{
    "cbrunsdon": "Didn't get to this early enough for a 1.0, and too late now. Killing it.\n. Killing this, was mostly while I was testing jenkins.\n. retest this please\n. :+1: \n. retest this please\n. :+1: \n. I am now :-1:  this in favor of #23\n. Killing them. I am going to use them at some point in time to stop the reset preferences on every spec,but doesn't need to be right now.\n. @gmacdougall sorry. pushed wrong branch to wrong place.\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. retest this please\n. :+1:  good stuff, looking forward to running 4.2 on a site!\n. huge :+1:  from me\n. Closing this down with thumbs up of blackie. Attempts to clean it up to merge is probably not worth the effort. \n. :+1: \n. retest this please\n. retest this please\n. :+1: also assuming it works\n. Killing this as its more likely that we'll do a new API than make any significant changes.\n. :+1: \n. :+1: \n. :+1:, I tried using it a few times for kicks but never actually got it to work. saw a huge amount of tickets on it too, for what little it provided.\n. :+1: \n. @jhawthorn can we kill this issue now, with that revert in?\n. Yea, I'm a little scared of some unintended side effects, but I can't think of any right now and I think its a really positive change long term.\n:+1: \n. Maybe we should leave a note on the readme that this is still a Secret Project\u2122 and gems will be cut shortlyish.\n. A bit of history for anyone that starts this:\n\"spree-multi-domain\" was built for pre-1.0 spree. Over time it gained more features and functionality as more people adopted it and incorporated it into their stores.\nAs \"multi domain\" (the ability to run multiple stores off of one codebase) was a very desirable feature, the \"store\" ActiveRecord model from spree-multi-domain was added into core so different multi-domain implementations could share at least some common ground and functionality.\nIt was not ever implemented as a complete set of functionality and much of the spree-multi-domain extension was relied upon to make a store actually work properly.\nThe core team has agreed that as much of that functionality should be pulled into solidus core as is appropriate. \nA person wanting to work on this issues could go through solidus_multi_domain and evaluate all overrides and functionality, pulling out and building PR's for anything that was better suited for core.\nI would consider this a very \"accessible\" task that could be accomplished by developers of any level.\n. @danielmyasnikov sorry to respond late, but absolutely, I think we're very happy to take much of whats in multi domain into core if you wanted to bite off a chunk of it.\nIf anyway wanted to talk specifics this is a reasonable place (though I'm closing the issue), or feel free to ping me in slack.\nIn general that would be a good task for anyone new that wanted to contribute some how.. :+1: \n. Closing due to our suspicion this is now fixed or no longer a problem. Please re-open if anyone is having same issues.. I agree with this, @jhawthorn what are your feelings? It doesn't look like it'll be a huge job to set up (but its heroku, so who knows).\n. Calling this actionable in individual commits, but not necessary to be its own issue\n. There are a few plans on the table which have been discussed, like splitting up into (multiple?) gems that provide just controllers and additional gems to provide frontend views (bootstrap?  foundation? API-only?), but nothing concrete has been decided and this isn't going to be the place we discuss it.\n. In this episode of Solidus Issue Background History:\nHistorically Spree::Order.state was a state machine very tightly integrated to the \"checkout steps\" a user would go through in order to complete a checkout.\nA \"cart\" would enter the \"checkout\" state when the checkout button was made.\nThe Spree::Order would progress to the \"address\" state when \"continue\" was clicked on the checkout page, prompting the user to enter their address.\n\"delivery\" would be next, prompting the user to select a shipment method.\n\"payment\" would follow, prompting for payment information\n\"confirm\" would (optionally) show up with an order summary\n\"compete\" would follow that, when an order was complete.\nAn order progresses through these states with the magic \".next\" method, which just pushes an order through the states if it meets the criteria of being able to move forward.\nAs checkout's became more customized (single page API driven, re-ordered flow, etc) and the number of \"states\" we considered an order in increased (fraud, cancelled) it became clear that state_machine model we have is overly complex and tied to an outdated _frontent checkout flow.\nThe core team has identified that the checkout flow should not be dictated by an Order's state machine and should be pulled out and supported in a different way, which we hypothesize should improve comprehension and reduce complexity of an order.\nExtracting the address/delivery/payment/checkout state from the Spree::Order should be considered a very advanced topic, likely only accomplish-able by someone with a very thorough understanding of the spree order state machine.\n. Hawth and I are going to kill this, as while we would love to see it done, it's not actionable with how the codebase is now. We have many more tasks we need to accomplish first before this can be tackled reasonably. \n. There isn't any reasonable information here for a person to tackle to improve the codebase. Something we definitely want to do, but closing as we want more actionable issues.\n. I'm looking at \"yet another mapping system\" on a Spree 2.4 (which will shortly-ish go solidus) to map line items -> ??? -> multiple inventory units.\nI'm having an initial discussion with Hawth and Jared on some of the systems we've already built and seeing what comes out of it. After that I'd like to talk to you @athal7 more about what you've done with bundles if you have a bit of time.\n. Just to give some background to anyone reading this in the future (and anyone feel free to correct me if I'm wrong anywhere here) there are two different ways this has been done.\nThe first is a \"mapping\" system that maps a specific line item (or more likely, a line item's variants) to different stock items. When shipments are being created, rather than the line item's variants being added to a shipment, all the variants that are \"mapped\" get added instead. This is how something like spree-product-assembly works, or a few things we haven't been able to make public.\nThis method is:\n- Easier to make promotions on (as we can look at line-items individually)\n- Is much harder to track which line items inventory units came from (since they go through some mapping process)\n- Makes tracking stock on the line items very difficult (as we need to know the state of all mapped items)\n- Works well if mappings are \"dynamic\" and fulfilment can be handled by a selection of variants on the backend\nThe other implementation is \"product bundles\", which isn't currently public but the folk at Bonobos have in a state that could be shared relatively easily. Instead of handling the mapping of a line item to inventory units, it adds multiple line items to your cart when a \"bundle\" is added. This is the system I want more clarification on, but my immediate thoughts on it are:\n- Makes it very clear in a \"cart\" which items you're actually getting (which is desirable sometimes but not all times)\n- Has potentially less inventory complications as we know the variants that will be added as we check out\n- Makes it harder to write promotions for (think: %off if entire bundle is purchased, but a user could remove one of the variants in the cart)\n. We don't have a clear winner on how to do bundling, and there isn't a clear path forward anyone is working on they want in so I'm closing this. If anyone was specifically attempting this themselves, happy to re-open the issue.. ### Issue Background Information: Categorization Edition\nHistorically spree_frontend's navigation and organization was based around Spree::Taxon, and adding products to Taxon's. This was a good early step, but as stores got larger and more complex it became more difficult to use only taxonomies (which are more about modelling of what a product is) to organize how things should be displayed on the frontend. \nOver time we found more success building \"category\" models alongside taxons and adding products and ancillary information to the \"Category\" rather than trying to shoehorn that information into a taxon.  \"Categories\" become the driving force behind how products are organized and navigated on the frontend, while Taxon's are still used for product classification on the backend.\nThe folk at Bonobos have adopted this path and done significant enhancements and customizations to their \"Category\" model which I'm sure they'd be excited to share with anyone investigating this issue.\nWe think supporting a simple hierarchical category structure to organize products is something that will be useful to very many stores and should be added to core. Additionally, we don't believe stores that do not wish to use categories will have their operation impacted negatively.\nI would consider this a very accessible task for anyone at any level to complete, though we'll need to flush out exactly what we're building and its requirements before someone started.\n. The general consensus north of the 49 is Rabl was a great decision at the time but has not stood up well to customization or expansion.\nIts tough to work with, extend and comprehend. We are for scrapping it's existing interface entirely. \nMy personal preference for going forward is:\n1. Support the current api endpoints for a while longer exactly where they are\n2. Start up a new API endpoint only for the frontend\n-  use AMS with the JSON::API adapter\n- keep it light and tight for the frontend for easier security separation and auditing\n- drop Spree::API::BaseController because its terrifying\nWe've been following this path in one of our stores to great success, which will soonish be in a shareable state. \n. Giant :+1:. :burnitdown:\n. :+1: \n. wasn't the last one in the file the one that would have been used? should we have yanked the other one instead?\n. someone in slack reported this is still an issue, investigating now.\n. :+1: . \nI have a bunch of complaints on the controller/spec's that were there before, but can't fault you for those.\n. calling a big :+1: on behalf of gmac. He doesn't care if he has his name next to making it work as long as it works.\n. I'm killing this in favor of #232\n. Marked it down on my personal hit list, but closing this issue due to staleness.. :+1:  </late_to_party>\n. @jhawthorn are we good to kill this now?\n. :+1: \n. These actions could now technically be handled in PaymentCreate, or another way, but closing this due to staleness as I don't think its a priority for anyone anymore.. This isn't realistic for us any time in our near future, as much as we'd all like to see it happen. We'd need a good plan that wouldn't cause chaos in peoples worlds.. Yea. My fault these were ever added. Sorry.\nI made the mistake of thinking them being in the repo would make them easier to update in the same PR etc. Definitely didn't happen that way and I am definitely pro killing in favor of real docs in the code.\n:+1: \n. This PR is awesome (thanks @plongyear), but I've taken over this in #542 as Peter is no longer working on the project. \n. :+1:, big fan of the separate classes.\n. I pulled out the code in this one that I cared about that hasn't already been merged in #539 and #538.\nThat is the last of the HABTMs! So closing this, thanks for the work @BenMorganIO \n. @jordan-brough I'm not a big fan of attempting these hooks with the .try!\nI guess as a background I have a few questions:\n- What are all the places credit cards are currently created?\n- Who is (and when are they)  going to call that callback? (which is related to the one above)\n- Is this ran only after a credit card is persisted to the database? Should it run after a transaction is rolled back?\nExcellent time to have a conversation though, I can see many people wanting to run code when credit cards are created.\n. Yea, if you changed it unintentionally and it might possibly make it tougher for someone to upgrade because of it, I'm :+1: \n. I'm usually a fan of nesting resources where things make sense.\nRather then close_adjustments and unfinalize_adjustments I'd personally prefer /orders/:id/adjustments/finalize and /orders/:id/adjustments/unfinalize.\nAlso are we tied to finalize/unfinalize? I've decided I'm partial to \"settle\"/\"unsettle\", but mostly because I don't like the concept of \"finalizing\" something that is finalized.\n. Cleaning up these commits isn't going to be worth the effort to get them into core, the majority of the important functionality of #289 already got in, so just killing this. \n. With #357 up now we can probably kill this\n. As this was technically public we should make a note in the changelog that we removed it and let people know they can add it back into their controllers that used it if they need it still.\n. @hhff we have no plans to support the spree 3.0 backend, sorry.\nWe do, however, have lots of plans to clean up, improve, and eventually re-style the backend, but don't have any plans to ever use the spree 3.0 codebase. Hawthorn is making some good progress but it'll be a while before it noticeably looks or works better than it does now.\n. @jhawthorn do we want to shoot to fix this the same time we stretch out the admin layout? or should we shoot for 1.3?\n. I care about this because I am tired of hearing people around me complain about it. @Sinetheta what will it take to get this moved forward for 1.3ish?\n. @Sinetheta my hands and face are busy gesturing wildly and not understanding most of what has to happen here, so I'm going to leave cleaning this up to you. \n. :+1: \n. :+1: \n. yea, nifty. thanks @grzlus.\n. I would have prefered we return new_order from charge_for_items to make the API more explicit, but not enough to change anything. I'd probably want to wrap it in some kind of message back rather than just returning it, anyway.\nAre we just waiting on the re-raise of the exception to finish this one off?\n. Sure, :+1: by me\n. Take that, 4d652a77fdcb14db6d0fadbd5966a91264889073!\n. :+1: \n. I'm unofficially :+1: on this, will leave the official one to @jhawthorn \n. I think I'm :+1: on this, and would like to move on this as early in the 1.3 window as possible.\nThanks a lot for your work @alexstoick, really appreciate the follow-through on this.\n. :+1:, thanks again @docelic\n. I am pretty scared by the change of the persist_totals call.\nI'm very pro this change overall, but aren't comfortable merging it in just before we get 1.2 ready, so @jhawthorn has agreed to merge it very early in 1.3.\nStores that heavily abuse callbacks could get affected by the extra ones running on the .save, and if there were problems caused by that change they might take a while to figure out something wrong is even happening, with potential large impact to a running store.\nIn short: :+1:  for 1.3\n. We very much agree that fraud needs to be treated as a first-class citizen in solidus, but the implementation we inherited from the Spree codebase is not anywhere near what is required.\nAs we plan solidus fraud management going forward, it is unlikely to have anything to do with the 'approved' state.. Killing this for the same reasons I killed #49\n. good by me for now! thanks. @bsodmike  :+1: \n. I pulled this down to rebase it against master, but unfortunately due to #449 and its subsequent revert there isn't much work salvageable that wouldn't be faster to re-do, so closing this for now.\n. @olistik not everyone has rails in their path (I only ever have it in a local vendor/bundle for the project I'm working on), so I'd prefer what is there now for safety sake.\nIts not like I'd get tripped up on removing it, but nubs might, so :-1: from me.\n. @olistik aye, totally understandable, going to kill this as the extra few seconds to run through bundle exec is a reasonable tradeoff.\nThanks for the attempt though, always great to get our docs reviewed and improved.\n. @olistik aye, I'd be happy to take a PR to add it there. or ./bin/rails s, if the bin is added to the sandbox (which IIRC it is, but would need someone to confirm)\n. :+1: from me, this is pretty ballin', thanks @metade\n. @jhawthorn we should make note of this in the release notes\n. Yea this one is :+1: by me.\nAlso, BEDMAS.\n. @jhawthorn's main concern is tying more logic to the state machine states, something we continually feel pain from.\n\n@jhawthorn Since we want to always apply store credit whenever available, even in favor of other payments, that check seems insufficient.\n\nI'm unsure what would change between a check on the confirm state and an incomplete in that situation?\nI'm personally terrified of an after_create (in a model) doing a restart_checkout_flow to (potentially multiple?) orders. If we already have the store credit that was just created, are we not able to simply apply it to the order?\nA call that would look something like:\nruby\nuser.current_order.apply(credit)\nThis is too similar a situation to ensure_updated_shipments that blows away everything and becomes impossible to detangle from the order updating process. \nAlso can an admin increase a store credit through an edit, or is it only possible to create? Because I imagine we want this increase applied as well?\n. If anyone wanted to send a PR to implement this I think people would be happy to see it, but closing the issue due to staleness.. I'm super :+1: but will leave @jhawthorn to officially call it on our end\n. @mbj nobody is paying for it right now but I'll talk with hawthorn next time he is in the office and we can look at what kind of bullet we'd need to bite. Don't really want this slowing people down.\n. @lightcap All of jhawhtorn's commits pass CI, aye. He has pretty flawless commit histories for everything he does. I do the same and would support it as a standard for the project for the same reasons mbj mentioned above (for git bisect, especially).\nI agree with ben morgan saying each commit tells a story, I just also believe that story should pass tests at every step of the way.\n. :+1: \n. Okay, we're going to shoot to get this in as the big back-end change for 1.2.0. We have a competent frontend person earmarked to do this in as minimally obtrusive way as possible, but everyone will almost certainly have to update any defacements or view overrides they have in the menu as it exists now.\n. :+1: \n. @ajkamel I'm looking to remove deface from the core project in the next release. If people want to keep using it inside their projects, thats fine with me, but as we don't use it any more inside the solidus repo itself we shouldn't be adding it as a dependency.\nBut that is, of course, just pushing the problem down the line. I'll try reaching out to @bdq and seeing if he can either do a push or add someone else to the owner list.\nEDIT: didn't mean to close the issue, sorry.\n. Yea, big thanks to Brian Quinn for granting us ownership on rubygems.\n. We implement these in some of our stores, but we understand the conditions they are used under and are incredibly careful with tthem. They're not difficult to add to your own store, but I don't think this is safe to add to core, there are too many edge cases people are almost certain to run into and ruin their day.. Aye, I agree with @jhawthorn. Rather than making any decisions right now I think we should chat about them on case-by-case basis' for a while and see what we think as we work on things. Definitely happy to have these conversations though, I expect these will be some of the most important design decisions we end up making in solidus.\n. @jordan-brough looks like a great step forward to me, thanks for taking the time to type those up, :+1:\nWe'll need to be diligent about the \"every commit passes\" but I love working on projects that strive to achieve that.\n. @adaddeo thanks so much for the attempt here, sorry we've been pretty quiet on our end. Every time we sat down to look at this closely we got distracted on other things to get 1.1 and 1.2 out the door.\nThe approach is pretty neat but a little drastic for a single PR. @mamhoff has been attempting to fix the tax situation in a very similar way in: #685 that is more mature (as we've made him re-write it 4 or 5 times now) and we'll likely be going with that.\nAfter that is merged, if we can scale back the size of the changes into more smaller PR's I reckon we can get something in that is safely merge-able. These types of changes are definitely the direction I think we need to move in, but unfortunately with how bad the state we're starting with it has to progress in some incredibly small steps forward. \n. Are you experiencing this on a vanilla solidus store?\n. Going to assume you figured it out or decided to classify the bug as a feature.\n. I'm in no position to critique the css/html but it looks reasonable to me (and of course trust @graygilmore  for his review). I think @jhawthorn wanted to get some input on how we were generating the tabs (for customization reasons), so I will hold off a thumbs up for him.\nsuper nifty folks, giant improvement. should have done it years ago.\n. @Sinetheta Can we get some kind of update to the changelog as well please, with maybe a link somewhere explaining how to add things to the menu, or how people will need to update their markup, if they need to do so?\n. Okay! Big thanks to everyone that helped on this, and Kevin for doing all the work, I am now :+1:, will leave it to @jhawthorn to give a round of feedback too \n. Aye, I agree with andrew that it would probably be better as a separate promotion.\nWe've attempted to do something like this a few times but it almost always ends up \"too simplistic\". Users that want the promotion twice will either use different emails, or just use the gmail this+that@gmail.com notation.\nI'd rather not pollute the working OneUsePerUser rule for this case than attempt to handle them both, and another rule to cover just the emails is a good benefit.\nAlso, edit'd original post for markup.\n. @dhonig sounds good, and invites are public, just hit slack.solidus.io and you can get yourself one.\n. Closing this as I imagine it was either PR'd or sorted out.\n. I'm pro removing anything we can from the order.\n. I'm a bit of a tossup, Half the time I find that validations aren't always ran at the appropriate time (especially when its done on a AR callback) and find they get in the way of the store I'm working on, and the other half I appreciate that they're there and often do okay things.\nFor this, if I had to weigh the before_save against the delayed stock check on checkout, I'd say skip it when its added to the cart.\n. @tvdeyen Hmm, thanks for the link, we'd only care about that where associations need to have their class's dynamically determined, right? \nI don't need to pay attention to that for this specific commit as neither specify the class nor is it dynamically determined, correct? \n. @BenMorganIO did I need the FK's to make this legit? I was trying to get the smallest possible improvement. Tests pass on this, after all...\n. Yea, good by me, :+1:\n. Okay! To start, thank you. This is a fantastic way to start this issue and was very understandably laid out.\nHowever, I don't think the concept of a \"GiftReturn\" is something I'd want inside of core at this time. For the added complexity I don't think its likely to be used by very many stores and therefore isn't appropriate for core. \nThough I am curious if anyone has differing opinions?\nIs there something we could do to make the existing returns API more flexible to allow you to implement your GiftReturn in your own store or an extension in a supported way?\n. @athal7 and I had an offline chat and we narrowed down the scope a bit for something we think could end up as a good addition to core.\nWe're going to scrap the concept of \"GIftReturn\" in core for now, but are going to support the concept of re-reimbursing to another user. This would allow admins, when doing a return, to optionally specify a different user that should get the re-reimbursement.\n. Thanks for sharing your screens @sukhchander, but unless you had a specific path to get anything concrete merged, I doubt we'd benefit from a code dump. \nYou're very welcome to break out any specific functionality and shoot PR's across on a case-by-case basis though, looks like there are definitely some improvements you've made to what is shown in different admin areas the project might benefit from.\n. Closing this as its not super actionable itself and is being looked after in other PR's and issues.. As discussed IRL hawth is going to throw some test cases about what didn't work before and how the new behaviour should be.\n. To be clear: there were no tests testing the :coupon_code_not_found and :coupon_code_better_exists logic that was previously being returned and we are changing that behaviour.\nYes, those happen under pretty dubious circumstances, but that is the existing behaviour.\nDoes anyone want to chip in on if they rely on those being returned or not? Maybe @alepore or @tvdeyen? \n. I'm not sure how (or if?) you're going to utilize any of these changes in the VAT code but I'm still :+1: on the commit.\n. Big giant :+1: from me. Good work hawth.\n. I'm going to leave this open for now until we have support for VAT in solidus, but aye I echo @tvdeyen's comments that your best bets are to wait for better support from the two PR's linked or poke the magiclabs guys offline. \nWe know handling VAT better is a big issue for the platform and the German folk involved are doing a great job to try and get support in for 1.2.\n. As we now also have #706, I'm closing this issue. We're hoping to get these cleaned up in time for 1.3 out the door, sorry its currently such a hassle.\nI echo Martin's warning about order-wide promotions being a book-keeping nightmare. \n. :+1: from me. Killing this didn't make any tests fail and I don't understand its purpose to begin with.\nIf someone that actually understands this stuff says kill it, I'm good killing it.\n. @mamhoff Are we good to pull the trigger on this one for 1.3? I'm still honestly pretty fuzzy on how it fits into the larger changes.\n. :+1:  from me. I don't like zones or members or how we handle any of that, but I don't have a better plan than what we have now and am okay supporting those associations on Zones.\n. The first commit here is covered by #529, maybe shoot this PR at that branch instead?\n. :+1:, good by me.\n. The deprecation warning on by_number is good by me, and moving to use the helper for deprecate is fine too.\nWhat was the reasoning behind silencing during the spec runs? So we can still use our own deprecated methods for a few commits? Or I guess we still have specs that test their behaviour that we want silenced?\n. :+1: \n. This has been discussed in the past, but I do not think we should be doing taxes with adjustments.\nAdjustments have been a \"kitchen sink catch-all\" for modifying prices and amounts, and they almost always add more complexity to the code than they save in the data model.\nI would prefer we be able to model out all taxation than try lumping them into a more generic \"adjustable\" class.\nHonestly this one is probably worth jumping on a hangout for with anyone that has an opinion. (after black friday though, when more of our lives are sane)\n. Putting on the variant is almost definitely wrong, and would have a bunch of historical data problems (as it would actually have to be on the Spree::Price and not the variant). We're also hoping to make a large number of changes to allow for more dynamic pricing which wouldn't make sense on the variant.\nPutting the initial_price on line items makes much more sense to me and something I definitely support.\n. I don't have any opinion on this, but if you prefer it its a :+1: from me.\n. :+1:  by me.\nHuzzah for removing code! Thanks @philbirt \n. I poked @mamhoff in slack and the first thing we're going to try with this PR (which we all know is very scary) is try and pull out the general \"spec improvement\" commits from any serious change here.\nThe PR itself is so massive anything we can do to reduce noise would go a long way.\n. :+1: \n. ha, thanks! It was definitely a good change for the codebase.\n. I have been thinking about this one for the last few day and I don't think I like the idea of stopping :update's to orders by default at the cancan level.\nThere are a number of circumstances I think \"updating\" an order makes a lot sense: changing/fixing addresses, adding assets, some stores even allow changing shipping before a point in time (all of which I think are very clear use cases).\nI'd rather block on a more fine-grained level, like stopping line item updates if its complete rather than all updates to an order, thoughts?\n. @carchrae Aye, I follow.\nBut order.completed? doesn't mean \"hey this is shipped and shouldn't be edited\", its really more of a \"hey we got through the checkout flow\". In many stores .completed? orders can still be changed by a user. In my experience the more we rely on it for behaviour the more trouble we end up in.\nI would be more okay with this if we didn't use the .completed? check and instead added some different flag deciding if it was still user editable, rather than lumping yet more logic on that flag. Maybe user_editable?\nThis would allow stores to implement the logic they wanted rather than having it tied to .completed?.\n. Okay, I follow why you want to lock that down on the cancan level as that gets generated from: \nsolidus/api/app/views/spree/api/orders/show.v1.rabl\n47:  { can_update: current_ability.can?(:update, root_object) }\nLooks like it was added here: https://github.com/solidusio/solidus/commit/e6240a30e24627053b1eba1bfe4b1e1d32594da6\nAnd doesn't look like its used anywhere inside of solidus anymore. I'd even say this is probably safe (and smart?) to kill, or shift it away from a cancan check. \n. Yep, good by me too, thx hawth :+1: \n. @dfmedeiros this looks fantastic, really appreciated.\nI'm slammed by BlackFriday/Monday stuff but will pull it down and give it a run early next week. On first glance everything looks great though.\n. Okay, addressed both of @mamhoff's feedback (thanks).\nI definitely think this should be (at least) the level we scrutinize all factory changes in the future. I find problems with our factories echo through all our tests.\n. Okay! Looks good to me, other than hawth's request in #a272fee.\nAlso, when you have a minute, you'll likely want to read though: http://tbaggery.com/2008/04/19/a-note-about-git-commit-messages.html\nThanks for the cleanups though.\n. :+1: from me too, thanks @punjab. Taking Magnus' pre-squash thumbs up as well\n. :+1:  from me too, thanks.\n. yea, :+1:  though what this code does is a bit of a mystery to me.\n. @philbirt yea, I always assumed lots/most of this was useless I just haven't had time to look into it. @adammathys might know as he has dealt with way more of the promo stuff than I have.\n. Okay, I'm :+1: for this for 1.3. Cleaner than what was there before, and huge improvement on the tests.\n:+1: \n. :+1:, thanks @tanmay3011! Really appreciate the effort trying to clean up core.\n. @athal7 I've got nothing against it. Its definitely a quirk/optimization of rails I hadn't considered before but am for it. @gmacdougall @jordan-brough @jhawthorn ?\n. :+1: \n. good by me too, thanks :+1: \n. That this breaks no specs terrifies me.\n@jhawthorn should we try and get this in really early into 1.3 as well?\nAlso, we should write a spec that actually does something for this. As in: given we have a payment that fails, a log entry of it still exists. We should probably do that before we merge.\n. @richardnuno I don't 100% follow what that check is guarding against.\nIf you could outline what a test would look like that would cover the case you're worried about, I think either Hawth or myself could write it up.\n. Those tests are magnificent. Thanks @jhawthorn, I don't have any objections to the PR, and its definitely moving us in the right direction.\nIf it has any unintended side-effects I can't think of where, but we'll have to deal with them if and when they come up.\nAlso from now on I'm going to use these as a reference for writing clean tests in these types of situations.\n. Nifty, thanks @ajkamel \n. [insert pictures with explanation too, please. would be appreciated].\n. Hi @rbngzlv, thanks for the contribution, always much appreciated.\nI'm definitely agreeing that we need to get this fixed (the fact that we can't transition to complete without shipments, as not all stores will require shipments).\nWhat I think we need to resolve though is the connection between the \"delivery\" state and an order having shipments. I don't like that we're using the presence of the that state here to make that decision.\nAn example where this logic falls down (IMO) is when stores have \"digital only\" delivery as well as actually shipments. The \"digital only\" orders will not have shipments but should still be completable, while the state machine would still have the \"deliver\" state for regular orders.\nGoing to poke around and see what stores that do mixed orders are doing now...\n. Okay, I was a little shaky on this for 1.2 but I am okay with this for the same reasons hawth is.\nThanks a log @rbngzlv, its a tough problem to work through but the effort is very appreciated, sorry we couldn't move on this faster.\n. I'm a big fan of the spec changes, and the optimization on the packer looks reasonable enough to me.\nI would personally have probably done the following rather than the each_with_object:\nruby\ndef stock_item_lookup\n  @stock_item_lookup ||= begin\n    Hash[ Spree::StockItem.\n      where(variant_id: inventory_units.map(&:variant_id).uniq).\n      where(stock_location_id: stock_location.id).\n      order(:id).map { |stock_item| [stock_item.variant_id, stock_item] } ]\n  end\nend\nbut don't care that much to ask someone to change it.\nI might also have put an intermediary private stock_item_for(variant) rather than exposing the state of that hash to the method, but again not super strong.\n. Oh snap, good point, I hadn't realized I clobber that functionality when I swapped it. I'm cool with yours.\n. Balling, :+1:  from me, but we'll have to fix the history for the sprockets of course.\n. This is definitely getting more complicated to read than I'm happy with. I tried and couldn't make any changes to make it noticeably cleaner though. Once I got my head wrapped around the whole thing I definitely am okay with the change in logic, seems to be doing the same thing (which is good!).\nI'm going to say I'm pretty ambivalent on the change too, I'm sure when Hawth's back next week he'll have an opinion though.\n. :+1:, thanks Jordan. will be interesting to see if 6 months from now anyone found the comments helpful.\n. This went through a bit of an in-person nerdfight but the long story short is I'm :+1:. I pushed for <colgroup>'s but apparently they're not sufficient to style everything. \nYou might want to ping @graygilmore to see if he wants to bikeshed the naming, or maybe has an opinion here. Lets even say my :+1: is pending a :graynodofapproval:\n. :+1:, thanks. also neat link.\n. :+1: looks good to me, thanks!\n. To throw my $0.02 into the ring the main thing I care about isn't that we implement $FRAMEWORK_$VERSION but that we start getting sanity and clarity in the backend.\nIn addition to the tickets listed above, we also have:\n- The style guide in #602 that will make the backend more clear and structured going forward \n- #630, #633 and #634 to improve the organization, structure, and logic of the backend.\nRather than bikeshedding over frameworks, we should be focusing on reducing chaos and insanity and make the experience for people working on extending and improving the backend a reasonable experience.\nAs we saw from spree 3.0, trying to YOLO commit in a giant backend overhaul is just going to fracture the community farther. \n. The stembolt folk sat down for a meeting today and we've reached consensus that bootstrap would be a good way to move the admin forward, so long as we can execute on it reasonably.\nOur tentative plan (needs more investigation) is to start by using just the grid and slowly fix our markup and add more components. Anyone elses help would be appreciated, of course, but we're going to try some experimental PR's to see how reasonable this is going to be to move forward. \n. The stembolt folk sat down for a meeting today and we've reached consensus that bootstrap would be a good way to move the admin forward, so long as we can execute on it reasonably.\nOur tentative plan (needs more investigation) is to start by using just the grid and slowly fix our markup and add more components. Anyone elses help would be appreciated, of course, but we're going to try some experimental PR's to see how reasonable this is going to be to move forward. \n. Hawth did some work in #955 to get bootstrap in an unobtrusive as way as possible, which should allow us to start moving bits of this forward.\n. As this is now handled by #662 I'm closing the issue.\n. Huzzah! Crazy this is actually got done, good job everyone. \n. Also paging @graygilmore. \n. I'm ambivalent on all of this (the \"where it should live\" discussion). I don't think it would be too difficult to move around in the future for however we decide it should go long term, will leave it to other people to hash out where it should live for now.\n. I'm merging this as its not going to be difficult to move later if we so desire, and it seems pretty innocuous. \n. and now I wish @Sinetheta had added an entry to the readme.\n@jhawthorn maybe a readme/changelog update if you get a sec?\n. @Sinetheta this looks really nifty. And pretty. Etc.\nCan you please do a write-up either in the wiki or somewhere on how one would go about customizing the colors themselves? I imagine a few stores will either want to immediate take use of the better organization to color to their own branding, or maybe even go back to what it was to avoid scaring people.\n. Okay, as per discussion in the #gui room in slack (which we made to talk about the gui) and #630, we're leaning towards pulling out the last commit here (that actually changes the colors) for a future PR when more colors are ready to change. Final decisions still pending though.\n. this is good by me now :+1:. For the record though, we don't need to call the variable settings in every theme variable_overrides, as those in fact are the variables for that theme.\n. Okay! bit of an odyssey to get this in, thanks for the patience @Sinetheta, great step forward\n. :+1: . Just for $pirate-gold though.\n. This looks good to me but @jhawthorn is the paranoia expert 'round the office so I'll leave it to him for final say.\nFor my $0.02 I'm good requiring paranoia >= 2.1.4 as well.\n. Guessing this got solved elsewhere and closing it.\nHopefully next version of solidus API is more robust and supports this.\n. This looks good and reasonable to me, I'm :+1:\nSomeone else might want to complain about the switch to coffee though? I usually include .min's on my vendored assets but don't have strong opinions either way. \n. Probably best to address this as part of #348?\n. :+1: \n. Good by me, thanks hawth. :+1: \n. :+1: \n. :+1:\n. Hi @blacktea3937, nobody has updated the spree_marketplace extension to be solidus compat yet (that I know of).\nYou'll need to give it a run yourself if you're looking to get it working with solidus. Generally speaking its not too difficult to take any 2.4 branch of an extension and update it to point to solidus instead, but will be very tricky if you haven't done much spree/solidus or rails development before.\n. Hmmm, as bourbon 4 was released 2014 I'm okay with the restriction there. Can you try pulling down 5 (which looks like its alpha now) and see if maybe we can do like > 4 and < 6 or something?\n. Good by me, :+1: \n. Yea, all good by me, thanks @jhawthorn :+1: \n. Yea, good by me too, thanks @Dkendal.\n. Okay, it looks like all these commits are in #627 so I'm killing this PR\n. :+1: \n. For posterity, I believe this is related to: #572\n. @travisp and @daisuke-3, I'm having a conversation with @jhawthorn and we're trying to better understand exactly how you're using the checkout.\nAre you looking to skip the delivery step, but still expect shipments/inventory units/etc to be created? Or are you looking to skip the step from happening, but still expect shipments etc should be created?\nAlso, is this something that worked previously (on spree) you're running into with Solidus, or is it an issue you're running into with a new store?\n. I'm also not really excited about the env check, I know it means we have a test to make sure that factories would be individually loadable, but I'm not sure thats worth the potential extra issues by controlling loading with ENV settings. Will think about it.\nTests on our factories if fantastic though, thanks for the effort. The huge reliance on our factories by ourselves and other projects without any reasonable suite has always been a black mark on the project IMO.\n. We could look to do it outside of our specs as well just as a CI task. \nWhile individually requirable is nice, I'd definitely say not worth confusing up our specs. I'd even say we try waiting on backlash for a while. We'll also be watching PR's to make sure we're not adding dependencies to factories without including them, so we might be optimising for a problem we won't have.\n. As this is just going into Kevin's original PR I am :+1:\n. Whoops, sorry, missed where it was being targeted it to.\n. Yea this is all good by me, :+1: \nWill be funny if anyone is doing an assert on number of stock locations created and traces it back to this PR later on when their tests \"breaks\".\n. @tvdeyen What is up there now (menu on the left, some colour changes) are what we're targeting for 1.2 (which we're hoping to get out the door sooner rather than later).\nBut aye, what @Mandily said. Kevin is AFK for the week but Hawth, Mandily and myself sat down yesterday and tried to see what would target 1.3 release. I think we came up with a good balance of consistency but still reasonable to do in a single release. \nWe'll have to play it by ear as the work and feedback comes in, but will keep the releases in mind.\n. Calling this good, thanks a lot @sairam \n. @tvdeyen The settings are so infrequently used I don't think we should be prioritizing click reduction\n. @Mandily I say we leave everything in now for this issue as we're just re-arranging, if we also want to yank it we can handle that later separately. \n. I'm :+1:  on this. For the future, if anyone is looking for this functionality, I highly suggest it be handled at the time the currency is being changed and not as a before_update.\n. See kids? Complaining until someone else fixes it does work.\n:+1: thx Hawthorn. Should probably get a message in changelog though. Zeus forgive anyone that needed to override any of those methods.\n. @JohnMorales Aye, thanks for the attempt though. Hawthorn and I had a pretty serious conversation after this about what would be required to do this legitly. We might start sneaking in commits to help the transition in the log term. We're going to have to be really careful with migration/table names, any associations saved in the database (I.E. Spree::PaymentMethod stuff) and the like.\n. Ah, @jordan-brough's explanation of events makes a lot of sense. I'd agree that we should make a decision. Or even make a decision on not accepting PR's that just add/remove prefixes.\nI myself don't have an opinion, but would maybe lean towards always including it inside of core? @jhawthorn thoughts?\n. Yea, I'm good on this too, thanks @jhawthorn :+1: \n. Aye, duplicate of #598, fixed in published release and master.\n. I agree with @gmacdougall and am :-1: \n. Thanks @tfaruq, but I'm going to close this out. I agree with the others that Rails experience is required and we're not looking to document rails' options in our readme.\nAlso, removing the \"bundle exec\" on the rails is less likely to work as not everyone installs rails globally, but everyone should have bundle globally.\n. @connecticus thanks for checking in, if you end up filing a bug against solidus_globalize please link it here for future people.\nkilling this issue for now\n. Fantastic, thanks @connecticus. I'm a big fan of the workaround for this. If we can get a fix out the door without doing any real work I say lets do it. If you don't shoot off a PR by tomorrow either @jhawthorn or I will do it, as it seems this is an issue many people will run into.\n(Also: edited your comment for formatting)\n. Just one quick question on one commit, but this looks awesome, thanks @mamhoff for pulling these apart (and I imagine pulling teeth while building them).\nWill do a serious run through in the morning but first pass these looks great. Will reduce a ton of noise from #536 as well.\n. Yea, this is good by me too. Can starting to see this go in an actual reasonable direction now for the first since the beginning of the codebase, thanks a lot @mamhoff.\n:+1: \n. @travisp nice catch, thanks. Aye, if its not too much trouble a PR would be appreciated.\nHere's the code he's talking about for posterity:\nhttps://github.com/solidusio/solidus/blob/master/api/app/controllers/spree/api/stock_items_controller.rb#L36-L39\n``` ruby\ndef update\n  @stock_item = StockItem.accessible_by(current_ability, :update).find(params[:id])\n  @stock_location = @stock_item.stock_location\nadjustment = count_on_hand_adjustment\n  params[:stock_item].delete(:count_on_hand)\n  adjustment -= @stock_item.count_on_hand if params[:stock_item][:force]\nSpree::StockItem.transaction do\n    if @stock_item.update_attributes(stock_item_params)\n      adjust_stock_item_count_on_hand(adjustment)\n      respond_with(@stock_item, status: 200, default_template: :show)\n    else\n      invalid_resource!(@stock_item)\n    end \n  end\nend\n```\n. This is fixed in #811, thanks @travisp for reporting and @ajkamel for making the PR.\n. Assuming solidus version was bumped or sprockets was locked and this got resolved.\n. Good by me too, thanks for updating that hawth. And yes, will be great to get this thing gone.\n. I'm :+1: for this, I think we can slip it in for 1.2\n. Yea, nice catch, thanks @travisp :+1: \n. Still good by me :+1: \n. :+1: \n. :+1: \n. Interesting, less changes than I was expecting (though that one test failure seems legit).\nIt would be nice to get some benchmarks in some different situations before/after the change.\nSomething like $X inserts into the children of a taxon, maybe a few of the common queries with $Y taxons. I don't fully understand the plusses and minuses of the change here.\n. @jhawthorn I'm generally opposed to this as more people were using it than I expected (from a poke around of people/projects). I would want us to find a way to deprecate it for 1.2 and remove it at a later date.\nIs there another way to get the same structure of data out of our public API?\n. Yea, nice catch hawth.\n. @jhawthorn thats awesome, thanks.\n(implicit :+1:)\n. @saroar unfortunately this isn't enough information for us to understand or fix the problem, can you please post steps to recreate this on a fresh store?\n. Yea, looks good to me too, thanks a lot @alepore \n. What if we do it with i18n? Pass the state \"number\" into the string and let the locale decide to show it or not? (or is this too large an abuse?)\nIt would just be a smaller change than moving it out of helpers...\nI'm 100% behind moving it to frontend though. \n. whoops, thanks, nice catch @gmacdougall.\n@alepore would overriding the css work for you?\n. We've hired a documentation writer to update how to best customize solidus, so this will get covered under his scope.. Aye, its from the infinite old 687b8c0 so I'd say its a good idea to kill.\n:+1: \n. @joeswann I tried using the same gemfile and couldn't reproduce, can you please paste me the schema of your spree_users table? It will give me a better idea at where things went wrong in your install process.\n. @joeswann no problem, thanks for including the gemfile in the issue.\n. Aye, I agree with @mamhoff that if we're going to change the behavior (which I agree with) we should add the scope and make sure $0 adjustments aren't shown on the frontend.\nI think the \"visible\" scope mentioned is reasonable. Though I would also be okay with customer_visible or user_visible or something of the like, as I would still want these shown to the admin.\n. Okay, agreed to not mix nonzero and eligible, I have enough troubles trying to figure out what an \"eligible\" promo is and how it should affect things.\nAnd aye, we could alias that but as we're already using nonzero I don't see it as important for this PR.\nAlso the change on \"complted_at: nil\" to the spec there makes me think we need a better incomplete order trait or factory, but I'm good with this for now.\n:+1: \n. Agreed, thanks @mamhoff. \nYou're doing amazing things for the codebase but you're terrible at taking vacations :-1: .\n. :+1: \n. merged it. even if we add more later, all that looks quite accurate.\n. :+1:, doesn't look like anything controversial in there.\n. @alepore this commit is a little much to track down for people that are relying on any of the methods as or where they are now. If you're okay with it I'd like to cherry-pick the method removals from spree/spree to make it clear that we removed them.\nAlso in your PR you said there are some \"renames\" here, is that true? I couldn't see anything that was renamed, but I think we should do any renames in separate commits from the ones that move them.\n. Great, thanks @alepore, do love the changes though. I threw up #710 as I did the work last week to see how cherry-pickable they were, hope you don't mind.\n. This was added 3 years ago, I suppose its reasonable that it isn't used anymore...\nso :+1: \n. Yea, I ran into this earlier, thanks for fixing :+1: \n. Yep, fantastic as always, thanks @jhawthorn.\n. Yea, I'm :+1: to the change but also open to a discussion at large. Thanks a lot @jrochkind, these aren't easy things to sort out and its much appreciated.\n. I'd prefer to remove the not_to raise_error now and do our best to keep it out of the codebase, as @jhawthorn made a run at them once already in 3df99fb.\nOther than that this looks great, thanks @alepore \n. :+1: \n. Yea, good by me. :+1:, also standard disclaimer eventually we want to phase off checking for states, but good for now.\n. Aye, test case would have been nice if anyone gets the time, but nothing broke so I'm cool with this for now.\n. I'm very supportive of the plan to make sortable payment methods, I think its a good move for us as a project, but I don't like the default_scope on payment methods. \nI know we do this in other places, but as a developer using the platform I'm always tripped up by us using default_scopes and would like to stop using them.\nMy main problem comes from being a developer using spree as a project, default_scope's on models leads to behavior I would not expect and is tough to hunt down. I'd rather us explicitly sort it everywhere we know it needs to be sorted rather than have other developers run into potential surprises on our default scopes.\n. As we're running low on anything reasonable to cherry pick from spree/spree I'd be for doing a mass conversion.\nBut yea, :+1:  on the PR, thanks @alepore \n. I'm :+1:  on this, sorry, missed the feedback to my migration question. Hope the rebase isn't too brutal... cough\n. This all looks reasonable to me. At the end of this, would your rubocop still give any warnings or are we now good?\n. Yea, for anyone that missed some of the conversations on slack:\nWe're trying to achieve a balance here. We want to be able to use rubocop to alert of us potential problems and be good about alerting us on things that are universally cared about (hash syntax), but are not sure where we'll end up with enforcement of many of these.\nHowever we wanted the giant-rewrite to have as many rules enabled as possible to get as many cleanups into the code base as possible in a global change.\n. @jhawthorn aye, agreed these could be in a changelog.\nAdded them in another commit.\n. Yea, looks good to me too, don't know what or how that rendered. Also no failed tests! Nice catch.\n:+1: \n. looks right to me. big :+1:, thanks again.\n. Okay, I have been thinking about this for a while and I think my main problem is its almost impossible for us to get a function called Spree::Base.base_scopes right. \nAs Hawth points out, this would break any kind of aggregation if used in some kind of report query. I think people would continually want this used in some places, but not others, and it would be impossible for us to know where and how it should be used.\nCan we come up with something more specifically named to make it more clear? I'd be fine giving this scope a name something like Spree::Product.include_translations. I think it would be more clear when we should be including it in queries, and be less ambiguous for anyone reading the code what it does and how they should use it.\n. @alepore off-line @jhawthorn suggested Spree::Product.display_includes, which seems to be a pretty reasonable description of what is getting accomplished here while still allowing globalize and others to be able to override behavior in a pretty understandable way.\nI think with display_includes its clear that we should be using it any time we are querying on these products for frontend displaying.\n. Oh man I totally forgot we had factory tests until I saw this commit. Made my night. :+1: \n. I think we're potentially changing the behavior by removing the ||= there? If someone else has defined that const before its loaded is it going to redefine the const to be whatever is in the file (though will of course throw a warning).\nHow attached to that one commit are you?\n. I pulled down the latest sandbox and can't recreate out of the box, will tweak some things and keep trying.\n@modreoci could you please peak into your javascript console in your browser and see if there are any errors when the page loads, please? \n. @modreoci Thanks! Helps a lot:\njquery.jstree.self-4133052a7f69ba15d0e4f85db43d4dc0ff19499b5fc5e512d704ce4b3e92f07b.js:2701\njQuery.Callbacks/fire()\nWe pulled jstree out of core which is making me suspect this might be from something else. Can you please paste your gemfile as well?\n. hi @modreoci, could you please try locking jquery-rails in your gemfile to v3.1.4 please:\nruby\ngem 'jquery-rails', '~> 3.1.4'\nI didn't realize you were not running master. 1.1 still has jstree. @jhawthorn was probably right and it was likely failing for the same reason as #691. He has plans to release a 1.1.2 to fix this. \n. To anyone else reading this: solidus' admin on 1.0.3 and 1.1.1 is not compatible with jquery-rails > 4.0. You can either lock your jquery-rails or wait for a new release (which should not be a long wait)\n. Hi @cindyward1, thanks for doing such a thorough backtrack of that codes history.\nDo you have your WIP of the spree_product_assembly port handy? I'm unsure what is actually throwing the error here, as order.contents.add() sets the default for options to be {}, so it should never be nil and we should not need to set it inside of the populate method. \n. @cindyward1 Hi cindy, I went through the code there and at no time is options[\"selected_variants\"] set anywhere.\nhttps://github.com/TrialGuides/solidus_product_assembly/blob/master/app/models/spree/order_contents_decorator.rb#L4-L63\nFollowing that backwards it looks like you set it in the params and expect it to be passed through, as it was originally in the spree 'populate' method:\noptions  = (params[:options] || {})\n@jhawthorn I'd be good taking that line back as it is really the only point where we'd reasonable be able to extend order_contents.add, thoughts?\n. Conversation was continued in #1918, closing this.. :+1: \nThanks to @CallMeSH for working with me trying to reproduce this on slack. But of course @jhawthorn figured it out.\n. I'm also :+1: this but I don't know this area of the code very well. CC'ing @brendandeere and @forkata  as well who know it better than myself. \n. solidus_virtual_gift_card will error out trying to run tests against this change with the devise token missing (not just throw a warning). Before I'd be for merging this in I think we need a plan for what we're going to do on gems such as those.\nI agree this shouldn't be in core, but I'd like an idea on what we're going to do for those other gems.\n. Sorry, @forkata corrected me IRL, it is in fact just  warning in the test_app, so it won't break specs. I'm :+1: on this change then, we should deal with it eventually but by no means a priority IMO. \n. Rebased over master for the rspec fixes, trying build again.\n. Aye, please see #691 and #720, its related to jquery-rails > 4.0. We will be doing a release shortly.\n. Closing this, as we now have releases out to peg the jquery-rails dependency. \n. Thanks for the code though @wuboy0307. As a bit of background, historically many of the admin settings were exposed via the backend, saved to the database, and cached at the rails cache layer.\nUnfortunately the config settings are very invasive and have large and far-reaching effects to the codebase. We greatly advocate setting them statically in an initializer for a few reasons:\n1. Nobody can accidentally change settings in the admin (or change them in ways they don't understand)\n2. Your tests will run against the exact settings in your config, not whatever it happens to be at runtime\n3. No need to db migrate to change settings when you deploy code, and easier to manage settings across different environments (staging, prod, dev)\nBut aye, as Hawth points out it is pretty trivial to support database-backed configs in better ways and I'd recommend just doing it inside your own app, if that is a desired feature.\n. Honestly I'm fine with it in this PR. \nIts the same output and more readable. Just do it in a separate commit and we're good IMO. \n. > Is cleaning out en.yml of unused translations even a concern?\nNot right now at least :D.  Lets focus on getting the forms moved into the right places and deal with the rest later.\n. Closing this! All the commits are merged, congrats @Murph33 and thans @tvdeyen \n. > The code that used this was removed in 2011\nYea. :+1: from me.\n. :+1: \n. :+1: \nyay for @Murph33's first PR into a real project. and thanks to @tvdeyen for doing the actual work.\n. I always hated the fact we did this, I'm cool axing it. Most of the time we just ended up including empty or terrible js files.\n:+1: \n. :+1: \n. @jhawthorn I think we can kill this now due to #850?\n@simo163 thanks a lot for the contribution, sorry this was broken for so long.\n. Yea, looks good to me, thanks a lot @dougjohnston :+1: \n. I appreciate some people's comments on things but I'd say just merge it as it is. Its an improvement and none of the suggested changes I read made it significantly better or clearer than the change already happening.  \nAlso its a Big Fat Change and the sooner we merge the less hassle it'll be for hawthorn.\n. :+1: \n. Yea, good by me, :+1: \n. Yea, big :+1: from me too thanks @jhawthorn.\n. :+1: \n. Hi @samanmohamadi, seeing as our long-term plan is to remove more of the \"pre-complete\" state machine steps I'm not sure we want to do too much here.\nWe generally find that attempting to customize the state machine in these ways usually leads to brittle, very difficult to test and debug code.\nI'd suggest making sure the order is \".next\"able through your order states and do a while order.next; or work on explicitly calling the transition you desire conditionally in your action.\n. Keeping or removing them is a hard decision with no clear victor (IMO).\nI say we... keep them for a while? But maybe group them under some \"Legacy\" comment in the .yml and decide what to do with them later?\n. @Murph33 the problem is people use the translations inside of the codebase in places they extended or override existing forms.\n. On first pass this looks like a fantastic step forward. Nice call. Will review in depth when I get a minute.\n. :+1: thanks\n. :+1: \n. I'm :+1:  on this, and my understanding is the feedback here is resolved as well.\n. I don't know if we need to (or should?) count on the behaviour/order in which Carmen returns states? Also we might want to add a changelog that we're changing the behaviour and show how to specify which state to pick as I reckon many sites would be relying on alabama to be returned by default.\nOther than that, this is fantastic, another huge step forward.\n. Yea, nice save on the alabama. I'm now a big :+1: this, but want @jhawthorn's eyes on it.\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. Modifying migrations on an already-released version scares me. Should we not be doing this as a new migration?\n. Yea, good by me, thanks :+1: \n. I'm :+1: for this mostly because it ALSO allows us to jam it down as well. Which is nifty.\n. @sanchojaf without this change whats the actual error you're experiencing? some kind of CSRF error? are you able to write a spec that would fail without the change in it? I'm also having a hard time understanding why we want to change this.\n. Hey @sanchojaf, I looked into this a bit more and talked with @jhawthorn IRL to give me a bit of background.\nThe Spree.ajax call should already append the Spree.api_key as the token:, so I think to achieve your fix all you should need to do is remove the authenticity_token without also adding the token.\nIf you can update your PR to do just that I'd be :+1: on it.\n. Cool, this is good by me now, thanks @sanchojaf :+1: \n. discussion on this change is happening in #792, for posterity sake\n. @sanchojaf sorry for the big delay, we've merged #792 now, if you can kill the token: in this one like you did in #792 we'll be able to merge it as well.\n. Aye, good by me too, thanks\n. :+1: \n. :+1: , thanks @Murph33 \n. Looks reasonable to me, thanks @jhawthorn :+1: \n. I think this is awesome. I've always been embarrassed by the default_country_id and think this is an awesome change excellently executed.\n:+1: \n. Yea, looks good to me too, much appreciated @ajkamel :+1: \n. :+1: \n. :+1: \n. :+1:, as I was cool with these in #850 \n. for situations where \":\" doesn't work well in a translation, we might want to start passing the other bits as params so people can customize them however they wish, instead of always value first.\nI'm still :+1: for this, though.\n. :+1:, either here or in #835 \n. Okay, this looks fixed in #850, thanks @pdanzinger \n. :+1: looks good to me, thanks @timrossinfo and @mhaylock\n. aye, I'm :+1:  on this too. typo was the word \"onlky\" from the commit message.\n. Yea, thanks @jhawthorn, this page needed time and attention. :+1: \n. To be completely transparent, we know its a huge knock against Solidus as a project that we don't have anything near reasonable documentation.\nGood documentation is going to be incredibly important for the long-term success of the project, but we're balancing fixing all the crazy inherited technical debt of the project vs documentation for new users.\nWhile this won't always be true, its been more important for Stembolt and the rest of the solidus team to focus on fixing core and the ecosystem around it, rather than taking time away from core improvements to focus on docs. I'd expect that over the next 6 to 9 months that to change and the developer docs start to get into a space they're actually useful. 12 months from now I'd expect even user docs start to shape up and be more usable.\nOf course, thats all assuming we're going at the current speed we're going at. If more people from the community wanted to pitch in and push the docs forward I'm sure we can get them done much faster. \nI know its been a big priority for @jasonfb from conversations in the past, we might be able to get a bunch of people that want to get it done ASAP and push it forward. \n. Thanks a lot @ajkamel, I think this is an excellent start and a great place for people that want to start contributing documentation.\nVery much appreciated. Closing this as we can now use its repo for any conversation about direction of guides.\n. :+1: \n. good call, thanks @jhawthorn \n. I'm sad we'd be losing variables that would be easy for us to customize on a store-by-store-basis\ne.g: $color-sel-disabled-bg and friends\n. should things be using this and not the model name of Spree::Exchange?\n. As this commit pulls in the punctuation to the \"create_one\" link, I'm aware we're changing what is currently being rendered, from the exclamation mark outside the link to inside the link (and switching it to a period).\nI think what we should do instead is change the entire thing to be:\nno_resource_create_one that takes a param for the model name and link to the create_one, giving a tighter and more clear control to the locale file. \nI also think we should remove the duplication and render the thing as a partial (or a helper) for no_objects_found\n. I agree with this.\n. :+1: \n. @jhawthorn you can probably rebase and merge this\n. :+1: \n. Interesting, I was going to ask the same question. \nI appreciate keeping behaviour the same but would you consider leaving a comment in the code please? The only way people in the future would know why that was there would be if they tied back the git commit's to the PR's they got merged in.\n. yep, good by me, thanks @joshhepworth :+1: \n. I'm not sure I follow whats going wrong with your attempts to extend it, but I am :+1: as I see no reason to need the custom translation here.\n. Are we sure we want to switch it to Shipping category from Shipping Category, which one should be the appropriate model name?\n. okay, thats fair to me than, thanks. I don't super care about casing myself but was wondering why the change. :+1: \n. :+1: \n. :+1: \n. Wow. Yea, honestly I have just been adding it to every app manually and hadn't considered where the include should actually be.\nThanks :+1: \n. if not, no worries, we can make @Murph33 do it.\n. I'm :+1: on this, but it might deserve its own note in the changelog\n. CI failed because you missed some references in db/samples\n. Yea, thanks for the changelog. :+1: \n. :+1: \n. :+1: \n. @mtomov I'd almost suggest we change it to be a trait rather than making this the new default for \"non-code\" promotions.\nWith this change we could be breaking stores test suites that were expecting the default to be the reverse (as it is now) for not a ton of gain.\nIf we created an :automatic trait we'd be able to change the \"automatic\" behaviour behind the scenes in the future, while giving us a good place to document to people how to create promotions that should apply automatically in their suites.\nAlso the more logic we can remove from after(:creates) the happier I am. Would even be nice to kill that magic around :code in the future.\n. Do we need to bump ours for this though? We still work fine with 1.6, can't we just allow > 1.6 and let people specify in their gemfiles if they want 1.7?\n. @kovalevsky I'd appreciate the change, I don't like forcing people to bump stuff unless its required by us.\n. Great, thanks @kovalevsky, merging!\n. :+1:, also with our without hawth's suggestion\n. :+1: \n. :+1: looks good, thanks @jhawthorn \n. Makes sense to me, :+1: \n. @cee-dub no worries, glad to hear you're overriding it locally.\nWe wait for a second thumbs up from a core member before we merge. Generally if its an improvement we'll merge it even if its \"rough\". CSS could probably make this better? But since its an improvement overall so its likely to be accepted as it is and we can deal with the intricacies of the UI later.\nThanks though! All improvements are super appreciated, no matter the level of polish.\n. looks good to me too thanks :+1: \n. looks good to me, thanks @yeonhoyoon. Also no need to add \"trivial\" to PR titles. They're all appreciated, be they typo fixes or adjustment modifications.\n. Yea, I had a chat with @jhawthorn about this IRL and I'm cool with it too. As hawth points out it more affects euro customers than it does NA, and I definitely want to start tracking more things unrounded so I am :+1:.\nThanks for pulling this bit out @mamhoff\nThis should probably make it into a changelog entry though.\n. Good by me too, thanks @mamhoff \n. This all seems really reasonable to me but I want to go over it again commit-by-commit with @jhawthorn. \nAs an aside, looking back I wish we made the TaxHelpers methods take params rather than expecting predefined methods on the included model.\n. I would prefer we make them take an arg list, as it gives us more flexibility about how and why they're used (like the \"ShippingRateTaxer\" needing to take the order in as a class param because of it. \n. @mamhoff this needs to be rebased against the module-takes-param work\n. Okay, I've read through this a bunch of times and don't have any serious feedback left.\nGoing to :+1:.\nAlso standard \"need changelog at some time for this\".\n. Thanks @Murph33 and @Mandily, looks good :+1: \n. I'm not clear which is the right thing to do here but @jhawthorn looks pretty confident so :+1: for me, though we could ask @graygilmore or @Sinetheta to look in as well.\n. yep, I'm good by this too, thanks @mamhoff  :+1: \n. @dholdren and I chatted this through in slack and the decision was to not modify existing payments if no new store credit payments were created in that call.\nLong term we need to refactor and clean it up, but that should be a good fix for now.\nThanks for hunting down the code for the specific issue @dholdren, super appreciated.\n. Yea, better than not having it, good by me thanks :+1: \n. :+1:, its slightly unclear why that check is happening to anyone not deeply familiar with this chunk of code, but as we are (lols, \"we\") working on removing it entirely I'm cool with it \n. I'm cool with this, I didn't realize previously that the \"refund\" label could only apply to VAT transactions. Thanks martin :+1: \n. :+1:, good by me thanks.\n. Yep, looks good to me too thanks, merging\n. Looks reasonable to me, however images are always appreciated of the before/after too. :+1: \n. I'm :+1: this, I think its cleaner and clearer than the  module expecting specific methods defined by anything that includes. \n. :+1: \n. I'm not super happy with how these options are playing out, but I don't have any concrete suggestions on how to improve it otherwise. \nSo lets say I'm tentatively :+1: \n. Good by me, :+1:. \nFor the person that loses webmock and finds this later: just add it to your own gemfile. \n. Looks good to me, thanks @Murph33 :+1: \n. I am good too, thanks @mamhoff \n. Cleaner and more specs running! Thanks :+1: \n. Good by me too, thanks :+1: \n. good by me too, thanks @Murph33 :+1: \n. good by me thanks :+1: \n. > It seems that bundle exec rake railties:install:migrationsline doesn't actually do anything. Is it necessary to run that command?\nI'd prefer to leave that as if anyone jammed other extensions or the like into their gemfile that will install their migrations as well.\n\nIt might be good to add an instruction to add run rails g solidus:auth:installto create the secret key.\n\nAgreed, we changed something recently that stopped it from getting created by default.\n\nAlso, the images would not show up without installing imagemagick, so a comment about installing that is probably required too.\n\nThis is fair too, as we rely on paperclip and this is required to get anything done in that. I'll take a look tomorrow at adding these two things in, thanks for the input.\n. @yeonhoyoon Wow, good catch, thanks. :+1:\nRe-running specs as I don't believe the failure was related.\n. :+1: with or without the spec\n. I'm good by this too, as going forward it would be nice to count on an order having a store. The original migration set up the store_id on orders set them so we should be good to count on this usually being there: 15df7e7133c77e6724eb5ad1fb8f7cf755c42799\n:+1: \n. Added regression feature spec, felt that was the most appropriate way to do the regression.\n. Added regression feature spec, felt that was the most appropriate way to do the regression.\n. Looks fine to me, thanks @jhawthorn :+1: \n. Do we need to take this in via the interface now too?\n. Yep, I'm getting on the :+1: train too, excellent work as always @mamhoff. Temporary slowdown for vat is a small price to pay for moving this forward.\n. @jhawthorn can you take care of this with the TOPPEST OF PRIORITY please? I assume getting asked by @rafaelfranca to do something means we're now a legitimate project.\n. This all looks right to me, and I can't think of how this would affect anyone using these as they are now, but I might be missing something? Is this completely transparent or is there anything we need to make people aware of while upgrading?\n(also: :+1:)\n. This came out of a discussion in slack where someone asked why we don't delete the shipments if we delete the last items inside of them (on a .complete) order.\nWith further discussion we found out the larger problem was we would not show admins empty shipments on an order, so by deleting the last order admin's did not know there were now \"empty\" shipments on that order.\nI am strongly against automatically deleting shipments (as we lose things like tracking numbers that might be associated to them, other potential associations, etc) and would rather we present admins with the ability to delete them if that is the desired outcome.\n. Aye, that was my way of being :+1: on this, sorry. It might be worth sitting @Mandily down and having a talk from a UI/UX point of view though.\nThe admin screens, what they're showing (shipments or line items or who knows?) has always been pretty hard to understand and comprehend. She might already have plans for the future.\n. :+1:, thanks @ayb.\nGotta love class_eval'ing our own codebase.\n. I also like this but reckon it will need a changelog if it goes in, as we are technically immediately removing a method from the public API.\nI have such a poor understanding of what a \"package\" does I'd rather this be the only thing accessible by a co-ordinator, and agree it would give us more flexibility to (eventually) make some meaningful changes behind the scenes if we can get this in.\n. I have no opinion one way or the other, whatever consensus we end up with is good by me.\n. I'm good by this one now :+1: \n. :+1: \n. Looks good to me, thanks :+1: \n. Yea, looks good to me too, thanks @eric1234 \n. @eric1234 just needs a rebase, when you get a sec\n. Good catch @eric1234, big :+1: from me too.\nAlso fantastic commit messages as always, super appreciated.\nEDIT: whoops. closed by accident, apologies.\n. Rather than the code, I'd prefer we do this as a preference with a default value of off.\nI certainly appreciate the attempt (and the spec), but default off with a note in changelog to re-enable seems reasonable to me. \n. @eric1234 aye, I appreciate the attempt at backwards compat. We ended up in this feature in core from before solidus dev was done publicly (it was included in a giant rebase to get a few branches together 18 months ago) and I know its not widely used enough to maintain backwards compat.\n. I'm :+1: on this too.\nOur long term goal is to be properly semver'd, but aye with the code base we have it'll take a while before that is achievable. For now I think the changelog entry is entirely reasonable.\nThanks a lot @eric1234\n. I think phantomjs dies pretty randomly and uncontrollably on the CI, which will cause other failures.\nHawth is the expert, but I think the best way to move these forward is to figure out what is up with #806 and get our poltergeist updated.\n. Personally I'm :+1: this, especially for a partial so likely to be overwritten for a store.\nBut I'm also not sure of our stance on these types of changes (see: #640, though this is definitely a different situation). Do we take them on an as-sent basis? Do we namespace all routes in our views in the admin going forward? Etc. \n. Looks good to me, thanks @jhawthorn \n. All looks good to me, thanks hawth :+1: \n. All looks reasonable to me, thanks @Murph33 :+1: \n. @Murph33 I'm okay with that for now, we can address that as a separate issue if and when we need to.\nI'm still :+1:  on this.\nAlso when we say \"change log entry\" we usually mean the actual changelog.md file in the root.\n. Looks reasonable to me :+1: \n. @121onto this was fixed for regions/countries in #874 and should be in the next release.\n. Aye, thanks @jhawthorn and co, looks good to me too.\n. The changes all look good to me so :+1:, with disclaimer I haven't pulled it down locally and ran it.\n. Aye, thanks for catching @docelic, also sad we missed it. :+1: \n. I'm never a big fan of calling anything \"Legacy\" something, is there a more descriptive name we can give this that better describes its behavior? (and maybe would be clear in its differences when we create other ones).\n. :+1:. \nI can't find any specific discussion that seemed relevant on it actually getting implemented using the  MutationObserver other than a bullet point here: https://github.com/twbs/bootstrap/pull/17021\n. Looks good to me, thanks hawth. I guess these are all towards our eventual fixing of FA?\n. Looks good to me, thanks. :+1: \n. Ugh, so update_positions is inherited from the ResourceController. There is probably a lot of broken routes that we expose but don't actually support.\nI'm :+1: on this, a test that it acts like a list would be nice, but getting it in to fix our existing broken route would take priority over a test for me.\nThanks @devhyunjae\n. Yea, I'm good by this too, thanks @jhawthorn  :+1:, and for reporting @dholdren. \n. Yea, same deal as the other big JS refactorings, went through commit-by-commit and it all looks good to me, thanks @jhawthorn :+1: \n. Do you have the exact line its failing on? I tried to recreate locally in the sandbox by deleting all the images for a product (and then all images in the databsae) and couldn't get it to fail.\n. @modreoci that should fall back to a new image, which should use the paperclip default image. \nIf you load it in a console what do you see:\nSpree::Product.find(my_product_with_no_images_here).display_image\n. Yea, your default_url is broken as .extension will have nothing to interpolate to (as you don't have an image).\nYou can set it the default to start\ndefault_url: 'noimage/:style.png',\nand work from there\n. Good by me too, thanks as always @eric1234 \n. Aye, good plan here, thanks folks :+1: \n. Yea, I'm good by this, thanks. :+1: \n. I'm very much happy with this compromise :+1: \n. I'm fine with this too, if it helps anyone read or navigate its good by me.\nIf you can squash the 4th typo fix into where it happened, and squash the first two together, I'll be :+1: \nEDIT: Just realized the typo wasn't introduced by you, leaving that as its own commit is fine, sorry for the confusion.\n. Thanks a lot for the writeup, this is a pretty tricky issue and the clarity is very much appreciated.\nI'd prefer to do a new migration adding lengths rather than editing the existing migrations. I'm worried about the states different stores are going to end up in. Adding a single migration to ensure everything is in the right state seem like the right way to go for me. Of course we'll need to decide what that \"right state\" is and what limits we should have everywhere.\nI'm not a big fan on the DbMaximumLengthValidator (Assuming we're talking about the one that was added into spree 3), but more on principal than objecting to the implementation.\n. I'd like to throw this in as a potential way to set the validations. It will use the limit from the database if one exists, or fall back to the hardcoded value if nothing is set.\nruby\nmodule Spree\n  class Address < Spree::Base\n    validates :firstname, length: { maximum: columns_hash[\"firstname\"].limit || 100 }\n  end\nend\n. @alex-handley ha, that was my thinking too. I prefer my inline to using the DbMaximumLengthValidator (if for no other reason than we can provide a default length), which would let us kill the validator from core (or at least deprecate and kill in the future).\n@jhawthorn opinion?\n. @alex-handley we're going to need some kind of check/guard/something at the top of this migration to do a sql max() length of the fields to ensure we don't accidentally truncate anyones data.\n. I'm torn on having the \"add after order complete\" being a separate objects. I almost think it should be supported somehow by the wallet API itself to keep the api more cohese and clear for anyone using it.\nI'd almost expect something more generic to be called like:\nruby\nwallet.events.order_complete(order)\nwhich users could do as they wish with (including persist it, if desired).\nThe second one, the add_default_payment_source I'm weirded out about for another reason. It seems weird that a Wallet:: class would be responsible for creating a payment on an order after a transition. But thats maybe mostly related to how ugly it is now.\n. I've thought about this one for a few days and can't think of anything that would improve it, and I think its better than what we have now, so I'm at a :+1:  if @jhawthorn is.\n. I'm cool with this :+1: \n. This looks pretty good to me, thanks @mtomov, :+1:. And I have nothing valuable to add to the open conversations.\n. Still good by me, nice work :+1: \nWe're almost definitely going to need a changelog entry for this change though.\n. I really like this change. Looks very sensible, will start simplifying a lot of junk in a lot of extensions.\n. Whoops. Thanks for catching that, @Murph33 when you get a sec can we get a spec that runs through this view please.\n:+1: \n. Yea I'm for cherry-picking that over. So long as we still get the same commit message.\nAnyone that wants it back (which I can't imagine anyone would) can just add it back in themselves to their own project.\n. @apepper fantastic, thanks :+1: \n. Aye, good by me too, thanks :+1: \n. I'm okay with this too, thanks for the change :+1: \nThough I imagine long term we'll want both those styles dead...\n. I'm good on this one, thanks :+1: \n. @jrochkind would you be kind enough to rebase, please.\n. I'll leave this one up to @jhawthorn as he is the local paranoia expert, but I'm :+1:  if he is.\n. This looks like a fine idea to me. Nothing worse than a migration that dies half way through for something easily avoidable.\nDoes this work with the arrays though? \nSince \nruby\nsafe_add_index :spree_adjustments, [:adjustable_id, :adjustable_type]\nwill call\nruby\ncolumn_exists?(:spree_adjustments, [:adjustable_id, :adjustable_type])\nwhich I don't have any reasonable expectation to work.\n. Looks good to me now, thanks :+1: \n. Thanks @Murph33, (and @adaddeo), good by me. \n. Yea, looks great, thanks @dangerdogz  :+1: \n. I'm also good with this, thanks @jrochkind, looks like that would be pretty terrible to debug :+1: \n. I'm not sure I prefer this rather than ordering the shipments, but no reason we couldn't do both :+1: \n. nice catch, thanks :+1: \n. This actually looks like a pretty reasonable approach to me. We will need to ensure that we have something friendly for non-auth-devise usage as well but I think its pretty low hanging fruit to remove every round trips from every request. Would be a good target for someone during the hack days next week, too...\n. Yea, this isn't amazing but I'm okay with it for now. We need to figure out how to do this better later.\n. (in case I wasn't clear before I was :+1: on this).\nKevin is also doing similar(ish) things right now with the breadcrumbs, might be a good idea to sit down tomorrow and talk some of this through IRL.\n. Quick warning from your friendly neighborhood core team! We're okay with this now in the \"We can't see anything wrong or can suggest any better ways to do any of it\", so unless we get any kind of feedback in the next 24 hours we're going to merge it!\n. @stewart is this going to be used somewhere in the codebase or is the point just add it for general support?\n. :+1: \n. Yea, I'm good on this as well, thanks @adammathys :+1: \n. This looks good to me, thanks :+1: , but I wasn't really clear on why we needed this in the first place. @jhawthorn?\nFor record I pulled it down into the sandbox, edited routes, and everything worked as expected.\n. @mtylty I think its more of a \"one PR per what makes sense\". Would be nice if it was a small enough unit of work that was quick to review, but in some cases it might make sense to cut through multiple things at once.\n. I'm :+1:  on this now, btw. Thanks for updating it.\n. I'm both pro-trailing-comma and pro-less-rules :+1: \n. Looks good to me, thanks :+1: \n. I caught the live show of this and am inherently :+1:.\nNot just because it is @jhawthorn wandering around fixing problems I am having, but also because if its @jhawthorn wandering around actively fixing my mistakes. \n. Yea, this is great. Actually fantastic. I can't imagine how many dev hours this is going to save people in the future.\n:+1: \n. @mtomov iirc receive_messages doesn't use a verifying double unless you configure it to, which will be default in future versions of rspec but not with what we're currently running in core.\n. @flyfy1 aye, running a store sans default currency doesn't make any sense, but we expect developers to set up the store in config rather than logging in as an admin.\nThe history of the \"settings\" page was aimed at supporting \"hosted\" spree, where admins could set up their stores using the settings pages, but it led to a bunch of very difficult situation:\n- admins changing settings with unforseen consequences\n- dev/test/prod/staging environments with different configs\n- serious caching issues when switching live settings wouldn't invalidate caches\nWe have been phasing out of those pages in exchange for config blocks for many versions now, this commit just cleans up some JS that was accidentally left in.\n:+1: \n. I would prefer to do something like give an id to the fieldset its in and target it that way (#add_product_property_form table), but I'm mostly okay with this too\n:+1:\n. good be me too, thanks as always @jrochkind :+1: \n. Aye, good by me too :+1:. I solved this a different, likely worse way...\nwe should think about yanking versioncake from core. We don't use it and I doubt we ever will.\n. :+1: \n. Looks reasonable to me, thanks :+1: \n. Aye, I'm good with this too, making life easier for old stores to upgrade is nifty :+1: \n. :+1: \n. :+1: \n. :+1: \n. I've been poking into this and there are a few things here.\nThe biggest API change is order.tax_address used to return nil if the order had no shipment/billing addresses. That change was made for the very positive reason of cleaning up an orders taxes/zones with regards to what store it is in, but was an undocumented behaviour change for 1.3.\nIt would have been less obvious (and probably completely unnoticed) if we did more to ducktype the Spree::Tax::TaxLocation to be more address like.\nSo I think we should either:\n1.  Do more to make TaxLocations behave like addresses\n2.  Always return TaxLocations (and just build them from the ship/billing address)\n. looks much better to me, too, thanks! :+1: \n. All this looks reasonable to me, all better than what we have now, so :+1: \n. All this looks reasonable to me, all better than what we have now, so :+1: \n. :+1: \n. :+1:, thanks.\nFor the record I spent an unfortunate amount of time trying to figure out what \"specs\" this would fix. :coffee: \n. What is it that lets it be valid if we .new it? Is the state 'invalid' so it skips the source check?\n. :+1: , thanks @Senjai \n. Makes sense to me, thanks @mtomov  :+1: \n. I'm fine with this, I wasn't too impressed with that in the routes.rb anyway\n:+1: \n. These all look right to me, so :+1:.\nDisclaimer I haven't ran it locally. Also I don't care about that hound warning.\n. I'm a serious :+1: on this as well\n. Closing this as I don't think anyone has a solid plan on how to move this forward (but the PR is good information if anyone moves it forward).\nI personally believe our best bet is to stop representing cancelled items as adjustments, but that is a pretty sizable change.. :+1: \n. I don't think its reasonable to support hacking JWT in with an if/else like this. I think the approach we should take is make the authentication system pluggable and then offer JWT as a separate implementation (preferably in an extension?).\nDoing it this way makes it tougher for people to add more complexity to authorization (like supporting two methods of authorization).\nAlso we'd need to add JWT as an explicit dependency of solidus_api.\n. I'm totally aware this might break some code as stores might not be expecting us to operate on the in-memory objects, but I'm 100% for the change. I think the order updater should always be operating on the in-memory objects and the more of these changes we make the faster and cleaner our updating process will be.\n. I'm totally aware this might break some code as stores might not be expecting us to operate on the in-memory objects, but I'm 100% for the change. I think the order updater should always be operating on the in-memory objects and the more of these changes we make the faster and cleaner our updating process will be.\n. Thanks for the attempt, but in an effort to close some stale PR's we're going to close this.\nIts not too hard for other auth systems to handle post-signin however they want, and trying to pull this functionality into core isn't a clear win.\nAdditionally, I don't think it should be inside Spree::UserMethods, as I don't think it should be the models responsibility for deciding what should happen to itself post login.. :+1: \n. I think this is a good change ( :+1: ) and would be down with killing that memoization\n. Looks good to me :+1: \n. Good by me, thanks peter :+1:.\n. Looks great to me, really fantastic work, thanks :+1: and anyone that contributed eyes.\n. I'm good on this too, thanks jordan :+1: \n. @swively you'll also need to update the RefundController in the backend to perform! as that is what happens now.\n. :+1: \n. Its been Agreed that since these are paranoid, we're better to keep the sources around.. I'm pro this change of behavior, and how you have it implemented. :+1:\nWe'll definitely need a pretty solid changelog entry though, as some stores might have been running extra logic when promos were being applied to carts, which could potentially now trigger earlier than stores would otherwise expect.\n. :+1:.\n. :+1: \n. :+1: :fireworks: \n. I am very pro this. I think most people end up implementing GA on their own and don't use these views, let alone the Tracker models. Maybe we want to have a different GA extension that implements a reasonable set of views? But definitely this is a good step forward.\n:+1: \nThough we will probably want to move the external extension into solidus-contrib.\n. Looks reasonable to me :+1: \n. Good by me too thanks :+1: \n. After logging in (or registering) do you have a user or email address associated with the order? It looks like you are logged in but the user isn't associated to the user.\n. @ericsaupe do you know how either of those would return nil?\n. @jrochkind yea, but since this is 2.0+ I think we're good.\n. Hey, sorry @vladstoick, I am super interested in getting this merged into core I just lost sight of the PR and you have my apologies, thanks for sticking through and poking us again.. Looks good to me, thanks. Can you change the commit title to remove the reference to the issue though, please? You can add it to the comment body and that would preserve the link.\n. I'm pro swapping to html5 validations as well, though I know very little about them.\n. Yea, I'm pro leaving the tests in. Since we're testing the output, which is the text string, not the implementation, which we know goes through standard rails i18n.\n. I'd be okay with something like a shared example for calculators that just tested that there was a non-zero length string there\n. As this is the default frontend, which is widely replaced anyway, I'd be pro putting in html5 validations with a warning in the changelog that someone might want to polyfill in something for iOS. \nIt wouldn't stop individual stores from using whatever they wanted, and we'd be reducing our reliance on an external lib in a forward-looking way.\n. I've noticed this come up in our analytics before, I don't think its reasonable to even expect just external links to be rendered correct and consistently, as other people could share a link with the extra trailing slash.\nI'd be for setting the canonical link on the product page to what is proposed :+1: \n. @jordan-brough yea, its a bit tough since if we dont rollback, its quite likely orders are in the \"wrong\" state for other reasons.\nMaybe we should consider some kind of datastore which would be responsible for handling certain types of records in case of _rollback?\n. For the record I am :+1: on this, but do echo Jordan's concerns\n. I think the idea with how this code currently functions is it will maintain all promotions on an order, but only use the one that provided the greatest savings.\nThe idea being, if I added one coupon code for \"$10 off\" and another for \"10% off\", at some point in time the 10% off will become more valuable and that should be that one thats used (which is why we I believe we don't remove promos from an order).\nI'm not saying I agree that should be the default behavior, but its why any changes like this are going to be pretty serious discussions as it will be changing default behavior in a pretty subtle way, but something many people are quite likely counting on.. I'm with @flyfy1 on this one in that I'm not sure under what circumstances the wrong product will be called, could it be something like code you've copy-pasted into a decorator that is causing the issue? I tried a local repo and couldn't recreate the undesired behavior.. Personally I think we should always assume that if an order exists its line items are there as well. I consider them an integral part of the order.. I have nothing against explicitly listing classes for associations :+1:  . @flyfy1 can you paste a snippet or something of some factory code that would exactly expose this problem on the sandbox? Would help a lot for debugging purposes.. @bbuchalter doesn't subject memoize as well? I don't believe your spec addition actually runs simple_current_order twice. . @bbuchalter hey, my apologies, the return in simple_current_order means if its memoized its only going to be executed once, so right you are.. I have objections to the existence of simple_current_order, but are not appropriate for this PR, so thanks @bbuchalter and double thanks for helping me through that misunderstanding . I think this is probably worth reaching out to a few places CS departments and do a quick ask to see if they ever use email addresses with \"contains\" like that. I know people could override the view and switch the query param back, but its potentially a disruptive thing. It would be nice if we could support wildcards ourselves and let people decide when to use them.. Good by me too, nice step forward, thanks :+1:.. Looking through the devise PR (and every other PR that references it), it does look like wrapping it in a respond_to? check is the community preferred way of solving the issue.\nhttps://github.com/plataformatec/devise/pull/3732. @anulman I don't personally think any additional tests should be required for this, though eventually we might want to rails-api spec in place (not sure how that would look).\nA pr with just the surrounding respond_to? check would be fantastic, thanks.. Looks like a legit failure:\nHINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.\n: CREATE  INDEX  \"idx_apply_automatically_promotions\" ON \"spree_promotions\"  (\"apply_automatically\") WHERE apply_automatically = 1. Now we have to live with those red :x:'s forever.. We had a similar discussion much earlier (back when we were still a \"new\" fork) and decided not to do this as we thought it would be much harder to cherry-pick spree commits, and had a large number of other branches lying around.\nRight now though I think we're in a pretty good state, and there hasn't been any commits we've cherry picked from spree in the last few years, so my personal preference is we go ahead and do this. Whether we do it slowly, or do it in a \"big bang\", the work has to be done and the \"blame\" for that line is going to be off, but right now we're only talking some ~650 lines which really isn't many.. This relationship exists in the complicated it way is now because inventory units can be associated to multiple shipments through... returns? or exchanges?\nYou can see all the failures, we do in fact have behavior that relies on this (for better or worse), and these will not be easy changes to make.. @mamhoff I don't think we need to push to solidus-contrib if we push it to rubygems. if anyone ever runs across that extension, its not like we want them to use it.. Hi @pascalj, sorry about the slow reply, I've been internally going back and forth on this and its generated a few pretty hefty conversations.\nI definitely think the change is a good direction (multiple captures when payment gateways support it), but I'm worried that this is going to be a big change that everyone will get, even when multiple capture is not supported by payment gateways.\nI do however think this is a very reasonable, and not too intrusive for an extension, would you consider supporting it in that way? If it lives there for a while and the kinks get worked out, I would be happy to re-examine it for core in a future release.. Hi @skukx, a few of us are in the middle of a conversation about this IRL and we're trying to get a better picture about how people are using the state machine on shipments (because as you can see it has a lot of issues).\nCan you share what it is you're looking for on ready being called? Is there a \"better\" time you actually want it called, but are hooking into ready because it should be easy, or is shipment.ready for sure the exact time you want something to be executed?. Cleaned up the list of seeds and removed any trace of humour from the deprecations. Closing this for right now. Learnt what these did and realize I have to kill them harder.. @kennyadsl oh nice :D. should have looked first. So @omnistegan how is #1956 looking? (also I'm looking at you right now, when you're curious about why I'm staring at you later).. Okay with #1956 gone this is good to go whenever someone has a sec. I'm hardly the right person to comment, but everything here looks reasonable to me.\nThough we'll likely have to do a semi-large manual QA to make sure there aren't tables somewhere in the deep dark parts of solidus we will need to change.. Ahh, I guess require_dependency is what the autoloader uses to do these things. But yea, I'm happy explicitly spelling it out. . Spec failure is unrelated, should be fixed by #2117. Good call hawth, added.. I think we can write this up to a circleci blip, I don't care if we merge this one or #2166. We can make @swcraig write a regression feature spec for this. . Closing in favor of  #2176 which includes the regression. When you see anything that looks like this: my_instance.() it calls the call method on that object, if its an object, or will invoke a proc if its a proc.. This all looks good to me, are the changes here 100% compatible (as far as you can tell) or is there something we should maybe be aware of that behaves differently?. We'll need a serious change log entry for this. Everyone that has extended or changed rabl templates will have to adapt.. @benjaminwil can you give a shot at re-creating this please. Merged through another PR. Hmm, definitely looks like a bug to me. Happy to take a PR or we can get @swcraig on it.. Certainly looks like Spree::Price belongs with the other product management permissions:\nhttps://github.com/solidusio/solidus/blob/master/core/lib/spree/permission_sets/product_management.rb. @swcraig you may as well just do it, it should be pretty quick. Thanks @loicginoux, hopefully you're cool we sniped your PR opportunity, thanks for offering though.. Killing this one as #2178 accomplishes the same goals and is a better move forward, thanks though @swcraig . I'm not picky on colors at all (or the default frontend, for that matter), but @Mandily might have an opinion. . I thought I could remove the autoload, but I also needed to add the require.. We added the 3.0 milestone as we're going to hold off merging this behaviour until a larger version bump. We're worried about how the validations will impact stores for speed and unexpected behaviour.. @swcraig can you take a look at this please? I Imagine it might be from me stripping highline from core.. PR is merged, can you try this again @swcraig ?. Yea, it'll be a fair number of more changes before I can actually remove the rails dep from solidus_core, but without this work that'll never be possible of course.. Here is a quick diagram to help illustrate what this PR is working to achieve:\n\nThe goal is for solidus_core to provide ecommerce functionality independently from what web framework we're using to deliver the content.\nAnecdotally, this removes 20 more gems from the requirements of solidus_core.\nMore importantly, it lets me use and work with the solidus models without also requiring all of rails, a huge benefit to me when I'm developing stores and libraries locally.. Here are some timings for running the state_spec.rb 5 times in three different environments:\n1) Solidus Core\n2) My Branch, using my rails_helper\n3) My branch, using my db_helper\nIn host applications we can expect the same spec would take significantly longer (9+ seconds each) as we'd be booting up entire rails applications. \nfor i in `seq  5`; do bundle exec rspec spec/models/spree/state_spec.rb; done;\nSolidus Core:\n./state_spec.sh  11.54s user 1.66s system 99% cpu 13.306 total\nMy Branch, rails_helper.rb:\n./state_spec.sh  7.23s user 0.84s system 98% cpu 8.172 total\nMy branch, db_helper.rb:\n./state_spec.sh  4.74s user 0.53s system 98% cpu 5.348 total. At the very least I think we'll need to add activesupport, activejob, and railties, which are the three I know we depend on inside of core.. @BenMorganIO aye, Rails is from railties, but we don't have that dependency, we get it through other gems that do explicitely have it listed, which I don't think is good to rely on.. Have we ever talked about having a second storage mechanism for stuff like this, separate from our AR?\nWe're fighting against our technology with things like the log_entries, and it seems to me it would make more sense to shove it in some kind of document or object storage, its not like we ever actually do anything with it in terms of querying.. @tvdeyen error_on re-checks .valid?, which is first checked in the before block on the parent context, but not again after the object is modified in the nested before. pushed up a fix.. The circle error was my fault, typo'd something, fixed it and its fine now.. :+1:. Okay, I don't personally agree with the require_dependency over keeping the class definitions the same, but I'll switch it. Are we okay with me leaving them broken out so its clear Calculator is a class and not a module?. If at all possible can you let us know exactly what you do? We really should start gathering up all the \"business\" problems for ben for his documentation, and if you come across a successful approach long term we can think about how better to handle/help these decisions in core.. Full disclosure I directed and helped @swcraig so I'm implicitly biased but also :+1:.\nWe often don't use paperclip in all of stores, and where we do use it we (maybe) probably shouldn't.\nPulling it out into an extension and preparing for the future or alternative image implementations is a :+1: for me, as long as you can drop in the gem seamlessly.. Aye, I've been burned too many times by our paranoia stuff to want to keep it around. I imagine most of these are individually not giant changes, and there isn't any reason we couldn't try it with one model first and see how much work its going to be, right?\nI also can't imagine too many cases where extensions are really going to care about what we're using for deletion.. We only barely use stringex in core, I bet we could bump it pretty safely (to fix the original dependency problem), or relax the requirement to allow 2.x if that works as well.\nI also see no reason to not relax the deface requirement in solidus_static_content as well.. Ha, if your description is right this is for sure a big problem. If you're able to write a regression test that would be very appreciated, otherwise someone like @derrickp will take a look.. Defering to @benjaminwil on my :+1:, but thanks for sending the PR! Updating docs is a terrible, thankless task but we really appreciate it.. @kennyadsl @mamhoff I threw another commit on here before I saw your approval. I can either split this up into another PR or you can weigh in on it being okay.. It tells programmers what and how to upgrade, rather than having to hunt down what is happening.\nSo I am :+1: \n. can we do this with a \nruby\nSpree::Shipment.where(pre_tax_amount: nil).update_all('pre_tax_amount = (cost + promo_total) - included_tax_total)\nrather than the exec? its a nit-pick but will ensure right table names or whatever are used.\n. Assuming that IS the name of your spree shipments table...\n. agreed\n. I support extracting it and freezing it, but I don't think we gain enough semantically to bother switching it to a set.\n. Aye, I appreciate its more accurate but personally would rather leave it as an array as it is everywhere else in the codebase and then deal with the set on a global level rather than having the two mixed uses of convention.\n. My preference would be we let things settle for a few more days/weeks before we global change stuff. I reckon there are going to be a pretty large amount of people looking to cherry-pick changes in spree 3 or master and adding something white noisy to the merges isn't worth it being in a few days early. And then anything in those cherry picks would be globally fixed as well.\n. @mbj freezing all PR's/dev we're done cherry picking from 3.0 would be excessive and I'd way rather have the codebase moving forward. \nDoing large global changes are way more likely to cause conflicts (as they're touching more things), and while I agree they'll be in improvement to the codebase, waiting a bit would reduce friction in cherry picks. Its not that we're removing all conflicts, just attempting to minimize them for a set period of time.\n@lightcap I'd be happy picking a date. I'd propose Dec 1st as a month seems like a reasonable time for people to have identified they want to move onto solidus from the 3.x branches and poke through the things important to them to attempt to get them PR'd in. It would be nice to grab as many of the commits from your performance patchset during this time as well.\n. We can definitely agree that this isn't quite the appropriate place for this discussion. It does sound like you have some specific rules/guidelines/axioms you'd like the project to adopt, would you consider opening up an issue for them?\nThough it would be great if anyone else wanted to weigh in on the \"when to do a global replace\" discussion. I don't consider it a \"feels\" decision so much as a pragmatic call that doesn't really warrant enough investigation or decision making to warrant any kind of \"scientific\" investigation, but am curious on other opinions.\n. I'm more a fan of killing it, as it wasn't ever actually published in the public API on the old docs site:\nhttps://guides.spreecommerce.com/api/taxonomies.html\nWe can make a note in the release notes pointing to the commit if they want to pull that code into their own stores. I would consider that a better upgrade path than supporting it as an extension.\nThough not removing the routes and just axing the javascript is still a good improvement... Maybe we do leave it till we just deprecate the entirety of the API.\n. @Sinetheta yea if you can at least pull those commits that remove the ruby side out into a separate PR it would be nice.\n. I don't like that as it has a potential side effect (adding errors to the model) which IMO isn't expected with ? methods\n. I don't like that as errors could be non-empty from another validation/operation and I don't want this to return a false-positive\n. was the logic here wrong before?\n. probably didn't want this file. \n. do we need to be worried about included_tax_total ever being nil? I'd had to nullify pre_tax_amount from included_tax_total being nil. Should we switch to WHERE pre_tax_amount is null to be safe?\n. This prompted an in-office conversation over here, with @jarednorman chiming in something to the effect of: \n\nI dislike computed expected values, which is what I consider that to be\n\nWhich I generally agree with. I'd say we leave it with the explicit translation and change the tests as we change the locales rather than testing on the computed value of Spree::Something.human_attribute_name. I don't expect the tests to break often, nor be hard to fix.\n. Shouldn't these be using Spree::Shipment and not Spree::LineItem?\n. agreed\n. Its the name of the other model. Its referencing what StockLocation it belongs_to, so referencing what a StockLocation is by the way of that table is perfectly reasonable\n. Should these be fixed here too? Or are they going to be a separate PR?\n. Should this be Spree::Payment.human_attributes_name(:identifier) ? or something fancier including the model?\n. can this be removed too?\n. Kill it.\n. as we no longer implement model_name ourselves I think you can safely kill this spec now\n. I think we generally use Spree::StockLocation.human_name for these, no?\n. was this missed for a reason or can it be done as well?\n. Can these two be jammed in translations as well?\n. this can be done on the model as well.\n. That commit gets pretty fancy, maybe something like: \nruby\n    def safe_add_index(table, columns, options = {})\n      if Array.wrap(columns).all? { |column| column_exists?(table, column) } \n        && !index_exists?(table, columns, options)\n        add_index(table, columns, options)\n      end\n   end\non the original commit would be easier/cleaner?\nor something with cleaner formatting.\n. you can still pass the options to column_exists in the block I pasted above.\nYea, little heavy for me. Happy to have anyone else weigh in, but aye, I'd say kill it for the sake of brevity.\n. I'm a toss up on this. When we first discussed it In Real Life at solidusconf I was a fan of it going into core, but I didn't realize it would need another table with it. I see arguments to leave it out and make it a public extension or bring it in as its an incredibly common request.\nI'm less swayed by the arguments of it being potentially abused. I'd rather burn that bridge when we come to it.\n@jordan-brough @gmacdougall @tvdeyen opinions for bringing it in or leaving it out of core?\nGood code though, I'll definitely end up using this either way. \n. We can strip these comments now, I don't think they add any value\n. Rather than this being a static method on the class I'd really like it to be an instance, as it would allow the filter to potentially render different sidebars depending on its filter logic.\n. if we instantiate the presenter class before the partial and pass it in as a parameter to the view we'd be able to make the partial_path an instance method and give stores tighter control of how things can be extended\n. I like either of those options too.\n. Honestly I'm fine with just a deprecation warning and kill it in the future.\n. this has an extra \"c\"\n. is this right? should it be first.id: 3?\n. I'm pro reducing and removing our reliance on active_merchant in core, so I'm :+1:  on copying it in (it also isn't something that changes frequently).\n. I don't really like them, but it might be better than what we're doing here? @jhawthorn I'll leave you as tie breaking vote.\n. Can you return some kind of status here instead? something with a symbol or something. so we can use locales to display the actual text. When we hardcode english like this, people that speak weird languages become sad and complain to me in private messages.\n. can we limit this to just respond to the :csv format?\n. could you push these to locales too please\n. whats the reason this is getting reloaded here?\n. can we cut down the stubbing in the mailers and instead look at the test deliveries to see if they contain the content we're expecting?\n. can you hardcode number_of_codes for all these tests? its more clear to asset something is equal to a specific thing rather than a variable.\n. can you kill the stubbing in this? I don't think its too costly to create a promo batch with a code to avoid the message chain\n. is this the same thing that was stubbed above? is there a way to kill those two things?\n. ha, nice catch Martin.\n. I think we can get this out of Carmen, as \"subregions\" have a \"type\", which would save us from needing to use or populate this\n. I'm not 100% sure thats safe, I'd prefer something like:\nruby\n\"SET available_to_admin=#{ActiveRecord::Base.connection.quote(true)}\"\n. I don't know if I agree with CSV headers being i18n'd, as they might need to be parsed by external systems... so I'm also a toss up. So I'm probably good with this as a default, and as Thomas says letting people override if they don't like.\n. I say ignore thomas and let him work on his own backlog, as this PR is separate from that feature.\n. can you create a CantProcessStartedBatch exception and call that instead of the raise please? Makes finding different exceptions in external systems way easier.\n. This makes Rails 3.1 sound new and fancy.\nCan we change this to something :\n\nSolidus leverages Rails' asset pipeline to allow for extension and customization of frontend and backend assets.. I'd remove the \"3.1\" here and just say Rails apps.. Why don't we use https://github.com/solidusio/solidus_auth_devise/blob/master/lib/generators/solidus/auth/install/install_generator.rb. This breaks the link at the top, as well.. Is there a good use case for this? Or is it just for like... digital goods or something? I would say bringing attention to it might not be worth it here unless its something we want to be keeping long term.. Whats the rational here for returning the in_cents rather than the money object and letting the caller do with it as it wishes?. Can you replace this call with the actual number its supposed to be, please. Doing it on the computed amount from the setup makes it tougher to figure out what should be happening (though this calculation would be nice to keep in a comment or something).\n\nYou can take a look at the tax specs and see how much more readability it adds when you're really trying to figure out whats happening: https://github.com/solidusio/solidus/blob/master/core/spec/models/spree/calculator/default_tax_spec.rb. Does this work reasonably with the current default behavior and guest checkouts?\nhttps://github.com/solidusio/solidus/blob/master/core/app/models/spree/wallet/default_payment_builder.rb#L14\nIts tough to trace all the way through easily (with all the aliases and whatnot) but I think we'll get the default set to nil if there is no user? Though none of our specs seem to be failing.... This can get cleaned up to \nVariant.where(product_id: all_products.pluck(:id)). I don't think this is really worth being a public method, its more likely anyone that wants this will not know it exists and call descendants.pluck(:id). self_and_descendants is provided by acts_as_nested_sets so this can get cleaned up with\nself_and_descendants.pluck(:id). I think the whole thing can be done in one query with:\nruby\n Spree::Product.joins(:classifications).joins(:taxons).merge(self_and_descendants).distinct. I think this button was removed accidentally? Its needed to submit the form, and thats what made the tests fail. If you add it back in, I think the tests should start passing.. Anything that adds a transition I'm not a huge fan of, will talk offline though.. Discussed IRL, not reasonable to do with this PR (which doesn't change behavior). We'll need to change behavior to fix it elsewhere.. I split it into another commit. Long story short, without the order const loaded, EmailValidator isn't properly loaded and now that the order const isn't loaded when its factory is, this isn't required anymore.. I will once the deps are actually removed, aye. There are still lots of rails calls inside the codebase (and we still have the engine in there).. railties too please. I'll end up pulling this commit out, as I sent it separably as #2312. Its not require_dependency'd everywhere its defined/used. \nI'd say we fix the definitions to be consistent and not have to worry about it.. I think we should deal with these migrations in a separate PR. The weirdness of them came up when I did the roll-up but I didn't want to change any behaviour.\n. Just pulled this out entirely, can be dealt with later. Was just a move, but updated.. Updated. Hmmm, I like the idea of a spree.rb defining the Spree module. (independent of the rest of these changes). Can we look at killing the other one? \nI am not a big fan of the \"solidus\" gem itself doing much.. I am not super worried about deleting the original without deprecating as I don't think it would create any runtime errors in stores, and could be caught and fixed very easily by anyone reading the changelog.\nBut now that i sit down and think about it, I'm not 100% sure how/when solidus is usually required into a project.\nAnecdotally I grep'd my code folder and we don't have any projects, either inherited or greenfield that do a require 'spree'. . Yea, I just checked and it looks like we usually get solidus required as part of:\nBundler.require(*Rails.groups) in config/application.rb's.\nI doubt anyone is going to get caught by this, even if they are an old spree upgrade.. I'd say delete the specs... but thats just me.. nice catch, sorry. fixed. not anywhere in solidus_frontend, the only time its rendered I can find is here:\nhttps://github.com/solidusio/solidus/blob/master/frontend/app/views/spree/products/index.html.erb#L1-L9\nAnd in that case only if @taxon exists.\nI personally have a vendetta against these methods because I only barely understand what is happening and don't think they're used or valuable.. I think the idea is to eventually pull this mail processor out entirely, and move it to an solidus_action_mailer extension, eventually, so a Config for mail_processor_class doesn't need to be supported by core at all.. I think we want to ensure we have a strong API, so anyone that wishes to count on these events through their app or extensions can expect events to look a certain way.\nIf someone wanted to write their own event class (that, for instance, supported more things), they could catch this one and re-broadcast a different one, or override the code that triggers the event.. ",
    "jhawthorn": ":+1: :heart:\n. :+1:\n. :+1:\n. test this please\n. test this please\n. retest this please\n. test this please\n. test this please\n. test this please\n. This was merged in #153\n. looks good :+1:\n. test this please\n. retest this please\n. retest this please\n. :+1:\n. :+1:\n. Looks good to me. :+1:\nHow's it look now @richardnuno \n. We decided in our meeting to go with backbone sans-thorax. At least for the time being.\nThis looks good to me now. What say you @richardnuno @magnusvk ?\n. :+1:\n. retest this please\n. :+1: from me. Happy to trade some slightly awkward active states for better css. The select2 dropdown looks way better.\n. :+1:\n. Merged as #298\n. retest this please\n. retest this please\n. retest this please\n. Closing in favour of #179\n. > Credit cards month/year return strings instead of integers now. Is this OK, or should we update it to return integers? Also, does anyone know why are these columns are not ints?\nFigured this out. The column was always a string, but activerecord 4.2 now does typecasting on assignment (which IMO is good).\nactive_record 4.1\nsource.month = 4\nsource.month #=> 4\nactive_record 4.2\nsource.month = 4\nsource.month #=> \"4\"\n. :+1: from me. Great work.\n. Merged :tada: \nGreat work @philbirt @exsuzme @allisonlarson\n. retest this please\n. retest this please\n. retest this please\n. retest this please\n. Looked into this briefly.\nI see no reason to keep the custom rescue's responses. The defaults seem more than adequate.\nOne major change from this will be that api controller specs will now receive exceptions instead of simply a return status of 404/500. I consider that an improvement, but it will require updating.\nWith current rescue_from:\nruby\nrescue_from StandardError, with: :error_during_processing\nrescue_from ActiveRecord::RecordNotFound, with: :not_found\njson\n{\"error\":\"The resource you were looking for could not be found.\"}\njson\n{\"exception\":\"undefined method `error_please' for nil:NilClass\"}\nWithout:\njson\n{\"status\":\"404\",\"error\":\"Not Found\"}\njson\n{\"status\":\"500\",\"error\":\"Internal Server Error\"}\n. One case where the existing behaviour is preferable is with specific exceptions like ActionController::ParameterMissing and ActiveRecord::RecordInvalid, where it is desirable to return the error message with the json.\n. All ready. Just waiting on solidusio/solidus_auth_devise#2 (and a gem release of that)\n. @gmacdougall how? The scope is used for a build and then thrown away. I don't think the eager load can ever be run.\n. :+1: also nice that will will make the order updater do less on a completed order.\n. Just to clarify, this would be because the per line item promotion actions will create one adjustment per-item in the order. Counting as one usage per item in the order.\n. @athal7 how is that?\n. @athal7 I think it is important to be able to honestly review the changes we are making.\nWe are all in agreement that these would be better in a different place, but I believe I'm the only one who has expressed that this method was better where it was.\nRegardless, here is the first of several cherry-picks, if it get's two +1's I will merge.\n. :+1:\n. :+1:\nHad to look up the difference. void! is a state_machine method which just makes the payment void. void_transaction! actually voids the transaction. It would be awesome if someday we remedied this confusion.\n. > Are there preferences which well modifiable in the admin which will not persist now that we've removed the DB persistence? If so, I think we should disable those sections of the admin.\nThere are a few (~5) preferences remaining which can be changed from the admin interface. I didn't tackle this when making this commit because this doesn't disable persistence by default, it just allows you to. Thinking on this again, I agree that if we support disabling persistence, we should ensure that it works properly, so I will work on removing those few remaining preferences monday.\n. @gmacdougall I think they are all gone as of #42. Is this good to go? :ship: \n. :+1:\n. Fixed by #152\n. I still really want to do this, and it isn't a ton of work, but it might make cherry-picking between spree and solidus annoying, so I'm going to put it off for a bit.\n. :+1:\n. If we decide to go with this (I think we should, it's a necessary evil). We should replace the other instances of Spree.user_class used at load time in models.\n. > Should we use it here? https://github.com/solidusio/solidus/blob/master/core/app/models/spree/promotion/rules/user.rb#L5-L7\nWe probably should, but I suspect we will have to add the :: to the start of our #to_s in UserClassHandle\n. :+1:\n. :+1: Great\n. Merged as 36c3855651fe4ae80225d3249fa62939593267df\n. :+1:\n. looks alright, pending passing tests\n. @richardnuno I think you may have missed a git fetch before rebasing. There was a fix to the stock_transfer factory that was merged Friday that this PR is not based on.\nPending passing tests this is :+1: from me.\n. You're a little early to the party :tada:. We haven't cut a gem release yet, expect a prerelease gem shortly and a proper version in a few weeks.\nThanks for checking it out!\n. Hello @anulman \nI don't think we would accept a PR making Properties polymorphic. The Property is designed specifically for displaying some attributes of Products to customers and is a poor fit for just storing arbitrary data.\nInstead you might consider either the preference feature, which allows serializing pseudo-attributes into a preferences attribute on the model. Or introducing a your own MyawesomeStore model which belongs_to Store and holds your custom store attributes.. :+1:\n. The spec that is failing here is fixed in #121 \n. :+1: Awesome. Thanks for looking into this.\n. @athal7 It's part of rspec's new default spec_helper. See: https://github.com/rspec/rspec-core/blob/master/lib/rspec/core/project_initializer/spec/spec_helper.rb#L89-L94\nIt should make rerunning specs just slightly more repeatable, we should (hopefully) be able to get the same random values from our factories, generated order numbers, and the like.\n. I don't think the where clause is necessary, I think the fix here is just using destroy_all, which will issue one DELETE for each record. \nOld:\nadjustments.shipping.delete_all\nDELETE FROM spree_adjustments\n  WHERE adjustable_id = 1\n  AND adjustable_type = 'Spree::Shipment'\nThis PR:\nSpree::Adjustment.where(id: adjustments.shipping.pluck(:id)).destroy_all\nSELECT * FROM spree_adjustments\n  WHERE adjustable_id = 1\n  AND adjustable_type = 'Spree::Shipment';\nSELECT * spree_adjustments\n  WHERE id IN (1,2);\nDELETE FROM spree_adjustments WHERE id = 1;\n(callback queries)\nDELETE FROM spree_adjustments WHERE id = 2;\n(callback queries)\nProposed:\nadjustments.shipping.destroy_all\nSELECT * FROM spree_adjustments\n  WHERE adjustable_id = 1\n  AND adjustable_type = 'Spree::Shipment';\nDELETE FROM spree_adjustments WHERE id = 1;\n(callback queries)\nDELETE FROM spree_adjustments WHERE id = 2;\n(callback queries)\n. :+1:\n. :+1: but agree with andrew's concerns\n. It looks like this had two legit test failures. (and 1 spurious looking failure :disappointed: )\n. :+1:\n. :+1:\n. :+1: This is looking very good\n. Hi Chris, Thanks for the interest.\nIt's still a bit early, we're working on getting a non-prerelease gem out as well as a changelog and description of our changes.\n. :+1:\n. I'm unable to connect heroku to github (http://i.hawth.ca/s/Z0oQQvhv.png). Maybe someone else can give it a go.\nEDIT: I kept trying and eventually it worked\n. I think this is way more work than it's worth. As far as I can tell we would need to write a custom buildpack in order to bundle install, generate the sandbox application, and use that directory as our app.\n@athal7 I'm closing this. If you're interested in pursuing it yourself please reopen.\n. If there is a desire to do this it should be done in an extension before we evaluate inclusion in solidus itself.\nClosing due to inactivity.. I can see why this is necessary. We change the passed in set of inventory_units, which won't necessarily be the same ones as shipment.inventory_units: it could be order.inventory_units or carton.inventory_units. Basically, inventory_units are a mess.\nHowever, I do think this needs a test.\n. closing in favour of #170\n. :+1:\n. Just rebased and added the small feature spec\n. :+1:\n. Here it is passing on travis under MySQL https://travis-ci.org/jhawthorn/solidus/builds/70308044\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. Looks good :+1:\n. I agree with Andrew and Magnus, if cartons can contain multiple orders they should be able to have multiple stores.\nHow I think we should solve this is send out one email per order/carton pairing. If a customer makes two orders, and those happen to get combined into the same shipment, I still think the customer should get one email per-order (I know amazon works this way).\nI think it would also be nice if we could decide as a convention that transactional emails will always have an @order available, so it could be used from a layout.\n. lgtm\n. :+1:\n. :+1:\nIs there a companion addition to solidus_auth_devise you can link to?\n. :+1:\n. @adammathys thanks. Updated with your feedback.\n. Still :+1:\n. I like this. :+1:\nMaybe a little mention in the docs of the ControllerHelpers::Store module would be nice\n. :+1:\n. Now looking good to me\n. :+1:\n. I don't think this is the right place for this reload. The reload is right at the start of this method, there must be something else causing the association to be stale.\nI would also like to see a test against api/checkouts_controller#advance showing it failing. The test here doesn't tell us that this reload is required, just that it happens. This would be a good place to start.\n. :+1:\n. I was running into this again, have created #224 to fix it.\n. Also at the same time it might be worth removing jstree, which is complex and doesn't provide a particularly good interface (right click to add/edit/rename/remove) compared to a simpler nested sortable.\n. Closing for #2254. Are we sure this is still touching the products? I see the variant's updated_at being bumped but not the product.\nOther than that concern, I'm generally in favour of removing as many of these touch: true's as possible. They were added with little consideration and in many cases kill our performance.\n. Isn't this going to exhibit the same problem?\n- touch option value\n  - touch variant\n    - touch product\n  - touch variant\n    - touch product\n  - touch variant\n    - touch product\n  - ...\nalthough this is probably faster than touching through the option types.\nEDIT: considering this again, it is an improvement, so :+1:\n. :+1: for removing this. Assigning address here makes no sense.\n. In order to make stores consistent, we'll have to add another migration to remove the useless indexes where they have already been added.\n. :+1:\n. other than comment :+1:\n. :+1: Thanks for fixing this adam. Problem was caused by my #182. This happens because of some nastiness in the method_missing in Spree::Gateway\n. @jordan-brough can we get a test for this?\n. :+1:\n. :+1:\n. This needs a test\n. :+1:\n. :+1:\n. :+1: :microphone: \n. :+1: Looks good to me, but a test would be nice.\n. :+1:\n. I'm :+1: as a quick fix, but we should instead do this properly. I've created #221 for this purpose.\n. @athal7 \n\nis ContentController#cvv used?\n\nIt's oddly used by both the frontend and backend for the \"what the hell is a cvv\" popup (the \"what's this\" link below)\n\nI'd love to remove that in the backend in favour of something independent of frontend, but that's outside the scope of this PR.\n. Makes sense to me. I feel that the state machine is triple-checking that stock is available since ensure_inventory_units effectively is doing the same check.\n:+1:\n. updated\n. Awesome change :+1:\n. Closing as this was done in #265\n. :+1: but we do need to revisit touching.\nEDIT: agree with @magnusvk's comments\n. Is it possible to get a failing feature spec to go with this? The controller spec tests the new behaviour, but I don't know why that is needed or what this does.\n. We've merged #265, which means that migrations will now complete when coming from a 3.0 store. More work is needed to sync up the schemas and some functionality.\n. @BenMorganIO how do you feel about this? Are there any additional changes we should make in order to close this?\n. Closing as it seems to be possible. Any issues upgrading should be filed as new issues.\n. Stale. api/products is slow because it displays taxons, variants, images, stock levels.\n:+1: for now this is a good performance fix. I've created #244 to revisit this.\n. Great! :+1: assuming passing tests\n. :+1: :exclamation: \n. :+1:\n. :+1:\n. > We could also wrap this expect in a page.document.synchronize block which seems like the new wait_until and the better sleep in capybara2.\nexpect(page).to have_css(...) actually already does this internally.\nI haven't been able to reproduce this failure after many, many runs with the same seed. I've added #295 which should help diagnosing future failures, but if this doesn't pop up again I will have to close it.\n. I haven't seen this recently, not much I can do unless it's repeatable. Closing for now\n. Looks great :+1:\n. :+1: death to inject\n. looks good to me :+1:\n. :+1: agree about stubbing\nI'm fine either way, but this could be\nadjustments.each &:open!\ninstead of\nadjustments.each {|a| a.open! }\n. What are the implications of readonly? being false vs. an on: :update validation which prevents changes? Changing readonly? feels like we're overriding some rails internals, and having to .readonly(false) any time we want to do a join is unfortunate.\n. I'm now :+1: on the def readonly and the rest of this (pending a double check of the readonly on scoping).\n@forkata thanks for weighing in. Any further thoughts or are you :+1:?\n. @gmacdougall \n\nShould we mark these as deprecated for now?\n\nI don't think we need to deprecate Spree.content_tag, which was created by accident and I'm sure nobody knew existed.\nI could see wanting deprecations for Spree.t(\".translation\"), but this functionality was never used in core/backend/frontend and none of the translation keys were structured for using this. IMO these can be removed without deprecations.\n. :+1:\n. I rewrote these recently, it worked fine without bundle exec. Most people will never need to run this, I only do so as a double check before releasing gems\n. Just want to confirm that you want delete_all instead of destroy_all?\n. Both are fine by me, so long as the use is intentional :+1:\n. :+1: assuming specs pass\n. > What I did was I just made that existing remove payment method environment column migration empty.\nJust to clarify, we do need the environment to be specified here. Otherwise the migration which removes the payment method may remove this as the environment won't match.\n. :+1:\n. I don't understand why this is desirable. Orders have a user associated with them. If this is to log admin actions, I feel that would be better handled in the admin.\n. I would love for us to use \"show\" for actions which are \"show + edit\", but there's no reason for that to be in this PR's scope.\n:+1:\n. :+1: love it.\nI'm not sure this is the best place for the promotion_chooser_class configuration (code reloading issues, and I'm not sure it's the responsibility of ItemAdjustments) but I don't have a better suggestion right now.\n. :+1:\n. Yes. Opened #280\n. > My only concern is how cross DB compatible the execute in the migration would be, only because I don't write SQL like that often.\nShould be entirely standard SQL. Works on mysql, postgres and sqlite at least.\n. @plongyear @jordan-brough sorry, I lost track of this one. \nI would prefer a new scope (#valid probably shouldn't exist at all)\nOtherwise a strong :+1:. This is great and really important to get in\n. Non-actionable. Closing due to staleness.. I would prefer these were all split into two separate objects.\nLooking at just this one, for example \n``` ruby\nclass StockDisplay < PermissionSets::Base\n  def activate!\n    if Spree::Config[:respect_stock_location_associations]\n      can [:display, :admin], Spree::StockItem, stock_location_id: location_ids\n      can :display, Spree::StockLocation, id: location_ids\n    else\n      can [:display, :admin], Spree::StockItem\n      can :display, Spree::StockLocation\n    end\n  end\nprivate\ndef location_ids\n    @ids ||= user.stock_locations.pluck(:id)\n  end\nend\n```\nThere are no lines of code shared between the respect_stock_location_associations being true or false, so there's no advantage to them sharing the same class.\nSplitting them would also allow choosing per-role whether the stock locations should be used. I could  see, for example, a telephone customer service user who can view stock at all locations and a shop user, who can only see stock at their own shop.\n. :+1: \n. We're not looking into immutability at a data-structure level. It is, however, a nice ideal to look for when designing/writing/reviewing code.\nIn another PR we are making Addresses immutable, so that they can be shared between orders. Cartons were designed in a similar mindset, we didn't want to mutate shipments in order to show how items actually made it out the door.\n. @tesserakt I don't expect to see an all-immutable codebase, but if small changes result better code, we'll absolutely accept it. We do however need to maintain compatibility. Using hamster is out, as we aren't writing heavily threaded code with sharing.\nI think if we had unlimited time and no existing installations to worry about Andrew, Clarke, Greg and I would be rewriting this totally immutable in elixir :wink: \n. Cool :+1:\n. > Do we have to worry about the \"prune strategy\"?\nNot for CI. I've never set one up in development, and it's been fine so far.\n. :+1: Removing strange code. Good change. \n. Merged as #302 \n. :+1:\n. :+1:\n. Is this necessary? This is a private method which is only used here and not in a way that should need indifferent_access.\nWhile on the subject, I think this method should be renamed new_order_params, as that is how it's used.\n. Can we get a spec which fails without the whitelisted_ransackable_associations change? These spec changes look unrelated.\n. :+1: Looks good. Thank you for the explanation.\nWhen merged I will cherry-pick this into the 1.0 branch.\n. :+1:\n. :+1:\n. > since we are doing one email per order, do we want to reduce the items that are included in the mailer to only be the items for that order\nThis is done\n. @jordan-brough used all your suggestions. How's this?\n. Thanks @jordan-brough I've just rebased and added some small notes to the changelog\n. :+1: I'm not sure anyone should be able to destroy accounts. Doing so currently would create a bunch of broken relations. We should fix this by either removing deletion entirely or adding dependent: :restrict.\n. :+1: good first step. We do eventually need to either fix user deletion or disable it entirely.\n. We should absolutely use delegate when it does everything we need. delegate_belongs_to has an extra feature: it will build the belongs_to or has_one association if it does not exist. We need this in order to do things like Variant.new(price: 5.50)\nConsider the following:\n```\nvariant = Spree::Variant.new\nvariant.default_price  # => nil\nvariant.price          # => nil\nvariant.default_price  # => #\nvariant.price = 2      # => 2\nvariant.default_price  # => #, currency: \"USD\", deleted_at: nil, is_default: true>\nvariant = Spree::Variant.new(price: 2)\nvariant.default_price  # => #, currency: \"USD\", deleted_at: nil, is_default: true>\nvariant.price          # => 2.0\n```\n. It looks like we do assign in that way quite frequently.\nOne thing we could do instead is:\n``` ruby\ndef find_or_build_default_price\n  default_price || build_default_price\nend\ndelegates :price, :price=, ..., to: :find_or_build_default_price\n```\nI wouldn't mind switching to this and entirely deprecating delegate_belongs_to\n. I think I agree. Opened #320\n. Closed in favour of #320\n. :+1:\n. :+1:\n. Closing due to staleness. (though I would still like better default templates). :+1: I checked and it is. LGTM\n. :+1:\n. :+1: I checked and it is. LGTM\n. Yeah, I really like this :+1:\n. :+1:\n. Still good :+1:\n. :+1: Do you just spend all day spellchecking this repo?\n. :+1: I'm sure it was made by accident. We removed Spree::Configuration which was similar.\n. Looks good to me :+1:\n@jordan-brough ?\n. I will be taking this and moving the new methods into classes\n. Closing in favour of #357\n. > Do you know off hand how far away would we be from disable_monkey_patching?\nI want to do this, and transpec will do it for us. Will make another PR shortly\n. :+1:\n. One reason I'm eager to remove it is that it would be easy to accidentally use it to bypass strong params\n. :+1:\n. @richardnuno I'm sorry to be a stickler, but we need a test for e3521f5bd380f0ec67b05f6c8a9c0950eb1d1fb4.\nFor all I know, this could have worked fine as it was before this commit, skipping the state machine using update_attributes! could have been a fine solution. If there's a reason it's not we need to show what that is.\nI'm fine with the less than optimal change to create_proposed_shipments for the sake of fixing this bug, but we need to clearly show in tests why it has to be as it is. I would consider the unreturned exchanges one of the uglier parts of the codebase, and something I want to visit as soon as I have the time. In order for anyone to ever fix these things, we need the current behaviour and requirements to be well tested.\n. :+1: Thank you for the spec and using .try!\n. Looks good to me :+1:\n. I prefer making a subclass which overrides the parent's methods. As you say, you have the ability to override just one method but writing the class from scratch is also an option. This would be useful, for example, if you wanted to write a variant searcher using solr or postgres full text search. This relies on classes having a useful and well-defined interface, which we do always aim for.\nI also agree with @athal7's concerns. Expecting classes to be inherited and overridden puts us back in the \"nothing can be removed, everything is assumed to be required\" territory.\nWhat about having comments declaring which methods we consider \"overridable\"?\n. I'm not sure about this as an extension point.\nIs there a reason not to implement this as our default behaviour? Shipment#refresh_rates already has logic to keep the same shipping rate selected, it seems like we should do the same here.\n. > Not sure if with-tip and no-text fall into that realm.\nwith-tip is it's own thing and means we want a fancy tooltip. Outside this PR's scope.\nno-text is icon-link specific and should probably be prefixed\n. Closing because I haven't spent any more time on this and it is too large a task to tackle at the moment.\nThis will likely come up again as we improve individual sections of the admin.\n. :+1:\n. :+1:\n. :+1:\n. > Conflicts... That's weird.\nI noticed this because of #354, but forgot to make sure I was on top of that merge\n. Disappointing discovery: if I comment out set_shipments_cost, all specs still pass :disappointed:. Will have to try and add a feature test exposing that.\n. @jordan-brough I have just two things I want to check up on. The first you might be able to help clarify\nHere https://github.com/solidusio/solidus/pull/357/files#diff-0a2f4b241f8427ca90d58eec529e0e8aR53 we assign credit_card.verification_value and there are tests which verify (though expect(..).to receive(:varification_value=)) that that is assigned. However that record is never saved, and I see no place that that would be used. If we need that value to be around at some point we need to test for it.\nSecond issue is to find out why we have set_shipments_cost\n. @jordan-brough I have just two things I want to check up on. The first you might be able to help clarify\nHere https://github.com/solidusio/solidus/pull/357/files#diff-0a2f4b241f8427ca90d58eec529e0e8aR53 we assign credit_card.verification_value and there are tests which verify (though expect(..).to receive(:varification_value=)) that that is assigned. However that record is never saved, and I see no place that that would be used. If we need that value to be around at some point we need to test for it.\nSecond issue is to find out why we have set_shipments_cost\n. I've added a test for set_shipments_cost. Other than my question to you @jordan-brough I believe this is ready\n. @jordan-brough thanks. I was mistaken and assumed that was added by us. Might as well leave it in for now, changing that would be ouside this PR's scope.\nAs of 3a5e16ab49687c7960d90bfbf8e05b09eff0ecd2 (which was horrible to track down) this is good to go by me. :ship: \n. I might prefer the config name to be _cutoff_days just to be clear about what the integer represented.\nOtherwise :+1:\nI am noticing a lot of churn in this method, we should maybe consider later extracting it into a pluggable class\n. That would be great! These are exactly the type of high-quality changes we are looking to make\n. This looks good to me :+1:\nI'll squash this when merging (due to the failing previous commit)\n. :+1:\nI think it might also be reasonable to ActionMailer::Base.deliveries.clear in a global before\n. other than two nitpicks looks good :+1:\n. One question, otherwise looks good to me\n. :+1: (other than tiny change discussed in PM)\n. :+1:\n. :+1:\n. :tada: \nAs a sidenote, at some point in the (somewhat distant) future, I could see there being a country_iso column on the address table. I would like it if we used carmen's country data directly instead of having our own representation of countries in the DB.\n. I'm actually very happen with the chosen naming. This should behave somewhat transparently, it's akin to setting country_id .\n. Other than precompiling handlebars looks good here\n. > I also want to get rid of sale transactions, because I agree that they're wrong. However, it is a pretty invasive change for our users, so I want to make sure we have a good migration guide.\nIt is, and I fear that there's some gateways which only implement purchase.\nI think some users will be using auto_capture just to capture on complete (which is what it sounds like it does) rather than because their gateway requires it.\n. Maybe adding a capture_on_complete and deprecating auto_capture would be a good transition\n. :+1: Looks good to me. Thank you for the specs\n. :+1:\n. > Nice find!\nThanks. I now feel bad about the places I removed with_model. Now that I know it can work under MySQL it's pretty nifty.\n. travis loves me. Merging\n. thanks. Looking good to me :+1:\n. looks okay\n. lgtm :+1:\n. :+1:\nThis is also about responsibility and knowledge. A payment should not know that it needs to update the shipment state and the shipment should not know how to update the order. Very happy with this change.\n. PriceSelector certainly fulfills this issue. If there are other requirements, they should be in a new issue.. Resolved by #412! Thanks to @alexstoick for the hard work on this. :tada: \n. Failed because I needed to rebase onto 80956281c9322abf3c1c36a038e602f0572f4194 :tired_face:  (thanks @gvaughn)\n. > Readme files should be executable. /s\n$ ./README.md\n./README.md: 2: ./README.md: Syntax error: word unexpected (expecting \")\")\n:shipit: \n. great! :+1:\n. :+1: good call Magnus\n. seems good to me :+1:\n. The experiment would be to disable reloading of the solidus classes. Which would allow stores depending on solidus to have a faster development environment. The store's models would still be reloaded\nThis is just desired as an experiment.\n. Closing because this is stale. Still interested in it though.. How about \"days ago\" instead of \"months ago\"? Seems that might be a bit more general\n. :+1:\n. This needs a test.\n. I agree with @jordan-brough, but that needs to be tested thoroughly. We don't want to re-introduce this spree 2.2 era regression.\nhttps://github.com/solidusio/solidus/blob/v1.1.0/core/spec/models/spree/order/payment_spec.rb#L70-L74\nEither way, we should get a test first :wink: \n. :+1:\nI'm really interested in seeing inverse_of added, but that shouldn't hold up this PR. \n. lgtm :+1:\n. :+1:\n. looks good to me pending ci :+1:\n. How do we want to represent a shipping method with all stock locations set? Do we want to make it explicit and require the join record for each, or would we like to allow no stock locations to mean all?\nFor the former, which is what this currently implements, we'll need a migration to add all existing shipping methods to all stock locations.\n. :+1:\n. :+1:\n. This fails because the list of changed attributes is not cleared by update columns, causing that one test to fail. #425 will fix this.\n. cc @Sinetheta the human eslinter\n. :+1:\n. lgtm :+1:\n. Seems fine to me. We don't really consider this to return anything meaningful\n. Can you be more specific about why this change is desirable? I preferred the previous code.\nAlso this needs a test.\n. Another potential for issues: unpersisted associated records will now be saved on an update!\n. Rebased. This is still good to go by me.\n. Rebased again\n. Merging. We want this to get as much testing and exposure as possible before our 1.3 release.\n. I've deprecated identifier and removed all references to identifier.\n. That's a big gotcha, and probably a good addition to cancan.\n:+1:\n. Looks good to me :+1:\n. One thought: these dependent: :destroys are going to be run on \"soft destroys\" (this is a paranoia model). Is that what we want?\n. This has a failing test\n. Closing due to age.\nI don't think we want to be destroying the associated records so long as this is a \"paranoia\" model.\nFeel free to open a new PR if this is addressed\n. Looks good to me :+1:\n. Thank yoouuuuuu\n. is it possible to keep the old block behaviour of stub_authorization? Users are likely to have used that in their own stores.\n. I'm not sure I agree with the deprecation warnings. I've found being able to define the cancan rule explicitly a good way to test the rules directly without adding a dependency on permission sets\n. :+1:\n. Had to revert this because it was causing a spurious failure (depending on order) due to some existing calls to Spree::Ability.register_ability. We'll have to revisit\n. :+1: pending a rebase on #449 \n. This was mostly solved by #476, but leaving this open for the improved feature spec.\n. Yes, that's always been the case. The question I had was why it was changed in spree 3.0 from something inferred by the contents of zone_members to something stored on zone itself. There was IMO, no benefit to this in core, so was looking for if it was done for extensions support.\n. seems good to me :+1:\n. :+1:\n. Could you clarify why this is desierable? It clearly makes things more complex (as #457 shows)\n. This is looking good.\nI was still hoping for a better name than sale which isn't the most descriptive. Does anyone have thoughts on that? Maybe site_wide or something?\nShould we be adding a restriction to ensure that codes (or a path) can't be added to a sale promotion?\n. apply_automatically makes sense to me\n. This is looking great, thanks.\nAny thoughts on my suggestion of disallowing codes on applied_automatically promotions?\n. awesome. Looks good to me :+1:\n. I don't think this is an improvement. I like @jordan-brough's version, though.\n. @BenMorganIO thanks. this looks good to me. Do you mind squashing these into one commit with a better message.\n. :+1:\n. We had some minor improvements into 1.2, and will target the rest for 1.3\n. We had some minor improvements into 1.2, and will target the rest for 1.3\n. > I'm curious to chat more about how to address your concern better. Would it be helpful if we moved this logic to Spree::Order and then just called Spree::Order.apply_store_credit(user) or something like that from the store credit hook?\nI don't think that addresses my concern. That might be an improvement, but we still should not be relying on states just because of what those states may imply.\n\nThe logic only applies to orders in the confirm state because any order in a state prior to confirm will have store credit applied during this transition.\n\nWould it be appropriate instead to check for .incomplete (ie where completed_at is nil) orders which have payments?\n. @jasonfb thanks, but I have a few reservations about spree/spree#6794. I don't think the migration is appropriate (turning deleted products into discontinued products), as that may have significant behaviour differences in stores' custom code. acts_as_paranoid was not removed from the product, despite some of its necessary functionality being removed. There were also unrelated changes I would prefer to be reviewed separately (fixing line items of deleted products, for example).\nWhat we'd like to see, at least initially, is a minimal PR implementing the available_until without breaking existing functionality.\n. :+1: Looks great. Thanks for working through this.\n. I'm lukewarm on this, because I don't want to discourage fixups or rebases when they are warranted. I don't feel strongly though, and do see the value in making our reviews easier.\n. > CircleCI is to my experience the better CI. But just lacks the matrix.\nI do not share this opinion at all, but the rest of the team seems to like it.\n. First, I prefer using travis (UI, configuration format). I've found it to have better uptime (anecdotal, but Circle seems to have some outage almost every week). CircleCI is appallingly bad at permissions (though this doesn't matter in an open source project). There's also no matrix builds on Circle (which is really what we're looking for right now).\nI like travis because it doesn't seem to have the same 4-container limit, it runs whatever it has resources to do, but it feels marginally slower per-container. If you haven't used it in the past ~year, it's much faster to start testing now if you specify sudo: false in your travis.yml, which makes it use containers instead of a VM.\nBut again, I feel like the rest of the team doesn't agree with me here.\ncc @athal7 \n. I've enabled travis for branches (not PRs yet) we can evaluate it over the next week to see if it runs \"stable\" enough to enable for PRs.\nFWIW, I believe that whatever instability travis may introduce can be fixed by using capybara properly.\n. I'd like to do this but it isn't easily viable on CI. Closing due to non-actionability.. Looks reasonable to me. Is there a reason we prefer to_not over not_to here?\n. Okay, looks fine to me then :+1:\n. Re: the actual PR, this is a small change that improves readability.\n:+1:\n. :+1: Seems reasonable to me. We should document that the OrderMerger only makes a best effort two merge the two orders together.\nIn the future I'd love if there was a separate commit to extract into a class and a separate commit to make the change. But I understand that this is a commit from spree which had probably been squashed there.\n. :+1:\n. Still looks great.\n. One comment, otherwise good by me\n. One comment, otherwise good by me\n. :+1:\n. :+1: looks good. Agree with nitpick\n. @negouseid this has always been a pain, and is something I hope we make easier in the future.\nMake sure all the products in your cart matches the shipping category of your desired shipping method.\nMake sure your zone includes the country (or region) that you're entering as a shipping method.\nHope this helps.\n. This is a good change. Just a few thoughts\nI'm not sure whitelisted is the right language. This isn't configuring which roles are allowed an API key, but which roles are auto generated one (a small difference).\nShould (or could) it be possible to use this preference to generate an API key for all users, regardless of role? iirc some stores do that\n. Awesome. Looks good to me :+1:\n. I believe we should create a store during migrations. Someone upgrading an existing site should have a Store created for them during migrations.\nThis is a good example of why we have to avoid using AR models in migrations: later changes to their behaviour will break older migrations.\nEDIT: I've created #488, which is how I think this should be fixed.\n. Closing as #509 has been merged. :tada:\n. @dangerdogz this is merged. Thank you for confirming.\n. @ajkamel Success! We have a new deface release.\nhttps://rubygems.org/gems/deface/versions/1.0.2\nhttps://github.com/DefaceCommunity/deface\n. I think for a lot of extension points this would be a lot cleaner. Especially for sorting it makes a lot of sense.\nI think in some cases classes probably still make sense.\n. I'll avoid some more detailed review as this is still a work in progress, but I'd like to see how the api/frontend-of-the-admin part of this would be handled. I noticed that the variant search select no longer has images for variants (since they no longer have images).\n. @richardnuno thanks for the sample data, but I don't think your performance test was really measuring the impact this would have on production. The sample data did not include any images and caching was turned off.\nI ran the sandbox against both master and this branch with the server in a production-like environment: config.cache_classes = true and config.action_controller.perform_caching = true. I added one image for each colour on this PR's branch.\nTesting both branches had approximately the same runtime :+1: about 3.5 seconds (slowish, but unchanged). However, this is our best case scenario with this change, since we're hitting the product endpoint, it only needs one query for each of the variant_image_rules, variant_image_rule_conditions, variant_image_rule_value, and image.\nWhat needs to still be tested is the variant index or variant search route with multiple products, which is where I think the worst impact from this change will be. \n. This is looking good.\nI was still hoping to see variant_image_rule_conditions and values combined with the variant_property_rule_ counterparts. Is that still in the works?\n. :+1: Thanks!\n. Hi @adaddeo. Thank you for the PR.\nI'm not too sure about this. This is a lot of code and complexity for a level of indirection that doesn't seem to abstract anything that cleanly.\nCan I ask what exactly you were looking for in terms of extensibility? Maybe there is a simpler way we can achieve the functionality you're looking for.\n. If I knew the specific use case it would be helpful.\nCould we accomplish the same thing by applying all non-tax, non-calcellation adjustments instead of just promotion adjustments before doing tax?\n. Are you sure you are running ruby 2.1 or greater?\nThis is the syntax for a required keyword argument, and is what we want here.\n. I checked and this error only occurs on ruby 2.0\n. :+1:\n\nmakes sense.\none question: will admin templates remain \"deface friendly\" with data-hooks?\nthis is very useful for extensions, imho.\n\nI don't think anyone will be looking to remove them without a good reason (just removing them would accomplish nothing but break extensions). But I don't expect to see data-hook in new pages of the admin. I think that it's probably just as easy to target ids or classes. I think data-hook attributes are just cargo culted in like this one.\nI think in the short term we might want to replace the two data-hooks that auth_devise uses with something else (a plain partial?).\n. :+1:\n. I also agree that transfer_from and transfer_to doesn't make sense for the \"display\" permission. Seems to me that the controller, or at possibly the view is should be checking the display permission instead.\n. Great :+1: I think this is good to go. \n. Any idea why the change to .trigger was needed when it wasn't before?\nEDIT: checked the previous builds. Looks like the button is being hidden behind tooltip\n\nstill interested in why this changed from the previous version\n. I added a sleep 1 before the click on powertip v1.1.0 and this issue showed up. Old powertip may have had this same quirk but didn't show up fast enough to break tests.\n@scottcrawford03 I did want to note that I've toyed with the idea of totally removing powertip in favour of a pure css tooltip. Won't happen soon (requires #384) but would this affect whatever reason you want to use $.powerTip.destroy?\n. @scottcrawford03 also just noticed the jquery.powertip.js file has the wrong filesystem permisisons: it's marked as executable.\n. @scottcrawford03 excellent. Thank you.\n. I'm not sure this is a good approach to begin with.\nIn addition, the new test is broken. It isn't testing for a yeild (b variable is unused).\n\nThe spec failures looked unrelated.\n\nWhy would you think this? The failing test is called \"Spree::Api::BaseController lock_order with an existing lock returns a 409 conflict\" and has failed three times in a row. Do not just retry tests, that is how we end up with broken code in master.\n. @jordan-brough No. This code here in this PR is not a good approach. I also don't think OrderMutex is a good approach, but I wasn't bringing that up here.\nI think it's early to thumbs up this approach as it is still failing tests.\n. :+1: Great! Let's get this in. Thank you @Mandily and @Sinetheta this looks great. Thanks @tvdeyen for the vigilant reviews, which improved this a lot.\n. Merged! :tada: \n. Actually, I changed my mind. This will cause breakage for those referencing a git repo (which is pretty much everyone at this point). Might as well just let developers find a working version for now.\n. I don't believe it's appropriate to use validations for checking stock, since it could become invalid after being saved to the database.\nClosing due to staleness.. :+1:\n. > @tvdeyen my concern with a blocking spinner is that not all interactions which could trigger this loading state result in a page that a user shouldn't interact with.\n\nLiterally any ajax for any reason https://github.com/solidusio/solidus/blob/master/backend/app/assets/javascripts/spree/backend/progress.coffee will cause this thing to pop up. So if anything I would like to see it become less prominent (eg the admittedly overplayed http://ricostacruz.com/nprogress/ ) rather than more disruptive.\n\nThis has gotten off topic, especially since this change is being made in #509, not here. Can we move discussion to that issue, and keep this issue to font, colour, and other style issues Amanda has proposed?\n. > This removes a fair chunk of messaging we gave to clients that was (usually) right, doesn't it? Like the fact the coupon might be inelligible because a better one exists? I'm not sure I'm comfortable removing that.\n\nWait, how and when do coupons get applied? was the update_totals and persist_totals ever ran? It seems like this changes quite a bit of behaviour....\n\nupdate_totals and persist_totals are still run they've been moved to the other method. This raises a good point: with the existing behaviour, it was possible that applying the coupon could put the order in an inconsistent state. If the first adjustment was marked ineligible (there was a better coupon) but was applied to a different adjustment in the order, the order would not have the correct totals until another order.update was called.\n. @cbrunsdon Added a test for the previously broken behaviour. It fails on versions before 02ed14f (because successful? is false, despite applying the coupon) and passes now.\n. I love this change, but am a little concerned about changing copy_price, which is often overridden as an extension point. A quick github search shows how common this is. However, this method is definitely misnamed.\nTalked about this IRL with @cbrunsdon who suggested we could check this and warn users if the copy_price method was defined, which I think is a clever solution. It would be even better if we could make this change and at the same time provide a solution for #390. Tagging for 1.3 in hopes that we come up with a solution for that at the same time.\n. :+1: (and clarke is here and says :+1:)\n. @ajkamel thanks for the issue. That looks like a good change: looking up by ISO instead of name in the seed data. If you wanted to cherry-pick that change on top of our master (minus the guide changes, as we no longer have guides). I'm pretty sure we would merge it quickly.\n. Closing in favour of #492\n. :+1:\n. > What was the reasoning behind silencing during the spec runs? So we can still use our own deprecated methods for a few commits? Or I guess we still have specs that test their behaviour that we want silenced?\nThe specs are testing the deprecated method.\n. Thanks Phillip, this is a good change.\nSince we're using these same 8 lines in two places now can we extract it to a helper or other template?\n. Awesome :+1:\n. :+1:\n. :+1:\n. Closing this as there has been a year without activity. Please file a new issue or pull request if appropriate.. Closing this as there has been a year without activity. Feel free to file a new issue or pull request if appropriate. Thanks.. Great start! My previous experience using Model.human_attribute_name and Model.model_name.human has been positive.\n. Looks good to me. :+1:\nI bet we could go further here and select the stock items grouped by stock_location, and skip the N+1 on line 59, but this is an excellent step towards that.\n. @dfmedeiros no worries. We can worry about future improvements after addressing this. I think this is good to merge pending the spelling fix.\n. @dfmedeiros no worries. We can worry about future improvements after addressing this. I think this is good to merge pending the spelling fix.\n. Thank you @dfmedeiros \n. Other than tiny request this looks great :+1:\n. Great! Thank you @tanmay3011.\n. :+1: \n. :+1:\n. :+1: Indeed looks like bad copypasta\n. Is it possible that a store would be depending on the existing behaviour? ie. they would expect the tiers to be based on the specific line item's amount instead of the order's item total.\nalso cc @adammathys who knows this better than me.\n. Thanks @adammathys \nThat's a point I missed, which was that this wasn't previously available on line items (it wasn't in promotion_actions_create_item_adjustments), so it's unlikely anyone would have used it that way.\nThis replaced the previous spec where it calculated against an order with a spec in which it calculated against a line item (or two). Could we get the old spec testing the order case back alongside the new ones?\n. > can we make that new method private?\nDone. I could see the method being useful, but no reason for it to be public until we want to use it elsewhere.\nI've also included some cleanup of the estimator_spec in this PR, and wanted to note that specs pass before those changes were made.\n. Rebased and still good to go.\n. @cbrunsdon this could use another review. I had to update it to support the changes from #412, but I think it turned out fairly well.\n. I am in favour of the changes here as they are now. Though the allow_blank might read as contradictory, it does behave exactly as one would expect, ie. not checking checking uniqueness on an already obviously invalid record.\n. Merged as 2ad85706d129f4e67a7dd568a786f4aa2326fc29. Thanks!\n. :+1: that just looks problematic.\n. Closing this for now. I would like a better solution, but this clearly is in use.\n. Closing this for now. I would like a better solution, but this clearly is in use.\n. Tagged for 1.3. We should make sure there is a spec covering payment failures.\n. I wrote some specs to demonstrate the behaviour of that check. This asserts that InsufficientStock is raised whenever there isn't enough inventory.\nHere is the result:\n```\nSpree::Stock::Coordinator  with no backordering\n    with a single stock location\n      with no inventory\n        behaves like an unfulfillable package\n          raises exception\n      with insufficient inventory\n        behaves like an unfulfillable package\n          raises exception (FAILED - 1)\n      with sufficient inventory\n        behaves like a fulfillable package\n          packages correctly\n    with two stock locations\n      with no inventory\n        behaves like an unfulfillable package\n          raises exception\n      with some but insufficient inventory in each location\n        behaves like an unfulfillable package\n          raises exception (FAILED - 2)\n      has sufficient inventory in the first location\n        behaves like a fulfillable package\n          packages correctly (FAILED - 3)\n      has sufficient inventory in the second location\n        behaves like a fulfillable package\n          packages correctly (FAILED - 4)\n      with sufficient inventory across both locations\n        behaves like a fulfillable package\n          packages correctly (PENDING: This is broken. The coordinator packages this incorrectly)\n      with sufficient inventory in both locations\n        behaves like a fulfillable package\n          packages correctly\nPending: (Failures listed here are expected and do not affect your suite's status)\n1) Spree::Stock::Coordinator with no backordering with two stock locations with sufficient inventory across both locations behaves like a fulfillable package packages correctly\n     # This is broken. The coordinator packages this incorrectly\n     Failure/Error: expect(packages.map(&:quantity).sum).to eq(5)\n   expected: 5\n        got: 3\n\n   (compared using ==)\n Shared Example Group: \"a fulfillable package\" called from ./spec/models/spree/stock/coordinator_spec.rb:170\n # ./spec/models/spree/stock/coordinator_spec.rb:107:in `block (4 levels) in <module:Stock>'\n\nFailures:\n1) Spree::Stock::Coordinator with no backordering with a single stock location with insufficient inventory behaves like an unfulfillable package raises exception\n     Failure/Error: expect{ packages }.to raise_error(Spree::Order::InsufficientStock)\n       expected Spree::Order::InsufficientStock but nothing was raised\n     Shared Example Group: \"an unfulfillable package\" called from ./spec/models/spree/stock/coordinator_spec.rb:126\n     # ./spec/models/spree/stock/coordinator_spec.rb:113:in `block (4 levels) in '\n2) Spree::Stock::Coordinator with no backordering with two stock locations with some but insufficient inventory in each location behaves like an unfulfillable package raises exception\n     Failure/Error: expect{ packages }.to raise_error(Spree::Order::InsufficientStock)\n       expected Spree::Order::InsufficientStock but nothing was raised\n     Shared Example Group: \"an unfulfillable package\" called from ./spec/models/spree/stock/coordinator_spec.rb:151\n     # ./spec/models/spree/stock/coordinator_spec.rb:113:in `block (4 levels) in '\n3) Spree::Stock::Coordinator with no backordering with two stock locations has sufficient inventory in the first location behaves like a fulfillable package packages correctly\n     Failure/Error: let(:packages) { subject.packages }\n     Spree::Order::InsufficientStock:\n       Spree::Order::InsufficientStock\n     Shared Example Group: \"a fulfillable package\" called from ./spec/models/spree/stock/coordinator_spec.rb:157\n     # ./app/models/spree/stock/packer.rb:26:in block in default_package'\n     # ./app/models/spree/stock/packer.rb:22:ineach'\n     # ./app/models/spree/stock/packer.rb:22:in default_package'\n     # ./app/models/spree/stock/packer.rb:16:inpackages'\n     # ./app/models/spree/stock/coordinator.rb:61:in block in build_packages'\n     # ./app/models/spree/stock/coordinator.rb:58:inbuild_packages'\n     # ./app/models/spree/stock/coordinator.rb:20:in packages'\n     # ./spec/models/spree/stock/coordinator_spec.rb:102:inblock (3 levels) in '\n     # ./spec/models/spree/stock/coordinator_spec.rb:106:in `block (4 levels) in '\n4) Spree::Stock::Coordinator with no backordering with two stock locations has sufficient inventory in the second location behaves like a fulfillable package packages correctly\n     Failure/Error: let(:packages) { subject.packages }\n     Spree::Order::InsufficientStock:\n       Spree::Order::InsufficientStock\n     Shared Example Group: \"a fulfillable package\" called from ./spec/models/spree/stock/coordinator_spec.rb:163\n     # ./app/models/spree/stock/packer.rb:26:in block in default_package'\n     # ./app/models/spree/stock/packer.rb:22:ineach'\n     # ./app/models/spree/stock/packer.rb:22:in default_package'\n     # ./app/models/spree/stock/packer.rb:16:inpackages'\n     # ./app/models/spree/stock/coordinator.rb:61:in block in build_packages'\n     # ./app/models/spree/stock/coordinator.rb:58:inbuild_packages'\n     # ./app/models/spree/stock/coordinator.rb:20:in packages'\n     # ./spec/models/spree/stock/coordinator_spec.rb:102:inblock (3 levels) in '\n```\nThe existing check works in a minority of cases, only when the stock location is fully out of stock. It will silently makes a package with insufficient inventory if there is some, but insufficient stock.\nThis also raises the error incorrectly if one stock location is empty, but the other has sufficient inventory.\nThese new specs also presented another issue: packaging seems to be broken when it need inventory from multiple stock locations to be fulfilled. This is the pending spec here.\nWe probably do want to check for this elsewhere (maybe at the end of package coordination) and raise exceptions. \n. @richardnuno does this cover the case you are concerned about?\nI'm concerned that neither of these changes really broke any tests. I suspect there is not good coverage of the various rescue_from Spree::Order::InsufficientStock sprinkled through controllers.\n. Rebased against latest master\n. Rebased again and added changelog entry\n. :+1:\nWe should probably not set Spree::Config[:default_country_id] here, and move it to config/initializers/, as the default is now config.use_static_preferences!, which doesn't store this preference in the database.\nI think we can merge this without changes to the default_country_id assignment, which this didn't change.\n. Thanks Kevin. jstree was terrible to use, flakey, and made us keep around a lot of cruft (custom json routes). I am very happy to see it go.\n. :+1:\n. I cloned this down and tested on a sandbox with Spree::Order.remove_checkout_step :delivery in an initializer. Things largely work, orders can be completed, no errors. The order admin is a little clunky: since shipping address isn't stored, can't make returns since there are no shipments. But nothing is outright broken.\nI am :+1: because this will definitely fix more than it breaks for stores with no delivery step, and causes no changes for stores having a delivery step.\n. StockItem has\nvalidates_uniqueness_of :variant_id, scope: [:stock_location_id, :deleted_at]\nSo we should only ever have active stock item per-stock-location-variant. I'd prefer we use Array#to_h and also lose the order(:id).\nOtherwise this is great :+1:\nSide note, I love the performance test gist. Is there anywhere in the project it would make sense to include these sort of benchmarks?\n. :+1: from me. I think this is a good performance win.\nI don't think the variant being in stock in all locations will be a common case. However I think the performance test gist does a good job of demonstrating the worst case: 3000 stock items across 100 stock locations. The previous code loaded 3000 StockItem models into memory, where this code only needs to load 3000 Integers, which is much faster.\n. :+1:\n. We should probably be supporting \"~> 5.0\" and assuming that friendly_id follows semver correctly.\n. :+1:\n. Seems fine to me :+1:\nDoes it make sense to pass in parameters to determine_order_user? order_params is already available on the controller class. Seems like it would be simpler to use that directly.\n. Yes, I would prefer it changed. If we're concerned about the time it takes to calculate order_params (I am not) we can memoize the method itself at a later date.\n. Great :+1:\n. > it would be nice to have a means of specifying the estimator at an instance level as well\nI don't think this makes sense. I'm not sure which instance of what would have a different value, where it would get it, or why that would be useful.\nA very short test would be nice. Maybe just asserting that a new estimator_class is called when running Stock::Coordinator#packages\notherwise :+1:\n. Also we might want to consider if Stock::Coordinator is the best place for this config to exist. It might be I'm not sure, but it seems a little weird to call Stock::Coordinator.estimator_class from shipment.rb.\n. Yeah, I like Stock.estimator_class a lot, with that it could even make sense in the future to allow overriding the whole coordinator.\n. Yeah, I like Stock.estimator_class a lot, with that it could even make sense in the future to allow overriding the whole coordinator.\n. I like this. Good by me :+1:\n. > We could update the existing migrations so that they have if statements in them. This way they run, but nothing is added.\nI think this is the best approach. It will mean that \"down\" migrations will not be able to function from spree 3.1 (we won't know from the migration if we actually renamed the first time around) but I think that is an acceptable compromise.\n. We did eventually incorporate Ben's great HABTM migrations from Spree 3.1. It will never be a totally seamless upgrade since the projects have diverged, but this should help.\nIf anyone finds other actionable improvements we can make to the upgrade please file a new issue.. I'd prefer dropping the -table suffix, from the classes which have that. Otherwise this looks good.\n. :+1:\n. :+1:\n. @exsuzme Sorry. This is failing due to the totally unrelated new sprockets-rails 3.0 release (which I've addressed as #597). Once that is in I am sure this will pass and be good to merge.\n. Thanks magnus\n. Looks reasonable to me.\nWould it instead make more sense to make this change in StockTransfer#ship? It seems odd for the controller to need knowledge of preserving the tracking number.\n. @richardnuno if that is desirable, we can have that behaviour\nruby\ndef ship(args = {})\n  args.assert_valid_keys(:tracking_number, :shipped_at) # raise ArgumentError on any other keys\n  args = merge(tracking_number: self.tracking, shipped_at: Time.current).merge(args)\n  update_attributes!(args)\nend\n(I took the liberty of also adding a shipped_at default here, as IMO that should also be a default if ship is called with no arguments. We could obviously make the default nil to provide that existing behaviour.\n. I agree with @jordan-brough. This needs a test.\n. Excellent. Thank you. :+1:\n. Closing due to staleness.\nThis code has changed a bit but may still be slow. It may be cacheable or may be unavoidable. Closing until there is an actionable proposal on how to improve this.. Thank you @lsirivong. Could you rebase on top of the latest master? The new sprockets-rails release yesterday causes builds to fail without one of our latest commits.\nNormally my recommendation is to avoid using .reload, but I think in this case it is appropriate. merge! is modifying the order.line_items collection indirectly in this method and the reload is needed to pick up the changes.\n:+1:\n. This should be fixed by 847a33d3ed1802f42d67d706db34cd693f4005c8. Making the reload unnecessary\n. I'm also :+1: this in its current location. I would find it very useful when working on a solidus store. I suppose this would be available to non-developer admins, but I don't think that's harmful, as it won't be linked anywhere. If this was an issue we could add a switch to disable it.\n. I like this as a way to get this in sooner, rather than make Kevin rebase weekly (which this PR needs again :wink:)\nWe had a quick discussion IRL, and I would prefer we made a \"theme\" folder for this and give it a name. This would allow us to make a themes/classic_overrides.scss file to restore the \"old\" (current) colours when this theme becomes the default.\n. With the theme change I am now :+1: (other than one comment) since this doesn't change the default styles\n. Looks good to me :+1:. Also fine requiring 2.1.4\n. I don't feel strongly about the .min.js. It's nice to have the .js to have our development slightly faster since we don't have to transpile, but the coffee is nice and readable. I'm fine either way.\nA short comment in _gateway.html.erb linking to the jquery.payment docs to explain type=tel would be nice, but maybe the commit message is sufficient.\nEither way :+1:\n. For when I later compile release notes: This was originally introduced here 5c400acad7d06f8e6a5145bc8a1734255f03332b (7 Feb 2013) so the existing stripe.js version would have been v1.0 and this upgrades us to v1.3.0\n. Thanks Martin :tada: :credit_card: \n. As @samanmohamadi pointed out this was breakage due to the new version of sprockets-rails. We will probably have a new point release this week locking us to sprockets-rails 2.x\n. I've released v1.1.1 which should resolve this issue. I've split the future task of compatibility with sprockets-rails 3.0 into #618.\n. I've released v1.1.1 which should resolve this issue. I've split the future task of compatibility with sprockets-rails 3.0 into #618.\n. Fixed by #1952! :tada: \nWe will remove the deprecated method completely for our next major release, Solidus 3.0.\nThanks!. Thanks @mtomov, I took this and ran with it. Hope you don't mind. See #614.\n\nThe only other thing would be to be able to mark individual preferences as static. But this option is the right start.\n\nThis should be achievable. I'm not sure this belongs in core, as I'd like all our preferences to be statically configurable, but the preference store is pluggable, and this can be implemented relatively easily.\nSome pseudocode:\n```\nclass MyPreferenceStore\n  def initialize(prefix)\n    @db_store = Spree::Preferences::ScopedStore.new(prefix)\n    @static_store = {}\n  end\n  def fetch(key, &block)\n    if statically_configured?(key)\n      @static_store.fetch(key, &block)\n    else\n      @db_store.fetch(key, &block)\n    end\n  end\n# Also needs #[]= and #delete\nend\nSpree::Config.preference_store = MyPreferenceStore.new('spree_config')\n```\n. Hi @stabenfeldt. Really appreciate the issue, sorry your first experience with our test suite was like this.\nI've created #615 which should fix the issue in the payment_spec.\n. :+1: Thanks Mike. Nice catch.\n. Optimistically tagging this for 1.2. The sooner we sort this out the better\n. @Blackening999 sorry you lost time, but our latest release v1.1.1 does set an explicit dependency on the older sprockets-rails. There's not much more we can do than that to avoid issues.\n. Looks good to me :+1:. Thank you!\n. Tagging for 1.2 optimistically, we do want our state machine to be better.\n. Isn't setting ENV['NO_FACTORIES'] = \"NO FACTORIES\" going to cause require order issues? If one of the factory specs is loaded before the other specs in our system I fear all factories will not be loaded, though they should be. I don't think \"other factories not loaded\" is something we can test for.\nOtherwise I love the factory specs.\n. :+1: Regardless of my suggestion. This is great.\n. :+1: Nice catch. Thank you.\nI'm trying to see if there's a good way to add a regression test for this. Testing drag interactions through capybara is pretty awkward.\n. I can leave a note for set_master_variant_defaults which is the only method changed (removed).\n. Added note and rebased\n. Thanks for the PR @sanchojaf. Could you comment on why you made this change? Is there an issue this is solving for you?\n. This is tricky.\nThere are definitely times where we need to add prefixes to get around rails autoloading issues. These occur whenever a store has the same class at the root level that we do under the Spree:: namespace.\nHowever, it's pretty ugly to need to use the full prefix every time we reference a class. If we are going to include the full class we should use the \"absolute\" version (with leading ::).\nA third option would be to eager load all of our classes, which I'm unsure is viable or even desirable.\n. > Can we go on a case-by-case basis here\nI can agree with this\n. rebased.\n. Locally I'm also seeing an issue which would be fixed by rubysherpas/paranoia#292\n. Fixed by #656 and I've released paranoia 2.1.5\n. I've given the specs a more thorough read and am very :+1:\n. Thanks @connecticus.\nI'm not sure about having workarounds in solidus itself for issues coming from another project (this is a globalize issue, which we don't use without solidus_globalize). One of the challenges is that we can't write a spec, since the problem can't be exposed without solidus_globalize. However this issue looks like a doozy, being open in globalize forever.\nWe use find_by a lot in this codebase, are the rest of those going to be broken as well? (possibly our default scopes prevent this incorrect behaviour in other models?) I'd be open to merging this if its the only place needing the workaround.\ncc @alepore and @dfranciosi who did the porting of solidus_globalize\n. rebased\n. Hi @Devalo thanks for the report. This I believe is caused by a sprockets-rails 3.0 incompatibility. This is similar to #609.\nWhat version of solidus are you using? The two latest versions are 1.1.1 and 1.0.3\n. Proof this passes on ruby 2.3 https://circleci.com/gh/jhawthorn/solidus/449\n. I agree. The logic performs is bizarre, seems almost accidental. I think we should probably backport this for 1.0.x and 1.1.x, but ideally get improved logic for our upcoming 1.2 release.\n. Other than one comment this is good by me :+1:\n. :+1:\n. I took the liberty of adding an additional spec :)\n. Nice catch. Thank you.\n:+1:\n. This is breaking due to sprockets-rails 3.0. Either change your dependency to \"~> 2.0\" or upgrade to solidus 1.1.1.\n. Thank you Gray.\nI believe there is also a api/app/views/spree/api/taxons/jstree.rabl file which can be removed.\nThere was some concern raised last time this was brought up that this is an incompatibility and should be deprecated instead. I feel otherwise and am fairly confident nobody would use these routes. The data format they return is only useful when using jstree (possibly only the really old version we had installed)\n. :+1:\n. > Is there another way to get the same structure of data out of our public API?\nNo, but it's a trivial transformation.\njs\n// /api/taxonomies/1/taxons/1/jstree\n[{\"data\":\"Bags\",\"attr\":{\"id\":3,\"name\":\"Bags\"},\"state\":\"closed\"},{\"data\":\"Mugs\",\"attr\":{\"id\":4,\"name\":\"Mugs\"},\"state\":\"closed\"},{\"data\":\"Clothing\",\"attr\":{\"id\":5,\"name\":\"Clothing\"},\"state\":\"closed\"}]\nCompared to the proper route\njs\n// /api/taxonomies/1/taxons/1\n{\"id\":1,\"name\":\"Categories\",\"pretty_name\":\"Categories\",\"permalink\":\"categories\",\"parent_id\":null,\"taxonomy_id\":1,\"taxons\":[{\"id\":3,\"name\":\"Bags\",\"pretty_name\":\"Categories -\\u003e Bags\",\"permalink\":\"categories/bags\",\"parent_id\":1,\"taxonomy_id\":1},{\"id\":4,\"name\":\"Mugs\",\"pretty_name\":\"Categories -\\u003e Mugs\",\"permalink\":\"categories/mugs\",\"parent_id\":1,\"taxonomy_id\":1},{\"id\":5,\"name\":\"Clothing\",\"pretty_name\":\"Categories -\\u003e Clothing\",\"permalink\":\"categories/clothing\",\"parent_id\":1,\"taxonomy_id\":1}]}\nHere's my go at a transform in js\njs\n$.map(data.taxons, function(t){\n  return {\"data\": t.name, \"attr\": {\"id\": t.id, \"name\": t.name}, \"state\": \"closed\"};\n})\n. I'm still in favour of removing this as I don't expect anyone to use the jstree specific route of the api, but discussion seems to have stalled.\nClosing this issue for now.\n. Thanks @softr8, this is a great start. I'm just not sure where the best place would be to update the usage count. Maybe adjustment finalization? I'll have to think it over a bit.\n. :+1:\nI'm also wondering if we could combine this with the validates :amount on line 9\n. Awesome. Even better :+1:\n. Duplicate of #618 \nSoldius 1.1.1 and 1.0.3 have an explicit dependency on the old sprockets-rails version.\nWe need a new release of handlebars_assets in order to support the new version of sprockets-rails\n. Also we could consider marking $0 adjustments as ineligible, which would have the same effect of hiding them.\n. :+1: thank you\n. Reads much better to me :+1:\n. This does seem like a good target for extraction to a PORO, but the handling of the two cases (receiving either an item or an order) is a little awkward. The two cases share very little code.\nMaybe we could adjust the signature of the adjuster? Brainstorming a little:\n```\nclass Adjuster\n  def initialize(order)\n    @order = order\n    @tax_zone = order.tax_zone\n  end\ndef adjust_order\n    # adjust all items in the order\n  end\ndef adjust_item(item)\n    # adjust just the item\n  end\nend\n```\n. Looks good to me. :+1:\nOne thought, should we keep TaxRate.adjust as a deprecated method that would use the PORO?\n. I did this\n. The error message for this can also be:\ncannot read property 'opener' of null\n. I can verify that you aren't able to destroy a cancelled order.\nSeems like this is the culprit:\nhttps://github.com/solidusio/solidus/blob/master/core/app/models/spree/inventory_unit.rb#L136-L139\nSeems by design that we don't want to be able to destroy cancelled units, possibly to ensure we preserve data.\n. Thanks @jrochkind this is great :+1:\nI tried to whip up a spec to test for this change, but I wasn't able to replicate the old behaviour that multiple orders were created. I was however able to test that duplicate return authorizations were created.\n``` ruby\nin spec/lib/spree/core/testing_support/factories/customer_return_factory_spec.rb\nit \"creates only one of dependent records\" do\n  create(:customer_return, line_items_count: 2)\n  aggregate_failures \"items created\" do\n    expect(Spree::Order.count).to eq(1) # This never fails\n    expect(Spree::ReturnAuthorization.count).to eq(1) # This used to fail, fixed by this PR\n  end\nend\n``\n. :+1: Thank you!\n.ascend_by_name` is a scope on Product. This probably broke when we disabled arbitrary ransack attributes for security.\n:+1:\n. What am I thinking. This is zones, not products. Maybe bad, ancient copypasta that never worked.\n. :+1:\n. :+1: but a test case would be great\n. This is failing because remove_environment_from_payment_method.rb has the line Spree::PaymentMethod.where('environment != ?', Rails.env).update_all(active: false)\nWe'll have to replace that with raw SQL.\n. :+1:\n. :+1: Thank you for updating\n. I think everyone prefers the 1.9 syntax. We've been fine with commits either updating them or leaving them the same.\nI think we've avoided a complete conversion to keep our git-blame useful and to avoid conflicts, but it's something we should discuss again in slack.\nTo clarify what this PR does:\nBefore this change,\nif you have no option values selected you'll be shown \"Please select\" in both boxes. great.\nOnce you select one option value and save, on the next edit it will fill in the next value. Weird.\nClearing the boxes once set doesn't remove the option values from the variants. Also weird.\nTested manually and this seems to fix all those issues :+1:\n. Thank you @mamhoff, this is fair more approachable and understandable.\nMy favourite thing about this is that the previous remaining_rates behaviour varied based on the order of the rates (which was somewhat random) and is now fixed to do the (more) right thing. So this isn't even really a behaviour change.\n:+1:\n. Note to future self: We'll have to make a change log entry for the removal of potentially_applicable.\nClarke says :+1:\n. > I believe the notion of pre_tax_amount is only present in the return items because\n\nsomeone from a sales tax country wanted to use something excluding sales (additional) taxes.\n\nI believe the opposite to be true, pre_tax_amount was introduced purely for VAT countries (whether it's appropriate or helpful there is another discussion). When applying taxes without included rates pre_tax_amount == amount.\nI'm :+1: and this looks good, but we'll need to be very clear in our release notes about what the behaviour change is as it will affect admin end-users.\n. I agree that the original code is probably incorrect, but I worry this will reintroduce the issue that code was intended to solve.\nConsider two return items, each with a total of 10.005, which afaict would be what you would get for buying two items totaling $20.01. The existing code would round it to $20.01 correctly. The code in this PR would round each item to $10.01 for a total of $20.02, more than the original paid amount.\n. Thanks mamhoff. Look forward to however we tackle this next.\n. I think this is something core should support, as core currently supports multiple currencies.\nHere's a nice list of currencies and their decimal places\nhttps://en.wikipedia.org/wiki/ISO_4217#cite_ref-ReferenceA_6-0\nJust as another data point, I've previously been asked to support 8 decimal places for bitcoin enthusiasts, but I feel that belongs in an extension as it's really excessive for physical currencies.\n\nYeah. It's just a worse version of the RubyMoney Money.\n\nIt's a thin wrapper at this point, we could probably begin delegating functionality to the underlying object with the goal of eventually just using ::Money\n. Just a quick update\nThe output of rubocop after the automatic conversion is largely useful and are things we should fix\nhttps://gist.github.com/jhawthorn/de55a6894ca49e9c3d67\nThere are a few manual fixes I did here so that the AutoCorrect didn't mangle our source code, and a few others which fixed some of the warnings that occurred. It might make sense to extract those to their own PRs so that we can review just the automated changes for correctness here.\nStill WIP, but I am liking the initial results.\n. At the end of this rubocop gives (IMO very useful) warnings\n. I think we are fairly happy with this conversion now, though we may relax some rules later.\n. :+1: But a changelog entry would be great\n. :+1:\n. :+1:\n. I can't reproduce this (but I might be missing something). Both /admin/search/users and /admin/search/products take the same amount of time with or without this change in a fresh sandbox.\n. Update: I was totally missing something.\nThis took /admin/search/users from 200ms to 27ms (on my not particularly fast laptop)\nThanks :+1:\n. I'm not sure about this. I do understand the need for this to support globalize, and want to find a good solution, but I have a lot of questions about this approach.\nI don't think it's clear when this scope should be used. base_scopes to me implies most of the time, but I don't think that's appropriate. The LEFT JOINs will affect any SQL aggregate calculations, for example.\nIt's also unclear what extensions should be \"allowed\" or \"encouraged\" to use this for. Should it just be for includes/eager loading, or can it be used to filter results? Which situations should the extension expect the scope to be applied?\nFor eager loading, I'm also not sure how this will work in nested models ex. if you are selecting variants you probably want to eager load the products' translations too.\nAnother (more minor) problem is that there's no good way to test that the scope was used in solidus itself. There might not be a good solution to that, though, other than testing in the solidus_globalize project.\n. :+1: works for me\n. Merged as #1118. Thank you\n. Merged as #1118. Thank you\n. I'll pull the ||= commit out. I think it's correct to change, but it's confusing enough to warrant its own PR and discussion\n. :+1: Perfect with the rails bump as well.\n. Possibly failing javascript due to #691\n. The interface has changed. There is now an \"ADD TAXON\" button in the top right. The new taxon can be moved to the desired location.\n. Thanks for the report @CallMeSH \nI've been trying, but can't reproduce this either on a sandbox or a fresh store. Do you have any customizations in your store?\nWould you mind sharing your Gemfile.lock and ruby version?\n. Thank you. I've made progress and can now reproduce this.\n$ rails c\nRunning via Spring preloader in process 30840\nLoading development environment (Rails 4.2.5)\nirb(main):001:0> reload!\nReloading...\nS=> true\nirb(main):002:0> Spree::Config.stock\nNameError: uninitialized constant Spree::StockConfiguration\n        from /home/jhawthorn/src/solidus_constant_test/vendor/bundle/gems/solidus_core-1.2.0.rc1/app/models/spree/app_configuration.rb:316:in `stock'\n        from (irb):2\n        from /home/jhawthorn/src/solidus_constant_test/vendor/bundle/gems/railties-4.2.5/lib/rails/commands/console.rb:110:in `start'\n        from /home/jhawthorn/src/solidus_constant_test/vendor/bundle/gems/railties-4.2.5/lib/rails/commands/console.rb:9:in `start'\n        from /home/jhawthorn/src/solidus_constant_test/vendor/bundle/gems/railties-4.2.5/lib/rails/commands/commands_tasks.rb:68:in `console'\n        from /home/jhawthorn/src/solidus_constant_test/vendor/bundle/gems/railties-4.2.5/lib/rails/commands/commands_tasks.rb:39:in `run_command!'\n        from /home/jhawthorn/src/solidus_constant_test/vendor/bundle/gems/railties-4.2.5/lib/rails/commands.rb:17:in `<top (required)>'\n        from /home/jhawthorn/src/solidus_constant_test/vendor/bundle/gems/polyglot-0.3.5/lib/polyglot.rb:65:in `require'\n        from /home/jhawthorn/src/solidus_constant_test/vendor/bundle/gems/polyglot-0.3.5/lib/polyglot.rb:65:in `require'\n        from /home/jhawthorn/src/solidus_constant_test/bin/rails:9:in `<top (required)>'\n        from /home/jhawthorn/.rubies/ruby-2.3.0/lib/ruby/2.3.0/rubygems/core_ext/kernel_require.rb:55:in `require'\n        from /home/jhawthorn/.rubies/ruby-2.3.0/lib/ruby/2.3.0/rubygems/core_ext/kernel_require.rb:55:in `require'\n        from -e:1:in `<main>'\n. Sounds reasonable to me :+1:\nCC @adammathys who I know pointed this out before\n. One thing we'll have to check before merging is whether this breaks extensions which depend on auth_devise\n. Version 1.1.2 has been released which is compatible with jquery-rails 4.0\n. Version 1.1.2 has been released which is compatible with jquery-rails 4.0\n. :+1:\n. Hi @wuboy0307 thanks for the PR.\nI'm not sure why this change is desirable. Currently you have the option to configure preferences statically by calling use_static_preferences! (allowing you to configure them in an initializer), or to always use preferences from the database by not calling use_static_preferences! (allowing you to change the from the console and have changes shared across servers).\n. Okay, I understand a bit better, but I would not like this in solidus itself. There's enough confusion with db vs static preferences already. Having preferences only reloaded on a server restart would be very strange for users.\nWe've been making an effort only to store values in AppConfiguration which should be global and configured by a programmer.\nFortunately, if this is the behaviour you want, I think you could implement what you're looking for yourself just by making your own preference store.\n(untested example code)\n``` ruby\nclass CachedDbStore\n  def initialize(scope)\n    @db_store = ScopedStore.new(\"spree/app_configuration\")\n    @cache_store = {}\n  end\ndef fetch(key, &block)\n    @cache_store[key] ||= @db_store.fetch(key, &block)\n  end\ndef []=(key, value)\n    @cache_store[key] = value\n    @db_store[key] = value\n  end\ndef delete(key)\n    @cache_store.delete(key)\n    @db_store.delete(key)\n  end\nend\n```\n. Okay, I understand a bit better, but I would not like this in solidus itself. There's enough confusion with db vs static preferences already. Having preferences only reloaded on a server restart would be very strange for users.\nWe've been making an effort only to store values in AppConfiguration which should be global and configured by a programmer.\nFortunately, if this is the behaviour you want, I think you could implement what you're looking for yourself just by making your own preference store.\n(untested example code)\n``` ruby\nclass CachedDbStore\n  def initialize(scope)\n    @db_store = ScopedStore.new(\"spree/app_configuration\")\n    @cache_store = {}\n  end\ndef fetch(key, &block)\n    @cache_store[key] ||= @db_store.fetch(key, &block)\n  end\ndef []=(key, value)\n    @cache_store[key] = value\n    @db_store[key] = value\n  end\ndef delete(key)\n    @cache_store.delete(key)\n    @db_store.delete(key)\n  end\nend\n``\n. :+1:\n. @tvdeyen I have a different plan to remove the. Those are a pain point for me because it messes up capybara's matching: you might have tofill_in \"Name \", with: \"My Name\"`. It also pollutes our markup with something which IMO is a style concern. I plan to open a PR where we change it to\nhtml\n<label class=\"required\">Name</label>\ncss\nlabel.required:after {\n  content: \" *\";\n}\n. :+1: Thank you. Appreciate the tests\n. Thanks Thomas, I also don't like the key used here, but this fixes a missing translation on 1.2.0.rc2 that I'd like to cherry-pick back.\nWe have an existing en.admin.tab.xxx namespace that might make more sense. We should also consider en.admin.nav.xxx\n. :+1:\n. :+1: Thanks Murphy\n. Yes. This should be fixed by #850. If it isn't please reopen or file a new issue.\nThanks again @simo163\n. :+1: Thank you. The test case is especially appreciated :smile: \nThis changes the behaviour when \"only show complete orders\" from displaying only incomplete orders to showing both complete and incomplete orders. We'll have to add this to our changelog.\n. > Do you want me to add that? Or, will you add it?\nI'm happy to fill in the changelog, but help is always appreciated :smile: \n. Updated with more descriptive names in the shadowed variable commit\n. Updated with more descriptive names in the shadowed variable commit\n. rebased\n. :+1:\n. I'm starting to be less terrified by this change :). Making the shipping rate adjustments eligible=false helps my confidence in safe upgrades a lot.\nA couple concerns still:\n- eligible? on the taxable items isn't the most descriptive. Looking at line_item.eligible? the purpose of that method is unclear. Maybe something like tax_adjustments_eligible?.\n- The adjustments on ShippingRates don't seem to be deleted when they are. (Orphan records added to the DB when refresh_rates is called)\n- This adds a lot of queries when calculating shipping rates. Maybe unavoidable?\n. specs fail, and this seems to have stalled.\nPlease feel free to reopen or file a new issue.\n. Started looking into this, and although there are some significant improvements in select2 4.0, there are a number of incompatibilities (and maybe some style issues) that make the upgrade non-trivial.\nI'll revisit this again later, maybe after the select2 4.0.2 release\n. I'm no longer sure it's a good idea for our project to upgrade to select2 4.0.3. I can't entirely rule it out, but it would be a significant investment (both from me and stores/extensions upgrading) for questionable, and maybe negative benefit.\nSelect2 4.0 has significant API changes. See for example what it takes to change variant_autocomplete.js.coffee to use select2 4.0.\n The signature of processResults has entirely changed\n The signature of data has entirely changed\n initSelection can be made to work with modifications, but actually generates warnings that it is deprecated without replacement.\n formatSelection and formatResult have been replaced with templateResult and templateSelection\n  * They take different arguments\n  * Output is escaped by default, breaking templates. It can be configured not to be escaped, but Select2.util.escapeMarkup is no longer provided.\n  * formatResult is initially called with the data {loading: true, text: \"Searching....\"}. What?!\n* Automatic expanding width to match the existing element no longer seems to work\nThose are all frustrating and will be an issue for every single one of our existing select2 components. But there's a greater issue that I think makes this a non starter: \n\nselect2 can no longer be tied to an <input\n\nThere is supposed to be a compatibility layer for this but it does not work at all. Select2 now expects to get a <select> element even when doing ajax (which I don't believe is even supported in 3.5). This is a fair bit more awkward because we have to provide at least the <option> for initial selection.\nAny element (solidus, extensions, or stores) using variant_autocomplete or any of our other autocomplete components will have to change their markup, and will have no way of being backwards compatible (which is very bad for our extensions).\nOn top of that. I'd suggest that the library's future is uncertain. There have been under 10 commits since last June, with the project seeking new maintainers.\nSo IMO we should stick with select2 3.5 for the time being, possibly improving the old style since that was one of the main issues with it. We should also consider moving off of select2 entirely as upgrading would be as much of a breaking change as migrating entirely. Unfortunately, I know of no equivalent replacements.. Closing as there's nothing actionable here. I no longer think upgrading to select2 4.0 would be a net positive for our project.. :+1:\n. :+1: This is great. Finally a fix to the \"many Alabamas\" problem.\nI was a little concerned about this slowing down our test suite, but the performance of generating postal codes for a region is very reasonable (~28k i/s)\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. DEPRECATION WARNING: `#timestamps` was called without specifying an option for `null`. In Rails 5, this behavior will change to `null: false`. You should manua\nlly specify `null: true` to prevent the behavior of your existing migrations from changing. (called from block in change at /home/jhawthorn/src/solidus/core/sp\nec/dummy/db/migrate/20160201232080_create_spree_shipping_method_stock_locations.spree.rb:8)\nThis adds null: true, which preserves the the existing rails 4.2 behaviour, removing the warning.\n. We spoke IRL to approve this.\n. :+1:\n. This was merged as part of #798\n. :+1:\nI think this could be hidden away a little more, it's not a commonly visited page, but we should tackle that along with return reasons and refund reasons.\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. The products come from the sample data, our seed data includes only zones, countries, states, etc.\nTry installing using:\nrails g spree:install --sample=false\nIn the future, questions like this would be better fielded in our #support channel in our Slack.\n. Thanks @sanchojaf \n. Thanks @sanchojaf. The last occurrences of AUTH_TOKEN were removed as part of our security patches in c0775a17a9e25f8cb8dc8cc7651465da28b0584f\n. :+1:\n. :+1:\n. :+1: awesome\n. Thanks for the report\nClearly we're ignoring the result of update_attributes, and always setting successfully updated, which we should not do. This is because this configuration page has changed a lot over the years. This used to just set global config preferences (which couldn't really fail), but now sets settings on a Store model.\nWe'll want to add something to the extent of\nruby\n@store = current_store\nif @store.update_attributes(store_params)\n  # success\nelse\n  # failed\nend\nBut it could need some larger changes to properly use the @store variable and display errors.\n. @stabenfeldt this should be fixed by #819. Thanks again.\n. :+1:\n. :+1:\n. :+1:\n. They should be in the same place in both spree_auth_devise and solidus_auth_devise\nfrontend/spree/checkout/registration.html.erb\nIn the future this sort of question would be more appropriate in our slack channel.\n. The bad news: This failed a few times\nThe good news: always in the same place\nhttps://circleci.com/gh/jhawthorn/solidus/643\nhttps://circleci.com/gh/jhawthorn/solidus/640\nhttps://circleci.com/gh/jhawthorn/solidus/637\n. This still doesn't seem stable enough to merge, there's some clicks on the frontend which seem to miss their target. Still investigating\n. :+1:\n. :+1:\n. This breaks the existing default_country_id preference, it would be great if that could remain functional.\n. Thanks for re-adding that functionality Martin. This is :+1: from me now.\n. I also think iso is the best choice\n. Thanks again!\n. Looks good to me :+1: Thanks\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. Test failure here looks likely related\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. Closed by #850\n. There are other gems we can likely remove with a little work. stringex is used only by taxons, highline I'm not sure is needed. This was the easy one.\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1: Thank you.\nI may cherry-pick this into #835, where I move that template\n. Thanks again @pdanzinger. This was merged in #850 as 6d595604527538cbaf71aa276b1aed92810572a2\n. Thank you both :+1:\n. Thank you for the exemplary bug report, I believe I've addressed the issue (and several others) in #850\n. Thanks again @CallMeSH. This should be fixed in #850, which is merged if you'd like to check that this is fixed in master.\n. :+1:\n. Typo fixed. Thanks\n. :+1:\n. I'm giving this some extra thought because the user class is pluggable. Not sure if we need to provide translations for en.activerecord.attributes.spree/legacy_user as well as en.activerecord.attributes.spree/user.\n. :+1:\n. :+1:\n. Fair enough. I prefer the slightly our of place style to the blue because IMO we've allocated that colour of blue to buttons, where these are form inputs.\nI'll try this again after upgrading to select2.\n. Looking good\nI think we need a more descriptive name than provided_link. Maybe \"new_resource_url\" or similar\n. I actually prefer the partial not use new_object_url, it's best that partials don't know too much about the controller they're being used from. Explicitness is nice.\nThis looks good :+1:\n. We might need to wait for other PRs to be rebased and include this config before enabling hound\n. :+1:\n. :+1:\n. I gave this a look today. To clarify a few points:\nBootstrap's tab.js doesn't help us here at all. tab.js adds the ability to hide and show a div for each tab on the same page, which we aren't doing. Our tabs are links to other pages. It doesn't provide the functionality this does of collapsing items into a dropdown if they are too large. (bootstrap does also have collapse.js, but that's slightly different, and not quite what we're looking for here)\nWe could use bootstrap's css here, but that will either require changing markup (which this PR carefully avoided), or require additional complexity to use the same mixins in out _tabs.scss. The latter I think is worth investigating (I think bootstrap's tabs have a better look than these), but is outside the scope of this PR, especially as we haven't merged bootstrap yet. I'd be happy to look into styling after both this and bootstrap are merged\n. Thank you everyone\n. There are going to be times where the existing code is faster, for example when doing order updates the shipping_rates association will already be loaded.\nThis also introduces a bunch of association methods which we do not want available, like selected_shipping_rate= which could cause a lot of confusion.\nI do agree that most of the time (especially for display) having a selected_shipping_rate association will be preferable to preloading the entire shipping_rates association.\nRe: the ordering, I'd be happy to lose it as having multiple selected shipping rates does not work.\n. Sorry for the confusion @dfmedeiros, just explaining that this does need some additional time for consideration. I'll be investigating this today.\n. Thanks @joshhepworth this largely looks good.\nIs there a reason for dropping the transaction? I would prefer keeping it because it's likely faster at doing the bulk insert, and I think it makes more sense to have no countries if the import fails than some.\n. Force push an amended commit please.\n. Thank you\n. Nice catch.\nTo reiterate, this Spree.t is run at class load time, so this translation wouldn't show up in the correct locale (this can be done using validations by passing a symbol).\nThanks very much @SebAshton :+1:\n. :+1:\n. :+1:\n. :+1: Thanks again @jrochkind\nIf you had the time implementing @mamhoff's suggestion would be great.\n. Thanks @jrochkind that CI failure is an annoying phantomjs crash (hopefully soon we can upgrade to 2.1 which should be more stable). It passed on a retry.\n. :+1:\n. :+1:\n. :+1:\n. Sorry about that @CallMeSH. My original attempt in #850 to fix this was broken and I had to revert it.\nI've opened #896, which should finally fix this.\n. :+1:\nWe could also switch this to '~> 1.7' to better follow semver\n. :+1: still\n. :+1: Thank you. Very glad I'll never have to track down test order issues due to forgetting to reset a preference.\nI've retriggered the build (which is now passing)\n. :+1:\n. I agree that this seems like intended behaviour. Master variants aren't intended to be purchasable when there are other variants on the product.. \n. With our without suggestion :+1:\nReally like the added return none\n. :+1:\n. It might make more sense to list these in our wiki, which is publicly editable\n. We now just link to extensions.solidus.io, so I think this can be closed. :+1: I agree with the assumption that nobody was sending _ids as a scalar.\n. :+1: Thanks @cee-dub \n. :+1: \n. :+1:\n. Does this affect projects including solidus, or just solidus itself? I'd prefer to gave projects the option of choosing their preferred test framework (although our testing_support does use rspec).\n. Awesome. Thank you for checking. :+1:\n. :+1:\n. @tvdeyen I'm pretty sure using an inline style is the right thing to do here, as gross as it is.\nBootstrap has !important on their .hidden class, so .show() will not make that visible. Adding the inline style is the same thing calling .hide() would do.\nFor reference, from jquery\n\nNote: If using !important in your styles, such as  display: none !important, it is necessary to override the style using .css( \"display\", \"block !important\") should you wish for .show() to function correctly.\n. > .hidden does not exist in v4 of Bootstrap which is what we'd be adopting anyways\n\nWe are not adopting bootstrap on the frontend, which is what I'm attempting to fix. There are going to be existing stores using this view with a bootstrap3 based layout.\n. We talked about this a bit more. There's a lot we could do to clean up this JS, but a lot of it is hindered by the state of CSS on the frontend. Sites with heavily customized frontends  screen.css.scss, so we aren't able to add styles with certainty they will show up.\nIn the future we should consider adding a _checkout.scss, which includes minimal unopinionated styles can encourage stores to include that and build off of it, but that is too big a task for this small fix.\n. :+1: \n. Took me a minute to fully understand. The compute_amount method is doing the same check, and setting the amount to negative only if included_in_price && !default_zone_or_zone_match. So if included_in_price && amount > 0, we know that default_zone_or_zone_match is truthy.\n:+1:\n. :+1: Much improved. Thank you.\n. :+1:\n. :+1:\n. :+1: Looks good to me. Thank you\n. :+1:\n. Webmock was just in common_spree_dependencies, so it wouldn't have been included by projects including solidus\n. :+1:\n. :+1:\n(I should add a hound.yml on our old branches to skip all checking)\n. :+1:\n. :+1:\n. :+1: It makes the most sense to always stay on the edit page after saving here.\n. :+1: Thanks\n. Looks reasonable to me :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1: Was originally added believing that shipments were updated as part of the unreturned item change. It turns out they are not and it is explicitly disabled in create_proposed_shipments\n. I think we need a regression spec for the issues this is fixing.\n. Looks good to me :+1: \n. @cbrunsdon done\n. :+1:\n. @rafaelfranca Looks good to me. All our suites passed https://circleci.com/gh/jhawthorn/solidus/745\nThank you for keeping us in mind. :heart: \n. I agree with mamhoff. .calculator is defined in CalculatedAdjustments. Maybe there was some confusion because a server restart is needed to update the calculator configuration.\nIf we're mistaken, please reopen.\n. Makes sense. This test now matches the stated context.\n. It will be slightly different (methods defined on module instead of directly on class), but I don't think that necessitates a CHANGELOG entry.\n. Even if we were to delete empty shipments, that would be even more of a reason to delete this check :wink: \n. I wouldn't mind #packages being public, as I could see that being useful, but I don't feel that strongly.\n:+1:\n. I agree. This rule is 99% of the time correct, but often in rails it requires writing awkward code.\nFor example it recommends replacing:\nrespond_to do |format|\n  format.html\nend\nwith\nrespond_to(&:html)\n. :+1:\n. :+1:\n. > The small misalignment of things everywhere is a no-go to me. I'd prefer to see us importing things one component at a time. What was your thought on that?\nWe spoke IRL, most of our misalignments are going to be due to bootstrap's reboot and typography, and it isn't much use to include bootstrap without those. I'm going to try to fix up as many issues as possible before merging and have created a checklist of issues.\n. I think this is good to go :ship:\nI spent a while browsing through the admin and can no longer find anything noticeably broken. Spacing has of course changed slightly in a few places, but nothing I've found looks out of place.\n. I replaced the a-la-carte individual JS files with the single bootstrap.js file. It was pointed out to me that it would be nice for extension developers to have the entire suite of bootstrap js components available. This is also a lot simpler to include anyways.\n. I prefer including the entire bootstrap.js file. I suspect it will be a point of confusion for users if some bootstrap features don't work (the bootstrap docs aren't as clear as they could be about needing to include js for the data-toggle features).\nIMO if we were going to sweat a couple extra KB, we wouldn't be using bootstrap in the first place.\n. :+1: \n. :+1: Thank you\n. I'd prefer leaving this in. It was deprecated fairly recently and was widely used before that.\n. > It has been deprecated long enough\nI disagree, this was deprecated in solidus 1.1. I would like to recommend to users upgrading to solidus to upgrade directly to the latest version, skipping intermediates, which I can't do if this is removed.\n. I'd like to remove deprecations in 2.0 (which IMO should be the rails 5 release)\n. Seems reasonable to me. Thank you. :+1:\n. > Actively removing it from legacy stores may cause issues if the store has been customized to use the role.\nThank you for considering this. 100% agree.\n:+1:\n. I'm wary of preferences being this smart, so I also would prefer can_restrict_stock_management being false by default.\nI expect this feature to be used by almsot nobody, in the future I'd like to consider moving it into a separate extension\n. :+1: Thank you\n. I aim to follow semver as closely as possible, but I feel this is fine to squeak by in a minor release as this only affects the admin interface and only for an infrequently used feature.\nThanks @eric1234 \n. This is a phantomjs bug.\n. :+1: thank you\n. > This will give the estimator the information it needs to calculate taxes correctly in the pending tax work.\nIf this is the case we need a spec for that\n. :+1:\n. Merged in #1012\n. :+1:\n. :+1: and thanks again for the excellent commit message\n. :+1:\n. Thank you\n. @tvdeyen done!\n. Thanks Jordan, that makes sense :+1:\n. :+1: Looks good to me\n. Fine by me.\n. Looks good to me. Thanks again. :+1:\n. Thanks @eric1234 \n. Thank you. I wish we had caught that in code review. :+1:\nI'll likely backport this to the next solidus 2.2 release as it only affects seeds, so there should be no compatibility concerns.\n. In addition to others comments I'd love to see LegacyLineItemPricer use instance instead of class methods. In the current implementation the instance has no defined behaviour. All of the methods take in a line_item, storing that as an instance variable should help clean that up.\n. :+1:\n. :+1: Yikes. variant.currency is wrong and makes no sense\n. Much better. Thank you. :+1:\n. Hi @isindexer. Thanks for the report.\nThe image has been added to master and will be in the next release (see #898)\n. This is excellent. :+1:\nThank you for addressing the regression.\n. Thank you\n. Unfortunately, locking pry-byebug to \"~> 1.0\" is intentional, newer versions behave in a way that makes binding.pry broken for developing feature tests (hangs the server thread).\nSee deivid-rodriguez/pry-byebug#69\n. I believe it is still an issue. You'll find that you can't visit pages or do anything which makes requests to the server.\nI'd be happy to have pry and byebug as separate dependencies.\n. This doesn't seem to be an issue in solidus itself. Judging by that SQL query, maybe something to do with solidus_globalize. I'll investigate further.\n. @modreoci I believe you're experiencing globalize/globalize#423. Using the current globalize master should fix this issue.\nIf it doesn't, please file a bug against solidus_globalize and we'll take another look.\n. These values aren't going to work for databases other than postgres.\nIs it possible that rails' DATABASE_URL would solve your needs here?\n. DATABASE_URL won't replace the database.yml in the generated app, but will take precedence over the settings in database.yml when connecting to the database\n. :+1:\n. Thank you.\n. If it makes no difference I will close this and #1005\n. Reopening due to #1193\n. :+1:\n(and I don't expect any measurable performance change)\n. :+1:\n. :+1: :100: \n. This is a workaround more than anything, we should probably move AppConfiguration to lib/, as it should not be code-reloaded.\nThat said, this is a good workaround :+1:\n. Works for me :+1:\n. I have done this elsewhere and it has worked well (8090a4dce549fcb22821e6b63da48b2324d6609d). Not sure why I missed this one (oops).\n:+1:\n. :+1:\n. :+1: Makes sense (well, as much as anything when dealing with acts_as_paranoid models).\n. :+1: great\n. Just a note that we might switch that 12:4 column ratio back to a 8:4 when we switch to bootstrap's 12 column grid. For now though, this is the right step forward.\n. :+1: Much simpler, and now actually works!\n. We're using more of underscore than I expected :disappointed: \n. :+1:\n. :+1: :100: \n. > This isolates bad functionality to a place where it can be removed. This should be removed in Solidus 2.0.\nAgree 100%. Isolation also means it could be trivially extracted into a gem if someone still needs it when we land Solidus 2.0.\n. :+1:\n. Is there a good reason to return the price in the default currency if nil is used? The existing behaviour didn't allow that afaict.\nI tend to view anywhere we use a \"default\" (price, locale, or store) as a place that is likely to accidentally introduce incorrect behaviour. My preference would be to require the caller to use price_in(Spree::Config.currency) if they indeed want the price in the default currency\n. Great :+1:\n. Thanks @dholdren I have noticed that bug before. I'll see if we can revert that change to fix it.\n. :+1:\n. :+1: \n. :+1: Anything using Spree::Config[:currency] is probably wrong.\n. :+1:\n. Closing as we do have the solidusio/solidus_guides repo and this is a work in progress\n. :+1:\n. :+1: thank you\n. @mtomov \nWith the solidus admin we're in a somewhat unique and difficult situation.\nI don't think we can easily use a external transpiler (other than by going through sprockets). It's unreasonable to add extra work for users by making them setup a transpiler in order to use the admin. I also don't think we want to precompile and commit the result (this works well for small JS libs, but not so much for an application like solidus).\nI really don't want to push coffeescript because generally JS developers don't care for coffeescript, and I would like JS devs to contribute to our JS.\nSo the current feelings of the core team is to accept contributions in either JS or coffeescript, but to avoid converting between the two.\n. This doesn't help prevent timing attacks. Secure compare will always be called with the same two values, so all this does is add a constant time operation for the case that a valid token has been entered (which is pointless, as this only happens when you've entered a full correct token).\nIf there was a possible timing attack here it would have to be a measurement of the difference in a SQL query returning \"0 results\" on a partially correct token vs a slightly correct token.\n. We've chatted in slack. I don't believe there's an urgent danger here. We have some ideas to implement secure_compare properly that we'll work in implementing later quell any fears of timing attacks.\n. Thank you\n. Thank you :+1:\n. :+1:\nI think we'll want a CHANGELOG entry as this is a (beneficial) behaviour change that we now respect the default_currency option on a store\n. Looks good to me. Thank you :+1:\n. :+1: I think the previous migration was just too big and slow to run. Could we also update the CHANGELOG explaining this limitation.\n. It failed in an extension which only included ControllerHelpers::Order. https://github.com/solidusio-contrib/solidus_social/blob/master/app/controllers/spree/omniauth_callbacks_controller.rb\nIt could be an issue in custom controllers in apps as well.\n. Thanks\n. :+1:\n. :+1: Thank you\n. This is scary because it's a big change, but it seems very good to me.\n. Thank you @mamhoff this is excellent.\nAlso thank you @mtomov for the review. Lets try to get some good class-level documentation on these classes before the proper 1.3.0 release \n. Looks good to me :+1:\n. :+1: Thanks\nWe might consider adding more of these from Money::Arithmetic. This is a great start.\n. :+1: Thanks\nWe might consider adding more of these from Money::Arithmetic. This is a great start.\n. This is a bug in select2 (select2/select2#128). It looks better, but still broken select2/select2#3824, in the 4.0 version (we're still on 3.5).\nAFAICT the only workaround is removing the required attribute on the field and performing the validation ourselves.\n. :+1:\n. :+1:\n. One of the times is probably the payment's creation, and the other would be when it was captured/completed\n. There are several changes I think this needs but I will send them in a future PR.\nThank you @Murph33, @Sinetheta, and @Mandily \n. :+1: Looks good\n. This should be fixed by #1105\n. :+1:\n. :+1: Thank you\n. This ProductScope situation is a little confusing to me. This is defined in an ActiveRecord class, which is clearly incorrect as there's no tables for it. It also is in a file with the wrong name.\nI think we should just remove the file, since it doesn't work and is unused.\nEDIT: Looks like our own @cbrunsdon already removed it from spree previously. We should cherry-pick that over spree/spree#5940\n. Seems reasonable to me :+1:\nIt looks like they have version 5.0 just around the corner too.\n. :+1:\n. This preference is defined in master, but not in 1.2 (the version your backtrace suggests you are using).  This view was only updated with this preference in master\n[1] pry(main)> Spree::Config[:can_restrict_stock_management]\n=> false\n[2] pry(main)>\n. :+1: and cherry picked back to v1.3\n. Removed changes to top-level readme\n. remove stub :arrow_right: specs still pass :arrow_right: :+1:\n. :+1: Thank you (especially for the specs)\n. Nice catch. Looks good to me :+1:\nFor testing this we would normally use a feature test. There is a select2_search helper that can be used for this. IMO that isn't necessary here for this to get merged (but would always be appreciated).\n. How about using sku_start? IMO that's the best compromise between wildcard on both ends and exact match.\n. Thanks @jrochkind\nI've created #1171 which adds some feature specs to test the fixed behaviour.\n. I think this is the only correct approach. Even if shipments were ordered by time, this spec shouldn't be dependant on that fact. (also ordering by time have this same problem in MySQL due to timestamp resolution)\n. :+1: Looks reasonable. Thank you.\n. Looks reasonable to me :+1:\n. :+1: :shipit: \n. :+1: Thanks Gray\n. Thank you Gray :tada: \n. Fixed by #2185. :+1: tried this out. More work is needed, but I think it's good enough to merge. We can then collaborate on making it better.\nFuture steps:\n- Validate entered currency (it's possible currently to make a price in an invalid currency, ex. \"XYZ\")\n- Grouping common prices (@Dkendal and @Mandily did some investigation of this)\n- We have the master price both on the main product page as well as the pricing page. This will probably be cause of some confusion.\n- Showing \"Master Variant\" in the pricing table feels like we're leaking an implementation detail\n. @tvdeyen done. We can use #1167 as a meta-issue to track these\n. Thanks as always Martin\n. Thanks @alepore and @cbrunsdon \n. Thank you\n. Seems reasonable to me :+1:\n. :+1:\nThis was broken by bundler/bundler#4244\n. Clarke gave this an IRL nod\n. :tada: :boom: \n. Thanks for updating. Now good by me :+1:\n. Actually, I'm taking martin's previous approval as a thumb :)\nThank you @jrochkind and sorry for the delay\n. :+1:\n. The jenkins job is too horrible to share in full (sorry alex), but the basics are that it clones down solidus master, runs a rake sandbox, and copies any changes over top of the sandbox-demo repo.\nThis is our first shot at this. I think we can do better. What I really want is to have a buildpack which is responsible for running rake sandbox and saving the result as a slug, but this is a bit tricky to do (the heroku buildpacks really want an existing app). I do still really want to do this, but this hack was the easiest way to get started. I'd like to merge this as is because having a demo is better than none.\nSomething we can work on with this current demo hack that will carry forward is the app.json file. Which we should be able to use to configure the admin's email and password.\n@alexblackie could we get some nicer text like @tvdeyen suggested.\n. Merged as #1173\n. There's definitely downsides to removing the shipments.address column. Though we don't have a builtin way to support it (yet?) we should be able to represent shipments being sent to multiple locations. It's a not uncommon feature of online stores (though obviously non-trivial).\nHowever, if editing the shipping address in the admin doesn't update the address we are shipping to, that is obviously broken. For that reason I'm in favour of removing the column (but disappointed we have to).\nI really like @alexstoick's suggestion of a rename. It would allow us to still represent the concept of multiple ship addresses, but fix the functionality easily right now. I'd suggest maybe something more descriptive than optional_address, maybe address_override.\n. :+1:\n. :+1:\n. The original reason this was added was related to rails/rails#12367, we'll have to see if that is still an issue in extensions.\n. @dholdren Thanks for your patience \nI tried this branch on a few extensions and couldn't spot any changes or issues w/r/t routing :shipit: . Hopefully whatever this code was working around was fixed at some point since rails 4.0.\n:+1: This is great. The backwards compatibility with deprecation warnings are especially appreciated.\n. :+1:\n. :+1:\n. :+1: Thank you.\nHaving the sample as well is very helpful\n. Looks good. Thanks again @kennyadsl \n. This was a typo in solidus_globalize which is now fixed.\n. Yep. They have been gone since spree 2.2! 0b64980df9138493c6e30c44ba962c6e76cb6840\nNice catch Brian :+1:\n. Rubocop (via houndci) needs def eligible?(order, options = {}) changed to def eligible?(order, _options = {})\nOther than that this is great. Thank you :+1:\n. Great! Thank you for updating this.\n. :+1:\n. I think in the future we want to improve our loading indicators even more (progress shown on submit buttons, more granular indication of what sections of the page are waiting), but that is a ways off and will need major JS changes.\nFor now, this is a huge improvement over the broken looking spinner we had at the top of the page.\nThank very much :+1:\n. :+1: Thank you.\nI looked into why the colours were off before and found:\n \nYuck! Ideally we wouldn't blindly be applying colours to all dl and header tags, but we currently do so this is a fine and necessary workaround.\nAlso want to note that we will need to make sure we don't lose this fix when implementing #763\n. These are no longer select2's but bootstrap-styled normal HTML selects. :tada:  I think this can be closed. :+1:\n. :heart: removing stubs\n. We've made progress, as can be seen in the linked merged issues.\nThere's always going to be more we can do to improve the UI here, and this issue no longer has actionable steps forward.\nMarking this done. Thanks everyone.. :+1:\n. :+1:\n. @CBarklem as far as I can tell the seeds create a default=true store, and the sample data creates another non-default store. Is it possible you missed running rake db:seed (it should be part of the normal spree:install command)?\n. There were indeed some issues with the \"default\" store in the database not being set as default=true. These should now be fixed in 1.3.0 by #1230 \n. @CBarklem I believe you're experiencing globalize/globalize#423. Could you try using the master version of globalize, where that should be fixed?\n. @CBarklem Could you try\ngem 'globalize', github: 'globalize/globalize'\n. Closing because I believe this is an issue in globalize itself (not solidus_globalize) which has been fixed in their master. If this isn't the case, please open a new issue against solidus_globalize.\n. Instead of an empty <div> at the end, it might be better to wrap the entire form in a div. This still allows for the same customisation using deface (and more) and makes more semantic sense.\nI'm not sure the test for the selector is providing any value.\n. :+1: Looks good. Sorry for the delay\n. Merged in #1373. Thank you\n. :+1: Thank you.\nIn a future change we should better document the Coordinator, the interface it is expected to provide and what it should do.\n. I'd love to do a follow up on this, needing to add this to all initializers is a bit weird, but it does seem to solve the problem, so :+1:\n. I like both @kennyadsl and @jrochkind's suggestions. I slightly prefer the class, as lambdas always feel ad-hoc and I don't think they're as good for composition or testing purposes.\nAnother option is taking the EmailDispatcher a step further and create a class to serve as the point of entry to sending emails. This also meets the \"tell don't ask\" design principle.\n``` ruby\nin spree/email_dispatcher\nmodule Spree\n  class EmailDispatcher\n    def initialize(mailer, mail)\n      @mailer, @mail = mailer, mail\n    end\ndef deliver(*args)\n  if Spree::Config[:send_core_emails]  # Matching old behaviour, could be extended\n    action_mailer.send(@mail, *args).deliver_later\n  end\nend\n\nprivate\n\ndef action_mailer\n  # This could also be a less-ugly case statement\n  # I wanted to avoid just passing the class or class name, as that might\n  # not be what a site with custom email behaviour wants to use.\n\n  \"Spree::#{@mailer.to_s.classify}Mailer\".constantize\nend\n\nend\nend\nUsage\nSpree::Config.email_dispatcher_class.new(:order, :confirm).deliver\nSpree::Config.email_dispatcher_class.new(:order, :cancel).deliver\n```\nThis would allow conditionally sending emails, as well as being flexible enough to allow basically any customisation of email delivery.\nI've wanted something like this for a while to better support services like sendwithus, or any other custom email behaviour.\nAs an example, to prevent sending some emails:\n``` ruby\nusing inheritance\nclass MyEmailDispatcher < Spree::EmailDispatcher\n  def deliver\n    return if [@mailer, @mail] == [:order, :cancel]\n    super\n  end\nend\n```\n``` ruby\nor using composition\nclass MyEmailDispatcher\n  def initialize(mailer, mail)\n    @mailer, @mail = mailer, mail\n  end\n  def deliver\n    return if [@mailer, @mail] == [:order, :cancel]\n    EmailDispatcher.new(@mailer, @mail).deliver\n  end\nend\n```\n. :+1: \n. :+1:\n. I wrote a spec and it seems to work for me\n``` ruby\ncontext 'with a soft-deleted payment method' do\n  let(:order) { create(:completed_order_with_totals, line_items_count: 1) }\n  let!(:payment_method) { create(:check_payment_method) }\n  let!(:payment) do\n    create(:payment,\n      order:          order,\n      amount:         order.outstanding_balance,\n      payment_method: payment_method\n    )\n  end\nbefore do\n    payment_method.destroy\n    visit spree.admin_order_payments_path(order.reload)\n  end\nit \"successfully lists the payments\" do\n    expect(page).to have_content(payment.number)\n  end\nend\n``\n. I did think it worked initially. I talked with Adam IRL to find out that it was in fact the \"show\" page which was having issues.\n. solidus_multi_domain includes some specifics about what multi-store behaviour means, but to some degree Stores have been natively supported since spree 2.3 (models in core,current_store` method, association to orders) https://github.com/solidusio/solidus/blob/master/core/app/models/spree/store.rb\n. Wanted to note that I had to revert this because the new test caused a spec failure :disappointed: \n. Wanted to note that I had to revert this because the new test caused a spec failure :disappointed: \n. @ridem Thanks for reporting (and testing on our master branch :smile: )\nI haven't been able to reproduce this. I'd expect acts_as_list to be required here, before the engine is loaded.\nCould you post your Gemfile and ruby version or anything else that might help us reproduce this?\n. Thanks. I can reproduce from that Gemfile\n. As far as I can tell adding react-rails is what triggers this failure. Still investigating to see what we can do to work around it.\n. This should be fixed by #1203 which is now in the v1.3 branch. We'll probably have another beta release shortly.\nThanks again for reporting the issue.\n. Can't do this because of deivid-rodriguez/pry-byebug#69. See #1005 \nI previously proposed #1016 as an alternative\n. Tests are failing because your branch is out of date (last commits from January), if you rebase it should fix the CI issue.\nIncluding just byebug (not pry-byebug) is what I proposed in #1016, and I'd still be happy to do that. I have reopened the issue.\n. @jrochkind I've merged  #1016 Could you file a new issue if you see any more problems\n. Closing in favour of #1448, which has now been merged.\nThanks for the contribution.. I'd like to see this requirement met as simply as possible.\nHow about just binding some JS to the checkbox to enable/disable the complete order button.\n. #1448 has been merged, which I believe accomplishes what is needed for this.\nBig thanks to @DanielePalombo . :+1: \n. :+1: Thank you\n. Change was payment.number vs payment.amount :disappointed_relieved: \n. @jordan-brough number isn't displayed on the final page at all. So it was less \"flaky\" and more \"entirely broken\" I didn't notice because CircleCI decided not to test pull requests authored by me, so it actually wasn't being tested.\nHound made it look like it passed\n\n. State 1 should probably also hide the \"New Stock Transfer\" button, since one can't be made without two stock locations.\n. Closing this due to inactivity. If you feel like picking this back up please open a new PR.\n. I can confirm that this is an issue, though it's a little different in 1.3/master and later because we now have a default country of \"US\".\nFeature test to reproduce:\n``` ruby\ncontext \"with a checkout_zone specified\" do\n  let!(:default_country) { create(:country, iso: 'AD', states_required: true) }\n  let!(:default_country_state) { create(:state, country: default_country) }\n  let!(:checkout_zone) { create(:zone, name: \"Checkout Zone\", countries: [country]) }\nit \"has a working state selector\" do\n    Spree::Country.update_all(states_required: true)\n    Spree::Config.default_country_iso = default_country.iso\n    Spree::Config.checkout_zone = checkout_zone.name\nvisit spree.new_admin_order_path\nclick_link \"Customer\"\n\n# Only displaying country from our checkout zone\nexpect(page).to have_select(\n  'Country',\n  selected: \"United States of America\",\n  options: [\"United States of America\"]\n)\n\n# It should use the states from the selected country, NOT the default\n# country\nexpect(page).to have_select(\n  'State',\n  options: [\"\"] + country.states.map(&:name)\n)\n\nend\nend\n```\n. Removes stubs, reduces a query, fixes a bug\nAwesome :+1:\n. :+1:\n. :+1: Thanks Brian\n. The issue is the partial index added here, which is treated as a full unique index on sqlite < 3.8\nhttps://github.com/solidusio/solidus/blob/master/core/db/migrate/20151219020209_add_stock_item_unique_index.rb\nWe can probably use ActiveRecord::Base.connection.supports_partial_index? to make this test instead\n. :+1:\n. :+1: Great. I want this on solidus 1.3 as well. Thank you for checking version compatibility.\n. :+1: Thank you\n. :+1: Thank you\n. :+1: I love the new state/country factories. This makes them even better.\n. I think the issue comes from it autosaving the shipment through the inventory units \nI made this change which seems to fix the issue https://github.com/jhawthorn/solidus/commit/61cf8f28e54e857a2f733826fa9f6c7c9b595cd1\nThis may have actually been broken further ago by 5ced785376a8e8d5e99b152b0c5db853a9ac48ee\n. @jordan-brough could you swap the order of these commits? This way all commits are passing.\nOther than that :+1:\nI'll backport this to 1.3 once it's merged\n. This is a very old migration (2.1 -> 2.2 I believe), but we might as well patch it now for anyone taking that upgrade path.\n:+1: migrations should be written in SQL as much as possible (I argued for this when this migration was originally changed in spree). Both because it's faster and because it avoids using whatever behaviours are in the model (which change over time).\n. :+1: Agree we should assume SemVer \n. :+1:\n. This looks good to me :+1:\nA few additional thoughts:\n- We should probably rename assure_store_on_orders to ensure_store_on_orders\n- Does ensuring there's a store_id belong in this rake task? It seems like it could be a migration.\n. Thanks Jordan :+1:\n. :+1: Thanks\n. :+1: Thanks again\n. This was an intentional change #425. We should remove that comment.\nIs it possible top change your before_save callback to not run the order updater?\n. I don't think this is an issue. Relying on duck typing and Address and Tax::TaxLocation quacking the same way is the best way to deal with this IMO.. I will submit a second PR for removing the rake task\n. :+1: In the future, if we do want to use create in a spec we should make sure to use create!\n. :+1: span inded makes more sense than h5 here, and looks better. Had a peek at CSS and didn't see any changes needed.\n. Thank you @jtapia\n. Spec failures looked unrelated. retrying.\n. @bbuchalter could you rebase and reopen this targeting master instead of 1.2?\n. :+1:\n. Thanks Brian\n. I believe so. I'm waiting on #1238 before merging this. Since that will fix the deprecation warnings this will introduce.\n. > Is this being removed from 1.3 then?\nI believe that validation should stay.\nI think this was clarified in slack. The 1.3 branch will be the 1.3.0 release. To make changes to it we make PRs against master and cherry-pick them back.\nSince there is already a release candidate out, the changes to that branch before release should be minimal.\n. Interesting issue. I make a spec to reproduce\nruby\ndescribe \"issue #1241\" do\n  let!(:user) { create(:user) }\n  let!(:address) { create(:address) }\n  it \"can update the ship_address on user\" do\n    expect(user.ship_address).to be_nil # This line is essential!\n    user.update!(ship_address: address)\n    expect(user.ship_address).to eq(address)\n  end\nend\nAs far as I can tell it only fails when user.ship_address is accessed before the update! and this does seem to be a change in 1.2 -> 1.3. I'll run a git bisect to see what it turns up.\n. My git rebase turned up 15c226e34c75f9efa1df34195840152d4ad21494, which makes sense. We now try to cache that relationship, where previously it would have run the SQL query each time. Maybe we can reset the relationship (or do something similar) when assigning to ship_address.\n. Looks like that's being entirely overridden here and here\n. Looks like that's being entirely overridden here and here\n. I think we both got confused here. The issue is with User#ship_address, not Order#ship_address\n. This should be fixed by #1242, which I'll backport to the 1.3 branch shortly\n. This should be fixed by #1246, which should be included in v1.3.0.rc2\n. :+1:\n. I've sent you a PR to address the TODO https://github.com/jordan-brough/solidus/pull/3\n. That's odd. This is failing because there is an adjustment missing an order_id. \nThis is strange because the start of this migration tries to ensure that all adjustments have an order_id set. Is it possible your database has some adjustments which were tied to a line_item, shipment, or order which no longer exists?\n. I'm not sure there's anything we can do about this.\nSpree's schema supported having multiple promotions with the same code, but it would not have functioned correctly. It would have applied an arbitrary promotion with a matching code.\nAt some point, for correctness and safety we needed to add this constraint, I wish we had been more explicit about it in the changelog.\nSorry for the delay in responding.\n. :+1: Should we cherry-pick these back onto 1.3?\n. @jordan-brough I think we've made huge progress here. What in your opinion is needed to close this.\nIt would be great if we had a example of what a very basic tax plugin would look like.\n. Considering this fixed by #1892 and similar work :tada: . :+1:\n. Fixed by #2002 :tada: . :+1: \n. :+1:\nIt looks like this has existed at least as far back as 1.48.0, our oldest supported version of AM.\n. A migration could be good, but I don't think that should block this PR.\n:+1:\n. Rebased and added a note to CHANGELOG\n. Thanks Gray. I'll add an extra spec in #1264 after rebasing :+1:\n. We have added a few, I don't think this issue is helpful to leave open without specific recommendations\n. :+1:\n. @sviechnikov We try very hard not to make such major changes to old versions. I know that the activemerchant bump was the source of some issues for our 1.3 adopters, and I don't want to surprise 1.2.x users with that on a future patch version upgrade.\nIf you need this, I recommend making your own fork and applying adde7d7d33e3a7d860887eafcc6d96420fca8d36 to the v1.2 branch.\n. @Kingdutch thank you. I've force pushed this to the rails5 branch.\nThe spec failures already existed, and the branch is still in a pretty broken state. Notably there's some weirdness going on with state machine (when it gets redefined specifically) that I haven't been able to diagnose yet.\n. Thanks for the feedback. We're continuing to improve our docs and new user experience. Some good work has already come from this (like Brian's addition of READMEs to the subprojects)\nClosing this due to lack of actionable steps.. Thank you. Other than Amanda's suggestions this looks great :+1:\n. Thanks @mtylty\n. > Are you sure it's unrealistic to support both rails 4 and 5?\nYep.\n\nI've worked on a Rails engine that supported Rails 3 and 4 with few or no (can't remember for sure if it was zero) Rails.version checks, just a few respond_to? checks like good ruby.\n\nThis is probably viable for small engines, but we just have too much app code.\nTwo examples of changes we need to make in order to support new rails 5 apps (with the new defaults) without having deprecations.\n- return false doesn't halt callbacks anymore. We need to throw abort\n- Every get/post in controller specs needs to be passed different arguments\n. With the 2.0.0.beta1 out and master running rails 5 I think it's time to close this.\n. Thanks so much Brian.\n. Another point I should mention is that stores with heavy custom caching (which is who I assume this is designed for) are likely to need more than just Rails.cache.clear. The existing specs hint at this. It would be simpler for these stores just to implement their own cache clear button than to try and hack into this existing one.\n. Rebased and added note to changelog\n. :+1: Looks good to me\n. Looks good to me. Thanks @dangerdogz\n. You can easily use the github version of just one gem in your Gemfile\nruby\ngem 'solidus_core', github: 'solidusio/solidus'\nIt's not uncommon to group multiple gems in the same repository. Rails does this, for example. There's many advantages to this approach: PRs can include changes anywhere, we're always testing all the projects on any change (important for changes to core/api), and it's easier organizationally. It's also important that we keep the entire git history of this project.\nI don't foresee us doing this.\n. :+1: \n. This should be fixed by #1514, which has been merged into master\n. :+1:\n. Other than two comments this is excellent. Thank you Kevin.\n. @bbuchalter Our Versioning Guidelines are in the wiki. Even though this changes some obviously broken behaviour it is too big of a change to go in a patch release. It will be a part of the upcoming 1.4.0 release.\n. :+1:\n. This was fixed by #1294. Thank you @isaacfreeman \n. :+1:\n. :+1: This is great.\nI'd love to eventually see the 3rd level (tab) menus built and configurable in a similar way, but that's definitely a task for a future PR.\n. This should be fixed!\nI can't thank @stewart enough for fixing the issues with bundler and updating the buildpack to rails 5.\n. Thanks @Kingdutch. Merged into rails 5 branch as e3cbbc4eda41faf805caa20e11e9e2eae2420d39\n. Yep! Merged as 8d4ba1e75558dd2f0007c7cd549ae70957219e25\nThank you again.\n. Done in a6163f20c3c44b022b775ae0ea76a7b9a042e2f0.\nEither behaviour is fine for how we're using it in migrations, so we might as well use the one which doesn't generate warnings.\n. Fixed by #1386\nThank you both\n. Thanks again. I pulled this down and it does indeed remove the inappropriate clear buttons. Much better.\nThis is another case (of many in our codebase) of @extend .fa wreaking havoc on the CSS.\n:+1:\n. Thanks @sanchojaf, but we only accepting PRs against master. Could you rebase this and create a new pull request against the master branch.\nIf you wouldn't mind a spec to demonstrate the issue would also be great.\n. Thanks isaacfreeman \nHere's a screenshot \nI like that this cleans up the page, but am unsure if this is better for usability. Variants often have similar SKU's (MY_PRODUCT_BLACK, MY_PRODUCT_BLUE) and it might be helpful to be able to see that at a glance. It's only marginally more difficult to see this, but it is still slightly more difficult.\nI don't have a strong opinion for or against this change. The code changes looks good.\n. Done in #1320\n. :+1:\n. Fixed by #1955 \nThanks!. :+1:\n. :+1: \n. :+1: Thank you\n. :+1:\nI don't love the special case extra parameter of ?simple=1, but I don't think we're ready for the generic solution of ?excludes=variants,option_types. Our next steps for the API are uncertain, so I do agree with the minimal interface provided here.\n. @gmacdougall I think this is good to go. Could you give it a rebase and merge it? It just has a small conflict with #1407\n. I've already set the environment variable on CircleCI, so it should still be raising. I think we'll want to turn this on for a few extensions as well (ex. solidus_auth_devise).\n. :+1: (pending typo fix)\n. This issue was filed first, but #1549 covers the same issue and now has more infromation.. :+1: Thank you\n. :+1: Can confirm that there's only an index on refund_reason_id (which provides little value) and not payment_id or reimbursement_id (which both make sense).\n. :+1: Thank you\n. This is ready to go :shipit: \n. > This does break API compatibility. Do we care?\nI suppose it does remove the preferred_eligible_values_without_numerification method, but I don't expect anyone to be using that so IMO this is fine.\n. I like the %x{ notation, but I actually agree with the hound warning. More people will be familiar with the backtick notation, so we should use that. Fixed.\n. :+1: I've added a spec in #1372 to test this\n. Thanks @jeremyw\n. Fixed by #1349\n. Duplicate of #1350\n. :+1: \n. I've created #2260 to track various issues with UnitCancel. :+1: LGTM\n. :+1: (pending whitespace fixes)\nThanks for the specs\n. :+1: \n. :+1: Thank you\n. Thanks @peterberkenbosch.\nIf it's okay I will just be cherry-picking the changes to API here.\nIn #1330 we deprecated the spree_* methods from testing_support/controller_requests. Graeme here at Stembolt is working on the big task of converting each of the backend and frontend spec requests to the new rails 5 syntax (sorry Graeme :disappointed_relieved: ).\n. Thanks again Peter.\nThis is included in #1342\n. Confirmed. Looks like it's realated to an OrderStockLocation record being created, which are used to configure packages specifically for one location.\n. This should be fixed by #1709, which bypasses the \"location configured package\" feature, which is what caused the separate shipments.. Thanks peter. I've merged this into #1342\n. @jordan-brough Sorry. This caused tests to fail on master so I had to revert it.\n66abad46ede137a9c352f38291ffc894157ab3bd\nhttps://circleci.com/gh/solidusio/solidus/4433\n. :+1: \nThis is a very old migration (spree 1.1 -> 1.2), but there is no reason not to fix it. It may help others upgrading.\nIt looks like the postgres/sqlite migration is also broken in the same way, which another PR could fix.\n. :+1:\n. From what I can see this removes just one query.\nSpree::State Load (1.2ms)  SELECT \"spree_states\".* FROM \"spree_states\" WHERE \"spree_states\".\"country_id\" IN (3, 6, 62, 11, 1, 8, 5, 9, 4, 10, 7, 14, 13, 12, 16, 32, 23, 19, 18, 36, 20, 37, 25, 27, 33) ORDER BY \"spree_states\".\"name\" ASC\nBut it does seem like that query is unnecessary, and we should remove it.\n:+1: Thank you\n. I'm a little concerned that Spree.ready is now going to fire at least twice on a page (more if turbolinks is being used). Users may have used it in a way such that that will cause issues.\n. Thanks @mtomov \n. Thanks Martin. I fixed your comments. Good catches\n. :+1: Thanks Brendan\n. :+1: Thank you\n. Thanks, but with the changes we've made to genericize our payment sources, our payment sources are not just credit cards.\nI'm not eager to add another way to create credit cards in the system. The fewer endpoints we have for this the better.. As a toggle, I fear this would just split our focus and efforts in half, not something we want for a feature as important as authentication.\nI'm interested in the idea of using JWT for all of our authentication, but it would have to be a much more complete conversion than this. It would be nice if JWT was used to describe both users and order tokens. A complete JWT implementation would need to duplicate our \"reset token on password change feature\" and resetting tokens in general, which is a little awkward for JWT since it loses its statelessness (one of the main features). \nI also like Clarke's suggestion of moving authentication to a pluggable class and creating an extension. This is probably the most achievable way to introduce JWT in the short term.\n. My main concern with this is that the after_destroy is currently necessary. I'm worried that when destroying the last adjustment on and item, an order.update! won't successfully update the item's total since it won't be included in all_adjustments.map(&:adjustable). The change to recalculate_adjustments should fix that, but we should probably make a failing test to be sure.\n. My main concern with this is that the after_destroy is currently necessary. I'm worried that when destroying the last adjustment on and item, an order.update! won't successfully update the item's total since it won't be included in all_adjustments.map(&:adjustable). The change to recalculate_adjustments should fix that, but we should probably make a failing test to be sure.\n. :shipit: \n. Works for me :+1: \n. :+1: \n. :+1: Looks good to me, nice extraction from auth_device\nCould you adjust the commit summary length to be <= 50 chars?\n. :+1: Looks good to me, nice extraction from auth_device\nCould you adjust the commit summary length to be <= 50 chars?\n. Excellent. Thank you.\n. :+1: \n. > To me as well. On the second line change you might as well add a question mark after eligible - select(&:eligible?) - to make it consistent\nGood catch. I made this change.\n. :+1: \n. Although the instructions are a little awkward right now, adding gem 'solidus' will still get you solidus 1.3, which runs rails 4.2. Maybe we want to merge this only after releasing 2.0\n. :tada: Thanks @peterberkenbosch \n. Finished in #1507 :tada: \n. :+1: \n. Other than the two spec changes this looks great. Thanks very much.\n. :+1: \n. Looks like a relic from Spree < 2.2 where shipments were charged as adjustments.\nGood catch :+1: \n. Does it make sense to do this in all environments? When is ActionMailer::Preview.all normally called by rails?\n. That code in rails looks a little unfortunate, but this seems like a reasonable fix.\nLet's do this only in dev.\n:+1: \n. :+1: it's time to do this.\nWe probably can also drop the order.reload added in #407, as I believe that was required due to rails 4.2's awkward behaviour for changed? when update_columns was being used.\n. lgtm :+1: \n. :+1:\nI could also see it making sense for the api not to use pagination when ids= is specified.\n. These changes look good and make sense to me :+1: \nHowever I'm a little confused about the existing behaviour of this class. eligible? checks the configured taxons and all descendants, actionable? only seems to check against the taxons themselves (not children)\n. Closing now that #1524 has been merged. I think this could be accomplished much simpler.\nInstead of max-width: $width-sidebar - (2 * $sidebar-margin); we can just use max-width: 100%. This achieves the desired effect in my testing.\nRather than giving the image an id and styling that, it's probably reasonable to just add the rule on .admin-nav img { max-width: 100%; }\nI agree that this change should need no specs.\n. :+1: \n. :+1: \n. This is tricky\nTraditionally stock locations aren't associated until the packaging step. This allows for some \"intelligent\" packaging and allows stock to be drawn from whichever stock location has inventory available. This is the most common path that any frontend store will do, and is probably what out backend should do most of the time.\nThis changed with the introduction of the OrderStockLocation (which was not a particularly complete implementation IMNSHO). An OrderStockLocation ties some amount of a variant to a particular stock location. When packaging, it builds these as separate shipments.\nWe run into issues because under different circumstances our banckend behaves differently w/r/t adding an OrderStockLocation. The cart page usually does, and the shipments page doesn't.\nI'm don't think adding an OrderStockLocation for the first stock location is the correct fix here, as it's possible that that location runs out of stock or could have other issues. I think we need to clarify to admin users when these records are being created, when they exist, and possibly stop creating them.\n. @DanielePalombo sorry for the delay.\nIn addition to being assigned to a specific stock location, the default is that the variant can come from any stock location. IMO whatever UI we come up with should favour this default, since most of the that's probably what an admin would want.. This should be fixed by #1709, which bypasses the \"location configured package\" feature, which is what caused the separate shipments. None of the regular solidus contributors run windows, so unfortunately it is unlikely to work flawlessly. As Peter suggests, issues are likely to be with paperclip. It doesn't make sense for us to spend time improving windows support since that won't be used for production servers, and it isn't particularly well supported by rails itself.\nGlad to hear everything works on ubuntu.\n. I think we need might want a dependent: restrict (or equivalent) to catch attempts to delete adjustment sources when it is not safe.\n. :+1: \nI'd guess that rails doesn't understand our Spree:: namespace well enough to add inverses automatically. Definitely needs further investigation.\n. Strangely this occurs with \"1\" but not \"4111111111111111\"\n. Created #1423 with a spec demonstrating this\n. I think this looks good, but there's a failing spec and it sounds like we're collectively not sure if it's necessary.\nI'm closing this, but if this comes up again please file a new PR as it does look like a good change. :smile: . :+1: \n. Trackers are a great fit for an extension. They integrate very loosely with the rest of solidus, and most users will be rolling their own analytics (especially as google is not the only name).\n. Still looking good to me.\n@mtomov could you please change the target of this PR to the master branch?\n. Thanks again @mtomov\n. The basic idea looks okay to me.\nThis would require that ALL payment sources support the with_payment_profile scope.\ncc @jordan-brough who has done some work making generic wallets, which might be more of a full-featured solution than this.\n. This was fixed in #2043. :+1: \n. Agree. Thanks jrochkind\n. :+1: Looks good to me.\nThank you @DanielePalombo\n. Thanks again. Closing in favour of meta-issue #2260. :+1: although I've never felt that amount was that clear either. Maybe we should introduce and encourage use of display_subtotal\n. Thanks Jordan\n. I don't think this has the intended behaviour if the country_iso is being changed.\nruby\nprice = Spree::Price.new\nprice.country_iso = 'de'\nprice.country_iso #=> \"de\"\nprice.country_iso = nil\nprice.country_iso #=> \"de\"\nI think the setter should be \nruby\nself[:country_iso] = country_iso.presence\n. Great! Thank you\n. :+1: \n. Duplicate of #1299\n. This should now be fixed.\n. I believe this is fixed by #2002. Thank you\n. Thank you @omnistegan \n. Test failure is unrelated (sorry). Would you mind rebasing against master to fix it?\n. Thanks everyone. I like us transitioning to the magic-scoped translation keys when we have a translation for a specific location. \n. Rebased and merged\n. We should absolutely do this in our test_app task.\nI may have broken this in bc8efcb5f66057e0a6e91abaf801528c556d28d0, but reverting that doesn't fix the issue. Rails 5's environment tracking seems to throw a wrench into the works also.\n. Thanks @Kingdutch, but as Gregor says we maintain our locale files in solidus-i18n. Help keeping the Dutch translations up to date would be greatly appreciated.\n. I suppose I'm fine with that too. I guess my ideal rule would be to allow either nil or a comment.\n. Good catch @acreilly. I've opened #1499 to address this.\n. > Probably deserves a changelog entry?\nI don't think so, we already require 2.2.2 by requiring rails 5.\n. > The remove class appears to only be used in promotions forms as is defined in nested-attributes.js.\nI investigated this and it actually isn't being used by promotion as far as I can tell. Though some promotion rules are using the remove class, the nested-attributes.js code runs only on page init and the promotion rules templates are only added after that.\nI will open up a follow-up PR to remove that file.\n. > Multiple activation types could mean we use checkboxes instead of radio buttons if we want to allow a user to make any combination of options. If we wanted to restrict them to certain combinations, it might be better to make that combination a new radio button option.\nThough we do allow combinations in the data-model (both a code and a path, for example), I think it's an uncommon use case that we might as well just hide in the UI for simplicity.\n\nTooltips: the new bootstrap layouts will allow for substantial helpful information to be added to the sidebar, so we might want to just make a note of what we'd like on the page for the time being and then add that information when we switch this page over to the bootstrap layout in the future.\n\nSounds good.\n. I have rewritten this to work after the changes in #1524.\nI've gone with a very simple solution for the \"edit\" action, and I'd like to make further improvements in a separate PR.\n\nWe didn't previously allow editing codes on existing promotions. The code field was marked readonly and the controller didn't support it. I've made this (hopefully) more clear by just printing the code as text.\nThis is ready for review. Though this works better for products with variants, it's now extremely confusing on products with only a master variant.\n\nMaybe we need to special-case that to only show the master variant prices and lose the heading/hint.\n. I don't understand the purpose of the Options table here.\nI think the option types relate only loosely to Prices (in that the options are what variants use, and variants have prices) and is going to be more confusing to users than helpful. New variants aren't created from this page.\nI think that table would make sense on the Variants page, but not here.\n. What was the issue in the order_factory? Can we test it in a spec?\n. @jordan-brough I rebased and removed the first commit, which was unnecessary as of #1479 :tada: \n. Merging this earlier than I normally would because it fixes the solidus_auth_devise spec failures against Solidus master\n. Thanks @gevann\n. Squashed and merged as fb5aa37a7e3ccae30cbb30ef372c102b413e4119. Thanks\n. I think we're agreed on moving forward with this in #1540 \n. cc @jordan-brough who has written a good summary of the state of Refunds, payment_total and outstanding balanace in #1254\n. Thanks Daniele. I think this is fixed #2002. If not please file a new issue or PR. :+1: I like it\n. This looks good to me :+1: \nI've created a separate issue #1548 to discuss removing jquery.validate in favour of plain HTML validations.\nOne thing that still doesn't autofill correctly is the state/province. Presumably because the dropdown is filled in via javascript. It would be great if that worked (but it may not be possible).\n. Thanks Martin. This is much more sensible.\nLooking forward to the follow-up removal of default_tax, which should simplify a little more and remove a query or two.\n. Other than the small nitpick this seems okay to me. We hide the link to \"New Variant\" when there are no option types, and the variants page provides a pretty good explanation.\n. For reference\nhttp://caniuse.com/#feat=form-validation\nhttps://bugs.webkit.org/show_bug.cgi?id=28649\n. Completed by #2264. I agree it would be better to lose the trailing slash.\ncanonical-rails adds this for index actions (I have no idea for what reason)\n. This is very cool, but I also don't think this belongs in Solidus core.\nAdding extra API calls to the checkout process is not something that can be taken lightly.\nThis would make an excellent extension\n. I make further changes in #1282, which I will rebase to include this\n. This seems like a good change, but this reopens the issue which caused this in the first place, spree/spree#6229.\nTo summarize:\n1. From a completed, paid, shipped order\n2. Create an RMA\n3. Create a Customer Return for that RMA.\n4. Create a reimbursement\nThis leaves an order in the \"balance due\" state, which is wrong. We are not expecting more money from the customer since they have returned their item. Something needs to reflect this before this can be merged.\n. > Easy enough to do, but I wouldn't know the proper namespace. Any suggestions?\nWe've started using the implicit leading . for translations we expect to only use once.\nSo t('.not_supported') would give us spree.admin.payments.source_forms.storecredit.not_supported (a bit long, but that's fine)\n. Thanks Brian\n. I think unfortunately these can't be overridden. Neither can any JS asset. This is a sprockets issue, and is outside our control.\nThis is made extra confusing because dev and production behave differently (due to sprocket's debug setting). Sometimes attempting to override a JS file will result in both the overridden and not overridden file being included.\n@cbrunsdon has looked into this more than me and might be able to clarify.\n. I'm personally pretty comfortable with any work being rolled back here in the case of an exception.\nThe OrderUpdater really shouldn't be raising exceptions. When it does, the most likely culprit would be issues communicating with a 3rd party tax extension, in which case it wouldn't make sense to store any data. In other cases something must have been invalid, and any stored data would likely be garbage.\n. One potential issue I've spotted is that this has changed the behaviour of an existing tax rate which had an amount and then later became0 (but otherwise still matched). Previously, it would have been removed after becoming 0. This code, in it's current state, will leave the adjustment, but update the amount to be 0. I'd like to change this so that it is consistent (it shouldn't have a \"memory\" of it's past tax rates).\nAnother (preexisting) issue is when order_tax_zone(order) has a zone but later becomes nil. adjust! will exit early, but it should probably remove all tax rates in that case. Addressed in #1575\n. Thanks for the pull request, but I'm afraid I agree with the others here.\nThis is probably best done by overriding spree/shared/_head.html.erb and replacing the <title> with title_string surrounded by the desired look. \n. This no longer applies and has become stale. Closing in favour of #1818. Fixed by #1587\n. I'm a little concerned that having two edit buttons will be confusing to users. @tvdeyen's suggestion would solve this.\n. > Could we also get rid of that ugly 10px dashed border and use a solid light gray background instead? (No offense @mtomov)\nI think (strangely) a dotted border is the universal symbol for \"upload area\". I do agree the wide dashed border doesn't fit particularly well here though.\nHow about a smaller dashed border? I also shrunk the area horizontally.\n\n. \nSplit text from button and added a large icon\n. While I don't like this attribute, and it makes especially little sense on Order, shouldn't we have some way of declining to save a credit card to a user's wallet?\n. Thank you\n. Thanks for the detailed report. It really does help.\nI can confirm that this happens in a sandbox. It seems that this is only exposed when using solidus_auth_devise (although I'd guess the problem exists in solidus proper).\nI'm running a bisect to try and figure out what caused this.\n. This should be fixed in the latest version of solidus_auth_devise, 1.6.2.\nThanks again @andreas-venturini\n. I spent some time poking at this, as far as I can tell this only affects the \"per-quantity\" CreateQuantityAdjustments. Is that correct (I've changed the PR title to reflect this)? I saw no issues with the more standard per-line-item adjustments.\nThe code inside that promotion action  looks like it wasn't updated to match the changes we made in 1.4, and it wasn't tested well enough to expose the issue.\n. @bbuchalter @kwstannard does #1595 fix the issues you were having with build.sh, if not could you please file a bug with whatever error you are seeing.\n. @mamhoff There's also a has_one :product, through: :variant, which is what makes this delegate unnecessary. It will have the same behaviour as though this delegate had allow_nil: true.. Yep. This is broken. See #583\nIn spree 2.4 the existing Stock::ContentItem was changed from a struct which requested a quantity of some variant to a wrapper around an unsaved inventory unit, which also locks it to a specific stock location. Because of this mistake, packaging across stock locations doesn't work.\nAt some point I'd love to fix this, but I'm afraid that it can only be done with a major breaking change to the Stock system (essentially reverting the 2.4 change).\n. Hi @bosskovic thanks for the PR.\nAs far as I know the user picker is working. There was previously a different issue which was fixed in #1349 and I added a spec in #1372 to ensure it is working. Do you have an example which fails without this PR?\nSpecifying a token here shouldn't be necessary because Spree.ajax does that for us.. @mbreedlove We tried removing the required field, but it introduced further wrong behaviour. It would take the empty string assigned to price= and consider that a new price of 0.\nI haven't run a store with this value set, what is the desired behaviour?. Good catch. Let's replace length: { minimum: 3 } with just presence: true, the same validation on name.\nWould you be interested in making a PR @fschwahn? :). I'm actually not certain this works (anymore? after a certain sprockets version?).\nWhen using require_tree, at least, JS assets aren't overridable (see #1567). @cbrunsdon would know more since he has run into this.. > There is this DeprecatedConstantProxy, although I doubt that anybody ever used this constant and it's safe to be used removed.\nDeprecatedConstantProxy is really cool, but only works if there is a replacement. We can manually define const_missing, which we have done elsewhere.\nWhat's best here is probably to use DeprecatedObjectProxy. Thank you. Thanks @fschwahn. I skipped our normal \"wait at least 24 hours to make sure everyone has a chance to review\". I think our documentation should have a lower barrier to merge (and if there's an issue it's much easier to change back).. Solidus is the name of an old Roman coin and is also the name for a forward slash :). There's now a striking similarity between PromotionHandler::FreeShipping and PromotionHandler::Cart. I think we should look into removing PromotionHandler::FreeShipping in favour of just using PromotionHandler::Cart, or at least sharing some code between the two.\nDefinitely out of scope for this PR, though :+1: . Thanks Jordan. I believe this is a duplicate of #1611. I believe this was fixed a while back by #1772. Please re-file if it is not :heart: .. @tvdeyen wrote:\n\nI always had the impression that summing in database is faster. Are the line items already in memory? And can we ensure that this is always the case?\n\nIt's much faster to sum in the database if the line_item association isn't already loaded. I changed this here because in the only place that .quantity is called, the OrderUpdater, we know that the line items are loaded (and are expected to be up to date).\nI've changed the pull request to just inline the in-memory summation as part of the order updater, since that seems like the more correct to do w/r/t compatibility just in case someone somewhere is using order#quantity and expecting it to be fast when line_items aren't loaded.\nIn a future PR, we should consider deprecating order#quantity in favour of order#item_count.. The \"Customer E-mail\" does indeed refer to the order's email. The wording could probably be more clear, but I don't think this is wrong, it is the customer's email as saved on the order.\nAs far as I can tell the sidebar does correctly show the user's email https://github.com/solidusio/solidus/blob/master/backend/app/views/spree/admin/shared/_order_summary.html.erb#L8\n\nIdeally, non-guest orders would always have null email addresses in the database, and order.email would return the user's email address.\n\nWe've preferred always setting an email on the order. I still think there's a lot of advantages to this approach (simple for querying, accessing, validating).. I've seen this before.\nI believe what's happening is that the different Accept headers for content type make the rendering slower. I would guess (but can't confirm) that this is due to template lookup with multiple formats.\nI can reproduce locally from a fresh sandbox, though my differences are far less pronounced:\ntime curl -I -H 'Accept: text/html' http://localhost:3000/ 0.128 seconds\ntime curl -I -H 'Accept: */*' http://localhost:3000/ 0.290 seconds\nThis seems to be the case in a standard rails app as well.\nClosing this since I don't think there's anything we can do in Solidus to improve this (rails issue afaict), and it doesn't affect production.. I agree with Gregor. As far as I can tell, this doesn't fix solidus_globalize, but moves the error elsewhere.. I'm going to tackle the last 3 files in separate PRs, since they will probably involve some (minor) behaviour changes.. Thank you. Thanks :+1: . @kennyadsl I agree. That seems to be how ::Money works already, so delegating to that will have the desired behaviour.\n```\n\n::Money.new(10) < ::Money.new(20)\n=> true\n::Money.new(10) > ::Money.new(20)\n=> false\n::Money.new(10, \"USD\") < ::Money.new(20, \"CAD\")\nArgumentError: comparison of Money with Money failed\n```\n\n@eoinkelly A PR would be most welcome. Hi @sechix \nThis was an issue earlier today with the coffee-script-source gem having a broken release. It should be fixed now.\nSee:\nhttps://github.com/rails/ruby-coffee-script/issues/11#issuecomment-267422413\nhttps://github.com/rails/ruby-coffee-script/issues/13\nhttps://github.com/jashkenas/coffeescript/issues/4403. Thank you. Thanks for the thoughtful write-up Brian.\nI think a lot of the complexity we'd run into re-implementing state machine as PORO would be in restricting the state transitions. We don't, for example, want to start processing failed payments. They've failed. Further actions should not be taken.\ndef started_processing!\n  raise \"Can't start_processing from state #{payment.state}\" unless ['checkout', 'pending', 'completed'].include?(payment.state)\n  payment.update!(state: 'processing')\nend\nThe backtrace and error message from this might be slightly better than the one from state_machines, but it's still fairly awkward. Looking at the line in the backtrace will show the states which are allowed, and I suppose that could be included in the error message too. I'm not sure that's a huge gain (it doesn't help you that a \"pending\" payment could start processing, you have a failed payment).\nI think we should also investigate continuing to use the state_machines gem, but defining the machine itself on a separate object.\n\nThe payment state machine in particular provides us almost no value in being a state machine.\n\nThat looks vaguely like a state machine, however the transitions between pending, completed, failed, void rarely happen directly and in real usage always go through the processing step (search payment/processing.rb for started_processing!).\nEliminating those (usually) unused edges,\n\nThis isn't useful. Nothing prevents us from completed to processing to pending :bomb:. Bizarrely, the state machine doesn't stop us from transitioning from processing to processing (though at least handle_payment_preconditions does).\nI believe the next step in improving the Payment states is to separate processing from the other states (it should exist alongside/as a modifier to the other states). Maybe that would make sense to do in a PaymentStateMachine object.\n\nSomething I'd really like to see some day is separating the Order state machine into its own (maybe PORO) object. When the Order state machine was first created, and wizard interfaces were in fashion, it was assumed that all orders would go through the same frontend checkout interface and all steps. This is no longer exclusively how Solidus orders are used. Sites may have one page checkouts, batch order creations, orders created as part of a return, subscriptions, etc. Implementing most of these involves fighting the state machine, either by replacing it entirely, or emulating advancing through the steps (while order.next, order.advance).\nSeparating the Order's state machine into a separate object would be the first step in allowing the checkout flow to be pluggable on a per-order basis.\nLikely, this will be complicated, especially with the current state of the Order state machine. I think we'll need to reduce the huge number of state machine callbacks before we can attempt this.\n\nTL;DR. I like it, but complicated.. Rebased and merged as #1716. Thanks @aamyot . @cbrunsdon @gmacdougall Can anything be done to move this forward? One of our promises with Solidus is to work well on large stores, which this change is necessary for.\nMaybe we should start by changing the less controversial searches, like number and shipment_number to _start. Merging this a few hours ahead of our normal 24-hour minimum. Sorry!. This should be what safe_remove_index already does\nruby\ndef safe_remove_index(table, column)\n  remove_index(table, column) if index_exists?(table, column)\nend. I'm reluctant to ever remove a calculator, since it is a huge pain to be missing a class referred to in the DB through rails' STI.\nIt would be nice if we displayed it to users in a better way. \"Price Sack\" is a terrible name. \nFurther complicating this is that the Shipping::, versions is broken and behaves differently to the promotion version :anguished: . As for better names: I've heard the term \"hurdle\" used for this type of promotion. In slack Sean Denny suggested \"price break\" (which I like). @Magnusvb going out on a limb, sorry if I'm wrong.\nIs it possible you've copied the _confirm.html.erb from Solidus master (which is 2.2.0.alpha) into your app running on an older version of Solidus? That method is brand new and doesn't exist in any Solidus gem releases. If you're copying views into your app, you will have to use the the version of the view matching the version you are using.. No worries @Magnusvb, you are hardly the first to run into this :wink: \nHopefully #1681 will make this less common to run into.. > I'd like a small comment indicating that it's okay to submit issues that are not a bug report, though. Things like: I'd like to have Solidus support a better returns system, and I'd want people's input as to what that means. That would be a valid issue IMO, but wouldn't fit this template.\nI'd like that too, but couldn't find a way to put it in the template non-awkwardly. As far as I can tell, there's no way to add a comment (like a code comment). Maybe I can add more details to CONTRIBUTING.md and link to that.. I figured it out. PRs didn't have the CircleCI config which caused them to fail on depredations. Fixed now in CircleCI config :roll_eyes: . > The thing I'm curious about is why methods like update_shipment_state and update_payment_state become public.\nThey were previously public. They're still a little too intertwined to be made private immediately.\nFor example, in Order#finalize! both are called with intermediate work being done in-between.. > This is really neat. However, I see some commits do not pass CI. :(\nI believe that was just the second to last commit which I've rebased and amended the last commit fixing the spec failure. I'm running a git rebase -x rspec locally to double check. This has passed specs... but CircleCI :roll_eyes: \nEDIT: rebased to rerun specs. Now showing as passing in github. Thank you @ericsaupe. @vfonic is there any way (with the standard Solidus code) to end up with the empty string (\"\") as a guest_token? In my testing there wasn't.\nUsing #present? here seems fine to me, just to be sure against something going horribly wrong.\nAlternatively (or in addition), we could add the following to the Order model\nvalidates :guest_token, presence: { allow_nil: true }. > Not sure why it was explicitly made look like it doesn't belong to the table.\nThis is the pattern used throughout the admin and is way outside the scope of this PR.\nIf you have thoughts on how the admin UI should be please file a new issue or come discuss it in our #gui slack channel. Can't run test on CircleCI because of AWS issues, but this is passing locally\n:shipit: :fire: . This didn't get fixed in time for 2.4, but I believe it will be for 2.5. @tvdeyen This is ready for review :)\nModels and views are now namespaced and in the models/ and views/ directories. I believe I have addressed the other feedback.\nTests have passed, but CircleCI is being CircleCI and hasn't updated github.. > Just for the record: We should start to think about how we organize the admin order templates and partials. Ideally we have a template for each order state (or better tab). Having an edit template for shipment state is somehow silly.\nThe names aren't ideal, but it's never made visible to the user. IMO it's not worth changing them due to the incompatibilities it will cause. Either way, outside the scope of this PR.. Fixed by #1720 and #1736. Thank you. While I would like to have only migrated files as they were touched (and better preserving history), I feel like changes to hash syntax (and requests for those changes) clutter up code reviews. I think this will be a very good change for us.\nThank you @brchristian . :-1: From me, I'm afraid\nI'd like to echo what @Mandily said. We need to identify exactly what problem we are trying to solve here and come up with the best solution for that problem.\nHaving the buttons inside the table looks worse to me. Maybe it's just familiarity with the existing look, but it seems really off.\nI believe this is a worse UX language than what we had previously. Having the button visually outside the row makes it clear that the edit button refers to the entire row (the entire order in this screenshot).. Thank you. I am still working on this but will open a new PR. I don't think this can be done, since in the current implementation a single Address could be used by multiple Users.. The code looks good, I don't think this should be done in this way.\nIf a customer is in the process of checking out an order, and an admin views their order in the admin, the customer will be given the option of selecting the backend-only rates.\nMaybe this could be done only for orders with frontend_viewable = false (only orders created in the admin)?. I don't really care for any of the rules in Metrics/*. They're certainly good goals, but I think humans are the best judges of such things.. > Thanks. I think we should add a CHANGELOG entry as we moved around files.\nDone. Can't run test on CircleCI because of AWS issues, but this is passing locally (and was passing before adding CHANGELOG and a rebase)\n:shipit: :fire: . It it possible to support both paperclips? I imagine some users will still have some random gems still requiring aws-sdk 1.x. It's good for us to be pessimistic about supporting future major versions. They'll bump these versions only when they have a major change, so it's best to double check each time there is a new one that we can still use it.\nWhat I'd like best here is:\ns.add_dependency 'paperclip', ['>= 4.2', '< 6']. Oops I had typod my suggestion (=> vs >=). Pushed up a fix (hope that's okay).. > @jhawthorn No prob! But it looks like something weird got into the changelog by accident. Let\u2019s just take that out before we merge.\nWhoops. Multitasking fail. Fixed. . I think the intention is to have lastname nil it because it is optional. We generally want to have factories create the absolute minimal object (though we don't always succeed in doing this).\nSince requiring a lastname is specific to your application, you might consider using FactoryGirl.modify. Fixed a second issue while investigating this. Previously, when the inventory count reached 0, it would call shipment.destroy, which would leave the shipment in the in-memory order.shipments association.\nThis could later cause an order.update! to fail, as it would attempt to update a destroyed shipment.. Fixed by #1755. Thanks so much @kennyadsl . @bofrede you may want to make sure your reverse proxy sends X-Forwarded-Proto, which rails should understand.. Thank you. I'll vendor select2 in a separate PR. I modified all_products to be a little cleaner using self_and_descendants.\nThanks for the change :+1: . @jordan-brough I think I have addressed your feedback. It no longer removes the spree_credit_cards.default column, which eliminates the need for the down migrations's behaviour. It now only uses the CreditCard and WalletPaymentSource defined in the migration.. I don't think this will be missed. It was introduced ages before we had our current stock editing interface, which can do the same task this does, but with much clearer UI.\nIf I'm mistaken, please reach out via GH issue or Slack.. I think @cbrunsdon's concern is with code that has been extracted into the solidus_expedited_exchanges gem, which moves a shipment from one order to another in order to charge for it (yech!). I think it will be fine, as that code uses shipment creation time vs order creation time (yech again!) to detect an exchange. In any case, this shouldn't be a blocker.\nOther than concern about additional queries \ud83d\udc4d from me.. :+1: Thank you. Hmm we seem to be running into https://github.com/twbs/bootstrap/issues/21607 so we may have to put off this upgrade. I tried setting enable-transitions: false, and it didn't help\nEDIT: setting animation: false when calling $.fn.tooltip() fixes this.. Closing for #1816. If we're tweaking font sizes, I think we should remove some strange font size rules. Otherwise we risk calibrating the base font size wrong because the elements we look at are at font-size: 90%\nFor example:\n fieldsets are set to 90%\n labels are set to 90%\nFixing these should make the fonts even larger at the same time, which I think aligns with your goals :smile: .. This is looking much better.\n@tvdeyen was there supposed to be a change to $body-font-size as well? Currently our legacy styles are using 13px and bootstrap is specifying 15px. Thank you. > I like this a lot. I'm assuming we'd use the same thing in the settings where you set the master currency for each store?\nThis probably only makes sense when entering an amount.. @tvdeyen to help differentiate between selectable and fixed currencies, I'm going to try make the background white when it is a select box. If we also go with the change I propose in #1797 \"Replace select2 styling\" it should match other select boxes and be even more obvious.. This is no longer WIP and is good to go.\nHere's how the selectable vs fixed currency looks now.\n. At @tvdeyen's suggestion I've swapped this to use bootstrap's custom select styling, which has the advantage of looking (more or less) identical across browsers and reduces the CSS we need to achieve this.\n. @tvdeyen Thanks. I have addressed your feedback.. Updated this to use the same dropdown arrow as bootstrap's custom-select styling.\n. This is out of WIP\nFor icons, I only brought back the \"close\" icon from font-awesome. The dropdown icon is provided by bootstrap, and I chose to forgo the search icon, which I don't think was useful.\nColours come from bootstrap variables, which will be slightly off until #1809 is merged.\n. @tvdeyen I agree with all your changes and cherry-picked your commit. I needed to make one change (001b702a3faa20f074823a19ebb836a331186209) to keep the close (clear) button for single-select in the right place.. This was a 2.1 regression, and I think we should backport it for a 2.1.1 release.. Good call @kennyadsl. We might want to add a sass linter to catch these.. @tvdeyen I've pulled in your changes other than changing the font size.. This is all expected behaviour, but the UI was really bad. Fields are indeed supposed to be readonly once created. The random string is because you've asked it to create 12 codes, so it invokes the code generator (codes need to be unique). If you want to specify the exact code, number of codes needs to be 1 (I know this isn't obvious). \nThis wasn't great, but I think it's greatly improved in #1509. At least what is being created is obvious, I think we can still do a better job of showing what codes have been created.. I like this. It would be even better if we could share the code to generate Order numbers, Shipment numbers, and Payment numbers. After more thought and some discussion, I think the best way forward is:\n\n<input type=\"text\"> with some JS to format and validate into the current locale.\nRemove LocalizedNumber, require assignments to be in period-as-decimal format\nAn <input type=\"hidden\"> which stores the actual value as a period-as-decimal number for submission to the server.. Thanks for filing an issue. Could you provide a full backtrace?. This is ready for review. Teaspoon is run on CircleCI and should even report errors correctly via junit XML.\n\nI've added some basic specs for some JS I'd written recently Views.NumberWithCurrency, formatMoney, and Spree.t. I think @jordan-brough wanted to note that this isn't an endorsement for removing the confirm step. Though it can be done, it can cause issues unless care is taken.\nRegardless can_complete? reads better than confirm?, and better expresses the intent of the calling code. :+1: . Thanks Eric and Taylor. Closing in favour of #2002, which includes the specs from this.. Thanks, but probably nothing we can do. This will be the fault of some native code and Solidus itself is pure ruby.. Bypassing our normal 24-hour wait for reviews so that this can be included in 2.2.0.beta1.. @mtomov Thanks! This was an easy change because the existing code was very good.. Thanks for the report. Looks like PromotionCodeBatchMailer was inheriting from ApplicationMailer, whereas all previous mailers inherited from Spree::BaseMailer.. This is fixed by #1854, which will be included in 2.2.0. > The only concern I have is about the removed data-hook. I want to see them be gone as well, but stores \"may\" depend on it. Changelog?\nAny store \"may\" depend on anything. One could target [class=\"\"] in deface and it would make just as much sense as targettu [data-hook]. I try to leave in the \"named\" data-hooks, because that is/was a popular pattern, but I have no idea why empty data-hooks are a thing.\nRegardless, I have added it back because there was no reason to remove it here (other than my desire to remove useless markup). > In Case 1:\n\nI should be able to change the value in the selectbox for countries\nIn Case 2:\nI should be able to change the value in the selectbox for countries\n\nThis is intended behaviour. A new price should be created for different countries\n\nNo country is selected. It always shows the first select-value \"any country\" even if its not the actual value.\n\nThis does seem to be a bug :bug: . Taking a look. Bug should be fixed by #2266. I can't reproduce this. In a Solidus 2.2 store with the following paperclip config everything works as expected.\n```\nconfig/initializers/paperclip.rb\nif ENV['AWS_ACCESS_KEY_ID']\n  Paperclip::Attachment.default_options.merge!(\n    :storage => :fog,\n    :fog_credentials => {\n      :provider => \"AWS\",\n      :aws_access_key_id => ENV['AWS_ACCESS_KEY_ID'],\n      :aws_secret_access_key => ENV['AWS_SECRET_ACCESS_KEY']\n    },\n    :fog_directory => ENV[\"S3_BUCKET_NAME\"]\n  )\nSpree::Image.attachment_definitions[:attachment].delete(:url)\n  Spree::Image.attachment_definitions[:attachment].delete(:path)\nend\n```\nif images records aren't being created at all there should be a rails error somewhere (or a JS error if it doesn't get that far). If they're being created, but on the filesystem, there is probably a configuration issue, are you sure the AWS_ACCESS_KEY_ID environment variable is being set?. I tried with that config and still can't reproduce. Images were uploaded to s3 just fine.\nI have to assume this is a configuration issue (either environment, s3 permissions, or something else) and not an issue with Solidus itself. This might be a good conversation for our #support channel on slack.\nI'm going to close this for now. Please @mention me if there are reproduction steps or an error's full stack trace and I will reopen.. Thanks for the report @shawno.\nThis was broken because our custom buildpack was trying to use the new rails 5.1 release, which we're not quite ready for. This should be fixed now.. I thought about this a bit and couldn't find a better way to organize it. I don't want to introduce a new class (since this will be serialized). I want this to be as deletable as possible, since it's just a workaround for a ruby 2.4 bug (which I still hope will be fixed in a patch release). Hi @gcmartins93 we do have a pluggable model for users for situations like this. However the api currently only accepts the spree_api_key column value, not the tokens from devise_token_auth.\nCould you report whatever errors you ran into to the solidus_auth_devise issue tracker. We do intend that it can be usable without the frontend or backend gems. Thanks :smile: . Thanks @sechix, taking a look now. Yep, this was a 2.2.0 regression. I believe this will be fixed by #1876. We should probably also add a validation to the image model, but that's an unwanted change for a patch release, so I'll send a separate PR for 2.3.0 later.. I was mistaken and this is not a 2.2.0 regression, and was only broken in master. Yay!. @tvdeyen not until #1895. > I am having issues integrating the solidus_globalize gem, issues that are related to the presence in solidus codebase of many dynamic finders such as find_by_permalink!, find_by_name! and so on, which as far as I know are/will be deprecated in rails.\nThese are not deprecated and there's no indication that they ever will be (quite the opposite). It is a misconception because some other dynamic finders were removed from rails (ages ago in rails 4.0).\nFrom activerecord-deprecated_finders README:\n\nNote that find(primary_key), find_by..., and find_by...! are not deprecated.\n\nSo it is a globalize bug (globalize/globalize#423) and it should be fixed there. I'm not totally comfortable with us making sweeping changes simply because another library is broken.. Makes no performance difference, we always have an Array here. any? would be the best choice anyways.. > I already approved this PR, so I don't insist on this change. Still thinking present? would be the \"more correct question to ask\", but it won't matter in this particular case. So,\n:+1: I can get behind this. I don't think the performance would ever be an issue, but there is a mental overhead for the reader debating if it matters that any of the elements could be falsey.. Thanks, but this should be done in solidus_globalize, since those keys aren't referenced here.. @tvdeyen I agree. We should either be testing that the right job is being enqueued with the right params, or test the result of the jobs using perform_enqueued_jobs. I'll take a look next week.. @tvdeyen updated to be a less significant change. Now has the same assertions as before.. Rails 5.1 support is still a work in progress. Closing for #1788. :shipit: . We're now ready for Rails 5.1. All deps we need have releases compatible with rails 5.1 :tada:\nI'll update this PR to also be compatible with rails 5.0. EDIT: Will add rails 5.0 compatibility back later instead (if possible). We are now using selenium + chrome headless for the backend :tada: :taco: . Just noting that previously refresh_rates was always called on completed orders 4ad32da96500ce56ea75aedeb4d3f868bf269eb5. That might make this a less-scary change, but it might also make this change not achieve what is desired (correct updating of rates when the amount changes).. I added a 2.2.1 changelog in the 2.2 branch. Do you mind cherry-picking that over instead?. Thank you. This needed some small updates due to a change in heroku, as well as needed to be updated to support Rails 5.1. Should be working again, I was able to deploy https://solidus-rails-51-test.herokuapp.com/. One of the few things preventing this is our use of ActiveMerchant::Billing::Response. We can probably introduce our own class, which quacks the same way (duplicate the interface it has with duck-typing). @gmacdougall wrote:\n\nThe attributes should be validated at the lower level\n\nI'm not sure, I think they should maybe be validated at this level via strong params, as they are in the API . > The documentation for Spree::LineItem says that #options= \"Sets options on the line item and updates the price. The options can be arbitrary attributes on the LineItem.\"\nThis is exactly the problem here. If we pass arbitrary user input to #options=, we allow users to set arbitrary options on line item.\nI'm closing this, but feel free to open a new PR if it sanitizes the user's input.. I don't think we should do this. I think that setting promotionable to false is intended to be a very hard \"do not under any circumstances allow promotions on this item\". Specifically, I think the use case is for cash-equivalent items (like gift cards), which we wouldn't want to allow promotions on just because there are other promotionable items in the cart.. Sorry, but I don't want this behaviour even if this is configurable.\nSetting promotionable=false should be a hard guarantee that no promotions will ever apply to this item.\nThe intended use case of promotionable=false is to allow selling items like gift cards safely. If a customer buys a $100 gift card and a $1 pen, they shouldn't be able to receive a \"$20 of orders over $100\" discount. This is an extremely important rule to enforce, and though this would be a configuration option, I'm just not comfortable making it possible for that to be misconfigured.\nExtension authors (ex. of a gift card extension) might want to have their extension create a promotionable=false item, and should have a guarantee that that works consistently in all stores.\nTo allow the behaviour this PR provides (promotions for some items in a cart), I believe it would be better to only allow it using item-level promotions.. When run with #1835, this errors with\ndiff\n-:outstanding_balance => 0,\n-:payment_state => \"paid\",\n-:payment_total => 100,\n-:refund_total => 10,\n-:total => 110,\n+:outstanding_balance => 10,\n+:payment_state => \"balance_due\",\n+:payment_total => 100,\n+:refund_total => 10,\n+:total => 110,\n. As the BatchBuilder can now take options, maybe we can store a desired separator value on PromotionCodeBatch and pass it in when running the BatchBuilder from PromotionCodeBatchJob. @cbrunsdon @mamhoff I think it would be best if this was on solidus-contrib, I would like to see the tests run on TravisCI. https://github.com/solidusio-contrib/solidus_responders\nWe've moved the repo to solidus-contrib and added a bold note at the top. Thank you!\nClosing in favour of #2263. I also would like to remove support for HTTP_SPREE_STORE gone. Since it requires extra configuration to use properly, it doesn't make sense to support it on all stores by default.\nI've opened #2041 which is related to this. It supports selecting a store by domain name and falling back to default with a single query :zap:.. This looks some type of bundler issue. I am able to bundle 1.3 locally.\nCan you try disabling your rubygems mirror?. We're going to backport and include this in 2.3.0. Since 2.3.0 includes the renames of the bogus payment method classes, it makes sense to include this and have them human readable (and also would avoid changing how they're displayed here in two separate consecutive releases).. Thank you. I'll try to cut a point release for 2.0 shortly. For some reason there's an unrelated issue on CircleCI preventing this from passing :thinking: but the build is passing locally. I will try to cut a 1.4 patch release shortly. I tried on iOS safari and was able to log out.. If you have instructions on how to reproduce please file a new issue. Thanks.. Fixed by #1997. There are some good suggestions here, but I think they're all outside the scope of fixing this immediate issue. Many extensions use <select class=\"select2\">, so we'll need that to continue working for the time-being.\nI'd love to see us move away from that, to bootstrap's custom-select or similar, but IMO this is a good fix to an immediate issue.. Thanks Isaac. I wonder if there's some repository we can find this information for all countries. We've been trying to avoid having any information about countries in Solidus itself because it tends to become out of date or incorrect.. Merging without our normal 24 hour review window so this might avoid spec failures in other PRs. Master now runs Rails 5.1, but we might need a better description of which versions support which versions of rails in the README. It would be nice to have a section describing what Solidus versions support which rails versions (4.2 for 1.x, 5.0 for 2.0-2.2, 5.1 for 2.3+), but since master is Rails 5.1, this is soon to be invalid. Thanks for the detailed report. It really helps :heart:.\nI made some progress reproducing this. I run MariaDB locally, which hasn't changed this default, but it can be enabled using SET sql_mode=\"ONLY_FULL_GROUP_BY\";.\nI think this might be an issue in a few places. Running rake spree_sample:load failed under this sql_mode. I believe #2025 should fix the original reported issue. I also needed the fix in #2024 in order to load sample data or checkout successfully.. > We should maybe also change the warning message. Often Spree.url is used only to get a URL, like in the example above. So, adding \"use Spree.routes to get URLs\" could help developers understand what is wrong.\nI don't think Spree.routes provides the functionality Spree.url has either. I think I will just drop the suggestion from the warning.. I think we've been moving more towards having the multi_domain behaviour included in core, just because of how frequent a need it is (and how invasive the changes are otherwise). But I appreciate how wasteful those three queries are on single-store apps.\nMaybe we want to include several store selectors side-by-side Spree::StoreSelector::Default/Spree::StoreSelector::ByDomain for users to select. WDYT?. @mamhoff I have re-added the scope and deprecated it instead.. Is there a popular gateway which supports multiple captures? Certainly they all support partial captures, but I don't know of any which support multiple captures (other than by making multiple charges against a stored credit card). custom-select has styling from bootstrap. It is somewhat heavy handed, so we probably don't want to @extend it onto every select element.. custom-select has styling from bootstrap. It is somewhat heavy handed, so we probably don't want to @extend it onto every select element.. This was not merged because in tests on older long lived stores there was a lot of broken data.\nI still think this should be merged and it should be the responsibility of users to fix up their data (or skip the foreign keys migration).\nI will not be able to get around to updating this.. > Maybe we could extract the previous behavior (mainly the header supporting one) into a second store finder class and still ship it with core, so existing stores can use the old one?\nAbsolutely! Do you think it's reasonable for us to use this as the new default? It should be an improvement for most stores.\n\nI didn't know multiple store urls could be set. If this feature is used can't we change the query using like (via by_url scope) and support multiline store urls?\n\nWe could do that, and if we implement a \"legacy\" store selector class as @tvdeyen suggests, that is what it should do. That said, I'd rather remove that behaviour for this new implementation.\nThe most glaring issue with the current implementation is that it will incorrectly match ca.example.com for example.com (even if there is a separate example.com store defined). We could change the LIKE query to assume that the stores are newline separated WHERE CONCAT('\\n', url, '\\n') LIKE '\\nexample.com\\n', but that's getting really hacky. If multiple store urls are something many of our users need, we should introduce a separate table for it store_urls.. I'd guess this was done for a much older version of rails (4.0 would have issued a warning). Due time we updated it :+1: . @gmacdougall Fixed by #2045 and another small change. Mind taking another look?. Merged and fixed as #2097. Thanks!. Merged as #2097. Thank you :tada: . This was replaced with the \"Stores\" page as part of #1282\nThe solidus-guides (a straight port of the old spree guides) aren't terrifically up to date, and a replacement is in the works.. This seemed to fix our CI failures. The deprecation warnings are errors on CI (although I'm not sure why this wasn't caught when the PR was run on CI). > Any data on test runtime changes using the in-memory postgres?\n@bbuchalter It is a bit faster, and more similar to the speeds we had on CircleCI 1 (making me think CIrcleCI probably did this previously). Are you able to view build timing in our CircleCI? https://circleci.com/gh/jhawthorn/solidus/1134#build-timing https://circleci.com/gh/jhawthorn/solidus/1120#build-timing. Rats. Here's timing without details.\nBefore\n\nAfter\n\nMostly notably this shaves about a minute off of the \"backend\" build in container 1. My guess is that this is because TRUNCATE is faster.. I don't think these elements should have the \"pointer\" cursor. I think the buttons which do have the pointer cursor are a mistake due to them being <a> tags (also a mistake IMO, but that's another discussion)\n\"Buttons shouldn\u2019t have a hand cursor\" by Adam Silver argues for this and has some reference to authorities saying the same: Microsoft, Apple, w3c.\ncc @Mandily who may have some thoughts on the matter. This should probably also be reported upstream to paperclip\nEDIT: Done in thoughtbot/paperclip#2462. We understand the problem here and desire to have a better way to hook into state changes. We'd like to find a better way for stores to hook into events like orders completing, payments being received, and shipments being shipped.\nUnfortunately the Shipment state machine isn't really a state machine. It's mostly a calculated state field. I'm not even sure the \"ready\" state should exist.\nClosing because this isn't mergeable or immediately actionable.. Thanks for the feedback everyone. This was a lot less contentious than I expected.\nMerging now. As the 2.3 branch has been forked, this will be in our future 2.4.0 release.. Good catch @mamhoff. Fixed. Agree with Martin, this was good and desirable other than the issue of users being able to bypass restrictions. We absolutely want to support admin-only shipping rates.\nI've tagged the issue for milestone 2.4.0, let's see if we can find a solution next release.. Merged as #2159. Should the search field label be on it's own line above the input? That's the pattern we've used elsewhere. This is a rebase of #2053, which is already approved.. I ran a git bisect and found this was introduced by #1770 (so not an issue in 2.3.0).\nThe issue seems to come from db/samples/reimbursements.rb\nruby\nreturn_item.exchange_variant = return_item.eligible_exchange_variants.last\nreturn_item.build_exchange_inventory_unit\nreturn_item.accept!\nbuild_exchange_inventory_unit builds a new inventory unit and a new shipment. When accept! is called that shipment is saved.. Aha! I think this is because \nin ReturnItem#build_exchange_inventory_unit\nsuper(\n  variant: exchange_variant,\n  line_item: inventory_unit.line_item,\n  order: inventory_unit.order\n)\nWe initialize an InventoryUnit with an order, which is now a has_many through: :shipment, so it will create an empty shipment (believing it to be a join model).. Closing this as #1770 has been reverted (for now). Thanks for the report.\nI believe this was failing because of missing solidusio/solidus_auth_devise#102, which wasn't in a release yet. I've just released a new version of solidus_auth_devise and this should be fixed.. > I successfully deployed Solidus on Heroku therefore I assume your supposition was correct.\n:smile: Great!. > Will this also affect extension's Configuration objects?\nIt will. One of the motivations for it.. I've actually just been ignoring the JS routes and instead just using Spree.pathFor.\nIt's a level of indirection that I'm not sure we get any benefit from. Unlike the rails routes, which are generated and we know will exist for all routes, I fear the backend routes are just extra maintenance work.. Before\n```\n$ rspec --profile=10 ./spec/features/admin/reports_spec.rb\nRandomized with seed 54973\n..\nTop 2 slowest examples (15.09 seconds, 99.5% of total time):\n  Reports visiting the admin reports page should have the right content\n    14.61 seconds ./spec/features/admin/reports_spec.rb:7\n  Reports searching the admin reports page should allow me to search for reports\n    0.48311 seconds ./spec/features/admin/reports_spec.rb:49\nFinished in 15.17 seconds (files took 2.36 seconds to load)\n2 examples, 0 failures\nRandomized with seed 54973\n```\nAfter\n```\n$ rspec --profile=10 ./spec/features/admin/reports_spec.rb --seed=54973\nRandomized with seed 54973\n..\nTop 2 slowest examples (0.89705 seconds, 5.9% of total time):\n  Reports searching the admin reports page should allow me to search for reports\n    0.57514 seconds ./spec/features/admin/reports_spec.rb:49\n  Reports visiting the admin reports page should have the right content\n    0.32191 seconds ./spec/features/admin/reports_spec.rb:7\nFinished in 15.27 seconds (files took 2.35 seconds to load)\n2 examples, 0 failures\nRandomized with seed 54973\n```\nTime for the suite hasn't changed (the ~14 seconds to load assets is just moved earlier), but the first specs run in a more similar time to the other specs in the suite and won't error waiting on assets to compile.. Should solidus_api also receive an explicit dependency as it calls kaminari functions?. I'm not sure why CircleCI refuses to build this, I have sent them a support request.. Thanks for the issue. I'd guess that the root cause is the same as #583. I believe this will be fixed by #2199. I've added the (greatly appreciated) spec here as ec7b241c1c0a7f38adf0aa5d993c0eb2137b204b.. Closing in favour of #2256 . > I don't know this topic very well but I'm curious why we didn't used the Rails class_attribute here. It should also have a default option now.\nThe purpose of this is to call constantize whenever accessed. Completed as #2147 :tada: . Merged as part of #2139. I wrote a commit to fix the spec failure here https://github.com/jhawthorn/solidus/commit/54c309beccc209a84bca65784c190f4b7f5bce20. Merged as part of #2139. I think this is caused by this line in AdjustmentSource#deals_with_adjustments_for_deleted_source. @adammathys does #1419 solve this issue for you?. :boat: . Is it possible to get a regression spec for this?. > When you see anything that looks like this: my_instance.() it calls the call method on that object, if its an object, or will invoke a proc if its a proc.\nYeah, JBuilder uses this (maybe too) cleverly as a shorthand for multiple attributes. I replaced a few spots where it didn't make sense to use this over explicitly declaring the attributes on separate lines.. > This all looks good to me, are the changes here 100% compatible (as far as you can tell) or is there something we should maybe be aware of that behaves differently?\nChanges should be 100% compatible.\nOne thing to watch out for is we no longer have RABL's implicit checking for records being nil, so we have to check explicitly for associations being nil. I've tried to do this but it's possible I've missed some that aren't exposed by our tests.. I did a hacky test with our spec suite to ensure that the responses were compatible. For each get/put/post/delete in our test suite I recorded the response (normalized by sorting the JSON keys, starting from the same seed) and compared the output JSON.\nI found one discrepancy (associations being null vs just skipping the key) which is fixed by the latest commit (81a5638).\nAfaik, this is good to go :shipit: . Great to see you here @radar :heart: :bowing_man: \nUnfortunately the latest release of bundler, as of writing 1.15.3, is still very broken. I'm guessing the fixes won't make it in until a 1.16 release.\n```\n$ bundle update\nFetching gem metadata from https://gems.stembolt.io/...........\nFetching version metadata from https://gems.stembolt.io/..\nFetching dependency metadata from https://gems.stembolt.io/.\nResolving dependencies............................................................(cut)\n...........................\nBundler could not find compatible versions for gem \"actionpack\":\n  In Gemfile:\n    solidus_core (= 2.2.0) was resolved to 2.2.0, which depends on\n      rails (~> 5.0.0) was resolved to 5.0.0, which depends on\n        actionpack (= 5.0.0)\nrspec-rails (~> 3.4) was resolved to 3.4.0, which depends on\n  railties (< 4.3, >= 3.0) was resolved to 4.2.8, which depends on\n    actionpack (= 4.2.8)\n\n$ bundler --version\nBundler version 1.15.3\n```\nOn 1.13.7 this bundles fine.. Scary warning is gone :tada: :no_entry_sign: :ghost: . Updated to include the merged #2133. This is included as part of #2147. Aligning the identical actions looks good (for the cases it makes sense), but I suspect we'd have to do it with some sort of placeholder element. This PR won't help or hurt our ability to do that in the future.. I think the confusion here is because Spree::Zone.for_address returns a set of matching zones, unlike match which only ever returned a single zone (which is incorrect for a lot of cases). There's no exact direct replacement of match because it's behaviour is wrong.\nThese changes were made as part of the major tax refactor which went into Solidus 1.3 https://github.com/solidusio/solidus/issues/989. Spec failure here can't be related. @swcraig is working on the solidus_legacy_stock_system gem. I think this can be merged before that's 100% finished.. > Is there any reason Solidus needs a database connection during asset compilation?\nThis is the result of some technical debt, specifically Spree traditionally stored configuration in the database, including configuration needed at load time. We've slowly been phasing this out and in the upcoming Solidus 2.4.0 the default will finally be changed to not use the database including for extensions (#2112).\nIn the mean time, you could try adding an initializer to use the (preferred) non-DB preferences:\n``` ruby\nconfig/initializers/solidus_auth_devise.rb\nSpree::Auth.config do |config|\n  config.use_static_preferences!\nend\n``. These queries are also duplicated across multiple shipments. This has been much improved by #2219. I'm in favour of this behaviour, but a little concerned about performance. What queries are going to be added by validations?. The order index allows searching by variant? Maybe a shortcut to that from the product page would be more appropriate than its own page.. Thanks. Prior to 86d0e62, core tested thatLegacyUser` had that restriction. At least now we're consistent.\nThe soft-deletion of user in solidus_auth_devise is really half-baked. Nowhere in either codebase do we do a User.with_deleted or similar, so all associations tied to the user will look like they have no associated user (not good!). We also have no ability in the admin to see the user. Deleting the user also scrambles the email, which is probably not a good idea for auditing.\nFor these reasons, I think we should remove acts_as_paranoid from solidus_auth_devise's user model and replace it with what is described in the devise wiki.. I believe I've addressed the suggestions here.\nThe last 4 commits here are poorly named and will be squashed into earlier commits, but I have kept them separate to ease reviews.. My feeling from working on #1821 is that number inputs are terrible for decimal inputs. Having the input step by 1 isn't desirable for, say, entering a tax rate. The bad browser behaviour w/r/t locale only makes this all worse.\nI'd rather continue using input type=text, even if it's semantically less correct.. My initial feeling towards this is :-1:\nI don't see any benefit to making these changes. Furthermore I expect this will be confusing to users as it is already confusing to me.\nEven after all these changes, solidus_core still depends on rails. Making the split pretty ineffective. solidus_core is always going to depend on activerecord, so it seems like a better first step would be reducing the requirements of solidus_core. Since solidus_core will never be without activerecord it might as well continue being an engine. If this is just for spec speed purposes we can just avoid requiring the engine if that's the goal here; there's no need for the complexity of an extra gem.\nAs for the controller_helpers, it would be simpler for everyone to keep them in solidus_core, but simply not require them by default. I think that would be a good change.. @tvdeyen \n\nMaybe for easier customisation we should add a\ncan? :reveal_api_key, @user\npermission?\n\nBecause our default \"admin\" role is assigned SuperUser permissions they will be able to view all api_keys, a bigger change than I intended. Are we okay with that?. > Revealing should only be possible for the owner. But I\u2019m fine with Super Admins being able to reset the key. WDYT?\nWith the SuperUser permission, that isn't possible. We give the \"admin\" role the :manage permission, which allows all actions. https://github.com/solidusio/solidus/blob/master/core/lib/spree/permission_sets/super_user.rb#L5. Will re-create. This was attempted in #1918, #721, but isn't viable due to security concerns. Please feel free to file a PR if it addresses these concerns.. Modifications made from #1963:\n\nStock transfer table should be shown if there are >= 2 stock locations. Not just > 0\nFilters/search should always be shown, regardless of number of stock transfers\nUpdated to use new pill component. We're working on having good and modern documentation for Solidus, unfortunately the old Spree docs aren't good or accurate (for either project).\n\nInstead of including individual modules which Solidus would require for correct functioning, there is a single module, Spree::UserMethods which a user model is expected to include.. Code seems fine, but I'm not a fan of having a sticky header. I don't think users benefit from having the information in the header visible at all times. That information is less important than that on the rest of the page, and it eats quite a bit of screen real estate.\nI also see some z-index issues.. > Besides the aforementioned date picker I did not found any more z-index issues. Could you please mention them, so I can investigate?\nPrice inputs appear above the header.\n. > Do we also need to remove the database table?\n:+1: I've removed the migration creating the table. (I don't think we should make a migration to remove it if it already exists). ok. > At the very least I think we'll need to add activesupport, activejob, and railties, which are the three I know we depend on inside of core.\nWe do get these from other gems, but it would make sense to add them to our deps. Found in solidus_editor. > this fix seems like it will remove the association between spree_log_entries and payments, which will surely make debugging harder, no?\nThis is not being changed here.. I've addressed most of the feedback.\n\nBuilds successfully for individual tests suites, but fails from root\n\nThis should be fixed. We were incorrectly running specs using the top-level Gemfile instead of the individual project Gemfiles. It now runs bundle exec from a clean environment under each project.\n\nThe warning about missing migrations seems to be wrong and we should find a way to avoid it\n\nThis is because Spree::Migrations is detecting the old dummy_app migrations (it assumes the migrations paths instead of checking the app's config.paths as it should). rm -Rf spec/dummy or rake clean at the top-level will fix it. We could detect if we're running inside DummyApp from Spree::Migrations, but I'm not sure that's worth doing.\nI was able to re-add the application/layout, but can't find a reasonable alternative to render_404.. We can probably just remove these IMO, since they're private methods on a backend controller it's unlikely that anyone would be relying on them.. Thank you!. Hi @loicginoux, discussions are better for our #solidus slack channel.\nThis is a very good question and an area we are looking to improve. It is too hard for developers to add logic to trigger at the right time. However I believe this is deceptively difficult to do in a good way.\nI think we haven't added these already because adding hooks/callbacks has been a pretty brittle and unsuccessful way to add extensibility. (I'd actually really like to remove the orders' update_hooks, which are very problematic because of how often they run)\nThe main problem is anticipating what a user expects to be able to do within any of these hooks and ensuring the surrounding code behaves correctly. Let's take your first example, register_on_add_product_to_cart_hook. What should a user be able to do here?\nSay a hook modifies the line item's price in some way, that would mean we'd have to run order.recalculate after the hooks to ensure the order took the price into account. Another hook might want to log the new state of the order somewhere, and that would have to happen after an order.recalculate. This isn't even really solved by splitting into before_/after_ hooks, as you can't modify a line_item before it exists.\nThis is why we've preferred to introduce extension points with a specific function, which return data Solidus acts on instead of modifying data, like the pluggable PriceSelector class.\nIt's possible we could introduce these with a warning that developers shouldn't modify any of Solidus's records during a hook (but I would guess this is one of the main desires of these hooks).\n\nFor example and as a side note, in our case, it wasn't that easy to find how to trigger an action exactely once when it is completed and fully paid.\n\nI think this is desirable for a lot of stores, and it would be nice to have something better, but there are caveats. This might happen several times to the same order. Consider a customer calling in and asking for an item to be added to their order: the order will have started complete and fully paid, leave that state as a new item is added, and then re-enter it again as the new total is paid for. Refunding a user for any reason also raises questions about whether this should be called.\nThere aren't easy solutions, but this is a discussion I and I'm sure other would be happy to continue in slack.. This is worth asking in Slack.\nThere's certainly no harm in more extension :smile: . Closing for now. Expecting a patch to rspec-rails soon. > In the PR title and commit message you talk about JSON.generate while in the code you use JSON.dump (which uses JSON.generate internally). This can be confusing. Maybe update the commit message?\nUpdated.\n\nThere is also JSON.fast_generate. Did you tried that as well?\n\nI just tried fast_generate and saw no difference in performance\nJSON.generate(I18n.t())\n                          1.047k (\u00b1 1.0%) i/s -      5.304k in   5.065674s\nJSON.fast_generate(I18n.t())\n                          1.047k (\u00b1 1.1%) i/s -      5.304k in   5.064887s. rebased and removed (now unnecessary) last commit. Unscientific test (time for backend specs on circle between two runs):\nBefore: Finished in 9 minutes 46 seconds (but I think this run was particularly slow)\nAfter: Finished in 7 minutes 42 seconds\nLocally I get a huge speedup (about 2x) I'm guessing that it's less pronounced on CI because it stores the DB in RAM.. I've been trying to diagnose the CI error. It's repeatable with the same seed, but weird. Some concurrency error when loading classes. I have to assume it's caused by this change.. Aha! We were having a deadlock related to us using the :async ActiveJob runner (which we really shouldn't use in tests). This should be fixed.\nI'll re-run backend specs a dozen times locally to double check.\nEDIT: all passed!. I started running into a different spurious error in promotion_adjustments_spec locally. I'm going to spend more time investigating that issue before merging.. > I started running into a different spurious error in promotion_adjustments_spec locally. I'm going to spend more time investigating that issue before merging.\nFixed by improving the spec. I'll merge once CI passes and I run specs a few more times locally. I think this was an issue that could have happened otherwise but was made more frequent when using transactional tests.\nEDIT: All :ok_hand: . Thanks for the PR, but it unfortunately doesn't meet our contribution guidelines.\nWe need a description of why this change should be made before we can review it, and tests need to pass before we can merge. Please see CONTRIBUTING.md. Thanks for the PR, but it unfortunately doesn't meet our contribution guidelines.\nWe need a description of why this change should be made before we can review it, and tests need to pass before we can merge. Please see CONTRIBUTING.md. I'd be happy as long as we can ship an image provider to new users relatively seamlessly.\nIf we can get this so we just change our README to recommend\ngem 'solidus'\ngem 'solidus_auth_devise'\ngem 'solidus_paperclip'\nas the starting Gemfile and provide the same experience we have now, that would be :+1: . We also need to consider how to cleanly extract paperclip from Taxon, which has an icon (although I'm not sure it's used anywhere).\nIt's probably worth asking in slack to see how widely this is used.. We had a similar problem with tooltips. I solved it by polling to check that the tooltip still exists. It's pretty hacky but we might consider implementing something similar for this.\nhttps://github.com/solidusio/solidus/blob/master/backend/app/assets/javascripts/spree/backend/components/tooltips.js#L6-L24\nThe comment saying \"This may be unnecessary in a future version of bootstrap\" is no longer true, and they now consider the problem a WONTFIX (which is fair, given how hacky our solution is) :disappointed: . > I like the explicitness of this, although I think the name of your methods should be paranoid_*. Makes it more readable. Will comment on the paranoia PR as well.\nI agree it sounds better and I definitely thought about it when changing adding these aliases, but the gem's name is paranoia and all the other methods in the gem are prefixed paranoia_ (paranoia_destroyed?, paranoia_scope, paranoia_column) so I think I will keep with that naming.. Frontend passed 10 times locally :crossed_fingers: :shipit: . Closing in favour of #2407. I'd prefer this was fixed in deface. There's nothing wrong with our ERB here, deface just doesn't parse it correctly.\nIt seems like these regexes https://github.com/DefaceCommunity/deface/blob/master/lib/deface/parser.rb#L14-L16\nare incorrect\nThey might need to be\n/([\\w-]+)(\\s?=\\s?)(\")(([^\"]*<%.*?%>)+[^\"]*)/m,\n/([\\w-]+)(\\s?=\\s?)(')(([^']*<%.*?%>)+[^']*)'/m,\n/([\\w-]+)(\\s?=\\s?)()(<%.*?%>)(?:\\s|>|\\z)/m. > Might break an extension, but thats their problem.\nExtensions use things from lib/spree/testing_support. There's no easy way for outside apps or extensions to require this so I think we are safe.. > Should we actually run these tests on CircleCI?\nWe do run rake teaspoon on CI, which runs the tests inside phantomjs (I wonder if we can change this to headless chrome). rake teaspoon:server just starts a server and requires the user to point the browser at it.\nEDIT: no good way yet to run chrome headless with teaspoon. Waiting on an open PR there.. We're looking to remove jquery.validate in #2264, so this may be unnecessary. Thanks for the PR.\nI've merged #2264, so I think this is now unnecessary. es-MX or any other locale should now work just fine on the frontend by relying on browser validation :tada:.. Fixed by #2470. As far as I can tell current_path does wait for the path to chage.\nDo you have an example build on CI where this has failed?. Hmm. I can get that failure locally. It looks like the payment isn't succeeding.\n\nWhen I take the screenshot before submitting the button it looks like the credit card hasn't been entered correctly.\n\nSo I think this is the same issue as #2386, but with the CC field, not the expiry.\nEDIT: I've opened #2404 to do the same fix to CCs we did for expirations in #2386.. That was a nice idea @luukveenis, but we can't use a number_field here, unfortunately. See my comment here. Thank you. I like a lot of where this is going.\nMy big concern is still: at what time and in what context do the event callbacks run?\nThe current implementation has a lot of behaviour implied:\n Callbacks might run inside a transaction from the \"publishing\" code\n  * An exception in the callback will roll back the transaction :bomb:\n  * The transaction might rolled back after the callback is run (either by a later callback or by containing code) :bomb:\n An exception in a callback prevents all further callbacks\n Callbacks are (maybe?) run within a request\n  * I18n.locale will be set correctly for the user :+1:\n  * An exception in the callback will cause the request to return an error respones (500, 404, etc. Depending on exception)\n The callback is passed a live AR object\n  * there may be unsaved changes from the \"publishing\" code (we could be careful to avoid this)\n  * unsaved attribute changes from the callback may be saved by the containing code :bomb:\n    * or a subsequent callback :bomb: \n  * There may be stale associations (we've worked hard to fix associations becoming stale, but it can probably still happen, especially in areas involving inventory_units)\nSince we are currently only using this for emails, these aren't issues, thanks to ActiveJob, but as soon as we intend these extensions to be used by users or extensions, some behaviours here are going to cause problems and others are going to be relied upon.\nI don't know the best solution, but I think we should consider running all callbacks through ActiveJob, which solves most of these problems.. Thanks for the report and PR. I think the change we made to the searcher was not the right thing to do and I have proposed reverting it in #2455. Closing in favour of #2455. Thanks. Thank you for catching this. I really :heart: the git check for any other migrations which shouldn't have been rolled up. We should probably release a version 2.4.2 with this fix.\nMy only concern is users who have already installed 2.4 and the previous bad rollup migration. We might need to just check that the spree_wallet_payment_sources table doesn't already exist.. Thanks very much. I will work on getting 2.4.2 out with this as soon as possible.. Let's merge #2442 first, then I will rebase this. We should probably merge #2447 first as well, so that rake will include the backend JS specs. Let's merge #2442 first, and then I will rebase this. Thanks. Nice catch.\n\nMy fix was only merged into Rails master and Rails v5.2 is already in beta so I imagine it'll be a good while before that trickles back to Solidus\n\nI think rails master is still tracking 5.2, so it shouldn't be too long.\nAlternatively, we could use Spree::Deprecation.warn explicitly within the private method, which avoids the slight strangeness of instance_method(...).owner.send(:private, ...). I am :+1: with any of the 3 approaches.. The best way to handle this would probably be to decide a maximum resolution of available_on (say, 5 minutes) and round times and cache based on that.\nI will not get around to this.. @loicginoux that looks good to me, would you mind sending a PR. What do you think @jordan-brough ?. Unfortunately most things with inventory_units end up with us having different copies of the same record in memory.\nIf we want to remove this, we should instead move the deprecation onto cartons, and then remove it in the next major version. The previous deprecation only warns users that we (in solidus_core) are doing something deprecated, not that they are.. This seems to be failing because money isn't loaded yet when app_configuration is. Thank you!. > Why not use angular or react for the backend instead? A collection of jquery code has made it kind of hard to add more js features to the backend, at least for me. I ended up putting angular in the solidus backend.\nI've tried to avoid including any of the heavier frameworks, because regardless of their pros/cons the opinions of them are very polarized between developers (angular especially so). They also would require more (and more specialized) knowledge for any developers to be able to contribute to the admin.\nI'd love to give react a more serious consideration. As far as I can tell it is the clear winner of the \"framework war\". I also personally have enjoyed using it. But I fear its inclusion would require extra work from developers to get react-rails (or similar) behaving correctly in their stores.\nIn any case, including a heavier framework doesn't remove the need for these components. We would still need them and additional libs to make them play nicely.. This is done and will be shipping with Solidus 2.5. This was changed in Solidus 2.3 for more clear naming (See #2000). There should be no difference other than naming. This looks great to me :+1:\nI hope you don't mind I've taken it to #2477 with a few small changes:\n Rebased (Fixing the build)\n Added localization\n Fixed CRLF line endings\n Removed unused flatpickr files. Thank you! Merged as #2477 . Thank you! Merged as #2477 . We've merged #2598\nIt would be nice to provide this migration to older stores (maybe as a gist or installed by rake task), but it no longer makes sense in this form.. Thank you. You'll need to sign up first. Unfortunately slack isn't particularly well suited for open source projects, so this is needed.. I wasn't able to reproduce this, maybe I missed something.\nI added a spec to the orders_controller (which renders the same partials and is easier to test), and it rendered without error.\nhttps://github.com/jhawthorn/solidus/commit/5ae69a79cb4b4bad4756f9a6e0a06914d74eb99f. Yep! oj seems to be the culprit. I don't know why this originally failed CI. Passing and merged as #2576. Thanks!. A compromise required to make this work: the slug field needs to be disabled when creating a new product in order to keep the behaviour we had previously (slug generated on create, slug required when updating).\nI think this is a reasonable solution and we can address it later if there is a preferred UX design.. > LGTM but i'd guess that in_stock? and potentially is_backorderable? also doesn't need to be serialized when we're not tracking inventory. Just a thought!\nI've spent some time thinking about this. You're right that it's confusing to have values that should basically be ignored when track_inventory is off. I think in stock should probably keep in_stock even if we were to hide backorderable, as we do in most places consider track_inventory=false to imply in_stock.\nRelated to this is #2522, where we are considering adding another attribute/scope to represent (in_stock || backorderable || !track_inventory).\nFor now, at least, I think we should keep all of these fields in for compatibility.. One option is to introduce a new method like Order#shipments_required?, and use that to determine whether or not we should be building shipments. I don't like this because I don't think it would ever be well tested.\nAnother option is to always require shipments. I'm hesitant to do this because people clearly rely on the existing behaviour (building a store which doesn't ship). On the other hand, it's hard to properly test something like this. I would have the most confidence we would do this correctly.. It is! We had a security release last month to address this (Solidus 2.3.1).\nPlease see https://groups.google.com/forum/#!topic/solidus-security/oU2K7WJ5H5E\nFor future security issues (or if you discover a flaw in this patch) please contact us privately :speak_no_evil:. Thank you. Pushed again updating flatpickr to latest version (v4.2.3). Pushed again updating flatpickr to latest version (v4.2.3). > Select2 also has autocomplete functionality.\nI don't think select2 can do what we need here. We want to have autocomplete (selection from a list), but we also want to be able to type a value not in our autocomplete list. select2 allows selecting a single value from a list (it's default behaviour), and it allows taking arbitrary typed input when it's taking multiple values as token input, but I don't think it can accept a single arbitrary value with suggestions (I could be wrong though).. I can't reproduce this. It is working here. Can you provide more details?\n. Can confirm this issue. The problem is that most of our admin variant selectors use in_stock_only: true. Our terminology in the API and core is that in_stock means essentially count_on_hand  > 0 || !track_inventory?.\nWe should introduce a new scope to mean any variant which we could put in an order: count_on_hand  > 0 || backordered? || !track_inventory?.\nI have no idea what to call this scope. Any suggestions?\ncan_supply? is probably the nearest match. So maybe something named similarly to that?. I believe this is fixed by #2536. Now ready to go :shipit: . I've spotted an InvalidAuthenticityToken issue with this on some pages.. > I've spotted an InvalidAuthenticityToken issue with this on some pages.\nUser error (mine)! Everything's good I had customized something else in my sandbox which was breaking this.. tahnk you.. Should be fixed by #2589 :tada:. After\navailable_countries    223.391  (\u00b1 4.5%) i/s -      1.116k in   5.006031s\nBefore\navailable_countries     80.574  (\u00b1 6.2%) i/s -    406.000  in   5.057310s\n```\n\nBenchmark.ms { require 'carmen' }\n=> 6.585271989228204\n``. It looks like you are specifyingrails< 5.1`. Solidus 2.3.0 and later use Rails 5.1. > Have you used any tool to perform this conversion?\n\nI used coffeescript (1.x version, since 2.0+ emits es6) and manually edited the output.. I don't think teaspoon can be made to work with this. Oh well.. @damienlethiec Unfortunately there isn't yet a Rails 5.2 compatible version of Solidus yet. Biggest blocker right now is cancancan, which does not work on Rails 5.2 (see #2460).. > Thanks a ton for the answer!! Any idea of when a compatible version could be ready (even if I understand you don't have any control over CanCanCan)\nWith this change it's just the gems we depend on (barring any changes between rc and final release). cancancan doesn't want to merge any changes before final release, so some time after that.\nSolidus 2.5 will likely ship without Rails 5.2 support, but I would like to cut a Solidus 2.6 within a couple weeks of the final release.. Nope! Wasn't this.. Fixed by #2568 instead.. I don't want to do this because if will cause strange behaviour.\nFor example, the master association is autosave: true, but variants_including_master is not. So master is only autosaved if variants_including_master isn't loaded first.\nAlso if master is modified but not saved and then variants_including_master loaded loaded, those modifications will no longer be visible.. Thank you. Thank you!. @kev-hoang would you mind taking a look at #2578 \nI took a slightly different approach than what was previously here and should hopefully be less error-prone.. Failure should be fixed by #2580. > The current stable gem release of solidus auth devise fails with\n\ncurrent solidus core master, because we dropped the deface dependency.\n\nThis shouldn't be the case. Version 2.1.0 is the same as current master. > Nice. Out of curiosity did you test how much memory actually gets saved on a regular store?\nI haven't, and I'm not sure what exactly I would measure (maybe run stack_prof or memory_prof on a full checkout?). I'm not expecting a major improvement (but would love to be surprised by one).. Thank you!. Thank you!. Revert avoided by #2596. Thanks for the detailed report. Also, hi! I follow you on twitter and am a fan of your work.\nThe issue seems to be that taxon_preview doesn't use the Searcher (everywhere else displaying Products does) and therefore doesn't filter out products which don't match the current pricing options. Tomorrow I'll take a look at either filtering the products in this taxon by the current pricing options or using the searcher here.\nA second bug here is I don't think _products.html.erb should have errored. We have a show_products_without_price Config setting, so we should allow rendering this view with a product lacking a price. I'll also look at this tomorrow.. Thanks for the detailed report. Also, hi! I follow you on twitter and am a fan of your work.\nThe issue seems to be that taxon_preview doesn't use the Searcher (everywhere else displaying Products does) and therefore doesn't filter out products which don't match the current pricing options. Tomorrow I'll take a look at either filtering the products in this taxon by the current pricing options or using the searcher here.\nA second bug here is I don't think _products.html.erb should have errored. We have a show_products_without_price Config setting, so we should allow rendering this view with a product lacking a price. I'll also look at this tomorrow.. Spec failure unrelated and should be fixed by #2607. Spec failure unrelated and should be fixed by #2607. Hound still doesn't work :disappointed: . I think the definition of a \"ready\" shipment should be: \"we are able to ship the remaining inventory units\" (ie. inventory units can be shipped, on_hand, or canceled)\nThis would require changing this line in Shipment#can_transition_from_pending_to_ready?\nFrom\nruby\ninventory_units.all? { |iu| iu.allow_ship? || iu.canceled? }\nto\nruby\ninventory_units.all? { |iu| iu.shipped? || iu.allow_ship? || iu.canceled? }\nThis should, as you suggest, have no change for users on the standard UI, for whom cartons and shipments are 1:1.\nWould this solve the issue?. > Only works currently with solidusio-contrib/solidus_i18n#114\nIt won't cause any problems without that merged (it just won't do anything). This change will allow us to remove the decorator entirely from solidus_i18n :tada: . > solidus_18n also takes the preferred_available_locales is the current store into account. What this PR is not. Do you plan to support this feature as well in core?\n2627 :wink:\nMy implementation is a bit different and has different attribute names.. I think as long as it works under both MySQL and Postgres (and it seems to), the raw SQL is fine.. Maybe those missing routes could be moved out of order_concerns and onto resources :orders. Fixed by #2653. > The PR description doesn't seem to match the commit.\n\ud83d\ude33 Fixed. I would have thought that the index on [\"shipment_id\", \"shipping_method_id\"] would cover this (but I could be wrong).. This was actually extracted to https://github.com/solidusio-contrib/solidus_legacy_stock_system (solidus_stock_transfers was a separate effort)\nThe OrderStockLocation model became non-functional in Solidus 2.4 when the old Stock::Coordinator was extracted to solidus_legacy_stock_system. It would have been nice to have removed OrderStockLocation at that time, but I didn't get around to it until #2270\nIncluding the solidus_legacy_stock_system should fix any issues. Though if you don't need location configured packages it is probably better to just remove references to them. For anyone curious I do think this is a rails bug and spent some time yesterday evening making a test case for it https://github.com/jhawthorn/rails/commit/cf9c10e1b3e78c188677080fcf684f52ded55206. > Thanks. Could we satisfy the Hound, though?\ndone. While I think it's a bit odd to introduce a Config option I don't want anyone to use, this is a big improvement over what was there and does solve the issue :+1: . > This PR is blocked on #2685.\nDo you mean #2687?. I am getting the same deprecation errors locally, which are considered failures on CI. > The first commit seems to be empty. Is it still useful?\nNope! I merged it a while ago in a separate PR. Fixed!. I'd like to avoid removing even testing related methods in a SemVer minor release, but I think it's unlikely this is widely used, and it would break for everyone in Rails 5.2 regardless.. Thank you!. ok. > In order to support SassC (a much faster, C based Sass implementation) we should actually remove the sass and sass-rails dependencies from our gemspecs and tell our users to add the Sass implementation of their liking.\nI think this still works with both included. sassc-rails even depends on sass. Would this work instead?\nif !@@user_class.constantize.is_a? Spree::UserMethods\n. I think this should be a raise since it \"must include\".\n. What is modifies_config?\n. I don't think this method exists on the user from spree_auth_devise. Maybe we can remove it entirely.\n. I don't think this is testing anything. The return value of valid is not checked.\nIs there a reason to add this additional stubbing?\n. I don't think this is testing what the test describes.\n. not sure why this was changed. Maybe there needs to be a change to the model in order to cause a touch.\n. After some discussion, I think we'd like to find a different means to extend this. Including a module which is defined as a module attr is complicated and error prone w/r/t load order.\nI'd like to see if we can get away with just having mattr_accessor :login_url\n. The issue is that ControllerHelpers::Auth is likely to be included somewhere before before an initializer is run in the application. While I agree that extensions shouldn't be setting this themselves, that doesn't solve the issue.\n. I wouldn't mind seeing that in the future, but this was an easier fix.\n. Is try necessary? If so can we use try! instead?\n. Is try necessary? If so can we use try! instead?\nSince this appears twice, maybe we should have a store_credit? method on Payment twice.\n. In pre-22, tax adjustments were created directly on the order. In post 2.2, they are created on items and shipments. So these no longer correctly reflect how an order is taxed. I could move this change to a separate PR if that makes more sense, there's no need to include it here.\nEDIT: moved to separate PR\n. I added a little extra clarification in the comment right before the short circuit.\n. This should be changed, I just needed a public url.\n. Can change this when we rename the initializer.\n. This is a super hack, but we should document it properly. I'd also like it if we raised an error if #to_s was run without Spree.user_class being defined\n. The to_s is unnecessary due to the implicit one in interpolation.\n. Could these both be try!\n. Just curious what situation this is intended for? I don't think shipments can leave pending until the order is completed.\n. Can we find a name other than :backend, which is a term I want to phase out?\n. Does this allow assigning roles? If so only full admins should have this ability.\n. If we're going to switch on the action anyways, I don't see the advantage in breaking this out into a method.\n. Helpers are exposed globally. Names need to reflect what they are operating on. This should probably be store_credit_event_originator_link\n. Same as below. This should probably be store_credit_event_admin_action_name\n. This duplicates a lot of assignments translation_key =, translation_options =, href = in each of these cases do avoid duplicating a call to link_to and Spree.t. I think it would read a lot better as:\noptions = {target: '_blank'}\ncase originator\nwhen Spree::User\n  link_to(\n    Spree.t(\"admin.store_credits.user_originator\", email: originator.email),\n    spree.edit_admin_user_path(originator),\n    options\n  )\nwhen Spree::Payment\n  link_to(\n    Spree.t(\"admin.store_credits.user_payment\", email: originator.order.email),\n    spree.edit_admin_user_path(originator.order, originator),\n    options\n  )\n...\n. Is it possible to avoid driving the frontend display via evaluated js from the server? Maybe this could return json that was displayed via JS.\n. Probably should destroy the record\n. Why empty string instead of nil?\n. This made me realize, maybe we should make the roles attribute a hash of {name => Role}\nThis would allow something like:\ndef initialize\n  @roles = Hash.new do |h, name|\n    h[name] = Role.new(name, Set.new)\n  end\nend\nThis would allow us just iterate over the provided spree_roles, and elimintate the need for find_role.\n. is ArgumentError the right error here? Sound like it should be NotImplementedError\n. I think this is the reason for the :admin pseudo-action. All users can edit/update their own order, so admin is to distinguish between that kind of editing and this kind. A good clarification of this somewhere would of course be welcome.\n. This is fine (and an improvement) for now, but we should replace this with the correct store for the order, rather than the default store.\n. :+1: So without the to_a we get a serialization because it's an AR::Relation? Neat.\n. The capybara matchers both wait (up to 2 seconds by default) until the condition they are looking for is true. This not_to have_content returns almost immediately, since the row is hidden in the click event handler. Meanwhile, the phantomjs browser continues running the ajax request to delete the item and then refreshes the page.\n. Is this what we want? or do we want images.first || product.images.first || product.variant_images.first? If that we could simplify this to images.first || product.display_image.\n. I see, I think I understand better now.\nI think the problem here is the original intent of the deprecation, and why this method was introduced, was to move away from this behaviour. If you're editing stock for \"white socks\" it's confusing to have the \"black socks\" image shown. For this reason there was no fallback implemented in this method.\nHowever, we probably often do want to use a fallback if there is no image directly attached to this variant, in the cart for example. I also think that when a fallback is desirable, if the product has an image associated (ie. an image on the master vairant) that should be preferred to the current fallback of \"any image from any variant\".\nPerhaps being able to specify the callback would solve this issue. One possibility:\n```\nFor the cart, we want any image available\nvariant.display_image(fallbacks: [:product, :other_variant])\nEditing inventory, we want to make sure the image describes the exact variant\nvariant.display_image(fallbacks: [])\n```\ncc @richardnuno and @cbrunsdon who made this change originally.\n. Thinking this should maybe be the count of orders completed before this order. That way this could be realculated even on a completed order correctly. This will probably work without that because the adjustment will be closed on order completion, but we shouldn't depend on that.\n. Both contexts use this, maybe we should have\nallow_any_instance_of(Spree::Admin::RootController).to receive(:spree_current_user).and_return(user)\nand then here\nlet(:user){ build(:user) }\nAlternatively, maybe stub_authorization would simplify some of the stubbing later in this file\n. Can we get some quick docs on what this means?\n. Under MySQL, timestamps only have 1 second precision. This has to either be tested differently, or an update_column or update_all set updated_at to a known past value.\n. For the time being, I'd prefer if we kept both of these in place. We shouldn't remove this without first deprecating it.\n. This should not change the value of inventory_cache_threshold. If I understand this correctly maybe it should read:\n``` ruby\ndef conditional_variant_touch\n  variant.touch if count_breaks_threshold?\nend\ndef count_breaks_threshold?\n  inventory_cache_threshold &&\n  ...\nend\nprivate\ndef inventory_cache_threshold\n  if Spree::Config.binary_inventory_cache\n    ActiveSupport::Deprecation.warn \"Spree::Config.binary_inventory_cache=true is DEPRECATED. Instead use Spree::Config.inventory_cache_threshold=1\"\n    1\n  else\n    Spree::Config.inventory_cache_threshold\n  end\nend\n```\nThat way we're using the correct values without re-assigning the preferences.\n. If this busts cache on variant_id_changed?, this method should have a different name. Maybe should_touch_variant? or similar.\n. This should use the UserClassHandle\n. installation time\n. We can remove this when the table is renamed. I'm looking to merge this into the v1.0 branch, so it will stay this way for now.\n. An more lazily evaluated form of just calling Spree.user_class.to_s, makes initialization more bullet-proof.\n. This is probably the issue you found @jordan-brough. Creating 4 credit card payment methods. We probably want to change the description also.\n. Don't use validates_associated, we don't need to validate the country model to create the address model. Country records rarely change, and aren't created at the same time as Addresses\n. I am fine with both validates :country_id and validates :country, just not validates_associated\n. We should remove the guides\n. return not needed here.\nIs there a pre-defined scope on payments we can use instead? If payments were for some reason complete wouldn't that also be valid?\n. why / 2?\n. Would it be possible to do the entire match here, instead of going to SQL and then finding the same in memory object?\nMaybe something like detect{ |ua| ua.address_values == address_attrs }\n. We can't fully maintain compatibility, since we can't determine which order was supposed to be sent to, but we could guess that it was always the first which would be correct for most stores.\n. I want to pass an ActiveRecord object through ActiveJob. Is there any reason I shouldn't? I believe it handles serialization well.\n. It it possible to get duplicates? I wouldn't think so since we're grouping on just variant_id?\n. Should we have an inverse of here, or is that detected successfully?\n. Same question as other PR: Should we have an inverse of here, or is that detected successfully?\n. This was deleted because I believe it is dead code. We have no #transfer_variant_template, no #transfer-variants-table etc anywhere in our codebase.\nIf it is used I don't know where, and much of it is broken.\n. Just a relic from the era that BaseController inherited from Metal instead of Base\n. Is it possible to check that this is a \"unreturned exchange\" as well as doing this check?\nI don't think that this \"silent fail and skip\" would make sense for a normal order.\n. This test tests the behaviour change, but doesn't expose why this change was necessary. Can we get a spec showing the problem with an unreturned exchange?\n. I think this should be a raise, possibly even a raise ... if create_proposed_shipments. This behaviour doesn't fit well with the rest of this methods behaviour. I think if we were to write documentation for this method it, this behaviour would seem really out of place.\nIf I change it to this to a raise if unreturned_exchange? && shipments.all?(&:shipped?) only the spec testing this exactly this method fails. Is it possible to get a spec which covers why this behaviour is required rather than just that it exists\n. I like apply\n. > The spec that covers why it's required is in unreturned_item_charger_spec.rb. It's a though one to bring over to order_spec.rb since it's directly related to this method being called when attempting to charge for unreturned exchanges.\nI don't need it in order_spec, but nothing in that file shows that this is required. See jhawthorn/solidus@acc533053ac172550fea0bd2647ef4d91ca1234e I replace the return with a raise \"FOOBAR\" which never occurs (outside of the skipped unit test). Proof here\n\nI think raising might be too severe since it's not an exceptional case, perhaps wrapping the contents of create_proposed_shipments within an unless unreturned_exchange? && shipments.all?(&:shipped?) would make it a little clearer?\n\nIt is the behaviour, not the formatting that I think is unclear. I think raising an exception is the right thing to do: we've asked to create new shipments on an order that should not have a new shipment created. Raising an error informs the caller that we were not able to perform the requested action. Failing silently makes it impossible to determine what the result of the action was.\n. I really like that. Obvious what you're passing in and will make any future changes easy.\n. Good catch. I think I'll extract \"available_cards\" to another method and make use of Spree::CreditCard.none\n. This seems more like a create than an update\n. This seems to go out of the way to avoid being the standard rails rest resource. Is there a reason the standard index, create, and destroy were avoided?\n. I don't see a reason that they would guaranteed to be returned in this order (unless I missed a default scope somewhere). Maybe it would be better to test that just one of the two was default\n. Ah, I missed that this was added :+1:\n. I still intend to switch this to CreditCard.none (mostly because I think that's a little more clear). That will perform no query, so I'm not sure what this discussion is about.\n. Can we get a quick yardoc on this, just to clarify what it does (not a standard setter).\nOtherwise :+1:\n. is that a tab?\n. I think I clarified this in chat, but yes. unreturned_exchanges are a special case which deals with shipments itself.\n. I believe that this behaviour exists by default. (specs still pass with it removed)\n. extra newline\n. Not if we have infer_spec_type_from_file_location on (which we do), but they seem to be used and there's no harm (and maybe we'll turn that off eventually).\n. This will probably break on MySQL (second timestamp precision issue). Maybe we want to rule.update_columns(updated_at: 1.day.ago) before this line\n. MySQL timestamp precision issue (see below)\n. MySQL timestamp precision issue (see below)\n. MySQL timestamp precision issue (see below)\n. is there a reason to compare the ids instead of just == the records?\n. I think this is less readable than what was there before\nThis uses the structure\nif address_attributes.present?\n  ...\n  # continues\nelse\n  return\nend\nI think it would be less confusing as\nreturn nil if address_attributes.blank?\naddress_attributes = address_attributes.with_indifferent_access\n. Just for context (please don't consider this question a blocker, as it was already in) why do we even accept {} for address_attributes?\n. Is splitting by space what we want here? we split by ',' above\n. Here I think we could use params.fetch(:stock_location_id) to get an ActionController::ParameterMissing instead of writing this logic ourselves\n. Maybe it should be a .join(',')? I'm not used to seeing space delimited params in rails\n. I think we should remove it\n. done\n. Good catch. Made this change.\n. Nope. This happens at runtime, so Spree.user_class is fine. Spree::UserClassHandle is only needed if used during initialization.\n. is this necessary? We've had a lot of issues with factories which depend on the state of the database when they are created\n. Probably would be good to remove. We need it when we update shipments through shipments_attributes, but it doesn't make sense on its own\n. As Ben says, this should be dependent: :destroy. Also, class_name should always be a string.\n. As Ben says, this should be dependent: :destroy. Also, class_name should always be a string.\n. if anything it should be null: true to generate the same as the existing table\n. I prefer what is there. This is a migration, where the table names are already hardcoded.\n. If you look two lines lower in this file the table name is also hardcoded. Table names should be hardcoded in migrations, we don't want migrations to change behaviour.\nSQL is always preferable to AR in migrations for the same reason.\n. @mamhoff we're very open to improvements in the taxation system (especially included tax, which is a bit of a mess). Is this refactor one PR or commit in particular?\n. Agree with jordan here\n. That is quite large, I've created issue #461 to remind me to look into it\n. I think that might be a good idea but is outside the scope of this PR\n. Maybe that's the best way to do this, but I'm not sure. Can we discuss in another PR\n. This is failing for me under mysql (which our CircleCI unfortunately doesn't test). Can we split it into three separate execute statements?\n. Or we could use travis :wink:. https://travis-ci.org/jhawthorn/solidus\nYou are right. I've created #469 to track this.\nHere's the error I get\nMysql2::Error: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'UPDATE spree_adjustments SET order_id = (SELECT order_id FROM spree_line_items W' at line 1: UPDATE spree_adjustments SET order_id = adjustable_id WHERE adjustable_type = 'Spree::Order' AND order_id IS NULL ; UPDATE spree_adjustments SET order_id = (SELECT order_id FROM spree_line_items WHERE spree_line_items.id = spree_adjustments.adjustable_id) WHERE adjustable_type = 'Spree::LineItem' AND order_id IS NULL ; UPDATE spree_adjustments SET order_id = (SELECT order_id FROM spree_shipments WHERE spree_shipments.id = spree_adjustments.adjustable_id) WHERE adjustable_type = 'Spree::Shipment' AND order_id IS NULL/home/jhawthorn/src/solidus/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.4/lib/active_record/connection_adapters/abstract_mysql_adapter.rb:305:in `query'\nSplitting the query into three statements fixes the issue.\n. I believe the adapter doesn't split by ; into separate statements. Which I think is semi-sensible.\n. in this case, however, roles[x] can't ever be nil as it has a default value.\n. Unfortunately can't use partial indexes because of MySQL :cry:. This is worked around by using a punch_slug method on Product. It's not ideal, but I'm not looking to change that in this PR, just merge the two indexes.\n. Is there another way to do this? This makes too many assumptions about the order state machine and how it works.\nThe store credit class should have no knowledge of what states an order has or what opperations happen on transitions between them.\n. This regression test was added before OrderUpdateAttributes was created. It provides us value in testing a corner case that the original code accounted for. For this reason it provides value.\n. I know I (sort of) asked for this, but seeing the implementation I don't think this makes sense. Most users signing up to a store will have no role at all. This option will grant an api key to any user with any role (but they must have a role), which is probably not as useful and I think the distinction will be confusing.\nI would still (eventually) like to see something for granting all users an API key, but I'd be :+1: just removing this option\n. That would be great\n. I would rather see that done initially. Especially combining the rulesets, which will require a migration if done later to copy rules from one table to the merged one and fix up the links.\n. Use try! not try.\nDid you mean || or | here?\n. I think @athal7 had concerns (rightly so) about the performance impact of this. Has the admin been tested with a large dataset loaded?\n. This is not a good way to add css. These styles are only ever going to be used by the one box on the one page (and it doesn't even fit on that page particularly well). Deciding things like i has a font size of 30px also makes no sense semantically.\n. > my understanding was that we were going to have rule-based images at the product-level in the api response\nHow would this work for the varuant search route?\n\nIn my opinion the performance impact is very small.\n\nMy intuition is otherwise, have you tested this?\n. @tvdeyen @graygilmore I agree that this would be nice, but for compatibility reasons they should stay the same.\nThe sub_menus are a common deface target, and this has largely left it intact. An existing deface override on the data-hook in spree/admin/shared/product_sub_menu will still work. I think eventually we will end up cleaning this up through some sort of programatically extensible menu, and I'd rather not make developers have to change their menu overrides twice.\n. This should be class_name: Spree::UserClassHandle.new, which gets around some load order issues (which are likely causing the ci failure here)\n. Would Spree.user_class.table_name work here?\n. Could you try find(\"#customer_search a\").click instead? Using execute_script can cause timing problems because there's no guarantee the element is on the page yet when this is run.\nSome of the uses of this above might be better replaced with our built-in select2 helpers. targetted_select2(value, from: \"#customer_search\") probably covers a lot of these cases.\n. Just curious if this volatile attribute is necessary, could we determine that recipient was being overridden by the presence of a recipient? Or is there a case where recipient will be set, but it won't be considered overridden?\n. We could still have that functionality without the model needing to be aware of it.\n. I think the naming here is a little ambiguous, I don't think a developer would be able to infer that user.generate_spree_api_key always generates an api key, but user.generate_api_key only generates one if the user is eligible. Maybe a name like auto_generate_spree_api_key or similar would clear that up.\nI'd also love if this looked through the roles rather than needing the role to be passed in, just to keep the api as simple as possible. We have the knowledge in this object of what roles we belong to so we might as well use that. Maybe something like (spree_roles.map(&:name) & Spree::Config.roles_for_auto_api_key).any?.\nOther than those two comments this is awesome :+1:\n. I'm fine with restart_checkout_flow, but not with checking for the \"confirm\" state. Sorry if that wasn't clear initially.\nI don't think I'm entirely clear why we're only applying to the confirm state.\n. We can't store classes as preferences this way (there's no understanding of :class as a type). But this could be done like variant_search_class or promotion_chooser_class below\n. AR::Base#valid? modifies errors as a side effect, so it does align with that.\nI find ensure a problematic word in our codebase. Some methods like ensure_updated_shipments have major side effects (deleting all shipments), others like ensure_shipping_address just perform validations.\nMaybe we would all be happy with validate_transfer_items?\n. Fixed. Thanks.\n. I think this file would be better under testing_support/factories (but I don't feel that strongly about it)\n. The comment says:\n\nThe rate's zone is in the default zone\n\nBut the code is\nself.zone.contains?(Spree::Zone.default_tax))\nWhich reads to me as the opposite, \"the default zone is contained by the rate's zone\"\n. Thanks Martin. I've cloned this down, and am trying to wrap my head around the tax system to give a proper review. I really appreciate format of the new specs here.\n. This should probably be try!\n. Whoops. The rebase snuck that back in. This is fixed and I gave this a more careful read.\n. I don't believe this will be a good time to do this. Order update can be called somewhat often and this is probably something we want to do rarely.\nOrder updater also isn't called immediately on order.finalize!, which may cause this to be incorrect.\n. Done. Thank you\n. I'd prefer\nproduct.really_destroy!\nexpect(product).not_to be_persisted\nto_not raise_error is basically a no-op\n. These lines might read cleaner as \nruby\nrates_for_order_zone = all_rates.select{|rate| rate.zone.contains?(order_tax_zone) }\nrates_for_default_zone = all_rates.select{|rate| rate.default_vat? }\n. Thanks\n. I went with a different solution I hope is acceptable: dropped the outer variable and kept the shipment variable in the block.\n. Thanks, that's a nice improvement. I'm going to implement that in a separate PR as @Mandily has suggested a few other small improvements\n. I prefer x, because p is http://ruby-doc.org/core-2.3.0/Kernel.html#method-i-p\n. I think this should be :label, as that is the attribute we are printing\n. I don't think this is an attribute name, it's translations for two of the values the attribute can have.\n. All other actions are Capitalized, should this be the same?\n. Looks like it should to me. This is a class method so it will return the Spree::Zone.none null object relation.\n. Good catch. Thank you.\n. Sure\n. The &nbsp; here previously was attempting to avoid a line break, which will no longer work now that there are additional spaces here.\nI think that was unnecessary. Could we also remove the &nbsp; here?\n. Should this be part of this PR? Where is this used?\n. I'm not sure why this change was made, the existing code looks preferable.\n. :date_completed doesn't exist. Maybe this was meant to be :completed_at\n. I don't think this will pick up a translation\n. typo here\n. payments_failed_count already makes it clear we are using payments, and we don't need to provide the model name to that translation.\nThe :count key is magic and will allow adding the :one and :other keys under payments_failed_count\n. I don't think we should be translating these method names at all.\n. permalink_part is not an attribute\n. Was this necessary to combine?\nIf so this line should be:\nlink: link_to(Spree.t(:cannot_create_payment_link), admin_payment_methods_url))\n(Using the parens for the method arguments rather than around the whole method call)\n. Could this be first_or_create! so that we receive errors if there are any problems?\n. I'd also love first_or_create! here\n. maybe this should check for presence? if state_ids == [] and country_ids == [] we know there will be no results\n. :small isn't a style on icon by default.\nCould we have :normal instead?\n. The name tax_adjustments_destroyed is a little confusing to me.\nHow about something like :skip_destroy_adjustments?\nOtherwise :+1:\n. This should probably be '.orders' since it is on the class, not the instance.\nOtherwise :+1:\n. Done. I went with \"solidus_admin\"\n. Could we have an indent here to show that this is part of the previous statement?\n. I agree. We gain nothing by removing it here.\n. I think this might be an important behaviour change (and unfortunately this is the only spec that caught it).\nA shipment which has some \"canceled\" inventory units should still be \"ready\" and shippable\n. helpers is a bit of an overloaded term. How about utilities or utils?\nIf you believe helpers is the most descriptive, I'm also fine with that.\n. All of this is provided by bootstrap's _reboot.scss. It can probably all be removed.\n. I should have provided a link:\nhttps://github.com/solidusio/solidus/blob/master/backend/vendor/assets/stylesheets/solidus_admin/bootstrap/_reboot.scss#L20-L28\n. This line actually wasn't changed here, but looks like it because github's diff is confused by the massive whitespace change.\nI've made this change in a second commit.\n. Is it common to have a price passed in here?\nI'd prefer checking just options.has_key?(:price), as both line_item.price = '12.34' and line_item.price = nil do work. Even if we don't expect options to be used that way, it's harder to reason about if it behaves differently based on the type of :price provided\n. Is this try really necessary? The previous code was able to assume the exchange_variant was present.\nOtherwise this change looks good.\n. I'm not sure the rubygems page provides useful information. Maybe we should use github links with the intention of adding READMEs to the subprojects\n. try should be try!\n. Neat!\nMy only concern here is that price_for reads a lot like price_in, despite being very different (price_in returns a Price, price_for returns a Money). I'm not sure I have a better suggestion, though, as out *amount* methods usually just return a number.\n. Would this make more sense on Spree::Config. Having class instance variables behaves strangely in development mode as classes are regularly reloaded.\n. It's called both from an instance of Money, and from the class so it can't be :(\nWe can make it private once the deprecation in initialize is removed.\n. Thank you. Excellent suggestion.\n. Is this necessary? The class is defined in the view, we should be able to rely on that.\n. I would prefer always using the same class name ex. success and error. Developers can customize that in css if need be.\n. I believe this should be inside the above <p> tag to match the existing behaviour.\n. That makes sense. Thanks for checking.\n. This will not be in 1.3, could you move this to the 1.4 section\n. Actually just noticed this. Spree.url is deprecated. Is there a reason this was changed?\nI think this also lost the without_children: true, which makes the API call a fair bit faster\n. I think what's here is probably fine. Both solutions run the same number (2) of SQL queries and I don't expect instantiation of a few roles to be too expensive.\nIf we were really concerned about performance. We could store the role ids as a preference (preferred_role_ids) instead of as a real association. This would allow us to avoid having N+1 queries if we were to have several role-based promotions which were automatically applied.\n. Sorry for the delay in reviewing. Could these be .try!?\nI also wonder if maybe Spree::Tax::TaxLocation should also implement taxation_attributes, any thoughts @mamhoff?\nOtherwise I think this is a great change and is a step in the right direction towards relying less on the state machine to get everything right.\n. These tests are nice and feature-complete, but we strive to avoid having stubs in our specs, as it can make them brittle.\nIt should be possible to write this without stubbing https://gist.github.com/jhawthorn/74b9a554a307675d69e624db5cef33f3\n. If we use a preference of serialized ids this would remove the need for the extra table.\nI'm in favour of adding this to core either way.\n. Ideally we wouldn't do this, but it is essentially the same as the productAutocomplete, userAutocomplete above.\n. Is the second * here a typo?\n. Thank you. Nice catch.\n. Is there a reason for this to be a preference? I think having it at Spree::I18N_GENERIC_PLURAL would probably be sufficient for everyone.\n. Could be in here I suppose https://github.com/solidusio/solidus/blob/master/core/lib/spree/i18n.rb\n. Since we are now using _currency (even though it's just for the deprecation). The leading underscore should be removed.\nOther than that nitpick :+1:\n. This is unnecessary. There aren't any stores being created before this (and we truncate the database at the start of the core test suite)\nOtherwise :+1:\n. We need to be able to assume that we have a reasonable test framework and that the database is empty at the start of our tests. Otherwise we'd need to put delete_alls before practically every test we have.\n. I think it's fine as is (but full disclosure, I may have suggested it). I don't like @admin_layout =, because we lose control over the assignment (juts in case we ever need to deprecate this or certain values). An attr_writer is fine, but reads a little awkward in a view. I don't think people normally think of the fact that the view context is an object when writing views..\nruby\n<% self.admin_layout = 'foo' %>\nvs my preferred\nruby\n<% admin_layout 'foo' %>\nI don't think admin_layout  being a setter and getter is out of place in a view, content_for(name, content=nil) is similar.\nThis is probably pretty subjective, so I'd love to hear others' thoughts.\n. This should probably just be adjustments, which delegates and caches item.adjustments\n. Since we aren't using the result this should be each\n. If it is required (I don't think it should be) it should be in the before block instead of hiding in here\n. The user in all of these examples is the \"target user\", so I think this is consistent.\n. I could make it a method instead of a let, which might reduce confusion.\n. This should be expect(order).to be_canceled\n. This factory is crap (sorry). The order_with_totals factory actually makes an order with no totals :disappointed_relieved: :rage4: \nAs a result this spec wasn't actually failing after you removed the .update! :cry:.\nChanging this to create(:order_with_line_items should fix the problem.\n. do/end is actually a little more awkward here because safe_join breadcrumbs.collect do |level| will associate the block with safe_join rather than collect.\nI agree with the hound, prefer map over collect.\n. done\n. Are id, variant_id, quantity really valid options? They probably should not be used.\n. We should probably not document them since they may have an effect but will likely produce strange behaviour\n. I really want to do this.\nI don't think we should concern ourselves with someone attaching adjustments to something other than LineItems and Shipments, since the rest of the methods in OrderUpdater won't take that into account.\n. > Shall I merge that into this PR?\n:+1: \n. I'm actually encouraged that this test is breaking. It's testing an obviously wrong thing (that the adjustment totals aren't updated despite being wrong). We could probably remove it.\n. [0.01, -0.83, -0.84].inject(:+) #=> -1.66\nand that 0.01 is the tax adjustment above :+1: \n. Lower in this file there is\n{ product: product }.merge(variant_attribute)\nWhere variant_attribute is a hash derived from variants_attrs. This causes a warning in rails 5 because it is converting an ActionController::Parameters to a Hash without sanitizing.\nuser_address_book.rb and importer/order.rb have similar things.\nI'm not sure this would make more sense to do at the controller level. Calling permit() there makes sense, but it seems to be a common pattern for other objects to accept ActionController::Parameters (like ActiveRecord does)\n. I think we should\n. :+1: I really want to do this. I tried it and it caused a few errors, so I'd like to do that as a separate follow-up to this PR\n. Instead of this we should probably fix this line https://github.com/solidusio/solidus/blob/master/core/app/models/spree/tax/item_adjuster.rb#L31\nand then remove the skip_destroy_adjustments option\norders here should never have tax adjustments (they've been only on items since spree 2.2), so I don't think we need to consider that\n. Alternatively, I think this could be.\nself.adjustment = inventory_unit.line_item.adjustments.create!(\nThis should keep both associations fresh without performing an extra query (no query run since source will already be set correctly). This avoids the need to change the has_one to a has_many\n. I don't think this [] syntax works (I see it elsewhere in the file, I don't think that does anything either).\npage.find_link(\"Promotions\")['/admin/promotions'] #=> nil, no spec failure\npage.find_link(\"Promotions\")['foooooooooo'] #=> nil, no spec failure\nInstead can we make this\nexpect(page).to have_link(\"Promotions\")\n. Same as above\nexpect(page).to have_link(\"Promotion Categories\")\n. I don't think this is a concern. We use descendant selectors liberally in our styles. A > img here also won't achieve the desired effect here.\nFrom the linked document\n\nNote: This document was originally written in 2000. Much has changed when it comes to writing CSS that is fast. This guide is not an accurate representation of the bottlenecks in the browser's rendering pipeline.\n. This should be for version 2.1.0\n. This change is great, and allows another refactor here.\n\nWe can change this ugly @response instance variable to just a local variable in this perform! method (the only place it is used)\n. Let's discuss this elsewhere. I would like to follow this up and replace this method with something that more resembles a standard AR string attribute (that will cast Integers to a string), but I felt that that was too big of a change here.\n. Not sure what the return value should be after this change. Previously I had thought of it like AR's save, true means the action was successful, false means nothing happened.\ntrue now means the promotion was attached and is currently active.\nfalse now means the promotion was attached, but is inactive for the time being.\nMaybe this is fine, but I thought I'd bring it up.\n. I would prefer that since the JS response will not be in core. Otherwise, :+1: \n. This is probably not quite right. The return value of a controller action has no meaning, so we don't need to return the value from our superclass here.\nHowever, the save performed in the ResourceController, our superclass, may or may not succeed. We don't want to perform a refund which failed to save.\nWe probably need to duplicate the logic from the ResourceController here, but inserting the @refund.perform! in the \"success\" path.\n. We don't have a js view here, so we can remove this line. (it made sense in ResourceController because some controllers would have a JS view for create)\n. Same as above\n. I'm also prefer keeping the to_a.first\n. Single quotes prevents interpolation here\n. It might make sense to group this loop with the previous identical one.\n. I think I disagree with our rubocop rules here.\n. It feels weird that promo_total, included_tax_total, and additional_tax_total are summed in their respective methods, but cancellations are not.\n. I don't think .html.erb is appropriate here since html can't be rendered inside the textarea. Either this should be text, or the textarea should be changed to a different container.\n. I would prefer this had a class instead of using inline styles.\n. Thought about this slightly more, and it's probably preferable to keep this HTML and to  change the textbox into a div with a fixed height and overflow: scroll\n. .detect would return us (for example) ['visa', /^4\\d{12}(\\d{3})?(\\d{3})?$/] so the code would need to be something like\ncard_type_pair = CARD_TYPES.detect { |type, pattern| numbers =~ pattern }\nif card_type_pair\n  card_type_pair[0]\nelse\n  ''\nend\nI think the return is more clear.\nI will remove the .to_s\n.  Thanks. Fixed\n. This should avoid modifying the hash passed in.\n. > In this way we prevent inserting the html code (link, images ecc...)\nI don't see why this is a concern. Nobody is forcing a developer to add those to this file.\n\nThe terms and conditions should be in a format that can be printed or saved\n\nThere is no reason a textarea is better for this. Using a div with overflow: scroll we even have the opportunity to expand it in a print-only stylesheet if that is a real concern. The \"text only\" feel of a textarea could be duplicated using white-space: pre for sites which really want that, and sites which already have an HTML version of their terms and conditions can use that.\n. This is a little tough to parse with the early return inside the unless (which has me thinking about the rest of the method like the double negative unless...else).\nI think it would read better as an if/elseif/else\nruby\n  if !money\n    self.price = nil\n  elsif money.currency.iso_code != currency\n    raise CurrencyMismatch, \"Line item price currency must match order currency!\"\n  else\n    self.price = money.to_d\n  end\n. I don't think this should be removed, it's a parameter accepted through the API.\n. I don't doing work (like save) in a suffix if statement. I'd prefer a regular if statement to ensure it is noticed\nruby\nif save\n  debit(ledger_balance, { action_originator: user_performing_invalidation })\nend\n. I found this just slightly tough to parse (have to flip the sign because of the unless). I'd prefer\nruby\namount = -amount if amount > 0\n. Missing spec\n. Is it possible to do this using raw SQL or using AR models defined directly in this migration?\nDoing it this way may cause issues in the future if the behaviour of StoreCredit or StoreCreditLedgerEntry.generate_opening_ledger_entry_for changes.\n. We need to keep this as we ll since we are keeping option_values_hash\n. keep\n. keep\n. Is this necessary? I would rather have a transaction unless there is a reason not to.\n. I would rather not print anything in our migrations (since this will show up in each rake test_app, rake sandbox, and rspec run). Though I believe say in an actual migration will be silent if VERBOSE=false or something.\n. I would still prefer that this didn't use the standard AR models as that will cause problems if the implementation of amount_remaining ever changes. It seems really likely that that method will chnage, given that it might be better implemented in terms of summing these ledger entries.\nInstead I'd like to see raw SQL which shouldn't cause any issues in the future.\nruby\nexecute <<-SQL\nINSERT INTO spree_store_credit_ledger_entries\n  (store_credit_id, amount, created_at, updated_at)\n  SELECT id, amount - amount_used, '#{now}', '#{now}'\n  FROM spree_store_credits\n  WHERE invalidated_at IS NULL\nSQL\nexecute <<-SQL\nINSERT INTO spree_store_credit_ledger_entries\n  (store_credit_id, amount, created_at, updated_at)\n  SELECT id, 0, '#{now}', '#{now}'\n  FROM spree_store_credits\n  WHERE invalidated_at IS NOT NULL\nSQL\n. We aren't using the skeleton classes anymore. This can juts be \n<div class=\"no-objects-found\">\n  ...\n</div>\n. This two lines can probably be combined into just a form_for\n. Please use try! and not try.\n. I would prefer a name other than build, which will be confusing since ActiveRecord uses that name a lot.\nAny of build_codes, create_codes, process would be fine.\n. A checkbox might be simpler than a radio button\n. This is not ideal because the order is holding knowledge about what payments are available to what stores. This logic would be better in either the Payment or Store class.\nI'd recommend adding a Payment.available_to_store(store) scope.\n. This isn't a precise replacement ,your_store.payment_methods won't return payments if none are associated (it should return all payments in this case). Payment.available_to_store(store) which I suggest above would solve this.\n. What meaning does the default, nil, have?\nI would prefer that the default to both be true (matching the old default behaviour) and that the column was null: false to avoid any tri-value logic.\n. :+1: Thank you for using plain SQL in the migration\n. I don't follow this line. I don't think it replicates the existing functionality.\n. 'both' should not be included here.\n. I would prefer we kept the old value here 6, just to avoid surprise changes to users.\n. As a convention, the ? suffix should only be used on methods returning a truthy/falsy value. A better name might be redirect_on_empty_option_values\n. I'm concerned that we're changing the meaning of this column. Both because existing applications may expect the amount to have the refunds subtracted, and because existing records in the database will already exist with the existing values.\n. I'm not sure what \"originator of the Payment\" or originator here is supposed to mean. self here refers to the payment we are processing.\nThis is the first time we will be using an (non-simple) object in this hash. Every other value has been carefully coerced into a string, integer, or another simple hash. I don't know that we need to keep that convention (or if there was a good reason for it originally) but we should be conscious that we are breaking it.\n. This can probably be .left_joins(:option_values)\nRails 5! :tada: \n. I'm still not crazy about the word originator here, but if it is for a specific purpose, could we get a comment refering to the method which will be using this?\n. Elsewhere we've used handlebars templates which can be thrown in spree/backend/templates which are precompiled and made available to the admin JS.\nEdit: Sorry, I see you left a comment noting this.\nI would prefer this used handlebars. Both for consistency and because I think it is better here.\n. I understand why this hack is necessary, but I think this selector is a little too broad.\nCould we do input.select2-input[placeholder] instead?\n. I would also prefer we keep as much data in Carmen (or even just hardcoded) as possible.\n. This should probably mention what user-facing change was made. Maybe:\n\nThe backend prices listing page now shows master prices separate from variant prices. This changes instance variable @prices to @master_prices and @variant_prices.\n. This also won't prevent process from being called multiple times, since no codes will be created until the job starts running. Worth considering if we care about this race condition.\n. Unless there's a kind of error we're expecting I don't see a reason to store the error on the model.\n. I would prefer the rescuing and mailing was done in the PromotionCodeBatchJob. IMO the reason we want to send an email and set the error on the model is that this is being run in the background.\n\nMoving that to the job class reduces the responsibilities of this class and should make it better to test, and more flexible. Maybe a developer wants to generate promotion codes without sending emails.\n. I think this is no longer necessary thanks to your work in #1479\n. I see above we have col-xs-12, which is the full width, and can probably be removed\n. We probably want to find a way not to need to do this. We should only use row where it is needed (and makes sense, because we have multiple columns)\n. IMO the name is fine\n. There's no reason this page should have different outer padding than our other pages, so this should either be removed or applied to all pages.\n. I notices that this has CSS applied strangely.\n.row as defined by bootstrap has a margin left and right of -0.9375rem, which patches a padding of 0.9375rem on the columns.\n.form-section has margin: 10px 0px.\nSo adding these two together adds padding in a non-obvious way. We instead probably want to add some padding to .form-section and avoid using row here at all.\n. all isn't safe to use in feature specs, since it's possible for it to return [] if the desired items aren't on the page (ex. not yet fully loaded).\npage.all(:css, '.stock-item', count: 3) should work\nOtherwise, this looks good\n. Thanks for the PR.\nBeing within 0.1 (10 cents) is probably not good enough here. We should test for an exact amount.\nThis test passes both before and after the change made in default_refund_amount.rb. Is it possible to get a spec which clearly shows how the existing code was incorrect.\n. We should probably follow semver here and allow ~> 1.7\n. This value isn't checked anywhere, so if necessary this should use save!. We need a spec to show why this is necessary. After removing this everything still passes.\n. I'm not sure if this is necessary, but adding reloads generally wreaks havoc. reload disconnects the object graph between models, which can cause some very unusual behaviour. Instead we should look at fixing whatever code was updating this line item (and not uploading the correct version, which we have here). A spec would be helpful since removing this line causes no failures\n. \"voil\u00e0\". I don't think we should use bundle exec here because we're already in ruby, and presumably already in a bundle exec. I'll remove this commit and submit it separately for discussion.. I worry that this will give the wrong impression, and sqlite might be fine for users who are just starting out and developing.\nHow about\n\nRails default sqlite database isn't well suited to real Solidus production usage. Solidus will runs best with the postgresql (or MySQL) database.\n. I think this should be\nto account for the different VAT rates in either country. Fixed. We can remove this also. I don't think this should be a \"bang\" methd. There's no non-bang version of this. We're calling next and complete on order, not next! and complete!.\n\nI'd prefer it was just called transition_forward or similar.. I find this line tough to parse for a couple reasons.\nI prefer using the conditional suffix only on functions that don't mutate state. It's kind of sneaky that transition_forward!, the main purpose of this whole action, is at the end of the line. It also makes the order these run in mildly confusing: this_second and this_third unless this_first.\nI'd prefer that the transition_forward! was more obvious, and that the order would read top-to-bottom\nruby\nunless transition_forward!\n  redirect_on_failure\n  return\nend. Instead this could have originally been\ncolumn_exists?(:spree_taxons, :depth)\nWhich would not have exhibited the column caching issue you found. Removing it entirely is probably fine too.. This can be uncheck 'Send Mailer', which reads a little nicer :). @cbrunsdon  has removed all the wait_for_ajax in #1668 :tada:.\nWe can replace the wait_for_ajax here with expect(page).to have_content(\"shipped package\"). We can wrap the test above this one (it \"can ship a completed order\") with the opposite email expectation. You'll probably want to rebase first, since that spec was changed in #1668\n```\nit \"can ship a completed order\" do\n  expect {\n    find(\".ship-shipment-button\").click\nexpect(page).to have_content(\"shipped package\")\nexpect(order.reload.shipment_state).to eq(\"shipped\")\n\n}.to change{ ActionMailer::Base.deliveries.count }.by(1)\nend\n``. One though before merging: should this beupdate!? We don't check the result so it probably should.. The test in the fixup looks good to me (it can't hurt to have). I'd like it rebased please :). I believe SQLite actually uses't'` as its true value.\nIt's probably safer and simpler here to use\nruby\ncondition = \"apply_automatically = #{connection.quoted_true}\"\nOtherwise :+1: \nIt's worth noting that MySQL and its forks don't support partial indexes, but there should be no harm in it adding this index without the condition.. Seems like quoting the outside of the sentence will read quite odd if multiple items are out of stock.\n\n'blue shirt and red shirt' has become unavailable.. Done in #1710. Nope. Please feel free to file an issue.. It will always be set. I don't think we need to be defensive here.. I can appreciate that, but I'm not 100% sure that this will be the permanent implementation of this method. We might have to end up including accounting.js or similar, which we would not want cluttering up the frontend. For that reason, I want to keep this backend-only.. Using let is better for composability and is always preferred. This let actually overrides a let!(:order) higher up in the file, which the local definition would not do. This is a good thing.. There is a rake task in solidus_i18n for this purpose. This question is way outside the scope of this PR.. Good call. Done.. Probably don't need to pass both order_form and order in, since order can be found via order_form.object.\n\nIf the goal is to make the code in the form partial nicer, it would be better to just store order as a local there.. This is not a temporary fix. The frontend and backend have different javascript, different requirements, and different browser support.. This should be {{ t \"admin.table.actions\" }}. I also prefer JS, but this file was originally coffeescript and the changes were each incremental. I agree. Going to split these into separate files and also move to a different namespace, Spree.Models.Order, which will also make more sense as we add more models (like Spree.Models.Variant). Yes. this.$ is scoped within the view's element. It's great!. A fair point, I hadn't considered them changing often enough to warrant this, but I suppose if they were changed at all the existing method would be a pain to deploy with confidence.\nI've pushed up a change which combines this and the existing translations into a _js_locale_data partial. Can't be done here. At this point the model needs to be defined where we have access to url. #1715 is a follow up to this where this will be fixed.. I'd rather address this in the #1715, which is a follow up to this. This PR was intended only to be the UI change, with #1715 being a more complete switch to backbone.. .save-line-item and .cancel-line-item are still in use and also used in specs (a more dubious use).\nI'm not sure they aren't appropriate classes to have.. :+1: Excellent idea. Rebased and fixed.. Not sure about that because we need to do the lookup of mini_url/small_url, but maybe a helper. I'll investigate.. It can be done! I think it warrants further discussion. I will open a follow-up PR.. Yep, we empty the <select> on line 42.. :+1: As long as we provide deprecations.. Passing a block to find_or_create_by behaves the same as passing a block to create if the record doesn't already exist.\nWe want to do this here, because we absolutely only want to have one WalletPaymentSource per credit card, the block specifies the values if one doesn't already exist. This makes the up migration idempotent, which we want since the down migration doesn't remove WalletPaymentSources.. It would be better to use descendant_ids + [id].\nPush would append to the array descendant_ids returns which we want to avoid (I don't know whether or not that would cause a real issue, but I can't know without reading its source, so we want to avoid it). I'm slightly concerned that this change may introduce N+1 queries (and tvdeyen's suggestion 2N+1). I'm not sure about this. I think our default should be to wrap, and to specify areas where wrapping is undesirable (like actions).. This isn't worse than what was here before (bootstrap's .table sets pretty much the same CSS as we already had here). It would be ideal if we were to move away from styling all table elements like this and instead required a class. That way we avoid needing to un-style the styles when we want a table to be \"normal\".. Can't be done. This is the background of a <select>. :+1: \nI'm going to try &:hover:not(:active). When testing with just :hover it felt a little weird. When opening the select, the cursor changed from pointer to arrow and then quickly back. Using :hover:not(:active), it just switches to arrow, and stays that way while open. This is the same behaviour we get from the select2 controlled selects.. We can deal with this later. It's not a new issue and shouldn't block this PR.. opacity: 0 didn't do the trick on IE11. The \"D\" in \"USD\" was cut off, despite there being lots of room in the select box. See comment.. :+1: \nThis leaves a 1px gap on the top and bottom (height is 2.25rem == 29px), but I don't think that's a huge issue, and is worth it to avoid this magic number and ensure the input will scale well if our font size changes.. We've deprecated it, which means if a user sets $color-txt-text, they should see a warning, but it should continue working. This line (and the few below) are necessary for it to continue working. I prefer using just described_class.create in the spec for the model itself, otherwise you are testing the factory's output at the same time.\nWe probably shouldn't be using PaymentCreate in this file (that should be in the payment_create_spec.rb file), I suspect that's here because PaymentCreate replaced an some old payment behaviour.. I would like that, but I think we should do this in a separate PR. Removing this would move us from 13px to 16px (maybe), which is a really significant change, which I'm sure will cause some issues. I'd rather we look at that separately.. Right. I forgot this.\nBootstrap removed the .media-left class https://v4-alpha.getbootstrap.com/layout/media-object/ instead asking you to just specify .mr-3.\n:+1: Your padding solution is a good fix.. This isn't necessary. It's slightly off in our current bootstrap version but fixed by #1816 . Not sure about this style. Our other selects are all going to use the double-caret from bootstrap \nThis also looks quite off when the progress spinner is showing. \nI'm not sure if a dropdown indicator is needed on these inputs. The behaviour here is more like an autocomplete than a select. If one is needed we should probably use the double caret we use elsewhere. cc @Mandily @tvdeyen . It also looks off on pages where the input expands to several lines.\n. I don't this is an appropriate variable to store the colour for the card backgrounds. This value should be usable for buttons, alerts, labels etc. Like in this bootstrap example.\nThis won't work if we use it as a common background because it will totally blend in. It's also too light for use outside. \n (btn-info on the right)\nThis should probably be in a dedicated variable.. That changes the size of our rem, which I don't want to do. It's awkward that our base font size doesn't match a rem, making rem pretty useless if it doesn't match up with anything else on the page. If we're setting $font-size-base to a px value anyways we're not improving accessibility in any way.\nI appreciate the argument that using the browser's default font size is a good thing. But if we aren't (and I think it's too big a change for this PR) the way bootstrap used to do it, and the way we're doing it here, by setting a size on the root element, is best.. This is a good catch by hound. I think there's an issue here between length  being a instance method and being assigned here as a variable.. We know what all these values are, so we can probably just\nruby\ndef parent\n  @parent ||= Spree::Product.with_deleted.find_by(slug: params[:product_id])\n  @product = @parent\nend. Not easily. The regression here was that the value wasn't being sent to the server and not saved in the DB. I think this is the simplest test for that.. I think we need a different class name here. Application has too strong another meaning. I think we could avoid the sends here (but the rest of the structure looks good).. Maybe we can come up with a more obvious name to what these classes represent than Output. Maybe Spree::Tax::TaxedItem? Naming is hard.. If we move this change into the Spree::Tax::OrderAdjuster, we can keep overrides of that working (and delete the existing code in there). It's probably better to also not use .try(:id). default_wallet_payment_source == wallet_payment_source. We allow that only as legacy pre-spree-2.2 data. The current Tax::OrderAdjuster and OrderUpdater don't support it so neither should this.. I appreciate both sides here. We do want to associate tax amounts with specific items, and an ID is the most obvious and robust way to do that. That said, the more abstracted from the DB this is the better.\nIt's worth considering that passing using an ID here doesn't necessarily require that the ID is sent over the wire to an external service, the sort-by-id could be done in the extension.. This will probably be cleaner if we assert on the title (which uses the same values now). I think drivers other than poltergeist sometimes insert a space between these elements :thinking: \nexpect(page).to have_title(\"New Promotion - Promotions\")\nIf this doesn't work, though, no big deal.. The indentation here is now off. This amount of logic is awkward in a controller, especially since it's tied to the frontend. What about orders made through the admin, api, or a custom frontend?. Are we sure this should be a required field? Seems like it should only be allowed on a non_expiring category, but optional.. Why has this changed?\nIf it must change, the old methods should be aliased with deprecation warnings.. I am becoming less convinced by the need for an \"input\"-type class, but we should absolutely discuss it at SolidusConf :smile: . I think marking it @api private for now is a good compromise.\nWDYT @adammathys ?. This goes back to using the skeleton classes. Can this be updated to use the bootstrap classes (as the removed code did). One thought: maybe this should be an instance of NumberGenerator rather than the class. This would allow developers to specify a length, prefix, or letters without needing to write their own class.. Name change is fine by me, but we need to old method to be deprecated before removal.. My concern is not only that we have the API and the admin, but users may have written their own frontend. Yet this behaviour is absolutely essential for store credits to work now.\n\nI discussed this with @cbrunsdon offline because I initially had this in a before_transition to: :complete. He brought up that there would likely be scenarios where admins would want to push through an order with expired credit and having it in a transition hook would prevent them from being able to do that. In general, having it at the model level would make it hard to opt out of this behaviour if desired.\n\nI would expect the exact opposite of that behaviour to be desired. Admins shouldn't accidentally be able to use expired store credits.. That makes some sense, but are we sure that everything in an expiring category must be expiring? Or does the category mean it may be expiring. The default is :async, our dummy app's test.rb doesn't change the value.. :+1: I think you're right this isn't necessary anymore. I only needed it before including ActiveJob::TestHelper, which adds a setup step which clears this.. :+1: done. I'd prefer that this was a normal spec. As a before(:suite), this makes it impossible to run a single other spec without running this first. It also makes this not report itself as a passing or failing spec.. We probably want to keep the old field around (until the next major version). Can this rescue something more specific? It's easy for bugs to sneak in with the catchall rescue.. ditto here.. The previous code checked the equivalent of string_date.blank?, should we still be doing that (I suspect yes since we may get an empty string from the user)?. It's not without replacement. The replacement is Rails.application.config.spree.payment_methods :smile: . I'd prefer by_name_or_abbr or with_name_or_abbr. Could just be me, but I'd expect find_all to perform a query (maybe because of old rails 2.x's find(:all)?) and this just builds a scope.. I love this. Mistake. Fixed. These will be in 2.4.0. I wonder if we can simplify these cases using the new form_with :thinking: . Can we bump this forward to 2.4?. Could we move this to the 2.4.0 section. Yeah, let's tackle this later.. I'd rather not use humanize as a default. We want to see where we are missing translations (and avoid the cost of calling the inflector). :+1: done. Probably don't want to do it like this. The choice to capitalize or not is language specific, so it should exist somewhere in translations.. We probably want to keep Spree::PromotionHandler::FreeShipping as a deprecated constant.\nThis is probably a good case for ActiveSupport::Deprecation::DeprecatedConstantProxy. I believe we re-add a promotion_handler/free_shipping.rb with\nruby\nmodule Spree\n  module PromotionHandler\n    FreeShipping =\n      ActiveSupport::Deprecation::DeprecatedConstantProxy.new('FreeShipping', 'Shipping', Spree::Deprecation)\n  end\nend\n. This probably needs to check eligible? (and a spec catching that would be great). This should probably be just cancel (without the !). Instead would it be possible to do by having a user edit their vendor/assets/javascripts/spree/backend/all.js?. A YARDoc comment would be helpful here, the return values are a little confusing:\n ActiveMerchant::Billing::Response with true if the void succeeded\n ActiveMerchant::Billing::Response with false if the void failed\n* Just false if it can't be voided at this time.. Is this going to do the right thing with this removed? If so, the assignment on the previous line should be removed to make it more obvious that it is just being returned.. Changing the shipping method may change the amount of the order, so the sidebar needs updating. This will eventually be done without a reload, but is outside the scope of this PR (which is the first step towards removing it).\nThis doesn't introduce the reload, it was moved from here. I'd rather find a different solution to this. I believe I've found the issue and we should address it in a separate PR. It's not a backbone issue.\nThe is that the \"Add\" buttons from the Tiered calculators, which aren't submit buttons, but their disabled state causes chrome to not submit the form on \"Enter\". This can probably be better solved by making these buttons an <a class=\"btn\" instead.. This could probably be simpler as where(spree_taxons: { id: self_and_descendants.ids } ). This is done throughout the admin. It's pretty awkward to have a select and then an each with an unless inside it\nMaybe it would be better to either have a .select then a .reject or put all the logic inside the each?. We have a Spree::Config.require_master_price (which I don't know how widely is used but exists).\nCan we change this line to required: Spree::Config.require_master_price?. Shouldn't this require make the change unnecessary?. We can't change the behaviour of this file. We can't have it so users upgrade and the logic for displaying images on the frontend changes (I think it's likely in a ton of stores that this wouldn't be caught before production).. We define this association, so we shouldn't test for it. If this is to prepare for a future paperclip removal PR, it should be done later.. We define this association, so we shouldn't test for it. If this is to prepare for a future paperclip removal PR, it should be done later.. I think this should be removed anyways because it's a bad way to override the 404 behaviour.\nStores could regain this functionality by either:\n Using config.exceptions_app, the proper way to have a dynamic 404 page\n Setting up the rescue_from from ApplicationController\n* Class-evaling (or sending) the rescue_from (if overrides are being done anyways)\nBut I can submit this as a separate PR if it will get this merged. Right. I can't remove this because the render_404 behaviour is very unusual.\nruby\nrender status: :not_found, file: \"#{::Rails.root}/public/404\", formats: [:html], layout: nil\nThis doesn't use views, it renders the public/404.html file relative to the Rails.root directory. There's really no way to get around this, it's bad code.. I do, but can send a separate PR. Removed this change.\nReplaced the db:migrate task with a custom migration task which runs migrations one engine at a time (which simulates running railties:install:migrations before db:migrate).. I think this will also fix a spurious error we've had in this spec. Bonus!. This will generate a warning and I don't think it is necessary after a rebase (the Gemfile will cause factory_bot to be required).\nIt turns out we also don't need factories at all for this test suite, so I have removed them in #2330. no :angry: \nI have disabled this rule.. Why would this be useful? What is a developer supposed to do with this information.\nI assume this is for extension points, since we want to avoid class_evaling, maybe we should look at introducing a Spree::Config.variant_gallery_class and a Spree::Config.product_gallery_class.. I don't think this needs to be a try. Is @variant ever nil? . I'm not sure there's a need for this base class. It should be sufficient to duck-type have the two gallery classes \"quack\" similarly :duck: :duck: :duck: :duck: :duck:. We can't name a file spree.rb, because of the other file of the same name. Even with the require_relative it has potential to cause issues.. That file doesn't do much, but we should definitely deprecate it before removing it, various extensions and likely stores, which have been upgraded from spree, are expecting that require to require all of Solidus.. This is built on top of #2358, which is necessary for this to pass.. It's not clear to me why we are using two different methods here. Previously we only used one.. This needs a name more clearly scoped to what it does. We (through rials) use ActiveSupport::Inflector heavily for other things and this name shouldn't imply that we are overriding that. It should be clear that this is for URL parameterization only.\nThe question here is do we intend to use this for. If we intend to only use this class from Taxon, it should be called taxon_parametizer_class (or maybe taxon_url_parametizer_class). If we intend to move everything else over, we could call it parametizer_class (or maybe url_parametizer_class).\nIt's worth noting that  has some of its own logic and configuration for parameterization (though I believe it relies on Inflector.parameterize). I'm not sure we would want to lose that logic, but it would be nice if we generated URLs consistently.. We can either create a new class which calls parameterize then dasherize, or we can just use parameterize.\nSince we're already changing behaviour here I think it is fine to just use parameterize and update the specs to pass.. This also prompted me to move these warnings to a common ParanoiaDeprecations module.. We need to avoid referencing the Spree::StoreCredit model and the constants here.\nInstead we can define our own \"AddAmountRemainingToStoreCreditEvents::StoreCredit\" model here and use that instead.. I've added require: false here too. Before this we could probably add return if table_exists?(:spree_wallet_payment_sources). Only concern is that this should maybe be a proc. We load preferences quite early and customizations might be made to ::Money. (this is really quite an edge case, so I don't know if it's necessary, but can't hurt). Deprecating implies that this will be removed in a future version, but as far as I can tell the changes later in this file have made this entirely non-functional.. Could subscription.include? work here?. Just basically time in seconds from time rspec on my local machine. Not very accurate (my computer is a lot faster than circle), but it just needs to be an estimate. This is already namespaced within Spree::, so I'm not sure that's descriptive. It could be MOUNT_ROUTE or ENGINE_MOUNT_ROUTE or CORE_MOUNT_ROUTE. Treating SPREE_MOUNT_ROUTE as a regex is going to work fine because it doesn't have any regex characters (*, (, ., etc), but it feels like the wrong thing to do.\nThis should probably be\nFile.read(routes_file_path).include?(SPREE_MOUNT_ROUTE). `'de'` is probably not correct here. Has this been tested?. I'm pretty sure this existing line never worked. Though errors are added to the model, `deleted_at` is still set and persisted.\n\nEDIT: confirmed broken since at least 1.4. You're right. I was confused about what this was describing. We should probably change this section (in a future PR) because \"redefining\" isn't an accurate description of what happens when adding additional CSS (and is likely misleading for JS too).. :exclamation:. it seems really weird to check stores.none? here. I think this is the opposite of the direction that we should have for the \"none means all\" rule.\nI'd rather have \"shipping method with no store is available to all stores\" not \"a store with no shipping methods can use all shpiping methods\". Apparently payment methods do the same\nhttps://github.com/solidusio/solidus/blob/master/core/app/models/spree/payment_method.rb#L39-L42\nI'm not really a fan of that either. I'm not sure this syntax is valid. It fails under MySQL with\nMysql2::Error: Can't create table `solidus_core_test`.`spree_store_shipping_methods` (errno: 150 \"Foreign key constraint is incorrectly formed\"). Reading more, to_table does seem like a valid argument (I had thought it was not), but for some reason this isn't working.. Fails after\n(60.4ms)  CREATE TABLE `spree_store_shipping_methods` (`id` bigint NOT NULL AUTO_INCREMENT PRIMARY KEY, `store_id` bigint, `shipping_method_id` bigint, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL,  INDEX `index_spree_store_shipping_methods_on_store_id`  (`store_id`),  INDEX `index_spree_store_shipping_methods_on_shipping_method_id`  (`shipping_method_id`), CONSTRAINT `fk_rails_1ec4e4430e`\nFOREIGN KEY (`store_id`)\n  REFERENCES `spree_stores` (`id`)\n, CONSTRAINT `fk_rails_24cc4a3cd1`\nFOREIGN KEY (`shipping_method_id`)\n  REFERENCES `spree_shipping_methods` (`id`)\n) ENGINE=InnoDB. The issue is that this is creating an FK from a bigint to a normal size int.\nRemoved the FK entirely in in #2596. Looks great, but I'd rather not use target: \"_blank\" here. Links should open in the same tab.. I did this out of habit due to MySQL second timestamp issues, but this isn't necessary as of #2598 :tada:. I will use your suggestion.. done.. I guess the other files don't need a new locale to be autodetected. We should keep an eye out for new failures related to this, though. I know this was copy-pasted from the existing implementation, but it's weird since both methods are already defined on ProductFilters. Expecting users to remove_method as the means of customization seems quite odd.\nThis of course is probably desirable for compatibility and shouldn't block this PR.. This seems a little weird as a preference because it isn't a behaviour we properly want to support. Maybe we could add some wording here to dissuade users from setting it to false.\nMaybe:\n\nThis setting is provided to help users who have made heavy modifications to disable shipments in their store. It should not be changed.. I'm not sure it makes sense to link to the root. Maybe we should drop the link entirely (just plain text) if we don't have permissions?. I think the current_store.available_locales should apply to the frontend only. \n",
    "alexblackie": ":+1: LGTM :shipit: \n. :+1: \n. :+1: \n. :+1:\n. :+1: \n. :+1:\n. :+1:\n. Marionette is somewhat similar in what it provides, but is way more bloated and\nunnecessary. Thorax, however, is not a huge dependency and adds only some view\nhelpers and nice conventions. The Collection Views, Handlebars integration,\nContext...  Basically everything Thorax provides is something that, in our\ndicsussions, we decided would be a great help in cleaning up the admin. So many\nother frameworks try to do way to much, whereas Thorax maintains a light\nfootprint, while still providing some nice decoration on top of Backbone.\nBut primarily Thorax was added to establish conventions early on. It means we\ndon't have to worry about trying to decide about where things should go or how\nthings should work, nor have to write and maintain a bunch of infrastructure\ncode to build parts of Thorax features ourselves.\nIt is yet another dependency, but the general consensus was it provided things\nwe would end up building ourselves anyway so it was worth pulling in.\n. :+1: \n. nice\n. nice\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. nice\n. :+1: \n. :+1: \n. I got around it by injecting config.action_mailer.raise_delivery_errors = false into the production environment config.\n. Looks like the sandbox repo had some of its commits go missing, so the config line is missing. With the config change I mentioned it will deploy.\n. I think we're stuck with Heroku's, unless we want to make our own image. A nice middle-ground could perhaps be some explanatory text around it.\n\nWant to try out Solidus? Deploy a demo store: [Button]\n. @bbuchalter Currently it's living on the Stembolt Jenkins, which is not ideal (but was easiest and fastest). Will talk IRL with @jhawthorn on Monday to see if we can get it in Travis or something.\n. LGTM! :+1: :heart: \n. I definitely am the opposite.\n. I was looking at it from the method definition perspective; i.e., we don't explicitly define cancel... I'm fine with describing all callable things as methods if it would be less confusing.\n. No reason at all.\n. I think removing it was a mistake.\n. \n",
    "jarednorman": "Fixed a typo.\n. Remember that AMS has global configuration, so if stores have AMS already and have it configured it differently that we configure if, this may present a non-trivial upgrade cost to those stores. This is the same reason we can't even consider using something like simple_form on the backend.\n. They do the same thing. The other one just reads better. I assume someone formatted the code more nicely and then a bad rebase happened that brought back the old version.\n. Looks like this is done.\n. :metal:\n. @jhawthorn All the typos would have been caught by now if I did!\n. Perhaps a better explanation in the commit body is warranted, as lots of people tend to assume Ruby's protected works like other languages' protected.\n. :sparkles: The Singleton Wizard approves! :sparkles: \n. @Sinetheta Thoughts on testing this?. This all looks quite sensible. :100:. I can't imagine it's worth the effort of doing that up front if the existing helpers aren't being deprecated.. I imagine that stores that drop the \"delivery\" state in order to not build shipments must be depending on other customization beyond just removing the state. If it's something you want to support in some meaningful way, then maybe we need to add make this a configuration option of some kind. If not, then I'm fine with just a new method.. I'm in favour of this change. I know we've had some minor incidents before, having personally assisted in the resolution of some, but there was no official process or rules to govern that, nor expectations laid out.\nI tend to agree with @mamhoff's points about what's missing here, and with @stem that using the Contributor Covenant is a good option.. I've been live streaming myself working on this. Here's the YouTube playlist of past streams.\nThe biggest issue I've run into so far is that there are some really annoying incompatibilities with newer versions of CanCanCan. I've been running against the branch that has Rails 6 support, and it's caused a whole bunch of unrelated issues.\nI'll continue working away on that. I haven't opened a progress PR because I'm waiting on releases on a bunch of the gems that will need to be bumped to support Rails 6. Currently I'm just pointing at various GitHub branches that contain the tentative work on Rails 6 support for those gems.\nI've got core passing, and backend/frontend almost completely passing if I comment out the stuff in the permission sets that are causing the CanCanCan headaches. API is full of failing specs and I haven't dug into that, but I imagine it's at least partially related to the authorization issues.. Yeah, I'm personally pretty indifferent on this one (though it would be nice,) but if we do it, we definitely have to go with whatever approach causes the least problems.. > There is nothing preventing you to not use Rails::Engine, but you will have to require manually your files and do yourself all the steps that engines do take care of: initialization hooks, generators (migrations and such), assets, locales, etc.\nAll true, but the tool for generating new extensions makes them engines by default, and I agree with @dustineichler that this is not a good pattern to encourage.\nI've tried to follow what I think are a better set of practices for building extensions on recent stuff: normal gems (not engines), no class_eval/prepend, etc.\nI personally think encouraging building them like that, and potentially moving some extensions over to something more like that would be great.. I'm very surprised that you don't see an issue with class_eval/prepend. Maintaining a system of dozens of extensions where all of them can modify the behaviour of each other has been both a burden on maintainers, as well has caused many bugs.\nIt essentially locks even private class APIs in place because extensions may be relying on them. In talking with our previous full time maintainer, he considered it one of the more painful pieces of maintaining the project, because every store has either class_evaled some random things, or has extensions that do it, and if anyone moves logic around in core classes they're liable to just randomly break a bunch of stuff.\nI see our adoption of class_eval/prepend is a significant burden when it comes to stores keeping up with latest releases, and with maintenance in general. It's certainly been my experience that well-defined extension points offer a much better experience for both store and project maintenance, and that seemed to be the consensus during the group discussions at Southeast Solidus, but I'm curious how other people feel.. @patleb We should take a step back a here, as we've gone way off into the weeds. There's a huge disconnect happening between us in this conversation: @dustineichler was trying to continue a specific discussion from Southeast Solidus, but unfortunately didn't provide any real context for those who missed out on that conversation.\nI totally appreciate that you're largely happy with how the extensions currently work and as such might be worried about unnecessary changes. Let's try to keep the discussion constructive and focus on ideas that have been explicitly suggested and avoid speculating too much. No one is suggesting replacing bundler, or banning the use of class_eval.\nFor a little more context: at the conference there was a discussion where some people expressed pain with how we currently handle extensions, and we discussed where we thought the trouble was coming from, and how we might alleviate it.\nI think the goal here should be to continue the extension conversation from Southeast Solidus and hear from more people on where they are having issues and brainstorm on how we can address those issues.. Yep, all totally understandable, and I didn't mean to imply any bad faith when I suggested we keep it constructive, only that we'd got way off track from the original/intended discussion (which is fair due to the lack of explanation/context.) Have a good rest of your weekend! \ud83d\ude04 . Integrating my extension involved adding some views/routes/controllers/models for one of the stores that I integrated it with. I very intentionally didn't provide certain things out of the box: for example, I didn't include the state machine transitions and jobs to do transaction reporting because not all the stores I'm using it with need that functionality, and doing it properly would require assuming the use of active_job.\nInstead I've provided the API required to do the reporting, and am going to document how to integrate that with your store, including making clear some of the things that may be different from store to store. \nOn top of this, I'm considering providing the extra admin functionality as its own extension, as well as  active_job based transaction reporting as another.\nThis is all to say that the core functionality for some extensions might belong in its own package, and the state machine transitions, routes, controllers, views, models, etc. might belong in another package for those stores that don't need anything too custom and want a \"works out of the box\" experience can have that as well. Using this approach doesn't change how anything works for those currently using existing extensions, but might provide some extra flexibility for the stores that want it.. Alternatively, it's not unreasonable to have solidus_cmd do a little more, like set up the test suite, require in the solidus factories, provide a default CI config with up to date version matrix, etc.\nJust a thought.. Document attributes right above their attr_*, not in the class docstring. I'd expect that to be a class attribute.\n. Also @seantaylor, you're busted. This attribute is doc'ed as being [rw] but it's actually only a reader!\n. Prefer \"this product\" rather than \"the product\".\n. Sorry Sean, it is writable but @alexblackie moved things around so the writer was way down the file. :-1:\n. You can skip the the method summary and have it autogenerated just by providing a good return doc, like @return [Array<Spree::Variant>] all variants that have at least one option value. Cleaner imo.\n. And you don't really need to duplicate here, you can kill the method summary. The auto-gen'ed one from the return will be good enough.\n. the desired new value?\n. Kill method summary, @return [Array<Spree::Promotion>] all advertised and not-rejected promotions\n. @return plz <3\n. Everywhere!\n. Typo \"defaut\".. I'd probably just write this as\nruby\n<% if carton.tracking_url %>\n  <%= link_to carton.tracking, carton.tracking_url, target: \"_blank\" %>\n<% else %>\n  <%= carton.tracking %>\n<% end %>\nbut either way this seems fine.. ",
    "seantaylor": ":+1: \n. test this please\n. test this please\n. :+1: \n. :+1: \n. :+1: \n. :+1:\n. :+1: \n. :+1: \n. Green is good :+1: \n. @athal7 right you are, thanks. I'm pro just removing it. Will do in separate PR.\n. @jordan-brough agreed thanks. Made that change.\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. Also ran into this issue on a store. \ud83d\udc4d  for getting this in. Seems reasonable to me.\n. Thanks, I didn't know about that one!\n. I'm not sure that I agree with that. These numbers do come from the default factory values and I think that if you change the default values, you should expect to change test expects. It seems much less explicit to sum it yourself, vs testing against the actual values/objects Im expected to get back.\nBut I'm open for debate on it.\n. @jarednorman tsk tsk.\n. I'd always prefer to not mix up ruby inside of html. \nruby\n<%= content_tag :tr, class: 'line-item', id: \"line-item-#{item.id}\", data: { line_item_id: item.id } do %>\n. This file doesn't actually include any js or erb. I would ditch those extensions and just use .html since that's all we actually have in this file.\n. We don't have multiple formats of this file, so specifying format isn't needed.\nI would also prefer the newer (better :) ) partial syntax:\nruby\n<%= render 'spree/admin/products/sortable' %>\n. You should use pluck(:id) instead of the map here for moar speeeedddddd :)\n. ",
    "athal7": ":shipit: \n. :+1: \n. :+1:\n. i like where this is headed!\n. sounds like we were all circling on an alternative approach to this. ok to close?\n. :+1: \n. :shipit: \n. @solidusio/owners & @philbirt this is now ready for review. passes manual testing as well. just haven't been able to throw avatax into the mix, but i think that should be dealt with separately.\n. @gmacdougall thanks for the feedback! it should all be addressed now\n. @gmacdougall i think i've addressed all of your feedback, let me know if you have any other thoughts.\n. @solidusio/owners @philbirt all good to merge?\n. e63145d\n. :+1: \n. we don't use taxons, so i'll defer to the people who do on this review\n. :+1: \n. :+1: \n. :+1: \n. i think we are taking a step forward with your second approach. would a good first step to integrating be to replace pieces of order contents that were introduced in 2-2-dev?\n. @cbrunsdon going to close this for now just to try to clean up the PRs\n. the controller itself doesn't seem to provide any behavior above the resource controller. i'd vote for removing the decoration in the controller as well as this spec file entirely.\n. :+1: \n. :+1: \n. :+1:\n. :+1: \n. :shipit: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :ship: :it: \n. this looks like it could be a great way to handle fixtures! only concern i have is that running a single spec could get slower as more fixtures are added, as happens with our Bonobos fixtures implementation. It doesn't seem like there is a way to lazy load because of the transactions, right?\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. @gmacdougall you may be right, possibly in stock coordination.\n. @gmacdougall i like that idea better\n. @gmacdougall updated\n. fancy! :shipit: \n. I agree with @gmacdougall. Also - I would have preferred if you had chosen to comment on the previous pull request for further discussion as opposed to bringing out the revert hammer here, feels like a bit strong of a response to me.\n. @Senjai no worries, thanks\n. :+1: \n. @jhawthorn i don't find the :-1: comment productive here. we are all aware that we want to put these in a different place and have a plan about how we intend to do so.\n. :+1:. would appreciate further conversation offline about this\n. Since @philbirt wrote the code and I'm just submitting the PR, I think a :+1: from me will suffice on the Bonobos side, merging.\n. Since @jordan-brough wrote the code and I'm just submitting the PR, I think a :+1: from me will suffice on the Bonobos side, merging.\n. @gmacdougall sorry about that, forgot to pull the explanation over from the previous pr. added now. not sure why yet re the spec failures. @philbirt is going to look into it\n. Yes!! Very excited about this change and this approach!\n. :+1: \n. nice work!!\n. :+1:  for the record I was fine with it in the other PR as well\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. lgtm\n. i trust your cherry-picking abilities\n. :+1: looked through all of the commit messages with conflict comments and they all seem to be good!\n. :+1: \n. :+1: \n. i'm :+1: on this.\n. i second Magnus's comment\n. looks good to me\n. :+1: \n. pulled out from https://github.com/bonobos/spree/pull/412\n. @gmacdougall updated\n. merged the frontend-viewable pr into this one, will merge once it goes green\n. Jenkins test this please\n. the failing specs pass for me locally, seems something is going on with the rack version?\n. @magnusvk rebased. @gmacdougall thanks for the feedback, i think it is addressed now\n. @solidusio/owners this is ready for review now.\n. @cbrunsdon i was afraid as well, we've had this running on our store for a few weeks now and haven't seen any adverse affects yet.\n. :+1: \n. :+1: \n. :+1: \n. merging since https://github.com/solidusio/solidus/pull/81 and all dependent PRs were :+1:-ed\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. lgtm\n. :+1: \n. :+1: \n. Can you say a bit more about the Kernel.srand line?\n. :+1: \n. :+1: \n. :+1: \n. ah i see, you renamed the association. i think we had different ideas here. i was thinking maybe renaming the entire table / model? but maybe that is too painful.\n. :+1: for this and the related bonobos/spree cherry-pick\n. do we want to still point people at the stable build? it looks like maybe that was removed?\n. Never mind it's higher up. :+1: \n. :+1: \n. :+1: \n. :+1:, maybe just check that some of the extensions work with this. i remember auth_devise and multi_domain failing from the url sequence\n. :+1:\n. :+1: \n. is there an option in the UI to process a payment in this scenario?\n. very nice work here\n. :+1: \n. @jhawthorn sounds good, thanks for looking into it\n. @cbrunsdon can you say more about that mapping system? I'm curious to understand what you mean by that. happy to chat about bundles anytime\n. Thanks for the write up. That's my understanding of the options as well\n. :+1: \n. :+1: \n. lgtm\n. i trust that this works since it's good for us from the original extension PR\n. :+1: \n. :+1: this is a great summary / start. thanks @cbrunsdon for organizing these and for all of the background / history on the linked issues\n. @cbrunsdon I think the latter parts of item 2 are vaguely captured here: https://github.com/solidusio/solidus/issues/147\n. closing in favor of https://github.com/solidusio/solidus/milestones/Future\n. :+1: \n. I'm all for keeping the mapping of carton to real world boxes, so to me it seems that option 1 is the only way to achieve that.\n. i may be seeing this wrong, but it seems to me it's still possible to view and update preferences even when loading from a yml file? i think this is a good first step, but i'd probably want to not have the configs viewable in the UI or stored in the DB if they are specified via in-memory preferences\n. :+1: \n. :+1: \n. is this for editing the payment method itself or for adding payments? usually it is not preferred to add store credit payments manually since they are auto-added, but if it is for configuration then :+1: \n. I think this looks great! Curious to hear some opinions about how separate we desire this promotion rule to be from the FirstOrder rule.\nI see 3 options:\n1) (as in this PR) wholly separate \n2) deprecate FirstOrder \n3) have FirstOrder subclass NthOrder\nThe latter two seem to me to have a downside of a slow data migration, which leans me towards the current approach, but I'm curious if others see an easier upgrade path if we were to go for more shared code / fewer promotion rules. \n. the code does not support the ability to add store credits via admin, it is only designed to work with auto-adding of store credit.\n. ah my mistake\n. hm that is odd, i would expect https://github.com/solidusio/solidus/blob/master/core/app/models/spree/variant.rb#L21 to touch the product?\n. hm you are right, looks like this change isn't necessary / positive. closing\n. @jhawthorn a ha, here's the difference:\nspree 2.2:\nhttps://github.com/bonobos/spree/blob/2-2-dev/core/app/models/spree/option_value.rb#L18\nsolidus:\nhttps://github.com/solidusio/solidus/blob/master/core/app/models/spree/option_value.rb#L17\npersonally I'd rather this approach:\n- properly touch the related variants on touch and on save (let the variants touch their product)\n- remove the option_value -> option_type touch \nI favor this because option_types are more likely to be shared across products than option_values, and that's where we run into trouble with lots of touches. I'm curious what your opinion is though.\nUpdated to reflect that approach\n. yea exactly it won't help with the multiple variant -> product touch, but it will reduce the product touch through the option_type.\n. :+1: \n. :+1: this seems much safer and what is intended\n. :+1: \n. IMHO this is a bit heavy handed. These pieces of the system are tightly integrated into the checkout flow, and trying to extend them from outside of core has the risk of being brittle. Plus they are beneficial to many stores.\nWith that said, we have chatted internally about making the tax code easier to use, with defined extension points whereby one could easily attach their tax vendor of choice, which I think would solve your concern about tax (let me know if not). Regarding promotions, I would be interested to hear more specifics around what your frustrations are, as we probably have similar ones, and we can try to improve it in this codebase.\n. very good, this should be covered by https://github.com/solidusio/solidus/issues/171 and https://github.com/solidusio/solidus/issues/147 then. closing\n. :+1: \n. is ContentController#cvv used?\n. :+1: \n. :+1: \n. :+1:\n. :+1:\n. I wonder if we even need the environment column here anymore. Maybe we could remove it instead?\n. hm this isn't quite what I was suggesting because for stores who still do have the environment column the payment method would be unusable. I was suggesting we remove the column from the table itself.\n. if a store is upgrading and doesn't run the seeds, they would miss out on this data right? that seems less than optimal\n. that too :)\n. just waiting for specs to pass on the initial iteration\n. :+1: \n. i actually don't think it is necessary. removed\n. @gmacdougall I don't believe that's an option on has_many, just on belongs_to http://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html\n. @jhawthorn it's a bit tricky because this is kind of a catch-all for orders that are supposed to be in the confirm state (i.e. have payment, items, and address information), but for some reason (state machine?) have not quite made it into the confirm state.\n. @jordan-brough might have more information about this situation, its causes, and why this is the current approach. i'm happy to work to make it better, would like to get this iteration out as well to re-enable servicing of these orders & because this was the behavior / specs in bonobos/spree before the upgrade.\n@jhawthorn does that work for you?\n. @jordan-brough that makes sense. can you help us understand more about how orders get into this state? is it when denormalized calculations don't add up to other totals?\n. :+1: thanks for the explanation\n. :+1: \n. :+1: \n. Personally I would vote for moving the logic into Solidus since we are hoping to deprecate that extension anyways. If not, I like how you have implemented the ability to support the old method signature. \n. :+1: on this change, interested to pull the multi-domain change into this codebase as well\n. very nice work\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. i'd be interested in putting an even more explicit hook into update_cart so that we don't need to override the method.\n. if you'd like...\n. just curious if you considered making a promotions#show route instead to be more consistent with the approach we've taken for other items here.\n. :+1: \n. do you mind adding a spec?\notherwise this is :+1: \n. :+1: \n. do we want to do another round to move other configurations (e.g. returns) over similarly?\n. yep, issue here: https://github.com/solidusio/solidus/issues/282\n. I'm :+1: on this approach & removing https://github.com/solidusio/solidus/blob/master/core/app/models/spree/permission_sets/restricted_transfer_management.rb. To me, this is the full realization of the intended feature when user -> stock location mapping was enabled. If we were to have that mapping just scoped to the other permission set, then it would be easier to unintentionally override the stock location restriction with a full stock location permission set unless you are intimately familiar with every permission set for a role.\n. I could get behind that, as long as there is a RestrictedStockDisplay and RestrictedStockManagement in similar to the RestrictedTransferManagement permission sets.\n. :+1:\n. closing, going to open as part of different PR\n. From my perspective, we would be open to adding immutability for use cases where it makes sense for the model to be immutable, not just for the sake of immutability.\n. @tesserakt not necessarily, as long as there's a clean upgrade path. :+1: on elixir :)\n. :+1: \n. For what it's worth I think a pub/sub approach similar to whisper internal to solidus could have some code organization benefits, but could encourage worsening of implicit behavior rather than encouraging explicit behavior.\n@jordan-brough for me an ideal state would be that way have a gateway interface for adding a credit card (whether it be to an order or optionally just to a user) where, post-success, we kick off a delayed job through ActiveJob (to prevent failures from giving a failed the credit card addition response) that does 'credit card address verification', which can be a no-op for default payment methods, but happens to do something in the payment method you care about.\n. :+1: \n. :+1: \n. is this now going to ignore params entirely?\n. Yea I think you're right. \ud83d\udc4d. Just be careful with this, I think it might be an extension point that at least we use. \n. A poor extension point, but an extension point nonetheless\n. :+1: \n. :+1: \n. :+1:\n. i like this approach. :+1: \n. :+1: \n. :+1: aside from spec failures\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. since we are doing one email per order, do we want to reduce the items that are included in the mailer to only be the items for that order? currently it shows all items in the carton https://github.com/solidusio/solidus/blob/master/core/app/views/spree/carton_mailer/shipped_email.text.erb\n. :+1: \n. @jhawthorn there might be some rare cases where an admin/superuser might need this functionality, I think it could make sense to handle this in permissions for the time being. I could be convinced otherwise though.\n. I'd be in favor of not using our own variant of delegate as well.\n. @jhawthorn are there a lot of cases where that is necessary? if so, :+1:, if not I think I'd rather do a find or build in explicit code.\n. I do like that proposed approach better\n. :+1:\n. @BenMorganIO I'm all for a V2 if we have/desire breaking API changes. As long as the API contract is consistent here, I think we can do this refactoring in V1. And hopefully it will make the V2 build easier as well.\nI'm curious to chat through (on a separate thread maybe here) what you are looking to see from a V2, since I think a lot of people have opinions.\n. @jhawthorn updated to authorize on new. I still think it makes sense to return an empty set and 404 respectively for index / show as opposed to 401ing, but happy to chat it through more.\n. ping @solidusio/owners curious to get some more eyes on this\n. @hhff updated\n. very nice! do you want to keep these as separate commits or squash before merge?\n. :+1: \n. looking good\n. :+1: \n. fantastic :+1: \n. i would vote for keeping these as protected, no harm and leaves a bit more flexibility for extension. https://github.com/solidusio/solidus/pull/338/files#diff-65b40bbcedba89897613ce6d5becb581R12 in particular I would expect to be used by subclasses\n. derp :+1: \n. :+1: kill it\n. :+1: \n. looks great. do you mind squashing then we can merge when we get a review from FRT\n. spec plz, otherwise :+1: \n. :+1: \n. :+1:. Just a note that category items are not a Solidus-specific thing, but this will help invalidate the product rabl cache  when a product gets a different set of option types. If you wanted, a spec around that could be useful.\n. Thanks for laying out the options @jordan-brough, and nice work with the subclass spec. My main concern is that we have been talking about the 'public code api' as not being inclusive of private methods, and usually private methods are safe to factor out, change the name, change the arity, or change the behavior. With this type of approach, it is a bit better having specs as you have added, though I still think that it is easy to miss which non-public methods are expected to be overridden / customized, and therefore would prefer something other than method-override for recommended customization.\n. I would be on board with some sort of tagging marking it as public api, plus specs similar to the ones you've written Jordan. \n. @BenMorganIO it's worth taking a look at React as well. We've been having a lot of success / enjoyment with it on our frontend. Would be happy to share knowledge\n. @BenMorganIO I'm curious to hear more about your specific negative experiences with React. We've actually found it quite easy to sprinkle a bit in here and there along side other js structures and significant server-side rendering, and found it to be quite opposite to Angular in terms of pulling you into its own world and opinionated-ness, given that React itself is just the view layer. Additionally, some of the Flux frameworks allow the use of non-react view components.\n. Thanks for the detailed comparison of your experience @hhff. Very helpful context!\n. I wonder if some of these could also be able to be solved by https://github.com/solidusio/solidus/issues/419 with promotion rules for the situation (e.g. item quantity greater than, ship address country equal, email address in list)?\n. @alexstoick yes!\n. i like that suggestion better, updated and also gave clear the same treatment\n. we do have a nil check on line 78 as well, does it make sense try to to combine these nil checks in some way? :+1: \n. :+1: \n. @jhawthorn @Senjai updated with days ago. @jordan-brough updated with rename. @magnusvk updated to be greater than 0\n. I agree this does seem heavy-handed. @magnusvk I'm not sure it removes all management ability though, can you say more about what you're seeing?\nThis solely restricts editing information on the users table (and user addresses because the controller is setup a bit oddly). Orders, returns etc can still be managed. As far as being even more fine-grained about which fields on the users table are able to be managed, I struggle with a way to implement that without removing all of the places that call update_attributes on a user. I'm open to ideas though.\n@jordan-brough yes you're right, if user roles are used for other things, then it would not be possible to for an admin to do things where we check user authorization. That does seem less than ideal. I'm curious how often that happens, but also, struggling for an alternative solution without developing a role access hierarchy.\nFor reference, here are a few places we check user authorization to manage:\nhttps://github.com/solidusio/solidus/blob/master/api/app/controllers/spree/api/resource_controller.rb#L34\nhttps://github.com/solidusio/solidus/blob/master/backend/app/controllers/spree/admin/users_controller.rb#L40 (through resource controller)\nnotice we do not check the ability to authorize a user here\n. @magnusvk @jordan-brough one other idea that comes to mind - in those controllers, we could call something like user.safe_update_attributes(current_ability, user_params), that in the model would check for if the email address is being set in user_params and make sure the ability can :update_email on the user. maybe that would be more appropriately restrictive?\n. I like that idea. What would the behavior be if a user without that ability tries to change the email? The default with that approach would be to silently just update the fields they have access to, and ignore the other fields, which could be confusing.\n. I like that idea. What would the behavior be if a user without that ability tries to change the email? The default with that approach would be to silently just update the fields they have access to, and ignore the other fields, which could be confusing.\n. that sounds fantastic, will work on that and let you know when it's updated\n. that sounds fantastic, will work on that and let you know when it's updated\n. @jordan-brough see the new implementation here: https://github.com/solidusio/solidus/pull/421. closing.\n. @jordan-brough see the new implementation here: https://github.com/solidusio/solidus/pull/421. closing.\n. this is a great start!\n. this is a great start!\n. @jhawthorn personally I would lean towards explicitness here rather than ease of migration. \n. @alexstoick a few of the folks on the core team chatted about the question re explicit association to stock locations, and this is what we propose:\nadd a boolean to spree_shipping_methods that, when true, allows this shipping method to be used by all stock locations. We can make that boolean true by default, and have the UI of selecting stock locations for a shipping method only visible when that boolean is unchecked.\nHow does that sound?\n. @alexstoick a few of the folks on the core team chatted about the question re explicit association to stock locations, and this is what we propose:\nadd a boolean to spree_shipping_methods that, when true, allows this shipping method to be used by all stock locations. We can make that boolean true by default, and have the UI of selecting stock locations for a shipping method only visible when that boolean is unchecked.\nHow does that sound?\n. @alexstoick thanks!\nre the boolean, maybe something a bit more explicit would be an improvement? e.g. supported_by_all_stock_locations\nre the shipping_methods method, did the suggestion I provided not work for you?\n. @alexstoick thanks!\nre the boolean, maybe something a bit more explicit would be an improvement? e.g. supported_by_all_stock_locations\nre the shipping_methods method, did the suggestion I provided not work for you?\n. @Senjai just checking in on how the investigation is going\n. @Senjai just checking in on how the investigation is going\n. :+1: on this and on apply_automatically\n. :+1: on this and on apply_automatically\n. @tomcartwrightuk go for it!\n. :+1: does it make sense to include model errors in the failure case?\n. :+1: does it make sense to include model errors in the failure case?\n. :+1: \n. :+1: \n. @solidusio/owners - looking for a Stembolt review here\n. @solidusio/owners - looking for a Stembolt review here\n. \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. this should fix the failing specs on master\n. @gvaughn no not the specific model methods, those authorization checks were called out specifically in the controller: https://github.com/solidusio/solidus/blob/master/api/app/controllers/spree/api/address_books_controller.rb#L25\n. :+1: \n. :+1: \n. @Senjai since we realized that request specs were not going to work with any stubbing approach, I've made an update here to still make changes at a process level, but in a different way so that we can still get the benefit of testing with permission sets.\n. @Senjai since we realized that request specs were not going to work with any stubbing approach, I've made an update here to still make changes at a process level, but in a different way so that we can still get the benefit of testing with permission sets.\n. @soliddusio/owners @Senjai all green now\n. @soliddusio/owners @Senjai all green now\n. @jhawthorn possibly yes if we build a new permission set, maybe we could issue a deprecation warning though? for the support of permission sets, i think using that syntax for testing masks real issues more often than not.\n. @jhawthorn possibly yes if we build a new permission set, maybe we could issue a deprecation warning though? for the support of permission sets, i think using that syntax for testing masks real issues more often than not.\n. @jhawthorn updated to support the old syntax with deprecation warnings.\n. @jhawthorn updated to support the old syntax with deprecation warnings.\n. hm these pass locally\n. hm these pass locally\n. @jhawthorn imo with the new permission sets implementation, the cancan rules provide the most value in tests only at the unit level (though maybe controller as well, which would warrant removing the deprecation warnings). once we get into feature-level specs, I think we will get tremendous value out of asserting that people with certain permission sets can do certain things as is evidence by the bug that was masked (actually still is) not allowing people with the user management role to manage user addresses (see https://github.com/solidusio/solidus/issues/450).\n. @jhawthorn imo with the new permission sets implementation, the cancan rules provide the most value in tests only at the unit level (though maybe controller as well, which would warrant removing the deprecation warnings). once we get into feature-level specs, I think we will get tremendous value out of asserting that people with certain permission sets can do certain things as is evidence by the bug that was masked (actually still is) not allowing people with the user management role to manage user addresses (see https://github.com/solidusio/solidus/issues/450).\n. updated to maintain support for anonymous permissions in controller specs\n. updated to maintain support for anonymous permissions in controller specs\n. ping @jhawthorn @jordan-brough \n. ping @jhawthorn @jordan-brough \n. @mbj thanks for the feedback. I welcome code reviews even from people who I do not explicitly ask. updated\n. @mbj thanks for the feedback. I welcome code reviews even from people who I do not explicitly ask. updated\n. will rebase before we merge\n. will rebase before we merge\n. @mbj https://github.com/solidusio/solidus/pull/467\n. @mbj https://github.com/solidusio/solidus/pull/467\n. @mbj sorry I meant let's have the commit amending discussion on that PR\n. easiest to review the relevant code (second commit) in this PR using this link\n. @jordan-brough do you mind taking a look\n. :+1: \n. :+1: \n. :+1: \n. looks great, is it worth adding a data migration to backfill the sale column for any promotions that people currently support as sale promotions?\n. :+1: \n. @BenMorganIO I have similar frustrations with the admin resource controller, which is why the api resource controller is slim. I can't speak for everyone, but I at least have an intention to keep it slim that the code is explicit enough. I would find it helpful here if we debate specifics of the implementation, rather than the abstract concept of code-sharing.\n. :+1: \n. I'm :+1: on this since i'm not sure of a better way.\n. :+1:\n. @jasonfb It's less about moving slowly, and more about having the updates to Solidus be easy for stores to upgrade, and having the commits be single-purpose so that they can be easily identified or rolled back as necessary. If there is important cleanup work on products as well, let's evaluate that separately (even if before) from the available_until feature.\n. @jasonfb sounds good, I like fixing nil bugs too though :)\n. Sounds great :+1: \n. I've personally had troubles with Travis' stability, but not opposed to giving it another shot.\n. :+1: \n. :+1: \n. :+1:\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. @stewart can you link the line that excludes the shipment total in the order.total calculation? I see it included here https://github.com/solidusio/solidus/blob/master/core/app/models/spree/order_updater.rb#L72\n. I can't speak for what the average store wants because we have highly customized logic, but total == 0.0 seems reasonable to me.\n. @dangerdogz when does the table usually get created?\n. @dangerdogz can you link to the place where that table is usually created please\n. per offline chat with @dangerdogz, we think a good path forward here would be to move the store creation to the seeds file, then the migrations would go fine, and db:schema:load could also be used.\n@jhawthorn curious if you have more context here and whether that will cause any issues\n. I kind of like having the accessible_by scope there just as an added measure of comfort since shipments can leak a lot of information.\nAlso do you mind adding specs for the other routes that you are having 401.\n. looking great! if you want extra completeness, you could add a spec for 404 when an invalid shipment number is specified. but :+1: aside from that context naming inconsistency\n. :+1: \n. :+1: \n. :+1: \n. \ud83d\udc4d\n. \ud83d\udc4d\n. @alepore agreed re settings, maybe we don't require that all top level menus are clickable, just the ones that make sense to me. Also in favor of splitting products and taxons.\n. :+1:\n. seems like a good change to me. since we are adding public api (and particularly since it isn't called anywhere), maybe some method-level documentation would be good\n. ping @jhawthorn @gmacdougall \n. :+1: \n. :+1: \n. @jhawthorn the most recent spec failures do seem unrelated to me, but i know that generally we have a stable build: https://circleci.com/gh/solidusio/solidus/1365. thoughts?\n. the 'admin' action is super confusing, and possibly needs a rename. all that 'admin' gives you access to is the top-level nav tab. different from 'manage', which is an alias to access on all actions.\n. ping @jhawthorn @gmacdougall \n. yea the naming is a bit confusing, though I'm not sure a better one. Here is the code path:\nhttps://github.com/solidusio/solidus/blob/master/backend/app/views/spree/admin/stock_transfers/index.html.erb#L25 ->\nhttps://github.com/solidusio/solidus/blob/master/backend/app/controllers/spree/admin/stock_transfers_controller.rb#L104 ->\nhttps://github.com/solidusio/solidus/blob/master/backend/app/controllers/spree/admin/stock_transfers_controller.rb#L146-L152\n. @jordan-brough @gmacdougall @jhawthorn updated, hopefully this is more what you had in mind\n. @jordan-brough transfer_to and transfer_from were introduced in 1.1.0.pre https://github.com/athal7/solidus/commit/35e18b3cb68e484c4c7fba7bedd6e89b9a08ff01, so I don't think that is necessary\n. :+1: \n. :+1: \n. :+1: \n. How about a separate promotion rule e.g. OneUsePerEmail ?\n. That is correct, the default logic only takes into account adjustments, not refunds.\nA few ideas that come to mind to resolve this for your store:\n1) Register a different refund amount calculator\n2) Have your admins create an adjustment prior to the refund\n3) We could consider taking refunds into account in the default refund amount calculator, though I would have to dust off some cobwebs as to why they were originally excluded.\n. :+1: \n. This seems like a good improvement to the line item creation api.\n. :+1: \n. :+1: \n. :+1: \n. I think this is a great change, I'm wondering if there are other places we want to catch as well (e.g. line item creation)\n. :+1: \n. :+1: on this and on @jhawthorn's suggestion\n. :+1: \n. :+1: \n. :+1:. Was a bit thrown by the allow_blank and allow_nil paired with the presence validation. The performance benefits make sense to me, I wonder if a comment would help to not trip up future contributors though?\n. @tanmay3011 hm yea that does seem excessive. would it save the extra query if you removed the presence validation instead and changed allow_blank to false? that would be a bit less confusing IMO.\nIf not, :+1: \n. @tanmay3011 I think I'm missing where the query count is reduced, can you say more? Here's my own little test:\nbefore adding allow_blank:\nruby\nirb(main):001:0> Spree::AdjustmentReason.create!(name: \"foo\", code: \"bar\")\n   (0.0ms)  begin transaction\n  Spree::AdjustmentReason Exists (0.1ms)  SELECT  1 AS one FROM \"spree_adjustment_reasons\" WHERE LOWER(\"spree_adjustment_reasons\".\"name\") = LOWER('foo') LIMIT 1\n  Spree::AdjustmentReason Exists (0.1ms)  SELECT  1 AS one FROM \"spree_adjustment_reasons\" WHERE LOWER(\"spree_adjustment_reasons\".\"code\") = LOWER('bar') LIMIT 1\n  SQL (0.3ms)  INSERT INTO \"spree_adjustment_reasons\" (\"name\", \"code\", \"created_at\", \"updated_at\") VALUES (?, ?, ?, ?)  [[\"name\", \"foo\"], [\"code\", \"bar\"], [\"created_at\", \"2015-12-07 14:26:44.287782\"], [\"updated_at\", \"2015-12-07 14:26:44.287782\"]]\n   (0.8ms)  commit transaction\nafter adding allow_blank:\nruby\nirb(main):002:0> Spree::AdjustmentReason.create!(name: \"foo\", code: \"bar\")\n   (0.1ms)  begin transaction\n  Spree::AdjustmentReason Exists (0.1ms)  SELECT  1 AS one FROM \"spree_adjustment_reasons\" WHERE LOWER(\"spree_adjustment_reasons\".\"name\") = LOWER('foo') LIMIT 1\n  Spree::AdjustmentReason Exists (0.1ms)  SELECT  1 AS one FROM \"spree_adjustment_reasons\" WHERE LOWER(\"spree_adjustment_reasons\".\"code\") = LOWER('bar') LIMIT 1\n  SQL (0.4ms)  INSERT INTO \"spree_adjustment_reasons\" (\"name\", \"code\", \"created_at\", \"updated_at\") VALUES (?, ?, ?, ?)  [[\"name\", \"foo\"], [\"code\", \"bar\"], [\"created_at\", \"2015-12-07 14:20:24.484747\"], [\"updated_at\", \"2015-12-07 14:20:24.484747\"]]\n   (1.5ms)  commit transaction\nYou probably have a deeper understanding of this and I'm just missing where to look, but just want to see it through because of the introduced code complexity :).\n. I did, and also entirely rebuilt the sandbox just to make double sure.\nOn Mon, Dec 7, 2015 at 1:22 PM Tanmay Sinha notifications@github.com\nwrote:\n\n@athal7 https://github.com/athal7 Did you reload your console?\nInorder to reload all your models again with the validation in affect\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/pull/559#issuecomment-162613987.\n. @tanmay3011 thanks for the example, that helps / makes sense. \n\nSince we are trying to prevent blank names and codes, my personal preference would be to introduce a client-side validation and avoid db interaction entirely rather than introducing this level of indirection. I know that doesn't cover us in the API, but personally I prefer that trade-off. \nCurious to hear opinions of other core team members...\n. @gmacdougall just to be clear, I'm not suggesting we remove any sort of validating code, just remove seemingly contradictory validations that are in place to reduce queries in cases that we don't expect. the presence: true would stay.\n. I would be in favor of the changes I recommended earlier, but not going to\nstand in front of this if the rest of the core team feels strongly\notherwise.\nOn Sun, Dec 13, 2015 at 3:27 AM Tanmay Sinha notifications@github.com\nwrote:\n\n@athal7 https://github.com/athal7 Do I need to do any changes now?\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/pull/559#issuecomment-164237530.\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. I also find it a bit odd to have a vendored asset in coffeescript, usually use the minified version.\n. @tvdeyen that sounds great to me\n. :+1: \n. :+1: \n. :+1: \n. @Senjai this looks good and gets the job done in a simple manner, so :+1:  \n\nA few thoughts potentially worth considering:\n1) In addition to other potential benefits, tracking urls are usually carrier-based, so it could make sense to break out carrier to its own table/model for that purpose as opposed to duplicating tracking url across shipping methods for a carrier\n2) Were there other uses for internal name in the community aside from an unstructured representation of what we have just broken out? If not, maybe we could deprecate that field to reduce confusion. \n. :+1:\n. would this extend Action ?\n. do we want to do 'recalculate' at the end of this?\n. would it be possible to pull the rest of these over into the module as well?\n. i think it would be great to keep this around and enforce on the user class.\n. just for clarity, these are in duped the order model specs, not the finalization specs\n. s/comman/common\n. nice!!\n. i'm not sure i understand what this is doing. can you explain?\n. the changes in this file seem unrelated, and the previous style didn't necessarily break a convention, do you mind backing them out?\n. same here re style\n. i think the specific user implementation would probably specify this? this seems like a legacy-user-specific thing.\n. i might be misreading, but i think this logic is reversed\n. that seems reasonable to me. @magnusvk ?\n. agreed with Gregor's comments\n. I'm a bit confused by this in that it removes the table name specificity, which seems at face value to be contradictory to the PR description. Can you help me understand?\n. i think the idea behind these tests might still provide value, even if the implementation of them is poor. did you consider changing the specs to test behavior instead of sql?\n. even with the mattr_accessor you might still have load order issues. i think this is OK, and we can be vigilant in extensions about not setting this directly, but rather stating in the readme that people should do this in their project. then if there is a conflict, the implementer can choose what to do.\n. curious if there is a reason why you chose to do this as the reference id, rather than an association, e.g.\nruby\nshipment { nil }\n. i'm a bit confused by the inconsistent convention in this file, above you have describe \"#method_name\" and here you have describe \"method_name\". can you help clarify?\n. are these safe to remove?\n. :+1: \n. ah i see, because it's state-machine defined. i can get behind that.\n. hm maybe not. i think that was a mistake\n. ah good point\n. i didn't think there was a need since the migrations would get run. am i missing something?\n. ah that makes sense, thanks! will add\n. just curious if considered using the state machine rather than reaching in to do these things specifically?\n. i'd be interested in trying to pay down that debt now if it doesn't take more than a half hour or so. otherwise :+1: \n. i'm not sure what a better naming is, maybe duplicate payments? i agree, let's leave it for now.\n. thanks i don't think i am the originator of that comment \n. thank you kind sir\n. see https://github.com/solidusio/solidus/pull/14/files#diff-b3fa806cb8560b7b39d6791b65809f3aR202\n. we do currently delegate, but if the payment method is nil then it will raise. i'll go ahead and turn it into a full method though instead of delegating\n. I'm curious why this change is in this pr, can you say more?\n. i see the chat in slack now, :+1: \n. can you say a bit as to why this was removed\n. do you mind adding a comment about this importance of this being calculated before short-circuiting? it tripped me up at first\n. :+1: \n. i might expect this to be set as null: false, i don't see a use case for created_at or updated_at to be null. maybe i'm mistaken\n. just making sure we are ok with exposing these routes since they previously weren't exposed. \n. good point. i think i'm OK either way on this\n. s/Spree/Solidus\n. keeping this for now i presume?\n. sounds good\n. correct. this is not new behavior for the api, but is new for frontend. imho the frontend side was missed when this new behavior was introduced into the api, so this rectifies that. but let me know if you think differently.\n. we can remove it, there was some different behavior in 2.2, but i think we have covered those use cases (and more/better) with the dependent frontend_only pull request\n. :) thanks\n. updated\n. just curious, why bring 'authorization' into the name here? it could also be during an actual return, not necessarily only during a return authorization.\n. do you want to rename the factory as well?\n. and everything here?\n. it looks like the column name is still the same\n. i think this is fine, but you might need to have another case for if they need to use the ReturnReason model instead\n. it actually is necessary because create_proposed_shipments (just above) cannot run for a completed order, so if the order importer truly wants to set the order as completed, it has to happen after that check. there were failing specs around this expected behavior\n. Unreturned expedited exchanges, where the shipments are already shipped and the order is attempting to complete. It should not call this method, but if it does, then at least the shipments don't get destroyed.\n. is StockMovement necessary here as well?\n. Curious why stock item is here, can you say more?\n. :+1: to @jhawthorn's comment\n. :+1: \n. imho only people with the stock management role should be able to set the count_on_hand for a product, maybe I am missing something though?\n. just checking - does the owner of an order have the ability to admin an order? if so, could they change the user_id? that would be bad\n. from offline conversation it sounds like that is not the case. i have some concern about a user acquiring this role either in base solidus or in a store at some point. is it worth adding an extra warning or spec somewhere around that?\n. This has_completed_orders check seems redundant with the nth_order check to me. Certainly not anything bad behavior-wise, just seems unnecessary from what I can tell.\n. Also on board with keeping them separate. Thanks for exploring. \n. can this also include the stock locations that the user has access to? (same for stock items)\n. yea i guess you're right. i was thinking of a scenario whereby we might want to grant a customer early access to certain items or something along those lines. it could be achieved by granting them access to a special stock location.\n. since this is cached above, do we need to add a touch from address -> credit card?\notherwise :+1: \n. :shipit: \n. updated\n. whoops ya\n. so if i wanted to maintain binary inventory cache, I would set this to 1 then? I wonder if there's a way to issue a deprecation warning on the binary_inventory_cache preference and make it set the inventory_cache_threshold response. Maybe a method on Spree::Config?\n. I like that approach @jhawthorn. I might even take it one step further and define an override to the inventory_cache_threshold on Spree::Config to defer to binary_inventory_cache if set to true and issue the warning there, but both seem good\n. in the case where the save fails here, would we lose the user's default address? maybe we need to wrap the above line in a transaction with this one?\n. forgive my memory / ignorance, can you explain again why it's better to have a constant with blacklisted attributes as opposed to using dup\n. since we are doing equality, if they are both empty, won't that be caught by the new equality check?\n. ok, i'll change my question then: I'm curious if it will be cleaner to validate against a new model as opposed to a hash of attributes. What do you think?\n. i guess it just seems potentially brittle to me that we are replicating the behavior of dup by explicitly blacklisting the attributes it doesn't copy to a new instance. maybe there isn't a good way around it, just trying to poke at it to see if there might be.\n. TIL we haven't yet removed the guides.\n. i don't think this really tests what the example says it does anymore. the example says that each shipment gets updated, but this just asserts than any shipment somewhere gets updated. same for the specs below\n. hm yea. you have more knowledge here. would it be beneficial to clear these after every test run like we do for preferences? or is state required for some specs.\n. :+1:  thanks for the suggestions. will update\n. note to self - this hash syntax mixing is sloppy\n. would it make sense to pull this into the controller? same for the reimbursements/edit form\n. in terms of method signature here, i wonder if named params would make sense since maybe not all eligibility engines care about stock location but might care about other settings later that we would add. this would be able to be cleaned up to just passing the 'options' through to the SameProduct engine, which would actually implement the named params since it cares about stock locations\n. i think using arel tables here could be useful\n. would this respond with the correct payment in a failed scenario? it wouldn't be the order's last payment would it?\n. ah cool. if it were me i'd probably want a separate add_payment method that update_cart would use if it detects nested params as opposed to the other way around. but i think this is fine as well. :+1: \n. why only the first one here?\n. sounds good\n. it looks like this is something they have started supporting: https://github.com/rails/rails/tree/master/activejob#globalid-support\n. this is great also that extension abilities get evaluated after the permission sets, makes it far easier to add behavior\n. :+1: on the user check here\n. this is nitpicky but symbol-to-proc might be easier to follow here\n. hm yea it's a bit fuzzy as it currently stands. i have a small concern with using the word repeat, since marketers might start to think it's a multiple purchase since? maybe i'm over thinking this....\n. this is the intersection of the variant's shipping categories' shipping methods and the stock location's shipping methods right?\ni wonder if something along these lines might be a bit more expressive:\nruby\nshipping_method_sets = shipping_categories.map(&:shipping_methods)\nshipping_method_sets << stock_location.shipping_methods\nshipping_method_sets.reduce(:&).to_a\nthe method comment could probably use an update as well\n. i think timestamps would be helpful as well here, possibly indexes as well\n. We could potentially start namespacing new models with Solidus. Not sure what @jhawthorn has in mind for the rename\n. The only other idea that comes to top of mind for me involves another 'assumption' about usage: namely that we restrict the UserManagement permission to not be able to edit the email of users who have the SuperUser permission, but allow all other editing. This would prevent privilege escalation to SuperUser, but not any other type of privilege escalation.\n. Is this supposed to be find_or_create_by?\n. @Senjai I'm not sure I follow this is about ability to edit email, not ability to change roles. Are you saying that you suggest to stores that only SuperUsers can assign roles? That still doesn't quite cover all of the potential privilege escalation, e.g. viewing orders -> editing orders.\n. it could be nice to refactor this specs in an 'expect to change' fashion, but that's just a nice to have since the original approach isn't your code.\n. this appears unused, and was a red herring when trying to figure out the best way to stub\n. My ideal actually would be to stub the user fetching, then build the ability during the spec, because then the user could be specified well also. I'm not quite sure how to do this or the idea you proposed for request specs though.\n. would this be 'destination_location_ids' ?\n. would you be opposed to updating this ivar to be @source_stock_locations and in the view? was thrown by this a bit.\n. i wish https://github.com/solidusio/solidus/pull/449 was ready, b/c it could clean up some of this spec setup\n. good thinking, updated\n. is it worth moving it to a separate controller/resource at this point?\n. @mbj we don't know for sure here that the permission set we intend to remove is in this list, do we? and yea @jhawthorn is right, it would be an empty array\n. with tables with many items, we've had performance issues from locking up the table to add the indexes. would you be opposed to adding disable_ddl_transaction! ?\n. @mbj I can get behind that on migrations that have a reasonable risk of needing to rollback the transaction, I'm not sure that this is one of those though.\n. is restart_checkout_flow too heavy handed?\n. that's generally what i do, though we don't have strict convention for it\n. i think it's fine here till we see a need for reusability\n. We could move the auto-generation to the user model and then get the benefit from this preference. That would give the solution you desire.\n. this gets reset before every spec run, see https://github.com/solidusio/solidus/blob/master/core/spec/spec_helper.rb#L63\n. same as above\n. just a bit inconsistent here with the spec\n. i think a separate nested controller might make sense here rather than shoehorning into the current one. Probably same goes for variant property rules. Not sure if this is the right time to make that change or not.\n. i assume this is because it's a spike, but would be interested in some failure cases here.\n. per IRL chat, it would be nice to try to combine these ruleset models somehow\n. seems reasonable to me, lets just make sure to follow through on it\n. :+1: for composition\n. would it make sense for short_ship to use this method under the hood?\n. where does this and the cancel_unit method get called?\n. got it\n. my understanding was that we were going to have rule-based images at the product-level in the api response, but if it's not a painful response time I'm open to this. would be interested to see example queries\n. @jhawthorn good point, it would not work for the variant search route without providing a similar n+1 query\nre the images, it is only one-per-rule-per-product. so for us where we only have rules per color it is more like O(log(n)), but for people who do one rule per variant, it would be more like O(n). We do already have a another n+1 query in the products endpoint (variants -> stock items), so I think some performance consideration is overdue on that endpoint either way. Aside from denormalization or putting these images at the product level (and then having search use another field that does the n+1), I'm currently at a loss for potential solutions to the slow query. \nWhile it is (very) helpful to poke holes, I am interested to hear some potential solutions and/or preferences of these trade-offs from you as well.\n. is this supposed to be inside the context \"roles_for_auto_api_key is defined\" ?\n. curious why we need two users here\n. try! instead of try http://apidock.com/rails/Object/try!\n. is accept what we want here? that will override any logic included about whether a return item is allowed to be accepted. maybe that is what we want here since it's a cancellation, but i'm just not sure.\n. got it. not sure we need that, but it also doesn't hurt\n. i would be :+1: on that as well\n. are we using subject somewhere? i am not able to find where\n. for what it's worth i think keeping shipment is better because it's more explicit\n. ",
    "Senjai": ":sheep: \n. :tada: :+1: \n. :+1:\n. :+1:\n. :+1:\n. :+1: I also want the CSS for other things\n. :+1:\n. :+1: \n. OH MY GOD YES\n. :+1:\n. @gmacdougall That's fair, thanks for the insight.\n@athal7 Apologies, it wasn't meant to seem that way. I created the new PR just to discuss bringing it back so that it could be merged if we went ahead with it. I'll make it a point to discuss these things on the original PR's from now on.\n. :+1:\n. :+1: I never used the CLI, in fact I cant remember it ever working properly. For existing projects I installed it like any other engine, and for new stores I used the install generator. \n. :+1:\n. :+1:\n. :+1: on this so far. Interested to see what turns out via our discussion on https://github.com/jhawthorn/solidus/commit/034f6ab94671fa45351714ff88461831c4e3e657\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. I'm not entirely sure of the circumstances around locking down the stock locations. If anyone has any comments regarding that please let me know.\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. Hahaha thanks! Sorry about that.\n. :+1: chatted with phil about this. This should be an if, it slipped in as an unless in my commit.\n. :+1:\n. I have no problem with using destroy, and its probably the safest option. I used delete initially due to the fact that the join table has no callbacks, but that might be monkeypatched in a store somewhere. I'll change it to destroy.\n. We discussed this in slack and opted to stick with the edit action changes for simplicity, given that the majority of the backend currently uses edit actions for both \"show\" and \"edit\" purposes (e.g. orders#edit). \n. Aye, I also really wanted the separate classes. So I'm pleased we have consensus on this approach\n. :+1:\n. :+1: I use this in development sometimes. Do we have to worry about the \"prune strategy\"?\n. :+1:\n. :+1:\n. :+1:\n. :+1: I dont think users should generally destroy their own accounts. They usually have to write into support on most of our storefronts if they feel strongly about it. We dont have a UI to support this functionality either.\n. :100: :shipit:\n. Do you know off hand how far away would we be from disable_monkey_patching?\n. :+1: to these changes :tada:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1: :tada:\n. :+1:\n. :+1: It's beautiful. \n. Yep! People can add their own logic with Spree::Order#register_update_hook which will now properly get triggered on every solidus supported state change.\n. :-1: Readme files should be executable. /s\n. :+1:\n. :+1:\n. :+1: on the days ago, I think this would allow for more flexibility.\n. :+1: :shipit: \n. :+1:\n. Closing in favor of #425 \n. :+1:\n. :+1:\n. :+1:!\n. I'm :+1:, having recently made changes so that attribute changes are present for the order updater hooks:\n- https://github.com/solidusio/solidus/pull/407\n- https://github.com/solidusio/solidus/pull/389\nIdeally, I wouldn't want to register an update hook with order here, but seeing as though the states I was interested in were only changing with update_columns, there was no other way I could add behavior around situations where those states change. \nChanging this to save would allow me to use Active Record hooks instead, which is considered the \"proper\" approach for the specific problem I was attempting to solve.\nI also have no idea what homogenize_line_item_currencies is really for.\n. I would expect that the most significant issues would come with:\n- Callbacks now being triggered when they weren't before on orders.\n- If anyone uses update! in a scenario when the order is saved, a stack level too deep error could occur where it wouldn't before.\n- Mystery currency stuff Magnus talked about.\n. :+1: This has been around for  awhile, since cancan.\n. Zoom Zoom!\n. :+1: save andrews comment, that doesnt seem to make sense.\n. Talked with @athal7 about this on slack.\nWhen I originally wrote this, I misunderstood how cancan worked with arrays like this.\nWhile:\nruby\ncan [:admin, :create], Spree::User\nIs valid in the ability to declare that a user can be created or admin'd, checking it the same way does not work. \nIt worked before because in testing we had stated that users with the user management role can manage users which makes any check pass, regardless of the validity of the check. We do still need to check for admin privileges here as well because all users can create users when they sign up.\nExample:\n``` ruby\nrequire_relative \"config/environment\"\nclass MyAbility\n  include CanCan::Ability\ndef initialize user\n    can [:admin, :create], user\n  end\nend\nuser = Spree::User.last\nability = MyAbility.new(user)\np ability.can? :admin, user # true\np ability.can? :create, user # true\np ability.can? [:admin, :create], user #false\nability.can :manage, user\np ability.can? [:admin, :create], user #true\n```\nThis might be worth looking into on the CanCanCan side of things as well.\n. :sunflower: :grinning:  :beers: :100: \n. :+1:\n. :+1:\n. There are certainly difficulties when using the resource controller for non restful situations, or situations where you require a lot of custom behavior, however, with simple controllers, nothing has been more helpful than the resource controller. It cuts down the time significantly for controllers that match what it's trying to accomplish and works well with resource controller specific helpers like link_to_destroy\n. :+1: :shipit: :tada: :100: \n. :sparkling_heart: :+1: :boat: :shipit: \n. :+1:\n. Discussed IRL: Going to try taking a look at https://github.com/leafo/sticky-kit rather than implementing our own logic, and see if sticky kit is feature complete for this task.\n. :+1: pending the result of the javascript looking into of things.\n. :+1: :shipit: Much better imo!\n. :ship: :it: \n. :shipit: :+1:, we almost always have to create models for these join tables at some point in time.\n. :+1: :ship: :it:\n. :+1:\n. :shipit: Good work! @tanmay3011 \n. :shipit:\n. :+1:\n. :+1:\n. :+1: @gmacdougall \n. :+1:\n. Tests are required here. Also, it would be nice to have a means of specifying the estimator at an instance level as well. I have no idea why you would need to use separate estimators in the same project, but the flexibility would be nice if others would agree. \n. :beers: :+1:\n. :+1:\n. :+1:\n. I remember this! I think create_proposed_shipments (I believe) has to be called. \nThe one time I had to get around this we had a global zone with a $0 electronic delivery shipping method and called that method on a before_transition to payment using the order state machine, which may or may not be a better workaround for you in the time being. This was a while back now though.\nI do think that this shouldn't be a problem though for stores that wish to bypass this step.\n. :+1: :tada: :raised_hands: \n. :+1:\n. I agree with gmac, we shouldn't be documenting rails in solidus.\n. @connecticus Product properties were not meant to be used for filtering purposes in the first place. They were meant only for frontend display where users would have a \"properties\" box or the like on the product page which would display additional information.\nSearching on these properties is a common thing people want to do and I usually recommend that users add their own model associated with products to act as a profile of sorts with proper normalization. I find that product properties as implemented are not easily used for search purposes and would recommend against using them for that purpose.\n. :shipit:\n. :+1: \n. :+1: :shipit: \n. :+1: On this. \nWell done.\nI agree that the current state of customer returns is rather perplexing, especially when looking into their relationship with return authorizations and how those two work together under different circumstances. I would be pro cleaning up the interface and responsibilities here around the fact that:\nA customer return isn't guaranteed to belong to just one order: (A CR doesn't belong to an order, it gets that through Return Items -> Inventory Units)\nAnd the behaviour that occurs with multiple RA's can be confusing. I wouldn't be surprised if some of the behaviour here is unpredictable.\n. @jrochkind I do want to have more of an in depth discussion around CR's and RA's here, but I dont really want to derail the thread. When I have some free time (or if you wanted to) I'd open up an RFC about the current structure and what we'd like to see changed.\n:+1: as is\n. I agree with cbrunsdon and jhawthorn.\nI will generally :-1: anything that doesn't have a name that adequately represents the behaviour and responsibility of the method or if the method by its nature has no defined behavior or responsibility. Every other extension point has (or should have) a clearly defined responsibility. The extendee expects certain interfaces from the extension, or certain tasks to be performed. \nIf we kept this as an extension point, and we have more than one extension that chooses to use it, we come into load order dependencies, or incompatibilities which is why I think a wide open method like this should not exist. It's also why I'm against implicit scopes like default_scope, or base_scope as a whole. \nI don't have a better alternative here, but I would like to avoid this approach if possible.\n. @tvdeyen Bumped, totally makes sense. Went with the original for consistency.\n. Internal name here, (admin_name on the model) is meant to be used only for display on the backend, but others might actually tie logic to it. I have no problem with keeping an internal name, as it may often be drastically different than the name shown to customers.\nE.g. Free Super Saver Shipping! (known on the backend as UPS Ground). The backend name is usually easier to deal with for administrators, and the backend method used for Free Super Saver Shipping might change, unbeknownst to the user at a future date.\nI wouldn't vote for extracting carrier out into another model, though I had thought of it. There isn't any logic tied to it. Tracking URLs are associated to carriers for sure, but if we have to make a separate shipping method for each carrier / service level pair, we might as well keep the tracking logic on the shipping method. \nTypically stores have less than 10 methods and I'm not sure extracting this would remove more complexity than it would add. There are stores that have many more shipping methods (> 100) with a much more complex setup, but at that point it resembles very little of the traditional shipping method setup we know in Solidus.\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. @stabenfeldt railties:install:migrations brings migrations from all gems in your project. gemname:install:migrations brings them in from only one of the gems.\nIf you ran them both, you'd notice that the gem specific one would do nothing after running railties.\n. solidus_auth is not the same gem as spree_api\n. I can swing it. :+1:\n. :+1:\n. :+1: See how it goes.\n. :+1:\n. @jhawthorn This is great. Really well done. :+1:\n. :shipit: :+1:\n. :+1: much better\n. :+1: \n. :+1:\n. :+1:\n. :+1:\n. Good small commits :+1: (best reviewed with ?w=1)\n. :+1: \n. :+1:\n. Sure, seems reasonable :+1: \n. :+1:\n. :shipit:\n. Seems reasonable :+1: \n. :+1:\n. :shipit:\n. :+1:\n. :+1:\n. :shipit:\n. I feel like arithmetic on money is a good idea for ecommerce :trollface: :+1: \n. I would prefer to have limits in the schema instead of using application level constraints if possible. We could add application validations where they make sense, but I dont think we should use them to solve the database level issues with limits. With respect to the mysql concern, setting strict sql mode will make all warnings become errors, but that has its own draw back (this is the default when running migrations though).\n. I am also :+1: on one migration to make everything \"correct\" but also agree on the concerns around that. \nI'd be :-1: on the maximum length validator approach, just because I'd want to ensure consistency at the database layer instead of in the application layer. \n. :+1:\nWe should honestly always use verify partial doubles and verifying doubles in our specs\n. Can we go with #1 here? I don't see an immediate problem if payment_total also takes into account the refund total. We currently fix this with an adjustment at the moment because refunds don't put the order into the payment state we expect it to be in.\n. :+1:\n. @tvdeyen is correct.\n@jordan-brough I made this work as a POC with this https://gist.github.com/Senjai/ec55a807e71c26224173539a0a0b814b\nFeel free to use it if you want to. This stuff needs to be made better in cancancan and I'll throw it on the slate for 2.0.\n. I'm :+1: on this. Good work @Sinetheta \n. Still :+1: :tada:\n. :shipit:\n. :+1: @jhawthorn any opinions?\n. :+1:\n. :+1:\n. TIL :+1:. @tvdeyen lgtm, thanks.. :heart_eyes: :+1:. ruby\nexpect(assigns(:orders)).to_not include(order_non_complete\n. It's worth noting there's a nice explicit way to indicate that certain let's are context for just those shared examples:\n``` ruby\nfrom rspec docs\ndescribe Array do\n  it_behaves_like \"a collection object\" do\n    let(:collection) { Array.new }\n  end\nend\n```\n. Im a little unsure where these totals come from, are these the totals from the orders created via the factories? Could we make this dynamic? item_total: Money.new(expected_orders.map(&:total).inject(&:+) or the like?\n. :+1:\n. What's happening with the timestamps that we need to pass this in? (Just curious)\nEDIT: I was just made aware of the future Rails 5 changes.\n. @athal7 I think the logic around it is that they currently can be null. \nEnforcing them to be null: false (the default in rails 5) would be considered a \"breaking change\" from previous versions if stores have null timestamps in their database. \nThat said I agree in that I cant imagine a scenario where these would not be present on a model besides some extremely weird requirement so I'm pretty indifferent on it.\n. @richardnuno Aye, I believe the goal is to have all templates compiled and available on each page.\n. I don't think so. Everything required to perform stock transfers can be done only with the stock transfer controller. Stock movements is a controller under the settings tab that is only accessible through stock locations.\n. When setting the count on hand for a product, you send a put request to the stock items controller to do so.\n. That makes sense. I can add a better guard around that in the interface and remove this from product_management.\n. @jhawthorn Should be resolved in https://github.com/Senjai/solidus/commit/ab305688ab077c89a63ce41e19f10aebd100c6e0\n. I literally just added a commit for this, thanks for catching it.\n. Yes, you are correct. I'll change that.\n. With respect to deprecating the FirstOrder rule, it does havea few notable differences from this rule. \nSpecifically this rule works only for users who have accounts with the site, I'm not sure if its desired to support anonymous users with this rule. The first order rule has to do those lookups for anonymous users in a haphazard attempt to prevent every order from being a \"first\" order for anonymous users, though it can be bypassed with a different email. I suspect that a number of stores may override the first order promotion to make this logic more robust. \nI would be willing to deprecate the first order rule if there is consensus on the matter, though I think it might make the logic more complex.\nRegarding the order check in that class, I don't understand why that check is there. Completed orders should not have new promotions applied, save manually via an admin or cs rep. If this order is completed, I expect the promotion to be ineligible. If there is an error in thinking for this, please let me know.\n. I had this here to define the prerequisites for eligible? in the same place. I could remove it and add a return false if completed_orders_count(user) > 0 in the signature for nth_order? if that would work better? If this ends up being a replacement for the FirstOrder rule, this check would also be able to go away.\n. @jordan-brough  :+1:, I did operate on the assumption that the adjustment would be locked after completion. I have added an additional spec and changes to make sure this is still eligible if completed.\n. Absolutely, thanks for pointing that out.\n. I don't think we use this for user facing authorization.\nThe user can change the following:\n[:number,\n :month,\n :year,\n :expiry,\n :verification_value,\n :first_name,\n :last_name,\n :cc_type,\n :gateway_customer_profile_id,\n :gateway_payment_profile_id,\n :last_digits,\n :name,\n :encrypted_data]\n. I'm not sure I follow. This particular can statement I believe is meant for user facing interactions to allow all users the ability to see all active stock locations.\n. Is there a chance of this leaking? This appears to me to be global configuration, we'd have to reset it after the test.\n. You can either stub the current ability, with your own ability that you can manually activate! a permission set directly on. Or you can reset Spree::RoleConfiguration.instance.roles to the empty hash it was. Though it was a Hash.new hash.\nI generally prefer:\nruby\nmy_special_ability = Spree::Ability.new(user)\nSpree::PermissionSets::UserDisplay.new(my_special_ability).activate!\nallow(controller).to receive(:current_ability).and_return(my_special_ability)\n. :+1:\n. I'm fine with the second branch that was mentioned. I'm not super knowledgeable about how all the address stuff works now, but you can also authorize on the Address model itself. You can also define a symbol, or use the class (which will get triggered when an instance is used) to represent an address book.\nruby\ncan :update, :address_book do |user_id|\n  #logic\nend\nBut here, I would expect to authorize on the address no? In the destroy action, it's clear we can can? :destroy, Spree::Address.find(params[:address_id])\nUpdating is a very different case here because an update means creation (If I remember correctly) due to the immutable requirement around addresses. In that case I would want to authorize: can? :create, Spree::Address, user_id: id\nDue to the abstraction it's better I think to keep the two permissions on Spree::User (I would just do display and manage), or use a symbol approach like above. The best by far would be to use Spree::Address, which is the model actually being created. \nEven further, we could state that if you can update the user, you can update their addresses which lacks granularity and flexibility but makes usage a lot easier. There would only be a check to see if the current user can update the user in question.\n. :+1: Would name the permissions after the method actually being invoked :remove_from_address_book etc.\n. Because we're using the user for authorization, could we just: authorize! :display, address_book_user? Or is that too permissive?\n. I do think that these custom permissions are the correct approach. Could we change :update_address_book to :save_in_address_book so it follows the method convention like remove_from_address_book does? Just a nitpick, not too opinionated on it.\n. I dont think we should, the test that is in this context is the regression for the issue mentioned in the comment.\n. I'm pro restricting user role changes to just super users on the assumption that the average user does not have roles, and the assigning of roles to a user is at a level above regular user management. The permission set can be extended if users desire the ability, or want to change it, or an entirely new one could be created depending on how flexibile they need it to be. I think taking the safest approach here is probably the best approach.\n:+1:\n. Apologies, that was unrelated, and I misread.\nI am pro this PR, but I am also pro only allowing super users to assign roles.\n. Might be able to get away with stubbing :current_ability on controller here, instead of stubbing new at the ability level. Could cause curious issues depending on the test.\n. Could we only bind to global events if we have stickies on the page in the first place?\n. :-1: on extending jquery if possible. This is helpful, but it's also very simple. Some may disagree with me here, and if people feel strongly I'll defer the point. The alternative would be exporting the Sticky class, either to the window or to a common namespace. I'm not sure what people prefer here.\n. I don't think this should be on jquery. It's only used in this file.\n. I don't know enough about the javascripts to suggest alternatives here, but I feel like this should exist, and if something doesnt that gives us the same behavior with the same quality, or a minimal amount of LOC I'd probably like to see this extracted into a common plugin, as it sounds like it'd be useful for others. Maybe out to solidus-contrib? What do people think about this?\n. Did we want this allow_blank: true to be a part of the uniqueness clause?\nvalidates :variant_id, uniqueness: { scope: [:stock_location_id, :deleted_at], allow_blank: true } \nSame question for other calls below.\n. Ah, this is valid. allow_blank can be passed directly into the UniquenessValidator or used as an option to the validates method. The difference being whether or not the validators are invoked, or are expected to handle :allow_blank directly (which uniqueness does). I've only ever passed allow_blank into specific validators, I didn't know you could short circuit using it outside of those validation statements. :+1:\n. :+1: Now that this doesnt return an array, but a relation, we could probably move it into a scope.\nMight be cleaned up by where(shipment: { stock_location_id: stock_item.stock_location_id })\n. Why is this incorrect?\nEDIT: NVM, gotta look higher in the file, its the second private.\n. I'm pro adding an association for this. But I don't think we need to test rails here. We're not really testing Solidus.\n. ~~The negative amount usually indicates that that many items are backorderd. If we adjusted below that, that would no longer mean the same thing. It makes sense to adjust positive amounts to fill backorders but I don't think it makes sense to adjust negatively. wdyt?~~\nLooks good, not a validation issue.\n. The exact name of the rake task may be helpful here\n. for_address is misspelled \n. +1, spring is annoying. Err. Is there a way we can make this assertion without looking into the db here?. ",
    "jordan-brough": "looking good to me!\n. nice! I'm not a yard expert but this looks great to me.  :+1: \n. :+1: \n. Same question as John.  :+1: otherwise\n. :+1:\n. :+1: \n. :+1: great!\n. :+1: \n. @jhawthorn mentioned to me yesterday that this was on his todo list. or at least his wish list.\n. I'll pick this up when I have time.\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. Merging since bonobos team gave a :+1: in the bonbos repo already.\n. I looked and apparently there isn't. That would be a good reason to keep this. :)  Thanks.\nThere is only a \"capture\" button, which will fail because the admin UI does not provide any mechanism to auth or auth+capture.  Shaving that yak does not seem prudent right now so I'm going to close this PR.\n. I got a :+1: on the overall PR from @gmacdougall via IM\n. :+1: Pretty cool!\nLeft a few minor questions/thoughts but nothing that I think needs to block this.\nI really appreciated the bite-sized commits and excellent commit messages while reviewing.\n. :+1: \n. Fwiw this seems like something that is usually not used but is occasionally super handy (for showing off/discussing UI changes).  I know spree/spree used teatro at least for a while, though having it leave comments on the PRs was super annoying.  Anyway, if someone did find time for this I think it would be cool.\n. @magnusvk unfortunately I think we'd still need the update_columns line. It would just turn into a shipment.ship! line.\n:+1: on the fix.\n. :+1: \n. :+1: \n. Could we also (or instead?) add id: desc to the relevant order clause on this query?  (e.g., order(:created_at, :id).last) That way if we did somehow end up with two orders created at the same time (which is more plausible w/ mysql) we would at least get a consistent result from the DB every time.\n. :+1: \n. @plongyear looks like the spec failures are unrelated? Should we re-run them?\n. :+1: \n. :+1: nice.\n. :+1: \n. :+1: \n. Cool, it sounds like we're all pretty well in agreement on the option to choose. @cbrunsdon @gmacdougall any comments before I close the PR and we move on?\n. :+1: \n. :+1: thanks for posting the screenshot\n. :+1: \n. :+1: \n. :+1:\n. :+1: aside from failing specs\n. :+1: \n. I'm having a hard time figuring this out. What was broken?  The difference I can see (and the only spec that fails with the old code) is the spec that checks whether we update user.bill_address/ship_address in place or create new ones.  Why do we need to create new ones in this case?\n. Yeesh. Nice find.\n. :+1: \n. @gmacdougall @jhawthorn @cbrunsdon would one of you take a look when you have a minute?\n. :+1: \n. :+1:  Looks the same as https://github.com/spree/spree/pull/5904 so that's good.\n. @gmacdougall is that a :+1: then?  Would you have preferred if Scott had cherry-picked yours or anything like that?\n. :+1: \n. :+1: \n. :+1:\n. :+1: nice.\n@adammathys I see we removed this section in the Bonobos app during the Solidus upgrade.  Do you know if perf was the reason why we removed it?\n. @adammathys cool, shall I create a Bonobos PR for that? (were you planning on doing so?) I think it's as simple as removing a deface.\n. @cbrunsdon any reason not to bring https://github.com/spree/spree/pull/5882 into Solidus?\n. > the defined?(Spree::ReturnAuthorizationReason) check was added to this migration when the model was renamed\nWe should have removed this chunk of code at that point instead of adding the check. That check is always false in the current state of the code.\n\nI'm not sure if migrations should be inserting data via models like this in general\n\nYeah I don't love it either but I've yet to see a better way of doing this sort of thing.  Do you have any ideas?  I think it's a good thing that the migration started failing when you removed the model. That let us know that something in an old migration was broken.  The other approach (other than inserting data in migrations) that I've tried previously is to write all the seed code such that it is always runnable, regardless of whether you are boostrapping or just updating your store.\n. ~~:+1: on removing the code since it will never be executed as per what Peter said.~~\nEDIT: Actually after looking at the rename code it appears that we should've switched the model used rather than making the code unreachable.  @plongyear is there any reason we didn't do that?\n. @plongyear any thoughts on this?  Is there a reason why we shouldn't change all the Spree::ReturnAuthorizationReason.create!s into Spree::ReturnReason.create!s?  Otherwise migrating stores won't get the default reasons, correct?\n. @plongyear that sounds great to me.\n. :+1: assuming specs go green\n. I don't think it's a good idea to trigger mutations (like advance) on GET requests.  Maybe that's not the pragmatic thing to do given how our state machine stuff is set up, but that was the idea.\n. @athal7 I'm not sure what the most common scenario is, but if an admin picked up an in-progress order the order might not be in the \"confirm\" state already though it could be ready to be moved to the confirm state.  And there's no obvious way in the admin to trigger \"order.advance\", so when you are in such a scenario this might be the most obvious way to advance the order?  I'm sure there are better ways we could handle situations like that from a UI perspecitve.\n. fyi i meant to remove the 'empty - trigger specs' before merging but that's fine\n. :+1: \n. @BenMorganIO see my updated code comment. As of Rails 4.2 t.string columns do not have a limit in PostgreSQL and SQLite.  So PostgreSQL, SQLite, and MySQL Solidus stores created before Solidus was updated to Rails 4.2 will have a 255 limit, and MySQL stores created after the Rails 4.2 update will have a 255 limit.\n. cc @solidusio/owners\n. @gmacdougall like this?\n. I'll merge this after I have a chance to test it out on Bonobos code.\n. Note to self: I was accidentally in this branch yesterday and noticed that Frontend in a Sandbox seemed to be displaying \"New credit card\" multiple times, I assume because it was finding PaymentMethods that it shouldn't have. I'm not sure if it's a sandbox setup issue or an issue w/ the migration or Frontend itself.  I will to look into that before merging this.\n. > I would vote for moving the logic into Solidus\n:100: \nI left some comments on https://github.com/jordan-brough/solidus/pull/1.  I think that's a great approach in general though I think in this specific case we can get away with something even simpler.\n. :+1: \nLeft some comments on the associated multi-domain change.\n\ninterested to pull the multi-domain change into this codebase as well\n\nditto\n. @gmacdougall look ok now?\n. :+1: :100: \n. :+1:\nAll the stubbing in those specs is unfortunate but they were already like that.\n. @jhawthorn @gvaughn I don't think the readonly in the UserAddress scope is related to the readonly? on the Address model.  I know Rails automatically makes associations readonly in some circumstances as a safety measure, but I didn't dig deep into this case.  Also, I just now tried removing the .readonly(false) in the UserAddress scope and the specs that were previously failing no longer fail, so perhaps we've changed something since then and can now remove the .readonly(false).\n. > I have a new commit encompassing your latest point about security.\nlooks nice!\n. :+1: \nI'm going to merge this as soon as the latest specs pass and we're ready to pull it into our code.  Greg is out but I just now pushed a fix for the one remaining issue I had noticed.\n. :+1: \n. @jhawthorn it seems like we should add an id field to these tables as we break out the models. Are we intentionally avoiding that for now?\n. :+1: any idea how this worked before?  Did you have to run it without bundle exec or something?\n. @athal7 @magnusvk look OK?\nIt looks like this has resulted in us creating authorizations on credit cards for orders that never got completed (when the order failed one of the validations and then the user never completed the order).  (And those authorizations will just expire eventually)  Fortunately we don't capture until ship so at least it was just authorizations and not captures.\n. :+1: \n. @athal7 agreed, that would be a great followup as well.  We could tackle that separately though yeah?\n. I chatted w/ John and we seem to be in agreement that passing in the user will be a good thing, but it sounds like it'll be best to do that in the context of providing a real extension point like Andrew suggested so that the benefit is more obvious.  I'm going to close this PR and work up something larger that solves this issue and some others for us.\n. @magnusvk - I just got through talking with @jhawthorn and he pointed to app_configuration which is where searcher_class is currently configured: https://github.com/solidusio/solidus/blob/287b118/core/app/models/spree/app_configuration.rb#L235-L239\nUsing app_configuration seems like it lines up really well with what you were saying and seems like a good option to me. What do you all think?\n. @athal7 :+1: You mean as a separate task/PR right?\n. cool, that looks really nice.\n. @magnusvk specs are passing now.\n. sweet. :+1: \n. nice! :+1: \n. awesome. nice deprecation strategy on open & close.\nsince mandatory has been gone for a good while and since there's nothing we could map it to i kind of think as a developer i'd rather have it fail hard like you have it doing here so that any issues are quickly surfaced during testing.  i suppose we could also deprecate it with no-op methods but what you have seems ok to me.\n. :+1: \n. :+1: thank you \n. While you're in here, what do you think of extracting all of this into an ensure_sufficient_payment method, and then deleting this code and adding\nruby\nbefore_transition to: :confirm, do: :ensure_sufficient_payment\nhere\nand adding\nruby\nbefore_transition to: :complete, do: :ensure_sufficient_payment\nright before this line\n?\nThat would make the logic more apparent and consistent and would replace the existing store_credit.errors.unable_to_fund message, which isn't actually a good message.\nIf that seems ok but is too much for this PR that's fine, we can open a separate issue for it.\n. :+1: on this fix.  Thought as @jhawthorn mentioned it would be nice if there were a scope we could use for this and/or a fix for the 'valid' scope.  @plongyear when you looked did that seem like too much extra work for this PR? Should we create a separate issue for that or something?\n. That seems like a good idea to me. @jhawthorn?\n. :+1: \n. Verbal :+1: on this during Solidus core team meeting. I will merge it soon.\n. @braidn thanks for the suggestion. I haven't looked at Wisper so I'm not sure if it would make sense for Solidus.  But I think the core question in this PR is independent of something like Wisper -- the question being \"does credit_card_created make sense as a hook\"? (whether it's implemented via Wisper or otherwise).\nI think considering something like Wisper could be worthwhile (I don't know) but probably as a separate issue.\n. @gmacdougall @jhawthorn @cbrunsdon @magnusvk @athal7 any thoughts on this?\n. @cbrunsdon \n\nWhat are all the places credit cards are currently created?\nWho is (and when are they) going to call that callback? (which is related to the one above)\n\nGreat questions. Here's what I've been able to find:\n- Api::OrdersController#update (via OrderContents#update_cart)\n- Api::OrdersController#create (via Core::Importer::Order.import)\n- Api::PaymentsController#create (via order.payments.build)\n- Api::CheckoutsController#update (via Order#update_from_params)\n- Admin::OrdersController#update (via OrderContents#update_cart)\n- Admin::PaymentsController#create (via order.payments.build)\n- frontend/CheckoutController#update (via Order#update_from_params)\n- frontend/OrdersController#update (via OrderContents#update_cart)\nI think it would be great if we could get them all using something in common.\nBut, let's assume that we could figure that stuff out, and find a good caller for this callback.  Do you all agree that some form of a credit_card_created(credit_card, payment) hook would be a good way to allow Bonobos to implement our ship-address-verification without having to monkey patch Solidus?\nI don't want to spend too much energy figuring out the details unless people are on board with the basic idea of the hook itself.\n\nIs this ran only after a credit card is persisted to the database? Should it run after a transaction is rolled back?\n\nI think I'd say only after everything persisted and not run if it fails.  That lowers the surface area of the hook (e.g. it can't stop an order from saving successfully, etc so it's usage is limited) which is a good thing imo.\nThoughts?\n. @braidn \n\nif we are asking about the need of the hook\n\nBonobos has a requirement for some sort of a hook to avoid monkey patching and our requirement seems reasonable to me.  So I'm mostly asking whether this seems like a good way to provide such a hook, or if people have other ideas.\n. @BenMorganIO \n\nI'm going to be :-1: on Whisper\n\nYeah, let's leave that level of implementation detail out of this discussion for now at least.\n. Per the chat w/ the Solidus core team today I'm going to dive into the following and see how plausible it looks:\n- Refactor the 8 endpoints above to use some common base\n- Add some way for applications/extensions to hook into \"credit card created\" (including any payments it was added to) when the credit card is created through that common base.\nI'll open a PR if I'm able to get something worth looking at.\n. @athal7 yeah, unless I'm reading this wrong it was only permitting extra_order_params.keys anyway, so that's all that would be let through anyway\n. ping @jhawthorn \n. @jhawthorn if you're going to start working on the \"CartUpdate\" idea perhaps we should have this use CartUpdate instead of update_cart?\n. This is taken care of in https://github.com/solidusio/solidus/pull/357\n. Thanks guys. I'll merge this as soon as I get a chance, I'd like to wait until I'm ready to deploy on Bonobos.\n. Nice :+1: \n. :+1: \n. @jhawthorn it shouldn't be necessary, but it could cause a regression if someone's app or extension was accessing any of these values by a string key. I noticed when one of our specs failed because of it.  I've already fixed our specs so I'm happy to leave this out if people would rather not have it. I'm just trying to play it safe, maybe overly so.\n. @solidusio/owners any further thoughts from anyone here?\n. :+1: \n. @jhawthorn fyi we have now gotten rid of ResqueMailer in our app.\n:+1: on the PR. If you think there's something worth mentioning in the release notes then that's great but +1 either way.\n. :+1: \n. @jhawthorn @magnusvk I added deprecation of open/closed scopes. Still look good?\n. @magnusvk @jhawthorn I suppose we could update and deprecate the routes as well.  I'm OK either way there, do you guys have any preferences?\n. Cool. Fwiw, I think I found the history: https://github.com/solidusio/solidus/commit/062c2d36ed653bd370251186b0260c470e7242e5#diff-2e15d5409a141ad2f6ab3a8f7b1dd51d (an unfinished TODO item)\n. Nice. :+1: \n. Note: Github has hidden the comment thread but I'm still interested in people's thoughts on the \"cascade\" question.  I don't have a super strong opinion but I wonder if we shouldn't keep the responsibility for cascades in Rails-land intead of DB-land.  Having foreign keys is great, it's just the cascade part that I'm wondering about.\n. > I'm a big fan of having your database maintain referential integrity, because (in good databases) there's no way to bypass it.\n@gmacdougall  I think most people here agree with you on that. The question (for me at least) isn't about whether to use the database to maintain referential integrity, it's whether to automatically cascade deletes.  You don't get any extra integrity by adding \"cascade\", you just make it potentially faster and/or easier to work with the DB.\nAnd DB cascades would skip AR callbacks right?  That might be fine, but seems like something to consider.  In the chatroom we kind of came to a consensus of we're not sure so let's start with just introducing foreign keys to Solidus and then we can think about cascades later. Do you think we should revisit that?\n. So we'd set a tentative policy for now of only adding cascades to lightweight many-to-many join tables and we'll add prominent yardoc notes to those classes when we do so, right?  I think that could be a good experiment, especially on these brand new join tables where we're sure that nobody is hooking into them yet.\n@jhawthorn? @BenMorganIO?  Others?\n. Hm, I didn't realize that Rails doesn't support SQLite foreign keys right now.\nThat makes me think we should hold off on cascading deletes for now. (Unless we wanted to drop support for SQLite.) Adding the foreign keys themselves seems OK because it's mostly functioning as a safety measure.\n. @BenMorganIO we chatted about this in the core meeting yesterday and the consensus was let's omit the cascading for now and just get the foreign keys in.\nI think that means this PR is good to go.  @gmacdougall looking at the MySQL and Postgres docs it seems like we don't need to specify \"restrict\".  In MySQL \"restrict\" is equivalent to \"no action\" and in Postgres \"restrict\" would just means the check cannot be deferred until later in a transaction (e.g. this).  Does that sound right?\n. :+1: \n. @jhawthorn @cbrunsdon @gmacdougall would be great to get some more FRT review of this PR when you are able.\n. :+1:  Thank you! I've often wanted this myself.\n. nice :+1: \n. :+1: \n. :+1: \n. @athal7 subclasses should be able to still use them just fine if they're private.  It's just a question of whether controller instances can call those methods on other controller instances of the same class/superclass type.  And I can't think of when we'd have one controller instance operating on another controller instance.\n. iow as long as we only need to call the method with an implicit receiver (which I believe is the case unless I'm forgetting something?) it seems like we should be ok?  https://gist.github.com/jordan-brough/87405488cc89d355d86a\n. :+1:\n. Awesome! :+1: \n. Other question here:  @solidusio/owners (or anyone) -- @athal7 brought up a good point regarding inheritance and method overriding.  This PR provides a superclass that has some default functionality, including a private method that child classes are meant to override if they desire.  Is that a pattern we would like to have in Solidus for allowing people to build customized classes?  i.e. ones that are based off of default classes that we provide? (in Java/C++ land this would be a 'protected' method.)\nI feel good about that pattern.  It seems like a standard OO way of customizing behavior. As long as the overridable methods are appropriately focused, documented and tested (see the docs and spec in this PR) then I think it'll be a nice way to allow people to customize classes in specific ways without having to monkeypatch things or rewrite the entire class, or without us having to anticipate every way that users may want to customize that specific method.  Again, that only works when the method is very focused.\n@athal7 please chime in with your concerns, which I think are definitely worth considering.  I don't want to misstate them.\nFYI, for this specific pull request here's another option that Andrew and I came up with that avoids method overriding by providing a class_attribute instead.  Perhaps that's the better solution for this particular PR. I'm undecided.  But more than that I wanted to surface the question of whether we like inheritance+method overriding in general as a way for people to customize Solidus.\n. > What about having comments declaring which methods we consider \"overridable\"?\nJust thinking through that option -- Here's something I found in Rails just quickly glancing through the code:\n``` ruby\nThis method should return a hash with assigns.\nYou can overwrite this configuration per controller.\n:api: public\ndef view_assigns\n```\n(from https://github.com/rails/rails/blob/a03f7e8/actionpack/lib/abstract_controller/rendering.rb#L69-L105)\nWhere public can be at least public/plugin/private.\nI don't know the details of those comments, I only found it browsing around.\nI did add some comments since you first looked at it, I don't know if we'd be content with that much:\n``` ruby\nReturns an array of search term symbols that will be passed to Ransack\nto query the DB for the given word.\nSubclasses may override this to allow conditional filtering, etc.\n\n@param word [String] One of the search words provided by the user.\ne.g. a SKU\n@return [Array] the list of search terms to use for this word\n```\n(the \"Subclasses may override this...\" part)\n. Cool, thanks @athal7 and @jhawthorn.\n@magnusvk @cbrunsdon @gmacdougall any other thoughts on this?  If we like subclassing+overriding shall we consider doing something like :api: public or just some specific phrasing?  Might be a good thing to chat about today during the core team meeting.\n. I added the # @api public tag and will merge as per the comments and core team meeting\n. :+1: \n. thanks for the quick review guys!\n. :+1: \n. :100: \n. Looking great to me!  The extraction of code into standalone classes seems like what we've been needing and the spec cleanups along the way are great to have also.\n. This is looking pretty great! @jhawthorn do you have much more on your todo list here or do you think this is pretty close to ready?\n. @jhawthorn taking a look now\n. @jhawthorn I can't see a definite use for the verification_value with existing cards.  We definitely haven't used it ourselves.\nYou probably already saw this, but this is the commit that added this via the cvc_confirm parameter (which we now translate into verification_value in controller_helpers/payment_parameters.rb to be more consistent in what we call it).  I couldn't find any corresponding PR or anything but it does seem to be meant specifically for use with existing cards.\nI'd guess that someone was requiring their customers to re-supply the CVV before being able to re-use an existing card, and that the in-memory credit card was making its way to the payment processor code (e.g. in code like this) and that code expected the verification value to be there.\nSummary: I don't know.  When I moved that code around I was just trying to be extra cautious. I would be willing to bet that there are very few stores that use that param, if any.\n. @jhawthorn super! I'm going to take another look today and verify that it'll give us what we were looking for originally.\n. :+1: :ship: !\n. :+1: \n. :+1: \nIt might be nice to leave a comment that this is temporary (looks like it should be fixed in the next 4.2 release)\n. nice! :+1:\n. :+1: \n. :+1: \n. ping @solidusio/owners \n. :+1: \n. @BenMorganIO valid point but I think that ends up being more confusing because the belongs_to :country means that country=(xxx) is already defined on address.rb, so we can't easily define a setter for that.\n. Merging but happy to discuss alternatives as a follow-up if we can think of something that's cleaner all around.\n. @BenMorganIO ok super. Thanks for the input!\n. :+1: Thanks for finding this @alexstoick!\n@jhawthorn I sent you a PR to add an extra spec at the 'checkout' level: https://github.com/jhawthorn/solidus/pull/1  Seem good?\n. Oops, this was already merged and I didn't realize it\n. @jhawthorn see this PR: https://github.com/solidusio/solidus/pull/230\n. Nice find! :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. @jhawthorn updated. Look good?\n. @magnusvk yeah I'm thinking write it from scratch.  We end up changing just about everything that this Spree::CartonMailer does -- we don't use the template (and instead share a template with order completion), we don't use the @manifest variable, we have our own subject line, we add a bcc, we add a custom instance variable.  Though again we could instead add ways to customize all that stuff.\n. @gmacdougall hm, I kind of already wrote that sort of thing in app_configuration.rb on the setting. (There's not much to it). How about I just add a note in CartonMailer pointing people there? Unless there's something more you're talking about?\n. @gmacdougall sure, that makes sense. That class could use better docs anyway.  I'd rather not repeat the same docs twice, so I'll move the docs to CartonMailer and remove them from AppConfiguration (and just point to CartonMailer instead).\n. @gmacdougall updated. Look OK?\n. nice! :+1: \nWe probably don't need to worry about backwards-compatibility since this stuff hasn't been released yet right? @jhawthorn would this make it into the next version?\n\nRails 5 will be getting rid of controller specs\n\nCool! I didn't know that.\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :100: \n. This shouldn't happen if inverse_of is set up correctly, right?\nI thought that was automatic in our version of Rails but it doesn't seem to be happening for me.  Maybe it's because of one of the options we put on our belongs_to or our has_many? Or maybe I'm imagining the automatic-ness.\nWhen I test out the current state of the code:\n``` ruby\n\n\no = Spree::Order.complete.last; o.object_id\n=> 70196650722200\no.payments.pending.to_a.first.order.object_id\n=> 70196674897280\n```\n\n\nWe do have an inverse_of set up here on Payment: https://github.com/solidusio/solidus/blob/157365b/core/app/models/spree/payment.rb#L9\nBut not on Order: https://github.com/solidusio/solidus/blob/157365b/core/app/models/spree/order.rb#L52\nIf I change the Order relationship to: has_many :payments, dependent: :destroy, inverse_of: :order then I get:\n``` ruby\n\n\no = Spree::Order.complete.last; o.object_id\n=> 70151364663080\no.payments.pending.to_a.first.order.object_id\n=> 70151364663080\n```\n\n\nCan we add a test and then see if correcting the inverse_of relationship will fix this without a reload?\n. @jhawthorn wow, great memory!  If adding inverse_of becomes a huge effort then I'm :+1: on this PR as-is and then opening an issue around figuring out how to add inverse_of separately.\n. Note: inverse_of investigation PR here: #414\n. :+1: \n. :100: :fireworks: \n. I'm kind of thinking the same thing as @magnusvk.  Would it make sense to have a can :update_authentication, Spree::User kind of ability? (which would include changing the email, password, authentication tokens, etc).  We don't want to make this fragile but if there were a safe way to be more specific that seems nicer.\nAlso, this sort of assumes that Roles are only used for admin-y type things, right?  Is it reasonable that some stores might be assigning some sort of Roles to their normal users?  If so it might be nice to not have this restriction be so broad.\n. What if we moved the existing user_attributes into user_authentication_attributes and then added a user_attributtes that was only the safe stuff?  We could permit user_authentication_attributes only when the current user had the update_authentication permission for the user in question.\n. Agreed that it could be confusing.  But it's also kind of what we do across the board when unauthorized attributes are passed in.  Any other ideas though?\n(btw: I meant to say \"authentication\", not \"authorization\" above.  Updated the comment.)\n. It would also probably be helpful to not show those fields as editable in the admin if the current user doesn't have permissions, yeah?\n. :+1:\nI am not very familiar with frontend stuff but is there a way to deprecate calling fetch_cart without an argument? Is there a reason we want to allow calling it without a value?\nBut :+1: in any case.\n. Wow, that is confusing. :+1: \n. :+1: Thanks @kennyadsl \n. cc @gmacdougall @jhawthorn @alexstoick. This is from the solidus chat room discussion.\n. :+1: \n. Nice!  I really like the extra refactors along the way also.  Just that one question left for me.\n. :+1: It seems like the shipment states and state machine could use some more thought, but given our current code I think this makes sense and I really like the event rename.\n@gvaughn if other people like this then there are some more places in solidus where we should replace the now-deprecated methods as part of this PR right?\n. Some quick thoughts:\nPaperTrail:\n- Seems a bit shotgun-ish.  (Recording every version of every row) Ideally, sure, I'd like to have all the information in the world, but I worry that there is a storage and performance cost here that perhaps we don't need to pay to get what we want.\n- Isn't as reliable as I'd like.  Anything that skips activerecord callbacks won't hit the db (update_all, or the dreaded update_columns, etc).  I've wondered if DB triggers would be a more performant and reliable way to do this kind of thing (store every version of every row) if a store did want to just store every version of everything. (And something like that should maybe live outside of Solidus since it'll be db-dependent and can have other implications.)\n- Does not provide as much context as I'd like.  Many tables can be updated from a single change and it's hard to tie those things together in our admin tool.  In a rails console or db console it's even harder.\nOne thing I'd like to see is for us to get more classes like @jhawthorn's PaymentCreate and OrderUpdateAttributes classes in https://github.com/solidusio/solidus/pull/357 and outfit them with logging and auditing, so that we could easily provide context like the person making the change and the intent of the changes, alongside the actual changes made.  I'm imagining us coming up with a tool that calculates a summarized diff of the order before and after the class runs, and storing that somewhere.  And make it easy customize or to turn on/off according to the performance requirements and details needed by each store.\n. :+1: \n. :+1: \n. Can we deprecate \"identifier\"?  Or at least stop using it within Solidus itself?\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. @magnusvk had suggested apply_automatically in #419\n. :+1: aside from the one nitpick on scope name.\nThanks for doing this!\n. Could this whole method just be rewritten as\nruby\ndef self.reasons_for_return_items(return_items)\n  active | return_items.map(&:return_reason).compact\nend\n?\n. :+1: \n. Nice, this is good stuff.\n. @mbj should we add an update for spree_shipments like you have for spree_line_items?\n. > How do you feel adding the FK / check constraint under postgresql by default?\nI'm very :+1: on adding the FK constraint. We have that FK in our own DB.  We can use the new Rails 4.2 add_foreign_key support for that and get it on postgres and mysql right?\nThe check constraint seems cool also, though I'm hesitant to start introducing too much db-specific stuff. Though this is just safety-check stuff and not behavioral stuff. Googling around it looks like if we wanted it for mysql also we'd have to add that via a trigger?  Which I think has other implications we might not want to get into.\n@gmacdougall any thoughts? Or anyone else?\n. > Lets keep this iteration as small as possible. Conceptually yes.\nHm, so I'm saying let's add this:\nsql\nUPDATE spree_adjustments\nSET order_id = (SELECT order_id FROM spree_shipments WHERE spree_shipments.id = spree_adjustments.adjustable_id)\nWHERE adjustable_type = 'Spree::Shipment'\nAND order_id IS NULL\nIf we're repairing the order id I'm not sure why we wouldn't do that at the same time? (Even if you didn't do that originally.) Any missing data there is going to cause the null: false constraint we're trying to add here to fail. That's the only other type of adjustment in stock spree I believe.\n\nYes you can. We have full FKs in our app active already and it catches tons of bugs\n\nGreat!  We likewise have full FKs and have found it very helpful as well.  Can you move the foreign key addition outside of the if postgres condition and use the rails standard add_foreign_key for that?\n\nFor now I think the PostgreSQL specific check constraint is worth it. Especially as code bugs exposed in PostgreSQL will have a positive effect on MySQL installations even when the constraint there does not exist\n\nThat sounds great to me.\n. > How we did this is we temporarily added immigrant as a gem dependency and used it to generate a migration that added the foreign keys.\nThat's actually exactly what we have done as well. :)  Since it's relatively easy I think a PR would be a great way to kick off that discussion if you don't mind making one.\n. > Longterm I think we can likely untangle the polymorphic associations\n+10000 I'd be really happy to see that happen\n. > Because I like to do one thing at a time, at this point. The patch as is was tested against our production system. Before we add more constraints (for example the FK on shipments) we probably want to check all data generation call sides for possible violations.\n@mbj Totally agree with you in general on doing one thing at a time.  But are we on the same page here? We're adding null: false to spree_adjustments.order_id in this migration and I'm talking about repairing any spree_adjustments.order_id nulls for spree_adjustments.adjustable_type == 'Spree::Shipment' (just as we've done for line items).  If we don't do that then the null: false in this migration could fail, which would not be a good experience for people trying to upgrade.\n. > I hope this is a perfect example on why we want even postgresql specific checks in the code base\nTo be clear:  I think that's great and am not opposed to it at all. Like I said before, these are just additional safety checks, not behavioral differences, so that seems good to me.  I'm mostly saying \"we haven't done this before so let's make sure everyone is on board\" and \"maybe we should also do it for mysql\". I don't think we should for mysql since it would involve triggers.  @gmacdougall or @jhawthorn  any thoughts on that stuff?\n. Just saw @gmacdougall's response. Cool. @gmacdougall are you likewise thinking we shouldn't venture there for now with mysql?\n. > I'd love to not delay this PR to wait on a MySQL solution for weeks\nHaha, I doubt it would be weeks. :) This PR has been open for 15 hours now, I don't think we need to start talking about \"not delaying this any further\" quite yet. :)  (We've had a lot of discussion on this PR but I think a lot of that is discussion on the  good patterns you're contributing, which merit discussion and consensus.)\n\nI'm fine with leaving out MySQL advanced constraints knowing how terrible the implementation would be.\n\nCool.\n@mbj This is looking great to me! If you can move the foreign key addition up out of the postgres if and use add_foreign_key for it that would be great.\nDo you want to move the polymorphic constraint into a separate PR or tackle it now, given that there seem to be issues with it?  (Either way sounds great to me.)\n. > AFAIK add_foreign_key is not supported by the rails version we are running right now. I'l ldouble check this. This info is from our spree fork, not solidus one.\nYeah, Solidus is on Rails 4.2, which supports it.  We've just recently begun making use of it, actually, thanks to @BenMorganIO: https://github.com/solidusio/solidus/commit/8394c3c8ee4ad426a39155c8642e5c525096803d#diff-61cdaf6ae78f46af1b88b4cbb3614770R3 \n. @mbj Sorry, I didn't mean for that commit to be a reference.  It was just an FYI that we've begun adding foreign keys to Solidus.\nWhat you have now is exactly what I was hoping for.\n\nthe DB to do these cascading actions.\n\nYes -- I do not want us to use cascade here. See our discussion here about cascade.  We've decided that we don't want cascade anywhere since rails+sqlite doesn't support foreign keys at all yet (and we say we support sqlite).\n. :+1: great stuff!  Thanks for sticking with this long discussion.\nAwaiting a +1 from @jhawthorn or @gmacdougall or @cbrunsdon to merge.\n. @jhawthorn is the spec failure here a known issue? i.e. should I open a github issue for it or anything?\n. > Each separate commit should pass the CI\n@mbj what are the main motivators you see for that?  I'm not necessarily against it, but it does come at the expense of other things (like a simpler github review flow) so I'm curious what the primary reasons are in your opinion.\n. Per our core team meeting today, we don't have consensus on the\u00a0narrow subject of this pull request, which is using the same github workflow that Rails uses -- avoiding force pushes during pull request review.  And we haven't yet had enough pain with force-pushing or not-force-pushing to start mandating that, so we're going to wait and see for a bit there still.\nI'm going to open a separate pull request that talks about guidelines for each individual commit.  E.g., representing a standalone chunk of work, passing specs, etc.  Those guidelines will be independent of whether that is accomplished before, during or after the pull request review period. I'll link that pull request here when I've created it.\nThanks for the input everyone.\n. FYI, here is the follow-up issue, as promised: https://github.com/solidusio/solidus/pull/497\n. :+1: \n. I opened a PR with a couple tweaks here: https://github.com/mtomov/solidus/pull/1. Thoughts?\n. :+1: \n@gmacdougall or @jhawthorn does this still look OK to you?\n. :+1: \n. :+1: \n. > Why does sorting have to be in this class?\nGreat point. Is there a good way to deprecate the \"sorted by descending cost\" promise of Estimator?  If so we could deprecate the sorting here and later move the sorting out of here and into Shipment#refresh_rates, for example.\n\nWhat about to change this to expect a configuration object that responds to #call(rates)\n\nI like the idea of using call for configuration and it's something we've done elsewhere.  But @mbj can you help me understand the practical difference between \"provide an object that responds to call and accepts x and returns y\" versus \"provide a class that can be initialized with x and responds to foo which returns y\"?\n. The actual contract we're asking for right now for these properties is:\n\nProvide an object that responds to new(rates) and returns an object that responds to sort\n\nI don't see anything that's more overkill/open-ended/future-coding about that than the contract that call would give us:\n\nProvide an object that responds to call(rates) and returns a sorted list\n\nThat said, I kind of prefer the call contract personally.\n@jhawthorn you had some thoughts on this kind of thing previously didn't you?\n. > A contract that requires 2 API calls for no gain is more complex than one that requires one.\n@mbj good point.  However I doubt we'd want to support two different models of doing this and there are costs of switching how we are doing this, so I've opened a separate Github issue to discuss this: https://github.com/solidusio/solidus/issues/493\n. On the \"Why does sorting have to be in this class?\" idea -- I still think that's a valid point but I think this PR is a valid step forward in that direction regardless. If we do refactor to move the sorting elsewhere I imagine we'd want to use same shipping_rate_sorter_class that this PR introduces.  So let's not address that in this PR.\n@mbj btw I'd love to see a PR for moving the sorting elsewhere if you (or anyone) were up for it.\n. :+1: on this PR\n(though I'd prefer to see the specs done a bit differently, see above comments on mocking)\n. :+1:, regardless of the final nitpick\n. Thanks!\n. Nice! :+1: \n. Cleaning it up and refactoring it sounds great. @peterberkenbosch do you already have some high-level ideas on how to solve the issues with the previous implementation?\n. > add an association to the line item with the promotion\nI think that could be a great idea.  Something like the join table on the CreateQuantityAdjustments  promotion action right?  I haven't thought it through in detail but recording the data in a discrete way seems like the easiest to reason about. @adammathys crafted that one so maybe he has some insights on it?\n\nThat well hidden reference to the removed CreateLineItems action is still present :) \n\nHah, nice find! I guess that one slipped past me. :) We should remove that...  Thanks.\n. :+1: Thanks\n. Looking good to me. Agreed on adding yardoc on the new method.\n. :+1: \n. Looks good to me. One question: I'm not very familiar with the Stock Transfer stuff, but is StockTransferDisplay a strange name at all, since it gives you permission to \"admin\" StockTransfers and \"transfer_to\"/\"transfer_from\" StockLocations?\nNot saying we need to change it, just wondering. What's the meaning of \"Display\" for us in general in our permissions stuff?\n. nice. :+1: \n. Btw, do we need any kind of release note or anything around the renaming? (I really don't know, just asking)\n. I think this approach looks great.  It does seem like we ought to be able to make those tests a little nicer.\n\nI'm not sure this is a good approach to begin with\n\nI actually really like OrderMutex (though I'm biased since I created it :) ).  It's worked really well for us and has been exceedingly pragmatic.  I'm definitely interested in better solutions, and if there are ones that are feasible for Solidus right now that would be great to hear about.  There's the whole 'use database transactions, duh' solution that we obviously ought to be doing more of, but trying to use that as a system-wide locking scheme in Solidus is just not feasible right now as far as I've been able to tell.\nIn other words:  Please open a github issue. ;)\n. @jhawthorn I'm assuming when you say \"I'm not sure this is a good approach to begin with\" that the \"this\" is OrderMutex.  If the \"this\" is \"nested OrderMutexes\" then please ignore my whole previous comment.  I'm not completely sure whether we should allow nesting, but I can't think of a solid reason why not at the moment.\nThinking about this a bit more, I wonder if we need to require that a transaction not be open when the order mutex is created.  If a transaction were already open then any other attempts to acquire the mutex would block, where so far we've been trying to get them to fail immediately.\n. > I also don't think OrderMutex is a good approach, but I wasn't bringing that up here.\nOK, cool. Sorry for my misunderstanding there.\n\nThis code here in this PR is not a good approach\n\nIt may have some implementation flaws but the general approach seems good to me.  Allowing nested mutexes makes me slightly nervous but I can't put my finger on why still.  Is there anything specific that's making you dislike the approach? (edit: We may be ascribing different meanings to the word 'approach'. If you could clarify what it is that you don't like I think we'll get on the same page more quickly)\n\nI think it's early to thumbs up this approach\n\nJust to be clear -- no one has given it a thumbs-up yet.\n. One thing to think about regarding the current approach -- if you've already got a lock then any threads you spawn won't be able to acquire a lock. That actually seems correct to me because the whole point of the OrderMutex is to prevent concurrent modification of an order.  And I think that's just a limitation of where we're at with concurrency in Solidus, but it might not be intuitive (it wasn't to me at first).  Thoughts on that?  If nothing else it's worth calling out in some comments.\nBtw I think that sort of complexity is part of what makes me nervous about allowing nesting. Maybe it's fine but are there other options we should explore?  @philbirt is there any reasonable way to satisfy #502 without nesting?\n. Here's the draft I whipped up and showed to @jhawthorn and @cbrunsdon: https://gist.github.com/jordan-brough/a0b9f208b6b5b445dfc4  We took a look together and believe that it should work correctly (without having written any specs and w/ just 15min of looking at it).\nHowever, I believe we ended up not needing the nesting after all, and it would be nice to avoid that complexity until we find we really do need it.  So I'm going to close this PR for now and someone can re-open if they think we should pursue this further.\n. :+1: I tried this out on our codebase last night and was amazed at how few things we're broken! :)  It'll probably take us a half day or something to work out the kinks on our site I'm guessing. Nice work and great job trying to preserve backward compatibility.\n. nice :+1: \n. Nice update, thanks.  :+1: regardless of my one question in the spec.\n. :+1: thanks for sticking with this @cbrunsdon.\n. :+1: \n. :+1: good improvments, nicely incremental, great commits.\nI imagine the 'strip default amount' one could break some extension and application test suites but I'm very +1 on the change so I'm not sure if there's anything better we could do there.\n. :+1: nice.\n. :+1: \n. > I might also have put an intermediary private stock_item_for(variant) rather than exposing the state of that hash to the method\nGood point, I like that. I'll update if others are on board with the change in general.\n\nI would personally have probably done the following rather than the each_with_object\n\nNo strong preference either way (though I think I'd say Array#to_h instead of Hash.[]?). But I do like how the current each_with_object explicitly chooses the first found stock item for a given variant_id to put into the hash. We'd have to do order(id: :desc) to accomplish that with to_h.  There shouldn't be any collisions, but we don't have db-level constraints around that right now so it feels good to be safe and use the first one like StockLocation.stock_item does.\n. @jhawthorn:\n\nSo we should only ever have active stock item per-stock-location-variant\n\nI didn't want to trust the application-level uniqueness constraint since it's vulnerable to race conditions. I've now added a commit that adds a db-level uniqueness constraint for DBs that support them in this scenario (Postgres and SQLite) and switched to to_h.\nBtw, I was also trying to avoid the temporary arrays generated by the to_h approach but the perf test didn't show any difference when switching to to_h so that seems fine.\n@cbrunsdon:\nI've now added a stock_item_for method.\n. Also FYI I've added the sprockets-related commit here just so that the specs will pass until https://github.com/solidusio/solidus/pull/605 (or something equivalent) gets merged into master.\n. The sprockets thing got merged so I've updated to remove that commit.\n. > I'm just curious if this is a premature optimization -- is this only an issue in contrived examples\nIt very well could be. @dfmedeiros you mentioned in #550 that you had 100 stock locations.  For a given item, how many of those locations would you expect to have the item in stock?  My testing used 100 stock locations with 30 items in an order and all of the items in stock in every stock location.  What would be the maximum reasonable scenario in your store, for example?\n. > This is definitely getting more complicated to read than I'm happy with. I tried and couldn't make any changes to make it noticeably cleaner though.\nDitto on both fronts.  I'm not super gung-ho on this (I just tried it out while I was looking at the area) so if no one jumps in saying they think these changes are awesome and will be great for them then I'll be happy to just close the PR.\n. @jhawthorn I updated with @magnusvk's suggestion and added a bunch of comments.  The comments are lengthy but the logic is a bit hard to follow so it seemed worth it.\n. FYI: I added the sprockets commit here just to get the specs passing.  See https://github.com/solidusio/solidus/pull/605.\n. The sprockets thing got merged so I've updated to remove that commit.\n. Great find.  The 2.4 breakage you're talking about would be this commit from this pull request right?  I'm going to go back and try to understand the old code better but it does seem like something fundamental needs to change here.\n. I like the idea of exploring namespacing our configurations like this. But putting them in app/models feels strange to me.  Nesting them under Spree::Config::Stock.estimator_class might jive more with the other config code we have.  It would also provide a cleaner separation between configuration & ActiveRecord models.\nHowever, I also feel like Spree::Config.stock_estimator_class works pretty well and could allow us to put it inside app_configuration.rb where we've been putting other things like this recently.  If we want to keep the scope of this PR minimal I'd say put it there and address the scoping of configurations in a separate PR where we can focus on that.\n. Why not just make the default value be the current tracking number?\nruby\ndef ship(tracking_number: self.tracking_number, shipped_at: Time.current)\n  update!(tracking_number: tracking_number, shipped_at: shipped_at)\nend\n(and shipped_at could stay nil, just as John said)\n. :+1:\n. We should probably add a model spec for this right?\n. Given the multiple ways that we thought about solving this issue, it seems very possible that someone could refactor this at some point and break this aspect of things.  But I don't feel super strongly about it if you and @jhawthorn are :+1: without it.\n. :+1: thanks \n. I think it might be worth adding a separate table for counting promotion usage.  It seems reasonable to me to make this an explicit data point instead of being inferred.\nSomething like:\npromotion_usages(id, promotion_id, promotion_code_id, order_id)\nI don't think implementing this would be harder than implementing a counter cache, and would carry roughly the same costs (in terms of denormalization).  It would have the added benefits of being more explicit, more relational, easier to write a no-downtime migration for, and potentially providing a good place in the future for SQL-y things (like ensuring that orders are never allowed to be double counted (a problem we've had in the past) or using SQL transactions and locking to prevent race conditions from allowing a promotion usage to exceed the allowed amount).\nStepping back for a second, here are three ideas so far on solving this problem:\na) Make the query faster\nb) Add counter cache columns\nc) Make usage counting explicit\nHow do people feel about those options and are there any other ideas out there?\n. Super. I added 2.1.4 and did the further cleanup.\n. FYI, see also https://github.com/jhawthorn/solidus/commit/5988804b30805419e42d116a17746e0c22842ee4 (from https://github.com/solidusio/solidus/pull/597) and also https://github.com/solidusio/solidus/pull/605.  cc @jhawthorn \n. I think this is the same thing as https://github.com/solidusio/solidus/issues/609. Can you confirm whether the latest version of Solidus master fixes it?\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: Thanks!\n. :+1: Thanks\n. I like how this is looking!  One issue that comes to mind:  I wonder if we're still tying this too closely to ActiveRecord.\nE.g. this:\n``` ruby\nfrontend/app/controllers/spree/products_controller.rb\ndef show\n  @variants = @product.variants.includes(..., Spree::Config.variant_gallery_class.preload_params)\n  ...\nend\n```\nSeems to be assuming that you can perform an efficient preload all the information you need to display the images for those variants using ActiveRecord includes.  Is that correct?  If so, I don't think that would work for a rule-based system like the one we are now using at Bonobos.  Where does that particular variant-image preload get used btw? I took just a very quick look and couldn't immediately find it.\n. To be clear: What I'm thinking we might need, very roughly, is something like:\nruby\ndef show\n  @variants = ...\n  @variant_image_displayer = VariantImageDiisplayer.new(@variants)\n  ...\nend\nand somewhere in the view:\n<%= spree_image_tag(@variant_image_displayer.image_for(variant)) %>\ni.e. something that lets us do a preload in an efficient way, without relying on ActiveRecord includes.\n. :+1: thanks!  Would you mind rebasing and resolving the merge conflicts?  Looks like we're ready to merge after that.\n. Perfect, thanks again!\n. > yes I have an issue when I try to override this method\n@sanchojaf when you copy-paste this code into your controller it doesn't work because it's missing the Spree:: prefix.  Is that correct?  So the original code isn't a problem, it's just a bit harder to copy-paste?\nI do not have a strong opinion on this.  But it might be nice to standardize how we do this.  We switch between including/omitting the prefix a lot.\n. :+1: \n. :+1: \n. Left a comment on the original issue with one other idea.  This PR could be the right direction but it'd be nice to explore the other options a bit I think.\n. :+1: I'm not sure what I personally think about rubocop still but I think these changes are great.\n@cbrunsdon I think that ||= commit is worth keeping.  Those constants are relatively new and their intended and probable use was addition/subtraction rather than replacement, and harmful effects are limited to the admin UI, so the risk seems worth the cleanup to me.  We could temporarily put in some if defined?(...); raise ... safety logic for a while if we wanted to.  I don't feel strongly in any direction on the ||= stuff though.\n. @mamhoff thanks for all the details!  I've been looking at this today and am still wrapping my brain around everything.  Will look some more and leave more thoughts tomorrow.\n. :+1: very nice.\n. I really like this direction of separating out shipping rates taxes into their own model!\n. :+1: I think the simplification here is worth the temporary slowdown, especially since @mamhoff has already done so much of the work to speed things up in upcoming commits.  I feel like this commit is helping detangle the code and helps me be able understand the existing code more clearly.\n. We'd probably want some sort of changelog note about removing the columns yes?\n. Great!  I added a changelog entry.\n. Merged in f8b889a\n. @mamhoff & @jhawthorn updated. Look good?  I don't love the spec\u00a0I added but lmk what you think. Any ideas are definitely welcome.\n. FYI I chatted briefly with @mamhoff on this and I'm going to take some time tomorrow morning to code up a fix and improve the specs.\n. @mamhoff @jhawthorn I've added a couple of commits which broaden the scope of this PR a bit but I think it's worth it.  Thoughts?\nThese changes fix the errors that @mamhoff's commit was seeing.\nThere is some change to the public API so I've added a changelog for that.\n@mamhoff you'll want to omit this change to core/spec/models/spree/stock/estimator_spec.rb if you rebase on top of this.\n. Thanks everyone!\n. :+1: \n. Re: Your multiple payment source work -- that is extremely helpful, thank you!  I'm going to be looking through that in detail.\n. @mamhoff that would definitely be an improvement!  I'd love to go a bit further if I could.\nI was hoping to move the whole \"but it has a token\" thing into PaymentMethod because then payment methods where this isn't an issue (\"supporting\" amex vs visa vs mastercard, etc) could could simply override supports? and not have to deal with this.  It feels a bit awkward that the Order has to know to call both PaymentMethod#supports? and then also call Source#has_payment_profile? because (if I'm reading things correctly) supports? doesn't quite do the full job, doesn't it?\n. @cbrunsdon I hear you on the weirdness and current ugliness.  I'd lean toward getting this in since it solves the biggest problem of stores being able to customize this logic without monkey patching and then revisit during or after the main Wallet PR.  What do you think though?\n\nwallet.events.order_complete(order)\n\nI like that.  How about I make that change in the main Wallet PR after we merge this? (e.g. the User#wallet namespace doesn't exist yet at this point).\n. > Also, this PR is pointing to master right now. Should it be towards this branch?\n@peterberkenbosch I did want to point it at master. I did this in a weird way...but this was one of three things in that other branch that I wanted to get into master before the main Wallet PR.\n. @jhawthorn updated as per our chat\n@bbuchalter I added some more comments/YARD docs also\n. @jhawthorn did you mean to close this?\nEdit: I think the branch I based it on got deleted and that automatically closed this.  (I know I did this PR in a funky way. I'll think of something better next time)\n. @peterberkenbosch great!  Things on my list:\n- Add specs for all new functionality\n- StoreCredit check-ups\n  - Update StoreCredit to inherit from PaymentSource (i.e. this). I really just haven't even looked at this yet. It may be quite easy or there may be some gotchas.\n  - Verify that this line works correctly in the presence of store credits.  i.e. I'm not sure what happens for a new order if a user has some store credit available but not enough to cover the whole order.\n- Try using this in a live store\nDoes any of that, or anything else sound interesting to you?  I'm happy to have any help available.\n. @mamhoff yes the non-master branch is intentional.  I wanted to exclude the commits from the three PRs that I mentioned in the description from showing up here.  I need to get that last one figured out and then I'll reopen this against master.\n. > 1 ... I would suggest WalletPaymentSource, spree_wallet_payment_sources, and WalletPaymentSource#payment_source\nSounds reasonable to me. I'll update to this naming unless anyone objects.  @mamhoff @cbrunsdon any preferences?\n. > 2 ... Suggest a validation and/or a setter argument checker that prevents you from setting anything but is_a? Spree::PaymentSource\nGreat idea, I'll add that.\n. > 3 ... are we sure we'll never need ... all payment methods ever used by a user, whether in current wallet or not?\nI'm not completely opposed to this idea but I think it expands the scope right now unnecessarily without some solid use cases.  A table like user_payment_sources also feels like something that is harder to get right, or at least more important to \"not miss anything\" in.  i.e. I feel like we don't just need to make sure wallet entries are in there, we need to make sure all payment sources get in there, which feels like a greater burden for backfilling, and for scenarios that allow guest checkout and then subsequently allow guests to sign up and claim orders. I'd feel like we'd need to make sure user_payment_sources got updated, but I wouldn't be so worried about wallet_payment_sources.\nPart of the reason to provide the PORO Wallet interface in this PR is to decrease the need for future coding.  The provided interface could work equally well with either DB implementation so I'd say leave it as-is for now and I'd be happy to see someone submit a PR exploring the idea of user_payment_sources.\nI do think one thing that might be nice to do right now though is to add belongs_to :user on PaymentSource so that people know to have a user_id field on their payment sources and to connect them to their users (except in cases of guest checkout).  Anyone have thoughts on that?\n. > I don't know that STI is used anywhere else in Solidus\nSome places we currently use STI:\n- PaymentMethod subclasses (e.g. Gateway and all its subclasses in solidus_gateway)\n- Asset subclasses (Image)\n- Calculator subclasses\n- PromotionAction subclasses\n- PromotionRule subclasses\n- ReimbursementType subclasses\nI'm not sure whether it's the right choice here, but definitely worth considering.\n. > Order is gonna need an association to PaymentSource too, isn't it?\nI don't see the need for anything to change in that area.  Order already connects to payment sources via order.payments.map(&:source), which is already polymorphic (from Payment to Source).  Moving to STI is actually more of a change than continuing to use polymorphism in that regard.\n. Re polymorphic vs STI:  I think I lean toward continuing with polymorphic relationships, with the addition of the validation that @jrochkind suggested so that WalletPaymentSource.source has to be a PaymentSource.  It feels easier to migrate to (for our own code, for other existing extensions out there, and database-change-wise) and most similar to what we're already doing for Payment.source.  I feel like my experience with the very similar Payment.source polymorphic relationship has been fine query-wise and usage-wise and performance-wise so it seems nice to be consistent there if possible.\n. One extra thought:  One part of Payment.source that I haven't been happy with usage-wise is the general confusion I personally have with polymorphic relationships (or STI) in general.  e.g., with polymorphic relationships in particular \u2013 not knowing what kind of object at all that I might be getting, and what methods are OK to call on it.  But I feel like @jrochkind's suggestion of a validation makes that part better since we'll have an explicit common interface for all wallet payment sources.\n. Re polymorphic vs STI:  I chatted with @jhawthorn today and he is also in favor of using an abstract base class and a polymorphic relationship (instead of STI).  Among other things, he made the point that it's likely that we'll want to search by these provider-unique fields (e.g. the email address of a PayPal account) and cross-db support for json fields is complex and/or not all there right now.  So the STI+JSON idea might not work very well, and STI w/o JSON doesn't seem like a great fit for a table where the fields vary greatly between child classes.\n. Closing this. @peterberkenbosch is taking this over and pushing it forward in https://github.com/solidusio/solidus/pull/1414.\n. Note: This is now being moved forward by https://github.com/solidusio/solidus/pull/1707. @Serabe do you want to require RMAs for returns?\nIf you don't then you should update this list to remove the RMARequired validator in your app. E.g. in an initializer:\nruby\nRails.application.config.to_prepare do\n  Spree::ReturnItem::EligibilityValidator::Default.permitted_eligibility_validators = [\n    ...\n  ]\nend\nSomething important to know: A lot of the returns work was built with automated returns in mind, since that's what Bonobos (who authored most of it) did.  E.g. you might provide prepaid return shipping labels inside every box you ship and then you may use a 3rd party warehouse to receive returned items (this was the case for Bonobos).\nWith that in mind, some definitions: (If we can make sense of all this, I'll try to open a PR to add more documentation to Solidus itself)\nA ReturnAuthorization represents a pre-authorization for returning some items.  Your store may or may not require pre-authorization, so ReturnAuthorizations might not be necessary for you.  Even if you don't require pre-authorization, you might create a ReturnAuthorization to override the default reimbursement method for an item when it arrives, or to set up an exchange to happen when the returned item arrives.  ReturnAuthorizations are composed of ReturnItems.\nA CustomerReturn represents something being returned to your warehouse.  It may or may not have been pre-authorized, and pre-authorization may or may not have been required, but whether it was required or not it was still returned so a CustomerReturn is created and a corresponding ReturnItem is either found from an existing ReturnAuthorization or else a new ReturnItem is created and only linked to the CustomerReturn.\nA Reimbursement represents you compensating the customer for an item.  It is composed of ReturnItems, just like ReturnAuthorizations and CustomerReturns.\nSo, a lot of what you're seeing is \"expected\", though the UX probably needs improvement and it looks like there is some missing functionality for stores that require pre-authorization.  For you example:  This return was not pre-authorized (no ReturnAuthorization was created beforehand), yet it did arrive at your warehouse (you indicated this by creating a CustomerReturn), your store is configured not to reimburse items that have not been preauthorized (via the RMARequired validator), so the reimbursement failed.\nSome thoughts on what's missing:\n- Maybe a warning in the admin UI about creating a customer return without having a return authorization, if your store is configured to require pre-authorization?\n- Some way to override the reimbursement failure and approve the reimbursement, even though the return was not pre-authorized (I don't think that retroactively \"pre-authorizing\" the return by adding a ReturnAuthorization after the fact is the right approach, but it might be)\nI'm out of time at the moment but would be happy to hear ideas on fixes for this.\nNote: \"Paves the way for non-return reimbursements\" was about something different.\n. The concept looks good to me.\nAbout the error handling -- I think we should keep our error handling consistent between Rules::Taxon and Rules::Product.\nIn current Solidus Rules::Product is not even consistent with itself.  Does it make an assumption or does it raise an error?\nWhat if we add a validation to both rules to make this problem even less likely to happen:\nruby\nvalidates :preferred_match_policy, inclusion: { in: MATCH_POLICIES }\nAnd then also apply the \"return false and log it\" strategy in each of:\n- Rules::Taxon#eligible?\n- Rules::Taxon#actionable?\n- Rules::Product#eligible?\n- Rules::Product#actionable?\n?\n. Also, it seems like it could be worth adding an entry for this in the changelog.  Both to highlight the additional functionality and also to warn people that valid \"match_policy\" values are now required.\n. @jrochkind my intention wasn't to try to require you to do that extra work and I very much appreciate you doing this. :)\nOn the other hand this PR does introduce inconsistency (Taxon now returns false instead of making an assumption, while Product still has the 'assumption' behavior) so I think we should fix that before merging this.  I'll go spin up a PR that is focused on consistency and on \"return false and log it\".  Then you should be able to easily rebase this on top of that, if we get it merged.  Good?\n. I think it'd be great to get https://github.com/solidusio/solidus/pull/1184 in first if people are OK with it.\n. @jrochkind I believe the cutoff for targeting features at v1.3 happened before this PR opened (a week earlier in April) so I think it would've been a stretch to add this to v1.3 in any case.  \nThat said, my PR is taking a while to get reviews so if others want to merge this first I'm fine with that (though I think it'd have to be targeted at v1.4).\n. @jrochkind I just merged #1184 which caused some conflicts.  Mind rebasing? Sorry it's taken so long on this one.\n. \ud83d\udc4d Thanks for sticking with this @jrochkind!\n. \ud83d\udc4d \n. @mamhoff that is true and we had a quick chat with @jhawthorn about that.  We should definitely think this over very carefully, but we're thinking this might be the right choice because:\n- Spree::Order can only have 1 \"ship_address\", so it's confusing and error prone to support shipments with multiple addresses in a single order\n- We have Spree::Carton in Solidus now, which can still record the fact that you've actually shipped things to different locations, even if the original intention (e.g. the Order.ship_address) was a single address.\nThis change makes me nervous about breaking things for people but we're already broken (like @metade said, updating the ship address in the admin doesn't actually change the shipment if the order is complete) so it feels like we're in a bad place right now also...\nIt does make sense to allow multiple shipping destinations in a single order, but it feels like there are more changes we need to make to really support that properly, so we might be better off doing this for the time being.\nThoughts?\n. \ud83d\udc4d on @metade's comment.\nI'm thinking it would be good to also remove the field from the migrations so that new apps don't have it.  Otherwise it feels a bit confusing and possibly problematic in the future if people add new functionality against it since we really don't support it in the code.  And if we remove it from the migration we'd want to make the \"rename column\" migration smart enough to only rename the field if it already exists.\n. @mamhoff I don't think the idea is to have multiple Solidus stores with different schemas.  Rather it's to deprecate a column that we aren't going to support anymore (and never really did).\nI think we're saying this:\nThis column never really worked correctly and we're not going to support it anymore so we're removing it from Solidus.  We don't want to delete any of your data but we do want to make sure you realize that we've removed it from Solidus (in case you're still using it somewhere) so we're going to rename it rather than drop it.\nIt doesn't seem right to keep a \"mystery\" column around in Solidus that isn't used or tested anywhere does it?\nWhat if we renamed the column to deprecated_address_id instead of address_override_id?\n. \ud83d\udc4d (ditto on a changelog entry)\n. @metade a couple more references to Shipment#address that I noticed: https://github.com/Lostmyname/solidus/pull/1\n. \ud83d\udc4d \n. \ud83d\udc4d \n. +1 on @mamhoff's suggestion.  Adding Spree::Config.stock.coordinator_class (like we have for Spree::Config.stock.estimator_class) seems like the direction we'd want to head in.\nIn addition to that, it would be really good for us to document which (if any) private methods here are \"public api\" that we're committing to keep as stable overridable methods.  E.g., we just recently removed the previous private methods in this area.\nOn the method split-up:  I actually prefer the method as it originally was, though I wrote the latest version so I'm biased. ;)  I feel like the extracted method is very tied to the original method and separating them just makes it bit harder to read.  I won't fight too much about that if others feel strongly, but it sounds like the method break-up itself wasn't really the point anyway, especially if we haven't committed to keeping those methods around in the first place.\n. I'm a bit skeptical about us being able to do this in core at this point.  Losing data from third-party services and/or locking up the DB seem like significant dangers.  It might be more feasible to start trying to add smaller transactions around critical pieces of this transition?\n. \ud83d\udc4d (w/ the variable update)\n. Note:  I'm going to rework this a bit.  I'm going to have the \"else\" clauses make an assumption instead of generating an error, while still logging the invalid value.\n. Note:  I'm going to rework this a bit.  I'm going to have the \"else\" clauses make an assumption instead of generating an error, while still logging the invalid value.\n. I've updated the logic and updated the PR description.\n@jrochkind yes, I tried to follow the previous handling for the most part.  See the updated PR description.\n. > Don't entirely understand why I need to call load_roles and load_stock_locations -- or rather, I don't understand why the ordinary #edit action does NOT seem to need to do this\n@jrochkind this happens when edit or new are the action:\nruby\nbefore_filter :load_roles, :load_stock_locations, only: [:edit, :new]\nWe could add update to that list but it's only needed for update failures.\n. \ud83d\udc4d \nNice solution for generating a failure case.  Left a minor comment about the spec cleanup.\n. > I think that's a separate refactor\nAgreed.  Doesn't seem worth the hassle at this point.\n. \ud83d\udc4d \n@jhawthorn just curious - you're saying the old spec was flaky?  If so, what made number flaky and amount reliable?\n. ~~One solution could be to go back to using an attr_writer :order on ShippingRate as @mamhoff had originally done.~~\n. Fantastic! Thanks John.\n. Added the commit from @jhawthorn.\n. \ud83d\udc4d \n. \ud83d\udc4d \n. \ud83d\udc4d \n. I think a migration could make sense here.  Our store needs this rake task because in Solidus < 1.3 a store is only added if the Solidus-provided controllers are used to generate orders.  Our app doesn't use those controllers so we have lots of orders without store ids.\n. Added a commit to rename assure -> ensure.\n. @mamhoff any thoughts on moving this to a migration?\n. > This was introduced in #935, which IMO is a great change\nAgreed\n\nStore.default could create a default store if none exists\n\nFor some reason that feels a bit scary to me.\n\nHave Store.default raise an error if there is no default Store\n\nI like that idea.  I think it'll prevent more errors than it'll cause.\nOr perhaps we could instead (or in addition) remove the || new from Store#default and add a boot-time check to ensure that a default Store exists?  That might require updating the solidus installer to generate a Store by default for new stores but that's probably a good idea anyway.  (Does the installer already do that?)\n. The || new part of where(default: true).first || new in Store.default seems like an odd pattern to me for Solidus, and it's confused me more than once.\nSome other places where we have \"default\" methods:\n- Country.default\n- TaxCategory.default\n- User#default_address\n- User#default_user_address\n- User#default_credit_card\n- Store.default_created_by\n- Tracker.current\n- Zone.default_tax\nAll of those return nil if there is no default set.\nThe only one I could find that behaves similar to this was Address.default, and that method is deprecated in favor of Address.build_default, which is a lot clearer.\n. > the one it lazily creates doesn't even have the default attribute set!\n@jrochkind I believe the before_save :ensure_default_exists_and_is_unique here means that it will have the default attribute set when saved.  But it's true that it won't have that attribute set until it's actually saved.\n\nmaybe Store.default shoudln't be lazily creating anything\n\nI feel like intuitively that's what I'd expect. If we could get there w/o breaking things for people too much I think it'd be great.\n. FYI another issue I've had while upgrading is that Order.before_validation :associate_store isn't aggressive enough to rely on -- it only happens after valid? is called on the order, which is too late in some cases.  So it makes some things work but others not work (because some code tries to read order.store before order.valid? has been called.)\n. > Drop the validation for the 1.3 release\nWould that require a lot of change?  A new issue that came up for me in rc1 was from this change on Order#tax_address -- it expects a store to be present on the order or it raises an NoMethodError error since the store is nil.\n. > it'll just fail validation anyway, since it has no name, email, or mail_from_address\n\nSo that lazily created Store.new returned from Store.default at present is just a disaster waiting to happen\n\nGreat points.\n. Thanks!\n\ud83d\udc4d (assuming specs go green)\n. I've opened a PR for this: #1246.\n. It'd be great to get more specs around these tasks and also to address the \"TODO\".  If anyone has the time or inclination to do so that would be great!  I think this at least gets us to a starting point though.\n. An idea from our last core team meeting:\nRemove these two lines from ItemAdjustments:\nruby\n@item.included_tax_total = tax.select(&:included?).map(&:update!).compact.sum\n@item.additional_tax_total = tax.reject(&:included?).map(&:update!).compact.sum\nAnd add another line right below this call to recalculate_adjustments in OrderUpdater that is something like recalculate_taxes.  Also, make an extension point for swapping out the logic, e.g.:\nruby\nSpree::Config.order_taxes_calculator_class.new(order).calculate_taxes\nPossible problem:  Anything using ItemAdjustments outside of OrderUpdater may be depending on ItemAdjustments to calculate taxes.\n. > Does default solidus frontend actually show tax in the cart?\nYes:\n\n\nit would be interesting to do a survey of major e-commerce sites\n\nI actually did this once (six or so of the ones close to our field) and all of the ones I looked at only showed tax on the confirm step.\n\nI think in the front-ends we've done where I am, we don't even show tax until the final 'confirm' step.\n\nThat's been my experience as well.  But I know I've heard from others (@gmacdougall possibly?) that there are stores that want to show it at every step.\n\nI think tax still needs to be (at least optionally) calculated, and ideally stored, on a line-by-line basis\n\nstored yes, calculated no.  Or rather, taxes do need to be calculated at the line level, but the whole order needs to be submitted to the third party tax service at the same time. (And then the results get stored at the line level)\n\nhaving an explicit calculate_and_assign_sales_tax method/hook on an order\n\nAgreed -- this is what the \"idea from our last core team meeting\" is suggesting.  The customized calculator could hopefully decide at what states it should recalculate taxes?\n. @jrochkind ah, perhaps I misunderstood what you said.  I'm talking about modifying OrderUpdater, not OrderUpdateAttributes.  Is that what you mean?  Yes, that is a great point that the decision logic (and customization of the decision) could be in OrderUpdater, separate from the calculating logic (and customization).\n. > Possible problem:  Anything using ItemAdjustments outside of OrderUpdater may be depending on ItemAdjustments to calculate taxes.\nPlaces in Solidus that invoke ItemAdjustments outside of OrderUpdater\n~~Adjustment creation or deletion~~:\nUpdate: This has been removed by: https://github.com/solidusio/solidus/pull/1389\nruby\nclass Adjustment\n  after_create :update_adjustable_adjustment_total\n  after_destroy :update_adjustable_adjustment_total\n\u261d\ufe0f  This shouldn't be a problem for tax adjustments, but it could be a problem for other adjustments -- e.g. if a promo modifies the amount on an item then we need to recalculate taxes.  We'd have to rely on order.update! being called after the adjustment was created. That should happen, but it seems like a possible problem spot for existing stores & code.\n~~During apply_free_shipping_promotions~~:\nUpdate: This has been removed by: https://github.com/solidusio/solidus/pull/1400\n``` ruby\nclass Order\nbefore_transition from: :delivery, do: :apply_free_shipping_promotions\ndef apply_free_shipping_promotions\n    Spree::PromotionHandler::FreeShipping.new(self).activate\n    shipments.each { |shipment| ItemAdjustments.new(shipment).update }\n    updater.update_shipment_total\n    persist_totals\n  end\n```\n\u261d\ufe0f We could call updater.update instead of updater.update_shipment_total+persist_totals to ensure that shipment taxes got recalculated.\n~~After adding or removing items~~:\nUpdate: This has been removed by: https://github.com/solidusio/solidus/pull/1400\nruby\nclass OrderContents\n  def after_add_or_remove(...)\n    ...\n    ItemAdjustments.new(line_item).update\n    reload_totals\n\u261d\ufe0f reload_totals there invokes order_updater.update so that should already be OK.\n~~After changing the quantity on line items~~:\nUpdate: This has been removed by https://github.com/solidusio/solidus/pull/1356\n``` ruby\nclass LineItem\nafter_save :update_adjustments\ndef update_adjustments\n    if quantity_changed?\n      update_tax_charge # <- I think we can get rid of this...\n      recalculate_adjustments\n    end\n  end\ndef recalculate_adjustments\n    Spree::ItemAdjustments.new(self).update\n  end\n```\n\u261d\ufe0f This should be ok if all the triggering code calls order.update! afterward (like OrderContents#add does, for example) which is likely to be true but probably dangerous to assume.\n~~After shipping cost changes~~:\nUpdate: This has been removed by https://github.com/solidusio/solidus/pull/1356\n``` ruby\nclass Shipment < Spree::Base\nafter_save :update_adjustments\ndef update_adjustments\n    if cost_changed? && state != 'shipped'\n      recalculate_adjustments\n    end\n  end\n```\n\u261d\ufe0f Same thing as for LineItem.\nUpdate: Another one found by @jhawthorn:\nIn Shipment#update_amounts:\nPR: https://github.com/solidusio/solidus/pull/1435\nruby\nclass Shipment < Spree::Base\n    def update_amounts\n      if selected_shipping_rate\n        self.cost = selected_shipping_rate.cost\n        self.adjustment_total = adjustments.additional.map(&:update!).compact.sum\n. > is OrderUpdater triggered from the front-end CheckoutsController?\nI took a look:\n- OrdersController#update (frontend) and Api::OrdersController#update use OrderContents#update_cart, which triggers OrderUpdater#update\n- I can't see anywhere where CheckoutController#update (frontend) or Api::CheckoutsController#update trigger OrderUpdater#update.  There may be a possible bug in there somewhere (more likely for Api usage than Frontend usage).  Those controllers don't permit adding/changing line items at least, but they do allow changing at least ship_address, which should trigger a tax recalculation.\n. An update: Thanks to help from @jhawthorn the problem spots listed here have all been addressed.  I'm now working on a PR to add extension points for tax calculation that will be usable by 3rd party tax services.\n. PR #1892 from @adammathys gets us nearly there I think. After that I'd just like us to finalize what the configurable interface should be exactly and call this done.. \ud83d\udc4d \n. @tvdeyen how? If I remove the first can definition then accessible_by blows up.  If I remove the second can definition then the existing specs (even before this PR) fail.\ncc @Senjai since he maintains cancancan\n. Also, if I try to do this:\nruby\ncan(:update_email, Spree.user_class, spree_roles: { id: nil }) do\n  user.spree_roles.none?\nend\nthen this error happens:\n\nCanCan::Error:\nYou are not able to supply a block with a hash of conditions in update_email Spree::LegacyUser ability. Use either one.\n. @tvdeyen @Senjai thanks!  Great to know.\n\nPerhaps in this case we should just yank the first can and not worry about accessible_by compatibility?  We obviously don't use accessible_by with this, since it was broken, and it feels weird to duplicate permission logic in two places.  We do have other cans that use blocks and don't provide accessible_by compatibility.  I'm OK with either way personally though.  Thoughts?\n. @tvdeyen updated. Look good?\n. TODO: Call update! on all all adjustments, not just promo/tax/cancellation adjustments.  I'm not sure how we best figure out what order to call update! on things though, when there are adjustments of unknown types.  Taxes probably need to be last.  That might be part of the reason why this wasn't done in an open-ended way to begin with?\n. Note: I'm doing this mostly to see how much stuff breaks.  Specs are passing so that's good.  If anyone would like to pick this up and carry it forward that would be great. Or I'll try to think about it / look into it more when I can.\n. Note to self: We should try to tackle this while working on https://github.com/solidusio/solidus/issues/1252\n. @adaddeo & @dangerdogz thanks for the detailed info.\n. I prefer the non-nested style but I don't know if we need to mandate it at all one way or the other. \n@bbuchalter do you know of anything that might break if we do this one way or the other?\n. @bbuchalter I think I have the same sort of haunting memory about Rails autoloading and class declarations. :)  I can't think of what exactly might break though either.  How about we close for now and see if we get someone reporting a failure?\n. Looking great!  I left a couple questions, I'm not sure why github thinks they are outdated.\n. \ud83d\udc4d \n. \ud83d\udc4d Thank you!\n. Some other good points brought up in Solidus chat:\n@peterberkenbosch mentioned that separate first & last  names are nice for personalization, e.g. \"Hello Mary Jo\" instead of \"Hello Mary Jo Smith\".\n@Sinetheta noted that personalization breaks down for people that don't fit the firstname/lastname mold, so maybe we shouldn't worry about it (at the Solidus level at least).\n@jrochkind suggested that perhaps we don't needs names on Address at all for shipping purposes, as shipping services don't require names.  And for things like company addresses there may not be a 'name' (or at least a name with first & last parts).  He also mentioned that billing addresses may have different requirements.\n@jhawthorn noted that Spree::CreditCard already has just a single name field.\nAbout credit cards: We currently split credit card names apart for ActiveMerchant, but that whitespace-splitting seems to have worked well enough so far.  Braintree has separate first/last name fields while Stripe has a single name field.\n. Re Validations:  Ditto on what @jrochkind said.  It would be sad to have that be the official method to remove the last name validation in Solidus.  I think no-last-name is a perfectly reasonable scenario to support in a good way in Solidus core.\nPersonally I'm OK with leaving the fields separate, for now at least, but I do think we need to at least support nil last names.\n. >  when we create Return labels on the FedEx api, I'm fairly certain it will hiccup if it doesn't have both a first & last name in there\n@jasonfb do you have any example links for that?  I tried looking around but in this fedex doc and this ruby gem I only see PersonName (like Amazon) and no first/last name fields.  Which part of their API requires first & last names for addresses?  \nLikewise for UPS looking around in places like this all I see are things like Name, CompanyName, and AttentionName.\nDo you have any examples of services that require separate first and last names on addresses and where an invalid whitespace split (e.g. \"Mary\" \"Jo Smith\" instead of \"Mary Jo\" \"Smith\") would cause a problem?\n. Does anyone know of any examples of third party services that would require an address (not a user) to have both first and last names?\n. It sounds like we have a pretty good consensus that this PR is OK, and there may be future improvements we can make (like combining first and last names)?  Shall we go ahead and merge this?\n. @gmacdougall per your latest comment are you \ud83d\udc4d on this PR as a whole?\n@jhawthorn you had some thoughts on this iirc?  Seem OK?  I like the idea of combining first and last names but perhaps this can be a stepping stone to that?\n. FYI I'm a bit worried that I've made the spec/features/admin/orders/order_details_spec.rb flaky somehow.  I haven't been able to repro these failures for that spec locally:\nhttps://circleci.com/gh/solidusio/solidus/4156\nhttps://circleci.com/gh/solidusio/solidus/4161\nhttps://circleci.com/gh/solidusio/solidus/4151\n. Note: I found that the sporadic spec failures are specific to Postgres so I'm guessing it's something to do with DB result ordering but in any case at least I can repro the failures now.\n. @jhawthorn I verified just now that the new specs fail on the old code (in the PR I un-pending-fied one of the specs) so I think it might be ok?\n. The sporadic failures only happen on postgres. I can repro locally now.\n. This was taken care of in #2259. FYI I've added a Changelog entry for this and the related PRs.\n. I've gone ahead and removed the reload mentioned by @jhawthorn and added some more comments on the specs for that.  Assuming specs go green I'll merge this.\nShall we backport this to 1.4 as well?\n. @jrochkind thanks for raising this issue!\nI've got a slightly different suggestion I'd like to offer on tackling this: What if we introduce a PromotionCodeBatch model?\nI very much agree with all of these points:\n\nPrior to this PR, if you look at an existing Promotion, the first promotion code (if any) is shown on screen labelled (labelled incorrectly) \"base code\".\nThat's just a mess, but the actual base code was not stored anywhere to display instead.\n\n...\n\nhard to later create more promotion codes using the same base code.\n\n...\n\nThe CodeBuilder was I guess written with the assumption that it would only be used on new promotion creation.\n\n...\n\nI wouldn't have the CodeBuilder deciding whether to use a suffix based on how many codes there are at all, I'd have another option.\n\nAlong with those, here are a few additional points of pain I've had with the current system:\n- Multiple promotion codes on a single promotion should not be required to have the same base code, or even any base code at all. (Which actually argues against having a spree_promotions.base_code DB field)\n- The admin can easily time out when trying to generate large batches of promotion codes (e.g. 100,000 codes)\nI think we might be able to help with all these issues if we added a PromotionCodeBatch model and update the admin API a bit.\nSpecifics:\n- PromotionCodeBatch Schema:\n  - promotion_id\n  - base_code\n  - number_of_codes\n  - status (processing/completed/errored)\n- PromotionCodeBatch would not be not required.  You can add a code to a promotion without it being in a batch (makese sense, imo, and helps with backward-compatibility)\n- PromotionCodeBatches can be processed asynchronously. And since they're in the DB we can provide an admin UI on their status.\n- Provide a different admin UI for generating single codes vs batches of codes and send them in separate controller parameters\n- Don't use CodeBuilder for single codes\n- Deprecate calling CodeBuilder with num_codes == 1 instead of changing the behavior (and in the future make it do the same thing for == 1 as it does for > 1)\n- Deprecate :base_code as a parameter to PromotionBuilder instead of changing the behavior\nThoughts?  I know that's a much larger request, but personally I'd rather not cement the idea of spree_promotions.base_code as a data point, and this would be helpful to our store so I'd be happy to collaborate on it or try taking it on ourselves if people think it's an OK idea.\n. @vladstoick actually just implemented PromotionCodeBatch for us in our own store and we have been using it for the past week or so.  The aim was to upstream it.  Can you give us a week or so to see if we can get a PR up?  It could avoid the extra back-and-forth of changing this multiple times?  If it doesn't look good or if we don't manage to get it up then maybe we go forward with this PR?\n. Updating Gateway#reusable_sources seems like a good thing to do here as well, as per this PR: https://github.com/solidusio/solidus/pull/1442#issuecomment-248034253\n. Something I just thought about -- after this change it's possible to have refunds in your database that haven't actually been refunded.  E.g.:\nruby\nrefund = Spree::Refund.create!(...)\nrefund.perform! # <= raises an exceptoin\nPreviously the return of money happened in an after_create and if it failed (raised an exception) then the refund insert would get rolled back.  With this PR right now the Refund.total_amount_reimbursed_for method could easily become incorrect.\nIt seems like we need to either 1) Make it obvious that a Refund record should only exist if the return of money was successful, and make it easy to do that in a robust way. Or 2) Add something like a state column to Refund so that it can be marked as failed. (We could look for the absence of a transaction_id, though that seems too indirect to me.)\nA solution for option 1 could be:\nruby\nclass Spree::Refund\n  def self.perform!(attributes)\n    transaction do\n      create!(attributes)\n      perform!\n    end\n  end\n  ...\nend\nThen the \"right way\" would be fairly obvious and easy to do in a robust way.  And if someone really wants to create a Refund record without performing the refund (e.g. while importing data) they can still do so easily.\nIf we want to do option 2 then there is more code we need to change and probably a bigger release note we need to write.\n. > I have added a scope to make sure the method only performs on transacted refunds\nThis seems too indirect to me.  If we're going to introduce \"state\" to the Refund model I think we should make it more explicit than that (even if we don't use state_machine (preferrably not :)).\n\nThe goal of this PR is to remove the implicit call of perform! so that refunds could be created\nwithout automatically performing them, for the purposes of data importing\n\nThat makes complete sense.  But it seems like this:\nruby\nclass Spree::Refund\n  def self.perform!(attributes)\n    transaction do\n      create!(attributes)\n      perform!\n    end\n  end\n  ...\nend\nWould accomplish that in a much less invasive way (without changing the the meaning of what the presence of a Refund means)?  Do we really want to change that aspect of things?\n. @solidusio/admins any thoughts?\nAn alternative might be to avoid this entirely by raising an exception when trying to delete an adjustment source that is referenced by completed orders.  (A poor man's foreign key for a polymorphic relationship).  That would be more involved though.  This seems like a decent incremental improvement?\n. FYI I added an issue to look into things further: https://github.com/solidusio/solidus/issues/1452\n. \ud83d\udc4d \n. Closing. I opened this from the wrong repo.  Opened PR 1428 instead.\n. @cbrunsdon good point. Added.\n. I will review and rebase. @jasonfb @mtomov thanks for the feedback, very helpful!\nA thought on only_allow_most_recent_promotion_for_user_applied_promotions -- that does seem reasonable, but it also seems reasonable that a store might want to have apply_automatically promotions be replaced by manually-entered promotions doesn't it?  i.e. have the apply_automatically promo be a sort of \"default promo\" that can be overridden by a manually entered-promo?  Maybe we should have the config setting be a three-valued config?  Or if there are other common scenarios that we should also consider then maybe we should make this even more generic somehow.\n. @jasonfb @mtomov I've opened #1433 as an alternative approach that might be more customizable without having to pull too much logic into Solidus itself.\n. @mtomov I think the promotion category idea is a good one. I know some stores use promotion categories for different purposes so I think I'd hesitate to bake that into Solidus, but in the other PR I've opened I believe you could do it that way using the provided extension points if a particular store wanted to.  Thoughts?\n. Closing this in favor of https://github.com/solidusio/solidus/pull/1433\n. \ud83d\udc4d \n. nice! \ud83d\udc4d \n. \ud83d\udc4d nice!\n. @gmacdougall if we do want to make sure the relationships are correct, then since it's most likely that promotion.order_promotions isn't loaded and won't be used, perhaps the first option would be the best? (The self.order_promotions.reset one.)\n. @gmacdougall I've updated with a couple more resets.\n. @peterberkenbosch we don't address Gateway#reusable_sources in https://github.com/solidusio/solidus/pull/1414 and it seems like we should.  It seems like we would want to implement like this perhaps:\nruby\ndef reusable_sources(order)\n  if order.completed?\n    sources_by_order(order)\n  elsif order.user\n    order.user.wallet.wallet_payment_sources\n  else\n    []\n  end\nend\nThoughts?\n. Nice, thanks!  Would it make sense to also put this inside a similar guard at the same time that we're making this change?\n. > FactoryGirl has no API to remove an attribute from an existing factory, or even to delete an existing factory altogether and replace it with a new one\nAnother reason to have factories be minimal? :)\n. > I had a separate PR to guard the admin view form at #1390\nAh, great!  Left one question on there.  Lmk what you think and I'm happy to get that merged.\n. \ud83d\udc4d Makes sense. Thanks for looking into it!\n. Do we have a standard way of visually making a button look disabled in frontend?  I tried this out in a sandbox app and it was a little confusing that the button appeared enabled but was actually disabled.. Overall: This seems like a nice addition, thanks for doing it.\nI left a few minor questions & comments but nothing that seems blocking to me if others are OK with how things are.. In this same vein, I noticed Spree::OrderCancellations#update_shipped_shipments bypasses in-memory shipment objects when making its updates to shipments. :(\n. One idea on working around this problem: https://gist.github.com/jordan-brough/f3604db1dbd91f08282f0d6c73b40adf (I'm not super happy with it but am having a hard time thinking of something safe that doesn't require a significant change of all this code)\nThe fact that inventory units have so many associations that are all related certainly makes this more difficult...\n. This makes sense to me.  Order#total means \"final amount after everything\" so it seems like LineItem#total matches that and LineItem#display_total currently doesn't.\nIt looks like we need to remove some usage within Solidus as per the spec failures, but I'm \ud83d\udc4d on doing this.\n. @mamhoff are you suggesting that we remove (or fix) display_total rather than deprecating it? Since it's really a bug?  It seems like it might be safer to deprecate it first.\n. I chatted w/ @mamhoff IRL just now and there is a LineItem#total method but it's a bit confusing also.  He says \ud83d\udc4d on proceeding with this deprecation in any case.\nIt might be nice to standardize the naming all around here.  (But that doesn't need to be this PR I think.)\n. There's a bunch of stuff that we've been telling people \"will be removed from Solidus 2.0\".  Should we actually remove those things in 2.0?  Or should we just merge this PR for now and be more vigilant in the future about removing deprecated code in major releases?\n. Note: We decided that for the 1.4/2.0 release at least we'll remove the deprecated methods in v2.1 instead of v2.0.\n. @jhawthorn I've added a changelog entry and a \"Removals\" section. Look ok?\n. Went ahead and merged since I started using the \"Removals\" section in other PRs as well.  I'm happy to see that changed if we want different formatting or whatever though.\n. > without line item records of how much tax was collected\n@bbuchalter to be clear -- the idea is still for taxes to be calculated and recorded in Solidus at the line level.  But we need the tax calculation to be invoked at the order level (i.e. calculate taxes on all the order's items at the same time).  Does that address your concern at all?\n. :)\n. @jhawthorn thanks for the feedback!  I've added commits for all the comments (including bringing in most of the code comments from ItemAdjustments).  I also rebased on latest master to get the updated rubocop rules.\n. Nice, thanks!  Possibly bikeshedding, but would it be more direct to do this in a setter instead of in a before_validation?\n. Or even at the controller level rather than the model level?  Just thinking out loud.\n. Seems reasonable but the specs are unhappy.\n. Thanks @cbrunsdon & @mamhoff.\n@jhawthorn mentioned offline that it might be nice to avoid the query using destroyed? so I've pushed a commit doing that.\n@jhawthorn was also going to look at another way of attacking this problem that might allow using after_save instead of after_commit.  @jhawthorn do you want to do that in this PR or separately?\n. Note about 1.4:  My specs don't work for 1.4 unfortunately :( since after_commit doesn't work correctly in specs in Rails <= 4.  See this readme.\n. @jhawthorn merging this for now so that I can rebase https://github.com/solidusio/solidus/issues/1479 against master.  I assume you'll open another PR if you get the other method working.\n. @cbrunsdon I took a harder look just now and it's because in that commit I referenced we overrode the create action in the controller so this doesn't get called anymore: https://github.com/solidusio/solidus/blob/v2.0.0/backend/app/controllers/spree/admin/resource_controller.rb#L53\n. Merging since #1369 was already approved & merged.\n. @jhawthorn are you thinking that empty else's are indicative of bugs?  I could see this being valid:\nruby\nif order.blah?\n  ...do something...\nelsif\n  ...\nelsif\n  ...\nelsif\n  ...\nelse\n  # don't do anything, order is foo\nend\nBut if we think it's more likely to be a bug then I'm fine w/ EnforcedStyle: empty.  I just personally would love to keep Rubocop focused on things that are bugs or that cause obvious pain.\n. Very \ud83d\udc4d on this!  If we merge https://github.com/solidusio/solidus/pull/1524 we'll want to take that into account also yeah?\n. @jhawthorn see the commit message on the first commit:\n\nFix order_factory to create tax charge after shipment\nOtherwise the shipment doesn't get a tax adjustment set up.\n\nYah I can create a spec for that. Will do.\n. @jhawthorn I've added a spec for the factory\n. Thanks @stewart!\n. This will be a fantastic improvement for shops that make lots of codes. \ud83d\udc4d \nShould we add a spree_promotion_codes.promotion_code_batch_id field?  E.g. then admins could download all the codes for a particular batch.\n. Please also see https://github.com/solidusio/solidus/issues/1254\n. Nice! The optimizations look great!\nI'm trying to think through the consequences of having one big transaction for this.  E.g. the db records from third party tax extensions, which will talk to remote services, may all be rolled back, losing track of things communicated to those services.  Any thoughts or suggestions on how we handle that and how we message that to people writing these extensions?\n. @jhawthorn updated as per feedback\n. Thank you!. Should we leave the existing apply_automatically index in Solidus? I imagine for most stores almost all promotions are apply_automatically=false so it might be better just to have this partial index?. @gmacdougall I'm interested to see the details and the VACUUM ANALYZE from @alexstoick, but whatever the case there isn't it much more efficient overall anyway to use the partial index (on postgres & sqlite) given this particular data set?. @gmacdougall I'm talking about in terms of indexing overhead and space consumed by the index.. Nevermind actually, for a boolean column the space consumed is going to be too small to worry about probably.  And I'm not enough of a DB expert to know whether there'd be an overall indexing-overhead win on this to be worth any additional complexity.. Seems worth fixing in some way.  Some thoughts:\n\nI could add a check to see if parent_data[:model_class].respond_to?(:with_deleted), but that's pretty ugly\n\nparent_data[:model_class].paranoid? is maybe a little better?\nAny chance this might open up any vulnerabilities for custom controllers that stores have that inherit from ResourceController?\nWe could also just override the required methods in Spree::Admin::VariantsController itself?\n. Another thought: Would it work to just do:\nruby\nbelongs_to 'spree/product', find_by: :slug, model_class: Spree::Product.with_deleted\n?. I'm not sure I love the thought of setting an option called model_class to a scope, but it seems like it could be OK.. > I had thought about that but didn't think in practice folks would have that many codes on a single promotion\nYeah, I've seen at least a couple stores that do this sort of thing. E.g. for an email blast with a unique code in each email.\n\nJust remove the code sorting similar to the usage sorting\n\nSeems reasonable to me. Do we have good enough indexes on all of the remaining fields to provide decent perf out of the box?  Promo-heavy stores can have lots of promotions.\n\nYou could define a new relationship that is scoped to just a single code\n\nHm, what do you mean there?\nI wonder if sorting makes sense for promo codes? If you had the following promos:\npromo_1: { codes: ['zzz', 'mmm', 'aaa'] }\npromo_2: { codes: ['eee', 'sss'] }\nHow would we expect those to get sorted, given that we have one row per promo rather than one row per promo code?\n. Commenting here to connect this to issue #1252, which is advanced nicely by this PR. Here's a few first ideas on TODO items for accomplishing the above:\n\n[ ] Reimplement Spree::Promotion::Actions::CreateAdjustment to generate line-level adjustments\n@graygilmore is working on this in #1949\n[x] Allow having Admin adjustments at the line level (see #1274)\n@alexstoick did this in #1933\n[ ] Update the admin UI so that manual admin adjustments are generated at the line level instead of the order level.  This could involve providing a tool to automatically spread out a certain amount across an order's line items proportionally.\n[ ] Figure out what to do about existing order-level adjustments.  Write a tool for migrating them?  Continue to support but deprecate them?  Move support into an extension?\n. > An \"order level adjustment\" that looks to the customer & business as-if it is applied at the \"order\" level, but then there is a calculation of how much was discounted per line item.\n\n\ud83d\udcaf \n\nIn fact, I'd even go so far as to suggest two \"promo_total\" fields on the line item\n\nHm, this adds some low-level Solidus complexity that I think would be nice to avoid unless we really need it.\n\nAvalara \u2014 widely used here in the U.S. \u2014 actually expects the full amount to be passed along with the discounts\n\nMy understanding from working and talking with Avalara was that the line-level amount field is supposed to represent the discounted amount, not the full amount. And that the order-level discount amount is provided for convenience. (They distribute it amongst the line items). @alexstoick is working on this. @gmacdougall hm, it is not.  I wonder if my alternate suggestion would be better...?\n\nA different option: Ignore finalized for all tax adjustments in Adjustment#update!?\n\nDo we really want to prevent tax adjustments from updating?. @mamhoff @gmacdougall I've opened #1936 to replace this.. Specs?. @mamhoff the only other type of adjustment that solidus core generates (besides promos & taxes) are \"admin\" adjustments - adjustments an admin makes in the admin ui for an arbitrary reason.  Right now these can only be added at the order level, and that blocks us from getting rid of order-level adjustments (thus this is linked to #1913).\nAnother nice improvement (but probably separate PR) might be to really support all types of adjustment sources by calling update! on adjustments that have a source other than PromotionAction/TaxRate/nil.. And another nice improvement beyond that might be to record something as the source for admin-generated adjustments.. If we can get to a simpler interface it feels like we should lead with that.\nThis feels very good as an exploratory step to see how many places ActiveMerchant is hooked in, but for this to provide any real benefit other libraries would need to start creating Spree::BillingResponse &etc objects, and I think we'd want them to be able to create simpler objects.. @Dkendal we chatted about this in the core team meeting yesterday and we'd like to shoot for some simpler models rather than pulling in the ActiveMerchant ones verbatim.  There's a lot of code in there that we don't want to maintain or expose as an official Spree object.\nThat said, the work you did here is very helpful in identifying what would need to change to introduce a simplified billing response class.\nFrom looking through your PR it appears that we could create a minimal Spree::BillingResponse object along with a translation layer that converts an ActiveMerchant::Billing::Response into a Spree::BillingResponse.  (Instead of having a Spree::BillingResponse with the exact same interface as the ActiveMerchant::Billing::Response class.)  If that's something you're interested in doing let me know, otherwise I might see if I have time to give that a try, based on your work here.. @skukx I agree this is unfortunately wordy and a bit confusing but I don't think we want to make this change.  We actually had your proposed names originally and changed them to the longer ones.\nThere is both a PaymentSource and a WalletPaymentSource class, so wallet.payment_sources seemed a bit confusing since you're getting back WalletPaymentSources, not PaymentSources.. @skukx yeah, I think ideally maybe we could've come up with a better name for WalletPaymentSource but that might be hard to change now.  It is a join table between the user and their payment sources, but the naming makes this a bit confusing perhaps.. @dividedharmony this doesn't seem to address some of the concerns that @mamhoff raised in his commit.\nHe mentioned that with the form, an admin:\n\nis able to change the variant's options to those of a variant that already\nexists\n\nIs that not still a danger?. This would be important for #1914 as well.. You should add a screenshot of what the admin UI looks like for this calculator :) Best one I've seen I think.\nEdit: Oops, either you added it after I looked or I missed it at first. Either way: Great!. @tvdeyen STI auto-loading is a valid issue, I don't think your problem here is an STI issue, is it?\nI think the same thing happens with any Spree:: class that hasn't been loaded yet:\n```ruby\n\n\ndefined?(Spree::Carton)\n=> nil\nSpree::Country::Carton\n=> Spree::Carton(id: integer, number: string, external_number: string, stock_location_id: integer, address_id: integer, shipping_method_id: integer, tracking: string, shipped_at: datetime, created_at: datetime, updated_at: datetime, imported_from_shipment_id: integer)\nSpree::Country::Carton\nNameError: uninitialized constant Spree::Country::Carton\n```. Linking to https://github.com/solidusio/solidus/issues/1254 (since this fixes it). @gmacdougall @jhawthorn updated.  If all looks good I'll squash these down.\n\n\nUpdate:  #2045 was causing red specs so I went ahead and squashed and rebased on latest master.. > return @collection if @collection would also work\nGood point, I've updated to that.. @mamhoff that's what I did isn't it? The original is still there. :)\n(Btw Another option could be to change it from */spec/**/* to **/spec/**/*, but that felt like it might be too broad). FYI: I force-pushed after Thomas's review to fix some specs and add some specs.  No code changes except for the last minor commit.. Thanks @swcraig.  My personal opinion is that I'd rather turn off purely-stylistic rules like this completely.. Great summary. I think it'd be great to figure out how to move things over to discard.. For the record: Here's the PR to address the method-visibility issue: https://github.com/solidusio/solidus/pull/2449. I've submitted a Rails PR here: https://github.com/rails/rails/pull/31433 to fix this in ActiveSupport.. @gmacdougall I think it's worth going ahead and fixing this.  My fix was only merged into Rails master and Rails v5.2 is already in beta so I imagine it'll be a good while before that trickles back to Solidus.  It's good to have correct method visibility for the apps using Solidus imo, even for deprecated methods.. > we could use Spree::Deprecation.warn explicitly within the private method\nGreat point, I'll update with that \ud83d\udc4d (at least for the ones where the method is defined in a way that's friendly to that). @jhawthorn @gmacdougall I removed a broken deprecation no Spree::PaymentMethod#provider_class and updated the remaining ones to use Spree::Deprecation.warn.  Look good?. Well the distinct change is what's recommended in the deprecation warning (\"(use distinct instead)\") but I'm just a little sad that we get separate Carton instances for all of the following:\nruby\nshipment.order.cartons\nshipment.inventory_units.map(&:carton)\nshipment.cartons\nI was thinking it would be nice to eliminate this path for now since it's already broken.\nI don't really have a great idea for a better replacement at the moment though so I can change the approach if we'd prefer.. Updated to fix the has_many rather than deleting it.. What do you think of using Spree::Reimbursement.new(reimbursement_status: status) here?\n. @gmacdougall I wonder if in this particular case removing it would be better?  From Spree 2.3 to 2.4 this method silently changed from checkout+pending payments to just pending payments so aside from being extraneous the method is now also dangerous if anyone is using/modifying it externally.  It might be better in this case to remove the method entirely and hope that that causes a hard failure that people will notice?  What do you think?\n. I believe you are correct -- in that case I think a credit card (at least Braintree provider) would re-auth, resulting in over authorization.  I think a store credit would actually end up working just fine (not that that was by design...).  I'm not sure what the right thing to do there is though since we don't have a #capture! method that works in the same way as the #purchase! and #authorize! methods.  What do you think of opening a separate issue to address that?  It would be nice not to expand the scope of this too much if not required and this store credit auth issue is a bug that we really need to get fixed.\n. @magnusvk sure, done.\n. Super. I opened a github issue here: https://github.com/solidusio/solidus/issues/135\n. Don't we want to skip this entirely if they can't add one?\n. This is a nitpick but can we just require that permission_sets be passed in as an array? Then we can just call \"permission_sets.to_set\" and can delete this code and don't need specs testing the non-array case.\n. Er, after looking at the method signature again maybe I don't understand this.  Is this supposed to flatten nested arrays?  It doesn't seem to do that... What am I missing?  In any case can we just require the argument to be an already-flattened array?\n. It seems a bit unexpected to me that a method named register_role may silently add to an existing role rather than registering a new role (perhaps one added by an extension?). Would it make sense to have separate methods for those actions?  Or rename the method name to something else possibly?\n. you might get a small perf boost by calling .to_set here? (if there were lots of roles/spree roles)\n. (and the same question on a few other ones like this)\n. Nitpick: shipment.inventory_units.reload.all? seems more readable to me.\n. Nice, I think that looks great.\n. I opened a PR around this issue: https://github.com/solidusio/solidus/pull/177\n. Just for my own edification -- why does this fix things?  From you comment it sounds like you're adding this because this line makes the specs wait until the page refreshes?  Does the not_to have_content behave differently? (doesn't wait for the refresh?)\n. Tricky!  Thanks.\n. Would it make sense to deprecate the first_order rule and allow this to be greater_than: 0?  I see the first_order rule does some special lookup-by-email stuff. Is that an intentional difference?  Also, the first_order rule allows the current order to already be complete (the && completed_orders.first != order). Is there a reason it needs that check but we don't here? (i.e. your + 1 below would exclude the current order if it's already complete).\n. Hm, yeah that anonymous user stuff does seem awkward.\nIt seems there's no way to really enforce FirstOrder since it's usually easy to create new accounts or use new email addresses.  FirstOrder just makes a best effort to remind users what the intention of the promotion is.  And thus it incorporates searching by email address. But NthOrder (for N > 1) does have some enforcement since users have to have placed some other orders before they make it to order N.  Users might be able to hack NthOrder by making+canceling orders but that's a lot harder than switching your email address.\nSo I guess it does seem like N=1 and N>1 have some fundamental differences and I'd vote to go ahead and keep them separate.\n. > If this order is completed, I expect the promotion to be ineligible.\nYeah the only case I can think of is if an admin were retroactively applying a promotion after an order was completed. John's idea of counting 'orders completed before this order' might cover even that case though.\n. That sounds like a good idea to me. Where \"before this order\" is something like < order.completed_at || Time.now, right?\n. That might be a bit confusing/error-prone?  I think part of the problem is that NthOrder with n=1 probably behaves unexpectedly for stores that don't require login, so FirstOrder has some stuff to make it behave more correctly for the n=1 case.\n. It does require a user already, but what I'm trying to say is it that it seems like a hard thing, for example, to message to a random store using solidus -- \"If you use NthOrder make sure you understand xxx because it behaves unexpectedly if you don't require login\". Maybe we could have an application configuration that allows NthOrder to work for n=1?  Then people wouldn't accidentally get unexpected behavior. Are you hoping to reduce the number of promo types for our admins since NthOrder n=1 works in our case?\n. FYI I seem to get something happening, am I doing it different?\n``` ruby\n\n\no = Spree::Order.complete.last\nu = Spree::User.where.not(bill_address_id: nil).last\no.user_id\n=> 540813\nu.id\n=> 540848\nb_address = u.bill_address || u.build_bill_address\nb_address.attributes = o.bill_address.attributes.except('id', 'updated_at', 'created_at')\nb_address.save\n...\n  SQL (2.6ms)  UPDATE \"spree_addresses\" SET \"firstname\" = ...\n...\n=> true\n``\n. @Senjai if that's an issue then I don't think it's specific to this PR is it?  Those attributes are already exposed via payments_attributes -> source_attributes on the order (when creating a payment).  Perhaps we need a separate PR for that if it's an issue?\n. @athal7 great catch. Greg and I talked this over for a bit we think we're OK.  We are still not updating addresses in-place anywhere -- you would always create a new address via /admin or /api.  So that means the credit_card.address_id will change and the cache will get invalidated.  Theoretically someone could update an address directly but that shouldn't be possible through /api or /admin and @gvaughn's' upcoming immutable-address work should resolve even that scenario.  Seem good?\n. Your quotes don't match here\n. @jhawthorn shouldn't we use the bang version of this method? I see it didn't in seeds.rb but the others in this file do use the bang versions.\n. PR: https://github.com/solidusio/solidus/pull/242\n. @gmacdougall great idea, done. (I usedtry)\n. This turned out to already be the case in Solidus right? (As opposed to bonobos/spree/2-2-dev)\n. Theshouldsyntax is deprecated, we've been trying to move everything over toexpect`\n. Also, would it be worth adding a changelog entry saying that admin user search now searches all user addresses instead of just the current defaults?\n. What does defining this do?\n. remove this?\n. > So you think this line should be removed from the changelog?\n\n\nYeah\n. Why not include 'created_at' in this list also?  If someone is trying to set both created_at and updated_at why let them only change created_at and not updated_at?\n. @jhawthorn awesome, thanks! I'll try to squash that early next week so we can get this merged in.\n. This will create a new address record even if this exact address already exists in the database but isn't yet linked to this user, right? Do we care?  Are we trying to avoid duplicates?\n. I think there might be a security issue here.  If an attacker caused this method to be called with address_attributes = {firstname: 'Jordan', lastname: 'Brough'} they could harvest my address because this would only search by firstname/lastname.  I really like passing a hash instead of an Address into this method but maybe at the start of the method we should do something like\nruby\nfiltered_attrs = Address.value_attributes(Address.new(address_attributes).attributes)\nto ensure that we get all the appropriate keys into the hash?\n. The suggestion will ensure that you'll get\nAddress.find_or_create_by(address1: nil, address2: nil, firstname: 'Jordan', lastname: 'Brough', ...)\ninstead of just:\nAddress.find_or_create_by(firstname: 'Jordan', lastname: 'Brough')\nwhich would require an attacker to know a full address in order to connect to it, which defeats the purpose of the attack.\n. https://github.com/solidusio/solidus/issues/276\n. I might be misreading this but doesn't this mean that if it's a new address but not the first one and not default=true we won't end up saving the user_address?\n. is it worth having finalize/unfinalize (private, non-bang versions) for open/close?\n. not important, but did you mean to omit the space between the question marks?  it jumped out at me like \"finalized???\" :)\n. > It would return voided payments as well\nEesh, that's something I didn't realize until just now. I wonder if we really want \"voided\" payments to be part of the \"valid\" scope. @jhawthorn @plongyear do either of you know of any code that expects/depends on \"voided\" payments being \"valid\"?\n. Just noticed this -- if existing_address is nil don't we still want to search the DB for an address with new_attributes?  Otherwise we will end up creating duplicates I think.  e.g., given an order with order.ship_address==nil, doing this: order.ship_address_attributes = {...} (which uses immutable_address) will always create a new address, even if a matching one already exists.\n. I think we just want to update this line to use factory:\nreturn factory(new_attributes) if existing_address.nil?\nI'm going to try out updating to that.\n. Yeah I was worried about that also but it's cached inside the association since we just tried to add it through the association.  There's a spec that verifies this: https://github.com/solidusio/solidus/blob/458efae129fe3a4bec1aed105f47935915f5a0f2/api/spec/controllers/spree/api/payments_controller_spec.rb#L54\n. @athal7 cool, yeah, just trying to stay real minimal for the moment before moving on to better stuff like that.\n. Yeah this is hidden, hacky and surprising.  But, I'm just maintaining the existing functionality here. (See here). With the way Frontend's html form is set up there is not a good way to handle multiple payments (and their sources) and Frontend will only ever send a single payment at a time so this hack takes advantage of that. It would be really nice to see if we could rework Frontend's form but for the moment I'm just trying to avoid shaving that yak.\n. That seems like a good idea to me. I'll add that.\n. seems a little overkill at the moment imho. you really want it though?\n. Ha, oops. I misread that. I thought you were asking for a finalized_adjustment factory.  Fixing now.\n. Updated.\n. i think it'd be nice to use keyword args here.  what do you think of def shipped_email(carton_id=nil, order:nil, carton:nil, resend:false)? Then we could refactor to def shipped_email(order:, carton:, resend:false) after we drop the deprecated version.\n. or perhaps just extracting the carton & order as options instead of expecting them to be the first & second args?\nthis is probably just personal preference so ignore if you'd like.\n. is it worth renaming this to send_shipment_emails?\n. you want spree_taxons_promotion_rules here right? also, you'll add a primary key as well yeah?\n. Is this removable because Api::BaseController now inherits from ActionController::Base instead of ActionController::Metal?  i.e. this no longer applies? https://github.com/jhawthorn/solidus/commit/546dd1852364d1e86214792eddec85b3764f82d5\n. Hah, I guess the answer is yes. :)\n. What do you think of apply instead of update for the name of this method?  Or something else like that.  If I have a \"FooAttributes\" object, I kind expect foo_attributes.update to refresh the attributes themselves or something like that.\n. I think this would be a good one for Spree::AppConfiguration since the concept isn't tied directly to the implementation of the class and it would make sense to have even if all this code was refactored.\n. @jhawthorn - this won't play nicely with anyone (like Bonobos) that's using ResqueMailer since it won't hit the new Rails 4.2 GlobalID stuff and the order will be passed into queues as an ActiveRecord object instead of as an integer.  I know that's caused problems for us in the past.\nBonobos can and probably should stop using ResqueMailer anyway (it's a bit broken on Rails 4.2 anyway) but would be nice if there were a temporary workaround that didn't require us to monkey-patch Order#send_cancel_email. Any ideas? Or perhaps at least a warning in the changelog that people need to get rid of ResqueMailer (and perhaps other gems like ResqueMailer, if there are any)?\n. @BenMorganIO yah the options I see are a) Find a way to make it backwards compatible, or b) Let people know they need to update their code (in the changelog or something?)\n. @grzlus yes you can have orders with null user_id values.  I wanted to raise the same ActiveRecord::RecordNotFound error in either case so I put the condition in the query.  You could equivalently omit that line and do something like raise ActiveRecord::RecordNotFound if order.user_id.nil? at the top of the method but I don't see any real benefit from that. Am I missing something?\n. In general I also prefer assign_attributes over attributes= since I find the latter to be a little misleading, but I'm not sure it'd be worth the time it would take for john to retype it. :) (Personally I like to defer to the author of the code on minor stylistic stuff.)\n. Seems a bit bike-shedding-ish...\nAlso, in this case I like how the current form calls out the fact that we may want to discontinue supporting requests without parameters (which I find weird).\n. > you don't need to perform query\nThe query ends up being where user_id is null and user_id is not null and on top of that this is an indexed field. I can't imagine performing the query will be a performance problem.\n\nCustom exceptions are good\n\nMy thought was that we don't necessarily want to expose extra information here, security-wise. The old code does raise a custom exception, but it wasn't very informative and I'm not sure it was helpful.  To me it seems reasonable to say that this credit card id doesn't exist for the given user, period.  But I'm not 100% sold on that.\n. Yes, what you say is completely true. I can imagine it making a 0.0001% difference in response time for real-world requests hitting this code.  Personally I like having all the logic in the same place, in the query, but I'm OK if someone wants to change that in this particular case.  What I'm against is a culture where we waste time on changing stuff like this with micro-optimizations when we have much bigger fish to fry.\n. @grzlus yes that is absolutely true, but if your database is overloaded to that extent and you are running the code in this area then you are already doomed and a micro-optimization like this isn't going to help.\nI'm still fine w/ refactoring this, and CreditCard.none seems like a great option there.\n. yup. oops. fixed.\n. I know this isn't from this PR but should this be a bang version of update_attributes!?\n. nm, i see that it is now returning a value (with the next line gone)\n. since we're making this public it seems like we ought to make it a bit safer to call.  i.e. calling .new_order from the outside probably shouldn't mutate anything right?  how about setting it explicitly inside #charge_for_items and just using an attr_reader to expose it?\n. Great idea. I'll update to that.\n. @jhawthorn this means that we don't need the spree/api/shared/stock_location_required template anymore.  I wonder if we should remove that file, or deprecate it somehow...? (leave a comment in the rabl..?) Thoughts?\n. We can now just collapse this into the rescue => e right?\n. @magnusvk @gmacdougall changing this to rescue => e instead of rescue Exception => e does seem like the right move. (I think rescue Exception was a bad habit of mine from the Ruby 1.8 days where Timeout::Error (and maybe some other classes like that?) did not inherit from StandardError and it was often bad that rescue => e did not rescue them.)\nBut with this update we now have the problem that our failure_handler will never be called for anything in failures if a non-StandardError occurs while failures has something in it. (e.g. if you sigint the rake task to stop it.\nWe could add:\nruby\nrescue Exception\n  Spree::UnreturnedItemCharger.failure_handler.call(failures) if Spree::UnreturnedItemCharger.failure_handler\n  raise\nend\nbut that might not be good, depending on what the non-StandardError is.\nOr we could add more rescues like rescue Interrupt => e ... for expected scenarios.\nOr we could add signal handling stuff to this rake task specifically so that you can kill the task and run cleanup code.\nOr we could change our failure handler so that it was called right away for each error as it occurred.  That seems like the most sane option to me.\nOr we could just keep this as it is now and not worry about any of this.\nThoughts?\n. @gmacdougall yeah but if it's a NoMemoryError or something like that then you're likely to make things worse by trying to call more code.  What do you think of calling the handler right away on each exception, and if there is no handler just allowing the exception to raise right then?  We might not want to make the assumption that a store will want this code to continue processing exchanges when unexpected exceptions are happening.\n. might as well pass this into create to begin with, right?\n. @gmacdougall this situation is a bit strange because there is no \"AddressBook\" model to validate against and we perform actions through the address book interface rather operating on the ActiveRecord models directly.  e.g., for deletion we're deleting (actually archiving) a UserAddress but we never have that UserAddress in hand at this level.  We just have an address book interface through which we request a deletion (aka archival).\n@gvaughn talked in the solidus channel earlier about possibly changing things so that we have an actual UserAddressBook model, though that would take some work.\n\nif address_book_user is nil, this will throw an odd 500 exception\n\naddress_book_user raises an ActiveRecord::RecordNotFound rather than returning nil, and ActiveRecord::RecordNotFound errors are converted into 404s aren't they?\n. Further clarification: I believe @gvaughn intended UserAddress to be a \"behind the scenes\" model that you never really had to know about or deal with directly from this level. Is that right @gvaughn?\n. This isn't part of this PR but I just noticed that we don't pay attention to the return value here and maybe we should? That method returns true/false instead of raising when it fails.\n. A couple ideas for trying to avoid rewriting address book stuff significantly (just brainstorming here)\n``` ruby\nuser_address_book.rb\nmodule UserAddressBook\n  class Permission\n    attr_reader :user\n    def initialize(user); @user = user; end\n  end\nend\ndefault_customer.rb\ncan :manage, UserAddressBook::Permission, user: user\naddress_books_controller.rb\nauthorize! :manage, UserAddressBook::Permission.new(address_book_user)\n```\nor another idea:\n``` ruby\ndefault_customer.rb\ncan :manage_address_book, User, id: user.id\naddress_books_controller.rb\nauthorize! :manage_address_book, address_book_user\n``\n. Feel free to ignore, but something likeFirstRepeatPurchaseSince` would make the intent of this more immediately clear to me since it only applies if you've previously made a purchase.\n. :+1: nice. I think that looks like the best option.\nSince we don't have an \"AddressBook\" model, these things are all really a property of the user, so to me it makes sense to make the auth on the user like that.\nMaybe another option would be to just assume that \"update User\" should allow updating the user's addresses (in the same way that we don't have separate permissions for updating a user's first name vs their last name vs their email), but addresses seem worth breaking out permissions-wise so I think your branch is the better choice of those.\n. I chatted offline w/ @Senjai about the reasons for not using an Address object and he says:\n\nOkay, in that case, you probably want the authorizations done on the user model\n\n(like @austenito's second branch is doing)\n. My understanding was that we'll add more stuff here later but we're starting out w/ the minimum that we need to do the payments stuff that triggered all this. @jhawthorn?\n. @allisonlarson while we're in here would you mind adding docs to this method, including the fact that it does nothing and returns nil if the supplied address is nil?\n. @allisonlarson would you mind also adding some quick docs here while we're in the area?\n. I'm still not a fan of changing this. :)\n. @allisonlarson the return value actually depends completely on the bill address right?  we probably should just not say anything about a return value since it doesn't seem like we return anything super meaningful.\n. This still feels weird to me since it assumes roles are only used for giving admin permissions and would work in unexpected ways if roles were used for other things.\nStembolt: Have you guys ever seen roles used for things other than admin permissions? (@gmacdougall / @cbrunsdon / @jhawthorn / @Senjai)\n. Interesting, OK. What do you guys think is the best thing to do here?  I can't think of any other great solution that doesn't make assumptions like this about roles.  The only other idea that comes to mind is just eliminating update_email from this UserManagement permission set entirely and letting stores add stuff like this inside their apps if they need it.  (I imagine many stores will just use the super-admin role for all admins anyway).  Thoughts?\n. I'm also not opposed to just leaving this here like it is if people think it's generally reasonable. Just brainstorming.\n. @jhawthorn should this be a configurable class? e.g. Spree::Config.order_update_attributes_class.new(...)\n. and same question for PaymentCreate\n. @jhawthorn can we add current_user: nil to this?  (And supply it when we call this). It would be really nice for logging and auditing to have that.\n. A nice-to-have: I think this might be slightly better as expect(Spree::PromotionCode.where(promotion_id: promotion.id).count).to eq(0).  (And the same thing in the other specs above this one.)  Though I also am not sure that we even need to test that dependent: destroy does what it says it'll do.\n. @ono if you wouldn't mind removing all three of these it \"should delete xxx\" specs I think that would be great.\n. :+1: :+1: thanks!\n. I'm all for cleaning up the specs but I'd prefer we didn't make sweeping updates to stuff like quotation marks.  We don't have a rule about this (and I don't think we need one) and it makes commits harder to review and git blames more tedious.  I'm all for updating stuff like that when you're already touching a line of code but I don't think it's super helpful to just make changes like this by themselves.\n. Cool\n. Do we want to cascade deletes by default at the database level?  I'm not sure one way or the other but would like to know what others think.\n. I'm pro referential integrity. My only question is on the cascade.  There might be some benefits to having the cascades be done in activerecord?  I'm not sure.\n. Seems fine to me for a migration.\n. It does seem like we should be using a factory here but that's not the fault of this PR.  create(:promotion, apply_automatically: true) seems easy enough to me w/o a trait or factory.\n. How about apply_automatically instead of applied_automatically for the name of the scope?  applied_xxx feels a bit confusing given that we have an applied scope that means something very different.\n. I do see that applied_automatically matches the naming pattern for advertised, it just feels a bit confusing given the applied scope.\n. I think before we merge this PR it ought to be in a state that satisfies the original extension goal that we had in mind. Maybe we should chat sometime about how we could best do that with the current state of this PR? \n. Per our chat we're good w/ this idea and I'll submit it as a follow-up once we merge this. Thanks!\n. I'll submit this also as a follow-up after this PR.\n. @mtomov that is because it is not deprecated here and is not intended to be, which actually goes along with my point that this is only coincidental (and temporary) duplication. :)\n. Why not use the sql version work for MySQL also?\n. Not a big deal at all but I believe you can just do connection.adapter_name... here\n. Do we still need this part even with b8b5e55661e2560437fb3b322ce284283e243dd8 and 30ae28f2e24001214737130835a50d8f9fb7cdca?\n. @mbj it seems to work for me: https://gist.github.com/jordan-brough/4e96c29a573d11d5b69d Am I missing something?\n. @mbj sounds good to me. I also like how you add the null: false in the same migration, so that bad data that comes in between the migration and the app restart will fail hard.\nCan we add and order_id is null to this query though? That reduces the time for our data set on my dev box in postgres from ~60s to < 1s, since most of the data is good and we have an index on spree_adjustments.order_id.\n. Can we add a and order_id is null here also? For me that reduces the time from > 4 min (I got impatient and killed the query before it finished) to < 1s.\n. @mbj I see it on the line item query but I still don't see it here\n. Are you missing a semi-colon here?\n. For the moment we've explicitly decided as a team that our style guide is limited to this.  If we want to change that it should be a separate discussion.\n. @cbrunsdon's argument seems sound to me. Waiting on global changes in particular seems sensible for the moment.\n. This is nitpicking but is there a reason why we need to build these? It seems a little confusing to me that we build instead of create  when we need them all to be persisted for the spec to work.\n. How about joins(:order).merge(Spree::Order.by_store(store))?\n. this is so nitpicky but i can't help it... can we use the same ->(store) { syntax as the other scopes, instead of lambda { |store|?\n. Since you're defining an actual class, how about putting the required methods in it rather than all the doubles and stubbing?\n. quick idea: https://gist.github.com/jordan-brough/79a8cbc7d115513d1ad7 (addresses the global mutation also)\n(that code probably doesn't actually work, just a general idea)\n. > it appears the global state gets cleared :)\nGreat!\n\nall that matters is the selector and sorter implement find_default and sort\n\nPersonally I side with DHH/Fowler/Beck on this (e.g. this and this) and avoid mocking when it makes sense, and I think it makes sense here.  But I won't hold up this PR if other core team members are OK with it. It can be a point of discussion for us separately.\n. @mtomov of course. :) I just happen to disagree with that side.\n. I think we should not combine the rulesets.  We will get no significant performance benefit out of doing that, it makes for a more confusing data model, imo, and after chatting with Richard we already have some differences between the two that will make the logic uglier. If we have shared behavior between the two then let's make some modules or helpers to avoid excessive repetition. But I think we'll have a saner data model and cleaner code by keeping them separate.\n. :+1: yanking short_ship_unit and re-using this method instead seems like a great idea and a good small step for this PR in making short_ship a bit better.\n. nitpick: extra space here\n. I don't think this will work correctly, will it?  If another Thread comes into this and exits then it'll clear this for all threads.\n. Perhaps we just need to add if @orderMutexThreadId == Thread.current.object_id to this?\n. Oh, also -- the first nested call in the same thread will clear this.  We probably need to move it up to the prior begin-rescue.\n. (And make sure we have specs for both of those cases)\n. @philbirt I know you already called out that the specs could use some improvement, but we'll find a better way to do this other than sleeping right?  I'm no threading expert either but I'm happy to pair up and brainstorm ideas if that's helpful. Just lmk.\n. Could this be expect(zone.countries.to_a).to eq([country])? Just to make the expectation a little stricter?\n. That sounds great to me. Thanks. I'll update if we decide we like this.\n. @BenMorganIO I don't need stock_location_ids and variant_ids separately, I need them associated with each other.  And I need them in a specific enough way (for performance) that it doesn't seem good to move this into the model. Everything here is already using a scope or else is the way it is for perf reasons.\n. I'm having a hard time wrapping my head around part of this.  In current Solidus doesn't the pre_tax_amount depend on where the item is being shipped (i.e. depend on which tax rate should be used)?  Yet here we are always using the tax rates for the default zone right?  Doesn't that mean that the code below from default_tax.rb will compute the wrong amount if the order is actually being shipped somewhere other than the default zone?\nruby\ndef compute_item(item)\n  if rate.included_in_price\n    deduced_total_by_rate(item.pre_tax_amount, rate)\n  else\n    round_to_two_places(item.discounted_amount * rate.amount)\n  end\nend\nWhere am I getting mixed up?\n. +1 on @Senjai's comment\n. Is this here primarily because the Coordinator builds shipping rates before it builds shipments?  Are there other places where we need to build shipping rates without a shipment in hand?  Does it make sense to have a shipping rate without a shipment? It just feels a bit awkward and I'm wondering if there's anything reasonable we could do to avoid this.\n. OK great. Looking at this was what prompted me to submit https://github.com/solidusio/solidus/pull/950, which I think is a good idea in any case, but might allow us to clean things up for this also.\n. @mamhoff would https://github.com/solidusio/solidus/pull/965 be sufficient to remove the attr_writer :order related code here?\n. I'm not a frontend expert by any means, but is it strange that we have to have this bit of code here?  We select all select.select2s on the whole page and apply some settings to them?  Should the scope be limited at all?  Maybe I'm just not familiar with how we're doing this sort of thing normally.\n. This seems like a nice example of something that can live outside of core that only uses defined extension points & interfaces (other than possibly the tweak to promotion_rules/create.js.erb? Which we could put into core if it makes sense).  We could let the community try it out for a while and merge it into after it's been widely used & battle tested.\nOn the performance aspect:  Personally I'd prefer to use a join table for roles -> rules since it lets us use foreign keys for data integrity.  But I know promotions are often a hot spot so I can see the appeal of using a preference.  If we used a join table then we're only talking about one extra query like the following, right?\n[edit: updated after looking at the match policy stuff that was added later]\nruby\nrule_role_ids = promotion_rule.promotion_rule_roles.pluck(:role_id)\nAre we concerned that that would not be performant enough?\n. If the example fails (e.g. raises an exception) this cleanup won't happen. It might be better to use before and after blocks, or else use begin...ensure?\n. TIL.  Thanks!\n. > I still have no idea how a bunch of other tests (especially controller/feature tests) are managing to pass without any apparent creation of a spree default store\n@jrochkind are there any in particular that you see that look weird? I was curious about this also so I took a look at a few specs and the ones I looked at all seemed to be creating a default store in one way or another:\n- frontend/spec/features/checkout_spec.rb (via \"checkout setup\")\n- frontend/spec/features/order_spec.rb (via OrderWalkthrough)\n- api/spec/controllers/spree/api/orders_controller_spec.rb (via order factory)\n- backend/spec/controllers/spree/admin/orders_controller_spec.rb\n. @Kingdutch updated. Thanks!\n. @bbuchalter thanks! updated.\n. @bbuchalter updated. Thanks!\n. @bbuchalter it's really only for taxes.  It means that the adjustment is already built into the price of the item, so we don't count it toward the adjustment_total.\n. e.g. VAT in Europe is an \"included\" tax whereas U.S. sales tax is an \"additional\" tax, in Solidus terms.\n. @jhawthorn thanks! Updated.\n. updated!\n. @tvdeyen @peterberkenbosch updated. Thanks!\n. @tvdeyen @peterberkenbosch hm, I am not sure about this one.  Right now the logic for this is very dependent on this happening during order completion.  Wallet::AddAfterOrderComplete seems like it might be the best we can get right now.  What if we leave it like this for the moment and take another stab at improving things as part of the Wallet work?\n. @gmacdougall I can see what you mean, and I hate to break specs, but we'd rather break their specs than their app, right?  E.g., we're trying this out on our own codebase and having the factory change helped us find a couple extra places where we weren't handling a possibly-nil last name.  In general we want factories not to set attributes that aren't actually required and this attribute is no longer required right?\n. I hope it's true. We don't follow that strictly but I think it makes for more robust tests if we try to make factories minimal by default.  E.g. for this lastname scenario exactly -- you end up writing specs around attributes that the default factories provide but that aren't actually guaranteed to be there.  It's easy to add additional factories that are more \"filled out\", but I think it's nice to make that explicit.  Apps can also use FactoryGirl.modify if they'd like to have lastnames populated by default.\n. This and the change above it are unfortunate. :(  See the commit message for details.\n. Here's an idea for getting OrderUpdater to operate on in-memory objects, to try to avoid problems like the above.\n``` diff\ndiff --git a/core/app/models/spree/order_updater.rb b/core/app/models/spree/order_updater.rb\nindex caff2a6..b21a70c 100644\n--- a/core/app/models/spree/order_updater.rb\n+++ b/core/app/models/spree/order_updater.rb\n@@ -31,7 +31,15 @@ module Spree\n     end\n def recalculate_adjustments\n\n\nall_adjustments.includes(:adjustable).map(&:adjustable).uniq.each { |adjustable| Spree::ItemAdjustments.new(adjustable).update }\nadjustables = Set.new\n+\n\nPrefer using in-memory objects when possible:\n\nadjustables << order\nadjustables.merge(order.line_items)\nadjustables.merge(order.shipments)\n\nIn case someone is attaching adjustments to something other than LineItems and Shipments:\n\nadjustables.merge(all_adjustments.includes(:adjustable).map(&:adjustable))\n+\nadjustables.each do |adjustable|\nSpree::ItemAdjustments.new(adjustable).update\nend\n     end\n```\n\nTwo risks I can think of:\n1) The in-memory objects may be stale.  That might be an acceptable risk in the interest of performance.\n2) The above code will invoke ItemAdjustments#update on all shipments & line items, even if they don't currently have any adjustments on them. That will result in an extra select * from spree_adjustments where adjustable_id = ? for every line item/shipment that doesn't have at least one adjustment (extra compared to the existing code).\nAny thoughts?\n. @jhawthorn great point.  Here's a PR (against this PR) to do that: https://github.com/jordan-brough/solidus/pull/7  Shall I merge that into this PR?\n. Great! I've gone ahead and made it simpler but more correct.\n. \ud83d\udc4d \n. @mamhoff I went ahead and updated a bit because this spec was hard for me to follow when I first read it and @jhawthorn also left a comment similar to yours.\n. What about Rails 5 made this necessary?  It feels like this should be done at the controller level to me.\n. (Same question about the changes in user_address_book.rb and importer/order.rb.)\n. Should we add this (and the others in \"Use render :json insteda of render :text for json\") to the non-Rails 5 branch also?\n. @jhawthorn any thoughts?\n. Hm, I still feel like the .to_h is more appropriate at the controller level, but I don't think it's important enough to hold this up.  I'm happy to see how this feels and readdress later if we feel like it.\n. I'm thinking perhaps we should leave that for a separate PR?  If it was relying on the after destroy then it was leaving the order in an inconsistent state anyway, because it didn't update the order-level totals.\n. Added a github issue for that: https://github.com/solidusio/solidus/issues/1396\n. @jhawthorn thanks, updated!\n. @bbuchalter good point.  I updated to @jhawthorn's solution though, so I've reverted back to has_one.\n. Updated. Thanks!\n. Do we know what other kinds of values do we expect here, besides nil?  E.g. Numeric values?  Is it worth updating the # @param num [String] method documentation, or deprecating unexpected value types, or calling to_s on everything?  (I don't want to bikeshed so I'm happy for this question to be a separate discussion from this PR)\n. ~~Does this mean that we no longer automatically strip whitespace from credit card numbers at the model level? Is that worth a changelog entry? (As far as that might affect line 96 below I mean.)~~\nNevermind, I see that number= should take care of this anyway.\n. @gmacdougall @jrochkind any further thoughts on this?  We've been using this in our app for a while now and are happy with it.\n. @jrochkind:\n\nIs anything in solidus using the return value?\n\npromotion_handler/coupon.rb is the one place in Solidus that is - see here.\n\nfalse for nothing happened (is that even still possible?)\n\nIt is still possible that nothing happened via this, which would return nil. So we also have:\nnil now means that the promotion was not attached.\nI chatted with @jhawthorn about this offline and he wondered whether we shouldn't just have this return true when the promotion was attached and false when it wasn't.\n. @gmacdougall thanks! Updated and opened a PR to remove more of these: https://github.com/solidusio/solidus/pull/1454\n. Updated. Thanks.\n. @gmacdougall this ensures that line_item refers to the same object that OrderUpdater and the promo code & etc will modify. i.e. order.line_items.first.object_id == order.line_items.to_a.first.object_id is not always true in general.\nOur current implementation of the order factory happens to preload order.line_items such that the to_a isn't needed here, but that's not tested and I'm not sure it was intentional either.  Perhaps I could remove it here but make an additional PR that tests this explicitly in order_factory_spec?\n. @gmacdougall sure, I've updated it to unrelated_adjustment.\n. Not a big deal, but just for consistency with the related factory PR should we use f.object.class.attribute_method?(:password_confirmation)?\n. Makes sense. Thanks for looking into it!\n. \ud83d\udc4d Updated in https://github.com/solidusio/solidus/pull/1467\n. Great idea. Done.\n. Thanks! Fixed by the update that groups this loop with the previous one.\n. Agreed. I've added a comment to that effect -- cancellation_total isn't persisted anywhere so we have to extract it here. (The others need to be done in their respective methods so that, e.g., tax calculations have the updated promo totals).\n. Fixed. Thanks!\n. > reducing and removing our reliance on active_merchant\nDitto\n. Instead of defining our own create could we take advantage of Spree::Backend::Callbacks and do:\nruby\ncreate.after :perform_refund\n...\ndef perform_refund\n  @refund.perform!\nend\n?\n. This needs to be flash.now[:error] right? (Though if we use the RefundController#create this goes away anyway.)\n. Now that this isn't invoked via a callback we can just do update!(transaction_id: response.authorization) right? (And remove the following update_columns line)\n. @jhawthorn @cbrunsdon ?  Are you guys wanting to deprecate Spree::Backend::Callbacks?  This seems like the kind of usage they were intended for.\n. I see this is update now. Thanks!\n. > I can only reply to comments on the code\nGithub isn't allowing you to leave PR-level comments?\n. I'd suggest wording this more strongly somehow.  Refunds really should always be performed via create_and_perform! unless you are taking care to delete the refund if it fails (via a transaction or otherwise).  And if you're importing data you won't be \"performing\" the refund.  Right?\n. We should use create_and_perform! here right?  Otherwise a failed perform! could leave an invalid refund in the DB.\n. That sounds good to me, thanks!\n. Hm, I think we actually can't use create.after anymore because we need to use create_and_perform instead of save + perform!.\n. We should use create_and_perform! here also right?\n. Should we perhaps use Spree::PromotionCode.create! here instead of promotion.codes.build ... promotion.save!?  That would avoid loading a million objects into memory if you're generating a million codes.\n. If we add a spree_promotion_codes.promotion_code_batch_id column then we could eliminate this yes?\n. Should we make this a class_attribute as well, in case people want to customize what characters are used for codes?\n. You are breaking this up into batch_size, but since we're putting the codes on the promotion they'll all stick around in memory right?  Maybe another solution could be to load our own promotion object after every batch_size iteration? (or reload the existing one)\n. I like how this separates creating a single code (via this controller) from creating a batch of codes (via the batch controller).  There's probably even further improvement we can do along the lines of creating single codes, but it seems like that could be a separate PR.  Possibly part of #1509?\n. Nitpick: Might as well use find here, rather than find_by_id so that it raises with a clear error message if the id is invalid?\n. Might want to leave a code comment to that effect? (about why the reload is needed)\n. Can we add some RDoc to this method, letting people know that they should always use this to save a refund unless they are importing data? (Until we do something like add state column and perhaps can get rid of this method entirely)\n. Can we restore the private here please? Since everyone should call this via perform_and_save!.\n. perform! calls update!, so we don't need the save! here, right?\nWith the current state of this PR we could possibly even get rid of perform_and_save! and just have perform!.  But for now (until we add a state column) I personally think it's worth having perform_and_save!.\n. Updated. Thanks!\n. What does this do?. Not a big deal at all, but \"Put your terms and conditions here\" would probably be the more standard english way to say this?. Could we add a comment here that they'll need to add the actual terms and conditions in app/views/spree/checkout/_terms_and_conditions.en.html.erb in their app?. @jhawthorn this will make the admin UI more helpful. If a batch fails you can go in and see the reason that it fails.  E.g. a customer service rep tries to create a promo, it fails for some reason, they tell a dev, and the dev can easily see what happened (and go look in their exception reporting tool or whatever for more details).. Moving the email to the Job makes sense to me but I think setting the error on the promo_code_batch should stay here.  We allow a row to exist in the spree_promotion_code_batches table when it may have failed part way through, so marking it with an error makes sense to me, and this seems like the place to do it.. @jhawthorn good point.  Since this model represents a \"batch\" which can't reasonably be completed within a transaction, perhaps we should have some sort of state column on it and not just infer the state by counting the codes on it.  Maybe started_at/errored_at/finished_at columns?  Or a state column?. We should add an index on this column. We should add index: true on this. Personally I'm not a huge fan of that module, and most of it is going away.  How about the reverse - bring the has_many from that module into here? Then the whole module goes away soon.. The method will only be used when there is a user for the order.  The next line will fail with a NoMethodError: undefined method 'wallet' for nil:NilClass if there isn't a user.. Did you intend to use CreditCard here instead of Spree::CreditCard?. WalletPaymentSource instead of Spree::WalletPaymentSource?. why is this in a block instead of alongside the other attributes? . if you use your in-migration classes you can just do credit_card.default right?. we'll need some tweaking for the includes to work with the in-migration classes right?. I wonder if we should hold off on actually dropping this column for another release.\nLooking at it again right now I feel nervous about dropping a payment-related column like that.  Holding off would make the \"down\" migration simpler also.\nThoughts?. \ud83d\udc4d I stared at this at least 10 times and still managed to miss the fact that you'd changed it from create to find_or_create_by :). The Spree::CreditCard#default method does have deprecations, but if someone was doing a Spree::CreditCard.where(default: true) I'm not sure how we could add a deprecation for that.  Perhaps we could rename the column to deprecated_default instead of dropping it?  Or just go ahead and drop it?. @cbrunsdon that code you referenced (and the add_default_payment_from_wallet method that calls it) is a no-op when order.user is nil, right?  Is that what you're asking?. Also the AddPaymentSourcesToWallet code is a no-op if order.user is nil.. I also checked our permitted attrs and it looks like they prevent setting credit card defaults via the API so I don't think there should be a problem in that direction.\nAnd the admin doesn't allow setting the default attribute either.\nI'm not seeing any other code that tries to set the default on a credit card, other than the above items.. You mean 2017-01-17 right? :). Just curious - any reason not to use the payment factory here?. If we remove distinct: true and you search by promotion code then we get 1 result for every promo code instead of 1 result for every promotion.  We really ought to have a spec that covers this but apparently we don't.. We don't have indexes on name, description, or usage_limit.  I think we might want those indexes before enabling sorting in the UI.. Two thoughts:\n1) Instead of promotion_includes and promotion_references, maybe we should just have promotions_scope\n2) Maybe we should provide a config instead of requiring a monkey-patch\nE.g.:\nruby\nmerge(Spree::Backend::Config.promotions_index_scope).\n?. It's compat with older Ruby. Solidus currently only requires Ruby 2.2.2 so we can't use the safe navigation operator.\nhttps://github.com/solidusio/solidus/blob/1a556fb/solidus.gemspec#L15. We already have a validation for code presence so I don't think we need to consider nil values.  Also I think we should use self.value = value.strip (not bang method and not worry about internal whitespace).  Open to others' thoughts on that.. > I agree the ArgumentError is not a drastic improvement. I discussed this with @jhawthorn on Friday and would be okay just letting it error the usual way too.\n^ I agree with removing the nil check.  The prior code didn't actually protect against nils and as @mtomov mentioned it doesn't really add much and we don't do it in most places. Could we remove this until we've had a chance to look at options on the interface a bit?. Oops, yes, I meant both.\nThe PR looks really great! I'd love for us to merge it but it would be great to have a chance to collaborate (maybe even at SolidusConf?) on the interface before committing to it.\nIf that sounds OK could we perhaps also mark these two new classes as @api private for the moment, as we had done for the Tax::ItemAdjuster class?. If this fails where do we find out about it?. This is likely outside the scope of this PR (since the same thing happens in the old code as of v2.1) but is this really what we want?  E.g. if an order is complete and I change the quantity (and thus price) of a line item, don't I need to update the VAT amount I have recorded for that item?. Would ItemTax be a clearer name for this? (Same question for TaxedOrder). How about item_id instead of id? (Same question for the id in TaxedOrder). To me at least it doesn't seems clear that I need to go unlock tax adjustments before modifying completed orders.  (Either via the Admin or some other way)  Again, possibly outside the scope of this PR, but between v1.4 and v2.1 at least we did update taxes on completed orders, if I understand the code correctly.. Nitpick: Don't need this if right? The logic in the else would handle it?. Since inverse_of is currently broken in Solidus it's probably worth adding it to these since we're starting fresh with them?. \ud83d\udc4d absolutely agreed. FYI I opened a PR just today actually: https://github.com/solidusio/solidus/pull/1917. s/id/item_id/ right?. did you intend to give a newline for the promotion_action option?. I'm not sure this is worth fixing, but we check the currency here at the line level but we don't check it again in WeightedAdjustmentsHandler.  That's fine in real life since we know that behind the scenes the line item delegates the currency to the order, but it seems wrong somehow to have to know that?. It would be great to have some comments explaining this calculator. Maybe total_amount instead of preferred_amount?. Not super important but could we add a sort_by(&:id) to this? Just to avoid the \"rounding penny' from ending up on different items in different runs?. I think we want to use line_items.length here to force the association to load if it hasn't already, and avoid the db-query that count will always generate. I think we have this problem all over the place, but we should round according to the number of fractional digits of the currency, not 2.\nI think it's fine if we leave it as round(2) in this PR (unless you want to have a go at fixing it) and I'll open a separate PR for the more general issue.. WeightedAmounts?. Or maybe DistributedAmount (singular instead of plural, since the amount specified to the calculator is a single amount?). agreed \ud83d\udc4d . Actually that would make the big-o worse for something that's already a bit worrisome.  Maybe that's not worth it.. Something similar to whatever you choose for the calculator name seems fine imo.  Should this go in the models/spree/promotion/ folder somewhere though?. Accidental change here?. Yah my concern was that we're only checking one of the line item currencies. When you see line_item.currency that doesn't guarantee that all the line items are the same currency right?  (They are but the interface doesn't make that clear.)\nPersonally i think it'd be more intuitive to see us check line_item.order.currency (or line_item.order_currency).\nBut like I said, probably not worth worrying about too much.. \ud83d\udc4d FYI the github issue: https://github.com/solidusio/solidus/issues/1957. @isaacfreeman the preceding text is the tooltip. This is the text that always shows. Please see the screenshot in the PR text.. Thanks @isaacfreeman. I went ahead and added a commit to fix the typo.. I'm going to go ahead and merge this as-is but would be happy to see a PR to improve it from either you or @graygilmore . Just curious - So these don't happen automatically when you use the :test adapter?  And there aren't any nicer helper methods?. Did you intend to leave this comment in? 19 seems OK to me (slightly confusing but does make sense from a certain POV). Did you intend to implement this spec?. Completely agree.  I'll switch to with_name_or_abbr with a deprecation for the old method.. At the moment we do, unfortunately.  We could try to avoid the duplication by combining the contents of these two lists when reading the values, but I wonder if you might want to remove a shipping promotion action from promotions.actions so that it doesn't show up in the admin UI, but you'd want to keep it in promotions.shipping_actions so that existing orders & promotions would continue to work?\nVery open to ideas on this.. Might need to use the credit_allowed method here instead of amount?. @jhawthorn nice, I hadn't seen that before.  Added.. @kennyadsl here's the case that I'm thinking of:\n\nDeveloper creates a OurGreatShippingAction promo action and adds it to the list\nAdmin creates a promo using that action\nThe store decides not to do any more of those promo actions and a developer removes the OurGreatShippingAction from the list so it doesn't show up in the admin for new promos anymore.\nHowever, if this also removes the action from Spree::PromotionHandler::Shipping#active_shipping_promotions then that means that the existing promo will cease to work as well.\n\nSo we need 2 lists -- one list that indicates what actions should be available in the admin, and one list that indicates what promotions to consider in Spree::PromotionHandler::Shipping#active_shipping_promotions.\nThe difference from other promo actions is that other promo actions don't need a special invocation to work correctly -- i.e. other actions don't need a before_transition from: :delivery, do: :apply_shipping_promotions in order to work correctly.\n. A couple other possibilities:\nA) Just decide we don't care about the scenario above\nB) Figure out how to make shipping promotions work correctly without the before_transition from: :delivery, do: :apply_shipping_promotions transition (i.e. eliminate the need to even have a Spree::PromotionHandler::Shipping class at all).\nC) Think of another way to identify Shipping promo actions in Spree::PromotionHandler::Shipping.  Perhaps all Shipping promo actions must inherit from a base class?  Or have a is_shipping field on the action?\nIt might be worth just going w/ what's in this PR and iterating on it?. Would you mind making this a normal if instead of a trailing if?  The condition is quite important, as you've pointed out, so it'd be nice to make sure it stands out. You don't need this because the default promotion has no rules and is eligible, right?. Rather than stubbing would you mind instead creating a promotion that will in fact not be eligible?  e.g. \nruby\nlet(:promotion) { create(:promotion, :with_item_total_rule, item_total_threshold_amount: 1_000, ... }. \ud83d\udc4d thanks. Added a spec as well.. You want to set apply_automatically: true in this context rather than code: 'freeshipping', right?. Any reason not to use a whitelist here, rather than permitting everything?. We should either remove the on: condition here or have a more robust way of determining whether a refund needs to have a transaction id.  With the updates from this PR we no longer need the on: for Solidus usage since the transaction id is fetched before the record is validated.\nI might be inclined to just remove the on: condition and require that things like data imports supply a manufactured id of some sort, if they don't have one already.. Could we please also check here that no Refund object is created when a failure occurs?. Could we change this to something like expect_any_instance_of(Spree::Refund).to receive(:perform!).and_raise(...)?  So that a test around not creating a Refund is a bit more likely to be meaningful, now that Refunds are able to be created without having been processed?. ",
    "magnusvk": "Yes, that sounds right.\n. :+1: \n. :+1:\n. Better viewed without taking whitespace into account: https://github.com/solidusio/solidus/pull/12/files?w=1\n. Jenkins: test this please\n. Jenkins: test this please\n. @cbrunsdon @jhawthorn @gmacdougall Good to merge? \n. And now I need another thumbs-up from @athal7 or @jordan-brough.\n. :+1:\n. So; I'm ok with merging this so we can run migrations without warnings. However, long-term we need to find a better way of getting our database into a good shape. Running all historical migrations is stupid and not a good way of getting to a sane database. Just want to start planting that thought.\n:+1: \n. @gmacdougall Is this still something we'd want to merge? Or should we close this out? As far as I'm concerned, we probably should, right?\n. If that works :+1: \n. :+1: on the plan of not rescuing exceptions unless there is a specific message / return code associated with a specific exception.\n. :+1: \n. :+1: assuming this goes green\n. The admin change is interesting: I think everybody outside of the engineering room will forever be calling this \"Spree\". Explaining to them that it's the same, but different, and now called a different name may not be worth it? But then again if somebody started from scratch with Solidus and the admin said \"Spree\" on every page, I assume it'd be weird as well. Curious what other people think.\n. I agree with the principle. admin is much better than backend. Just not sure how much work it is. If it's a reasonable amount of work, we should do it.\n. :+1: \n. yup, this looks good\n. :+1: I also just checked that this table is empty for us and it is.\n. :+1: \n. :+1: \n. I think you want to rebase this on a1632ea, right? Looking at just 7b7f20d this looks good :+1: \n. :+1: \n. Looks good otherwise. :+1: \n. :+1: \n. :+1: \n. I like this. :+1: on the principle in this. However, hard to review this for things it might break as it's a pretty large diff but code seems to be mostly just moved around. \n@jhawthorn How do you feel about the need for more QA around this? Or do you feel confident this won't break anything?\n. @richardnuno for another look?\n. @richardnuno The failure here looks real. Getting this:\nuninitialized constant Spree::Order::InsufficientStock\nMaybe that exception changed name or something? Not sure, but would be good if you could take a peek.\n. Jenkins test this please\n. Looks good :+1: \n. :+1: \n. I agree a deprecation warning would be good. Looks good though. :+1: \n. :+1: rebase on latest master now that #121 is merged?\n. :+1: \n. :+1: \n. :+1: \n. Did another grep through; indeed not used anywhere. :+1: \n. :+1: \n. :+1: \n. Still :+1: \n. :+1: \n. :+1:\n. Closing in favor of #169 \n. :+1: \n. :+1: \n. If anybody ever wondered why we are forking... :+1: \n. I like that approach. :+1: \n. Question: If we tackle the TODOs that are above and below this, might that obviate the need for this? I don't know enough to see why we need the reload, but that may be worth tackling if that's the case?\n. Cool, I'm convinced. :) :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. This is cool. :+1: We love bourbon here.\n. :+1: on this but also @jordan-brough's comment.\n. @athal7 I assume your 'lgtm' constitutes the second thumb here? Can I hit merge on this? Or feel free to do so yourself.\n. :+1: \n. :+1: \n. :+1: \n. @jhawthorn 73fcf04 addresses your comment re: using JSON rather than evaluating server-generated Javascript. Can you take another look over this to see if this is ready to get a thumbs-up? Also already got a thumb from @gmacdougall in the original PR at https://github.com/bonobos/spree_store_credit_payment_method/pull/67, though there's been more changes since.\nAlso @athal7 want to take another look? This is a blocker for us before we can go live on Solidus, so trying to get it merged. :)\n. @athal7 @jhawthorn Good points. Updated.\n. I still prefer .inventory_units.reload to .inventory_units(true) but either way :+1: \n. Do we want to add #176 (better token auth) somewhere here? I see this maybe in 3.\n. I have zero context on these but given that we don't use frontend here I'm just going to give you a blanked :+1: for the Bonobos side :)\n. \ud83d\udc4b blast from the past here. \ud83d\ude43 . I agree with Andrew -- I think we do want to support a carton having items from multiple stores. I think there's a couple of variations of 1) though: We could, for example, send one email for the carton and use the store of the majority of items. Or we could use the store that the order was placed in. Ultimately we want to end up in a place here where we can even share carts, so I wouldn't want to lock this down further.\nBut that's just my two cents here...\n. :+1: \n. :+1: @jhawthorn want to take another look at this now that it's updated? I think it's ready to merge.\n. :+1: \n. This looks good to me, though I'd love another set of eyes from @jordan-brough or @athal7 as to how this would play with the custom work we've done around this ourselves.\nAlso, do we want documentation for this somewhere?\n. That looks great, thanks for sharing that.\n. Nice. :+1: \n. :+1: \n. :+1: \n. :+1: Let's add a mention in the docs and then this is ready to go.\n. :+1: \n@gmacdougall @cbrunsdon @jhawthorn Does this look good?\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. I still like this. :+1: \n. :+1: I presume you verified that default addresses still get associated with orders in our store?\n. Indeed.\n. :+1: \n. :+1: on this and agreed with John's point on removing the indexes if they exist.\n. :+1: looks great\n. :+1: \n. @jordan-brough Steps to reproduce the issue, on our store at least:\n1. Check out with bill and ship address being the same.\n2. Go to checkout again; your bill and ship address are saved correctly\n3. Change your bill address while leaving the ship address unchanged\n4. Check out\n5. Check the user -- their saved bill address is now incorrect\n. Ok, let me look at this code some more and try and come up with a better regression spec for the bug scenario above.\n. After doing some more digging, here's what is going on in our case: During the data migration, the addresses that were created for user's default billing and shipping addresses are the same exact row in the database if those addresses historically matched. Given this code here, that will only ever preserve the shipping address because it assigns the values of the order's billing address to this one record first, then overrides it with the shipping info. I verified that this works correctly for a newly created user, but not for my user which was migrated.\nGiven this, going to close this PR here and either address in Bonobos-land only or ignore until we have Jordan and Greg's new work.\n. :+1: \n. Solidus has a different order locking system; this duplicated that, and in an incomplete way IIRC.\n. Yup, that's exactly right.\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. This is resolved by #227.\n. The only other place ensure_line_items_are_in_stock is used is in before_transition to: :resumed which a) nobody uses and b) should use the same, better logic in validate_line_item_availability if we did want to support it.\nSo I'd vote for removing the method entirely.\n. :+1: \n. :+1: \n. I like this new syntax so much better... Thanks for doing this.\n. :+1: \n. @jordan-brough I'd be in favor of bringing that over.\n. I'd never even heard of Spree::Tracker. :+1: on this. Though I'd raise the question if we should just remove Spree::Tracker entirely and provide some sort of tag manager instead? This seems awfully tied to one particular vendor.\n. Looks like there's still some real test failures here.\n. :+1: \n. :+1: \n. I wonder if @jhawthorn is going to ask for a spec here but personally I'm :+1: without one.\n. Also would be nice to have a spec that tests whether this works to make it easy to verify whether we need the after_save :touch.\n. So, not to be difficult or anything, but if it is necessary and it's not easily apparent to us as to why, then it should have a spec that fails if it's not there.\n. :+1: \n. A question, though: This is the refresh totals screen, right? I've always wondered why we don't just go ahead and do that automatically and save the ninja an extra click. But happy to address that idea separately.\n. @jordan-brough :+1: on not triggering mutations in GET requests, I didn't think of that.\n. :+1: though... We could think about making api/products less terribly slow at some point, as that does seem like a sensible endpoint to use.\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. Ok, an update here:\n- Rebased ontop of latest master to address merge conflicts\n- Removed duplicate payment methods in sample data; this fixes the sandbox issue @jordan-brough was seeing\n- I tested this on the Bonobos store and ran into one issue: The solidus_multi_domain extension overrides self.available and was still trying to use environment. Curious what you think of https://github.com/jordan-brough/solidus/pull/1 to enable a more stable extension approach as seen in https://github.com/solidusio/solidus_multi_domain/pull/12. This feels perhaps more heavy-handed than needed; an alternative would be to just move over this logic from solidus_multi_domain to core.\nCurious on thoughts on how to make this work with solidus_multi_domain and also another look-over of the updated PR.\n. @solidusio/owners Rebased this again. As far as I can tell this is ready to merge. Cool to pull the trigger?\nAlso: New way of dealing with this change in https://github.com/solidusio/solidus_multi_domain/pull/13\n. :+1: \n. Can we maintain backwards compatibility for binary_inventory_cache? I.e. if that's set, set the inventory_cache_threshold to the correct number automatically? That way we can be backwards compatible for existing stores. And it's a nice shortcut anyhow. [I suppose I should start reading prior comments to avoid just repeating what other people say. :) ]\n. :+1: looks great\n. :+1: \n. :+1: \n. cc @jordan-brough who requested this\n. :+1: \n. Either way works for me. We don't use any of this anyhow.\n. :+1: \n. @jhawthorn Yeah, a migration to add an ID field and also timestamps would be great.\n. :+1: \n. :+1: this looks good minus the failing specs\n. :+1: \n. :+1: \n. If you look at BestPromotion and LastPromotion, they are almost identical. That's a lot of common code and we should refactor those classes to share that code. Really, if you look at it, the only difference is in the best_promotion_adjustment / last_promotion_adjustment method, so it looks like a base class that has a method to override for that might be the way to go.\n. Also would be great to provide some documentation for this.\n. Another question: The logic in ItemAdjustments operates on an item-by-item level. So if you have an order with three line items and a shipment, it may apply different promotions to each of those. For example, if one promo code only generated an adjustment on the order and another one only generated an adjustment on the line items, those would stay active at the same time, right?\n. As far as Bonobos goes, yes, our intended behavior is for only one promotion to be active at a time. So that's really another level of customization here.\n. :+1: \n. :+1: \n. @jhawthorn I was chatting with @jordan-brough earlier today about potentially having a central place for checkout-specific extension points like this. In his case, we were talking about an extension point for \"after credit card added to order\" and \"after new ship address added to order\". Perhaps now is the point to make a Spree::CheckoutCustomizations or Spree::Order::CheckoutCustomizations class, where all it has are these extension points? Would make it nice and easy for somebody new to Solidus to find all the things they can safely customize, also. Curious what other people's take is on that.\n. @jordan-brough that looks good to me. Let's put it there.\n@richardnuno Can you just move the configuration over to live in the AppConfiguration? Then we can hit merge here.\n. Great. Let's :ship: :it: \n. This looks good, though the spec failures appear real.\n. :+1: \n. :+1: Spec failure seemed unrelated, yeah?\n. :hocho: :+1: \n. :+1:\n. Thanks for splitting out the migrations. This still doesn't allow me to deploy this one at a time, though. I was hoping for there to be one commit for each HABTM that is removed so that I can deploy and go live with each intermediary step. So that would require a significant history rewrite but I don't feel good deploying this without that.\n. I think that would probably be optimal, yeah.\n. Given that this isn't a ton of code, maybe it makes more sense to just manually pick the code over one HABTM association at a time? (Rather than using git.) I mean, either way works for me of course, but that's probably what I would try here.\n. Also, thanks for doing that extra work!\n. :+1: @jhawthorn does this look good to you?\n. I'm fine with this either way. I'm :+1: if we want to merge it but if we decide not to, that's good too. I mean, it really probably isn't necessary because if someone is using this to extend, it should fail in a fairly visible way. But again, either way works. :)\n. Nice way to use SQL here. :+1: \n. :+1: I think this is great.\n. :+1: \n. :+1: thanks for pulling this out\n. :+1: \n. I think this looks good. :+1: from me; @jhawthorn should we merge this? Or loop another entity controller into it first?\n. Great; hitting merge here as Andrew is out.\n. :+1: \n. :+1: \n. Looks good. :+1: Let's get this merged first; then maybe we can have a discussion about deprecating and renaming the routes on a separate issue?\n. :+1: \n. :+1: \n. This looks good, though I'd want to split up the migration. As this stands, the whole migration will run in one database migration which feels dangerous and I don't think is necessary. If we had one migration per rename, it would run each in its own transaction.\n. :)\n. Great work here @jordan-brough!\n. :+1: \n. :+1: \n. :+1: yeah let's get rid of it\n. :+1: \n. Yeah, public API tagging is on my todo list even for the class-attribute extension points we have. I also want to generate a doc that lists all the supported extension points from that.\nWhen I was digging on this, I was thinking about using yarddoc's @api tag for this. Then it would be\n# @api public\nI haven't actually tried using that to auto-generate a page yet, but that feels like the right place to start?\n. I think this looks cool. Interested to get some more eyes on it. Also the question on whether we want to centralize all the customization hooks ore leave them scattered around different places like this\n. We just chatted about this in the Solidus sync and we agreed that preserving selected shipping rates is what we'd want as default behavior, so rather than providing an extension hook for this let's just fix Solidus master to work that way. Is that good, Richard?\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. This looks great overall. Keen to still chat a bit more about OrderUpdateAttributes.\n. I've long wanted this, so :+1: from me. I'd definitely want to use this for Bonobos.\n. :+1: \n. These are great, thanks @grzlus for writing these and @jhawthorn for picking them over. :+1: \n. Looks like the spec failures are real? I do like this change otherwise.\n. :+1: \n. :+1: from me. @jhawthorn?\n. :+1: I'll merge when the specs go green.\n. :+1: \n. :+1: \n. This looks good. I'd like @richardnuno to also take another look at this. \n. :+1: \n. @philbirt That spec failure looks real, right?\n. Looks great otherwise.\n. Thanks! :+1: \n. Closing this in favor of #376. Thank you for reporting this and for the failing spec here, much appreciated!\n. :+1:\n. And yes, picking this over to 1.0 makes sense.\n. :+1: \n. :+1: \n. Agreed. :+1: \n. :+1: \n. Is this solved by #389?\n. Jordan, I think you are right. Updated.\n. @jhawthorn good to merge?\n. Reading through this again, I would like to merge this PR as is. We always talk about keeping the surface area of changes as low as we can. Well, this is the minimal change: Always pass the new order. If we want to change the way we handle unexpected exceptions that's cool with me but I'd like to address it in a separate PR. I wouldn't even collapse the two rescues as that would change behavior in that it would change the message.\n@jordan-brough @cbrunsdon Is that ok with you?\n. :+1: for using update_columns less and enabling better extensibility, which this will do for us.\n. :+1: \n. :+1: I love that this makes the specs fail. But that seems (thankfully) unrelated.\n. :+1: \n. This feels like the sort of thing where you'd have a bang method that saves and a non-bang method that doesn't, rather than using a parameter? Not a strong preference but that's what I would have done given the existing method name.\n. :+1: \n. @jordan-brough How would we use this in spree-backend? Would we write our own custom CartonMailer from scratch, or try to reuse the code from Spree::CartonMailer somehow?\n. Well yeah, but that seems a little crazy. I'm :+1: for this and writing our own from scratch.\n. :+1: \n. We do use this route in production for Bonobos right now, so we do have to worry about compatibility at least for ourselves.\n. :+1: \n. :+1: \n. :smile: thank you\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. This takes away all user management ability. Is that what we want to do? Or is there a safe way to do this that doesn't go quite as far? Maybe just blacklist email in that scenario?\nWith this one, I'm concerned about admin accounts that also have orders in them. Ninjas wouldn't be able to manage those accounts at all, right? Would they still be able to process, say, a return exception?\n. Yeah I'm :+1: on this\n. :+1: this looks reasonable. \n. I'm :+1: on doing this. I think the current behavior is frankly kind of crazy.\nNaming suggestion: apply_automatically\n. :+1: great work\n. :+1: \n. Yeah, I like that even better. :+1: \n. Yeah. :+1: from me.\n. Some discussion that's pertinent to this on https://github.com/solidusio/solidus_signifyd/pull/9\n. Well, we're not multi-currency, so we don't care about homogenize_line_item_currencies. From reading the spec, it seems that method is intended to support switching currencies on an order. So if you flip an order from USD to EUR, say, it would also flip all the line items to EUR if there's a EUR price available or raise an error otherwise. That sounds like sensible behavior to me, but it's certainly not something we rely on.\nAnyhow, I'm super excited about eliminating updates without callbacks, so :+1: on this approach. Still a little nervous about the potential impact of this. Perhaps we should put this on a dev box and see how it works for us?\n. Does this still look like something we'd like to ship? It does to me!\n. :+1: \n. :+1: \n. I'm :+1: on this. I'd be happy to consider moving this to a separate controller but would probably do that in a separate PR. @cbrunsdon?\n. @jhawthorn I'm curious to chat more about how to address your concern better. Would it be helpful if we moved this logic to Spree::Order and then just called Spree::Order.apply_store_credit(user) or something like that from the store credit hook?\n. @jhawthorn You didn't actually answer my question:\n\nI'm curious to chat more about how to address your concern better. Would it be helpful if we moved this logic to Spree::Order and then just called Spree::Order.apply_store_credit(user) or something like that from the store credit hook?\n. :+1: thanks for the cleanup @jhawthorn \n. This looks reasonable to me. Would love to get @jordan-brough's eyes on it. The spec failures looked unrelated.\n. @philbirt @jhawthorn Any more thoughts on this? It looks like #502 doesn't require this as it currently stands. Should we close this or is this still something we should go after? IIRC @jordan-brough had code for this that worked that we could try and bring in here. But I wouldn't be opposed to just closing this on account of \"we are not sure enough we'll get it right.\"\n. :+1: \n. :+1: \n. I don't have strong feelings about this, but I like the consistency with Rails. :+1: \n. :+1: @philbirt do you want to squash or should I hit the big green button?\n. Can you squash this into one commit for us? Otherwise I'm :+1: on this. Thanks!\n. Harder-to-read code is often faster than \"prettier,\" more naive code. But performance matters, particularly in a framework like Solidus. If we have solid tests around these methods I don't see a problem with adding this complexity to make them faster.\n\nI'm just curious if this is a premature optimization -- is this only an issue in contrived examples or does this actually happen in real stores? If the latter, I'm :+1:.\n. I'm :+1: here. Let's wait what the great @graygilmore has to say.\n. :+1: \n. :+1: \n. :+1: \n. Rather than requiring 5.1.x, would it make more sense to relax to constraint to support both?\n. :+1: \n. If we intend to allow for overriding this we should mark the method as // @api public so we know not to change it without deprecation warnings. Otherwise :+1: on this.\n. :+1: from me. @jhawthorn are you ok with leaving the parameters as an argument or would you prefer that being pulled out?\n. :+1: \n. This is great. :+1: \n. :+1: \n. Still :+1: :)\n. @exsuzme If you rebase on the latest master this should go green. \n. :+1:\n. Closing this as this is now locked to a working version in master.\n. \ud83d\udc4d to John's comment.\n. So this block is adding deprecation warnings on something that currently would just error? Is that a good thing?\n. :ship: :it:\n. Would be nice to keep the syntax consistent with above and use the lambda rocket?\n. I would write this in one line; but this works fine if you want to leave it.\n. The changes in this file look good, but possibly unrelated to the purpose of this PR?\n. Ok, cool. I'm :+1: on the change, just wanted to make sure this didn't sneak in here somehow.\n. Like this?\nvar flash = { success: <%= flash.discard(:success).to_json %>, error: <%= flash.discard(:error).to_json %> };\nif(flash['success']) { show_flash('succcess', flash['success']); }\nif(flash['error']) { show_flash('error', flash['error']); }\nChatting with Richard on this, want to make sure we understand your question correctly.\n. Or maybe we should check whether it's possible to use the default handling for flash here?\n. I was confused that we use :edit here and :update below. Turns out those are aliases but consistency is nice so I'll nitpick here.\n. Chatting with @Senjai we think it'd be better to check against can?(:manage, Spree::UserStockLocation) here.\n. Not to throw sand in the gears here but if these two rules behave differently, wouldn't it make sense to allow preferred_nth_order to be 1 here, so that the user can choose which promotion logic s/he wants?\n. What if NthOrder required a signed-in user?\n. Yeah it just seems like a weird restriction from a user point-of-view to me.\nAlright: I'm :+1: on this and happy to merge it as is. But for what it's worth, I'd actually want to get rid of the first order promotion. I think doing this without requiring user sign-in is almost a little silly particularly in times where I can just add a +1, +2, +3 to my email address to keep using a first order promotion. And outside of that difference the two promotion rules behave the same, so it seems simpler and more logical to have just one.\nBut again: happy to follow the majority here, just wanted to chime in with my two cents.\n. Why this? Is this testing a deprecated action? May be nice to have a code comment here why we decided to silence.\n. Ok, reading the comment above, we only want to silence for the :next case, not the :complete case, right? Is that too much of a pain to accomplish?\n. I could but I dislike them and we prefer this approach instead. They clobber your stacktrace, making it really hard to see where a failure occurs. And I don't see how they are better. But I'd be happy to learn otherwise.\n. Also note that this spec doesn't check that the user's addresses now equal the orders addresses, just that no new addresses were created. That's why the spec didn't catch our specific bug scenario.\n. Oh, and: Try this code on the console. Doing b_address.attributes = order.bill_address.attributes.except('id', 'updated_at', 'created_at') is a no-op. That doesn't do anything. I believe this code is intended to clone the address but doesn't?\n. vieweing -> viewing. Magnus, the German master of nitpicking!\n. What about calling through to self.class.model_name here?\n. This seems weird. Doesn't that just trigger another, unnecessary update.\nCan we either:\na) remove it?\nb) if that doesn't work just do after_save :touch_all_products?\n. nitpick on the double it\n. and the is here seems superfluous also. adding value with my nitpicks every day!\n. Shouldn't we take refunds into account for the canceled state above as well? I.e. if you got a refund and then canceled your order, we should subtract the amount of reimbursements from the amount we now owe you, right? I'm thinking something like this:\nruby\n      # If reimbursement has happened add it back to total to prevent balance_due payment state\n      # See: https://github.com/spree/spree/issues/6229\n      adjusted_payment_total = payment_total + refund_total\n      if state == 'canceled'\n        -1 * adjusted_payment_total\n      else\n        total - adjusted_payment_total\n      end\nSimplifies the code a bit, too?\n. Should we add a test here that makes sure we take this into account for canceled orders as well?\n. Looks like it may make sense to eager-load the :option_type association here?\n. count(1) is the same as COUNT(*), yeah? If so can we write it as the latter? :) I was confused by the count(1)\n. I took me a while to figure out what this does. I think this make sense and is cool but personally I could have used a comment explaining how this works.\n. Yeah the group('variant_id') should take care of duplicates.\n. Any reason not to do the symbol :variant_id here?\n. Should we also deprecate the old scope and add finalized and not_finalized scopes instead? I find it slightly confusing that this is the one place where we still use closed and open.\n. Same here.\n. finalized_adjustment?\n. Hm? I'm confused. Now that the adjustments aren't called \"open\" anymore but \"finalized\" it seemed more straightforward to call it that. I was just suggesting a rename of the let! from :closed_adjustment to finalized_adjustment for consistency. It seems like that's only used locally so shouldn't be a lot of work?\nBut! Totally :+1: for merging this as is, this is just me nitpicking.\n. We should add @api public here to mark this as supported.\n. I really kind of like semi-colons. I think semi-colons are beautiful! :smile: \n. I'm :-1: on the 303 as well; it's another HTTP request we're talking about there and I don't really see for what given that we've extracted the method.\n. Should this be .to be false instead? Or is it just falsey?\n. Any reason not to go check it's actually gone in the database?\n. Same here. My instinct would be to check that the update happened in the database.\n. I see the argument of \"the address book itself is the resource.\" But if it's taking all of us a while to wrap our heads around, then maybe that's just not worth it? It wasn't intuitive to me either. What if we went with scoping it in the user? I.e. /api/users/34/addresses, /api/users/34/addresses/1234? That would have the added advantage of allowing you to build an admin panel around that API that manages others' addresses (though then we'd have to check for that permission). That seems more intuitive to me.\n. yeah that's fair; I was thinking the same when I got to the unit test. let's leave it\n. Yeah I'm with @jordan-brough and @jhawthorn on this. I think the assignment in the conditional makes a lot of sense here.\n. Extracting this into its own class like this seems like a lot of boilerplate for the benefit of extracting just about 10 lines of code, no? Or are we intending to add more stuff to this class later?\n. I don't think I understand this change or why it's necessary.\n. We should move these to precompiled Handlebars templates like https://github.com/solidusio/solidus/commit/e757bdb04649d0068c848a29376d83baafc3f0b0 did.\n. At the point of this being a one-liner, should we inline it above?\n. Ok thanks for that explanation. This code is kind of crazy but not going to fault you for that. :)\n. I can't find anywhere that uses this code. Remove it?\n. Yeah good point; done.\n. I think I'd just collapse these and not think about rescuing non-StandardError exceptions. Like, what do you even do with a NoMemoryError? But I don't feel strongly about that. Doesn't seem clear to me what else to do though.\n. <nitpick> I would capitalize Slack here</nitpick> (also, ignore me)\n. No technical reason this couldn't be 1, right? So should this be greater_than_or_equal_to?\n. I'm still not a fan of the fact that we define this twice even though we already have a module in place which we can use to DRY this up.\n. @jhawthorn would be nice to hear your take here.\n. Can we just leave this in apply? I don't see the point of extracting one line of code that we only call once.\n. This class I like a lot.\n. I would probably just inline that code below, but that's a nitpick.\n. <nitpick> I don't like ending a method with a block like that; I don't find it particularly easy to figure out that's what the method returns. If I were writing this, I'd assign the result of the block to a variable and then explicitly return that variable on the last line.</nitpick>\n. Oh, I know it will return the hash. I just don't find that to be very readable code.\n. Isn't restart_checkout_flow called a good amount? To me that feels safe enough and it would accomplish what we need, wouldn't it?\n. restart_checkout_flow already calls .next! on the order. I kind of wish it did an advance itself, though I'm not sure introducing that change here is the best way to go. So perhaps we'd have to advance the order ourselves?\n. Are you familiar with the immutable address work? I'm not sure this will work as you expect it to be, as all persisted addresses are immutable. It feels to me that there's a better place for this logic, perhaps here. cc @gvaughn also who may want to take a look at this.\n. ",
    "gmacdougall": ":+1:\n. :+1:\n. :+1:\n. This looks good to me. I'd appreciate another set of eyes on it, as it's a giant PR.\n. :+1:\n. :+1:\n. :+1:\n. There is a select2 related failure currently. @Sinetheta could you please investigate?\n. Test failure was caused by something that @jhawthorn has claimed responsibility for.\nThis looks good to me: :+1:\n. :+1: \n. I am also in favour of #23. Going to close.\n. :+1:\n. :+1: \n. @cbrunsdon could you please take a look at the failures which are happening?\n. :+1:\n. :+1:\n. :+1:\n. retest this please\n. :+1:\n. retest this please\n. This is one of those things that I keep meaning to finish up, but keep getting distracted.\n. :+1:\n. I approve of these changes!\n:+1:\n. :+1:\n. We should probably start a Changelog for listing things like this. It is a significant change for some people.\n. @jhawthorn Could you rebase this please? It won't automatically merge.\n. :+1:\n. Looks great. :+1:\n. I am also a big fan of this change. Can you please add something to the Changelog to note this change in behaviour?\n. retest this please\n. Looks good to me. Thanks @alexblackie! :+1:\n. :+1:\n. :+1: \n. :+1:\n. :+1: \n. :+1: :shipit: \n. I believe this actually does something. Not here, within build, but at some point later on the general flow of everything.\n. I believe that when the InventoryUnitBuilder is invoke here:\nhttps://github.com/jhawthorn/solidus/blob/f68bacc9281d99edb95b975758ea664897cbf8cc/core/app/models/spree/stock/coordinator.rb#L8\nThat the assigned inventory units have eagerly loaded all of the associations due to the code that's happening within the builder.\nIf that is the case, I think the appropriate thing to do would be to move the eager load up the stack to a better spot that should have responsibility for this sort of thing.\n. @jhawthorn is correct. The eager load is never run as it is right now.\n:+1:\n. I think this is a good idea. I wonder if we should move the logic for this in to shipment.refresh_rates itself.\n. Looks good. :+1:\n. :+1:\n. I believe messing with the order's shipping rates after the order is completed is something that we shouldn't do in most circumstances. Refresh rates destroys what the mutually agreed upon (by the customer and the system) order state was.\nFor the situations that you mention above, I would prefer to handle those by changing the state of the shipments, and creating an adjustment on the order explaining why the cost was adjusted if additional costs were incurred.\nIf this is needed for reasons I don't see right now, I would prefer to have this dealt with through configuration, with the default configuration set to not refresh rates on a completed order.\n. :+1:\n. Can you please give a bit of explanation on which issue this fixes?\n. :+1:\n. Big :+1: on the technical side of things. A couple of things:\n- Are there preferences which well modifiable in the admin which will not persist now that we've removed the DB persistence? If so, I think we should disable those sections of the admin.\n- This is an important change which I'll want to use in every store that I work on for performance reasons. Can you update the guides to include some basic documentation on how to do this?\nGood work!\n. Go for it. Thanks for the work on this.\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. I also support this.\nAre there any references to the cmd tool in the guides?\n. Looks good. :+1:\n. :+1:\n. I think it's good change to make. Will reduce confusion in the future.\n:+1:\n. :+1:\n. :+1:\n. :+1:\n. Could you please add a description for this PR to explain why this is a desired feature?\n. :+1:\n. :+1:\n. :+1:\n. :+1: \n. :+1: to you. :-1: to compact!\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1: :green_heart: \n. :+1:\n. :+1:\n. :+1:\n. Looks good to me. :+1:\n. :+1:\n. Thanks for that catch John. I think you're correct. I will make that modification.\n. :+1:\n. :+1:\n. :+1: if the tests pass.\n. :+1:\n. :+1:\n. :+1:\n. Looking good so far.\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. They're really old. Mostly from pre 1.0 Spree.\n. :+1:\n. Closing due to being stale.. :+1:\n. :+1:\n. My only suggestion would be to extract the current store logic to its own class, document it, and allow people to specify their own class to use if they'd prefer different logic.\nQuick demo:\nExample:\n``` Ruby\nmodule Spree\n  module Core\n    module ControllerHelpers\n      module Store\n        extend ActiveSupport::Concern\n    included do\n\n      # docs\n      class_attribute :current_store_class\n      self.current_store_class = Spree::Core::CurrentStore\n\n      def current_store\n        @current_store ||= current_store_class.new(request).store\n      end\n      helper_method :current_store\n\n    end\n\n  end\nend\n\nend\nend\n```\n``` Ruby\nFull description about these responsibilities\nmodule Spree\n  module Core\n    class CurrentStore\n  # docs\n  def initialize(request)\n    @request = request\n  end\n\n  # docs\n  def store\n    store = Spree::Store.find_by(key: store_key)\n    raise StoreNotFoundError unless store\n    store\n  end\n\n  private\n\n  def store_key\n    @request.headers['HTTP_SPREE_STORE'] || @request.env['SERVER_NAME']\n  end\nend\n\nend\nend\n```\nThe CurrentStore class can now be tested in isolation with a mocked request, and if you want to do something else, you can override that logic for your own store.\n. :+1:\n. :+1:\n. :+1:\n. Closing due to being stale. :+1:\n. :+1:\n. :+1:\n. I thought this looked familiar....\n. :+1:\n. :+1:\n. :+1:\n. You're a champ adam!\n. :+1:\n. I agree with @athal7. We need the data in the migration for stores making the upgrade path from previous versions of Spree. One of the big things we're looking for is to make the upgrade path silky smooth going forward, and this data will be needed. Since we don't re-seed stores once they're up and running, we want that data to be inserted in some other way, so we use the migration.\n. :+1:\nThere's not really a good reason to disallow multiple trackers. it shouldn't be that hard to make it work. We should maintain the existing API of .current returning a single tracker for now if you want to implement that.\n. Fine by me\n. :+1:\nBiggest surprise...we already have the thinking-cat.jpg.\n. :+1:\n. :+1:\n. Is there any reason why we can't just declare touch: true on the has_many :products? I think the touch_all_products was implemented to (badly) try and update the products quickly.\n. Of course. Thanks for that.\n:+1:\n. We don't really have a well supported elasticsearch integration right now, so I think that would have to be our first step.\n. :+1:\n. :+1:\n. Looks good to me.  :+1:\n. Can you add something to the changelog about this?\n. Yup!\n. :shipit: \n. @BenMorganIO Credit card addresses were added recently. https://github.com/solidusio/solidus/pull/202\n. :+1:\n. :+1:\n. Should we mark these as deprecated for now?\nI do want to see them go away.\n. :+1:\n. :+1: \n. :+1:\n. :+1:\n. I'm a big fan of this. My only concern is how cross DB compatible the execute in the migration would be, only because I don't write SQL like that often.\n. :+1:\n. :+1:\n. :+1: as well.\n. :+1:\n. There's a couple failing specs that should be removed.\n. :+1:\n. :+1: so far.\nShould we consider going all the way and removing delegate_belongs_to and just use the standard rails delegate?\n. It's certainly clearer to see what's going on. The delegate_belong_to code is a bit scary...\n. :+1:\n. :+1: Great work here!\n. Closing due to being stale. This is looking good. Could you please add a note to the Changelog, so we can let people know about this one?\n. I'm a big fan of having your database maintain referential integrity, because (in good databases) there's no way to bypass it. You can trust the database. Rails callbacks and validations can be easily bypassed.\nIf there's a situation where it's really important that we don't just cascade the things away, we should use a more appropriate on delete restriction for the foreign key (like restrict). Make sure rails does the dirty work, then let it destroy the record.\n. I do feel that cascade is the appropriate thing to do in this case. I don't feel that many-to-many join tables should contain logic as heavy as ActiveRecord callbacks.\nWe can note in the documentation for the class that these objects are subject to deletion through cascades and as such, callbacks should be written on one of the classes on either side of the many-to-many relationship.\n. :+1: \n. :+1:\n. :+1:\nI don't think doing a RABL cache test is appropriate for a model layer change like this.\n. I had half typed a comment that magnus just made about using the yarddoc @api tag.\nWe can come to an agreement internally that anything tagged as @api public will follow semver strictly.\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. Conflicts... That's weird.\n:+1: otherwise\n. :+1:\n. :+1:\n. :+1: Thanks for the contribution.\n. :+1: \n. :+1: on removing the state machine and moving source construction around.\nI also want to get rid of sale transactions, because I agree that they're wrong. However, it is a pretty invasive change for our users, so I want to make sure we have a good migration guide.\n. Closing due to staleness. :+1:\nThanks for the contribution.\n. Agree with the sentiments above. Nice work Richard.\n. @alexstoick That would be great. We would really appreciate any help in this area that you could offer.\n. :+1:\n. :+1:\n. Good idea here for allowing this to be customized.\nI think the only thing that I would want to see is some documentation to the existing CartonMailer so that if I wanted to implement my own CartonMailer I would know what options I should design my class to handle.\n. Sorry for the confusion @jordan-brough \nI was just thinking that I'd like to see the documentation also exist on core/app/mailers/spree/carton_mailer.rb in the form of some better YARD there.\n. Sounds like a great plan. Thanks @jordan-brough!\n. Looks great. Thanks for the change.\n:+1:\n. Much nicer. Great work.\n:+1: :balloon: \n. :+1:\n. :+1:\n. :+1: \n. :+1:\n. :+1:\nThe test failure was a poltergeist crash of some sort. Re-triggering the build.\n. :+1:\n. This is a great step in the right direction. :+1:\n. As the person who wrote most of the initial multi-currency code, I should probably weigh in here.\nThe intent when I was designing the multi-currency system was to explicitly not allow people to switch the currency of an order. If you switch currencies, you get a new order. This avoids all of the problems that homogenize_line_item_currencies tries to solve, but doesn't do a particularly good job of.\nI am in favour of removing it, with a note in the release notes to explain why it has gone.\n. :+1:\n. Closing due to staleness. :+1: \n. :+1:\n. :+1:\n. :+1:\n. :+1: \n. :+1:\n. Could you please add a spec for this?\n. Looks good to me.\n:+1:\n. Thanks for putting in the effort on this one. We appreciate it!\n. Closing due to staleness. Though I would prefer checks that worked in both MySQL and PostgreSQL, I'm with @mbj that a Postgres specific check is better than nothing due to the reasons he noted.\nI would want to put some comments around to make sure that we don't intentionally write logic around that relying on the DB check to catch it. However, in the case of a mistake, I like my DB to complain, and tell me what happened so I can fix it rather than put bad data in the DB for years.\nI'm also hugely on board with cleaning up our data historically to correct mistakes and/or bad decisions that were made in the past, rather than leaving hacks in our code to deal with the different way things used to be.\nI like this change to all_adjustments, and echo @jordan-brough with sentiments that there is much more to improve here, but this is a great first step.\n. I'm fine with leaving out MySQL advanced constraints knowing how terrible the implementation would be.\n. :+1:\n. While I appreciate the sentiment, I also appreciate not being sued by a certain comic book company. Probably best to err on the safe side.\n. It's also looking good to me. One thing I might consider doing is adding some YARD docs for the OrderMerger.\n@mtomov thanks for the PR! One of us can take up the task of adding the docs to this PR if you'd prefer.\n. I have added documentation in https://github.com/gmacdougall/solidus/commit/8112b719e422980b995e8df8533430698cb1343a\n@mtomov Could you cherry-pick that change in? I can also submit a PR to your branch if you'd prefer.\nAs part of that change, I also made a number of these methods private, as they're not used outside of the class.\n. :+1:\n. :+1:\n. :+1:\n. Looks good to me. :+1:\n. :+1: \n. Good catch. Thanks for the PR Chris!\n:+1:\n. I think that this is a desired feature and that we'd be happy to have a working version of this.\n. Closing due to staleness. We should add something to our release notes for this as well to inform users who rely on deface that they'll need to add it to their own Gemfile.\n. I have a few comments that apply to several instances of the same issue. If you could take a look at the related problems as well, I'd appreciate it.\n. Good improvements! I just have a few more suggestions.\n. @jhawthorn  and I discussed the ! vs. non-! methods briefly. It doesn't bother him as much as it does me. The logic around stuff that can be reasonably be expected to throw exceptions having a ! isn't correct from a Ruby perspective. For example:\nRuby\n[1] pry(main)> [].fetch(1)\nIndexError: index 1 outside of array bounds: 0...0\n@philbirt if you feel strongly that it should have a !, then leave it in. Otherwise remove it.\n. :+1:\n. I echo the comments that @jordan-brough had around being confused why StockTransferDisplay permissions need the ability to transfer_from and transfer_to.\n. I think this is good for now. We can remove it in a future release.\n:+1:\n. We have recently added a one-to-many relationship between promotion and promotion code. Please see https://github.com/solidusio/solidus/blob/v1.1.0.beta1/core/app/models/spree/promotion.rb#L19\n. Hi @drahcirsama \nThank you for your interest in Solidus. We use the issues on this project to track development features and issues with the code in order to keep things manageable. I feel that Stack Overflow is a better forum for your request and am going to close this issue.\n. :+1:\n. :+1: \n. Hi @amicheals \nThanks for your interest in Solidus. As we use the Github issues to track ongoing development of the Solidus project itself, questions like this are best directed to Stack Overflow, or the Slack or IRC channels.\n. I'm not particularly bothered about the extra validation queries either way. I do like having validations live as close to the DB as possible, as front end validations can easily be bypassed.\n. Thanks @athal7  I wasn't clear on that as I was having trouble following the flow of the conversation here.\n. :+1:\n. :+1: I agree with your logic.\n. Looks good to me. Thanks for the contribution!\n:+1:\n. Please don't take our rejection of the Spree 3.0 bootstrap as the rejection of the bootstrap framework, but only as a rejection of the manner in which it was implemented.\nOn the front end side, we have discussed removing frontend from the main repository, and allowing the developer to pick one of several provided front end implementations, or roll their own. As part of this, we want to move to a more API driven front end and deprecate some of the magic that happens in places like Spree::CheckoutController.\nOn the backend side of things, we're more interested in maintaining the status quo. I would not have made the choice to roll my own framework, but in the current state of things, I don't know if I would support a rewrite all of the views in order to support a new framework. If our frontend extraction is successful, maybe something similar could work on the backend side of things.\n. Thanks for your interest in Solidus! This is a platform in which you'll be able to developer the type of functionality you desire, however it will take a good deal of custom development.\nI might recommend you check out the Slack channel (http://slack.solidus.io/) for some people to discuss this with. In order to keep our issues list manageable, we like to keep the issues for active development on the project rather than discussions about how to use the project. As such, I'm going to close this issue.\n. Thanks for the PR! Is there a particular feature in 5.1 that you desired or is this a bump to stay current?\n. Fine by me.\n. :+1: Good work here. Thanks John!\n. I think the direction of this is good. I would rather have helpful error messages than something returning false for unknown reasons.\n. Hi @dt1973 Could you please move the issue of loosening the restriction on sprockets to a new issue?\nWe don't intended to keep sprockets locked forever, but it was breaking things significantly and needed to get a fix out fast.\n. I agree with @mamhoff  Lets get this in as is and do more PR's to fix the other stuff.\n. I just have a couple minor formatting things that I'd prefer to see in order to keep the code looking tidy. Great work on this! :star2: \n. Closing due to staleness. Closing due to staleness. I think we're going to hold off on this change. There's lots of decisions that need to be made here, and it will break everyone's extensions, so we'll want to hold this for a major version if we want to do it at all.\n. I am not a fan of this for three main reasons.\n1. I do not wish to use this open source project to make political statements\n2. I don't believe this is solving a problem which currently exists on this project\n3. I feel the responsibility for dealing with harassment should be left to more appropriate authorities, such as Github, or law enforcement\n. I don't think this is particularly necessary. We're assuming that people have a familiarity with rails and the options available there.\n. Closing due to staleness. Can you try upgrading to solidus 1.1.1, then running a bundle update? This is a compatibility issue with sprockets 3.\n. Closing due to staleness. Good catch! :+1:\n. :+1:\n. You'll need to remove spree_i18n from your Gemfile and replace it with https://github.com/solidusio-contrib/solidus_i18n\nYou will need to do the same with any other spree_* gems as well.\n. That gem has not been ported to Solidus. I would recommend not using it and instead configuring your mail settings using standard ActionMailer configuration.\n. :+1:\n. I have verified that this is working correctly on a fresh sandbox. Can you please verify and try the same on a sandbox?\n. I agree. I think that deprecating this method is probably for the best. I'd like to move this functionality from core to frontend as well.\n. This is probably the wrong solution after looking at this closer. It uses an <ol> tag, so the number should already be there, it's probably being disabled by CSS list style or something like that.\n. It certainly deserves a place in the Wiki at a minimum. Perhaps we should then link to some of the more commonly asked topics in the README.\n. Agreed.  :+1:\n. Hi @davidpatters0n. Thanks for your interest in Solidus.\nStack Overflow or the Support channel on our slack are more appropriate venues for this type of question. If you're able to reproduce this issue on a fresh Solidus install, please provide steps in a new issue.\n. :+1:\n. Agreed.  :+1:\n. :+1: Great work!\n. Authentication right now is handled through solidus_auth_devise rather than the main project itself. I don't think we wish to enable this by default for anyone, and would prefer to allow individuals to decide on if they want something like this for their own stores.\nPlease feel free to develop a fork of solidus_auth_devise that integrates this in. This could be used as an alternative to the existing solidus_auth_devise.\n. I think this is a step in the right direction, but we will still have issues with currencies which do not use 2 decimal places. We should consider doing the math individually using the appropriate money objects.\n. @mamhoff I agree that's it's too much to deal with in this PR. I just wanted to start the discussion. I'll move that over in to its own issue.\n. Yeah. It's just a worse version of the RubyMoney Money.\n. Close due to being stale. We've made some improvements here, but I don't believe we've fixed everything. We can highlight additional issues with individual issues.. Looks good to me\n:+1:\n. :+1:\n. Hi @modreoci Thank you for your interest in Solidus.\nUnfortunately, this is not enough information to investigate or comment on this issue. If you are able to provide more information please file a new issue.\n. I believe that we're relying on JavaScript to trigger those actions. Is your JS loading properly?\n. The default country is managed through configuration:\nhttps://github.com/solidusio/solidus/blob/v1.2.0.rc1/core/app/models/spree/app_configuration.rb#L120-L123\nIf you're having issues like this, please address them to places like Stack Overflow or the support channel on Slack. We like to keep issues on Github focused on features or problems with the code base rather than how to use Solidus.\nThanks for your interest!\n. Thanks for your interest in Solidus. We like to keep issues on the project to bugs or features that are on the project itself. I'd recommend that you check out the Support channel in our Slack or post a message to Stack Overflow with a more detailed version of your question.\n. :+1:\n. :+1: \nYay for less crazy JS.\n. Thanks for your interest in Solidus. We use issues on this project to manage issues with Solidus itself and the roadmap of the project. For \"How to...\" type questions I recommend that you ask on the support channel on our Slack, or on a platform like Stack Overflow.\n. :+1:\n. :+1:\nThanks for the contribution!\n. @mamhoff Could you please add some YARD to the new classes describing their purpose and public interfaces? I'd like to have that in place so people who are wanting to provide their own implementations have a good reference.\n. :+1:\n. Hi Adnan,\nWe're tidying up some old issues and I tried to reproduce this on the most recent Solidus master and was not able to reproduce the behaviour you're experiencing. Some stuff has changed in the promo system so it's possible we may have fixed this along the way.\nFor now, I'm closing this issue. Thanks for the report.. :+1:\n. :+1:\n. :+1: \n. @mamhoff This looks good to go. Could you please rebase so we can merge this in?\nThanks!\n. Github is showing conflicts again. Could you give it another rebase please?\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. If this behaviour was incorrect, how was the test able to pass?\n. @mtomov Thanks for the clarification. Makes sense.\n. Great work @jordan-brough \n:+1:\n. Can you please add a changelog entry for this. It is a change in behaviour that I think people would want to know about.\n. :+1:\n. Death to tri-state booleans!  :+1:\n. Looks good. There's some scary stuff in there. I'm continually amazed that half of this stuff works at all.\n:+1:\n. Can we drop configuration_menu.html.erb now? Also I think that a Changelog entry for this would be appropriate.\nGood work on this. I really like the usability improvements here.\n. :+1:\n. :+1:\n. :+1:\n. I'd like to see the unit tests for default_tax.rb improved, covering the new functionality and providing better tests for the existing logic.\nWe also need to make the default_tax handle currencies that do not have two decimal places, but I'm fine with leaving that for another PR.\n. I was thinking more currencies without decimal places like JPY or KRW which are generally supported, aside from some bad rounding logic here and there.\n. :+1:\n. :+1:\nGood catch.\n. An example of where we have caching that will be affected by this:\nhttps://github.com/solidusio/solidus/blob/96f186c3bda4fa4636ea1dc352c03012ae293d16/frontend/app/views/spree/products/show.html.erb#L1\nThe product show page is currently cached on Locale, Currency, and Product and we rely upon Price touching Variant and Variant touching Product to bust the cache.\n. Looking good to me. Could you please rebase this?\n. :+1:\n. :+1: Thanks for the contribution!\n. I do think that this makes sense. However, I am concerned about potentially destroying data that people were relying upon if they had customized their store. I would appreciate some more opinions on this one.\n. I like that we've extracted this functionality to a better place and put it under test. I would prefer to deprecate it with the intention of removing it. It can only be customized through monkey patching, and the pricer system as a whole will provide similar, but much less bad versions of that functionality.\n. Hi @mkranthikmr \nWe keep the issues for this project to catalogue development on the project. For \"How do I....?\" type problems I recommend using Stack Overflow, or the Support channel on our slack.\nThanks for your interest in Solidus.\n. I think we should consider removing this dependency and allow developers to set their own version.\n. Looks good to me. Thanks for working on this. :+1: \n. :+1: again!\n. :+1:\n. I think it's reasonable so assume these were omitted by accident. I don't see any reason why they shouldn't be there.\n. :+1:\n. I don't believe this error is coming from within Solidus. It is likely caused by one of your extensions. content_path is not provided by Solidus, and the excerpt listed in your stack trace is not part of Solidus. \n. :+1: This isolates bad functionality to a place where it can be removed. This should be removed in Solidus 2.0.\n. :+1:\n. I might prefer returning nil when no price is available in the currency listed. I can also forsee issues when asking for the price in CAD, and am given a price in USD.\n. That makes sense. I was confused.\n. :+1:\n. :+1: this seems significantly more correct.\n. :+1:\n. :+1:\n. This is looking good so far.\n. :+1:\n. :+1:\n. I think this is very useful. My only question is if we should raise a specific error if other does not respond to .money. What do you think?\n. :+1: Thanks Martin!\n. Close due to staleness. :+1:\n. :+1: \n. :+1:\n. :+1:\n. :+1:\n. :+1: Great work John!\n. :+1:\n. There are two major ways to configure currency:\n- Configure the global default currency through the application configuration\nSpree.config do |config|\n  config.currency = 'EUR'\nend\n- Configure the default_currency for a specific store on the Spree::Store model\nAllowing admins to set the currency at runtime through the admin is something that broke a large number of assumptions about how the site operates (such as caching) in addition to the performance considerations.\n. :+1:\n. :+1: on this and backporting to 1.3\n. Should we consider deprecating this instead and removing the column in the next major version?\n. Should we consider deprecating this instead and removing the column in the next major version?\n. Thanks Andrew!  :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1: Thanks Fr\u00e9d\u00e9ric!\n. \ud83d\udc4d \nThanks Kevin!\n. This was merged in #2257 after a rebase. Thanks for the work on this Seb!  Sorry for the very slow response on this.. \ud83d\udc4d \n. \ud83d\udc4d \nMuch better. Thanks John!\n. :+1: Great work on this John!\n. \ud83d\udc4d \n. Thanks for the contribution Eric!\n\ud83d\udc4d \n. :+1:\n. Registration isn't provided out of the box with Solidus. In order to work with a number of different authentication systems, it's extracted out to an extension such as solidus_auth_devise.\nAs we manage the issues of the project through Github, I'm going to close this and would encourage you to bring future questions or issues up in another forum like the Solidus Slack support channel.\n. Could you please remove my mention from the commit message. With the @ it will message me any time someone cherry-picks that commit around to various branches.  Non @ mention is fine though.  \ud83d\ude04 \n. Yay! I always disliked those.\nCould you also flag the existing spree_* helpers as deprecated?\n. Sample response after from the solidus sandbox:\n```\n\nhttp \"http://localhost:3000/api/taxons/products?id=7&simple=1\" X-Spree-Token:cd0ebcf6ac7d236c7007f23ad05b50bba470c9812c57d8ab\nHTTP/1.1 200 OK\nCache-Control: max-age=0, private, must-revalidate\nConnection: Keep-Alive\nContent-Length: 357\nContent-Type: application/json; charset=utf-8\nDate: Wed, 13 Jul 2016 19:25:29 GMT\nEtag: W/\"38d78a06563db8d140330f4323f18540\"\nServer: WEBrick/1.3.1 (Ruby/2.1.5/2014-11-13)\nX-Content-Type-Options: nosniff\nX-Frame-Options: SAMEORIGIN\nX-Request-Id: c85d935d-39ad-4baa-a9c8-32575e8d1322\nX-Runtime: 0.075606\nX-Xss-Protection: 1; mode=block\n```\n\nJson\n{\n    \"count\": 4,\n    \"current_page\": 1,\n    \"pages\": 1,\n    \"per_page\": 500,\n    \"products\": [\n        {\n            \"display_price\": \"$19.99\",\n            \"id\": 7,\n            \"name\": \"Apache Baseball Jersey\"\n        },\n        {\n            \"display_price\": \"$19.99\",\n            \"id\": 6,\n            \"name\": \"Ruby Baseball Jersey\"\n        },\n        {\n            \"display_price\": \"$19.99\",\n            \"id\": 3,\n            \"name\": \"Ruby on Rails Baseball Jersey\"\n        },\n        {\n            \"display_price\": \"$19.99\",\n            \"id\": 5,\n            \"name\": \"Ruby on Rails Ringer T-Shirt\"\n        }\n    ],\n    \"total_count\": 4\n}\n. Rebase incoming.\n. Hi Eric,\nI'm taking a look at this issue and am having trouble reproducing the issue in a sandbox environment. Currently, when I attempt to add a payment to an existing order in the admin it correctly shows the #new_payment form.\nLooking at the result that you are seeing, you have id=\"edit_payment_3126575\" in your result, which shows that the payment has an ID.\nLooking at your solution, you've removed a payments.build call. In a basic Solidus store, payments.build should not persist the record.\nExample:\nSpree::Order.first.payments.build.id #=> nil\nCould you please provide more information on how to reproduce this issue in a Solidus sandbox store.\nThanks!\n. Based upon my findings in #1336 I am not confident this fixes an issue. I am going to close this PR for now pending new information.\n. Thanks Martin. Much appreciated!\n\ud83d\udc4d \n. :+1:\n. \ud83d\udc4d \n. Great Work John!  Big thanks to all the other contributors as well.\n\ud83d\udc4d \n. This does break API compatibility. Do we care?\n. :+1:\nIf we don't care about the hound warning we should disable it.\n. Spree.ajax is supposed to pass the api_key in the headers of the request. If that's not working, we should fix things on that side rather than forcing this method of authentication.\nCan you please provide a more detailed description of what problem you're seeing?\n. I believe that does indeed fix the issue. Closing this PR.\n. I agree that this makes sense. I can't think of anywhere else I would prefer to deal with this.\n\ud83d\udc4d \n. Hi Brendan,\nI'm thinking through this and not coming up with any reasonable solution for this.\nLets take an example of an order for 3 Line Items costing $20 each, and a tax of $4 each.\nThis leads to the following situation:\n| Amount | Value |\n| --- | --- |\n| Item Total | 60 |\n| Tax Total | 12 |\n| Total | 72 |\nIf one of the two line items is returned we get the following:\n| Amount | Value |\n| --- | --- |\n| Item Total | 60 |\n| Tax Total | 12 |\n| Adjustment Total | -24 |\n| Total | 48 |\nThe total calculates correctly as you mentioned because of the adjustment total.\nIf we were to update the item total we would have the following:\n| Amount | Value |\n| --- | --- |\n| Item Total (2 items only) | 40 |\n| Tax Total | 8 |\n| Adjustment Total | -24 |\n| Total | ??? |\nIn this case the total would be wrong because the sum of all the values is only 24.\nAs far as I can tell we have a few potential solutions:\n1. Leave it as is and deal with the fallout\n2. Stop representing cancelled line items as adjustments, and instead represent them with their own proper field (cancelled_item_total or something like that). Then we could explicitly ignore that field when calculating the order total, but still reflect the cancelled item correctly. We would need to add fields to both the LineItem and Order to deal with this correct.\n3. We could update the line items on the order to reflect only non-cancelled items and trust order.update! to do the magic.\n. \ud83d\udc4d \n. \ud83d\udc4d \nThanks Peter!\n. \ud83d\udc4d \nThanks for finding this John. It's a bit of a strange one.\n. Yes. \ud83d\udc4d \n. \ud83d\udc4d \n. Thanks for the PR Eric!\n. :+1:\n. Thanks for the PR @bjvoth. This was obviously a mistake somewhere along the way.\n\ud83d\udc4d \n. :+1:\nThanks John.\n. :+1: \n. We can likely remove currency from LineItem. When I was originally adding support for currencies, I went in with a very basic assumption: everywhere that has an amount which is representing money gets a currency.\nIt was probably a mistake to add it to LineItem rather than rely on a join or delegation to make it happen.\n. :+1: \nThanks Jordan!\n. \ud83d\udc4d \n. Thanks Jordan\n\ud83d\udc4d \n. Thanks Andrew!\n\ud83d\udc4d \n. Thanks for the work on this Martin. Sorry for the slow response, but we agree that we like this code and I have rebased it with intent to merge in #2258 \n:+1: . :+1: Thanks Jordan!\n. Superseded by #2259 . :+1: \n. I believe this is in error.\n. Hi Jordan. We're going through stale PR's and this is something we're not feeling comfortable with. We're concerned with adding more customization to a confusing promotion system.\nWe're thinking we need something more in depth in order to fix some of these problems (similar to when we fixed up the tax system) rather than a simple PR like this.\nGoing to close for now, but we're open for further discussion on promotions.. Yay!  Good riddance to reloads!\n:+1: \n. \ud83d\udc4d \nThanks John!\n. That's fine by me.\n. I would probably keep the column and add a new column to track the amount remaining amount on this particular store credit. That way we don't break backwards compatibility or people who rely upon it in their application.\nWe're looking at doing some work to deprecate store credit events with a proper accounting ledger which will deprecate StoreCreditEvents to be removed in a future version of Solidus.\n. @flyfy1 Nothing else needed. We leave PR's open for a little bit to give people a chance to comment on things. But with two approvals and a few days in action, this is good to go now.\nThanks for the contribution!\n. Thanks Alberto!\n. This should be integrated into solidus-i18n:\nhttps://github.com/solidusio-contrib/solidus_i18n/blob/master/config/locales/nl.yml\n. Thanks Graham. Should this be back-ported as a bugfix to any previous releases?\n. Perfect   \ud83d\udc4d \n. Thanks for working on this John. I feel it is an improvement.\n. Thanks for taking this on Matteo. Is there anything that we could do to fill in the amount remaining on all of the existing store credits? We should have enough of a history to come up with something based upon the StoreCreditEvent.\nIf not, I would suggest we leave it NULL to show that we don't have that data.\n. Peter and I discussed this a little bit more, and there 's still some important information that we want to track regarding auth/void on the ledger. These are important events that affect the amount of available store credit and we want to have an appropriate history of them.\nWe also want to make sure that the public interface makes sense and you can't break assumptions that we have by using the public interface (methods like credit/debit).\n. Can you please tidy up your commit messages?\nhttp://tbaggery.com/2008/04/19/a-note-about-git-commit-messages.html\n. Brian, Peter and I discussed this earlier and don't see a significant advantage in making the records read only. The ledger entries are only created, and not updated in the code here and readonly can be bypassed.\n. I don't think that orders should be allowed to change currency. There's too much complication around it. If someone needs that functionality in their application, they can implement it on their own, but it's complicated enough that we should be very careful about supporting the functionality.\nSome items may not have prices or availability in other currencies, migrating promotions, taxes, etc. would be complicated under a currency switch. The easier solution is for us to give them a new order with a new currency when they switch, which is what should happen if current_currency changes.\n. Thanks for the contribution Eric!\n. I tried rebasing this to solve the conflicts but ran in to spec failures. We've changed the way that payment cancellation works recently, and I need to get a better understanding of this before I'm confident in what's going on.. Replaced by rebased version (#2265). Hi @4dandies \nThis issue appears to have been fixed here:\nhttps://github.com/solidusio/solidus/pull/1521\nCan you try updating your version to include that fix?\n. Going to do some additional work on this. There's an issue with cancelling an order containing a fully refunded store credit payment.. I have corrected the error which occurred when cancelling an order which was previously fully refunded.. This was superseded by https://github.com/solidusio/solidus/pull/2111. This was superseded by https://github.com/solidusio/solidus/pull/2111. I'm not sure this is the solution that we want. I think if we have a validation on something, we should assume it exists. If solidus_globalize doesn't want the column to exist, maybe it should remove the validation.. Going to close this issue as it's not related to the core solidus repository. Please use alternative means for assistance with these sort of issues, such as Stack Overflow or the #support channel on our slack.. I triggered a rebuild. Here's a link to the odd failure: https://circleci.com/gh/solidusio/solidus/4985\nI was not able to reproduce it locally.. Sure thing. I agree that having contains would be better than starts with on e-mail, but the reason that this came up is that we're getting timeouts on our site with large numbers of orders when attempting to search via e-mail.. Changelog added in an amendment.. I feel that all of the things listed here are large enough that non-indexed searches are inappropriate. It's not that hard to get millions of orders or promotion codes.. Change rebased and shall rise again!. This is now rebased (properly)!. Rebased the CHANGELOG out of this. Should be good to go.. Hi brchristian,\nThanks for your input on this subject. I think we're comfortable with leaving the existing migrations as they are. If we were to provide some level of backport for this, I think we'd want to backport safe_remove_index.. Can you please explain why this is preferable and faster than the existing index? I don't see this being significantly faster.. @alexstoick I don't believe that this is correct. Here's a basic example in my postgres.\n```\ngregor=# create table promotion_test (id SERIAL, apply_automatically BOOLEAN);\nCREATE TABLE\ngregor=# INSERT INTO promotion_test (apply_automatically) SELECT FALSE FROM generate_series(1,1000000);\nINSERT 0 1000000\ngregor=# UPDATE promotion_test SET apply_automatically = true where id IN (585215, 598755, 513940, 30532, 408250, 83469, 504287, 408492, 509115, 255546, 918519, 769406, 178516, 148653, 414456, 551209, 55718, 144677);\nUPDATE 18\ngregor=# create index on promotion_test(apply_automatically);\nCREATE INDEX\ngregor=# EXPLAIN ANALYSE select * from promotion_test where apply_automatically = TRUE;\n                                                                       QUERY PLAN\n\nIndex Scan using promotion_test_apply_automatically_idx on promotion_test  (cost=0.42..9.60 rows=67 width=5) (actual time=0.035..0.044 rows=18 loops=1)\n   Index Cond: (apply_automatically = true)\n   Filter: apply_automatically\n Total runtime: 0.080 ms\n(4 rows)\n```\nCan you try a VACUUM ANALYZE spree_promotions on your dataset?. @jordan-brough I don't believe so. If you look at my above example it finds 18 rows out of 1 million in 0.080 ms. I'm fairly confident my example shows that this is not needed. I'm open to being wrong though and if we can find a good counter-example, I'm open to revisiting this. Closing for now.. The basic structure of PriceSack is to give a different value to the promotion if the order or line_item  is above a certain amount. For example, $5 shipping on orders over $100.\nWe don't really have a good idea on how many people use this, so I'm a bit hesitant to remove it or even deprecate it. I think the best thing to do first would be to document it.. Thanks @jhawthorn \nI confused myself with the diffs. It was all the other stuff that became private, not those becoming public.. Thanks for your interest in Solidus. This is a forum for issues with the software itself. Your question would be better suited for an environment like Stack Overflow of the #support channel on our Slack.. I would tend to side with adding the with_deleted scope. Though both are reasonable.. Hi Viktor,\nThanks for contributing this. Though your implementation is reasonable, we're concerned about exposing this complex relationship (an address having many users) to Solidus developers, as such we'd prefer to avoid doing this. It's a relationship we're not sure is going to exist in this manner for the long term, so we're going to leave this as is for now.\nThanks for the effort and discussion. Sorry for the slow response and please feel free to contribute again in the future!. Looks reasonable to me. Thanks for addressing the feedback.\nRebase away!. Thanks for the work on this Dustin!  Sorry for the slow response.. I tend to think that since we're providing an e-mail validator we should make it decent.\nWe can also try to get out of that business altogether, but that's a bit more of an invasive change.. According to John, \"This is nothing, you can close it.\". Given the current feedback, I don't think this is a change we're looking to make. There are failing tests and some additional JS that we're not looking to add.\nThanks for the contribution on this and please don't hesitate to send additional ideas our way.. \"This is also nothing\" -- John Hawthorn. Can anyone think of reasons why we shouldn't accept user-defined input here? The line item options are validated with this: https://github.com/solidusio/solidus/blob/v2.2.1/core/app/models/spree/order_contents.rb#L99\nbut that's only one part of the thing that options are used for.\n. This has been resolved by #1932 . Could you help my understanding how you reproduced the issue? Taking a look at how this is initialized, I can only see it getting initialized with boolean values (example: https://github.com/solidusio/solidus/blob/v2.2.1/backend/app/assets/javascripts/spree/backend/stock_transfers/receive.coffee#L3) and not seeing where the string \"false\" came from.. I think that makes sense.. I think this is great. I might consider adding another spec for the specific case that you were having trouble with. For example, when in_stock_only is \"false\". What if we allow the behaviour to be configurable? Leave the default behaviour as is, but provide an option to allow people to implement the new behaviour based off of a Spree::Config attribute.. I'm concerned about the tight coupling between this change and the required change in solidus_auth_devise. We like to maintain compatibility between extension versions.\nShould we consider a strategy where we detect what solidus_auth_devise supports and then provide the correct functionality. Perhaps with a deprecation warning as well.\nThere are also failing tests which need to be addressed.. @tvdeyen Can we get a rebase on this?. @tvdeyen can we get a rebase on this?. Thanks for the contribution!. Thanks for the contribution!. Looks like a reasonable change. We have a test failure here that looks related.\nI'd also like to see a better commit description.\nThanks for looking in to this!. Looks like we have a legitimate test failure here. We'd also be looking for a better PR/commit description along with this one.\nThanks for taking a look at this!. Should we provide something like:\nRuby\nSpree::Gateway::Bogus = Spree::PaymentMethod::BogusCreditCard\nor even\nRuby\nclass Spree::Gateway::Bogus < Spree::PaymentMethod::BogusCreditCard\n  def initialize(*args)\n    #deprecation notice\n    super\n  end\nend\nuntil we're ready for a major version release?\n. That'll learn me for reading PR's too fast!. I like the direction this is heading, but there's a couple of failures to take care of right now.. Thanks for the contribution. We've had an issue with our circle configuration which should be resolved now. Could you please rebase this on to master if you have a moment?. Tests pass with things fixed up. Merging!. I saw a lot of deprecation warnings from this..... I am also on board with this.. Thanks for finding this Jordan.\nI prefer to leave this as is and update to a new rails version when this is fixed upstream.. Great work John!. Thanks for the contribution!. I'm not a huge fan of moving from model based touching to controller based touching. I would be much happier if we could find a solution where the model still has that responsibility.\nWith Solidus being an extensible system, I can foresee people having extensions to their application which create or modify option values that this would break for them.. Going to close this as I don't foresee us coming up with a reasonable solution for dealing with the drawbacks of this. It's something people may want to consider in their own stores, but as it it, is too potentially dangerous to merge.. There's a red CircleCI build on this right now. Do you know the source of the errors?. The PR description doesn't seem to match the commit.. My main concern about this is that we're changing the public API for some of these key methods.\nCould we user creator = nil as a default action, with deprecation warnings that maintain the current behaviour until the next major version release?. Yeah. That's what I was thinking.. We are planning on migration away from Paperclip. There was some initial work done in #2328 but it needs some additional work.. @tvdeyen Would you be able to give this a rebase and merge it?. Right now we don't have a specific sass version requirement so bundler will resolve to any version of sass. We require 3.5.2 or greater due to the issues linked.. This obviously does not work. Will take another pass at it.. Looks like this needs a rebase.. Thanks for your work on this. We've been talking about making major changes to the front end for some time, but looking at this change, I think it can provide a decent quality of development life for people who are using the front end as is right now.\nI think the big thing we're concerned about is breaking people's existing customization which they have made using skeleton CSS and markup.\nFor people just starting their stores now, I do think this is a better options for them.. There's just a failing spec that needs to be addressed.. Thanks for putting this together. I'm interested by the query count spec but am concerned it would be fragile and likely to cause potential failures in the future.\nWhat do you think about removing the query count matcher portion of this as I think the rest of this is good to go as is.. Can you explicitly state the tax category name?\n. Are you sure that we're safe to move this in to a private method only?\n. This should be lastname.\n. Out of curiousity, why do we need to extend ActiveSupport::Concern?\n. You don't need to class_eval this.\nSpree.user_class.include UserMethods\nI like the deprecation warning getting people to move this to their own definition rather than hacking it in for them.\n. Probably only need this once.\n. I would prefer doing something like:\nis_a? Spree::PaymentMethod::StoreCredit\nto allow people to subclass StoreCredit.\n. I don't think this change is appropriate for this PR.\n. I would prefer to keep the HTML out of these. If the line break is important, I'd toss a `.gsub(' ', '') on the view side.\n. By using the symbol instead of a string, ActiveRecord does the work for you. It quotes the table name, and column name using the appropriate syntax for the the current DBMS.\n. This should go through i18n.\n. Non-expiring and Expiring should go through i18n\n. i18n\n. Is this safe?\n. i18n\n. Is this something that should be in seeds as well?\n. Include this in seeds?\n. Include these in seeds?\n. Include in seeds?\nThese names should all probably go through i18n as well.\n. We need them created for new stores who create their databases with a schema load and seed rather than an existing store which ran the migrations.\n. This logic has changed a bit, which may not been intended.\nPreviously it would return the last incomplete order (by created_at). Now it returns the last order (by created_at) if it is incomplete.\nThe change would be if there is an incomplete order which was not the last one created.\n. We can use the new hash syntax for this.\n. I feel that only_created_by_self should be false by default. In fact, I don't know if I would even include that restriction in here if we're not using it within this commit.\nI assume you have other plans for it?\n. Can you make this null: false as well to avoid the tri-state boolean.\n. Can you add some new lines in here?\nrender(\n  json: {\n    errors: [I18n.t(:quantity_is_not_available, :scope => \"spree.api.order\")],\n    type: 'insufficient_stock',\n  },\n  status: 422,\n)\n. Should we consider putting a deprecation warning that store you should be passing store in to this method?\n. I would prefer that this method remain, and be marked as deprecated and that is is scheduled for removal in a future version of solidus, telling the developer to use payments.pending instead.\n. Should this loop be moved up a level?\nIf auto capture is on, and this payment is pending, right now we will attempt to purchase! which I don't think is correct.\n. Can you AREL this up while you're here? Something like:\nwhere(arel_table[:created_at].lteq(Spree::Config[:order_mutex_max_age].seconds.ago))\n. :+1:\n. Works for me.\n. One of these is not correct. This currently throws a syntax error.\n. Ugh... :fireworks: :+1: for getting rid of terrible stuff like this.\n. Can you provide some documentation for this?\n. Could you use shared examples instead here?\n. Could we use:\nRuby\nbill_address = source.respond_to?(:address) && source.address\nI think that would be more flexible in the future.\n. Give this a try:\nRuby\n      add_search_scope :in_taxon do |taxon|\n        joins(:classifications).\n        where(Spree::Classification.table_name => {\n          taxon_id: taxon.self_and_descendants\n        }).\n        order(Spree::Classification.arel_table[:position].asc)\n      end\nComparison:\nBefore:\n[1] pry(main)> Spree::Product.in_taxon Spree::Taxon.find_by!(permalink: \"categories/bags\")\n  Spree::Taxon Load (0.2ms)  SELECT  \"spree_taxons\".* FROM \"spree_taxons\" WHERE \"spree_taxons\".\"permalink\" = ? LIMIT 1  [[\"permalink\", \"categories/bags\"]]\n   (0.2ms)  SELECT \"spree_taxons\".\"id\" FROM \"spree_taxons\" WHERE (\"spree_taxons\".\"lft\" >= 2) AND (\"spree_taxons\".\"lft\" < 3)  ORDER BY \"spree_taxons\".\"lft\"\n=>   SQL (0.3ms)  SELECT \"spree_products\".\"id\" AS t0_r0, \"spree_products\".\"name\" AS t0_r1, \"spree_products\".\"description\" AS t0_r2, \"spree_products\".\"available_on\" AS t0_r3, \"spree_products\".\"deleted_at\" AS t0_r4, \"spree_products\".\"slug\" AS t0_r5, \"spree_products\".\"meta_description\" AS t0_r6, \"spree_products\".\"meta_keywords\" AS t0_r7, \"spree_products\".\"tax_category_id\" AS t0_r8, \"spree_products\".\"shipping_category_id\" AS t0_r9, \"spree_products\".\"created_at\" AS t0_r10, \"spree_products\".\"updated_at\" AS t0_r11, \"spree_products\".\"promotionable\" AS t0_r12, \"spree_products\".\"meta_title\" AS t0_r13, \"spree_classifications\".\"product_id\" AS t1_r0, \"spree_classifications\".\"taxon_id\" AS t1_r1, \"spree_classifications\".\"id\" AS t1_r2, \"spree_classifications\".\"position\" AS t1_r3 FROM \"spree_products\" LEFT OUTER JOIN \"spree_classifications\" ON \"spree_classifications\".\"product_id\" = \"spree_products\".\"id\" WHERE \"spree_products\".\"deleted_at\" IS NULL AND \"spree_classifications\".\"taxon_id\" = 3  ORDER BY spree_classifications.position ASC\nAfter:\n[2] pry(main)> Spree::Product.in_taxon Spree::Taxon.find_by!(permalink: \"categories/bags\")\n  Spree::Taxon Load (0.4ms)  SELECT  \"spree_taxons\".* FROM \"spree_taxons\" WHERE \"spree_taxons\".\"permalink\" = ? LIMIT 1  [[\"permalink\", \"categories/bags\"]]\n=>   Spree::Product Load (0.4ms)  SELECT \"spree_products\".* FROM \"spree_products\" INNER JOIN \"spree_classifications\" ON \"spree_classifications\".\"product_id\" = \"spree_products\".\"id\" WHERE \"spree_products\".\"deleted_at\" IS NULL AND \"spree_classifications\".\"taxon_id\" IN (SELECT \"spree_taxons\".\"id\" FROM \"spree_taxons\" WHERE (\"spree_taxons\".\"lft\" >= 2) AND (\"spree_taxons\".\"lft\" < 3)  ORDER BY \"spree_taxons\".\"lft\")  ORDER BY \"spree_classifications\".\"position\" ASC\nQuery is simpler and easier to understand, plus we do it all in one shot query (with a subselect) rather than two. It functions a bit differently internally but should produce the intended results.\n. This needs distinct because the scopes aren't set up right. It takes a currency in as an argument but doesn't do anything with it:\nhttps://github.com/solidusio/solidus/blob/v1.0.0/core/app/models/spree/product/scopes.rb#L190-L193\nIt returns multiple records because records with multiple prices are returned by the scope if you have a product with a price in more than one currency.\nIf that's the way we want that to work, we should apply the distinct at that level. But really, I think we should properly respect currencies rather than just ignoring them.\n. Initial attempt at refactoring:\nRuby\n    def taxon_preview(taxon, max=4)\n      products = Spree::Product.where(id: taxon.active_products).limit(max)\n      if (products.size < max)\n        taxon.descendants.each do |child|\n          to_get = max - products.length\n          products += Spree::Product.where(id: child.active_products).where.not(id: products.map(&:id)).limit(to_get)\n          break if products.size >= max\n        end\n      end\n      products\n    end\nThis can be simplified significantly further if we can rely on active products to be distinct.\n. Do you mean the table rename here? I think its fine.\n. Should we consider adding this as a new method, and deprecating the old shipped_email(carton_id, resend: false) in order to maintain API compatibility?\n. While you're here, if you could get rid of this, I'd really appreciate it.\nInstead of\nrescue Exception => e\njust\nrescue => e\nRescuing Exception will rescue syntax errors, signal exceptions and such. Things that you shouldn't be rescuing unless you're re-raising them.\n. I'm fine with rescuing Exception as long as we re-raise it. It's just not one of those things that should be swallowed.\n. If we're destroying an address, I think that we should verify that we're allowed to do it on that address object rather than a different object with the same user_id.\nAlso, I think that we should check the appropriate permission (:read for the show action, :manage for the modification actions).\n. Additionally, if address_book_user is nil, this will throw an odd 500 exception when a 4xx of some sort would be more appropriate.\n. I'd prefer to see these attributes extracted to some let statements. In the case where I want to add a new test, I'd prefer to be able to access the existing values rather than copy/paste these around.\n. How about:\n``` Ruby\ndef persist_order_address(order)\n  save_in_address_book(\n    order.ship_address.attributes,\n    Spree::Config.automatic_default_address\n  ) if order.ship_address\nsave_in_address_book(\n    order.bill_address.attributes,\n    order.ship_address.nil? && Spree::Config.automatic_default_address\n  ) if order.bill_address\nend\n```\n. Sorry, forgot that find threw RecordNotFound. The 404 is right there.\nI'm still a little iffy on the user address cancan check. Anyone else want to chime in there?\n. We had a client who would use roles for discounted pricing. A wholesaler role as an example.\n. I don't think this assertion is correct.\n. What about switching this to:\nif s.respond_to?(:cc_type)\nThat will allow other objects which implement cc_type to use this. Probably not super helpful with this attribute, but it's a good pattern to follow.\n. I like our DB maintaining referential integrity. It does a much better job of it than ActiveRecord. I also feel that cascade is the correct on_delete to use here.\n. We should probably explicitly specify a sort for the id's here.\n. Oops!\n. I'll bring up the concept of immutable data structures with the core team at our meeting next week.\n@GeekOnCoffee We're currently talking about some improvements to the coding style & patterns we use in Solidus so we can set a pattern of higher quality for the future. It's a discussion that's just started, and are encouraging suggestions from the community on.\n. Could you add YARD for the parameters as well and mark this as @api public?\n. This is a bit gross. I would like to be able to call reimbursement.return_all which does all we need it to do.\n. I think this is the Reumbursement returned by subject.\n. Is there anything that would cause this to not be true?\n. I would prefer to get this from the return from subject rather than hitting the DB again.\n. I don't think this expectation is needed. Its been asserted elsewhere.\n. Can we base this on the return from subject rather than Spree::UnitCancel.last.\n. Could you please add a @return [void] here?\n. The ruby convention for methods ending in ! is that they are a dangerous version of an equivalent method without the ! (http://dablog.rubypal.com/2007/8/15/bang-methods-or-danger-will-rubyist)\nSince there is no return_all method that provides this functionality, I would name this return_all rather than return_all!\n. What happens when no reason is specified?\n. I see now that the expectation is listed above on line 12. I might prefer to to put these expectations in pairs:\n`` Ruby\ncontext 'when a reason is specified' do\n  it 'sets the reason to the reason specified\nend\ncontext 'when a reason is not specified' do\n  it 'leaves the reason as the default reason'\nend\n```\n. Similarly, I would have a context for when whodunnit is not specified here.\n. I think it's important to test the case where we are returning multiple things.\n. What about switching this to:\nRuby\nif invalid_items.any?\n  error_messages = invalid_items.flat_map { |i| i.errors.messages }\n  errors.add(:base, Spree.t(:not_enough_stock, errors: error_messages))\nend\nerrors.empty?\n. This does return true/false, so I think a name like: transfer_items_valid? would be better.\n. The readability of this could be improved by putting one thing per line:\nRuby\n[\n  :default_price,\n  :product,\n  { option_values: :option_type },\n  { stock_items: :stock_location },\n  Spree::Config.variant_gallery_class.preload_params\n]\n. I'd prefer some simpler indentation rather than sticking everything far to the right:\nRuby\n@variants = @variants.includes(\n  Spree::Config.variant_gallery_class.preload_params,\n  stock_items: :stock_location,\n  product: Spree::Config.product_gallery_class.preload_params\n)\n. There is a difference here that needs to be noted. .sum(:amount) will do a round trip to the database doing the sum in SQL, where .map(&:amount).sum will use the values from the objects.\nThere are different circumstances where each will have higher performance depending on if we have the data loaded in to objects already or not.\n. I'm not clear where this is being used.\n. Could we add some YARD here to explain the return values of this method.\nI also tend to to not have a method ending in a bang without a corresponding non-bang method.  See http://dablog.rubypal.com/2007/8/15/bang-methods-or-danger-will-rubyist\n. Is this a concept we should have on the order model? Some sort of method that returns all things that can be adjusted?\n. Does this work?\n. I had forgotten that none is an ActiveRecord method. Looked for our own implementation and didn't see one, and got confused. Sorry spreading the confusion.\n. We should probably have a combined unique index of some sort to ensure that there are not more than one price for the same set of things that should uniquely identify a price.\n. Do we have the forms for edit?\n. I would find this a bit easier to read if it were:\nit { is_expected.to be_invalid }\n. This is not English.\n. Could you please add some new lines in here to make it a bit easier to read, and shorten the line length?\nExample:\nRuby\nlet(:product) do\n  create(\n    :product_with_option_types,\n    price: \"1.99\",\n    cost_price: \"1.00\",\n    weight: \"2.5\",\n    height: \"3.0\",\n    width: \"1.0\",\n    depth: \"1.5\"\n  )\nend\nI would also like to see some of those removed if possible, and only supply the data which is important to make this spec pass.\n. Why begin?\n. I would prefer that we deal strictly with objects rather than objects or id's. It makes things a bit simpler. It can likely be more efficient by just using the ID's, but I'd prefer the simpler code for now.\n. For adding this field, I would prefer allowing nulls, and setting the default to be null. Then we could validate that the country ISO is within the list of valid ISO's or nil.\n. I'd rather do this with a single assertion:\nRuby\nis_expected.to contain_exactly(german_tax, eu_tax)\nor\nRuby\nexpect(subject).to contain_exactly(german_tax, eu_tax)\n. I don't like stubbing methods on the file that we're writing the spec for. I don't think that this test provides value.\n. I think it would be best to digest the prices. I don't know if we'll encounter an issue with key length if we have thousands of prices, but it's better to err on the side of safety.\n. I think that this test might be best expressed using an assertion like:\nRuby\nexpect { subject }.to chance { product.cache_key }\nSince that's what's important here.\n. I would prefer to use the Timecop library for this, which is already a dependency in Solidus.\n. Yes, I think that's makes sense. I'm not sure which PR you want to do that in.\n. Could we get some YARD doc for these methods, and the class?\nFor a method called price I would expect it to return a Spree::Price but instead it returns a BigDecimal. I would like to avoid returning BigDecimal in any of these scenarios. I feel it makes more sense to return a Money object or Spree::Price.\n. I think these exceptions should be on a shared parent class.\n. I don't think the Conservative portion of the name adds anything. This is just a standard line item pricer, so I'd call it LineItemPricer or StandardLineItemPricer.\n. We'll need to order the results from pluck somehow to ensure that they're returned in a consistent order.\n. I don't think this assertion is important.\n. That makes sense. I think some docs would help there.\n. I think this should just be @return [Spree::Money]\n. Do we expect current the current_store default currency to return a non-nil blank value (like \"\")? If not, we can simplify this to:\nRuby\ncurrent_store.try!(:default_currency) || Spree::Config[:currency]\n. Any reason just to not use find?\n. This seems odd to have inside the loop. Should this just be updating shipping_rate or should this be outside the loop?\n. Sorry. Must have been looking at my monitor cross eyed...\n. Can you please set expectations on the actual value (e.g. 'USD') instead?\n. I would like a better assertion here.\n. I don't believe that this change is safe to make.\n. This can just be if report_class\n. I would also like to see an expectation on the flash here.\n. I think we can lose the data-hook here. It was designed to be matched by deface overrides, but that won't be useful in this circumstance since deface operates on the template itself.\n. As part of refactoring this, I feel this one should be removed as it can't be used for its intended purpose any longer.\n. I would prefer to leave this as is. Since the factories are designed to be included in other people's app's, some people may be relying upon 'Doe' to still be the last name. I don't expect it will be a major issue, but there's no reason we can't leave this as it was.\n. I don't believe that these two should use raw. It is user input, so I don't think it should be trusted.\n. This should use AREL matches instead of LOWER.\nRuby\nstates = country.states.where(\n  Spree::State.arel_table[:name].matches(state_name).or(\n    Spree::State.arel_table[:name].matches(state_name)\n  )\n)\nThat will be properly database agnostic and potentially allow usage of indexes.\n. What caused this to change? It doesn't match the context this is in.\n. matches will use the appropriate case insensitive matcher depending on the DB. For example on Postgres:\n``` Ruby\nSpree::State.where(Spree::State.arel_table[:abbr].matches('NY'))\n=>   Spree::State Load (2.9ms)  SELECT \"spree_states\".* FROM \"spree_states\" WHERE (\"spree_states\".\"abbr\" ILIKE 'NY')\n``\n. I'm not particularly bothered either way.\n. If you don't care about the return value@return [void]should be used.\n. Same here.\n. Theto_ashouldn't be needed\n. Could we name theother_adjustment` something that implies this more directly?\n. Sounds good\n. I'm not super keen on building everything around callbacks. Could we try extracting the logic to some specific methods so I could do the following:\nRuby\nstore_credit.credit(100, admin_user_who_granted_this)\nstore_credit.debit(50, payment)\nThen those methods could create the ledger entry and modify the current balance.\n. I would also like to see a source here in order to track where the action came from (for example, a payment or admin user).\n. Rather than checking Spree::StoreCreditLedgerEntry.count I think it makes more sense to check: store_credit.store_credit_ledger_entries.count\n. Same here:\nexpect(store_credit.store_credit_ledger_entries.last.originator)\n. I still don't think this is quite what I'm looking for. I would prefer something like:\nRuby\nif action_amount > 0\n  credit(action_amount, user_performing_update)\nelse\n  debit(action_amount, user_performing_update)\nelse\nand move to a system where that is what's happening. Then the credit and debit methods are the ones which alter the ledger.\n. ``` Ruby\n@param liability_type [String] ...\n``\n. Same as above\n.null: falseas well to prevent tri-state booleans.\n. We can probably use symbols here instead of strings. Not a big deal.\n. I am going to look in to this more. There some confusing usage betweenoriginatorandaction_originator` throughout the code.\n. On further review the complex object is what's expected further down the chain:\nhttps://github.com/solidusio/solidus/blob/v2.0.0/core/app/models/spree/store_credit.rb#L137\nI am also not a fan of the generic term originator but that's what's expected here:\nhttps://github.com/solidusio/solidus/blob/v2.0.0/core/app/models/spree/payment_method/store_credit.rb#L36\n. Thanks for the reminder. Comment added.\n. This is creating a RubyMoney in order to reverse the amount_in_cents logic. Example:\nRuby\n[1] pry(main)> ::Money.new(1000, 'USD').to_d.to_s\n=> \"10.0\"\n[2] pry(main)> ::Money.new(1000, 'JPY').to_d.to_s\n=> \"1000.0\". Done.. As this is going through the PaymentMethod I would hope not, but I should raise a more appropriate exception in that case.. Added. I'm not a big fan of the test.\nIt's testing with .not_to without a corresponding test to check when it does change. For all we know, it could not deliver anything, or this test isn't configured correctly and we wouldn't know it.. I would like to see the wait_for_ajax eliminated. We should expect something on the page to happen.. What is destination_root and how comfortable are we rm -rfing it?. This expectation doesn't seem to match the description here.. Rather than using lower using arel matches would be preferred. This will use ILIKE in postgres, and LIKE in MySQL.\nThese types of comparisons can make better use of indexes than relying upon the SQL function return value.\nExample:\nRuby\nwhere(\n  arel_table[:name].matches(name_or_abbr).or(\n    arel_table[:abbr].matches(name_or_abbr)\n  )\n). This doesn't match the context.. I have some query optimizations I think would be suitable here. Any time we use pluck, we take back the identifiers and put them in a ruby array which means a round trip to the database.\nCurrently all_products is required to do 2 queries, and all_variants is required to do 3, but we can reduce that to one each pretty easily.\nExample of current behaviour:\n[1] pry(main)> Spree::Taxon.first.all_variants.count\n  Spree::Taxon Load (0.1ms)  SELECT  \"spree_taxons\".* FROM \"spree_taxons\" ORDER BY \"spree_taxons\".\"id\" ASC LIMIT ?  [[\"LIMIT\", 1]]\n   (0.2ms)  SELECT \"spree_taxons\".\"id\" FROM \"spree_taxons\" WHERE (\"spree_taxons\".\"lft\" >= 1) AND (\"spree_taxons\".\"lft\" < 12) AND (\"spree_taxons\".\"id\" != 1) ORDER BY \"spree_taxons\".\"lft\"\n   (0.2ms)  SELECT \"spree_products\".\"id\" FROM \"spree_products\" INNER JOIN \"spree_products_taxons\" ON \"spree_products_taxons\".\"product_id\" = \"spree_products\".\"id\" INNER JOIN \"spree_taxons\" ON \"spree_taxons\".\"id\" = \"spree_products_taxons\".\"taxon_id\" WHERE \"spree_products\".\"deleted_at\" IS NULL AND \"spree_taxons\".\"id\" IN (3, 4, 5, 6, 7, 1)\n   (0.1ms)  SELECT COUNT(*) FROM \"spree_variants\" WHERE \"spree_variants\".\"deleted_at\" IS NULL AND \"spree_variants\".\"product_id\" IN (1, 2, 8, 9, 4, 3, 5, 7, 6)\nBut if we try this:\n```Ruby\n    # @return [ActiveRecord::Relation] all self and descendant\n    #   products\n    def all_products\n      scope = Product.joins(:taxons)\n      scope.where(\n        spree_taxons: { id: descendants.select(:id) }\n      ).or(scope.where(spree_taxons: { id: id } ))\n    end\n# @return [ActiveRecord::Relation<Spree::Variant>] all self and descendant\n#   variants, including master variants.\ndef all_variants\n  Variant.where(product_id: all_products.select(:id))\nend\n\n```\nEverything can be done in a single subquery:\n[3] pry(main)> Spree::Taxon.first.all_variants.count\n  Spree::Taxon Load (0.2ms)  SELECT  \"spree_taxons\".* FROM \"spree_taxons\" ORDER BY \"spree_taxons\".\"id\" ASC LIMIT ?  [[\"LIMIT\", 1]]\n   (0.3ms)  SELECT COUNT(*) FROM \"spree_variants\" WHERE \"spree_variants\".\"deleted_at\" IS NULL AND \"spree_variants\".\"product_id\" IN (SELECT \"spree_products\".\"id\" FROM \"spree_products\" INNER JOIN \"spree_products_taxons\" ON \"spree_products_taxons\".\"product_id\" = \"spree_products\".\"id\" INNER JOIN \"spree_taxons\" ON \"spree_taxons\".\"id\" = \"spree_products_taxons\".\"taxon_id\" WHERE (\"spree_products\".\"deleted_at\" IS NULL AND \"spree_taxons\".\"id\" IN (SELECT \"spree_taxons\".\"id\" FROM \"spree_taxons\" WHERE (\"spree_taxons\".\"lft\" >= 1) AND (\"spree_taxons\".\"lft\" < 12) AND (\"spree_taxons\".\"id\" != 1) ORDER BY \"spree_taxons\".\"lft\") OR \"spree_products\".\"deleted_at\" IS NULL AND \"spree_taxons\".\"id\" = ?))  [[\"id\", 1]]\n=> 19\nThis means only one round trip to the DB, less work done in Ruby and hopefully happy developers!. My bad. I'll fix that up.. This method is no longer used and can be removed.. This is pointing to a larger problem in this bit of code. I think it might be best to apply some refactoring to here in order to avoid the respond_to? and send.\nSome suggestions of things I would try:\n\nExtract apply_coupon_code to a common base class (which extends StoreController) and modify the checkout controller and orders controller to inherit from that.\nExtract the error handling to a method, allowing it to be overridden to handle the error condition and call super to finish the job.. I would like it if we could avoid stubbing the controller under test.. Should this be a factory trait of some sort?. What should it be?. I don't like the use of stubs here. The feature specs are intended to interact with the site as a user would. Here we create an order for them and stub things rather than browsing through the site to add stuff to a cart.. I think it's helpful to use the actual string here. I've seen more than a few translation bugs get caught when people were specifying the key wrong in both places.. This spec didn't work, and as such I think it's best we just remove it for now. There are quite a few areas where we could improve the specs in the backend, and I don't think keeping the code around is going to make this any easier.. This should be ruby rather than shell.. We're talking about variant's above, but products here. How does this work?. We're talking about products and variants here using the same terms. I think it would be best to start with examples of cases where a product has variants, and what the product is and what the variant is.. Doesn't the price do that?. This information should come first to provide context about the information listed above.. A master variant is a complicated concept that should have additional information.. You should use \"associated with a specific variant\" rather than \"unique to\". Your backticks are mismatched here.. This is a good point and needs further detail. When should I use a property, and when should I use an option type?. Avoid use of unique. There isn't such a restriction.. This would be a good point to bring up master variants.. It sets the cost price even if it's not in an alternative currency.. What does this mean?. What is this?. If I have a red shirt, and a green shirt in small, medium, and large. What should my master variant be?. The flexible rate needs more explanation here.. It's difficult to infer what this needs to be based upon the table above.. It would be best here that calculable is a polymorphic relationship and possibly link to the rails documentation on that.. Static model preferences should be introduced here.. I would recommend users against defining something as object. What is the object being passed in here? Lets explain that.. I don't believe this is true. A tax rate has a precision of 8, scale 5 at the DB level and no such restrictions in rails validations that I know of.. This test doesn't match its description.. Yup. That makes sense. The example is fine as is as a trivial example, but will be helpful for people wondering what object is.. The amounts that can be represented here are actually between -999.99999 and 999.99999 to potentially accounting for tax rates over 100% and (for some reason) negative tax rates.\n\nI think it would be best to use a simple example here that a sales tax of 5% should be represented as 0.05 and not 5 as 5 is 500%.. There are two ways that the state of payments are represented. There is the state of the payment status for the order, which is what is described below and the state of an individual payment.\nAs an example:\nAn order for $100 has a single payment of $50 that is complete. The status of the one payment is complete, but the order is in a payment state of balance_due.\nIf the order has multiple payments:\n\n$80 - failed\n$80 - completed\n$80 - completed\n\nThe order will be in a payment_state of credit owed.\nRefunds play in to this as well as those can bring the payment state back in to a state of pair if the customer overpaid in the above case. This is complicated enough that it needs an explanation of what the difference between order payment_state and payment's state is.. An order can also be in the state void. This is not true.. typo. Replace \"state or country\" with \"location\". Describe the difference where sales taxes are added to the price after the item is added to the cart (or address specified) where with VAT the tax is included in the displayed price.. Missing word.. I'd add an example here about offering different shipping services based upon ship time. For example, overnight shipping for $30 and ground shipping for $10.. I don't believe this is a pattern we wish to encourage. If this has resolution issues as it is I think that:\nRuby\nRails.application.config.spree.promotions.actions << ::MyPromotionAction\nor \nRuby\nRails.application.config.spree.promotions.actions << MyNamespace::MyPromotionAction\nwould be preferrable.. Below, it is stated that this can be configured to match all or match any.. Typo here.. The singular \"Brand\" doesn't match the plural \"Brands\" below.. ",
    "adammathys": ":+1:\n. :+1: \n. :+1:\n. :+1: Looks good to me.\n. :+1:\n. +:100: Nice find.\n. :+1: Looks good to me.\n. Exactly. \nAlso, even if that is desired behaviour (each line item counts as a usage), it doesn't take quantity into account. So someone who ordered 3 different variants would have a usage count of 3. But if they ordered 2 of one variant and 1 of another, it would only have a usage count of 2. \n. I'm going to close this issue. The usage count logic has all been updated. (Made some changes in Bonobos' Spree fork that have since been cherry-picked.)\n. :+1: From me.\n. :+1: Nice.\n. :+1: Need this for https://github.com/solidusio/solidus_signifyd/pull/1\n. :+1: Nice.\n. :+1: Looks good to me.\n. :+1:\n. :+1: \n. :+1: \n. :+1: Looks good to me. Largely just stock transfer stuff, which I think got a pretty good review when it was originally added.\n. :+1:\n. :+1: \n. :+1: \n. :+1:\n. :+1: Looks good to me.\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1: Looks good to me.\n. :+1:\n. :+1:\n. :+1: As far as I've been able to tell, this is literally never used right now.\n. :+1:\n. This can be closed in favour of #170. Which is nearly identical. (It is rebased against master and has regression test.)\n. :+1:\n. :+1:\n. :+1: Good find.\n. :+1:\n. :+1:\n. :+1: \n. :+1: \n. :+1:\n. :+1:\n. :+1:\n. Need to update this to something like:\nruby\ndef options\n  preferences.to_hash\nend\nBecause what's currently there is silly, it just converts all keys to symbols, and unnecessary. Also, it doesn't play nice with the static preference class.\n. :+1: Awesome. All looks good to me.\n. @magnusvk, @jordan-brough, @athal7: For reference, here's how this hooks into spree-backend right now. Which provides an almost identical interface to the other static preferences in spree-backend:\nruby\nBonobos::GatewayConfiguration.new(\n  SpreeBackend::Application::GATEWAYS_FILE\n).load!\nI do have a minor tweak or two to make to the load class. (Specifically, it won't be updating records since that can cause all sorts of issues.)\n. As with spree_config_preferences, it's still possible to view the gateway in the admin when loading from a YAML file. However, it now hides all of the preference fields. Making it impossible to update them without first consciously deciding to convert to the database store preferences. (Also, the assignment operation is a no-op when using the static preferences.)\n\nFor reference, this is what it looks like when editing a gateway with preferences stored in the database:\n\n. It's for configuration. Otherwise when you try to update it in the admin it'll mess everything up. It will set the type to the first provider in the list but not clear any of the preferences. (Resulting in 5XXs on all subsequent attempts to view or edit the payment method.)\n. :+1: I agree with @gmacdougall, making this extensible would be nice. \nI should point out that if you want to document the class attribute you'll need to do something like this. Because the documentation tools we use won't read anything in the included block.\n. :+1: Outside the one minor documentation tweak, this looks good to me.\n. :+1:\n. That view isn't associated with adding store credits. Right now, any store credit payments on an order have a link that results in a exception due to it trying to render information about the store credit but not finding an appropriate partial.\n. Right you are, I'll toss one together.\n. :+1: \n. :+1: \n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. :+1: Outside of those couple of config things.\n. @jordan-brough Yeah, it slowed the page down considerably. With this merged we can look at adding it back in.\n. @jordan-brough I was planning on doing so later today. And yeah, should be a simple change.\n. :+1: Not to mention that it tries to render a non-existent template.\n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :flushed: :boom: :dizzy_face:\nAmazing! :+1: \n. It's been a while since I created that, but I believe that with a little bit of work you should be able to use that association to help figure out which line item was added by a CreateLineItems action.\nThe more difficult task will be coming up with a nice place to hook in the line item removal. Right now, promotions are so heavily tied to adjustments that I don't think there's a nice place for it. (And that a larger re-factoring needs to happen before these types of promotions could be nicely written.) Specifically, instead of simply marking adjustments as ineligible, some sort of roll-back mechanism to remove the effects of ineligible promotions from an order is required.\nLooking forward to seeing what you come up with. Maybe there's an easier path I'm not seeing.\n. Ugh! Definitely a bad copy/paste on my part. The reason this works is because the admin view just re-uses the item adjustments one.\nI suppose having Spree::Promotion::Actions::CreateQuantityAdjustments.calculators return the correct thing might be useful. Maybe we should just update this to read:\nruby\napp.config.spree.calculators.promotion_actions_create_quantity_adjustments =\n  app.config.spree.calculators.promotion_actions_create_item_adjustments\nSince that's technically the most correct answer. (Although it does mean the FlexRate calculator would become available for quantity adjustments. Which might work. I'm not certain.)\n. I don't believe this specific action was available for line items before, so I wouldn't expect any existing store to be relying on current behaviour. Some one would have to add it manually for their own store. (Not to mention current behaviour doesn't make a lot of sense for line item adjustments, it would be a weird implementation of the existing flex rate calculator.)\nI would like to see some additional tests for this. Now that we've got some branching logic I would like to have some tests to ensure correct behaviour when passed an order versus a line item.\n. Overall :+1: from me. Very much appreciate the YARD documentation. \n. :+1: From me. Also, very much appreciate the Rake task. \n. :+1: For the code from me. Although would have rather not had this re-based on https://github.com/solidusio/solidus/pull/935 so that this wasn't dependent on another change getting merged first.\n. :+1: Looks good to me.\n. Like @cbrunsdon, I'm not crazy about calling things Legacy. I don't have a better alternative though.\nBig :+1: on the general direction of this change from me. Moving chunks of related logic out of the \"core\" models (LineItem, Order, Shipment, etc.) is something I could see being useful in a number of places. That being said, I'm not overly fond of objects that only modify fields on another object. Sort of goes against the \"I\" in SOLID, leading to code that ends up being harder to test and refactor later on. (In order to test a Pricer, we make assertions on a Spree::LineItem. This principle is violated all over the place in Solidus, which in my opinion is one of the many reasons it's so hard to write good unit tests for much of the project.)\nPersonally, I'd be happier with a toned back version of this change that introduced a LegacyLineItemPrice (:tm:) that was responsible for determining what amount and in which currency a LineItem should be priced. Leaving the logic for assigning the information to the columns on the LineItem itself.\nEdited: Clarified that I was referring specifically to unit tests, and not just tests in general. \n. :+1: I like the abstraction and general direction.\n. :+1:\n. :+1: Looks good to me.\n. :+1: \n. :+1: \n. :+1: Definite improvement.\n. :+1: \n. Added a relatively simple feature test to exercise this behavior. \ncc: @tvdeyen @jhawthorn \n. :+1: \n. :+1: \n. :+1: \n. :+1: \n. :+1: From me. Definite improvement over the original factory.\n. It normally isn't called until Rails::MailersController#index is hit.\nThis isn't really different than how we're loading everything in now. ActionMailer::Preview.all simply requires the dependencies the same way we do right now. Personally, I don't think it makes sense to do this outside of the development environment, but decided to leave this as close to how it's currently working as possible while fixing the poor behavior.\n. @jhawthorn :+1: I believe so.. Fixed by https://github.com/solidusio/solidus/pull/2259. I don't believe this is the best way to fix this issue. Now that the handler is reliant on knowing about the promotion, there's little purpose for it being its own class. It is directly tied to the calculator and to only ever being used for promotions. \nA better approach would be passing the handler the list of items and an amount to distribute. Then updating the the interface to query for the amount that should be applied to a specific item.. Yes, it's only used in this file. (There is another method with an identical name in Spree::PromotionCode, but it is not the same as this one.)\n. I think maybe you forgot a .\n. Right you are. That's what I get for copy/pasting the original code.\n. Based on what we were originally doing, I believe it's what we want. Simplifying the existing code for the case when we're looking for a variant's image:\n``` ruby\nAssume self == variant\nif images.empty?\n  if false\n    # First part never going to happen, because we have a variant.\n  else\n    if !product.variant_images.empty?\n      product.variant_images.first\n    else\n      # No image\n    end\n  else\n    images.first\n  end\nend\n``\n. That's a good point. I'll see if I can come up with a nice interface for specifying fall-backs.\n. This is a little ambiguous. When I first read it, I thought it meant to put my credentials here. Not that this is a nice name for referencing these credentials later. Maybe something likestripe_env_credentials` would be clearer.\n. No, that shouldn't be too hard to do. I can just toss in a conditional. It'll all get deleted once we remove the deprecation action anyway.\n. We probably don't need this.\n. While I know we don't exactly have a very good track record of it on this project, I would like to be more careful about using models in migrations.\nWould you mind adding simple class declarations above?\n``` ruby\nclass Spree::ShippingRate < ActiveRecord::Base; end\nclass Spree::TaxRate < ActiveRecord::Base; end\netc.\n```\nThat way if for whatever reason we decide to change the class names or remove those classes we don't accidentally break this migration. Alternatively, we could rewrite the migration to use SQL but in this particular case I think that's probably more effort than it's worth.\n. It would be nice to wrap this in a say_with_time block. That way we still get some feedback when running the migration on how long this section took, what it's doing, and how many rows were affected.\n. I don't think the say_with_time is necessary when all it's wrapping is an execute. But it doesn't really hurt to have it.\n. I agree with @houndci-bot, I don't think table_name is doing anything here.\n. I agree with @cbrunsdon, this is a little too heavy. I would prefer the simpler Array.wrap, although I would probably just create a private method (instead of in-lining it) and call it a day:\n``` ruby\ndef safe_add_index(table, columns, options = {})\n  if columns_exist?(table, columns) && !index_exists?(table, columns, options)\n    add_index(table, columns, options)\n  end\nend\nprivate\ndef columns_exist?(table, columns)\n  Array.wrap(columns).all? { |column| column_exists?(table, column) }\nend\n```\nI also don't think including the options in the column_exits? call is correct. The options passed in to that will check to see if there's a column with those restrictions. Whereas the options we're passing in are meant to apply to the index associated with that column, not the column itself.\n. That won't quite work due to the nature of the relationship between stores and payment methods. It could be writen as:\nruby\nscope :available_to_store, -> (store) { joins(:stores).merge(Spree::Store.where(id: store.id)) }\nHowever, this would mean a divergence from how we typically handle store associations. Normally, if a store doesn't have anything associated to it we assume everything belongs to that store. I believe this decision was made a while back to help handle single store apps by ensuring everything continued to work without having to create the missing associations.\nWhile I'm definitely not opposed to changing that behavior, it would require a larger amount of work and a conscious decision to have all single store apps require some additional configuration behind the scenes. \n. I agree. Just went with the the simplest placeholder name for the time being.. 1. Love the idea of moving labels to the output object. I'll put together that change in a few.\n2. We need some way of tying the rate to the line item or shipment it should be applied to. The ID is our only real way of doing so. Sorting both lists won't always work. (For example, some items can be tax exempt and shouldn't have any rates associated to them.)\n3. As you've commented later, this is due to adjustments requiring a source.. While I agree that using adjustments for taxes is not ideal, I believe that is much too large of a change to make in this PR. . Shipping rates are much easier to avoid passing database IDs. Since there's no need to tie the rate to any existing database record afterwards. If we were looking to make an interface for returning a list of tax rates for an item I would entirely agree with you.\nHowever, we're looking to return a list of calculated taxes for items on an order. Meaning we need to tie those values together in some concrete way. Sorting the items and using their indices, giving them a new alphanumeric identifier, or using the database IDs are all functionally equivalent. Using the database IDs is just the simplest and most robust approach. . It currently is an array of TaxedItem objects. This looks to just be a on old name that got left behind in one of my rebases. I'll update it.. Do we want to remove both configuration points? Or just the shipping rate one?. Definitely. I've marked both classes and their configuration points with @api experimental. (Which is what we used for the tax_adjuster_class configuration point.) I also added in a note to each class explaining that they're still in development and that the input specifically is likely to change.. I didn't put the new tax calculators inside of models/spree/calculator because they aren't like the rest of the calculators in there. All of those calculators inherit from Spree::Calculator and as such have an already established interface.\nThe two new tax calculators share only the description of being a \"calculator\" with everything else in that namespace. Perhaps this is an indication that we should use a different name altogether for these new classes, because they are not meant to replace the existing calculators. (And the default implementations still use the Spree::Calculator::DefaultTax at the lowest level to compute the tax amount.). I believe this is out of scope of this PR. The goal isn't to change any of the current behavior, just to add in a new extension point. \nThat being said, I agree that it doesn't make sense that taxes aren't recalculated on completed orders. I'll open a second PR to propose a reversion of that change.. Ideally, this shouldn't ever fail. I'll update this to update_attributes! (update! is unfortunately overridden on adjustments) so that if it ever does it makes a noise.. This name will also show up in the adjustment label for promotions that have one of those actions. So it's not entirely limited to admins.. This is how many times each code can be used before becoming inactive. There's also usage_limit which more closely matches the definition here. (How many times the promotion can be applied before becoming inactive.). > while a free shipping promotion would be applied automatically.\nThat isn't always the case. You could have free shipping that only applies after a customer enters a code or visits a specific page.. I would use \"negates\" instead of \"subtracts\", but that might just be personal preference.. Creates a single adjustment associated to the order. I might also add something about not recommending its use. Order-level adjustments don't work particularly well with taxes or refunds.. Will create adjustments on each applicable line item. (e.g.: If there's a product rule, it will only apply to products matching the rule.). Creates adjustments based on groups of items, not just the first set of matching items. So the action would apply based on the number of groups of t-shirts.\ne.g.: 0-2 shirts - doesn't apply, 3-5 shirts - applies once, 6-8 shirts - applies twice, etc.. I might also mention that it must implement the perform(options = {}) method that should return a boolean declaring whether the action was applied successfully. \nAlso, that it's recommended that it define a remove_from(order) as well.. I would try to be more specific that it's the order's item total. (i.e.: Before taxes/shipping/other discounts/etc.). > the promotion actions are re-applied.\nMight be a bit misleading. The action isn't really re-applied. The amount will be re-calculated and the eligibility of the adjustment will be changed based on the eligibility and if the amount becomes $0. But I'm pretty sure all of the logic in the action's perform(options = {}) method won't be re-run.. It is a little odd. I'm not sure why it was originally written this way in solidus_multi_domain, but I figured it would be best to keep it the same.. This is the direction we use for most of these types of associations. (As you found with payment methods.)\nI agree that it's confusing and I'm also not a fan of the \"none means all\" pattern we've adopted, but it's probably best to at least keep them consistent.. > (or fix) if of interest. It might be a little bit misleading to use the word \"private\" here. It has a specific connotation when associated to a GitHub fork. (Technically, there's considerably more work involved in making a private fork of Solidus, since making a private fork of a public repo isn't functionality GitHub provides.). We should probably mention that a column needs to be added to the model to persist the preferences. \nruby\nclass MyMigration < ActiveRecord::Migration[5.0]\n  def change\n    add_column :my_table, :preferences, :text\n  end\nend. > Solidus's preferences and their default values . . . . ",
    "brendandeere": "test this please\n. I will also write a spec for LoginRedirector after talking with @forkata \n. @jhawthorn Given that it is the stock estimator we could add the config to the Stock module. Then it would become.\nStock.estimator_class \nThoughts? \n. @jhawthorn What do you think of Spree::Stock as a module like this ? \n. @jordan-brough Yeah I like the idea of having them under Config. It keeps configurable behaviour all in the same space and easier to find when someone is looking for it. Right now there is only 1 estimator in the project so nesting it under Config would work, but I do like having Config::Stock because it does really specify where that customization will be applied.\n. @jhawthorn @jordan-brough Thoughts on this configuration? I wanted to move the Stock configuration to Spree::Config::Stock but since Spree::Config is defined in the engine as a constant and not a clas that wasnt working out. So I settled on Spree::Config.stock.estimator_class\n. @jhawthorn @jordan-brough Thoughts on this configuration? I wanted to move the Stock configuration to Spree::Config::Stock but since Spree::Config is defined in the engine as a constant and not a clas that wasnt working out. So I settled on Spree::Config.stock.estimator_class\n. There is already this here: \nhttps://github.com/solidusio/solidus/blob/master/core/app/models/spree/adjustment.rb#L53\nAnd it seems to be used in the front end gem to hide them from the checkout summary partial\nhttps://github.com/solidusio/solidus/blob/master/frontend/app/views/spree/checkout/_summary.html.erb#L48\n. We could easily alias nonzero as user_visible if that is something we want to do.\n. I am Pro this! In working on a Solidus Easypost gem I came accross the requirement for carton shipping rates to have shipping methods. This meant creating shipping methods for all the returned easypost rates . There was no clear way in the existing architecture to indicate which provider and which service a Shipping Method actually represents, So i ended up shoving that info into the Internal name and hoping it was never touched by an admin.\nNot all providers include their company name in the shipping method Code. UPS usually does (ie: UPSGround), but USPS for instance does not (ie First).\nThis change would make it much easier to identify which 'real world' provider/service the ShippingMethod  was modeling\n. Thanks guys ! \n. How would you feel about leaving touch_all_variants in the model and simply removing the callbacks instead?\nThat would keep the api consistent and it would be easy for extensions to call the touching method as needed.. No,  @@user_class.constantize is a class. After talking with @jhawthorn, figured out it would need to be @@user_class.constantize.new.is_a? ... but that we didn't like that syntax\n. This doesn't seem to be used anywhere else in the codebase. It seems like a logical callback to me, but it might not be something we want to force on the User class.\nThoughts? @jhawthorn @athal7 \n. This is a good point. I was followng the patten of the other modules in that directory, but I guess since this module doesn't need #included it isn't necessary\n. Good catch! \n. Agreed, Ill pull it out \n. Strong params Here grab out these keys\nThey seem to get saved to the arbitrary options hash associated with line items here\nSeems weird but I included them since it seems to be allowed .... \n. ",
    "philbirt": ":+1: from me.\n. :shipit: \n. I'm not sure we actually want or need this, going to close it out\n. @jhawthorn @cbrunsdon @richardnuno @adammathys This is now all green, would you guys mind taking a look? \n. :+1: \n. Looks good to me :+1: \n. Should we use it here? https://github.com/solidusio/solidus/blob/master/core/app/models/spree/promotion/rules/user.rb#L5-L7\n. I like it :shipit:\n. @jhawthorn fixed the specs and tested this out with auth_devise and multi_domain with no issues!\n. At the risk of sounding foolish, is there a good example of how this should be done? Like, where the docs should be, in what format, what sort of information?\n. Updated it, allowing it to be extended (great idea @gmacdougall) and some documentation. If the docs could be any better or should include anything, please let me know\n. Went through this with @magnusvk and it should be good to go\n. Added a spec\n. :+1: \n. Removed the method completely based on feedback\n. You can never be too careful (except sometimes)! I think you may be right, but I don't know much about ensure_inventory_units\n. Actually the after_save hook is necessary, but updated it per @magnusvk comments\n. @magnusvk updated specs and squashed everything\n. @jhawthorn Ah nice, i had the longhand form since i was doing update_attributes originally. Updated.\n. :+1: \n. Updated based on all the feedback\n. Good point @jordan-brough, updated it to be config preferences. I also added a condition for created_at, as well as updated_at. I think it would be nice to be able to toggle on both, but interested in what others think.\n. Unfortunately yeah. I had gotten it working with selenium but it doesn't seem to work with poltergeist. I'm not sure why yet.\n. @magnusvk @adammathys @jhawthorn The feature spec is now passing, would you gentlemen mind taking another look?\n. Good call. Added @gmacdougall \n. Sure, I can try to. We have a custom matcher that we would like to function in the following way:\n- If I am adding a new line item with certain custom properties, I would like to create a new line item (split them) so the matcher needs to return false for no matches\n- If I am removing a line item with certain custom properties, we need to make sure the options match the line item's custom properties, so the matcher needs to return true for a match\nThe issue lies in that the same matchers get run for both adding and removing, and I need to have one behavior for adding and a slightly different behavior for removing. I also toyed with the idea of passing another key in the options hash through to the API for signifying an add or remove operation (instead of modifying the solidus code at all), but that seemed redundant and strange to me.\nFor what it's worth, https://github.com/solidusio/solidus/pull/457 is only related to this pull request in that I saw that it was kind of odd looking behavior and thought I should be a good boy scout and fix it -- I don't actually need it to proceed. I should have clarified that the two aren't connected in any other way.\n. Chatted offline with @jhawthorn and it isn't desirable to look up line items differently for adding vs deleting. Closing this out as we have found an alternative.\n. ping @jhawthorn @gmacdougall @cbrunsdon \nMind taking a look? Any reason we shouldn't just delete the line item in hand?\n. :+1: \n. Refactored this so #short_ship will call #cancel_unit. Unfortunately we are unable to nest OrderMutex locks currently, so this refactoring is dependent on something like https://github.com/solidusio/solidus/pull/507 getting pulled in.\n. Reverted the refactoring for now so that we can spend more time talking about nesting OrderMutexes. Added docs for the public methods in OrderCancellations.\n. @gmacdougall Thanks for the thorough review. I have updated the pull request based on your comments:\n- Use subject's return value in place of {ActiveRecord}.last in all of the specs\n- Updated to @api public where relevant\n- Added @param to public methods where relevant\n- Added a #return_all! method to Reimbursement which will accept return items, persist, and perform. I think this is what you were describing in your comment, but let me know if that is not correct. Added api public and a brief description of what it does. I wasn't sure about the return value/raise of this method since it is heavily dependent on the state of the reimbursement and it's return items. Thoughts?\n. @gmacdougall Thanks! Just pushed some code addressing spec comments. I have one question about the ! method. I'm really not too particular, so I'm happy to change it. I just want to make sure we are consistent about this in the future, as this is something I have seen us do a lot all over the place without a non-! variant  https://github.com/solidusio/solidus/pull/502#discussion-diff-45085763\n. @gmacdougall Cool. Personally i've always been in your camp regarding this, so ! dropped. The contents of the method were pretty !-y (with reimbursement.perform! not having a .perform method) so it seemed like this should have also had ! in turn.\nGood article to keep in my back pocket. Appreciate the thorough review.\n. @jordan-brough Yeah there are definitely ways to satisfy https://github.com/solidusio/solidus/pull/502 without doing this at all. First and easiest, I could just leave the refactoring to use common code alone and accomplish that later. I'm sure there are other alternatives, but that seems the most sane to me.\n@jhawthorn I just want to be clear that I didn't come into this thinking this was the only or best approach. Hence why I said \"this is my attempt at making it work\". I also didn't really need to do it -- I thought and still think it's reasonable-ish, and I thought it was a desirable feature, so I attempted to make it work.\nI agree some seemingly unrelated ones are still failing and I am looking into it, because they most definitely are related. I, like you, have zero desire to have a red master or do anything risky with this, as we are heavily reliant on it locking when we expect it to and releasing the lock when we expect it to. This isn't a deal breaker for us to get in quickly (or at all for that matter), so let's take our time and get it right. I would just really appreciate some feedback on how we could make it better and specifically what is \"not good\" about it. \n. The two partials were actually identical at this point, sans one variable, so i pushed the whole file into one common partial, and passed the calculators as a local. Not 100% on the naming of the new partial or its location, so any opinions on that would be welcome\n. Solid :+1: \n. @cbrunsdon i believe its supposed to set which calculators are available for the different types of promotion actions. Although that its been like this for awhile is kind of telling that it may be useless.\n. Looks good to me. Thanks for cleaning up all that message_chain junk in the estimator spec :+1: \n. :+1: \n. :+1: \n. Seems like a good change to me :+1: \n. :+1: \n. Is it okay to remove this?\n. Not sure if we want to do it now, but this method seems poorly named. \"old payments\" doesn't seem exactly like what it is invalidating here.\n. Well that is pretty interesting and weird. Good comment\n. Good call hooking up returns where it makes sense to pull in store credits.\n. What is this for?\n. The reason we changed this, is because the DbMaximumLengthValidator was previously returning a limit of 255 here: https://github.com/solidusio/solidus/blob/master/core/app/models/spree/validations/db_maximum_length_validator.rb#L14 but now is returning nil, which means limitless.\nI figured it was good to keep the fact that we were using this validation, but didn't know how to make this test pass without stubbing strange things in the DbMaximumLengthValidator or stubbing it like i did here.\nAlternatively, we could use a more simple thing like: validates :value, length: { maximum: 255 } but didn't know how people would feel about getting rid of this db-level length validation.\n. Checked into why this changed. It looks like there are a handful of specs that will fail if we do not expose these routes:\nrspec ./spec/controllers/spree/api/variants_controller_spec.rb:145 # Spree::Api::VariantsController can learn how to create a new variant\nrspec ./spec/controllers/spree/api/variants_controller_spec.rb:151 # Spree::Api::VariantsController cannot create a new variant if not an admin\nrspec ./spec/controllers/spree/api/variants_controller_spec.rb:156 # Spree::Api::VariantsController cannot update a variant\nrspec ./spec/controllers/spree/api/variants_controller_spec.rb:161 # Spree::Api::VariantsController cannot delete a variant\nTalked about it with @jhawthorn and it seems like these are probably good routes to expose.\n. Maybe: s/don't/doesn't/\n. Great idea\n. Can we use non-hash-rocket syntax here (and below)?\n. I like that a lot better, updated.\n. Could we add some documentation to this method?\n. Yeah, I definitely considered that when building this. If we can reach a consensus on this change, I'd be happy to refactor short_ship to use this and remove the private method its using altogether as well.\n. Currently nowhere in this repo, I need it to hook in from an extension.\n. Interesting. I also thought we would want the bang-named-variant for anything that could reasonably raise exceptions , not only if that method had a non-dangerous version. In this case, return items unable to be accepted or IncompleteReimbursementError\n. unallocated*\n. ",
    "richardnuno": "Looks good aside from the small suggestions :+1: \n. The Backbone changes seem good to me, what I'm a little more concerned about is the addition of Thorax. I haven't used Thorax before but I have used Marionette which (correct me if I'm wrong here) seems similar. When using Marionette I found that although it did add some nice functionality, the complexity it introduced when trying to write/debug/navigate the code didn't make it worthwhile. I don't think Thorax would give us any additional functionality that we couldn't achieve with just Backbone. There's also the added overhead of having to keep both libraries in sync and up to date. Happy to discuss more of the tradeoffs but I'd prefer not to add anything on top of Backbone.\n. Looks great to me :+1: \n. Changes look good to me :+1: \n. Looks good so far :+1: \n. Looks good :+1: \n. @magnusvk I think it wasn't defined yet because the cherry-picks hadn't been merged into master. Just rebased and that should hopefully fix it.\n. @gmacdougall updated, good to merge?\n. The test failures seem unrelated and pass locally\n. Rebased on top of current master\n. @athal7 rebased and tests are now passing. My permissions don't allow me to merge this in so someone else is going to have to merge it.\n. @jhawthorn updated, good to merge?\n. The test failures seem unrelated and pass locally\n. Rebased on top of current master to see if that helps with the test failure\n. @jhawthorn you're right, just rebased again.\n. Original PR here https://github.com/bonobos/spree_store_credit_payment_method/pull/67\n. @jhawthorn made most of your suggested changes, had to change the store_credit_events_helper.rb quite a lot because Solidus doesn't have virtual gift cards by default (it's an extension)\n. I have a related PR in https://github.com/solidusio/solidus_virtual_gift_card/pull/3\n. :+1: \n. :+1: \n. :+1: \n. @magnusvk agreed on the code duplication and documentation. To avoid overriding methods how about a base class that calls a defined class that chooses the correct adjustment? As far as the last question, that's correct, they would both be active. Would the intended behavior be to only have one promotion active regardless of item type or does that seem like another customization to you?\n. @magnusvk ok, closing this PR for now seeing as how that'll involve some more changes. Will reopen once I've got it all sorted out.\n. @athal7 added a test to ensure custom promotion choosers are instantiated.\n. Moved the code over to app_configuration.rb if anyone has a couple of minutes to take a look\n. @athal7 added some more commits to address your feedback\n. ping @jhawthorn, @gmacdougall or @cbrunsdon \n. :+1: \n. @jhawthorn updated with your feedback. Thanks for suggesting the extra spec, it actually uncovered another issue that would have happened further along while finalizing the order. When finalizing the new order, the shipment would be finalized again causing the count on hand for the variants in the shipment to be decremented (causing the out of stock error again if there is no stock). I've added a fix for that issue as well, mind taking another look?\n. @athal7 updated with the symbol-to-proc syntax\n. @athal7 sure, squashed all the commits\n. @jhawthorn any chance you can take another look at this?\n. I took another look at the unreturned_item_charger_spec and you're right, it wasn't hitting the create_proposed_shipments at all. set_shipment_for_new_order was doing a update_attributes!(state: \"confirm\"), that I've since removed, causing the order to not transition to confirm via the state machine.\nThe code is calling .next on the order until the confirm step is reached or .next returns false. When a user has store credit, the order is able to reach the confirm step. When the customer doesn't, it would stay in the payment step set_order_payment would associate the payments and set_shipment_for_new_order would move the order to the confirm state by doing a update_attributes. Moving set_shipment_for_new_order up and removing the update_attributes!(state: \"confirm\") means that the order may not be in the confirm state before calling .complete! To fix this, I moved set_order_payment up before the attempt to transition the order to confirm. This means the order has all of the necessary associated data so that it's able to reach the confirm state.\nRegarding the raise in the create_proposed_shipments (instead of returning the shipments), I agree it's something that shouldn't happen under normal circumstances but I also think the presence of a check like unreturned_exchange? && shipments.all?(&:shipped?) indicates that it's a special case we're trying to work around. Raising an error in create_propsed_shipments would leave the current bug unfixed. Definitely open to alternative solutions to fixing this bug but as we discussed over Slack a while ago, all of the other solutions we've come up with so far would also not be ideal (adding unless: :unreturned_exchange? to several state machine hooks) or very time consuming.\n. @jhawthorn totally reasonable request, just not sure how to go about testing that. I think the original intention was to have the order go through the state machine until completion. Since it didn't, the update_attributes!(state: 'confirm') remedied that but nothing points to intentionally wanting to skip steps in the state machine. Since I believe we always want the order to go through the state machine, I've added error raising whenever the order is not in the state I expect and tests for that in the latest commit.\nDefinitely want to add as much test coverage as possible but struggling to come up with good test cases. Could you be more specific about the tests you'd like to see in both the order and unreturned item charger specs?\n. Closing in favor of https://github.com/solidusio/solidus/pull/367\n. @athal7 updated with spec\n. @athal7 updated and also added missing translations for the stock transfer detail page which were causing warnings while running the tests.\n. @magnusvk had forgotten about the attempt to centralize the hooks, moved it over to Spree::Config\n. We also have validation in place to ensure that there is only one shipping method across all of the shipments, would that be something we want to bring over as well?\n. @jhawthorn talking to @magnusvk we realized that preserving the selected shipping rates would be a little more complex and time consuming than we'd hope. I filed issue https://github.com/solidusio/solidus/issues/347 so we can eventually work on supporting this but I do agree this extension point is awkward. Happy to jump on a hangout or something to talk through the challenges of preserving the shipping methods if you'd like but closing this PR for now in favor of the issue.\n. tests look good :+1: \n. @jhawthorn updated the specs\n. @jhawthorn @magnusvk updated to use comma separated values\n. Looks good to me :+1: \n. @jordan-brough good to merge?\n. @athal7 updated restricted_stock_transfer_management with the approach we discussed\n. @athal7 updated!\n. @jhawthorn @gmacdougall or @cbrunsdon, mind taking a quick look at this one?\n. @athal7 added those specs you mentioned, am I missing any scenario you were thinking of?\n. @athal7 was this more of what you were thinking of?\n. @athal7 @jhawthorn any thoughts on next steps with this pull request?\n. @magnusvk @athal7 updated\n. @jhawthorn Since we want to always apply store credit whenever available, even in favor of other payments, that check seems insufficient.\n. @jhawthorn Since we want to always apply store credit whenever available, even in favor of other payments, that check seems insufficient.\n. @jhawthorn no reason in particular, there was a mix of both and just wanted to keep it consistent throughout the entire file.\n. @athal7 @jhawthorn added a rake task in the last commit that creates a product with over 4000 variants to test the performance implications of the change. Hoping it might be helpful in the future to test other scenarios.\nOn my local machine I get the following response times:\n```\nurl: http://localhost:3000/api/products/ruby-on-rails-baseball-jersey\nmaster: Completed 200 OK in 766ms (Views: 697.4ms | ActiveRecord: 46.4ms)\nbranch variant-image-rules (3 image rules): Completed 200 OK in 1058ms (Views: 963.5ms | ActiveRecord: 48.6ms)\nurl: http://localhost:3000/api/products/performance-shirt\nmaster: Completed 200 OK in 248782ms (Views: 225584.3ms | ActiveRecord: 18565.9ms)\nbranch variant-image-rules (3 image rules): Completed 200 OK in 367021ms (Views: 344624.9ms | ActiveRecord: 18368.9ms)\n```\nAs expected there is a performance difference. It's pretty significant with a large amount of variants but as @athal7 mentioned (and as you can see in the response time in master) there are already some existing performance issues with the endpoint.\nI'm also very interested in hearing suggestions on how to tackle the performance concern here.\n. @jhawthorn I pushed up a branch that includes the same type of sample data setup script included in the latest commit of this PR but for master. It creates 10 products with about 4000 variants each. Each variant has 6 images associated with it, either by using the direct association present in master or using the variant image rules in this PR. Let me know if you think they're not equivalent in any way.\nI tried hitting the api endpoints below with the application settings you mentioned config.cache_classes = true and config.action_controller.perform_caching = true. I got the following response times for each branch (master is actually variant-image-perf-compare but I thought master would make it easier to compare) on my local machine.\nCold cache\n|  | master | variant-image-rules |\n| --- | --- | --- |\n| /api/variants?q[product_name_or_sku_cont]=performance&in_stock_only=true | 3916ms | 3482ms |\n| /api/variants (variants from current sample products) | 4432ms | 3462ms |\n| /api/variants?page=1945 (variants from performance sample products) | 3871ms | 3005ms |\nWarm cache\n|  | master | variant-image-rules |\n| --- | --- | --- |\n| /api/variants?q[product_name_or_sku_cont]=performance&in_stock_only=true | 531ms | 350ms |\n| /api/variants (variants from current sample products) | 569ms | 181ms |\n| /api/variants?page=1945 (variants from performance sample products) | 436ms | 205ms |\n. Hi @mtomov\nI agree that at first sight this seems overly complicated but the reason behind this approach is performance. The challenges/benefits explained here also apply to variant images.\nPerhaps the comment on variant_property_rule.rb should be moved to concerns/spree/variant_rule.rb to make the reasoning behind this approach clearer?\n. I agree with @jordan-brough's comment and would prefer to delay combining the two until it's necessary.\n. After thinking on this for a while, this is probably not a good addition to core. Going to do this as a customization on our store for now.\n. I'm concerned this will break the behavior this commit was trying to correct.\nI think that if we remove this we need to add a check further down the line that everything in the order can be shipped when generating shipments.\n. @cbrunsdon sure! The test would ensure that you cannot transition an order to the delivery state if any of the order's contents couldn't be shipped.\n. @jhawthorn yes this covers it, thanks!\n. @jhawthorn were you thinking something along the lines of this?\nruby\ndef ship(tracking_number: nil, shipped_at: nil)\n  attributes = { tracking_number: tracking_number, shipped_at: shipped_at }\n  attributes[:tracking_number] = self.tracking_number if self.tracking_number.present?\n  update_attributes!(attributes)\nend\nI don't really like that since it seems like an unexpected side effect. If I were to call stock_transfer.ship or stock_transfer.ship(tracking_number: nil) on a stock transfer that already has a tracking number, the tracking number wouldn't be updated to nil.\n. That, @jordan-brough, is an excellent idea. Updated with your suggestion.\n. Seems like an unnecessary test to me, wouldn't the test just ensure that the default value for the parameter is applied? Feels like we're testing Ruby at that point but let me know if you were thinking of something else.\n. @jhawthorn @jordan-brough tests added\n. I'd change the end to .attr('content') just to keep the style consistent with the other method calls in the file.\n. Would something like postMethods be a clearer variable name for this?\n. By removing the check for the #variant_autocomplete_template DOM element, does this mean the templates will be defined on every page?\n. There are also some errors that are due to the StoreCreditsController being a ResourceController in Solidus, looking into fixing those as well.\n. The advantage I see is centralizing the error handling for both actions. Since there are three operations going on here (loading the update reasons, setting the flash error message and rendering a template) I think centralizing the logic is worthwhile but happy to remove the method if more people feel the same.\n. Good point, changing.\n. That's actually how I had it originally and changed it to this, will change it back.\n. I thought an empty string would be a sensible default for a display method but nil is probably better here.\n. Having some trouble finding where this code was moved to. Was this file deleted by mistake?\n. Ah, ok makes sense now.\n. The spec that covers why it's required is in unreturned_item_charger_spec.rb. It's a though one to bring over to order_spec.rb since it's directly related to this method being called when attempting to charge for unreturned exchanges.\nI think raising might be too severe since it's not an exceptional case, perhaps wrapping the contents of create_proposed_shipments within an unless unreturned_exchange? && shipments.all?(&:shipped?) would make it a little clearer?\n. Here's an example of a generated name property for a value input:\nproduct[variant_property_rules_attributes][0][values_attributes][0][property_name]\nWith the previous code, when creating a new input, the generated name would be something like this:\nproduct[variant_property_rules_attributes][1442601174172][values_attributes][1442601174172][property_name]\nWe want all of the values to be associated with the same variant_property_rule for when we call update_attributes so this code generates product[variant_property_rules_attributes][0][values_attributes][1442601174172][property_name] instead by only replacing the last numeric value in the string.\n. It is, the value set on the view is an array of integers (I don't do a .join(',') on the values) so it's space delimited when coming back.\n. Good catch, must have created it when spiking and forgot to remove it. Just pushed up another commit removing it.\n. @gmacdougall  Sounds good, added another commit to address this and hopefully make adding more attributes in the future a little easier.\n. I agree the naming is a little confusing but looking at destination_location_ids it's just location_ids + [nil] and since we're not interested in the nil value I just used location_ids. Would a separate method, something like transfer_to_location_ids and transfer_from_location_ids be in order? I think it might be a bit much since they'll both end up calling location_ids but I do see how it could be helpful in terms of customization...\n. I agree this is a little awkward but it was the best way I could come up with to hook into the creation of store credit and ensure the state machine callbacks are still triggered when transitioning between order states. Open to suggestions of course.\n. I think it might be since it kicks you all the way back to cart.\n. I was hoping to have changes like that (as well as combining the ruleset models) in separate followup PRs. It's looking like a pretty big PR already and I think separate PRs would make it easier to review if everyone's OK with that. \n. The || is intentional, I only want to load the associated images if there are no images determined by the rules.\n. I tested searching for variants when creating an order and a stock transfer in admin with a large dataset. I didn't notice any performance issues there but let me know if there's any other scenario you or @athal7 are particularly concerned about that I'm missing.\n. @athal7 and I looked at this together and the variant image rules do have an unfortunate side-effect of introducing an N+1 since it looks up images for each rule rather than loading them all up front.\nIn my opinion the performance impact is very small. With a small set of rules the difference becomes negligible. Weighing the benefits of the new feature versus the performance impact it has I think it's worth the small performance hit.\n. Would you then call next until you're back in the confirm step?\n. The logic only applies to orders in the confirm state because any order in a state prior to confirm will have store credit applied during this transition.\n. ",
    "graygilmore": ":+1: \n. :+1: \n. Yes please. I'll likely take a hatchet to the CSS at some point and at the very least replace a bunch of lines with mixins.\n. @jordan-brough I love the idea of adding extra commits to address things; that definitely makes reviewing easier to follow. I'm not sure if it would also be helpful to add a note that they should be squashed down before the final merge. I would hate to see a commit history that looked like:\nRemove console log\nFix code style\nFix another thing\nFix the blah thing\nFix the derp thing\nAdd a new thing\n. :+1: The more of these things we can remove now, the easier cleaning up the whole admin will become.\n. I think we've addressed most of the points and there shouldn't be anything else holding us back from merging this in. I think this is a great step in the right direction in bringing some much needed new life to the admin.\n. Talked to @exsuzme about it. We're just going to slightly tweak the names of the classes and then we're good to go. For those outside of the conversation, two major things:\n1. Prefer explicit naming (column instead of col)\n2. Name spacing where appropriate. This can be super tricky but in this case we landed on names like return-item-product. We want to protect against using something like product-column where that could conceivably be used elsewhere in the admin and we don't want to accidentally modify those as well.\n. :boat: :+1: \n. @tvdeyen that's great. To be fair*, I fell off the Bootstrap/Foundation wagon so long ago that I haven't bothered checking back in. That is great news and definitely changes my perception. I will have a look at Foundation 6 and play around with it!\n* probably not fair.\n. Agree with @jhawthorn. Other than that all good.\n. @jhawthorn thanks, forgot about those. Fixed the commit.\nI had considered the incompatibility issue but considering the fact that we've nuked jstree from the project anyways it makes sense that this would need to be a customization for somebody to take on in their own project.\n. That sounds good to me.\n. That sounds good to me.\n. > Do we really, as an e-commerce framework, want to maintain a widget library? We discussed this a lot, but I have to raise this question again.\n@tvdeyen that's a great question and I'm sure we'll have to draw a line somewhere. What I don't want this project to get in the habit of doing is adding X, Y and Z dependencies that end up causing headaches down the road. It's a valuable discussion to be had, though.\n. @cbrunsdon, @tvdeyen: your feedback has been addressed!\n. @tvdeyen once again, updated! :smile: \n. @tvdeyen the discussion is good! These are all long-term decisions and should be treated as such. The Bootstrap suggestion is good but it doesn't really encompass what we're trying to do here. I have, however, found a lightweight library that may be better than us rolling our own JS. I'm going to play around with it and see if it's worth our time including it instead of the custom implementation here.\n. @tvdeyen I explored a library whose entire job was this functionality and it didn't do an important thing: don't collapse \"active\" elements.\nI'm happy with the solution I've provided here and until there is a concrete alternative available I believe we should proceed with this so we can start cleaning up some of those views.\n. .hidden does not exist in v4 of Bootstrap which is what we'd be adopting anyways. I agree with @tvdeyen that we should be avoiding inlining styles. The issue here is larger than this simple discussion, though, it's really about applying a small fix to a rather ugly larger piece of code.\nIf we're going to spend the time to fix this I'd prefer we do it right by digging into address.js.coffee.\n. You can also automatically generate the file by running:\nbash\nbundle exec rails generate solidus:auth:install\n@BenMorganIO also talks about this in a still somewhat-relatable \"Getting Started with Spree\" article: http://blog.benmorgan.io/post/89825694756/getting-started-with-spree\nRelated: https://github.com/solidusio/solidus_auth_devise/issues/33\n. I agree with @tvdeyen.\n. The small misalignment of things everywhere is a no-go to me. I'd prefer to see us importing things one component at a time. What was your thought on that?\n. :+1: \n. I think it should probably be the > * + * but hopefully this area gets a reboot anyways.\n. Good stuff. Happy to see the Tabs being used :smile: \n. :+1: \n. Would you mind removing this as well? https://github.com/solidusio/solidus/blob/master/backend/app/assets/stylesheets/spree/frontend/backend.css\n. Nice change. Probably a good candiate for tabs.\n. A double mention! :smile:\nChange looks good to me. So much better have those along the top.\n. @jhawthorn would you prefer to see the Stock Locations tab removed from Settings > Shipping? That makes the most sense to me.\n. To clarify: and move it under Stock in the main navigation.\n. I think this would be a good opportunity for us to put or \"site architect\" hats on and figure out the structure for the entirety of the admin area.\n. I don't think I like having all of these things shoved into the h1. They should be separate things. Maybe the active item could be the h1? Either way I think the implementation needs to change a bit.\n. Updated the description with screenshots and a plan for what's next.\n. @tvdeyen that's a great catch. For the most part this was just for presentation. I'm unable to add this layout to any form pages properly without also gutting the forms on that page.\n. @tvdeyen I removed the two commits relating to the variants index page. It was added more of an example of how to use the centered layout but that should be pretty clear given the other example. Would just look like:\nerb\n<% admin_layout \"full-width\" %>\n. I agree. I don't think this is the nicest change but it fixes a pretty bad visual bug. I've create an issue for discussing making this area better.\n. What's the difference between \"action required\" and \"no action required\"? I find that a little confusing. Could you provide an example of a major app using this technique?\n. Let's also make sure to use the Bootstrap classes for these, cc @jrochkind.\n. > 1) I have opted for a minimal set of CSS-styling. I find the select2-default to be quite sensible and works IMHO out of the box. So instead of making design decisions in this pull I would prefer it to be done separately.\nI believe that changing the styles from what it was before to this is a design decision. And since we're doing that we might as well make the styles match. Something as simple as just match to the inputs around it:\n\n. The preference is set here: https://github.com/solidusio/solidus/blob/master/frontend/app/models/spree/frontend_configuration.rb#L6\nCan you confirm that that file is being loaded?. @kennyadsl @tvdeyen fixed the @money and added a test that checks if Comparable is included. I went back and forth a few times on the value of adding that test.. @jhawthorn changelog entry added.. I'll have a look at this one.. Just as a heads up, currently working on allowing TieredFlatRate to be using as a line item level adjustment as a part of https://github.com/solidusio/solidus/issues/1812. Great comments. Going to look at these now.. Should we be using an ID or name? That's what https://github.com/select2/select2/issues/2750#issuecomment-59634990 suggests.\nShould allow us to clean up these selectors even more.. > There are some good suggestions here, but I think they're all outside the scope of fixing this immediate issue. Many extensions use <select class=\"select2\">, so we'll need that to continue working for the time-being. \nSounds good! \ud83d\udc4d \nIt wasn't fully clear to me why this was necessary so I pulled stuff down and tested things out. I think improving the commit message here will go a long way in clarifying things for future-us.. Yes, the markup on this page is nothing short of a nightmare. I haven't dug into this area much further, to be honest. I think it needs a completely fresh solution.. Big fan of changing empty anchors to buttons \ud83d\udc4d . :wave: @benjaminwil! Thanks for the detailed write up. I just went through the Getting Started guide and was able to set up everything okay.\nI imagine this bug was caused by the manual rollback of Rails versions. Does this happen when you start a project from scratch without the rollback?. Cool! Going to run through this now.. The stock management table in particular falls apart here. I had already been working on some changes to that table. I will coordinate with @Mandily to clean up that area.. @tvdeyen beauty! I nabbed the align-centers yesterday but I'll grab these other ones, too. Just need access to push to @Mandily's PR. I also have a commit that removes the cycle() for odd/even classes.\nThere might also be some no-border classes that can go away now, too. We'll have clean tables in no time!. I believe I've nabbed all of @tvdeyen's concerns as well as a couple of my own. This PR is rebased and I believe ready for a proper review.. Is there any other work required to get this into an acceptable state?. Forgot about the form-control class from Bootstrap.. Updated to include centering of the images. This will likely not happen on normal stores as the images we're selecting to go in this modal are larger than the modal itself but I'm happy to provide a fallback for smaller images.. @tvdeyen a separate PR makes sense to me. Unfortunately overriding the value here is really hard. I tried adding:\nscss\n[id^=\"modal-image-\"] img {\n  // Images in tables automatically have a border around them but we don't want\n  // that in our modal.\n  border: none;\n}\nBut of course it's not strong enough to override this incredible selector:\ncss\ntable tbody tr.even td img {\n  border: 1px solid #e7f0fa;\n}. > I just noticed a little issue when changing a checkbox input and trying to restore original form data\nI knew there was still something to do! The checkboxes were finicky, I'll have another look at this.\n\nThat's cool! Thanks! Didn't know about the :input selector.\n\nNeither did I! It's a jQuery specific thing.\n\nskip_before_action :authenticate_user seem a bit weird there at the top of the controller\n\nYou're right, I do not believe that should be there. Will fix.. @Mandily is this the direction you want to see us heading? I know you've referenced other implementations where the admin is able to edit multiple items in the table and then save them all at once. Before we continue down this path I think it's important to make sure we're spending time on something that we actually want!. Closing this to remove some clutter. Given the conversation above I think this area of the system needs to move in a slightly different direction.. That makes way more sense to me. Perhaps this issue should then be to remove the Spree.routes object and update the routes throughout the backend JS to use pathFor instead. Is this something that we'd first want to deprecate before removing completely?\n(I know this is likely far down the priority list). Note: currently working on this.. > A good change. I don\u2019t see a reason to keep - and even add code for- the possibility to list countries and states. What is the benefit of this?\nYou're right \u2013 if we're removing the editing of this we might as well nuke the whole thing. I'd be interested in adding that change if that's something we can agree on.\n\nFor example options specific for country that would need a custom field editable by admin into the country edit form.\n\nI think I would rather see these kinds of modifications in a separate model: YourApp::CountryModification \u2013 what do you think?. @kennyadsl excellent. I will make the changes to this PR to remove these entirely from the backend.. This has been updated with a full removal.. Updated the zones_spec.rb and added a changelog entry.. @kennyadsl added a note about the extension to the changelog entry. Tests now passing after rebasing with master \ud83c\udf89 . Makes sense to me! \ud83d\udc4d . > Maybe it's just me, but shouldn't complete be green? I assume shop owners love to see lots of green in their orders table.\nNo. Green in this case specifies something that is active. It gives the feeling of movement and that something is currently happening. A complete state is something that needs no further action and is finished, and the grey-blue color better helps signal that.\nEdit: ha! Same time as @Mandily.. Wooo tests are green. @tvdeyen I think I've addressed all of your other concerns. I went a little overly verbose with the number of commits but that should make things a little cleaner to understand in the future.. Looks like the order page is borked. Will fix.. Fixed the order page. The bug was from a few releases ago but it went unnoticed because none of the pages using the new layout also had a sidebar.. Needs https://github.com/solidusio/solidus/pull/2158 in order to effectively use Bootstrap's btn-link styling.. Here's a really simple example of how somebody would extend this in their own app:\n```rb\nconfig/initializers/spree.rb\nSpree::Backend::Config.configure do |config|\n  config.quick_switch_items << Spree::QuickSwitchItem.new(\n    [:promo],\n    :find_and_redirect_to_promotion,\n    \"promo PROMOTION_CODE\"\n  )\nend\n```\n```rb\napp/controllers/spree/admin/quick_switch_controller_decorator.rb\nSpree::Admin::QuickSwitchController.class_eval do\n  private\ndef find_and_redirect_to_promotion\n    if promotion = Spree::Promotion.with_coupon_code(searched_value)\n      redirect_to_url spree.edit_admin_promotion_path(promotion)\n    else\n      not_found(\"Could not find promotion with code #{searched_value}\")\n    end\n  end\nend\n``\nDoes this seem suitable? This is my first time getting into some arguably meta programming withmethod(quick_switch_item.method).call`.. > Or we could just use Ransack.\nI really like this simplification. This was exactly the kind of feedback I was hoping for!. Actionable comments have been addressed! Thanks for everyone's patience on this one.. > One last change request.\nChanged Spree.t to I18n.t \ud83d\udc4d . Formatting aside, @jhawthorn makes a good point here. If this is going to be a reusable thing then having it in this file makes sense. If it's specific to a particular page then these styles should live there.\n. Prefer double quotes to single quotes for attributes but more importantly prefer consistency.\n. If we're going to be putting new code in I'd love for us to be using newer syntax:\nerb\n<%= render \"spree/admin/shared/product_sub_menu\" %>\n. Since we're touching all of these files anyways I'd love for us to switch to the new hash syntax.\n. If it's inline-block and width: 100% we should just be able to one-line this with display: block.\n. If we care about Safari 8 (previous version) we'll need a mixin here.\n. Single quoted attributes :cry:\nBut more importantly: the partial is called _sidebar_left but the class name is sidebar and the children use .sidebar-left-header.\n. If there's only one main sidebar I'd prefer these to all just be sidebar-#{thing}.\n. Should these be sidebar_left_#{thing}? Seems like this is the one and only main sidebar. Until we're planning on having a right sidebar I'd like to kill the left.\n. See https://github.com/solidusio/solidus/pull/509/files#r44841465 re: \"left\"\n. @Sinetheta I like that. It gives the \"sidebar\" a purpose. :+1: \n. What does this value represent? If it's the header's height we should save that as a value: $height-header and use it here and on the header.\n. Let's just reorganize this a little bit:\nscss\n@include display(flex);\n@include align-items(center);\n@include justify-content(space-between);\nposition: fixed;\nleft: $width-sidebar;\nwidth: calc(100% - #{$width-sidebar});\npadding: 15px 14px;\nborder-bottom: 1px solid $color-border;\nbackground-color: very-light($color-3, 4);\nz-index: 1;\n. Do you know what page_title_classes is used for? Not sure if we want to keep this around. It doesn't make a lot of sense to me.\n. @jhawthorn is this a kind of class name that we need to keep around? I'd prefer to remove anything we're not actually using.\n. As we discussed IRL, move this to .main-content and change the conditional class name to .has-header. This is a lot clearer on why the padding-top is being added.\n. Instead of having an empty <h1> we can tweak how we're using Flexbox.\n``` diff\ncontent-header {\n@include display(flex);\n  @include align-items(center);\n- @include justify-content(space-between);\n}\n+.page-actions {\n+  @include flex-grow(1);\n+  text-align: right;\n+}\n``\n. If we need comments like these we know we're putting this in the wrong place. I would prefer to see these styles in a file like_forms.scss`.\nWhat these styles do need, though, is a comment explaining their purpose.\n. So close! This makes a good commit message but it's entirely what's needed here. The goal here is to explain what this code is doing so that the next person looking at this doesn't have to scratch their head for 10min. Something like:\nscss\n// Always make sure buttons are spaced out. Sometimes there are forms\n// with single buttons inside so we can't always just do `.button + .button`.\n. #nitpick can you remove this empty line?\n. I have a feeling like we might want to keep the data-hook=\"toolbar\" here. @jhawthorn what are your thoughts on maintaining that kind of thing?\n. You can express this as nth-child(even) if you want it to read a little nicer.\n. I could go for utilities. Just matched what the commented heading said so I've got no attachment either way.\n. :+1: \n. Totally. I have completely reworked this for future layouts because I ran into the same problem: https://github.com/solidusio/solidus/compare/master...graygilmore:content_layout#diff-b1a47ee5eb885f91f6fe5ff9b2be5211R13\nSince #content-without-nav is only being used for a JS hook maybe just something like class=\"js-content-below-tabs? Either way it's going to be ugly but I'd rather avoid something like content-without-nav as it implies that there is no nav on the page (if you were viewing it out of context, like in the new.js.erb file).\n. Try adding the .checkbox class to the div instead.\n. Instead of writing &#x2f; all of the time I think it would be better if we used CSS for this. Something like:\nscss\n.page-title > *:before {\n  content: \">\";\n}\n. Since these values match the defaults here https://github.com/solidusio/solidus/pull/1090/files#diff-a065997c80be8446e236252c98a12800R7 we don't need to duplicate them here.\n. I know that a bunch of this is being copied over but it would be a good opportunity to convert some of these variables into camelCase. The new stuff that you've added uses it \ud83d\udc4d so we might as well make everything in here a little nicer if we can.\n. They imply that they are overwriting default behaviour. If we want to document it both the changelog and the JS file make very good candidates for that.\n. I missed this because it was in an outdated diff. I'd lean towards agreeing with @jhawthorn here. Removing this would clean up both the JS and the markup and make the conversation below moot.\n. do/end for multi-line blocks\n. This is no longer needed since .activate() takes care of the promo code.\n. I had definitely considered adding more robust tests but I wasn't sure if that's something we wanted to do for our factories. If anyone would like to see more work added to this PR just let me know.\n. I would prefer to avoid using randomly named utility classes for this. In a perfect world we'd have form components ready to go and I wouldn't have to add these styles at all but we're not there yet.\n. You're right that I shouldn't be testing that I get value back and instead should be making sure I get the exact value that I am expecting.\n. Great, I'll improve the specs using that example.\n. This didn't appear to provide any value to me and was causing issues in the test. If somebody can tell me why this is important to have I'll figure out a way to add it back in.\n. Kind of. It's undocumented, really. This PR introduces two explicit layout options that can be passed to this.\n. You can see <%= @admin_layout.presence %> be used below on the content-wrapper. This could have ended up on the body but the layout tiself is really just for the content-wrapper.\n. Does full-width accomplish anything here? I don't think this is a style that exists.\n. scss\nborder: 1px solid very-light($color-3, 32);\n. What does this class mean? What is it used for?\n. diff\n- @include margin (null auto);\n+ @include margin(null auto);\n. Is this line necessary? What is it stopping from happening?\n. Does this element need to be positioned relatively? Does it have children that depend on this being here?\n. If we're positioning this element this finely we might as well just position it absolutely and get rid of the float altogether.\n. All markup gets left-aligned by default, do we need this?\n. Is this for any sidebar? We might want to tweak our naming here.\n. I'm guessing the purpose of this is to add the max-width to it? I wonder if we can come up with a different name as everything* is left aligned by default.\n*almost everything\n. Empty line was added here.\n. This kind of nesting of rows and columns really concerns me. I'll load this up locally and see if there's anything we can do.\n. I thought about also adding tests for <, >, .between?, and .sort as those also get included with Comparable but I didn't want to get into the habit of testing another module. Any thoughts?. Makes sense to me, I'll include that.. Will fix.. I don't think this media query is necessary. It actually requires more characters than not having it:\n```scss\n.element {\n  background: blue;\n// With mixin\n  @include media($desktop) {\n    background: green;\n  }\n// Without mixin\n  @media #{$desktop} {\n    background: green\n  }\n}\n``. @davidedistefano I don't think the added complexity of the mixin helps us here.. I noticed that @jhawthorn had switched to casecmp from theupcasecomparison so I followed suit: https://github.com/solidusio/solidus/commit/4d2b5ba513ce4269eef638f706e4a293e47b8fc7. Not completed sold on the naming of this calculator.. Would happily rename this class to something else. Additionally, only the calculator is currently under test. I intend to switch to placing this under test and just making sure that the calculator calls this with the correct arguments.. Should probably be[Float].. I'm happy to leave this for now. Would prefer to avoid tacking too many things onto this PR.. I liked having it in the calculator. I'm not sure it needs to exist in both places as it's the calculator that cares about this the most.. Aahhh I gotcha. Right nowline_item.currency` actually delegates to the order already: https://github.com/solidusio/solidus/blob/master/core/app/models/spree/line_item.rb#L41\nEdit: but being a little more explicit wouldn't be the worst thing in the world.. I'm with @Mandily on this one, not a fan of the large line-height.. Separate PR makes sense. I think we're due for another solution in that area entirely.. I think it could reduce some markup but it would drastically increase the amount of JS, no? If that's the direction we'd like to go that's fine but I think the net footprint will be much larger (since each page will require its own JS).. Having looked at this a little bit more I see some opportunity here to perhaps generalize the EditStockItemView and allow other pages to inherit from it. I will investigate this today.. Any particular reason?. \ud83d\udc4d will make changes to the translations and then downcase or somehow slugify for the class names.\nEdit: don't need to do that for classnames because, of course, we're not i18n-ing those!. I'm more curious about who the perspective is here. This is a very specific component that I have sized specifically. If users viewing the admin bump up their font size this will scale along with it.\nIf we decide to change the root font size of the admin we'll need to go through components one by one and figure out what needs to change. I'd normally be happy to use rem but our admin root font size is 13px which I can see changing in the future but I wouldn't want this component to change.. Nice! Thanks for that.. Cannot use $gray-light here since it's no longer defined until later on... this is tricky.. Now that we have a QuickSwitchItem class I wonder if that's where these methods should be defined.. Looks like these translations are not quite available when this code gets run. Does anyone know a way to get around this?. Yea, @jhawthorn pointed out that I had set this up a little wrong and should instead of storing the key. \ud83d\udc4d . The only issue that I have is that it returns a redirect. It seemed odd to me to have a GET change your location but I'll gladly change it if it makes more sense.. I did this so people could still hit this without JS (also what the controller's spec is doing). I can remove it and instead switch to a feature spec only.. If they are already in a form element we won't kick them out.. In its current state there is no case where it needs this but that can certainly come if this ever gets more complicated.. I've found this to be a common pattern in JS-land. In this case something else triggers a shortcut and then our object knows what to do onShortcut. I'd prefer to keep it to keep the pattern alive but could be persuaded.. ",
    "BenMorganIO": "@gmacdougall Maybe make a part 1, part 2, part n?\nI'll be stealing some of the concepts here for #289...\n. :+1:\n. I believe I originally added this because of a suggestion given to me by the Bullet gem. Just some historical context.\nThere is, however, probably a point in the code where we call #any?, #size, #count, or #length somewhere. Pseudocode:\n``` ruby\nvariant.stock_items.size\nor\nvariant.stock_items.any?\n```\n(#size is a rails method for AR objects. If the association is already loaded, it will call #length to get the size of the object, otherwise, if the object is not loaded, it will do a #count call to the DB (COUNT ... SQL CODE .... #size is also internally used by the #any? method.)\n. @TeatroIO is also an alternative which, honestly, is faster for implementation, but I don't think anyone ever used it on Spree. Its broken half the time.\nAre we sure a review app would really help with the workflow?\n. We should probably ask Teatro to add something when we want to skip @TeatroIO. Something like [skip-teatro] at the bottom of a PR might be nice.\nBut it is super handy and I'm enjoying it with Whole New Home.\n. Dibs. (On cracking the order state machine code.)\n. @hhff does have a gem that covers the frontend nicely. Its a great starting place IMHO.\nThere's also lots of discussion about this for Spree RFC #001: https://github.com/spree-contrib/rfcs/pull/1.\n. @jarednorman We can add a Solidus::BaseSerializer to \"cement\" our configuration. That way when someone changes something globally, it won't hurt the serializers.\nOR\nAlso, we could just use the a certain json format via the content type? This way we can explicitly say to the request: hand us this format, and not the main applications: Content-Type: application/prs.solidus+json. See RFC 6838 Section 3.3\nOR...\nThere's also another option where we can make a Solidus::JsonAdapter that can \"cement\" some of the configuration.\nI feel like this cat has many ways of being skinned. Treading carefully on the configuration portion is probably important.\nIf anyone has any thoughts on this, I can start experimenting with different methods on the https://github.com/wildcardlabs/solidus_json_api and see what turns up.\n. :+1:\n. :+1:\n. :+1:\n. :+1:\n. I'm going to :+1: for removing the environment column. My concept is this:\nruby\n(rm db/structure.sql || rm db/schema.rb); spring rake db:drop db:create db:migrate\nAnd if that all passes after a Spree 3 --> Solidus transition, we've got a good flow going. My main concern right now is finding silent issues such as creating tables that are Spree 3 specific and don't exist in Solidus. I think I might make a rake task to run a check through my DB schema vs. a new Solidus project and compare and contrast. (This paragraph is probably outside of this PRs scope. Look, squirrel!)\nAnywho, I think I can just kill the if statement and kill the :environment key. This would, in essence, allow a transition to happen even more seamlessly.\n. Yep, realized that some users were going to get left behind this morning. I think we should just opt for chopping the Reason off.\nI am going to mention thought that in migrating from Spree to Solidus that a lot of the migrations have been changed. I think I am documenting all my changes personally. I think a simple how to guide would be nice for somewhere in the documentation.\n. See #404 \n. @magnusvk I believe in spree/spree#5770 I wanted to drop the Spree::Tacker model.\nNew question: Do we want to allow multiple trackers?\n. @gmacdougall When we allow multiple trackers, we are assuming that trackers are for GA. What if you want a tracker for GA, HubSpot, and Mixpanel?\nslim\n- @trackers.each do |tracker|\n  = render 'google_analytics' if tracker.analytics_id.starts_with?('U')\n  = render 'hub_spot' if tracker.analytics_id =~ /^\\d$/\n  = render 'mix_panel' if tracker.analytics_id =~ /mixpanels_number/\nI would be willing to take the time and do something like this:\nslim\njavascript:\n  - @trackers.each do |tracker|\n    = j tracker.script\nI would add a column called either name or type and another column called script or source or code and use that. Then add a deprecation warning for when they use analytics_id and remove the column in 1.1.\n. KK.\nFrom this discussion, I think this PR is ready and awaiting more review.\nNext steps for Spree::Tracker are to upgrade it from an id submission to using code. Things like tracking user_id for GA and enhancing it for analytics may be things to discuss, but I'll bring those back up when I submit a future PR.\n. @magnusvk oh man, forgot about those. I'll fix them when I get into the office today.\n. Please see #443.\n. Working on this right now. Will make a PR with documentation changes as per my experience.\n. Working on this right now. Will make a PR with documentation changes as per my experience.\n. @jhawthorn Its awesome that we've merged #265. Just concerned about the UI functionality right now expecting an environment.\n. Sent some images over Slack.\n. Does anyone know how hard it would be to let the Spree Backend take advantage of say elasticsearch instead of rabl? Since ES already indexes all the data, I'm crossing my fingers and hoping it might be a faster solution.\n. Of course, we'd have to give a user a choice between ransack and es.\n. @gmacdougall I know. I might be interested in helping build it out.\n. @jordan-brough can you expand? I'm wondering how this compares to PG and SQLite.\n. :+1:\n. :+1:\n. yessssssss :+1: thanks @jordan-brough !!!\n. I think this is the only PR left for making Spree 3 -> Solidus 1 a lot smoother.\n. Awesome. Can't wait to see this in master!\n. Out of curiosity, when did credit cards get addresses?\n. @gmacdougall kk\n. This could be from JS. Maybe sleep 0.5 might solve it....\n. > broken, dangerous, not threadsafe\nkill it :+1:\n. :+1:\n. :+1:\nWhat I did was I just made that existing remove payment method environment column migration empty.\n. very :+1:\n. :+1: here too.\n. Very :+1:. I remember doing this in Spree and happy to see it Solidus!!!\n. :+1:\n. @magnusvk I was thinking of moving the splitting up the add columns and rename tables into two separate PRs. I could use the \"I don't think there's any errors\" argument to state that the one migration is good enough, but the fact that that excuse can be used tells me that the migrations should probably be split out. Why? In case of error...\nI'll split the migrations out per HABTM removal and one more for any remaining rename_tables.\n. I think this ready for another round of code review :)\n. @magnusvk Yeah, the cherry-picking will be very, picky... I could separate this into several PRs?\n. KK, I'll cherry-pick some of the commits out.\n. Tag #317, #318 \n. I'm going to be :-1: on Whisper mainly because its going to be an added dependency as well as one more ruby library to learn. I also have no understanding of the subscribe/publish model.\n. :+1:\n. lol :+1:\n. lol :+1:\n. I'd rather move the HTML emails to something like Blot this way a lot of the email templating is just automagically created and there's not tons of HTML tables to look at.\n. There's no dependent destroy added here. Also, what do you guys think of back tracking and adding foreign keys in this PR?\n. Left a similar comment in #317.\nNo dependent destroy was added. Backtrack and add referential integrity as well?\n. One thing I'd love to start work on with Solidus is a second version of the API. I think we should move all API requests to a v1 namespace and maybe start building out a second API and deprecate this existing one and move it to its own gem.\nI have experimented with a Spree::Api::V2::ResourcesController and it did feel like a pretty good controller to have around. Debugging can be kinda weird though.\nI would personally try and put effort into building a V2, rather than refactoring the V1, but I'm :+1: for this PR.\n. @athal7 I totally agree with you on the ResourcesController being hard to read. Having built one on my own privately, it can be super awkward. Steps to ensure the meta-programming is easy to read and/or follow should be a high priority; especially for debugging.\n. :+1: for this\n. lol :+1:\n. Guess someone made a booboo while they were building Spree::Gateway. :+1:\n. @gmacdougall some of the DB changes are already in master. I agree on adding it to the Changelog. I'm thinking that I'll do one bullet point notifying the db updates for HTM instead of HABTM and then sub bullet points for all the details.\n. @jordan-brough yeah I know. The pro here is that you get to kill the 0.2ms of time spent in a callback with rails searching for the values. Instead, PG just does it for you. So, if you have ~1000 associations, deletion is going to be a lot faster.\nMy main worry is the AR callbacks. Those nice hookable points that tend to get abused. After some reading, I don't believe they get called when you do taxon.destroy!. Why? Well...\nLets say you have a Taxon associated to 10 prototypes. If you perform taxon.destroy! then the AR hooks will run since a ruby object is loaded. Since there's referential integrity, the 10 PrototypeTaxon rows will be deleted. Since you don't load up the 10 ProtyotypeTaxon objects, then no AR callback is going to happen.\nWait, what if a taxon has 1000 prototypes? Uh oh... That on_delete: :cascade is looking mighty nice. But, if you have an after_destroy: :some_cleanup_method then it wont' get called.\nI think they're fairly safe TBH. I don't recommend using AR callbacks unless you have a good reason to. They tend to cause bugs down the road.\nWhat I'm also concerned about is counter caches, but there's none here, so I'm not going to fret too much about it.\n. ## Thoughts\n@jordan-brough I think that's a good compromise. I do feel AR is handling a tiny bit too much now that there's referential integrity. I'm :+1: on making sure on not just documenting the cascades, but the referential integrity, when it exists, and under what conditions.\nWe can probably sit back and wait for the community to give us their thoughts. Since there's referential integrity in rails now, I'm curious as to how the community is going to move towards it and respond to it. We've already hit an odd spot.\nI feel like we're tip toeing around the API design of AR. Maybe we should ask an AR contributor their thoughts? Mainly because AR + RI might not be mixing so well. (Or maybe it is mixing and we're missing something or it is \"mixable\" and Rails is missing something.)\nWe're all trying really hard to find that \"sweet spot\". I think we're getting there, but I feel like AR still needs to evolve more to help with that.\nMoving forward:\n- Document what we're doing with referential integrity so no one is caught off guard.\n- Use referential integrity in new join tables or HABTM models gone HMT.\n- Wait on community feedback?\nExample App\nThere's two things I'm worried about:\n1. before_destroy/after_destroy callbacks; and\n2. counter_cache\nI feel like some devs will want to implement one of these two in the future. Since no dev has made a PR to Solidus to move the HABTM => HMT then its safe to say ensuring callbacks is probably not that important. If it was, where are the PRs to extend the models? I added the PRs mainly for apartment support.\nNow, there's two SQL calls that will happen in the traditional rails sense. Lets assume there's 10 Authors for a post. Here's the example app: post_author_app\nruby\nPost.first.destroy!\nsql\n  Post Load (0.2ms)  SELECT  \"posts\".* FROM \"posts\"  ORDER BY \"posts\".\"id\" ASC LIMIT 1\n   (0.1ms)  begin transaction\n  AuthorPost Load (0.2ms)  SELECT \"author_posts\".* FROM \"author_posts\" WHERE \"author_posts\".\"post_id\" = ?  [[\"post_id\", 1]]\n  SQL (0.9ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = ?  [[\"id\", 1]]\n  SQL (0.0ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = ?  [[\"id\", 2]]\n  SQL (0.0ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = ?  [[\"id\", 3]]\n  SQL (0.0ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = ?  [[\"id\", 4]]\n  SQL (0.0ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = ?  [[\"id\", 5]]\n  SQL (0.0ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = ?  [[\"id\", 6]]\n  SQL (0.0ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = ?  [[\"id\", 7]]\n  SQL (0.0ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = ?  [[\"id\", 8]]\n  SQL (0.0ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = ?  [[\"id\", 9]]\n  SQL (0.0ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = ?  [[\"id\", 10]]\n  SQL (0.1ms)  DELETE FROM \"posts\" WHERE \"posts\".\"id\" = ?  [[\"id\", 1]]\n   (0.6ms)  commit transaction\nAfter adding referential integrity and removing the dependent destroy:\nruby\n2.2.3 :007 > AuthorPost.count\n   (0.4ms)  SELECT COUNT(*) FROM \"author_posts\"\n => 10\n2.2.3 :009 > Post.first.destroy!\n  Post Load (0.4ms)  SELECT  \"posts\".* FROM \"posts\"  ORDER BY \"posts\".\"id\" ASC LIMIT 1\n   (0.1ms)  BEGIN\n  SQL (0.4ms)  DELETE FROM \"posts\" WHERE \"posts\".\"id\" = $1  [[\"id\", 2]]\n   (1.2ms)  COMMIT\n => #<Post id: 2, created_at: \"2015-10-19 23:28:47\", updated_at: \"2015-10-19 23:28:47\">\n2.2.3 :010 > AuthorPost.count\n   (0.4ms)  SELECT COUNT(*) FROM \"author_posts\"\n => 0\nNow, with referential integrity AND dependent destroy:\nruby\n2.2.3 :003 > AuthorPost.count\n   (0.4ms)  SELECT COUNT(*) FROM \"author_posts\"\n => 10\n2.2.3 :004 > Post.first.destroy!\n  Post Load (0.5ms)  SELECT  \"posts\".* FROM \"posts\"  ORDER BY \"posts\".\"id\" ASC LIMIT 1\n   (0.1ms)  BEGIN\n  AuthorPost Load (0.2ms)  SELECT \"author_posts\".* FROM \"author_posts\" WHERE \"author_posts\".\"post_id\" = $1  [[\"post_id\", 4]]\n  SQL (0.2ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = $1  [[\"id\", 31]]\n  SQL (0.2ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = $1  [[\"id\", 32]]\n  SQL (0.1ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = $1  [[\"id\", 33]]\n  SQL (0.1ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = $1  [[\"id\", 34]]\n  SQL (0.1ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = $1  [[\"id\", 35]]\n  SQL (0.1ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = $1  [[\"id\", 36]]\n  SQL (0.1ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = $1  [[\"id\", 37]]\n  SQL (0.1ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = $1  [[\"id\", 38]]\n  SQL (0.1ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = $1  [[\"id\", 39]]\n  SQL (0.1ms)  DELETE FROM \"author_posts\" WHERE \"author_posts\".\"id\" = $1  [[\"id\", 40]]\n  SQL (0.2ms)  DELETE FROM \"posts\" WHERE \"posts\".\"id\" = $1  [[\"id\", 4]]\n   (1.1ms)  COMMIT\n => #<Post id: 4, created_at: \"2015-10-19 23:31:18\", updated_at: \"2015-10-19 23:31:18\">\n2.2.3 :005 > AuthorPost.count\n   (0.5ms)  SELECT COUNT(*) FROM \"author_posts\"\n => 0\nThis all looks great. All the ruby objects were loaded up :D. This is really good news. This means that AR callbacks get called and counter caches are updated :).\nAnd what about #delete?\nruby\n2.2.3 :006 > post = Post.create! authors: Author.all\n => #<Post id: 7, created_at: \"2015-10-19 23:34:37\", updated_at: \"2015-10-19 23:34:37\">\n2.2.3 :014 > AuthorPost.count\n   (0.4ms)  SELECT COUNT(*) FROM \"author_posts\"\n => 10\n2.2.3 :015 > post.delete\n  SQL (1.5ms)  DELETE FROM \"posts\" WHERE \"posts\".\"id\" = $1  [[\"id\", 7]]\n => #<Post id: 7, created_at: \"2015-10-19 23:34:37\", updated_at: \"2015-10-19 23:34:37\">\n2.2.3 :016 > AuthorPost.count\n   (0.4ms)  SELECT COUNT(*) FROM \"author_posts\"\n => 0\nIt looks like the delete call also helps enforce the referential integrity and removes the data appropriately :).\nHowever, in SQLite, foreign keys and referential integrity is a no-op (see foreigner docs which the rails feature is based on) so adding dependent: :destroy is still needed.\nConclusion\nSince referential integrity doesn't work in SQLite, then we need to add dependent: :destroy. If you're using PG or MySQL, then you'll be happy to know that the callbacks will still be supported (phew) and when you do a #delete the data is still removed.\nQuestion\nHow does this conclusion compare against the bullet points for Thoughts at the beginning of the post?\n. @jordan-brough My conclusion is to add foreign keys with cascading deletes and add the dependent destroys. Everything is retained and foreign key support is added.\n. @magnusvk I think this will be the last time I separate things out...\n. lol :+1:\n. :+1:\n. :+1:\n. Slightly concerned mainly because I might have used #map_nested_attributes_keys out of pure frustration in the past... (But, anywho, that's my problem, not Solidus's)\nI'm :+1:\n. :+1:\n. @cbrunsdon I'm :+1: and using Backbone.\n. I'm :-1: on React, mainly because I've had such a bad Angular experience and React just feels like a de ja vu... If I hadn't had such a bad Angular experience, I might be more neutral to the decision and be willing to try React out, but there's just so many things similar between the two frameworks that I'm unwilling to give React a shot.\n- Angular: Lets change best practice.\n- React: Lets change best practice.\n- Angular: Made by Google.\n- React: Made by Facebook.\nI just don't feel like I should pick a framework (no matter how fab it is) if they want to change how to do best practice. With backbone and ember, they aren't changing best practice; they're leading by example.  Angular and React just seem to want to pull you into their own world. Thing is, its usually a world I never feel comfortable fitting into.\nBackbone has Jeremy Ashkenas (maintainer of Underscore.js, Coffeescript, and Docco.js) and Ember has Yehuda Katz (Rails, Bundler, Thor, Handlebars). Angular has Google. React has Facebook. I want to opt for the people, not for the company.\nAll in all, I'm not convinced Angular or React are the way to go. Hope this description helps communicate my feelings about the JS frameworks.\n. @hhff lol\n. @athal7 I'm more gun shy of React. It felt like a dejavu from when I did AngularJS. Some issues that I had with Angular was that there was no convention. This made it too easy for one developer to have their own style even down to where they store files vs another dev. I've one project with ~100 Angular files and some of them 900 lines long. This was a \"rockstar\" Angular dev. Test suite: 8 tests, 8 failures. I was fairly unwilling to touch the Angular code or volunteer for it. I also spent a significant time learning and doing Angular. I never felt like I was making progress. I just wasn't wrapping my head around it. Even after a year of usage.\nThis seems to be the type of projects I end up on when its Angular. The convention is the big thing to me. This means anyone who's getting started with JS is enforced to use convention and best practices. Ember also comes with a linter and OMG I :heart: it so so much. Having worked on big projects where bikeshedding on code style can get slightly out of hand, I love how linters can help minimize it.\nI haven't been in the Ember world for too long TBH. I'm not an active user, but it 15 minutes I'm able to do 3 days worth in Angular.\n. :+1:\n@Dkendal agreed.\n. :+1:\n. I'm :-1: on a 303. The only reason I could see someone wanting to use it is if you had to do some redirect from one app to another app. We want things to be fast and adding another HTTP request to things doesn't do that.\n. :mine doesn't seem restful. We could nest the address information in and make a model to manage the address book contents?\n. Very :+1: for this. I know my employer will enjoy this feature.\n. Oh well, but :+1: anyways.\n. This feels kinda hacky. I would move the params over from a :country_iso to a country: :iso. This way the dev knows that there's no country_iso column, but the iso is on the spree_countries table.\n. @jordan-brough hmmmm.... you're right.. Looking at the files and realizing there's been no changes to the controller, so I think I'm :+1:.\n. Actually, we could rename it to country_id_by_iso, but now I'm just jumping into a rabbit hole on this one.\n. @jhawthorn killing the Spree::Country and Spree::State is most likely a good idea in favour of Carmen.\n. Appreciate the detailed explanation! Very appreciated.\n. I would opt to remove it if you're coming from Spree 3. If you're coming from Spree 2.2 => Solidus 1.1, then maybe rename it. There's tons of things we could do to help with this.\n. Please see https://github.com/spree/spree/pull/6746 on how I discovered that this was a bad idea. Although, we should probably add the opposite has_many :orders in.\n. :+1:\n. @alepore love the RFC :D\n. @jhawthorn I kinda like the idea TBH. This way you can fix bugs as you're building your own seed. I do think its a nice idea.\n. I'm :-1: on this. I think it would be better if we had a superadmin role and an admin role. At some point, store owners will be a little upset they cannot make these changes.. @seand7565 I think credit card number vs. password is a whole different level of security; the former potentially leading to some business owners to court. There really is no security issue with giving a business owner access to changing passwords. They can do this with GSuite to manage employees, they can do it to their users on AWS, why not on their own platform?\nThe decision to remove this from a business owner who already owns the data seems a bit redundant and frustrating.\nThe real security issue is the ability for the password to be poor or if the session is left open. Not much ado with poor passwords as that's up to the users na\u00efvity. Simply ask for the current user's password and then you've covered security threats and kept business owners not left cursing.. I'm not educated on the requirements of GDPR (ignorant Canadian) but yes, I agree with the password ownership problem with an admin setting it.\nSince an employee account, such asbob@ecommerce.store, is owned by Ecommerce Store, Inc. then this doesn't fall under GDPR and the password ownership is owned by the business entity.\nI agree with this proposal :+1:. If a superadmin can change and takeover an employees account (or most likely an ex-employees account).. Closing #232 for this :D\n. @jhawthorn\nRe: soft destroys.\nI'm kinda on the fence here. Not sure if I should sway to keep the old associations or make them paranoid as well or just them disappear.\nRe: failing spec.\nI believe that's referential integrity doing its work :D. Kinda getting a bit giggly reading that failure.\n. yesss :+1:\n. lol I just saw a chance to use #each_with_object and I was like: why not just remove two lines.\n@jordan-brough good thought.\n. @athal7 I'm actually :-1: on using resources controllers. Over time, I feel like they just do too much. A lot of things end up getting hidden on you and that can make debugging a pain. Having a render_collection and a render_instance has been helpful for me.\n. :+1: on another fk! Not too much else I can comment on...\n. I'm very :-1: on each commit having to pass CI. A commit tells a story, a change in the code. Squishing commits just to get no red x's has always been quite silly to me.\n- Why do you want to ruin the story?\n- Why make the code review harder?\n- What if the failures you see in a PR tell a story?\n- Why remove that just so there's no red x's?\nCommits are messages and they can have descriptions. To squish them is to lose documentation.\nI usually keep my commits very small. I want to have my commits telling a story of my work. Describing my path through code. And when a failure happens, you have a small code change you can view and understand. If you want a commit that summarizes all of the work, why not just use the merge commit? Isn't the purpose of the merge commit to tell the conclusive end to that story?\n. My 2 cents: Switch to Travis since it provides a matrix. I've always seen Travis as the go to open source solution and CircleCI as the private solution...\n. @jhawthorn :+1:\n. @gmacdougall :+1:\n. I'm :+1: for using .call instead of .new(args...).some_method. This way you can pass a proc/lambda or a service object or even a Method#method :D.\n. :+1:\n. I would add a deprecation warning first and then remove in the next version. This way there's no surprises to anyone using that method in their own apps.\n. Maybe add:\nruby\nif Solidus::VERSION.starts_with?('1.1')\n  raise SomeDeprecationError\nelse\n  ActiveSupport::Deprecation.warn('...')\nend\nI've been thinking of adding something along those lines to my OSS. This way I remember to actually remove the deprecated methods when I do version bumps :p\nThinking out loud - maybe we can setup another PR and add a Solidus::Deprecation class. This way you can do something like:\nruby\nSolidus::Deprecation.warn 'message', '1.1'\n. Here's the spec failure that I encountered: https://circleci.com/gh/wildcardlabs/solidus_json_api/58\nThe hack/fix I ended up with: https://github.com/wildcardlabs/solidus_json_api/commit/e3b467e295a976baab964c19de6183a8caf1f5c2\n. Don't forget those foreign keys :)\n@cbrunsdon thank you for taking over :+1: \n. @cbrunsdon :+1: then.\n. :+1:\n. :+1:\n. @amicheals Not by default, no, however what you could do is setup the model for a variant as having an ebook attachment. Then, when they checkout, you can flag at the line item level if its print, ebook, or both. Once you have the line item flagged, you can proceed with the rest of the business logic; from figuring out if you need to do any shipping, to whether or not to provide a link to download the ebook.\n. :+1:\n. :+1:\n. Ah, that was me :p\nWe could update the existing migrations so that they have if statements in them. This way they run, but nothing is added. OR we could update Spree 3.1 and make it easier for Spree to migrate over.\n. :+1:\n. :+1: that's a great improvement\n. :+1:\n. For the gems that are going to reference Spree I would just do this somewhere:\nruby\nSpree = Solidus\n. I'm :+1: on namespacing. It adds clarity and the pros of namespacing to the code.\n. What should we put for INSERT EMAIL ADDRESS?\n. @gmacdougall, @cbrunsdon, and @Dkendal \n1. I don't see how wanting a \"harassment-free experience for everyone, regardless of level of experience, gender, gender identity and expression, sexual orientation, disability, personal appearance, body size, race, ethnicity, age, religion, or nationality\" is a political statement. Its more of an invitation to contribute to our project and not fear to be subjected to any not-so-pleasant comments. Its a statement that we're a project that is :+1: for not only diversity, but in experiencing a positive and welcoming experience.\n2. I think this a problem that occurs once in a while. As @CoralineAda has noted, there's @meh and @elia who are already creating problems in this PR. There's also the Slack channel where one or two users have already been booted for their comments. So, yes, I think this is needed. Instead of booting users, we can remove or hide their comments and forward them to the Code of Conduct. In essence: here's the rules, please behave. If you still don't decide to behave appropriately, we can remove all your comments and ban you. We want people to be a part of our community and we should work towards that.\n3. I'm going to agree with @CoralineAda on what is and isn't against the terms of service and whether or not harassing comments are or are not illegal.\n\n@CoralineAda I'm not a maintainer nor apart of the Solidus core team, just a Solidus evangelist. If I was I would lock this PR to owners or, if it was possible, just ban @meh and @elia. I would also delete their comments as well. I think we'll need to wait on the core team to do that for us.\nHowever, with my statements up top, I would keep @meh's and @elia's comments in just to prove why a Code of Conduct is helpful.\n\nBottom Line: Do we need a Code of Conduct? Yes.\n. I'm going to agree with @krainboltgreene. A set of professional standards are set by rubygems and Bundler in OSS. If you create a new gem today, you'll get a Code of Conduct in your list of newly created files.\nThat's what really drove me to add this. Bundler adds one for you now. Spree has one. Solidus doesn't. I saw a tweet from @CoralineAda on the projects that were now using the Contributor Covenant. It reminded me how Solidus' OSS community can improve with staying up to date with what the ruby community was doing.\nI think the ruby community takes a lot of value in being inviting and open. There's several projects before the days of the contributor covenant that had some form of a code of conduct such as Bundler. I think the Contributor Covenant was a step forward in building the community.\n\nUpdate: Yep, its still up: http://bundler.io/conduct.html\n. @wstucco\nI would recommend reading the Thanks portion of the Bundler Conduct file. They built their's from JSConf's and Fedora's. The Contributor Covenant is merely supplying a standardized text file.\n\nThanks to the JSConf Code of Conduct and Fedora Code of Conduct for inspiration and ideas.  Additional thanks to Contributor Covenant for the default code of conduct included in generated gems.\n\nHow would you feel if you had to hand write all your MIT License files? A lot of projects are adopting them. Its that instead of hand writing all of them, you have a simple file to work off of.\n. Hey everyone,\nI don't think this was meant to be a discussion for the internet at large and we'll talk about it as a community. Closing until future notice.\n. Hey, if you can provide steps to reproduce the issue, that would help move things along faster :)\n. :+1:\n. Agreed :+1:\n. Just my 2 cents. A friend and I once took the time to try to build a payments gem called Ryal. Largely an experiment. We wrote the state machine for it three times and constantly consulted an accountant for iterating over how a payment process should ideally work.\nThis was the first try with AASM: https://github.com/spurryal/spur/pull/5\nSecond attempt with Statesman: https://github.com/spurryal/spur/pull/9\nThird and final attempt with AASM and ideas pulled from Statesman: https://github.com/spurryal/spur/pull/10\nBasic AASM was used in the beginning, but we tried out statesman. We ended up feeling that it had a lot of \"bonus\" features, wasn't as \"essentially\" featureful as AASM, so we stuck to AASM. All the bonus features inside of Statesmen we implemented ourselves, such as the caching of the transitions.\nYou can view the readme and what we ended up finalizing on as a product here: https://github.com/spurryal/spur/tree/master/ryal#payment-state-machine\nWhat was really cool was that we added what we called a \"machinist\". This was a module where we placed state machine specific classes and then called back to them via a #machinist method. You can see the state machine we build here and how we accessed it here.\nAll in all:\nWhen it came to the state machine, we did end up building what we wanted, but if we could refactor it, we'd keep our current tests (as we quite liked the end result behavior wise) and ever so slowly start removing AASM and write our own ruby methods. Our main goal was to have a trustworthy state machine however to get that, it required a lot of heading back to the drawing board.\nWhat I'd do with state machines with Solidus:\n\nI would pull the current state machines all into their own \"machinest\" models.\nEnsure they all behave similarly. Check all their behavior from their usage of ! methods down to if they cache the transitions. If they don't, then this will most likely be the second stage of behavioral changes.\nSince all the behavior has been outlined and they're all in one place, I'd leave AASM as a dependency and move some of the methods out into their own ruby code, leaving AASM with less code it owns.\nIf we can, consult industry professionals and revise what some state machines should look like. Although this will lead to some major business logic changes, it would most likely be welcomed by some power users and help align with prospective business users. We loved it that we could go back and forth with an accountant. The state machine we build looks fairly straightforward, but that's only because we spent the time to make it simple and efficient. Simplicity was hard work.\nThe big removal AASM and providing an upgrade path for those who are dependent on extending the current Solidus state machine with AASM.\n\nHope this helps in considering the refactor of some state machines :). Personally, I think there should be both. If we go for the password reset, an admin won't be able to manually change another users password.\nOften, when onboarding, an admin will add an employee via the admin, give them a role, and then set their password to something and ask the new employee to update their password for security. If we do both, we allow an admin to be able to create a new user and set their password and then send a reset password email. Both cases are beneficial and I see a use for both of them.\nIf you're an admin or the head honcho, you have the OSS and you're running it with your own database. Nothing is actually stopping an admin from going into the console and setting another users password. The least that we could do is make it easier for them via having a web interface for it. The only security issue here is if they have a poor password or left their session open.\nTherefore, we could just ask the current user to provider their password as confirmation and also allow them to send out reset password emails. We should probably also wrap this in a can?.\n. I think it's completely fine to run the lint at the beginning of the suite. We could also have a rake task that simply lints all of the factories. I'm not sure if Factory Girl comes with this or not however, it wouldn't be too hard to build and add to CircleCI.\nBut, there really isn't much of a problem if we run it apart of the suite. I can only see it becoming a true pragmatic problem if the suite takes a noticeably long time to run.. I like this. For business owners, address verification is done when generating the shipping label and checking fraud.\nFor me, I can verify the address of orders through EasyPosts address Verification API and Stripes Radar. This covers malicious users. For non-malicious users, or rather, the ones making honest mistakes, we can detect them through services such as Google Maps.\nI'm :+1: on removing this and perhaps adding fraud checking and verification to the guides for new business owners. They will find much more value out of this.. @cbrunsdon oh man, looking at that, I feel like Solidus Core should be ActiveSolidus and Solidus Rails should be ActionSolidus XD. Not really, but I'll leave a comment on that this change is totally possible within @cbrunsdon's branch.. @tvdeyen @jhawthorn After the closing of https://github.com/solidusio/solidus/pull/2236#issuecomment-334582147 I think this can be reopened and rebased.\nThese changes will help remove actioncable and the rails meta gem.. @cbrunsdon nope... Wait, isn't that from railties?\nRails only includes the README.md.\nhttps://github.com/rails/rails/blob/master/rails.gemspec#L21\nAnd for the Rails.cache method:\nhttps://github.com/rails/rails/blob/master/railties/lib/rails.rb#L38. Are we able to place state machine specific methods in their own class? I feel like that would make managing the model so much easier.. I think you should also add a validation in the model as well. If the order is a guest order, then it should require the customer email.. Ah, I see. :+1: good sir.. On another note, we could use this as a chance to help migrate translations over to the Solidus namespace instead of the Spree namespace. Or rather, since many projects use Spree.t, we could add a Solidus.t and have Spree.t point to it. This solves a namespace problemo. Then finally in another version notify that we're deprecating Spree.t and Solidus.t in preference for t('solidus.').\nI hope this little blurb on Solidus-ifying the project helps :). OK, that works. If I see some more interest from Members I'll do a PR up to deprecate Spree.t. Get back to contributing to Solidus in a long while.. Cool, good job @jtapia. Also, for record keeping, fixes #2789.. This looks like a really good idea, should we do this for the rest of the mailers?. I'm :-1: on this as well. Because if a store isn't able to reach 2.3, we could leave them out as Solidus goes forward.. @ericsaupe Also, 2.3 minimum would go against Solidus principles, which is to make upgrades easier for users. If we remove a version of ruby, we need a practical reason for it. Mainly, I think, it's when that version of ruby stops working with the minimal version of Rails we're permitting. So, if Rails 5.2 supports 2.2, which I think it does, we should keep it.. If we add a migration that converts all of the primary keys to bigint, we could also probably add an option to make it uuid since it will all be abstracted out enough. If not, bigint is an improvement to be at least Rails standard.. Wasn't saying we should use one or the other, just that if we abstract it out for bigint, we could give the option for UUID.\n\nIf we add a migration that converts all of the primary keys to bigint, we could also probably add an option to make it uuid since it will all be abstracted out enough. If not, bigint is an improvement to be at least Rails standard.\n\nI've never heard of this \"sort index\" and have never run into a problem relevant to sorting with UUIDs.  Can you elaborate why you'd need an index on created_at with UUIDs?. @tvdeyen I think it's because it's cool \ud83d\ude0e:p. @salbertson Are you able to rebase this from master? Seems like the CI is having problems.. Are we able to kill using FactoryBot explicitly in specs? Using the monkey patched version of create and build are far more succinct, use less code, and uses FactoryBot as it was originally meant to be used.. @kennyadsl the community is providing a valid change to help with backward compatibility. Solidus team members are committed to security patches for older versions. If a community member provides a fix, especially one that may be holding them back, I don't see why the Solidus team cannot merge it if the work has already been paid for.. @fastjames are you trying to use factory bot in your current project?. If so, you may be able to cheat with this initializer:\n```ruby\nconfig/initializers/factory_bot.rb\nFactoryBot = FactoryGirl\n```\nAnd then as you bump Solidus or try and add factory bot with factory girl (if that's possible :/) it should make the journey somewhat easier on you.. @fastjames yeah, I've ran into that issue before.. I'm :+1: on moving away from JBuilder.. TBH if we change up the API a bit more, we could just use to_json/as_json and remove the need for a JSON serialization dependency. It would be hard work, but probably worth it on a few endpoints. Like, the main problem we keep having is: we want to to use a thing that makes the API look nice. We could try getting rid of that altogether.. Refactored this. This is not the same as the original commit by @cbrunsdon.\n. This was not in the original work either. Since a column was being removed, I updated the colgroup respectively.\n. lol good catch!\n. Maybe use validates_associated\n. I remember adding this in the beginning because I didn't want to make too many specs break all at once as well as thinking about deprecations.\nNow that you have it switched over, the next step is to probably remove the new .table_name and set it back to Rails convention.\n.table_name is usually used for legacy data, except in this situation, we have control to rename it.\n. What's a Spree::UserClassHandle?\n. When would Spree.user_class be nil or false?\n. I'm not sure if I'm :+1: on this or :-1: on this.\nAfter some thought I think we should add these now for \"join\" tables and if developers prefer to not \"clutter\" their join tables with timestamps and/or primary keys, then they can remove it themselves.\n. I think it is.\n. I'm :+1: for 1.9 syntax\n. This needs to be changed here. Made a mistake with sorting my ABCs.\n. I would prefer to move this to the model as a scope later on or in this PR to help refactor this code.\nAlso, this line right here was originally:\nsql\nDISTINCT (spree_products.id)\nArel now generates:\nsql\nDISTINCT ON (spree_products.id)\nIt may partially be because I'm using Arel::Nodes::DistinctOn instead of Arel::Nodes::Distinct. However, I couldn't find a way for Distinct to be able to accept a table and a column, but DistinctOn did.\n@gmacdougall WDYT?\n. @gmacdougall For instances such as this, what are your thoughts?\n. If anyone happens to know how to update this, it would be appreciated. :)\n. Arel does have a node called Distinct but I don't think it does anything with the SQL TBH. If anyone can refactor this, that'd be great.\nAlso, does anyone know why we need to select products by distinct ids? When would there be duplicates?\n. Does anyone know how to get this to be arel friendly? I tried the Spree::Classification.are_table[:taxon_id], however I didn't realize how some of Arels internals would hiccup when #to_sym was called onto it; the usage of #to_sym is probably so that Rails can lower the amount of string allocations and know the key type.\nAnywho, for those who want a deeper understanding of the problem, here it is:\nWhen you call Foo.arel_table[:bar] you have called into the Arel::Table and then Arel hands you back this lovely Arel::Attributes::Attributes (also aliased to Arel::Attribute). This is all nice and pretty and you go \"I have an Arel object back, yippie, now lets get the SQL!\" and you end up doing Foo.arel_table[:bar].to_sql and you get UndefinedMethodError. Wat?\nBut wait, if we stop for a second and start doing some work with the code:\n``` ruby\nFoo.arel_table[:bar].lower.to_sql\n=> \"LOWER(\\\"foo\\\".\\\"bar\\\"\")\n```\nOK, so somehow there is a reference to the table. Its there. It exists. All we did was call #lower and then it just wrapped it. It turns out that you actually need to setup the code so that there's a reference to a node. Why? Cause that's where #to_sql is defined.\nIts unfortunate that the docs for #to_sql start with FIX ME and its not because people want Foo.arel_table[:bar].to_sql but because of the AST traversal to find a relation.\nIf we want to be able to pump a string out, this is what the code started to look life for me after a half hour of hacking:\n``` ruby\ncollector = Arel::Collectors::SQLString.new\ncollector = ActiveRecord::Base.connection.visitor.accept Foor.arel_table[:bar], collector\ncollector.value\n=> \"\\\"foo\\\".\\\"bar\\\"\"\n```\nTBH, if we did a lot of this and changed up the app to use Arel in a lot more spots, we could start (badly) supporting more DBs than just MySQL, PGSQL, and SQLite. But, hey, lets just stick to doing the Rails-Way\u2122.\n. :heart_eyes: \n. It would also be a tiny bit faster if we could use DISTINCT lol\nI'll take the time to explore Arel a bit more and start building out a Distinct for Arel if I have to and PR it to them. Also, I wish Rails supported #distinct_on now that I know it exists...\nAnywho, lack of an API has lead us into in awkward position.\n. Translation here :)\n. Translation\n. Translation\n. Translations\n. kk\n. @gmacdougall TBH this whole time I thought AR didn't have #distinct.\nhttp://guides.rubyonrails.org/active_record_querying.html#highlighter_543904\n. I think we should use the #id here so that we don't send an AR object through AJ.\n. Maybe iterate over the mailer_previews here. This way when we add or remove over time, we won't have to edit this file.\n. Didn't know that. Used to always be careful.\n. Ah, super :+1: then :D\n. same\n. I would assume it is...\n. I think it can get detected.\n. Just a reminder for COUNT here. :)\n. lols whoops...\n. This actually looks pretty scary. What did this do?\n. As long as they're called as before actions, I think this is a good thing.\n. I'm guessing Rails autosets this...\n. ---Bikeshedding alert---\nTo avoid semi colons:\nruby\ndef authorize() 'authorize' end\n. @jordan-brough I'm thinking that you might want to monkey patch it. This way Solidus remains closer to the sugar that Rails provides and helps you find reason to remove the ResqueMailer.\n. @grzlus If we add the ON keyword, then we could definitely move this to Arel, but you're right, this won't be compatible with other DBs. I think I'll just make an if statement for database type. Its not nice, but it'll do :(\n. lols super :+1:\n. I'd opt for (b) since most devs will be using ActiveJob in 4.2.\n. returned_exchange? already manages the shipments?\n. :+1: here.\nI'm assuming this is to make sure there's only one begin and commit for he transaction or was this for locking?\n. The inventory units are based on a line items quantity right? I might use a find each here in case people use Solidus for wholesale of goods; but now I'm just trolling.\n. :+1:\n. :+1: for using the association\n. lol :+1:\n. Do we need the type: :controller here?\n. That's a good idea.\n. @Dkendal @alexblackie I would wrap it in a 'transition to' context.\n. I feel like this should get its own special unit test now lol\n. I would just do @new_order = ..., but this is a cool style!\n. This should be Spree namespaced (eyeroll for not writing Solidus) and the table name should be spree_shipping_method_stock_locations.\n. Can you add foreign keys for referential integrity? Its available in rails now, so we might as well add it in. I also feel like these should have index: true on them.\n@gmacdougall thoughts on this?\n. Shouldn't this be Spree::UserClassHandle.new?\n. If I destroy a shipping method, what should happen?\n. I'm shutting down a stock location and destroying it in the admin. What should happen?\n. Also, is the #to_a needed? I think rails actually calls it internally. That's how it does the DB request at the end. Calling #to_a here just hands you back an Array object instead of an ActiveRecord::Relation object. I would always prefer an AR object over a simple array object.\n. Oh man... Can't wait till rails 5 is out.\nruby\nt.belongs_to :shipping_method, foreign_key: true\n. Shouldn't this be cartUrl?\n. Maybe delete the comment as well? lol\n. ah kk\n. @athal7 pros and cons came to mind. I would start the rename here and in the rail engine add:\nruby\nSpree = Solidus\nThis way Spree starts to become a second class citizen and its Solidus.\n. Are we sure we want to permit :id as well?\n. lol same\n. Actually, I cherry-picked the wrong commit. If you check the branch name, this was actually correct. Through an interactive rebase, I've removed the commits that aren't specific to this PR. Apologies.\n. Maybe add null: false here.\n. oh, right lol :+1:\n. Curious if this should be deprecated in the future.\n. The only loss I can think of is possibly no after_destroy/before_destroy callback. Not sure if we get to keep that.\n. I want to add a note about referential integrity here too. But seeing that Prototype <=> Taxon and Product <=> PromotionRule doesn't have it, then it might not be appropriate just yet.\n. I feel like this should be either:\nruby\nline_item.destroy!\nafter_add_or_remove(line_item, options)\nor\nruby\nline_item.destroy && after_add_or_remove(line_item, options)\nMainly because, if a user extends line items and breaks an before_destroy callback or something, I feel like this would help them debug.\n. I've been going back and forth these days on whether to use SQL or to use AR for migrations. For me, I would have done:\nruby\nSpree::Shipment.where(pre_tax_amount: nil).find_each do |shipment|\n  pta = shipment.cost + shipment.promo_total - shipment.included_tax_total\n  shipment.update_attribute 'pre_tax_amount', pta\nend\nThis way its all inside of AR and none of the callbacks happen; I think. If the table name may change, then maybe:\n``` ruby\nclass Shipment < Spree::Base\n  self.table_name = 'spree_shipments'\nend\nShipment.find_each do |shipment|\n  ...\nend\n``\n. Was there a reason for the parenthesis?\n. Ahhhh that's why we need it. :+1:\n. Honestly, we should create a helper for this. If I had a dollar for every time I've written those four lines... I could purchase Spreecommerce and FirstData...\n. This is a fairly big method. Maybe split it up into smaller methods?\n. This is happening in a lot of specs. Maybe make a trait or a factory for it?\n. :+1: here :D\n. If I remember from math class(a + b) - c = a + (b - c) = a + b - c`.\n. For Rails 5:\nruby\nt.timestamps null: false\n. This should probably become nested. That way people know that Spree is a module... Makes code investigation for newcomers easier.\nAlso, it should extend from Spree::Base, not ActiveRecord::Base. This way we get that spree_ table prefix.\n. I think when you extend from Spree::Base, this line can disappear :D\n. Out of curiosity, was the :class_name required?\n. :D\n. A product is paranoid isn't it? Maybe:\nruby\nadd_index :spree_product, :slug, unique: true, where: 'deleted_at IS NULL`\nThis way the index doesn't contain deleted data (lower DB size? :D) and if you delete a product then recreate it, you might get an error.\n. Grammar: a => an\n. Since the position is in the default scope, maybe index this as well?\n. We should probably drop this into an extension in case anyone has an iOS or Android app relying on these endpoints.\n. Just saying, removing from the API might really upset anyone who wants to upgrade, but they're using this in their iOS or Android app. I know my previous employer Kabuni is using it in their iOS app.\n. @magnusvk I think Enumerable#each_with_object will return the hash. I believe the nature of it was so that you didn't have to store it in a variable and then return it :p\n. I feel like some of this should be moved off to a scope and then use ruby's multiple assignment abilities to make things more readable:\nruby\nstock_location_ids, variant_ids = StockItem.stock_location_and_variant_ids\nlocation_lookup = StockLocation.where(id: stock_location_ids.uniq).map { |l| [l.id, l] }.to_h\nThis way you can write stock_location_ids.uniq instead of location_variant_ids.map(&:first).uniq.\n. I tend to add #present? incase the param is an empty string like if order_params[:user_id] = ''.\n. Missing preposition. Probably \"bind it with an IP address\".\n. :-1: since API removals are a major change for people. Anyone who has an iOS or Android app using these endpoints are going to get stuck on previous versions of Solidus unless they code their own.\nMaybe provide a gem for this so that way we don't leave anyone in the dust and just provide deprecation warnings that it'll be removed in 2.0?\n. Just style policing... Don't think the self here is needed.\n. It looks like this was a duplicate.\n. lol :+1:\n. This can be split out to just actionmailer and activerecord.. @jhawthorn Yep, that can be a problem. We could provide an unless config.files_to_run_one? or something along those lines; can't really remember the methods name.. We should probably cherry-pick this out into another PR.. We should freeze these strings since they shouldn't be mutatable.. I feel like a method should be used here. So that way people can easily extend payment states if they need to. Perhaps add a config to Solidus for this?. Ah, right. We should delete all of the other freeze calls then :p.. Why grab all the payment methods, reload the data, and then not use it?. This could be a before. Then you wouldn't have to call subject at the beginning of each spec.. Could this be done as cannot :update, Order, &:completed?. Maybe add some docs on how sorting works.. That's weird. I don't think you're using the reference anymore though.. Just need to instantiate payment_method before the specs. Since it's used by both tests, you can do:\nruby\nlet!(:payment_method) { ... }. This taxon is needlessly created for the first spec. let! can also be problematic in creating records when you don't need them and can slow test suites down. Using let will solve this.. Yep, especially since the before action also applies to create. The code change did expand the behavior to create.. Why? That breaks consistency with the UI. There's no reason someone could find their own page and send a reset password email to themselves.. I don't think there's really any need to do a return of false here. The return value of this method will never be used and it's more for possibly adding errors to the record.. uh oh, I think you meant to add :return_authorization_reasons.. No idea. If you found it didn't work, then removing it is probably good. Not sure on the history of this guy.. Nope, just out of place for the type of method it is.. Yeah, method docs plus guide docs would be great. I recently needed something like this.. It would also be really good to add some top-level docs as well.. This looks weird. Why not just do:\nruby\ndescribe Spree::Stock::Sorter::DefaultFirst do\nend. Why the need for type: :model?. Can also do:\nruby\nattr_writer :coordinator_class, :estimator_class, :sorter_class. Why require it to be of ErrorReport::Base? I would recommend just checking if it responds_to? :report. That would be much more in line with Ruby philosophy.. Might be better to have it raise NotImplementedError. Missing semicolon.. Missing semicolon.. This is a really big method. Maybe move the renders to their own private methods? Like render_redirect_to, render_not_found, and render_invalid_query. You may have better naming than I.. Since this is multi-line, the lambda should be lambda do |variant|. May or may not work since you're in a method. Anywho, there should be a space between -> ().. Extra new line.. :-1: Would prefer something more restful such as:\nruby\nresource :quick_switch, only: [:create]. Do p require 'jwt'. If you get false, you'll know soon enough.. Use find_by instead of where.first.. Is this still needed with the latest master?. Yep, still needed: https://github.com/solidusio/solidus/blob/master/core/solidus_core.gemspec#L27. Weird. I would suspect AASM to just check the errors. It's scary then that AASM lets me move forward in steps with errors if the method return value is, ~as Java would put it,~ void.. As a developer, if I see an error that says NotImplementedError, that really tells me something :p\nBut if you see NoMethodError I would check to see if I spelled the method right. NoMethodError covers a wider array of reasons why it gets raised.\nIf I see someone do: rescue NoMethodError I would wonder why. Are they getting nil and rescue'ing if it ain't there? So many questions with NoMethodError.\nThe purpose of NotImplementedError was to communicate what needs to be implemented. You've spelled your method right and if you rescue it, it's obvious to give a default response when a method isn't implemented or to raise a new default error that is better formatted to the appropriate context.. Ah, just read the link. This puts a spin on things: http://ruby-doc.org/core-2.5.1/NotImplementedError.html\n\nRaised when a feature is not implemented on the current platform. For example, methods depending on the fsync or fork system calls may raise this exception if the underlying operating system or Ruby runtime does not support them.\nNote that if fork raises a NotImplementedError, then respond_to?(:fork) returns false.. If raising an exception, would the state machine catch it and politely return false when doing order.next vs order.next!?\n\nBut, if AASM isn't following proper Ruby philosophy nil || false then returning false is probably a safe bet.. ",
    "Dkendal": "Minor comments but otherwise lgtm\n. :+1: yes please. Imo icon_link should be renamed as well to icon-link, if it falls under the scope of this pr. Also agree that the link colorizing classes should have a name like what was suggested - but it would probably be beneficial to change all classes that are specific to the structure and augmentation of 'icon links' to share a common prefix. Not sure if with-tip and no-text fall into that realm.\n. My biggest want would just be having sane classes, that don't rely on the scope of other classes/selectors/whatever that have names that make it obvious that they are intended to be used together.\n. :maple_leaf: bruh\n. closing because i guess this is a hot topic \n414\n. I always found it annoying how this differed from rails new app :+1: \n. It works as is, however it does not address all broken factories.\n. Sounds good to me!\n. Updated description.\n. Feedback from https://github.com/Dkendal/solidus/commit/6cb4728a0c3f77f126755ac4957e48a2b69bbc71 addressed in https://github.com/Dkendal/solidus/commit/a5840ad1f677a29d712cfc7e4fa206b8acf40a29\n. pretty!\n. :-1: for the same reasons as @gmacdougall.\n. :+1: \n. I'm going to take a stab at this\n. As far as I can see this requires: \n- Replace ActiveMerchant::BillingResponse\n- Replace ActiveMerchant::ConnectionError\n- replace usages for ActiveMerchant::Billing::Base??\nNot sure yet what ActiveMerchant::Billing::Base is used for, I can only find assignments to it, never anything reading from it, including, or extending the module.. https://github.com/solidusio/solidus/compare/master...Dkendal:feature/remove-active-merchant?expand=1\nCurrent branch.. @mamhoff any thoughts on how to rectify the interface with solidus_gateway? \nAll results that come back from gateway are handled in core/app/models/spree/payment/processing.rb, I was thinking of checking the type of the result and presenting a deprecation notice if it's an ActiveMerchant::Billing::Response.\nThoughts?. #1935 . @mamhoff rebased. @jordan-brough While I agree that a simplified interface for gateways would be an excellent move forward, this is only intended to remove the dependency while still providing duck typing and backward compatibility with all existing gateways.. If possible I'd like to see these shipment.determine_state(order)  expressions pulled out into a subject block in this pr\n. @alexblackie  it would probably be cleared if it was described as something like 'transition to cancel' or something of the ilk.\n. ",
    "allisonlarson": "New PR https://github.com/solidusio/solidus/pull/103, with all of the cherry picked commits\n. @jordan-brough added docs\n. @jordan-brough \n. Prefer this. Original change was just re-adding the nil checks that had been previously removed. Thanks\n. Yeah, both stock_transfer_closed? and stock_transfer_shipped? should be inlined then.. I'm into it. \n. ",
    "ckk-scratch": "No thank you! Excited to start building with it.\n. No thank you! Excited to start building with it.\n. ",
    "anulman": "Hey all\u2014hoping to revive this thread.\nStumbled on this while browsing source; my firm is about to need different default_cart_tax_rate lookup on our stores and would like to minimize eventual pain as Solidus expands multi-store support.\nSeems easy enough to override the lookup w/ a subclass, but we'll have to persist the store's state (as in OH, CA, AZ, NY...) somehow to look this up properly.\nWe're using the core project as a backend for a custom frontend, so using solidus_multi_domain isn't a good option. Further, multi_domains options were a bit brittle; I'd figure downstream implementers may have all sorts of metadata they may want / need to add to a Store.\nAre you open to making the properties model polymorphic? Seems like doing so would accommodate Stores' idiosyncrasies like Products', and be a nice upstream API for extensions like multi_domain: a pattern of join tables for metadata + subclassing to manage their effects.\nSince you dropped the TODO, thought I'd reach out and offer to contrib before trying something like \u261d\ufe0f on our own.. preferences looks great. Is usage documented anywhere higher-level than the spec / are there particularly useful reference implementations?. @cbrunsdon \ud83d\udc4d that looks like the right approach for the lib. My \"resolution\" code was purely in case other consumers stumble on this issue while debugging :)\nHappy to submit a PR if this will be as simple as find/replace'ing through the project and confirming all tests continue to pass. If add'l tests will be required (not sure if this qualifies as refactoring vs. bug fix?), I'd appreciate some additional guidance.. @cbrunsdon first stab, haven't been able to get build.sh running. Can any project devs help? I've consulted README.md & CONTRIBUTING.md and am having difficulty getting the first test run booted.\nNeed to turn back to client work for now; dumping state:\n\nFailed due to missing mysql executable; brew install mysql\nFailed due to postgres not running; pg_ctl start (why are both dbs required?)\nFailed due to missing postgres role; CREATE ROLE postgres SUPERUSER;\nFailed due to inability to log postgres user into database; unsure how to proceed. \n",
    "danielmyasnikov": "\nA person wanting to work on this issues could go through solidus_multi_domain and evaluate all overrides and functionality, pulling out and building PR's for anything that was better suited for core.\n\n@cbrunsdon @jhawthorn , is that still the case?\nI'd love to move to solidus_multi_domain gem into solidus.\nAnd fix some tests \ud83d\ude0f , like: https://github.com/solidusio/solidus_multi_domain/blob/master/spec/controllers/spree/api/products_controller_spec.rb#L16\n. ",
    "Sinetheta": "Rubber ducky at your service.\n. :+1: \n. @dangerdogz what makes this funny is that :none is not included in Spree::PaymentMethod::DISPLAY, so it's not really a valid option, which means that if anyone ever clicks \"update\" in a store credit payment method they will unwittingly set the value to :both.\nSo I don't suspect that anyone running into this problem ever changed the value intentionally, and they certainly don't have an easy way to change it back.\n. @cbrunsdon just a lot of changing things by hand and verifying the effect with my face. A lot of pixel-perfect nudges will fail, as @jhawthorn mentioned a lot of properties which are not being inherited will fail.\n. :+1: to defaults\n. Thanks for pulling this down to test @tvdeyen!\n- [x] I'll check the settings menu when I'm back in office. \n- [x] Having the settings menu in a flyout (are we talking about the \"sidebar\" 3rd level of nav in general?) might not be possible, as it seems quite large depending on the page.\n- [x] The user login menu will require an update to solidus auth devise, since it's defaced in and I've renamed the partial.\n- [x] I think a folder for the sidebar partials is a great idea\n- [x] I'll check the position relative\n- [x] RE: sidebar color. What do you think about coloring it in @Mandily to provide some contrast there? I think all of the colours are up for debate.\n. So, it looks like the remaining spec are failing due to overlap of the flash with what is now a higher content area.\n\n~~@Mandily would like to scope creep those into dismisable alerts at the top of the main content area.~~\nI'd like to move them to the bottom.\n\n. @tvdeyen in regards to the third level of navigation, I'm going to leave it where it is right now (on the right side of the main content). But I believe that @Mandily is considering a \"tabbed layout\" for the main content area, where the 3rd level of nav would be the tabs.\n. I'd like to include a couple styles and notes about the solidus_auth_devise change, then we're good to go.\nA color change will come with the next PR.\n. Hey @tvdeyen sorry I was out yesterday. Thanks for having a thorough look through things. And yes, PRs are always welcome! For my own sanity I'm going to make another checklist.\n- [x] 3rd nav style problems (right sidebar)\n- [x] assess removability of .inline-menu\n- [x] loading spinner positioning (gonna be tricky to place anywhere in this interim layout)\n- [x] solidus_auth_devise update\n- Removing nav.menu styles wholesale was too aggressive. I've just reverted that change and we'll address it with the possible \"tabs\" update.\n- So I had accidentally affected \"all\" .inline-menu when I cut the styles from navigation.scss, there was actually an important global style which I have moved to typography.scss with the rest of it's friends.\n- just went with centre top of .main-content\n\n- solidus_auth_devise update https://github.com/solidusio/solidus_auth_devise/pull/28 will wait for this pr to land.\n. So, there's been a bit of scope creep here, but I think we're close.\nI looked at a few sticky-nav libraries, but nothing seemed to do the full \"wordpress experience\" without huge file-size. I think this bit of custom js will do the trick for us.\n- If the viewport is taller than the menu\n  - the menu will stick to the top of the viewport when scrolling down past it\n  - the menu will return to it's topmost position when the viewport scroll up past that height.\n- If the viewport is shorter than the menu\n  - the menu will stick to the bottom of the viewport when scrolling down past it\n  - the menu will stick to the top of the viewport when scrolling would bring you higher than it\n  - scrolling up or down when the viewport is inside the upper and lower bounds of the menu will scroll naturally.\n  - the menu will return to it's topmost position when the viewport scroll up past that height.\n. I'm just fixing the spec failures that were introduced with our recent rspec changes.\n. I believe I've addressed everyone's concerns here.\n- Navbar is now a sidebar\n- Menu is \"Wordpress style\" sticky and follows the viewport.\n- We use a small lib, instead of custom code, to do that.\n- There's a note in the changelog with a link to a wiki page explaining how to upgrade.\n. 1 last item, changing solidus_auth_devise from a deface hook to a template override.\n. Okay, solidus_auth_devise will now no longer use deface.\n. Part of the sticky nav changes @tvdeyen was to drop the \"login fixed to bottom\". When the nav is shorter than the viewport it gets tricky to have a reasonable fixed position element there.\nShopify gets away with it by adding a separate scrollbar to the nav when it's taller than the viewport. I felt that we would go the wordpress way with the 2-ended sticky. Which means the login menu has to join in with the other items.\nI think you're right though, that it seems to be \"floating there\". @mandily is putting her style thinking cap on to improve the look a bit. Do you have any suggestions? We could\n1. Add an \"Account\" nav item, and throw the login nav in as subnav items.\n2. Add 3 nav level items.\n3. Add 2 items and move the \"back to store\" elsewhere (header?)\n4. Keep the anchor motif, but style it up a bit to look less out of place.\n. Okay, so how about this. If there is room for the whole nav, we stick the footer to the bottom of the page, and let both pieces ride along with scrolls (main nav sticked to the top, login sticked to the bottom). When there is no room, we trail the login nav off the bottom of the main menu and it's business as usual.\nEnough Room\n\nNot Enough Room\n\n. Good eyes @tvdeyen, it's actually any margin bottom on the last item in the .main-content which would have caused that overflow, so I added a clearfix.\n. Thanks all, and big thanks to @tvdeyen without whom this would have been a much lamer UX with a lot more visual inconsistencies.\n. @tvdeyen my concern with a blocking spinner is that not all interactions which could trigger this loading state result in a page that a user shouldn't interact with.\nLiterally any ajax for any reason https://github.com/solidusio/solidus/blob/master/backend/app/assets/javascripts/spree/backend/progress.coffee will cause this thing to pop up. So if anything I would like to see it become less prominent (eg the admittedly overplayed http://ricostacruz.com/nprogress/ ) rather than more disruptive.\n. I'm a big fan of showing components, especially those specific to Solidus. When it comes to something like sass variables though, I worry about overreach.\nRather than trying to take on \"how to internet\" I would prefer references to other resources.\n. AH! Sorry about that, I misunderstood. Then I completely agree, I would love to see justification for our things. \"colors\" sections always look pretty, with swatches and variable names.\n. @mandily @tvdeyen I'd love input on this page while I'm editing. The biggest concerns for me are around adding new taxons.\nOn the old page you would right click a taxon and \"Add\" a new one as the new last child. That taxon would be called \"New node\" and your focus would be automatically set to edit that name in-page.\nMy current implementation has only an \"Add Taxon\" button in the header. Clicking that button inserts a taxon called \"New node\" as the new last child of the root taxon. In order to rename any new taxons a user would have to \"edit\" that taxon by leaving the page.\nThat was the easiest thing to implement, but I'd be happy to entertain alternative interactions.\n. Oh, but I'm sneaky @tvdeyen \ncoffee\n$('#taxonomy_tree ul').sortable\n  connectWith: '#taxonomy_tree ul'\nBam! nested sortables.\nPull it down. Play around a bit. I think it works pretty slick.\n. Thanks for taking a look at it @tvdeyen. Can you explain which drag operations were problematic. Personally I found it at least as functional as jsTree was (dragging any tree structure is going to require playing around until you get the hang of the particular implementation).\nOne thing that was giving me a problem, was trying to get something into the bottom most position of any list (it always wanted to be a child, not a sibling of the element above it), so I tweaked some settings and I think it feels more intuitive now.\nI'd be happy to give nestedSortable a shot though if this still isn't feeling good enough.\n. I've added the api routes back in @BenMorganIO @cbrunsdon, we can just rip them out when we address the API as a whole.\nI think we're good here, unless anyone has code related feedback, or UI/UX suggestions.\n. Thanks @tvdeyen, I did worry about lumping this in with everyone's admin assets (especially the code highlighting library, which some people have expressed concerns about) but I'm more worried that the alternative is that it sees no real use.\nI can't think of a way to \"include this is development only\", so as a separate gem it would be up to each project to include it themselves. We need to decide whether this is:\nA) A tool for the development of Solidus only. In which case it's fine as a separate gem. If you want to contribute to the backend you include it in your environment.\nB) A tool to help all stores style their admin areas.\n. @cbrunsdon I've moved things around so that the \"theme\" of the sidebar is controlled by the final commit, a change of variables only, then added a note to the changelog.\nI don't think any additional explanation is required for customizing the nav, as that file would be the point of entry for any solidus admin custom colors.\n@tvdeyen I very much agree about noting these colors in the styleguide. I will update whichever PR makes it in later https://github.com/solidusio/solidus/pull/602#issuecomment-166692728\n. @cbrunsdon I've moved things around so that the \"theme\" of the sidebar is controlled by the final commit, a change of variables only, then added a note to the changelog.\nI don't think any additional explanation is required for customizing the nav, as that file would be the point of entry for any solidus admin custom colors.\n@tvdeyen I very much agree about noting these colors in the styleguide. I will update whichever PR makes it in later https://github.com/solidusio/solidus/pull/602#issuecomment-166692728\n. Hey guys, sorry I was away for so long. Although I personally love incremental changes in UIs, even if it results in half-man half-monster in-between phases, I can completely understand @tvdeyen's concerns. As such I have ammended the final commit to be opt-in instead of opt-out for users.\ndiff\n+    * Added optional \"Solidus next\" styles to the admin area, as per [admin rebrand](https://github.com/solidusio/solidus/issues/520).\n+    To use the new colors, add `@import 'spree/backend/next/globals/variables_override';`\n+    to your `spree/backend/globals/variables_override`.\nDoes that seem like a reasonable approach to everyone? The /next directory would be where we add any breaking style changes during rebrand until they can all be moved into core. For this PR I was able to get away with variable overrides only, but I wanted to leave the door open to custom stylesheets which a user could include after Spree's styles.\n. That's wise @jhawthorn because every time I have to rebase a branch my file names become more ridiculous.\n. Thanks for spotting that one @jhawthorn. I think we're good now.\n. That sounds great @mamhoff. I meant to finish this over the holidays but got a little side-tracked.\nIn order to test these I pulled https://github.com/solidusio/solidus/blob/master/core/spec/spec_helper.rb#L36 out of the spec_helper and was using a simple test_spec.rb where I would just swap out the factory I wanted to isolate.\n``` rb\nrequire 'spec_helper'\nrequire 'spree/testing_support/factories/address_factory'\ndescribe 'things', :type => :model do\n  let(:address) { create(:address) }\nit \"should pass\" do\n    expect(address).to be_an(Spree::Address)\n  end\nend\n```\nThe only problem is that I wasn't being super thorough testing all factories in a file, or checking all of the traits. I was planning on doing little --fixups where needed.\nBy all means send PRs to my branch, or just open a second PR with your own fork. If you finish first I can shut this one down, or I can just cherry-pick any progress you make. It will probably be a few days before I'd get a chance to get back to this anyways.\nThanks!\n. :+1: from me, gj @Murph33 \n. @tvdeyen my thought was to get the breadcrumbs closer to meta-data. With a content_for we have no validation over what's being jammed up there. With an interface like add_breadcrumb I'm hoping that we can soon take this decision out of the views entirely and get the info from our navigation.\nCurrently we have a quasi configurable nav. Some of it is in backend_configuration.rb but mostly it's contained in the views. I've talked with @jhawthorn about how we might make the nav configurable and I think he liked this pattern https://github.com/codeplant/simple-navigation/wiki/Configuration\n\nThen when rendering the breadcrumbs we can take care of active state, etc.\n\nHow would we do this with a content_for approach?\n. @tvdeyen the only thing that's important to me is that the \"individual breadcrumb entries\" be isolated in some way. I would have used an array to pass them in, except:\n1. We're still doing this in actual templates and it felt a little too \"code-like\" to enforce the extra structure of an array, to save on the repetition of add_breadcrumb.\n2. Since some pages are built from multiple partials, we still need the ability to \"build up the breadcrumbs\", so there will still be multiple calls sometimes and a breadcrumbs which is stateful and additive sounded weird to me.\nI'd love to see the nav handled by configuration, although it presents some technical challenges for dynamic routes, then add_breadcrumb melts away and we just print out the current page nav structure.\n. I think I would lean towards most buttons being \"no action required\". Eg: Update and Cancel are both no-action-required until an input is changed, at which point Update becomes an action-required button (bonus points for window.beforeunload if the page is in that state as well).\nI'm interested in @kennyadsl concept of color for \"positive\" or \"negative\" actions. I think color-primary (green for github blue for new solidus) is a very upsert color, to be used for all create and update actions.\n. Thanks @jasonfb I agree that it's a little wacky that there's a button up top that just forces through a bunch of voids and refunds until everything is dead, but right now that's how it works. This is just a fix for orders with store credit.\n. Thanks @jasonfb I agree that it's a little wacky that there's a button up top that just forces through a bunch of voids and refunds until everything is dead, but right now that's how it works. This is just a fix for orders with store credit.\n. Spree::CreditCard already has a single name credit_card.rb.\nWhen mailing things a \"recipient line\" is a single string for all shippers I can find, USPS.\nI think that if an application wants to record first and last names, that's their business. It would be great is Solidus did not require them on addresses.\n. Does the Spree.Ready code really survive being reloaded like that?\nIt looks like the codebase has a bunch of doc readys and a few spree readys. If only the latter happens I would expect some information to be lost checkout.js.coffee#L12\nor for delegated event handlers to pile up payment.js.coffee#L32\n. Hey @mtomov, thanks for getting rid for Spree.Checkout. My concern with delegated events is that we have one bound inside of a Spree.ready, so each page load will add another.\n- [x] Tell Spree.ready not to fire twice at page load.\n- [x] Replace all document ready (and variants like $ ->) with Spree.ready for code that interacts directly with the page.\n- [ ] Move all event handlers delegated to document or body out of Spree.ready. Putting those in doc ready is probably fine (because it will never rerun). payment.js.coffee#L32 \nI've never used turbolinks, but those are the only concerns I can think of. Luckily there isn't much JS in the frontend.\n. Sorry about the nits, I didn't read the PR message. Looks great as a UI @jhawthorn \ud83d\udc4d . Thanks @kennyadsl, I bumped into this problem just the other day. Can confirm this resolves the issue \ud83d\ude00 . \u00bfqu\u00e9?\n. model and model.paramRoot \u2194 model?.paramRoot\n. :+1: \n. I always forget the prefixer.\n. I was just hedging my bets...\n. No prob\n. There's currently a thing called \"sidebar\" which refers to the right content of a page with a 3rd level nav (e.g., /admin/general_settings/edit).\n. Since there's now some confusion about what a \"sidebar\" is (left side of the page vs right side of the main content area), I'm thinking of calling all of the new stuff \"admin navigation\". But yes, grouped in a folder would be nice.\n. Good call. That corner is bound to be problematic. Either it's a part of the sidebar which \"happens\" to be the same height as the .page-title or part of the main content with happens to be the same width as the sidebar.\nI'm thinking that the latter might help with this positioning problem since the sidebar currently has a static width.\n. You beat me to it again @tvdeyen I was just about to add that very feature (js affix). I feel bad that we didn't foresee this problem sooner, I guess that's a drawback of developing on ginormous monitors.\nI would love to have been able to fix the problem with CSS only, but adding any type of scroll (even to only 1 direction overflow-x: auto) cuts off every overflow. So at the very least we would need to position the flyouts with javascript (append to body, position with js). But if we're going to do JS we might as well take the wordpress route and have the entire nav follow you around.\n. Ya, it's just a double-ended affix, when the main content is longer than the nav is longer than the viewport.\n. A little beefy, but the right idea.\n. :unamused:\n. That's a neat idea.\nA related problem comes up when trying to communicate styles (like media query breakpoints) between css and js. I've experimented with using ruby and the canonical source and templating into assets, but everyone seems to get all up in arms about the fanciness.\nI've never tried reading the value right out of the sass before though.\n. Ha! Good point. I think I wanted uppercase gone, and saw capitalize as the next step down. Let's be rid of it entirely!\n. It seems like you've got quite a few possible children here, but aren't addressing many of the permutations. Is that because these are the only ones that occur?\nWould > * + * be what you're looking for? http://alistapart.com/article/axiomatic-css-and-lobotomized-owls\n. That was my thought @Murph33. If the goal is to \"inset space between any children\" then I think * selectors might be what you're looking for (with child > selectors if necessary).\nFor example http://codepen.io/Sinetheta/pen/KzNpXN\n. Just something I grabbed from another spec. I'll find out if this is required (and should be worked back into the factory) or not (and should be removed from other specs).\nhttps://github.com/solidusio/solidus/blob/5f4b2a818829d9ef1e616df544be53bfd6abe540/core/spec/models/spree/order_spec.rb#L1121\n. Fair enough. I don't like when we try to catch problems tangentially, but in that case we would raise an error during a cancel, which would probably be useful. I'm cool with swicthing to ==.\n. Maybe something other than .hover , since the action here is .drag-over.\n. If we use jquery's addClass and removeClass we can be more descriptive of what's happening and avoid crushing unrelated classnames.\n. We might want to be more specific that return false, here we need to e.preventDefault() to allow dropping a file, but we don't need to stopPropagation of the event.\n. We don't need to stop or prevent this event.\n. We could use one of our helper libraries for iterating.\njs\n_.each(e.originalEvent.dataTransfer.files, this.upload, this);\n. I'm not sure if we need the browser support checking, since these APIs exist on all modern browsers including Microsoft Edge and we're not doing anything in the event of failure, just showing some words.\nIf we did want the support checking, maybe a custom build of Modernizr would be less application code to support? cc @jhawthorn \n. Adding progress to ajax is cool, we may want to make this generic to all Spree.ajax in the future. Make it a callback and trigger an event.\n. As we add more long lived pages cycle('odd', 'even') is really gonna show it's limitations, as new uploads don't get striped.\n. Is there a reason for these inherits? That would be the default and it's also in our reset.. I'm not sure what way you want to go here, but you could also add <i class=\"fa fa-caret-down\" aria-hidden=\"true\"></i> and position as necessary.\nThe svg us much simpler, but harder to color/theme.. We can break this up a bit\n```js\nSpree.Views.NumberWithCurrency = Backbone.View.extend({\n  events: {\n    'change input,select': \"render\"\n  },\ninitialize: function() {\n    this.defaultCurrency = this.$('[data-currency]').data(\"currency\");\n  },\ngetCurrency: function() {\n    return this.$('.currency-selector').val() || this.defaultCurrency;\n  },\nupdateSymbol: function(currency) {\n    var symbol = '';\n    if (currency) {\n      symbol = Spree.currencyInfo[currency][0];\n    }\n    this.$('.currency-selector-symbol').text(symbol)\n  },\nrender: function() {\n    var currency = this.getCurrency();\n    this.updateSymbol(currency);\n  }\n});\n``. \ud83d\ude33  this is why I nevergit add .. How about saving the user's current target if they're already using a form element and returning it to them afterwards?.  Is there a circumstance where you would wantonSubmit` to remove the search class? You might want to explicitly enable and disable instead of relying on implicit toggle.. \ud83d\udc4d thanks. ",
    "plongyear": "Oh I misunderstood. I don't think it will be too hard to rename everything. I'll take a look.\n. @athal7: I added a commit to rename ReturnAuthorizationReason to ReturnReason.\n. The Spree::ReturnAuthorizationReason model was removed from Solidus and replaced with Spree::ReturnReason, which allows return reasons to be set on the return item rather than the return authorization. Would this data ever get inserted by the migration since the model no longer exists in Solidus?\nAlso, I'm not sure if migrations should be inserting data via models like this in general. If a model ever gets renamed the migration will fail to run, which is why the defined?(Spree::ReturnAuthorizationReason) check was added to this migration when the model was renamed.\n. I don't think it would be safe to change it to Spree::ReturnReason.create in this migration. If a user was setting up Solidus for the first time, the spree_return_reasons table wouldn't exist at the time this migration runs so I think an error would get thrown when Spree::ReturnReason.create gets called.\nI think the safest thing to do is not create the return reasons in this migration. It should probably be done here where the rename happened. We should also use find_or_create_by in case a user is upgrading from Spree, which means they have already run this migration from Spree and would already have the return reasons created for them.\n. @jordan-brough I think that's a great plan. I'll make those changes.\n. I added a commit to address @jordan-brough's comments\n. @jordan-brough I took a look at how the valid scope is used in a few places. I would lean towards making a new scope for this rather than excluding voided payments from .valid and make an issue to determine if it makes sense for voided payments to be valid. Does that seem reasonable?\n. @jhawthorn this spec should have been failing once whitelisted_ransack_associations was implemented, but the spec was set up incorrectly so it was still passing.\nOne problem was that api_get :mine should be called with params passed in directly rather than the params: params hash. The other issue was that the incomplete_order used the order factory and did not have a shipment associated to it. This now uses the order_with_line_items factory so the test user always has 2 shipments.\nNow the spec fails unless whitelisted_ransackable_associations are set up for Spree::Shipment.\n. Good point, return_reason sounds like a better name. I'll update this.\n. @athal7, this has been renamed.\n. I had to add this in since Spree::ReturnAuthorizationReason is no longer defined which would cause this migration to fail on a new database. It felt odd to modify an old migration, but I'm not sure if there's another way around this.\n. Sure, I added the reasons as seed data in core/db/default/spree/return_reasons.rb\n. Good catch, maybe we should be checking for checkout, pending, completed, and processing payments?\nIt looks like the closest scope on payments is .valid, which returns all payments excluding failed and invalid. It would return voided payments as well, which we probably don't want to consider here. Would it make sense to make a new scope for this?\n. No reason in particular, I chose arbitrarily since a refund could be for a partial amount.\n. I don't know of any code that does, but I'm not very familiar with payments. I'll take a look.\n. ",
    "bbuchalter": "@jordan-brough do you believe this is still an issue that should remain open?. I am interested in this feature as well; we're getting feedback from the business that our customer facing product list pages are too rigid when only using taxons as categories for customers to \"drill down\" into. We want to be able to customers to navigate categories, but also refine their searches using product attributes.\nFor the sake of shared language, I want to confirm my understanding of the distinction @cbrunsdon is offering:\n- Categories: the hierarchical presentation of products to customers (e.g. Sporting Goods > Basketball)\n- Taxons: Attributes shared among products (e.g. color, size)\nIs that right?\n. Now that #240 is merged, is there any reason we can't remove Admin::Search?. Firing up a dummy app and running rake routes shows admin_search_users and admin_search_products are still out there, but not in use anywhere. I suppose we'd need to deprecate those end points? If there is a good example of how to do that, I'd be happy to open a PR. Or perhaps we just remove them?. Pinging this open issue to @jhawthorn as I've wondered about this feature too. Is this something that can get extracted to a gem?. I'd also advocate a shared \"time gating\" module to implement this behavior. It would be nice if all time gates behaves the same in the system so things are consistent for admins. Perhaps we should start by extracting the existing time gate behavior for promotions?\n. I believe you could implement the module responsible for parsing time gate logic such that the attributes which provide the data were abstracted away with an interface. Does that make sense?\n. I think it's worth trying.\n. @AlessioRocco what progress have you made here? I also started looking at this. \nAs I investigated further, I came to think more and more that FactoryGirl may not be the right tool for us. Take for example, the simple act of adding a line item to order. Using FactoryGirl to build or create a line item for that order makes no sense as that's the job of OrderContents#add.\nNow if we don't care about that extra behavior, that's fine. But then I'm not sure we shouldn't just be using test doubles and avoid the complexities and performance hits of FactoryGirl.\nRight now we seem to be somewhere in between those two worlds: we don't really execute the same behavior in tests as we would in a store, but we do try and recreate some of that behavior.\nWhat are your thoughts?. @AlessioRocco thanks for the thoughtful reply. I'm glad to hear that you feel the idea of using Solidus's API for setting up state for factories is a good one. However, on the other hand, I don't want to be optimizing factories in isolation. I'd rather see them improved in the context of making other specs more correct, or more maintainable. Does that make sense? Do you have any specs in mind that would benefit greatly from improved factories?. This issue seems quite out of date. Perhaps it's time to give it a freshening up in light of our intention to add related guides (https://github.com/solidusio/solidus/pull/1606)? I'd love for the guide to reference any further planned development.. I would find this PR helpful. We've got these customizations hacked into our app now and would love to have a nice interface for it!\n. This there a chance this PR could also be backported to the 1.2.x series?\n. @jhawthorn here is the second part of changes we made in https://github.com/jhawthorn/solidus/commits/fixup_old_preferences_migration3.\nJust for reference, you had already opened one part of it here: https://github.com/solidusio/solidus/pull/1088\nWe need to still open a third, final PR for this part of the changes: https://github.com/jhawthorn/solidus/commit/c5398f75a2be26f7b298e4506dce9370a3da1cee#diff-fa901dae0e304366993ae2180c352c6fL28, but candidly, I'm not very clear on why that change is needed; I don't think I could write a useful commit message. Could you give it a try?\n. @cbrunsdon I believe I've addressed your eagle-eyed concern. Thanks for the feedback.\n. One more time, with feeling!\n. I think this is an important change that we need to continue working at, but I don't know how to move this forward.. Cheers on this milestone PR!\n. Where can the CI job be reviewed?\n. \ud83d\udc4d \n. I'd also say that for those not use solidus_frontend, a controller filter seems like the wrong place to enforce such important business logic.\n. I don't see any difference between this and #1190 - what changed?\n. There are a few more subtleties to this issue that were difficult to capture in text. I took a screen recording of what I discovered and published it here: https://youtu.be/iPDnif_XHXM\nIn summary, my findings showed that when the default_country_iso does not match the first country specified in the checkout_zone, the country dropdown appears as if a selection has been made when it has not been. This is likely a consequence of using select2 with this dropdown.\nI've pushed a branch up that expands on the original failing tests that @jhawthorn got started above. The test run looks like this:\nNew Order\n  with a checkout_zone set as the country of Canada\n    and default_country_iso of Canada\n      defaults the billing address country to Canada\n      defaults the shipping address country to Canada\n      shows relevant billing address states\n      shows relevant shipping address states\n    and default_country_iso of the United States\n      the shipping address country select includes only options for Canada\n      the billing address country select includes only options for Canada\n      shows relevant shipping address states (FAILED - 1)\n      shows relevant shipping address states (FAILED - 2)\nHere's the commit which adds those tests.\nSadly, this new information doesn't make it obvious what the next steps should be. They might include a combination of the following:\n Adding a include_blank: true option for the country select\n Improving available_countries and the address_form partial to be more sensitive to discrepancies between default_country_iso and checkout_zone countries.\n@jhawthorn what would you like to see happen here?. After a quick chat with @jhawthorn we identified this as an issue with sqlite3 and partial indexes. From the docs:\n\nPartial indexes have been supported in SQLite since version 3.8.0.\n\nIf you happen to be running the very old version of sqlite3 that comes with OS X 10.9.5 then these tests will fail.\nNo plans yet on how to this issue should be addressed, but encouragingly, this should be a very edge case.\n. Thanks for this. Was seeing this and getting bugged by deprecation warnings yesterday.\n. \ud83d\udc4d this fixed things for my crusty old version of sqlite.\n. Not in a long time @jordan-brough: https://github.com/solidusio/solidus/blob/60ee1dffc7c3932cd7652cc2b4566f08a12f74b8/core/db/migrate/20150626200816_remove_shipping_method_id_from_spree_orders.rb#L3\n. > It'd be another PR to homogenize the codebase to only ever use Spree::Deprecation. Let's cross that bridge when we need to.\n@mamhoff perhaps opening an issue would be wise to remember that bridge exists?\n. @mamhoff just want to take a minute to say thank you for taking the time to do the search and replace on Spree::Deprecation. It's that kind of get-shit-done attitude that is going to make this platform great. \u2764\ufe0f \n. Is there any value in a migration to help clean up folks data?\n. > My biggest questions when I first came to Solidus was pretty much, \"what's the 30000 ft view?\". There's the 5 modules (api, backend, frontend, core and sample). They have a short one line description in the main README but if you click on their links and find their own README's, they're lacking in explaining what the module provides.\nI thought this was a very reasonable request. Here's a stab at getting started for core: https://github.com/solidusio/solidus/pull/1273\n. Although I thought including a summary of each model would be helpful, there are so many, it's likely going to overwhelm the reader. I do like breaking things into sub-systems and providing a very terse summary of each model there. Perhaps these longer summaries could go into docs in the model files themselves? Bonus points for having this README auto generated from the docs so it doesn't go stale overtime.\n. Although I thought including a summary of each model would be helpful, there are so many, it's likely going to overwhelm the reader. I do like breaking things into sub-systems and providing a very terse summary of each model there. Perhaps these longer summaries could go into docs in the model files themselves? Bonus points for having this README auto generated from the docs so it doesn't go stale overtime.\n. Style question: should these terse descriptions reference specific classes or the concepts which a class represents? For example, which of these is preferred:\nSpree::ReturnAuthorization - Models the return of Inventory Units to a Stock Location for an Order.\nor\nSpree::ReturnAuthorization - Models the return of Spree::InventoryUnits to a Spree::StockLocation for a Spree::Order.\n. Style question: should these terse descriptions reference specific classes or the concepts which a class represents? For example, which of these is preferred:\nSpree::ReturnAuthorization - Models the return of Inventory Units to a Stock Location for an Order.\nor\nSpree::ReturnAuthorization - Models the return of Spree::InventoryUnits to a Spree::StockLocation for a Spree::Order.\n. I was thinking it would be nice to add high-level summaries of each sub-system. I was also thinking this may be an appropriate place to link to the old Spree Guides, with a warning that they may conflict with the current state of Solidus, but generally should represent a reasonable introduction. Thoughts?\n. > I was also thinking this may be an appropriate place to link to the old Spree Guides\nI guess this was discussed in https://github.com/solidusio/solidus/issues/852 which lead to https://github.com/solidusio/solidus_guides but sadly, there has been very little activity there and the output from that repo (http://ashkamel.com/solidus-guides/users/orders/) doesn't seem ready for prime time.\n. @Kingdutch thanks for the encouragement. It's going to take a while to make this comprehensive enough, but I figure I can chip away at it over time.\n. Given the thumbs we've got for things as-is, I'm removing the WIP from this PR so it can be merged with additional documentation to be added in this form in the future. I've rebased over master and added a note indicating the documentation is still in progress and contributions are welcome. Please let me know what else is required to get this merged.\n. > Call update! on all all adjustments, not just promo/tax/cancellation adjustments. I'm not sure how we best figure out what order to call update! on things though\nI know our application had to override parts of the old order updater to get adjustments to calculate in the sequence we need. However this gets, it should be easily customizable and composable. ItemAdjustments is an improvement, perhaps we can go even further.\n. We built our own clear cache button, but only developers used it. Eventually, we just built it into the deploy process. \ud83d\udc4d for removal.\n. @jordan-brough sadly, I don't have a way to demonstrate that the style of declaration will impact behavior. However, I do have a memory that consistently is important for Ruby and Rails' code loading conventions. I'd understand if we want to close this.\n. Fine by me.\n. Typo is fixed. ;)\n. How do we feel about a feature test to protect this from future regression? Seems like a pretty important behavior, so it'd be worth having under test.\n. I know I'm just one voice, but my app isn't using this method.\n. Please see https://github.com/solidusio/solidus/pull/1331\n. Great work on moving this forward everyone. Thank you! \u2764\ufe0f \n. What kind of coordination needs to be done within @stewart to have this change play nicely with solidus_auth_devise?\n. > If a given solidus_auth_devise version is meant to work with multiple solidus versions, then that might have to be wrapped in a if user.respond_to?(:on_sign_in), with the current implementation being the else case.\nThis is likely not the appropriate form for this discussion, but I do want to raise a concern about the idea of adding yet another conditional to solidus_auth_devise. However, lacking a better suggestion, I believe this conditional would be prudent to keep solidus_auth_devise compatible with previous versions of Solidus while giving newer versions a canonical interface for this behavior.\n. For those who are investigating this issue be sure to also look at what impact this PR had by reviewing https://github.com/solidusio/solidus/pull/1416\n. I personally think adding additional codes after a promotion is created is a great feature and this PR moves us in that direction. \u2764\ufe0f \n. For the sake of good record keeping, https://github.com/solidusio/solidus/pull/1406 also addresses this issue.\n. First let me say, the change looks great from a technical level. Always happy to see more red than green. \ud83d\udc4d \nWanted to comment on this: \n\nIt moves toward performing tax calculations at the order level instead of at the line level.\n\nI'll say one challenge with this is refunds, at least with TaxCloud, because you don't get any line item breakdown of the tax calculation. If a customer makes a partial refund of an order, without line item records of how much tax was collected, it's impossible to create tax-accurate refunds. This topic hasn't yet been broached in https://github.com/solidusio/solidus/issues/1252, so perhaps that's a better forum for it?\n. I believe this issue can be closed now that https://github.com/solidusio/solidus/pull/811 is merged?. I've been using this change successfully in my store for more than six months. I believe it's time to get this one merged. \ud83d\udc4d \ncc: @gmacdougall . Given the massive number of commits, is a rebase in order?\n. A CHANGELOG entry is also in order.\n. We need another rebase here before merge.\n. One of the design goals of this ledger was to ensure that information was only ever appended to the ledger so there would be a consistent historical record of store credit activity. While I believe we've followed that principle here, perhaps we should enforce it by marking all store credit ledger entries read-only?\n. When we catch errors like this, shouldn't we be added regression specs?\n. Thanks for putting this forward. This is a regular pain point for our (tommyjohn.com) admins.\n. @DanielePalombo this PR didn't work as expected for me. Steps I took:\n1. Pulled your branch local\n2. Wiped my sandbox\n3. Created sandbox\n4. Added an item to my cart\n5. Completed my order\n6. Went to admin and captured payment for order\n7. Refunded order.\nExpected to see balance due as $0.00 with a payment state of paid. Instead:\n\nThank you very much for your effort on this. I'll be happy to continue to QA, but I believe we now need some feature tests to automate some of this QA if wish to avoid future regressions.\n. I'm going to defer further conversation on this topic to the core team at the moment.\n. It would be nice to cross reference the PRs which closed this issue.. My team has learned the hard way that HTML5 form validations are not supported by Mobile Safari. If you wish to support that browser, you may not want to make that change.\n. This works as expected for me in the sandbox:\n\n. > Not sure if it's worth having a translation for this message?\nEasy enough to do, but I wouldn't know the proper namespace. Any suggestions?\n. I also could not get build.sh to run...if we're talking about removing some cruft, I think that file should go and some clear README updates around running individual components test suites. I've just fought that battle pretty hard, so I'd be game if that'd be welcome.\n. Looks like this surfaced a deprecation warning which caused the test suite to fail.\nThese changes look good. \ud83d\udc4d \nHowever, this does not the underlying issue I was facing which we can discuss in depth in another forum. Ping me on Slack any time if you wish to discuss.. This change seems reasonable. Thanks for the incremental improvement here.. Can this issue be closed now that https://github.com/solidusio/solidus/pull/1616 is merged?. @jhawthorn thanks for your thoughtful reply. It's good for us to get this conversation started. Some specific replies below:\n\nI think a lot of the complexity we'd run into re-implementing state machine as PORO would be in restricting the state transitions.\n\nI had considered this, but honestly it felt like one of the easiest parts of the extraction. You captured it perfectly in your code snippet. Is there more to it?\n\nSeparating the Order's state machine into a separate object would be the first step in allowing the checkout flow to be pluggable on a per-order basis.\n\nDo you see separating the state machines from the objects they mutate implemented as an extension point, similar to what's been done recently for tax calculations?\n\nLikely, this will be complicated, especially with the current state of the Order state machine. I think we'll need to reduce the huge number of state machine callbacks before we can attempt this.\n\nWow! I hadn't seen that Checkout state machine in a long time, and it hasn't gotten any better.  However, looking more closely, it's really just a bunch of method calls executed at a particular transition, in a particular order. I think extracting it out into a class which calls those methods in the correct order (and under direct test!) would be very possible. What do you think?. There doesn't seem to be any further comment here.. @cbrunsdon I added a spec that checks for persistence when simple_current_order is called a second time to show that it's not persisted. Did I misunderstand you or write the spec incorrectly?. @cbrunsdon would you like me to rebase the fixup or remove it?. Done.. Test fail does not seem legit. I can't seem to trigger a rebuild. Thoughts?. Poke.. I have rebased this PR on master. Given that simple_current_order is now deprecated, I've removed any of my changes related to that method. . @gmacdougall can we get this one rebased on master and review this work again?. I think we've reached the end of useful conversation here.. This is a duplicate of https://github.com/solidusio/solidus/issues/1186 which was fixed by https://github.com/solidusio/solidus/pull/1200.. Obviously this isn't as simple as adding with_deleted, as this causes 111 specs to fail. I could add a check to see if parent_data[:model_class].respond_to?(:with_deleted), but that's pretty ugly. However, I don't have any alternative suggestions. Going to let this sit for a day to see if I get any feedback on how we'd like to move forward with this, or come up with else.. > We could also just override the required methods in Spree::Admin::VariantsController itself?\nAs I was thinking about it more, this was the direction I was taking. The question now is to what degree: do I just override #parent or do I stop trying to use ResourceController as the base of VariantsController? Is there an interest in moving away from ResourceController? . @jordan-brough your solution is clever, but I think overriding parent is more clear.. Poke.. Feedback implemented. Ready for another review.. Poke.. > This is all expected behaviour\nI have to say I think the inability to add more codes to an existing promotion is a major shortcoming. Is there an existing issue to request this feature? If not, perhaps this is where it belongs?. I was able to take a different approach to creating an extension.. I agree this is a noble goal, but is likely a big breaking change for many, many stores. Would need to be part of a major version bump and a lot of care given to a sane upgrade path. Nonetheless, \ud83d\udc4d .. I just got a comment from my marketing team about making changes to this. \ud83d\udc4d \nExtra points if it's administerable.. This also happens with a more stripped down ./bundle/config file:\n```\n\nBUNDLE_PATH: \"vendor/bundle\"\nBUNDLE_DISABLE_SHARED_GEMS: \"true\"\nBUNDLE_MIRROR__HTTPS://RUBYGEMS__ORG/: \"http://localhost:9292\"\n```\nIt's also worth noting this happens when there is no ~/.bundle/config adding further options. Here is the output of bundle config:\n```\nSettings are listed in order of priority. The top value will be used.\npath\nSet for your local app (/Users/brian/workspace/solidus_13_bundler_test/core/.bundle/config): \"vendor/bundle\"\ndisable_shared_gems\nSet for your local app (/Users/brian/workspace/solidus_13_bundler_test/core/.bundle/config): \"true\"\nmirror.https://rubygems.org/\nSet for your local app (/Users/brian/workspace/solidus_13_bundler_test/core/.bundle/config): \"http://localhost:9292\"\n```. Let's not worry about this any more. Bundler is crazy for now.. > I'm not sure we want the linter run at the beginning of each spec suite\nWe run Rubocop as part of the test suite, why wouldn't we lint the factories as well? I think the factories form the foundation upon which the test suite is built; if we don't maintain the factories, our test suite becomes difficult to maintain. I vote we run it as a breakable part of the build.. Thanks for the quick and positive feedback. There's still a lot more I'd like to do with these factories, but I think this is a good step forward.. I'm considering rebasing these changes into a single commit. I left them separate for the sake of review, but for the sake of history, I think they may belong all together. Thoughts?. Rebased into a single commit.. \ud83d\ude4f thank you for cleaning this up. This new PR does cause the same test failure as #1101:\n```\n  1) Spree::StockItem#after_save inventory_cache_threshold is set beginning above threshold count on hand stays above threshold\n     Failure/Error:\n       expect do\n         subject.set_count_on_hand(8)\n       end.not_to change { subject.variant.updated_at }\n   expected `subject.variant.updated_at` not to have changed, but did change from 2017-06-12 08:10:14.927710593 +0000 to 2017-06-12 08:10:14.927710000 +0000\n # ./spec/models/spree/stock_item_spec.rb:217:in `block (5 levels) in <top (required)>'\n\n. Like @peterberkenbosch [originally reported](https://github.com/solidusio/solidus/pull/1101#issuecomment-245590058), it's passing locally.. Also worth noting this raises a new depreciation warning:\nDEPRECATION WARNING: Locking a record with unpersisted changes is deprecated and will raise an exception in Rails 5.2. Use save to persist the changes, or reload to discard them explicitly. (called from set_count_on_hand at /Users/brian/workspace/solidus_master/core/app/models/spree/stock_item.rb:48)\n```. There are now a few of these warnings in core. See https://github.com/rails/rails/pull/25873 for details.\ncore/spec/models/spree/product_spec.rb:373\ncore/spec/models/spree/order_merger_spec.rb:150\ncore/spec/models/spree/variant_spec.rb:152\nI am unsure how to proceed because I believe we need to address the deprecation warnings generally and I cannot reproduce the CI test failure locally, even when running the full core suite with the same seed as CI.. > The local dummy test app uses sqlite as database, while CircleCI tests with posgresql.\nCould you remind me how to switch locally?\nAlso of note, I do not get the depreciation notice locally, which may suggest something else is dirtying the stock item's state outside the spec?. I was able to follow the README and use DB=postgresql bundle exec rake test_app.\nStill passes locally against latest master with same seed as CI.. > Also of note, I do not get the depreciation notice locally, which may suggest something else is dirtying the stock item's state outside the spec?\nI wanted to clarify this a bit. After adding this change, there are new deprecation warnings when the full core spec suite runs. However it's not stock_item_spec.rb that's causing the warnings as is the case with all the others; it's actually coming from core/spec/models/spree/stock/packer_spec.rb.. Upon further reflection, I don't believe I can stand behind this PR. When it comes to addressing DB lock issues, I want to be confident I can reproduce and eliminate the deadlocks via a load test. Haphazardly adding locks, as @mtomov rightly suggests, is not the right path.\nIdeas for new issues:\n Add automated load testing for the API to identify deadlocks and performance regressions\n Address DEPRECATION WARNING: Locking a record with unpersisted changes is deprecated and will raise an exception in Rails 5.2. that were seen in other parts of the test suite.\nPlease let me know if there is interest in the issues above.. Any data on test runtime changes using the in-memory postgres?. Can't see build timing:\n\n. \ud83d\udc9a specs for factories!.  > a class in a module in a class in a module\n\ud83d\ude06 . Hey @brchristian - you raise an interesting point. Thanks for the issue submission. It's great to see you still hacking on this stuff; I remember when we did a bit of work together for spree_tax_cloud a long time ago.\nAnyway, from my perspective, this issue is mostly one of semantics. From a certain perspective, for an order to be canceled, it must be complete. If you only want to find orders that are completed and not canceled, there is a by_state scope you can use to accomplish what you've suggested in your second proposal.\nAs for the issue with the Sales Report, I think that's a very reasonable fix that would deserve it's own issue and a PR would likely be very welcome.\nJust my two cents.. This is a nice idea John. I wanted to make a comment about date selection: let's make sure there is good time selection support too. In my store, we've added customizations to give admins better control over the exact time and date something might be scheduled to occur. Would be nice to know going forward that the UI library for this will be compatible with those customizations (or future Solidus features). One noteworthy feature I'd like to see in this area is good presentation of timezone data; I don't need the UI to let me change the timezone (although that would be nice), but I want to be confident that it's clear what timezone is being chosen. \u2764\ufe0f . While I think this migration is necessary to have effective testing, it will require most stores to take some downtime. If the community wants to proceed, perhaps it could be isolated into its own dedicated point release to ensure proper attention is paid.. Note we discard the options parameter when checking for the existence of multiple columns. I believe this is a reasonable compromise. What do you think?\n. Note that we drop the options here, although I suspect options would not be relevant in a multi-column index addition?\n. My initial reaction to writing a class for this was just like yours. It does have two benefits:\n- The public methods read very nicely.\n- Single column index additions get the options parameter passed along to column_exists?\nIf you feel this is too heavy weight for those benefits, I'll go back to the block-inside-conditional style like you've suggested.\n. An additional note suggesting the following is likely very thoughtful:\n\nIf you do not use Solidus Auth or you use Solidus Auth but do not use Solidus Frontend, you will need to restore order merging functionality yourself.\n. Should we consider memoizing this?\n. Some docs for this class and this method would be very welcome.\n. I believe some docs for this new public method would be helpful.\n. There is another method in this file which references desired_attributes: https://github.com/magiclabs/solidus/blob/b8d5bbaea0131abfbeb0c57d31dbe07b2a4a0cdf/core/app/models/spree/price.rb#L65\n\nDoes that need to be updated as well?\n. There is also this method using desired_attributes: https://github.com/magiclabs/solidus/blob/b8d5bbaea0131abfbeb0c57d31dbe07b2a4a0cdf/core/app/models/concerns/spree/default_price.rb#L15\n. Hi @Murph33 I'm sorry I haven't come back to this thread, but I still think this is an open question. Perhaps I misunderstood the nature of this change. Is this where order merging is done?\n. Thus, we need to update this changelog entry. Right?\n. We seem to have a convention of not putting factories under the same level of testing as other parts of the system. Is that an intentional choice? If we were fixing any other regression outside of factories, wouldn't we be adding more robust tests?\n. I would imagine tests are failing because of the lost call to update!. I do think there is room for improvement on how this is done though.\n. Will the use of this AR scope trigger unnecessary SQL calls and Ruby object instantiation? We already have these in memory, yes?\n. What's the included column on adjustment do?\n. Why is tap(&:update!) required here?\n. Although, there is no guidance in StemboltHQ/ruby-style-guide for these kinds of RSpec tests. At minimum, I would expect the spacing between expect { and change{ to be consistent.\n. I don't have strong opinions on this either way. Anyone else want ot chime in?\n. Not yet done, and likely won't be for some time. I'd welcome some help! Could you pitch in on those topics?\n. Given this comment (https://github.com/solidusio/solidus/pull/1086/files#diff-a9fae1594c22d1ec005ac8501d80d7afR356) and the importance of documenting these interfaces, could we add some more YARD docs to this method?\n. Should this be referencing :password_container instead?\n. Perhaps this change would merit an entry in the CHANGELOG?\n. If these two items are interchangeable, perhaps a migration to set that data on base_code would be helpful?\n. It's a bit unclear to me why this change is required. A more detailed commit message would be welcome.\n. Will this text ever be shown to a user?\n. Not sure we want this line in?\n. I think I might prefer to raise an exception here than this. I want consumers of this API to understand what's expected and not rely on magic.\n. Extra whitespace. Surprised hound didn't see this.\n. Additionally, I think this is an appropriate time to talk about preferring save! vs save. If we cannot persist an object when we intend to, I cannot see why wouldn't always want an exception. This localized the problem making debugging much easier. I would suggest that all save/update/create type active record persistence methods be replaced with their exception-raising equivalents.. I like how you chose to sort this by when the line item was created. Exactly how I would expect it to be sorted. \ud83d\udc4d . To access the store admin, visit localhost:3000/admin.. Prefer create! to ensure errors are raised in test setup.. Is the .to_d still required now that we're returning a Fixnum from amount_in_cents?. Can the originator here ever be something other than a payment? I assume so, and cause this will break.. The spacing here needs some help. Perhaps in a separate commit?. This is a great improvement, thank you!. Can we add a regression test for this guard?. What's the difference between additional_tax_total and included_tax_total? Perhaps link down to the lower section? Or does the more conceptual, introductory section \"Sales tax vs. Value-Added Tax\" belong higher up in this document?. I think the phrase \"net price\" merits further explanation. Does that include item-level adjustments? Order-level adjustments?. We probably shouldn't be giving out tax advice:\n\nFor instance, in Australia customers pay a Goods and Services Tax (GST). This is basically equivalent to VAT in Europe.. \"Solidus  supports\" extra space. I'd also like to see here a link to the open issue @jordan-brough is working on in https://github.com/solidusio/solidus/issues/1252 to suggest that there is more than one solution to this, and it is under active development.. I believe there are open issues which talk about adding more robust pricing management in the admin. Perhaps more links to those issues to suggest further active development?. ##Examples at the end of the line.. While I appreciate the effort here, you've previously mentioned everyone in the US should not use these mechanisms to collect taxes, and instead use Solidus Avatax. Adding these examples seems to contradict that.. I thought EU was VAT only? This example seems to contradict that?. This does not belong in this PR.. I just assumed since a polymorphic association is used, we should expect it possible that something other than a payment method be the originator. Maybe that should be changed to not be polymorphic?. _ stard_ looks like a typo?\n\nalso \"for validate\" might be better as \"for validating\". I agree this should be an update!. Also before merge, there is this question about my fixup commit in this PR: https://github.com/solidusio/solidus/pull/1658#issuecomment-269883417. I agree this is an improvement. Will fix.. @gmacdougall could you follow up here?. Fixed in a fixup commit 745cdcf9. I'm trying to backport this PR to Solidus 1.3 to help with an upgrade I'm working on. I needed to change tax_categories here to tax_category, but it seems taxes aren't being added to shipments in my backport. Any thoughts?. Using a factory would have avoided needing to fix this. Maybe we can start using a factory now?. ",
    "hhff": "Keen to follow along / help out here where possible - at least from a \"chatting things out\" perpective.  The Spree Ember Checkouts package is a promise aware state machine that wraps the current order.  Keen to do what I can to support the new approach!\nRelated: https://github.com/hhff/spree-ember/blob/master/packages/checkouts/app/services/checkouts.js \n. Hey guys!  Just wanted to chime in and say hi!  I built Spree Ember and have been chatting with @benmorganio about working to support solidus too.\nI originally built spree_ams, which inherits all logic from regular API controllers, but simply responds with AMS instead.  It's a very simple gem, but I think it's worth checking out.  I'd love to stay abrest of this and help out where possible :)\n. http://spree-ember.com that is\n. hectic\n. yeyah\n. :+1:\n. I would recommend using respond_with in the new action as well - for the sake of consistency.  If a developer needs to intercept / extend respond_with, etc\n. :+1: \n. While it's a long way off - I eventually want to support ember-cli backends with Spree Ember.  I've found most Rails devs grok Ember super quick.  Might make sense to go with something heavily conventional on the backend for such a large & complex OSS project\n. React is great of you only need Ember Components :trollface:\n. Jah - I actually like React a lot.  I've learnt a ton from it.\nIn my experience though, for a successful React build (I actually did a Spree storefront in React a while back), you need to sprinkle a lot more than \"just react\".  \n\"Just react\" actually encourages bad inter-app communication practices.  That's where Flux comes in to save the day! \nThat said, So once you've got React + React Router + Flux (and eventually Relay / GraphQL, plus some custom code thrown in to bolt it all together), your FE stack is looking almost identical to Ember + Ember Data.\nThe difference being that Ember + Ember Data is built to work together perfectly, has first class support for Rails, and if u squint your eyes, it almost looks like a Rails project.\nPlus, almost all Ember Addons are heavily tested, scored (partly on their test coverage),  can be added to a project with a single line install, and often provide Rails style Generators.\nOh and Ember CLI has a tooling built in.  No need to write a Grunt/Gulpfile.  Just ember new app then ember install ember-cli-sass then start coding.\nEmber Engines are not far off either.  I couldn't think of a \"more manageable\" way to build a robust frontend for something as complex as Spree.\nTLDR: React is almost always slower to build with, and certainly harder to manage complexity with.  It's definitely \"easier\" to grok for beginners though, and for sure easier to incorporate into an existing project.\n. :+1: no worries @athal7 !\n. :+1: @BenMorganIO \n. :+1: i was looking into this recently and was so surprised this doesn't exist\n. Ah, amazing and super extensible!!  Love it / can't wait :heart: \n. Here's a the \"ol' Spree way\" @amicheals https://github.com/spree-contrib/spree_digital\n. I used Foundation for spree-ember.com because it allowed us to write the frontend entirely in HTML, with Zero CSS files.\nWriting verbose HTML without zigzagging between CSS files makes building a customizable frontend super easy to maintain, easy for new developers to understand, and easy to swap out.  You can just do a find all and replace in your templates folder for your new grid frameworks' classnames.\nAlso want to drop a :+1: for a Framework on the backend.  The (awful) Spree 2.4 backend is the main reason I'm pushing Shopify on new clients, rather than Solidus.\n:heart: \n. word!  on it @tvdeyen :+1: \n. agree w/ @cbrunsdon - I think expandable sections will really help the admin feel \"less overwhelming\", which IMO is a bigger problem at the moment\n. solidus v1.1.1 fixed this for me\n. Thanks @jhawthorn - to use Stripe would I do:\npayment_method = Spree::PaymentMethod::StripeGateway.create! ?\nie - How do I refer to a specific gateway in the new format?\nAlso - as i understand it - that will only fix one of the deprecations.  How would I fix the others?. I still don't understand I'm sorry.  I'm using solidus_gateway: 1.2.0 which appears to be the latest release on Ruby Gems.\nHow do I create a Stripe Gateway in the new naming convention?. Hi All,\nNoticed 1.3 is up on ruby gems, so I thought I'd take another stab at getting these deprecation warnings out of my Tests!\nAfter updating, I'm having this same problem. This is the code change I'm making:\n```\ndef test_gateway\n    # -> From This\n    #payment_method = Spree::Gateway::StripeGateway.where(name: \"Credit Card\", active: true, auto_capture: true).first_or_create!\n# -> To This\npayment_method = Spree::PaymentMethod::CreditCard.where(name: \"Credit Card\", active: true, auto_capture: true).first_or_create!\n\n# No changes after this line\npayment_method.set_preference :secret_key, Rails.application.secrets[:stripe_secret_key]\npayment_method.set_preference :publishable_key, Rails.application.secrets[:stripe_publishable_key]\npayment_method.save\npayment_method\n\nend\n```\n```\n  1) Wallet::CreateOrderPayouts will create the appropriate wallet_entries\n     Failure/Error: payment_method.set_preference :secret_key, Rails.application.secrets[:stripe_secret_key]\n NoMethodError:\n   secret_key preference not defined\n # /Users/hhff/.rvm/gems/ruby-2.3.1/gems/solidus_core-2.4.2/lib/spree/preferences/preferable.rb:81:in `has_preference!'\n # /Users/hhff/.rvm/gems/ruby-2.3.1/gems/solidus_core-2.4.2/lib/spree/preferences/preferable.rb:60:in `set_preference'\n # ./spec/rails_helper.rb:120:in `test_gateway'\n\n```\nThe preferable module appears to not know about Stripe configs? I'm sure I'm not initializing the new payment_method correctly, but for the life of me can't figure out what I should be doing. Please advise!\nThank you! Solidus Rules!\n. Hmm - will take a closer look a bit later, but perhaps it's because we're\nusing OJ\ngem 'oj', '~> 3.3.5'\nOn Mon, Jan 8, 2018 at 5:40 PM John Hawthorn notifications@github.com\nwrote:\n\nI wasn't able to reproduce this, maybe I missed something.\nI added a spec to the orders_controller (which renders the same partials\nand is easier to test), and it rendered without error.\njhawthorn/solidus@5ae69a7\nhttps://github.com/jhawthorn/solidus/commit/5ae69a79cb4b4bad4756f9a6e0a06914d74eb99f\n\u2014\nYou are receiving this because you authored the thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/solidusio/solidus/issues/2486#issuecomment-356119755,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/ACu4_MYIB17ftX7n9KITE1Ya-10bN14Gks5tIplpgaJpZM4RTXJZ\n.\n. LGTM but i'd guess that in_stock? and potentially is_backorderable? also doesn't need to be serialized when we're not tracking inventory.  Just a thought!. these comments are my favorite part of this PR\n. \n",
    "chornodid": "@cbrunsdon Did you consider to add bundle id along with variant id in case of \"product bundle\" solution so that you can eliminate the problem with promotions (you can check at any moment if a bundle is entire or not)\n. ",
    "bsodmike": "Hey @cbrunsdon I'd like to look at this, once details are up :)\n. Thanks guys - might be a good idea going through an cleaning up all the 'shipment' references to subject; I'm komotose tonight, but I'll pick it up later on in the week if no one has gotten to it by then :)\n. @alexblackie @jhawthorn One regression test was removed earlier in Alex' work (https://github.com/solidusio/solidus/pull/433/files#diff-079dc32783aecdf3902b9cdb9f2bfd41L28); should this be removed? Another one https://github.com/solidusio/solidus/pull/433/files#diff-079dc32783aecdf3902b9cdb9f2bfd41R606.\n. I added subject but need to clean it up replacing all the shipment calls.\nWill do that in the morning if someone else doesn't beat me to it :D\nOn Thursday, 24 December 2015, Andrew Thal notifications@github.com wrote:\n\nIn core/spec/models/spree/shipment_spec.rb\nhttps://github.com/solidusio/solidus/pull/613#discussion_r48372446:\n\n@@ -1,8 +1,8 @@\n require 'spec_helper'\n require 'benchmark'\n-describe Spree::Shipment, :type => :model do\n-  let(:stock_location) { create(:stock_location) }\n  +describe Spree::Shipment, type: :model do\n-  subject { shipment }\n\nare we using subject somewhere? i am not able to find where\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/pull/613/files#r48372446.\n\n\n\nMike's on the move!\n. Sure, will push that up, thanks @athal7 :)\n. ",
    "hapax94": "Very interested in this feature, as many retail organizations needs a more stable and corporate-based categorization\n. ",
    "kennyadsl": "This issue was mainly created for using a different tool than RABL, and this has been done with #2147 .. @gmacdougall thanks, it seems like the build is green now! :green_apple: \n. @seand7565 yep, thanks for pointing out!. @jhawthorn @jordan-brough I made this commit with @DanielePalombo on a solidus fork branch. This solves splitting across multiple stock locations. \nAnyway I'm afraid this generates 2 ready packages, not identical, since with this logic what's inside the first package cannot be inside the second one. At a first look this makes Stock::Prioritizer and Stock::Adjuster useless. Stock::Prioritizer will just sort packages, but when it tries to adjust them removing duplicate inventory units across packages it will never perform any action.\nAlso, at the moment Stock::Prioritizer is not sorting anything.\nA couple of crazy ideas to solve this:\n- completely remove Stock::Prioritizer and Stock::Adjuster. With this commit I cannot find a scenario when they will be actually used.\n- when Stock::Coordinator build packages, it should give precedence to inventory units not yet allocated. I think this will solve even if I cannot be 100% sure it works in any possible scenario at the moment. This will create 2 packages, but not identical if there are other inventory units for the same variant which are not yet been taken into another package.\n- something like passing the unallocated inventory units to Prioritizer (probably we already have all inventory units there, so it could be easy to find unallocated ones). When it adjusts packages, it tries to substitute the removed inventory unit with an unallocated one if there are an unallocated inventory unit eligible for that package.\nI'd love to hear some feedback before trying to go in one of the above directions.\n. What about to also adding a preference for Reimbursement Mailer class, similar to Spree::CartonMailer ?\n. Closing in favor of:\n- #1144 \n- #1145 \n- #1146 \n- #1147 \n. @graygilmore for example in http://codepen.io/pen/ when you start typing the save button changes border-top. That's the action required.\n@Mandily great work. I like consistency but I also think that using colors to define positive/negative actions are generally a good thing. Maybe even giving more emphasis to the main action of the page could be a good idea? eg the edit button on an edit page is more relevant of the cancel or delete button?\n. I think it works @mandily \n. @jrochkind I'm not sure about this PR. I like the feature even if I'm not sure for which scenario this could be needed. Also, using something that can be both a boolean value and an hash as the preference value worries me a bit. I've left some comments on the PR anyway, waiting for some core member opinion.\n. @jrochkind I'm not sure about this PR. I like the feature even if I'm not sure for which scenario this could be needed. Also, using something that can be both a boolean value and an hash as the preference value worries me a bit. I've left some comments on the PR anyway, waiting for some core member opinion.\n. what about adding to Solidus a class that has the responsibility of choosing if an email has to be delivered or not? \nYou could extend this class in your own application and use it to choose if a specific email has to be delivered with your custom logic.\nSomething like:\n``` ruby\nin app_configuration\nemail_dispatcher_class = Spree::EmailDispatcher\nin spree/base_mailer\ndef should_send_mail?\n  Spree::Config.email_dispatcher_class.new(self.class).deliver?\nend\nin spree/email_dispatcher\nmodule Spree\n  class EmailDispatcher\n    def initialize(klass)\n      @klass = klass\n    end\ndef deliver?\n  # by default it just looks at the preference\n  Spree::Config[:send_core_emails]\nend\n\nend\nend\n```\nin your application you could do:\n``` ruby\nSpree::Config[:email_dispatcher_class] = YourEmailDispatcher\nclass YourEmailDispatcher < Spree::EmailDispatcher\n  def deliver?\n    # your custom logic here\n  end\nend\n```\nWhat I don't like of this approach is that we are passing the class of the current mailer to the Dispatcher (with Spree::Config.email_dispatcher_class.new(self.class)) even if we are not using it into the core. We are doing this only because we know that this could be useful extending the default behavior of the class. I honestly don't know if this is acceptable or can be improved.\nany other idea?\n. @peterberkenbosch we are working on a PR for this. It's in an internal review state so expect a PR soon. \ncc @DanielePalombo \n. Closing due to inactivity. @Mandily great work! I agree with @isaacfreeman on the need of a couple of real example at this point, just to make sure these options are valid and to start defining a \"guideline\" about how to choose which form layout is better for a specific form.\n. @tvdeyen Yes, squashing was needed even in my opinion. Now we have 5 commits, much better. Let me know if you guys think something else is needed here. \n. I'm working on this issue, for now I only made this commit. I'm not sure how to proceed in terms of validation. If there's no Spree::Price with the currency of the current order, the line item will have nil price. Is this something that could happen or we always have a price in each currency?\n. Hey @mamhoff , thanks for reading my commit. \nI think that check is done here and tested here. Anyway there's still something to fix there, probably also find better names for errors and validation method. What do you think? \n. @mamhoff thanks, I'll do changes in the direction proposed and go ahead with a PR asap.\n. @mamhoff please check progresses on #1507 \n. @jhawthorn done!\n. @mamhoff I can't find any reference about this convention in the codebase. Can you point me to something more specific please?\n. @mamhoff ah cool! I like this convention. IMHO scoping the key will also make it easier to understand the context to who will do the translation. I've made changes you proposed.\n. Thinking again, a downside of this approach could be that if that string is moved into another partial, we'll also need to change the translation keys, here and on solidus_i18n. Can this be acceptable?\n. @mamhoff please check again when you have time, thanks a lot!\n. @mtylty can you rebase now please?. I think it works the way it currently is. As far as I understood from the post you linked you don't have to pick the right version of the URL in the canonical tag, you should just pick one version and be consistent. Both /products and /products/ return 200 so they are equivalent. \nOk, which one is the most correct version? Since products#index is a collection route I think it's correct to have a canonical tag for this route with trailing slash, since it's like saying to search engines that this resource has something inside (products), like a directory. \n. @rsiddle as far as I understood they are evaluated differently if there's no a consistent (always same) canonical tag in those pages.\n. maybe it's just matter of setting an empty array here? \n. Thanks @DanielePalombo for fixing this!. Reopened since I think Solidus still need this endpoint. @aitbw I think also @loicginoux is working on it, please coordinate \ud83e\udd1d . @eoinkelly How do you want to implement this? I think we only should allow comparing Money objects that have the same currency with <=>.. It seems like an error with solidus_static_content gem. You probably have to install migrations from that gem since the error is saying that the spree_pages table does not exist.\nTry running:\nrails g spree_static_content:install\nrake db:migrate. \ud83d\udc4d . This seems to be related to #97. Looking at transfer to location code, when we remove the line item from order contents it also destroys all line item inventory units. Specs are passing because it uses an order factory that has a pending shipment state and probably, using auto-captured payments, will automatically move shipments into ready state, making not possible to transfer an item into another stock location.\nI think what we currently have is not the expected behavior, we should let users transfer content of a ready shipment into another stock location.. Honestly, I'm not sure if we'll have unexpected side effects allowing to destroy inventory units of ready shipments. Probably it's better to wait for someone else opinion/comment.. This has been closed with #1709 . Thanks @ericsaupe! Closing this one.. I've implemented a basic collapse menu system, basically it adds a label in the menu that changes the checkbox value that shows the full menu, same as what the hamburger menu (only visible if <= tablet) does.\nCollapsed\n\nOpen\n\nTablet\n\nThis PR still needs:\n\n[ ] understand if we can use bootstrap media queries, as @mtomov pointed out in a comment.\n[ ] cleanup details, there's some alignment that is not working in the menu\n[ ] understand if we can remove stiky-kit jQuery plugin and move to css position: sticky\n[ ] make menu collapsed/not collapsed based on the device width (now it always starts collapsed)\n[ ] remember users choice about collapsed menus on each device (probably we can make a separate PR)\n[ ] add meta tag <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n[ ] show a label for elements that don't have a submenu\n[ ] remove hover state (color) on hamburger menu on touch devices\n[ ] try to add a nice transition\n[ ] make it work (if possible) with pages that don't have thenew-layout body class \n. closing this one since lot of layout things has changed and after working on this I think we should use a different approach (more JS driven).. I'm ok updating the hash syntax to the new version but I think it should be done gradually to avoid losing a clear git history, which in this kind of projects is more important IMHO.. @brchristian that section would be awesome anyway in my opinion and I think that the style guide for new commits should be done just following rubocop rules. \n\nLet's wait for other feedbacks on this PR since I'm not 100% sure everyone agree on this topic.. @brchristian \ud83d\udc4d  if we'll keep it maybe it's better to squash them in a single commit. @jhawthorn I initially started writing something like this but wasn't sure about where is the best place to put it and if it's really useful:\n```ruby\ncore/spec/controllers/filtered_parameters_spec.rb\nrequire 'spec_helper'\nRSpec.describe ApplicationController, type: :controller do\n  controller do\n    def index\n      head :ok\n    end\n  end\ndescribe \"Passing sensitive parameters\" do\n    subject { request.filtered_parameters }\nit \"filters correctly\" do\n  get :index, params: {\n    password: 'secret password',\n    password_confirmation: 'secret password confirmation',\n    number: 'secret credit card number',\n    verification_value: 'secret verification value',\n    name: 'something not secret',\n    number_eq: 'R123456789',\n    payment_number_eq: '123',\n    answer_number: '42'\n  }\n\n  expect(subject[\"password\"]).to eq '[FILTERED]'\n  expect(subject[\"password_confirmation\"]).to eq '[FILTERED]'\n  expect(subject[\"number\"]).to eq '[FILTERED]'\n  expect(subject[\"verification_value\"]).to eq '[FILTERED]'\n  expect(subject[\"verification_value\"]).to eq '[FILTERED]'\n\n  expect(subject[\"name\"]).not_to eq '[FILTERED]'\n  expect(subject[\"number_eq\"]).not_to eq '[FILTERED]'\n  expect(subject[\"number_eq\"]).not_to eq '[FILTERED]'\n  expect(subject[\"answer_number\"]).not_to eq '[FILTERED]'\nend\n\nend\nend\n```\nI used an anonymous controller that inherits from ApplicationController since this test is not related to a specific controller; the configuration will be valid for the whole application. \nMy concern is that, if one day we'll change filtered_parameters configuration in frontend or backend engines this test will still be green. A possible solution could be duplicate this test in all engines that need parameters filtering. What do you think about it?. @webuilder240 thanks for your contribution, can you please explain which issue this PR should solve and why this code will fix it?. Talking with @mamhoff he convinced me that the current version is good enough to be merged. Having promo codes with spaces inside is not a documented feature so we should not care that much about it. . This can be closed since we merged this via #2264, thanks @gitmihalis !. Closing since there's no more activity here and probably this is not a feature needed by lot of solidus users. If we need it later we'll certainly keep this code as a starting point and as a reference about potential issues, especially with distinct: true in admin promotions controller.. @Draiken it seems like there's no price retrieved for that specific variant. Can you please check?\nAnyway that code is much more solid on newer versions. Is it possible to update solidus to 2.1.0 for you?. What about adding here something like this:\nruby\ncurrent_order.assign_default_addresses! if current_order.has_checkout_step?(:address)\nMaybe the only downside is that having this assignment in two places (and one of them is an external extension) it will be harder to debug and understand what happens in case of errors.\ncc @mtomov \nUpdate\nmaybe also here?\n. Probably @aaronrussell solution is better than mine since it does not require to change external extensions and will work no matter which controller will intercept/redirect to the checkout.\n@mtomov Are you suggesting to move the order.assign_default_addresses! call from the state machine logic to the set_current_order method at controller level instead of duplicating it? I'd be less confident doing that because probably we'll lose that behavior (using an old user address) if the order is placed via API or programmatically, right?. I'm on this one!. @Perkir Hello, what do you mean with \"Display Order not work\"? Can you please post steps to reproduce this issue or at least a screenshot. \nAlso, in the code you are linking to the admin products page but with the \"Orders\" label, maybe you want to use Spree::Product instead?. Can you please share which language (with solidus_i18n) and which solidus version are you using?. Closing this one since most of its content has been moved/handled into other PRs (#1822 and #2127). @ericsaupe should be closed with #3059, can you please check?. @gaurav945 there's another endpoint to complete the order via API. Is there anything that denies you to use that one? I think that the logic to check if current state is confirm is supposed to be placed where the API is consumed.. @gaurav945 don't you worry, I'm happy to be of help! . Hi @AndreiMotinga, can you please refer to this guide when posting issues? It will help other people understand your problem and help you, thanks!. This has been done! Thanks @benjaminwil for your work here.. Great solution! We can even implement methods to remove items/sections that can be useful into stores/extension.\n\nI'm not sure it's worth it vs specifying controllers.\n\nWhat about implementing a \"simple\" finder by controller to find the active item and section?\nruby\nclass Item\n  # ...\n  def controller\n    @controller ||= Rails.application.routes.recognize_path(url).fetch(:controller)\n  end\nend\nand somewhere in controllers land:\n```ruby\ndef admin_menu\n  @admin_menu_handle = Spree::Backend::Config.menu.items.find do |item| \n    item.controller == current_controller\n  end\n# for this to work we'll probably need to pass section to items\n  @admin_menu_section = @admin_menu_handle.section\nend\n```\nOf course this is just a raw idea, I'm not sure this can work. Anyway this way we can maybe avoid adding both controllers list and view verbosity?\n. This has been done and already in Solidus since 2.4, closing now.. I'd remove those permalink finders methods fromcore/lib/spree/core/permalinks.rb if we are not using them or they can be replaced with Model.permalink_field using the default find_by! method.. Hey there, I'm not sure this kind of state change is allowed via current API, anyway you could try to workaround this by using the /orders/ endpoint. You can even try to build your own endpoint in the api/checkout controller that does the same as update but without triggering the order.next call. . what about going one step back, for example moving to address if you have to go to address + 1 (delivery)? I think it's better moving this conversation on solidus slack #support channel, ok?. @andrewkmin I usually check the API key via rails console, something like:\nruby\nSpree::User.find_by_email('admin@example.com').try(:spree_api_key)\nWe probably have to restore the ability to view the API key in admin or remove the generate key button.\n. @andrewkmin it can be helpful to perform API calls that require authentication. Take a look at the base api controller here. Passing that headers along with each request you'll be able to create/update stuff or view admin restricted resources.\nThe order token is useful to allow managing the order to guest users that do not have any key yet, so it is often what you need to implement checkouts/cart interaction in js applications.. @acreilly hey there! I'm taking a look at this PR. There are some changes requested by @tvdeyen still to be done, especially the one about keeping fields if you are that user, since at the moment the UX generated with this PR is not ideal:\n\nas an Admin I need to change my password\nI visit my user page in admin\nI send the reset password link to myself\nI click on the link in the email\nI'm redirected to the homepage without any message and I can't change my password\n\nThis happens because to perform the reset it's required not to be authenticated:\ntext\nRedirected to http://localhost:3000/\nFilter chain halted as :require_no_authentication rendered or redirected\nCompleted 302 Found in 6ms (ActiveRecord: 0.6ms)\nHaving the old password fields there for current users could be a solution for this problem.\nAlso, I think this needs a rebase. If you want or do not have time I can continue this PR with what's missing. . @mamhoff done!. rebased again due to another conflict with the CHANGELOG. This can be closed after #2917. \n\n\nBonus points if we can add a character counter to the description. If we can do this, we can get rid of the text and just write [number of characters used}/[max number of characters] (ie 0/255)\n\n\nis still to be implemented but I think it won't be done for now.. @jhawthorn @mamhoff this is not going to change any value on a GET request. It just sets the address without saving.. @brchristian Hi there, which solidus version are you using? I think this is fixed with this commit. \nWhen @request.headers['HTTP_SPREE_STORE'] or @request.env['SERVER_NAME'] are not set only the default store query (last one) should be done.. @brchristian I think the last commit you posted is not reverting the one I linked but it is just removing the deprecation previously set.\nAs far as I can see this is the code you are using:\n```ruby\n      def store\n        if store_key\n          Spree::Store.current(store_key)\n        else\n          Spree::Store.default\n        end\n      end\n  private\n\n  def store_key\n    @request.headers['HTTP_SPREE_STORE'] || @request.env['SERVER_NAME']\n  end\n\n```\nSo if store_key is nil (no @request.headers['HTTP_SPREE_STORE'] or @request.env['SERVER_NAME'] set) it should just make the default store query.\nAnyway I'm going to do some more testing on a clean solidus app and see if I find those queries and they are coming from other places in the code. Will keep you posted!. @brchristian I think that moving that code out of core (in solidus_multi_domain as you suggested) is the best way to go. I've just opened a PR (#1993) with initial steps for having it done. Let's see what others think about it and I'll proceed with the rest of the needed PRs.. Steps to fix this issue:\n\n[x] make it more standard/easier to use another class to determine which store to use #1993\n[ ] move out of core the logic that checks requests info to determine if another store has to be used. This will be moved to solidus_multi_domain. (solidusio/solidus_multi_domain#67)\n[ ] just use the Spree::Store.default on a solidus store without solidus_multi_domain avoiding multiple queries for each request (#2022).. Yes, thanks @aitbw !. This is interesting but we still have no clear ideas about how to proceed here and what's the best way to lint factories inside the spec suite runs. Talking IRL with @AlessioRocco about moving this commit (138d6561ff16dfac42bffd1cdd49bf9b4942a9d7) into a new PR which fixes the stock_transfer factory if called multiple times.. Nice find. I agree this is a problem and would be fixed with your proposed solution, thanks!. duplicate of #1991 ? Can this be closed?. @skukx this is a very good and well documented change. Anyway, talking with other core team members we decided to avoid introducing this code. The benefits it brings in are not enough to justify metaprogramming methods and the drawbacks that can be introduced from this. Thanks anyway!. @mamhoff sure, done!. Closing this PR since there's a new up to date PR (#2187) which seems to be close to a final solution.. Maybe we can leave relaxed ruby styles config at the bottom (I agree it's better to keep them separate to allow easy replacement if needed) and group only our rules? Does it make sense?. @oeN also, I think that if you rebase against master the test suite failure will disappear, thanks!. Since the direction is to gradually deprecate solidus_multi_domain, I'm going to change this PR trying to pull stuff from that extension into core instead of the opposite. I'll update this soon!. Closing this one in favor of #2041 which is a better solution.. @mtomov thanks for your feedback! I initially thought the same thing and I was surprised that buttons do not have cursor: pointer class by default. Maybe there are buttons where this is not needed? Anyway I moved my steps in this direction (using an anchor) mainly to uniform the markup between all the other similar buttons, like here. I agree with you about the better semantic using a button, even if that's not a real form since the action is performed only via js and I don't think that page will work without it.\n\n. I read that article before doing this PR but I don't fully agree with the author. Like a lot of comments do, I also think that it's more important to focus on user expectations. \nI think that Microsoft and Apple resources linked refer to Desktop application, which maybe is a bit different from a web application. w3c takes a strong position in favor of not using pointer cursors for elements that are not links.\nAnyway I'm starting to feel that this discussion is too much general and would require a separate issue for discussion. If we decide to go with removing pointer from buttons (and other elements that are not links) we probably have to change a lot of stuff in both backend and frontend markup/style. . Updated the PR so that we now have <button> elements instead of <a> for shipment/shipment manifest views and js templates, which is semantically better for everyone. The pointer cursor is added via css to all buttons inside a table td.actions.. Also, from Rails 4+ that update! method on Spree::Shipment  is overriding the ActiveRecord update! method and I don't think it has been done intentionally. \nP.S. We probably have the same problem on Spree::Order. @sechix hello! If tax amount is included in price you have to calculate taxes starting from the price without tax. In this case it is: 20.66 (+ 4.34 = 25.00), right?\nI think the same applies to shipping.\nFor the duplicated variants maybe it's better to open another issue with some more information, like steps to reproduce it so we can try the same locally on a clean Solidus app.\n. I think we should just put a flash message that inform the user that the order is not editable.. > If possible I think it would be just easier to exclude the edit action from resources :orders. What do you think about this approach?\nIt makes sense for me. \ud83d\udc4d  \nI think that route is there since there are stores that allow changing orders info after purchase but they can just add that route back and customize Spree::OrdersController#edit. \n. @dangerdogz I think ffaker is still needed as dependency since it is used to build sample data which could even be run in production.. @cbrunsdon also, there's another PR ( #1956 ) for this same task.. @tvdeyen yes! Didn't noticed that PR. I noticed that when invalidate_old_payments is called, order.payments doesn't contain the newly created payment. It could not be an issue since we want to invalidate only old payments but it can cause issues in other places maybe, what do you think?\nGoing to close this one anyway!. I like this change, the interface looks more clean and professional in my opinion.. Yes, I think you are right. I was looking at the touch: true into the association between shipment and inventory unit but your intuition seems to be the right way. I think we also need to pass the shipment when building that InventoryUnit. I'm not sure if the shipment should be the same as the current inventory_unit though.. This seems a good approach. A couple of thoughts:\n\nhow will we handle Spree::Refund reason, which has to be present when the refund is created?\nmaybe it's better to call the method void_or_refund or something like that? Since try_void will also create a refund in some case it could be better to be explicit.\nwe can maybe create a (configurable) class that handle this voiding logic so it is easily customizable into stores. try_void will just call this class.. @ccarruitero thanks for your contribution. What exactly this PR is fixing? Can you please post a more accurate description?. Fantastic work @graygilmore! \n\nI just noticed a little issue when changing a checkbox input and trying to restore original form data:\n\nI suppose it is because $input.val(originalValue) could not change checkbox value.\nWaiting your feedback on this issue before approving. \ud83d\udc4d . Closed with #2798, thanks a lot @jtapia !. I don't know, I'm not against this but I have some concerns about how much difficult/long it would be to extend solidus in case a store needs to add some editable field into countries/states. For example options specific for country that would need a custom field editable by admin into the country edit form. I know we have other resources that do not have an admin UI but I have the feeling that countries/states are more used.\nI understand the concern about making some of those fields not editable though. What about just disable critical fields in the form?\nOf course if our plan is to migrate to Carmen in the future this makes perfect sense.. @graygilmore we discussed about this one in the core team meeting. We'd go with removing this, including listing, from core for several reasons:\n\nSolidus will slowly move towards Carmen. It also allow better countries/states I18n;\nThe only country's attribute that could be safely changed is states_required. It is usually a \"dev thing\" and it can easily be done via console;\n\nWe plan to move this backend functionalities to a separate extension so it can be added back to stores that need those easily.\nThanks!. @graygilmore I've created an extension (solidusio-contrib/solidus_countries_backend) that should have all the countries/states UI code. It currently points to this PR repo/branch to run specs against Solidus without this code.. @graygilmore there's a couple of feature specs failures, due to Locations -> Zones I18n key rename.. The failure is not related, rebasing against master should fix it, Thanks!. Also, I'd mention the replacement extension (solidusio-contrib/solidus_countries_backend) in both commit message and PR description so that it's super easy to find it if needed, wdyt?. I don't know this topic very well but I'm curious why we didn't used the Rails class_attribute here. It should also have a default option now. . I'd still add some capybara specs since there's a some JS behaviors which is untested at the moment.. Sure \ud83d\udc4d I suggested to have some capybara specs just to have a bell ringing if feature stops working, but if it's just me I'm totally fine merging this PR. We can even add these specs later if something will break in the future.. Closing in favor of #2809 . Thanks for reporting.\nI can confirm this issue, even if I'm still not sure this is not the expected behavior. \nYour JS proposal would not work if another user completes a purchase of the same product just before another user adds the product to the cart, right? I think that if we need to stop allowing users to add products with insufficient stocks to cart we need to implement some backend validation logic first. Also, IMO critical frontend functionalities should work without JS active on the page.\nSomething like this on Spree::LineItem should work:\n```ruby\nvalidate :check_insufficient_stocks\ndef check_insufficient_stocks\n  unless Stock::Quantifier.new(variant).can_supply? quantity\n    errors.add(:quantity, \"is not available\")\n  end\nend\n```\nbut at the moment I'm not sure about drawbacks this can have on the rest of the code.\nLet's wait for someone else feedback on if it is a bug or not.. I think this happens because apply_coupon_code happens before setup_for_current_state. If there are errors applying coupon code the edit action is rendered with a return. This wont make setup for checkout state to happen so existing wallet payments are not set.\n. This is fixed since #2327 has been merged. Just an update on this PR: I cleaned up everything following @gmacdougall suggestions. Anyway the core of the fix is still something that needs to be addressed. Talking with the rest of the core team we decided to:\n\ndeprecate this apply_coupon_code callback to apply coupon code  \nuse a separate controller which will handle, with a specific request the coupon code application\n. closing in favor of #2327 . This can be closed, I just tried on a new Solidus version and it works as expected.. @ccarruitero Can you please rebase this?. @ccarruitero ping \ud83d\ude42 . For the validation argument, we also have specs for factories.. @tvdeyen good catch! I also found another PR (#1821) that adds other thoughts to this topic. I'm going to remove my approval since I feel like I need to revisit this changes better.. It should also probably take into account $product_price_text_color now.. @tvdeyen Great! We don't need to take into account smaller screen versions for now right?. I actually just found an issue with elements inside the .content-wrapper that has a z-index applied, like datepicker:\n\n\nIf I got it correctly, even if we respect the stacking order and give more priority to an element pushing it at the end of the list there could be other child elements inside previous elements with z-index (new stacking context) that would take precedence in display order.\nI made a little codepen to simplify the situation: https://codepen.io/kennyadsl/pen/vepxwO\n. This just needed someone to press the button, sorry again for taking so long to merge!. @rbngzlv Can you please rebase? No more Spree.t(:key) in favor of I18n.t('spree.key'). @tvdeyen I generally agree with not using extra spaces for indentation (I'm also in favor of commas in last element of arrays and hashes to preserve git history). In this case I'd go with being consistent with the rest of the file, since I can't see an easy solution for the current state of the file: I don't think we'll change that file so often to bring it into an ideal indentation state and probably it will be completely changed in the future instead. \nOf course this is a non blocking comment and I'm perfectly fine with the current indentation. \ud83d\udc4d . Hello! It would be great if you could explain better which problem this PR will solve, and maybe post some screenshot of the result so it is immediately clear to everyone. \nThanks for your contribution!. Thanks!. @tvdeyen sure, I'll fix and rebase after we merge #2690 so we can test it on the CI with both versions.. @tvdeyen changes requested done!. @gmacdougall can you please review again now?. @DanielePalombo since it's so old, can you please rebase against latest master? Thanks!. Thinking twice, it's probably better to redirect to the :edit route, as we did in backend products controller.. The thing I was thinking at is that by only removing the :show route we still have a 404 error (instead of the current AbstractController::ActionNotFound), which does not solve the case someone reaches that page. With the redirect in controller instead we wont have any error.. @vladstoick thanks!. @jhawthorn Thanks for your feedback. Another approach could be using MutationObserver to understand when childList of that tr changes. When this happens we could remove action- classes from that element:\n```js\n  $('table').on(\"mouseenter\", 'td.actions a, td.actions button', function(){\n    var tr = $(this).closest('tr');\n    var klass = 'highlight action-' + $(this).data('action')\n    tr.addClass(klass)\n    tr.prev().addClass('before-' + klass);\nremovalObserver = new MutationObserver(function(mutations) {\n  // disconnect itself when content is changed, a new observer will\n  // be attached to this tr by the new mouseenter event on the new\n  // element rendered by the template.\n  this.disconnect();\n\n  // remove '.highlight' and '.action'- classes related to this mouseenter event\n  tr.removeClass(klass);\n});\nremovalObserver.observe(tr.get(0), { childList: true, attributes: false });\n\n});\n```\nI like this approach because code related to this behavior is contained into code that defines it, so we don't have to add code into other js files (like I did in current commit). Also this should fix this issue everywhere it is present.\nThe only thing that I'm not able to do at the moment is disconnecting the MutationObserer attached to the tr on mouseleave.  If you like this approach I can try to find a solution.\n. I've updated the PR using MutationObserver, much better now in my opinion! \n@jhawthorn thanks for the suggestion of moving the mouseleave event binding into the mouseenter callback, so we have the instance of the MutationObserver available.. @krtschmr can you please post more information about what have you done and your Gemfile content in order to reproduce the issue?. ok, can we close this?. It should work, can you be more specific about what is not working and the code you are using?. Closing this one since all code here has already been merged in master with #2374 . Closed with #3059 . ~@alepore maybe related to #2331?~ No, they are not related, sorry!. Great, I was thinking at what should I do if I need to show just one preference hash or array field, for example because I know it's safe in that point and I want admin to be able to change only that. Is this a scenario we want to support?. > Great, I was thinking at what should I do if I need to show just one preference hash or array field, for example because I know it's safe in that point and I want admin to be able to change only that. Is this a scenario we want to support?\nOk, ignore it. I figured out I can just render another input in the view for that field outside the preferences partials code, so there's no need to support that in core.. Closed with #3059. There's a conflict to be fixed, anyway I'm good with this change, thanks!. @tvdeyen rebased and ready for a second review!. I think I'll go with fixing this at a model level if everyone agrees it's preferable, thanks for the feedback!. After talking with @gmacdougall we agreed that it's better to whitelist the accepted methods here. As a next step it will probably make sense to try to refactor the logic that required this fire action to exist.. The only possible event is cancel! so it does not make a lot of sense having this metaprogrammed stuff in there just for that. \nAs next iteration we could remove this fire action and create another controller that is responsible just for canceling return authorization instead.. I'm not sure all attributes inside the MASTER_ATTRIBUTES array should have a setter. For example the 2 duplicated attributes do not seem to have setters method. Maybe it's better to remove stuff from the MASTER_ATTRIBUTES array if not needed.. Yes, I think it's better at a first look, even if I honestly didn't investigate deeply. \nI think we don't have display_amount= and display_price= on Spree::Variant (or somewhere else) so it's probably better to do not delegate them, you can test this by trying to assign for example a display_price to a variant:\n```ruby\nrails console\n\nSpree::Product.first.display_price = 12\nNoMethodError: undefined method `display_price=' for #\n```\n\nThey are not technically attributes, so I think it's better to have them in the delegate below, which just delegate the method without the method_name= part.\nAlong with those two methods, I think we can remove other elements from that list, but maybe we can do that in another PR?\nSorry for not being clear on my first comment and thanks for your contribution.\n. I've found something about those spec failures:\nUsing ActiveRecord::Relation#cache_key produce cache keys for our products search similar to\nquery-9a8681e154ac694950cb63b934444259-2-20180328191149899341/695d3742aae7eec904440fe5dfbf1300\n\n9a8681e154ac694950cb63b934444259 is the digest (MD5) of the query so it changes every time the query changes\n2 is the size of the collection\n20180328191149899341/695d3742aae7eec904440fe5dfbf1300 is timestamp of the most recently updated record in the collection.\n\nSpecs fail because the first part is different in each query to retrieve products. This is the content of cache_writes when specs fail:\ntext\n{:controller=>\"home\", :action=>\"index\", :key=>\"views/en/USD/spree/products/all--spree/products/query-9a8681e154ac694950cb63b934444259-2-20180328191149899341/695d3742aae7eec904440fe5dfbf1300\"}, \n{:controller=>\"home\", :action=>\"index\", :key=>\"views/en/USD/spree/products/all--spree/products/query-c8672fcf8f2cb4d058f7f3f08a9dace2-2-20180328191149899341/695d3742aae7eec904440fe5dfbf1300\"}\nI looked in depth at both queries and it looks like they are actually different. The difference is into this piece:\ntext\n(\"spree_products\".available_on <= '2018-03-30 08:43:59.215588')\nwhich is generated by the available scope that we use in our searcher base scope. That query uses Time.current so ActiveRecord is right thinking that he needs to generate the query again. \nActually it's something we are not taking into account when generating the cache key for products on Solidus. If a product \"expires\" it will be visibile in the products list until the cache key expires.\nI'll continue to think at a solution for this. Any suggestion is welcome!\n. Overriding Spree::Product.collection_cache_key fixes specs. But we loose the query signature functionality provided by ActiveRecord. Anyway for that kind of query I think we cannot use the query digest since it contains the Time.now part and it's different every time.\nSomething like this lets the specs pass:\n```ruby\ncore/app/models/spree/product.rb\ndef self.collection_cache_key(collection = all, timestamp_column = :updated_at)\n  count = collection.count\n  max_updated_at = (collection.maximum(:updated_at) || Date.today).to_s(:number)\n  \"#{collection.model_name.cache_key}/#{count}-#{max_updated_at}\"\nend\n```\nI know it's basically the same as it was before but moving this logic into the model and using the standard rails way (.cache_key on ActiveRecord::Relation) is a good thing.. @Sciyguy any update on this one? Where do you see that solidus needs sl-SI key for slovenian translations?. Closing due to inactivity, thanks anyway!. @hhff Spree::Gateway::StripeGateway.new/create should work. 1.2.0 is quite old (released on July 24, 2017), for now the new code is only on github master.. I think we can just resume https://github.com/solidusio/solidus/pull/2673 and address latest change requests. . @jtapia Hey I think this is a great change, can you please rebase against master?. Thanks @softr8 !!. Do you mean in frontend checkout, address step?. Thanks for your contribution!. Thanks for reporting these UX thoughts, I agree we need to find a better solution for this problem.\nI think it really depends on the information that the admins have when they need to fill this field. For example they could have some internal stock management software that tells the final number of current stocks for a specific product, already taking into account backordered items. In this case they would do the math. \n. Thanks @tvdeyen! . @DanielAmah please do it!. I'm preparing a PR on solidus_i18n to remove that feature.. All your doubts are justified. I think that simply, when we added the OrderUpdateAttributes, we  didn't considered all these things.\nI think that the real difference is that in the Api::CheckoutController it works because there are other things that recalculate the order later (probably the next call). Also, checkout and orders api controllers are thought to make difference things, otherwise one of them could potentially be useless.\nI think it's safe to use the same code that we used in the Api::OrderController.update and in the frontend orders controller update action.\nI'll talk about this with the core team today, thanks for reporting your doubts.\n. In another PR we could remove this mutable thing, if it's just used to do not allow admin to change its name (since it has to be the same of the constant defined here) in favor of a default boolean on the refund reason table. WDYT?\n. Have you considered splitting the shipment to reflect the partial shipments made?. Sorry, I can't get if shipping only part of the shipment without splitting is possible using solidus default functionalities or it is something you implemented in your store?. Sure, now I got it, thanks for the detailed background of this PR. \nYou are right, this is the scenario carton was made for, thanks for pointing out the issue.\nA question: when you hit the ship button on an already partially shipped shipment, will solidus only ship the rest of the shipping correctly understanding what has already been shipped, or do you need extra code to make it work? . Ok, shipping the rest of the order programmatically makes sense, but it should work without any code even via Admin UI since here it ships only shippable inventory units, which should filter out what you previously shipped.. I've made #2622 with what I've found, I think it's better to discuss there before changing other code to be sure we are going in the right direction and we are not missing anything. Thanks again!. John already did that in #2634, we can close the first PR!. @aitbw this is not ideal. What would we need to update in order to use other currencies?. Hello there! GraphQL is not part of the roadmap yet but I think it would be a great extension for Solidus. \nI'd really like the idea to have a GraphQL API and I think that its flexibility would be perfect for this kind of platform. I'm interested in working on this! Feel free to contact me on the Solidus Slack channel!. I confirm the bug on master sandbox. I'm trying to create a spec to reproduce the issue but still can't do that, it seems like our specs on that are correctly creating the creditable object.. This can be closed with #2802 . If you rebase against master now the Mysql specs failure should go away. It's not clear why it's needed to update those taxons icon sizes honestly. Can you please explain better?. reopened in #3038 . @benjaminwil do you think it's ok now?. reopened in #3039. reopened in #3040 . reopened in #3041 . Hello @spaghetticode, if I recall correctly the reason behind this implementation is related with how the checkout works:\n\non the payment step it makes an authorization payment without capturing any amount, this creates the fake payment and stores all the information about the payment source (which will allow user to capture the payment later without readding the credit card information)\non the confirm step it actually makes the payment using the source from the payment previously authorized, this is why that payment is needed.\n\nDespite the process in not intuitive and it can probably be improved, storing the first null payment in terms of logging could also be useful to understand where payment issues are.\nLet us know if this makes sense!\n. @jacobherrington I've opened #2802 to complete this one, I think we can close this. . Closing this since this should be changed in the auth system as done in solidus_auth_devise, as suggested in the related PR.. It makes sense but we should find a way to handle duplication of routes/controllers/views for users that will update solidus but not solidus_auth_devise, where we should also remove those files if they are already here. We should conditionally avoid including those files in some way? maybe Solidus version number?. Also, we are thinking about moving all the controllers/views/helpers from solidus_auth_devise into core, keeping solidus_auth_devise as solely an authentication system, so it's better to wait until we finalize this decision. Any thought is welcome.. By merging this PR stores will end up having the same route/action/view defined in both solidus_frontend and solidus_auth_devise. Do you see a possible solution to this? . Sure, I'm thinking that if a user upgrades to latest Solidus (that will include code from solidus_auth_devise) he will have the same code defined in both solidus and solidus_auth_devise. If we want to change something in core I'm afraid some changes (like changes on views) could not be doable since they will be overridden from the same files in the extension since they should be loaded later, right?. @spaghetticode your proposed solution makes sense but no one can ensure us that user will update solidus_auth_devise after the Solidus update. \nWe should think at least to some warning or suggestion into the changelog entry that asks users to update solidus_auth_devise along with solidus. If we go in this direction, I'd prefer to ask/force Solidus users to update solidus_auth_devise once, by moving all the code unrelated to authentication from solidus_auth_devise to solidus in a single version release. \n. Pending means that the shipment can't be shipped since the payment has not been captured yet. When you'll capture the payment the shipment will move in ready state and you'll see a Ship button on it.. I think it's much better now, can you please remove the following commits:\n\nCreate i18n string for \"Available On\" placeholder\nAdd placeholder for \"Available On\" field\n\nwhich are now useless?\nAlso this one Explicitly set placeholder colors for inputs should probably be part of another PR, if still useful. Thanks!. What about also updating the description of this PR with instructions?\nIt should be:\ntext\ncd guides \nyarn install\nyarn run vuepress dev .. I think it's solidus_stripe responsibility to create this file. Can you open this same issue there as well please?. I merged a PR on guides (#2742) \ud83d\ude2c . Can you please rebase against master?. We discussed this issue in the core team meeting, and we think that this scenario is basically not realistic. We think that no business could ever create this kind of cumulative promotions, isn't it? \nDespite we know that technically this could happen, in this case it's more like an issue in how you set promotions up for your store and we think that for now the best trade-off between patching complex code, working around the issue as for (#2769) and do something here is to just raise an exception when calculating total, if it's less than 0. Stores that want to ignore this scenario can just ignore it while other store can rescue the exception and print an error message to the user.\n@jacobherrington again, thanks for your contribution, we really appreciate the effort, if you'd like to take this task it would be great!. @denis-mueller I think it's an issue with the discard gem, and I've opened an issue there. Let's see what's the best way to move forward on this and thanks for pointing out the issue.. For now, if you want to remove the warning, you can do something like:\nproduct.master.prices.discard_all\nproduct.master.prices = [\n  create(:price, amount: 4, currency: 'CHF'),\n  create(:price, amount: 5, currency: 'EUR')\n]\nLet me know if this works!. Hey there, sorry for being late in answering and thanks for your thoughts and work on this topic. \nI have a quite strong opinion against introducing another grid along with the basic frontend template provided. The reason is that what we are providing is just a template that the majority of Solidus users just uses as reference to start building their own frontend. Using one framework or another is a choice that developers should make based on the design they need to implement, so in terms of grid framework in my opinion Skeleton and Boostrap are equivalent since they'll be replaced. We'd just replace unsemantic class names with other unsemantic class names that developer will need to change. Skeleton is here just because this choice was made a lot of time ago when the idea of changing/extending Solidus (Spree at that time) frontend instead of totally replacing it was something real. Honestly I can't see any advantage just changing grid framework at this point.\nMy proposal:\nWhat I'd say is a change useful to the project is replacing unsemantic class names for grids (or any other) with something that is rich of meaning and could both self-document code and provide an html structure that could be taken as is when a custom frontends are implemented.\nFor example, instead of:\nhtml\n<div id=\"content\" class=\"columns <%= !content_for?(:sidebar) ? \"sixteen\" : \"twelve omega\" %>\" data-hook>\n  <!-- ... -->\n</div>\nHaving something like:\nhtml\n<div id=\"content\" class=\"<%= !content_for?(:sidebar) ? \"content-without-sidebar\" : \"content-with-sidebar\" %>\" data-hook>\n  <!-- ... -->\n</div>\nAt this point we could move all grid sizing information into the scss, separating markup from its style. In this way Solidus html will not depend anymore from a specific framework, it's self-documented without any specific knowledge and can also be easily copy-pasted into developers projects without too much changes. \nTo move grid sizing information into the scss as mentioned above, Boostrap 4 already provides such scss mixins.\nI look forward to read your opinion on this and thanks again.\n. Still not convinced! \ud83d\ude42\nWhat's the scenario when you, as a developer building your frontend taking Solidus views as a template, could benefit from this grid change? \nFirst of all I want to specify that I totally agree that Bootstrap grid is better than the Skeleton grid.\nMy concern is more with changing what we have in favor of a non-optimal solution: we'd risk to break frontend views of people that used the Solidus frontend without overriding them (using Deface) with another solution that we could want to change in a bit. \nWe'd force people to revisit their deface overrides and style (or reintroduce skeleton on their store) in favor of a solution we already know it's not the ultimate. I'd take the risk of forcing users to take an action to improve their store, but I'd like to be sure its the right one, which in my opinion is using semantic class names and moving style things to css.\nAnyway I don't want to be the only one that blocks this so, if other core team members have a different opinion, feel free to go head with this approach.. No I think we just need to merge, doing it now!. I think the best way to solve this issue is to do not allow promotion to apply (or apply it partially) when the order total reach a negative amount, but at the moment I don't know if this is easy to achieve with current promotion implementation. I'm not sure about what to do here. I'll bring this topic into the next core team meeting and will let you know!. Yes, checkout could work, but the issue is at data level if I got it correctly. We should not allow that since an order with negative amount makes no sense.. Closing in favor of #3093 . Hey, this is a duplicate of #546. I also think this should not be the default behavior in core. I'm preparing a fix but I have a lot of specs failing so I need to understand better if there is some side effect of this or some specs are just not well written.. I agree we can deprecate Spree.t, thanks @BenMorganIO !. Closed with #2802. @coorasse let's go with just adding a line to the Changelog, thanks!. @aldesantis specs failures seem related, can you please take a look?. Closing, I'm reopened this into #3092. Thanks anyway @benjaminwil! . There was a conflict in the yml file yet so it couldn't allow me to merge. No worries, you have the owership of the commits in the PR I just open, so it does not change much. Thanks again!. Specs ran successfully, not sure what's happening, I'll try to re-trigger this build.. Thanks! Can we also add a regression test for this please?. I think we can close this issue since we should be fine on 2.2 which is within the supported timeframe:\n\n2.0: 'paperclip', '~> 4.2'\n2.1: 'paperclip', '~> 4.2'\n2.2: 'paperclip', ['>= 4.2', '< 6']\n\nIf users need older versions and they don't want to upgrade Solidus, they can just fork and use their own repo since those versions will not change anymore in the future. \nThanks and sorry for taking too long to answer.. Sure, thanks for pointing out!. Specs are green:\nhttps://circleci.com/gh/solidusio/solidus/8569\nhttps://circleci.com/gh/solidusio/solidus/8568\nhttps://circleci.com/gh/solidusio/solidus/8567\nhttps://circleci.com/gh/solidusio/solidus/8566\nMerging.... Specs are green here as well:\nhttps://circleci.com/gh/solidusio/solidus/8573\nhttps://circleci.com/gh/solidusio/solidus/8572\nhttps://circleci.com/gh/solidusio/solidus/8571\nhttps://circleci.com/gh/solidusio/solidus/8570\n. I think the issue is with the buildpack we are using. At the moment we are using this custom one made to work with Solidus. I think we need to change this line and maybe rebase against the master upstream.\n. I have a fix ready for the heroku deploy button here: https://github.com/nebulab/heroku-buildpack-solidus-demo/commit/518ca5961e112de73306df9b53dea1ff6b4ddc4b\nHeroku build is still failing for https://github.com/solidusio/solidus/pull/2826, which is almost solved here. I'm going to fix the deploy button after the new ransack version is released.. I rebased our heroku buildpack repository against its upstream so we have the latest things. \nI also made a small hack that disables yarn install, since we are not using it in the sample app and it was generating an issue with our solidus buildpack.\nClosing this issue since now the deploy button works again!. Hey @jtapia, can you please rebase? I'd like to push merging this with the Core Team this week. Thanks!. Thanks! I think it\u2019s due to this Rails (5.2) commit: https://github.com/rails/rails/commit/ec4a836919c021c0a5cf9ebeebb4db5e02104a55\nI\u2019ll take a look soon!. Yes, it should work but I think that Solidus should second Rails defaults. I think it's just matter of adding that:\nprotect_from_forgery unless: -> { request.format.json? || request.format.xml? }\nwhen needed (API only).. @ericsaupe @gmacdougall I've addressed the concern we talked about in the core team meeting. This should be fine now!. is en-US the only locale that you are using?. Which version of solidus and solidus_i18n are you using?. Anyway, what about creating a new select2_locale_en-US.js file here instead?\n. > Anyway, I'm using custom forks of the two projects with small changes. This PR was only to contribute.\nThanks for contributing but I think that, as you said, this change is going to make life harder if someone just want have different content in their en-US file. I think we can try another way that is good for everyone. If you want/have time to find alternatives please go ahead, otherwise I'll try to take a deeper look at this soon. Thanks again.. Merging since failures on Netlify are not related and are solved on master. I'm ok moving to bigint to reflect Rails standard (who wants UUID can probably run an extra migration in their project?). What about adding a new migration that converts all primary keys?. @cedum thanks for your insights. \ud83d\udc4d \nI think we can close this one in a couple of weeks if no other opinions in favor of choosing UUIDs are shared. . Today I did some work on JWT and I have a concern regarding refresh policy/endpoint. Do you have any thought on that? Do you think we should include some work for that in this PR?. I've deleted houndci-bot comments since it was not detecting frozen_string_literal comments (that I've added) correctly. \n. Thanks, I think we should also move the extension into solidusio-contrib organization before merging. What do you think?. I think you just need to give me admin access to that repo and I can transfer it. Let's talk in Slack for details if you want!. @jtapia I think I have to be admin to make the transfer. Closing, @benjaminwil has the final word here \ud83d\ude42 . Thanks anyway!. Ransack released a new gem version today (1.8.9). Unfortunately they decided (still not sure if that was intentional) to lock Rails compatibility up to 5.1.1. I opened a new issue on Ransack to understand better how to go head.. To be more clear, this is making impossible for us to support Rails 5.2.1 since ransack 1.8.8 is generating the error above and 1.8.9 does not support Rails 5.2 at all.. Working on a PR (#2826).. This is the issue on ransack that is making our spec fail, let's see what happen. \nIn the meantime ransack 2.0 has been released so I'm going to bump our dependency up in the core gemspec. ~This way Rails < 5.2 will use ransack 1.8 and Rails >= 5.2 will use ransack 2.0.~ Ransack 1.8 will not be used by any Solidus version since it's only for Rails < 5.0 and we do support Rails >= 5.1.. Closing since it's a duplicate. Duplicate of #2807, let's discuss there!. This is fixed in solidus_stripe, which should be used instead of solidus_gateway. . Closing, I'm not seeing this issue on a fresh sandbox anymore. Thanks for reporting.. Personally, I'm against changing this in old versions branch/es. I know they should be maintained still for some time but the maintenance is more for security updates, or at least bugfix. \nLet's wait for some other opinions on this, thanks anyway.. What about locking factory_bot gem to 4.10.0 in solidus 2.3 instead? It should still have the factory_girl file in /lib which has been removed with this commit. What do you think?. @tvdeyen specs fail because they removed the FactoryGirl namespace at all in the latest released versions.\n@BenMorganIO I wasn't aware that this was breaking extension specs on older Solidus versions when I said I was against this PR. Now that this is clear I'm open to merge this change, even if we should make the same thing for the other older versions maybe?. @tvdeyen I think we could even switch to factory_bot and just use 4.10.0 version, which is the last that contains the old FactoryGirl namespace.. @tvdeyen Yes, I was just afraid that factory_girl gem one day could be deleted but honestly I don't even know if it's doable and for sure when this happens those Solidus versions will have passed their EOL. \n\ud83d\udc4d for your proposal. I'm trying to locally run specs on an extension (solidus_auth_devise) using this branch and it does not work. \ud83d\ude22 \nI'm afraid my suggestion was incorrect and locking factory_girl dependency in common_spree_dependencies.rb is not a solution since they are dependency needed for the solidus gem development and they are not considered as extensions dependencies.\nI think the only way to handle this is your first attempt which I've wrongly request changes for, sorry!. Do you have that version still available (maybe with git reflog)? If not I can make the change again, please let me know.\n. > For extensions though we need to make sure that the extension is using factory girl 4.8.1 if they run specs for Solidus 2.3.\nYes but currently almost all extensions are built to work with all solidus versions, adding some extra code or branch in all extension is worst than change Factory Girl to Factory Bot in 2.2, 2.3, 2.4 branches here IMHO. \nIn terms of the danger of doing that, I think it's just matter of specs so there could not be issues. If stores that still uses Factory Girl (and are importing solidus factories into their specs) updates to latest Solidus patch version (like 2.3.1) they will be forced to update to Factory Bot, but is that a real issue?\n. @tvdeyen ok thanks, let's see how it comes \ud83d\ude42 . So the plan is to keep all extension locked to 'factory_bot', '4.10.0' until 2.4 reaches EOL. At that time we'll relax factory_bot in all extensions, right?\nI'm just concerned on how to explain that to users that creates new extension, maybe a big comment in the extension template in solidus_cmd?. Cough, cough https://github.com/solidusio/solidus/pull/2835#issuecomment-418301511 \ud83e\udd23 I'm happy if we all agree that this is a good solution. \nhttps://github.com/solidusio/solidus_auth_devise/pull/130 is not needed anymore, right?. Oh right, I keep forgetting that the Solidus dev dependencies are not reflected into extensions. \ud83d\udc4d \nRE \"the plan\":\nRight now:\n\nupdate all extensions with something similar to https://github.com/solidusio/solidus_auth_devise/pull/130/commits/d902b8ea46883f51f31df6fd59cda7b805ab0849\nmerge this PR\nupdate template on  and documentation to explain why this is needed (I'm working on this)\n\nOnce the EOL of 2.4 is reached (2019-05-07):\n\njust revert https://github.com/solidusio/solidus_auth_devise/pull/130/commits/d902b8ea46883f51f31df6fd59cda7b805ab0849 on all extensions\n\n. Merging with 1 review. This is on guides and only on development, it's not critical. Are you looking for previews of the solidus emails? If yes I think you can just find them into /rails/mailers/. I think we can close this one. Please reopen it if you have more details.. @tvdeyen you are right. Closing and moving it, thanks!. I'm also \ud83d\udc4d with what has been proposed by @tvdeyen in https://github.com/solidusio/solidus/issues/2849#issuecomment-422919918. AirBnB rules (more relaxed) are fine but that's the goal we should strive step by step as proposed.. Can you also please take a look at the specs for this? I'm seeing that we should already be covered but it looks like that test is a false positive. . Thanks @tvdeyen . I agree we need a UX/UI person opinion but in the meantime I personally think it's better than what we have now. . @jacobherrington please take a look at this issue and this closed PR also. We started some work for the collapsible menu but, the way it was required to be, it turned out to be a big change.\nAt the moment I think we need something more simple, like removing the ability to expand/reduce the menu in mobile/desktop. . Leaving the review of this PR to a native English speaker \ud83c\uddfa\ud83c\uddf8 \ud83c\uddec\ud83c\udde7 \ud83c\udde6\ud83c\uddfa .... What do you mean? I'm ok with the change, I just think it needs some more details to be better valuable by who is in charge to review/merge this and by devs that will need to understand why this code changed in their stores.\nIf there's something I can do to help you with what's requested feel free to ask here on in our Slack channel!. @stem can you please rerun failing specs on CircleCI?. Thanks!. Closed since #2875 has been merged. @kingsleywang2013 sure, feel free to submit a PR for this, I've just added this task to the 3.0 Milestone after talking about that with the rest of the Core Team, thanks!. @tvdeyen I think in the guides land it is added to the bundle at assets compile time. Could this be related to #2421 ?. As far as I get from this comment in the issue on RubyMoney/money, you have to set that configuration up in each application. I'm not sure that initializer works but setting that here it removes the deprecations in specs. I think we need to put that setting in a place where it is also configurable by users with the other Spree::Money configurations.. Personally I'm more for a simpler Community Conduct Guideline like the one used for Ruby which we can evolve in our community if we think it's needed.. @bitberries I'm not sure to get the issue with current code and the link provided does not help understanding (for me). Can you please point to some other resource or explain the issue better?. > This code is just randomly working correctly for the English language.\nThat's what I was trying to understand, thanks. It looks like it's not supported by rails-i18n so we should avoid using it here as for your PR.\nI've also found the initial work for this in Solidus: #1191\nAre there other occurrences of this wrong pluralization in Solidus? It is worth to update all of them in this PR maybe, what do you think?\n . @bitberries I've just found this one: https://github.com/solidusio/solidus/blob/fac5b359bb0b27de638d2ae4abb82abc584ad177/backend/spec/features/admin/users_spec.rb#L40\nThis should be unsupported as well. I know that this will not break any thing since specs does not run with east slavic locale but we should not encourage bad practices in the codebase. Every line of code could be taken as example and reused again, maybe somewhere where it will be dangerous.. Now there are 3 commits, the goal is to have just the correct one, I think you just need to squash them, thanks!. Why bcc should only apply to the order confirm email? . I think that we need to provide a way to let devs choose which emails they want to add bcc into if we want to introduce this feature.\nOther users could need to add it to shipment confirmation emails also for example and if they need to override code to make that happen I think this is not worth the change since they could just change code to add the bcc to the order confirm email as well.\nIMO if we don't go in this direction it's better to keep this customization out of core, maybe an extension or directly into apps.\n. Closing this, let us know if you build the extension and thanks again for contributing!. Hey thanks @sechix, can you please also post the error you were having before the change?. Ok, I'm going to close this one, feel free to reopen if this happens again and you can attach an error message that allows debugging. Thanks anyway for reporting back!. @spaghetticode can you please rebase against master? Failures should go away. I'm re-pushing this branch several times to see if this really fixes it. This seems to work, I don't love it but can't find any other solution at the moment. WDYT?. This could be a breaking change for some store right? Maybe we should add a specific line into the CHANGELOG. @JDutil what do you think?. Made a test locally and I can't see any UI change from what we previously have, thanks @JDutil \ud83d\udc4d \ud83c\udf89 . @tvdeyen I think you are right but we are already storing the credit card in the database, this just changes which one is considered the default one. \nI think it does not change which cards are being shown to the user on the next purchase but the last one used will be preselected I think, while at the moment the preselected one is the first added. Right @vassalloandrea ?\nUPDATE: it's the other way around (now you can choose to select the last one as default or it will always use the first one) but they are both saved in the database anyway.. > Also the additional configuration option in this PR seems to be very store specific and should not be in core IMO. What could be in core is a user account page that let the use decide which payment source that they decided to be stored is their default one. Having the store deciding this is wrong IMO.\n\ud83d\udc4d \nWhat about a class that each store can customize? Like:\nruby\nSpree::Config::Wallet.default_payment_method_setter_class\nwhich by default acts exactly as the one we have in core right now?. I think this is a great solution @tvdeyen, thanks!. It's worth to say that this PR depends on #2810 . @JDutil specs failure are actually related, can you please take a look? \ud83d\ude4f . @tvdeyen in this case I'd leave the specs since we are not really removing this functionality but just printing a deprecation warning. I think it's better to be sure stores and extensions that still rely on that method can work.. Thanks @michaelmichael, we need more PRs like this one!. @bitberryru failures should go away if you rebase against master, thanks!. I'm sure this is a great way to fix the issue but I'm not an Arel expert so I'm more for the easier to understand solution provided in #2921 . But let's wait to see if we have other opinions here. \nIn the meantime thanks for the contribution!. I'm actually seeing a UI change in the header in desktop:\nBefore:\n\nAfter:\n\nI'll try to take a look soo, I have no idea what could be, but I \u2764\ufe0fNetlify previews even more. \ud83d\ude42 \n. Ok I think it's related to this issue on Twitter Bootstrap: https://github.com/twbs/bootstrap/pull/26820. Closed with #2504, thanks for reporting the issue.. I don't think it is expected, it does not make sense to refund a payment that never happened. Feel free to submit a patch, thanks!. Thanks @ccarruitero ! \ud83c\udf89 . This happens when there is no user in the database with the email spree@example.com. This has been already addressed into #2802 that will also close this issue when merged. \nI'm just reporting the issue here for documentation and to help other users that find this strange issue.. Yes, I'd keep this stale for now, but it's something that we'll probably want to add later. Yes, I'd keep this stale for now, but it's something that we'll probably want to add later. @jtapia Hey there, can you please take a look at the failing specs? They look related to this change, thanks!. Closed with #3029, thanks @Nittarab and @twist900!. Closed with #2936, thanks @jacobherrington and @gbxl for reporting the issue! \ud83c\udf89 . Hey I think it's a good idea but how can the menu be reordered by a user? For example what should I do in my app to put a new entry after the Products item? What about an overridable method that returns the order of the items instead?. @jacobherrington I got how you can add new items but I still don't get how you can change existing (in solidus backend) menu items positions into your own app, maybe it's simpler than what I think but can you please provide a simple example?. Thanks! In the screenshot provided I can see Filter Result as button's text but from the code it looks like you used another i18n key (spree.filter). Is that just an issue with the screenshot provided?. Maybe you could squash all commits into a single one with a better description?. Hey thanks @trottomv!\nA couple of things:\n\nSolidus Support backend_available? method: I think we need to deprecate this method since it should now be admin_available?  This is used into extensions like here\nLot of extensions are injecting assets expecting the backend directory exists, can we fix this somehow in your opinion? Different examples of its usage here and here. @seand7565 maybe disabling the count on hand input field is better? The edit button is still needed if you need to change the track inventory option to false for example.. > That also triggers a more interesting discussion: my original thought was that the stock locations ordering would be used in the simple shipment coordinator, but it's not. At least I think we should change @stock_locations = Spree::StockLocation.active to @stock_locations = Spree::StockLocation.order_default.active there... but that's another discussion. :D \n\nI think you want to look at this recently merged PR #2783 that would allow to use the position if needed creating and using a new StockLocation sorter class. \nI think we need to merge this PR anyway since there's a bug in the UI. Thanks again!. @jacobherrington \ud83d\udc4d can we please rebase? . @jacobherrington sorry, I meant squash commits \ud83d\ude2c . I like this but maybe it's time to port these methods into solidus_core?. > Or add solidus_support as runtime dependency?\nI don't think this could work as is since solidus_support already depends on solidus_core. \n. @afdev82 Hey can you please rebase on master since in the meantime some en key changed? I think it could be easier to revert changes and re-run the script at this point since there are a lot of conflicts. Thanks!. Hey thanks @peterberkenbosch !\nIn my experience these kind of gateways also have a callback URL (or more, like one for success and one for failure) where they will land after the payment offsite is done.\nWith this callback the payment is registered in solidus and the user is redirected to the next step (or still on payment if there's an error).\nDo you think this logic should be implemented separately into each gateway that should add its own routes/controllers or is this something that we can generalize and add support for that into core?\n. Thanks @elia !. @afdev82 sorry, can you explain better why is the reformatting commit needed?. > usually the translations are alphabetically ordered and so on \"normalized\".\nGot that but shouldn't this be handled by i18n-tasks gem? \nWhat I don't get is why the PR #2963 moved things around and we are reverting some of its changes here? . Yes but look at this for example. It does the opposite of the normalization happened in this PR, maybe some options changed on you env in the meantime?. @afdev82 \ud83d\udc4bdo you have any update here?. Reopened as #3132. I think #3000 fixes this issue, anyway we should also open another PR to remove the column from the database.. > I think #3000 fixes this issue, anyway we should also open another PR to remove the column from the database.\nDone in #3028. I've removed the link to the .rubocop.yml config from the .erblint.yml file since it's still not supported by HoundCI. I've also removed the .erblint.yml file at all since that was the only configuration present. This is now ready to be merged in my opinion.. @tvdeyen can you please review again?. Thanks @spaghetticode, closing this one since it seems documented now. \ud83d\ude42 . @deepaksisodiaa please follow https://github.com/solidusio/solidus/issues/2989\nI think we can close this one. @aitbw \n\nInclude a i18n-tasks.yml config file under config and consider all spree.api I18n keys used\n\nWhat do you mean? Which configuration should this file contain in order to make the CI step work?. if it's possible, I'm ok removing scope.. I think it's related to some ActiveSupport deprecation change in latest Rails. I'd lock Rails support to 5.2.1 for now until we know what's going on.. \ud83d\udc4d where did you find that? I couldn't find any info about that in the ActiveSupport changelog. Also, I don't think it's the only place where we are using deprecate like that.. I think it's related to this commit: https://github.com/rails/rails/commit/015477ae9109d4105d5a5057d82338f198febb74 (related to https://github.com/rails/rails/commit/a982a42d766169c2170d7f100c2a5ceb5430efb1). Not sure what Hound wants here \ud83d\udc36  . @ericsaupe I'm re-running the failed job. I think it's a flaky spec but let's see. . @elia I think we need some padding since the svg is taking all the space available:\n\n. Closing in favor of https://github.com/solidusio/solidus/pull/2996, thanks anyway @Nittarab!. @aldesantis I've opened #3028 which removes the code column at all. Maybe we can move forward with that PR removing this method at all. WDYT?. I think that saving the source should be done per payment and not per order.\nThere's no guarantee that the user enters a single payment/source per order, there could be frontends that allow adding more than one credit card in the payment step and user could want to save just a subset of them.\nI think we should move the temporary attribute on payments or sources calling it with a better name as well (like single_usage_allowed), this way it will be more flexible.\nWDYT?. Thanks for opening the issue. Can we do something similar to https://github.com/solidusio/solidus/pull/3002 ?. I see this now, thanks for the accurate explanation.\nI can't see any clean solution to this but maybe someone from awesome_nested_set could help us.\n. Thinking to some security implications of merging this PR:\n\nwill the state machine validations be skipped setting the state without calling next?\ncan a user set the state of the order to complete without actually have all the steps done?. Re-running specs. We talked about this in the weekly Core Team meeting. It's better to try other approaches like adding a new endpoint that has the state parameter permitted and let you move to another state using the state machine. Something like /recede/address? \nIt will be an extra API call but we thought it's legit in the API world.. Thanks @bitberryru, this makes total sense and I did see the need of this in many projects.\n\nI'm just wondering what happens with this Pull rails dependency out of core into solidus_rails PR that we want to merge before the 3.0 release. Will we need to change something there as well in your opinion?\nFor the _decorator \"convention\" change, I also totally agree. Not sure if we can just change this in the documentation and extensions. It should not break anything inside users stores since they we are not going to change their application.rb and if they have the previous convention in both config and directory structure they are safe. I think it's just matter of choosing the new pattern. I'll open an issue about it.\n. @elia didn't know that, great find! I think that could be a good reason to keep it as is then.. Not sure to understand. We could move core things into concerns but still need some mechanism to change Solidus core functionalities into applications, which is where \"decorators\" are used. Could you please explain this more in depth @mdesantis ?. Thanks @stem! I'm trying to analyze the result of this PR with bullet but I see the same results as before without PR. Can you please help me understand what happens and why this should fix the N+1? \nI'm also trying to see some documentation in awesome_nested_set about the associate_parents method but it really seems like an internal one so I'm a bit concerned on using it directly into Solidus.\n. @stem \ud83d\udc4bHey there! Any update here?. A last, small thing. Can you rebase and squash some commits (I'm looking at the Hound violation commit in particular, that could go into the Refactor Taxon.pretty_name one). Thanks again!. In the core team meeting we talked about this and I agree with @gmacdougall here (sorry, I pushed to add that spec). There could be a lot of things (rails/act_as_nested_set updates or specs execution order) that would make this test fail. It's probably better to remove it now that we are sure we removed the N+1 there. . @stem yes, I think it's better to remove this module since we don't use it and we could keep code in the repository that could no longer work in the future. . Thanks @stem !. It looks like you are using a very old Solidus version (1.4.2) can you try with the latest version (2.7.1)?. Closing since it looks like an issue with Rails/Solidus versions.. @tvdeyen is the Netlify failure normal here?. Closed with #3023, thanks @spaghetticode !. This is not related to Bundler 2.0 but to not running the command with bundle exec. The proposed fix is still needed though.. @spaghetticode go ahead with the commits squash!. I have to add a guard to let people know that they have to remove data from the column before running the migration. Also, I need to add a changelog entry. There's some issue with the database in test environment when it tries to roll back to the previous state after the test ends, I need to investigate more on why it's happening.. Thanks for the contribution @forever-sumit, would you mind also adding a spec that fails before this fix?. I'd say to wait for specs anyway. I'm not confident merging this without specs since I'm not 100% confident on the context where this issue happens. If someone else (maybe from the core team) has time to go deeper and understand better, that person could also probably add specs to finish this PR.  . Ah, and maybe also spec for when the current variant is master?. @jacobherrington \ud83d\udc4d but maybe we should squash commits?. @rubenochiavone thanks! \ud83c\udf89 . Thanks @aitbw !!!! \ud83c\udf89 . @rubenochiavone I'm all for this. I think it's a good idea. I'm not sure if we really need to create another CircleCi job for that. Can't we use an existing one? Coverage should be the same right?. @gildardoperez Hey there, thanks for the contribution! I think specs are failing since address factories are created without that field filled. Also can you please explain why this change is needed? . @sechix I think it could be related to #3027. Can you please paste your vendor/assets/javascripts/spree/backend/all.js file's content?. @sechix I'm trying to replicate the issue but I can't see that autocomplete in admin -> order. Which page are you using exactly?. I think the error comes from the first error in console (the SyntaxError one). Can you see what it refers to?. Re-running CI, there's a flaky spec. \ud83d\ude20 . @grichardomi Hey there, can you please explain your issue better. Which page are you talking about?. Released v2.5.1 and v.2.6.3 that contain #3078 and #3079. If this will fix the extensions matrix we can close this issue.. Problems on extensions seem fixed, we can close this one!. That PR's commit message is Avoid running validations in current_order but I think it refers to running validation only when we need to update the order - if IP is not changed it won't.\nAt the moment I can't see any cons skipping validation there. So \ud83d\udc4d for me!. cc @DanielePalombo . This has been fixed in Rails (I think just in master for now). \nWhat do you think about this solution made on factory_bot_rails using gsub_file instead of sed?\nruby\ngsub_file \"Gemfile\", /^gem 'sqlite3'$/, 'gem \"sqlite3\", \"~> 1.3.6\"'\nI think it's a bit more \"Rails friendly\".\n. If possible, that would not be bad in my opinion. But maybe we can do that into another PR?. @peterberkenbosch yeah, we talked about that. The only way to use gsub_file is moving that part into a Gemfile template and use that template with the -m option on the rails new command. Definitely not worth it. \ud83d\ude42 . @spaghetticode maybe we should change the first commit message? Or are we still uncertain it will fix?. @solidusio/core-team can we have another review here, please?. Thanks @loicginoux!. This is currently not linked anywhere in public guides pages. To try this out, this is visible into https://deploy-preview-3092--solidus-guides.netlify.com/users/settings/overview/ \nI think some paths have to be adjusted so I added WIP label.. @benjaminwil I\u2019ve just started resuming exactly that PR! \ud83d\ude03\nI\u2019ve already rebased and added something, I\u2019ll submit a PR soon and maybe you could help reviewing that one?. @solidusio/core-team @benjaminwil Can I have a review here, please? \ud83d\ude4f . @solidusio/core-team can I have another review here, please? \ud83d\ude4f . @benjaminwil if you want to take a look it would be awesome, thanks!. Thanks for the review @tvdeyen, but I can't find links without cursor: pointer in both navigation and sidebar.. @tvdeyen yes, Chrome. I agree we can tackle this into a separate PR.. CI is green, there's some issue in reporting the status here on GH: https://circleci.com/workflow-run/7649387c-f702-4401-a4d2-d6568e3f10d9. Thanks @davidedistefano !. Thanks @brchristian for reporting and @VzqzAc for these initial thoughts. I think this is also related to https://github.com/solidusio/solidus/pull/2417, which I started fixing on the view layer (by resetting the state to nilin the form). We have fixed this already the same way in backend but I think we should do something on the model layer. I know @cedum started working on this already. \nDo you think we should finalize and merge https://github.com/solidusio/solidus/pull/2417/files in the meantime? Once identified the bug I think it's quite easy to fix in each application, and merging that PR will not help devs using a custom frontend, while the model level bugfix would. Let me know your thoughts.\n. Thanks, @tvdeyen! I'm just not sure about the Logs button at the end of the payment page. It could look like it's related to the capture events only, but it refers to all events type logs of the payment if I get it correctly, right?. If you can clone the repo locally, you could just run\nbundle install\nbundle exec rake sandbox\ncd sandbox\nbundle exec rails s\nto have a working Solidus demo store. Alternatively, there's no way at the moment.. @kinduff thanks for the contribution. My first thought has been that I don't want to maintain this Docker Demo feature, mostly because I don't have a lot of experience with Docker and there's no way to know if it's still working for all solidus features (eg. file upload or other things which could depend on the system). On the other end, the same could happen (and happens often) with Heroku. For sure we'll talk about this on the next Core Team meeting. . > Also to ask if anyone has insights about how to automate this with Circle CI and have an up to date image everytime there's a change.\n@kinduff maybe a GitHub Action?. In the last Core Team meeting, we had a chat about this and we are ok with this PR if the image is hosted on a Solidus Docker Hub account. There's an existing solidusio org on Docker Hub, trying to understand who created that. . @kinduff great, thanks. I've opened a support ticket on DockerHub to understand how we could get the solidusio or solidus organization ownership, which already exist but no one seems to have created. \nIn the meantime, maybe you could rebase the PR since I think one single, well-documented commit in enough for this change, thanks!. We did it: https://cloud.docker.com/u/solidusio/repository/docker/solidusio/solidus-demo \ud83c\udf89 . Hey there, you can just check this file: https://github.com/solidusio/solidus_auth_devise/blob/91687769600cc9292e198684be8d15b6796f07e2/lib/views/frontend/spree/shared/_login_bar_items.html.erb\nViews are there since they are loaded conditionally if you have loaded specific parts of solidus (frontend, backend, api).. Yes, it's my fault not considering all the possible scenarios behind removing a simple/unused field. Lesson learned. We need more caution while removing fields from the database and probably even some tests on real stores database before merging.. I think it makes sense to remove that column but I think it's better to do this into another PR/migration since it's not really related to the code column. Probably it would have been to create that migration before, but it's too late now since this migration is already part of a release (v2.8). \ud83d\ude22 . @jacobherrington \n\nThis might be something worth documenting on the Solidus blog?\n\n\ud83d\udc4d . Rerunning our CircleCI workflow several times to see if the problem happens again, Thanks @spaghetticode !. @solidusio/core-team can we have another review here, please?. \ud83d\ude22 https://circleci.com/gh/solidusio/solidus/11142#tests/containers/1. I'm giving a live try to this PR. I think it's ok as is since it does not allow you to set 0 as value by using browser's number input controls. Anyway, a user is still able to fill that input with 0 and submit. I think this happens since the submit of that form is never really called. Maybe it's just matter of triggering the validation programmatically in the backbone view?. Thanks! Are you using solidus_auth_devise as well? Because I think that Proc is overridden in that extension as well. Maybe something we should take into account?. Sound good to me, please note that for the Admin controller there's another point where this is set, other than what I've previously linked: https://github.com/solidusio/solidus_auth_devise/blob/335991f79557bc36ea08943b9e1fbb151154d020/lib/spree/auth/engine.rb#L37. I agree we should change the title of this issue and add some more context to its description. I wasn't at the conference as well and it was quite hard to understand what we were talking about, and I still have some doubts, so I'm sorry if I'm not getting it yet.\nWhat I'd like to point out is that the current pattern used for extensions is good if we need to inject routes or other Rails layers resources (models, views, controllers, migrations, assets) into our stores.\nThe extension @jarednorman built is a great example of adding some business logic to a store and it is made possible because of the presence of an extension point for that particular feature into core and because the extension does not need any assets, routes, controllers or migrations to be used.\nThe point, I think, is not to find an alternative when we need those things into an extension, because using what Rails gives us and maintains for us is the best and more responsible way of solving that problem (or I can't see any valid alternative yet). The point is trying to only build extensions that provide only business logic, leaving to each developer the possibility/responsibility of building the rest of the things into their store on their own. \nFor me, this opens some questions:\n\nIs it ok to not providing users interfaces of features we ship into extensions? I think it could work for some features but not for all of them.\nWith this rationale, we should have an extension point (via a configurable class) for every feature that could be changed, but I think it's not realistic to expect that or we'll end up calling a configurable class for each line of code. We could add these configurable classes every time this is required by someone that is building a store or an extension, but I'm quite sure people will prefer to use class_eval/prepend to quick fix their issues instead of submitting PRs that could be opinionated and requires some time to be merged and released in the next Solidus version.. @dustineichler \n\n\nsuggestion on title change? \n\n[RFC] Should the new extensions template create a Rails Engine?\nWhat about something like this?\n\nmight be worth closing and moving to solidus_cmd too.\n\nI think we can discuss here since it has more visibility and then eventually create PRs on the solidus_cmd repository referring to this PR.\n@jarednorman \nSure, I was not criticizing this approach, and it's clear to me that this was intentional. \nProviding good documentation is a great way to delegate to each store for the rest of the implementation.\n\nI was thinking that it could be a good idea to provide 2 commands (or an option) to create a new extension with solidus_cmd but maybe it's not worth it since the extension without the Rails Engine skeleton would be very similar to a new gem created with Bundler with bundle gem new_gem, WDYT?\n. Sure, any improvement is welcome. As far as I can see right now:\n\nSolidus factories are required\nThe \"right way\" of defining factories is enforced in the extension template\ntravis configuration file has extra 2.2 and 2.3 and missing 2.8  which has been released recently (just opened https://github.com/solidusio-contrib/solidus_cmd/pull/31). Thanks for pointing out, I'll add it to our wiki page about releasing new versions so we'll not forget again. On a side note, I was experimenting using CircleCI Orbs to run extensions specs. This way we could have a shared place to update when we release a new version and this will be automatically reflected on all extensions ( \u2705). Updating the matrix on the template and all extensions is a waste of time most of the times. Any comment is appreciated here.\nThe provided spec_helper could be improved, I think we need to use testing helpers provided by solidus_support. (Opened solidusio-contrib/solidus_cmd#30)\n\nIf there are other concerns or missing things, let's discuss and fix them!. @brchristian I'm more for adding the exacxt number that we expect so just leaving:\nruby\nexpect(subject.order_count).to eq order_count. @rubenochiavone I've set up a CODECOV_TOKEN env variable in CircleCI that should be visible in all builds but hidden publicly. Let me know if that works. @aitbw thanks!. This is passing, I rerun this workflow several times and it is always green (first failure is due to a force push, not a real failure). I think we can try to merge this.. It failed again on the CI :(\nhttps://circleci.com/gh/nebulab/solidus/1625#tests/containers/1. By looking at the last failure on CircleCI it's evident what happens:\nThe page fails in this state (at least when the screenshot is taken):\n\nand the failure says:\nFailure/Error: expect(page).to have_css(\".select2-search-choice\", text: taxon.name)\n  expected to find visible css \".select2-search-choice\" with text \"Clothing\" but there were no matches. Also found \"Ruby on Rails\", which matched the selector but not all filters.\nThis is the failing code:\nhttps://github.com/solidusio/solidus/blob/7ca285d9475192cd7277cbd51d660fe2eaadeb10/core/lib/spree/testing_support/capybara_ext.rb#L93-L98\npage.find should wait for 10 (Capybara.default_max_wait_time) seconds, so I don't think it's an issue related to the page waiting for div to be populated correctly. Also, if Clothing were not found and clicked in the results div, Capybara would raise an exception. So for some reason, that result is found, clicked but it's not doing anything. I'll put some more debugging code, so it will be more clear what's happening.\n. Thanks!. Thanks @cedum !. @fastjames thanks! Can you please post the error you are receiving as well?. @coorasse wow, thank you, I love this change! Do you think there's a way to deprecate the old usage any way before removing it?. these are the changes made to this file:\n1. removed - char at the end of some erb tags. They are useless and not used in other tags;\n2. when return_item.variant.product.name was used, it has been changed in return_item.variant.name since that method is delegated from variant to its product;\n3. in this portion: <%= raw(return_item.exchange_variant.product.name) if return_item.exchange_variant.options_text.present? %> the if condition is checking the presence of option_text but it's applied on the name. It had to be moved to the option_text tag. This is actually a bug since without this change the mail text will not have the name printed if the option_text is not present on that variant.\n. Not sure what's the best way but probably it could be a good idea to change this method content to use the new class. If someone was using/overriding taxon.applicable_filters the interface would be the same and it should continue to work but under the hood it would start using the new Spree::Core::Search::ProductFilter which does exactly the same things.\n. maybe ProductFilters if it returns a list of filters? or maybe a public instance method all or available which return the content of @filters?\n. Maybe it's easier to extend in the view?\n. Yes, I agree and I don't know what's better. Does anyone else have an opinion on this? \nPlease, feel free to point us to any issue on this topic or a place in the Solidus codebase where we adopted a similar approach.\ncc/ @cbrunsdon @jhawthorn \n. do you need reimbursement variable here?\n. you could probably use demodulize here even if I'd prefer to stay explicit on the value passed here.\n. good catch on this to be useless\n. casting the preference value to an Array (  Array(pref[:only]) ) would allow you also to pass a single class name like:\nonly: 'OrderMailer'\n. reading the code again, I think you are right. There's no reason to extract this method. Going to revert this change.\n. I reverted this change for now. I'm probably missing something but at the moment I cannot see any scenario when something else then the line item itself could need to be aware of these specific line item pricing options. That's why I'd move it to the private section, but I'm ok leaving it in the public one as well.\n. done, but assigning nil to line item price when money is nil.\n. @jhawthorn thanks for your review. Agree on the better readability of suggested version. Changed! \n. I'm not sure which one is better here but in the rest of the file to read attributes we used @money instead of self.money. Is there any reason to change this here? (I think it also applies to self.currency -> @currency). If they are equivalent we should probably be more consistent.. What about testing that Comparable is included? This way, if we remove that module, we'll be sure that some test will fail.. @jhawthorn why you are not using dash but underscores to separate words for all elements ids?. it happens when page content is shorter than menu height, looking for a fix. also, it doesn't seem to be related to having the spacer or not, it happens even with it. @tvdeyen should be fixed with https://github.com/solidusio/solidus/pull/1718/commits/8e9a39f3ad78bda18324b46ed4e73462556116f6, what do you think?. done. @mtomov agree, but as long as we have skeleton layout I think we need to consider that exactly these breakpoints will trigger screen resizes. We just moved those into variables to be able to use them in all pages consistently.. sorry, I don't get it. This way it will use the bootstrap sizes for xl, lg, etc screen sizes but I think we need to use the skeleton ones which are defined here that could not match, right?. Sorry for the wrong link. Cool, thanks, I didn't noticed those variables in backend. I'll give these mixins a try soon! :) . I'd let this addition go into a new line, just to keep consistency with existing code. I had the same doubt and I noticed that in this same file payments are also created using Spree::PaymentCreate.new Service Object. Is there any reason/general rule to prefer a method or another?. I'd leave a space after > . I think submit is done via checkbox tag onclick: 'this.form.submit()' which I don't like a lot. It should be done in a javascript file but I'd avoid it completely because each store can implement that logic with a couple of lines of code if needed.. This line does not seem to be indented properly. It is inside the <li> element so it should have 2 more spaces, right?. I think the best way to indent this checkbox params is using this style guide:\nerb\n<%= check_box_tag(\n  param_1,\n  param_2,\n  etc\n) %>. I think this is not tested, this should probably be something like: \nruby\nfind_by: Spree::Product.permalink_field.to_sym => params[:product_id]. yes, it's probably better to do that in a separate PR anyway (if it is useful). I'd leave an empty line after let here. I'm not sure about this comment line. If we'll add other scopes later this line had to be removed/changed in something more generic. I'm for removing it since we can understand why this code is here by using git history.. I'd take advantage of this change to add spaces inside {} to be consistent with the rest of the code .. What about moving tax calculators folder into models/spree/calculator?. I think this should be added here instead. I think having a @payment_methods ivar can be confusing since, as a developer, I expect to find currently persisted Spree::PaymentMethods there instead now it contains possible types of Spree::PaymentMethod. What about some more semantic variable name like @payment_method_types?. I think this logic could be too complex for a view. What about creating a method into Spree::ShippingRate similar to:\nruby\ndef available_to_user?\n  shipping_method.available_to_users? || shipment.selected_shipping_rate == self\nend\nand here just do:\nerb\n<% ship_form.object.shipping_rates.select(&:available_to_user?).each do |rate| %>\nDo you think something like this would work and reduce view complexity?. do we need to deprecate this argument if it is not used anymore? Maybe also changing method documentation?. or available_payment_methods?. why not use an hash here?. why this file is needed?. Ah right! Now the old files just contains deprecation specs. \nThis file is empty since: 1fbbdcc5d6aef78b33904a9e71a10dfde62ca71e\nand this seems to be the reason this file was added for: \nhttps://github.com/solidusio/solidus/commit/970eeb6ce6eb6a0455746d644dde3272165153c3#diff-4f10b6436800df7a8b39eff13961d74f\nMaybe we don't need it anymore? Or can it be useful to understand if a payment method can be created with BogusCreditCard payment method? My feeling is that this file is missing some specs, like this one, and of course we can add that with another PR, if they are needed. \ud83d\ude04 . looking at here maybe we can also add skip_yarn and no_rc?. @gmacdougall I think this has been introduced rebasing and fixing the CHANGELOG conflict.. I tried the script locally and columns.join(\", \") seems to work even with postgresql and sqlite3. Why the else version is needed?. Just found some (maybe) useful comments here.. I like formatting this kind of array with each element in a separate line, mainly to keep git commits history clean if we change something, but it's just my personal preference, I'm ok with this as well. . @oeN maybe we should also test that the currency wasn't EUR before selecting/saving it?. thank you!. both fixed now!. I just have some doubt about the naming:\nI expected this class to be named Spree::Payment::Canceller because it is the entity that performs the cancellation. Spree::Payment::Cancellation also makes sense but it's more an action, maybe I'd expect the cancellation to happen right when it is initialized, instead this will not perform anything until the cancel! method is called. \nAs discussed in private with @tvdeyen it is just a personal preference, both make sense, I just wanted to express mine \ud83d\ude38 .. Maybe this should not be an optional argument since we are passing it on initialization.. do we need to keep Spree::Promotion::Actions::FreeShipping into spree.promo.register.promotions.actions as well?. I know we just want to reflect views as they are, I just want to take note that this is the only place where cache! is used without I18n.locale key. Probably stuff for another PR.. Thanks for the clarification. I have no good ideas other than the one you proposed. Anyway at the moment I can't figure out a scenario when removing something from that actions list would break existing orders and promotions. I mean, isn't the same if we remove another action from that actions list, like Spree::Promotion::Actions::CreateAdjustment?. Got it, thanks for taking the time to explain this better. IMO it's reasonable to care about the above scenario. As you said, there could be promotions that would stop working if a developer removes that class from the list before all promos with that actions are expired or disabled.\nI'm fine merging and iterating on this, maybe with time we'll be able to simplify this logic a lot since it seems like we just want to automatically try to apply some promotions after a specific checkout step (probably I'm too optimistic and it's much more complex than this \ud83d\ude04 ).. I also think GET is better here. This returns a redirect but it's still data retrieving (more like a question then the request to change something).. why not nest into .quick-switch-help here?. maybe an alternative approach could be redirecting to the right checkout step?. is this supposed to stay here?. yes, I can just do create(:order_with_line_items, state: 'payment'). yes, you are right. I changed the code to avoid stubbing the current order. wrong opening or closing quote ?. I think this is a good candidate for the Major changes section . I think .strip can be enough for fixing the main issue (whitespace before or after). Each store will be able to override the method easily if needed. . I think the general feeling is to remove data-hook attributes. To follow this path you could use a class instead, like:\n<p class=\"field payment-form-card-name\">\nand add a similar class to the other elements for consistency (number and expiration).\nYou should be able to hook this element with a class as well, right?. I think this code can be simplified in this way:\n```scss\n  ul.taxons-list {\n    ul {\n      margin-left: 1em;\n    }\nli {\n  font-size: $main_navigation_font_size;\n  font-weight: normal;\n\n  &.current {\n    font-weight: bold;\n  }\n}\n\n}\n``. I think it works with&.currentsince it applies toul.taxons-list li`, which is exactly elements that need this style.. @tvdeyen thanks for your feedback. Yes, it's probably better to have it less specific.\n. I'd write except: :show instead?. From here on, we have some issues with markdown (I suspect it is the initial double * which is not closed).. Can we avoid exceeding the 80-char limit. Of course we can do that when we are sure the content is ready to be merged, just wanted to point that out so we don't forget. :) . Maybe this section is a bit out of context here? What about moving this text into What the Order's Administrator Sees?. This explanation is very good, but in my opinion it's too much accurate for something which is not included in core. Also, it's very easy that it goes out of date here. I think this has to be moved in the Active Shipping Extension. The link provided in the first section of this guide could be enough.. I'd use a code example with something that is not included into an extension (Usps stuff), so that it needs less overhead and we can keep it simpler.. maybe we should also mention Inventory Units (shipment content) here?. Not sure where but I'd also think about mentioning the concept of Carton here. It is basically what the shipment becomes after it is shipped: a shipped shipment is a Carton. Maybe it's just a technical detail but it is a question that pops up often and a section that explains it could be useful.. I agree we'll probably don't need to keep this list, even because the direction on gateways is trying to build a gem for each geteway for several reason. They don't share any logic in solidus_gateway gem and 99% of times stores just use one gateway from that list.. Agree this is useless here as it currently is. shouldn't be variant.discard?. @mtylty I think hound is right. This when is missing its content, maybe it should just be credit_amount? Or are you intentionally leaving it without content, just for documentation?. I understand you are trying to emulate what happens in Spree::OrderCancellation#short_ship but we are not reloading the line item there, so why here is needed?\n. I'd keep it on 2 lines. Maybe this partial is or was rendered in some view that doesn't have @taxon?. Oh, yes, seems like it's safe to remove them. I agree they are pretty useless, thanks!. what about manually updating the adjustment_total instead?\nruby\ninventory_unit.line_item.adjustment_total += amount\nThis would ensure it's updated for next iterations without hard refreshing all the order content. I think it's giving a false positive here.\nYou should test removing reload and with:\nexpect(inventory_units.first.line_item.total.to_d).to eq(0)\n. We decided to use \"text\" input for currency fields, right?. mhh, I tried this code as well and it seems to work with your spec (removing the line_item.reload). Ah, you are right, good catch!. I'm not sure these 3 keys are ok, since it could not be clear that they refer to the amount. \nEg. \nUsed cannot be greater than the credited amount\nI don't get what we gain removing the term Amount\n. what about using configurable classes instead? Spree::Config.order_confirmed_event_class.new(...). what about a more generic initializer 'spree.core.register_event_processors'?. is it possible (easy) for stores or extensions to add other subscriptions to this list? One way could be creating a custom MailProcessor class that inherits from this one, but we should probably use something like\nruby\nSpree::Config.mail_processor_class.register!\ninstead of\nruby\nSpree::Events::Processors::MailProcessor.register!\ninto core/engine.rb. not sure about this, but maybe method(:send_confirm_email) is the same here.. curiosity: how did you find/choose these weights?. is loading this plugin needed? . What about trying to create a plugin for this behavior?. since we are making changes here, what about moving all the datepicker code to a separate file?. I meant moving this behavior you implemented into a new flatpickr plugin that we'll include instead of putting this code here directly but it's just an idea for better isolate this functionality that we could choose to replace later. Anyway maybe it's better to wait for other core team members opinion on flatpickr before putting too much effort here. Thanks!. what about taking advantage of this PR to change this variable name to original_gateway_type?. I'm not sure if it's worth specifying that this attribute is no more on the Inventory Unit but it's calculated from the associated shipment of the Inventory Unit. . or moved from a stock location into another?. frontend is not based on bootstrap. It just uses skeleton for grids instead, ref:\n\nhttps://github.com/solidusio/solidus/blob/2fcabc9518175cddebd6076fea3a7f914e702022/frontend/app/assets/stylesheets/spree/frontend/_skeleton.scss\nwww.getskeleton.com\n. It's not immediately clear (at least to me) how this section is related with stock management. I'm not saying it's not related but I think we should specify how here.\n\nWe should probably say that the return authorization is something that allows to create ReturnItems. Each ReturnItem in associated with an inventory unit that can be restocked when order items are received back. You can follow the code here to see what happens. \nDo you think it could make sense to add these information?. > Each Spree::Variant in a store has a corresponding Spree::StockItem object\nit has a corresponding Spree::StockItem object for each stock location present in the store. So the same variant can have more than one Spree::StockItem associated objects.. for the sake of the example, is it relevant to say that the item should be backorderable? Maybe it's more clear if we remove this concept from here and use a positive number for the initial count_on_hand. WDYT?. Maybe here we should say that orders that contains backorderable stock item/inventory units (not sure which concept it's better to mention here in order to not increase complexity) can not be shipped until that stock item has been restocked in the stock location. Not sure if we have other guide for this topic, maybe we can just link there?. Cool, makes sense!. Agree with @tvdeyen , attr_reader for @options will make this class more consistent.. I think we don't need this distributed_amounts  reader method here. I think that this won't work if the current shipment only has inventory units in a different state, eg backordered. In this case all? returns true and it will incorrectly move the shipment to ready. I think that with InventoryUnit.pre_shipment scope we'll also cover backorders inventory units. No, I meant changing inventory_units.on_hand.all? {} into inventory_units.pre_shipment.all? {} but I'm still not sure we'll cover all scenarios since we'll filter out all canceled inventory units (making the || iu.canceled? check in the block useless). I need to understand better what that code does, and which kind of inventory units we expect to have when the shipment is ready.. yes, please let me (and/or other users as well) think a bit about this, thanks again!. what about using the new ruby syntax here? .format(with_currency: true). maybe here we should link the Order::NumberGenerator which allows to change how this number is generated. WDYT?. this state needs a link to its own documentation like shipment state, right? I assume it's not here since the payment docs is not merged yet, what about a todo? is it possible within the list?. the calculate -> they calculate?. provide -> provides. Do you think we should change the label in the admin UI?. what about moving Flat rate per package item immediately under Flat rate? Maybe being closer could help readers following their meanings?. is the text between parenthesis really needed?. should we say that this code (spree_current_user and authentication helpers)  goes into a controller? Or is it too obvious?. Maybe we should put this div into the if available_locales.size > 1? I think there's no reason to keep the html if empty.. Do you have ideas about why this is needed only in this specs and not in other files that uses I18n?. Have you considered using some more explicit string to mark locales available, like active: true? \nI know it's not a proper translation but how can a user easily understand that this key is what will make the translation file available?. why @private?. Got it after reading https://github.com/solidusio/solidus/pull/2629. why not using the new call here and remove the Deprecation :warn stub?. I have the feeling we can avoid this expectation: if run! is called the next expectation will fail, right? Is there any other reason you wanted to set this expectation?. I think this can be a let outside the before block. I think @controller can be called as controller without the @ here. . you can move this ability setting in a before that lives into the context authorized user since it will be applied to all its scenarios.. Ok! I thought that since it's a single line it would be better to compact those paragraphs but here is your land, I will update shortly! \ud83d\ude04 . done!. There's a promotion_code_id on Spree::Adjustments. Maybe it's better to update that attribute instead of removing it?. since the join_characters is included into the promotion_code_batch we are initializing the BatchBuilder with, what's the purpose of also passing it as a keyword argument? I think it could be better to keep the .new identical and work inside the BatchBuilder class to make the join_characters an instance attribute instead of a class level one. why not using let! here?. I tend to avoid instance variables in specs as much as possible and I'd like to even discourage future developers to use them (watching them here could make them feel like it's ok to use). I understand here it makes sense though. Maybe using around instead of before/after would fix the issue and will avoid using any instance variable?. what about moving this into /guide? I just don't want to confuse devs that see this package.json in the root and maybe expect to be able to build something useful for solidus development? I think that the yarn commands can be run into that folder directly as well, right?. why stubbing this method is needed?. I'd move this expectation into the it block. It makes specs easier to read and we are not DRY anything here since it's just applied to a single spec.. should assign -> assigns. should not change -> does not change. I'd remove the .after_create spec (it's a Rails responsibility to test it) in favor of a more high-level test that ensure that the order is properly recalculated after its creation.. this migration and file should be named  add_apply_to_all_to_variant_property_rule to be consistent with the rest of migrations in the project. mhhh we've probably had some change in that file in the meantime, or I missed something while rebasing. I honestly can't recall why that var was required, I'll investigate soon, thanks :). Maybe Setting this to false is misleading? \nIs this statement referring to the result of the call method on the class specified in this preference? If yes maybe this is not the right place where to put this information or it needs to be adjusted?. #### This comment is not blocking.\nMaybe it's just me but I find this preference naming a bit complex to understand. For me it's not immediately clear what it does and what's the purpose of this preference. Maybe it would be better if it was wrapped into a Spree::Order#needs_shipments_building? or something similar? What do you think?. is this file needed?. I can only access the http version. Maybe it's better to use that link version?. It is a bit twisted for me that @taxons will contain the paginated version of taxon which sets an ivar named @taxons which contains the taxon scope. \nWhat about naming the memoizing method taxons_scope or all_taxons or something similar?. This line was useless, right?. I started with that in mind and this has been my first attempt commit. Than I saw #547 and investigated a bit more in the cancancan doc and I found this page in their wiki which says that rules are logically or'ed and I think it's a good way to avoid duplicate logic or move it into a method which I don't know where to place.\nWhat do you think? I'd go more with this and change the commit message to better reflect its content (thanks for noticing that). I'd prefer splitting these in two lines, so git history is easier to read when these change. But it's just a non-blocking preference \ud83d\ude42 . maybe we should also change this line?. Sure, but I prefer this way for clarity and cleaner git history if the block content changes in the future.. This comment needs to be updated. here as well. this comment needs to be changed. I don't think store_credit_reason here is needed anymore. I think we can use store_credit_reason here. maybe we should use the active scope here?. has an -> has a. doesn't have an -> doesn't have a. same as above. same as above. same as above. I'd use another variable or method @sorted_stock_lcoations for that. It should also help backward compatibility if someone extended this class and was using the @stock_locations ivar. what do you think?. I think that if we document this change well in the PR and in the guides it would be enough. Yes, you are right. One option could be creating another @active_stock_locations ivar, use that in the whole class instead of @stock_locations which could be deprecated with DeprecatedInstanceVariableProxy. I feel like it's too complex though, maybe a changelog line is enough here. I'd say, let's see what others think before.. Talked with @gmacdougall about this. Since the default sorted is returning the same thing as before maybe no one will have unexpected behavior with this, so I'm ok leaving it as is.. why calculators?. maybe this text as well?. too much indent?. maybe we should mention that at this point the order could be merged with a previous user's order?. I'm not sure that this is needed actually. I think that shipments become ready when the payment is paid (no balance due), no approval needed.. doesn't this happen when the shipment is shipped?. why this is needed here?. is it needed here?. does this happen only when a user logs in via web app?. We could even use another separate header maybe? Is there some benefit in using X-Spree-Token for JWT as well?. who saves this token on the User?. @tvdeyen after your review I just changed this line from:\nruby\nexpect(page).to have_content(\"How do I use this\") # TODO: check visible class\nsince I did left that TODO but totally forgot to fix it before pushing.. Sorry, I still think this should not stay here, doesn't this happen when the order is completed without the need for the admin to do any approval?. The inner content needs an indentation here. why manage if the link is for creating orders only?. why manage and not create?. same question as above. Thanks for the suggestion, I've documented that in the commit message. I prefer not to add comments in the code and if we forgot and keep monetize locked to 1.8 is not that critical. If someone will need to update monetize to 1.9 a git blame will document the why of this. Does it make sense?. By default only this permissions set is activated. I think that at line 10 it sets the create ability for Order. Are you setting the other permissions for a specific user in some way via code?. you are right, fixed!. can you please also:\n\nupdate documentation on line 80, that mention the html: true param\ndeprecate the html option into solidus, so that if stores devs are still using it, they will be notified that they need to change their code to pass html_wrap instead. Can you please document this change? why is this needed?. Wait, this should stay under 2.8.0 instead!. Not sure where/what changes having this text as comment, can you please explain better?. Done and squashed changes into 3f33fa199e889251c517a60c4ac98be958248b4c. I did read the commit description but still can't understand the final effect of this. Will that text be invisible in GH? If yes, what about the Steps to reproduce title that will still be visible without any content inside?. Shouldn't be the currency taken from the order where the calculator lives instead?. Gotcha, thanks for the explanation. I have no strong opinion around that but I'm seeing that it's also used here so \ud83d\udc4d . What about opening a new PR for this? I think it's not really related to this PR and could make sense to have a separate discussion around that. . Honestly I'm not a fan of putting a list here. We could miss some important ones, what about:\n\n\nSolidus strives to be inclusive of as many contributors as possible and welcome all contributors and partecipants.\n\nI feel like this already says everything and we don't need to add specificity here.. I'm more for a positive language tone, what about:\n\n\nParticipants are encouraged to foster a positive and cooperative environment\n\n\n?. What about\n\nHave questions or something to report?\n\nI'd also add a comment about who will read this email (the core team? the \"community manager\" only?)\n. I'd also add:\n\n\nPartecipants should criticize, judge or blame ideas rather than people behind them\n\n\nwhich in my opinion is very appropriate for the kind of interactions that currently happens in our project.. I know it's not popular but I'd remove this one for now since it's not yet clear what is considered harassment, who will not tolerate that behavior and the actions we can take.. I thought the same but it's a private method, do we want to use deprecations for those as well?. @elia We don't have a real policy around that but we usually keep deprecated method around for at least a couple of MINOR releases, often much more than 2 \ud83d\udc7b . Another approach could be stubbing the deprecation warning \nexpect(Spree::Deprecation).to receive(:warn). why can't we use plural_resource_name here?. Why the limit(quantity) is needed here? Shouldn't current_shipment.inventory_units.where(variant: variant).on_hand already return only the inventory units present in the shipment for this variant, which should not be more than quantity?. I think we can take advantage of this change to also change Spree::Shipment.table_name instead of the hardcoded spree_shipments. Yes, exactly.. what's the result of this? Maybe we can just use that string without the need of including a helper here.. chatted with @bitberries on Slack, I think that's the best way as well.. just wondering why we are not using ActiveRecord build here. Is there a specific reason? I think you can even do @promotion.build_promotion_code right?\nSame in the create method where it's not a conventional create. I'm taking a look at scaffolded rails controller templates.\nLet me know! . I alway use this syntax, which avoid useless duplication so \ud83d\udc4d . Is it possible to have the script inline without the need to add another script file? I personally prefer a less readable line than a new file in the project that is used in a single point.. Does the test fail without this line? Also, maybe we can assign the user to the order in the factory instead, WDYT?. Yeah, .circleci/bin/halt-for-doc-only-changes.sh would be my preference. Since you have the error hardcoded at line 39 maybe it's better to check the expected result so that we are super sure we are testing the right thing, for example if both assigns(:widget).errors.full_messages and response.body are empty we could have this test passing even if it's not what we expect.\nMy suggestion is:\nruby\nexpect(response.body).to eq 'You cant destroy undestroyable things!'. @gylaz Thanks! So also the other entries are not valid?. Done, thanks!. please remove this line. What about reformatting code as:\n```ruby\norders_includes = [\n  :user,\n  :payments,\n  :adjustments,\n  :line_items\n]\n@orders = paginate(\n  Spree::Order\n    .includes(orders_includes)\n    .ransack(params[:q])\n    .result\n)\nrespond_with(@orders)\n```\n?\nI think this reduces the complexity since: \n\nwe have less variables around;\nI think it's better to rename order_includes into orders_includes since it refers to a query to retrieve a collection of orders;\nhaving the includes called before ransack and result looks more natural to me, even if I don't have strong opinion here.\n\nWith yield_self of Ruby 2.5 we could have simply done:\n```ruby\n@orders = Spree::Order\n  .includes(orders_includes)\n  .ransack(params[:q])\n  .result\n  .yield_self { |orders| paginate(orders) }\nrespond_with(@orders)\n```\nwhich is much cleaner IMO but we still need to support older Ruby versions. \ud83d\ude22 \nAlso, what do you think about moving order_includes as a private method in the controller?. Same here:\n```ruby\nLet's evaluate moving this into a controller's private method\nproducts_includes = [\n  :variants,\n  :option_types,\n  :product_properties,\n  { classifications: :taxon }\n]\n@products = product_scope\n  .includes(products_includes)\n  .ransack(params[:q])\n  .result\n```\nWDYT?. can you please change the namespace/inheritance stuff into one or more other commits, so they are independently  documented? Also, why are these change needed?. Also, can we please document why this change is needed in this PR?. I know there's no easy way to get these zones set up correctly with factories and we should give a simpler interface around this but in the meantime I'd rather start moving these ivar into let! instead of adding new ones. Do you think it's doable here?. can't we just use self_and_ancestors?\nruby\nSpree::Taxon.associate_parents(taxons.each(&:self_and_ancestors))\n. What about adding this code to the legacy stock system extension instead?\n. Can't we share the support file introduced in core via #3005 ? Maybe moving the module in core/lib into the testing_support folder?. This line is assuming the step after delivery is the last step, which is not the case for everyone since steps are configurable. Is there a way to refine this check in order to be more generic?. Is restarting the flow required? I think it will move the order to cart, and it's also not clear why next! is needed. What if we just push the user back to the delivery step?. This should fix the issue but what about using ingored_columns instead?. This path should probably not contain _admin_. Also maybe we should use _path instead of _url, right?. not sure how this could pass if the path in the controller was wrong, can you please double check?. I'd remove one space after header, it's aligned to pattern on the line above but if that line changes in the future we'll be forced to change this one as well and this is not ideal for git history. What do you think?. @aitbw good catch!. Maybe this logic should go into the VariantGallery directly. Also, I think it can be simplified with something similar (didn't test):\nruby\ndef images\n  @images ||=\n    @variant.images.presence ||\n    (!@variant.is_master? && @variant.product.master.images).presence ||\n    Spree::Image.none\nend \nI think it's safe to assume that each product has a master variant without the need to check that.  What do you think?. Thanks for the detailed response!\n\nNice point, but since variant gallery class could be changed in config isn't it better to leave this implementation inside Variant class?\n\nNot sure which benefits would we have doing this, can you please explain better what's your concern? In my opinion this is a logic only related to which images we want to display for a variant and should stay in this VariantGallery class that has been added exactly to cointain this kind of logic.\nI think .lenght and .presence are equivalent since they make the same query.\n```text\n.presence\n  Spree::Image Load (0.3ms)  SELECT \"spree_assets\".* FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_id\" = ? AND \"spree_assets\".\"viewable_type\" = ? ORDER BY \"spree_assets\".\"position\" ASC  [[\"viewable_id\", 20], [\"viewable_type\", \"Spree::Variant\"]]\n.length.zero?\n  Spree::Image Load (0.3ms)  SELECT \"spree_assets\".* FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_id\" = ? AND \"spree_assets\".\"viewable_type\" = ? ORDER BY \"spree_assets\".\"position\" ASC  [[\"viewable_id\", 20], [\"viewable_type\", \"Spree::Variant\"]]\n.size.zero?\n   (0.2ms)  SELECT COUNT(*) FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_id\" = ? AND \"spree_assets\".\"viewable_type\" = ?  [[\"viewable_id\", 20], [\"viewable_type\", \"Spree::Variant\"]]\n```\nYou are right about .size being more efficient only if we don't need to also take records anyway, so only when there are no images for that variant. I think this is an implementation detail though and we should just rely on the method that fits more in terms of code readabilty/simplicity here.\n\nMaybe update those test cases?\n\nYes, specs there use:\nruby\nlet(:variant) { Spree::Variant.new }\nwhich is fast but I think it does not reflect an intact data representation.\nMaybe we should use:\nruby\nlet(:variant) { build_stubbed(:variant) }\nand probably, into another PR, we should also add a validation on the variant since right now we can't call .valid? on an instance of Spree::Variant that does not have the product set:\nruby\nv = Spree::Variant.new\n=> #<Spree::Variant id: nil, sku: \"\", weight: 0.0, height: nil, width: nil, depth: nil, deleted_at: nil, is_master: false, product_id: nil, cost_price: nil, position: nil, cost_currency: nil, track_inventory: true, tax_category_id: nil, updated_at: nil, created_at: nil>\nirb(main):090:0> v.valid?\nTraceback (most recent call last):\n        1: from (irb):90\nRuntimeError (No master variant found to infer price)\nHope this makes sense but feel free to let me know if you think it doesn't. \ud83d\ude42 . > Maybe a client code could benefit from this model method somewhere else without being required to use VariantGallery class\n\nAlso a different variant gallery class could decide which method to use\n\nBoth are legit concerns IMO but it's very simple to add that method into a user's app via a Spree::Variant decorator or directly into a custom variant_gallery_class if needed and I'd prefer not to add another public interface (that we'll need to maintain) unless this is strictly needed.\n\nShould I create an issue?\n\nDone: #3036\n. Can we avoid using should in favor of fallbacks here? Also, there's an extra space after variant.product.master.images.. Technically it should be an ActiveRecord::Relation not an array \ud83e\udd13. I'd avoid specifying what it is at all here, ... is empty is enough IMO.. can't we do this anyway without this extra param?. Why do we need to set all these associations here?. Sure, makes sense and I didn't recall that param. Thanks!. Thanks for pointing this out @mdesantis !\nThere's a uniqueness validation on value so if that value is already used (let's say the code has been already moved manually into the Spree::PromotionCode) it will raise an exception.\nWhat about using Spree::PromotionCode.find_or_create_by!(value: value, promotion_id: promotion.id) instead? \nI think this way it will only raise if the value is not unique and that value has been used on a Spree::PromotionCode associated with another Spree::Promotion. It will do nothing if the current Spree::Promotion already has a Spree::PromotionCode with the same value.. This is very similar to what I did first but to test all the possible proposed approaches I ended up creating a method. I know it's not ideal but I can't think to other solutions for this. Feel free to suggest how can I keep this code tested reducing its complexity.. I'd not say ActiveRecord methods here, they are more generic class-level methods. For example, the acts_as_something methods coming from other libraries are not ActiveRecord.. I think this line is not really needed, we should have the same result without it.. To expand a little bit, in the example gist provided they also have:\nruby\n    # Class methods\n    module ClassMethods\n      def ransackable_associations\n        %w(...)\n      end\n    end\nwhich contains methods injected at a class level but we haven't added that module into the example so that prepend is not needed. I'm fine both with and without adding that extra scenario.. what about moving if: -> { product && product.master } here?. What about adding a presence validation on the product here? There are too many places where Solidus gives for granted that a product should be associated with a variant and I think it could make sense to don't allow saving a variant without a product associated. Also, this way users will have the right validation message attached to the invalid object.. I'd say a more generic:\nThe coupon code you are trying to remove is not present on this order.. why not using the coupon_code attribute of this class here?. I'm not sure about this. It's both not really related to this change and I think it works only since Spree::Order#coupon_code is a method but it won't work if you apply this syntax to a variable, for example:\n```console\n\ncoupon_code = 'TEst'\ncoupon_code(&:downcase)\nNoMethodError: undefined method `coupon_code' for main:Object\ndef coupon_code; \"TEst\"; end\ncoupon_code(&:downcase)\n\"TEst\"\n```\n\nAlso, I think it's not working as expected (the string is not downcased).. @skukx agree but these validations were already there, they have just been indented due to the module change. I think that if we want to change them we need to open another PR and deprecate existing methods.. This could potentially create issues with payment sources that have already been added to a user and are no more valid - for example, if you already have duplicates and try to update one of them, right?\nI'm not sure what is the best way to handle this, maybe use this validation only on create so it does not apply to already added payment sources?\nAlso, how did you have this issue? Can you share the reason/scenario behind this problem (which I see exists)?. just read https://github.com/solidusio/solidus/pull/3007#issuecomment-448727125 - nevermind\n. Should we also change this : coupon_code_already_removed to reflect the message? \nI mean I could even never have applied this coupon to the order but this way seems that it was previously there, right? Or maybe I'm missing something?. build_master is a method coming from has_one association. That variant will be associated with the product automatically so I think it will be valid, even with the proposed product presence validation.. I'm \ud83d\udc4d on using this syntax but \ud83d\udc4e on adding a code comment. I think you could add a reference in the commit description instead (please keep it all in a single commit \ud83d\ude42).. what about this , :js? Why is this needed?. Thanks for pointing this out @aitbw! \nFollowing docs I've done this way at the end:\nruby\naccept_alert 'Please select the split destination.' do\n  click_icon :ok\nend. This image links to itself for some reason and this is not ideal since we are saying on the previous line:\n\nYour logo will show up here with a link to your website. . We are using Sponsor here and saying thanks to bakers into the text. This is kinda confusing and I think we should explain better the difference between the two.. Do you think we can use permalink_part_changed? here to change the permalink_part only when it is changed?. This change also has effects on permalinks of children. Can we test that it works with children as well?. it's parameterizes here, right?. I think the test you added is testing that the permalink is correctly saved when it has a parent taxon. I mean to test when the taxon with special chars has children instead (like sp\u00e9cial&charact\u00e8rs/child for example) so we can see the parameterization reflected on those taxons as well. Anyway the test you added can stay, better to have that as well. \ud83d\ude42 . Makes sense, can't see any clean solution here. I agree it's better to keep it as is.. We use to redefine modules/classes into existing ones by repeating their inheritances on each level, see https://github.com/solidusio/solidus/pull/2572 for example for more information. In this case, it would be:\n\nmodule Spree\n  class Image < Asset\n    module ActiveStorageAttachment. Since we are deprecating not setting an attachment module I think we should not encourage leaving it empty. I think it's better to provide both options for now (with Paperclip setting commented) or remove the Paperclip statement at all since new stores should not use Paperclip.. I'd enforce the deprecation here as well.. I'm sure there's a good reason for this, can you please explain it better? Maybe it is worth a separate commit?. maybe adding more context about why this setter is needed in the commit message could help inexperienced users (like myself \ud83d\ude04) understanding. . What if this module is someway loaded before Spree::Image?. if we plan to have multiple event processors maybe we can change the folders/modules structure to accomodate this? Something like: spree/event/processors/mailer. WDYT?. I always see SUFFIX for this kind of things. Anyway, what about making this configurable?. I don't get the comment, can you please expand a little bit?. What do you think about keeping the format of the rest of the CHANGELOG? I mean, adding a reference to this same PR since the number could be useful to easily find the context of this change. . You are right, going to remove that line now. No, I think it can work but I'd still change it for consistency. I also found this related PR https://github.com/solidusio/solidus/pull/2098 and I think the goal there was to explicitly inform the type of all the modules/classes involved in the inheritance.. I'm not sure it's a good idea to keep this line number. It's very hard to maintain and it's super easy to find a method into a file with all editors or browsers. Not sure if it's better to take advantage of this change to remove it or we could remove it also in other places (if any) with another PR. WDYT?. We have this entity cited into Tax adjustments section as well (line 64). What about adding the link for that text as well?. This is what is being suggested in other parts of the guides, eg: https://guides.solidus.io/developers/shipments/custom-shipping-calculators.html\nWe use that initializer in our apps so I'm totally for that. For consistency, I'd like to change this everywhere in guides, what do you think?. Ok, I agree that it can be moved but I'd remove the comment then.. Done, thanks for the suggestion!. > Lets say I have many subscribers in my codebase defined with the static string 'order_finalize' and one day down the road that topic name changes. When I run bundle update, all of sudden my code breaks.\nThat's true, even if no one ensures us that someone just skipped the usage of the constant and used its content (the string) instead to subscribe to events. In that case, those stores would break in the same way. I imagine a way to change an event name could be:\n```ruby\nSpree::Event.instrument 'new_event_name', order: self do\n  # Do stuff\n# Instrument the old event as well, so old subscribers will be happy\n  Spree::Event.instrument 'old_event_name', order: self\nend\n```\nWe should also find a way in the Spree::Event#subscribe to deprecate events so subscribers to old events would be notified that it's time to change the name of the event.\nMy point is that if we decide to use constants but we still need to implement something similar cause we can't be sure devs used strings or constants while subscribing to event, I can't see a real advantage introducing them.. What's the difference here? Shouldn't they return the same thing?. what about also moving this file into the Demo folder?. What about firing two events? One for success and one for failure and subscribe to the success one for email sending? I\"d also remove the TODO in favor of something else, maybe an issue where we discuss about deprecating all hooks in the project, in favor of an event. . We'll probably have more subscriptions here with time. What about adding one per line, maybe alphabetically sorted?. Trying this out and it returns just one shipping method ID also for:\nruby\nActiveRecord::Base.uncached { store.shipping_method_ids } # => [3]\nin the test you wrote.\nAlso, the query seems a bit too much for what it should do:\nsql\n(0.6ms)\nSELECT DISTINCT \"spree_shipping_methods\".\"id\"\nFROM \"spree_shipping_methods\"\nLEFT OUTER JOIN \"spree_shipping_method_stock_locations\" ON \"spree_shipping_methods\".\"id\" = \"spree_shipping_method_stock_locations\".\"shipping_method_id\"\nINNER JOIN \"spree_store_shipping_methods\" ON \"spree_shipping_methods\".\"id\" = \"spree_store_shipping_methods\".\"shipping_method_id\"\nWHERE \"spree_shipping_methods\".\"deleted_at\" IS NULL\n  AND \"spree_shipping_methods\".\"id\" IN\n    (SELECT \"spree_shipping_methods\".\"id\"\n     FROM \"spree_shipping_methods\"\n     INNER JOIN \"spree_shipping_method_categories\" ON \"spree_shipping_method_categories\".\"shipping_method_id\" = \"spree_shipping_methods\".\"id\"\n     WHERE \"spree_shipping_methods\".\"deleted_at\" IS NULL\n       AND \"spree_shipping_method_categories\".\"shipping_category_id\" = ?\n     GROUP BY spree_shipping_methods.id\n     HAVING COUNT(DISTINCT \"spree_shipping_method_categories\".\"id\") = 1)\n  AND (\"spree_shipping_methods\".\"available_to_all\" = 1\n       OR \"spree_shipping_method_stock_locations\".\"stock_location_id\" = 1)\n  AND \"spree_store_shipping_methods\".\"store_id\" = ? [[\"shipping_category_id\", 2],\n      [\"store_id\", 1]]\nThere are some suspect join with categories, which I'm not sure why are there and if they are needed here. Can you please investigate a little bit more?. ",
    "mamhoff": "This is what we do as standard procedure anyways. . This issue is not actionable, closing.. The referenced PR has not been merged, and from what I see Solidus still does not preserve selected shipping methods when running Spree::Order#create_proposed_shipments. I would be a nifty feature to have, but likely add more complexity to the Stock coordinator. There has not been any activity on this feature for more than a year now; closing. . One thing that we needed was the ability to create payment sources without an associated payment, so we could allow users with subscriptions to switch their payment method between \"orders\". \nAlso, with the European payment sources, we needed some kind of abstract idea of a payment source, and a #payment_sources association on the User model that supports polymorphism. I know polymorphic associations are a pain, but here I think they actually make sense. There's a PR on the Spree repo already which probably won't get merged anymore: https://github.com/spree/spree/pull/6831\nI'm really not set on the details here, mostly I'm interested in something like this being possible without too much patching.\n. @Kingdutch in my opinion, iDeal does constitute a payment source, maybe something like an IdealWallet, especially if there's any way of re-using an iDeal payment source for a future payment. \nThe payment interface class you're talking about exists already, it would be Spree::PaymentMethod. \n. For supporting VAT, I need to be able to modify prices as well, but automatically. I have time for implementing this, and if this discussion comes up with something useful, I'd be more than happy to use that.\nIn https://github.com/solidusio/solidus/issues/532, @cbrunsdon mentioned that the core team prefers a solution that'd be as simple as possible. I reference this issue here so I can close #532.\n. Is the PriceSelector that's been in core since 1.3 good enough to close this issue? Are we missing features?. @acreilly is working on this. Why don't you let customer support change the email address and then send out a password reset token? . I think it was done to speed up things. In https://github.com/spree/spree/pull/5650 and https://github.com/spree/spree/pull/5650/files you'll see that it can be anything, really, but that it should be 'country' when it's a Spree::Country and state when the zone contains states. \n. I believe this issue was created to facilitate migrating a 3.0 store to Solidus. This goal has been accomplished in 1.4 at the latest. Closing.. FYI: While the initial need for the PR was MOSS, the PR also fixes a number of idiosyncrasies of the old VAT code (like the strange idea of \"refunding\" taxes when outside the default VAT zone). The big catch is that with the PR, product and line item prices actually change depending on the user's tax_address. There's another PR to allow more variables to influence prices (notably: Is my customer a tax exempt for some reason?): https://github.com/spree/spree/pull/6662\n... and one that fixes rounding issues with VAT https://github.com/spree/spree/pull/6645/\nIf you have any questions, do feel free to reach out. \n. We decided to just not have whole-order promotions. Your case is still sort of manageable, but if you have differently VAT-taxed items in your cart, the taxation of whole-order promotions just becomes a huge mess. You start having questions like how much of the promotion would apply to reduced VAT goods, and how much of the promotion would apply to the rest? \nOh, and mixed carts are just plain impossible with the VAT calculated on the order. \nAs for your case: Couldn't you tax adjust the order by the included VAT of your promotion?\n. So... it turns out this one might be interesting, too: https://github.com/spree/spree/pull/6852. Here I fix the ReturnItem so that its amount is a price including VAT but excluding promotions, which is what the thing was originally intended for. \n. I'm back from holidays, and will hopefully get some time to spend on this one. I'd like to get feedback on a number of ideas I've been having, hopefully making the entire taxing thing quite a bit more elegant:\n1. Sales taxation works well - it should work just as it did before. \n2. Prices should always be right. The tax system should adjust them as soon as they are added to the cart OR as soon as the customer changes the relevant tax_address. For this, there should be a TaxAdjustedPriceCalculator. For example: When shipping from a VAT-country to a non-VAT-country, that thing is responsible for removing the included tax from the price entered in the backend. If another VAT rate applies, it adds that other one. \n3. The Spree::TaxRate class should do no updating (and especially no update_attributesing) of line items. \n4. There should be a Spree::TaxAdjuster class that creates the correct adjustments. I'm almost in favor of one Adjuster class per total column (Spree::TaxAdjuster::LineItemAdditionalTax, Spree::TaxAdjuster::LineItemIncludedTax, Spree::TaxAdjuster::OrderIncludedTax etc). All of these would be pretty small, and called in a configurable sequence. \n5. There should be no multiplication or implicit rounding in the database (adding is fine). \n6. As much as possible of the tax rate selection should happen in the database, and as little as possible in ruby. \nEspecially the second one of these points will drastically simplify tax rate selection and allow a pretty large, beneficial refactoring of a number of fun spots.\nOh, very important: the semantic meaning of included taxes is that they are already included in the price. There should be no included tax adjustment that affects a line item total or order total (lamentably, that is the case right now). As a general rule: \nruby\ntotal = price * quantity - promotions\npre_tax_total = round(total - included tax)\nAs far as I'm concerned, the pre_tax_amount column is not necessary unless it's there for performance reasons. \nIf anyone has input on anything here, do weigh in. Especially naming is paramount, and I might not have come up with the best names for everything. I'll be collaborating on this with @peterberkenbosch :sunglasses: \n. Closing since 1.3 has been out for a while.. While time gating looks like very similar behaviour in different models, some things have needs that are really quite different from others. For example, Spree::Promotions starts_at field would be poorly named if used in the context of a Spree::Product. When I took a stab at making historic pricing happen, I went without an expires_at (or equivalent). I don't like the idea of a shared module or mix-in for this functionality. \nStill, I'd like to see some conventions in place so that we don't end up with\n- valid_from\n- expires_at\n- active_on\n- starts_at\n... and so on, all meaning very similar things. What about a naming convention like \n#{adjective}[_from,_until]:\nProduct#available_from / Product#available_until\nPromotion#promoting_from / Promotion#promoting_until\nTaxRate#valid_from / TaxRate#valid_until\nShippingMethod#operational_from / ShippingMethod#operational_until`\n(I'm not to keen on the concrete adjectives, just on the pattern)\n. I think that can be done, with an API kinda like this: \nclass Spree::MyModel\n  time_gated_by :available\nend\nI'm just not too sure we can actually guarantee that the behaviour will be the absolute same for all models. But I'd be open if somebody were to try it out :)\n. I think you're missing some set-up. Have a look at The Spree Shipments guide - basically, you'll have to add a shipping category and shipping methods for each of the zones you want to ship to. \n. The initial attempt at directly manipulating prices in the line item did not work, as line items can get their price from all sorts of places. So right now I've been restricting myself to a more iterative approach: Simplify tax_rate.rb and zone.rb, and clean up the tests. They're still a little complicated to see through, but hopefully somewhat more readable. \nBecause the initial attempt failed, I force-pushed. Lateron, I realized that was a shitty idea because all of your comments got lost :( - I am deeply sorry for that. Otherwise, this would be ready to merge, and for the next piece, I'd open up a new PR. \n. I'm breaking this up into smaller PR's to make sure all commits pass the CI individually. \n. Closing in favour of https://github.com/solidusio/solidus/pull/536\n. Also really like it!\nI like the dark menu, and I think it does give a good contrast to the main area. We're also used to slate-gray menu backgrounds from our mobile devices, so people will get it nicely. \nI'm fine with the color palette. Gold is a tough color to nuance, and brown would be... brown. I think if people care a lot, there might be a PR to make that configurable, but really: Blue is good. If more elements can be distinguished via shades of grey, I wouldn't even mind...\nI agree with @tvdeyen that the action buttons should be signal their actions (green for creation, red for deletion). \nAll in all, this is amazing work. Thank you @Mandily!\n. The initial idea for this PR is not working out - there are many ways of setting a line item's price, and directly hooking into all of them them for deducing the merchant's home VAT (like I did it in Spree) is not feasible or beautiful. As a consequence, this is a pretty pure refactoring of the line item, adding mostly readability for the time being. Next up: Think deeply about a good way of modifying line item prices. \nThis PR is now ready to merge. Btw: I did have to force push twice to account for random failures in the back end suite. \n. Rebased. @cbrunsdon it helps, because having easier-to-read code when refactoring things helps. :)\n. OK, totally understand the concern about copy_price. I'm re-introducing it as a private method set_pricing_attributes and notify people who override it with an ActiveSupport::Deprecation. \nI don't think tackling #390 in this PR makes much sense, as this PR doesn't address changes in functionality. The idea is really just to fix naming and housekeeping. \n. Currently, what Solidus does is the following: If your customer's tax_zone is outside your default_tax_zone, and the line items in your customer's orders do not have tax categories for which there are tax_rates which are VATs (included_in_price). This sounds complex? Yep, it is, and it's also not exactly correct. \nHowever: If you're in Europe, and you don't care that your customers have line items with German prices in their carts, Spree will produce a strange \"VAT refund\" for every line item, so your customers, in the end, will get the correct price.\nThis only holds true for two cases, though: \n1. Your customer is in a place with no VAT. Then the European VAT will be refunded, and that's super. \n2. Your customer is in a place with VAT, and that VAT has exactly the same amount as yours. \nIf your needs go beyond that, you'll have to wait for a bit. \n. You should be able to set this up with Solidus as it is right now. \nCreate a zone for Europe with all of Europe inside (I do believe there's a seed that can do this for you). Make this zone your default zone. Add a tax rate: 19%, included in tax, zone: Your only zone. Solidus will do the right thing. \nPromotions get adjusted as well (tax is always calculated after promotions). This does mean that if you were to give a fixed-sum promotion on a line item, your US customer would only get the net value of that fixed-sum (which is actually the correct thing to do IMO). \nThere's also no need to write a custom tax calculator, this works out of the box. \nThings Solidus can't deal with for the time being: \n- Tax-free delivery to business customers\n- Changing gross prices as required by MOSS\n- Anything to do with more than one VAT for the same tax category. \nDon't use order-wide promotions if you can avoid them. They're a bookkeeping nightmare. ;)\n. Let's wait with this one until we can actually manipulate prices. \nLet me quickly explain what's going on here: The default_tax_zone indicates what zone's VATs apply to the prices entered for variants in the backend. So a German user would enter 19.99 for an item whose net price is actually 16.80 (at 19% VAT). As things are now, when you ship to a place outside the default VAT zone, the default zone's VAT would be \"refunded\".\nIf you ship to another place with VAT, the German VAT will not be refunded, and the other place's VAT would be applied. This leads to wrong net prices (same prices, different included tax --> crazyness).  \nOnce we have tax-adjusted line item prices, there would be no need for the refunding anymore, as for that case the price for the line item would drop to the net price. It will even be possible for a Solidus integrator to not specify a default zone, and prices would be adjusted up once users decide to ship to Germany. \nReally though, I'd say put this on hold and leave it for the time being. We're right now working on improving the taxation tests, and once those tests are in, it'll hopefully be possible to see more clearly what setting a default VAT zone does. \n. No, we're not. First, I need to be able to recalculate line item prices,\nwhich is like three commits away on the PORO PR.\nOn Jan 25, 2016 5:07 PM, \"Clarke Brunsdon\" notifications@github.com wrote:\n\n@mamhoff https://github.com/mamhoff Are we good to pull the trigger on\nthis one for 1.3? I'm still honestly pretty fuzzy on how it fits into the\nlarger changes.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/pull/527#issuecomment-174720741.\n. I cherry-picked that upon https://github.com/solidusio/solidus/pull/747, because this can only go when that's implemented. Closing. \n. Will do.\n. Uh, wrong one. sorry. \n. The build failure is due to some CSS not being found. I'm reasonably sure it's nothing to do with stricter expecations on zone associations :) \n. I'd like to, but Github doesn't let me. Would it be an option to create a branch for the VAT refactoring, and I just point all my PRs to that?\n. Rebased.\n. Sped up Spree::Zone.with_shared_members a little, and rebase on current master. \n. I'm in the process of writing requirements in RSpec for all of this, so that's a step. The problem with MOSS is that it requires the price of the line item to change before we apply taxes. So it's a two-step thingy: First get the price right for the area you're sending to, then calculate promos and then the taxes that actually apply. \n\nFor this to work though, I need some place where I can obtain the original price of the line item. It can't be the variant (even though that would make most sense). It could also be yet another column on the line item (initial_price?). \n. For the time being, I'll go with an initial_price column, but if a framework for modifying prices shows up that can be used for this, I'd be more than happy to incorporate it. Thank @cbrunsdon for the feedback!\n. Rebased on current master in order to remove some noise. Still not yet ready for prime time as I'm waiting on comments regarding https://github.com/solidusio/solidus/pull/685.\n. I'm also closing this one in favor of #685, which when integrated with #530 does everything done here in a much nicer way. \n. Right now, there is only five invalid factories left:\n* customer_return_without_return_items - Validation failed: Return items can't be blank (ActiveRecord::RecordInvalid)\n* stock_packer - undefined method `save!' for #<Spree::Stock::Packer:0x007f7f7bed2248> (NoMethodError)\n* stock_transfer_with_items - Validation failed: Code has already been taken (ActiveRecord::RecordInvalid)\n* receivable_stock_transfer_with_items - Validation failed: Code has already been taken (ActiveRecord::RecordInvalid)\n* store_credit_event - SQLite3::ConstraintException: NOT NULL constraint failed\nSome of these are probably not easy fixes. Who takes on the challenge?. @bbuchalter I'm not sure we should be using the Solidus API for setting up test data, mostly because those factories are used in client stores where they might very well use external services to set up shipments or taxes, which would slow down many client test suites. This would mean sample data would actually test production code, leading to hard-to-debug spec setups I think. . Oh that's amazing! :+1: \n. This can be closed since #627 is in. \n. This is still an issue. I would vote for deprecating usage of the icon helper and creating a new namespaced solidus_icon helper.. @usmanasif The link above is actively developed. To find information about their progress, please consult that repository. . Is this still work in progress? Because it really addresses some annoying ones in the factories. I'd love to see this merged. \n. I'm working on #623, and running into some factories that can't be built. Some of my fixes are the same as the ones you're proposing here, and in order not to make your work redundant or get merge conflicts, I'd love to build on it. \nI understand it'd be nicer to address all issues, but the nice things about this is that all the fixes are atomic in the sense that they don't depend on each other and just make things better :) \n. @Sinetheta This is really, really nice stuff. There's a bit of stuff missing; if you want help - can I PR against your branch? \n. Since #572 has been merged, I think this issue can be closed. @jhawthorn @cbrunsdon wdyt?. The ENV check was necessary for testing the requireability of the factories. I entirely understand the ugliness of it. \nI'll remove it - for knowing whether any factories still break, we could do one of two things: \n1. Just wait for the community to cry when a factory does not load individually (probably only happens for a couple of popular factories (order, shipment, payment, line_item)\n2. Remove loading all spree factories from the spec helper and load factories in individual spec files. That'd be a large amount of work though, and probably concern of another PR. \nIf anyone has a better idea on how to test requireability ... I'd be excited. \n. Switch removed :)\n. @jordan-brough rebased!\n. I think it's good practice to include prefixes always. We had a funny one with a PromotionAction called User at one point - it was really irritating to track down and it wouldn't have happened with good namespacing. If you use multiple large engines (say Solidus and Alchemy) in the same project, you do sometimes end up with conflicting names. OrderMutex is a particularly improbably candidate, but as a general rule of thumb, I'm very +1 on using prefixes, and even ::Spree::OrderMutex style prefixes. It also helps with some weird autoloading issues. \n. Can we go on a case-by-case basis here? I know it's not as systematic as \"always prefix all the things\" or \"never prefix anything\", but in this case it clearly helped one user, and it does not really make a big difference. I'm :+1: for merging this, even if we don't have a super clear rule to go by. \n. I'm :+1: on this one. I don't see any harm in a statement that commits us to be nice to people. \n. It's the tax rate specs. I replaced them in https://github.com/solidusio/solidus/pull/536 - ready for Ruby 2.3 ;)\n. Rebased on https://github.com/solidusio/solidus/pull/657 in order to separate concerns.\n. Fixups for fixed pending specs. \n. Note also: That is the bit of code that I spent most time trying to understand and that I'm most sure about has to go away. It essentially takes in an AR collection of tax rates, and removes some if they have the same tax category. Which rate is removed depends on the order of tax rates in the collection (hence the intermittent failures in #650 I had to xit) . \n. Nice. Thank you!\n. Can you rebase this PR on current master, as well as fix the failing test? Once that's done, this PR will be up for review again.\n. The initial PR mentions that the check is similar to what's being done in tax_rate.rb. I agree that we should allow zero adjustments (both tax and promotion), as they don't really change anything. Maybe adding a scope on adjustments would help to fix that zero adjustments are shown in the view layer: \nscope :visible, -> { where.not(amount: 0) }\n. @brendandeere I should've looked up the source. Good find, so there actually wouldn't be that much to do except for using the existing nonzero scope in the frontend views. I think it's a better name than both visible or user_visible, as it tells exactly what it means. \nI think mixing up nonzero and eligible wouldn't be something I want.\n. Really? I think I'm having a pretty good time :)\nOn Jan 12, 2016 3:10 PM, \"Clarke Brunsdon\" notifications@github.com wrote:\n\nAgreed, thanks @mamhoff https://github.com/mamhoff.\nYou're doing amazing things for the codebase but you're terrible at taking\nvacations [image: :-1:] .\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/pull/684#issuecomment-171055497.\n. Force-pushed with no changes because of spurious failure in admin shipment spec. \n. Thank you for chipping in! \n\n@jhawthorn Actually, they do share code, as the order adjuster doesn't actually adjust the order, but all the items (line items and shipments) contained within it. \nThe current stuff on TaxRate shaves some AR requests by only loading the potentially_applicable rates once per order - I would like that efficiency to stay, which is why I didn't separate the two into their own classes. @tvdeyen I hear you though. Possibly I can have the best of both worlds by making the LineItemAdjuster a Singleton and cache things like the tax rates in an instance variable. \nAt the moment, Spree::TaxRate.adjust is a method that is executed for side effects (create adjustments, update pre_tax_amount), which isn't super transparent. Ideally, I'd like something to this effect: \n```\nclass Spree::LineItem\n  has_many :adjustments, ... , autosave: true\n  before_save :adjust\nprivate \n# builds tax adjustments and sets pre tax amount, but doesn't actually save\n  def adjust\n    self = Spree::Tax::ItemAdjuster.new(self).adjust!\n  end\nend\n``\n. Changed these to single responsibility objects - I do think we can deal with the efficiency after we've defined the interfaces. \n. Wheew! Green! RemovingTaxRate.adjust, which is a monster, has not been that hard after all. I'm excited: I like the API, and because of some data sharing between theItemAdjusterand theOrderAdjusterthe expensiveTaxRate.match` call is only done once. \nThis is still lacking feedback. Once that's in, I'd start putting in unit tests and moving the Spree::TaxRate into some kind of taxation_integration_spec.rb file. \nPlease please, this isn't ready for merge, but definitely ready for feedback (although you do have a couple of days as I'll be out until the weekend from tomorrow). \n. Rebased on master, updated commit message on second commit. Feedback still welcome. \nBtw: With #530 in, I'll take a go at removing TaxRate.match, too.\n. These last ones failed because of the Rails update (https://github.com/solidusio/solidus/pull/736). Rebasing on master now, and adding a couple of performance fixes as well. \n. The build failed because of phantomjs crashing :(\n. Force-pushed to get a green build. Otherwise: This is ready for review. \nI can think of more stuff to do, but the scope of this PR is already quite large, so I'll stop for now. :)\n. Damn. The shipping rates also have VAT, and they're not price-adjusted yet.\n. This is really long, and hard to review. I'll split this PR in two: One that just adds the POROs and uses #530 to look up zones (that's all commits up to a68d9c8), and one that actually implements MOSS with that. \nThe one that actually implements MOSS will also have to deal with shipping rates, somehow. \n. Did the naming changes, and also added some more tests to the adjusters. \n. First commit was failing because of a naming change, rebased again.\n. Well, the method signatures are a bit different. I could use just the item adjuster, but then that method will have abysmal performance. I'd rather have it entirely gone. However, if there's another person saying: Deprecate it and be nice about it - I'll do it, along with the requested YARD docs tomorrow. \n. :+1:, very much so!\n. Canceled orders might have associated payments (if you have the customer pay on completing checkout). In that case, \"canceling\" an order does not mean \"pretend it never happened\". It means: Restock all the inventory and refund the money. Your accountants will thank you for keeping the record. \n. :100: \n. I like this a lot. It might even speed up the abominably slow tests for customer returns (as fewer objects are created). :100:!\n. Nice! Really appreciate the work of porting over good Spree code!\n. :+1:  :)\n. Amended for better readability as mentioned. Thank you @jhawthorn!\n. The reason I believe that pre_tax_amount was introduced from a sales tax country perspective is that the form field for entering the data was labeled pre_tax_amount, indicating that the admin user should enter the reimbursement excluding sales tax, as sales tax would be added later. In a VAT country, I can not imagine the admin user actually wanting to do essentially this calculation in her head: \nI want to reimburse 10 Euros. \nMy local VAT rate is 19%. \n10 / 1.19 -->  8.40 \nOK, I enter 8.40 in the form field.\nWhat about this as a release notes approach: \n```\nWhen creating a refund for an order including VAT, you now have to enter the amount you want to refund including VAT. \nThe form field and the permitted attribute for the return item amount changes from :pre_tax_amount to :amount`. \n```\n. We have an issue with currencies not using two digits in a lot of places, most notably in the database, where a lot of money-related columns can only store two digits. Also, there's a bunch of places in the code that handles doesn't handle anything else well (for example, in the default tax calculator).\nI agree rounding should be tackled more explicitly, and probably at the level of the Spree::Money object. However, that's a much bigger task, and I don't see how this PR would make that bigger task more difficult, which would be a reason not to merge it. \n. Actually, the Spree::Money object is never used for calculation in core, only for display purposes. See https://github.com/solidusio/solidus/search?utf8=%E2%9C%93&q=%22Spree%3A%3AMoney%22+in%3Afile+core%2Fapp+in%3Apath&type=Code \nChanging that so that Money objects get used for calculations instead of BigDecimal or (behold) Float would be amazing, but also a huge pile of work. \n. @jhawthorn Yep, that's true.\nCould we imagine something along the lines of \ncalculated_amount = return_items.map { |ri| ri.total.to_d.round(2) }.sum\npayable_amount = sum_of_line_item_totals - sum_of_already_refunded_return_items\n[calculated_amount, payable_amount].min\nThat way, for the two items you call out, if you refund partially, the first time you'd get [20.01, 10.01].min = 10.01, and the second time you'd end up with [10.01, 10.00].min = 10.00. \n. After doing some more research, I believe this will have to be solved in the default_refund_amount calculator. Because that's where too high rounded refunds come from. I'll close this for now as it clearly needs more thinking.\n. There's a great library for handling multiple currencies: https://github.com/RubyMoney/money - and we're already using it for display purposes. However, all the math currently done in Solidus uses BigDecimal or Float, and, to make matters more difficult, our database schema assumes a two-digit currency. \nMoney objects are instantiated using the \"fractional_unit of the given currency\". This means we could potentially move from storing BigDecimal in the database to storing fractional units as Integer. \nAs for arithmetic, the Money class does it smartly. Have a look at the spec for that: https://github.com/RubyMoney/money/blob/master/spec/money/arithmetic_spec.rb\nIn the models, this would mean stuff like: \nruby\ndef amount \n   Spree::Money.new(super, currency: currency) \nend\nAcross the project. Huge. \n. OMG Spree::Money is substantially different from a proper Money object :crying_cat_face: \n. So what would be a viable way of doing this? First remove Spree::Money and replace every occurence with proper Money objects, then convert the database to Integer and do the attribute accessors on all the models? I have a hard time imagining how this could be done piecemeal... \n. If we actually did the \"store amounts in fractional units\" thing, we wouldn't have to worry about how many decimal places any currency has: \n2.2.1 :010 > Money.new(1234, :BTC).to_s\n => \"0.00001234\" \n2.2.1 :011 > Money.new(1234, :USD).to_s\n => \"12.34\"\nNote how integers were used to initialize the object in both cases. \n. If I see things correctly, this issue is still outstanding and could be fixed by adding \nruby\noptions = (params[:options] || {})\nand replacing \nruby\n @line_item = @order.contents.add(variant, quantity)\nwith \nruby\n @line_item = @order.contents.add(variant, quantity, options)\n@jhawthorn any objections to re-adding this extension point?. @acreilly is working on this!. Since #850 has been merged, there have not been any more \ud83d\udc4d on this issue. Closing now.. :+1: \n. I think this is a matter of taste more than a bug. If you'd like it to be different, I suggest opening a PR. \nAlso, when submitting issues, please try to add punctuation and capitalization to your sentences, it makes things much easier to read and comprehend. \nAs an additional bonus, GitHub has support for pasting images in issues; if you used that, the people reviewing this don't have to navigate away. \n. Rebased on https://github.com/solidusio/solidus/pull/685, and removed the work on shipping rates present in RfC Make shipping rates taxable like line items or shipments  (on which this will have to be rebased as well). \n. After chat on slack with @jhawthorn reverted the instance variable names to names without an underscore (as they're actually used by the classes that use the TaxHelpers mix-in. \n. I'm closing this. Much of it is already merged into master, and for all the following work, #989 is the guide. \n. Aside from the naming nitpick in order_inventory.rb, this is wonderful.\n. I think this works for a new shop. For existing shipping rates, this is a breaking change. However, things are mitigated by the fact that all order-relevant data is actually stored on the shipments.\nDo we need to migrate? If so: How would we do that? \n. As for the order_id = nil question: I'm hesitant on that one, as it would mean that shipping rate taxes would not be recalculated in the order updater. \nGiven that the all_adjustments association only made it into Solidus in October last year, I would doubt people use it to generate reports - and if they did, I'd wonder what sense it would make to group tax adjustments and (potentially non-eligible) promotion adjustments in one report. \n. Rebased on current master, including the new shipping specs. \n. I do not think we need to migrate, even for existing shops: \nShipping rate adjustments actually do not show up anywhere except for the select box where customers choose a shipping method in the shipment step. I'm not sure we need a migration for this: If the order is complete, we don't show shipping options anymore; if it's not complete and the customer chooses the shipping method again, he'll have gone through a state transition on the order where shipments and shipping rates get re-calculated. \nSetting order_id to nil: \nThis would require patching Spree::Adjustment to not validate the presence of the order id under some circumstances. I'm now using the eligible bit, which indicates whether an adjustment actually counts toward the adjustment total of an order, and I ask the item being tax adjusted whether it's eligible itself when I set it. See the commit message for 2eb5d0a for more explanations. \n. In private conversation with @jordan-brough he voiced concerns about further cementing eligible adjustments, or using the adjustment system for something other than actually adjusting orders.\nLikewise, other members of the community would like to see something like taxation system that is pluggable, and not even necessarily in core. \nhttps://github.com/solidusio/solidus/pull/862 addresses some of the issues we currently have with shipping rates, and the refactoring of the display_price method can be ported to that as well. Furthermore, it's a better step towards isolating Spree's inner workings from the taxation stuff. \nThese were supposed to be complementary, but can also be thought of different ways of achieving similar goals. @jordan-brough I'd still like you to look over this though; many thanks for yesterday's conversation! \n. I'm actually less and less a fan of this. It introduces useless columns (promo_total for something that can't be promoted, for example - but really all the totals as they aren't ever used). \n862 showed me that this is possible entirely without adjustments, at the expense of quite a few database calls. I think I can find a solid middle ground with a new AR model Spree::Tax::ShippingRateTaxEstimation which would just have an amount and a tax rate, and has no direct connection to the order (because it doesn't need it). That can also be easily used for migrating old shipping rates.\nHaving ItemAdjustments do a bunch of re-calculations every time the order is updated IMO doesn't help a lot either. Stay tuned.\n. Closing this in favor of #904. Much more fun. \n. Found a way of getting Alabama again, amended. Ready for review. \nI want to further increase the quality of the taxation specs, which will require me to have working German and Romanian addresses, and I'd much rather have that work offloaded to the factories. \n. Sorry, I had pushed too early. By now, Alabama is returned, because I actively sort by the states' name first. See https://github.com/solidusio/solidus/pull/765/files#diff-feb83d2311eaf80d0d133cb6924656a7R8\n. This last commit is a little bit of variable name cleanup (There was a variable called usa which is now just a statement with a ||; and a little more functionality: Now you can also directly add a state_code to the :address and :state factories, and easily create an address for example in New York or Alaska if you so wish. \nThe Alabama issue is still solved, but does not rely on sort orders anymore. Heck, the US could possibly add another state called \"Abalama\", and the factories would still work the same. \n. This will not work nicely. We don't want to essentially store the implementation details of matching tax rates as a column on the address. Also, we'd run into issues in the case that someone adds a smaller tax zone to an already existing zone. Btw: I think all of this can be streamlined tremendously (Airport Epiphany). \n. :+1: Thanks for the cleanup, always good to see your own code revisited :ice_cream: \n. Can we merge this soon-ish? \n. This ties in with the taxation stuff, as using the default country I can bypass the whole idea of a default tax zone. Upcoming: A default state that behaves just like the default country. \n. Hm, isn't the country code for Germany +49? Joking aside, this fits in well with the country factory (iso) , the Adress class (country_iso, country_iso=) and lots of other places in Solidus. I'm for keeping that name. \n. Rebased on current master to remove conflicts. \n. Can you rebase this PR on current master? \n. :+1: \n. Would you mind rebasing again? \n. I'd say let's go on a case-by-case basis here. Aside from the comments I made regarding amount vs. pre_tax_amount, this PR is :+1: by me. \n. :+1: \n. @Murph33 Would you mind rebasing this on current master?\n. Thanks!\n. Actually, the work in #822 will make the entire method obsolete, and I would be for deleting it afterwards. It'll never have been released.\n. I'm closing this. It's a nice, but fruitless addition.\n. In this PR, only the last two commits are relevant (the rest is rebased off other PR's that are in the process of being merged). As soon as merges happen, I'll rebase. The good news: This actually speeds up the taxation process by some 10% (46/44s before HEAD, 42/38s after HEAD). \nMore good news - this can relieve us of the following methods: \n- Spree::TaxRate.for_zone(zone)\n- Spree::Zone.match\n- Spree::Zone#contains?\n- Spree::Zone.with_shared_members\n- Spree::Zone.default_tax\n- Spree::Order#tax_zone\n- Spree::Order.reload\n- Spree::DefaultTaxZoneValidator (entire class) \nWhat do we do with all of these? They're exclusively used in tax calculation. Delete or deprecate?\n. It's not query times, it's the time the entire taxation test suite needs on my machine. So Seconds. I know each of those queries takes ~1-2ms, but the interesting question is how much time is needed for all the queries when calculating taxes. That measure, of course, is less than ideal. \nAs for the deprecations: No, it doesn't slow down my work. I've already started. \n. Closing in favour of https://github.com/solidusio/solidus/pull/862. \nDeprecations later. \n. Superseded by https://github.com/solidusio/solidus/pull/862\n. My feeling is that solidus_auth_devise defines Spree::User, and thus should have the translations for that class attached there.solidusitself definesSpree::LegacyUser, thus we do need to provide translations here. \n. @Murph33 can you provide attribute translations for theSpree::LegacyUserclass, please? Once that's in, we can merge this. \n. :+1: Thank you!\n. :+1:\n. I can confirm this issue. The solution would probably be to add JS to fill in a hidden field with the magical ransackname` from the two select boxes instead of having the two select boxes fill an identically named field. @Murph33 since you found the bug, do you think you could pull up a PR? \n. :+1: \n. I disagree, for two (admittedly nitpicky) reasons: \n1. The typography is somehow strikingly different and worse-looking than in the existing styling (it's a different font, and it's positioned in an awkward three-pixels-off way). \n2. It's be the first instance of pseudo-3D-gradients in the interface. The 4.0 version is better in terms of the background, but still has the typography issues. \nThe current style, however, is not great either. Do you think the default styles are a better starting point for someone to style this properly? \n. Rebased on current master to remove merge conflicts. All commits have been passing before. \n. Rebased on current master, and added a refactoring of Spree::ShippingRate, allowing multiple tax rates to be displayed along a shipping rate without having it go through the item adjuster. \n. Rebased again, and added an object to fill in for an address in the configuration. \nI disagree with Hound's comments in this particular case. Is this configurable?\n@jhawthorn, @cbrunsdon This is now ready for review, and includes everything I can do before actual schema changes for taxation I think. Sorry it's large, but commit by commit should be understandable. I'm of course available for questions. \n. This is a now stale, and will be superseded by smaller PRs.\n. Yeah! I :+1: this a lot. One question though: Why is the order clause in the scope? Shouldn't there always ever only be one selected shipping rate? \n. @jhawthorn Would it be feasible to do something like \n``` ruby\nhas_one :selected_shipping_rate, -> { where(selected: true) }, class_name: \"Spree::ShippingRate\"\nselected_shipping_rate is a read-only association.\ndef selected_shipping_rate=(_shipping_rate); end\ndef build_selected_shipping_rate(_options); end\ndef create_selected_shipping_rate(_options); end\n```\nBecause we really don't want these setters used.\n. Hi @dfmedeiros, sorry it took us so long to respond to this.\nWe had a long IRL conversation about this at SolidusConf, and we decided not to accept this PR. We couldn't find any reasonable ways to stop the creation/set methods from getting created which isn't great. Because of how few shipping_rates shipments have, we believe it is a pretty reasonable solution to preload all shipping_rates and let the ruby detect filter them out.\n. Since selected_shipping_rate is done via a Ruby loop (detect(&:selected?)), that method should not create that n+1 query. It might be rails' implementation of the question mark method selected? that creates the problem. Can you confirm that the n+1 problem stays if you replace selected? with selected (without the question mark)? \n@jhawthorn Do you have any leads here? \n. We've just done quite a bit of work to make factories individually requireable, and if you require ffaker in that spot, that won't work. Can you move the line to lib/spree/testing_support/sequences.rb? I believe it's the only place where we actually need it. \n. The tests failed, I suppose because of phantomjs crashing. You can re-trigger the build by amending the commit and force-pushing. ;) \n. :+1: \n. @jhawthorn @cbrunsdon Ready for review as well. The spec failure is spurious, but I don't want to rebase and force push, as #862 has been rebased on top of this branch. \n. I bow my head :bow: \n. Suggestion added, and made the condition for the early return a little less terse. \n. :+1: \n. I just whipped up a new rails app (with test-unit) , added this PR's source branch as source for solidus, and generated a MyModel: \n``\nUsing solidus 1.3.0.alpha from git://github.com/magiclabs/solidus.git (at rspec-as-default-testing-framework@14fe09d)\nBundle complete! 13 Gemfile dependencies, 100 gems now installed.\nUsebundle show [gemname]` to see where a bundled gem is installed.\n|ruby-2.1.5| milliways in ~/code/solidus-test-app\n\u25cb \u2192 rails g model MyModel\nRunning via Spring preloader in process 36086\n      invoke  active_record\n      create    db/migrate/20160224203655_create_my_models.rb\n      create    app/models/my_model.rb\n      invoke    test_unit\n      create      test/models/my_model_test.rb\n      create      test/fixtures/my_models.yml\n```\nSo I think it only affects the Solidus engine, not projects using Solidus. \n. I went somewhat beyond minimal, but I think this turned out great! \nWe have\n- persisted taxes for shipping rates\n- no direct association to the order or messing around with adjustments\n- MUCH cleaner code\n- shipping rates with more than one tax\n- and a data migration\n@cbrunsdon @jordan-brough @jhawthorn This is for you now. \n. All the methods in the TaxHelper module are declared private. It wouldn't be much of an issue to change those signatures IMO. \n. Rebased on #941, so that doesn't pollute this. Otherwise ready for review! \n. Added a changelog entry, rebased on @jordan-brough s excellent work in #965 , added YARD documentation. Ready for final review. \n. Rebase on current master. I also added a few methods to the mini-implementation of Spree::TaxRate in the migration so that ti the tax rate knows everything it needs to calculate amounts for shipping rates. \nThe implementation is the one post #980 , so we might want to merge that PR first. \n. Rebased on master, still good to go. \n. @cbrunsdon Can we close this issue or do you want to keep it around until we have refactored and cleaned up?. Wow, that's a bug I didn't even know existed. This is fixed on the current master branch though.\n. The line you're proposing is good in most cases, but will destroy adjustments you might not want destroyed, unfortunately. (Example: You have a promo adjustment with ID 1 and a line item adjustment with ID 1, your code would destroy both...) \n. That will still not be foolproof. You would possibly be deleting shipment\nor line item tax adjustments on another order. You can provide a PR that\nactually fixes that issue on Solidus 1.2 or upgrade to master.\nAm 25.02.2016 20:58 schrieb \"Adnan Abdulally\" notifications@github.com:\n\nit still needs the .tax.destroy_all at the end. the code i proposed was\nto just show the initial sql query before the .tax for fetching the\nadjustments\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/issues/909#issuecomment-188952881.\n. That would work. Please submit a pull request as it does fix a bug.\nHowever, be aware that it also foregoes the efficiency of the query we had\nbefore: now you create items.length SQL queries.\nAm 25.02.2016 23:50 schrieb \"Adnan Abdulally\" notifications@github.com:\nAh ok, i see what you're saying now.\nThis should do the trick:\nrelevant_items.map(&:adjustments).map(&:tax).flatten.destroy_all\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/issues/909#issuecomment-189018406.\n. I think this has been resolved in both master and Solidus 1.2.\n. This looks good. Can you rebase it on current master? \n. That would require quite a bit of work, also in Promotions. I think I want to see how the discussion about removing taxes from adjustments generally pans out. If you look at #904, that's how I'd like to see it done in the future. \n. I changed the architecture of this a little bit to give more freedom to i18n users. The general thrust of it stays the absolute same though. \n\nIn case you're wondering why there's a translation for a sales tax refund: it is algorithmically possible if someone switches out the tax calculator. And as with taxes, I've seen pigs fly, I thought I'll allow the possibility. \n. Can you rebase on master? I've also added a small nitpick that's easily cured.\n. Thanks!\n. Closing this because it affects more than we would like it to affect.\n. I think this is answered and also reflected in the README. Closing.. The imagemagick dependency is still not included in the README. If that gets fixed, this issue can be closed (the reference to rails g solidus:auth:install has since been added).. The imagemagick dependency is now included in the README, thanks to @MFRWDesign . Thanks to you, we can now close this long-standing issue. . Added changelog entry, rebased on current master. Ready for review!\n. Amended, no spec testing Rails anymore. \n. A-ha! If I just make sure the store is somehow set in a before_validation filter, no tests fail. This is now proper PR and not an RfC anymore :dancers: \n. Let me rebase this, the commit comment is still a bit off. \n. Oh no. So validating :store does essentially nothing, because Spree::Store.default defaults to an empty, invalid store. If I validate :order_id instead, hell ensues. \n. Take away your thumbs @jhawthorn @cbrunsdon, this needs to be reevaluated.\n. @tvdeyen Thanks for the raise vs abort comment - I've amended the last commit. \n. Rebased! \n. Rebased\n. Nope, that doesn't work as it generates a validates :store, presence: true, which in turn breaks with the before_validation hook. \nI could look into Spree::Store.default, where a || new causes all this trouble, and I haven't quite found out why it is there. There is a possibility that that clause was inserted in order to prevent the kind of trouble I'm trying to solve with the validation. Thoughts, anyone? \n. :+1: Really nice. \n. Despite the horrid performance implications, I really want this in. It rids Spree::TaxRate.rb of any calculations except the bizarre amount * -1 bit, and really gives a lot of power to the calculator, where it belongs. The performance can and will improve. It's also a prerequisite for #904, where I've baked these commits in in such a way that if this is merged, the other will be shorter. @jhawthorn @cbrunsdon @jordan-brough\n. The taxation integration test suite, which is really exactly testing this lots and lots of times, goes from ~45s to ~53 seconds. Considering that much of that time is spent doing spec setup, yes, this must be a lot slower. \nThe real reason why is that in the adjustments callback cycle, every adjustments amount get recalculated an insane number of times, which is why the caching (on the pre_tax_amount column) helped so much. \nThis is a huge priority, but I think before this was the wrong spot in which to do the caching. If it's really necessary (I believe the more sanity we add to this code, the faster it will run). \n. This is :+1: by me. However, would you care to merge the second (fixup) commit into the first one? \n. \ud83d\udc4d \n. @yeonhoyoon This is good to go, except it needs some specs. \n. Super, thank you. I didn't know two SQL statements in the same execute thingy don't work.\n. I don't think the bug you're reporting is actually a bug, as the class method .calculators on both models runs exactly what you're proposing: \n```\n(with an entirely empty database)\n2.1.5 :003 > Spree::TaxRate.calculators\n => [Spree::Calculator::DefaultTax(id: integer, type: string, calculable_id: integer, calculable_type: string, created_at: datetime, updated_at: datetime, preferences: text)] \n2.1.5 :004 > Spree::TaxRate.all\n  Spree::TaxRate Load (2.2ms)  SELECT \"spree_tax_rates\". FROM \"spree_tax_rates\" WHERE \"spree_tax_rates\".\"deleted_at\" IS NULL\n => # \n2.1.5 :005 > Spree::TaxRate.calculators\n => [Spree::Calculator::DefaultTax(id: integer, type: string, calculable_id: integer, calculable_type: string, created_at: datetime, updated_at: datetime, preferences: text)] \n2.1.5 :006 > Spree::ShippingMethod.calculators\n => [Spree::Calculator::Shipping::FlatPercentItemTotal(id: integer, type: string, calculable_id: integer, calculable_type: string, created_at: datetime, updated_at: datetime, preferences: text), Spree::Calculator::Shipping::FlatRate(id: integer, type: string, calculable_id: integer, calculable_type: string, created_at: datetime, updated_at: datetime, preferences: text), Spree::Calculator::Shipping::FlexiRate(id: integer, type: string, calculable_id: integer, calculable_type: string, created_at: datetime, updated_at: datetime, preferences: text), Spree::Calculator::Shipping::PerItem(id: integer, type: string, calculable_id: integer, calculable_type: string, created_at: datetime, updated_at: datetime, preferences: text), Spree::Calculator::Shipping::PriceSack(id: integer, type: string, calculable_id: integer, calculable_type: string, created_at: datetime, updated_at: datetime, preferences: text)] \n2.1.5 :007 > Spree::ShippingMethod.all\n  Spree::ShippingMethod Load (1.4ms)  SELECT \"spree_shipping_methods\". FROM \"spree_shipping_methods\" WHERE \"spree_shipping_methods\".\"deleted_at\" IS NULL\n => #\n```\nThe proposed change also removes the sorting, which is a pity. \n. I think this makes sense, even as an incremental thing before @Mandily redesigns the page entirely. :+1: \n. :+1: \n. I like this. This would mean that the shipping rates estimation could be part of the to_shipment method on the package class, and I could get rid of the strange attr_accessor in Spree::ShippingRate.\n. I am definitely :+1: on prefixing path helpers, as it makes interaction with host apps and other engines a lot less error-prone.\n. :heart: Can you look at the last failing test, and then I'll rebase #904. \n. :heart: Can you look at the last failing test, and then I'll rebase #904. \n. I tried rebasing this onto #904. My work then breaks a gazillion other things, and I think the ugly spec and this failure are related somehow: https://circleci.com/gh/solidusio/solidus/2473. I'm not so sure how to remedy this, but essentially our spec setup/our factories are set up in such a way that with this change AND my changes in, 700 specs break because apparently lots of shipping rates have no shipment when they're created. :crying_cat_face: \n. I said so before in real life, but this is a change that will make my life a lot easier. Thank you @jordan-brough! \n. This is a long project, I won't pursue it in the near future. \n. I'm going to do this a little differently, in three steps: \n1. Add a user interface for prices in different currencies. \n2. Get #987 in\n3. Then add the additional field.\nClosing, for the time being.\n. Added the changelog entry, and rebased on #935 in anticipation of the next merge conflict. \n. @adammathys Rebased against master again. \n. Rebased on current master, added link to PR to changelog. \n. :+1: This is greate. @eric1234 Can you rebase on current master?\n. Thanks!\n. :+1: \n@Sinetheta @Murph33 frankly I don't quite understand the selector magic you're debating. Can you say whether this still needs work, or can it be merged? \n. I think no-one's really said anything here, and apparently all possible options work just fine. I'd say we look at merging before next week's core meeting if no-one complains. OK? \n. :+1: I think this can go in. Virtually the entire core team have given their thumbs up, there's a changelog entry, and it looks great. What's stopping us?\n. Currencies with more than two decimal places are not supported at all in Solidus, I think that's an entirely different issue. And yeah, I'll provide unit tests for default tax.\n. Ha. Yeah, I hear you. \n. Refactored the specs and added specs for some of the refunding logic @gmacdougall\n. The failing spec on 6990e65 is due to a PhantomJS crash, I'm quite sure. \n. Rebased and added specs for the actual behaviour of the calculator when called with line item, shipment or shipping rate. I think this is good to go now. @gmacdougall @jhawthorn \n. @gmacdougall If you have a minute, this should be good to go.\n. Please please review this, it's base work for #904, which is also ripe. \n. :+1: Looks good to me, too. \n. Yep, I love namespacing path helpers. :+1: \n. Would you be so kind to also rebase this on the current master?\n. That should work, though: Whenever I update, create or destroy a price belonging to a variant, that variant and in turn the associated product will be touched. \nAlternatively, we could create a more sophisticated cache key for products; something along the lines of\nruby\nclass Product\n  def cache_key\n    associated_object_timestamps = [updated_at] + variants.map(&:updated_at) + prices.map(&:updated_at) \n    hashed_timestamps = Digest::MD5.hexdigest associated_object_timestamps.map(&:to_s).join(\",\")\n    super + hashed_timestamps\n  end\nend\nRight now, that should bust the cache quite reliably whenever we update, add or remove any variants or prices. \nIn the future, we'll also have to look at modifying the *cache_key* methods in the core helpers to take into account the current order's tax location. But that is outside the scope of this PR.\n. @gmacdougall and I talked IRL (well, on the interwebs) and he explained that time itself should expire the cache key. I've cooked something up by looking up prices.currently_valid (which uses Time.current) to figure out which prices are currently possibly valid, and that correctly expires the cache when a new price becomes relevant. I've also added a spec to check for changing of the current price (which does the touching chain price -> variant -> product, and also correctly busts the cache. Would this work?\n. @gmacdougall @jhawthorn Please have a look at this, there is a caching strategy and a migration. \n. Wow, this is much more of a pain than I thought, mostly because saving a new item on a has_one relation deletes the old one, which is behaviour I'm not happy about. We need a relation though because otherwise Ransack won't work.\n. @gmacdougall @jhawthorn This is done, as far as I'm concerned. Would you have a look? :)\n. This is now very out-of-date. Much of it has been taken in in other PRs. I'm closing this for the time being. \n. @gmacdougall @jhawthorn Here's a list of open tax-related PRs, in order of which one to merge first for the least amount of friction: \nCore taxation system\n\n[x] #980 Move refunding logic into calculator\n[x] #904 Add Spree::ShippingRateTax\n\nPricing\n\n[x] #994 API for Line Item Pricers\n[ ] #987 Historical prices\n\nDrive-by refactorings\n\n[x] #1007 Never set a line item's currency in strange ways.\n. I'll close this issue now as the refactoring in question is mostly done. The one point not tackled so far is time-aware tax rates, for which I'll create a new issue.. PriceModifierAwareOnlyChangesPriceWhenModifiersPresentPricer? The current pricing behaviour has some quirks that prevent a descriptive, short name. I'm absolutely open for suggestions :D \n. Thanks everyone for the feedback. I think the difficulty in naming comes from the fact that this class does way too much, and I'll introduce smaller Pricers that are more easily names and (yep, @jhawthorn) take a line item as instance variable and go from there. \n\nThis was a very valuable spike :) \n. Closing in favour of https://github.com/solidusio/solidus/pull/994 and similar PRs\n. Yep, that might be the case. Feel like cherry-picking this for Solidus and PRing it? https://github.com/spree/spree/pull/6529/files It will need a test or two ... \n. Also closing this in favour of #998. We don't even need this attribute, and it only creates confusion. \n. @gmacdougall Implemented all suggestions, I think. This made adding a new money_price= setter on line item necessary that handles using a Spree::Money or just plain Money object as the price. \nIt'll take some time for the tests to run, but I'm quite sure they're green. Ready to go. \nI've also changed the naming and namespacing of the pricers, linking them more closely to Spree::LineItem. \n. @gmacdougall rebased, ready to merge!\n. @mbj Good point, and thanks for sorta implicitly pointing me to your work on this. I'm closing this in favour of #998 - that one actually has specs and cleans the relationship with a line item and it's currency up in a more thorough way. \n. :+1: - Again, my JS is limited, but this looks effective and not too intrusive as it only ever starts working when a tooltip element is instantiated. Great!\n. Closing in favour of #1007, which does not remove the column but makes handling line item currencies saner. \n. I'm closing this for the time being, as #994 has better naming and stuff. Let's do that first. \n. This is really good. Can you try to rebase the regression fix into the actual change commit, as well as fix the actual change commits up with the hound commit? That way, we have no state in the repository with a regression, which would be nice. \n. Since Solidus 1.2 we removed deface from core. Does your project have the gem installed locally?\n. Thanks @tvdeyen - I took your suggested wording for the deprecation message. \n. :+1: \n. :+1:\n. This makes sense, but would you be so kind to add a meaningful commit message (see http://chris.beams.io/posts/git-commit/ for what I mean by \"meaningful\").\nAlso, it'd be great to have a test that checks Spree::Variants new behaviour.\n. I don't have any opinion on this, either. \n. I think what happened depends on the model: \n- Some omitted it intentionally (Spree::OrderMutex)  - those are not included. \n- Some just missed adding them because they were created in ancient times (Spree::Variant) \n- Some used to be join tables and have since been upgraded to proper models (Spree::ProductsTaxons), and it was omitted by accident. \nFor some of the join tables it might not be strictly necessary, but I'd like this schema to be unsurprising, and that's what this PR does. \nRe: The performance question: I think there's bigger performance holes in Solidus than adding timestamps here and there. :) \n. :+1: \n. I was actually surprised to see that the product form doesn't have them, yet! I do think you mean the sidebar, not the sections in this form, correct?\n. I talked to @Mandily about this IRL, and I'll be updating this with lots of her input. \n. Done updating. This has come out pretty nice! I have a few questions for reviewers, which I'll put as comments to individual code lines. Also: Check out the screencasts!\n. @graygilmore @Mandily Do have a look, I rebased with the current master - now we have: \n- Full-width table \n- Full-width forms\nThis is from older PRs:\n- Working search in variants\n- Tabs :confetti_ball: \n- Consistent view of deleted variants\n- Deleted variants don't lose their values anymore\nSee updated screen shots in the description\n. @tvdeyen Yes they should be, does it look old to you?\n. Yes, @Mandily that's possible. Look!\n\n. Yeah, let's do the breadcrumbing in a different PR. :) \n. 1. Can we leave the \"Edit Variant\" in? I like the frame there, aesthetically :) Otherwise I'm fine with killing the sections headers and additional lines. \n2. I don't like calling anything \"Default\", because default is never actually defined and can mean different things in one or the other context. I could label the \"No override option\" with the tax category name from the product, but that's not really what we're storing in the database (we're storing nothing in this case). I'm curious for other opinions here. \n3. NP, will do. \n. @Mandily here's the form without legends - Still much better than what we had before! There's a larger gap towards the second row because the checkbox needs more space around itself than the other fields, but that's not something I want to tackle here. \nI went with \"Use Product Tax Category\" instead of \"No override\", which I think is understandable.\n\n. Hm, in some cases we're actually testing line item prices being different from their variant prices, apparently. Could you fix those nine failing tests so that they use a line item with a different price than the one in your factory? \n. Try replacing the instances of mock_model with build_stubbed. Spree::Variant#price is a delegated thing that needs an associated price object to function... \n. And... the general thrust of things makes sense to me, but we have a policy of only letting PRs pass if two core team members give their thumbs up and none says no, so there's still a possibility of others insisting on another thrust. \n. :+1: \n. :+1: \n. Yikes. I do believe the idea is decent: Given that we want to keep a credit card record, but we want to make sure its not actually billed anymore, we destroy the token in our database. \nReally though: I think a payment source should know how to disable itself. I'd prefer a method signature like payment_source.disable!.\nSo, :+1: .\nFor more reading, I did multiple payment source support in Spree half a year ago. It's not super-pretty, but definitely something that works: https://github.com/spree/spree/pull/6831 \n. :+1: \n. I think it's a great idea to remove #token_based? from payment, but I'm not so sure anymore about combining these two methods into one. \nThe case in which token_based? would be run is a fairly remote one as we discussed IRL: \n1. Your credit card is not supported by your payment method\n2. But it has a token\n3. And the provider (which we're assuming here to be the same one as the provider of your payment method) knows how to bill using that token\npayment_method.supports? should, IMHO, not provide the answer to Question 2.\nQuestion 3 is always assumed to be yes. Ah well.  \nWhat about this approach instead: \nIn processing.rb: \nif payment_method.supports?(source) || source.has_payment_profile?\n. @jordan-brough But then, the method is still named awkwardly. \nWhat about using a new method: \ndef can_bill?(source)\n   supports?(source) ||\u00a0source.has_payment_profile?\nend\n. We talked IRL and I am :+1: on this. \n. It does return nil when there is no fitting price. It's only if you ask for a price in currency nil that you get the default currency. \n. @jhawthorn Yeah, makes sense to me. Amending. \n. @jhawthorn amended, green with no unrelated spec failures.\n. This has been discussed in https://github.com/solidusio/solidus/pull/638. In a nutshell, this would be a dangerous move for stores moving from Spree to Solidus and would seriously hurt backwards compatibility.\n. :+1: \n. Hm, we just put in a bit of work into making factories individually requireable - allowing you to require just the factories you need for your tests instead of the > 100 factories Solidus comes with. That functionality comes with require statements in every factory, though, which we can't replace with load, because that would also error out with Factory already defined. \nMaybe there's a better solution using a config.to_prepare block? Maybe even inside the factory_girl_rails railtie, which only loads factory_girl, and then does not run FactoryGirl.find_definitons.\n. So I was wrong, it does run FactoryGirl.find_definitions, but does not add the Solidus factories to the load path. \nIf you added a file (spec/test)/factories/spree_factories.rb directory with the following content:\nrequire 'spree/testing_support/factories'\nDoes that solve your problem, too? \n. @Serabe did any of my hints help solve your issue? \n. :+1: Thanks!\n. My JS skills are limited, but from what I see this simplifies the existing codebase a lot. Very educational! :+1: \n. @mtomov We've had the JS/CoffeeScript discussion in core and are in favour of incrementally moving our coffeescript to JS. There's been a long and insightful discussion in the Discourse (the forum software) community, and they had strong arguments in favour of this: https://meta.discourse.org/t/is-it-better-for-discourse-to-use-javascript-or-coffeescript/3153/17\nI think the main points are that JS is incrementally getting better, and that only Rails devs know CoffeeScript. (I'm exaggerating, but you get my point). \n. I think we're not discussing the actual PR here anymore \ud83d\ude09 . If you don't mind, let's move this to our Slack channel or an issue. I still think this PR is great work, and wouldn't want @jhawthorn to re-write it in CoffeeScript. John, do you mind rebasing this when you have a minute? \n. :+1: \n. :+1: \n. I added the try! you suggested; otherwise I think this can go in as-is (unless you insist on removing the presence call). \n. @jhawthorn Added Changelog :)\n. @tvdeyen Have a look at the upgrade strategy detailed in #1068.\n. Alright, no issue with this at all - I thought I'd required the pricing module everywhere the order helpers module is included, but it does make sense to have the module require its dependency itself. Can you give a hint at where this failed? \n. OK, no more questions asked :) :+1: !\n. Amended to use find instead of find_by.\n. I'm alright with this, even though we don't have the README files for the individual Gems yet. \n. Closing in favour of #1071 \n. Rebased on master so that the changeset becomes a little slimmer. A little. \n. @jhawthorn This is ready for a second round of review now. Bad stuff extracted and slimmed to (I think) the minimum.\n. Hi @mtomov, thanks for reviewing this - it's not an easy piece of code. \nThis functionality is meant to be extended, and solidus_price_modifier is one (not great) example on how to use it. It's meant to replace functionality like the one provided by extensions like spree_price_books or spree_price_lists without adding another ActiveRecord table inbetween variants and prices. \nOne use case that I have in mind will be pricing depending on the customer's tax_address, in order to get VAT pricing right and reduce complexity in the taxation system. The way that will be implemented is by adding a vat_country_iso field to prices and select prices based on that field (with a default fallback). \nAnother example of where this would come in useful is exactly what you're describing: Different prices for e.g. wholesale buyers or registered users vs. non-registered users. All you need is a different pricer with the related pricing_options class, and probably another column on the spree_prices table. \nI agree that the price_difference stuff in Spree::Variant is not super-nice, and it's a good candidate for extraction, actually. For now I wanted to keep exisiting functionality though.  \nRegarding comments: Yep, that's right, I'll add those. We're big fans of YARD docs. \n. :+1: \n. Thanks\n. :+1: \n. Thanks!\n. This is a minimal implementation; if we were to do it really seriously, I would also like it if we could add ::Money objects to Spree::Money objects. Ruby ::Money has all that solved in a nice way, I kind of think it would be a duplication of effort to first implement a lot of respond_to and is_a? metamagic only to in a future life just let Spree::Money inherit from ::Money... \nOn the other hand, I have been confused in the past by undefined method 'money' for nil:nilClass :D - I'll add the error. \n. This is excellent work. I advised @dangerdogz IRL to do this at the model level, however I have an impression moving this to Spree::Order or Spree::OrderUpdater instead of Spree::OrderContents might be a worthwhile. \nThere's one thing about the commits: While it's great to see your TDD, we want only commits that actually pass CI in the codebase. Can you group the commits that add functionality together with their new tests? Also, I agree with Hound most of the time.\nNotwithstanding, good work!\n. Yep, this is great! \ud83d\udcaf \n. Thanks again Fr\u00e9deric!\n. I like this, of course! Now that new accepts a Money object, can you also get rid of from_money? I only introduced that because new couldn't do what it does two days ago. Now it can, so I think from_money can actually go. It has no specs, and is only used inside the class (in + and -). \n. One of them is the payment itself, the other table is the logs around it (when it was authorized, captured and so on). Combining them into one table would mean essentially showing the Logs first, and not the payments. Given that most payments are only one or two events, having two pages for that seems redundant - and the only reason you want that much details about a payment is when you actually want to see the logs. \ud83d\udc4d . \n. I think this is good, but an intermediate step. Once we have a configurable navigation across levels, that should handle the breadcrumbs. It's better than what we had before though, so \ud83d\udc4d .\n. I'm just very happy about the submit Event listener being gone. \ud83d\udc4d  -- also nothing valuabel to add to the existing conversations. \n. I'm good with this, but we also paired on it so it doesn't count as team thumbs-up. :)\n. @jordan-brough Now the PR is targeting a non-master branch. Is this intentional?\n. Different payment source can have very different fields, and as soon as we start providing support for e.g. SEPA payments, we'll run into a big table with lots of accessors that don't make sense in many contexts. We have the solution @jordan-brough is proposing running in production, and this is the schema for just credit cards and SEPA payments: \n``` ruby\n  create_table \"spree_credit_cards\", force: :cascade do |t|\n    t.string   \"month\"\n    t.string   \"year\"\n    t.string   \"cc_type\"\n    t.string   \"last_digits\"\n    t.integer  \"address_id\"\n    t.string   \"gateway_customer_profile_id\"\n    t.string   \"gateway_payment_profile_id\"\n    t.datetime \"created_at\"\n    t.datetime \"updated_at\"\n    t.string   \"name\"\n    t.integer  \"payment_method_id\"\n  end\ncreate_table \"payone_sepa_mandates\", force: :cascade do |t|\n    t.string   \"bank_country\"\n    t.string   \"bank_account\"\n    t.string   \"bank_code\"\n    t.datetime \"created_at\"\n    t.datetime \"updated_at\"\n    t.integer  \"payment_method_id\"\n    t.string   \"iban\"\n    t.string   \"bic\"\n    t.string   \"gateway_customer_profile_id\"\n    t.string   \"mandate_identification\"\n    t.string   \"mandate_status\"\n    t.text     \"mandate_text\"\n    t.string   \"creditor_identifier\"\n    t.string   \"street\"\n    t.string   \"city\"\n    t.string   \"company\"\n    t.string   \"zip\"\n    t.string   \"country\"\n    t.string   \"email\"\n    t.string   \"name\"\n  end\n```\nI would not want to merge these two into the same table. \nAs for the preloading upside: Usually, users have very few payment sources. I do not see a performance issue with loading a few of them, even if it were n+1. \nThanks a lot for taking the time to comment here, especially the naming suggestions are very much appreciated. \n. @jordan-brough I'm unsure what the user_id field does that the WalletPaymentSource does not do?\n. \ud83d\udc4d  on adding Payment between User and Wallet. \n. @jrochkind Coming to think of it, most of that data does not have to be particularly query-able, so we might get do well with STI and a JSON data column, actually. @jordan-brough I know this throws over a lot of the stuff we've done so far, but it would prevent us from column creep and give us all the goodies of a more restricted association. \n. \ud83d\udc4d  Again, great work @eric1234 \n. :+1: This is good!\n. This solution only looks for master variant SKUs. \ud83d\udc4d for sku_start.\n. You could test it with a feature spec that runs with JS enabled. Create two products, one with variants, and then check for the presence of the right variants in theselect` input. \n. \ud83d\udc4d \n. Index view without deletion\n\nEdit view (you can only edit the price itself, for existing prices changing currency or variant is confusing and disabled)\n\nNew view (all fields can be edited)\n\n. @gmacdougall incorporated your feedback, and added pagination.\n. #1169 should fix the validation issue. I've amended this PR to use a select2 instead of a text input to make it harder to input invalid data. As for the last point: I've removed the .master_price translation from this PR and switched to instead using Variant#descriptive_name (which has the same leakage issue, but is already there as model-level logic). \n. We can't add SMTP information to production.rb for all stores. \nHow do we feel about disabling e-mails in production for the sample store? We now have a \"deploy to Heroku\" button that probably needs something of that sort as well. @alexblackie How did you get around that?\n. It's done - pending positive code reviews. \nThis PR finally generates correct prices including VAT that can be changed by a backend user, and gets rid of the default zone. Much of the changed lines are specs for migrating an existing VAT store and class renames. Most notable is the class Spree::Variant::PriceSelector, which used to be called Spree::Variant::Pricer - that old name was confusing when trying to differentiate from Spree::Variant::PriceGenerator (which could have been named \"Pricer\", too). \nThe interface for prices is still a bit rough around the edges, as #1167 testifies. For now, I believe it's absolutely usable, though. \n. This has been fixed in https://github.com/solidusio/solidus/commit/726630f3f84ca4a79a675a91d6081bbf6cdfe718. \ud83d\udc4d \n. Thank you!\n. I like this! Thanks a lot. However, could you squash at least 4bf22b3 and 791f5ca into the same commit so that the specs pass on all commits?\n. \ud83d\udc4d Thanks!\n. Is there tests for this functionality in spree_multi_domain? If so, it'd be good to move those over as well. If there aren't, I'd suggest actually writing them, because this is a bunch of functionality that deserves to be specced out.\n. \ud83d\udc4d Super!\n. Closing, thank you @swcraig . Closing, thank you @swcraig . I don't like the idea of two Solidus stores having different schemas. Do the rename, remove the functionality, all that is perfectly fine with me (I just wanted the discussion to happen, and am happy with the outcome) but IMO the column should not be deleted. \n. I'm fine with this. For what it's worth, the Spree people are adding that functionality to the backend now: \nhttps://github.com/spree/spree/pull/7350. Would you mind adding a changelog entry?\n. \ud83d\udc4d \n. I would like this to be split up into one PR for fixing indentation, one for adding the HTML view and preview, and one for changing the Text version of the E-Mail.\n. \ud83d\udc4d \n. Thanks, this makes sense to me. @forkata Any idea why this was omitted in the first place? \nBtw really nice specs. \n. Re-triggered the build as it looks like a phantomjs-related failed build.\n. This consistently fails the tests. @acreilly Can you look into making the test suite pass? ;)\n. :+1: super!\n. :+1:\n. :+1: \n. :+1:\n. \ud83d\udc4d \n. \ud83d\udc4d \n. Thanks!\n. \ud83d\udc4d \"a little imperfect\" :shipit: \n. \ud83d\udc4d \n. Thank you!\n. As pointed out in https://github.com/spree/spree/issues/5842#issuecomment-68595785, the ActiveAdmin gem stored 2.1 in a constant to do the lookup properly. I'm not super-excited about that constant living in I18n in their solution, but I liked that it wasn't just a magic number. \nMaybe something like (in short): \nSpree::I18N_GENERIC_PLURAL = 2.1\nSpree::Order.model_name.human(count: Spree::I18N_GENERIC_PLURAL)\n. As long as the commit does not mix concerns, it can be as big as you like, as far as I'm concerned. So one commit for introducing the thing, and another one that basically regexes over the entire project. That's probably even safer and more comprehensive than doing it bit by bit and missing one...\n. #1169 should fix the first issue. I've also amended the #1117  to use a select2 instead of a text box for input.\n. \ud83d\udc4d for the method breakup. \nHowever, I would prefer this to become a customizable class, so that instead of writing a pseudo-decorator, you can do this: \n``` ruby\nSpree::Config.stock.coordinator_class = MyShop::Stock::Coordinator\nmodule MyShop\n  module Stock \n    class Coordinator < Spree::Stock::Coordinator\n      def stock_location_variant_ids\n        ...\n      end\n    end\n  end\nend\n```\nWould you mind adding that extension point to Spree::Stock::Configuration? \n. I didn't see that these were private methods. \n@jordan-brough is right here, we as they're private, they are not part of the public interface and thus should not be an extension point at all. Sorry @isaacfreeman; I think the right way to go about this is subclassing and replacing the entire method as @jordan-brough suggests.\n. :+1: Nice work!\n. :+1:\n. Thanks! \n. \ud83d\udc4d After fixing the using the reimbursement variable in the ReimbursementPreview.\n. Thanks!\n. \ud83d\udc4d Great!\n. Makes sense to me. \ud83d\udc4d \n. The order thing is there so that this test passes: https://github.com/magiclabs/solidus/blob/remove-is-default-boolean-from-prices/core/spec/models/spree/variant_spec.rb#L174-L180\nEssentially, if you add a price to the prices array that has the same properties as an existing price, the new price should be selected.\n. Closing this in favor of #1469.\n. \ud83d\udc4d \n. @jasonfb I agree with you. acts_as_paranoid is a bad replacement for properly time-windowed models. But as long as we don't have those, we need to work with what we have. I'm sorry. \n. \ud83d\udc4d \n. \ud83d\udc4d Beautiful!\n. From: http://www.out-law.com/page-424\n\nStep 3: Incorporating the terms and conditions\nAt the bottom of the terms and conditions page the purchaser should, ideally, be required to check a box to indicate that he or she has read, understood and accepted the terms and conditions, before clicking the \"Accept\" button. The \"Accept\" button should not work until the box has been checked. Equally the page should be designed in such a way that the consumer cannot check the box and click \"Accept\" until the page has fully loaded onto the screen. By doing this, you improve your position in the event that a purchaser claims there was no opportunity to read your terms.\nWhile there is no responsibility on the retailer to ensure that the consumer has in fact read them, following this procedure will demonstrate that reasonable efforts have been made to bring them to purchasers' attention.\n\nThis looks like @jhawthorn s approach of disabling the submit button wherever the checkbox appears might just do the trick, and we don't need to persist anything. \nMaybe we could just look at a partial that incorporates the JS for disabling the submit button. \n. Looks good to me! Thank you \ud83d\udc4d \n. I <3 your high-level overview issues, @Mandily ! I feel the fourth page (with a lot of data) is missing pagination; otherwise I think this is great! \n. I  can confirm the code for pagination has been there since https://github.com/solidusio/solidus/commit/ab5faedd4dc93fbb900c81136e4ba942433bb453. \n. I looked into this, and it appears that this particular page uses the config options orders_per_page, which by default is set to 15, which is why the pagination did not show up for you. This is a little unacceptably hidden, and the standard resource controller does not paginate either. I'll PR something up, but the issue is more complex than initally thought. \n. Thank you!\n. This actually looks alright to me. I guess the removal was triggered by associating this feature too closely with the price_modifier_*. \ud83d\udc4d \n. Thank you!\n. Thanks!\n. This appears like a good change to me. Would you mind adding a spec for this?\n. Amazing! Thank you @flyfy1 \ud83d\udc4d \n. \ud83d\udc4d I wrote the initial state-aware factories, and I wasn't aware of states with no subregions. I'd be good with this in 1.3 as well.\n. I like the abstraction, actually. \ud83d\udcaf \n. I reviewed this with @tvdeyen and we do have suggestions for simplification of this PR. I'm retracting my previous :100: - but still both of us like the basic idea of centralizing message dispatch configuration. \n. We're closing this as there has not been discussion or progress on this since more than a year. . > > Drop the validation for the 1.3 release\n\n\nWould that require a lot of change? A new issue that came up for me in rc1 was from this change on Order#tax_address -- it expects a store to be present on the order or it raises an NoMethodError error since the store is nil.\n\n\nThat's originally why I introduced the validation in the first place. If I don't have it, code down the line has to provide paths for the store not being there, and that's not very good. \nAdditional food for thought: I think the vast majority of users has only one store, and those that don't will have a store_id associated. Otherwise that would be just reckless, and will produce more pain the later they address that issue.\n. You get a \ud83d\udc4d from me as well. :) \n. \ud83d\udc4d \n. 2. implies 1. Would implementing TaxLocation#state suffice for your needs, @dholdren? In that case I'd go for that solution in the short run. \nIn the medium/long term, I agree that always returning a TaxLocation is probably the best solution. \n. Thanks John! Does this not make the rake task obsolete and delete-worthy then? The migrations will be run before the rake tasks, so...\nOtherwise, \ud83d\udc4d \n. \ud83d\udc4d Thanks Jordan!\n. I'm a fan. \ud83d\udcaf \n. I'm still a fan of this. @jhawthorn whenever you have a minute would you mind rebasing this on the current master branch?. This is a design change. Previously, the confirm/cancel buttons would show up right on the bottom border of the fieldset. I understand it's not semantically correct, but it does look better the old way IMO. \nI'd prefer to remove the changed position of the buttons. \nWould you also squash the two commits? The second (\"remove char\") commit does not add extra value as a point in the repo history :) \n. I'm still not happy with moving the buttons below the fieldset, as this is the only place in the admin backend where we would do it that way. We will probably make this better semantically at some point, but for the time being, for the sake of consistency and compatibility I'd like you to remove that change. \n. It's two changed lines, and it introduces two data-hooks with the same value. Can you explore doing this using standard CSS classes? They should be semantic, i.e. describe what's in the div and can be targeted with Deface just as well as data-hooks. \n. \ud83d\udc4d\n. :+1: looks perfect to me.\n. \ud83d\udc4d \n. \ud83d\udc4d \n. I would like a shop without cloned products to still be able to keep a non-slugged URL for a product page. Is this an issue only when used with globalize?\n. \ud83d\udc4d  Thank you!\n. \ud83d\udc4d \n. @jhawthorn I think so, they're a usability plus. :)\n. We deprecate using both ActiveSupport::Deprecation and Spree::Deprecation, so we have to raise on both. It'd be another PR to homogenize the codebase to only ever use Spree::Deprecation. Let's cross that bridge when we need to. \n. Added a commit to always use Spree::Deprecation. It's just search and replace, really. \n. \ud83d\udc4d  Great!\n. \ud83d\udc4d \n. @agustifernandez Yes, it'd be great if you could take a go at this. Good examples for not-so-easy-to understand form fields are: \n- Variant#tax_category (is an override, if not set, takes over the product)\n- Product#shipping_category\n- Product#tax_category\n- Price#country (if empty, the price is valid for all countries)\n. You can update the active_merchant gem in your local app. Solidus just specifies a minimum version, it's not fixed. \n``` ruby\nGemfile\ngem active_merchant, '~> 1.49.0' \n``\n. @sviechnikov That requirement has been relaxed in master and the recently released version 1.3. Is it feasible for you to upgrade?\n. \ud83d\udc4d \n. \ud83d\udc4d Thanks John for digging these up :)\n. \ud83d\udc4d \n. \ud83d\udc4d \n. Seems like this issue is still up for grabs!. \ud83d\udc4d \n. Can you provide a spec for this?\n. This is good work. It needs a spec. A view spec would be enough IMO. In order to test this behaviour, you'll need an order with both a line item level and an order level adjustment. @SebAshton Would you be willing to do this, or should we close this and make it an issue?. I'm not sure it's necessary to pass an address to the credit card. The order has a billing address, and ideally the credit card should just take that over (I'm assuming you're not dealing with split payments nor are you assuming people pay with a credit card where the bill address is different from the order's bill address). TLDR: Try not providing address attributes on the credit card. \n. I think this needs some test fixing, and maybe even a new spec. Otherwise, this is great!\n. I agree with @Mandily and @jhawthorn about this not being an explanation, but actual content. \n. Are you using the importer via the API or directly? Because within the importer class, there is no mention ofStrongParameters` or permitted attributes. It appears to just take in a params hash, and that should work (as the spec suggests). \nThat said, adjustments are tricky, and there's a bunch of things that can go awry when dealing with them. Can you provide more details as to what specifically you're trying to do, and where and how it errors out? \n. Adjustments are, unfortunately, not as easy as they look. I recommend going through the shipment phase as adjustments (at the moment) can only be tax or promo adjustments, and there is not such thing as shipping adjustments (apart from actually adding shipments). Going through creating shipments is also more close to standard Solidus behaviour, which will make things easier if you add more bells and whistles to your shipment behaviour. Also: the shipment system is complex, but also really quite powerful. \n. Yeah, closing.. \ud83d\udc4d \n. \ud83d\udc4d \n. \ud83d\udc4d \n. \ud83d\udc4d \n. Will CircleCI still raise on deprecations? Because I'd love that, and that was the main intent of the original PR. Otherwise \ud83d\udc4d \n. Perfect. \ud83d\udc4d \n. \ud83d\udc4d \n. :+1: go for it\n. Would you mind squashing the two commits into one and adding a meaningful commit message explaining this change? You'll have to rebase onto the current master anyways, and it'd be really nice if this not-so-obvious change would be somewhat more well-documented. \nOtherwise, this looks good. I'm especially happy you added specs for the fixed behaviour. Thank you!\n. This is excellent. \ud83d\udcaf \n. Great. \ud83d\udc4d \n. \ud83d\udc4d \n. Hi @brchristian we've had exactly this PR in the past and decided to not accept it. For reasons, please look at the old PR - essentially we do not want the additional setter methods for this relation to be auto-created and believe the speedup can be achieved differently. \n. https://github.com/solidusio/solidus/pull/872 was the old one, sorry, forgot to paste this before. \n. \ud83d\udc4d \n. \ud83d\udc4d \n. I'd totally merge this in as it's an obvious mistake, but your commit has an E-Mail address that's not connected to your github account. Maybe it makes sense to configure your git client such that your contribution appears on your bathroom tiles! Btw: There's no harm ever in amending and force-pushing a PR ;) \n. \ud83d\udc4d \n. LGTM. \ud83d\udc4d \n. I've seen the need for subregions in Italy (where shipping depends on the region) as well as the Netherlands (where Paypal obscurely needs subregion data). \nIn Italy the states are typed \"region\" in Carmen, but they're still necessary. I wouldn't go this route, especially as even a large states table is not a big performance issue. \nLastly, the typed method in Carmen is not released yet. \nThe states_required boolean is used for displaying the state select in address forms, so quite necessary. \n. Module a bunch of nitpicks/questions, great work! \ud83d\udc4d \n. \ud83d\udc4d \n. I think it'd be great to have an API for creating payment sources like credit cards. \nHowever: \n- @jordan-brough is working on supporting payment sources other than credit cards, and it'd be great to support that work with this endpoint. \n- you're targeting the 1.3 branch, on which we won't accept new features\n- the commits can IMO be squashed\n- the commits are not connected to your github account, which is fine with us but might not be fine with you\n- I know the API relies heavily on the order importer, but it really should use core instead. If we introduce new endpoints, it might be a good thing to just use the core models instead of the importer. \n. \ud83d\udc4d \n. Would you mind rebasing the empty merge commit out of this PR? \nAlso, I would love you to make Hound happy by removing the empty newlines. We use Hound in order to enforce a (pretty lenient) style guide that helps us reduce noise in diffs down the line, and ignore his advice only in rare, well-reasoned cases.\n. photoshovel: You can totally add this route to your app, and it'll probably be supported for a long time. The credit card model is not going away. If you were to rebuild it using the wallet, that would have a much better chance of being merged. \nWe're understanding that the reality of payment sources is much richer than credit cards, and that's  the primary reason for this not being merged: We don't want to maintain an endpoint for one specific payment source, but for all the ones we support. \nSolidus is also meant to be a lean base for you to build what you need on top. Do open an issue next time describing what you intend to do and get early feedback before you put work into creating a PR. Your contributions are much appreciated!. This is good. \ud83d\udc4d !\n. \ud83d\udc4d \n. I have tried to remove it in the prices refactoring, but at the time we felt it to be unrelated, so I axed that change. I still would like to see that gone.\n. Hey @kennyadsl - I looked through the code and have issues with it :) - By default, a user should only be shown products and variants that have a price in the current currency (that's why the Variant.with_prices scope  exists). The default product searcher, which is used in the standard frontend products controller, will also exclude products without matching prices.\nI think the line item should be invalid and error out if no price with the right pricing options can be found. \n. Hey @kennyadsl I left some comments on the commit itself; I think we can simplify things a little bit more as some of the stuff in there has been deprecated for a while already. \n. The promotion categories sub navigation has been added to the menu already. I've opened another PR with your test suite improvements. . \ud83d\udc4d \n. \ud83d\udc4d \n. \ud83d\udc4d \n. Mainly, for two reasons: \n1. The Spree project, from which Solidus forks, has started out like that, and we're very keen on preserving the commit history of the project. \n2. Changes in one part of the project very likely affect the other parts. When we review changes, we want to run the test suite against all of them so we know when we break things. \n. \ud83d\udc4d \n. This is very interesting - might be a thing with path delimiters (/ vs \\) that we're not doing well. \n. @tvdeyen I know you fixed this in a client project, do you agree this works well? . I think this issue is fixed via #1487 .\n. The alias there is a bug. amount should be the subtotal before adjustments, and total should be the total after adjustments. The deprecation makes it seem as though they're synonymous, which they aren't. \n@jrochkind amount is usually a BigDecimal, and the display_money module creates display_* methods that return money objects. That's how it should be. Can you point me to instances where amount returns a Spree::Money?\n. I was wrong here before. There is (thankfully) no total method on Spree::LineItem, so deprecating display_total is the correct way of going about it.\nWhat this PR misses is removing all the calls to line_item.display_total from the code base, as that's what makes the build fail. @vladstoick Would you mind? \n. \ud83d\udc4d \n. I'm \ud83d\udc4d on this. \n. I like the setter idea. I've thought about doing it at the controller level, where it admittedly belongs, but then I view that doing this at the model level is very much the Rails way and would confuse people less if they ever manipulate prices from another, custom controller. \nWill amend.\n. Thanks @jhawthorn - amended.\n. Whether this should be on the 1.4 and 2.0 branches is a decision I'd like to leave up to @jhawthorn. \n. If we're changing the key, I would rather change it to a properly namespaced key. There is the convention with t(\".create_use_order\") which will expand into a partial-specific path, also namespaced under spree: spree.admin.users.user_page_actions.create_user_order.\n@jhawthorn What do you think? I would love to get rid of the Spree.t helper, as it really does not provide a lot of value over the standard Rails helper.\n. It's not a solidus convention, it's a rails thing (not super-well-known, but \ud83d\udcaf ) From http://api.rubyonrails.org/classes/ActionView/Helpers/TranslationHelper.html#method-i-translate: \n\nSecond, if the key starts with a period translate will scope the key by the current partial. Calling translate(\".foo\") from the people/index.html.erb template is equivalent to calling translate(\"people.index.foo\"). This makes it less repetitive to translate many keys within the same partial and provides a convention to scope keys consistently.\n. I think as long as the key is only used in that particular partial, we can just take that. If we need to reuse it somewhere else, we have two options: New key, or explicitly referring to the previous partial's name (`t(:new_user_order, 'spree.admin.user.user_page_actions.create_user_page_order'). Not a big deal. \n\nRegarding \"Giving up on scopes\": Do not do that. It's frequently misses subtleties in other languages, and we end up with terrible, terrible keys like \"state\" meaning BOTH \"region\" and \"status\", which e.g. in German are different things. Do not give up scopes.\n. Umm... Yes, that was my fault :). \ud83d\udc4d \n. The commit removing the is_default column has not yet been released, so no need for backporting. \n. I love this. \ud83d\udc4d \n. @jhawthorn Yep, I have to agree. The user needs to know which option types are selected for a particular variant she's pricing, but she doesn't create new variants here, which she would need that table for. \n. I prefer the solution with local_assigns[] :)\n. Hey @chrisradford , are you on Solidus master? It should be fixed there, via this PR https://github.com/solidusio/solidus/pull/1468 .\n. That scenario is why the cart_tax_country_iso setting is not a global setting, but one works by store. Can you have a separate store (URL) for China? Or can you somehow find out in the frontend where the customer is from? \n. OK, closing this as resolved then. :)\n. This is not necessary. You need to set the cart_tax_country_iso of your store to \"SG\", and then you'll have Singaporean prices for empty carts. Also, this loads the admin_vat_country_iso setting with frontend meaning, which I don't like. \nI know there are a bunch of settings in a number of different places and I eventually have to write a HOWTO about it. :)\n. Closing in favour of #1586 .\n. @jrochkind An order's shipping address might actually match several zones with tax rates attached. It's far easier to check which zones have the state or country of the shipping address, and then get the tax rates for them. \nThe way this worked before was: \nWe run Zone.match, get an array of zones and arbitrarily select one of them and designate it the tax zone. THEN, we do a matching of zones against that zone, where we had to check whether the rates zones wholly contain the order's tax zone, and it's all really unnecessarily complex. If you feel like, watch my talk on the subject: https://www.youtube.com/watch?v=BRnY-BidYRM :)\n. OK, @tvdeyen this makes sense. My fault here for providing an example test... Maybe add a spec for the base calculator to call model_name.human instead? @gevann you can do that in an additional commit.\n. I think this should be just customized by overriding the relevant view, and that method is a little superfluous anyways.\nDon't get me wrong, I think this is well-executed and would be alright, but I'd rather limit the amount of configuration and helpers and instead just put things like that in templates. \n. Addressed the nits! Thanks @Senjai \n. I think that this delegation has a different purpose than line the association on line 14. \nThe association defines line_item.variant, while the delegate, depending on the association, defines line_item.product - a method I find to be worthwhile. It might make sense to add allow_nil: true so that the delegation doesn't fail when the line item, for some reason, does not yet have a variant associated. \nRather than see this delegate go, I would want to see a spec for it. I do believe people might rely on it.. @jhawthorn Thanks, good by me then :). ...amended. :). In Versions of Spree and Solidus prior to Solidus 1.3, this piece of code is responsible for \"refunding\" value added tax when exporting (since back then there was really only one price for every variant). That refund has to be \"additional\" and negative, otherwise it would have no effect. \nI agree this is a weird piece of code, and we're going to remove it in Solidus 3.0. However, for backwards compatibility reasons, we will still keep it. There is also a bunch of other weird pieces of code in the default tax calculator, which have to go along with these two lines. \nTo know more about the history of this piece of code, I recommend watching my SolidusConf 2016 talk: https://www.youtube.com/watch?v=BRnY-BidYRM\n. Added a short changelog entry (although I think it's really a bugfix).. I've re-ordered the guide so that the VAT/Sales tax differentiation is explained in the beginning, then Solidus' taxation system is explained, then the pricing system. \nI've also removed some confusing/repeating paragraphs. \n. I'm also fine with this. Quoting the Zen of Python:\n\nNamespaces are one honking great idea -- let's do more of those!\n\n;). I like the approach (like I said in the workshop). To more clearly state the purpose of this (which we talked about IRL): \nSpree::Order has a checkout_allowed? method which returns false if there's no line items present. In that case the state machine will refuse to advance to checkout, but only with a generic error message that doesn't really say much to the user. If one were to add more conditions (in the workshop, the example was that an order needs to be > 100 dollars total), the user would not get an appropriate error message. \nThe solution proposed here adds a checkout_errors thingy filled with ActiveModel::Error objects that won't stop the order from being persisted but still add meaningful errors usable in the API or in the frontend. \nThis PR I think needs a couple of things though: \n\nIt can be simplified quite a bit I think. I wouldn't add a concern, but rather some PORO that does all of this. I would like the \"no line items present\" condition to also be implemented with this, and the checkout_allowed? method to query for checkout errors. \n\nThe build is still failing, and we need tests for this behaviour. \n@oniram88 Would you be up for spending more time on this? Don't go right now though, as there will probably be a bit of discussion around architecture here. Nevertheless, thank you for coming up with this, I think it's a pretty neat feature. \n. What I'm thinking of is refactoring Spree::Order#checkout_allowed? to something like the following:\nruby\ndef checkout_allowed?\n  Spree::Checkout.new(self).can_start?\nend\nSo there would need to be a Spree::Checkout object. I would not make this persisted yet, just make it a PORO: \nruby\nmodule Spree\n  class Checkout\n    def initialize(order)\n      @order = order\n    end\n    def can_start?\n      Spree::Config.checkout_blockers.any? { |blocker| blocker(@order).blocks_checkout? }\u00a0\n    end\n    def checkout_blocker_errors\n      Spree::Config.checkout_blockers.map? { |blocker| blocker(@order).error }.compact\u00a0\n    end\n  end\nend\nSo this in turn requires a setting for an array of Checkout blockers: \nruby\nclass Spree::AppConfiguration\n  attr_writer :checkout_blockers\n  def checkout_blockers\n    @checkout_blockers ||= [Spree::Checkout::Blockers::LineItemsRequired]\n  end\nend\nAnd, finally, a set of checkout blockers, structured like this: \nruby\nclass Spree::Checkout::Blockers::LineItemsRequired\n  def initialize(order)\n    @order = order\n  end\n  def blocks_checkout?\n    @order.line_items.empty?\n  end\n  def error\n    return unless blocks_checkout?\n    ActiveModel::Error.new(@order, \"Not enough items\")\n  end\nend\nAll of these would have to tested and documented using YARD docs, implemented well, with proper spacing and stuff though. \nEDIT: I've run this by @clarke, who has a very different opinion on how to do this properly, with pretty good reasons. \nI'll leave this solution here as a starting point for a discussion. Let's go slow on this. . I still think this would be a good path towards moving checkout validations into their own class. However, there has not been any activity on this PR since December 2016, so I'm closing it. . @alepore Thank you, this is good.. I really appreciate your work on this! But the solution you're proposing doesn't look right. You want to go two routes, possibly: \n\nMake sure the callback is called only once somehow\nCheck in the VAT price generator whether the price we're looking for is already in the unsaved prices array on the variant in question (replace find_or_create_by with a select statement). \n\nAlso, you changed the spec to actually create eight prices, when we would expect only four to be created.  . This looks like a cleaner approach to me, thank you very much for this contribution. One more thing: Can you squash the commits (I think one commit would be sufficient) and provide a good commit message for it? . @fschwahn FYI we have a policy of not merging approved PRs for at least 24 hours. While this has a good chance of being merged, it might take a couple of days. This is to allow community feedback. . sechix: It seems like you're running with precompiled assets, which shouldn't be happening in development mode. Have you seen our tutorial under https://github.com/solidusio/solidus/blob/master/guides/getting_started.md ? Please try re-installing using that tutorial. If you have trouble again, please post an exact description of what you did along with your Gemfile and Gemfile.lock.\nSolidus is a Rails application, it might make sense for you to read through the Rails guides under http://guides.rubyonrails.org/. . We'd like Spree::Money to implement all the things that the base Money object supports, one by one. If this particular itches you, by all means submit a PR!. Resolved conflict with the current master branch so that the changelog entry is in the right place. I still think this is a worthwhile change.. Awesome. This does all the things @tvdeyen and I planned to do. \ud83d\udc4d . @jhawthorn @jordan-brough I'll leave this PR to Team America. . Hey @vishalzambre, will you look into this again? I understand your concern: In a multi-currency store, calculators need to be aware of the currencies. However, while you did add some validations, I don't see how this plays out in the backend (how do you administer multi-currency calculators), and I'm also not sure BigDecimal.new(\"0\") is always the answer. Also, the test suite is failing. \nMaybe have a look into the available? method on calculators, and make sure calculators only return true for objects they can calculate? \nAlso, since this PR has been quiet for some time, we'd close this issue if it turns out you don't have the time/energy to do this.. We discussed this in core, and we think this is an oversight. The transfer_to_* methods on Spree::Shipment, however, do have a number of other strange side effects: If the price of your line item is somehow different from the variant's price, the new line item you obtain after doing a full split (fulfilling all inventory from another stock location) will the variant's default price. \nAlso, going through order.contents.{add, remove} makes this operation really slow for shipments with many inventory units.. This is really neat. However, I see some commits do not pass CI. :(. Closing this as stale. I've created issue #2251 to mark that the underlying issue still needs work. @akihitoalextsuboi if you want please re-open this with a better variable name if you want to.. Reopening this as the fix in #1984 would allow frontend users to select a backend-only shipping method too easily. See #2077.. What about the case where an admin edits a customer-created order to give them a shipping method the customer can not access? \nI get the point about not giving customers access to backend only rates; I'd amend the PR so that the frontend selects the rates by their frontend-viewability, too.. If we do it via frontend_viewable, we can entirely pass on the second argument to estimator.shipping_rates(package, frontend_only =  true). . There is an issue for this problem as well.. Closing this in favour of #1984.. I'm waiting for the discussion on #1739.. \ud83d\udc4d . @cbrunsdon The spec suite doesn't catch any complex behaviour when removing the column. :). @jhawthorn I think you might be right here. What about having something like \ndelegate :order_id to: :shipment in order to have concise usage of inventory units? @tvdeyen concern is a law-of-demeter concern where he's like \"the manifest shouldn't know about the order's id\", and that could \"fix\" both of your concerns (as well as possibly making the changeset a lot smaller. \nThe PR at the moment always checks for the full order, which does introduce more objects being loaded.. Rebased on current master, and fixed for Rails 5. From my point of view, this is still a very sensible thing to do. Oh Inventory Units.. @tvdeyen would you mind re-reviewing?. For a line item with 5000 quantity, this is the difference in destroy performance: \nmaster: \n95.640000   0.900000  96.540000 ( 97.042166)\nThis PR: \n5.590000   0.140000   5.730000 (  5.788784). I've been thinking about this, and it's not the right way to do this. . Hey @eric1234 thank you, very nice work (and yeah, this has generated a lot of discussion). \nWould you mind merging the three commits into one (and removing the code nazi language)?\nThank you again for your patience and hard work. . \ud83d\udc4f . Once https://github.com/solidusio/solidus/pull/1787 is in, this will be green. I'll rebase then rather than create a merge conflict.. I think the change with the smallest impact that fixes the bug would be overriding #parent on the VariantsController.. I would rather keep this old-fashioned and working without JS. If stores want to do this, it'll take a few lines of code as @kennyadsl notes. . Go for it. I see a challenge in administering this nicely in the backend, but from a data architecture standpoint this makes a whole lot of sense. :+1: . @softr8 We used to have an is_default boolean on prices that we removed because it was not clear what kind of default that would mean. \nThe master price is defined to be of the configured default currency for admins. If that price is empty, the form should still render with the default currency, and an empty master price.. I think it's good to port existing docs and have something. The technical writer will probably change things, but let's just iteratively move forward on this. Thank you!. @mtomov is still working on this. Closed via #1886 . Please squash both commits into one (the first one would introduce a commit at which we'd have a failing test suite, which is no good when you try git bisect to find which commit introduced regressions). \nAlso, your commit message's title is too long (50 characters is what you should aim for), and the body of the message reads like the commit title of another commit, not like an explanation of why you did that change. I encourage reading the aforementioned blog post again! \nLike I said before, I am absolutely fine with the content of the PR. But please be considerate to future readers of this code base.. @spaghetticode The commit message is much improved now, thank you for that! \n@tvdeyen if you have a minute could you re-review this? I think your concerns have been addressed, too.. Closed via #1938 . Fixed via #1904 . Thank you!. I think this accidentally slipped into the codebase, actually.. Added a changelog entry as well as a spec for the intended behaviour.. I part from the idea that it is possible to change the line items of an order when it is completed but not shipped yet. If that is possible, then the shipments must be able to change, too, as the line items will need to be shipped somehow.. Rebased on current master.. @jhawthorn This is primarily intended to make splitting shipments for completed orders work. Right now it doesn't at all because the new shipment won't have rates.. If it isn't used and you can remove it from core without anything breaking, remove it.. @jordan-brough I think @gmacdougall s concern is valid. Seems like we need to add another line to that method. :). We discussed IRL that both @jordan-brough and I agree that changing the semantics of finalized to never be applicable to tax rates on unshipped orders makes sense. If we have to unfinalize and finalize within the same method we're only adding complexity and database calls to the code at no advantage in code clarity.. I think this is a beneficial change. One way to test it would be a controller test with stubbing order.contents, expecting that that double receives add with the options. Given that we allow this as an extension point but don't use it in core, there's no \"real\" way of testing it that does not involve a disproportiate amount of spec setup.. I think this removes the promotion that created the promotion adjustment, not the adjustment. This would mean that if we have a promotion that applies to a thousand carts and a user clears their cart, that promotion would fail to apply for all remaining orders. I would also delete all promotion codes associated with it. \nI think it'd be good to look into what happens here exactly, because the existing code should destroy all adjustments for this order. . This class is already well-tested, and will work with both default preferences. I think we don't need another test for this actually, but I whole-heartedly agree that adding a more helpful commit message would be great. Here's an article describing what great commit messages look like: https://chris.beams.io/posts/git-commit/.  A simple spec to test this would be\n```ruby\nRSpec.describe Spree::Promotion::Rules::ItemTotal do \n  let(:rule) { described_class.new }\ndescribe \"#preferred_item_total\" do \n    subject { rule.preferred_item_total }\n    it { is_expected.to eq('gt') }\n  end\nend\n```\nWe just discussed this IRL and both think this would make sense to add in.. I'm fine adding this in. Please squash your commits into one, and try making the commit message for this commit adhere to Chris Beams blog post. Thank you! :). You don't need to open a new PR, but can use git push --force once you have squashed your commits. Btw the build will also restart when you do this, so I'm not retriggering now. \n. @ranxiang any news on this?. Closing as stale.. This makes sense to me: If we have any promotable line items, order level promotions should apply. The promotion rule can then decide what total to use, but generally the rules should come into effect if any line items are promotable. \nCould you be a little more elaborate in your commit message about what this change entails?. @gmacdougall this is now configurable, and I still think this is a beneficial change. Would you mind re-evaluating?. Hm, I'm not sure we need the billing address on the payment screen. We already have it on the Customer Details screen, don't we? \nAlso: I'm missing the ability to use an existing payment source (credit card). Maybe it makes sense to make that one of those tiered select boxes?. Please do the renaming in a separate PR. This is great as it adds specs though!. I'm not sure I understand why line item level adjustments have to be source-less.. Yeah, sounds good, actually. In the meantime, someone else got to editing the change log, do you mind rebasing?. @skukx Largely, we need to expose those WalletPaymentSources because frontend returns singular IDs, whereas payment sources are polymorphic and could be anything from a credit card to a roman debt token. \nYes, in most cases we want the payment_source, but we opted for the not-so-pretty-looking but more correct wallet.default_wallet_payment_source.payment_source. That API allows us to do all the things we need while not exposing any methods called one thing and returning another. . This looks good to me, but needs a changelog entry for people who have overridden or used that class attribute. Also, would you mind squashing the Hound appeasement into the previous commit?. @jordan-brough yes that could still happen, but I've since been convinced that admins should have that power. For example, stores that model packaging via variant options might want to change how a variant is packaged (in a bag or a carton) without having to re-create the variant and possibly losing the connection to the previous packaging for analytics.. @kennyadsl Would you mind rebasing on the current master branch?. Thank you!. Let's merge this once the extension has been moved to the solidusio-contrib organization and a Rubygem has been cut.. @cbrunsdon Sure, as long as people can use the extension from their Gemfile somehow, this is good to go.. Yeah, I like seeing tests run, too. @cbrunsdon Would you be happy with a note saying: \"This gem is deprecated, don't use\"?. When would these files be run? . The cart_tax_country_iso determines for which country taxes are shown in the cart. As stores that sell to the US do not need to show taxes in the cart, I think it's fine to leave this as nil.. I don't think we should add another dependency to core for this task. Most authentication solutions come with email validation of sorts, and the needs people have for this vary wildly. \nI specifically didn't add the Hack Day label to this one because it's much harder than it initally seems.... We discussed this in the core team, and we all think we should not try handling email validation in core. Closing this - thank you for the effort though!. Clarkes announcement does not preclude the community from porting Spree documentation. The person that will be hired will have lots to do either way, so I suggest going on with community-delivered guides. \n@Reddshift this is an amazing effort, an I would very much like to see this merged as it still is a pretty good guide. . I think I'm not a big fan of this. Payment Sources should quack like payment sources, and they have their respective partials for being rendered. If a specific store needs logic around types of payment sources in the wallet, they should implement it in their host apps. \nI would also not like a feature in core that breaks development mode in Rails. \nIt is definitely an interesting idea, but drawbacks vs advantages I think yield a rather not.... I also agree this is a good fix to an existing problem. Would you mind adding a request spec for this change though?. @Draiken The controller spec is perfect. It's more about documenting that we want this to be a post action, for the reasons you mention in the PR. . The variant view has been fixed in https://github.com/solidusio/solidus/pull/1804, so we can actually display that link. Would you mind removing the if condition there, and rebasing? . @kennyadsl would you mind rebasing this on the current master? The changelog changed again. :). The most complete repository for locale data is by far the CLDR. There might very well be a flag hidden in there that we could use for this. It would require some digging though. The good news is we already have it as a dependency (and use it only for validating postal codes at the moment). . You need to add the attribute to the LineItem somehow. In most cases this would be an additional column or an associated model.. I've opened an issue linking to this PR. . We just ran into this today. The culprit is solidus_auth_devise, which uses its preferences singleton to figure out whether it should load the frontend routes or not. \nAdding an initializer config/initializers/solidus_auth_devise_fix.rb fixes it: \nSpree::Auth::Config.use_static_configuration!. That'd be a great PR!. This is a can of worms. We explicitly don't run the Shipment state machine, and rather determine the shipment's state by its attributes for performance and complexity reasons (the order and shipment state machine interact in strange ways). \nYou're right in that we should do one of two things: Either remove the shipment state machine entirely, or actually use it.. Thank you John for updating the changelog. I've had too much on my plate. . .flash.error apparently also counts as a compound selector. \nThis line still triggers that warning in the sandbox. \nOtherwise, things look still good. :)\n. @jasonfb There was a comment here that was almost impossible to read, and I'm not even sure it wasn't a spam filter overreacting. Would you mind posting your answer again?. I think you would need to add spec/**/* rather than changing it. Because Solidus is split up in submodules, the actual tests are in core/spec, backend/spec and so on, and * apparently doesn't match nothing. :). Sorry @jordan-brough I must've had my eyes clogged. :). I am very much for this, but would like a dedicated changelog entry detailing that this is happening and what it means.. Will this also affect extension's Configuration objects?. @Eth3rnit3 Have you overridden any style sheets in your host app? Compare them with the ones in Solidus 2.4. You're probably not requiring the pills SCSS file.. @jhawthorn Should I take this over again? . > 1. Should we make proper canceled and not_canceled scopes for the Order model, to go along with frequently used scopes like complete?\nYes, that would be nice. You can add those to this PR or open a new one.\n\n\nShould the complete scope by default exclude canceled orders unless explicitly called for complete_including_canceled, the way that Product#variants by default excludes the master variant unless and we specify variants_including_master, or how various scopes exclude deleted objects unless we use with_deleted scopes?\n\n\nNo, complete just means that the order has, at some point in the past, been completed. In the core team, we were discussing we might be missing a name for a scope that is completed.not_canceled, but we did not come up with one. \n. @brchristian any news on this? Will you be able to add a request spec?. I actually do. I think the model-level changes (including the spec, which is perfect) should go into one commit, and then we should have another commit that changes the controller to use the new scope. \nSorry to be so picky, but we'll all be thankful when we go back to the history of this. :). @brchristian thanks for following up! Yes, in my opinion this is good to go, but needs another pair of eyes from the core team. . Have you checked whether this actually affects the current master branch? That object is precisely designed to avoid that flaw.. That validation has been removed from the line item and moved towards the before_complete callback in the order state machine for performance reason. If you want to re-add it, simply add the line \nruby\nvalidates_with Spree::Stock::AvailabilityValidator, if: { !order.completed? }\nto your Spree::LineItemDecorator. \nHowever: I don't think this is an ideal solution as the record is not actually properly invalid. The thing might come back in stock before the order is completed. It's rather something that should be implemented in your custom frontend as a before_action, with a better error message than ActiveRecord::RecordInvalid. \n. Damagoza: To use bootstrap, you have to customize the frontend. See https://www.youtube.com/watch?v=kFalBLRMgdI for more information. \nGithub issues are meant to inform about bugs and/or missing features, by the way. For support questions like this, please use our Slack channel (solidusio.slack.com).. Closing as #2120 has been merged.. We hope this fixes the issue, we're reasonably sure it got introduced in #1392 and this seems to fix it.. Can I PR more removals to this PR? If we get rid of this migration, I would also like to remove Spree::Zone.default_tax and all the code paths that do the weirdo \"tax refund\" thing.. I'll PR that other removal separately.. To get all tax rates that apply to an order, run the following code: \nSpree::TaxRate.for_address(order.tax_address)\nYou can just bypass the zones as an implementation detail.. jasonfb: It's a reference to Frankenstein the movie, and yeah, it's a messy thing. It's an included tax adjustment (which by definition does not change the line item's amount) with a negative amount, which - because of its negative amount - is counted as additional, changing the line item's amount. If that sounds confusing to you, that's because it is.. I will once other people have weighed in and also think this is the right thing to do :). The updater loads shipments and line items anyways, those will be loaded. Only new or changed records will be validated. I'm guessing we'd see additional queries for variants on changed line items. New addresses will load states and countries. \nI think the benefits of running validations justifies a couple of additional queries. \nShipments have no validations to speak of. . This still needs a :+1: from @kennyadsl or someone from the core team. IIRC the decision was to merge it and eat the performance penalty in the interest of debuggability.. Yeah, I agree with @jhawthorn that we don't need an extra page for what is essentially a search. . Would you mind trying this on the master branch? We worked a lot on those features, and bugs like that should be resolved now.. Can you try this out in the current master version of Solidus? This bug might be fixed already.. I'm saying the current master, which is still unreleased. I know it's an issue in all released versions. . We keep released versions stable, and only add changes in behaviour like this for new releases. We consider the bug, therefore fixed. Closing this issue.. I'm all for this. However, we don't just delete methods like that. Please deprecate it, and we can remove it in a future version. People might have used this method in their host apps, and just removing it without a warning would be a terrible dev experience.. Closing due to localization issues with browser vendors.. I think products might have touch: true on classifications as well (I'm sure they have on taxons). Can you check whether touching on both sides does not create race conditions? If it does not, this makes perfect sense, and I would be very happy to see a PR for this. . Yeah, infinite touch loop is in fact what I meant :) Thanks for clarifying!. This is taken from #1402, which by itself was stale but contained good stuff.. Wrong repo.. We offer a frontend and a backend, and you can just not require these or override their CSS/JS. You'll need both for a functional store. Closing this for not being specific enough.. @aosorio1 There is a Solidus version of that plugin by Boomer Digital: https://github.com/boomerdigital/solidus_flexi_variants.\nWe don't have a forum, but you're welcome to use our Slack channels under https://sodiusio.slack.com.\nIf you want to build this functionality yourself, we have good support for customizing pricing using the Variant::PriceSelector class.. There used to be https://github.com/solidusio/solidus/pull/564, which is a more comprehensive solution to this thing. @jhawthorn What do you think, should we just revive that? . In my understanding, a stock item can not have a negative count on hand. Backordered items also should not affect the count on hand. What's the scenario you want the negative count on hand for?. I don't think stock item's should have a negative count on hand. In my understanding, backordered stock items don't affect the count on hand.. I was wrong, just re-checked the way Spree::OrderInventory handles these cases. In fact, negative stock items are desired in order to account for the case that inventory is added and used up by backordered stock items. . This does not seem to be erroneous behaviour to me. If you split the shipment, and generate more shipping cost, the new shipment is unpaid and therefore pending. Rather than creating more payments to account for the difference, you could also add a free shipping method or add an adjustment to offset the missing payment. Are these two options you could consider?. Some of my comments appear as outdated, but they are not.. Oh I had no idea how terrible Deface is. Still, pro this for the reasons @tvdeyen points out.. I keep my approval.. I think that it makes sense to do this at the model level: If the country is changed to one that does not require states, set the state_id to nil. . @hhff The deprecations probably do not come out of code you wrote yourself, but out of the solidus_gateway gem . Try updating that. . Hey @pelargir, thank you! Would you mind adding a spec for the intended behaviour? I know there is one :)\n. Looks good, but can you look into the failing spec?. Hm. The spec failure fix makes me wary. Why do the first two commits change the return value of variant.default_price? If we break that method, many admin views will cease to function.. Hm. The spec failure fix makes me wary. Why do the first two commits change the return value of variant.default_price? If we break that method, many admin views will cease to function.. I agree with @gmacdougall here. Shaving four seconds off the test suite for potentially introducing caching errors does not seem worth it to me. Also, I have seen code bases where option values are changed from Rake tasks.... Sorry, I thought we changed the partial name with deprecating the Spree::Gateway class, but we didn't: \nhttps://github.com/solidusio/solidus/blob/master/core/app/models/spree/payment_method/credit_card.rb#L15\nSo, keep the partial name, but do add a spec. :heart: . Thank you John, good tip! Weirdly though, in this particular context ActiveRecord seems to have difficulty generating the correct SQL for the pricing options' search arguments, so I had to write some SQL by hand to make it work. This means that if a store overrides their pricing options class they might have to override the with_prices scope, too. If anyone can come up with a more generic solution, I'm all for it. . Thank you. I think this is a great step forward. . To make the addition take precedence over the substraction. \n. This commit is part of a larger refactoring of the taxation system. Are you planning to also port that to Solidus? \n. I should mark my jokes better :)\n. @jhawthorn https://github.com/spree/spree/pull/6295/ - sorry, it's large...\n. Nope, currency here is a local variable and is not passed into the LineItem instance. \n. Because the price may be different if the currency is different: A variant can have prices in multiple currencies. But I'll look into it! The method is too complex for my liking too... \n. Whoopsie! I don't think that Company exists. :)\n. Solidus Commerce Inc. :)\n. Solidus is a fork of Spree. \n. ... legacy versions of Spree (not Solidus) in this context\n. Spree Commerce, Inc.\n. This should not be changed for the time being IMHO, and maybe there should be a bit of discussion about use of the name Solidus. \n. I wouldn't mind doing that, but that was Kevin's decision, and I didn't want to touch his stuff. @Sinetheta should the file be moved? \n. Yes. If your default zone is Germany, and you have a tax rate defined for Europe, and then you try to ship outside Europe, you want to be aware that there's a European tax rate in your price. \nI deliberately chose a test setup with hairy cases like this, and reverting this to the original breaks seven specs: https://gist.github.com/mamhoff/512dae674e2437133eec\n. Yes, correct, the comment is not correct in this case.\nThere is this idea of a smallest possible zone (Spree::Zone.match(address)) produces just that, the smallest fitting zone for an address. Apparently, a default zone should also be like that (contain no other zones). \nI'll fix the comment. \n. There's some fun bits in the production code. If you have questions, shoot them at me, I'm reachable on slack.\n. Yep, agree. Fixing.\n. Absolutely. Thanks for the heads-up! :100: \n. I know, but that would mean iterating twice over all the tax rates in the system, and running the expensive contains? call double as often. \n. Whoops, you're right. This way I just run the contains? call twice pre iteration, nothing gained. \n. Why is this beneficial? I'd find variant more descriptive as a variable name than x. \n. product would be better than x, imo.\n. I think this is the same one as above: t is much less descriptive than taxon. If the issue is variable name shadowing, maybe rather one like descendent_taxon? \n. While you're at it: line_items.sum(:amount)?\n. This is also variable shadowing, and I think here I'd be happier if the variable outside the block would be something like  pending_shipment_with_variant. Or extract it into a method with that name. \n. The second branch of the ||, could that not have a beautiful name, too: unshipped_from_stock_location_with_variant? I don't care if as method or as variable. \n. OK, var shadowing again. I don't mind the x. \n. Var shadowing, and x is only used on that one line, it's ok. Ignore this.\n. Ok, also keep it. This PR isn't for actually changing behaviour, and an additional roundtrip would be just that. \n. I added a safeguard clause that sets included_tax_total to 0 if NULL. The pre_tax_amount/ amount column has a NOT NULL db constraint set, so no worries on that side of the plus. \n. What John said. However, medium term that entire method goes away when #783 gets applied.\n. We could, potentially. I shied away of adding more methods to Spree::Order. I'd do that on a later commit though once we actually see it DRYing away other things, namely when I have to write a method that does the same thing for the shipping rates in a shipment (https://github.com/solidusio/solidus/pull/759). \n. I can very well imagine a future non-bang adjust method: One that will not change the order, and not create adjustments, but just build them. That would be great to reduce database calls when updating items and orders. Alas, we're not there yet, but I'd like to keep this method's name the same at that point. \nYARD I can absolutely add, as this method returns the newly created adjustments (making it somewhat easier to test than Spree::TaxRate.adjust). \n. These are used in private methods of the included module TaxHelpers, in order to run the database calls that only have to run once per order only once per order: https://github.com/magiclabs/solidus/blob/add-tax-adjuster/core/app/models/spree/tax/tax_helpers.rb#L28-L38.\n. That would be more realistic, but the system under test here is the\ntaxation system. I'm assuming the shipping system works - the additional\nbenefit is that the rates used are always recognizable: 16 for sweaters, 8\nfor books and 2 for premium downloads ;)\nAm 05.02.2016 19:32 schrieb \"Thomas von Deyen\" notifications@github.com:\n\nIn core/spec/models/spree/tax/taxation_integration_spec.rb\nhttps://github.com/solidusio/solidus/pull/799#discussion_r52053847:\n\n\namount: 0.24,\ntax_category: digital_category,\nzone: romania_zone\n)\nend\nlet!(:book_shipping_method) do\ncreate :shipping_method,\ncost: 8.00,\nshipping_categories: [books_shipping_category],\ntax_category: books_category,\nzones: [eu_zone, world_zone]\nend\n  +\nlet!(:sweater_shipping_method) do\ncreate :shipping_method,\ncost: 16.00,\n\n\nIs this a real world use case? Shouldn't we test different rates for each\nzone? I.e.: 6\u20ac in German zone, 12\u20ac in EU zone, 20\u20ac for world?\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/pull/799/files#r52053847.\n. Yep, you're right. The comment also says deprecated, which I don't intend\nit to be. I'll force push once the build is through.\nAm 07.02.2016 19:28 schrieb \"Thomas von Deyen\" notifications@github.com:\nIn core/app/models/spree/app_configuration.rb\nhttps://github.com/solidusio/solidus/pull/810#discussion_r52121680:\n\n#   @return [Integer,nil] id of {Country} to be selected by default in dropdowns (default: nil)\n preference :default_country_id, :integer\n-    # @!attribute [rw] default_country_iso\n-    #   @deprecated\n-    #   @return [Integer,nil] id of {Country} to be selected by default in dropdowns (default: nil)\n\nThe comment says default nil, but the code 'us'\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/pull/810/files#r52121680.\n. So the scenario of find by ID returning nil is essentially a misconfigured shop. Previously, in that case it would return first, i.e. any country. I find it more fitting to actually return something sensible, and that would be the configured country by iso. \n\nIt's supposed to be nudging people into configuring their shops correctly. Apart from the address form and (newly) taxes, the default country is also used for stock locations, and should make sense there, too. \n. In that case I could possible also remove the show_rate_in_label column, as that's be handled by I18n entirely, no?\n. done!\n. No, it's on the instance :) see two lines below... \n. You're not getting mixed up, this is IMO a bug in the current taxation system. The pre_tax_amount is the basis on which to calculate VAT (another way to say this it's the actual value of the good). The current taxation system in Solidus allows that actual value to change under certain conditions (\"the receiving country also has VAT\"). If the receiving country does not have VAT, then we create this refund so it kinda sorta appears like we didn't charge it in the first place. \nThis is actually a glimpse into Solidus' future taxation system: All the prices that come out of the backend (calculated prices as well as prices entered by admins) will include the VAT of ONE place. If we ship to another place with different VAT, then we have to deduct that VAT (only), and apply another one. \nI think I will extract this to its own PR as it's really quite a complex topic. \n. Here we go https://github.com/solidusio/solidus/pull/941\n. Yes, that's exactly the reason. The estimator doesn't really build shipments at all, one of the other stock classes does that. And no, a shipping rate without a shipment doesn't really make a lot of sense. But I (honestly) get a little lost between packages, inventory units and shipments at times, so I opted for not refactoring that here. If anyone has a good idea on how to avoid this, I'm all for it. \n. Nope, I just needed the path helpers for now. \n. I think there's a need to have more than one price for the same things present, probably something like time-based pricing (can we make this new price the default from Wednesday next week?) \nI'd rather propose something like superseding, editable valid_from dates. That way, you always take the newest past valid from date, and you get a whole lot of flexibility at the cost of only one datetime field. What do you think?\n. I thought because of the multiline expression. But - having written code that doesn't need it, I guess it can go here as well. \n. Hm, I do have to call compute_amount on the tax_rates, which is a method with very weird behaviour that's actually about to change. I just had a long chat with @tvdeyen about ways to remedy this particular rabbit hole (it's deep) and essentially it will mean moving the weird behaviour of compute_amount into the Spree::Calculator::DefaultTax, then marking that class as deprecated, and creating a new, simpler Spree::Calculator::Tax::Default which hopefully makes things better. This is not ideal, but we have to make sure changing the implementation of how taxes are calculated does not break old taxes. \n. I thought about this but went for \"the simplest thing that could possibly work\". I do agree with digesting we'd be safe from key length issues. \nSomething that's crossed my mind though: Should we maybe ask the currently used pricer make sure the correct cache key is used? \n. Can absolutely be this one. I'm thinking after #994 is in, which gives us a first go at how a pricer would be structured, it could be quite neatly tucked into a new pricer that's less stupid than the ConservativeLineItemPricer. \n. Nope, coming to think of it: This PR should really just introduce this feature. Variant#prices.currently_valid will return all prices (all currencies and so on), and custom pricers will just add more attributes to select prices from - this caching strategy would still work in most cases. I'll work on your suggestions (use timecop and use the change matcher). \n. I think it does. The pricer I want to see will change the price even if it's already present, and I'd like to make that the standard one. It's not there yet...\n. Yep, I agree.\n. YARD: Sure. \nMoney object: Makes sense, requires a bit of tweaking here and there, and also the other PriceModifierLineItemPricer to be reworked a little. \n. I don't want to use a Spree::Price, as that would imply having the currency stored redundantly AGAIN. :) \n. A pricer's return value will be sent to_d and currency, expecting ::Moneys signature. I thought I'd allow a plain money object to start phasing out Spree::Money. \n. I elaborated more in the comments.\n. Wait, \"overrides\"? Is awesome_nested_set still around to be overridden, or does the method just follow the signature from awesome_nested_set?\nAlso: We tend to have comments above method definitions, along with a little bit of YARD doc. If you could move that once we've come to a decision about this PR, that'd be great.\n. This column does not exist anymore, and is not used for refunds anymore either (see #941 and #706). \nBesides, it's use further up is for a return item form, not a line item form. \n. This is the label for a input field for a ReturnItem, so we should not use the LineItems attributes here. \nBesides, the actual column has been renamed, so the key should be named amount. The translation in english can still be Amount before sales tax. \n. Is there a particular reason you're not using f.label :display_on here?\n. f.label :auto_capture?\n. This has :: before the method call, where you want  a single . (also the two lines below).\n. I don't think we need the align=\"center\" here. CSS should do that for us.\n. Same, no presentation in markup.\n. I think if we used the && operator here, we could remove some of the parens, making that ifstatement look less like a method call: \nruby\nif can?(:update, shipment) && !shipment.shipped?\n. Sorry, I've been playing with these fieldsets all day long - and I think this one should actually have a bottom border as it's the last fieldset on the page. Would you mind amending this again? \n. So there is no actions. Should then the header td not also be deleted? \n. I don't like this, but if I don't do something like that the checkbox that it's applied to (\"Track inventory\") is way too far up. I'm sure there's a better way to do this. Frontenders?\n. This is an unfortunate name, but content has already been taken by the div above that contains both the aside nav and the actual content. If anyone comes up with a better name, I'd be happier. \n. This is what happens if you use the t('.something') convention. It's nice, and very well namespaced. We're losing a bit of generality here, but on the other hand it's very easy to find where to add a translation. Loved it. \n. Perfect! Thanks loads!\n. I don't think so. It was only used for filtering, and that's been entirely revamped (we already \"lost\" @option_types and @option_values).\n. There's specs for exactly that case which I don't want to see raising the deprecation warning for the price_modifier system. That was the motivation behind this check. \nYour suggestion to not check the type is good, will amend later today. \n. This translation is not used in this PR, and I'm not sure whether Back End is actually more correct than Backend. \n. This can also be done using human_attribute_name, even though it isn't a database column. It's also kinda special, because it isn't really a description but the payment method's name, so I think it merits having its own translation. \n. This is the total field on Spree::ReturnItem, why do we use the translation from Spree::Reimbursement here?\n. Hound complained that has_key? is deprecated, and I should use key? instead. \n. Unfortunately, find_each doesn't work here, because pluck returns an array. Would .each not work, now that we con't create AR objects but simple strings?\n. I took some specs from solidus_multi_domain, and this case has been explicitly tested for: https://github.com/solidusio/solidus/pull/1060/files#diff-14ee7de4c10a42a47306354bec6b902eR20\n. The entire thing is terrible. \n. Is this to make the globalness of order_number more explicit?\n. I used money_price on the line item, would that be an alternative? Spree::Variant#money_price_for_options? \n. No particular reason. Should I amend? \n. I think it is outside the loop :)\n. That focus tag shouldn't go into the codebase :) \n. Can you add that space back in?\n. And add a space here?\n. Does this method have any unit tests?\n. Can you re-format the comments so they fit in a GitHub code preview? :) \n. These specs are great, and even if we decide to move the logic somewhere else, they should absolutely stay. \n. This is a naming thing: In my opinion, the tax_zone is a weird implementation-specific artifact. Can we name this constant TAXATION_ATTRIBUTES or something like that that does not imply Spree::Zone to be involved? Because it isn't (directly)\n. Target for deprecation as it's called nowhere in the Solidus codebase. \n. Deprecate this for a method that's not called active.\n. Spreee does not work. \n. price_difference_from_master(pricing_options).zero? if defined on Spree::Money\n. Deprecate these classes\n. Deprecate these two methods\n. No need to call product as variant will call product.\n. Use let!\n. Only call variant as variant2 is let!d.\n. Leave out the call to product.\n. Add a spec for default_pricing_options\n. This tests the pricers. Please delete. \n. Use Spree::LineItem.new() instead of stub_model. \n. Make the expectation clearly the thing we expect.\n. Expect an empty array instead, and test whether it returns stuff if we setup stuff for it. \n. Expect \"USD\" instead of line_item.order.currency. \n. Same\n. Same\n. Split this up into two explicit expecatations.\n. Once a user has, for example, a different tax address, these methods will need that user's or session's pricing options passed in here. I think that passing the argument is necessary (otherwise the user would get the price difference in the wrong currency, which would be wrong). I am, however, thinking it might be a good idea not to have a default argument and error out when these methods are called without arguments. \n. This is becoming the ultimate bikeshedding exercise, but: This method is now useless. Can you please please get rid of it?\n. Can you PR this in a separate PR that just fixes the indentation? I'm good with the change, just don't want to mix it up with some of the other stuff in this PR.\n. I don't understand why the changes you made are here. Does the view work without those changes? \n. Sure, will do. \n. Yes it is - there's no route for deletion yet. I should add that I guess :sheep: .\n. I would love to see time-based pricing. That aside, is_default is the most poorly named boolean I've seen so far: It's true be default, and adding a new price for a given currency will set all other prices for that currency/variant to is_default: false. So \"Currently valid\" is actually a pretty accurate translation for what it does.\n. I wouldn't do it. The Spree::Tax::TaxLocation is usually a pretty throwaway object. The big reason why we need this method is that countries are referenced by ID rather that ISO code (in which case I could just use that and not use a DB lookup). \nAlso: This query can return nil, in which case memoizing won't help.\n. Absolutely, working on it. \n. I'm considering naming it something else as it's anything that can be used as a XXXX to variant.prices.where(XXXX). For the case we're looking at here, it could even be a hash.\n. No, both of these need the exact desired_attributes hash, not something that only where can use. \n. has_many :tax_rates\nhas_many :vat_rates, -> { where(included_in_price: true) }\n. This is two times the same thing\n. Remove the fallback naming, use for_any_country.\n. for_any_country\n. Both of these should be before_validate as they actually set things. \n. VatPriceGenerator\n. Add an early exit for sales tax stores.\nreturn if variant_vat_rates.empty?\n. ...for choosing the price of a variant when displaying or adding it to a cart.\n. Thomas says: Maybe another name that hints more at choosing or retrieving prices\n. You have to nest the checkbox into the label, otherwise you can't click the label and reach the checkbox: \n<% form.label :terms_and_conditions do %>\n  <%= form.checkbox :terms_and_conditions do %>\n    <%= Spree.t(:accept_terms_and_conditions) %>\n  <% end %>\n<% end %>\nSemantically it's fine like you have it.\n. Thanks :) \nDon't listen to me, listen to @tvdeyen \n. I think there's a typo in the string. Just use \"#{self.class.name}\" ;)\n. If that zone is missing, the task should silently return. \n. Absolutely, thanks!\n. No, we only recently put the factories under test, and the coverage is not perfect yet. They're very complex, and we'll happily accept contributions towards improving both the factories and their specs. Yes, the test suite itself kinda sorta tests the factories, but that's all very implicit and meh. \nThis change is good as far as I'm concerned, but it does not test the improvements to the factory. @graygilmore If you want to add specs that test your improvements, I'd be happy - but I don't see that as a blocker for an obvious improvement.\n. I'll bring it up at the core meeting today, deferring until after that. \n. So we agreed we do want to have better specs for factories for sure. @graygilmore Just give us a heads-up if you're willing to spec out this factory a little more; @jhawthorn has given a fine example in #1264 on how to do this beautifully. \n. Can you make the expectation a bit more explicit? I fear that default_url_options[:host] might not be set in the test environment, and the test doesn't make that clear. \n. I think this can be done with the association method, which will hit the database less when using build_stubbed: \nassociation :source, factory: [:credit_card, user: order.user]\n. Both of these are valueable comments, I'd like to see them addressed (map > collect, do / end for multi-line blocks). \n. I believe this is the core of the entire matter. For every event, we want to have a class and a method that's fired with arguments. Can we reduce this PR to a simple dispatcher that calls configured_method on ConfiguredClass, and remove the ActionMailerDispatch class and much of the lambda stuff that IMO knows too much about the actual mailers?\n. I don't think this is necessary - the Dispatcher should not know about the signatures of the actual messaging receiver class. The only thing necessary IMO is the table I commented on before. \n. This line could go, as Spree::Deprecation specifies a version where this errors. \n. The comment is missing a word, maybe store?\n. The spec checks for the order's email being changed, not for the cart contents. Huh?\n. I don't think this call to subject is necessary anymore, is it?\n. Is this lambda necessary? I think the subject call will already make the code in the block callable?\n. This is a little strange, as the three values now add up to -1.66. Is there a tax adjustment hidden there?\n. Got it. Don't answer, Line 144-152 explain it all. \n. I don't even see why js: true is there, and suspect the spec would pass without it. @gevann do you mind removing that bit?\n. This can be written shorter as a delegate: \nruby\ndelegate :currency, to: :order\n. I think this should have a Safeguard: It should raise a good error when trying to assign a price with a currency different to the order currency. Otherwise the information would just be lost. So something along these lines: \n``` ruby\nclass CurrencyMismatch < StandardError; end\ndef money_price=(money)\n   return unless money\n   raise CurrencyMismatch, \"Line item price currency must match order currency!\" if money.currency.iso_code != currency\n   self.price = money.to_d\nend\n``\n. I like removing things from the public interface, but I'm not sure about moving this method to the private section. \n. Is there a reason for extracting this method? I wouldn't do that. :)\n. With the delegate, this can actually be written shorter asline_item.currency:)\n. Changing instance variable names in controllers can be hazardous if people overrode those views. This has not been around for long at all, and I do not suspect many people have used this instance variable name, so I won't ask for a deprecation warning, but maybe a short note in the ChangeLog.\n. Yes, this is good. I have a feeling one could golf around in this method a bit more, but I'm fine leaving it as is because it does the right things. \n. Really good documentation. I wish I'd had that when first reading this method :) \n. Because when you create a new price for an item, you're most likely doing that in the backend as an admin, and you'll expect the new price to be with the VAT the other prices in the admin area. The default country iso is the one used in the frontend. \n. An export price is a price without VAT, as in countries with VAT, if you export to a country where no VAT applies, you have to change the price to exclude VAT. We addnilbecause a price withnilis used for shipping to any country we have no information about. Otherwise we'd need to create a price for each country, which is redundant and tedious to work with. \n. There's a space missing here before the opening{. Can you add that one space? I know it's lots of commits to go and edit, but interactive rebase makes that pretty straightforward. Read up [here](https://www.atlassian.com/git/tutorials/rewriting-history/git-rebase-i) about it, it's great. And yes, please force push afterwards, we don't mind for open PRs before they're merged. \n. @gevann I second this thought. In the individual calculator specs, we only want to see something likeit_behaves_like \"a calculator with a description\". Thedescribeblock can go into the shared example. \n. I'm uneasy about the default currency beingUSDhere. If this isn't passed in in a context where the currency is anything else, this should actually throw an error IMO. \n. Why are these migrations extracted toraketasks? I did this for data migrations which depended on model methods, but in this case the rake task really only has SQL and almost no ruby dependency. I believe these should be directly inside this migration.\n. I think this is a fine change in principle, but the previous code had a!` before the main condition, turning the two branches around. Maybe rather: \nruby\n@product.has_variants? ? 'omega' : 'alpha'\n. This is a super-nit. Should we be mixing old- and new-style Hash syntax in the same line? I feel like if we touch the line anyways, we could just switch it over to new if nothing stands against it. \n. amended, thank you!. Yes, this is true. The step is really only there for the db:create step as without it, the generators won't start (they include that step, too). . This is copied verbatim from the Readme. And you're right, that step can go, it doesn't do anything.. I wouldn't consider that \"tax advice\", this is common knowledge (and is actually a verbatim copy of Spree's taxation guide :) ).. Good point, I'll move this section down. . True that, will rebase. . While I do link to files in Solidus' master branch, I wouldn't want to link to issues. These guides are for people who I hope run stable versions of Solidus, and issues have a tendency of becoming out-of-date (thanks for the linking the VAT Roadmap, I had pretty much forgotten about that).. It's a technical document, and describes what's possible. Something like US sales tax is possible, and that's what the documentation tells you. Zipcode-level taxation is not possible, but there might be stores that do not require it... Maybe. . No, I haven't heard of a single instance where anyone set this to false.  I'll remove it from the guide and send a PR deprecating it. . I've asked a number of times (at SolidusConf, in the Slack channel...). I've tried finding out where it comes from, and found this commit: https://github.com/spree/spree/commit/d3ee56193d6fc4e40b9d84f6cbd154b958d96477 - there's no explanation as to why it got introduced. . So apparently there is edge cases in the US where for some orders, depending on where the stock location is, and depending on where the customer is located, the billing address is used. See this blog post (I did not understand when it actually happens). \nHowever, this configuration option is global. I'm still for killing it; in case you need that behaviour globally, it's easy to override Spree::Order#tax_address. . Added it back in. . It's Rails.root.join('app', 'views', 'spree') - in a spec context the views/spree directory of the dummy app, which should be empty always. I feel pretty comfortable rm-rfing :). This spec surely wants to have a pending call to make sure this commit doesn't break the suite, no?. Can we have pending calls for both failing specs in this commit?. Here, you might want to use an internationalized separator, as not all locales will work with a comma separated list. Most will though, so I won't insist. :). If we keep this interface and move the new stuff into the default order adjuster? As per @jhawthorns comment on a later commit?. TaxationData? . 1. I would like the label to be part of this. Avalara can add labels to whatever they return, and so should we.\n2. I would like the matching not to be done by ID. When recording taxation API interactions with e.g. Avalara, it always hits us that matching is done by what is essentially a database artifact. Can we just try relying on sorting by ID and adding taxes - or no taxes - based on that? \n3. I would like our tax rate to be a hidden implementation detail. If using an external service, e.g. Avalara, we don't have tax rates to play with. \nattr_accessor :i_of_sorted_items, :label, :amount, :included_in_price. The current implementation allows for order-level tax adjustments. For all sane configurations I know we shouldn't allow that, just noting that this is conspicuously absent here. . This line reveals that Spree::Tax::Output::Order#line_items should be named line_item_taxes. . Similarly here, with shipment_taxes. \nBy the way: We had a discussion earlier about the fact that for orders that are beyond the delivery step, it's actually preferable to have the shipment's manifest be taxed for contents rather than the line items. The shipments know where they will be shipped from, making correct taxation for multiple stock locations possible. . This should have the label thing as well. We want to abstract from the Spree::TaxRate, so rate should not be in here. . Adjuster, Performer, Applier, Applicator, OrderTaxer. Just throwing in ideas here, I second Johns thought.. Ah! This is why Spree::TaxRate still plays a role. \nAdjustments need a source so they can be individually re-calculated. However, with any order-level, API-based taxation solution, this will never happen. \nWe might need to think about something like a Spree::Tax model, similar to adjustments but NOT adjustments. . What happens if both of these return nil?. Tax exempt items can just have an adjustment_amount of 0. We can calculate shipping rates without passing database IDs to external services, so why can we not do the same with taxation? :). I might make it a thing for the Hack days to replace tax adjustments with a new thing. Do you mind adding a comment that the source is just there to satisfy the requirement of a source on adjustments, and not actually (in terms of business logic) required?. Can we leave the rates out of the signature of this method, and rather attach them to the TaxedItem object? Because external services do not have actual rates. . You can use \ndeprecate simple_current_order: :current_order, deprecator: Spree::Deprecation \nWhich does the same thing more concisely. . This tests the association of the order to the current user. If I understand correctly, the change this introduces does not have anything to do with the user, so we can harden the spec by only specifying that posting changes the Spree::Order.count.\n. I think we can save a DB lookup here by using the in-memory refunds: \nrefunds.map(&:amount).sum == amount \n. @product.price will return something different than display_price(@product) in many circumstances (customer uses a different currency than the admins, for example). This would need to recreate the behavious of display_price. . Would preferred_currency.upcase == order.currency.upcase be clearer than this?. Can you try order_promotions.destroy_all instead? Even if this line only destroys the join table, we want to be clear that we're targetting the join table, not the promotions table.. You can use @product.price_for(current_pricing_options).to_d here. . product.price_for(current_pricing_options).to_d. Yeah, super!. Maybe DistributedAmounts?. Really like the use of admin hints here. :+1: . You can do this in two lines: \nruby\nalias_method :solidus_icon, :icon\ndeprecate icon: :solidus_icon, deprecator: Spree::Deprecation\n. Would this line not always just return Spree::Config.currency? IE: We could probably just save all the initialization and just use the default currency here and call it a day.... @Empact good point. @juliancheal would you mind disabling that cop in a separate commit and not reordering the Gemfile? \nOtherwise, I am fine with this as it does not change functionality and limits itself to style fixes. . We're now way over 100% with these width values.. Just make it nil and add a Spree::Deprecation.warn if it is present.. I like @payment_method_types. Or even @available_payment_method_types. I agree with @kennyadsl s sentiment that payment_methods sounds like instances, but the collection is an array of class names. . If you move the comment up to new line 70, we shouldn't really need this line, should we?. This is excellent class documentation. Wow. \nThere's a typo in here though: \"ment\" should read \"meant\".. Typo: \"resuable\" -> \"reusable\". This does not work, as the object being validated might have been changed in-memory and the DB query won't catch those changes. . This method exists because of shipping providers packing things for different order into same cartons. . We've overriden update!. :). Using show_flash resulted in quite a lot of testing trouble for some reason: Locked Sqlite databases, hung phantomjs, weird things. Can we move that to a separate PR?. Changed. Please load your files directly file. I think there's a file too much.. Yeah, it will. And also, yes the assignment is unnecessary. I'm not sure we need to ship this entire method any longer, either, as it we don't do taxation on orders since Spree 2.2.. Amended!. We can reduce them. I chose to keep applicable_rates, because that's what's being used in calculators, and remove rates_for_order. Thank you!. I did not realize the module is only  called via rates_for_item by now, good catch! However, I did not change the name of the method. While it's not grammatically perfect, it conveys what the method does, and this way I don't have to change the calling code. \nI kept the ivar caching, but removed the two superfluous methods.. Subtracts (typo). Hey! Good to hear from you :) \nThis spec tests something hard to test with a factory if I remember correctly. Let's not do this in this PR. . Do we want to call these legacy just yet? :). s/Spree/Solidus ?. Yes, new is faster. FactoryGirl.build is marginally slower, as it will persist associated objects. For now though I think it's fine, let's deal with this in a subsequent PR. The answer to the conundrum would probably FactoryGirl.build_stubbed.. I don't think this distinction makes sense. cost and order_id are just as important as stock_location_id.. This is the estimated shipping costs, not the order cost.. The ID of the order the shipment belongs to.. The shipment has left the warehouse. \nIf it has arrived at the buyer, it will still be shipped, but not \"on its way\" anymore.. Nah. Shipping calculators are more closely associated with shipping methods. The shipping rates are what the calculators compute.. Shipping categories can also be used to force items to ship separately. This is arguably their most important use case.. I think into a single entity is redundant.. This used to be Spree behaviour. An address can be in multiple zones, for example \"USA\" and \"North America\". Zones can overlap.. I would take away taxation from here, as it's not really relevant to this guide.. Maybe move this up to the bullet point above.. They represent the cost, and are calculated by the shipping method's calculator. Shipping rates don't change, they get deleted and re-created.. Only one shipping rate can be selected for each shipment.. Shipping methods can have multiple zones, so the heading here should be plural.. calculatd misses an e.. Why do we need default here? It isn't in the list of categories above.. When is this information collected? During checkout? From the customer?. There's a star missing here.. I think dispatch is not good wording in this context, as we usually refer to that action as 'shipping' the shipment.. Star has to be added back in.. This is most certainly a wrong change.. The adjuster does not exist anymore. . Maybe add a sentence here about how Solidus < 2.4 have a different legacy stock coordinator and associated classes that are more complex.. All of this is cool and very useful.. Yeah, that's in theory possible, but isn't worth mentioning in the shipping guide IMO.. Typo: Our. For some countries, dividing them up into sub-territories makes no sense. For those cases, we can determine that the states_required field on the country is set to false. \nIf we do that, then the subregions for that country are not chosen for addresses. \nThis makes sense for many European countries and any small country.. That's technically not correct. The coordinator only builds shipments for an order, the deletion happens in code that calls the coordinator.\nMaybe instead: \nThe SimpleCoordinator takes an order and builds as many shipments as are necessary to fulfill it.. It doesn't calculate, just checks.. For each shipment that is thus generated, a shipping method is chosen. (this is to clarify that the splitting does not have anything to do with how the shipment is packed or shipped, instead the shipment is actually split in two separately fulfillable entities).. ...into shipments.... ...shipment.... s/package/shipment.\nWhile in the code, the thing is called a package, the end result is a new shipment. Package sounds like we're referring to the boxes inside the shipment, but we're not.. Maybe just remove this section for now. solidus_active_shipping is a beast, and hard to customize or understand.... The calculator takes a Spree::Stock::Package object, not an Array of line items. That object has access to the package.order and through that to all other stuff in the order. \nHowever, when dealing with the contents of the package (that really is a shipment), as a developer you must deal with the package.contents array. If your store does split shipments, you will otherwise quote the entire order when you only want to quote the contents of one shipment of many.. This is old code that would not work in current solidus versions. The available? method now takes a Spree::Stock::Package. . For completed orders, the shipments tab is the default interface. It might feel confusing to users if they think they have to navigate.. I hope this line is not necessary. This amounts to a line item reload, which would result in an out-of-sync object graph - something we've been working pretty hard to avoid.\nBesides, I second @cbrunsdon in that this but sounds pretty important and deserves a spec. \nGood find!. C is very short, and maybe someone else creates an example class C, with different behaviour. In order to avoid conflicts and possibly test order issues because of the conflict, you might want to consider naming the class ClassWithPreferences or the like.. Uh-oh, there's also A, B, and D. Not concern of this PR, but \ud83d\udde1 . It seems to me this is a wrong change.  Given a class with preferable :color, type: :string, previously this would render the form with attribute preferred_color, whereas now it seems like it renders preferred_string, no? . Previously, I misread code in a future commit because this method name includes types, prompting me to thing the result of this method is an array of type strings. Let's consider renaming it to admin_editable_preferences, so it communicates more clearly it returns an array of preferences?. No, we're just not rendering a type here. . type should be name here. . key should be name here. . type should be name here. . On a Ruby level, this is quite incorrect. The Spree::TaxRate model is a class, not a module, and the Spree::Calculator is an entire group of classes that has to do with tax rates, but also with other things. A developer reading this sentence assuming the person who wrote knows Ruby well will likely be very confused. \nWhat about this: \nEvery `Spree::TaxRate` you create will be connected to a `Spree::Calculator` \ninstance that calculates the correct tax amount for a given shipment or line item.. that checkbox I believe refers to Rebuild VAT prices, correct? Maybe spell it out, we're two sentences away from the last checkbox, and I think included_in_price can also be displayed as a checkbox. . Nope, there isn't any such thing. :). The Tax Country for Empty Carts is the same as cart_tax_country_iso, and here it sounds like they are two different things. I suggest merging this with the previous section? . Maybe reiterate that VAT and pricing are intricately connected, which is why you're making this point here. . That would then be Other items as a product can only have one tax category, and All items sounds like clothing is both Clothing and All items. . any customer who. This could use a sentence that sums up the article. The reader is left with a table :). Do you think that is a good first sentence to start an Overview?. Taxes may or may not be included in a product's price.. Nope. That's what the adjustments are for. \nThe Tax Category and Tax Rate model specify the rules by which tax adjustments for order are created.. ...on items. Using plural here I think makes it more clear that it's a rule/configuration, not a particular entity.. This is misleading. The rate, as we saw above, is a configuration thing. \nWhen you make a new tax calculator, you don't create a tax rate. You just create a tax rate with more complex (hopefully) amount calculation.. Minnesota is not a good name for a tax rate. It's a good name for a state. Minnesota Sales Tax is a good name for a tax rate. . I have not come across a scenario where the billing address is actually used for taxation. I believe we can actually get rid of the config option. Let's not spend too much time documenting it. \nOne thing worth mentioning is that the order.tax_address can - through duck typing - be either an address or a Spree::TaxLocation, which is computed from the store's default cart tax country ISO. You can only trust the tax address has a country, all other fields might be empty or raise errors.. I think this misses a link explaining consumption tax. . I think the class name does not help that much here. Maybe order's line items is good enough?. -e. s/sales tax-style taxation/`additional_tax_total`/. Solidus uses the included_tax_total column to store the sum of VAT-style taxes, and the additional_tax_total column to store the sum of sales tax-style taxes.. It's not \"typically\" included, it's just always included.. Pretty much all jurisdictions do that. . This sentence sounds like you shudder lightly at the implementation. :). Is that a tab? Should it be a table instead?. Uh-oh, the indentation is off here. Otherwise I really like the receipts as visualizers of what's happening.. This does not pass the :mini parameter to the image. Maybe it should.. This is also missing the :mini option.. In almost every request, we load an order with line items, shipments, inventory units, and so on. When reloading anything other than the order, we have two copies of the same database entry in memory - that means the object graph, the network on in-memory-objects is not in sync. . Or actually pass the carton - it holds a reference to the order(s). . These are sufficient, but should be more explicit. Either render_template('spree/api/payments/source_views/_gateway.html.erb), or test directly for the right thing being rendered as JSON.. s/saleable/sellable. ",
    "gvaughn": "This is great. The address book functionality @richardnuno and I are working on is encapsulated into another module to include in UserMethods and won't be hard to merge into this when the time comes.\n. Note: Also need to drop db columns spree_addresses.user_id, user.ship_address_id\nWe cannot delete user.bill_address_id in order to avoid a major revision by changing public API\n. @jhawthorn Good question. I don't know all those implications off the top of my head, but I can look it up. I too found it disconcerting that we had to add that .readonly(false) to the query (Thanks the @jordan-brough for quickly realizing that was the answer to the errors I saw). Upon a quick grep through the source though, we already do that is shipments_controller and promotion_handler/cart. I think adding that to the query is a broader concern than the actual ActiveRecord::Base#readonly? method.\n. @jordan-brough That's interesting. I'll experiment more with removing the readonly from the UserAddress scope.\n. New commit added to remove readonly from the query in UserAddress, plus addressing the extra creation of Address rows that Jordan noticed.\n. Assuming this is good as is, what's the next step? Should I squash and rebase? I don' t have merge rights, so I assume someone else will need to do that final step, but I'm happy to make that as easy as possible.\n. @jordan-brough I have a new commit encompassing your latest point about security. I may have bikeshed a few things nearby because it opened up a refactoring possibility to me.\n. Thanks for picking things up, Jordan. I suspected Address.factory would be useful elsewhere, but hadn't found them yet. I'm going to look at the failing test now.\n. I'm by no means a FactoryGirl expert, so I'd be happy to see ways to improve those factory changes.\n. Nice! I like the direction this is going\n. I've fixed up the small scale suggestions on the PR and fixed the test failures. I've provided more background context in the description, which I should have done initially. The 303 approach suggested needs more community agreement before doing it.\nCan I have a re-review?\n. @grzlus For the extraction you're suggesting -- something like?:\nruby\ndef render_address_book\n  @user_addresses = current_api_user.user_addresses\n  render :mine, status: :ok\nend\n. I don't mind changing the name of the action from mine but there is precedent in the routes file. Making a separate model would really just be a proxy for a user, which we currently reference by the auth token in the header.\n. @grzlus OK. I have a new commit with that now. Yes, I'm well familiar with the advantages. In this case I was on the fence because this was a 2 minute job.\n. New commit added with more traditional routing\n//cc @jhawthorn @magnusvk \n. New commit added. I'll get it merged on Monday.\n. Can we put this on hold for a couple of hours? I need to figure out what's up with the failing ci tests plus I have something to try that should simplify some of this code.\n. @jhawthorn Once you drew my attention to that merge_one method I realized it was no longer needed because of the reset at the end of save_in_address_book. I had been trying to avoid doing that unconditionally and merge_one was one of those pieces.\nAlso, do you have any suggestions on that CI failure? It looks like something up with CircleCI itself? Doesn't happen for me locally.\n. I can't explain why CI had a different version of rspec-activemodel-mocks than I had locally, but here's a new commit that specifies the new version that includes the patch we were watching for.\n. This looks good! :+1:\nSorry for my delay in responding. I need to tweak some gmail filters because this didn't show up in my email.\n. OK. I'll add a test.\nWe had an order in which one shipment was already in a shipped state. Now we can't progress the rest of the items to a shipped state. This allows that one shipment to just be a no-op and not raise and abort the whole order.\n. New commit added which refactors the name of the ready event to ready_to_ship to help avoid confusion with the ready state. I added an issue to further discuss this portion of the state transitions.\nMore discussions have happened on the https://github.com/solidusio/solidus_signifyd/pull/9 PR that really is more general about the state machine and more logically belong here.\n. @jordan-brough Yes, great point. On a quick grep and scan (ready has a lot of false positives) the main place seems to be ShipmentsController which also has that check for can_ready? instead of letting the state machine centralize what's allowed when.\nI'll run the whole test suite to find any other deprecated calls and add to this PR.\n. Idealistically I'd still love to see this sort of no-op behavior defined within the state machine, but this gem doesn't seem to have a way to specify no-op for certain events in certain states. Even though we could protect within the after_ship method, other stores may also have hooks added to the state machine. Closing this in favor of a more tactical workaround in the solidus-signifyd project.\n. Thanks. I'm trying to learn my way around these codebases one PR at a time.\n@athal7 That addresses my concern nicely.\n. @jhawthorn Yeah, I wasn't sure about the parameters parameter. I noticed that order_params and normalize_params performs some logic, so maybe it's just premature optimization to avoid running those multiple times. I'm open to changing this if you believe it would make the code clearer to read.\n. Thanks @magnusvk I wasn't aware of that convention. The comment is added now.\n. @jhawthorn Updated per your request\n. @BenMorganIO I added the #present? call\n@magnusvk Would you have time this morning to merge this?\n. Right. So you think this line should be removed from the changelog?\nSure, I'll give a shout out to admin searches\n. I knew that, but I don't know why I used it here. I'll straighten it up.\n. It demonstrates the hurry I was in trying to put this PR together. ;-) I'll remove\n. Aha! I hadn't run across that yet. Thanks for pointing it out.\n. At one point I had the idea that updated-via-copy addresses could share a created_at, but on second thought it should be in here. Your eagle eyes are appreciated.\n. Good catch. That was a very tactical fix for some broken test that I've forgotten. I also ran across the validate: true option to belongs_to today which should also handle the situation. Is there a preference?\n. That makes good sense. I'll work that up.\n. dup works great when we have an Address instance, but not so much when we have a Hash of attributes.\n. Yep. I overlooked this point. Thanks for pointing it out. Will fix it shortly.\n. Coming up next\n. The user's bill_address should work as it has in the past. We couldn't remove it without a major version release due to backwards compatibility issues. In this case, the list of addresses in the \"address book\" will represent the ship addresses, and the ship_address/default_address is going to represent the most recent one, which is the the current behavior.\n. We went back and forth on this idea and ultimately decided (against my intuition) that pulling in all the addresses on prior orders would be \"weird/creepy.\" I am curious though about how existing stores allow multiple addresses. Is that a customization beyond stock Spree? Is it unreasonable to ask those stores to write a custom migration?\n. Should we remove :country completely from this validates declaration then?\n. I have my vision for the long term, but ultimately it will depend on the support of the core team. I think of the UserAddressBook as a list of addresses for easy pre-fill no matter whether the destination is a bill or ship address. User#bill_address could become as simple as default_credit_card.address. Based upon that, I (personally) see user.bill_address as potentially going away, or else being an opt-in rather than the default.\n. Does this mean validates :country_id is the common ground for these concerns? It ensures a country was supplied, but without validating the contents of the Country instance.\n. The credit card to address association was a precursor to this work and has been recent (https://github.com/solidusio/solidus/commit/aabbdf0726a7b6ac2ca27440d66531c3deda4408#diff-8e792ec275d2700cbf9bd5fd845df367). There's a rake task in that commit to do the back filling.\nRE: UI changes -- This is very much driven by a UI Bonobos wants to add. This PR as is should not require UI changes, but enable them. At the moment User#bill_address is still stored on the User model. What's here shouldn't break existing behavior. If it does, please let me know so I can fix it.\n. I'm not sure what you're getting at. Do you think we should create an Address instance here in order to validate and then return attributes? In one of the uses of this method (via immutable_merge -- line 42 above) the incoming Hash could be a list of only fields that should be changed, not a full set of fields to make up a valid Address itself.\nThis method isn't about validation. It's about taking a Hash which potentially may have extra fields and returning a list that we know is assignable to Address without ultimately causing unknown column errors when saved.\nI suppose our instance method #valid_attributes could be a dup instead of a call to the class method.\n. I like your intuition. There's something here I haven't quite identified that is still awkward. Part of me wants to take over Address#initialize(attributes) but that is not the Rails way.\n. Yes. I missed this during our last minute change to make this method receive address_attributes instead of an Address. I'll fix that.\n. Yeah, I'm starting to rethink passing in attributes instead of Address, but not ready to give it up. I see the situation you're suggesting, however, I'm not sure how that suggestion fixes it. It's not doing any validation step.\n. OK. I see now. This feels awkward and definitely calls for code comments. I nearly created an Address.factory class method at the last step. I'm going to explore that idea more in the morning.\n. new_record? refers to the User object this module is included within. We can't save the UserAddress join models until the User is saved, and some tests added addresses to unsaved Users. This does feel awkward, and I'd love to clean it up.\n. That's great. I like how it simplified things. I guess I had too much tunnel vision that I needed to use with_address_values\n. I'm looking into this, but I wanted to get the PR started and hope someone could shortcut this. permitted_address_attributes is initialized with an :id but from looking at things in a debugger it's gone by this point. I hope it's not being mutated somewhere.\nAlso the added :default field is rather specific to this controller. I don't mind it being here much, but I'm open to reconfiguring it elsewhere. Briefly: this controller somewhat flattens the UserAddress join model so that :default is another field of the address json object over the wire\n. It supports adding or updating individual address entries in the overall address book.\n. It's because the AddressBook itself is the resource. It took me bit to get my head around it.\n. The UserAddress join model has the default scope to guarantee this ordering. I can add a unit test for that too.\n. If I'm deviating too far from \"The Rails Way\" I'm happy to have that discussion. I'm not creating an AddressBook in this action. Also, Addresses are readonly models, so they cannot be updated. This felt like the best compromise to me -- to think of the AddressBook as the resource.\n. Can you explain the advantage of an additional round-trip from browser to server? As is, the code is updating an AddressBook and receiving the updated AddressBook in the response.\n. We understand Law of Demeter quite differently, but nevertheless, I developed this API at the same time as a UI that uses it (which I hope we can generify and share with the community). In every case we wanted to render the updated AddressBook after every modification. I still can't see a 303 status code and extra round-trip as an improvement. I also checked the solidus code and see no use of a 303 or a :see_other status code, so it's not a convention already in place that this code goes against.\n. Thanks. I'll fix that while I figure out the failing tests\n. Thanks. I'll fix that while I figure out the failing tests\n. @jhawthorn Is that a general thumbs up for the PR or just for that one question?\n. \"not true\" is just where my head was when I wrote it. I might be nil though since the db column is not non-nullable.\nBut we actually supply a default value of false in the schema, so it's safe to change.\n. It's still in the db, but I could check for the 'archived' flag in the db. I wouldn't normally do that in a controller test though. The unit tests cover that behavior.\n. As above, I don't normally do that, but I'm not dogmatic about it. If it'll get a thumbsup on the PR, I'll make it so.\n. My biggest concern is encapsulation of knowledge and enforcement of constraints. Since only one address (per user) can be default, an edit to one address may cause changes to another (making one default also changes any prior default address). If we treat it in a more traditional Rails-flavored REST-ish way then the client has to know about that and re-request the entire list. We're spreading business logic out into tiers of the app where it doesn't belong. Can we have a brainstorming session in the morning to find the best compromise?\nThat said, the admin side of things is a good point. However, since this is currently identify users by the auth token, that's the bigger concern.\n. Yes. In #prepare_user_address we seem to have a different instance than the one in this association. So when we update the archived flag it wouldn't match the one inside here.\n. OK. I'll fix that conditional issue. I waffled on it myself and I'm happy to have a 2nd opinion.\n@jordan-brough actually convinced me to accept a hash there when we were pairing on the original implementation of this method. Since Address is readonly and equality is based upon the values of the fields and not an id, the client actually does not have to know any id. Also if they submit with an id, then the additional fields are merged into the values of the Address matching the id, which will result in a new Address being created, with a new id. It was quite counterintuitive in that case if a client passed in an Address instance, but received a different one returned from the method.\nI'm happy to set up a hangout or something if you want to discuss further.\n. @jordan-brough Yes, that was the intent. I was concerned to see that the focus of permissions here, but I don't see any other alternative than to create an explicit AddressBook model with a one-to-one mapping to User. And I understand that's probably a bigger job than desired at this point.\n. @magnusvk Agreed. #immutable_merge should look at country.states_required to potentially leave the state_id out of the new_address\n. ",
    "skycocker": "@magnusvk and others as well: in case you were still interested, I created a fork of solidus that supports devise_token_auth: https://github.com/skycocker/solidus_devise_token_auth. @gbrlcustodio in case you were still interested, I created a fork of solidus that supports devise_token_auth: https://github.com/skycocker/solidus_devise_token_auth. ",
    "forkata": ":+1: \n. @jhawthorn I have a better understanding on where we are headed with this change, so I am :+1: \n. :+1: that would be so handy!\n. I am very excited about this change :+1: Thanks for the awesome work @Sinetheta and @Mandily!\n. :heart: :+1: This has plagued us for a long time. Thank you for taking the time to investigate and clean this mess up.\n. This looks great, always appreciate reading nice tests :100: :+1:\n. I just tested this with solidus_auth_devise and indeed it will install it's devise initializer if this isn't in place.\nI also did a quick test with a gem that depends on solidus_auth_devise like @jhawthorn suggested (solidus_virtual_gift_card) and he is right in that case no initializer will be generated and it throws the devise warnings. I believe this was put in place to just prevent those warnings from the original comment here d3d33ae0da3dedd1ecb94264e7b82026bb9c0db2.\nHaving said that, I do think this should be addressed in solidus_auth not in core, however I don't know how one might go about that. Maybe we need a way for extensions to hook into the dummy app generator :)\n. :+1: I think this will be very useful when mapping rates from shipping providers to shipping methods. Also good call on making these fields optional, often times one shipping method can be used for multiple service types from a given carrier and the logic for picking the service type lives in the calculator.\n. Thanks @jhawthorn didn't get a chance to chime in before this got merged but :+1:  great work!\n. :+1: IMHO the after is more consistent with what we have on other actions throughout the backend. Also the the amount of code this removes is great!\n. Managing stock locations seems like a configuration change to me that wouldn't be done on a day-to-day basis and should probably be limited to \"super\" admins. The stock screens are something that is probably used on a daily basis by someone like an inventory manager. In my mind there are two ways to think about the organisation of things, one would be per area, i.e. stock, products etc., the other would be based on the frequency of use or permissions required to manage things, i.e. configuration vs. day-to-day operations.\n. @mamhoff It appears that the address association on shipment isn't used consistently and this was probably omitted by mistake. I looked through the history of this code and as far back as I could trace it, it seems this would have been an issue https://github.com/solidusio/solidus/commit/b252e9adcd02b5b0f0f89cdcfae583e72ae12fb7.\nRelated to this there is a proposed change to completely remove the address association on shipment here https://github.com/solidusio/solidus/pull/1138 and always use the Order#ship_address instead. If we decide to go down that direction, then this change may no longer be needed.\n. @hectoregm We can definitely use the spec, thank you for adding that. I would keep an eye on what the decision is regarding the address association on Shipment and make any changes based on that if needed.\n. :+1: Have definitely run into this before. Thanks for fixing this!\n. :tada: This is great, surprised at how few changes were required!. @gvaughn We have stores that allow a user to set a different preferred billing and shipping address. Is that going to  be supported by the UserAddressBook, as it seems like this change moves towards a single default address, but I may be missing something?\n. We have stores that allow users to have multiple addresses, I am not sure if it makes sense to provide some option here to bring over all addresses that belong to a user not just their ship/bill.\n. Yeah, it is definitely a frontend customization, so it would not be unreasonable for individual stores to have to implement a custom migration. Maybe other people can chime in and suggest if its worth adding an optional argument to the task to switch between the two behaviors, or if we should leave that to individual stores to handle.\n. Is the long term plan to continue supporting the existing data model of a user having a bill address, or is the plan to move that association to the credit card model and only have a default/shipping address on the user?\n. I believe country should be always required on an address.\n. I think having the billing address associated to a credit card makes some sense, however I can also think of some challenges in implementing that. It also has the drawback of having to pick a billing address for each credit card. Looking at the data from one existing store the majority of credit cards don't have an address_id on them (not sure when that association is created) so back-filling that can only be done if the card was used on an order. There may be some UI changes that stores will need to make to allow for selecting the billing address when adding a new credit card to a user. These are just some of the things that come to mind.\nI don't have strong opinions about either option, but I think now is a good time to decide on how we want this to work in the long term and think about what will be involved in migrating from the current approach. Alternatively if decide we don't want to move the billing address to the credit card, I think there should be a way to specify the default billing address on a UserAddress.\n. Thanks for pointing out that migration to do the back-filling, I wasn't aware of the work already done around that. I think based on the direction of all the work around this it's pretty clear what the long term plan is, so that addresses my main question :)\n. It would be nice if we can wrap all these expectations in an aggregate_failures block so we can see multiple failures in a single run.\nhttp://www.rubydoc.info/github/rspec/rspec-expectations/RSpec%2FMatchers%3Aaggregate_failures\n. ",
    "mtomov": "The image refactoring is brilliant. I've been struggling with those magic small_image, etc methods for a long while now, and your solution with the ors is brilliant. The best part of it is that the missing_image if no image is present is then sourced from Paperclip, exactly where this logic belongs, and not in a helper method with some convoluted ifs.\nI think the magic image defining methods should be deprecated, but maybe a lot of stores depend on it.\nI wanted to even propose for discussion to get rid of all rails helpers and replace them with presenters. Presenters in Rails explained. I've been using those for a few years now in my projects, and have found them to be way to go about view related logic. Otherwise, it's a mess of global methods (\"helpers\"..)\n. btw, why was this change necessary? Just curious about the reason.\n. \ud83d\udc4d I saw an OrderMutex class, which must be it.\nOn Wed, Feb 17, 2016 at 2:29 PM, Magnus von Koeller \nnotifications@github.com wrote:\n\nSolidus has a different order locking system; this duplicated that, and in\nan incomplete way IIRC.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/pull/206#issuecomment-185229055.\n. :+1:  It would be especially good if the emails fit well on on a mobile device screen. \n\n@BenMorganIO had a huge contribution on getting the emails to work with Foundation Ink, so it should be rather easy to add a bit of style.\n. To help a bit with the CurrencyUpdater mystery. At woolandthegang, we were dealing with 3 currencies. There was a Spree extension for switching currency, which was effectively changing the session[:currency] variable.\nThe session[:currency] variable is returned from the #current_currency method and used below through the  #current_order_params to search for a previous order by token.\nSo, no change of order currency is happening at the initial current_order lookup. Now, the other place I was thinking where this one can be called from is the #merge! method on Order. However, you will see that this is only merging line items with the same currency. \nSo, to my experience, there is no code or interface in Spree  to actually change the currency of an order.\nFurthermore that concern is so fundamentally broken:\n- business logic class is persisting data (no single responsibility .. )\n- after_update with an if condition on Order.rb is missing tests\n- the after_update \"catch all\" is clearly hard to reason about. This class should be explicitly called from where the actual currency change is happening.\nSo, either delete it, or change it to only assign changes to the Order without persistence. I'm favouring deletion.\n. I don't see why not. Maybe @jhawthorn is a bit out of time.\n. I would be very curious to see an implementation of this. Aren't there even gems for that, that put the foundation for such cache repository in place? It can't be that everyone is doing it the rails \"touch\" way.\nAnother downside\n3) Locks & lock violations causing .. well lots of trouble\n. I recently came across Aspect Oriented Programming.\nThe idea is not to get those clean and concise single responsibility classes PaymentCreate and OrderUpdateAttributes and seize the opportunity  to \"clearly\" add a few more lines before and after each method, but to wrap vertical programming requirements like auditing / logging into an own entity.\nOne ruby library that does implement the aspect oriented programming is Aspector\n. Well, a Zone can be country based, like North America zone can include Canada and USA, but it can also be state based. A state based would be for example a zone called USA, which consists of the states that you ship to. Then, one can define different shipping methods based on the different zones.\nBut, maybe that is something you already know and you were asking something more intricate.\n. Definitely a good add, especially for stores with personalisations (options), that code in the api/line_items_controller was simply broken.\nA way to remove the duplicate code in the tests is to use rspec's shared example group\n. Yes, agree with both of you. Separate commits for the fix and the refactor would've indeed been preferable if I had written the code.\nIf you prefer, you can also squash the 2 commits, as the first on obviously does not have all tests passing. Haven't done Yard docs before, so I would just observe you.\nThanks a lot for being active & improving the framework.\n. Wow, great explanations. Thanks a lot! \nLet me know if I need to do anything else.\n. :+1: for the change\n. Looking great!\n. Hello,\nI think using rules for images is overly complicated. Not only from code perspective, but also from UI and administration point of view.\nWhat you are effectively trying to do is to assign a single image to multiple, but not all variants. I think this can be accomplished by changing the existing one-to-many relationship between variants and images to a many-to-many one.\nFrom a data perspective, that would require one more table in the classical implementation of many-to-many. In the case of Postgres, it can be elegantly solved using an array column image_ids on the variant table.\nThe trickier part of this approach is to create a nice, maybe drag & drop UI, which would allow users to just pick from the pool of pictures available on all variants, and assign them to any variant.\n. Thank you for your effort on that though. It is indeed significant!\n. Thank you @Sinetheta , it is very hard to pull those large changes off, really great!\n. funny how a custom validation is removed and all tests still pass.\n. :+1: \n. Thank you very much for pursuing those performance improvements. They are indeed much needed!\n. I also love the performance test. The most difficult part of those is to start, but if there's a place to copy paste it from, that would indeed be great.\nMaybe in a new folder under specs, and add an Rspec tag of performance, and don't run it by default ? Or maybe they were called \"stress / smoke\", or something of the kind.. Have to lookup how other libraries are doing it. I think Rails must have those.\n. I vote for Foundation for the backend. Having struggled a lot with Bootstrap over the years, and seeing the latest version v6 of Foundation, those guys have really made working with the framework an ease rather than an override struggle. Much lighter, customizable, better code organized and lots of nice JS components that are missing from bootstrap. \n. indeed great :+1: \n. :+1: for a separate table due to the SQL reasons you outlined (double counted of orders & sql locking), while it being roughly the same effort.\n. Hello,\nWant to highlight that those queries are indeed a problem during Order#populate, and one such takes 140ms to run in our case. \nOn Solidus 1.2, during a populate - 6 of them run. I will check now how many they are on more recent versions.. Also, the whole merge operation has now been moved to a separate class.\nAnd, one other thing that has always annoyed me is that this method #set_current_order is not only incorrectly named, but it is also being called on eevery request, while it's use should only be on after login. I think this is the only occasion when the an order merge would actually be needed.\nNot sure if you'd be up for looking at that.\n. I could certainly change it to whichever one you prefer. The coffee script\nversion came when I downloaded the latest Released, thereby. Other versions\nare here https://github.com/stripe/jquery.payment/tree/master/lib.\nOn Wed, Dec 23, 2015 at 8:00 PM, Thomas von Deyen notifications@github.com\nwrote:\n\nI also don't like to have vendored assets as Coffescript file. I would add\nthe unminified JS version. AFAIK sprockets does not skip already minified\nfiles and it is great to have the readable version for debugging.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/pull/608#issuecomment-166980556.\n. Should be good now.\n. :+1: \n. I think that was the idea of this commit - that someone makes out something more elegant out of it. Thank you @jhawthorn . Great stuff.\n. Hi @blacktea3937 ,\n\nHave you gone any further with your ideas to realize a maintained Marketplace extension for Solidus? We have interest in doing so, and if you want, we can combine some effort : )\n. Thank you for that!\n. Thank you, looks great!\n. Updated to have the tests passing. Let me know if you'd find this useful.\n. Right, makes sense.\n. All right, I've updated the code, though I'm not sure that this is adding any value.\nI'd rather wanted to point out that this is a catch when upgrading from Spree 3.0 or so, so maybe just updating the Wiki with instructions to add apply_automatically: true to any promotion tests without a code would the better way to go about it.\n. I'd be closing this as it's not adding value.\n. The test was passing, because the behaviour is correct, and the test is the same as the main one at the top\nThis is meant to test an additional behaviour in addition to the basic taxon matching.\n. I would've only converted the code to CoffeeScript for better legibility. \nOtherwise I guess you're not heavily utilizing Backbone.model, but I'm not knowledgeable enough to point out exactly what should be there, and what in its View counterpart.  \nLooks good!\n. Hah, ok. I think I support this side though. \nJS is indeed making progress with ECMA 2015, ES6; Typescript is also a great addition that enables large JS codebases to exist, but what you've decided is not bringing us to any of those.\nIf you want to follow the \"future JS\" direction, you'd need to put enablers in place - transpilers or requirement for modern browsers on admin. What you've chosen is putting off developers who don't want to be stuck with old JS just because... \nHave a look at Foundation 6.2 - they've converted all their js into ECMA2015 and backport with transpilers (which CoffeeScript is in fact).\n. :+1:  All right. Makes sense. Thanks!\n. Thanks for your work on this. The new solidusio-contrib/solidus_price_modifier has really nice explanations of its functionality, but I'm a bit into the unknown as to how to use the newly provided functionality here. My two questions:\n1) Can you give me a use case when we want to cache the variant's price on anything else, but the currency? Could it maybe be a special user role - wholesale buyer So, being a wholesale buyer would give prices, which are say 20% lower. Is that now possible?\n2) In the solidus_price_modifier extension, you mentioned the example of a gift wrap, or any other option on line item affecting the price of the line item. Given that the old approach is mostly deprecated, is it possible to do it now with those new classes provided? If so, can you give an example.\nI think some concrete examples would help other developers to also understand how to use them. Adding them to the code as comments above the classes would also be favourable in my opinion, but not sure if that is acceptable.\n\nThank you again. I've reviewed the code, and all looks good. My only comment would be to maybe keep those frontend view related methods for the price difference away from the variant model. \n. Thanks for explaining :+1: \n. Have a look at different payment methods and you'll see it's high usefulness. \n\n\n\nIt also contains a link to the Logs (top right corner button), which can be incredibly useful:\n\n\nIt's different levels of detail. I believe it's correctly displayed, and those who don't need it simply don't visit the link.\n. Thanks for reviewing @jhawthorn !\nI'd be happy to also hear any other comments if anyone has.\n. Hi @jhawthorn , I've made this one change in the JS (don't auto-create the div tag).\nIt's good that we don't attach to the submit event, as I have seen payment gateways (Braintree) also attach to it, and it can get a bit messy when one needs to cancel the execution of the other..\nLet me know if there's more I can adjust!\n. Changelog added + CSS classes streamlined. Let me know of anything else. Otherwise I can squash it. Thank you for the feedback!\n. :+1: \n. Probably not part of your PR, but linking those to the edit screen on the variant would help a lot. Thanks!\n. It is! Thanks!\n. Great change indeed :+1:  Thanks a lot!\n. Wow, thanks so much! I think it's really good what you've done both here and in the matching PR in solidus_auth_devise. \nThanks a lot again!\n. Hello, it will be great to have this merged in, ideally in 1.x, but I would understand if that is not ideal. Thank you!\n. Hello, do you think we can merge this one in now?. Ping : ). pong. :+1:  \nDon't know where the bad rep of stubs is coming from, as especially in Rspec - they are verified.\nChange is great indeed! Thanks!\n. :+1: \n. In my view\n- tests should not have to create a store for every order test\n- default store should not be DB looked up on every request (valid for both one-store & multi-store)\nSo, I think a default store should be automatically created and class memorized. I just recently did that for a single-store site to avoid all those db lookups on every request.\nruby\n    def current(domain = nil)\n      @@current_store ||= Spree::Store.default\n    end\nThat has the disadvantage that an app restart will be required if someone changes the default store, but I think the benefits are worth the minor inconvenience. \n. I like the approach! My suggestions would be:\n- keep it to a single show action - it gets messy to have a controller action for every report. Metaprogramming helps indeed, but why not do it properly? I'm not sure that you will even be breaking compatibility, if you just add show, old reports with custom actions should theoretically work, no?\n- have a base Reporter class, which would define the common interface self.description, self.template, new, rows .., and can contain some helpful methods, such as def spree_routes; Spree::Core::Engine.routes.url_helpers; end;\n- rename def locals to something more revealing, like data, or something better\n- table report is great! \n. Yes, either Spree::BaseReporter or maybe even Spree::Reports::Base. Maybe the singular is even better - Spree::Report::Base - your call.\nBy all means, do continue with this one. We can squash it all at the end.\n. Btw, if we are to consider an external dependency, this gem Dossier was recommended to me. \n. Indeed :+1: \n. wow, brilliant, thanks a lot!\n. :+1: \n. And an interesting read on the very topic I came across just now\nCaleb Thompson - Use One Field to Store Names or Addresses\n. @Sinetheta \n- delegate event handlers are the best, since they don't have to be run after jQuery ready (Dom ready event) as they are run on the document node, which exists still before the html of the page has loaded. Turbolinks doesn't touch document, only replaces the body and merges the head. So, no piling up can happen with delegated events at all. They are even the recommended approach by Turbolinks.\n- Spree.Checkout - I wasn't aware of this one, but I couldn't find anything else in the codebase to use it. I think such an object definition is very hard to use even in a normal scenario as one cannot predict when it will be available (before or after another jQuery ready code). So, best way to go about this one is to actually delete it.\n- If it really survives - it does indeed. As I mentioned above, I tested the product page with the thumbs, the checkout pages with the address validator and the credit card validator on the payment page. That's pretty much all the frontend JS. I think the only 2 I haven't looked at are:\n  - coupon code applicator - (tested, works)\n  - cart.js - (tested, works)\nI will see to test those two out as well.\n@jhawthorn \n- ~~I don't think that Spree.ready will fire more than once per page view with or without turbolinks, as Spree.ready fires when one of the 3 events happens - jQuery.ready, page:load, turbolinks:load. Neither of those events can happen on the same page load as any of the other two.~~\nI can  though place some debugging code in the Spree.ready, and confirm that for certain.\n- You're right in that turbolinks:load fires on initial page load, same as jQuery.ready. That did not used to be the behaviour for page:load. So, in the current form, initializers run twice on initial page load when using Turbolinks 5. To fix that I'll add something like if typeof Turbolinks isnt 'undefined' and Turbolinks.supported (taken from here) before setting up the turbolinks:load event. The page:load event should be fine as it is.\n. Updated to only Support Turbolinks 5.0 as I didn't want to add the extra code to support 2.x. Tested, and all Dom ready events fire exactly once per page view, and all works. Let me know if you have any more concerns.\n. Also, just checked on Spree.Checkout, and it has been used by address.js , but the following two commits:\n- https://github.com/solidusio/solidus/commit/e49629ac7d7e3ff431e9ebffe08562598dfb83b3\n- https://github.com/solidusio/solidus/commit/08d56b3f930ca4b9180db95e83f930ea7685d6ea\nget rid of it all, and for good. I can add a commit to actually remove it from checkout.js as well.\n. Right, I see what you mean, and you are right that there will be repetition of this code. Maybe in this case I can switch it to a normal event attachment. \nI will do that, and will remove Spree.Checkout. Thanks for the feedback! Much appreciated!\n. And updated! Thanks for the feedback.\n. Not a problem, thank you as well :+1: \n. To me as well. On the second line change you might as well add a question mark after eligible - select(&:eligible?) - to make it consistent\n. Thank you for those :+1: \nWould they actually make it into the 1.x branch, or only onto the Rails5 one?\n. That's right. I believe it's a big oversight on #actionable?, so I will see to fix this bug in the next PR after this refactor. \n. Hello,\nI have resurrected this PR with improved variable names, and a few more details polished. I still believe it's a good addition.\nI think the review focus should really be on the only test, which I have modified - I believe that it was incorrectly written in first place, and wasn't actually testing what we wanted.\nOther than that, given that the code is not too convoluted, the other tests should server their role to ensure that I haven't broken anything with those changes.. Hey, no problem at all, glad you took the time to look at it as it can be quite confusing what is going on there. Thanks!. The fix is really good, especially coupled with #1967 - just cherry-picked both, and about to deploy them to production. It is indeed great to have this usability improvement. \nThanks for the fix @yeonhoyoon , and taking it up afterwards @peterberkenbosch ! . Ha, I did a similar promotion destroy logic for a client just the other day. And the way it worked tied along the logic Jason was saying.\nWe considered the user_applicable promotions to be the ones with code. So, whenever a promo code is entered, all other code promotions are destroyed. We went even that far that even if you enter the very same promo code again, it would still destroy & reapply, and give back a success message (again, client requested it that way).\nSo, I guess there's definitely a requirement for such a functionality.\n. Another idea then:\nAs of current, Solidus applies single promotion per Promotion Action Type (Order level, Line Item level, Shipping, etc). Then your current PR, as far as I understand, unites all of those, and only allows for a single promotion discount to be applied, regardless of the promotion action type. \nAnd what Jason is saying is that we still want to have those \"groups\" of promotions, out of which a single one would apply, but we don't want those groups to be Promotion Action Type based, right? We want to custom group the promotions per our own choosing, say 1) Free Shipping, 2) Volume Purchasing, 3) Other. So, if we have those 3 groups, a user can get a discount on all 3?\nIf I've got those right, then wouldn't that be the role of the Promotion Category relationship? Apply the best promotion discount per  Promotion Category? So, if all promotions belong to a single category, user could only get a single discount (which is this PR?).\n. I think it's really good!\nI will try to update my comment later with an example of limiting the promotions to one per Promotion Category.\nWouldn't it be better to add the activated promotion as a second parameter to the PromotionsToRemoveFromOrder#initialize, similarly to the AutomaticPromotionDecision class:\ndef initialize(order:, promotion:)\n    @order = order\n    @promotion = promotion\n  end\nas from your example it seems to be a bit of a struggle to take the last_promo?\n. I've actually changed the code around, and also modified the #update method, so if you'd like to have a new look, that would be great.\n. Yeah, hopefully it won't require you to go through leaps and bounds to test\nthis.\nOn Mon, Sep 19, 2016 at 2:07 PM, Jonathan Rochkind <notifications@github.com\n\nwrote:\n@jrochkind commented on this pull request.\nIn backend/spec/features/admin/auth_nav_spec.rb\nhttps://github.com/solidusio/solidus/pull/1450:\n\n\nreloader.reload!\nend\n  +\nafter do\n@load_extra_routes = false\nRails.application.routes_reloader.reload!\nend\n  +\nit \"has a back to store link\" do\nvisit spree.admin_path\nwithin(\"#login-nav\") do\npage.find_link Spree.t(:back_to_store), href: \"/\"\nend\nend\nend\n  +end\n\n\n@mtomov https://github.com/mtomov I'll change to a view spec, that does\nmake sense, backend previously had no view specs at all, which is maybe\nwhat discouraged me from using it before. Hopefully that'll deal with the\ntest failure from unreliable spec too.\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly, view it on GitHub\nhttps://github.com/solidusio/solidus/pull/1450, or mute the thread\nhttps://github.com/notifications/unsubscribe-auth/ABk0JhEsPL4X_NR7YEpz440c1zy5YHHsks5qrokMgaJpZM4J_Uad\n.\n. Looks good!. Amazing effort and excellent commit names & all! Thanks a lot!\n. I also think that this simplification is brilliant, and @gmacdougall said it all very well. Thanks a lot!\n. I would love to see the direct image upload land in core of solidus! It's such a pain to upload images!\n\n@tvdeyen  I know you'd share my suffering, so just pinging you for solidarity : )\n. There's actually that beast here - jQuery.validate that takes care of javascript validations. Not sure if it will play well with the html validations as it's a rather old version. \nAs the address form is the only one to use this plugin, as far as I know, (payment form uses a different plugin), if you consider it appropriate, I can remove jQuery validate altogether and replace the presence validations with html5 ones. Whoever wants then can add a validation plugin of their own (such as the Foundation's one Abide, or I'm sure bootstrap must also have one)\n\nI think even for experienced developers - having a reference to what exactly the correct auto-complete attributes are, without having to search for, is great to have.\n. @tvdeyen I would've been on the same board as you, so not to worry : ), but the way the shared example is implemented is just great! Thanks!\n. @jhawthorn  - reason is that index pages represent a collection of items, aka a folder , which is why it is more semantically correct to use a trailing slash on index pages. An ending trailing slash represents a multitude of resources, while no trailing would represent one.\nOn the google link at the top, it's the first example:\n\nhttp://example.com/foo/ (with trailing slash, conventionally a directory)\n\nBut indeed, Rails's path helpers do not have the canonical rails behaviour embedded, so I agree that it's best to correct the canonical tag as the author proposes.\n. Hello,\nThis one is ready for official review. I've cleaned up the javascript using Backbone, and have placed the supporting bits (css, js, translations) to their relevant places.\nThis is first time I'm using Backbone and I'm quite pleasantly surprised how it put a nice structure overall. The events mapping is very clean, and the view and its model work very well together to provide for live data binding.\nYou might've noticed that I'm using the underscore's templating function _template() instead of the customary Handlebars, and the reason is that I don't like how all handlebar templates are placed in a god forsaken directory separated from their actual location of usage. In terms of performance - since the template is only parsed and evaluated once on the initial page load, and I'm using the simpler template syntax with Underscore, I don't think there is a negative burden on the page.\nIn terms of design - current one is a bit plain. An alternative is to make use of Bootstrap's Cards. So, either multiple images per row, or again a single image per row, but wrapped in a round border.\nThank you!\n. Thanks @Sinetheta and John for the elaborate look. I've indeed corrected all points that you mentioned in 31632505f4e3ced01618717a51d5be4b4401fa0f - switched to Handlebars, etc ..\nFurthermore:\n1. In 8887673 - I added a small piece out of stack overflow for the translation helper in Handlebars, which allows to resolve keys with dots inside. Ex {{t 'admin.images.index.image_process_failed' }} - that wasn't possible before\n2. In 61a62ec - I've given it a try to use Bootstrap's cards with image inside. I think it looks better. From code perspective only thing I don't like is that I had to place className: 'col-sm-6 col-md-4 margin-bottom-one', inside the javascript due to Backbone wrapping the element in a div. \nI've uploaded image at the top of how the page looks with 3 boxes per row. Naturally, I can get rid of the commit if it's too much. Thanks again!\n. Thanks @Mandily and the others for the feedback. It'll be great indeed if we have a standard for those. \nI just didn't fully understand what the final look would be with the checkmark and X buttons - do they go next to the current Edit and Delete buttons, is the select box always there available for change (no need to press Edit as Thomas suggested)?\nThe only drawback of having the selectbox immediately there available is that it might look a bit ugly, as the deep blue on those select boxes puts a great focus on the area, as if though something is off .. \nNaturally, it's actually easier indeed from a programming point to have the select box directly there available .. so it's really up to you on how you're best seeing this.. as either option is sort of the same programming effort if you are concerned on that ..\n. Amanda, the hover suggestion was brilliant, did it, wasn't difficult at all actually, hopefully can also be used by other similar in-table editing functionalities.  \nWith the hover, it's quite incredible how quickly one could change the variant on a whole bunch of images. \n\n9e2eb1a was the actual commit with the change \n\non hover\n\non click\n\n.. finally the user needs to click on the check icon to confirm the change\n. I've actually gone about to re-write the javascript code for inline image update into a generic reusable Editable Table \"plugin\" of sorts, so that tables can be turned into inline editable only with html markup, similarly to the sortable plugin and such.\nIt's all in the last commit, and as an example, to do it on a text field element in cell, one would need to create such markup:\n```\n  \n\n      <%= image.alt %>\n    \n<%= fields_for image do |f| %>\n  <%= f.text_field :alt, class: 'editing-show' %>\n<% end %>\n\n\n```\nNow, to eliminate a bit of duplication here - an improvement could be to check if the cell has an element with editing-hide, and if not - then create it using the value of the input (select) field.  That would reduce the html needed for such table to just an input box with a class of editing-show\nAnother good improvement is to have the Cancel button revert the input box value it its original one. Should be easily doable though this one.\nIn this particular case for the image - I don't think we need to have the alt box be inline-editable, but have changed it for demonstration purposes. Might have to add a test if we are to keep it.\n\n-- \nI think the option types/values admin section could be a good candidate for this kind of UI\nLooking forward to any input if that is in the right direction. Thank you!. Thanks for your comments!\nAnother round of updates in 0ac12bc focusing on simplification - have removed all the custom classes, reducing everything to a single inline-editable that need be applied to the table. Have also removed the double specification in the cell - we are left with a single input/select box in the cell. \nOn suggestion from Thomas - have removed all buttons on initial view. On hover - the Edit and Delete buttons come up. On Edit - the Update and Cancel buttons come up.\nI've dug out nice row context colours from spree's code depending on the button that you hover over. Have attached some screens as you might've only seen the Destroy (red) context colour and not the others. Hopefully that would help with the confusion between the buttons that you mentioned. Indeed would be nice if we have some colour in those buttons by default.\nFinally, have added a real cancel functionality that I mentioned before would be nice to work.\n\nContext colours:\n\n\n\n. Sure, updated to orange in the last commit. I've rebased it onto latest master. Let me know what else I can do to demonstrate the achieved improvement.. Hello,\nAlthough not a brand new PR, in the latest commit after speaking with @Mandily and @tvdeyen, I've:\n\nUpdated the styles to match the new Select2 styles\nAdded recognition of Enter and Esc keys when inline-editing a table row, as well as tests for both events\nHave put back the Edit and Delete buttons to always be visible to keep the interface the same as existing tables\nRe-organized the code to match the new Backbone Views organization\n\nThank you for the feedback!\n\n. Hi @Mandily - happy that you find it usable!\n\n\nRemove the buttons and show them on hover - technically, doing that requires 1 line of css change. As I've noted above, I did have the right hand side buttons showing only on hover, and to me it looked good, but I've switched them back to always show as this was your preference. \n\n\nIdeas / timeline - that's all up to you\n\n\nPlan for applying to other tables - I think someone must figure out what other tables could use a similar functionality, as they aren't that many suitable I think. Then, create an issue to describe the task, which someone might pick and make the code changes.\n\n\nThanks @mamhoff for reviewing! . Come on, one more approve : )\nLet's see if the new members would be more easily wooed  @kennyadsl . Brilliant, thanks a lot @tvdeyen  - all great spots!\nI think I've now addressed them all, and have squashed all my work into a single commit, which should describe it all.. Thanks all for helping out!. Surprising as it might be the #checkout_allowed? method is not called from within the state machine, but only from the Frontend Checkout controller\nIn our case, we have been tying such validation checks directly to the state machine:\n```ruby\n    def ensure_logged_in_user\n      unless user\n        errors.add(:base, I18n.t(:logged_in_user_is_required, scope: \"checkout\")) && (return false)\n      end\n    end\nstate_machine.before_transition to: [:address], do: :ensure_logged_in_user\n\n```\nwhich compared to the above approach has minor differences, but the proposed approach will certainly make it clearer for the inexperienced how to add validations.\n. Cool way of doing this with the OO Blockers! .. with the base class and each blocker in a separate other one ... Hah, indeed so Thomas .. those have been quite a trickery to grep. Thanks a lot!. It is difficult to measure something like that in development because classes are reloaded and assets might be re-compiled on the fly in development. There should be comments in your Rails's environments/development.rb that explain that for cache_classes, eager_load .. etc. \nAlso, did you try the Ajax multiple times ? Might be that one some of the subsequent calls it will have all loaded .. and it will give you a similar sub half-second response.. There's no in-build way currently. One one occasion I had a custom endpoint built:\n```ruby\nclass CouponCodesController < Spree::StoreController\n  before_action :find_order\ndef destroy\n    @handler = Spree::PromotionHandler::Coupon.new(@order).destroy!\n  end\nprivate\ndef find_order\n    @order = current_order\n    render_404 unless @order\n  end\nend\n```\n```ruby\n  # added to Spree::PromotionHandler::Coupon\n  def destroy!(perform_update: true)\n    order.order_promotions.select(&:has_code?).map(&:destroy)\norder.adjustments.promotion.select(&:has_code?).map(&:destroy)\norder.line_item_adjustments.promotion.select(&:has_code?).map(&:destroy)\norder.shipment_adjustments.promotion.select(&:has_code?).map(&:destroy)\n\norder.update! if perform_update\n\nset_success_code :coupon_code_removed\nself\n\nend\n```. Thank you!. Even if you call it \"Price Break\", one would still have to explain how it works, and as you said any name change would not be so non-invasive. So, I'd rather stick with this one, but add one of those little fellows:\n\nI'm thinking that we should actually make the info button sign a little larger.. Indeed great!. I'm sure you will have a hard time finding someone to disagree with you : )\nIn general, on those matter, I'd advise to just pure steel the UX from Shopify : ) ..  it's really pretty good , and you will save yourself lots of time coming up with one of your own.. Maybe in the #populate, one can just do \nruby\nquantity = params[:quantity].present? ? params[:quantity].to_i : 1\nI'd avoid going for anything too involved. I think it is the responsibility of the controller to filter out the bad data.. Tedious one indeed!, super :+1: . Btw, there's a pretty good reason for stores to upgrade to 5.1, as this performance issue has just been addressed there:\n\nhttps://github.com/rails/rails/issues/25970\n\nand I've come to experience it myself - on a product page with 180 variants - it takes > 100ms just the call to product.variants.includes(:option_values)\nSo, thanks indeed for the effort!. Just played with this for a bit, and it's super cool! The up and down keys from the keyboard work just as well, and the immediate feedback that you get with the currency sign change in front is awesome! Very nice piece of UI! Thanks a lot!. I think that so log as it does not flag correct emails as being wrong, it's fine as it is. I don't consider it to be a core responsibility of Solidus to handle such use cases with perfection. They can be implemented at the individual store level. . I am all in favour of this change :+1: \n\nFoundation for example has a much lighter (read 100 times smaller) validation JS, which looks better and all, so I am having to always remove this jquery validation. It's just too much for 2 forms on the frontend.. I could tell you why that happens, though I don't have a solution proposal:\n\n#assign_default_addresses! in Checkout is the one doing the magic, but only when you change the state of the order from cart to address. That actually happens when you click Checkout, irrespective if you are logged in or not.. \nSo, the state move happens already before you are being redirected to log in, so after you log in, and get to the address page, there is no state change to trigger this method to run again.\n```sql\nStarted PATCH \"/cart\" for 127.0.0.1 at 2017-03-31 12:00:42 +0100\nProcessing by Spree::OrdersController#update as HTML\n  Parameters: {\"utf8\"=>\"\u2713\", \"authenticity_token\"=>\"T4PkR/ARxR+9K4yvWQO/oOV1O1qxxWx7/UoriZ2fc6A0+V/Ey23cmyUxszFBE8j2cAq3sZHZ7pNtvmurZ98vBQ==\", \"order\"=>{\"line_items_attributes\"=>{\"0\"=>{\"quantity\"=>\"1\", \"id\"=>\"3\"}}, \"coupon_code\"=>\"\"}, \"checkout\"=>\"\"}\n.............\nSQL (0.2ms)  UPDATE \"spree_orders\" SET \"state\" = ?, \"updated_at\" = ? WHERE \"spree_orders\".\"id\" = ?  [[\"state\", \"address\"], [\"updated_at\", 2017-03-31 11:00:42 UTC], [\"id\", 3]]\nSQL (0.4ms)  INSERT INTO \"spree_state_changes\" (\"name\", \"previous_state\", \"stateful_id\", \"stateful_type\", \"next_state\", \"created_at\", \"updated_at\") VALUES (?, ?, ?, ?, ?, ?, ?)  [[\"name\", \"order\"], [\"previous_state\", \"cart\"], [\"stateful_id\", 3], [\"stateful_type\", \"Spree::Order\"], [\"next_state\", \"address\"], [\"created_at\", 2017-03-31 11:00:42 UTC], [\"updated_at\", 2017-03-31 11:00:42 UTC]]\nCompleted 302 Found in 123ms (ActiveRecord: 59.0ms)\nOrder R758931254 transitioned from cart to address via next\nRedirected to http://localhost:3000/checkout/address\nStarted GET \"/checkout/address\" for 127.0.0.1 at 2017-03-31 12:00:42 +0100\nProcessing by Spree::CheckoutController#edit as HTML\n  Parameters: {\"state\"=>\"address\"}\n....\nRedirected to http://localhost:3000/checkout/registration\nFilter chain halted as :check_registration rendered or redirected\n..\nStarted GET \"/checkout/registration\" for 127.0.0.1 at 2017-03-31 12:00:42 +0100\nProcessing by Spree::CheckoutController#registration as HTML\n``. @kennyadsl that sounds like the right direction, though I am thinking that it will spread the logic too much if we add such a line to auth Devise. However, looking at the second like that you gave, I noticed [after_action :set_current_order, only: :create`](https://github.com/solidusio/solidus_auth_devise/blob/979cff481e45341dde2755a133970532464b4913/lib/controllers/frontend/spree/user_sessions_controller.rb#L14), which I think might be just what is needed here.\nSee its implementation.. Oh, not to worry, Request changes is my favourite button : ) In fact, the larger purpose of this PR was indeed to change the direction we were going with the css container structure and to overall express some general guidelines that I think we should follow : )\nAnd, in terms of effort - I just know that reviewing all this, and trying it out, and writing out the problems is much more time consuming then the few lines of code I have changed, so thank you both!\n@jhawthorn,\n\n\ninput-group-addon - yeap, saw later that you mentioned that it was fixed by #1816\n\n\nthe caret - I think I might be able to fix the multi-line bug by specifying it on the upper class, but I agree with you that more discussion is probably needed. \n\n\nbrand-info - very well spotted; it is indeed inappropriate to change the value of that variable. Better off as a new variable.\n\n\n@tvdeyen,\n\nBesides that I don't think dark background and boxes are a great UI for this forms.\n\nI share your opinion on that. I'm also in doubt about those default Bootstrap cards with headers. Better to leave it all as it is until we have a solid plan. I guess we might cover that at the conference. \n\nI've opened #1822 and #1823 as well suggested. Thanks indeed! \nI think we might as well close this and append the screenshots to #1290 as feedback.. Super, \nactually no logo resize was necessary after the line-height change .. which is good, as I didn't want to mess the frontend somehow.\nI've allowed myself one more try with an automatic image resize in d2d0b89 . Reason is that I think that nowadays all images should be responsive, like in foundation. I'm not sure to what extend that would apply for such a project, but I've browsed through some product images, and everything looks normal, so it's pending your decision on this \"global\" one.\n\n\nbrand-link - well pointed out\n\n\nline-height variable also fixed the login screen, well thought out :+1: \n\n\nThere is nothing much different than before, but posting a screen nevertheless:\n\n. Superseded by #2127 . Cool, thanks for the refactoring! I will be able to learn proper backbone organization. The size bit change is much cleaner indeed as well.\nBtw, should I refactor #1580 to work with the new code, or the direction there is not appropriate?. \n\n\nwe should use turbolinks.\n\nThat's something I really want to look into next. Now that our JS is better organized this should be easy to accomplish.\n\n:+1: \nI have been thinking the same those past couple of days, and even looked briefly at jquery.turbolinks. Super! Could you maybe push this code on a branch on the solidusio repo, as for some reason when I try to create a pull request towards your fork, I can't see it in the list ..\n. That was a good decision. I like it better without the config option.\nThanks for all your work on that!. Super, thanks, updated from my side as well! \nLet me know! Thanks!. That's that done! All easy with small PRs : ) Thanks!. Correct, my bad, thanks for noticing! Should be good now.. Right, 5.1 compatibility is still in preparation I think, see the Rails 5.1 milestone on it:  \nAnd your concrete problem with Canonical Rails is likely to have been addressed by this one: https://github.com/solidusio/solidus/pull/1885, so might give it a try using the github master branch in your Gemfile.. https://github.com/solidusio/solidus/commit/de2065b seems to be the commit to introduce the delete(). I guess if you are up for writing a test for this behaviour, there's nothing to stop you from making that change.\nActually, isn't it possible to directly use the ransackable_scopes to allow this with_deleted https://github.com/activerecord-hackery/ransack#using-scopesclass-methods. Simple is good! Thanks a lot! \nI looked up later what I proposed .. but it won't bring much advantage indeed.. Sure, take your time.\nI'm just not sure if you will be able to capture the existing bug of the \"not-checked\" checkbox after searching with a controller test. Maybe a feature test might do one better.. That's great! Thanks so much! It's those small usability things, which are most annoying. Thanks again!. That's just great! I always end up overriding Store.current to avoid the pesky lookups on every request:\nruby\n  # class memoize it as we only have one store\n  def self.current(domain = nil)\n    @current_store ||= Spree::Store.default\n  end. Indeed! I very much admire your guts to make such a major change in the name of making it all easier for us to work with the platform! I guess a big role in having the courage to do the refactoring play the tests, so thanks all as well for writing tests so good!. Thanks for this one as well!. I was actually under the impression that with_lock would add lock, thereby increasing deadlocks :thinking: \nI'm actually thinking that this process_backorders(count_on_hand - count_on_hand_was) is rather meant to be in a background job of sorts, as nothing should immediately depend on its result and it's logic could potentially get rather heavy. I remember it causing a lot of noise (trouble) in my previous company.. Thanks a lot! . Thanks!\nI haven't used more than 1 store, but if it is a requirement to use the solidus_multi_domain extension to work with more than one store, then I guess the logic should belong in the extension. Then again, I'm not too familiar if core is meant to support multiple stores without the extension.. Woow, that's so elegant! and builds on top of the refactor in #1904 by @spaghetticode setting an excellent example for any such scopes. \nI've actually had to deal with this one just recently to handle searching through thousands of products, and I didn't know about the exists way .. will definitely use it next time around!\nMaybe it's a good time to ping on #1660. There was an excellent discussion there, and in my view we, the benefits of lookups and search working on large stores far outweight the usability negatives of not being able to do partial matching. And by large stores I don't even mean ours (4.5mil variants, 3mil) - I'm sure that even with a few thousand products, each with 8-10 variants .. the lookups become hardly usable. \nSo if you do make a decision for better support of large stores, then we can add PRs similar to #1660 for variant SKU and others as well as conditionally add Postgres or MySQL specific indices.. Hm.. Ain't it a more valid approach to style all select with your custom styles, but maybe add a no-custom-style or so class for those occasions when you want to opt out of it. That should make it easier for developers as they won't have to learn about this new class unless they have a very very special case to \"opt out\". Would certainly help extensions as well.\nEdit: Sorry misread the PR, ignore the above - so there's actually no additional styling that comes with this new class custom-select .. then why do we need it at all is my new question?\n. Thanks!. Thanks!. Pretty impressive! I never thought that anyone would go about to switch all those tests to the recommended type. Thanks a lot! . Well, I'd say that the problem is in the CSS rather than the markup. Button can even be thought to be better semantically, because the action that you are about to perform is not a GET one.\nAlso, I'd doubt that this is the only place, which uses buttons, so applying such a change site-wide using css should a 1 liner. . thanks!. That's cool! Thanks! Didn't know about the :input selector.\nskip_before_action :authenticate_user seem a bit weird there at the top of the controller. I will happily steal this right off the bat into our projects, as I've struggled with this for quite a while now with no good solution on the horizon. Thanks a lot!. That's great! Thank you! \nHappy to see @admin_layout go.. Oh, thank you so much. When I used to work with the API, I always had to start with commenting out this rescue. And when I forget .. thanks a lot!. Thanks!. Cool that!. Thanks a lot!. Say again, what is the advantage of using strings? \nI was thinking that using real objects sort of adds a validation check that there really exists this object, which I thought might be good.. Makes sense, thanks!. Thanks!. super!. I'm also of the opinion that screen estate for content is more important than saving a scroll up to do a button press. The buttons, which sit at the top right, in my view, are actually not as often used, as the actions related to the general peruse of data.. That's all great! And all in for all the 3 next steps \nA current problem I'm always ending up solving with the coupon code not being a separate form is to detect when the enter key has been pressed, and submit just it .. as otherwise an Enter key would submit the payment form.\njavascript\n  $('#coupon_code').keypress (e) ->\n    if(e.which == 13)\n      Spree.onCouponCodeApply()\n      e.preventDefault()\nSeparate controller and action is definitely the way to go!\nAh, and one more - I'm also often needing to make a coupon destroy logic. That would also fit well under the new controller. And yeah .. if anyone is up for writing the code for it - all the better for me : )\nThanks again. > Thinking twice, it's probably better to redirect to the :edit route, as we did in backend products controller.\nthis has been the best redirect ever, as I can relatively easy add admin to the frontend products page url to get to the admin one. Not as easy the opposite way around.\nIn the promotions, I don't think it matters much.. That's just great! Thanks!. Correct that - solidus_auth_devise is usually used for user authentication instead of the alchemy-devise gem.. That is a good decision! Thanks!. I also agree on the events system, and the proposed Event Bus implementation looks good! Thanks for that.\nSuch events should allow for easier integration with Webhook services such as Zapier or cangaroo. Sort of related: with lots of products and variants, updating option values and types can bog down the database, so on one such app I've done:\n```ruby\noption_value.rb\n# Re-implement to handle lots of variants and products\n  def touch_all_variants\n    Spree::OptionValue::TouchAllVariants.perform_later(id)\n  end\nclass Spree::OptionValue::TouchAllVariants < ActiveJob::Base\n    def perform(option_value_id)\n      current_time = Time.current\n  Spree::Variant.joins(:option_values_variants).\n    where(spree_option_values_variants: { option_value_id: option_value_id } ).\n    select(:id, :product_id).find_in_batches(batch_size: 5000) do |batch|\n      variant_ids = batch.map(&:id)\n      product_ids = batch.map(&:product_id).uniq\n\n      Spree::Variant.where(id: variant_ids).update_all(updated_at: current_time)\n      Spree::Product.where(id: product_ids).touch_all\n  end\nend\n\nend\n```\nand\n```ruby\noption_type.rb\n# Re-implement to handle lots of products\n  def touch_all_products\n    return unless changed?\nSpree::Product.joins(:product_option_types).\n  where(spree_product_option_types: { option_type_id: id } ).\n  select(:id).find_in_batches(batch_size: 500) do |batch|\n    product_ids = batch.map(&:id)\n    Spree::Product.where(id: product_ids).touch_all\nend\n\nend\n```\nBut overall, I don't think that this is also too good.\nI think that some sort of non-imperative system (EventBus) is probably better, as it must be the responsibility of the relevant model (Product, Variant, Taxon) to hook itself and listen for updates (on Option Type, Option Variant, etc.. ) and decide on it's own how to go about updating itself  - be it in batches, in background jobs, which columns if you will, and even throw further update events... Good choice!. https://youtu.be/9R4wlyWBP1k\nThere's a cool guy with an opinion on the subject :grinning: \nSample implementation:\n```ruby\nclass ErrorHandler\n  class << self\n    def report(error, context = {}, options = {})\n      Honeybadger.notify(error, options.merge(context: context))\n  severity = options[:severity] || :error\n  message = error.respond_to?(:message) ? error.message : error\n  Rails.logger.send(severity, message)\nend\n\nend\nend\n```\n. Sorry to be picky on lots of good work. \nThis factory is very expensive, and I do not see why persisted data would be needed at all in a controller helper class. Maybe use build_stubbed or Order.new if possible.\n. I think the deprecation warnings here do not mirror the ones in the API controller.\nI guess that goes along Magnus's point that there is a duplication of code, which is error prone.\n. Well, the point of extracting logic into another class is that you are building an interface, on which you can start relying. \nThis test basically says, I do not rely on the OrderUpdateAttributes, so I will double check that everything is as expected there.\nOther tests also double check, all that creates trouble .. slow tests, single error -> multiple test failures, etc. This talk J.B. Rainsberger - Integrated Tests Are A Scam describes the problem well.\nSo, maybe to do an expect(OrderUpdateAttributes).to receive(:new).with(...).and_return(MockOrderUpdater) and then do an expectation for #apply on the MockOrderUpdater.\nI understand that this #update method is very complicated, and maybe in this case it is better to leave it as it is, but wanted to point out the pattern for not so \"do it all\" methods. \n. I am also a bit lost on the purpose of this class. Although the apparent intention is to function as a converter of html parameters to the model fields, 3 such methods are outside of it in a controller helper.\nIf that was not the intention, but instead to do business logic on order & payments, then would you not be effectively taking logic out of the Checkout state machine and placing it here. Is that the intention?\nDo you not think it will be better to separate the business logic from the persistence? Otherwise, you will be continuing on the Spree path of \"every class/method is on its own\" - let's parse and save everything just to be sure.\nThe name OrderUpdateAttributes is far from revealing. What else would one be updating on an order, if it is not the attributes? It handles payments, calls out to shipments .. I would rather suggest to call it CheckoutProgressor. \nBut then again, I think that the full Checkout code logic has to be drawn out in with a UML sort of diagam, so that the message flow will become clear, and from the message flow - the needed classes will naturally take their place. This is doing more of a scatter rather then delegation of single responsibility. \nSandi Metz in her book Practical Object-Oriented Design in Ruby talks about such message flow diagrams and about the higher importance of messages over classes.\n\nEdit: I think the whole problems stems from having a single do it all #update method. This \"flexibility\" that all checkout actions call this method comes at a great price.\nBest thing going forward is to refactor the view and this controller to have custom actions for each step of the checkout.  Same thing for the Api controller - lots of code will become more meaningful if if the #update is split up.\n. ah, all right. Good then : )\n. I see. Good then.\n. I think there is no point in both passing the class as a parameter, and having it available as an app configuration.\nHave a look at how @jordan-brough did it here: https://github.com/mtomov/solidus/pull/1/files\norder.rb#438 line specifically - just call it directly.\n. so, Spree::Config.shipping_rate_sorter_class.new(rates).sort\n. I would use #describe when describing a public method, and then multiple contents inside the #describe if needed.\n.. but that is a preference of the core team\n. I would place those above in let(:) blocks\n.. but that is a preference of the core team\n. There's always the opposite side : )\nOn Mocks and Mockist Testing\nhttps://vimeo.com/80533536\n. : )\n. :+1: \n. unnecessary : ) The tests below would fail anyhow.\nThe BigDecimal one is also superfluous imo\n. I'd rather stick to testing only public interface of a class. The below #adjust should fail of those are not being correctly set. Otherwise, you introduce coupling between the code and the tests : )\n. ujs is brilliant in such cases :+1:  \nI've had success in the past also adding the below\ndata-disable-with=\" &nbsp; <span class='fa fa-icon-spinner fa-lg fa-spin'></span>  &nbsp; \"\n( not sure about the exact class names you can use )\n. If one was to anyhow customize Spree::Config.default_pricing_options, why would they want to call either of the 2 methods with a different argument?\nI think the arguments are redundant and leak knowledge into the whatever will call them. \n. From my experience in integrating this code with Foundation, it was easier to specify the classes as data attributes than to add additional CSS to match this specific use case. I'd always avoid extra CSS if possible.\nUnless others favour your opinion, I'd prefer to leave the data attributes in place.\n. I agree. Took it from the old script, sort of backwards view compatible, but I guess given that the view needs a button now, I can get rid of this. \n. Ah, I went about to change it, but it turns out that <div>s can't be nested inside <p> tags.\nFunny that I had tried to place it inside the <p> on my initial go, had discovered that it doesn't work, but had forgotten about it, and was trying it again ..  so bad ..\n. Yes, but they are present for documentation purposes here. Alternatively, I can remove the defaults in the JS, but I thought they don't add much noise, so why not have them.\n. Yeah, but frontend developers (and even lazy people like me) don't tend to meddle with the middle of some JavaScript file to find out that they can actually customize the classes. \n. I can swap them. I can also give it a go with the changelog entry. It must be the one at the root of the project, right? - just to add a bullet point at the bottom of 1.3?\n. I think there's something wrong with the test, as I think on line 33 you are essentially saying \nruby\nexpect(admin_layout(nil)).to eq nil\nbecause the let is run before the before which is the same as the last test, and that's why it passes.\nIt's just that the over-ambitious  subject {} gets in the way of making the tests much simpler. The tests are also a bit difficult to follow due to this let(:value) which keeps changing. I'd rather do one describe \"#admin_layout\" do followed by 3 tests with simple it, and in each it, do directly  \nruby\nadmin_layout('full-width')\nexpect(admin_layout). to eq('full-width')\n- you will only be gaining simplicity\n. I'd rather avoid having a method, which is both a setter and a getter, as it makes it confusing, and is rather unusual. \nAs far as I have seen in other parts of the code, the getter is a method, while the setting is just plain @admin_layout = 'my-layout'. Alternatively, if that is too 'internals-revealing', you can do attr_reader, attr_writer, or all together - attr_accessor . See the def title example from the code.\n. Aren't there global helpers that can be re-used around the html, like:\n.mtop { margin-top: 2rem }\n.mstop {margin-top: 1rem }\n. Wouldn't table-layout: fixed take care of the column widths?\n. In the meantime, this got deprecated\n. Mentioned it also in the other comment, but an alternative here is to keep the existing code as it is, just add the Deprecated warning to both get sales_total and post sales_total, and add a show method action, which would work without meta-programming.\n. That's all pretty great! Thank you for it!\nJust wanted to ask you on why you didn't go about to change adjustments.eligible to an in-memory call as well? I think the collection has already been loaded by now somewhere in the ItemAdjustments, and here you're calling a sum twice, so it should be a two SQL lookup save. A #promotion? method already exists on Adjustment, only an #eligible? one would need be added, which could be useful. \n. Just wanted to point out this bad boy here:\nhttps://github.com/solidusio/solidus/blob/master/core/app/models/concerns/spree/adjustment_source.rb#L7\nIt sort of relied on the \"automatic\"  after destroy of adjustments. Should we maybe add an order.update!' to all those incomplete orders, for which we have deleted an adjustment?\n. Sure; it was like that indeed :+1: \n. Havingjs:trueover there makes this test very slow, compared to the benefit of testing that an ID is present, I'd think that's a negative gain of having the test. So, I'd rather choose not to have it.\n. I'd also use> img` if possible to avoid the descendant selector for performance reasons.\nhttps://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Writing_efficient_CSS#Avoid_the_descendant_selector.21\n. Indeed rightly pointed. Thanks for the reply! It's also great that you have established a style.\n. I can actually get rid of this one if you prefer, as one can easily just add the line in a decorator.\n. Why don't you try writing a view spec. Those are usually easy to write, very fast, and you can mock the hell out of it. I don't think that you need to test rails routing, and that spree_logout_path and such exist for real. It's a great overdo for such a view functionality. \n. If you only use the place_order partial only at a single place, then it's better to do without it, as it only introduces a level of indirection. Also the spree/checkout/.. path would've been a better place then spree/shared..\n. Maybe just using the id will be enough - accept_term_and_condition sounds pretty unique, and people may decide to remove the edit_order class from the form.\n. Usually using jQuery's closest does a good job at finding the nearest form, which would save you from specifying it with an ephemeral class.\n. Again, I'd prefer this to be in theviews/spree/checkoutfolder instead of shared.\n. Theoretically, evenSpree::User.newshould do fine here\n. typo inordre. Typo inoptions?\n. Right so. I've gone for thatdragClass: 'with-images'. Good observation. Corrected to that\n. Indeed so. Used the native'sel.classList.remove/add. Thanks for looking in those details. Corrected now.\n. did it as per your example - all excellent working. Thanks!\n. I'm not in favour of adding more libs. The code for those random pieces of text is ~20 links. As you see fit.. \n. I think it's too early at this point for anything such. As far as I understand, one only gets progress for large user submitted requests, i.e. files. For regular post requests when the server is just slow .. that's a different story that would likely need server support.\n. Is thiscontainer-fluidreally needed here? If it is needed for every view, is it not possible to maybe move it to the admin layout, so that we don't have to nest all views within it, and add extra indentation. \n. You might want to consider renamingorder_update,state_transitionandon_failureto their verb first equivalents to follow the schematics on the rest of the methods and to indicate that an action is happening. Say toupdate_order,transition_forward!andredirect_on_failure.Spree.user_class.new` can be used. Of course, as you see fit. Just in terms of speed, not persisting data where possible I think is preferable. \nAnd yeah .. making the start with the first view spec is indeed the toughest, so great on doing that! Might encourage others to follow suite as they are easy to write, and quick to run.\nI don't have anything else, maybe the others can have their say.. The problem with this stuff is that you then need documentation for it. That's why something standardized (Bootstrap) should provide for all that boilerplate. For example, it's very elegant in Foundation:\n\nhttp://foundation.zurb.com/sites/docs/media-queries.html#sass\n\n@include breakpoint(medium) {\n    // All CSS in here goes inside the media query\n  }\nIf Bootstrap doesn't provide for such a mixin, then we can probably steel the one from Foundation, although it's unlikely that there isn't one such there.. Yeah, but Bootstrap is already part of Solidus, so all mixins it has should be available.\n\nhttps://v4-alpha.getbootstrap.com/layout/overview/#responsive-breakpoints\n\nTry the above ones, they should work:\n@include media-breakpoint-up(xl) { ... }. The link are pointing to is for the frontend. \nAnd yes, hopefully they should match, otherwise we can't use Bootstrap ..\nSo, this must be the bootstrap configuration for the backend.\nThe skeleton one for the backend seems to have most of the values pretty fixed : ) .. so yeah, hopefully they match ... super : ). another option might be to use ::before / ::after selectors and content: property with the encoded symbol (not entirely sure what the svg is) as a value and position it absolutely, and set the font-family to the one for the icons, and finally give the element a position: relative. typo. The whole method is not very clearly written. It's sort of all in-reverse. I think it should be just:\nruby\nscope :available_to_store, -> (store) { where(store: store) }\nThat should also work if store is nil.\nThe raise ArgumentError is not much improvement over the Undefined method payment_methods on Nil:Class that one would usually get.\n. Absolutely you are both right, I did not see it through, and I am not that familiar with that part of the code. Thanks for the explanation!. The required here should maybe follow the same logic as the required class. !have_states ? 'required' : ''.\nDo we maybe need to remove the required class from those inputs as well? And use maybe the required attribute as a selector in the css if there's need.. I think that the RegEx is too complicated to sit in the views, and we'd need tests for it, as at the moment I have no clue what its expected functionality would be. \nIn addition, any kind of validation in this field would have to consider any sort of telephone number that exists around the world, which I believe is a difficult job. Just recently I was to add an auto-format in this field for the US phone style, which would wrap the first 3 digits I believe it was in parentheses (123) ...\n. Same thing as for the phone field is valid here - the logic is too complicated for the view, and it needs to be tested, so to understand what the expected validations are.\nBut before you go there, consider that there's already sort of an established RegEx in Solidus. See issue #1794  for more info.s. Here, I think we should also rely on the build in input-group-addon, again for the reason of free documentation, but as we want to have those add-ons  styled a tad bit different, we can add a supplementary class, say \ncss\n.input-group-addon.simple {\n  background-color: transparent;\n  border-left: 0;\n}. Maybe I miss something, but I think this is pretty much the role of the .container class. If I've guessed right, it will be great to get to use that. Otherwise, let me know what could be the problem with using it.. I think that this one can also be classified as a form-section or card, just without background and border. So, maybe something like:\ncss\n.card.light {\n  border: 0;\n}\nIf we minimize those \"public api\" classes, it will be easier for other developers to make use of them. . The use of this class closely resembles the .card component from Bootstrap. Do you think it will be an idea to either override the default .card class with our background and border, or maybe add a supplementary class to it, like:\ncss\n.card.form-section {\n  background: very-light($color-3, 4);\n  border: 1px solid very-light($color-3, 32);\n}. This seems to duplicate max-width-form, or the other way around, but either way I think we should change the terminology, and either use the build-in .container or an adjusted derivative of it if we can't - like .container.forms, so to be clearer to others what the purpose of this class is, ie. it's already documented in Bootstrap.. With the new additions by currency widget by @jhawthorn  in #1793, I think that all prices can now occupy a single line.. Thanks for the feedback! I will sort out the rest if we get the #1900 merged in. \nOn this one, we can copy over the few lines from turbolinks, but I really hate to encourage people to use old browsers, and those unsupported browsers are already ice age by now, let alone by the time somebody actually starts using this feature here..\nSo, well pointed out; my preference is to keep this behaviour.. It seems that people have hit this distinct issue previously with product:\n\nhttps://github.com/solidusio/solidus/blob/master/core/app/models/spree/product/scopes.rb#L184-L207 . no problem at all!, thanks both for reviewing!\n\nThe have_title suggestion was great, and I've gone about to actually change all those breadcrumb expectations to have_title, as when I was fixing those tests the other day, it took me a while to understand where \"PromotionsPromotion\" comes from.\nAll changed now.. Hi @tvdeyen , sorry to pester .. just whenever you get to it .. if you could rebase your branch on top of master now that that preparation PR has been merged .. as otherwise I think I won't be able to get the tests to green?\n. No problem, but I think that you might have updated tvdeyen/turbolinks instead of solidusio/turbolinks : ). ruby\nexpect(page).to have_css(\"[itemprop=price][content='19.99']\")\npriceCurrency\n\nhas content attributes. Spree::PaymentMethod::Check - can be referenced using described_class, and the new form of it is usually referenced using subject, so at the top you can do:\n\n```ruby\nsubject { described_class.new }\n...\nexpect(subject.credit).to ....\n. Although written in the console, this is still `ruby code : ). I'd rather replace therespond_toexpectation with one, which checks the actual contents of the returned collection. I think thateqis preferred toeql`.\nGreat that you have a test for the ArgumentError.. Same here! \nAnd congrats on the first tests on the Image model : ). I'm strongly in favour if sticking to server side logic wherever possible. \nI think the only thing here to improve is to eliminate a bit of duplication with the fields_for by placing <%= fields_for tax_category do |f| %> above the <tr>. Better figure out how to set some dummy data to this instance variable @updating_params in the test rather than changing the method. Given that it hasn't been tested so far, any change can break it really.. I'm not sure if it's worth keeping a separate logger for Solidus only, and that be different than the Rails.logger. I'd think that we might want to think about the exact sequence and type of parameters, taking into consideration reporting to external services, such as Honeybadger:\nhttps://docs.honeybadger.io/ruby/getting-started/reporting-errors.html#passing-additional-options-to-honeybadger-notify\nfor example, by leaving out \nruby\nmessage = error.respond_to?(:message) ? error.message : error\nOne can't do \nruby\nErrorHandler.report(\"ma mia\")\nwhich of course might be desirable, not sure..\nAlso, severity sounds like just one possible option, which an error can have. For example Honeybadger supports all of those:\n\nAnd lastly, context in the context of Honeybadger is an object with all sorts of additional information, can be for example \nruby\n{ user_id: 99 }\nWhich usually comes useful to be able to pass as well, either as part of the above options, or maybe as an explicit parameter being so useful, as in the example that I suggested:\n```ruby\nclass ErrorHandler\n  class << self\n    def report(error, context = {}, options = {})\n      Honeybadger.notify(error, options.merge(context: context))\n  severity = options[:severity] || :error\n  message = error.respond_to?(:message) ? error.message : error\n  Rails.logger.send(severity, message)\nend\n\nend\nend\n```\n\nI'm just mentioning those as considerations, feel free to do without them if not deeming necessary at this point.\nAnd maybe the style that you have proposed would actually be sufficient for internal Spree errors, but anything outside of that can be dealt within the application itself. So, in this case, feel free to ignore all of the above.. ",
    "joelind": "I'm seeing this now, with 1.3.0...Any updates?\n. Actually, the view my solidus admin is looking for is in source_forms, not source_views...\n```\nActionView::MissingTemplate in Spree::Admin::Payments#new\nShowing /Users/joelind/.rbenv/versions/2.3.1/lib/ruby/gems/2.3.0/gems/solidus_backend-1.3.0/app/views/spree/admin/payments/_form.html.erb where line #28 raised:\nMissing partial spree/admin/payments/source_forms/storecredit with {:locale=>[:en], :formats=>[:html], :variants=>[], :handlers=>[:erb, :builder, :raw, :ruby, :coffee, :slim, :rabl], :versions=>[:v1]}. Searched in:\n  * \"/Users/joelind/projects/rockets/quark/app/views\"\n  * \"/Users/joelind/.rbenv/versions/2.3.1/lib/ruby/gems/2.3.0/gems/solidus_gateway-1.0.1/lib/views/backend\"\n  * \"/Users/joelind/.rbenv/versions/2.3.1/lib/ruby/gems/2.3.0/gems/solidus_backend-1.3.0/app/views\"\n  * \"/Users/joelind/.rbenv/versions/2.3.1/lib/ruby/gems/2.3.0/gems/solidus_api-1.3.0/app/views\"\n  * \"/Users/joelind/.rbenv/versions/2.3.1/lib/ruby/gems/2.3.0/gems/solidus_core-1.3.0/app/views\"\n  * \"/Users/joelind/.rbenv/versions/2.3.1/lib/ruby/gems/2.3.0/gems/kaminari-0.17.0/app/views\"\n  * \"/Users/joelind/.rbenv/versions/2.3.1/lib/ruby/gems/2.3.0/gems/devise-4.1.1/app/views\"\n```\n. Actually, there _is an API key issue. When you go to edit an existing promotion with a user rule, the box that is supposed to list the users is empty. It appears that the UI is trying to fetch the users by ID, but it gets a 401 (since this API request has no token in it). See attached. I'm working on a PR for this.\n\n. @jasonfb yes. The initSelection option that is passed to select2 does a raw jQuery get, which doesn't seem to be sending the api_key with it. If I change the following, it works. Am I missing something?\nIf I edit user_picker.js, to change \n11     initSelection: function (element, callback) {\n 12       $.get(Spree.routes.users_api, {\n 13         ids: element.val()\n 14       }, function (data) {\n 15         callback(data.users);\n 16       });\n 17     },\nto \n11     initSelection: function (element, callback) {\n 12       $.ajax({\n 13         url: Spree.routes.users_api,\n 14         data: { ids: element.val() },\n 15         headers: { \"X-Spree-Token\": Spree.api_key },\n 16         success: function (data) {\n 17           callback(data.users);\n 18         }\n 19       });\n 20     },\n. ",
    "dangerdogz": "@joelind : The issue you have is a bit different. By default when you seed the store, Store Credit is added as a payment method with a display value of none see the class so it's not supposed to show as an option when you reach Payments#new or if you checkout from the frontend since the store credit are applied automatically (which is also something to improve upon)\nCurrently, it's not \"possible\" to add store credit payments from the admin so the partial is missing because the feature is not implemented. I assume you updated the display value for it to show but it's not working as you reported.\nCurrently doing some preliminary work on this, in the meantime to restore the original behavior I suggest you update the StoreCredit payment method to \"display_on: none\"\n. @joelind : The issue you have is a bit different. By default when you seed the store, Store Credit is added as a payment method with a display value of none see the class so it's not supposed to show as an option when you reach Payments#new or if you checkout from the frontend since the store credit are applied automatically (which is also something to improve upon)\nCurrently, it's not \"possible\" to add store credit payments from the admin so the partial is missing because the feature is not implemented. I assume you updated the display value for it to show but it's not working as you reported.\nCurrently doing some preliminary work on this, in the meantime to restore the original behavior I suggest you update the StoreCredit payment method to \"display_on: none\"\n. In a migration added by Solidus/SpreeGlobalize so outside the core itself\nIt's not a problem for other translated models since no records is created between the Solidus Core migrations and the Solidus Globalize migrations in theory\nIt's only a problem for new stores / bundle exec test_app task \n. This migration from SpreeGlobalize\n. Fixed by #488 \n. I confirm it fixes my issue in Solidus Globalize :+1: \n. Do you think using Traco or making a  \"homebrew\" version of this could be viable? Instead of using Globalize we could store the translations directly in the country table.\nThe gem is robust enough and has no external dependencies except ActiveRecord, the overhead is really small and basic benchmarks are promising\nIt could be tricky in terms of setup, you might not want to store a million translations by default if there's no need for them so we might need to tweak the seeding procedure to allow choosing the locales we want to seed if we go this way (it might trivial to have them anyway, I'm speculating)\nWhat do you think?\n. I'd suggest using another name than confirm and creating a custom step with custom logic. Confirm is already a step at the end of the process and there is a lot of logic tied to it.\nIf you try to move it around you will quite possibly break a lot of code since most of the callbacks related to closing an order are tied to the confirm step and assume it's the last step.\n. Gemfile :\nhttps://gist.github.com/dangerdogz/996e7b887f2e35d40826\nGemfile.lock\nhttps://gist.github.com/dangerdogz/06fa6c40c1e829a19205\nStack trace :\nhttps://gist.github.com/dangerdogz/2fe189a2cd0f7c5daf96\n. Gemfile :\nhttps://gist.github.com/dangerdogz/996e7b887f2e35d40826\nGemfile.lock\nhttps://gist.github.com/dangerdogz/06fa6c40c1e829a19205\nStack trace :\nhttps://gist.github.com/dangerdogz/2fe189a2cd0f7c5daf96\n. Fixed by #1082 \n. Fixed by #1082 \n. Did you edit the paperclip config ? (And you can paste it here)\nThis issue can arise if the default path / default url (the fallback for when there's no images) is not valid or doesn't exist.\n. It's a really specific issue and an unreasonable edge case that I can probably fix by writing better code, so closing this.\n. It's an issue for slugs because historically, there's a 255 maximum length but it's not covered by the validations (only a min, no max) so if it's exceeded you get an Error 500 with ActiveRecord::StatementInvalid. \nI was looking into updating the validations to fix the issue and I noticed the same thing as you : limit is no longer set for newer apps. \nI'd say it's better to have limits than not because without them, you get \"undefined behavior\" depending on your database engine.\n. Should a limit be added to every string column or only to a subset of those fields like names and slugs ? \n. Maybe this is why something like DbMaximumLengthValidator could be useful? Unless there's a better way, I think we would need to check that columns_hash exists and has a value (if so, use it) otherwise use a default value.\nAdding this to every single validates would be tedious to change and error prone, and using columns_hash as is would cause installation nightmares.\n@cbrunsdon Thoughts? (since you want to kill DbMaximumLength)\n. Maybe this is why something like DbMaximumLengthValidator could be useful? Unless there's a better way, I think we would need to check that columns_hash exists and has a value (if so, use it) otherwise use a default value.\nAdding this to every single validates would be tedious to change and error prone, and using columns_hash as is would cause installation nightmares.\n@cbrunsdon Thoughts? (since you want to kill DbMaximumLength)\n. I fixed the various style issues, rebased on master, and addressed the feedback provided by @mamhoff \nAlso added unit testing for the taxation_attributes method added\n. Reworded the comments a bit, did a double check on the tests, should be ready for review again once build is finished\nEDIT : Build crashed without failing tests for some reason, so I forced pushed a typo fix to restart it\n. Related to issue #1254 \n. I can't reproduce the issue from a new store, could you share your Gemfile/Gemfile.lock/database.yml?\nIs it a new project or are you porting a store from Spree ?\n. I can't reproduce the issue from a new store, could you share your Gemfile/Gemfile.lock/database.yml?\nIs it a new project or are you porting a store from Spree ?\n. Sample data contains existing orders.\nHeroku runs in production, so when you loads the orders, it's trying to send the confirmation email because the field confirmation_delivered from spree_orders is set to false.\nSo you would need to either :\n1) Add smtp information to your production.rb\n2) Disable email deliveries before you load the sample data.\nIt's a bit of corner case because sample data is meant to be used in a development environment where emails aren't sent.\n. I just tried the \"Deploy to Heroku\" button, and it's crashing in the same way so it's an issue with the button as well.\n\nErrors 500 will also be generated if you try to checkout or do anything that will queue an email so outside of disabling deliveries outright, I don't think we can around the fact that you need a valid smtp config to run a store in production mode.\nSo, maybe disabling deliveries, and adding a comment in the file + notes of the documentation saying : Email are disabled in production, if you want to send emails you need to enable this and add a smtp config (for a sample store, not all stores)\n. Reposting comment by @tvdeyen :\nThe only way to fix this is to pass in an actual number, right? Good catch and great investigation @dangerdogz\nWe can use a number of the value of which depends on the language so it feels arbitrary to use something like 2.1 because it needs to be bigger than 2, and I haven't looked into all the other calculators so there might be some other constraints. \n. I think this is the better solution but it would imply editing tens or maybe hundreds of files so I was hoping for something else.\nHow would I go about updating this (in terms of PR size) ? \n. @jhawthorn, @mamhoff  What do you guys think ? A big PR to replace everything at the same time, or smaller chunks?\n. Alright, going to make a PR tonight. Thanks for the feedback!\n. Should be fixed by #1191\n. Should be fixed by #1191\n. I think this might be related to the following bug :\nFriendlyID is using the current locale language to validate uniqueness of the slug, so if you're navigating in french, you can edit the english slugs and FriendlyID is gonna compare the proposed value to all the french slugs so you can set duplicate values.\nExample:\nNavigating in english, I have a Ruby on Rails bag with a ruby-on-rails-bag slug\n\nThen I open the Ruby on Rails mug with a ruby-on-rails-mug slug\n\nI replace the english slug (ruby-on-rails-mug) while my store is in english with the ruby-on-rails-bag slug (which already exists) and I try to update, I will get a slug already taken error\n\nIf I retry the same thing while my Solidus is in french, I can set the english slug of ruby-on-rails-mug to ruby-on-rails-bag because FriendlyId is comparing the english value I'm trying to set with the french slugs of the other products (and ruby-on-rails-bag doesn't exist yet in french)\n\nAnd now the english link for the Mug is the same as the one for the bag\n\nTL;DR : You can have duplicate slug by updating a product slug in a different language than the one you're using for browsing because FriendlyID is using your browsing locale to validate uniqueness instead of using the language of the updated slug\n. I opened a related issue #1107 a while ago about the same thing (and I think we reach pretty much the same conclusion).\nI'd be in favor of changing outstanding_balance. Unless I'm missing a use case, the issue that this behavior is addressing is only about presentation. (not showing completed orders with refunds as balance_due in the admin) so this could be solved in a different way (properly updating orders through adjustments or promotions)\nWhat is core opinion on this?\n. Updated, found a cleaner way to do it\n. Solidus (the gem) is made of core/backend/frontend/api. Frontend is not only about views, it includes all the logic surrounding browsing products / cart / checking out / some code surrounding users with solidus_auth_devise (which is the issue at hand here).\n. Solidus (the gem) is made of core/backend/frontend/api. Frontend is not only about views, it includes all the logic surrounding browsing products / cart / checking out / some code surrounding users with solidus_auth_devise (which is the issue at hand here).\n. I ran into something similar yesterday, I think the issue at hand is that taxes are updated by the OrderUpdater and that changing the selected_shipping_rate from the backend does not trigger anything that calls the OrderUpdater because it goes through the API and simply update the attributes, while adding a payment trigger @order.next which calls OrderUpdater through a transition callback\nfrom shipment.rb\nruby\ndef selected_shipping_rate_id=(id)\n   shipping_rates.update_all(selected: false)\n   shipping_rates.update(id, selected: true)\n   save!\nend\n. I ran into something similar yesterday, I think the issue at hand is that taxes are updated by the OrderUpdater and that changing the selected_shipping_rate from the backend does not trigger anything that calls the OrderUpdater because it goes through the API and simply update the attributes, while adding a payment trigger @order.next which calls OrderUpdater through a transition callback\nfrom shipment.rb\nruby\ndef selected_shipping_rate_id=(id)\n   shipping_rates.update_all(selected: false)\n   shipping_rates.update(id, selected: true)\n   save!\nend\n. Will investigate more. I knew I forgot something, going to add some \n. Comments look wrong, so I need to fix that but otherwise : \nI don't think TaxLocation needs to implement taxation_attributes because we're not supposed to compare TaxLocations for the following reasons : if old_address is a TaxLocation it means that that it's either a VAT order and it's handled elsewhere or it's a standard order who hasn't reached the Address state so the taxes will be handled by the checkout\nThe only case where this is suppose to apply is when you have two addresses, so this would means that you're either updating the customer details from the backend, or that a registered user is updating his default addresses so the taxes showing in the cart would be updated.\nDoes it make mores sense? \nGood point about using try! though, we can be extra sure that we're comparing Spree::Addresses because it will crash otherwise\n. Where should it live?\n. Noted, updating it\n. Turns out \"current_host\" is a thing, so yeah definitely simpler this way. Thanks!\n. Meant to do it and forgot, thanks\n. ",
    "MattDunbar": "Solving tax problems is equally good of a solution.\nOn the promotions side, most of the issues actually come down to the lack of coupling with taxes.\n. ",
    "scottcrawford03": "ah meant to reference that commit. thanks @jordan-brough for doing that.\n. @athal7, @magnusvk, @jhawthorn binary_inventory_cache has been added back in.\n. @jhawthorn @athal7 @magnusvk updated to reflect revisions that address your comments.\n. > I'm not sure whitelisted is the right language.\n@jhawthorn agreed on the naming. any alternatives come to mind?\n\nShould it be possible to use this preference to generate an API key for all users, regardless of role?\n\nseems reasonable to me. \n. @jhawthorn changed the name to roles_for_auto_api_key. If you have a better alternative I would love to hear! \nAlso added in generate_api_key_for_all_roles so that it is now possible to generate API keys for all users regardless of role. Spoke with @athal7 and we decided breaking it into a separate config that was a boolean was better than having to set roles_for_auto_api_key to ['all']. Just in case someone decides to create a role called 'all'\n. @jhawthorn @athal7 moved the generate_api_call to the user model\n. @athal7 updated to try! and fixed the placement of the spec to be inside of the roles_for_auto_api_key is defined context\n. @jhawthorn mind taking another look when you get the chance? :ear_of_rice: :rice_cracker: :rice: \n. @jhawthorn and @athal7 made changes to reflect hawthorn's comments in regards to the naming of the auto_generate_spree_api_key as well as changing the implementation to no longer require role to be passed into the method.\n. @athal7 updated it so the authorize call is inside of find_shipment. That way any shipment controller action that uses this method will always have a check on the shipment.\n. @athal7 updated the spec naming.\n. yeah it was overlapping. I'm not sure why it changed, but I wasn't seeing that behavior locally when I clicked around on it.\n. @jhawthorn \nnope it would help actually if it was removed completely in my case as I just don't want powerTip.\nI updated the permissions as well.\n. @jhawthorn line 176 already sets the updated_at to one day ago.\n. yeah that makes more sense. I agree.\n. this was to avoid the deprecation warning being called every time we try to access that return value.\nthoughts on this?\n. I created two users to test that two different roles get the api key when generate_api_key_for_all_roles is set to true\n. yup, will fix.\n. @jhawthorn that (spree_roles.map(&:name) & Spree::Config.roles_for_auto_api_key).any? is so great. Thanks for that. Agreed on the name. Making the changes now.\n. ",
    "braidn": "We could also wrap this expect in a page.document.synchronize block which seems like the new wait_until and the better sleep in capybara2. \nWhat's the best way to get this into the code base to pull against #248 ? Just pull branch off from master, implement the above and create a PR?\nsyncronize docs\n. :+1:\n. IMHO, if we are asking about the need of the hook? In my world which is with both request/response checkouts and SPA like checkouts, then no. I wouldn't see enough use of this hook. Although, I totally could see this use in the community.\nWhat about the old module#prepend around https://github.com/solidusio/solidus/blob/master/core/app/models/spree/order_updater.rb#L158 ?\nA check could exist if the order payment is in the state where you want the credit_card_created to fire or just call super? Still not convinced though a hook like this could be widely used...\n. Yes, pub/sub does nothing to encourage explicit behavior, it's actually an explicit role back in my mind. Here is a Wisper like/extremely lite implementation that has been used for personal projects. \nhttps://gist.github.com/braidn/baacaea0527b722d25cb\n. Awesome for eschewing AMS. The entire roadmap of that gem is full of potholes. . @webmaster219 what if your statics controller were to inherit from the store_controller?\nhttps://github.com/solidusio/solidus/blob/master/frontend/app/controllers/spree/store_controller.rb\nWould you have access to the routes/helpers?. ",
    "radar": "\n. Unsubscribe.\nLeave me out of this.\n\nOn 8 Apr 2016, at 08:35, dt1973 notifications@github.com wrote:\n@mradfaber I see you closed the other issue hence my email reply never made it. Here's the response I wrote 2 days ago:\nThank you for entitling me to my own opinion. No, but seriously, I wasn't being any more disrespectful than @damianlegawiec. I was simply stating what I see as abuse of a project I once loved dearly, the hijacking of Spree's good name and reputation in order to gain consumer confidence in Spark Solutions, making it seem at first glance to potential new customers like it was Spark Solutions that created Spree. Although a brilliant business tactic, I just don't see it as fair to those who actually created Spree.\nMight I also add that I find the accusations that I was attacking @damianlegawiec on a personal level and being xenophobic absolutely ridiculous. Not that it's anybody's business, but I've studied in Poland, had Polish girlfriends and currently have many Polish co-workers. I also don't appreciate you attacking my adulthood and threatening to have me banned from GitHub. I was just trying to help in the first place by offering to replace Spree with Solidus.\nThanks.\ncc: @mamhoff @tvdeyen @radar, @schof, @joneslee85, @BDQ, @cmar, @LBRapid, @paulcc, @davidnorth, @romul, @JDUtil, @huoxito, @danabrit, < a href=\"https://github.com/devilcoders\" class=\"user-mention\">@devilcoders, @peterberkenbosch, @GeekOnCoffee, @stephskardal, @parndt\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly or view it on GitHub\n. I just tried this with the latest master from Bundler:\n\n\nalias dbundle='~/code/gems/bundler/bin/bundle'\nNew directory with this Gemfile\ndbundle install\nSaw that it ran successfully.\n\nSo yes I think you're right that the next version of Bundler will fix this issue :tada:. ",
    "tesserakt": "@jhawthorn so you would be open to slowly changing the codebase to all-immutable through subsequent PRs? Or are you saying it is out altogether?\n. Point taken :) I just found out how much solidus is willing to break with the past. So in solidus, backwards compat >  rearchitecting in cases where they conflict. \n. ",
    "tvdeyen": "Please don't forget to also port https://github.com/spree/spree/pull/6654, because these changes introduced the bug fixed with spree #6654 \nThanks\n. :+1: \n. @jhawthorn Do you plan to disable it only in sandbox mode or for all apps using Solidus as engine? I defiantly vote against the latter. Especially unexperienced devs always get crazy, if things don't change if they hit refresh in the browser. We started to cache the yml based config files in AlchemyCMS for performance reasons and the people where like WAT? I can't even count the numbers of issues I had to close and questions I had to answer. So consider this, before disabling this globally. \nAlso, I think the developer is in charge of configuring their app, not the engine/plugin/gem.\n@alepore Yeah, I read this one. Not hoping for another spring, though :-1: The Rails core team should start to increase overall performance and remove the cause, instead of monkey patching the symptoms.\n. And where is the performance gain, if I have to restart the rails server, every time I change a class or method? Booting up a rather medium rails app can take several seconds, so I don't see any speed bump in here.\nFor frontend devs \"only\" doing CSS/JS, this is ok, but this is easily done in de-activating class reload locally in their app. Best done in a ENV var or something.\nDefinitely nothing you want to enable globally.\n. > Why don't you let customer support change the email address and then send out a password reset token?\n@mamhoff @ericsaupe This is exactly what #1942 does. Email address is already changeable and it adds a button to the users account page that allows admins to send a password reset token via email.\n\n. The same is true for the European Union. That's a country based zone. Each country inside is state based.\nBut, this could be done without a type/kind column. Since a zone member can be either state or country.\n. In the past Travis supported large OpenSource Projects like Rails and Spree with more free resources.\nWe could ask them to support Solidus\n. > FWIW, I believe that whatever instability travis may introduce can be fixed by using capybara properly.\nYes, Feature specs on Travis CI makes you nuts sometime. But they are handable.\n. Nice. I'm looking forward to a much improved backend. \nPlease consider to make the first level menu items hover able, so they reveal second level items. \nCurrently in Spree 3 the user has to click way to often only to see them. One click to open the panel, second click to visit the desired page. \nThanks\n\nAm 06.11.2015 um 00:11 schrieb Amanda Healey notifications@github.com:\nStembolt is putting effort into improving the overall experience of the Solidus admin. We\u2019d like to take an iterative approach, with smaller changes that make it easy to upgrade.\nIn the first phase we want to move the navigation to the left of the screen and make the application span 100% width. This will make it easier to add more menu items and frees up space at the top. Using the full width of the screen will help to maximize space and is one step closer to a responsive design. This puts us more in line with the upgrades made in Spree 3.0, which we consider to be a successful improvement from a UI perspective.\nWhile we\u2019re setting up the framework for a responsive design, the middle content area and navigation deeper than the second level will remain unchanged until a future phase. This means that although the width of page is 100% of the screen, the middle content will remain at its current width.\nThe left navigation will be organized the same, but will be formated in a vertical fixed width layout. Longer navigation items may wrap if they don\u2019t fit within the specified dimension. Users can collapse and expand the menu by clicking on the parent item. Only one sub menu will be viewable at a time to prevent overwhelming the user.\nThe link to store is moved to the right of the logo and access to the user\u2019s account and logout functions will be moved to the bottom left of the menu. This will maintain easy access, reduce prominence on the page and align with the rest of the design layout visually.\nSee the attached wireframe for all layout details.\nWe\u2019re looking for feedback on the outer design elements only. We recognize further enhancements will be needed, but would like to make this one the best possible before working through the others.\nIdeally we\u2019d like to get these first improvements in for 1.2 and set up future improvements for each successive release to keep an easy upgrade path and manageable patch sets.\n\u2014\nReply to this email directly or view it on GitHub.\n. That's absolutely okay! One of the, sadly lesser used, features of deface is the original key. This should give all extension authors warnings of their overrides that need to be reviewed.\n\nGo for it.\n. The current state of image handling in Spree is just bad. Very tedious. Way too many clicks involved and purely unusable for large stores. \n\nIn Alchemy we have:\n- JS multiple simultaneously Image uploader with drag n drop interface\n- a master image library where images can be assigned from to as many elements you want\n- a built in image cropping tool\n  \nMaybe I can port some of these features over into Solidus. \nI think an global image library where images can be assigned to as many variants you want would be a great addition for any store. \nThe current state is just not practical anymore. \nBest Thomas\n\nAm 20.11.2015 um 16:45 schrieb Martin Tomov notifications@github.com:\nHello,\nI think using rules for images is overly complicated. Not only from code perspective, but also from UI and administration point of view.\nWhat you are effectively trying to do is to assign a single image to multiple, but not all variants. I think this can be accomplished by changing the existing one-to-many relationship between variants and images to a many-to-many one.\nFrom a data perspective, that would require one more table in the classical implementation of many-to-many. In the case of Postgres, it can be elegantly solved using an array column image_ids on the variant table.\nThe trickier part of this approach is to create a nice, maybe drag & drop UI, which would allow users to just pick from the pool of pictures available on all variants, and assign them to any variant.\n\u2014\nReply to this email directly or view it on GitHub.\n. +10000000000 for splitting taxonomies and products!\n. Great proposal. I like the idea of removing clicks. \n\nOne possible menu item not fitting in this is grouping equal listings into on tab, like documents for instance. \nImaging two types of document listings, invoices and packing slips. Both of them are grouped under a documents section. The documents label has no direct relation to one the nested listings. And none of them is more important than the other, so just linking the main menu entry to one of the child listings is not an option IMO. \nAnother thing to consider is the possibility to directly reach one of the child pages. Especially under the settings tab. \nAlso, we should consider performance. If I have to load lots of records of a listing just to reach one of the child pages is not ideal. So, clicking \"products\" (all products load) then click \"option types\" is slower, in terms of database load, then toggling a folder and click the desired sub page. \nI think this can be addressed by hovering the main menu items. But what gesture do we use on touch devices then?\n. Thanks @Mandily for the fly out menu proposal. Really like the idea. I think option a is the best way to go, if, and only if, we also add the fly out menu. Then we have best of both worlds. Small consistent menu and direct access of \"children\" (or other group members)\n\ud83d\udc4d\n. No. The fly out is the missing part. So, keeping the current structure is fine. \n. \ud83d\udc4d\n. I really like the Wordpress fly out example, because it offers quick interaction with tasks often used, like \"create user\". \nIt would be great for extension developers to easily create fly out menus. Maybe though some kind of plugin registry, that also holds menu items and fly out interactions!\n\ud83d\udc4c\n. Sorry for this shameless plug, but in AlchemyCMS we have a plugin registry that offers the developer to set main menu and submenu entries with url to the desired action. \nhttps://github.com/AlchemyCMS/alchemy_cms/blob/master/config/alchemy/modules.yml\nMaybe this helps considering this feature. \nI think the old way of patching/overriding/defacing a view and use the tab and menu_tree helpers is not an ideal situation for extension developers. \n. Sorry for this shameless plug, but in AlchemyCMS we have a plugin registry that offers the developer to set main menu and submenu entries with url to the desired action. \nhttps://github.com/AlchemyCMS/alchemy_cms/blob/master/config/alchemy/modules.yml\nMaybe this helps considering this feature. \nI think the old way of patching/overriding/defacing a view and use the tab and menu_tree helpers is not an ideal situation for extension developers. \n. @Sinetheta it's already an improvement ;)\nBTW: In the settings menu, the right sub nav is somewhat misplaced:\n\n. I think the settings sub navigation should also be inside a flyout. The right subnavigation normally is based on one record (ie. Product 1 -> Images for Product 1). The settings on the contrary are not related to one particular resource and it would be very nice to be able to quickly reach the sub items.\n. The user login menu is not showing for me (fresh sandbox install):\n\n. Adding position: relative to body would make the sidebar 100% height:\n\nAlso, adding a background color (i.e. #EFF5FC) would be great to separate the sidebar from main content.\n. @jhawthorn I agree. Good point. \n. @Sinetheta good work. But, there are still some styling issues with the right / third navigation level:\nmaster branch:\n\n\nadmin-nav branch:\n\n\nI guess there are \"just\" some styles missing?\n1. The highlighting is gone\n2. the bullet points should not be there\n3. also the line height seems to be too small\nAlso, the height of the #content-header should be fixed to 95px, otherwise it will be smaller, if no buttons are present (the .inline-menu has a padding).\n. @Sinetheta \nThat's what's missing:\n```\nnav.menu ul li.active a {\n    color: #9FC820;\n    border-left-width: 0;\n    border-bottom-color: #9FC820;\n}\nnav.menu ul li a {\n    padding: 10px 0;\n    display: block;\n    position: relative;\n    text-align: left;\n    border: 1px solid transparent;\n    text-transform: uppercase;\n    font-weight: 600;\n    font-size: 90%;\n}\n```\n. @Sinetheta Sorry, I found another issue :crying_cat_face: \nSince the left menu is introduced, the JS #progress bar is now too far on the right:\n\nThis is easily fixed though, with adding left: 0:\n\nAlthough mathematically correct it now looks a little bit too far on the left. Playing with values (50 and 100 px) look a bit better.\n. @Sinetheta if you prefer, I can send PRs to your fork.\n. @Sinetheta Glad, that you got well this soon! Will send some PRs tomorrow.\nAs for the loading spinner position please also see my comment on #520 \n. Very nice work on the sticky.coffee class @Sinetheta \nThe navigation feels good, now. \n:+1:\n. :ship: :fireworks: \n. :ship: Really looking forward to the new admin layout. Great work everybody! \n. Hmm, the .admin-nav-footer styles seems to be missing now. The #login-nav from @Sinetheta fork of solidus_auth_devise is not sticked to bottom, as it's supposed to be:\n\n. Argh, you right. UX is hard :( \nNeed some time to think over it. \nI guess you and @mandily will work something out.\nBut a first thought: Option 4 :+1: \n. I found one small issue, that could be addressed in this PR or in a separate PR. As you wish.\nDue to a bottom margin of the main-content the side bar has a hole in the border:\n\nFix:\n\nBesides that :+1: :shipit: \n. Perfect! :shipit:  :tada: :dancer: \n. Perfect! :shipit:  :tada: :dancer: \n. Booyaa!!! \ud83e\udd18\ud83c\udffb\n. I added a comment to #289 about a fix for a bug that was introduced with https://github.com/spree/spree/pull/6654\n. Yes,\nI just wanted to be sure, that this is payed attention to ;)\n. Wow, @Mandily! \nFirst of all this is a big improvement! Thanks for your work. \nReally appreciate that the admin UI is finally addressed in Spree/Solidus :heart_eyes: \nMy two cents:\n\nI like the idea of using less prominent colors, especially for the main menu. But, I don't like this overall dark look of this. For us \"nerds\" this is ok, but the majority of our users aren't and like more light colors. I would love to see another version with lighter grays. (And it looks too much like Wordpress _cough)_\nThe blue color palette is little bit to \"cold\" for my eyes. Although blue is the color of trust and solidness (that's why lots of banks uses blue colors), we should try something else. For me, I love the golden touch of the Solidus logo for instance. Maybe we could try a golden palette? (Solidus => money => Gold, get it? ^^)_\nI think buttons that cause an action like \"create\" or \"delete\" should look like it. So blue is not the best option here IMO, especially with the overall blue color palette. Maybe the obvious ones (green and red) would be something we could try here, don't know.\nThe rounded corners of the UI elements look a bit too nice / cute for such an solid peace of software. As I don't promote complete sharp edges, I would try to reduce the rounding a little bit.\nThe rest is great. I like the content area and the sticky footer (the pagination should be sticky too)\n\nBecause it is not purpose of your mockup, I say it here: WE NEED TO CHANGE THE ICONS! They don't fit the overall vision of an solid and mayor e commerce software.\nLike I said above. Very great work!\nThanks\n:heart: \n. @Mandily there are lots of great other icon libraries out there. But I totally agree, that this will be too much of a change for now.\nYou're Shopify and Stich examples clearly show, that a dark menu is the way to go (for good reasons). So I just thought more like a \"branding\", then a redesign here. But nevermind.\nI'm all in. Let's not reinvent the wheel.\nFor the bottom aligned sticky notification I'm totally fine with. Maybe, you could consider a more Growl / OS X Notification center like approach floating on the top right. That's what we did in AlchemyCMS and since lots of users are used to it, it could be an option.\n\nBut it's jut notifications and like you already said, people won't notice them unlike they're red.\nBut, I think the \"wait, something important is happening\"-JS-progress-spinner-thingy should be more prominent and in best case, prevent the user from clicking anything. So maybe makin it a full screen overlay would be an option? Like, you guessed it, we did in AlchemyCMS:\n\nPS: Sorry, for these shameless plugs, but I thought a lot of admin user interfaces in the last couple of years and just want to share my experience here.\n. Like that. But still think there is a difference in \"primary\" and \"positive\" actions.\n\"Add\" and \"New\" are more like primary, but \"Save\" / \"Update\" are definitely very positiv actions and could be look like one, so green.\nWhat do you think?\n. I can agree that red is not fitting into the appeal of the UI and really like the primary and secondary action being inverted blue.\nThe current UI has the action color code as hover state. What do you think about keeping that behavior? It would be a great compromise of both ideas and it's more subtitle. \nBTW: As cancel is not a dangerous action IMO, I wouldn't color it red, but neutral/secondary. \n. Usually you want to setup your tax rates and prices with including tax. Then Solidus starts to refund your taxes for customers outside of the EU. \nBut, that's wrong. \nPlease wait for @mamhoff finishing his work and/or contact one of us (we work together at magic labs, a German Spree/Solidus integrator) in order to setup your system following German tax laws. We are quite familiar with it ;)\n. Linking #519 \n. And linking #522\n. Like the idea. \nI would like to see more like a code guideline site, then a visual guideline. \nEn Detail:\n- Sass Variables explained\n- an icon reference\n- and syntax preferences\nBut, first and foremost I would like to see a list of components and how to use and extend them. \n. @Sinetheta Too make this clear: With \"Sass variables explained\" I meant the sass variables used in Solidus, not how to use them in general ;)\n. :-1: Slim/HAML offer no benefit other then abstraction. Sass and Coffescript are also abstraction layers, but they also have benefits. \nAnyway: You're free to use slim/HAML in your view overrides. That works in the frontend and in the backend. You can even override an erb view with an slim variant. \nBut I strongly advise against slim and HAML as template languages in the core. \n. @jhawthorn yap. Please be aware this will be large one! I decided to make lots of commits so each change for a model will be visible in the history. This will be harder to review, but better to track down later. Ok?\n. @jhawthorn what do you want me to do with the test fixes? One commit at the end that fixes the specs that depend on old labels, or amend the fixes to the commits, that changed the culprit label? \nI guess the latter is the cleaner option, right?\n. Closing this for now. Will try to send smaller changes, maybe model wise?\n. \ud83d\udc4d\ud83c\udffc The factories really need some love. @mamhoff and @wdspkr recently refactored the order factory in one of our projects in a very nice way. Transients traits. Good stuff. Will see if we can get a PR working. \n. Thanks for your contribution.\nIt would really help the reviewers, if you could tell them what exactly do you refactor and why. \nPlease see the contribution guidelines in order to write good commit messages and pull requests. \nThanks again. \n. \ud83d\udc4d\n. This is used by the solidus_i18n gem to translate country names in the countries select. The translations are provided through I18nData, which is a dependency of solidus_i18n\nBut I see this is a performance issue that should be solved.\nWe could use globalize to translate the country names and load the countries with names for current locale with Spree::Country.with_translations(I18n.locale).\nSo, this should be done in solidus_globalize then and can be removed here. But, we need a way to override / extend the country select, without using module_eval ;)\nAny ideas @alepore?\n. Closing as stale. Please reopen if this is still something we want to tackle.. Fun fact: I also have a branch for removing jstree, but hadn't a chance to work on it any further. \nI use the jquery nested sortable plugin. A new dependency, yes, but a very small one, though. \nThe reason why I choosed this plugin was: nesting. Jquery sortable does not support nesting; only sorting elements on the same level. But we want to be able to move a node into another one, right?\nRegarding the context menu: I would remove it and add buttons besides each node to add a child node. \nWe should also clean up the table columns. AwesomeNestedSet does not need a position column and nested sets in general work with parent, left and right columns. But the taxons table has all of them. \nMaybe I can free some time to publish my branch. Would love to here your feedback on this. \n. Ha! You are great @Sinetheta \nI don't have the time right now, to play with it. Will do tomorrow, but this is very neat!\n. I tested it and find it very hard to drag a node into another one. It's so hard to hit the trigger, that I thought \nat first it is not even possible. I tried to use tolerance: \"pointer\", but this didn't help either. \nAnd even if one finally manages to move a node into another one, it is nearly impossible to move it out again. Not a great UX IMO.\nI am aware, that another dependency is not pleasant, but swapping out jstree with jquery.nestedSortable is still a total win of 148kb and a much better UX for the user. \nPlease try the demo at http://mjsarfatti.com/sandbox/nestedSortable/ to feel the difference.\nIf you still want to go only with jquery.ui.sortable I'm fine with that, but we should make the handling much smoother then, otherwise it does not feel like a good change UX wise.\nMaybe some css (tried raising min-height for #taxonomy_tree ul) will do the trick.\n. Feels much better now. Great work, Kevin!\nThere are still smaller UI glitches, but the dragging is perfect. \nGreat to see that we don't need any additional plugin for that feature. \nRegarding the routes: Deprecate and then remove with the next release. \n. Yes, this is definitely doable. Lots of community members already started to port common extensions under the solidusio-contrib GitHub organization.\nWhile porting other extensions two things need to be ensured:\n1. The spree gem dependencies in the extension .gemspec file needs to be update to require the solidus gems instead. So, a dependency to spree_core needs to be solidus_core, spree_backend to solidus_backend and so on.\n2. The code base needs to be compatible with Spree 2.4, because Solidus was forked form Spree 2.4.\n. Glad to here that! @cbrunsdon close, plz.\n. Moving to bootstrap in Spree 3 was one of the reasons for the Solidus fork, though...\nPersonally I think a framework like Solidus should not make any assumptions to the front end framework a shop wants. \nI would even prefer to keep the front end separated from the core as much as possible and the core should only ship the barest minimum possible, with easy to override defaults, so that the frontend dev can choose which front end framework she likes to use. Foundation i.e. is also a nice framework, like suzy is and so on and so forth.\n:+1: for solidus-bootstrap\n:+1: for solidus-foundation\n:+1: for solidus-suzy\n:+1: for a frontend framework agnostic core\n. Foundation is great. We had a discussion recently about the framework in the backend. As I also voted for Foundation, the majority of the core team voted for rolling it's own framework. \u00af\\_(\u30c4)_/\u00af\n. @gmacdougall thanks for the words. I appreciate the thoughts and am fully \ud83d\udc4d\n@hhff the backend currently gets redesigned and enhanced bit by bit. Please see #509, #487, #505, #520 and so forth. Please involve yourself in the very open and appreciating discussion. Would love to here your feedback on how we can approve the backend. \n. #955 has landed!\n. Please read https://github.com/solidusio/solidus/wiki/FAQ#can-i-use-the-spree_-extension-with-solidus\nThanks\n. A user of Alchemy reported, that switching from awesome_nested_set to closure_tree solved performance issues of CMS installations of several hundred thousand pages. \nThe switch seems to be relatively easy. But, we are talking about trees with several thousand entries. Does anyone has this large taxonomy trees?\nI say: If the switch is painless and backwards compatible in a manner of running a migration, why not? Performance gain for nearly free, give it to me!\n. This is too invasive for an extension IMO. I would fork the repo and rewrite it so it works with closure_tree, then open a pull request, so it can be merged into the core. \n. :+1: for updating the existing migrations\n. > It will mean that \"down\" migrations will not be able to function from spree 3.1 but I think that is an acceptable compromise.\nThat's totally ok.\n. We refactored lots of Spree 3 factories lately and hopefully can find some time to push upwards. /c @mamhoff\n. \ud83d\ude80\n. To be honest: My first thought was, \"Oh no, the style guide inside the core?\" But then I saw how you implemented it and was all in! \nThis is just awesome sauce. The style guide reflects the actual styles used. \ud83d\udc4f\ud83c\udffb\ud83e\udd18\ud83c\udffb\nMaybe we could put it in a separate gem inside the core repo (solidus_styleguide) and this will only be required for local development, not in runtime? \nOr do you plan to make it public accessible even for the backend users? Can't imagine why this could be useful. But anyway, with a separate gem, developers could opt in or out. \n. Ok. Loud thinking:\nFirst, I thought of option A) (for local Solidus development only). There we could just put it in the Gemfile of solidus_backend, mount it in the sandbox and that's it. Would be totally ok for me. \nBut: As you said \"to help all stores to style their admin\", my thoughts went like:\nReally, really nice would be to have a docs/help section in the admin. There this would be a perfect fit. Also for the docs and guides. All delivered right within the gem (PRs update note only the code, but also the docs, styleguide, etc). Benefit is clear. \nBut reconsidering again:\nWhich backend user (saying non-technical staff) is able to update the sass files anyway? Doesn't she always need a dev to change, commit, deploy?\nSo, I am not certain here right now about what's the right way. \nToday,I would say: Option A) for now, Option B) later on, as users request this. \nWhat do you think ?\n. The new styleguide would be a great place to add the customization guide, isn't it?\nAs the colors now differ from the main content, I guess you will address this as next? Otherwise the admin UI will look a little weird. \nAlthough I spoke against the dark/blue theme, I have to admit that it looks nice and far more mature then the current theme and I can't wait to see the whole backend to look like this! As always great work @Sinetheta \ud83d\udc51\n. :+1: \n. I like the idea of a theme folder, but it's not necessary right now IMO. \nAlthough I would call the intermediate folder solidus I'm \ud83d\udc4d\n. I also don't like to have vendored assets as Coffescript file. I would add the unminified JS version. AFAIK sprockets does not skip already minified files and it is great to have the readable version for debugging. \n. Ah. A proper diff \ud83e\udd17 Thanks @mtomov \n. It is possible for you to share your Gemfile.lock with us? So we can debug potential gem conflicts. \nAlso, please show us what steps you take to install Solidus. Step by step, please :)\nThanks\n. It is very unfortunate that you lost an hour of your precious time.\nWhat should a troubleshooting section in the README cover? Bugs like these happen and can have several causes. We really can't cover every  potentially issue.\nDebugging is annoying, cumbersome and frustrating, but explaining how to debug a Rails app can't be the purpose of this projects README.\nThere are lots of great resources out there covering debugging Rails apps. \nWhat Solidus specific debugging advice should we add to the README?\n. Otherwise \ud83d\udc4d\n. Yeah. What a Christmas present!!! Thank you so very much @Sinetheta \ud83c\udf84\ud83c\udf84\ud83c\udf85\ud83c\udffb\ud83c\udf85\ud83c\udffb\n. Closing as stale. Please reopen if you think this is still something we should to tackle.. Would love to see this happening. This is a great improvement. \nAs next step I would love to see the content not being centered and narrowed any more. It does not fit into the overall look anymore and is a waste of screen space. \n@cbrunsdon How do you plan to release all of these backend improvements? As the individual PRs are great, releasing them individually would lead to a very inconsistent UI. So, I guess that if all UI PRs landed, we will release them all together, right?\n. Ok, sounds like a good plan. Besides the colour (British Columbia ^_^, love that) changes in #603. This would lead to a strange mix of colours in the admin UI. I would move the colour changes all together in one release (1.3 then). Also #629 would be a better candidate for 1.3.\nMoving around the navigation and flash notices is ok IMO, but having two colour themes is not.\nHow do you think about it @cbrunsdon @Mandily ?\n. Great. Far better, then current state of third level nav. \nI also prefer the dropdown navigation for tabs not fitting the screen :+1: \n@Mandily I don't understand what you mean with:\n\nOne thing to note is that in doing this, we won\u2019t be using the title from the right side nav in the tabs\n\nWhat title? The text inside the link we have now?\n. @Mandily ah yes, totally useless.\n. I like the idea of grouping the settings in logical groups. But this comes with a downside I want to discuss here. \nWe won't reduce clicks. Removing clicks was one of the mayor reasons to move the individual settings into the main navigation. \nAny ideas in how we address this? I absolutely see the benefits of grouping the settings and like to see this implemented, but I also like the settings to be easily reachable. \nSecond: I don't think Taxonomies is Store related. It should be its own \"Page\" don't you think?\n. Yeah, yep, you're all right. A cleaner settings section > less clicks. Granted.\nWhat about putting Taxonomies on the Store settings page? \n. For gems using the Spree constant it's easy to migrate. Just like you did, replace Spree with Solidus. I wouldn't recommend to use something like Spree = Solidus. Expect strange, hard to debug errors. Rails eager and autoloading will not be happy with that. \nOtherwise \ud83d\udc4d. Although I would love to see better commit messages. And a rebase that stashes commits that fixes one another. \nRegarding the migrations. One large table renaming migration is needed to make the upgrade possible. \n. Ah. Good catch @mamhoff  we must not by any means touch the current Spree license!! Maybe there is a way to dual licensing? Really don't know how to handle licenses of forks. But the originally one needs to stay untouched. This is what the license is all about, right?\n. \ud83d\udc4d for waiting until 2.0 (?)\n. You're comparing Spree master with Solidus master. They are completely different. The fork was made from Spree 2.4. The current spree master is 3.1.beta. \nBut, yeah. This is easily fixed in your local app. Just add a config/locales/spree.en.yml file and add the missing translation. You also could send a pull request that fixes that. But since the translations get an overhaul in #549 and general translations like Spree.t(\"stock\") will be replaced with Model attribute translations anyway, you could spare this and just fix this in your local app. \nThanks for reporting. \n. I'm with Martin here. :+1: \n. :+1: \nAlthough I would replace all occurrences of \"this project\" with \"Solidus\", but it could also be like it's right now. \n. Yes, I also agree with @gmacdougall Especially if we start to document very specific stuff like binding IP addresses.\n. :+1: @cbrunsdon regarding bundle exec: Rails promotes bin/rails, since this handles binstubs and such. But this is for another PR\n. We should add this code to solidus_globalize. My time is limited right now. @connecticus would open a pull request on solidus_globalize? Thanks\n. Note: The example in the comment is wrong and against existing european tax laws! We have to change this in further PRs.\nCorrect is: When you ship from Spain to France, your customer will have to pay Spanish VAT. The entire idea of an online store giving \"tax refunds\" is ... wrong. \nSee https://en.wikipedia.org/wiki/European_Union_value_added_tax#EU_VAT_area\nDisclaimer: No offense to @jhawthorn :)\n. Did you run your benchmarks against the whole stack, so that rendering is also measured? \nAs we investigated in AlchemyCMS we found that rendering the tree is the slowest part. After switching to handlebars templates and only returning JSON from the controller we gained a ten fold speed up!! \nAgain, just by rendering in the frontend instead of iterating over rails partials. Alchemy still uses awesome_nested_set, because the speed gain was significant enough.\nReference:\nhttps://github.com/AlchemyCMS/alchemy_cms/pull/923\nhttps://github.com/AlchemyCMS/alchemy_cms/issues/894\n. Closing as stale. Please reopen if you think this is still something we should to tackle.. This would be a great addition. :clap: \nWe need to assure, that the label of the menu item is visible while hovering over it. In current Spree 3 admin the label is not shown and therefore it's hard to guess what icon is the desired one.\n\n. Like the fly out. We shouldn't introduce another visual for the main navigation. That could be confusing. \n. @sukhchander I guess @Sinetheta will do the implementation, but please feel free to send a PR. We are happy about every contribution.\nHow do you handled the missing label in collapsed menus? Your screenshot does not show how a hover state of a collapsed menu item will look like.\n. A delay in UI can be problematic for important information like the main navi entries. \nWhat if we let the tooltip point from top of the icon, so that the fly out does not interfere with it?\n. > You will need to do the same with any other spree_* gems as well.\n;)\n. You need a solidus compatible version of the gems you are replacing. Please read more about spree extensions in Solidus in the wiki\n. \ud83d\udc4d for removing magic numbers. \n. Although this is a step into the right direction, this really should be partials. Putting together templates in helpers is something we should avoid in the future.\n. This is more something for a guideline/wiki than the README. A README is more a \"how to install\" for developers than a user guide. Also this is common rails knowledge. \nPlease don't feel offended, but from that's a \ud83d\udc4e\n. Yes, a link to FAQ/Wiki ist great for the README, but a README is not \"main docs\", that was my whole point.\n. If someone sends a pull request we would be happy to merge this in. Also, the Wiki is public writeable. Contributions are welcome.\n. One adjuster for two different things? It seams the only thing they share is the order tax zone. \nWhy not an OrderAdjuster and a LineItemAdjuster, both knowing the order tax zone but having separated concerns?\nSandi Metz is calling! Excuse me ;)\n. One adjuster for two different things? It seams the only thing they share is the order tax zone. \nWhy not an OrderAdjuster and a LineItemAdjuster, both knowing the order tax zone but having separated concerns?\nSandi Metz is calling! Excuse me ;)\n. There is too much knowledge of the two possible callers inside one class. Case statements on class types, then methods named after the caller, etc. \nTwo separate adjusters are much more flexible, more future safe and less error prone. If we use POROs than please let us use clean object oriented design. \nSorry, reading too much Sandi Metz lately. \nJust my 0.02\n. I hopefully can spent some review time later this evening (CET)\n. Alright \n. :icecream: \n. This is very specific to the store itself. I don't see this in solidus_auth_devise either. This is something the store can include on its own. \nMaybe an extra extension.\n. Yes. . I think default_scope is not per se evil. There are places where it helps the developer to prevent unexpected behavior, like soft deleted products, not yet available products, etc. \nBut here the default scope is kind of optional. Not having the payment methods sorted is not harmful and therefore not mandatory. Displaying discontinued products is. \nSo, here we should remove the default_scope\nOtherwise \ud83d\udc4d\n. Yes. prompt without value is useless :+1: \n@jhawthorn @cbrunsdon how is our preferred hash syntax? And do we accept changes of syntax in pull request. For me it would be great and ok to change the hash syntax here rift with the changed behavior. What do you think?\n. Just a fix idea coming to my mind:\nShouldn't this solidus_i18n or similar library handle? Type conversion, rounding, etc. \n. Huge, but the \"only\" real\u2122 solution to rounding issues. Every serious software uses fractal units over decimal ones.\n:+1: for using money\n. This is awesome You're fast @jhawthorn \nYes, we should disable all checks we currently not care about (like variable assignment indentation). Good catch @jarednorman \n. :+1: :shipit: \n. :+1: Great\n. Being supportive to extension developers is a goal of Solidus, isn't it? We need to provide extension endpoints, hooks, etc, where extensions can hook into the core. Otherwise we will have class_eval all over the place.\nChoose your poison. \u00af\\_(\u30c4)_/\u00af\n. I guess your are using solidus_i18n? \nWould you please open an issue on that repo then?\nThanks. \n. Ok, closing this then. Thanks for updating\n. I plan to let all Devise controllers inherit from Spree::BaseController, to make it much easier to extend them from solidus_i18n\n. @forkata could rake test_app from solidus_virtual_gift_card also run the solidus_auth_devise generator, like in a \"real app\"? Or the generator from solidus_virtual_gift_card could run the solidus_auth_devise generator, if it's not already present.\nTBH I really don't see the core have to know anything about something it does not depend on.\n. Great. Thanks\n. As the view is not really used by any shop, I don't see that this needs to be \"fixed\". Most shops will most likely change the frontend styles anyway. \nBut we won't reject a pull request. \n. Otherwise I am \ud83d\udc4d on this, as this is often requested and useful information! Thanks\n. Still :+1: \n. :+1: \n. :+1: Let me know, if you need any help\n. @Murph33 Yeah, I changed that primarily for performance reasons.There is no need to create static HTML tags with costly rails view helpers. \nBut, this is out of scope of this PR, so I guess we should skip this in order to not pollute the diff with non related stuff. What are @cbrunsdon and @jhawthorn thinking?\n. @jhawthorn That's why the <span> is not part of the label in my change. I'm also fine with your solution. Easier to override for people that don't want the * in the forms. \n. We should at first only address the form translations and fix the other stuff later. Removing unsused translations should be another PR. \nMaybe we could deprecate them. Therefore we could pimp the Spree.t and log a ActiveSupport::Deprecation if a deprecated translation was used. But this is a lot of extra stuff to be done. \nShould we maintain a list of moved translations at least. So we could show the list in the release notes?\n. We need to avoid the duplicated id. Good catch!\nI think we should change all labels referring to foreign keys to use the human class name of the referred object. \nTaking the example from above:\nerb\n<%= f.label :stock_location, Spree::StockLocation.model_name.human %>\nThis will most likely be the best option and we won't need to have duplicate translations for the same thing. \n. :+1: \n. Although I don't like general translation keys like this one, I'm :+1: on this for the sake of consistency.\n. And will speed up asset compile times! :+1:\n. According to this post every empty asset file adds 250ms to compile time \ud83d\ude35\n. :+1: \n. :+1: \n. That's reasonable and I'm fine with it. Although @rates_for_items is not used outside of ItemAdjuster and therefore could have the underscore in the name, but I will stop complaining now and won't hold this back anymore. \nGreat work. Thanks, @mamhoff \n. Go!\n. \ud83d\ude0e\n. I totally agree with avoiding computed expectations, except for translated strings. Translated strings are just static constants living in other files. Like fixtures. \nThe test will break if you change the translation or, happened to me many times, the browser you test against has different locale settings. \nI'm fine with leaving it, but you've been warned. \nThere is a German saying: \"I've seen horses throw up\" ;)\n. Haha. Great one :+1:\n. This is awesome :+1:\n. Shouldn't we keep the removed translations? I'm not sure right now, where we're at right now with this topic. Do we want to keep them or remove them? /c @cbrunsdon\n. Otherwise :+1: (for obvious reasons \ud83d\ude05)\n. A simple comment won't work, cause nobody ever looks into that file. Especially if it's inside the gem.\nQuick thought:\nMaintain a list of deprecated translation keys (Spree::I18n::DEPRECATED_KEYS). Every time a deprecated key is used, we actually warn the user about it. \nWe could just remove them, but this will potentially break extensions and stores using them. \n. @Murph33 sorry about the confusion.\n. @Murph33 https://github.com/solidusio/solidus/pull/764#discussion_r51328487\n. :+1: This is great stuff and thank God Alabama is the first in alphabetical sorted states ;)\n. :+1:  No need to add a new migration. \n. :+1:\n. :+1: \n. Please ask questions on the official slack, the user group or on stack overflow. GitHub issues are for errors you encounter while using the app. Thanks. \n. Please reopen the issue if you get an error that is reproducible in a fresh Solidus install. \n. :+1:\n. I think default_country_code would be a more understandable name. Although iso is the correct term, code is more commonly known. \nDon't know what do you think?\n. Spree.t translations are not evil per se. If the key is specific enough, it's ok to use them. \nWe should avoid them as much as possible, but \"Ausnahmen machen die Regel\", as Germans say. \n. :+1:\n. Although I would love to see them go immediately, everybody would hate us if we don't deprecate them properly. We're good open source citizens, right?\nDo you think you could find an easy way to deprecate them or will this complicate your work dramatically?\n. And with s in your query times you mean ms, right?\n. :+1: \n. I'm with Martin. Separation of concerns. Spree::User related stuff is solidus_auth_devise responsiblity\n. :+1: \n. :-1: on select2 3 default style (the rounded gray look does not fit the rest of the UI)\n:+1: on select2 4 default style\n. Thanks :+1:\n. Spree::Exchange could extend ActiveModel::Naming. \nThen we could also remove this little fella\n. I support Clarke's idea. Both of them. This needs to be partial. \n. :+1: far better\n. :+1:\n. :+1: \n. Even without moving the initializer code :+1: \n. Great work @graygilmore \ud83d\udc4c\ud83c\udffb. \nAlthough I have to ask this question:\nDo we really, as an e-commerce framework, want to maintain a widget library? We discussed this a lot, but I have to raise this question again. \nAgain. This is awesome work! No doubt, but do we want to hassle with \"tabs not working in browser xyz\" issues in an e-commerce framework?\n. I'm a bad person. \n1. Why not leave the RMA translation as it is right now and use model_name.human. I know I gave the hint in the admin.tab direction. Sorry, but we already use it. So, why change it?\n2. We recently decided to switch to Bootstrap. Although this is great work, why don't we use the Bootstrap tabs component here? We could decide to merge this in, add the bootstrap grid, only for shortly after change this to Bootstrap? Although I admire your work, I feel bad about you doing the same work twice. \n. @graygilmore in #955 we start to introduce Bootstrap, which provides a Tabs component. Maybe we should have a look if this could work for us and either use your or their component. But having both is kind of silly. \nI'm in the don't reinvent the wheel club, as you already know ;)\nAgain, your work is amazing, but I try to keep the maintenance burden we already have as low as possible. \nSo, if you can invest some time to try the Bootstrap component, this would be very much appreciated. \n. Thanks John. \n\ud83d\ude80 :ship: \n. Ok. But ~> 1.6 should do the trick.\n. :+1:\n. \n. Two in a row? @jhawthorn and @mamhoff you are crazy! \nNice :+1: \n. :+1: \n. :+1: \n. jQuery respects if you use classes to toggle visibility. I consider toggling style attributes on DOM elements a anti pattern:\n1. We need a JavaScript driven browser to test features having this form. Without we could use plain capybara. \n2. style attributes have precedence over class declarations. So, a customization could never hide this field without using !important\nJust define the hidden class as display: none (predefined in Bootstrap, btw.) and see this working even with jQuery. \n. Ok\n. Yeah! :+1: \n. \n. Shouldn't we get rid of the label column, then?\n. :+1: \n. :+1: \n. Could you please try to use required: true on belongs_to :store, instead if validating the store_id presence?\nIn Rails 5 this will be default and should work here. Not shure about the before_validation running before that, but we should give it a try. \nEither way :+1:\n. Did you ran any benchmarks? Is this really so much slower?\n. Thanks! I would love to see tests for this\n. Closing as stale. Please reopen if you think this is still something we should to tackle.. Do we need ids after all? No css/js refers to it and integration point for extensions should be the [data-hook] anyways. \nSo, I vote for removing them.\n. Why not just deliver the files, but not require them. Then we could have a slim JS file for \"default\" Solidus and extension developers are still able to require components they need. \nFor instance, the Tab component won't be used by default Solidus admin, so why require it and bloat the JS file?\nAlso, I thought we agreed on porting one component at a time, so we basically don't need any JS component right know?\nAm I missing something? /c @graygilmore \n. Why not just deliver the files, but not require them. Then we could have a slim JS file for \"default\" Solidus and extension developers are still able to require components they need. \nFor instance, the Tab component won't be used by default Solidus admin, so why require it and bloat the JS file?\nAlso, I thought we agreed on porting one component at a time, so we basically don't need any JS component right know?\nAm I missing something? /c @graygilmore \n. As discussed in slack we go with the whole file\n:+1: :shipit: already!\n. As discussed in slack we go with the whole file\n:+1: :shipit: already!\n. YOLO!\n. YOLO!\n. :+1: Thanks\n. :+1: Thanks\n. @cbrunsdon you mean these svn externals, right?\n:+1: for ditching it. It has been deprecated long enough\n. @cbrunsdon you mean these svn externals, right?\n:+1: for ditching it. It has been deprecated long enough\n. @jhawthorn This means we can't ever remove deprecated stuff, because upgraders are encouraged to always use the latest version, right? How should this ever work?\nUpgraders need to use the version they are currently on and go on version for version. Remove departed stuff. Upgrade to next and so on. \nOr do you have any other idea? \n. @jhawthorn This means we can't ever remove deprecated stuff, because upgraders are encouraged to always use the latest version, right? How should this ever work?\nUpgraders need to use the version they are currently on and go on version for version. Remove departed stuff. Upgrade to next and so on. \nOr do you have any other idea? \n. Ok. Sounds reasonable to me.\n. Ok. Sounds reasonable to me.\n. I like the way the admin is heading to. Nice work. Nothing to complain (can you believe it)\n:+1:\n. I like the way the admin is heading to. Nice work. Nothing to complain (can you believe it)\n:+1:\n. :+1: we should always ever use the spree route proxy in all views and helpers, so they can be used outside of spree controllers. \n. :+1: we should always ever use the spree route proxy in all views and helpers, so they can be used outside of spree controllers. \n. :+1: thanks. What great commit messages you write! Chapeaux\n. :+1: thanks. What great commit messages you write! Chapeaux\n. :+1: \n. :+1: \n. #955 has landed. Now this can be rebased @jhawthorn \n. #955 has landed. Now this can be rebased @jhawthorn \n. If we change the selector to something more specific and closer to the event target element, we are good to go!\nNice work, John, as always \ud83d\udc4c\ud83c\udffb\n. If we change the selector to something more specific and closer to the event target element, we are good to go!\nNice work, John, as always \ud83d\udc4c\ud83c\udffb\n. Could we rename the checkout_tabs partial into something less generic and more specific to the settings? Maybe settings_checkout_tabs?\n. Could we rename the checkout_tabs partial into something less generic and more specific to the settings? Maybe settings_checkout_tabs?\n. :+1: \n. :+1: \n. Wow. :+1: \n. Wow. :+1: \n. :+1: Nice\n. :+1: Nice\n. Perfect. Thanks for adding more docs and considering my feedback.\nSomeone please have a look into the SQL in the migrations as I'm not able to review it. @jhawthorn @gmacdougall \n:+1: \n. Perfect. Thanks for adding more docs and considering my feedback.\nSomeone please have a look into the SQL in the migrations as I'm not able to review it. @jhawthorn @gmacdougall \n:+1: \n. :+1: \n. :+1: \n. :+1: for having a debug tool right in place. It's in the local Gemfile anyways. If someone likes to choose another one (like me preferring pry), they could easily cut that out.\n. :+1: for having a debug tool right in place. It's in the local Gemfile anyways. If someone likes to choose another one (like me preferring pry), they could easily cut that out.\n. :+1: otherwise \n. :+1: otherwise \n. :+1: \n. :+1: \n. Closing as stale. Please reopen if you think this is still something we should to tackle.. Closing as stale. Please reopen if you think this is still something we should to tackle.. :+1: nice \n. :+1: nice \n. Thanks\n. Thanks\n. I don't have any opinion on this. :+1: \n. I don't have any opinion on this. :+1: \n. I'm :+1: on this, but this can't happen accidentally. So, I ask myself, why where theses timestamps omitted in the first place? Performance? Thoughts?\n. I'm :+1: on this, but this can't happen accidentally. So, I ask myself, why where theses timestamps omitted in the first place? Performance? Thoughts?\n. :+1: \n. :+1: \n. @mamhoff the screenshots above are also updated?\n. @mamhoff the screenshots above are also updated?\n. No. Was just asking, because you made changes to the layout according to your last comment.  Thanks\n. No. Was just asking, because you made changes to the layout according to your last comment.  Thanks\n. :+1: Looking great! And the minimum amount of work needed is awesome. Big up @graygilmore \n. :+1: \n. :+1: I :heart: removals!\n. :thumbsup: :dart:\n. @dt1973 I absolutely agree with @mradfaber here, although the comment https://github.com/spark-solutions/spark-starter-kit/issues/21#issuecomment-204130890 from @damianlegawiec is not very helpful as well and just not true. But that's his opinion and ok, IMO.\nLet me say loud and clear, we do not support behavior like this in the Solidus community. \nPlease stop this! Thanks\n. Last warning @dt1973 \n. :+1: Nicely said @gmacdougall \n. Thanks for your interest in Solidus. This issue tracker is for issues/errors you encounter while using Solidus. Please either provide more in depth information of your error or join the the Solidus Slack and ask your questions there.\nI'm closing this right know. Please feel free to re-open if you have more informations for us. \nThanks. \n. :+1: obviously better and faster. Thanks!\n. :+1: can we also fix the indentation? Looks misplaced. \n. :+1: \n. Pretty obvious :)\nThanks!\n. Oh, that's correct. Thanks! :+1: \n. I'm not happy with this just being removed and leaving the stores somehow \"broken\". Even within the change log entry are no hints on how to get the old state back, besides \"updating the shipping rates\". \nWhy don't we take the code and move it into a rake task \"solidus:recalculate_shipment_taxes\"?\nI totally agree that a migration isn't the right place, but leaving this \"unfixed\" isn't an option for me either. Or am I too strict here?\n/c @cbrunsdon \n. :+1: \n. Thanks! \n. Perfect! Thank you very much @mamhoff \n. :+1: looks good\n. :+1: Thanks!\n. 100% acknowledged :+1:\n. \ud83d\udc4d for removing the required attribute.\n. \ud83d\udc4d \n. Perfect. Thanks John. :+1:\n. Wow, it just took me quite some time to figure out where the breadcrumbs for order views came from. Maybe this is the opportunity to move it out of order_tabs partial into the views, no? Or at least rename the partial into something more understandable? Don't have a good name in my mind right now, though.\n. Besides that \ud83d\udc4d this is a great improvement!\n. \"She is called @Mandily sharp eyes\"\n. Is there a reason why we don't use content_for here? The API seems very unintuitive and tedious to me. \nerb\n<% content_for(:breadcrumbs) do %>\n  <% link_to ... %>\n  ...\n<% end %>\nThen when rendering the breadcrumbs we can take care of active state, etc. \n. I like the idea of having a configurable navigation. That would be a great integration point for extensions. \n. Besides lots of (useless) additional new lines \ud83d\udc4d\nThinking about having a breadcrumbs helper that takes a block or array of entries, so we can spare the repetitive add_breadcrumb calls. We just call the add_breadcrumb for each of the entries then. \nWould be much more easy to use, no?\nOtherwise, great addition. Like that very much from the UI perspective.\n. Yes, this is better as it's right now. \ud83d\udc4d \n. Good step in the right direction. I Like that. \n. \ud83d\udc4d and another obviously useless code gone!\n. Closing as stale. Please reopen if you think this is still something we should to tackle.. Besides the relative URLs this is great stuff! \ud83d\udc4d \n. This is fantastic! Finally \ud83d\ude3b\nOne question, though. Why two different layouts for list tables? \nI thought we agreed on all listings to be full width and only forms should be centered. Any reasons why we changed it for the variants listing?\n@Mandily I hope I can free time to attend remotely. Any plans on doing Google Hangouts?\n. \ud83d\udc4d Thanks\n. Great for me. \ud83d\udc4d On the admin_layout helper. Feels more \"natural\" (in terms of Rails views)\n. \ud83d\udc4d\n. I also think, this is good enough. How to we ensure to not lose track on the follow up tasks? Maybe a \"pricing todo\" issue?\n. Thanks John. \n. Solves the problem, even if it's not perfect. :thumbsup: \n. @Mandily great idea. I forwarded the link to our \"non-devs\"\n. This is nice. Can we rename the button? \"Deploy a demo\" or simply \"Demo\" would be much clearer. \n. https://github.com/solidusio/solidus_auth_devise/pull/51 was merged, so this could be merged as well. Need an update to the CHANGELOG, though. We do not plan to back port this into 1.x\n@Murph33 would you update the CHANGELOG or should we do this?. Nice. Thanks, but I would like to have a test for this feature, before I :thumbsup: \n. Thanks. Change log entry and we're ready to merge.\n. Closing this PR as this is very outdated. Conflicts need to be fixed and if the changes still apply this needs to be opened again. Thanks for contributing.. \ud83d\udc4d \n. \ud83d\udc4d\n. I like the idea of two kinds of buttons. \nBut we should only ever have one main-action button, so the user isn't confused of having multiple \"main\" actions on that page. (That would be \"save\" on form pages and \"create new\" on list pages, for instance). \nI also like the idea of having \"action required\" states. We could have a little effect on the button that needs action (remember the glow effect of old Mac OSX versions). I kinda like that, but leave the decision to the designers. \nwindow.beforeunload is great, but should be another task, because maybe want to have proper texts dependent of the page viewed. \nDisclaimer: Also I like the color-for-state option, I think that's not state of the art anymore and doesn't provide too much benefit for the user and can (think of foreign cultures having different color codes) lead to false effects. \n. I'm fine with this. \ud83d\udc4d\n. :+1: for the ActiveAdmin approach. Thanks for finding this @mamhoff \n@dangerdogz I don't see any other chance in addressing this. You can split up the work into several chunks if you like or in one big, I don't mind. Since this is just a global search and replace, the review will be easy. \n. \ud83d\udc4d\n. This is just freakin' awesome!\n. :+1: \n. Sounds reasonable to me. Hopefully no one ever expects our initializers to be run after theirs. But let's try it. :thumbsup:\n. Although we just talked about this IRL, I don't understand the order clause thing. But anyway. This Boolean is not useful at all and we can't find any reference to prices in the current code base, that justify such thing. \n\ud83d\udc4d \n. Notifier, Messenger?\n. \ud83d\udc4d \n. \ud83d\udc4d\n. There is also a legal need in persisting the acknowledgment of the TnC. \n. I like this. \nSo this could be narrowed down to this: \n1. We have a page missing prerequisites. Displaying action to create it\n2. A page with no data. Having a link to create a record \n3. A page with only few records. We omit the filters and pagination\n4. A page with lots of records. We show the full feature set of filters and pagination. \nI think this is actually a great pattern for all list pages, right? Not only the stock transfers. \n. @jhawthorn any chance to look into this again?. span sounds more appropriate then h5, so I give \ud83d\udc4d but want to hear what @Mandily and @Sinetheta say\n. Instead of the need of passing in arguments to get the current store, we should store it on the current thread, so we have one single point of truth for getting \"the current store\" (however this is been set). \nAs a developer I would expect to get the \"current store\", not that I need to pass in an url or code, because that's what find_by_url or find_by_code are for. \nWhy would I want to ask for \"the current store\", if I need to pass in the url or code anyway?\n. I think it's very unlikely, that cloning a normal product getting the same slug as another product. This can't happen. I guess there is some issue with solidus-globalize\nWe don't want uuids in every product slug. \nThis sounds like a friendly_id issue, not a Solidus one. Can you confirm this only happens with solidus-globalize activated? Then the issue should be opened on that repo.\nThanks for reporting. \n. \ud83d\udc4d\n. We want to extract reports into it's own gem like stated in #1262. \ud83d\udc4d\n. This is a great addition. \ud83d\udc4d\n. You should be able to combine both into one can definition. \n. Oh, sorry. It has to be a scope:\nhttps://github.com/AlchemyCMS/alchemy_cms/blob/master/lib/alchemy/permissions.rb#L40-L42\n. Yes. I'm ok with adding them, when we actually need them.\n. :+1: Thanks\n. @sviechnikov please try:\nbundle update --source solidus_core active_merchant\nsince solidus is just a \"meta\" gem\n. \ud83d\udc4e On supporting multiple mayor Rails versions. You will end up with gazillions if Rails.version calls and even worse with if DependencyXY.version calls, as we can't rely on the dependencies to also support both Rails versions. In engines complex as Solidus and AlchemyCMS (which I maintain) this is nearly impossible and a huge maintenance burden. Believe me, I tried it ;)\nI like the idea to only raise the Rails version and nothing else, besides changes necessary to support Rails 5 of course. \nRaising Rails version is a breaking change for lots of stores, so 2.0 is a reasonable version dump, although I don't like to raise the Soldidus mayor version just for a dependency, but I think we can't reasonably do anything else. \n. Like I said, the problems are the dependencies (and dependencies of the dependencies) that will make us headaches. And Solidus has lots if dependencies. Engines with less dependencies are way easier to handle multiple Rails versions. \nI also would like to keep the 2.0 for Solidus related breakage, but one scenario could hold stores from updating to Solidus 1.rails5:\nStores that have dependencies besides Solidus, that may not yet be Rails 5 compatible (Alchemy for instance). So, they can't upgrade until these dependencies also support Rails 5. That's considered breaking IMO. Having a clear signal (a mayor version raise) could help here. I know these are just numbers, but this is how semver (and people understanding semver), works. \nAlso, we could still work on 1.x related stuff without having Rails 5 in mind. Rails 5 compatible stuff could be ported to 2.0, while Rails 5 incompatible stuff stay in 1.x\nI hope that this will never be the case, though. And maybe Rails 5 upgrades are hopefully easier then previous upgrades. (Let's never see a Rails 2 -> 3 horror ever again), but we should be well prepared. \nAnyhow, maybe I'm just too anxious after all these brutal Rails upgrades I went through over the years.\n. Like I said, the problems are the dependencies (and dependencies of the dependencies) that will make us headaches. And Solidus has lots if dependencies. Engines with less dependencies are way easier to handle multiple Rails versions. \nI also would like to keep the 2.0 for Solidus related breakage, but one scenario could hold stores from updating to Solidus 1.rails5:\nStores that have dependencies besides Solidus, that may not yet be Rails 5 compatible (Alchemy for instance). So, they can't upgrade until these dependencies also support Rails 5. That's considered breaking IMO. Having a clear signal (a mayor version raise) could help here. I know these are just numbers, but this is how semver (and people understanding semver), works. \nAlso, we could still work on 1.x related stuff without having Rails 5 in mind. Rails 5 compatible stuff could be ported to 2.0, while Rails 5 incompatible stuff stay in 1.x\nI hope that this will never be the case, though. And maybe Rails 5 upgrades are hopefully easier then previous upgrades. (Let's never see a Rails 2 -> 3 horror ever again), but we should be well prepared. \nAnyhow, maybe I'm just too anxious after all these brutal Rails upgrades I went through over the years.\n. > Does that mean then that solidus_auth_devise actually has a dependency on solidus_frontend?\nNo it depends on a method call current_spree_user to authenticate with. You can create you're own authentication. The only thing you need to make sure is that it provides a current_spree_user method in you're application controller for instance.\n. Great work and fully acknowledged. \ud83d\udc4d\nFor client side validation we should use something like https://github.com/DavyJonesLocker/client_side_validations to avoid the need of implementing them twice. \n. \ud83d\udc4d\n. Indeed \ud83d\udc4d\n. Great. The specs are even better readable know. \ud83d\udc4d\n. \ud83d\udc4d\n. \ud83d\udc4d\n. \ud83d\udc4d Fine with it. \nPlease squash the \"fixing commit\" into the previous one. It does not provide value in the git history. Thanks \n. After reading the comments of Amanda, I need to revert my thumb and second the idea of putting the list into some \"additional third column\". Also, I vote for closing this now (although I appreciate the contribution). \nWe really should put lots of effort into #1290 \n. \ud83d\udc4d \n. Great idea! PR anyone?\n. Thanks. Would love to see some kind of header above. I didn't spot this in the readme at first glance.\n. I like that. Excuse me for correcting the markdown table \ud83d\ude0a \n. Absolutely, yes! :+1:\n. Absolutely, yes! :+1:\n. The build errors are, because we use uppercase text to test against, sigh.\n. The build errors are, because we use uppercase text to test against, sigh.\n. :+1: like that\n. :+1: and deprecation is great. \n. Good idea. It was too aggressive. :+1:\n. :+1:\n. Could you please rebase on current master? Thanks. Sorry that this took so long. :+1: great. Stashing some commits in smaller groups would be nice, but not mandatory. \n. I think we should not require last name to be present, but it's ok to store them separately. Once concatenated you can't split a name in first and last name anymore. Simple using split(\" \") won't work (think of my full name). \nSo, I say :+1: for this PR\n. :+1:\n. @mtomov Turbolinks week for ya? \ud83d\ude06 \n\ud83d\udc4d \n. I'm fine with this, although I'm surprised that only in one place a refund is actually performed. Surely a reason why callbacks are evil here and this change is the right thing to do. \nWe definitely need a Changelog entry. There will be people relying on the refund performing itself. \n:+1:\n. We should consider to show a info or hint why this adjustment is striked through. It is now marked, which is better than before but why it's marked is still unclear to the user. \nI don't even know why an adjustment could exist but is not eligible. Aren't adjustments only get created if they are eligible? Is this really a case and when, why? This is something we should explain. \nMaybe not in this PR, but something we should keep in mind. \n. beside my nitpickery LGTM \ud83d\udc4d \n. @peterberkenbosch there is a conflict, could you please resolve?\n@mamhoff no, that wasn't me, but this change here is great. @jordan-brough @jhawthorn besides rebase does this needs more work?. Thanks to your interest in solidus. \nCould you please ask such question in the Slack support channel? The github issues are for reporting bugs. You can join he Slack at http://slack.solidus.io\nIf you think this is a bug, we need some more information. First and foremost we need a reproducable test case. \n. :+1:\n. Thanks for pointing us here.. Thanks for the work on this. This is very much appreciated. \nI think we should actually put only the bare minimum of what's needed to get a store up and running into the seeds. And most importantly we should copy the seeds over to the seeds file of the host app, in order to be able to change things before seeding. Lots of stores may not using all of these return reasons for instance.\nThis means we should update the install task after we updated the seeds so it copies the seeds over instead of just running them, but this could be another PR.\nI'm fine with having one PR that copies all seeds from the migrations into the seeds now and accept another one that changes the install task.. @mtylty would you mind to rebase this with latest master? Thanks. Added some comments on the extension: \nhttps://github.com/solidusio-contrib/solidus_prototypes/commit/9c36e3e12ca1d008f9a367fcee43079d72cda5d1#commitcomment-19425150\n. @mtomov you have my full solidarity. I would like to port Alchemys image upload over to Solidus. It's heavily based on https://github.com/blueimp/jQuery-File-Upload. Will see if I can free some time these days. The current image upload is just ridiculous, but as many stores don't even use the build in image solution and use services like Cloudinary, there was not much demand for a better solution yet. But anyway, this needs to be fixed. \n@flyfy1 I don't see an easy solution. As others will also be bothered by this we should think about replacing this with a custom trigger or event that all our own XHR requests call when we do expensive stuff. Any thoughts @jhawthorn?\n. Yes. Thanks for that find. . Thanks!\n. Simpler it is. But I'm not sure if this is also optimal. But it's a good start to put this form either in an overlay/modal or use the space for some additional info. \n\ud83d\udc4d For the hints\nI would like to here what @Mandily has to say\n. Hey. Thanks for your interest in Solidus. \nThe Solidus I18n project holds all translations. You can find it here https://github.com/solidusio-contrib/solidus_i18n\nIt will be helpful to also read the Rails I18n guides (http://guides.rubyonrails.org/i18n.html)\nTo get started it will help you to copy the English locale file to a Nepalis locale file and start translating in your local app. Then contribute by creating a pull request. \nIf you have further questions please join the Slack at http://slack.solidus.io\n. Hey. Thanks for your interest in Solidus. \nThe Solidus I18n project holds all translations. You can find it here https://github.com/solidusio-contrib/solidus_i18n\nIt will be helpful to also read the Rails I18n guides (http://guides.rubyonrails.org/i18n.html)\nTo get started it will help you to copy the English locale file to a Nepalis locale file and start translating in your local app. Then contribute by creating a pull request. \nIf you have further questions please join the Slack at http://slack.solidus.io\n. Assigning for further review to our taxman @mamhoff \n. As a bonus, as we're already here we could also add required: true to trigger browser based validation. But this is up to you to decide. This is good as it is right now.\nThanks for your contribution \ud83c\udf6d \n. \ud83d\udc4d for removing jQuery.validate and replace it with HTML5 based validations. But this is just my 2 cents. Would like to here the others @jhawthorn @gmacdougall WDYT?\n. Thanks @jhawthorn\n. \ud83d\udc4d \n. Thanks for your contribution.\nI don't see any value in testing these descriptions. Especially if we hard core translations inside tests. That only means broken builds if we update a translation. \nThere is no business logic included at all that needed testing. \nSo, from my point of view we should just remove them. \n. Testing a random string has no value for me. Why don't we test all other strings then, why exactly these strings? Are they special, and when yes, what makes them special?\nThe only value I see is that we ensure all calculators inherit from Spree::Calculator. Why not test this then? \nSorry, still not convinced, but I don't resist on removing them. If anybody these value in them, please keep em. \nI only care about less burdens. \n. it_behaves_like \"having a description\" \ud83d\udc4d\nLike that\n. Sorry for being so picky!\n. @mamhoff you requested changes that where now made. \nWould you mind to review again? Thanks\n. @bbuchalter we still have the model validations. Front-end validations are just, and should always, be an UX addition for users. Also, the form we provide is only an example and most likely will never be used on production as is. Stores that care about front end validations on mobile Safari can easily drop in some JS lib. \nWe can not provide front end templates that will fit all use cases. They are very easily replaceable by stores and are just an example/demo of a minimal working store and not a one-size-fit-em-all solution. \n. @mtomov thanks! I will have a look later. \n. Hi. Thanks for your interest in Solidus and your contribution. It's very much appreciated. \nThis feature is better as an extension and is not something we want to have in core. It brings privacy issues, that not every store wants to deal with. \nSo, as core feature I :-1: this. But as extension this feature would be great, as this is good work.\n. If you have interest in maintaining the extension I can create a repo under https://github.com/solidusio-contrib for you. \n. @skukx done\nhttps://github.com/solidusio-contrib/solidus_geocoding\n. \ud83d\udc4d\n. @CallMeSH is it possible that you try out #1613 in you're app and see if this fixes your issues?\nShould be as easy as:\n```\nGemfile\ngem 'solidus', github: 'jhawthorn/solidus', branch: 'remove_require_tree'\n```\nThanks!. I'm also pro templates, besides that this helper is optional and it's easy to write you're own. I don't see any need to introduce a new config option here. \nThanks for your contribution, but we plan to reduce front specific code for future versions of solidus.\nSorry\n. This is awesome \n. This has been part of #2002 and can therefore be closed.. Great feature. Didn't had the time to loon into the implementation details, but this looks good on a first glance. \nOne thing coming to mind, though. From a UX point of view I'm asking myself why we don't always show the select box With the current one preselected. This spares some clicks and we could get rid of the extra icons. \nThoughts @Mandily ?\n. > The good thing about making every field in a table editable is that we can then get rid of the edit pages. (WOOHOO!)\nI don't think this a working for all tables. Often tables are just a list with little detail and the forms have way more options than ever will fit into a table row. Think of the product or order tables. For small tables I like the idea, though. Although I don't like auto save. What if the user change its mind or mistyped something? \nI like the current state with save and cancel buttons, although I think they should look different from the edit and delete buttons. It's very hard to tell for the user if the buttons currently visible are the edit buttons or save buttons. Maybe we should hide all buttons but the ones from the hovered row? Or we highlight the buttons if we are currently editing the row. I kinda like the first option. Would remove clutter from the views. . \ud83c\udf8a Thanks!\nI made a followup https://github.com/solidusio/solidus/issues/2042. much better. Thanks @jhawthorn \nLots of apps (Trello, Redmine, Alchemy) use the whole \"content area\" as an upload area. Much better to hit with your cursor then fiddling around with a small area, though. But this is fine for now and looks ok for me. \n/c @Mandily\n. Lovely @jhawthorn \ud83d\ude0d \n. Thanks @Mandily \ud83c\udf39 \n. > shouldn't we have some way of declining to save a credit card to a user's wallet\n\ud83d\udc4d Absolutely \n\nwe should have an active configuration option there\n\nThis should be an choice the user makes during checkout, neither we nor the store owner should decide on storing credit card tokens on behalf of the user without asking.\nWe should revert what was introduced in e891bf56dcbe188dd485e1a95da8445c23a9000e IMO and add a way to let users decide if they want to store there credit card for later re-use.\nLong story short, this PR is valid and ok IMO, but needs a rebase now that we introduced the wallet payment source.\n@peterberkenbosch would you rebase this? If not we could take over.. @cbrunsdon how do we want to approach with this one?. I think it's worth being mentioned in the changelog. Thanks. IMO bug fixes are also worth to be mentioned in a changelog. Someone might want to see if an update is worthwhile because the long awaited bug fix finally landed. . Hmm, I guess the minimum of three is I18n related? AlchemyCMS has a minimum length of three validation because of possible locales in the route. \nBut as Solidus has /products/slug-of-product as default product route I think it's ok to remove this, but I'm not 100% sure.. The solidus_i18n codebase adds the non-default locale to the routes, but that's prepended to the product route, so\n/de/products/slug-of-product would be the actual route. \nThat said I think it's safe to remove the length validation of the product slug. \n. Thanks. Using this fix in my demo app https://github.com/tvdeyen/solidus-asset-override-demo works \ud83d\udc4d . This actually needs to be deployed somewhere in order to confirm its really working. My demo app is a proof though, but I want to be extra sure \ud83d\ude0e\n. :+1: thought the same, but hestitated. . The day has finally come \ud83d\udc4f\ud83c\udffb. > Statesman is extremely opinionated and is designed to provide a robust audit trail and data integrity. It decouples the state machine logic from the underlying model and allows for easy composition with one or more model classes.\n@alepore this looks very promising. Thanks for sharing. \n. Thanks!. @gmacdougall would you mind to rebase again so we can merge this?. Absolutely ok. \ud83d\udc4d. Merging in favor of #1664. Violated the 24h blocking rule, because related to tests.. Thanks for contributing. Could you please provide some more background for this? That would help reviewing. Thanks. This is totally our fault as we never had a good way to override views in your app, until https://github.com/solidusio/solidus/pull/1681. Thanks. Who finds the verb can keep it. This can be solved by using Spree::Core::Engine.routes.draw\nThis issue is a duplicate of https://github.com/solidusio-contrib/solidus_reviews/issues/5 and should be solved at that extension. In the last core team meeting we decided to go with option 2 (removing the feature).. The test failures seem related. Could you please have a look? Thanks. Please try to copy the view from the v2.1 branch instead. You can either switch the branch in GitHub or use bundle open solidus_backend to open the gen in your local code editor. . @jhawthorn I see a fixup commit. Maybe you need to rebase once more?. \ud83d\ude80 . Just for the record: We should start to think about how we organize the admin order templates and partials. Ideally we have a template for each order state (or better tab). Having an edit template for shipment state is somehow silly.. Generally this is a great idea and as we already use HoundCI for Ruby linting we could enable their JS linting as well. \nBUT: As with every code style guidance there are religious wars to expect. That's why we want to reduce the linting to the absolute minimum. We don't want to run single vs double quotes, leading comma vs trailing comma and so on and so forth debates. \nAlso, we need to update the current code before we enable Hound JS linting as we would have lots of red PRs then. \nWe happely accept PRs that help us updating the exisiting code. After that is done there is nothing stopping us from enabling a automatic linter. \nThanks for mentioning . I opt in for let's add a Actions header.. Let me rephrase:\nIf we are putting the icons into the table row, then a 'Actions' table header would be preferable. \nBut I leave the decision on are we putting the icons inside or outside the (visible) table row (because technically they are inside) to @Mandily . The GitHub issues are solely meant for bugs. Please use Slack for seeking help.\nhttp://slack.solidus.io. @jhawthorn is this still something you are working on or can this be closed?. \ud83d\udc4d could you also enable javascript on .hound.yml then? \ud83c\udf70 . @Senjai you introduced the fix in 72f8a0cc5f334d91e5424c2b2ef37b63bfec2063\nCould you please review?. This also needs to be backported to v1.4 as this bug is also present in 1.4.0. Just saw that we need a fix for the missing \"empty role ids param\" in the users form and feature spec.\nLet me add this as well. @Senjai done. Oh. Thanks John. Let me rebase this. . @jhawthorn rebased. We decided to not back port this into 1.4 because of our release policy.. Who ever finds the verb can keep it \ud83d\ude05. > Fixing these should make the fonts even larger at the same time, which I think aligns with your goals \ud83d\ude04 .\n\ud83d\udc4d\n\ntruncating it like we do the admin email in the left hand column\n\nI don't think it's a good idea to truncate table headers. IMO they transport important information. But I may be wrong. I would like to widen the default container width from 960px to ~1080px instead. . Most ideally we would use the newly introduced full width layout everywhere, but this would cause adjustments to the search forms most of the tables have. Maybe introduce a max width container for the search form?. This could work. Alternatively we could remove columns that hold secondary information on smaller viewports. Hard to figure out which one is the secondary information though.. @Mandily First step taken https://github.com/solidusio/solidus/pull/1782. @Mandily @jhawthorn I removed the change of the body font size and fixed the sizing in fieldset and the navigation instead (see updated comment on top). Thanks for pointing me to this, John!. @jhawthorn yes, but before we do that we want to do some preparations with #1780 and #1786 \nOtherwise raising the font size just won't look good. . @Mandily please have a look at this.. > The third and fourth screenshots start to look a little odd to me with form fields moving around and empty space being on the left side of a row. Is there a way to clean that up at all without breaking extensions and shops as you mentioned above?\nNo. We would need to move fields into other containers and this would potentially break extensions or shops. \n\nAnd just to double check - is this replicable with the other listing pages as well?\n\nNo. Every listing page need its own treatment. \n\ndid you consider putting a max width on the search area so preserve the order/groupings of form elements a little better?\n\nYes, I did. I decided against because we would limit the space for potential search field additions. Some shops may add additional fields to the search form. By limiting the width we would reduce the possibility to add additional rows to that form. . We definitely should reconsider the layout of that form. It is not ideal and has some elements in strange places. \nBut: I wanted to make the changeset as small as possible. \nI think this is a great step forward with lots of room for improvement, sure. But better what we have right now. . @Mandily another preparation for #1777 . @jhawthorn I updated the commit and took a more conservative approach. Only table headers, the .actions cell and states have text wrapping disabled. Added a .no-wrap class, so we can decide which cells we want to have text wrapping disabled as well.\n\n. I like this a lot. There is still room for improving, though. For me it's hard to distinguish between changeable and \"not changeable\" currency. The only differentiation is the little black arrow. Maybe we could remove the background from the \"display only\" or use a different bg colour? Not sure.\nThanks John! \ud83c\udf7a . > We can also try to get out of that business altogether, but that's a bit more of an invasive change.\nWhy not let the user class provider handle this (in our case solidus_auth_devise could let Devise validate this email)?\nThat's definitely not something we should do in core.. I do appreciate all the hard work that has been put into this. Thanks for that. \ud83e\udd42 \nBut\nI think we have to tackle some other UI problems first before we start to make changes to this form. As we can see on the screenshot very well, we need to get rid of this centred strip like thingy first. \nEspecially on large screens this is not very efficient UI. Moving the form to the right of the screen could be helpful for this. Having a proper space for additional / secondary information is another one to be discussed before going any further with this IMO.\nBesides that I don't think dark background and boxes are a great UI for this forms. I know I was excited at first, but as I revisit this today I doubt this whole coloured boxy layout is an actual improvement for us. I like the grouping of fields from an UX standpoint, but putting them in dark boxes is not something I would consider a modern and appealing UI. \nWe could make the boxes white and make use of Bootstrap card headers to slightly improve this, but I'm still not 100% confident that this is the best we can do here:\n\nAll of this is another discussion we should continue after we addressed the concerns from above at first.\nAgain, I really appreciate the work put into this, but for now this is a \ud83d\udc4e from me, sorry.\nPlease don't feel personally offended Martin, as this is not meant as an offence against you or others involved in this. This is UI, one of the hardest thing in our job.. > ... the admin_layout feature has already gone to be too complicated ... I think that this should be reduced to a boolean for full-width.\n\ud83d\udc4d \nThere is some stuff in this PR that I would like to see as separate PRs:\n\n[ ] Reduce the height around the logo a bit to make it match the breadcrumbs height\n[ ] Remove .container definitions from Skeleton and use those from Bootstrap. > share the code to generate Order numbers, Shipment numbers, and Payment numbers\n\n@jhawthorn I also thought about this, but I think we should not make the assumption that all numbers generate the same way. \nThe only idea coming to my mind is to ask the NumberGenerator for #order_number, #shipment_number, #payment_number and so on. WDYT?. @jhawthorn addressed the issues. \nStill think this is valuable as order number generator on its own. Shipments and friends get their number through permalinks.rb and are not that visible to customers as the order number. \nLet's address this - totally valid concern - in a separate PR, ok? . @jhawthorn good idea. I needed to remove the possibility for passing options into Spree::Order#generate_order_number, though. But I think this was barely used anyway.. Thanks. > It might be nice to allow admins to filter the roles by any combination. Displaying those in checkboxes instead of a dropdown would work well for that.\nStores are able to add as many roles as they like. We can't know the number of roles a store has. That's why checkboxes won't work IMO, but we could try to use a multi select field.\n\nlist the form fields in the order of Email, Role, Member since\n\nYes\n\nrename the table header \u201cUsers\u201d to \u201cEmail\u201d\n\nAbsolutely\n\nThis could be a global thing for all list pages - Displaying the total number of records (in this case \u201c322 users\u201d) would be nice for an at a glance idea of how many people had been through the store.\n\nWould like to add this as a separate PR and then for all paginated tables, good idea \ud83d\udc4d \n\nAs noted by @jhawthorn in Slack, the table pagination is off, but he may be fixing that in a separate PR\n\nYes, this is already handled by #1844 \n\nOther filters that might be useful\n- repeat buyers\n- dropped cart users\n- location\n\nThese need extra information we don't have in all stores or are even tough to calculate. These are interesting filters, but belong more to an analytics or business intelligence tool IMO and are also very shop specific. I think we should only add the common information and filters on that table used by the majority of stores.\n\nOther information that might be useful for admins\n- link to last order\n- total number of orders\n- total number of dollars spent in the store\n\nI already thought of those. We then need to make use of the new full-width layout for this table, what we should do anyway. Let me try those.\nThanks for the feedback \ud83c\udf39 . > It might be nice to allow admins to filter the roles by any combination. Displaying those in checkboxes instead of a dropdown would work well for that.\nStores are able to add as many roles as they like. We can't know the number of roles a store has. That's why checkboxes won't work IMO, but we could try to use a multi select field.\n\nlist the form fields in the order of Email, Role, Member since\n\nYes\n\nrename the table header \u201cUsers\u201d to \u201cEmail\u201d\n\nAbsolutely\n\nThis could be a global thing for all list pages - Displaying the total number of records (in this case \u201c322 users\u201d) would be nice for an at a glance idea of how many people had been through the store.\n\nWould like to add this as a separate PR and then for all paginated tables, good idea \ud83d\udc4d \n\nAs noted by @jhawthorn in Slack, the table pagination is off, but he may be fixing that in a separate PR\n\nYes, this is already handled by #1844 \n\nOther filters that might be useful\n- repeat buyers\n- dropped cart users\n- location\n\nThese need extra information we don't have in all stores or are even tough to calculate. These are interesting filters, but belong more to an analytics or business intelligence tool IMO and are also very shop specific. I think we should only add the common information and filters on that table used by the majority of stores.\n\nOther information that might be useful for admins\n- link to last order\n- total number of orders\n- total number of dollars spent in the store\n\nI already thought of those. We then need to make use of the new full-width layout for this table, what we should do anyway. Let me try those.\nThanks for the feedback \ud83c\udf39 . @Mandily @jhawthorn this is now ready to review.. @Mandily\nSure. Will add them later, as I am on mobile right now. \nUntil then (and as a general tip):\nConsider to install hub - a great tool for GitHub related stuff (https://hub.github.com). \nWith that you can easily pull down a PR and run the sandbox locally.\n\nhub checkout <url-to-pr>\nbundle exec rake sandbox\ncd sandbox\nbin/rails server\n\nI always do this for reviewing layout related stuff. . @Mandily the screenshot above is already updated. . > - Could we change \"total sales\" to \"total spent'?\nAbsolutely \n\n\nCan we add a sort caret to the last three columns?\n\n\nThese kind of queries are usually better inside a business intelligence tool. I already felt uncomfortable with adding these columns in the first place, but thought they provide some nice extra information on users (the same we display on the sidebar of the user detail screens). \nActually I already tried implementing this, but it turns out that this is a quite complex query. Ransack (the tool we use for search, filtering and sorting) has no built in support for this. We would need to add complexity to the code base that I\u2019m not sure of want to have.\nWhat do you think @jhawthorn @cbrundson?. Data tables doesn\u2019t help us, as we only load 10 results per page and data tables requires all data to be present at once. \nEven their ajax feature won\u2019t help us as not the rendering is the problem, the searching and sorting of huge amounts of data (users x orders x line items) is a slow and complex query. And with that data tables can\u2019t help us. \nI will try to implement something and then we can decide if we think it\u2019s worth to keep in the core code base or if an extension would be something we should work on. . @jhawthorn @luukveenis @cbrunsdon would you mind to revisit this and come to a decisions wether we can merge this or not? As I think store credits should be an extension actually I am not the right person to take any decision on this :P . > we should use turbolinks.\nThat's something I really want to look into next. Now that our JS is better organized this should be easy to accomplish. . \u2705  https://github.com/solidusio/solidus/pull/1863\n\nI have been thinking the same those past couple of days, and even looked briefly at jquery.turbolinks\n\njquery.turbolinks does not support Turbolinks 5 and is not needed by us. There might be an extension or store that uses an old jquery plugin that makes internal use of dom:ready, but this is most likely very rare.\nExtensions and stores DO have to use Spree.ready in stead of jQuery.ready though. But this is a simple search and replace update.. @mtomov sure https://github.com/solidusio/solidus/tree/turbolinks. This is now ready to review. @cbrunsdon rebased with latest master and ready to be reviewed.. Like discussed in the last core team meeting we will ship everything that make Solidus admin compatible with Turbolinks, but do not enable it by default. Even not for newly created stores.\nThe chance to break something by an extension or usage of JS lib that is not compatible with Turbolinks exists and we do not want to maintain issues caused by usage of Turbolinks.\nUse at your own risk. \"It should work\"\u2122\ufe0f . @cbrunsdon rewrote the flaky spec.. Rebased with latest master. Superseded by #1886 \nAnyway, thanks for your contribution \ud83d\udc4f . \ud83d\udc4d \nFirst step taken by https://github.com/solidusio/solidus/pull/1880. @mtomov rebased turbolinks branch on master, now could you please rebase your branch on top of turbolinks?. @mtomov just rebased again with master, could you please rebase again and while your at it fix the typo in the commit message (\"Turobolinks\" vs. \"Turbolinks\")? Thanks!. @mtomov Thanks, but I still see the typo in the commit message. . On Arrays any? is o(n) while empty? is o(1). From the documentation:\n\nIf the block is not given, Ruby adds an implicit block of { |obj| obj } that will cause any? to return true if at least one of the collection members is not false or nil.\n\nThis may not be a problem here, as we most likely will not have very large Arrays, but why not use the faster solution if we could?. I already approved this PR, so I don't insist on this change. Still thinking present? would be the \"more correct question to ask\", but it won't matter in this particular case. So, \ud83d\udc4d . I'm shocked that the specs passed, although we changed find_by_param usages \ud83e\udd14 . @jhawthorn sure. \ud83d\udcaf\u2716\ufe0f\ud83d\udc4d. Thanks \ud83c\udf89 . @acreilly there is a rebase necessary. Would you mind to?. > Since this change here would only be on master, it shouldn't affect other solidus versions. The change that was made on solidus_auth_devise won't break anything for older versions since that route is not used anywhere and is technically broken if anyone tried to use it.\n@gmacdougall @acreilly is right about this. Do you have anything particular in mind why this or the solidus auth PR should not be able to be merged?. Will rebase on top of #1975 if we decided to make this change.. @mamhoff fixed. @jhawthorn rebased on latest master. Might have another look?. @gmacdougall here you go. Need to rebase after #2000 and #2001 were merged if we decide to make this change. Rebased, ready to review. Looks even better with #2040 \n\n. Rebased again. Still ready for review. Need to rebase #1975 if we decide to make this change. Closing as I plan to move all payment methods into the PaymentMethods module namespace instead, because of constant lookup issues in Rails in combination with STI.. @jhawthorn rebased on master and re-added the method_type key to the api response.. @gmacdougall done. \ud83d\udc4d Agreed\n. \ud83d\udc4f I really like the idea. \ud83e\udd14 \n```ruby\n\n\nSpree::Gateway::StoreCredit\n=> Spree::StoreCredit\n``. Closing. The Solution is to move all payment methods into thePaymentMethods(observe the plural name) module namespace, as Rails STI has mayor issues with class names having a module namespace that is also a class constant, likePaymentMethod` is.. > I thought I had to stay in the character limit\n\n\nThis character only applies to the first sentence. The description body (separated by a new line) can and should be as long as you need to explain the rational behind your changes. \nA very good read on this topic is: https://chris.beams.io/posts/git-commit/. @gmacdougall I did this https://github.com/solidusio/solidus/pull/2000/commits/9443aec724f3a9ffd05a8ff1838db0c4a697fc97 ;). No worries, this is a large changeset. @mamhoff made a great comment IRL about making the migration class available from the outside (eg. solidus_gateway). Will do that now.. @mamhoff done!. @mamhoff thanks! Fixed\nAlso now includes #2000 . > What about also grouping config rules by their namespace?\nThought about that as well, but hesitated because the relaxed ruby styles config is on the bottom and our own additions at the top, but we could change that though.. The local dummy test app uses sqlite as database, while CircleCI tests with posgresql.. > Could you remind me how to switch locally?\nNot possible through rake test_app as this does not allow to pass options to the dummy generator. But you should be able to invoke the rails g spree:dummy --database=postgresql independently. Not able to test this on my own right now, sorry \ud83d\ude2c But worth a try. I like the idea of provided selectable Store selector classes. \nWhy do we even still have this extension? Shouldn't we deprecate it?. Yes. There is some very weird table markup going on. Have a branch laying around that fixes some of these issues. We publish it soon. . I did not have published a branch yet because @graygilmore volunteered to continue working on this particular area. This whole page needs a serious and well thought overhaul. My solution was more like a hotfix. Mainly I calculated the row height by the count of stock locations. This is a weak solution and we decided to not merge this. . Yes. Should be addressed by #1867. One thing I discussed with @pascalj IRL was to add a form for capturing partial payments to the payments detail page. Introducing a modal (we did not finally decided to have in our UI now) for this rarely used feature seems overkill for us. \nPayment Detail page with capture events\n\nWe need to keep in mind that payments could be uncaptured and therefor do not have an Spree::PaymentCaptureEvent yet. But we still have the payments detail page, so we could still display the form and pre-fill the amount into the field\nPayment Detail page without capture events\n\nThe form should not be displayed if no money can be captured anymore (aka. the full amount of the payment is reached). We will discuss this in the next core team meeting. Thanks for the write up. Oh, this is actually an oversight on my side. The file should not be renamed. Fill provide a fix.. @alepore I'm fine with both approaches. What do others think?. We agreed in the core meeting to revert the filename change. Thanks.. Waits for #2076 . Prerequisite for #2075. @jordan-brough the tests in #2075 fail because the specs for Spree::OrderCapturing fail.. I will make a QA session tomorrow morning . Nice work @Mandily \ud83d\udc4f  \nSorry in advance - this is hence the nature of this change - a very long review comment \ud83d\ude1e\nI really like the new table style. Hence tables are a mayor UI pattern in Solidus admin there is still some work to do. \nWalking through the admin I found these issues:\n\n\nAll what @graygilmore said\n\n\nalign-center should be removed from nearly all tables (some examples below) or the header also needs to be centered (like in the \"Countries\" table -> \"States required\" column)\n\n\n\n\n\n\n\nSome tables has hard coded inline styles for padding-left or margin-left (like the \"Product Properties\" and \"Reports\" table)\n\n\n\n\nSome tables with a \"sorting handle\" miss an empty header column - otherwise the second column header looks misplaced\n\n\n\n\n\nWe should consider to top align all table cells. Tables that have more than one row though word wrapping look weird (like the \"Order / Payments\" or the \"User / Store Credit\" table)\n\n\n\nAgain, great work. Please feel free to contact me for help. Maybe we should even consider to split this PR up into smaller PRs.\nThanks for the great work!. @graygilmore @Mandily https://github.com/Mandily/solidus/pull/1. - [x] We redundantly declare vertical-align: top on table td although this is Bootstrap's default\n- [x] Sortable tables should have vertically centered table rows\n- [x] The reimbursements table of customer return is horizontally centered. It sits in a fieldset with align-center class.\nAll of the above are solved in https://github.com/Mandily/solidus/pull/2. @graygilmore FYI. Reminds me to continue working on #1842 \u263a\ufe0f. Potential duplicate of #2075 ?. Short term merge as this is actually a bug fix.. @graygilmore https://github.com/solidusio/solidus/pull/2143. > how will we handle Spree::Refund reason, which has to be present when the refund is created?\nI went with the naive approach first_or_create and a hard coded string. This is not ideal, but used by us already on \"Return processing\". \nIdeally these reasons would be handled by I18n, but this is a whole new story.\n\nmaybe it's better to call the method void_or_refund or something like that? Since try_void will also create a refund in some case it could be better to be explicit.\n\nI don't think the payment method should handle the refund.\ntry_void should only handle the void and if that fails let the payment handle the refund. So, the name reflects exactly what happens: Try a void and return false if that fails (for whatever reasons).\nThink of try_void being a little more conservative then cancel (the latter always voids, while the former only voids if the transaction is voidable).\nExample\nThe Payment\n```ruby\napp/models/spree/payment/processing.rb\ndef cancel!\n  if response = payment_method.try_void(response_code)\n    handle_void_response(response)\n  else\n    reason = Spree::RefundReason.where(name: 'Order was canceled').first_or_create\n    refunds.create!(amount: amount, reason: reason)\n  end\nend\n```\nThe payment method\n```ruby\napp/models/solidus_paypal_braintree/gateway.rb\ndef try_void(response_code)\n  transaction = braintree.transaction.find(response_code)\n  if VOIDABLE_STATUSES.include?(transaction.status)\n    void(response_code, nil, {})\n  else\n    false\n  end\nend\n```\n\nwe can maybe create a (configurable) class that handle this voiding logic so it is easily customizable into stores. try_void will just call this class.\n\nI would then move the whole payment cancellation flow into a configurable class. Since the disputable part of my idea is the \"refund if void fails\" behavior. Maybe some stores don't want that or want to keep the old behavior. \nWe could even move the old behavior into a LegacyPaymentCancellation class. \nWhat do you think @mamhoff @jhawthorn @jordan-brough @gmacdougall @cbrunsdon ?. A fix is coming with #2107\nWe still need to add I18n translations if we want to display something else then humanized class names. But it know does not just show \u201cPayment Method\u201d anymore. \nThanks for reporting! This is how release candidates and betas should work \ud83d\udc4c\ud83c\udffb. Ah, you already added the milestone. Thanks. > edit multiple items in the table and then save them all at once\nThis is where Backbone models in conjunction with Backbone collections really shine. . It is worth mentioning that a payment method that does not implement try_void yet will fall back to the current behavior. So, this is safe for existing stores.. @jordan-brough I fixed the refund amount. It now uses credit_allowed. > I am very much for this, but would like a dedicated changelog entry detailing that this is happening and what it means.\nIt means nothing to existing stores as all existing payment methods do not implement try_void yet. Besides a deprecation notice stores will not see any difference to current behaviour. \nBut I will add a note about the deprecation. @mamhoff @jhawthorn addressed your feedback. I like that! \ud83d\ude0d \nMaybe it's just me, but shouldn't complete be green? I assume shop owners love to see lots of green in their orders table.. The build errors are actually related to the reimbursements helper removal.. > Re: Re: Green\nThis makes total sense. Thanks for the explanation. . \ud83d\udc4d AMS is a pain. I like the explicitness of jbuilder.\n\nThe only compatibility concern would be stores which have overridden rabl templates (ex. to add additional data).\n\nWe could check if a .rabl template for current action exists, use that and print a deprecation notice.. I would like us to not promote class_eval as a way to extend this functionality, but provide an API instead. Example above. The quick switch item object could take a model class name and an array of attributes. This should be enough to implement the search on our side instead. . Or we could just use Ransack.\nTo take your example from above, I think of something like:\n```rb\nconfig/initializers/spree.rb\nSpree::Backend::Config.configure do |config|\n  config.quick_switch_items << Spree::QuickSwitchItem.new(\n    search_triggers: [:p, :promo],\n    class_name: 'Spree::Promotion'\n    search_query: :coupon_code_eq, # a ransack search query \n    help_key: :promo_code\n  )\nend\n```\n```rb\napp/controllers/spree/admin/quick_switch_controller.rb\nSpree::Admin::QuickSwitchController < Spree::Admin::BaseController\n  def find_object\n    quick_switch_item = Spree::Backend::Config.quick_switch_items.detect do |item|\n      item.search_triggers.include? searched_key.to_sym\n    end\n    if quick_switch_item && search_record(quick_switch_item)\n      redirect_to_url spree.edit_admin_promotion_path(search_record)\n    else\n      not_found(\"Could not find promotion with code #{searched_value}\")\n    end\n  end\nprivate\ndef search_record(quick_switch_item)\n    model_class = quick_switch_item.class_name.constantize\n    model_class.ransack(quick_switch_item.search_query => searched_value).result.first\n  end\nend\n```\nAlternatively we could use find_by as we mostly want to find exactly one record, but Ransack would be more flexible for users to extend this behavior.\nWDYT?. @kennyadsl @jhawthorn could you please re-review and give approval? I think all concerns are addressed and this feature is ready to \ud83d\udea2 . I vote against Capybara specs. Request specs for the controller should be enough. The feature is not business critical and feature specs for this particular feature will be hard to write and - even worse - brittle and hard to maintain. . @graygilmore would you mind rebasing again? @jhawthorn @kennyadsl are you fine with the changes addressed?. @graygilmore do you mind to write a simple feature smoke test? Thanks. We probably want to add a changelog entry. Closed in favor of #2163. > Backbone JS isn't initializing with that data\nCan we fix this then instead?. \ud83c\udf89  \ud83c\udf8a \ud83d\udcaa . WIP, but this is what I have right now\n\n. > but i guess we can do that in a different PR.\nUpcoming. Some people may find it weird that the actions are right aligned, especially on tables with unequal actions item counts\n\n\nI like it \ud83d\udc4d . Tooltip color also fixed now\n\n. Please excuse the poor GIF quality on the second image. The background is actually not gray ;). This is fixed by https://github.com/solidusio/solidus/pull/2075 in 2.4.0\nIf you want to use this today use the latest master in your Gemfile. Could you please add a changelog entry?. \ud83e\udd17. Just as a heads up. Besides the PR to this PR here I am working on updating all Backbone based views to also support submitting via enter key (where it\u2019s appropriate). One of the advantages is that the constant doesn't have to be loaded when loading the factories, only when you actually use it.\nI get the validation argument and first thought the same, but as our own test suite uses all of these factories we have confidence that they are valid ;). Already dealt with in #2236\nBut thanks. Pulling out Rails out of core seems like a good idea. . A lot of people make changes to the template, add static content or even dynamic content from CMS's, that should not appear on the products index template. Therefore I wouldn't make changes to this.. Somehow my comment is on an outdated commit.  Copy that here:\n\nMaybe for easier customisation we should add a\nrb\ncan? :reveal_api_key, @user\npermission?. > Because our default \"admin\" role is assigned SuperUser permissions they will be able to view all api_keys, a bigger change than I intended. Are we okay with that?\n\nRevealing should only be possible for the owner. But I\u2019m fine with Super Admins being able to reset the key. WDYT?. > With the SuperUser permission, that isn't possible. We give the \"admin\" role the :manage permission, which allows all actions.\nRight, the super user thing... Something we should think about changing in the future.\nOk, for now we should do what you are proposing in this PR and compare the ownership right inside the view for the revealing. For clearing and resetting I think we could use a permission. . @jhawthorn review again, please. Rebased with latest master and fixed conflicts. Short term merge, as there is no breaking behaviour. Quite contrary  . Will split into several smaller PRs. @Mandily @graygilmore FYI. > I don't think users benefit from having the information in the header visible at all times. That information is less important than that on the rest of the page, and it eats quite a bit of screen real estate.\nThe header mostly contains breadcrumbs and is therefore a navigation bar, not an information bar. I do believe that users will benefit from having the header navigation sticking at the top, like we have the main navigation on the left side sticking. \nThe actual change necessary is not that intrusive. If you are concerned about the change DOM position I could leave it as is and use a very high z-index value instead. but using the DOM positioning is strongly recommended, though.\n\nCreate actions like \"new product\" would live there \n\n\ud83d\udc4d on having navigable buttons (\"New product\" is actually a navigation action) inside the header is good UX IMO and that's why I consider a fixed header a good thing.\n\nas well as save and cancel buttons once a user was in those new or edit views.\n\nI would strongly argue against putting \"save\" and \"cancel\" buttons into the header, but this is another discussion actually. \n\nI also see some z-index issues.\n\nBesides the aforementioned date picker I did not found any more z-index issues. Could you please mention them, so I can investigate?. Thanks. Just saw, that this happens even in non sticky header branches:\n\nWill take a look. We decided to not have a sticky header. I'm \ud83d\udc4e for the same argument you already mentioned in #1796 \n\nAn admin might really want to enter \"SAVE MORE\" as their coupon code.. I have some difficulties to build this locally.\n\nFirst try in root of Solidus\nPulled fresh branch, ran bundle update and\n```\ntvd and ruby-2.4.2 in solidus/ on jhawthorn-dummy_app\n\u203a be rake spec\n\nSolidus api\nrake spec\n/Users/tvd/.rbenv/versions/2.4.2/bin/ruby -I/Users/tvd/.rbenv/versions/2.4.2/lib/ruby/gems/2.4.0/gems/rspec-core-3.6.0/lib:/Users/tvd/.rbenv/versions/2.4.2/lib/ruby/gems/2.4.0/gems/rspec-support-3.6.0/lib /Users/tvd/.rbenv/versions/2.4.2/lib/ruby/gems/2.4.0/gems/rspec-core-3.6.0/exe/rspec --pattern spec/**{,/*/**}/*_spec.rb\nRe-running migrations\nrake db:reset VERBOSE=false\nDropped database 'db/solidus_api_test.sqlite3'\nCreated database 'db/solidus_api_test.sqlite3'\n[...]\nFailures:\n1) Spree::Api::ReturnAuthorizationsController as the order owner cannot delete a return authorization\n     Failure/Error: delete spree.api_order_return_authorization_path(order, 0)\n NoMethodError:\n   undefined method `spree_path' for #<Module:0x00007f9ba9236288>\n # ./spec/requests/spree/api/return_authorizations_controller_spec.rb:57:in `block (3 levels) in <module:Spree>'\n\n[...]\n```\nFails with hundreds of errors. All the same. Seems to be routes related.\nSecond try in ./api\n``\ntvd and ruby-2.4.2 in api/ on jhawthorn-dummy_app\n\u203a be rake test_app\n[Spree WARNING] Missing migrations.\n[Spree WARNING] add_lft_and_rgt_indexes_to_taxons from spree is missing.\n[Spree WARNING] solidus_one_four from spree is missing.\n[Spree WARNING] Runbundle exec rake railties:install:migrations` to get them.\nDatabase 'db/solidus_api_test.sqlite3' does not exist\nCreated database 'db/solidus_api_test.sqlite3'\n```\nPrints warnings, but it builds successfully.\n```\ntvd and ruby-2.4.2 in api/ on jhawthorn-dummy_app\n\u203a beer\n[Spree WARNING] Missing migrations.\n[Spree WARNING] add_lft_and_rgt_indexes_to_taxons from spree is missing.\n[Spree WARNING] solidus_one_four from spree is missing.\n[Spree WARNING] Run bundle exec rake railties:install:migrations to get them.\n[...]\nFinished in 1 minute 56.92 seconds (files took 4.86 seconds to load)\n579 examples, 0 failures, 3 pending\nRandomized with seed 1494\n```\nThe same with ./core\nConclusion:\n\nBuilds successfully for individual tests suites, but fails from root\nThe warning about missing migrations seems to be wrong and we should find a way to avoid it\n. @brchristian would you mind to rebase this branch and resolve the conflicts?. Thank you. The problem is that the state is called cancelled in the source code and therefore the translation key also has to be cancelled. But we could revert that translation change for sure. . The problem is that the state is called cancelled in the source code and therefore the translation key also has to be cancelled. But we could revert that translation change for sure. . @rbngzlv we need a second approval. From @kennyadsl maybe? \n\nSorry, that this took so long and thanks for reminding.. Sorry that this took so long. Please feel free to ping us, if it takes too long for an approved PR to be merged.. factory_girl was finally renamed to factory_bot. Pulling it out into a separate PR makes sense. @mamhoff please rebase now that the factory bot rename is merged. Sorry that this took so long to be merged. Please feel free to ping us, if an approved PR takes too long to be merged.. > I can't imagine a case where the user will be willing to pay for that...\nAmazon has this \"Do you want to wait and have a single package or get items earlier, but with more packages/aka shipping costs\" thing\nI consider this a business problem that each store tackles differently. We should not make this decision inside of Solidus. Just add a free shipping method (backend only) an use that for the case you described.. Nothing is true for all businesses ;)\nWe try to not make \u201cright choices\u201d in code unless necessary. It often turns out that we are wrong in doing so. \nHaving free shipping for backend orders are possible. So you can easily get what you want in current versions of Solidus.\nDid you try to add a backend only free shipping method? It should appear on your pending shipment as an shipping option. \nDoes this work for you?. Thanks for the clarification. Yes, this is a confusing part of the system. \nActually this reminds me that I wanted to continue working on changing the shipments order view so it does less confusing things.\nGreat that you could make it working for you. \ud83d\udc4d . \ud83c\udf89 \ud83c\udf81 . :+1:. \ud83d\udc4f . We should not move the var declarations from top of the function body\u2019s. JavaScript var hoisting is doing this implicitly and by not having them on top can lead to hard to track down bugs. . > This also fixes the duplicate migration issue reported here: AlchemyCMS/alchemy-solidus#14 \nIndeed! Nice find @mamhoff \n. Updated this PR so that it is now possible to overwrite the class method allowed_admin_form_preference_types on the extending class in order to change the allowed fields. One have to provide their own preference field partials if they do so.. @mamhoff please review again. @mamhoff addressed. @kennyadsl could you please re-review and give approval? Thanks. @jhawthorn yes: https://circleci.com/gh/tvdeyen/solidus/160. Close in favour of #2404 . @kennyadsl made the requested changes. Build errors will be fixed by #2423. Build errors will be fixed by #2423. Build errors will be fixed by #2423. @kennyadsl made the requested changes. Found old unused translation keys and used them for the table headers.. Thanks for catching up on this topic. This is a long standing issue we have in Solidus. I like the idea of an event bus and think this is the right way to do it. \ud83d\udc4d \nHave you looked into ActiveSupprt::Notifications?\nThey seem to support everything we need from an event bus and ship with Rails. No need for an extra dependency and easy to adopt to.\nI never worked with them, so I can't say if there are any caveats or downsides I'm not aware of, but I think we should give it a try.. ### Firefox and multiple stock locations\n\nLooks the same on chrome. Using rowspan like this is not how we can solve this issue. The table needs to have a nested table for the stock locations. I already invested lots of time into trying to solve this issue and this is the only solution I came up with.\nFirefox with one stock location\n. @jhawthorn thanks. Addressed your concerns.. Since migrations are most of time part of deployment strategies I think it is probably not a good idea to add this as migration. Why not make it a rake task so then stores can decide when to deploy this asynchronously to their automated deployment?. Just for reference. Select2 also has autocomplete functionality. . It\u2019s a little arkward but it\u2019s doable https://github.com/AlchemyCMS/alchemy_cms/blob/master/app/assets/javascripts/alchemy/alchemy.autocomplete.js.coffee\nI am not saying we should use select2, but as we already have the dependency it\u2019s worth looking into it. . Thanks . @adammathys I agree, but was hesitant to refuse the PR because of that. But on second thought we should think about a solution to only action on eligible items.. Somehow this is now working for me. \ud83e\udd14 \nI guess because I had solidus_auth_devise 2.0 installed it fulfilled bundlers needs, but failed because we do not have deface installed anymore. Now that I have solidus_auth_devise 2.1 installed it works like expected. \nWe should consider to add >= 2.1 to the sandbox's Gemfile\nwdyt @jhawthorn ?. Closing in favour of #2599 . Ha. You are awesome. Merging ahead of our usual time period, as this fixes spec issues. . @bbuchalter maybe I was not clear enough. But your PR is not doing what you would expect it does. We need to keep it as it is right now. I am sorry, but this is not \"fixable\" by us. This needs to be fixed in Sprockets.. @brchristian no need to be sorry. The goal is very noble and it would be great to have a solution for this. . > This change will allow us to remove the decorator entirely from solidus_i18n \nsolidus_18n also takes the preferred_available_locales is the current store into account. What this PR is not. Do you plan to support this feature as well in core?. @jhawthorn \ud83d\ude18 . > Regarding ActiveModel::Dirty, I just want to confirm that the goal is to use it to check what the previous state was without having to assign an extra variable? (For example, when I use previous_state to make note of what the original state was).\n@jgayfer yes. Like I said not mandatory, but still worth trying, as we are duplicating AR behavior here. . @jhawthorn somehow \ud83e\udd14 I am missing that index on my database. Git log showed me that someone actually removed that index because of problems with the uniqueness constraints. Can confirm that the same index even w/o the uniqueness constraint is mitigating the performance problems in the same way the single column index does. . > Are we able to place state machine specific methods in their own class? I feel like that would make managing the model so much easier.\n@BenMorganIO a module would be fine \ud83d\udc4d But we agreed to add this after we merge these PRs. @jgayfer could you please revisit the failing specs?. Thanks. Note to self. Enable javascript syntax linting on HoundCI. We should be more descriptive then\n. Thanks. Thanks, Ben. @peterberkenbosch Bedankt, Peter! I added an online demo https://tvdeyen.github.io/solidus/. @kennyadsl made the requested changes. Working like charm \ud83d\udc4d \nAlso updated the styles to the new colors and fonts from the shiny new marketing site.. Extracted the fixes for guide files into #2709. @kennyadsl thanks, updated. The stembolt folks were working on a new guides site as well, while working on the shiny new website. I will close this in favor of the other PR coming up soon. Thanks for all the great feedback. We think about migrating the soon-to-be released guides site to VuePress as well. . @benjaminwil this needs a rebase.. A better place to ask these kind of questions is our Slack at http://slack.solidus.io/. @gmacdougall sure. Done.. There is unfortunately much more involved than I thought. Closing for now. Thanks. @jgayfer #2739 has been merged.. @jgayfer thanks. This needs another rebase after we merged #2747 . Thanks!. @jacobherrington I say give it a shoot. . Probably also an option is to use no framework at all. Flex box and CSS grids have broad support and are a good starter for a modern store frontend.\n. I am also in favor of using semantic HTML instead of using the bootstrap classes in our html.\nI also think it is fine to ship the Bootstrap grid as a \"default grid\", but use the Sass mixins to apply the grid to the semantic classes and not use the Bootstrap classes.\n. We should be able to keep the skeleton grid until the next version of Solidus and remove it later. Stores using it (very unlikely they actually do) have the chance to migrate to a grid system of their liking (even keep using skeleton by copy it into their app). \nWe should even be able to print out a deprecation warning with Sass if people are still using our skeleton file. . @jacobherrington no, all fine. We need a second review of a core team, then we are ready to go. . Swapping the namespace is not planned and has more disadvantages than advantages. Adding a depreciation warning to Spree.t would be great, though. Anybody?. > So, can we merge it? We need it in our project :)\n@sebfie PRs need two approvals from core team members. This PR is a larger feature that will need manual review besides code review. Since all core team members doing this on a voluntary basis and mostly in free time, please be patient. \nMeanwhile you can run a fork of solidus that includes this PR in your app. \nThanks for your understanding . From a quick glance into the implementation I have to say that this is way too much code and complexity for a minor feature. I appreciate the contribution and like the general idea of shipping cost refunds, though. \nAdjustments have downsides, yes, but have everything we need to build this feature. \nThe other thing is to consider an extension.\nAgain, I like the general idea of this feature and the work done is great \ud83d\udc4cbut we need to be sure that we want to maintain this code. . Reviewing this again we decided in the core meeting today that we do not want have this in core. We think this is lot of code for a very specific need one could address in an extension or their custom stores. Thanks for the contribution.. Thanks for pointing that out. Solidus 2.1 is out of support, but I will see if we still can cut a release. . Close. This is easy to solve by updating to Solidus 2.2. @skukx thanks. Absolutely. Error handling needs some overhaul.\nBut instead of change the way we log, we should think about adding a global error handler, because like you said we want to be able to report to error tracking services or log, or do both. Having an configurable error handler (that defaults to Rails.logger.error) would be a huge benefit. . > I love the config.logger option.\nI am fine with having logger separate from a error handler \ud83d\udc4c\n\nAt least in my experience, we log everything to Rollbar and Filebeat and to a log file. This would make it easy to tie into all three of those services with little effort and as things change with new reporters/services it would be simple to reconfigure things\n\nI don't see why this is not handable by one error handler in your project. \n\nAs an owner and maintainer of the project you've got the final say on this. \n\nI don\u2019t have. We need to have two approvals from core team members and if we agree on willing to maintain the multiple error handlers overhead, I am fine with this approach as well. \nPersonally I would still say one error handler per store is enough, but YMMV and I am happily accepting examples and like to hear from other core team members what they think. \n. I think you got me wrong. \nAs I said earlier I am 100% in favor of having a configurable error handler in Solidus. But IMO we don't need the ability to support multiple error handlers. Other may that mo differently and I am looking forward to their thoughts. \n--\nThomas von Deyen\nBr\u00f6dermannsweg 83 c\n22453 Hamburg\nMail: thomas@vondeyen.com\nTel.: +49 (0)171 7615474\n\nAm 31.08.2018 um 23:12 schrieb Taylor Scott notifications@github.com:\nAt least in my experience, we log everything to Rollbar and Filebeat and to a log file. This would make it easy to tie into all three of those services with little effort and as things change with new reporters/services it would be simple to reconfigure things\nI don't see why this is not handable by one error handler in your project.\nThe problem is that from our own project we can't send errors which occur within solidus.\nFor example:\nhttps://github.com/solidusio/solidus/blob/475d9db5d0291dd4aeddc58ec919988c336729bb/api/app/controllers/spree/api/checkouts_controller.rb#L26-L29\nSo within this rescue say we want to log the error to some 3rd party reporter. In order to do so, we'd need to override that method.\nThe ErrorReporter class allows us to tie into that. Whether that is by inheritance or by using the Composite pattern.\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly, view it on GitHub, or mute the thread.\n. @skux most error trackers I know hook into the exception class and not into the Rails logger. \n\nI think we need to discuss the two things separately. Logging and exception tracking are two different things. \n@ericsaupe this is an interesting thought that we should discuss further. . @skukx you are right. Let's get back to topic.\nI think having the ability to register several reporters is a actually good thing, the footprint is low but the possibilities are many. Thanks for the examples. \ud83d\udc4c \nBut I am still not convinced about the error reporter base class and repository. I think we can implement this with less code.\n1. The Solidus default reporter\n```rb\nclass Spree::ErrorReporter\n  def report(error, severity, _metadata)\n    Spree::Config.logger.send(severity, error)\n  end\nend\nRegister the default reporter\nSpree::AppConfiguration\n  ...\n  attr_writer :error_reporters\n  def error_reporters\n    @error_reporters ||= [Spree::ErrorReporter.new]\n  end\nend\n```\n2. A store having their own reporter\n```rb\nclass MyStore::PutsReporter < Spree::ErrorReporter\n  attr_reader :log_file\ndef initialize(log_file)\n    @log_file = log_file\n  end\ndef report(error, severity, metadata)\n    log_file.puts error\n  end\nend\nRegister the store reporter\nSpree::Config.configure do |config|\n  config.error_reporters << MyStorePutsReporter.new(File.open('log/errors.log'))\nend\n```\n3. For an extension\n```rb\nclass SolidusRollbarReporter < Spree::ErrorReporter\n  def report(error, severity, metadata)\n    Rollbar.send(rollbar_severity(severity), error, metadata)\n  end\nprivate\ndef rollbar_severity(severity)\n    level = Logger.const_get(severity.upcase)\n    [:debug, :info, :warning, :error, :critical, :error][level] || :error\n  end\nend\nRegister the extension reporter\nSpree::Config.configure do |config|\n  config.error_reporters << SolidusRollbarReporter.new\nend\n```\nSeveral things to notice here.\n\nWe should hold instances of reporters not classes.\nWe should not use the Core module namespace. This namespace is reserved for internal gem organisation not part of the public api.\n\nWe should split up this PR into two. One for the logger introduction, one for the error reporting. This helps keep focused on the topic :)\nAgain, super appreciate all the work going into this and I like to hear from other community members what they think about this.\n\ud83d\ude80 . @skukx you are right. Let's get back to topic.\nI think having the ability to register several reporters is a actually good thing, the footprint is low but the possibilities are many. Thanks for the examples. \ud83d\udc4c \nBut I am still not convinced about the error reporter base class and repository. I think we can implement this with less code.\n1. The Solidus default reporter\n```rb\nclass Spree::ErrorReporter\n  def report(error, severity, _metadata)\n    Spree::Config.logger.send(severity, error)\n  end\nend\nRegister the default reporter\nSpree::AppConfiguration\n  ...\n  attr_writer :error_reporters\n  def error_reporters\n    @error_reporters ||= [Spree::ErrorReporter.new]\n  end\nend\n```\n2. A store having their own reporter\n```rb\nclass MyStore::PutsReporter < Spree::ErrorReporter\n  attr_reader :log_file\ndef initialize(log_file)\n    @log_file = log_file\n  end\ndef report(error, severity, metadata)\n    log_file.puts error\n  end\nend\nRegister the store reporter\nSpree::Config.configure do |config|\n  config.error_reporters << MyStorePutsReporter.new(File.open('log/errors.log'))\nend\n```\n3. For an extension\n```rb\nclass SolidusRollbarReporter < Spree::ErrorReporter\n  def report(error, severity, metadata)\n    Rollbar.send(rollbar_severity(severity), error, metadata)\n  end\nprivate\ndef rollbar_severity(severity)\n    level = Logger.const_get(severity.upcase)\n    [:debug, :info, :warning, :error, :critical, :error][level] || :error\n  end\nend\nRegister the extension reporter\nSpree::Config.configure do |config|\n  config.error_reporters << SolidusRollbarReporter.new\nend\n```\nSeveral things to notice here.\n\nWe should hold instances of reporters not classes.\nWe should not use the Core module namespace. This namespace is reserved for internal gem organisation not part of the public api.\n\nWe should split up this PR into two. One for the logger introduction, one for the error reporting. This helps keep focused on the topic :)\nAgain, super appreciate all the work going into this and I like to hear from other community members what they think about this.\n\ud83d\ude80 . I think :manage is fine for orders and returns. It only makes sense to be able to create an order if you are also able to update it.\nPlease fix the specs. Thanks for the contribution . @jacobherrington @salbertson\nI agree. I appreciate their free service they provide for Open Source and promoting their service it\u2019s the least we can do to show this appreciation. \nBut I also see the list of badges growing into something very random. \nWhat about splitting the badges into two groups? As we are about to add the Open Collective soon, it may make sense to have a second badges row for \"Supported by\"? Hound would be a great fit for that badges group, no?. I also like the first version. . Thanks. It seems that we need a rebase with master in order to fix the build errors. . The Gemfile.lock is a dependency tree.\n. @fastjames a rebase with latest master should fix the build errors. Thanks. We have a policy of very stable branches. Even small changes may have impact on stores. Since this change does not affect the stability I am fine with it, but I am not sure why this change is needed. Do specs fail without that change? The factory_girl is still available. It hasn\u2019t been removed from rubygems AFAIK. Maybe we need to pin the specific version. . > @tvdeyen specs fail because they removed the FactoryGirl namespace at all in the latest released versions.\n@kennyadsl but not if we pin the version of factory_girl to 4.8.1, right? That's the last version that does not have all the deprecation notices in it. This should work well and is the least intrusive change for this branch IMO.\n@fastjames would you please revert all the FactoryGirl -> FactoryBot changes and just lock the factory_girl version? We should be fine then.\nThanks for the contribution. @kennyadsl This only produces a lot of deprecation noise, no? This might confuse people and make them think they should upgrade. Are there any notable fixes in 4.10 that we need?\nI am not opposed to it, just think we should reduce deprecation notices to a minimum.. @kennyadsl what happens if you lock the factory girl version in Solidus Auth Devise? Do they still fail? . > I'm afraid my suggestion was incorrect and locking factory_girl dependency in common_spree_dependencies.rb is not a solution since they are dependency needed for the solidus gem development and they are not considered as extensions dependencies.\nI think this change is still correct. If someone wants to build Solidus 2.3 we want the tests to pass. \nFor extensions though we need to make sure that the extension is using factory girl 4.8.1 if they run specs for Solidus 2.3. . > Yes but currently almost all extensions are built to work with all solidus versions, adding some extra code or branch in all extension is worst than change Factory Girl to Factory Bot in 2.2, 2.3, 2.4 branches here IMHO.\nExtensions already have code that distinguish Solidus versions.\nSee solidus_auth_devise as an example\n\nhttps://github.com/solidusio/solidus_auth_devise/blob/master/Gemfile\nhttps://github.com/solidusio/solidus_auth_devise/search?q=solidus_gem_version&unscoped_q=solidus_gem_version\n\nThe change extensions would need to make is not that hard actually.\nIn solidus_auth_devise it would be to add one line in the Gemfile\n```rb\nGemfile\n...\ngroup :test do\n  ...\n  if branch < \"v2.5\"\n    gem 'factory_bot', '4.10.0' # has both factory_girl and factory_bot in it.\n  else\n    gem 'factory_bot', '> 4.10.0'\n  end\n  ...\nend\n```\nand remove the factory_bot dependency from the gemspec.\nWe can also update the solidus_cmd Gemfile template, as Solidus 2.4 (the last version that still uses factory_girl) reaches EOL in May 2019 and we need to support it until then.. > In terms of the danger of doing that, I think it's just matter of specs so there could not be issues. If stores that still uses Factory Girl (and are importing solidus factories into their specs) updates to latest Solidus patch version (like 2.3.1) they will be forced to update to Factory Bot, but is that a real issue?\nIt think we should avoid breaking the builds of people upgrading a minor (or patch version) of Solidus, if we can.. @kennyadsl I will prepare a PR for solidus_auth_devise. https://github.com/solidusio/solidus_auth_devise/pull/130. ## Actually the fix is even easier\nJust use 'factory_bot', '4.10.0' for all Solidus versions. What FactoryBot feature of > 4.10 do we desperately need that justifies all the hassle?. > So the plan is to keep all extension locked to 'factory_bot', '4.10.0' until 2.4 reaches EOL. At that time we'll relax factory_bot in all extensions, right?\nSounds goo to me\n\nI'm just concerned on how to explain that to users that creates new extension, maybe a big comment in the extension template in solidus_cmd?\n\nIf I would start a new extension today, I won't care for old Solidus version anyway. Especially not the ones that are EOL soon.\n. > It should be mentioned in writing extensions as well.\nYes, do it. But keep in mind that Solidus 2.4 will reach EOL in 6 months anyway \ud83e\udd37\u200d\u2642\ufe0f \n\n@tvdeyen what about someone who works with a store that is on an older Solidus? They might want to build an extension and would care to support the old versions.\n\nEasy. Add factory_bot 4.10.0 to your Gemfile/gemspec. Done \n. > solidusio/solidus_auth_devise#130 is not needed anymore, right?\nIt is. Without that change it would load newer versions of factory_bot even for old versions of Solidus and fail. See https://travis-ci.org/solidusio/solidus_auth_devise/jobs/433011396#L789\n. This PR is not needed anymore, right?. Semicolons are totally optional in Javascript, that\u2019s why I think we should not change a bunch of source files. It does not provide any benefit but adding noise to git blame. And that alone is reason enough to reject this change. \nBut, I think we should think about adding JS linting to our workflow. But this is a whole different story. \nFor the scope if this PR I think we should not do it.. @ericsaupe the difference is that we proposing a change here that would preferable be disabled in a linter (because semicolons are optional even in JS) and we did not care in the past and should not continue to care about them. Being too strict with linters can harm contributions. We want only the bare minimum of style linting as possible. The same reasons why we have lots of Rubcops disabled. \nIMO We should:\n\nSet up JS linting\nDisable all checks\nEnable one check\nFix the issues\nRepeat from 3\n\nThat's how we did it with Rubocop and this is how we should do this with JS linting.. \ud83d\udc4d \nRepeating my comment from #2847 \n\nBeing too strict with linters can harm contributions. We want only the bare minimum of style linting as possible.\nWe should:\n\nSet up JS linting\nDisable all checks\nEnable one check\nFix the issues\nRepeat from 3\n\nThat's how we did it with Rubocop and this is how we should do this with JS linting.\n. I use the AirBnB lint rules as well. But we need to relax even more, because our current code will violate it all the time. \n\n\ud83d\udc4d for strong tooling. We still need to ensure to not scare contributors . > Is this user error?\nYes. You need to install solidus-i18n in order to get translations . I have, but this is a bigger change than you expect. We need to rebuild/rethink the whole stock management. Just \"fixing\" the table is not working.\nThe reason for the wrong alignment is that stock for stock locations are listed under the same variant. Add another stock location and you will see.\nOne possible solution is to nest a table inside (like Spree 3 does). But this needs lots of css trickery to look reasonable. I have a old branch laying around that tries to solve the issue. It\u2019s published here:\nhttps://github.com/tvdeyen/solidus/tree/stock-items-modify\nIt\u2019s old and still WIP and there are more commits somewhere on my hard drive. Will try to update the branch tonight. . I would even prefer that, but we would need to have some kind of visual guidance (ie. by a UI/UX person) for this, as this would be the first time that we introduce another way of displaying tabular data in Solidus backend and I would like to \"do it right\" instead of rush things in. We spent a lot of time into refining the backend we inherited from Spree 2.4. I don't want this new interface to look misplaced.\nI can make a proposal. Let's see what the others think about it.. This is what I have so far:\n\nModify stock instead of setting it's absolute vaule\nNested stock location stock items table\n\n\nBetter than I remember it would be. WDYT?\nThere are some specs pending, though.. @jacobherrington #2862 is now ready for review. Thanks @kennyadsl  I think so as well.. @ccarruitero thanks for the feedback.\n\nBut, I'm not sure we should allow the user just update the stock. I think will be better keep a record about why the stock change, maybe generating a stock movement, that way is more easy track an error when occurred.\n\nThis PR does not make any changes to our current stock API at all. It behaves exactly like before. It's only UI.\nThe only difference is that instead of passing the ?force=true parameter (to set an absolute stock value), it uses the default behaviour of our API that increases and decreases current stock by utilizing stock movements.. I updated the PR in that you are not able to create negative stock via UI. This is prevented in the API already, but I call this better UX if we check that already in the UI.. @jacobeubanks sorry, my bad. Now with the meta tag the admin does not scale any more on small devices. This is an issue for all tablet users, as long as we don't collapse the sidebar as well. I think we should fix that sidebar problem before we take care of the rest.. \ud83c\udde8\ud83c\udde6 as well \ud83d\ude04. > Should we only be testing extensions against versions that haven't reached EOL?\nNo. Although we have a rule of supporting as much as Solidus versions as possible, the amount of resources we are burning alone is reason to not to.\nIt does not make any sense to do not support the Solidus version of it, but still test the extension for it.. > should this toggle on http://extensions.solidus.io/ go away?\nYes. Very good catch. @stem a rebase with latest master should fix the build issues. . > Building this as an extension would likely require a Deface, which is far from ideal (and honestly overkill).\nAgree \ud83d\udc4d \n. That's a good idea\n. @kennyadsl worth noting, that most of the dependencies are dev dependencies then.. > I think we need to put that setting in a place with is also configurable by users with the other Spree::Money configurations.\nYes, I agree. There is also money-rails that has an install generator, that creates the above mentioned initializer in the host app. Although I don't like to add another dependency, I think we should at least consider it or implement our own generator during Solidus install.. Please ignore the failed Netlify checks. They will be green after we merged #2893 . Sounds great.\nMaybe add \"Conferences\" and \"Meetups\" as collaborative spaces?. Please rebase to get rid of the Netlify errors. . Please rebase to get rid of the Netlify errors. . We agreed on not to deprecate a private method. Merged because all PRs are currently suffering of breaking builds.. > I think you are right but we are already storing the credit card in the database\nWe store the payment source used on the payment, yes, but also we store it as default payment source in the users wallet. And this should not be the case IMO unless the user wants to. They should opt-in for this.\nAlso the additional configuration option in this PR seems to be very store specific and should not be in core IMO. What could be in core is a user account page that let the use decide which payment source that they decided to be stored is their default one. Having the store deciding this is wrong IMO.\n. > What about a class that each store can customize?\nWhy not replace add_payment_sources_to_wallet_class with your custom code in your stores config? \nMaybe it makes sense to extract the \"make payment method the default one\" into a method, that a store then can override?\nrb\nSpree.config do |config|\n  ...\n  config.add_payment_sources_to_wallet_class = 'My::AddPaymentSourcesToWallet'\n  ...\nend\nrb\nclass My::AddPaymentSourcesToWallet < Spree::Wallet::AddPaymentSourcesToWallet\n  def make_default\n    order.user.wallet.default_wallet_payment_source = wallet_payment_sources.first\n  end\nend\n. Thanks . > Lot of extensions are injecting assets expecting the backend directory exists, can we fix this somehow in your opinion? Different examples of its usage here and here\nGood point Alberto!\nBut it's not only appending to existing files. It's also about adding new files into folders for a) overwriting or b) introducing new templates and partials.\nThis change is huge in terms of its impact and should not be done before 3.0. \nWe should deprecate it first and then make the final move.. The move from factory_girl to factory_bot could be an example on how to make this transition.. @rymai would you mind to rebase with latest master to fix the build issues? Thanks. Thank you for your contribution . I like the idea, but we need to address stores not having the frontend installed. solidus_support uses  defined?(Spree::Frontend::Engine). Or add solidus_support as runtime dependency?\n. > I don't think this could work as is since solidus_support already depends on solidus_core.\nMmm, right. Is this actually necessary? We could assume that extensions or shops that install solidus_support also will have solidus_core installed, no? . Much better, thanks. Could you try to make the toggle as high as the header and the icon half the size, so it fits the rest of the icons?. As high as the logo and the breadcrumb. . I have a branch with a working prototype as well. Just tell me if I should send it to you.. @jacobherrington https://github.com/tvdeyen/solidus/tree/collapsible-nav. Ransack 2.1.1 is out. . It seems like ActiveSupport::Deprecation now checks if the deprecated method actually exist, what it does not in this case. \nAdding a simple alias_method :apply_free_shipping_promotions, :apply_shipping_promotions should do the trick.. > where did you find that?  I couldn't find any info about that in the ActiveSupport changelog\nJust my gut feeling \ud83d\ude0a. Even with that alias added I get lots of strange method missing errors. Seems like something big (autoloading?) is screwed up in Rails 5.2.2 \ud83d\udc4e . I do not think this is necessary. Ransack 2.1.1 is out and the missing method alias is our own fault. Will provide a PR. Emergency merge. @kennyadsl No. I need to make some more adjustments. Stay tuned. @kennyadsl ready \u2705 . Ideally we would only install gems that are necessary to build the docs (namely yard), but this would make it necessary to alter the install command on Netlify. Anyhow the gems are cached and this is working for now. We can make this change later if we want to safe some resources \ud83c\udf33. @kennyadsl thanks. \nI was able to disable all gem groups we don't need with setting the ENV var\nBUNDLE_WITHOUT=core api frontend backend utils ci\nin the Netlify admin.\nThis should safe some resources \ud83d\udc33 . By grouping all gems I was able to reduce the gems needed to install to just yard \\o/\nhttps://app.netlify.com/sites/solidus-docs/deploys/5c2de220b7945d0008107d6c. With that gem grouping change we should be able to only install the gems needed to build the current sub project. Currently we are always installing all gems for each subproject. I will prepare another PR to make the changes.. I don\u2019t see any advantage in changing the namespace either. All points @patleb brought up are valid concerns and no pro argument can circumvent them. \nThere are far more pressing problems to solve for us. This one is not on my list. . @spaghetticode I agree with @mdesantis here.\nOnly because the ActiveSupport::Notifications is our current implementation we should not use its interface to design ours and not tightly couple us to it. Rather abstract the interface into something that can easily be used in our code case and is adapter agnostic. All the integration work should be done in the adapter instead.\nI am in favor of \n\nRenaming Spree::Event.instrument into Spree::Event.fire\nMake it a simple call that does not wrap code in a block\n\nSo the only change we need to make is add a single line into the order finalize! method:\nrb\nSpree::Event.fire('order_finalize', order: self)\n. I am a huge fan of the second solution. There must be no way to add products to an existing shipment but through the cart. I even have an (outdated) branch laying on my hard drive that removes that select from the order shipments tab. Will open a PR.. @kennyadsl Chrome I assume? In Firefox the links have no pointer. I guess they removed the default pointer for links and leave it to the site designers to use pointer cursors. Anyway, not important for this PR something we should think about later.. > On Payment capture, on the after screen \u2014the icon in the middle shouldn't be a blue check mark? Same as Payment save, on the after screen.\n@aitbw no, I changed that on purpose. Having a checkmark could be confused with save and I thought a commonly understood icon would fit perfectly here for the task of \"ok, collect the money\". We already use the thumbs down icon for rejecting failed payments.. \ud83c\udf89 \nThe correct link https://hub.docker.com/r/solidusio/solidus-demo. Maybe now is a good time to move all sidebar related stuff into it's own folder spree/admin/sidebar?\nspree/admin/sidebar\n  |-- _header.html.erb\n  |-- _menu.html.erb\n  |-- _footer.html.erb\n. Maybe all sub menus should stay in one folder spree/admin/sidebar/sub_menus?\nspree/admin/sidebar/sub_menus\n  |-- _products.html.erb # and use plurals here ;)\n  |-- _promotions.html.erb\n  |-- _stock_items.html.erb\n. You should tweak the logo instead. Add some padding in the image, for instance. Lots of shops change the admin logo, so all would have to deal with this. Not ideal IMO. \n. Removing this breaks styles of third level navigation in the right content area.\n. Since this is not the global nav.menu style anymore, we should keep these styles and rename the class to nav.content-sub-menu. But this means we need to change the html class of the content sub menu, which could break overrides. \nSo, the best would be to keep them as nav.menu IMO, although this naming is misleading.\n. With removing the .inline-menu styles you have default margin and padding of ul back in, which causes the #content-header to change height, dependent from presence of an inline menu.\n\n. If we're already renaming and moving stuff (what I like), we should rename this method into normalize_quantity, because that's what it does.\nPS: And please add a new line after the private. My dear eyes are bleeding.\n. I wouldn't call set_price implicitly. I would add this to the before_validation call, because more explicit.\nAlso, you can remove the redundant self. here. Although not activated, make the hound happy :)\n. I would be more explicit in the naming here. \"Set the price from what?\"\nWhy not name this method set_price_from_variant?\nIt's a little bit weird, that this method does two things, from two different callers. Ehy not let this little fellow just set the price? And the currency can be set from somewhere else? From inside def options= for instance? Then you can spare the first argument and it's more clear what this method does.\n. currency is already set here, you don't need to pass it into set_price\n. I don't think you are right. Since currency= is an attribute setter method already defined by AR, it's getting set instead of a new local variable is used. That's why self.currency = is redundant usage of self ;) But, I can be wrong.\n. With a fixed position we get problems with smaller screens (like my 13\" MacBook Pro) and large sub navigations, like the products tab:\n\nWe even can't make the sidebar scrollable, since the flyout would overflow and cause horizontal scrollbars. So, we need to stick with absolute positioning. \nI'd really love to have sticky main navigation, but the downsides are too large, I guess.\n. Wordpress uses Javascript to toggle between position: absolute and fixed, dependent on the scroll position. Interesting approach. Like this. \nDo you mind to have some little more Javascript in the admin?\n. Sorry, just pulled your branch and reloaded the browser and this was the first thing I saw :blush: \nNo, a CSS only solution won't work. (Where is position: sticky, if you need it ^_^)\nI really love the Wordpress approach, it feels very natural. But this is not affix, right? Because it sticks to bottom as soon as you reach the maximum height of the sidebar. Very neat.\n. Just playin' around with https://github.com/bbarakaci/fixto\n. This is one of my favorites so far :disappointed: \n. Maybe use Spree::StockLocation.model_name.human instead?\n. :sob: \n. Shouldn't we change this to ||= because without that the US is always the default country while seeding?\n. It would be really awesome to read the colors from the variables file, so they won't be needed to be updated in two places, once you update a value. \nI found a comment from the sass maintainer that could be helpful with this: https://github.com/sass/sass/issues/1246#issuecomment-42895688\nJust a thought. \n. Since you only need the index route I would either use only: [:index] or just use get here. The additional routes rails generates are not harmful, but clutter up rake routes and could lead to confusion. \n. There is also this: https://viget.com/extend/sharing-data-between-sass-and-javascript-with-json\n. Please don't use capitalize here, because that changes how every single word looks on the admin tabs. Especially plugin maintainers and users of foreign languages may not want to have every single word capitalized. This should be handled inside the locale files. \n. As you can see perfectly on \"Go Back To Store\" ;)\n. Come on, its 2015/16 require_relative is a thing ;)\n. Don't you want to call OrderAdjuster here?\n. missing Core:\nruby\n@stock_configuration ||= Spree::Core::StockConfiguration.new\n. Please remove the translation here and let rails do it's work. \nI know, that the other form fields still has the unnecessary translations in their labels and this is out of scope here, but we should not introduce even more too generic and context-less translation keys. \n. Please, let's us start to keep the Rails way and use the attribute translations of the ShippingMethod model. \n. Ditto \n. @item and @order should be attr_readers, so the TaxHelper module and potential sub classes don't rely on reading instance variables.\n. after introduced we should use the item attr_reader here and not use instance variables.\n. I find it good practice to name caching instance variables after the methods name and use an underscore to make it more visible, that this is not a normal instance variable. So, the name should be @_rates_for_item IMO. \nAnd we should also use the item attr_reader here.\n. Same as in item adjuster. Use a attr_reader for order\n. This is exactly why we should use the order attr_reader. The module shouldn't know anything about an instance variable set in the including class.\n. Here the same rule for naming caching instance variables applies\n. also caching variable name\n. A prime example why we need the order attr_reader \n. ruby\nexpect(adjuster.order).to eq(item.order)\n:heart_eyes: \n. To avoid errors like this in the future we could use the transition in the test. \nfill_in Spree::Country.human_attribute_name(:iso_name), with: \"BRL\"\n. Short local variable names for one liners are ok IMO, but I'll vote forv\n. Short local variable names for one liners are ok IMO, but I'll vote forp\n. If we're here, why not follow \"given, when, then\" and put this into a before block? option_type1 could even be a let!\n. Same here, I would rewrite this with a context, a before block and a let!(:option_value_1)\n. Would change this to let!(:product) into the already present context\n. Would use a before block\n. My preference is { |p| p['name'] }\n. This was actual code? :scream_cat: \n. \ud83d\ude0f\n. IMO we should use Spree::StockLocation.model_name.human here. This avoids duplicated translations.\n. Yes, I used LineItem as new home for item_description. Looking at the table, you will see there are items described\n. Indeed\n. To be more clear about this:\nerb\n<%= f.label :stock_location, Spree::StockLocation.model_name.human %>\nIf this also fixes the select2 label problem, great\n. This is not needed anymore. See comments above\n. I don't think this will work. The first argument needs to be an attribute on the object (Spree::CustomerReturn here).\nSo,\nerb\n<%= f.label :stock_location_id, Spree::StockLocation.model_name.human %>\nit is.\nedit: changed back to stock_location_id, because that's the attribute the select uses.\n. I'm ok to not use the properly version, but then we don't need a rails form builder at all. So, for correctness and to avoid confusion, change it to this:\nerb\n<%= label_tag Spree::StockLocation.model_name.human %>\n. Have you tried to use a nested label?\nerb\n<label>\n  <%= Spree::StockLocation.model_name.human %>\n  <%= f.select :stock_location_id, Spree::StockLocation.order_default.to_a.collect{|l|[l.name.humanize, l.id]}, {include_blank: true}, {class: 'select2 fullwidth', \"data-placeholder\" => Spree.t(:select_a_stock_location)} %>\n</label>\n. Exactly. I didn't want to change the original appearance of the page. We can change that later on, as label would be the correct attribute. \n. Why only update this table header? Why not all?\n. I'm not shure about this one. I don't like to set grammatical order in views like this. Imagine a language where numbers always follow the word. This way these languages are not able to do so. \n. This one here needs to be changed. This is perfect example for setting grammatical order in views and nobody can translated this into correct grammar of the language. The comma, the bang. Everything has to go into one translation key with interpolation variables. Everything else is just pretending I18n\n. Every time I see this in our shops, translated to a German sentence, I start shrugging. \nThis is maybe out of scope of this PR, but we need to address this one. Just wanted to point the attention to this one here. \n. Isn't the label argument redundant, since the tab helper uses the first argument as label anyways?\n. Is this a real world use case? Shouldn't we test different rates for each zone? I.e.: 6\u20ac in German zone, 12\u20ac in EU zone, 20\u20ac for world?\n. The comment says default nil, but the code 'us'\n. Is this deprecated?\n. I don't understand why you want to load the country by iso if the find by id returns nil\n. Better use Spree::TaxCategory.model_name.human here\n. We currently do a bunch of work to use model_name.human everywhere. So introducing a new rma key is not preferred here. So we should change the translation of the mode name here. Although this will have wider consequences. \nUsing the admin.tab scope would be ok for me. \n. I already love you for this one\n. Please remove this space. This should be in the translation, not here\n. Add the removed space from above here\n. Yup.\n. Make it spree.account_path to make it work in other engines and I'm :+1: \n. This theme should be called solidus\n. @adammathys you are totally right. \nBut in this case we need a trusted interface and S.P.O.T. of TaxRate#compute_amount. \nThat interface will not change for a long time (we can ensure that, because we own it). \nThe internal implementation will change, though. But that's ok.\nIf we ensure that the public interface will not change, then violating the rules here is safe IMO.\n. Yes, I support that @mamhoff \n. Maybe not everyone intended to change the line item currency and something else change it. Without knowing that, the current warning could be misleading. \nWhy not just: \"The line items currency is different from it's order currency. This behavior is not supported anymore and will be deleted soon.\"?\n. I like to write this as where(\"#{Spree::Price.table_name}.valid_from <= ?\", date) nowadays.\n. I would like the scope to be called Spree::Price.default_prices or similar\n. Can you write this more explicit as Spree::Price.default_prices?\n. If you want this scope to be called elsewhere, you need to include with_deleted scope\n. also here you need to include with_deleted scope\n. sweet solution :lollipop:\n. As I read this now, I would like to have the scopes inside of Spree::Price.cache_key\n. \"ask, don't tell\" ;)\n. couldn't we spare the .sort as valid_before already has an order?\n. This has possible implications I can't even imagine. But maybe I'm just anxious, since cache_key is called very often. @jhawthorn thoughts?\n. we really need to explain, why we use with_deleted all the time on the prices.\n. Isn't this just:\nruby\nprices.valid_before_now.where(Spree::Price.table_name => {currency: currency})\n. And this:\nruby\nprices.build(currency: currency)\n. If we deprecate stuff, we should at last implement the old, but wrong behavior.\nruby\ndefault_price.currency = currency\n. Maybe also change the deprecation warning to something more explanatory.\n. Isn't this better a column default in the database?\n. Shouldn't we add default: \"NOW()\" here, so we can remove the after_initialize from price?\n. Apparently this won't work in active record schema files.\n. in_currency(Spree::Config.currency)\n. That's nice!\n. Do people depend on that instance var?\n. :smirk: \n. I would prefer GitHub Links, so the interested one could read the source code/README right along.\n. Note for future: This should be handled by I18n\n. Yes and to ensure that always the global value is used and never a local one. Globals are bad, but it was global befor this change, so it's ok to make it more explicit here. We should change that on future versions to Spree.current_order_number\n. Shouldn't we remove all empty content_for :page_actions blocks? Or do we want to keep them for potential deface overrides?\n. Or just remove them. I don't think it's \"good practice\" to deface content_fors, right?\n. Ah, you're absolutely right. We check with content_for? :page_actions and only render the div if something is present. We could remove the check or advice people to add content_for :page_actions to their overrides. I would vote for to go with latter. It was never guaranteed that this div exists anyway. Thoughts @jhawthorn ?\n. Why not make it private then? ;)\n. Please put this into a constant. We don't want \"magic values\" in our code base, right?\n. I talked with @mamhoff and we think the Regex constant should be called RUBY_NUMERIC_STRING, so the reader knows what we want to check here.\n. After we remove this deprecation we should refactor this whole method ;)\n. Aight\n. We should consider to call this class DefaultPaymentBuilder as we actually don't add something, we build something. Otherwise great!\n. I no this name too strictly named after where it's called from. I think it should be named more like what it does. My English vocabulary is limited, so I only came up with Spree::Wallet::Storer. But, besides that I really like the way we are going here. Configurable POROs that are responsible for the actual implementation. \ud83d\udc4d\n. I wouldn't use relative URLs here, because READMEs get read outside of GitHub as well and GitHub is smart enough the parse absolute links relatively.\n. Is this intentional to disable the delete link here?\n. Would be great if we could follow rails convention here and put this into a _price partial and render the @prices collection. \n. \"Currently valid\" seems like a strange translation for is_default Boolean. I can't imagine what this does. \"Currently valid\" sounds like something date related. Do we plan to support time based pricing in the future?\n. That's not true. Rails adds a for=\"id-of-checkbox\" to the label. So this works fine ;)\n. I think we miss a link_to here?\n. WAT? aggregate_failures is just awesome and I didn't know, yet? Thanks\n. render_admin_breadcrumbs sounds better, I think. \n. Typo. It has to be \"Questions?\" ;)\n. Nice. Thanks \n. If text formatting is the reason for using raw, we probably should use sanitize here.\n. It's often better to use duck typing instead of class comparison.\nruby\nif num.respond_to?(:gsub)\n. Wouldn't detect have the same effect? \nAlso, I think you don't have to cast strings on type  Your hash keys are all strings already. \n. Oh, nasty. You have the early return because you return empty string below if a number matches.\nI would prefer .select {...} || '', but it's on you to decide\n. Why not take the Regex from ActiveMerchant instead of copy it over. This way we have to always have to have an eye on this. \n. .detect obviously \ud83d\ude44 \n. I think you also want to correct the indenting here\n. >= 2.2.2\n. Thank you\n. Please expect ActionMailer::Base.deliveries to be present instead of stubbing implementation details. Thanks\n. A great start in email testing are the Rails guides http://guides.rubyonrails.org/testing.html#testing-your-mailers\n. Please don't hardcore English in table headers, always use the model attributes translations.\n. As Clarke already mentioned, please return a symbol as status and pass the status here to Spree.t with a meaningful scope (ie. promotion_code_batches.status, so this can be translated in foreign languages. \n. Haha. Great. Much better to read and understand \ud83d\udc4f\ud83c\udffb\n. I like to use aggregate_failures when using multiple expectations \n. You can even put the whole describe block including the subject in the shared example so that you only have to leave it_behaves_like in the calculator specs. \n. I think expecting a String would be better. Every enumerable has a size method. \n. The term helper would lead to the impression that this file provides some preparation or tear down related stuff. \nWhy not call this file shared_calculator_examples or we could add another folder shared_examples and put a calculators file into it. \nWDYT @cbrunsdon ?\n. Please pass the placeholder value through I18n.t and preferable use a key with a leading period, so the key gets scoped to this particular view. \n. I think it should be enough the link to the 1.3 blog post.\n. Please remove this outdated comment\n. If the column is gone, there is no need for this anymore, right? Maybe we should keep the column for at least one minor version instead?\n. Maybe we keep the column for another round?\n. Why not use Rails' send_file here? Then you can spare to set headers, Rails does this for you.\n. Please don't invent your own translation keys, if Rails already has one for you.\nUse Spree::PromotionCodeBatch.human_attribute_name(:COLUMN_NAME) instead.\nThanks\n. wrong indention\n. Normally this header should be translatable, but this view could also be overwritten in the host app. So, I'm not super keen about it.\n. Since we don't use this ID anywhere we should rewrite this into a data-hook attribute, if I assume correctly that you added this for all the defacers out there.\n. Rails already has i18n scopes for mailer subjects. This mailer has the scope: \nen:\n  spree:\n    promotion_batch_mailer:\n      promotion_code_batch_finished:\n        subject: \"Your batches are ready!\"\n. I don't like to hard code the body in here. Please let's use mailer views as for all the other mailers.\n. Same here: We shouldn't hard code the body in here. \n. Same as above: We don't need to introduce our own i18n scope.\n. Ok, you are passing the id in here. That's why you need you own translation scope. \nHmm, I doubt that any user has a real understanding where this id is coming from and what to do with it.\nMaybe a link to the failed batch in the admin would be much more useful. And this correlates to my former comment: Let's use mailer views instead of a hard coded body.\n. This concatenation can not be configured anywhere, right? We should make this configurable, as I already tickets in my backlog (\"remove the underscore form promotion codes\") \ud83d\ude06 \n. \ud83d\udc4d great catch @cbrunsdon \n. Since this was just moved from old implementation, I'm fine with keeping it. \ud83d\udc4d \n. Running the migrations has no effect on a vanilla rails appandcan be omitted here. Is this extra step really needed? I presume that the install generators already install these migrations? Or are there any additional migrations from other engines needed?. Voil\u00e1 ;). Sure the db:create is mandatory. I meant the db:migrate, sorry or being unclear.. Haha, my French teacher will kill me... ImageMagick. As spring is cause of lots of headaches, we should not promote its usage here, no?. sh\necho \"export DISABLE_SPRING=1\" >> ~/.profile. Forgot to remove a trailing comma. Why, is bundle exec causing any problems?\nRemoving this could be cause of conflicting gem errors, using the bin/rake (or even better bundle exec, because of a possible spring binstub) would solve this, no?\n. Is it possible to link these?. > ~~Spree~~ Guide on using Engines\nRails Guide on using Engines. Maybe explaining the spree vs. solidus incidence in the introductory section would be helpful to understand the differing file names especially for the unaware.. Maybe mark this as side note or tip. Do we recommend the usage of Deface?. I think it's kinda dangerous to link to the spree guides. We can't rely on them being online forever.. Good advice, but unnecessary IMO. Nah, this is too harsh. I think we can just remove this line. It's not necessary to use the Spree module namespace and can even lead to strange issues. \nMaybe just use none or module YourStore. Great usage of Module.prepend\n\"No more class_eval\" \ud83d\udc4c . I think you don't need to explain Module.prepend here. Maybe link to a good article?. Also mark this as \"tip\" or \"side note\"?. Could you please remove the call for pull requests? This is a little bit too \"loud\" ;). You already required this in L15. This sentence is a bit hard to read. Maybe:\nIf an order's tax_address falls within a zone its tax rates will apply to all line items and shipments with respectively matching tax categories.. On our website we say eCommerce. > They do not change the amount of a line item, but are added just before calculating the order total. For Sales tax, the prices for items do not change when adding them to an order.\nYou basically saying the same thing twice. Maybe:\nFor Sales Tax the item prices do not change when adding them to an order. Instead they are added on top of the item price just before calculating the order total. . > See the example section at the bottom for examples.\nSee the example section at the bottom.. I think we should not advocate one taxation service over the other. There are more options then just Avatax.. > whether the tax rate represents a Value-Added Tax (VAT).\nwhether the tax rate represents a Value-Added Tax (VAT) or not.. > which are then used find the taxation rate\nwhich are then used to find the taxation rate. > The Solidus default is to treat everything as exempt from tax\nI actually had to look up \"exempt\". This guide is not only for native speakers, so we should use \"easy language\" for this already hard topic. What about:\n\"Per default Solidus assumes that all prices are without tax.\". > Only if a product has a tax category set, or there is a global default tax category, will products be taxed.\n\"Only if a product has a tax category set, or there is a global default tax category set, products will be taxed.\". > Solidus does, however, allow you to use the billing address to determine the zone.\n\", but Solidus does allow you to use the billing address instead.\". > that calculates the correct tax amout \n\"that calculates the correct tax amount\" . > It is suitable for both sales tax and price-inclusive tax scenarios\nIt is suitable for both sales tax and vat tax scenarios. > To learn more about tax calculators\nIf you want or need to change the default tax calculation behavior, please have a look at .... > adjustments inthe \nadjustments in the . > Every time an order is changed,\nEvery time an order is changed (ie. while proceeding the checkout). > In VAT-style jurisdictions, taxes have to be included in the price shown to customers (in index and product display pages as well as when adding them to the cart).\nIn VAT-style jurisdictions prices have to be shown including the taxes to customers. That's even true for all index and product display pages as well as when added to the cart, not only during the check out.. > In order to configure this, you need to first configure your tax rates, categories, and zones, and then update your products and variants with the \"Rebuild VAT prices\" checkbox checked.\nIn order to comply to this requirement, you first need to configure your tax rates, tax categories, and zones, then update your products and variants with the \"Rebuild VAT prices\" checkbox checked.. The purpose of this is that the admin does not have to handle net prices, no? So maybe explaining this helps to better understand this admin_vat_country_iso thing.. Yes\n\nwhere each shows different prices to accustom for the different VAT rates in either country\n\nwhere each store shows different prices to account different VAT rates in either country. Maybe we should mention the introduction about \"Prices have to be displayed including VAT to the customer\" requirement from above here, so the reader has a better understanding why this whole cart_tax_country_iso  is actually needed?\nMaybe:\n\"Remember the requirement to display the prices including vat from above? This is how you comply to this...\". Maybe additionally explain the need of both rates have to be linked to the \"Clothing\" tax category?. These \"Examples\" are for Examples -> Sales Tax right? Then the heading needs to be #### Examples. I think we can just remove the heading, because you are continuing the examples section from above, no?. > This tax amount is then applied to the line item as an adjustment.\nThis tax amount is then applied to the line item as an adjustment and added on top of the order total.. > When tax is included in the price there the adjustments to the line items do not affect the order total\nWhen tax is included in the price then the adjustments do not affect the order total. > Stores are, however, usually required to show the amount of tax the user paid.\nStores are, however, usually required to show the amount of tax the user paid. That's why Solidus lists all adjustments below the item total on the checkout summary page.. > Here's another hypothetical scenario\nAren't you explaining a MOSS scenario here? So, this is not hypothetical at all, no?. the solidus_auth_devise generator actually don't install any assets ;)\nSo, maybe this one? https://github.com/solidusio/solidus_braintree/blob/master/lib/generators/solidus_braintree/install/install_generator.rb#L6-L13. As this is correct for most use cases, it is possible that someone want / need to charge taxes on the billing address level. I don't think that removing this, only because we don't really know, is a good option as a world wide used ecommerce framework. \nAnd since we have this option we should mention it here. . As I said, we don't know ;)\nAs this is actually no huge burden https://github.com/solidusio/solidus/search?utf8=\u2713&q=tax_using_ship_address I think keeping it does no harm, no?. Here we have one Product missing its module namespace. huge? ;). Yes to testing that Comparable is included \ud83d\udc4d \nNo need to test a well tested module from Rubys standard lib. @money would work as this is a attr_reader, won't work for @currency, though, as this is a delegate to money\n\ud83d\udc4d for being consistent on @money and currency usage. \n\ud83e\udd14 thinking to enable Rubocops \"redundant self\" checks.... Yep, destination_root is Rails' generator method that returns the path to the file destination. In this case the dummy app's app/views/spree path, that is empty anyways.\nBut good catch @gmacdougall !. No need to convert name into a string, it is already one. \nAlso I would prefer to join the names with Rails' to_sentence instead of join with comma.. Please put the apostrophe into the locale file. Then users can decide if they want to have it in their notice or not. . This could be rewritten as\n@order.insufficient_stock_lines.collect(&:name).to_sentence. Valid points. I think we could just remove the apostrophe from the translation. Stores that want to keep it, can easily update their locale file. And \"has become\" could be \"became\" and everything should be fine, no?\nWDYT @jhawthorn @ericsaupe . I believe this doesn't belong here. Although I think we we should add an changelog entry.. Can these be moved into user_payment_source module?. Could we add another method?\nruby\ndef payment_sources\n  wallet_payment_sources.collect(&:payment_source)\nend. Can we rename this into default_payment_source and return an actual PaymentSource? wallet.default sounds like getting the default wallet and we don't actually need the wallet_payment_source object. All we want deal with is PaymentSources.. Can we rename this into default_payment_source= ? wallet.default= sounds like setting the default wallet.\n. Can we make this method private? We only really need a payment_sources method.. Typo: Should be reusable_sources_by_order. Can we use select(&:reusable?) here?. If we add the proposed method Wallet#payment_sources we could rewrite this into:\nruby\norder.user.wallet.payment_sources.select(&:reusable?). Typo: reusable_sources_by_order. Typo: reusable_sources_by_order. Please add the replacement method name to the deprecated method name:\nruby\ndeprecate sources_by_order: :reusable_sources_by_order, deprecator: Spree::Deprecation. Please add the replacement method name to the deprecated method name and the spree deprecator:\nruby\ndeprecate temporary_credit_card: :temporary_payment_source, deprecator: Spree::Deprecation\ndeprecate 'temporary_credit_card=': :temporary_payment_source=, deprecator: Spree::Deprecation. Please add the replacement method name to the deprecated method name and the spree deprecator:\nruby\ndeprecate persist_user_credit_card: :add_payment_sources_to_wallet, deprecator: Spree::Deprecation. Please also change the deprecate usage as in previous comments. Please don't raise here. An order does not necessarily have a user (guest orders don't have).. Could we add a find! method to the Wallet class instead? Then raise in that class rather than here.. Could we add a find! method so we make usage of find_by! from active record?. You don't use this method anywhere. Can we remove it? \nAlso the current implementation is unsafe. The same payment_source_id could be used by another payment_source_type.. In Rails 5 belongs_to associations are required by default. We don't need these validations.. Can we use foreign_key: true here instead and remove index and null?. Can we move this into the frontend gem?. Can we leave this a describe block?. Can we leave this a describe block?. This test is identical to the previous one.. We don't want to silence ActiveSupport::Deprecation but Spree::Deprecation here. We don't want to silence ActiveSupport::Deprecation but Spree::Deprecation here. Can we use a describe block for methods?. Absolutely!. Ok, but why raise then?. I think we can also deprecate and remove the fill_in_quantity Capybara extension as well.. Ah, you already did :). \ud83d\udc4d. You need to pass {to_table: Spree.user_class.table_name} to foreign_key. I get very strange jumpy scrolling behaviour without the spacer.. This should be <= 768 as the breakpoint starts at 768. IMO a small transition would enhance UX:\ncss\n.admin-content, .admin-nav {\n  transition: transform .2s ease-in;\n}. IMO all breakpoints can profit from a flyout. Is there a particular reason you hide them from small viewports? . We should add !default here, so the variable can be overriden by shop devs.. I would consider to use a console.warn instead. A small screen does not equal a touch screen and vice versa. And this PR actually added more code to make this work \"only\" for desktop. That's why I proposed to remove this refactoring and say leave the flyout even for small screens.. Good catch @graygilmore . I would not consider this a bug, but I also don't persist on this animation at all. It was just an idea for a little nicer UX. . Latest Chrome, small desktop viewport (~1024) lower the screen height so the sticky feature get's triggered.. Good call \ud83d\udc4d . Good call. We should address this in this PR. Maybe we should split this file into files for each model? So devs could override individual models (the order for instance)? Not sure though, if this could ever be the case.. I kinda confuses me, that some files are coffeescript and some are javascript. I would prefer to go with JS from now on. But we should be consistent.. Also maybe splitting these views into separate overridable files would be preferable?. Also consider to split this file up. Not a backbone expert, but do we really need to use this.$ over just $?. I think the indentation in this file messed up somehow.. I believe we have a global $border-radius variable we can use here.. We should only use Ruby 1.9 Hash syntax if we touch lines of code. This view could profit from some indenting and usage of Ruby 1.9 hash syntax.. We are forcing stores to use Kaminari 1.0 then (which has some breaking changes), while ['>= 0.17', '< 2.0'] would be less intrusive and still Rails 5 compatible.. https://github.com/kaminari/kaminari/blob/master/CHANGELOG.md#breaking-changes\nThe most concerning one is the removal of num_pages on AR scopes.\nThanks. Ok. Fair enough.. \ud83d\udc4d\ud83c\udffb for the namespace. TIL. Indeed very nice \ud83d\udc4c\ud83c\udffb. We can't store this information like this as Sprockets won't pick up changes to Money settings while compiling new assets. Means, every time you change a Money setting you have to delete the assets on the server and force recompilation. \nTo avoid this, we need to store this information in a html.erb file, like we already do for the JS translations data (backend/app/views/spree/admin/shared/_translations.html.erb). I actually find this a very good way to test this. \ud83d\udc4d. Good idea \ud83d\udc4c\ud83c\udffb Much more convenient. \nThis deserves a CHANGELOG entry though, as people may have modified one of these files. Even deface overrides will not work anymore as the file name changed. . The indenting of this file is a little off. Can we remove these classes from the html as well?. Can we put this model into its own file and use the Spree.Model namespace discussed in #1715?. Maybe we can also introduce a Spree.Views namespace for views as we discussed for models in #1715?. It really helped me today that in the other backbone powered templates we have a comment noting that the content is handled via JS. Maybe we could also add a comment here. . .line-item-qty-edit and .line-item-qty-show are JS utility classes used in the old JS only AFAIK. Maybe there are others. Not mandatory, for sure. But I like to clean up as we have the chance. . Sure.. Okidoki. Not mine ;) d2ec380de431ef498f28c4c2b80086c6fec81afc. I don't think we need routes in this file. This should be $cart-total-color with a default value of $link_text_color so it can be changed independently.. Could this be a handlebars partial?. Do we need a check for already existing states here? Or is the select always empty at this point?. \ud83d\udc4d. TIL \ud83d\udc4d . ruby\nwhere.not(gateway_customer_profile_id: nil). I would prefer to have \nruby\ninventory_units: @inventory_units.select { |iu| iu.order == order }\nhere. \ud83d\udc4d . I think the default should be no wrap. Most of the time we display where little information in cells, mostly values (order numbers, email addresses, etc. You don't want to wrap these.\nThe only occasion where wrapping was useful (not even needed) was the image caption. It would be a much larger change set to add a no-wrapp class to all cells where we want this to happen. \nBut this is just my preference. I'm also fine with having the opposite being the default. I would then vote for also making the header cells non wrapping. Nobody wants a \n\"Created\nat\"\ncell, right?. What would a \"normal\" table look like? Browser default? I always thought this is our default table style. But I understand your concern. Im also fine with adding a table class to all tables. The change set will be much larger then, though. . Can we use?\nruby\nreturn_items.joins(inventory_unit: :shipment).where.not(Spree::Shipment.table_name => {order_id: order_id}).exists?\nshould be much faster and avoid N+1. Do we really need this check? Maybe tackle in a separate PR?. Can we use?\nruby\nreturn_items.joins(inventory_unit: :shipment).where.not(Spree::Shipment.table_name => {order_id: order_id}).exists?\nshould also be much faster and avoid N+1. Could also be removed in a separate PR IMO. This whole method needs to get nuked, because core doesn't create cartons from different orders. Separate PR of course. There is also asset-data-url\nhttps://github.com/rails/sass-rails#asset-data-urlrelative-asset-path\nthen we can make this changeable and it's still a data uri.. can we have a:\nscss\n&:hover {\n  cursor: pointer;\n}\nhere please?. \ud83d\udc4c\ud83c\udffb. Took the opposite approach like suggested.. @kennyadsl I'm not sure about removing the sticky kit yet. @Sinetheta WDYT?. Dang. Don't know the 17th month? \ud83e\udd23 . fixed. display: inline-block is already set by Bootstrap in .c-select. Bootstrap already takes care of hiding this. . Can we use Bootstraps $input-heighthere?. Let's make use of Bootstraps $input-bg here.. text-align: center; is already set by Bootstraps .input-group-addon. Interesting. Ok. Thanks for clarification. . We deprecated the $color-txt-text variable.  Can we use $color-3 instead?. dito. dito. Somehow the height isn't correct when using this variable (it's two pixel off). I guess somehow the calculation of $input-height is wrong. It seems the correct formula, though. \ud83e\udd14 \nTaking the$input-btn-border-width into account seems to fix this issue.\nscss\n.select2-choice, .select2-choices {\n  ...\n  height: calc(#{$input-height} + #{2*$input-btn-border-width});\n*) calc only works with variables in Sass if you interpolate them. We need to use calc here, because of mismatching units (rem and px). But as calc is very widely supported, I think this is a good compromise.\nBefore\n\nAfter\n\n. Unfortunately with the fix for the height above it's even more obvious that the height of the selected value does not match its parent container.\n\nIt think this is a good fix for that:\n```scss\n\n.select2-chosen {\n  line-height: $input-height;\n```\n\n\n. Line heights should always be unit-less. Unfortunately we can't use the $line-height variable (tried that, doesn't fit into the container very well). \nA value of 1.35 does it for me in Firefox and Chrome, though.\nIn order to make this work well with the search input field and we get a consistent look I came up with this solution:\n```scss\n.select2-container-multi .select2-choices {\n  .select2-search-choice, .select2-search-field {\n    line-height: 1.35; / Fill height of input /\n  }\n.select2-search-choice {\n    background: $label-default-bg;\n    border: 0;\n    margin: 2px 0 3px 5px; // adjust the margin to respect the adjusted line height\n  }\n}\n```\nBefore\n\nAfter\n\n. Can we also adjust the height a little bit?\nscss\n.select2-no-results, .select2-searching {\n  ...\n  line-height: 2.5;\nBefore\n\nAfter\n. While we at it, we should adjust the select highlight colours.\nscss\n$dropdown-link-hover-color:      #fff !default;\n$dropdown-link-hover-bg:         $color-3 !default;\nscss\n.select2-results {\n  ...\n  .select2-highlighted {\n    background-color: $dropdown-link-hover-bg;\n    // Ensure all remote results have correct colors on hover\n    * { color: $dropdown-link-hover-color }\n  }\n}\nBefore\n\n\nAfter\n\n\n. We should use a Bootstrap variable for this. $label-default-bg seems to be a great fit. Not sure about this, though, but we should not hardcode a value here.\nsass\n$label-default-bg:            $color-7 !default;. Your are right. Ignore me. We need to add the newly introduced $input-line-height variable into our custom form fields, otherwise the inputs are too high in contrast to the selects\nBefore\n\nAfter\n\nscss\ninput[type=\"text\"], ... {\n  ...\n  font-size: $font-size-base;\n  line-height: $input-line-height;\n  ...\n}\n. I think this wrapper should be removed altogether. I know this is not part of this PR, but with the removal of the xs column classes this gets more obvious then before.\nBefore\n\nAfter\n\n. Out of scope, but I couldn't find any reference to this partial. \ud83e\udd14 . Flexbox \ud83d\udcaa \nChanges to this file visually breaks the variant select in both Chrome and Firefox.\nAdding\nscss\n.media-left {\n  padding: .5rem .5rem 0 0;\n}\nfixed this for me.\nBefore\n\nAfter\n\n. I'm not quite sure why this start to break visually now, but this makes the select too small. We should change this to col-12. We could also remove the row and col completely as I don't see any advantage to have this in this form, but this could break potential Deface overrides stores could have made.\nBefore\n\nAfter\n\n. Probably not caused by any change made in this PR I guess, but poking around I stumbled over a wrong background colour on disabled select dropdown arrows.\nBefore\n\nscss\n.select2-arrow {\n  ...\n  b {\n    background: transparent ...;\n    ...\n  }\n}\nI would even prefer to only make the background-image !important, but to keep the changeset as small as possible I just changed the background color\nAfter\n. Bootstrap removed this for accessibility reasons https://github.com/twbs/bootstrap/commit/bd38a2a2180fe585f2279aa205910933213e7fc9\nWe should follow their example.. These nested rows now break the layout\nWe should remove the nested row and change the columns size back to 4 as this is the value it was in our skeleton based UI.\nBefore\n\nAfter\n\n. As long as we set $font-size-base to $body-font-size everything should be fine.. Agreed!. Oh, actually a good catch. So, the only solution I see is to use a attr_accessor for length then, right?. We should not remove the max-width and max-height rules, otherwise large images will pop out of the div.. Instead of using (also asynchronous) padding we should use line-height to vertically align the image in the box and remove all the padding. This has the advantage that images could consume the whole available space if they like.\nWe can fix the padding of the default logo by removing the extra whitespace from the image.. The solution I came up with\nscss\n.admin-nav-header {\n  padding: 0;\n  border-bottom: 1px solid $color-border;\n  text-align: center;\n  // Using line height for proper vertical centering.\n  // As line height does not take the border width into account we need to subtract it.\n  line-height: $main-header-height - 1px;\n}. We should also use the (to be introduced) $main-header-height variable to set the height on the .main-header\nscss\n$main-header-height:             75px !default;\nscss\n.main-header {\n  ...\n  height: $main-header-height;\n  ...\n}\nThat fixes the height for empty main headers, in the login screen for instance\nBefore\n\nAfter\n\n. Shops may have used this class for deface overrides. We should not remove it now.. Have you tried to just remove it?\nI think the dummy app generated by Rails will most likely already have set this in the environments/test.rb. \n. A receive_message_chain(:adjustments, :find_by!) should do the trick here.. We prefer using receive_message_chain here as we don't want to test internal active record implementation details. This specs will fail, if Rails renames it's relation class.. This method is defined by us in core/lib/spree/core/permalinks.rb and are included in all active record classes. This should not be replaced.. This is a change in the actual implementation and not necessary for Turbolinks to work, right? I think this should not be in this PR.. This comment is misleading. You are doing this because we want to print out a deprecation warning and use Spree.ready even if it was not used explicitly. Turbolinks works without this change.. Please satisfy Hound here.. Neat little trick \ud83d\udc4c \nBut we remove the internal check of Turbolinks for supported browsers with this. Imagine someone enables Turbolinks in the backend and uses an unsupported browser, Turbolinks will not gracefully fall back anymore. \nI can live with that, because we encourage admin users to use latest browsers, but this can cause issues.. Can we have these changes to the new order and customer details feature specs as separate PRs to master? I want to be sure they still pass on non-Turbolinks based backend.. > note: I have not fixed the indentation in admin.js not to introduce noise\nbut, yeah, we should fix that \ud83d\udc4d . @mtomov sure. Sorry, I forgot the target of this PR, you are totally right!. @mtomov updated solidusio/turbolinks. Can we split this up into separate files?. I think we should rename the class into inline-editable-table when we have this in the global namespace like this.. Several Ruby style guides recommends:\nruby\n\"#{options[:class]} delete-resource\".strip. ruby\nBigDecimal.new(value.presence || 0)\nshould work without the need of rescue. I would prefer to just link to the install notes of imagemagick http://imagemagick.org/script/download.php\nThen this paragraph can be reduced to just a note about this dependency . Absolutely \ud83d\udc4d. key is a confusing name. Why not use action, as this is more common to Rails devs?. I would like us to use:\nruby\nspree.url_for(controller: 'admin/reports', action: action)\ninstead of interpolating strings.. The table needs a class otherwise all tables in the style guide will match this.. I'm ok with this as the problem is due to the original - wrong - implementation.. When using a tool to parse TODOs it would help to actually have the name of the factory in the message.\n```ruby\nTODO: Improve the name of the order_with_totals factory\n. I see. `payment_method_types` is ok, or `configured_payment_methods` could also work, no? @mamhoff thoughts?.ruby\nsource.name.demodulize.tableize\n``\nshould return the same result and is much shorter.. @kennyadsl @mamhoff updated. Please re-review. Oh, good catch. Due to the re-rename \ud83d\ude0a . I just renamed the file.. A good catch, as the keys are unique this will work as well. Thanks!. I say let's create a separate PR. Changed to Hash, thanks!. Thanks for checking. missing space. You mean additionally? Yes, this is a good idea. Can't we instead useoptional: falseon thebelongs_to :productabove?. Fixed. Thanks. I'm not sure about this one. I see the rational behind, but we don't have this kind of behavior in any other table we have. I think this should be discussed as an overall UI improvement on a separate issue/PR. I\u2019m sure we can speed this up even more by usingpluck(:iso)instead ofmap. Typo in variable nameexistingvs.exiting. Please indent these lines. Is there any reason why we put this code in a callable instead of just evaluate the code in place?. [Or simplyupdate!](https://apidock.com/rails/v4.2.7/ActiveRecord/Persistence/update_attributes%21). We are strange :). Why this alias?. This name confuses me. Maybe justhandle_stock?orhandle_stock_count?. Could we move this query into theifblock on line 26?. Could we spare this query if no backordered units are left?. Maybe don't call this varsplitter. This changed status code is maybe worth noting in the change log.. Could we useshow_flashinstead of analert` here?. Maybe it makes sense to put all the stock and shipment changing code into a transaction to avoid potential stock count mismatches?. I would like to see some documentation on this class.. Sure. Yes. I also would like to have this separated by line \ud83d\udc4d \nAnd maybe use %w() syntax, but I don't care about this very much.. ruby\nSpree::Deprecation.warn. ruby\nSpree::Deprecation.warn. I think we can be a little more verbose/descriptive on this deprecation notice\n\nrake spree:load_dir has been deprecated and will be removed with Solidus 3.0. Please load your seed files directly from your app's db/seeds.rb file.. I think rake db:reset is what we want to recommend, no?\n\nAlso Spree::Deprecation.warn. Development artifact?. This is bootstraps default. We can remove this line. We should consider to add a line-height: 2 to fix the vertical alignment of single line rows. This seems like a large value, but it actually looks pretty good.\nBefore\n\nAfter\n\n. The <td> only appears if the object is persisted. This looks wrong compared to other sortable tables.\nI suggest changing this to:\nerb\n<td>\n  <% if f.object.persisted? %>\n    <span class=\"handle\"></span>\n    <%= f.hidden_field :id %>\n  <% end %>\n</td>\nand remove the colspan from the name cell.\nBefore\n\nAfter\n\n. We should remove the colspan here and add an empty <td> instead.. The image should have a align-center class and we should reduce the column width, so the image looks belonging to the name.. Good question. Would be nice though. Will give it a try. Turns out this would be tricky, because we would need to rewrite all forms rendering these fields. In terms of the calculator fields this means to rewrite the calculator forms. I think we should tackle this in a separate PR. WDYT?. Done. I agree that the large line-height is not ideal, but I also think that the vertical alignment of single line rows should be corrected. What makes me thinking is that the default tables in Bootstraps documentation are all correctly aligned. \ud83e\udd14\nI will have a second look into this problem. @graygilmore @Mandily I know why the vertical alignment for single line rows is off. The action buttons occupy more space then the text and thats why the row is too high. \n\nSolution would be to get rid of the round background. \n\nWe should handle this problem in separate PR. \nWDYT about this approach?. https://github.com/solidusio/solidus/pull/2100. Just my personal taste, but wouldn\u2019t it be nice to wrap the image in div that centers the image?. Typo at the end of the line . Ditto. Instead of rolling our own set/reset mechanism we should consider to use a Backbone model like in the stock management views. \ud83d\udc4d like that!. A Backbone template could be useful here. We use them in other inline tables as well. Combined with a model this should reduce code. See the stock management view for instance.. Ignore me, I thought this whole line gets replaced with fields. The fields are already on screen. \ud83d\udc4c No need for Backbone templates then.. The font-size should have a relative unit.\nAlso the paddings.. You are changing the table far more than just adding the pill component. Could you please do this in a separate commit, or not even PR?. These changes do not belong in this PR IMO. At least it should be a separate commit.. Could we move this removal in a separate commit after this commit?. this as well, please. I like that this is now translatable, but please do not titleize this. This is what should be done in the translation itself, upper and lower case rules are very specific to languages.\nAlso, this should be a separate commit.. Please do not transform strings like this, pass it through I18n or just leave it like it is.. We should only use humanize if we pass it through I18n before and humanize the fallback translation.\nruby\nSpree.t(return_item.reception_status, \n  scope: 'return_item_reception_statuses', \n  default: return_item.reception_status.humanize). Same comment as above. I suggest to make a separate commit (not even a PR) first that changes the presentation via I18n.. Ditto. Same comment because of titleization applies here. Should be a separate commit as well. If you raise the body font size you want to grow this as well. The same with the passings. They should be relatively to the font size to keep the ratios. . paddings not passings. (Sorry iOS). > we're not i18n-ing those!\n\ud83d\ude06. I like us to move forward to relative units all over the place. That\u2019s the way all frontend frameworks went for a reason. \nI see the problem with the small base font size we have. So, I won\u2019t insist to make this change right now. \nBut, could you please make this font size a variable then?. Could we add require: false here? We don't need to require ffaker every time we boot the dummy apps. . Personally I prefer the %w(Sterling Jennette) syntax for arrays of strings. Also having a new line for each word is far better readable, but this should not block this PR.. We should set version numbers. You could only pass the translation key here and translate in the output. We also could think about some sensible defaults. Ie. An order quick switch item has an :order translation key (assuming a proper scope, like above).\nThis also would be great for the methods that get called. I don\u2019t like the \u201cyou need to class eval\u201d kind of extension point. A callable object (lambda) or assumptions we make would be nice. Passing the class name of the model that gets called and an array of attributes that gets searched for instance. . I would rather let us make some assumptions and a way to let users define the class and attributes. Something like\nruby\nQuickSwitchItem.new(\n  class_name: 'Spree::Image',\n  attributes: [:alt_text, :title]\n)\nOn the quick switch controller we would then just search the value on that model class' attributes . Please use named arguments, so the api is more obvious for users.. isn't search_trigger a more understandable name instead of search_term?. instead of method I would like to use a Ransack search_query (i.e.: promo_code_cont). Add a method for the help text here.\nrb\ndef help_text\n  Spree.t(@help_key, scope: 'quick_switch.help_texts')\nend. Do we really need the html response? We are only consuming the json response. I think get would be more appropriate then post.. Doesn't get requests in regular search forms change location all the time? \nBut yeah, semantics \u00af\\_(\u30c4)_/\u00af\nAs this is an Ajax request I actually don't care this much.. I get the test argument. But it is very unlikely that someone will use this html endpoint ever. Switching to a request spec should be enough and assuming that the response gives you the redirect_url. I don't think we need a fully blown js driven feature spec here.. Thanks, Jordan. Fixed. I want to be able to initialize without the reason given. I didn\u2019t find any usage of this function besides from triggerShortcut. Could we combine these?. We should update the rdoc. I think hound is right. Do we actually need these returns in all the lambdas?. I love this API. Fixed. added. Could we reduce the number of methods here or are these semi-public interfaces? In terms of private, but widely used by extensions/shops?. Thanks, but I think we can remove even more.\napplicable_rates is never called outside of this helper. The calculators only use rates_for_item.\nIf we also move sum_of_included_tax_rates into Spree::Calculator::DefaultTax (the only place where this is called) we can reduce the module to:\n```ruby\nmodule Spree\n  module Tax\n    module TaxHelpers\n      private\n  def rates_for_item(item)\n    rates = Spree::TaxRate.for_address(item.order.tax_address)\n    rates.select do |rate|\n      rate.tax_categories.map(&:id).include?(item.tax_category_id)\n    end\n  end\nend\n\nend\nend\n```\nWDYT?. And maybe we should rename the method to something meaningful then\ntax_rates_for(item) maybe?. Perfect! Thanks . \ud83d\ude06. Could we xit or even pend these specs and add a note why these fail or don\u2019t test the right thing? I still think this is a great feature, but need a rework someday. . This doesn\u2019t have to be a function if we use a static property. The indentation is a little off here.. What is the reason that we need a full page reload? Just curious . Can't we fix solidus_api instead? It should not rely on this table.. \ud83d\udc4c\ud83c\udffb. It's very inconvenient one can't submit all our Backbone views with Enter key. We should change that.\nIf we would listen to submit form events instead and wrap the fields into a form (and use that magic submit button trick shown below) we can have both behaviours (enter key and click on the button) with the same event handler.\nI will submit a PR with the changes to your PR.. If we would wrap this in a form we could use the submit event instead.\nhtml\n<form id=\"tracking_form\">\nNotice that we need to have that id to connect the \"save\" button with this form as it sits outside of the form. But there is this barely known attribute of submit buttons called form. \nVery handy for our use case!. In order to use the same submit event we need to add \nhtml\n<button type=\"submit\" form=\"tracking_form\">\nthe form attribute is important here.. Just saw, that the onChange function is not defined in this view. . Thanks for clarification . Maybe for easier customisation we should add a\nrb\ncan? :reveal_api_key, @user\npermission?. Great. I\u2019m more than happy to remove this. I think we should keep these fields and only display them\nrb\nif @user == try_spree_current_user\nalso, we should add a \"current password\" field. Then we should have addressed all security concerns.. We should add a no-border-bottom class. There are already too much borders on this page, also I don't not see any need for adding a DOM ID.. We should just add a align-center class and should not make use of the filter-actions actions classes, as these will add even more borders to this already overwhelming page.. We should hide this conditionally \nrb\nif @user != try_spree_current_user\nThat this is only visible for admins that don't manage their own password.. By using the human attribute name, like suggested above, we can remove this.. I would consider this wrong as this implies (from reading the specs) that we could set an order on a inventory unit, what we recently prohibited.\nThe shipment already has the order. Could we change the specs that we set the correct order on the shipments instead?. could we amend or at least correct the commit message?. Spree::Stock::Package and Spree::Stock::Packer has not been touched in this PR. Maybe expect(subject).to_not be_valid?. Addressed this rubocop annoyance with https://github.com/solidusio/solidus/pull/2314. duplicated line 44. Other settings have hard coded bools, while these doesn't. I think it's fine that we hard code all booleans. This dummy app is not meant to be run in other Rails env, isn't it? . Should we consider to move all Spree config into a file (../dummy_app/spree_defaults.rb)?. This seems to be nearly the same as in ../dummy_app.rb:61-67. Can we get rid of this duplication?. I think we should not change the spec like this. Is there a way to tell the dummy app the view paths like you did with the assets?. I think it is very common in stores to overwrite render_404 and do stuff instead of rendering the 404 page. Building a dynamic 404 page for instance. Is there a way to still provide this functionality for stores? Could you tell the dummy app where to find the views like you did with the assets paths for instance?. ditto. TIL config.exceptions_app \ud83c\udf89 \nYou are right, the code is bad and should be removed. Although it's blocking your PR I think we need a separate PR due to visibility reasons. I think we can forego with deprecating this, though.. @kennyadsl I think @bofrede meant that the selector is too strong in terms of \"Do not over specify css selectors\" rule of thumb. It would be hard to override this if we over specify selectors. 90% of !important usage is because CSS authors uses too specific css selectors.. We should use local_assigns here to make it optional.\nrb\nif can?(:create, resource) && local_assigns[:new_resource_url]. We can remove this local entirely if we use local_assigns in the partial above.. \ud83d\udc4c\ud83c\udffc. I like that idea of configurable image attachment classes. If we want extensions to be able to hook into we want to provide a real integration point. \nAlso I don\u2019t think gallery is the correct term. gallery_images would follow the \u201cplural is a collection\u201d convention of Rails better. We could even override the images getter. Btw. We need to deprecate the images = setter as well or delegate this to the images provider class. . \ud83d\udc4d good catch. Lots of extensions might inherit from this.. I don\u2019t see a need for this private method as long as we don\u2019t access it from two different methods at least. . Why not remove these image collector methods from here and move into the views. This might be more duplication, but is also more flexible. Although I think the naming is difficult and misleading. Let\u2019s not make these decisions here, but in the views. They are easier to override in a per use case basis. . Ah, yes. You are right. Dang. Thanks for catching this!. If you would use a custom event name and listener, agreed. \nAnyways. It is great as it is right now. I will not block this great feature. . We deprecated Spree.t in favor of I18n.t with a scope: 'spree'. Would you please make this change before we merge this?. Same here. Use I18n.t over Spree.t. Converted the buttons into anchors. The actual problem was that hitting the enter key added new tiers and that prevents the form from being submitted.. ~any~ any. I know this very picky, but could we use box drawing characters here? \ud83d\ude04 \napp|vendor\n\u2514\u2500 assets\n   \u251c\u2500 images\n   \u2502  \u2514\u2500 spree\n   \u2502     \u251c\u2500 frontend\n   \u2502     \u2514\u2500 backend\n   \u251c\u2500 javascripts\n   \u2502  \u2514\u2500 spree\n   \u2502     \u251c\u2500 frontend\n   \u2502     \u2514\u2500 backend\n   \u2514\u2500 stylesheets\n      \u2514\u2500 spree\n         \u251c\u2500 frontend\n         \u2514\u2500 backend. vendor\n\u2514\u2500 assets\n   \u251c\u2500 javascripts\n   \u2502  \u2514\u2500 spree\n   \u2502     \u251c\u2500 frontend\n   \u2502     \u2502  \u2514\u2500 all.js\n   \u2502     \u2514\u2500 backend\n   \u2502        \u2514\u2500 all.js\n   \u2514\u2500 stylesheets\n      \u2514\u2500 spree\n         \u251c\u2500 frontend\n         \u2502  \u2514\u2500 all.css\n         \u2514\u2500 backend\n            \u2514\u2500 all.css\nI \u2764\ufe0f box drawing characters. Missing link. Oh, yes. This is a left over from my investigation. Thanks! Will fix that. @kennyadsl Fixed it. There is no need to merge these two collections, because @product.variant_images already includes images of the master variant - what are the images returned by @product.images. The thing you're passing into the partial as image is actually an url. Shouldn't we rename the variable as well?. It makes sense to have a first_image_url method in the gallery classes.\nrb\nitem.variant.gallery.first_image_url(size: :mini) || item.variant.product.gallery.first_image_url(size: :mini). I think we would gain much more isolation from  this class if it would have an image_urls method that takes a size: parameter.. Here as well, a image_urls method that takes a size: parameter would help us decoupling from paperclip. We are not able to decouple from paperclip if we have this method inside of here. It would be better to put this url retrieving logic inside the gallery classes. Extensions like solidus_paperclip would then implement such gallery classes.. Will do, thanks!. Absolutely. Will see if I can sneak this into this PR. It seems unnecessary for me to require all database connectors at once. \nShouldn't we only load those we actually use via ENV['DB']?. I like the idea of a separate Image class \ud83d\udc4c\nSo we would have a repository (Gallery) and a presenter (maybe Picture?). This sounds like a good plan to me.. > Would being able to access image.alt here be an argument for using a custom image class\nYes! A separate image class (Picture maybe?) makes total sense to abstract the presenter API \ud83d\udc4d . > Is there a reason why we haven't historically been rendering an image's alt attribute?\nNot sure. We should render it (at least in the frontend).. You are right. I will change that. We don't use phantoms anymore.\nYou need to install chromedriver on your system first.. chromedriver. We should not promote a custom ENV var, but the rspec --fail-fast feature instead. But this is common rspec knowledge, I don't think we need to mention it in our guides at all.. This headline belongs to the next paragraph and this headline should be something like \nStable Solidus. and you need to provide tests for your bug fix or new feature as well.. Using the gem actually conflicts with having it globally installed. I would to see us promoting installing it system wide via package managers instead of via Ruby gems . Shouldn\u2019t we able to allow ~> 3.7?. I don't like our event depend on suppress_mailer here. Can't we just pass the order instead?. If we plan to move this class into an action mailer extension anyway and people are able to write their own mail processors we do not need to imply class_eval is a good idea to use the event bus. This violates the whole purpose of an event bus, no?. I am in favour of removing the class out of core and move this into an action mailer extension instead. Then provide an easy (as in not class_eval) configuration for people wanting to enable/disable certain event handlers. But this can be discussed in that new extension instead of core.. If we pass the order instead of surpress_mailer\nrb\nreturn if event.order.suppress_mailer. I don't think this should live in Spree::Config. The class is not configurable, but the name implies it is.\nDefining this in Spree.event_bus should be sufficient.. Why use the Spree::Config namespace? Could we use\nrb\ndef self.event_bus\n  @event_bus_class ||= Spree::EventBus.instance\nend\ninstead?. It is already passing the carton and as the carton only nows it's orders we do not know the order object that sends this event, though.. Do not send the event if suppress_mailer is true? This is it\u2019s whole purpose right? \u201cDo not send\u201d as in \u201cdo not notify the user\u201d, whatever the method of notification is. . Yeah. You are right we should not suppress events ever. But then we need a way for stores to be able to alter already registered event handlers. . Check. changed. MySQL allows multiple columns in a single ALTER TABLE statement. Maybe this will speed up the migration a bit?. As far as I read this paragraph it handles overriding a single CSS rule or JS function in a separate file, not overwriting the defining file itself. This is handled below. And overwriting things like this is always supported, no? Or am I misreading something?. \ud83d\udc4dnice. Not necessary, but could we use a attr_reader for @options? Consistency . Missing link. The ApplicationController is not nested inside the Rails module. This user is only meant as test user and should not be modified by extensions. Also it is not suitable for production environments. . Also this article does not handle the usage of Devise. Do you plan to extend this article? If not this paragraph should be removed as this confuses. Thanks! . Ah, ok, I misread the comma and the \"or\". Makes sense. Sorry for the confusion.. I would like to have a more meaningful parameter here. Just passing nil to restrict the countries to a specific zone seams unintuitive to me.\nMaybe something like?\nrb\ndef available_countries(restrict_to_zone: Spree::Config[:checkout_zone]). Could we not change the table style here? Won\u2019t adding just table-responsive be enough to fix the issue?. Why not order.shipments.order(:created_at).last or order.shipments.sort_by(&:created_at).last if we don't want to reload the shipments again? Would be more readable.. > ~~currncy~~\ncurrency. Ah. Thanks for clarifying. I always forget the darn mysql default precision. . I think this is good for now and works with existing locales w/o any further changes.. There is a nice little class method from ActiveSupport\nrb\ndef can_transition_from_pending_to_ready?\n  ...\nend\ndeprecate can_transition_from_pending_to_ready?: :inventory_can_ship?, deprecator: Spree::Deprecation\ncould we use that instead?. could we call inventory_can_ship? in here?. presence: true is superfluous if we also check the inclusion in something that's not having nil.\nMaybe we could also add default value for the state column?. We could have a default value for the state column instead.. ActiveRecord already sets updated_at for us.\nAlso, the bang at the end of the method name indicates that this method raises if the record couldn't be saved. We should use update! here.\nrb\nupdate!(state: new_state)\n. We should consider to move the methods change_state! and store_state_change into a module we share with all models that have state changes.. dito. dito. weird usage of parenthesis here.\nEither\nrb\nraise InvalidStateChange\nor\nrb\nraise(InvalidStateChange). Ditto, weird usage of parenthesis. Ditto, parenthesis. A database default would be preferable. Later we should change CANCELABLE_STATES to be a method as stores might want to change that.\nIdeally this would even be configurable, so stores won't have to class_eval or Module#prepend this class. I know this is just keeping things like before, but we should consider to make this configurable in the future. Either via a method or configuration.. Not all stores need all these sizes. This is a rarely used feature, but if a store is using this we force them to pre-process four sizes now, what is not what we want to force stores into. \nCould you make this change in your particular store instead? Here is an article on how to achieve this https://github.com/solidusio/solidus/blob/master/guides/products-and-variants/product-images.md#paperclip-settings (Just replace Spree::Image with Spree::Taxon). I tried to, but git doesn't let me to.. Using self here passes the action view context instead if the order object. \nAnyway, I think we should leave it untouched here. . Could we move this in its own file? Then this is more easily adjustable by stores. . Could we use a meaningful color variable (we have $red) here?. Do we really need the !important here? Especially with this generic class this could cause headaches. Would a stronger selector like\ncss\ninput[type=\"number\"].negative\nwork as well?. Could we please the human eye by adding some spacing here?. Ditto?. Ideally we would have two configurations, but this seems overkill to me. We could keep it as is, if we encourage the users of solidus_i18n to copy over only the files they need in their app (what I recommend anyway).. Reverted. icon is deprecated (deprecations let tests fail), please use solidus_icon. . Could we add an option to set the required attribute?. Would be great to have an option to set the required attribute. . This was my first take, but something led me to move this into the root folder. I will try again, because I agree that this should not be in the root folder.  . We usually don't want to rely on code inside the migrations. Although very unlikely that the value for Spree::Shipment::PENDING will change ever, it still is more reliable to use the value here instead.. We may can make use of ActiveModel::Dirty here?\nhttp://api.rubyonrails.org/classes/ActiveModel/Dirty.html. Can we try to make use of ActiveModel::Dirty here?\nhttp://api.rubyonrails.org/classes/ActiveModel/Dirty.html. Can we try to make use of ActiveModel::Dirty here?\nhttp://api.rubyonrails.org/classes/ActiveModel/Dirty.html. We should use the value of the constant here so we do not rely on the code may change in the future.. We should use the value of the constant here so we do not rely on the code may change in the future.. Can we try to make use of ActiveModel::Dirty here?\nhttp://api.rubyonrails.org/classes/ActiveModel/Dirty.html. We should use the value of the constant here so we do not rely on the code may change in the future.. This needs to be in the activerecord.attributes section. Even one more typo\n\nit creates several versions\n. Code should be in blocks if it\u2019s longer than one word. Otherwise it may break the line and this isn\u2019t really readable. \n\nI would even consider to put code always in a block, so it stands out. Code inside paragraphs seldomly make sense. Only if you want to reference a variable or constant it makes sense. Also syntax highlighting only works for code blocks. . We should use params.require(:order).permit(:coupon_code) instead. This is more secure and will most likely fail  in Rails >= 5.1 otherwise.. Ditto. Where is this var used?. I am not sure if a AR hook is the best place to do that calculation (that may include API requests and other funky stuff shops do to determine the order totals). Maybe we should move this into the perform! method.. I think we can remove \"straightforward\" here or replace it with \"sophisticated\". But leaving it out is most likely the best option. . Users sign into your store is more accurate as they can access the store without leaving an email. Maybe explain that every time a user enters a new address we associate the address with the users account. . \ud83d\udc4c maybe explain why it is needed to involve a developer.. > They also allow you group states\nMissing \"to\". We deprecated Spree.t in favor of I18n.t(:my_account, scope: :spree). \nAnd I don't see why we define this in the controller. Just use t(:my_account, scope: :spree) directly in the view\n. We deprecated Spree.t in favor of I18n.t(:my_account, scope: :spree).. We deprecated Spree.t in favor of I18n.t(:email, scope: :spree).. We deprecated Spree.t in favor of I18n.t(:edit, scope: :spree).. Please use\nrb\nSpree::Order.human_attribute_name(:number). Please use\nrb\nSpree::Order.human_attribute_name\nfor all the attributes here. Please do not use titleize here. As this is cosmetic change that should be done solely in CSS. Also do not use Spree.t. Could we also rename the class to js-addresses-form?. Very good point Ben. @jgayfer would you mind to address this?. We should extract this into a method, as stores might want to extend/change states.. Stores might want to extend/change the states. This should be a method instead.. The states may change for stores. We should allow them to overwrite a method instead.. I agree with this. And as changing configuration options in later releases is hard, we should agree on a better name before merging this.. missing link. Maybe add a short sentence what a calculator does. It's often not clear for non technical people what this thing is for, besides that it 'calculates things'.. The header of this table is misleading. There are no promotion action types listed, these are calculables (a term we probably should explain as well).. Can we call this method valid_state or is_valid_state? Reads better.. Can we rename this constant to DEFAULT_STATES? We don't want to give the impression that overwriting a constant is a good extension point (because it's not). Could we use a named argument here?\nrb\ndef reimburse_units(inventory_units, creator: nil). A named parameter would help the self-documentation of this method.. A named argument would explain the purpose of this argument:\nrb\n@reimbursement.perform!(creator: try_spree_current_user). Here as well\nrb\n@reimbursement.simulate(creator: try_spree_current_user). Ditto: Named argument. Why not have two seperate rules? One read and one update rule. You mentioned that in your commit message. What was the reason you did it this way?. It is absolutely fine \ud83d\udc4c . \ud83d\udc4d . This step is not necessary to test the extension locally. This is only necessary if you want to build and then install a gem via gem install, what you don't need if you are using bundler.. One does not need to install this gem. It is a nice little wrapper around gem new or bundle gem.. We should mention the Rails engine guides. As those are mandatory for extension developers.. Not all extensions are listed at http://extensions.solidus.io. We should also mention https://github.com/solidusio-contrib and that people can register their extension at https://github.com/solidusio/extensions.solidus.io via opening a PR. We should mention https://bundler.io/v1.16/guides/creating_gem.html as well. 1.8 does not work?. Yes. Please. We want to be as conservative as possible with dependencies. You are testing product update, while the PR says product creation. \nCould you add a spec for creation as well?. We should name this \nrb\nSpree::Config.stock.location_sorter_class. The Sorter module should be renamed\nrb\nSpree::Stock::LocationSorter::Base. ditto. rb\nlocation_sorter_class. ditto. Missing newline. This should go into the stock configuration. rb\nSpree::Config.stock.allocator_class. Yes. We should be fine with only depending on sassc-rails. . I don't know who reads this Mail. We need to make sure we have a public email address that core team members get. Maybe we can define one dedicated person for this and present their email here?. > I'm happy to be that person if no one wants to volunteer\nThank you. That would be great.\n\nto discuss the emails during core team meetings\n\nI am not sure this is necessarily a core team responsibility. Reading the code of conduct:\n\nUnacceptable behavior from any community member, including sponsors and those with decision-making authority, will not be tolerated.\n\nHaving a team outside of the core team is even preferable. Missing double quotes at the end of this line causes nearly all tests to fail. . We should not change the data-hook attribute. Stores might have used Deface to override the view. . I think we should deprecate removals first. There might be people that decorated this class like this:\n```rb\nmodule OrderContentsDecorator\n  def order_updater\n    super\n    do_something\n  end\nend\nSpree::OrderContents.prepend OrderContentsDecorator\n```\nThat would now fail.. We agreed on not deprecating a private method. I think we should not add global configuration in a class like this.\nCould we move this into it's own config/initializers/money.rb of the host app instead? And tell users to do so in their current apps and add it into the install generator? I like to be explicit with these things, especially if it's not our gem we are configuring here.. Why don't we use markdown anymore?. I\u2019m not a fan of adding a setting in our app that\u2019s a proxy to a foreign gem. \nWhat about putting it inside a before_initialize block? Are engine config/initialize files read before host apps files? That would be preferable. Someway where the host app is able to set it in a default (read: mentioned in money gems readme) kind of way and we still act as fallback/default? . Leaving it like that means that from the moment we ran this spec we always raise for deprecations even if we change this in the spec helper in the future. Either wrap the spec in a\nrb\naround do |example|\n  Spree::Deprecation.silence { example.run }\nend\nor do what @kennyadsl proposes.\nThird possibility is to remove specs for deprecated methods.. We should use @promotion as the  object. That way stores could restrict adding codes to specific promotions instead of all. . Wrong indention. .full_messages.to_sentence will do the same as .join(', ') but uses an \"and\" as last divider. Very unlikely we have more than one error, but still :). I think we should use the same capitalization we use on the other translations . Sure, we can do that in another PR. Yes. Thanks. If you already toggle the class admin-nav-extended on the body, why not toggle the visibility of the nav via CSS? That way you could also add a nice transition effect.. The current position gives the impression that this could be a back button. I think we should move this button into the navigation itself and use a double arrow. See this example on GitLab:\n\n. Here you could add all the CSS magic for showing and hiding the nav bar. For instance:\n```scss\n.admin-nav {\n  transform: translate3d(0, 0, 0);\n  transition: transform 350ms ease-in-out;\n}\nadmin-nav-toggle . fa-chevron-right {\ntransform: rotate(0);\n  transition: transform 350ms linear;\n}\n.admin-nav-extended { \n  padding-left: 0; \n.admin-nav { \n    transform: translate3d(-100%, 0, 0);\n  }\n#admin-nav-toggle .fa-chevron-right {\n    transform: rotate(180deg);\n  }\n}\n``. Instead of changing the innerHTML of the toggle icon in JS we could also use some CSS magic to rotate it if we toggle the body class.\n. I don't think we need this change of innerHTML if we use CSS to transform the icon. So this is only for the order screens? What about other sections in the admin? Wouldn\u2019t they also need a bit more spacing from the bottom? Wouldn\u2019t it be better to add a bottom padding to the body wrapper instead?. Every div with an id ofbillingnow gets a top margin? Could we use a more specific selector instead? Or add a utility class that handles these cases? There are probably more places in admin where a form is built like this form?. Why this extra lambda?. We do not need to explicitly test the implementation ofmake_default` here, as you already have an expectation about the default payment source in the next test.\nAlso, I prefer to test changes like this:\nrb\nexpect { subject.add_to_wallet }.to change {\n  order.user.wallet.wallet_payment_sources.count\n}.by(1). I suggest to make this a protected method.. I like Elias idea of using simple callables, but Albertos approach is working well and is tested (not that easy with lambdas), so I think it's fine. The outcome is the same. \nWhat I do care about is the very thoughtful work that is done here and want to give an extra appreciation! Very nicely done, Alberto! \ud83d\udc4f . Typo \u201cSolidus\u201d over \u201cSpree\u201d please :). Could you explain why you added a second module for active storage support? Why not have these methods in the other module as well?. Actually I thought about not adding this at all, as we generate the changelog from PRs before we make a release. But the PR description asked me to add changelog entries. We should remove the changelog note from the PR description IMO. We can't expect from contributors to maintain a changelog in a PR (The don't know the PR # and the release this is being merged in anyway). Shouldn't we advice to use the config/initializers/spree file instead?. We should make this consistence over the guides. This is not a very human friendly error message. Could we use\n\"already has this payment source in their wallet\"?. Shouldn\u2019t we allow all attributes a payment source can have? There is more than credit cards. Since this is admin only I am fine with \nsuggestion\n      self.admin_payment_attributes = [:payment_method, :amount, :state, source: []]\n. ",
    "felixbuenemann": "Fore those that already have the migration from solidus_multi_domain the following should fix the solidus warning that the migration already exists:\ngit mv db/migrate/*_add_store_payment_methods.spree{_multi_domain,}.rb\nIf you don't do this solidus will complain:\n[Spree WARNING] Missing migrations.\n[Spree WARNING] add_store_payment_methods from spree is missing.\n[Spree WARNING] Run `bundle exec rake railties:install:migrations` to get them.\nThe migrations are the same except for a null contraint on the timestamp columns, which is the default in newer rails versions. Make sure to upgrade to solidus_multi_domain >= 1.1.0 first.\n. You forgot to update core/db/default/spree/zones.rb which creates the EU and US zones without checking if the entries exist.\n. ",
    "gildardoperez": "Order Confirm Email HTML Template:\n```\n app/views/spree/order_mailer/confirm_email.html.erb \n\n\n\n\u00a0\n\n        <% if @order.billing_firstname %>\n          Dear <%= @order.billing_firstname %>,\n        <% else %>\n          <%= t('.dear_customer') %>\n        <% end %>\n      \n\n        Thank you for your purchase from <%= @store.url %>.\u00a0Please review and retain the following order information for your records.\n        <%#= t('.instructions') %>\n      \n\u00a0\nOrder Number: #<%= @order.number %>\nOrder Date: <%= @order.created_at.strftime(\"%m/%d/%Y\") %>\n\u00a0\n<%= t('.order_summary').upcase %>\n\n\n\n\n\nSku\nName\nQty\nPrice\nTotal\n\n\n\n\n\n\n\n        <% @order.line_items.each do |item| %>\n          \n\n              <%= render 'spree/admin/shared/image', image: item.variant.display_image, size: :mini %>\n            \n<%= item.variant.sku %>\n\n              <%= item.variant.product.name %>\n              \n              <%= item.variant.options_text -%>\n            \n<%=item.quantity%>\n<%= item.single_money %>\n<%= item.display_amount %>\n\n        <% end %>\n        \n\n\n\n\n\n\n\n            <%= t('.subtotal') %>\n          \n\n            <%= @order.display_item_total %>\n          \n\n        <% if @order.line_item_adjustments.exists? %>\n          <% if @order.all_adjustments.promotion.eligible.exists? %>\n            <% @order.all_adjustments.promotion.eligible.group_by(&:label).each do |label, adjustments| %>\n              \n\n\n                  <%= t('spree.promotion') %> <%= label %>:\n                \n<%= Spree::Money.new(adjustments.sum(&:amount), currency: @order.currency) %>\n\n            <% end %>\n          <% end %>\n        <% end %>\n        <% @order.shipments.group_by { |s| s.selected_shipping_rate.try(:name) }.each do |name, shipments| %>\n          \n\n\n              <%= t('spree.shipping') %> <%= name %>:\n            \n<%= Spree::Money.new(shipments.sum(&:total_before_tax), currency: @order.currency) %>\n\n        <% end %>\n        <% if @order.all_adjustments.eligible.tax.exists? %>\n          <% @order.all_adjustments.eligible.tax.group_by(&:label).each do |label, adjustments| %>\n            \n\n\n                <%#= t('spree.tax') %> <%= label %>\n              \n<%= Spree::Money.new(adjustments.sum(&:amount), currency: @order.currency) %>\n\n          <% end %>\n        <% end %>\n        <% @order.adjustments.eligible.each do |adjustment| %>\n          <% next if (adjustment.source_type == 'Spree::TaxRate') and (adjustment.amount == 0) %>\n          \n\n\n              <%= adjustment.label %>\n            \n<%= adjustment.display_amount %>\n\n        <% end %>\n          \n\n\n              <%= t('.total') %>\n            \n\n              <%= @order.display_total %>\n            \n\n\n\u00a0\n\u00a0\nWe will notify you when your order ships. If you have any questions, please contact us at <%= @store.mail_from_address %>.\n        <%#= t('.thanks') %>\n      \n\n\n\n\n```\nPreview Template:\nhttp://localhost:3000/rails/mailers/spree/mailer_previews/order/confirm. Preview confirmation emails path: http://localhost:3000/rails/mailers/\nSource code core copy from: /solidus/core/app/views/spree/order_mailer/confirm_email.text.erb\nOverride code path on your app: /app/views/spree/order_mailer/confirm_email.html.erb\n. ",
    "jsurdilla": "Added a few model specs. Any suggestions on a good way to test the rabl caching? A bit of research didn't turn up anything.\n. ",
    "121onto": "I've been working with React+ Redux to build replacement Spree fronted.  You can get up and running with only a few modifications.  This project helped me get my bearings. \nReact ain't bad.  Its much more accessible than it was when I first looked at it in 2015.  I am enjoying my time with it!\n. I've been working with React+ Redux to build replacement Spree fronted.  You can get up and running with only a few modifications.  This project helped me get my bearings. \nReact ain't bad.  Its much more accessible than it was when I first looked at it in 2015.  I am enjoying my time with it!\n. You can add the file yourself.  Use this as a template:\nhttps://raw.githubusercontent.com/spree/spree_auth_devise/master/config/initializers/devise.rb\nInside the config block, add the line:\nruby\n  config.secret_key = ENV['DEVISE_SECRET_KEY']\nOr (untested) set a value for secret_key_base in your config/secrets.yml.\n. You can add the file yourself.  Use this as a template:\nhttps://raw.githubusercontent.com/spree/spree_auth_devise/master/config/initializers/devise.rb\nInside the config block, add the line:\nruby\n  config.secret_key = ENV['DEVISE_SECRET_KEY']\nOr (untested) set a value for secret_key_base in your config/secrets.yml.\n. ",
    "kaleemullah360": "do \ngem 'mysql2', '~> 0.3.18' this gem works with rails version 4.x.x \nif install gem 'mysql2', '~> 0.4.0' it produces gem load error\n. ",
    "grzlus": "Thanks! I don't even know, that this fork exists. In future I'll be doing changes, if it's possible, to both projects.\n. Yes, it looks like something is wrong. I'll check that when I'll have moment and upload correct code.\n. I made a typo in code. Now tests passed :)\n. Ok, I don't insist on 303 redirects. It was just a proposition.\nOne thing that I'd like to see in controller code, is extract logic for selectiong collection and rendering it to separate method. Currently this is used in 3 places in your controller.\n. @gvaughn Exactly. You put ogic of rendering in one method, so in future, when you decide to add for example decorator, you change it only once.\n. I don't like setting variables in conditional statements. I propose 2 different wat how to handle it:\nreturn {} if masseged_params[:order].blank?\nmassaged_params[:order].permit(permitted_checkout_attributes)\nupdate_params = massaged_params.fetch(:order, {})\nupdate_params.permit(permitted_checkout_attributes)\n. I think, that explicit call assign_attributes will look better there.\n. You don't need to check if user_id is not null. If user is null for order, then CreditCard will be not found, so find will throw exception.\nIn case when user_id is null, you can just stop executing code and throw exception. I don't know if there could be order without user at all.\n. Using DISTINCT that way, will not work in PostgreSQL (if I undestand correctly, why distinct is used there). In documentation, we have example:\nSQL\nSELECT DISTINCT ON (location) location, time, report\n    FROM weather_reports\n    ORDER BY location, time DESC;\nSo when we want to show records with unique spree_product.id then we need to add ON before field name, but this is not compatible with other DBs.\n. Wthis could be also written as:\nRUBY\nwhere(spree_classifications: { taxon_id: taxon.self_and_descendats.pluck(:id) })\n. Using NullRelation is a good idea, but should we proceed that method, when there will be no card at all?\n. This will not be so easy: https://github.com/rails/arel/blob/master/lib/arel/visitors/to_sql.rb#L298 Only PostgreSQL has implemented visit function for distinct_on\nYou need to guess what DB is used and use distinct/distinct on :disappointed: \n. So name it create_or_update and make alias.\n. I think that this is a good place to introduce 303 See Other HTTP status. I use it in my projects, to minimize amount of duplicated code.\nCurrently I see that in 3 places code @user_addresses = current_api_user.user_addresses is used. You can move it to some method, to avoid duplications, but I prefer solution with redirect. When non-GET action is successfull, then server can respond with redirect_to action: :mine, code: 303. This means: Everything was successfull, to get information about current resource see this URL.\nI know that this is another request, but browsers follow that redirections automatically.\n. I don't get it. You don't use normal REST resource, but you pass params there. What exactly you want to do with that code?\n. Ok, so first of all Law of Demeter. Your code shoud be simple, do only one thing. In that case responsibility of rendering resource is in other action, so redirect user to correct resource to get it.\nSecond case could sounds strange, but I know from experience, that some servers has garbage collector enabled between requests. So faster response (with redirection) means faster garbage collection and freeing server resources.\nAnd third - If I want use API without getting resources rendered on every update, I can disable follow redirects, because after all updates I'll pull it in one request. It's also edge case.\n. @jordan-brough When you raise this exception by yourself then you don't need to perform query.\nOf course it's better to define custom Exception, in other part you can catch your exception, not general ActiveRecord::RecordNotFound - because, what record is missing (user, card, shop)? Custom exceptions are good.\n. As I mentioned in first comment - this is good time to discuss adding 303 to project, because you added new code, where we can use it.\n. Don't left empty parentes in lambdas.\nThis scope is so small, that should be in one line.\n. This conditions could be moved to 2 scopes: default and not_archived. This could be reusable in other places.\n. As I understand relation correctly, then we should have resources :addresses that is automativally in User scope. User can manage his addresses.\n. The query ends up being where user_id is null and user_id is not null and on top of that this is an indexed field. I can't imagine performing the query will be a performance problem.\nBut this is still a query, that you can avoid. In production env you can have DB on different machine, so there is not served via Unix Socket.\n. @\u2026 As I siad, NullRelation is a good idea. The whole conversation is about \"Does 1 query matters\".\n@jordan-brough When your database is is overloaded, one simple query like:\nSQL\nSELECT 1 FROM users WHERE email = \"\u2026\"\nThis query (email has index) could take 5-30s. It happens, so query with contraction in clauses probably be also delayed, because there is no resources to process it.\n. ",
    "kamui": "Added yardoc to the country_iso= method.\n. ",
    "alexstoick": ":+1: Nice one! \nThanks\n. @jhawthorn any plans on getting this into a 1.0.x release?\n. :+1: we have this in our app, and I'd be more than happy to port this over\n. @athal7 @jhawthorn I'm also :+1: on being explicit about something like this. I think it can be risky to leave this sort of logic hidden, especially as it represents one of the very central pieces of the system. \nAt LostMyName we have quite a complex shipping matrix, and having this sort of explicitness embedded in the system can sometimes makes things a bit more difficult to get off the ground, but in the long run we found it very valuable.\n\n. @athal7 Made these changes to the code but I can't work out a suitable name for said boolean - using available_for_all at the minute.\nAlso another headache-y bit is represented by the shipping_methods method which now gets a bit messy. I have to approaches there (active one + commented out one), but I'm open to suggestions on how to make either nicer!\nIt'd be good to get your thoughts on this before going to Admin side of things!\n. :+1: on this!\n. :+1: \n:shipit:\n. Had a brief talk with @metade today (cc @jordan-brough), and I have a suggestion about doing this. We can rename the address field on the shipment to optional_address, so as not to break anyone's existing setup, and also enable us to do interesting split shipments scenarios, for the people that need them.\nSo then the address function on Spree::Shipment could look like this:\nruby\ndef address\n  shipment.optional_address || order.ship_address\nend\nMore thoughts on this?\n. @jhawthorn Made the change requested \ud83d\udc4d . @gmacdougall An index is effective if the DB can partition itself into somewhat good sized chunks. Our use-case for this column would be that we have 1 or 2 values that are true and a bunch of them being false, which means that the DB would do a sequencial scan instead of using the index.\nHere are the 2 queries with EXPLAIN ANALYZE:\nWITH INDEX:\n=> select id from spree_promotions where apply_automatically = true;\n...\n(18 rows)\nTime: 1.345 ms\n```\n=> explain analyze select id from spree_promotions where apply_automatically = true;\nQUERY PLAN                                                                       \n\nBitmap Heap Scan on spree_promotions  (cost=22.50..11609.82 rows=368878 width=4) (actual time=0.056..0.060 rows=18 loops=1)\n   Filter: apply_automatically\n   ->  Bitmap Index Scan on spree_promotions_apply_automatically_idx  (cost=0.00..4.05 rows=184439 width=0) (actual time=0.048..0.048 rows=18 loops=1)\n         Index Cond: (apply_automatically = true)\n Total runtime: 0.079 ms\n```\nWITHOUT INDEX:\nselect id from spree_promotions where apply_automatically = true;\n...\n(18 rows)\nTime: 101.613 ms\n```\nexplain analyze select id from spree_promotions where apply_automatically = true;\nQUERY PLAN                                                      \n\nSeq Scan on spree_promotions  (cost=0.00..13247.27 rows=368878 width=4) (actual time=94.509..96.446 rows=18 loops=1)\n   Filter: apply_automatically\n   Rows Removed by Filter: 737738\n Total runtime: 96.464 ms\n```\nThe difference from 1ms to 100ms is big!\nLet me know if you have any other questions!. Tackled one part of this in #1933. @mamhoff rebased!. :+1:\n. :+1: on both \n. @jhawthorn This is quite an issue, and I was just trying to get my specs to go green. \nHowever, since I have looked around and it's a difficult one to find. This is because with this PR we now have a dependency between: shipping_method and stock_location. In most factories these get created separately and for the code to work, we need to link them.\nSo now we have two solutions:\n1) If we don't do this here, we'd have to replicate it through most factories, and my gut feeling is that this will be quite difficult in some particular cases (ie: factories which call other factories...)\n2) Do this here and try and find a way to clean it up.\n\n. TIL about Spree::Base\n. ",
    "Kingdutch": "EDIT: I may have spoken too soon as I see that payments without payment sources already seem possible. However since my understanding is limited at the moment I'm leaving the original message below in the hope that it contributes anyhow.\nI would really like to see work on this or see how I could help with this. I've currently been trying to roll my own subscription service, mostly because most that's out there is aimed at using Credit Cards. Solidus can take a lot of work out of my hands in building my own service but I would need support for extendable payments that don't use credit cards.\nThe payment methods I would need (and would be willing to help implement as I would have to do that anyway) are iDeal (used by 85% of Dutch online shoppers) for one-off payments and SEPA which is used for recurring payments.\nI must admit I'm not familiar with the current state of Solidus payments but one thing that I see as a potential problem is the requirement for a Payment Source (unless I misinterpreted this issue). For example, iDeal is trusted and used in the Netherlands precisely because it is not a payment source. (SEPA comes closer to this, especially with Stripe's implementation which I would like to use).\niDeal works roughly as follows, which is why I think it doesn't qualify as a payment source:\nThe website requesting a payment contacts its iDeal service provider (usually their own bank or an intermediary) and requests a payment with a description for a certain amount. It then receives a token identifying the payment. Using this token it redirects the user to the website of the user's bank where the user can complete the payment in a trusted environment. After the payment is completed (or cancelled) the user is redirected back to the merchant's website. The earlier token that was used to identify the transaction can then be used (either in webhook or query form I'm not sure, both should be possible) to retrieve the status of the transaction. \nAs described I don't think iDeal constitutes a payment source but rather only gives information about whether a payment was succesful or unsuccesful and allows the website to act accordingly.\nAs stated I would be happy to help in see how payments could be implemented. In other frameworks that I have used I think this would be a great place for polymorphism. Having a Payment interface class that can be used to query the status of a payment and complete a payment and having various subclasses that actually implement the inner workings (e.g. storing credit card details and billing, redirecting to Stripe for secure credit card handling, redirecting to iDeal or using SEPA for a recurring  charge). \n. Not having rails g solidus:auth:install just tripped me up. I thought I followed all the instructions in the README but I didn't follow the instructions in the other README.\n. What is the motivation for not showing filters for few records? I can admit that it provides a slightly cleaner page but it means that the user experience changes depending on a somewhat arbitrarily chosen limit.\nAn example use case for filters with less than 10 records would be someone implementing bulk editing with a select all field. Using the filters I could easily filter down to just the items I know I want (typing is faster than scrolling and clicking). Hit select all and be on my way.\nFurthermore it means that the user can become familiar with the available filters the first time browsing the page. Knowing that it's there too when more items are added. I would probably be confused if I were evaluating solidus with only two items present and it seemed to lack basic filtering capabilities.\n. I can understand that for an eCommerce system such as Solidus there are many moving parts and so it's not easy to just jump in and get going. I'm still of the believe that there should be, even for expert developers, better starting points than the code itself.\nI'm not sure where to place myself on the developer level scale. I've been building websites for a bit over 12 years. Rails has only been a part of that for 6 months now (I've probably missed out) but I have seen a few other ways of implementing eCommerce, mostly in other languages so I feel like I should be able to utilise Solidus.\n\nyou're better off with Shoppify or WIx or Squarespace..\n\nI have looked at each example named (and a few more) and although I love development, my goal at this moment is to get something off the ground, sadly each of the existing solutions with the features I want doesn't provide the iDeal and SEPA payment options (which account for 80% of the Dutch market). Which leaves me with little choice but to roll my own. \nWhat I've seen of Solidus so far makes me believe that it can be a great solution, I just have to figure out how.\n. Just wanted to chime in that the work you've done so far looks really good : ) \nGives a good overview of the way Solidus approaches solving the e-commerce challenge. \nI also like the comment about the Spree namespacing as that was something that first tripped me up too.\nAs a new developer it gives me some nice handles to start exploring. I realise there's the normal rails structure, but that makes 200 models still a bit overwhelming. With this set-up I can see what the most important models are and then start exploring from there, finding the dependencies and helper classes.\n. Thanks for the reply explanation and for showing me a new bundler trick :blush:\n. I've pushed the code that was created by the steps above to the repo at: https://github.com/Kingdutch/solidus-scope\n. Typing this up helps to think of possible workarounds:\nIndeed installing the solidus_frontend gem and running bundle exec rails g spree:install where I force the overriding of the Spree initializer (I hadn't changed anything to that from stock). Results in an installation that works as expected.\nThis probably means that the title of the issue should be changed to \"solidus backend depends on solidus frontend\"\n. Does that mean then that solidus_auth_devise actually has a dependency on solidus_frontend?\nI went from the following text which is in the first part of the README\n\nIt is also possible, however, to use only the pieces you are interested in. For example, you could use just the barebones solidus_core gem and perhaps combine it with your own custom frontend instead of using solidus_frontend.\n\nThis gave me the impression that the solidus_backend should just work without having solidus_frontend installed. That way I could later implement the frontend which would indeed have the  layout you described but in my initial setup with just one option for a product so no need for a cart.\n. This looks great! \nCould you give some feedback on what it would look like on mobile devises? e.g. Will the help text for the helpful layout simply be shown before the form or will it be hidden completely?\n. Having the buttons at the top actually tripped me up a few times. I believe most applications have their buttons after the content (of course both is possible). I usually look at the state of a page then look to the bottom right to figure out what I can do. I actually missed some of the Solidus buttons in the top right on my first run through.\n. Closed as per discussed on Slack \n. This can probably be closed as it seems to have been committed as 8d4ba1e75558dd2f0007c7cd549ae70957219e25\n. to should probably be from\n. ",
    "paultyng": "Another use case would be user entered price (ie. variable priced gift cards), which I guess falls under pricing by custom attributes?  We also do item pricing based on customization in our store, and we do all our price determination at add to cart (before_validation on: :create), or whenever the line item is updated but the order is not yet complete.  For example a cart edit type interaction.\n. ",
    "darbs": ":+1:  But how would this differ from adjustments on line items? Much like @paultyng we do pricing based on customization with adjustments. One thing also to consider is price changes that one wouldn't want to be affected by promotions. In our use cause we want promotions to only affect the price of the product not the fees that would be incurred through customization.\n. ",
    "alepore": "i solved some similar problems with the \"Price Lists\" approach, see here: https://github.com/alepore/rfcs/blob/705601769eaec76319308a6108d8b15452523f93/active/000-price-lists.md\n. The multiple prices support is a common problem that keeps coming out on my projects.\nI'm wondering if the \"price list\" approach could be taken into consideration to be included on the Solidus core.\nFull explanation from the former Spree RFC:\nAbstract\nI'd like to move the current \"price belongs to currency\" Solidus logic to a more\nflexible \"price belongs to a price list\".\nA price list is a way to differentiate multiple prices of the same item.\nMotivation\nA Store may need different prices for the same product/variant, for\ndifferent reasons (see below for a non-exhaustive list of examples).\nSolidus currently supports different prices if they have different currencies,\nbut in my experience this is not always the case in the real world.\nI'm proposing this because I needed this feature on some projects and the\ncurrent Solidus prices/currency logic was a clear limit.\nHere are some use cases (actual sites, 2 on production and 2 on development):\n- A fashion store needs a different price for each zone. Actually, some brands\n  have a specific price list for some countries and they want to follow this.\n  They like to use the same base currency (EUR) on all lists to keep things simple.\n  The payment gateway will do all the currency conversions.\n- A B2B store has 3 different price lists. Each agent is assigned to a price\n  list. Currency is the same for all lists because the target is the same country.\n- A B2B + B2C store has different prices for public clients and internal\n  agents. Currency is the same.\n- A furniture store wants to use two different prices, one for their home\n  country and one for the rest of the europe. Currency is always EUR.\nDetailed Design\nI've done a Spree extension for this feature, the code is at\nhttps://github.com/freego/spree_price_lists.\nIt's probably not production ready, it was extracted from a project and it's\nmissing tests.\nLooks like this is similar to https://github.com/spree-contrib/spree_price_books,\nbut I think my version is more simple and \"generic\".\nI saw some logics on spree_price_books that are probably extracted from a\nproject with very specific needs.\nOn Solidus, a variant has many prices. This is a good start point, but it's also\nvery limited in my opinion because of the currency stuff.\nInside Solidus, currency is just a string and is passed as parameter on many\nmethods, expecially during the checkout process.\nI want to change this to pass a price list reference instead.\nA price list is a simple model which can just have a name and a currency in\nthe most basic form.\nThis will not change any behavior for simple stores, because you'll just have\na default price list with your preferred currency.\nThis should enable flexibility to easily add any kind of custom logic for price\nlist selection.\nFor example, on the mentioned fashion store I get the user location from the IP\naddress and I load the right price list on the fly.\nOn the B2B store, I get the price list from current_user object.\nThis should be just a matter of overriding a method, which by default gets the\ndefault price list.\nDrawbacks\nWe have to add some logic to determine which list should be used on each\nrequest.\nThis can degrade performance, but on a basic Solidus store this can be just a\nsingle, cachable query like PriceList.first or similar.\nAlternatives\nI can just keep improving the extension.\nI'm totally for keeping the Solidus core as simple as possibile and using\nextensions, but in this case I think needed changes are too \"low level\".\nI need many decorators to overwrite many important methods, and it's only to\nswitch from currency to price list.\nThose methods also change often: I basically rewrited everything between Spree\n2.3 and 2.4, and it needs some more work for 3.0.\nAnother alternative I tried was to keep Solidus as is and to add \"fake\"\ncurrencies, like \"EU1\", \"EU2\", all with the same \u20ac symbol.\nThe main problem here is that fake currencies doesn't work in the real world.\nFor example, you can't pass them to a payment gateway.\n. Also, Rails 5 should improve development performance http://weblog.rubyonrails.org/2015/11/11/snappier-development-mode-in-rails-5/\n. > some sort of roll-back mechanism to remove the effects of ineligible promotions from an order is required\ni was thinking the same thing, like a standard PromotionAction method (normally blank) that's called for ineligible promotions.\nsome of them (like this one) can use it to \"clean up\" stuff\n. Just an update:\ni did a quick hack adding two methods on a site of mine:\nPromotionHandler::Cart when ineligible calls Promotion#deactivate, which calls each PromotionAction#rollback\nit's a pretty easy solution and works for me (TM), but i'm on spree 3 and i'm using a custom action\n. I'm not sure about this, the products and general settings pages have sometimes no direct relation with their sub items.\nWhy would i load the products index page if i want to edit taxonomies?\nI'd prefer changing the \"Products\" parent labels to something like \"Products and Taxons\", or splitting products and taxonomies to different menus.\nAlso note that the general setting page is really not a \"listing\" page, it's just one of the many settings pages, probably on of the lesser-used ones on production sites :)\nYour proposal makes sense for the promotion menu though, but that's because it's very specific and only contains promotions stuff, imho.\n. The \"Taxon\" submenu also has a bad name: i always rename it as \"Products Ordering\"\n. > what custom menu items have you added that would/wouldn't fit into this model?\nI always use the main labels just to group similar things, for example:\n\nI grouped all their custom resources together, and the client asked me to make another group for the homepage stuff, because it's easier for them.\nThat's why the \"proposed menu\" model doesn't fit for me.\nI have sites with 15+ different custom resources pages and i'd like to have the flexibility to group them as i (or the client) want.\n. makes sense.\none question: will admin templates remain \"deface friendly\" with data-hooks?\nthis is very useful for extensions, imho.\n. :+1: removing this from the core and move the problem to solidus_i18n.\nif you don't use solidus_i18n you probably have only one language (english).\nnow, with solidus_i18n + I18nData it's still slow and need some fix, but probably not that slow on production (i get 60ms on an average server).\n. sure.. updated just using the rails validation for all the stuff\n. i also don't like HTML helpers... except when they have 5+ lines of code and partials may become worse :)\nabout helpers, spree 3.0 moved some stuff on the frontend, this could be a good start: https://github.com/spree/spree/tree/master/frontend/app/helpers/spree\n. totally right about ol, number are actually there, i tested the wrong frontend :disappointed: \n. yeah this has gone too far... will open some small incremental PRs!\n. updated!\n. @jhawthorn right, i solved adding .unscoped\n. agree!\ni just copied that from the other models, but would be a good thing to remove all those non-critical default_scope, add a small Sortable module and keep coherence.\ni can take that!\n. so.. back on this.\ni forgot about that @Senjai PR and messed up with a force push :)\nrecreated lost commits, this is not now complete and rebased.\n. good question!\n. @cbrunsdon thanks to you for solidus ;)\n. the concept is to have models \"default scopes\" without default_scope... if that's is a good idea.\ni totally understand that this is somewhat controversial and may just add complexity and documentation needs.\nthe problem is mostly a (big) globalize problem, so we can also move all the problem to solidus_globalize: \"how to override solidus stuff to avoid N+1 queries\"\np.s: \ncan this also may be useful for sortable products as discussed in #703 ?\ni mean, instead of adding .sorted everywhere, you always add .base_scopes, and for sortable models,sorted scope is included...\n. \ud83d\udc4d i like the display_includes naming, updated commit.\n. i'm late here but \ud83d\udcaf thanks for this, this is a big improvement and a very much needed one! \ni can probably build a clean and lightweight version of spree_price_lists on top of this...\n. A correction about Italy: there are regions but they are not used for shipping. There's another sub-level, provinces, and that's what we need to use for Italy. . @flyfy1 i think i did that check because an app could already contain that field (mine, for example).\nNot sure about the spring issue, can you try with unless column_exists?(:spree_taxons, :depth) ?. it was useful at the time: i had an app on previous Spree version, with that field, and did the Spree upgrade :)\nIt's useless now for new apps, yes.\nBut anyway, column_exists? is the right way to do that :). maybe relevant, a state machine implemented with classes: https://github.com/gocardless/statesman. Hi, thanks for your contribution!\nFirst of all, this will need some discussions about if/how/where to do this thing, so if you urgently need this on your project, please implement it on your codebase.\nSo the issue is: if you have thousand of products with a property like Color => white, you translate \"Color\" once, and \"white\" thousand of times. Right?\nThis actually makes sense if you think at the product property like a field of the product itself, like the description. \nSome stores may also have lots of products with the same description, would you merge them?\nBut this is not ideal in your situation, i understand it.\nIn my opinion the whole properties management is not perfect, because Property types are matched by their name in the main language.\nThis wasn't probably designed with translations in mind.\nExtracting property values will lead to another situation when we match objects by a string value in some language, that can be very long, and can change, so i'm not really comfortable with this solution.\n. @tvdeyen or we can maybe provide both files on new installations, with some deprecations comments inside spree.rb?. ",
    "adaddeo": "I see two distinct problems:\nOne is price differentiating, or looking up a specific price for a variant based on some criteria. Examples of this are:\n- different pricing by country\n- different pricing by user\nTwo is price modification, or calculating an adjustment on the price of variant based on some criteria. Examples of this are:\n- bulk discounts\n- pricing by certain attributes\nThis comment focuses on problem two; as our project uses two extensions of that nature, one performs bulk discounts and the other does \"pricing by certain attributes\". \nI think @athal7 is on the right track, but attempting to extend promotion rules will run into problems when you:\n1. Need to make positive adjustments (add $1 for bacon on your burger)\n2. Are forced to choose between these promotions\n3. Extend with arbitrarily complex logic\nI propose the solution lies in providing well-defined extension points into the item adjustment framework, so new types can easily be added and hooked into ItemAdjustments for recalculating. This is what we do with our extensions (but in the class_eval style) and it has worked out tremendously.\nFor instance, we have a BulkDiscount model that mirrors the TaxRate model in a lot of ways, it is automatically added to a LineItem during it's after_create callback and then recalculates itself in ItemAdjustment's update. All of it's logic is neatly encapsulated and it just \"works\" (minus having to class_eval).\nIn general, the adjustment flexibility comes from:\n1. Adjustments can be applied in arbitrarily complex ways, you can have something like the TaxRate which is always added or PromotionAction which is applied using a ton of \"outside\" information (i.e. coupon codes, order, user, etc) and logic.\n2. Adjustments can be calculated in arbitrarily complex, you can have a PromotionAction that uses a simple calculator, or a TaxRate which is calculated using a ton of \"outside\" information (i.e. zones, addresses, taxation systems) and logic.\nBut despite all the potential complexity, at the end of the day there is a simple API for items to take on, and keep updated (through ItemAdjustment), any number of adjustments.\nThere are some definitely some tricky parts but all in all I think if there was an easy way to hook into ItemAdjustment so that arbitrary adjustment scopes could have their adjustments updated and value updated on the item in question, stores could write extensions of type two quite cleanly.\nSide notes:\nWe use the term modifier for \"pricing by custom attributes. This is a term we pulled from the restaurant industry that fits this pretty well (ex: burger ($6) + add bacon ($1) + add jalapenos ($0.50)).\n. That'd be great. We want the ability to create new kinds of adjustment sources that maintain their own total, add them to adjustable items, and have them recalculate appropriately during updates, just like tax_rates and shipments.\nExample:\nCreate a new adjustment source called NewAdjustmentSource, it implements adjust, compute_amount, etc. Add new_adjustment_source_total to orders, line items and shipments. Just like a tax rate or promotion action, we can apply it to adjustables and it is updated whenever that item changes.\n. @jhawthorn did that make sense or is there any additional information I can provide you with?\n. We have two uses: one is a bulk discount extension that can be assigned to products (similarly to tax categories/rates) and configured to stack on promotions or not; the other is an extension to line items that adds optional customizations (think cafepress.com), line items become unique based on a variant and a customization, with some customizations adding additional fees based on quantity.\nThese extensions work extremely well for us and the existing adjustment logic is perfect for them. The only negative is having to monkey patch ItemAdjustments to get them updated and persisted, however, once they are setup they work flawlessly.\nApplying all non-tax, non-cancellation adjustments instead of just promotion adjustments would work. My PR included a bunch of name changes that I thought made more sense, but I understand the hesitation of making changes without a ton of need/thought. The only crucial things required to open up adjustments are:\n- In ItemAdjustments, add hooks for other adjustment types to:\n  1. Recalculate other_adjustment_total for item by calling update! on other_adjustments scope\n  2. Include other_adjustment_total when persisting the updated adjustment totals\n- In OrderUpdater, add hooks for other adjustment types to:\n  1. Calculate other_adjustment_total in update_adjustment_total\n  2. Persist other_adjustment_total in persist_totals\nEDIT: We currently us run_hooks in OrderUpdater to calculate other_adjustment_total for the order and persist it. If we had a similar option in ItemAdjustments it would most likely suffice. It would still be great to have an abstracted, simple way to say hook in another adjustment type.\nAssuming that made sense, a few finer grain changes that would really make this open to extension would be an additional scope called competing_adjustments that is passed to Spree::Config.promotion_chooser_class here, so other adjustments can optionally compete for the \"best promotion\". And also replacing/opening up discounted_amount with something where other adjustments can optionally include themselves to be taxed or not here.\n. @jhawthorn I know that was long, but wondering if you had anymore insight/feedback before this got stale?\n. I was reading #425, using a save here rather than update columns would be a nice step in allowing extensions to add their own adjustments here.\n. @athal7 in reference to 2, we have multiple shipping methods with the same name so that we consistently offer the customer the same options, but use the internal name to further describe what categories and zones that particular method is servicing. Ex: \n- Name: Standard, Internal: Standard (accessories, continental)\n- Name: Standard, Internal: Standard (accessories, non-continental)\n- Name: Standard, Internal: Standard (alcohol, international)\nThat being said, if the zones and the categories were both displayed on the index page, it wouldn't be necessary to have this internal name to distinguish between the different methods.\n. Welcome.\n. This was fixed by @gus4no . @ridem is there somewhere in your application that you are performing configuration before the engine is loaded, something similar to: app.config.spree.payment_methods << Solidus::Gateway::OtherGateway?\n. options= has been useful and frustrating for us.\nCurrently there isn't one standard way to permit and assign additional attributes on line items.\nOrderContents provides a way to assign additional attributes, but Core::Importer::Order doesn't use it and instead calls line_item.update_attributes directly.\nApi::LineItemsController provides a way to permit additional attributes, but these don't help when using Importer::Order to create an order with line items, and OrderContents has it's own way of permitting additional attributes.\nThe way forward seems to be:\n- Contain all logic for assigning additional attributes to line items in OrderContents\n  - Remove line_item.update_attributes from Importer::Order\n- Leave all parameter permitting logic to the controllers\n  - Remove ActionController::Parameters#permit from OrderContents. I don't think there is a single other instance of parameters being permitted like this outside a controller in the codebase.\n- Use the existing PermittedAttributes module to provide a DRY and extensible way of permitting additional line item attributes\nI actually tried to take a shot at all this in #1112, but it could've been more direct.\n. Great stuff!\n. Thanks, looking forward to trying this out!. > (see doc changes to simple_coordinator)\nCould you link this? Definitely been using Rails/Solidus for a while still get confused by the initialization process.. #1051\n. ",
    "dhonig": "This should be interesting.  Would love to see some numbers on it...\n. @cbrunsdon +1 for pulling deface out of core.\nWhy it is a nice and elegant piece of work by @bdq  I don't think it has ever found a comfortable home in the wild in Spree projects.\nIts one saving grace was that it was very useful in what became spree_backend for a standard way of customizing things, but even that can be argued.\n. @gmacdougall absolutely this is a desired feature!  @peterberkenbosch will be watching as I've done alot of promo work lately on Spree 2.4, and would love to be helpful where I can.\n. I agree with splitting taxonomies and products, so long as it is not done in the awful way it was originally back in the early days, but maybe its that awful taxon editor still hurting me..\nTaxons and Taxonomies should be a separate top level concern than products rather than being buried underneath a 'products' tab.\n. :+1:  Definitely worth mentioning in release notes and probably has a permanent place in an upgrade guide when that is written.  Happy to help with the upgrade path gents.\n. Thanks @cbrunsdon this is helpful feedback.  I could not really make up my mind if this made more sense all in one rule, checking for both cases, or rather a tiny and discrete rule that does exactly what it says on the tin.\nI suppose we could filter out this+that effectively...and all of this detail means its simpler as two seperate rules.\nOnce I get a PR together for this, I'll send a PR.\nps-Wouldn't mind an invite to Slack when you get a chance!\n. :+1:   The only other thing would be to be able to mark individual preferences as static.  But this option is the right start.\n. We did a bunch of work on it back in Feb.  If there is interest in using this extension I'd be glad to work on porting our fork of it.\n. Cool!  I'll do an initial investigation over the holiday period and see how\nmuch is involved.\nOn Tue, Dec 22, 2015 at 7:26 PM, blacktea3937 notifications@github.com\nwrote:\n\nthank you @cbrunsdon https://github.com/cbrunsdon, I actually test the\nSpree_marketplace at Spree_drop_ship on Spree. I can't say they run very\nsmoothly. Quite some bugs. Spree_marketplace is only workable on Spree 2.3,\nnot even 2.4.\nIf @dhonig https://github.com/dhonig can make it compatible with\nSolidus, that will be great! I believe there will be a good interest for\nthis extension with Solidus!\nthank you @dhonig https://github.com/dhonig and @cbrunsdon\nhttps://github.com/cbrunsdon!\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/issues/617#issuecomment-166767866.\n. Worth mentioning that Product Prototypes may help resolve the issue:\nhttps://guides.spreecommerce.com/user/product_prototypes.html \n. @Senjai  both SOLR and ElasticSearch can deal with filtering on product properties with the existing models just fine for filtering and or faceting/aggregations.  The trick is just configuring the index correctly and creating the right code for populating the index.  I think you need a really good reason to create models outside of the spree norms, not sure if just replacing properties is a good enough one.\n In publishing you have a set of standard metadata such as ISBN, etc that is usually a part of every product, for this case I think it makes sense to have another model to represent these attributes....But it is interesting to know that people are having problems filtering on properties with Ransack.  To me this is something that might deserve a bit more attention.....\n. So another example not mentioned that I am dealing with right now is when shipping methods are used in combination with promotions.  For example, spend more than 200.00, receive free expedited shipping.  The code I have inherited is hard coded to find the shipping method by the admin name, which someone may change not realizing they will cause something downstream to break.    so :+1: \n. @mamhoff  I don't know that STI is used anywhere else in Solidus, do we really want to open this box?  When is a JSON data structure vs tables the answer and when is it not?  ( And I am pro STI, in general I think it leads to elegance in design, just not sure we want to introduce it if it is not already used.)\n. @jrochkind exactly.  There are so many places we could potentially use STI, that I think its important we know exactly why we are introducing it, and when it is justified.  Once it is introduced, then you will see lots of proposals using STI.   If we are going to introduce this design, then we musn't let it fall into the pervasive documentation vacuum that exists.  We should clearly document it and say, this design emerged for specific conditions, etc.  Its totally true that every payment method will have an unpredictable field set in a wallet that might contain, NFC, direct banking such as ACH and credit card sources.  So this is a sensible hack from that point.\n. Is there any advantage to StatesMan other than what appears to be a much better API, it is extremely similar to what is already there via the state_machine gem, or am I missing something?. This makes sense.  Going through the Config opposed to the class  further separates the usage from the implementation. +1. We will be glad to help you with this one:\n https://github.com/AlchemyCMS/alchemy-solidus\n\nNot sure of the state of refinery.   . I'd like to see this merged.\nI'd also like to set it up somewhere people can kick the tires and observe\nit in action.\nI also think that the Hierarchy around MailProcessor could be cleaned up a\nbit to make it a more clear design.\nFor example adding a \"BaseProcessor\" would be a simple improvement.  Maybe\nthis is there and I've missed it?\nOn Tue, Oct 9, 2018 at 11:16 AM swcraig notifications@github.com wrote:\n\nThanks for pointing out the stale code @fastjames\nhttps://github.com/fastjames. I think the community is still unsure\nwhether they want to see this change in Solidus. Once we get the green\nlight I will rebase and update the branch with the changes.\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/solidusio/solidus/pull/2431#issuecomment-428233348,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AAOZrwiaM9oBLTKM__E1jgXaqtkwLlhBks5ujL3KgaJpZM4Q43sV\n.\n. @tvdeyen @kennyadsl   Just bringing this one up for attention since it came up in support this morning.  My own thoughts are that this is really good work but it breaks new ground in a direction that we need to be careful of.   What I mean is that the same problem can be solved purely through adjustments.   When a new model is introduced we have to weigh the benefit of the new model vs increase in complexity it brings.  In my own experience with large stores, there are anomalies that happen with adjustments and incomplete orders that can be very hard to track down. This design could help in those cases, but the last thing I want to see are more models chucked into core without very careful scrutiny and a vision for how they fit into coherent future direction.   That vision could be simply expressed as favor adjustments for these concerns and we'll use implicit models for these other concerns.. @skukx  Really glad you brought this up.   Really good suggestions on the changes.  It would be great to modernize how errors are reported.  I'm not sure anyone has given this some good thinking in ages.. Looks good to me so far. Nice work!. @ericsaupe @tvdeyen  I've been using the AirBNB style guide for JS and React on projects outside of Solidus when no better alternative is already provided.   I've found it to be pretty sensible in most cases though some devs have argued to relax certain points.   I think its important to stress the importance of using good tooling to make working with ESLint pain free.   For example both VS.code and Webstorm have very good plugins that automate working with ESLint, maybe even make it fun....So lets make sure we mention tooling in the docs.. Obvious issue with the plugins and echosystem as well.\n\nOn Thu, Feb 14, 2019 at 1:41 PM Dustin notifications@github.com wrote:\n\n@jarednorman https://github.com/jarednorman agreed. i've looked into\nthis. i see two issues: updating namespace and db migration e.g. -\nsolidus_.\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/solidusio/solidus/issues/3065#issuecomment-463742334,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AAOZrzBP-1UiBHM9J3G5PW_flsPrQI6fks5vNa3WgaJpZM4aa6aP\n.\n. I dont think we should swim up the stream here.   Lets just go webpack and call it a day. Or lets just drop the spree_frontend altogether!  I have a working graphql imple already!. +1 for docker.\nIt opens up lots of cloud platforms.  Maintenance shouldn\u2019t be too hard. Ill be glad to help. @kennyadsl would be great to get @kinduff on the core team to improve\ncommunication and increase our contributions!\n\nOn Mon, Feb 25, 2019 at 11:16 AM Alejandro AR notifications@github.com\nwrote:\n\n@kennyadsl https://github.com/kennyadsl That's awesome. Let me know how\nI can help or if I can be added as a collaborator \ud83d\udc4d\n\u2014\nYou are receiving this because you commented.\nReply to this email directly, view it on GitHub\nhttps://github.com/solidusio/solidus/pull/3106#issuecomment-467119161,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AAOZr7rixwwCtF2vWAmCJQu35BAO21k6ks5vRCiZgaJpZM4a_KMz\n.\n. Nice work all!\n\nIf there is interest in a development setup I would be happy to donate that.. One idea that I presented at the conference was remembering the idea of\nApple migrating from MacOS to OsX.\nThey had the concept of  Yellow Box which was the new OSX interface and\nBlueBox the old interface.\nI spoke about this in Memphis, and how we could use this paradigm for a\nmigration in model.\nWe could have the current extensions and label them \"Blue\" and the new\nmodel based on a\nmuch smarter plugin model and then give extension authors 12-18 months to\ncome into compliance\nwith the new extension model.\nA few challenges:\n1.) Designing or adapting a good plugin model\n2.) Evangelizing to the community this is a good idea\n3.) Providing support,documentation to plugin authors\nBut I think its worth it! And I think we can serve the community better by\nmaking the plugin migration a curated experience vs\na bit of a guessing game.   Naming our intentions and providing clear\nguidelines will go along way!\n-dh\nOn Fri, Mar 1, 2019 at 4:14 AM Alberto Vena notifications@github.com\nwrote:\n\n@dustineichler https://github.com/dustineichler\nsuggestion on title change?\n[RFC] Should the new extensions template create a Rails Engine?\nWhat about something like this?\nmight be worth closing and moving to solidus_cmd too.\nI think we can discuss here since it has more visibility and then\neventually create PRs on the solidus_cmd repository referring to this PR.\n@jarednorman https://github.com/jarednorman\nSure, I was not criticizing this approach, and it's clear to me that this\nwas intentional.\nProviding good documentation is a great way to delegate to each store for\nthe rest of the implementation.\n\nI was thinking that it could be a good idea to provide 2 commands (or an\noption) to create a new extension with solidus_cmd but maybe it's not\nworth it since the extension without the Rails Engine skeleton would be\nvery similar to a new gem created with Bundler with bundle gem new_gem,\nWDYT?\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/solidusio/solidus/issues/3120#issuecomment-468597555,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AAOZrxmK6IkXygyxIM-q8y2nvHgRh5Otks5vSO-DgaJpZM4bJ5-j\n.\n. \n",
    "austenito": "I should say that controller specs are being deprecated :)\n. @magnusvk yup. We'll need to fix the routes on our end before upgrading solidus. Good thing we have tests :) :tada:\n. @jhawthorn yup. Fixing now.\n. @jhawthorn @athal7 Here's a stab at the sorter/selector extension points we talked about in slack. \n. - Removed the sorter and selector classes out of the method signature\n- Added expectations around using the configured sorter and selector\n. @jhawthorn updated!\n. @jordan-brough updated :D\n. @jordan-brough @jhawthorn fixed said nitpick!\n. Great. We will be posting up a pr soon for early feedback :)\n. This is the first of a series of PRs related to PR #518. We would like some feedback on our approach of adding a recipient override to return authorizations.\n. - [x] Update Spree.user_class to use Spree::UserClassHandle.new\n- [x] Could you try find(\"#customer_search a\").click instead? Using execute_script can cause timing problems because there's no guarantee the element is on the page yet when this is run.\n. @jhawthorn as a heads up, we added another change to this PR, which is validating if return items are eligible for an override recipient. (we will fix the build failures shortly!)\n. Closing this PR as we are going another direction.\n. Sure thing.\n. Cool. I'll make the changes\n. I like adding a manage_address_book action. My only question is if adding a specific action to cancan goes against their convention. I believe most of them are :display or restful-like actions. @Senjai would know more that me.\n. I've created another branch using the approach @jordan-brough described. This seems reasonable :D\nhttps://github.com/solidusio/solidus/compare/master...austenito:address-book-authentication-with-user\n. Great! I'm going to close this PR and open a new one. Thanks everyone!\n. It's fine for us. I originally added it's own action in case that would be too permissive for others.\n. Sounds reasonable. I will update.\n. More a preference. They get created eventually. I don't feel strongly one way or the other. Will change!\n. Sure! That's pretty handy. Didn't know about merge.\n. Sounds good! Will fix.\n. @mbj I'll add a spec to verify that.\n. I went with doubles in this case since all that matters is the selector and sorter implement find_default and sort. If the implementation changes to use a different method or renames them, then you would need to update the test in either case.\nI'm curious as to the reasoning behind implementing the method in the test class.\nAlso, it appears the global state gets cleared :)\n. @jordan-brough Cool, makes sense. In the selector test, I want to assert \"Did the shipping rate get selected\", which state verification.\nFor the sorting test, I want to assert behavior, which is the right place to verify sort gets called.\nI'll update the selector test :)\n. @jordan-brough I chose to use a constant instead of lets in this case to do some state verification for clarity. It's probably not the best since it's globally available, however the alternative is stubbing out the shipping rate. \n. Updated again to return a real ShippingRate to verify state instead of behavior. :)\n. Cool didn't know that existed. Will update.\nAs a side note, we have the same Spree.user_class in our migration file. Is there a better way around using Spree.user_class there?\n. Yeah we had trouble opening the customer search box. We really didn't want to use execute_script as well. We'll try your suggestion instead. :)\n. We need the volatile attribute because of the way the interface works. See attached screenshot (Please ignore styling for now). We expose a checkbox allowing users to override the reimbursement recipient. This is handy in the case where a user checks the box but doesn't select a user.\n\n. Here's what it looks like without the override checked.\n\n. @jhawthorn We thought of a couple options here. \n- Override create in \n  https://github.com/solidusio/solidus/blob/master/backend/app/controllers/spree/admin/return_authorizations_controller.rb which inherits from https://github.com/solidusio/solidus/blob/master/backend/app/controllers/spree/admin/resource_controller.rb#L52. We could allow create to be aware of the user wanting to override a recipient.\n- The current approach, which hooks into the AM attributes hooks.\nAre you thinking of another option or do you prefer to leave the logic in the controller? We went with the model level approach because 1) we don't have to override #create 2) We get validation messages for free. For example, if a user checks the Override Recipient box and fails to select a recipient, we automatically get the Recipient can't be blank error message.\n. ",
    "sebfie": "Is the backend view missing  to link a stock to a shipping method? I can not find options in my backend.\n. Hello,\nYes, multi times get the same result. Did you reproduce it?. I implemented what @loicginoux said and in fact we have for the moment one issue : \nWhen sending a carton with partial products, the shipment switch to state \"pending\" instead of stay in state \"ready\".\nI think it's due to this code (perhaps): \nhttps://github.com/solidusio/solidus/blob/v2.2/core/app/models/spree/shipment.rb#L81\nIt tooks all inventory_units.all? instead of inventory_units.on_hand? maybe? \nBecause after a partial shipment (one carton with half products for example), some inventory_units are not shippable anymore\nI did not have time to debug this part, but I will do it shortly, and maybe make a PR for that.\nThx for your time !. Did you reproduce this on previous version? :). No, I just want to send severals cartons for my shipment.. In fact, In my code i just use: \nSpree::OrderShipping.new(order).ship(\n          inventory_units: inventory_units,\n          stock_location: stocklocation,\n          address: order.shipping_address,\n          shipping_method: order.shipments.first.shipping_method,\n          shipped_at: Time.now,\n          external_number: \"test_number\",\n          tracking_number: \"12345\",\n          suppress_mailer: true\n        )\nYou can specify inventory_units you want to ship, so I suppose you can send a shipment on multiple cartons? Is not why carton exists?\nMaybe I did not understand the shipment. My case is : \n\n\nAn order has : \n3 bottles A\n4 bottles B\n\n\nMonday I send 3 bottles A and 1 Bottes B => Partial\n\nTuesday I send 2 Bottles B => Partial\nWesnesday I send 1 Bittle B => Shipped\n\nFinally, I will have 3 cartons. Yes, but to be able to send the shippable, the shipment should have the state \"ready\". Thx for this analysis :). Hello everyone, the solution of @jhawthorn looks good and seams to solve the issue ! Are you agree with that @kennyadsl ? \nDo I open a new pr or change the existing one?\nThx. Ok thx. Ok, thank you. So, can we merge it? We need it in our project :) . Alright, I will wait \ud83d\udc4d . I saw and fixed some rspec and it does not break backorders . So we should change the def allow_ship? method. So I wait your feedback before to add some tests?. For me, it seems the right way to do. . ",
    "fastjames": "I had the same question, so I dug in a little bit and found that the approved feature was introduced here:\nhttps://github.com/solidusio/solidus/commit/a0c69672a96f1a11d2dad265ac353d589eb099ae\nit was intended to appear when an order is considered \"risky.\" Beyond that I can't tell that clicking the button does much, so maybe the feature was never completed? Also, the considered_risky flag was removed in 2015 (https://github.com/solidusio/solidus/commit/1e241f7193b3d434e31ccd3d1acc288069647f5b) so I think the button is a stale artifact.. Based on prior experience with other ecommerce platforms, I would expect the site to prevent me from adding an unbuyable product to my cart when I click the \"add to cart\" button. The proposed validation looks like the optimal solution to me, since it stays in the existing error flow and also works without JS (e.g. on API calls).. Every time I read this PR I get a little bit giddy, as it would make the job of extension authors (like me) much easier.\n@jhawthorn I understand what you are saying about a callback not getting a consistent environment.\nI would be fine with events always running through ActiveJob as I think that enforces the right kind of decoupling. If someone then wanted a synchronous event, it feels like \"publish event and wait for some sort of resolution\" could be built as a feature atop the first part.\nI would love to talk more about this feature and what, if anything, we can do to help it see the light of day.. Still burning a :candle: for this one. To blend with v2.7 it needs to be modified slightly, pointing to Spree::Config.order_mailer_class and Spree::Config.reimbursement_mailer_class rather than calling the classes directly.. The extension point for styles is unneeded and breaks some parts of the admin. Back to the drawing board.. I would prefer to leave it as-is as well, so maybe I need to lock it to a pre-name change version? That would be a less invasive change. My goal here is to help extension authors who run CI against older versions. I had trouble getting versions with factory_girl to pass so I might have been doing something wrong.. Glad I could generate some discussion! To answer an earlier question from @tvdeyen I came to this because I had an extension whose specs were failing, and the errors seemed to point to the uphill factory_girl dependency as the culprit (because it was not pinned). With time comes understanding, and I would be happy to pin to either of the mentioned versions. If 4.10.0 creates deprecation messages and we don't want to fix them, then I would prefer to pin to 4.8.1. I am pushing a new commit with that in it now.. I can reproduce the poltergeist timeout error, but not the other one; it seems to be related to the time being taken to compile assets.. I can see a possible case for reintroducing the guard with a switch related to the config setting that requires login.. Sorry for the delay, I have been unable to get back to this today to reproduce and record the error. Will do so as soon as I can.. I ran into a situation recently where the removal of this method caused problems with an extension that tried to override it. Would it be possible to leave the send_foo_email methods in place and have them call the publish method instead? That would allow extension authors to update their tricks before things stop working.. Updated. Updated. Agreed. Maybe at one point there was not a state selector on the test checkout, but I guess that's no longer the case.. This seems reasonable, done.. Agreed on maintaining some level of backcompat. I have made this change.. Good point, I don't want to be a polluter. I have moved it into the feature block.. ",
    "jasonfb": "I fully support it being extracted if it is an island of functionality. We are heavily dependent on a complex hybrid system that relies on both Kount scoring and our own internal fraud tools to have orders in this 'limbo' (completed but not sent to the 3PL) state until they are approved by our fraud department. \nAs you may have guessed, we leverage the (removed in 2015) field considered_risky significantly. An order stays marked risky until it gets approved by an approver. Nearly all the big store have such a system. \nIf Solidus is to have no fraud functionality, then I think extracting it into a gem makes a lot of sense. But this seems odd to me, as hacking & fraud are both seriously on the rise globally, it seems like a robust fraud-management (at least, to gate the orders) should be a first-class functionality in a modern e-commerce platform. . do you want me to just pull request Spree PR #6794 against Solidus?\nwithout un-deleting already deleted records, you still retain a host of bugs related to nil objects. The bulk of the heavy lifting in Spree PR 6794 is to backport the change to eliminate the undefined method for nil bugs, which was the primary driver for me (the feature of discontinuing in the future was an added bonus). \n. Yes I understand the reasoning behind moving slowly. However, adding a discontinued_on (or available_until) was not the primary objective of my work, the primary objective was to fix the dozens and dozens of bugs I have seen across multiple stores that are related to deleted objects. That issue has cost literally hundreds and hundreds of hours of developer time. That was the primary objective, the added feature was a side-benefit.\nYou're right it is a significant change, and upgraders would need to re-think their scoping mechanisms if they aren't already using the patched available scope. \n\n\nacts_as_paranoid was not removed from the product, despite some of its necessary functionality being removed\n\n\nI'm not sure what you mean by this. By \"its necessary functionality\" are you referring to the ruby magic that happens to mysteriously re-show deleted objects? That's an anti-pattern, and leads to very bad bugs, and no one should code like that. It's true I left acts_as_paranoid in there, for when you really do want to delete something, but you shouldn't make deleting a normal part of a workflow. \nAs far as \"fixing line items of deleted products\" I think you are referring to the rake task, which only happens if you run it explicitly, of course, and you will note the migration does not edit any line items. \nI do realize it's \"seems\" like a drastic change, but in my view simply adding a small available_until feature is just a small band-aid when the real problem is the flawed design and the dozens and dozens of bugs created by the design. Without addressing the root problem it seems like you aren't actually fixing what is arguably one of the worst bugs in Spree itself. \n. Yes ok I understand, thank you for your patience. In that case my issues about the nil bugs can be considered off-topic to this specific GH issue as you had originally filed it. \n. this never got in Solidus did it? @jhawthorn @athal7 -- upon (6 months of..) consideration, I think we should indeed go with @jhawthorn's original suggestion which was just to add the available_until (although I'd recommend discontinued_on so that all the timestamp fields consistently end with _on ) at this time, laying the groundwork for the switch-over.\nTo that end, we can make both the db migrate and the rake task you see in https://github.com/spree/spree/pull/6794 into rake tasks, with instructions for how to use them. That way, this change is not forced on anyone and they can use the rake tasks to clean up their own data. \n. @bbuchalter -- I'm not exactly sure how an abstraction of the field's name would serve a greater purpose; at some point, we're gonna have to add a field (or two) and name it something. But all that a field-name abstraction would achieve is letting different stores have different data models, which becomes less-than-desireable, for example, when a 3rd party tries to build an integration against the 'solidus 1.3' data model, for example. (Unless i'm missing the point of the proposed field-name abstraction)\nAlthough I like the idea conceptually, it seems like it would have greater power when applied to something like a scope override (which, incidentally, this feature upgrade will need too)\nfor example, our in-app (messy) available scope looks like this\nscope :available, -> (available_on = nil, currency = nil) {\n    scope = joins(:master => :prices).where(\"#{Spree::Product.quoted_table_name}.available_on <= ?\", available_on || Time.now)\n    unless Spree::Config.show_products_without_price\n      scope = scope.where('spree_prices.currency' => currency || Spree::Config[:currency]).where('spree_prices.amount IS NOT NULL')\n    end\n    scope.not_discontinued\n  }\nI could see an abstraction for something like so:\nmake_available_using :available\n(:available being the existing scope), so that a store could re-implement their own availability scope without having to overload the existing :available scope\nmake_available_using :available_for_realz\n. FWIW, we just have discontinued_at on both spree_products and spree_variants. The only thing that mildly bothers me about the naming convention is that in the Spree/Solidus world, some timestamp fields end with _on where was outside of Spree/Solidus the convention I have seen in nearly all other Rails apps I have worked on is to end timestamp fields with _at. \nbut I could go either way on that point. to keep parallel with available_on I'd just suggest discontinued_on\n. @dt1973 @hakkiplaten are you recommending that someone copy all of the views from the Solidus core code into one's own app? This is not really considered best practice. Generally people copy only views & partials that they want to override from the core code, not all the views in one copy. \nI think there should be a specific guide for \"Customizing Solidus\" which should cover this topic indeed, as well as other ways to customize, but I wouldn't recommend a full copy of all the view files into your own app. \n. @davidpatters0n --- You should not have an existing User model, but solidus_auth_devise will create one for your, it is called Spree::User (or spree_users in your database). That's your User model.\nAlthough you can implement solidus with a different user model, I believe you are correct in that if you use solidus_auth_devise you should be using the standard Spree::User object as your user model. \n. :+1: \nam I crazy to suggest something like MediaWiki as a 'scratch pad' for writing docs? (Maybe not even the 'final home' of said docs). I guess what I'm envisioning is something so easy to edit and is community-oriented and MediaWiki seems like it takes away all the Git workflow and pull request stuff. \nmaybe just using Media Wiki as a place to draft the guides while we are collaborating on them, and them when they are more polished moving them back into Git? \nMostly I am coming at this from an efficiency perspective. \n. I have no \"Edit on Github\" button for the Solidus repository and I don't think most people do either--- I think that's reserved for core team members. I think the essence of this endeavor is to broaden the number of people working on this, to take the task of the documentation off the core team's plate. \n. the sample app is definitely a fresh install, it is public at m GH here https://github.com/jasonfb/solidus-1-1-helloworld\nupon examination right now I realized I didn't install the right gem version for this one anyway\nI will try this again... standby....\n. Indeed. Upon using heroku pg:reset and re-migrating the same instance, the migrations run through cleanly. given this, and your inability to reproduce @dangerdogz, I think we can chalk that up to a Heroku/Postgres fluke\n. FWIW, I rename all my 'dropped' columns to _DEPRECATED (all-caps for nice readability), leave them as _DEPRECATED for about 2 months, then go through routinely and actually drop the deprecated fields.\n(Yes I do this on all my columns, even from Spree migrations, which means I have to go through migration-by-migration and modify them to do this)\nI just scanned my own codebase and found 2 small places in which we are relying on the address association on the shipments, but this will be easy for me to fix (when the time comes), as I could simply change it to .order.ship_address\n. What do you do if you want an exchange shipment to go to a different address? (For example, when the original address was wrong and the package was returned to sender).\nWe use the Shipment's address for this in the context of exchange shipments only. \nMy feeling is that the Order's ship_address is the one the customer put the order in as, and the Shipment's address is the place the package actually got shipped to (which may have been changed by Customer Service). Seems like, although duplicitous, each has a function as its own data point\n. What do you do if you want an exchange shipment to go to a different address? (For example, when the original address was wrong and the package was returned to sender).\nWe use the Shipment's address for this in the context of exchange shipments only. \nMy feeling is that the Order's ship_address is the one the customer put the order in as, and the Shipment's address is the place the package actually got shipped to (which may have been changed by Customer Service). Seems like, although duplicitous, each has a function as its own data point\n. @jordan-brough Makes sense. I think the impact to us will be minimal --- differing address is an edge case. \ncc: @chrishawk -- for our app we can probably get away with following their lead and delegating up to the order; with the possibility of future support for differing addresses as a planned extension\n. note this is on a Spree 2.4 upgraded store; on my helloworld solidus (v 1.3) the /admin/promotions URL works as expected\n. this was fixed by manually setting the 'default' flag on the 'Sample Store' record in spree_stores to true (1)\n\nchanged to\n\n. closing ; cross-reference https://stackoverflow.com/questions/37244912/on-solidus-1-3-fresh-install-validation-failed-store-cant-be-blank-when-addin/37244913#37244913\n. I could see a good use case for this but it seems to me that in our store, this would encourage the Marketing team to create roles exclusively for specific promotions, which would lead to a proliferation of roles and open the door to abusing what should really be thought of as a system for access control (role-based ACLs)\nthen again, one could indeed make a compelling argument for access to a Promotion itself is an example of access-control permisssions (like, for example, the 'Reseller' role could get a special discount, or everyone with the 'Employee' role could get a discount). \nIt would be unfortunate, however, if a given Marketing team abused this, and stated creating Roles for everything (like, each monthly cohort is Role-based, segmentation becomes all Role-based).\nIn fact, the danger of such a slippery slope is so great that I would prefer not to have this at all in my app. \nTo work around this problem, we have successfully implemented tag-based Promotion rules, that involves using acts_as_taggable on the User model instead of using Roles for this. (which is a completely alternative strategy). It is my intention to roll out an extension to Solidus that includes both the acts_as_taggable implementation, as well as a very similar Promotion rule that ties a Promo to a specific tag, thus allowing only users tagged with that tag to use it. \nAlternatively, maybe this functionality would be a good candidate for an extension to allow stores to Opt-in for it?\n. I could see a good use case for this but it seems to me that in our store, this would encourage the Marketing team to create roles exclusively for specific promotions, which would lead to a proliferation of roles and open the door to abusing what should really be thought of as a system for access control (role-based ACLs)\nthen again, one could indeed make a compelling argument for access to a Promotion itself is an example of access-control permisssions (like, for example, the 'Reseller' role could get a special discount, or everyone with the 'Employee' role could get a discount). \nIt would be unfortunate, however, if a given Marketing team abused this, and stated creating Roles for everything (like, each monthly cohort is Role-based, segmentation becomes all Role-based).\nIn fact, the danger of such a slippery slope is so great that I would prefer not to have this at all in my app. \nTo work around this problem, we have successfully implemented tag-based Promotion rules, that involves using acts_as_taggable on the User model instead of using Roles for this. (which is a completely alternative strategy). It is my intention to roll out an extension to Solidus that includes both the acts_as_taggable implementation, as well as a very similar Promotion rule that ties a Promo to a specific tag, thus allowing only users tagged with that tag to use it. \nAlternatively, maybe this functionality would be a good candidate for an extension to allow stores to Opt-in for it?\n. \ud83d\udc4d \n. see http://stackoverflow.com/questions/37244912/on-solidus-1-3-fresh-install-validation-failed-store-cant-be-blank-when-addin\n. what happens if you open the rails console and do\nSpree::Taxon.find_by_permalink!(\"type-of-tea/white\")\nDo you get the taxon your are looking for or do you get not found?\nIf you don't get the taxon, make sure the taxon you are thinking you should be loading has a permalink of \"type-of-tea/white\"\nif you do get that taxon, go into the Solidus source code and debug directly inside of the show method, stepping through it line-by-line until you can determine what it is doing and why it is rendering your 404\n. hmm... it looks likes you don't have type-of-tea/white set as the permalink for a taxon ?\n. it seems odd to me that it says \n\"spree_taxon_translations\".\"permalink\" = '--- !ruby/object:ActiveRecord::StatementCache::Substitute\nunless I'm reading wrong is a cache object being passed in some kind of inspected way to the SQL query?\ndoesn't seem like that --- !ruby/object should be in the SQL\n. it seems odd to me that it says \n\"spree_taxon_translations\".\"permalink\" = '--- !ruby/object:ActiveRecord::StatementCache::Substitute\nunless I'm reading wrong is a cache object being passed in some kind of inspected way to the SQL query?\ndoesn't seem like that --- !ruby/object should be in the SQL\n. @jhawthorn As you suggested, I wrapped the whole form in a div with a class .return-authorization-form-wrapper\nsee associated commit in solidus_shipping_labeler https://github.com/solidusio-contrib/solidus_shipping_labeler/commit/b587cf3a5d7add0b06bbaa80d3d8d9ecca3e42c1\n. @jhawthorn As you suggested, I wrapped the whole form in a div with a class .return-authorization-form-wrapper\nsee associated commit in solidus_shipping_labeler https://github.com/solidusio-contrib/solidus_shipping_labeler/commit/b587cf3a5d7add0b06bbaa80d3d8d9ecca3e42c1\n. I agree with @adammathys, deleting is an anti-pattern that has cost hundreds and hundreds of hours for me personally and cost huge sums of time for the companies i have worked for.\nThe problem is easy to replicate, simply delete a payment method.\n@jhawthorn -- your test does not cover the actual crash reported by the posted (which admittedly is somewhat vague). He was referring to the 'show' page of the payment, not the Order payment page which you have tested \nthe stacktrace is as follows, I was able to reproduce this in seconds on the solidus-helloworld app:\nhttps://gist.github.com/jasonfb/cd85451cbce6941c08ff3e334cc21941\n. I agree with @adammathys, deleting is an anti-pattern that has cost hundreds and hundreds of hours for me personally and cost huge sums of time for the companies i have worked for.\nThe problem is easy to replicate, simply delete a payment method.\n@jhawthorn -- your test does not cover the actual crash reported by the posted (which admittedly is somewhat vague). He was referring to the 'show' page of the payment, not the Order payment page which you have tested \nthe stacktrace is as follows, I was able to reproduce this in seconds on the solidus-helloworld app:\nhttps://gist.github.com/jasonfb/cd85451cbce6941c08ff3e334cc21941\n. The root of the evil is that things should never be deleted once they are referenced -- \"soft-delete\" is a convenience that is useful for auditing, but horrible when things that shouldn't be are actually allowed to be deleted, as is the case with these payment method objects as well as products & variants. I am working on a PR to address this problem in products & variants.\nFor payment methods, we should move towards adding a \"discontinued_at\" or a \"retired_at\" flag to be used instead of deletion. \nI feel strongly that code littered with .with_deleted scopes (as Solidus currently is) is a serious anti-pattern and I will continue to push to address this serious, serious problem in the software. \n. The root of the evil is that things should never be deleted once they are referenced -- \"soft-delete\" is a convenience that is useful for auditing, but horrible when things that shouldn't be are actually allowed to be deleted, as is the case with these payment method objects as well as products & variants. I am working on a PR to address this problem in products & variants.\nFor payment methods, we should move towards adding a \"discontinued_at\" or a \"retired_at\" flag to be used instead of deletion. \nI feel strongly that code littered with .with_deleted scopes (as Solidus currently is) is a serious anti-pattern and I will continue to push to address this serious, serious problem in the software. \n. @jhawthorn -- you failed to mention in your statement \"I wrote a spec and it seems to work for me\" that you also fixed the bug using a code change in https://github.com/solidusio/solidus/pull/1190\nI am documenting here for completeness. Your statement \"I wrote a spec and it seems to work for me would lead one to believe that it worked the way you found it, with no code changes, which is inaccurate. \n. @jhawthorn -- you failed to mention in your statement \"I wrote a spec and it seems to work for me\" that you also fixed the bug using a code change in https://github.com/solidusio/solidus/pull/1190\nI am documenting here for completeness. Your statement \"I wrote a spec and it seems to work for me would lead one to believe that it worked the way you found it, with no code changes, which is inaccurate. \n. Are multiple store supported natively in core? I thought support for this was provided though the solidus_multi_domain gem. It would seem logical then that it is that extension's responsibility to provide this. \n. Are multiple store supported natively in core? I thought support for this was provided though the solidus_multi_domain gem. It would seem logical then that it is that extension's responsibility to provide this. \n. this is an anti-pattern and should not be allowed to proliferate throughout the codebase, although I do realize it fixes a bug today.\n. this is an anti-pattern and should not be allowed to proliferate throughout the codebase, although I do realize it fixes a bug today.\n. Yes fair enough. This does indeed fix a bug so... \"bob's your uncle.\" (That's something Europeans say right?)\n. Yes fair enough. This does indeed fix a bug so... \"bob's your uncle.\" (That's something Europeans say right?)\n. +1 for moving to controller concern at this time. It seems to me that if it isn't a datapoint on the actual database then it shouldn't be tied up with state_machine transition hooks which primarily are the concern of the models.\n(which I realize is slightly counter-intutive to the slim-controllers-fat-models paradigm, but in this case makes sense to untangle the worse problem of tying this up with the transition hooks)\n. +1 for moving to controller concern at this time. It seems to me that if it isn't a datapoint on the actual database then it shouldn't be tied up with state_machine transition hooks which primarily are the concern of the models.\n(which I realize is slightly counter-intutive to the slim-controllers-fat-models paradigm, but in this case makes sense to untangle the worse problem of tying this up with the transition hooks)\n. One other thought... (perhaps a feature request). It seems to me that every e-commerce company will want their T&C checkbox in a different place (ours, for example, is on Registration/Log-In), so it would be cool if perhaps the implementation allowed for it to be on any step, and configurable through customization. Not sure if that is already accounted for in your design @SebAshton -- or if that is prohibitively more work --- it just seems to me that the core code would best serve all stores if it accounted for that. \n. One other thought... (perhaps a feature request). It seems to me that every e-commerce company will want their T&C checkbox in a different place (ours, for example, is on Registration/Log-In), so it would be cool if perhaps the implementation allowed for it to be on any step, and configurable through customization. Not sure if that is already accounted for in your design @SebAshton -- or if that is prohibitively more work --- it just seems to me that the core code would best serve all stores if it accounted for that. \n. @flyfy1 --- I, like you it sounds,  found referencing a form without a data-hook impossible with Deface. Similarly submitted https://github.com/solidusio/solidus/pull/1178 (not same area of app).\nIt occurs to me we should standardize the data hook names themselves, as well as underscore vs. dashes ? \n. @flyfy1 --- I, like you it sounds,  found referencing a form without a data-hook impossible with Deface. Similarly submitted https://github.com/solidusio/solidus/pull/1178 (not same area of app).\nIt occurs to me we should standardize the data hook names themselves, as well as underscore vs. dashes ? \n. @flyfy1 --- I, like you it sounds,  found referencing a form without a data-hook impossible with Deface. Similarly submitted https://github.com/solidusio/solidus/pull/1178 (not same area of app).\nIt occurs to me we should standardize the data hook names themselves, as well as underscore vs. dashes ? \n. definately \ud83d\udc4e on two field-sets with the same exact data-hook name -- this seems bonkers to me\n. definately \ud83d\udc4e on two field-sets with the same exact data-hook name -- this seems bonkers to me\n. definately \ud83d\udc4e on two field-sets with the same exact data-hook name -- this seems bonkers to me\n. would you explain what you mean by \"generalize the slug\" -- do you mean denormalize (move data into a separate table) ? Sorry I think some developers use terms differently that's why I'm asking-- just to make sure I understand your meaning. \n. would you explain what you mean by \"generalize the slug\" -- do you mean denormalize (move data into a separate table) ? Sorry I think some developers use terms differently that's why I'm asking-- just to make sure I understand your meaning. \n. I think my marketing team would also concur with \ud83d\udc4e  on inelegant UUIDs in Urls. It seems to me that a normal workflow would involved copying the product, changing its slug to one that is in fact unique, and then copying it again, thus eliminating the double-copy uniqueness problem. \n. I think my marketing team would also concur with \ud83d\udc4e  on inelegant UUIDs in Urls. It seems to me that a normal workflow would involved copying the product, changing its slug to one that is in fact unique, and then copying it again, thus eliminating the double-copy uniqueness problem. \n. (speaking big-picture here) It seems that the transition hook stuff we're never really going to get around as long as the order has state transitions before being complete,  and that a sensible approach is to simply recalculate totals inside of the Updater as suggested. I know that our code relies heavily on the Updater doing its job, and we know that whenever any total might change we must call the Updater.\nAs far as the lack of OrderUpdater#update being called in the CheckoutController#update -- moving in this direction would make most sense (and figuring out how to make the notorious @order.next easier to debug). It seems to me that until the state transition problem is tackled, calling the Updater explicitly is a fine expectation. As long as it is in the release notes clearly I do not thing we need to be overly concerned with supporting existing implementations that fail to call the updater correctly after a total has changed, which probably already have bugs due to their existing implantation.\nFinally, the tax gem we use is boomerdigital/spree_avatax_certified. As you discussed above, it submits the whole order (in XML I think), including individualized itemization of each lineitem, in a single transaction (that, yes, is resubmitted when thing change).\nYes, because items can cross tax categories, the taxes need to be calculated on a line-by-line basis\n. (speaking big-picture here) It seems that the transition hook stuff we're never really going to get around as long as the order has state transitions before being complete,  and that a sensible approach is to simply recalculate totals inside of the Updater as suggested. I know that our code relies heavily on the Updater doing its job, and we know that whenever any total might change we must call the Updater.\nAs far as the lack of OrderUpdater#update being called in the CheckoutController#update -- moving in this direction would make most sense (and figuring out how to make the notorious @order.next easier to debug). It seems to me that until the state transition problem is tackled, calling the Updater explicitly is a fine expectation. As long as it is in the release notes clearly I do not thing we need to be overly concerned with supporting existing implementations that fail to call the updater correctly after a total has changed, which probably already have bugs due to their existing implantation.\nFinally, the tax gem we use is boomerdigital/spree_avatax_certified. As you discussed above, it submits the whole order (in XML I think), including individualized itemization of each lineitem, in a single transaction (that, yes, is resubmitted when thing change).\nYes, because items can cross tax categories, the taxes need to be calculated on a line-by-line basis\n. I was just going over this point on someone else's PR .... a direct \"Refund\" as implement (from the Admin payment screen, issued directly against an order OUTSIDE of the Returns Auth process) is kind of a bad news feature. \nOur Cust Service team can't give it up, although I am trying to get them to process all refunds through the RA process. The problem with the refunds the way they are is that essentially you can't issue Refund Tax transactions against them, which is appropriate in all cases when you give $ back to someone (this is basically impossible AFAIK because there is not relationship from the refund to the return item that it is refunding, thus making the TAX CODE impossible to know)\nTo your scenarios:\n\n\nUser completes an order for widget A ($10) and widget B ($20) and submits payment\nUser receives their shipment and reports that widget B is broken\nAdmin provides a refund for the broken widget B\n\n\nthis should be treated as a return, even if the thing doesn't come back, and thus go through the RA process which will issue a Refund tax transaction correctly\n\nUser completes an order for widget A ($10) and widget B ($20) and submits payment\nUser asks to have widget B cancelled, and admin deletes widget B's line item from the order and grants a refund for widget B.\n\nWe actually can't support this with our 3PL, since they are too good at what they do. Our products ship within 2 hours most of the time, making it actually impossible for us to change orders once they are submitted to our 3PL. \nBut again, it should be considered a finished transaction and refunds should go through RA. Also, in your scenario, what's the accounting? Is that revenue for the business or not? According to what I understand of GAAP-- which is really important here -- you should consider it two transactions: A sale & a return (the sale is revenue and the return is expense). \nAgain, if you issue refunds directly, you get no ability to do that Refund Tax transaction\n\nUser completes an order for widget A ($10) and submits payment\nUser says \"oops, I need to pay using a different account. Can you refund me and let me pay with a different card?\"\nAdmin grants a refund and the user submits a new payment\n\nThis seems to me to be the only actually valid  use case for Refunds (outside of RAs). In this case, it is a transactional matter only, you'd simply putting that order back into \"limbo\" while you take away 1 payment and then add another payment. In this case, we don't care about the Return Tax transactions so it seems to be to be a clean use case. \nI agree that the existing logic doesn't make sense. I think one thing we should strive for is separating transaction records conceptually (and I mean all entites) into two categories:\n1. transaction records that happen at the time of sale or in fulfillment.\n2. transaction records that happen at a later time, and constitute new entries into the Bookkeeper's ledger \nMoving in this direction will make things cleaner. And bookkeepers like new entries, not old ones that change values. \n. I was just going over this point on someone else's PR .... a direct \"Refund\" as implement (from the Admin payment screen, issued directly against an order OUTSIDE of the Returns Auth process) is kind of a bad news feature. \nOur Cust Service team can't give it up, although I am trying to get them to process all refunds through the RA process. The problem with the refunds the way they are is that essentially you can't issue Refund Tax transactions against them, which is appropriate in all cases when you give $ back to someone (this is basically impossible AFAIK because there is not relationship from the refund to the return item that it is refunding, thus making the TAX CODE impossible to know)\nTo your scenarios:\n\n\nUser completes an order for widget A ($10) and widget B ($20) and submits payment\nUser receives their shipment and reports that widget B is broken\nAdmin provides a refund for the broken widget B\n\n\nthis should be treated as a return, even if the thing doesn't come back, and thus go through the RA process which will issue a Refund tax transaction correctly\n\nUser completes an order for widget A ($10) and widget B ($20) and submits payment\nUser asks to have widget B cancelled, and admin deletes widget B's line item from the order and grants a refund for widget B.\n\nWe actually can't support this with our 3PL, since they are too good at what they do. Our products ship within 2 hours most of the time, making it actually impossible for us to change orders once they are submitted to our 3PL. \nBut again, it should be considered a finished transaction and refunds should go through RA. Also, in your scenario, what's the accounting? Is that revenue for the business or not? According to what I understand of GAAP-- which is really important here -- you should consider it two transactions: A sale & a return (the sale is revenue and the return is expense). \nAgain, if you issue refunds directly, you get no ability to do that Refund Tax transaction\n\nUser completes an order for widget A ($10) and submits payment\nUser says \"oops, I need to pay using a different account. Can you refund me and let me pay with a different card?\"\nAdmin grants a refund and the user submits a new payment\n\nThis seems to me to be the only actually valid  use case for Refunds (outside of RAs). In this case, it is a transactional matter only, you'd simply putting that order back into \"limbo\" while you take away 1 payment and then add another payment. In this case, we don't care about the Return Tax transactions so it seems to be to be a clean use case. \nI agree that the existing logic doesn't make sense. I think one thing we should strive for is separating transaction records conceptually (and I mean all entites) into two categories:\n1. transaction records that happen at the time of sale or in fulfillment.\n2. transaction records that happen at a later time, and constitute new entries into the Bookkeeper's ledger \nMoving in this direction will make things cleaner. And bookkeepers like new entries, not old ones that change values. \n. I don't think we are using this. I checked our DB and there are no values in the user_id column, and there existing (non-scalable) \"By User\" rule should be using the join table spree_promotion_rules_users, so I this seems \ud83d\udc4d  to me\n. I don't think we are using this. I checked our DB and there are no values in the user_id column, and there existing (non-scalable) \"By User\" rule should be using the join table spree_promotion_rules_users, so I this seems \ud83d\udc4d  to me\n. I don't think we are using this. I checked our DB and there are no values in the user_id column, and there existing (non-scalable) \"By User\" rule should be using the join table spree_promotion_rules_users, so I this seems \ud83d\udc4d  to me\n. @Kingdutch -- the (lack of good) documentation on Solidus is an issue. I have brought it up with various folks and also proposed we form a 'documentation squad' to seriously address the lack of documentation.\nOn a very macro level, speaking about Solidus + new developers, I would give you this word of perspective: Solidus is not for beginners. After having worked with Spree for years and mentored many devs on Spree, I would say it's not even for intermediate level developers. \nYou need to be a strong dev and also have great debugging skills, as well as know some internals of how Ruby behaves. This fact is somewhat an artifact of how it was built, and somewhat just it is what it is. \nFor this reason, I believe there was a little bit of a lack of interest in the old days (the Spree days) to even write thorough documentation for newbies. \nIf you are a small outfit, you don't have a team of Rails developers on staff and you aren't prepared to hire a team of experienced Rails developers, you're better off with Shoppify or WIx or Squarespace.. (And by \"you\" I mean someone who wants to start an E-commerce website, not \"you\" a developer.)\nSo basically even though you may have seen Spree commerce's old glossy marketing website that makes it look \"easy,\" Spree/Soldius is not easy. And I'm just talking about the basics--- let alone the stuff I myriad of stuff have to deal with on our high-volume website (which is true for most Rails apps, but somehow Spree/Solidus seems to make live production bugs very unpleasant to debug)\nI definitely think the README needs to get replaced-- not just augmented and tweaked --- replaced  ---  but a whole new set of documentation & guides. \n\n\nHowever I could be wrong and this functionality could be provided but I have little way of knowing this at the moment without going through the code.\n\n\nYou may or may not be right actually, as someone recently reported that in Solidus 1.3.0 RC core there was code that depended on solidus frontend. (That code shouldn't have been there as yes, you are correct to assume they are intended to be a la carte)\n\n\nI'm currently not sure which modules are in a usable state for which version of Solidus as Solidus is rapidly changing.\n\n\nThe idea here is that http://extensions.solidus.io will help you out for that. Yes, attrition is a problem.\n\n\nI understand it is an integration of Devise into Solidus but at the moment it very much seems like Devise is the only option\n\n\nCorrect you can define your own User class, and provide your own auth, but devise is widely adopted across the Rails industry. It's more like, you \"can\" do this, but if you do you are on your own.\n\n\nComing back to the purpose of extending, security and authorization is a big part of that. Some explanation of how user permissions are implemented. By browsing the issues I saw that cancan was used.\n\n\nI am inferring from your meaning that by \"authorization\" you mean \"access control\" . TBH, there actually isn't much in the way of Roles & permissions (although I think a basic User/Admin roles are created automatically), and yes it uses cancan. \nMost of the stores I know have to implement the granularity of access control themselves, which involved customizing both your ability.rb file and also wrapping certain sections of code or views in if can? statements.\nAs far as security, we are all concerned with security. (You should see my production logs of robots hitting the site looking for .Net vulnerabilities!). Being on an OS platform means that everyone is scrutinizing the code we all share, and when a vulnerability is uncovered it gets patched quickly. Compared to a lot of the other web industry, Rails + Solidus is on secure side of things. \n. @Kingdutch -- the (lack of good) documentation on Solidus is an issue. I have brought it up with various folks and also proposed we form a 'documentation squad' to seriously address the lack of documentation.\nOn a very macro level, speaking about Solidus + new developers, I would give you this word of perspective: Solidus is not for beginners. After having worked with Spree for years and mentored many devs on Spree, I would say it's not even for intermediate level developers. \nYou need to be a strong dev and also have great debugging skills, as well as know some internals of how Ruby behaves. This fact is somewhat an artifact of how it was built, and somewhat just it is what it is. \nFor this reason, I believe there was a little bit of a lack of interest in the old days (the Spree days) to even write thorough documentation for newbies. \nIf you are a small outfit, you don't have a team of Rails developers on staff and you aren't prepared to hire a team of experienced Rails developers, you're better off with Shoppify or WIx or Squarespace.. (And by \"you\" I mean someone who wants to start an E-commerce website, not \"you\" a developer.)\nSo basically even though you may have seen Spree commerce's old glossy marketing website that makes it look \"easy,\" Spree/Soldius is not easy. And I'm just talking about the basics--- let alone the stuff I myriad of stuff have to deal with on our high-volume website (which is true for most Rails apps, but somehow Spree/Solidus seems to make live production bugs very unpleasant to debug)\nI definitely think the README needs to get replaced-- not just augmented and tweaked --- replaced  ---  but a whole new set of documentation & guides. \n\n\nHowever I could be wrong and this functionality could be provided but I have little way of knowing this at the moment without going through the code.\n\n\nYou may or may not be right actually, as someone recently reported that in Solidus 1.3.0 RC core there was code that depended on solidus frontend. (That code shouldn't have been there as yes, you are correct to assume they are intended to be a la carte)\n\n\nI'm currently not sure which modules are in a usable state for which version of Solidus as Solidus is rapidly changing.\n\n\nThe idea here is that http://extensions.solidus.io will help you out for that. Yes, attrition is a problem.\n\n\nI understand it is an integration of Devise into Solidus but at the moment it very much seems like Devise is the only option\n\n\nCorrect you can define your own User class, and provide your own auth, but devise is widely adopted across the Rails industry. It's more like, you \"can\" do this, but if you do you are on your own.\n\n\nComing back to the purpose of extending, security and authorization is a big part of that. Some explanation of how user permissions are implemented. By browsing the issues I saw that cancan was used.\n\n\nI am inferring from your meaning that by \"authorization\" you mean \"access control\" . TBH, there actually isn't much in the way of Roles & permissions (although I think a basic User/Admin roles are created automatically), and yes it uses cancan. \nMost of the stores I know have to implement the granularity of access control themselves, which involved customizing both your ability.rb file and also wrapping certain sections of code or views in if can? statements.\nAs far as security, we are all concerned with security. (You should see my production logs of robots hitting the site looking for .Net vulnerabilities!). Being on an OS platform means that everyone is scrutinizing the code we all share, and when a vulnerability is uncovered it gets patched quickly. Compared to a lot of the other web industry, Rails + Solidus is on secure side of things. \n. \ud83d\udc4d for removing button. Only developers should need to do platform operations like clearing the Rails cache, and we have access to the Rails console for this. Too dangerous to give non-developers things they can mess things up with (we have enough problems with them creating Promos that break our checkout!)\n. \ud83d\udc4d for removing button. Only developers should need to do platform operations like clearing the Rails cache, and we have access to the Rails console for this. Too dangerous to give non-developers things they can mess things up with (we have enough problems with them creating Promos that break our checkout!)\n. I agree with @Kingdutch this seems counter-intuitive and the dependency should be reversed (that is, solidus_auth_devise should implement current_spree_user and solidus_front_end should depend on anyone implementing it, and by anyone I mean the auth strategy of your choice)\n@Kingdutch -- devs new to Spree/Solidus often are shocked at how much stuff seems contrary to certain common computer science principles, often having to shrug it off as a leftover or hold-over or hack (which this sounds to me like). For the time being maybe try including the spree_frontend code even if you don't plan to use it, and just not put any of those Spree routes in your routes file to hide all of Spree's native front-end routes, this would be the path of least resistance. Then again, maybe you can be the one to fix it via pull request(s).\n. I agree with @Kingdutch this seems counter-intuitive and the dependency should be reversed (that is, solidus_auth_devise should implement current_spree_user and solidus_front_end should depend on anyone implementing it, and by anyone I mean the auth strategy of your choice)\n@Kingdutch -- devs new to Spree/Solidus often are shocked at how much stuff seems contrary to certain common computer science principles, often having to shrug it off as a leftover or hold-over or hack (which this sounds to me like). For the time being maybe try including the spree_frontend code even if you don't plan to use it, and just not put any of those Spree routes in your routes file to hide all of Spree's native front-end routes, this would be the path of least resistance. Then again, maybe you can be the one to fix it via pull request(s).\n. this information from the old Spree guides applies to your questions: http://guides.spreecommerce.org/developer/view.html#template-replacements\nYou might want to seek help on the #support channel of the Solidus Slack room. \n. this information from the old Spree guides applies to your questions: http://guides.spreecommerce.org/developer/view.html#template-replacements\nYou might want to seek help on the #support channel of the Solidus Slack room. \n. Actually for views you copy the file from the gem views into your app (thus creating work for yourself when you upgrade and the original file changes --- this is why some people use deface, but deface has its own problems)\nFor controllers you use class eval and overload methods.\nHaving said that, for a lot of backend plumbing, many parts of Solidus now have plug-in class components (slightly newer & cleaner approach the community is moving towards. An example is here: https://github.com/solidusio/solidus/blob/master/core/app/models/spree/reimbursement/reimbursement_type_engine.rb#L9  notice that the class attributes that point to other models themselves, and this is designed this way to allow you to swap out certain components with your own objects. More appropriate for, for example, a back-end process that is complex and you want to write your object to represent your business's business logic)\nThe fundamental problem is that smaller  and new stores want the ease of using existing controllers & views but larger Spree/Solidus operations typically outgrow this and write their own frontends and keep Spree/Solidus primarily as back end. \nYour mileage may vary.\n. @acrolink Cool you are welcome. I'd suggest you close this GH issue since it isn't actually an issue, nor is the community going to take on the project of \"make a better way to customize\" in a Github Issue. \nTrust me, lots of people also want \"a better way to customize\" for Solidus but it it not something that is easily solved or trivial. The pluggable-classes thing described above is one example of the community recognizing a need for a better way and then taking a few baby steps in that direction. \nIf you want to do some work to think about how you'd approach the problem, a GH issue might be appropriate for a specific proposal to fix or augment in a specific way.\nLike, here's what I think we should do and here's what I propose, etc.\nBut in the absence of that I'm fairly certain there is nothing actionable here as at this point it sounds like you are basically taking Solidus out for a test drive. \n. @Sinetheta \nKeep in mind the refunds exist as their own first-class entity in Solidus I think, so that if \"cancel\" on an existing payment means refund the capture (which doesn't seem transactionally correct to me), then there should be a user interface that allows the operator to specify the type or reason for the refund. \nIn our app use 'void' to mean \"void out this payment record and no longer talk to the external gateway about it\" and cancel to mean \"cancel this payment and tell the external gateway about the cancellation\"\nIn my view, cancelling should only happen before capture. After capture, you should go through the existing refund workflow instead and leave the original payment records as-is (in 'completed' state) since that is more appropriate from a book-keeping perspective. \n. conceptually it makes sense to me, and I agree screens should never crash on the Admin users, although I still do have a categorial objection to soft-deleting. (but, as has been explained to me before, until soft-deleting is removed this is the most effective strategy to eliminate these bugs)\nMy only suggestion here is a user experience one: Particularly, Merchandiser teams that operate Spree/Solidus by deleting old variants and replacing them with identical SKUs (new records) -- which is possible because the SKU-uniquness is not enforced across the deleted/non-deleted records --- would have a very difficult them figuring out which of two identical SKUs on that screen was deleted and which was not deleted. \nI don't think that should block the bugfix, but it seems like a thorough implementation would change the UI to show the deleted ones with an indicator that they have been deleted (like strikethrough text or something). As well, it seems to me that one should be forcibly stopped from adding/removing stock for deleted variants (which I think actually works as-is because on that screen you input a SKU anyway). \nI guess all I'm getting at here is that by showing the deleted records there you create some confusion for the Merchandising team if there were two SKUs with the same value on the page and you couldn't tell which was which. \n. Love it. So much cleaner than deface. We should figure out how to update the \"how to customize solidus\" documentation out there to include references to this + other new patterns for customization, at least as \"here's some new patterns we're trying out... try them yourself and tell us what you think\" kind of thing. \nSee recent GH conversation I was having on https://github.com/solidusio/solidus/issues/1291\n. strange, that looks like a rubygems.org problem. Does bundle install on the very same app work locally?\n. there definitely is a rubygem for railties at the exact version 4.2.0.  are you sure your Gemfile has specified rubygems.org as the source? \nI see now you wrote \"Heroku Button\". I don't really know what that does exactly and Solidus is likely too complicated to deploy with button. I'd try to make yourself a brand new app and see if you can re-create the problem on it. \n. Oh ok, got it now. My opinion is that button should just go. Deploying with a button isn't such a great idea and is not something that is going to be consistent and easy to support. (I don't know why Heroku encourages it, it's really not a such good idea). Seems like it breaks often, and Heroku's build procedure changes too, and moving forward this button is just a headache. \nWe maintain a fresh install app (\"hello world\") app here: http://solidus-1-3-helloworld.herokuapp.com\nI can modify this helloworld app with the latest released version and also make a new one for 1.4 now. \n. Yes I hear ya, it's just that this is the umpteenth time I've seen people have problems with it and Heroku has the power to change stuff on their side and break the button (which admittedly, happens rarely, but can happen). All I'm saying is that supporting it seems untenable to me. \n. We have products with over 200+ SKUs, so keep in mind how this might scale with larger data sets. For the most part, there is only 1 single user of this screen at my company (the Merchandise Manager), and he's enough of a 'power user' to not really care about little bells & whistles (and to mostly know what he's doing). He does SKU-level (variant-level) management primarily from the Variants & Stock Management screens, of course. \n. You will probably want to write an integration for Payu. netguru/spree_payu_integration  is a good place to start. Depending on the code in that gem, you may or may not want to use that code. \nSolidus is a community-driven project, so if there is code you want to see built it is better to approach the community with the attitude of what you can offer--- i.e., build it and open source it, or build it with another company, or pay a 3rd party to build it, etc--- rather than what the platform can offer you. Then again, others may have some advice specifically for Payu. (But if there is no Payu integration, you'll have to consider how you want to proceed as Solidus is just a Ruby platform, it is not a service.)\nif I were you I'd fork netguru/spree_payu_integration and start to play around with it to see if you can get it working with Solidus. (Raname it solidus_payu_integration while you're at it.)\n. You might also want to ask on the Slack channel, under the #support room, which you can find here: http://slack.solidus.io\n. @joelind -- are you certain you generated your own API key for the user you are logged in with? You do this by searching for yourself on the \"Users\" tab and then hit \"Generate API Key\" on your own page (This is associated with the Admin user you are logged in with)\nGenerally all Admins need API keys\n. > > @jrochkind suggested that perhaps we don't needs names on Address at all for shipping purposes, as shipping services don't require names.\nWhich shipping services don't require names? This doesn't make sense to me, when we create Return labels on the FedEx api, I'm fairly certain it will hiccup if it doesn't have both a first & last name in there (as the FROM address... it even needs a phone number)\nAlso I can check with our 3PL but they probably need a first & last name too. \n. I think removing AR validations isn't as difficult as it is made out to be, it's just really counter-intuitive looking code. \nhere's what we have in our address decorator for removing the phone validation, works flawlessly\n_validators.reject!{ |key, value| key == :phone }\n  _validate_callbacks.each do |callback|\n    callback.raw_filter.attributes.reject! { |key| key == : phone } if callback.raw_filter.respond_to?(:attributes)\n  end\n. I guess my over-arching feeling on the whole thing is \ud83d\udc4e because the whole industry already uses two separate for first and last name, nearly all our external providers are implemented this way, and as soon as you combine the name into a full name you immediately run the very real probably that someone, somewhere down the line is going to parse that full name when they need a first & last for some 3rd party website (we literally integrate with about 15 external providers, none of whom I think have consolidated first & last name fields in their systems)... and as soon as you write a parser for the names you are invariably going to get it wrong. \nWhereas the use case of an external provider (as originally stated the impetus at the top of the PR) like Amazon that needs a single name field is obviously much easier and involves simply concatenating two strings with a simple space. \n. ~~Will investigate~~\nYou are indeed correct, our FedEx code passes the full name, I was wrong\nhttps://github.com/mackweldon/spree_shipping_labeler/blob/master/app/models/spree/address_decorator.rb\n. I guess the issue is also personal for me, because if you write your whitespace parser to include hyphens are white space,  then my full name (\"Jason Fleetwood-Boldt\") becomes \"Jason Fleetwood\" and \"Boldt\" which I personally would not appreciate. (My entire life tell people looking things up alphabetically to look first under \"F\" and then under \"B\")\nIf, however, you write your whitespace parser to treat hyphens as characters, then I become \"Jason\" and \"Fleetwood-Boldt\" which is how I identify. \nThen again, if I had followed the Spanish tradition (my father is from Chile), I would be \"Jason Boldt Fleetwood\" and \"Fleetwood\" would be my last name and \"Boldt\" would be my middle name. \nI guess I wonder what the rational for this is--- is it to eliminate the idea of \"First name\" and \"last name\" conceptually, and let people use whatever name they feel represents themselves? (Which I get, on a social/ethical/cultural level). \nIn Vietnam and China (and other sinosphere countries, and if you're from the planet Bajor in the Star Trek universe-- yes I know I got really dorky there), family names come first followed by common, which even further supports your argument for single full name fields.\nSo although I started this post questioning the rationally perhaps I've talked myself into it simply on the cultural-sensitivity argument.\n. are you proposing changing the actual token itself, without changing the names of the fields where it is stored (spree_api_token) and also the request header (X-Spree-Token) where it is sent from client to server?\nIt seems like a change like this could be done in less aggressive way, to allow users to opt-in to the JWT at first, but leaving all existing Spree token stuff in place.\nThe Spree token is an essential part of the entire API of course, so I'm concerned that any changes here could open a can of worms of bugs to clean up. \n. This feature is definitely desired, but I wonder if it is enough (sorry, not the answer you wanted). Specifically, we have two 'baseline' Promotions we would want applied in addition to a coupon-based Promo code entered by the user:\n- Free shipping (applies over an order threshold)\n- We have a special volume purchasing discount promotion that is applied to everyone on all orders\nIdeally, if I were to design it for myself, I'd put a flag on the Promotions to indicate \"User applicable\" (this is sort of the opposite of the apply_automatically which is already there, so I guess you could invert that and consider any non-apply_automatically Promo to be \"User applicable\"-- fine, semantics).\nThen, I'd make the setting be instead of only_allow_most_recent_promotion I'd change it to only_allow_most_recent_promotion_for_user_applied_promotions\nThen this new rule would apply only to user-applied promotions (AKA non-apply_automatically promotions), and still let the apply_automatically Promotions be 'stacked' on top of those User-entered Promo codes.\nJust my 2\u00a2, going down the road here is definitely an improvement in the right direction though. \n. Yes indeed and that is a use case for us too... in fact, I just hadn't presented it before. \nIn our case, we have a \"disable savings meter\" (aka \"volume discount\" as mentioned above) which is specific to us, but an abstraction could include a setting on the other promotion to for evict_other_promotion_even_if_it_is_automatically_applied. (this is a very wordy name but you get the idea)\nit gets a little tricky with all these rules but I agree the use cases are there. as we have it what we're discussing here makes up a good part of our customization of Spree code (as we have special promotions)\n. as an architectural standpoint it kind of seems like a can of worms here, because what you really want is a classification hierarchy where certain promotions kick off other promotions but then others don't, as set on a promotion-by-promotion basis. But if you really build that out it can be very complicated of course. \nI'm just brainstorming outloud here, I wonder if each promotion had two settings:\nA). a \"sticky\" value, 1-10, 1 being 'more sticky', 10 being 'less sticky'\nB). a \"evict other promotions whose sticky value is great or equal to ___\" (we'll call this the kick-off value, meaning \"kick another promotion off if its sticky value is >= X\")\nHere's a simple use case:\n- A) Free shipping should always be applied and never get kicked off\n- B) Volume discount 10% should only get applied if the user doesn't enter a coupon-based promo\n- C) Coupon-entered promotions should kick off the Volume discount promotion but not the free shipping. In other words, Promotion B should be mutually exclusive with Promo C\nUsing these, you could create a stacked deck of promotions, and give each rules. You'd set you \"core\" promotions with low-number values (1), those are the ones you never want kicked off.\nYour free shipping would get a sticky value of 1 with a kick-off value of 10 (does not kick anything off)\nYour volume discount would get a sticky value of 2 with a kick-off value of 2\nand your Coupon-entered promotion would get a sticky value of 5, but it would have a \"evict other promotions with stick greater or equal to 2\"\nThen your user would have both Free Shipping (A) + Volume discount (B) on their order (let's say automatically applied by spree). When they go to enter the coupon-based code, the settings dictate that that Promotion should kick off any other promotion with a sticky value of 2 or higher, so the user ends up with Free Shipping (A) + the coupon code they entered (C)\nIf the user then subsequently re-applied Promo B, it's kick-off value of 2 would mean that it would automatically kick off Promo C (with a sticky value of 5, which is higher than 2). \nUsing some kind of complex system like this you could create a series of stacked deals that would have granular application rules. Unfortunately, this may be too complex for a layman and now that I've written it all out it seems overly complex for the initial use cases. \n. \ud83d\udc4d  for explicitness. I agree about not wanting to include all helpers in all controllers -- things get very messy on large apps when you do that. \n. \ud83d\udc4d for backbone; we use it widely (we use Mariontte/Backbone) and love it. in particular, it boots extremely fast and its source code is accessible (readable).. this is just one person's opinion about why you should just avoid email validation altogether. (I happen to agree with him but there are good arguments to made for validation)\nhttps://davidcel.is/posts/stop-validating-email-addresses-with-regex/. having said that, we really like this approach (which isn't really an email validator at all, more a suggester): https://github.com/mailcheck/mailcheck\nYou can check that out live by going to Kickstarter (log out if you are already logged in), then click 'Sign up'. Then enter your email but purposefully leave off the .com (or in your case .ca), you'll see it suggest the right email to you\nThen again, now that I think about it, it probably suggests for you .com when your email is actually .ca which must be annoying and off-putting for anyone with a non-.com email (mostly people outside U.S.). my colleague @reidcooper and I literarily just noticed this yesterday \u2014 spree_prices seems to have acts_as_paranoid on it (using a soft delete with a deleted_at field), although for some reason Spree's code somehow works around the gem's mechanism. If you make a change to a price after deleting it, it still updates the \"deleted\" (soft) record in the database.  (slightly different symptom of the same root cause)\n. @sechix -- this may or may not have anything to do with your problem, but I debugged a nasty issue related to that once that occurred when there was an after_save hook on the model that read the file into memory before Paperclip did its processing. \nFor my problem, we would see a zero-byte file when processing it (doesn't sound like the same as your problem). Explanation & fix is here: https://github.com/thoughtbot/paperclip/issues/1096\nFor your problem (which I admit sounds different), did you attempt the setup excluding the CDN entirely, just pointing your asset_host to the AWS S3 buckets (not to Cloudfront or any other CDN)?\nI recommend using CDNs only in Production/staging and not using the CDN for local development or sandbox environments. There's a specific reason for this \u2014 you get strange timing issues when you try to pull an asset from the CDN before its available in the S3 bucket. Sometimes S3 can go into a little 'black hole' and although the asset  is uploaded to the S3 bucket, it takes another few seconds to become available on S3. \nFor this reason, you have strange timing delays/race conditions, which can include the CDN attempting to pull the image from S3 just slightly too soon. You will note that in the case of Cloudfront, the CDN will remember the failure for 5 full minutes. That means even if you subsequently try to re-access that asset, you still get a 404 on the CDN's endpoint for 5 full minutes before the CDN will go back to the bucket and re-attempt to fetch it.\nI would recommend removing the CDN from you setup and just pointing your app to the S3 buckets directly, for testing purposes, to see if the CDN is the variable that is tripping you up. . >> \"solidus can't read them the after\"\nCan you explain what that means in more detail? Specifically, if you right-click on the image in your browser window (where it says \"No Image\"), what is the URL you are seeing that points to the Image? Is it pointing to the correct image path on the CDN, the S3 bucket, or the default no-image image? \nIf you then open that image path directly into a new browser window, does it load your image?\nIf you look in your spree_assets table, do you see records in that table corresponding to the images you uploaded?\n. @sechix -- in config/production.rb, what do you have for the value in\nconfig.action_controller.asset_host\nWhen I look at http://sparky.md (which appears to be in a language I can't read), right-click on the missing image, it is telling me the image should be at\nhttp://sparky.md/spree/taxons/56/normal/BPR_330CE_HD.jpg?1493587048\nthat is URL your domain, not the S3 bucket or the CDN. It looks like your asset_host isn't configured on your production.rb settings, or the asset host isn't configured correctly in the has_attached_file definition, or the FOG directory isn't configured in the Paperclip settings (I think it can be configured in any of those 3 places, so check all 3). @AndreiMotinga -- you need 2 separate CDNs\nFor the paperclip assets, you store on S3 and the point the CDN to that Bucket (will end with amazonaws.com). You must do this for the paperclip assets because on Heroku you cannot store them on the file system.\nFor the internal assets, which live in your app under app/assets/ (or under public/ if you want them outside of your rails app), you set up a 2nd CDN that points to your domain name. For those assets, which have nothing to do with Paperclip, they live inside your app (in your repository), and are compiled into your slug, which gets re-pushed every time you deploy\nI was wrong about the asset_host \u2014 that's the configuration for the in-app assets. Sorry about the confusion, that was my bad.\nSee the paperclip docs for has_attached_file \u2014 that's where you configure the S3 bucket for Paperclip. You can also configure it globally. . For configuring Paperclip to use S3, see this doc:\nhttps://github.com/thoughtbot/paperclip/wiki/Paperclip-with-Amazon-S3\nNot sure why you see different behavior for Taxons and Products. Look in the Solidus core code for Spree::Image \u2014 look for the has_attached_file, or any place your decorated code may have over-ridden the core code. \nYou should in theory be able to configure paperclip to use S3 globally.\nThis is how we do it in our config/application.rb file\n```\n      FOG_SETTINGS =  YAML.load_file(\"config/fog_directory.yml\")[Rails.env]\n  s3 = YAML.load_file( \"#{Rails.root}/config/amazon_s3.yml\")[Rails.env]\n\n  config.paperclip_defaults = {\n    storage: :s3,\n    s3_credentials: s3,\n    s3_protocol: \"https\",\n  }\n\n  if !Rails.env.development?\n    config.paperclip_defaults.merge!({\n      s3_host_alias:  FOG_SETTINGS['cloudfront_bucket_domain'],\n      fog_host: FOG_SETTINGS['cloudfront_bucket_domain'],\n      url: ':s3_alias_url',\n      s3_alias_url:  FOG_SETTINGS['cloudfront_bucket_domain']\n    })\n  end\n\n```\nWe have some funky stuff so that in Dev we don't use the Cloudfront (FOG_SETTINGS) at all, but instead always use the S3 buckets in Dev (but we use both S3 and Cloudfront in Prod)\nDoes that make sense? Once you get it configured correctly globally, it should start making sense.\nAs far as the CDNs, the Heroku docs that suggest you point your CDN to your primary domain name are referring to your in-app assets, which has nothing to do with Paperclip \u2014 do not confuse. . @AndreiMotinga \n\n\nif it points to bucket, then you gotta have to have all the assets compiled and uploaded to bucket each time you deploy your app... I didn't find lots of blog posts/resources doing that... so.. to me it's still unclear.\n\n\nThis was the way we did things before 2013, for a pre-Rails 4 app. Back then (pre-Rails 4), we used to use a gem called asset_sync. That's what the old blog posts are referring to. Do not believe them, that is no longer the recommended way.\nIf you do however do that, you use asset_sync to upload your in-app assets to your bucket during slug compilation (see https://github.com/AssetSync/asset_sync)\nIn theory, you could set it all up with 1 single bucket using asset_sync. However, it's easier and faster just to use two separate CDNs as explained above, and Heroku no longer recommends using assets_sync. I wonder if there's a way to bridge the old-and-new paradigms: \nAn \"order level adjustment\" that looks to the customer & business as-if it is applied at the \"order\" level, but then there is a calculation of how much was discounted per line item.\nIn fact, I'd even go so far as to suggest two \"promo_total\" fields on the line items \u2014 One for the existing line-item adjustments, and a 2nd one that keeps track of the proportioned discount applied to this line item from the order-level adjustments. Then for the purposes of taxation & refunds, to get the \"actual amount paid for this item\", you take the line item's total minus the line item adjustments and then minus the  proportioned adjustment from the order level adjustments.\nDoes that makes sense? That way, you have the best of both worlds: you keep order-level adjustments as a high-level concept, and bubble it down into a specific calculation for each line item for the purpose of taxes and refunds. \nThis way you can keep the high-level concept of order-level promotions (which are indeed critical to our marketing team) and just make relatively under-the-hood fixes to how taxes & refunds work. \nAlso FYI Avalara \u2014 widely used here in the U.S. \u2014  actually expects the full amount to be passed along with the discounts, and then it does the discount calculation itself. It does not expect that you pass the already-discounted amounts to them. Since I know of no jurisdiction in which the discounted amount is taxable (in all cases the discount reduces tax), this does not seem to have a functional purpose but I believe the purpose of this is exclusively for bookkeeping and reporting. . Safari is particularly egregious about pre-fetching GET requests, for example, when it renders the \"frequently visited sites\", it will prefetch all those URLs.. I've noticed non-idempodent GET requests that cause problems like this are especially exacerbated in Safari (which I think I may be one of the last users of on the planet). What payment method (provider) were you testing this with? Most payment processors have moved away from their clients' applications passing the \"Full PAN\" (the card number) within their own system for security and PCI compliance. Generally it is recommended that unless you have a compelling need to process the full PAN, you probably shouldn't be having it move through your application. \nI think you will find most modern payment processes use tokens or nonces to tokenize the card number via Javascript. . I'm really curious, what's a \"Franken-adjustment\"? I couldn't find that term on Google (but lots of references to American Senator Al Franken and tax reform). Is than an accounting term?\nOr do you just mean like \"frankenstein,\" like a \"big messy thing?\". (discussed with Reid)\nAn abstracted storage mechanism \u2014 in which stores (no pun intended) could choose where to put their spree_log_entries \u2014 makes total sense to us. But it seems to me that for core code to dictate a document or object storage, that would expand the (already tight & small) stack requirements for setting up a new Solidus installation. \nWe recognize that this is a small piece of paper mache that covers up a bandage that itself was originally covering up what is (arguably) a code smell. It seems to us the root of the problem is that exceptions (in this case, the rollback) are relied on for too much flow control, which is essentially the root of the code smell. We fully understand this is not a fix to the root of the problem. \nAlso note it can be decorated as the decorated after_rollback seems to over-ride the core code definition. (this worked fine in our app)\nSo do with that information what you will. . we're not quite sure why referencing a source would cause a rollback. All we can think is for the case where payment.source has errors on it, it won't have saved correctly.\nthis fix seems like it will remove the association between spree_log_entries and payments, which will surely make debugging harder, no?\nI'd say a more defensive fix would be\nsource_id: (!payment.source.new_record?) ? payment.source.id : nil ,\nor\nsource_id: (!payment.source.errors?) ? payment.source.id : nil ,\nor even\nsource_id: (! payment.id.nil?) ? payment.source.id : nil ,\nThis would eliminate the awkward after_rollback construction but also keep the association (when there really is a payment record to associate)\n(keeping the removal of the after_rollback itself). Oh ok I misunderstood in that case.. buggy install can be examined here:\nhttps://github.com/jasonfb/solidus_240_helloworld_BUGGY_solidio-solidis-Issue2434\nI know what I did here.\nI mistakenly tried to install rails new using rails 5.2.0.beta, thinking maybe the head of solidus would just work on it. (dumb assumption).\nAfter starting with a Rails 5.2.0.beta app, I then switched my gemfile's rails version down to 5.1.4. Don't do this, it doesn't work.\nI then proceeded to add the Solidus gems themselves, and that's when I hit the non-fixable exception after bundle exec rails g spree:install\nOn my two subsequent attempts to do a fresh Solidus install, I correctly used\nrails _5.1.4_ new solidus-hello-world\nto check which version of Rails you have install in your active gemset, use rails -v\nI think what happened is that I had the 5.2.0.beta active and just ran rails new solidus-hello-world and it installed a 5.2.0.beta app. \n. cross posted to SO for more visibility (I find closed GH issues difficult to search for on Google)\nhttps://stackoverflow.com/questions/47729406/on-fresh-solidus-install-running-rails-g-spreeinstall-exception-it-seems-you/47729442#47729442\n. TODO (Jason): provide reproduction app. at scale (like in the case of abuse by the Marketing team, as described below), this will not be performant because the filtering will be done in Ruby. For example, let's say if there were hundreds or thousands of roles attached to a single User, this will cause significant bloat in the app (so much bloat it would cause a checkout to completely to a halt)\nyou could actually work-around that scalability problem by passing the logic deep into the SQL query itself, like so:\norder.user.role_users.where(role_id: roles.collect(&:id))\n(not sure if this style of Ruby syntax is preferable to you-- I'm offering this exclusively as an alternative to address scalability and performance. I do recognize that this line of code is objectively less clean than yours, but to me performance are more important than Ruby being pretty)\nthis would make it more performant and remove the need for AR to load all of the user's roles at once, thus instantiating too many AR objects. \n. You are right about the number of SQL queries; I didn't realize AR turned this into a JOIN query automatically.\nWith few roles you're right this not an issue. What happens if people start using this to make hundreds and hundreds of roles just because they want to segment specific promotions to specific people? Seems like 'danger zone' territory to me.\n. I would be in favor of returning false on the eligibility and logging the inappropriately setup object (with no match policy). Really, it's like the code is saying \"I can't use these settings because you (the operator) didn't set them up correctly, so I'm just going to assume this promotion can't be applied at all\"\n. I guess perhaps I have been worn down by a Marketing departments that can and will hang themselves whenever I give them even the shortest bit of rope (As well, I've scaled my share of apps and am very sensitive to bloat in Promotions.)\nHaving said that, it seems to me that conceptually speaking, if Roles are a first-class entity in the domain design, then having a Promotion rule associated with Roles is appropriate (as a core feature)\nmy biggest concern here is scalability. \n. \ud83d\udc4e \n. don't you mean to write Variant.active(currency)... instead\n. note: this field is to fully replace states_required; a proper clean-up will need to be implemented\n. ",
    "seand7565": "An admin would still have the ability to change the email associated with the account and then trigger the email reset - essentially giving them the ability to change the password. Should the ability to change a users email also be disabled? I can't think of too many use cases in which you'd need to change a users email. @acreilly. IMO an admin being able to set any users password creates unnecessary security issues. I get that some business owners may not like not having that ability - but there are some business owners that don't like not being able to see credit card numbers on orders - at some point you have to draw a line between platform security & business needs. In this case my opinion is that the security of the platform takes precedence.. @BenMorganIO There's a big difference between managing your employees passwords and managing your users passwords, and there is absolutely a security risk - I provided a link above that detailed a few of them (admin being able to log in and complete actions as a particular user, and setting the password usually leads to unsecured communication of the new updated password - e.g. \"We've reset your password, it's now hunter2\" via email in response to someone losing their password). Furthermore, the concept of password ownership as you've mentioned is a complicated subject, but I think it's safer to err on the side of the user owning the password rather than the owner - especially with everything going on in Europe right now with GDPR. Also, I imagine selling your users passwords would also lead to business owners in court, regardless of who owns them. \nI admit that requiring the current password to set a new password is a big improvement over what is there currently, but I still prefer the solution proposed with the #1942 - it just seems less limiting to me. Perhaps, if the issue is employee management, we should allow the setting of passwords for admin user accounts only? (That is, super admin can set admin users passwords, but not regular users passwords). Looks like this was fixed with #2787 - can anyone verify? . @flyfy1 @mamhoff Having trouble replicating this issue. I've done the following: \nChanged the tax rate to \"include in price\"\n\nCreated a product with multiple variants and assigned it the tax category\n\nHowever I see the correct amount of variants on the product page:\n\nThis issue was from 2016 and there hasn't been any update on it since - is this still a problem?. @sechix Can you take us through the steps to replicate this problem on a clean server? I was unable to replicate this issue following the steps detailed in the initial post. Also: What version of Solidus are you on?. This should be fixed by changing these lines in models/spree/order.rb from:\ndef empty!\nline_items.destroy_all\nadjustments.destroy_all\nshipments.destroy_all\nupdate!\nend\nto \ndef empty!\nline_items.destroy_all\nadjustments.destroy_all\nshipments.destroy_all\npromotions.destroy_all\nupdate!\nend\nWill test and PR. I do not believe it is the case that this code removes the promotion itself - we've been using this line of code on our local branch for the last year with no problems. I've tested this in console - after emptying the cart, the promotion still exists, however the order no longer has the promotion in Spree::Order.find(order_num).promotions\nMy current understanding of this issue is, while emptying the cart does clear the adjustment created by the promotion, the promotion is still associated to the order. The next time the order updates (when you add an item) the promotion re-applies the adjustment. Using promotions.destroy_all destroys all promotions in the order (but does not affect the promotion as a whole), which prevents the promotion from re-applying itself on cart update.\nI'm working on tests now - will also look into this a bit more to make sure I have 100% understanding before pushing the tests.. Closing PR because I don't know how to Github. :no_good_man: Will submit a new PR in two seconds. . Hi all! This change looks great but it looks like it's been needing work for a while. This looks like a good fix to our current oldest issue, #438 - are there any blockers in making the above changes (other than the version changes that have happened since this PR?). Yep - I'll get something PR'ed within the next day. :). Disabling or removing the edit button on non-tracked products makes sense to me.. @jacobherrington Very good point about people not using frontend. Any suggestions on how to handle that? The admin navigation footer wraps the link to the frontend in if spree.respond_to? :root_path - a similar approach should work here, right?. @tvdeyen I like defined?(Spree::Frontend::Engine) - I've popped that in, as well as a left margin on the new button so they don't look so squashed together.. Test added, all passing!. I was wondering why we had so many issues with this migration. Looks great, thanks for debugging this!. Looks like this was fixed with #3108 - though the fix is only on master ATM.. Done, tested & works great.. Yeah, absolutely. How should I deal with the image storage? Directly on the repo, like the Solidus logo? https://github.com/solidusio/solidus/blob/master/logo.svg\nOr do we have another place to store these images?. You got it! https://github.com/seand7565/solidus/tree/readme_oc#key-stakeholders. Agreed and changed. How's that look? https://github.com/seand7565/solidus/tree/readme_oc#key-stakeholders. ",
    "ericsaupe": "The only time I could think that an admin would need to be able to change the email address is if the user no longer has access to that email and would need their password changed. New account is the path there maybe?. Yeah, that's what I was thinking too. For our customer service reps I know they would be really angry if we simply told them to tell users to create a new account and lose all of their order history, saved cards, etc. Probably best to leave the ability to change emails in and let individual stores change that if they need to.. It looks like it is required in the Devise method, https://github.com/plataformatec/devise/blob/master/app/controllers/devise/passwords_controller.rb#L32. I think it is simply for resetting the password through the controller but the issue here is to remove the change password form all together to simply send the reset email. So if it's not used it could probably be removed all together.. Of course! I'm next to that @skukx purple faced guy from that other PR. I'll come find you in a second.. @mamhoff good idea. This task seems to be to add that ability to send the password reset using the admin.. This looks to be intended behavior, https://github.com/solidusio/solidus/blob/master/core/app/models/spree/variant.rb#L358.\n. Is this resolved with #1984?. @gcmartins93 this is still unresolved. I just tested it using the original steps and came up with the same error.. Honestly, it may be some obscure customization we have going on. I also was not able to reproduce it in a vanilla Solidus build so I'd be OK closing this.\n. @cbrunsdon no, I don't have a way to recreate it reliably. We just saw the error come through when we launched but have only seen it happen twice and the last time it happened was 2 days ago so I'd say this isn't a big deal and can be chalked up to something with us.\n. Any updates on this?. It turns out the specs were originally written to look for the product name in the translation, https://github.com/solidusio/solidus/blob/master/frontend/spec/controllers/spree/checkout_controller_spec.rb#L414. I have updated the code here to adhere to those old specs.. @tvdeyen anything else needed on this?. @jhawthorn updated with your regression test from #1926 . It still seems to be a little bit off. Maybe it's just the taxes? Anyway so the setup here is\nShipping Rate Calculator - Flexible Rate by item with first item $1.5 and addition items $1\n\nAdded three different products to the cart\nCompleted checkout\nCanceled two of the three items\nThe adjustments created did include the additional $1 for shipping but the shipping cost, which is taxed, remained the same. Also the tax adjustments were readjusted and now show a negative adjustment of a few cents. The tax adjustment for the remaining item seems to have disappeared as well.\n\n\nThis was done against the current 2.9.0.alpha\nCorrect me if I'm misunderstanding it all here but I think it should adjust the cost of shipping by the canceled item change, adjust the line item by the cost of the item, and maybe additional adjustments to remove taxes? Just thinking about it from an accounting standpoint where adjustments were created to charge money from a customer and then negative adjustments were created to restore money to the customer against what they paid for.. Is it worth updating all form tags to use the new form_with? http://edgeguides.rubyonrails.org/5_1_release_notes.html#unification-of-form-for-and-form-tag-into-form-with. I know the Rails core team haven't said anything about deprecating current form tags but this is the unification of the two.. @jarednorman that's what I thought as well. Just thought I'd bring it up!. @isindexer yes. Just for reference, this PR is fixing older versions of Solidus, from 2.1 on the fix was in with this commit https://github.com/solidusio/solidus/commit/da223aa7466dc3f0cca16228a02e8271804e4bdc. The model does have the user_id set. When going back that the Backbone JS it isn't initializing with that data.. That's what this does. It either uses the data that has been set in Backbone through another method or gets the value from the rendered page while initializing. It could be done a different way. Probably in the initializer.. Thanks!. Thanks @swcraig for the regression spec!. @swcraig there are a number of conflicting files but this is a great direction!. Closing in favor of #2974 now that @elia has picked it up and @swcraig has mentioned he doesn't have bandwidth right now.\nThanks for the work on getting the ball rolling @swcraig!. I like the idea of deprecating it with an eye to a future release. Solidus 3.0 would have the new styles for example since a full point release usually means things are going to break. Out of the box Solidus should look good and look good on mobile.. The way we get around this at Deseret Book is we issue the Refund for however much we are giving back to the customer, might just be shipping. That results in a balance_due in which case we create an Adjustment with the negative of the amount we refunded to bring the order back to balance.\nFor example:\n- User calls in wanting shipping refunded\n- Admin clicks refund on payment, enters amount of $3.50\n- Order now shows balance due of $3.50\n- Create new Adjustment for -$3.50 with a reason of Shipping (I think we added that reason, can't remember if it is default in Solidus)\n- Order now shows everything is balanced\nIt sort of follows double entry accounting in that we have both the debit of money in the Refund and the credit in the Adjustment.. I agree with @tvdeyen we should support whatever the Rails versions are supporting.. I think keeping with Rails standard is probably the best. I'm usually for keeping things \"standard\" in the community following Rails' lead unless there is a strong reason giving great benefits using UUID. I'd love to hear them.. I wonder if this would be better started as an extension to establish the additional features of JWTs like refresh policy, timeout config, etc.\nThoughts @skukx ?. Sounds good, @tvdeyen . I love the config.logger option. \nThe possibilities of the extensibility of the error reporting are really big. I can see the concern @tvdeyen has though. It does add complexity for something that may not be used by everyone. At least in my experience, we log everything to Rollbar and Filebeat and to a log file. This would make it easy to tie into all three of those services with little effort and as things change with new reporters/services it would be simple to reconfigure things. So for me I see the benefit but the question is whether or not it's worth it to the project at large. Like you said, it's there and if it's unused by most it shouldn't make a difference but gives another point of extensibility to developers.. I wonder if simply fixing the way Solidus can sometimes swallow errors will remove the need to have custom error tracking configurations. If Solidus is handling errors like a standard Rails app these other services should be able to run without additional configuration and handle the errors appropriately.. I guess the question then is, should we be rescuing? Should those methods/core be written in a way that allow those errors to bubble up?. Looks good. Would you mind squashing your commits?. @tvdeyen how is this different than the rubocop -a git changes? This is simply a manual lint change. I can see not doing it in favor of a proper solution for #2849 which would be just like the rubocop -a changes but I think code clean up, even in small commits, is valuable.. Should we close this PR in favor of the solution to #2849?. From what I've seen, the AirBnB JS style guide seems to be pretty well received. Not saying we have to follow it exactly, just like we have exceptions in our Rubocop linter, but may be a good start.\nhttps://github.com/airbnb/javascript. @jacobherrington any update on this?. Agreed, I like to have the UI handle those edge cases before a server call is made when possible. Good change!. @kennyadsl this is ready to be looked at again. Thanks!. I think this addresses it nicely. \nA couple of notes, I would redo your commit message to better describe what is actually being changed and, if possible, write a regression test that fails for current versions of Solidus but is resolved with your fix.\nThanks!. @mayanktap sure! Basically, a test that would do something like this:\nit \"returns unique products\" do\n  Spree::Variant.suppliable.count == variants.count\nend\nThat's a very simple test that is obviously mostly pseudocode but the idea is that you're going to call the suppliable method and see how many variants come back and compare it with the distinct number of variants we expect. Without your fix this should fail since the suppliable method will return duplicated variants but after your fix the test should pass.\nDoes that make sense?. I agree with @kennyadsl, I think there is value in having BCC fields for stores but I'd like to see this solution expanded to include the possibility of having BCCs on all emails sent. It might be a good idea to have this start as an extension and then reopen with a full solution into core once it's been fully implemented. . I like this idea but I'm afraid of how it would work. The way it's currently written the NoOtherPromotions promo wouldn't apply if other promotions were already there. What if that was a better promotion than what is currently applied? AFAIK the default frontend doesn't allow users to manage promos applied to an order which would entirely lock the user out of using this promo. Should the application of this promo remove other promos if better?\nNot really sure what the best path is just thinking out loud.. @kennyadsl good questions\n\nThe order still follows through with calling next which, surprisingly will get the test order from cart to confirm without issue (something we may need to look at elsewhere). For example, calling next on the test order from its initial state it passes through each step without error so you can call next three times and end up at confirm`\nI've added a test to verify that you can't just pass complete and get the order to complete.. @spaghetticode definitely a valid concern. Let me see if I can write some more tests to really make sure that isn't a concern and if it is shore up the code to make sure it doesn't happen.. This one too solidus_static_content. I fired up a new Rails 6 app with ActionText and it worked pretty well. Definitely could make those extensions cleaner. It works with ActiveStorage so it might be something that benefits from #2974 . @CharlyJazz pretty sure by default all API calls require authentication. You can remove this overarching requirement by changing the API config.\n\nSpree::Api::Config.configure do |config|\n  config.requires_authentication = false\nend\nThis will disable authentication for public calls but still maintain normal permission checks on things like orders and users.. Definitely something that can be better documented. I'll see if I can get a PR open with some better documentation for this gotcha. We did a single page checkout using the solidus_api and ran into this. \nThanks for the question!. Will do. I'm actually wrapping each name in \" to distinguish it from the rest of the message.. I was thinking about that today as well. Initially, I had it wrapping each product name but @tvdeyen suggested moving the apostrophe to the translation file. I've also been slightly bothered by the has vs have not being changed properly. Thoughts?. became is great! I just couldn't think of a way to rephrase that. Thanks!. I like this a lot better, I'll make the change. Thanks!. I like this idea. I actually was thinking about it after I submitted this PR and thought that would clean it up adding a method like that. I'll go ahead and do that.. I think so. What is the best way to deprecate an argument?. Yeah, I like that better. I'll make the changes.. Regular HTML works in markdown but I'd prefer the markdown version too.. AFAIK there isn't a way to manipulate size using Markdown.. Yeah, I usually prefer Markdown over Markdown + HTML but I'm not totally against having HTML in the README. Is it worth it/possible to resave the SVG to a smaller size or will it simply enlarge itself by default of how the Markdown is rendered? Just thinking of other options if we really were set on not doing the HTML. Yeah, let me give it shot.. It's to follow the format used in the other model files.. Yes, as it stands it will render. I'll see if I can add a collapse.. ",
    "acreilly": "@ericsaupe Lets say the data associated with that account is important to the user though, I think keeping the ability to change the email would be helpful. It isn't a common scenario, so if we really want to take it out, I guess a developer can go into the console and change it. What do you think?. It doesn't appear that we use this view: https://github.com/solidusio/solidus_auth_devise/blob/master/lib/views/backend/spree/admin/user_passwords/edit.html.erb\nDoes having the reset_password_token increase security? Or do we just want to stick with adding the Send Reset Password Email button. @ericsaupe I'm not sure if you are here today... but if you are would you mind helping me for a second? I am pretty easy to spot out in the room hah... I'm sorry, my issue may be coming from the combination of spree & alchemy on my project. I'll reopen if I find out otherwise.\n. @gmacdougall Can't think of anything when it comes to solidus out of the box. I came across this issue when working on SolidusFlexiVariants where I had to override the method. https://github.com/boomerdigital/solidus_flexi_variants/blob/master/app/controllers/spree/orders_controller_decorator.rb#L16\n@cindyward1 Also noticed it while working on a gem.\nI guess I just find it odd that it is offered as an option, but never passed on.. I fixed the initial failing specs, but the specs will continue to fail due to the changes in solidus_auth_devise not being available on master.\nI'm not exactly sure how to go about what you suggested. Since this change here would only be on master, it shouldn't affect other solidus versions. The change that was made on solidus_auth_devise won't break anything for older versions since that route is not used anywhere and is technically broken if anyone tried to use it.. Not a duplicate, this affects two branches. ",
    "jacobherrington": "Since there are arguments for both paths, is there a possibility this could be set up as a config option? \nI tend to favor removing this ability by default.. This bug technically still exists in Solidus 2.7\nWhile these tests still fail:\n```ruby\n  context \"with a checkout_zone set as the country of Canada\" do\n    let!(:canada) { create(:country, iso: 'CA', states_required: true) }\n    let!(:canada_state) { create(:state, country: canada) }\n    let!(:checkout_zone) { create(:zone, name: \"Checkout Zone\", countries: [canada]) }\nbefore do\n  Spree::Country.update_all(states_required: true)\n  Spree::Config.checkout_zone = checkout_zone.name\nend\n\ncontext \"and default_country_iso of the United States\" do\n  before do\n    Spree::Config.default_country_iso = Spree::Country.find_by!(iso: \"US\").iso\n  end\n\n  it \"the shipping address country select includes only options for Canada\" do\n    visit spree.new_admin_order_path\n    click_link \"Customer\"\n\n    within \"#shipping\" do\n      expect(page).to have_select(\n        'Country',\n        options: [\"Canada\"]\n      )\n    end\n  end\n\n  it \"shows relevant shipping address states\" do\n    visit spree.new_admin_order_path\n    click_link \"Customer\"\n\n    within \"#shipping\" do\n      expect(page).to have_select(\n        'State',\n        options: [\"\"] + canada.states.map(&:name)\n      )\n    end\n  end\n\n  it \"the billing address country select includes only options for Canada\" do\n    visit spree.new_admin_order_path\n    click_link \"Customer\"\n\n    within \"#billing\" do\n      expect(page).to have_select(\n        'Country',\n        options: [\"Canada\"]\n      )\n    end\n  end\n\n  it \"shows relevant shipping address states\" do\n    visit spree.new_admin_order_path\n    click_link \"Customer\"\n\n    within \"#billing\" do\n      expect(page).to have_select(\n        'State',\n        options: [\"\"] + canada.states.map(&:name)\n      )\n    end\n  end\nend\n\ncontext \"and default_country_iso of Canada\" do\n  before do\n    Spree::Config.default_country_iso = Spree::Country.find_by!(iso: \"CA\").iso\n  end\n\n  it \"defaults the shipping address country to Canada\" do\n    visit spree.new_admin_order_path\n    click_link \"Customer\"\n\n    within \"#shipping\" do\n      expect(page).to have_select(\n        'Country',\n        selected: \"Canada\",\n        options: [\"Canada\"]\n      )\n    end\n  end\n\n  it \"shows relevant shipping address states\" do\n    visit spree.new_admin_order_path\n    click_link \"Customer\"\n\n    within \"#shipping\" do\n      expect(page).to have_select(\n        'State',\n        options: [\"\"] + canada.states.map(&:name)\n      )\n    end\n  end\n\n  it \"defaults the billing address country to Canada\" do\n    visit spree.new_admin_order_path\n    click_link \"Customer\"\n\n    within \"#billing\" do\n      expect(page).to have_select(\n        'Country',\n        selected: \"Canada\",\n        options: [\"Canada\"]\n      )\n    end\n  end\n\n  it \"shows relevant billing address states\" do\n    visit spree.new_admin_order_path\n    click_link \"Customer\"\n\n    within \"#billing\" do\n      expect(page).to have_select(\n        'State',\n        options: [\"\"] + canada.states.map(&:name)\n      )\n    end\n  end\nend\n\nend\n```\nIt is difficult to recreate this UI bug because solidus/backend/app/assets/javascripts/spree/backend/views/state_select.js changes the states listed in the dropdown.\nHowever, if you recreate the conditions originally described in this issue and remove the CSS class js-state_id from the this line, you can see that this bug is still present before JS manipulates the DOM.\nThis gives you options like Alabama, Canada:\n\nI'm not sure overriding a broken view with JavaScript constitutes fixing this bug. If we choose to rely on JavaScript for this view (which is a viable solution for dynamic state selection), we should probably leave the state dropdown empty until the JS has run. Would love to hear other thoughts though.. #2814 will close this issue.. Thanks @mdesantis I think this can be safely closed.. Couldn't recreate this bug in 2.7.. We just talked about needing this at Engine. Thanks!. I don't think I can recreate this on Solidus 2.7.0. I don't think I can recreate this on Solidus 2.7.0. This was fixed by #1915.. This was fixed by #1915.. This is still present in Solidus 2.7. . This is still present in Solidus 2.7. . This seems to be fixed in 2.7.. This seems to be fixed in 2.7.. This was solved by #2771.. This was solved by #2771.. @gmacdougall is this something that still needs work done?. @gmacdougall is this something that still needs work done?. I can't reproduce this on Solidus 2.7.. I can't reproduce this on Solidus 2.7.. @sebfie I haven't are you still seeing the issue? If you have a solution, we'd love a PR! \ud83d\ude04 . @sebfie I haven't are you still seeing the issue? If you have a solution, we'd love a PR! \ud83d\ude04 . I can't reproduce this on Solidus 2.7.. I can't reproduce this on Solidus 2.7.. @kochis #2431 is still being discussed, for sure, if you have ideas you should weigh in there!. @kochis #2431 is still being discussed, for sure, if you have ideas you should weigh in there!. This is a kind of gray question. Really depends on the shop owner I think, however I would think that ideally eligibility should be calculated after all other promotions are applied.. This is a kind of gray question. Really depends on the shop owner I think, however I would think that ideally eligibility should be calculated after all other promotions are applied.. Hey @grichardomi are you still dealing with this issue? Have you tried any solutions out?. Hey @grichardomi are you still dealing with this issue? Have you tried any solutions out?. I am able to replicate this issue. \nNot sure why it happens. Looking into it now.. I am able to replicate this issue. \nNot sure why it happens. Looking into it now.. I believe I have reproduced what @grichardomi is describing.\n\nI am on Fedora 26 and followed the readme to build a sandbox application with Solidus. The screenshot was taken at http://localhost:3000/admin/users/1/addresses.\n@jhawthorn I am new to Solidus, but happy to try and figure this one out. . I believe I have reproduced what @grichardomi is describing.\n\nI am on Fedora 26 and followed the readme to build a sandbox application with Solidus. The screenshot was taken at http://localhost:3000/admin/users/1/addresses.\n@jhawthorn I am new to Solidus, but happy to try and figure this one out. . I am able to consistently reproduce this issue. I will be working on this for the moment. \nedit: PR made. I am able to consistently reproduce this issue. I will be working on this for the moment. \nedit: PR made. I am able to replicate this issue.\nI think the error is the result of validates :price, numericality: true in line_item.rb on line 35. For some reason when I change the currency, restart the server, and create a new product, the new line_item has a price of nil which fails validation.\nLooking into this, but I don't really understand it. Has anyone seen this before?. I am able to replicate this issue.\nI think the error is the result of validates :price, numericality: true in line_item.rb on line 35. For some reason when I change the currency, restart the server, and create a new product, the new line_item has a price of nil which fails validation.\nLooking into this, but I don't really understand it. Has anyone seen this before?. This bug seems to occur with most currencies actually.. This bug seems to occur with most currencies actually.. Hey @mihado work is being done here as well: https://github.com/boomerdigital/solidus_graphql_api\nI would love to see your work get included in that repo. \ud83d\udc4d . Hey @mihado work is being done here as well: https://github.com/boomerdigital/solidus_graphql_api\nI would love to see your work get included in that repo. \ud83d\udc4d . Is work still being done on this @gevann?. Is work still being done on this @gevann?. @gevann is this something you're still working on?. @gevann is this something you're still working on?. @order4adwriter if you see an area to improve -- please submit a PR. Thanks for getting involved!. @order4adwriter if you see an area to improve -- please submit a PR. Thanks for getting involved!. Hey @DanielePalombo are you still working on getting this merged? . Hey @DanielePalombo are you still working on getting this merged? . Hey @liwuqi95 are you using https://github.com/solidusio/solidus_i18n?. Hey @liwuqi95 are you using https://github.com/solidusio/solidus_i18n?. Hey @sechix I can't replicate this issue, it seems to be working for me. \nIf you hit update at the bottom of the product page, does your database match?\nCould you post some reproduction steps?\nThanks!. Hey @sechix I can't replicate this issue, it seems to be working for me. \nIf you hit update at the bottom of the product page, does your database match?\nCould you post some reproduction steps?\nThanks!. Hey @jasonfb! I'm not able to reproduce this -- are you still seeing issues using MySQL?. Hey @jasonfb! I'm not able to reproduce this -- are you still seeing issues using MySQL?. @exocode It looks like @swcraig is continuing work on this change right now!. @exocode It looks like @swcraig is continuing work on this change right now!. I am able to replicate this:\n\nHowever, upon checkout the charge will still be $0.00, so this is really just a presentation layer bug.. I am able to replicate this:\n\nHowever, upon checkout the charge will still be $0.00, so this is really just a presentation layer bug.. I still plan on working on this when I have time, but I'm also happy to pair-with/hand-off-to someone looking to get involved in this project.. I still plan on working on this when I have time, but I'm also happy to pair-with/hand-off-to someone looking to get involved in this project.. @snarfmason this looks great, but could you rebase? Tests have changed and I want to make sure they still look good. Thanks for the PR!. @snarfmason this looks great, but could you rebase? Tests have changed and I want to make sure they still look good. Thanks for the PR!. This passes locally after rebase, and the association really does look like it's doing nothing. Going to merge \ud83d\udc4d Thanks @snarfmason!. This passes locally after rebase, and the association really does look like it's doing nothing. Going to merge \ud83d\udc4d Thanks @snarfmason!. Looking at #580, I'm not sure if this would be a welcome change. Open to feedback.\nAt the least, I would prefer to replace _skeleton.css with a grid system that isn't fixed width.. Based on my own anecdotal experience, I think Solidus frontend is very important for newcomers to Solidus and potential adopters. I also think the current frontend is a hurdle for newcomers because it is a bit dated. \nI would love to build a new frontend with a powerful framework like React or Vue, but In the interest of keeping our footprint small...\nShort-term\nWe will replace _skeleton.css with an extremely light, more-modern CSS grid system. I feel like that is a good incremental quality of life change that will help new Solidus developers in building their own shop frontend.\nLong-term\nIn light of our previous conversation @tvdeyen, I will look in to building a modern starter frontend for Soldius that will function as a drop-in replacement for the current frontend. . Hey @kennyadsl, thanks for your feedback.\nA few things came to mind as I read your response. I'd like make it clear that I am a newcomer to Solidus. My observations come without the context of your history with Spree or prior knowledge of Solidus.\nYou're right that Solidus shouldn't enforce a frontend framework, which is part of the reason we chose to take only the grid classes from Bootstrap. This allows us to make use of a well-tested grid system, without forcing developers to adopt the entire Bootstrap framework. Furthermore, It's no more difficult to remove Bootstrap grid than it is to remove the Skeleton grid. Regardless, if you expect developers to create their own frontend anyway is there any harm in bringing the example frontend up to date?\nPersonally, I can see a lot of value from adopting a modern, well-documented flex based CSS grid. As a newcomer I was very confused by the presence of a fixed-width grid system from 2011. Do you think it is valuable to give newcomers examples that are easier to work? \nRather than rebuilding the entire frontend, #2767 specifically addresses the presence of an outdated, fixed-width CSS grid that might be a stumbling block for newcomers. Essentially this is a pragmatic solution to get Skeleton out of the repository. \nThanks again for you feedback and it's great to hear your opinion on the future of Solidus frontend. . Sounds good, we will look into it when we have time. :+1: . Hey @tvdeyen, thanks for the quick review. \nThe issue occurs in the backend when updating a user's address information. When the country is changed, the states collection does not update. See #2519 for a screenshot of the issue. \nYou can see the behavior in the sandbox app or any vanilla solidus app at http://localhost:3000/admin/users/1/addresses.\nExisting code in stock_locations.js (now locations.js) handled the problem by targeting a CSS class. We added that class to the user's address form, as opposed to rewriting the same code.\nWe changed the name of the JS file and the CSS class name to reflect an increase in usage. It is now being used in admin/users/_addresses_form.html.erb as well as admin/stock_locations/_form.html.erb. \nLet me know if there are any other changes needed.. @tvdeyen @kennyadsl just curious, is there anything else we need to do on this PR?. I understand the hesitation @gmacdougall, personally I just feel that the presence (and implied reliance) on skeleton does a lot more harm than good.\nGiven the current state of Solidus frontend perhaps this PR should go unmerged, but I feel that there is a need to revamp the frontend in a more future-proof way in the near future. \nThanks for the feedback!. Going to close this until I can revisit removing Skeleton in a better way.. Renamed the method - feel free to give some feedback! Thanks!. @kennyadsl sounds good. \nHowever, it is worth mentioning, I think this is 99% presentation as the checkout still reflects a total of $0.00.. @kennyadsl I agree, with the caveat that I don't think we should make it difficult to set a product to zero as some store owners might intentionally give a product away.\nIs #2593 relevant to this issue? \nCould you kill two birds with one stone by handling this issue at the promotions instead of the orders level? Just a thought.\nedit: I didn't check to see if the order is still negative post-checkout. It's possible that the checkout is $0.00, but the order total is recorded as negative.. Hey @BenMorganIO! Thanks for weighing in.\nInside the Order model line 127 is validates :email, presence: true, if: :require_email which makes sure that you can't have a guest checkout without an email. \nThe issue is that the frontend doesn't stop you from progressing though several long screens before the validation fails, causing the user to lose significant time if they have to remake the order. This change will just keep the user from progressing to the next screen without inputting an email - ultimately saving time for an admin user.. @tvdeyen anything else I need to do on this PR. Seems pretty trivial to me, but happy to do some fixups if needed.. Not sure if swapping the namespace is on the current roadmap. Seems like it would be better to just start off with implementing a warning and go from there. $.02. There is also an argument to be made that it shouldn't be possible to create a promotion with no actions.. @eyewritecode go for it!. Yes, something like that.\nI think the second suggestion is a larger change and would probably need a little more discussion, but do what you think is best! \ud83d\ude04 . Hey @bazfer, are you planning on making this change?. @tvdeyen do we plan to solve this, or should the issue be closed for EOL?. I am able to replicate this issue - planning on taking a look at it later today.. Fix for this in #2840 pending review.. @kennyadsl can this issue be closed now that you have merged #2840? . This was closed unintentionally. I'll make a new PR for this issue shortly.. That was super helpful feedback @tvdeyen! I acted on all of your suggestions, thank you. :+1: . Anything else I need to do to get this merged? Don't want it to get lost!. This exists in Solidus 2.7.0. I think this should stay all lowercase. That's purely opinion though. . After some testing this seems to fail intermittently... My previous PR was probably not the best solution, but seemed to work consistently. \nWould love to hear from others who can recreate this bug.. Closing this issue as I haven't seen it since and no one has recreated it.. This may have unintended side effects, so I'd love some due diligence here \ud83d\udc4d . It appears this failed CI, will close for now. . It appears this failed CI, will close for now. . I think it's fine to reference Hound, if we appreciate the tool they've built. \nThe only downside I see is that this might be a weird precedent for adding these kinds of badges.. I think it's fine to reference Hound, if we appreciate the tool they've built. \nThe only downside I see is that this might be a weird precedent for adding these kinds of badges.. I am a fan of the first screenshot (be sure it only lists Hound once though), but it's up to @tvdeyen . I am a fan of the first screenshot (be sure it only lists Hound once though), but it's up to @tvdeyen . @salbertson Do you mind rebasing this, so it can be merged?. @salbertson Do you mind rebasing this, so it can be merged?. Related: https://github.com/rails/rails/issues/33557. Related: https://github.com/rails/rails/issues/33557. Closing this issue after #2826 . Closing this issue after #2826 . Check out #2797. Check out #2797. @octave If you have a solution in mind for this, would you mind making a PR? \ud83d\udc4d . @octave If you have a solution in mind for this, would you mind making a PR? \ud83d\udc4d . It should be mentioned in writing extensions as well.\n@tvdeyen what about someone who works with a store that is on an older Solidus? They might want to build an extension and would care to support the old versions.. It should be mentioned in writing extensions as well.\n@tvdeyen what about someone who works with a store that is on an older Solidus? They might want to build an extension and would care to support the old versions.. @tvdeyen That's fair, totally agree with turning this down in favor of adopting some kind of linter. I feel like there are a lot of opportunities to increase our code quality, particularly in JS.. @tvdeyen That's fair, totally agree with turning this down in favor of adopting some kind of linter. I feel like there are a lot of opportunities to increase our code quality, particularly in JS.. Opened #2849 in response to this feedback. Would love to hear some opinions there so that we can do something about JS code quality. Thanks! \ud83d\udc4d . Opened #2849 in response to this feedback. Would love to hear some opinions there so that we can do something about JS code quality. Thanks! \ud83d\udc4d . Sounds good to me @ericsaupe . Sounds good to me @ericsaupe . I can replicate this on Solidus 2.7.0. I can replicate this on Solidus 2.7.0. I agree, but @tvdeyen makes a great point about adopting it incrementally. . I agree, but @tvdeyen makes a great point about adopting it incrementally. . @peterberkenbosch I think this was closer to @kennyadsl's solution. This allows shops that might want unique behavior to rescue the error. I have no strong feelings about it though!. @peterberkenbosch I think this was closer to @kennyadsl's solution. This allows shops that might want unique behavior to rescue the error. I have no strong feelings about it though!. @tvdeyen in that case, should the language dropdown be disabled if solidus-I18n is not present?. @tvdeyen in that case, should the language dropdown be disabled if solidus-I18n is not present?. @christophebeling does Daniele's solution solve the issue for you? Alternatively you can do as Thomas suggests and install solidus-i18n.. @christophebeling does Daniele's solution solve the issue for you? Alternatively you can do as Thomas suggests and install solidus-i18n.. I am working on this, but happy to work with anyone who'd like to contribute!. I am working on this, but happy to work with anyone who'd like to contribute!. Just found #2028. @tvdeyen do you still have some work for this?. Just found #2028. @tvdeyen do you still have some work for this?. How do you feel about rebuilding this using CSS (backend already has Bootstrap's grid) instead of a table?. How do you feel about rebuilding this using CSS (backend already has Bootstrap's grid) instead of a table?. I think that looks great. I think having to hack around with tables is a pain, but making this change would definitely be a gain. . I think that looks great. I think having to hack around with tables is a pain, but making this change would definitely be a gain. . @kennyadsl essentially the frontend is displaying all adjustments including those which are ineligible on the order. They are not actually being applied to the order, just displayed on the page this JS effects. \nFiltering them by eligibility causes this function to return an empty array which is what should happen when there are not adjustments affecting the order.. @kennyadsl essentially the frontend is displaying all adjustments including those which are ineligible on the order. They are not actually being applied to the order, just displayed on the page this JS effects. \nFiltering them by eligibility causes this function to return an empty array which is what should happen when there are not adjustments affecting the order.. @kennyadsl that test is actually running on another page. That is running admin/orders/:id/adjustment (and should pass), but this change affects admin/orders/:id/cart. I will look into writing a regression spec for this change.. @kennyadsl that test is actually running on another page. That is running admin/orders/:id/adjustment (and should pass), but this change affects admin/orders/:id/cart. I will look into writing a regression spec for this change.. @ericsaupe I haven't had a chance to revisit it unfortunately!. @ericsaupe I haven't had a chance to revisit it unfortunately!. @tvdeyen added a viewport tag. Should be useful if we want to make admin mobile friendly.. @tvdeyen added a viewport tag. Should be useful if we want to make admin mobile friendly.. @kennyadsl Ah, well this PR isn't doing that quite yet. Instead this PR just makes some of the forms collapse on smaller window sizes. \nI will read through those threads if I get to a sidenav PR! Thanks for the info!. @kennyadsl Ah, well this PR isn't doing that quite yet. Instead this PR just makes some of the forms collapse on smaller window sizes. \nI will read through those threads if I get to a sidenav PR! Thanks for the info!. Sounds good @tvdeyen. I will look into that!. Sounds good @tvdeyen. I will look into that!. Closing this until we have a resolved #2961, then I will revisit a more complete version of this.. Pretty sure I made PRs to all of the Solidus Extensions from http://extensions.solidus.io/ that are still running against EOL versions. I'll leave the issue open for now in case there is more discussion.. Pretty sure I made PRs to all of the Solidus Extensions from http://extensions.solidus.io/ that are still running against EOL versions. I'll leave the issue open for now in case there is more discussion.. If we stop testing against EOL versions as a rule, should this toggle on http://extensions.solidus.io/ go away?\n\n. If we stop testing against EOL versions as a rule, should this toggle on http://extensions.solidus.io/ go away?\n\n. Please do @mayanktap! Let me know if you need help and I'll try to give you some guidance. :). Wow that's great \ud83c\udf89 \nYes, we usually branch off of master and PR back to master and branch names aren't a big deal to Solidus.\nThanks a ton for your help! \ud83d\udc4d . I was working on this last night actually. I agree that getting rid of the huge number of deprecation warnings would be great. \n\nThe problem is that back in June RubyMoney/money deprecated html in favor of html_wrap, which doesn't exactly do the same thing.\nFrom RubyMoney/money docs:\n\nMoney.ca_dollar(570).format(html: true, with_currency: true)\n\n=> \"$5.70 CAD\"\nVS\n\nMoney.ca_dollar(570).format(html_wrap: true, with_currency: true)\n\n=> \"$5.70 CAD\"\nUnfortunately because html_wrap and html actually do different things, this change breaks a handful of important tests. Also if you look at the frontend after making this change you will see this:\n\nSo it's possible that getting rid of these deprecation warnings would take more than just using html_wrap where we were using html.. I'm now seeing this in Sandbox:\n[DEPRECATION] `use_i18n` is deprecated - use `Money.locale_backend = :i18n` instead. @aitbw It's been a while since I opened this -- I think I was referring to the actual coupon code.. @ccarruitero It feels to me like a hostile UX to hide a previously existing UI element for no real reason. I would have kept this change in a private fork if I didn't think it had more application in Solidus.\nBuilding this as an extension would likely require a Deface, which is far from ideal (and honestly overkill).\nWhile the product SKU may become less important for the developer when multiple variants exist, I would contend that it could provide significant value to an end user (which is who the admin UI should be built around). \nFinally, I think it's extremely important that a SKU has a sense of permanence. A SKU tied to a variant may cease to exist much more easily than a SKU tied to a product. This is not to say that variant SKUs aren't important because they obviously, are and Solidus is correct in using them in most cases, but rather than it's valuable to be able to refer to a product versus a variant of that product. In some cases, the ability to change that value might also be necessary.\nAgain, these are thoughts with the user in mind, not the developer.\n. @tvdeyen any thoughts on #2875?.  \ud83e\udd26\u200d\u2642\ufe0f . @tvdeyen in that case can we remove .travis.yml? Would help blind people like me not to do this. . Added a commit, should I make a new PR or use this one? . @ericsaupe good call. done!. @tvdeyen Thanks for pointing that out, I went ahead and changed it because the point of this PR is just to standardize inconsistencies in our documentation. I'd rather have it be as close as possible to what people expect so that future contributors aren't confused when they try to add documentation.. @trottomv Good research! Are you able to make a PR to fix this?. This has the potential to be a really big change, but I'd love to see it made.. @trottomv Please do!. This is a WIP, but wanted to make sure this was the direction we should go.. We can copy the SVG over to the root of this repo if that's better?. \ud83d\ude2d \n\n. That might be a better solution, although this does fix it when I run tests which was what I was trying to fix. I'll try to make it a configuration option instead though.. Work is being done on #2912. @kennyadsl I think that is a good idea.\nHowever, I also really like this part of the Citizen Code of Conduct:\n\n1. Purpose\nA primary goal of Solidus is to be inclusive to the largest number of contributors, with the most varied and diverse backgrounds possible. As such, we are committed to providing a friendly, safe and welcoming environment for all, regardless of gender, sexual orientation, ability, ethnicity, socioeconomic status, and religion (or lack thereof).\nThis code of conduct outlines our expectations for all those who participate in our community, as well as the consequences for unacceptable behavior.\nWe invite all those who participate in Solidus to help us create safe and positive experiences for everyone.\n2. Open Source Citizenship\nA supplemental goal of this Code of Conduct is to increase open source citizenship by encouraging participants to recognize and strengthen the relationships between our actions and their effects on our community.\nCommunities mirror the societies in which they exist and positive action is essential to counteract the many forms of inequality and abuses of power that exist in society.\nIf you see someone who is making an extra effort to ensure our community is welcoming, friendly, and encourages all participants to contribute to the fullest extent, we want to know.\n\nAnd I appreciate the idea of having a line of communication -- such as an email inbox intended for people who are having problems or have questions with the community.\nThoughts?\n. @tvdeyen @kennyadsl What are your thoughts on the following?\n\nThe Solidus Code of Conduct\nSolidus strives to be inclusive of as many contributors as possible.\nAll contributors and participants are welcome regardless of gender, sexual orientation, ability, race, ethnicity, socioeconomic status, and religion (or lack thereof).\nThis document highlights the values of the Solidus community. It includes our expectations for community members. It is inspired by elements of the Ruby Community Conduct Guideline.\nIt applies to all \"collaborative space\", which is defined as community communications channels (such as mailing lists, messaging platforms, conferences, meetups, submitted patches, commit comments, etc.).\nCommunity Expectations\n\nParticipants will be tolerant of opposing views and new ideas.\nParticipants will not engage in personal attacks and disparaging personal remarks.\nWhen interpreting the words and actions of others, participants will always assume good intentions.\nBehavior which can be considered harassment will not be tolerated.\n\nWe invite all Solidus contributors and participants to join us in creating a productive and positive open source community.\nHave Questions?\ncommunity@solidus.io\n\nI would love to hear from @gmacdougall @cbrunsdon or @ericsaupe as well as any member of the community with opinions on this idea. Thanks.. Done!. @tvdeyen Done, also updated the CoC to the copy from my previous comment. Thanks!. Not sure why this failed CI. You can't see any useful information on the Circle web app because of the deprecation warnings, but if you download the log here is the failure:\n1) Checkout user has payment sources allows user to enter a new source\n     Failure/Error: expect(page).to have_current_path(spree.order_path(Spree::Order.last))\n       expected \"/checkout/payment\" to equal \"/orders/R681598160\"\n     # ./spec/features/checkout_spec.rb:364:in `block (3 levels) in <top (required)>'. @kennyadsl Good suggestions, changes made!. @tvdeyen I agree, let's talk about it some more. \n@mamhoff I think we started with that, but started leaning more towards this based on @kennyadsl's suggestion to look at https://www.ruby-lang.org/en/conduct/ for inspiration. . @ericsaupe @stem that's definitely valuable. Do you have any ideas on how to phrase that? I'd love to incorporate it, but those rules should come from the core team.\n@tvdeyen any thoughts on how long we should leave this open? I will drop it in Slack again.. @kennyadsl @tvdeyen @jarednorman @stem @mamhoff \nBased on suggestions from all of you, I have reset this PR to a single commit that is just the Contributor Covenant. The only part left for this document is selecting an email address to put in this document.\nDoes anyone object to adopting this document, and making changes if the need presents itself?. @chukitow we are having issues with circle right now! Might not be your code. . Great first PR! \ud83c\udf89 \nRegarding Eric's suggestion on the commit messages, we have some great resources for good commit messages in contributing.md, if you're interested. \nThanks for fixing this bug!. Hey @eyewritecode thanks for making this PR! Looks like one of the test suites failed. Could you re-run those or see if you can fix the test?. Hey @eyewritecode, looks like you've picked up some extra commits here. Do you mind taking a look at your branch?. @bitberries thanks for making this PR! \ud83c\udf89 \nWe have some great resources for writing good commit messages in our contributing.md file, if you're interested! . @ericsaupe I agree, something I've been meaning to go back and work on more but haven't had the time. Thanks for the review!. Still failed. \ud83e\udd14 . Does this cause the UI to break horrendously (see #2870) or is it working?. I think not raising an exception is a good idea. I'm not too familiar with doing international stores, so anyone can correct me, but I think people should be able to edit prices for different currencies in this way.. I'm not sure we are ready for this yet. What do you think @kennyadsl?. Hey @monkeywithacupcake thanks for sharing this with us, I think we are going to work on implementing this a specific way in #3042. We really appreciate your example!. Thanks for reporting this, small usability upgrades are great!. I'm not able to reproduce this, but that doesn't mean there isn't a bug.\nTo logout just go to localhost:3000/logout. In the example frontend there is also a link if you're logged in:\n\n. @tvdeyen Changes made, does that work for you?\n@kennyadsl I added some comments to explain how the position attribute should be used. In most cases, the value doesn't need to be present and the behavior will be exactly the same as it currently is in Solidus. However, if someone wants to alter the ordering they simply add or change the position attribute to match the order they would like the menu to display. Does that make sense, or do I need further changes?. @kennyadsl for example Spree::Backend::Config.menu_items.find { |i| i.label == :promotions }.position = 0 would make promotions first. Do you think there is a better way to achieve this?\nedit: realized I forgot to commit the attr_accessor that makes this possible. . @kennyadsl @tvdeyen please let me know if you have any more thoughts on this one!. @kennyadsl I'm not sure I understand your question. I didn't change the button text, rather the section heading text from Search to Filter. Because this is not a conventional search, instead it's a set of filters to narrow results.\n@tvdeyen I think Search really might be incorrect here because it's not a search. It's a series of filters. Your call though \ud83d\udc4d . @tvdeyen done!. Just realized this will probably break some UI tests. \ud83d\ude06 I'll try to make those changes where necessary.. @kennyadsl done!. Which of these two expected behaviors is ideal? I feel like if a product is set to \"do not track\" then we shouldn't allow changes to the count, but does anyone else feel different?. @ychaker yes, I think there should be some indication for sure.\n@ychaker would you like to make a PR for the change Alberto has recommended?. Hey @gerritwessels if you have an idea to fix this, we'd love to get a PR for it. \ud83d\udc4d . In Slack @VzqzAc brought up:\n\nwouldn\u2019t show the master image misinform the user of the variant being selected? Thinking a bit about UX in here :thinking_face: open to discussion though\n\nI think he has a point, but I also don't expect the people using this page to really understand the difference between a normal variant and a master variant. As long as the SKU is correct, I don't think it would be a bad user experience.. @aitbw Yes, that is correct, but this is automated. Not all who wish to contribute to the docs will know to use [ci skip] or [skip ci] in the commit message. . Not to mention that I'd just like to hear opinions on this idea. There may be a very good reason to run CI on doc changes. \ud83e\udd37\u200d\u2642\ufe0f . Unfortunately this isn't a CircleCI feature, though I wish it was... It requires some creative thinking to solve. I think I could probably figure out a way to do this inside of the CircleCI config, but I'm not sure I see the benefit of doing it that way.\nI will see if I can find a way to do that, but it might be simpler to stick with this implementation. \nWould it help if we created a scripts/ directory to put things like this? build.sh could live there as well.. @kennyadsl Done!. Done @kennyadsl \ud83d\udc4d . Could we add some margin between the buttons?\n\nAdding <%= link_to t('spree.new_product'), new_object_url, id: 'admin_new_product', class: 'btn btn-primary mr-2' %> makes it a bit better, don't you think?\n\n. I like usability ideas like this one.\nThere is also a danger that we are assuming the individual is using both solidus_frontend and solidus_backend. I think a fair number of people choose to forgo solidus_frontend.. @seand7565 That is something I had thought of as well, the question is: Do we want to perpetuate that pattern? I think that's a call for the core team.. > We could assume that extensions or shops that install solidus_support also will have solidus_core installed, no?\n@tvdeyen Yes. solidus_support depends on solidus_core so a site using solidus_support without solidus_core wouldn't work anyway.. @tvdeyen thoughts on this? https://www.useloom.com/share/9270e32141c14ef1baf7e34d6473401c. @tvdeyen What do you mean by as high as the header? Do you want it to be level with another element or taller? I can make the change, just want to make sure I understand.. \nAny smaller than this and it is almost impossible to see, it's still a little larger than the other icons.. @kennyadsl does this solve that issue for you? I'm not sure it's the best way, but I'm not sure how I should accomplish this in vanilla JS.. @tvdeyen I actually agree with everything you have listed here. I am glad to hear there is interest in implementing this in a more correct way. \nAs long as we are comfortable with a more significant UI change, I agree that we should move towards something like you have shared. I will approach this with your thoughts in mind. I am going to open an issue to get some further discussion from other members of the community.. I'd love to hear any constructive feedback on this idea. . @ericsaupe I don't disagree with you. However, I do think there should be an option for stores who don't want coupon stacking of any kind and this is a rather generic implementation of that which can be extended for more specific use cases (e.g. picking the best coupon).\nI would also really like if there was a global config option that disabled coupon stacking on ALL coupons, but that is a little less granular than this method.\nJust to clarify, the way it works, a promotion with this rule could not be applied if another promotion was already applied AND no other other promotion could be applied after it was applied. So it is only possible to use such a promotion as the ONLY promotion.. I am currently working on this, but would love to take suggestions here!. @tvdeyen sure! That'd be a big help, thanks!. Let's keep this issue open for discussion. . It looks like you picked up 42d6c9c by accident! . @nvh0412 Yes, I believe that test is a bit flaky. It keeps showing up in various PRs.. I don't think this PR is related, but I'd like to figure out why the test is red before approving. . I can confirm this, it has been present for at least a couple of months. This seems to happen about 10% of the time (that's a fabricated statistic). . @aitbw I believe I have seen it with sqlite as well actually.. I think that might be an implementation detail best left up to the stores themselves, nevertheless, it is obnoxious that we allow the user to get to a point in which a non-present count on hand value stops them.\nWhat do you think is the best UX?. I'm still completely in support of this getting merged.. @tvdeyen I agree with your comments, this was sloppy CSS, but I do think we should have a presentable UI. As long as we have best practices CSS is fairly easy to overwrite.. @tvdeyen I updated the selector for adding margin to the billing field. The UI change is the same, but this is much more specific to this single element. \nI looked for other places this CSS was needed and didn't find any, so I left the rules where they were. Please let me know if I need to do anything else for your approval. . @aitbw I'm not certain we need it, but can you rebase just to be safe?. @aitbw I see this now, I thought this was intermittent. This failure is new. . This is the same issue documented #2989. Thanks for reporting it @ryangall7!. Hey @Nittarab, thanks for the PR! Do you mind addressing Hound? . We can deprecate the *_decorator.rb pattern now with a warning and add support for using *_override.rb (or whatever), then remove support for the old pattern in 4.0? Is that too long term, or does it make sense? \nThat's assuming that the 3.0 release (https://github.com/solidusio/solidus/milestone/16) isn't too far off.. If we keep it the way it is, let's document why we do that here: https://github.com/solidusio/solidus/blob/master/guides/source/developers/extensions/decorators.html.md. You probably need to change your Gemfile to point at a more recent version. \nThis will probably help: https://bundler.io/v1.17/guides/bundler_sharing.html. @mdesantis was this closed by accident?. Hey @forever-sumit, any update on this? Would love to get this merged!. @kennyadsl done!. Re-running specs, touching a markdown file shouldn't cause a feature spec to fail.. I'm happy with this as is, what do you think @kennyadsl?. I'd love to see a PR that does this as well. Go for it!. @RyanQuey did @spaghetticode answer this for you? Don't want to close the issue if you're still struggling? . This is definitely worth talking about, we've moved far enough from the original Spree project that it's probably a good idea to try making that comparison a little easier for potential stakeholders. \nI also know that there is the potential for causing some serious harm to extensions, etc.. Those are good points @patleb. Thanks for sharing. \nI tend to agree with Jared, this isn't extremely important.\nThe only benefit I see is trying to make it easier for those assessing Solidus and Spree to more clearly understand that they are not necessarily interchangeable (despite being very similar).\nAs I said before, this discussion is definitely worth having.. Thanks so much for your thoughts @patleb and @dustineichler. I prefer having these conversations in the open so people will know why we make the decisions we make :). Re-running build to get \u2705 . This still exists in master. ~I'll try to make a fix today.~ I think @aitbw is on it. . @doke we should definitely look for opportunities to do that! If you want to open a PR that would be great, otherwise I'm sure we will get to it \ud83d\ude04 . Thanks for making this change!. Oops! Good catch.. Hey Thomas, great feedback! I addressed most of your thoughts in my last commit, but I'm not sure I understood this comment. I sent you a Slack message about it, but you're also welcome to explain here. \nI'm not sure how someone would use the solidus_cmd gem without installing it. Could you explain how it should be used?. For posterity, Thomas' answer on Slack: \n\nIt\u2019s not necessary to install this gem to create an extension, as an extension is \"just a rails engine\". I don\u2019t want to give the impression that creating an extension is only possible with this gem. But we should still recommend it. Thanks for the feedback @BenMorganIO, changes made. Let me know if there is anything else you can think of!. Thanks for the feedback, just pushed some more tests! . @benjaminwil Thanks noticed this just a few seconds ago \ud83d\udc4d . Actually no, I removed it. \ud83d\ude2c :return_reasons worked where :return_authorization_reasons didn't seem to. I did this early in the morning, so due diligence is good. Does this need to go back?. I was following the example of ensure_line_items_present here. Happy to remove this, although is this a performance issue? . Will happily remove it! Thanks for the feedback, appreciate it!. @BenMorganIO interestingly the error doesn't seem to raise when I don't return false. Does AASM rescue errors like this or something? \n\nI'm relatively unfamiliar with AASM.. @peterberkenbosch do you think raising an exception is a better alternative? . Because it is possible for a user to hit this (given the right circumstances), I think we should leave it with AR. Thanks for clearing up our confusion!. Hey @tvdeyen, do the tests I pushed look adequate? Thanks!. We can make the inverse change if you feel that is the right way to go -- I just tried to make the fewest changes possible based on the README. I'm all for being consistent when it comes to formatting \ud83d\udc4d . I'd rather be consistent with the docs. Made that change. Thanks!. Sorry, here is the explanation in the commit message:\n\nAdd comments to the issue template\nPersonally I always end up removing these instructions so it made\nsense to me to go ahead and make them comments. This commit also\nadds instructions to get the current Solidus version from Rails\nconsole.\n\nThis just makes them not show up in the issue if someone doesn't remove them. It's purely my preference and I'm happy to remove that change.. ### Steps to reproduce\n How can we make this happen \nExample\nExpected behavior\n Tell us what should happen \nExample\nActual behavior\n Tell us what happens instead \nExample\nSystem configuration\nSolidus Version:\n Unsure? Check with <code>Spree.solidus_version</code> \n2.7.0\nExtensions in use:\nN/A\nSource for this comment:\n```\nSteps to reproduce\n How can we make this happen \nExample\nExpected behavior\n Tell us what should happen \nExample\nActual behavior\n Tell us what happens instead \nExample\nSystem configuration\nSolidus Version:\n Unsure? Check with <code>Spree.solidus_version</code> \n2.7.0\nExtensions in use:\nN/A\n```\n. This is how it should work. . Okay, thanks I will make that change and follow up by making sure the documentation is up to date with this change.. @kennyadsl Like I said, I'm am happy to get rid of this change if you think it doesn't work.. @kennyadsl done!. You're right, also the contact email and the reporting email should be different.\nI'm happy to be that person if no one wants to volunteer, but would a group email for the core team members be better? That would allow you and the others to discuss the emails during core team meetings when/if they came up.. Do we want to create something like community@solidus.io? . This was done so I could set the size of the image. If you know a way in GH markdown to set image width we can do that instead.. FWIW the above is a workaround specifically for doing this in markdown files, so it does work. . It's pretty huge, but if that's okay markdown works. Hey Angel! Thanks a ton for making this PR. \nI'm not sure we need the comma after Please. It also might more sense to change this to a specific endpoint.. Same as the comment above regarding the specific method/endpoint and the unnecessary comma.. See other comments \ud83d\ude04 . I feel like I would rather be given a specific endpoint that is most similar to the method I attempted to use, does that make sense?. I like that suggestion @elia do you agree with this @kennyadsl?. Would you mind expanding the above comment to explain what match_path is used for?. I believe you are missing a space after mysql -uroot -e. I'm not crazy about You cant destroy undestroyable things! I think there is a better way to phrase this.\nWe definitely need to add an apostrophe: You can't destroy undestroyable things!\nAlso, we probably want to add this to en.yml instead of just writing the string.. @bitberries That's fair, let's not worry about putting it in yaml then! I know it's picky, but I'd like to at least see the apostrophe :). I don't think this should be a comment.. I don't see this on the other sections. It might be present and I just haven't noticed it, but I don't think we should add bottom padding to the whole admin. My sandbox is currently broken because of #2989, but I will look for more instances of this.. You are correct. There are also other uses of this partial where this rule needs to be applying. I'll make this selector more specific and it probably needs to live in a different SCSS file as well. Not sure what I was thinking when I added this \ud83d\ude2c Thanks!. You've got the word the twice on this line.. I prefer Solidus' over Solidus's, but I think both are technically okay.. @andyyang We would love to have you help out! I think Thomas has this covered. Would you take a look at https://github.com/solidusio/solidus/issues for another issue? Thanks!. @cedum Thanks for this contribution! Do you mind addressing this hound complaint? \ud83d\udc36 . \u261d\ufe0f This seems like a lower touch fix.. I'm not sure about a guard clause being this long, but it's certainly not blocking.. I'd rather have less code in the example where possible. Changed to class-level, does that make sense?. Yes, I agree with his feedback. . Yes, I'd prefer coupon_code_not_present.. I'm fine with whatever, this is just a minor annoyance we noticed a couple of days ago. Whatever makes this easy to understand. \ud83d\ude04 . Ah, so we may have to add those images manually. @seand7565 do you think you can do that for us? I can keep up with it as more people join that tier. \ud83d\ude04 . This is true because in OC those are names for the tiers we are using. Backer is $10-50 and Sponsor is $100-500.\nMaybe ## Sponsors can change to ## Key Stakeholders and perhaps we can say: \nThank you to all our donors! \ud83d\ude4f [Become a donor](https://opencollective.com/solidus)\nI'd also like to see this higher in the readme (like before ## Summary) to demonstrate the support + provide more value to those willing to donate such a significant amount of money.. Can we grab them from OpenCollective profiles? For example https://images.opencollective.com/proxy/images?src=https%3A%2F%2Flogo.clearbit.com%2Fenginecommerce.com&height=100. \ud83d\udc4d Good comment!. you can use Docker to run a demo in your local machine => you can use Docker to run a demo on your local machine. Perhaps this could say The admin interface can be accessed at [http://localhost:3000/admin/](http://localhost:3000/admin/), the default credentials are `admin@example.com` and `test123`., what do you think?. ",
    "skukx": "Security speaking, I don't think it is ever a good idea to allow anyone other than the user themselves set the password. I think this is a good step in the right direction. Something like...\n``` ruby\ndef generate_spree_api_key!(expire_in = nil)\n  generate_spree_api_key(expire_in)\n  save!\nend\ndef generate_spree_api_key(expire_in = nil)\n  payload = self.as_json(only: [:id, :email, :login])\n  payload.merge({ exp: Time.now.to_i + expire_in }) if expire_in.present?\nself.spree_api_key = JWT.encode payload, 'my$ecr3t!', 'HS256'\nend\n```\nThen:\nruby\nuser.generate_spree_api_key(4.hours)\nof course spree_api_key could eventually be dropped all together and replaced with a boolean value like allow_api_access\nTo authenticate requests:\nruby\n      def load_user\n        @current_api_user ||= begin\n          payload = JWT.decode(api_key, 'my$ecr3t!', true, { algorithm: 'HS256' })[0]\n          Spree.user_class.find_by(id: payload['id'])\n        rescue\n        end\n      end\nAlso 'my$ecr3t!' could be something like ENV['secret_key_base']\n. Request headers could stay the same.  For backwards compatibility the column spree_api_key could be left for the time being and maybe add a column spree_api_access :boolean. Then allow configuration value for use_jwt. Based on this value is how the server handles key generation and verification. Maybe During the verification it can try finding a user by spree_api_key if no user then try verifying the json web token. Add methods:\n``` ruby\ndef generate_spree_jwt(expires_in)\n  # Generate json web token\nend\ndef load_user\n  if use_jwt\n    # Verify X-Spree-Token as json web token.\n  else\n   # Do regular stuff\n  end\nend\n. @jrochkind @jasonfb, Any thoughts on new PR?\n. Failures on truncation for `spree_api_key` column. The column is no longer needed So maybe drop the column and add a boolean `allowed_api_access`.  With the drop, many tests will need to be refactored.\n. See: https://github.com/solidusio/solidus/issues/1383\n. To work with \"reset token on password change feature\" it would be best to keep the token life short and implement a refresh token.  When validating refresh token, we could then check whether a password change has occurred. If so then we require sign in again.  Also while validating the refresh tokens we can check the db for any blacklisted tokens.  This limits the the db querying while staying secure as long as tokens life is short (~ 30 min).  I agree, much more work needs to be done to get this going.  Authentication would be handled by a Spree::Api endpoint using devise methods.\n. Is it possible to merge this fix with past versions of solidus (1.4, 1.3, etc)? and release version bump to gems?\n. The reason this is happening is because of this line:\nhttps://github.com/solidusio/solidus/blob/v2.1/core/app/models/spree/order.rb#L355ruby\n    def outstanding_balance\n      # If reimbursement has happened add it back to total to prevent balance_due payment state\n      # See: https://github.com/spree/spree/issues/6229\n      adjusted_payment_total = payment_total + refund_total\n  if state == 'canceled'\n    -1 * adjusted_payment_total\n  else\n    total - adjusted_payment_total\n  end\nend\n\n```\nAfter a Spree::Refund is created perform! is called\nhttps://github.com/solidusio/solidus/blob/master/core/app/models/spree/refund.rb#L16\nIn turn, this method calls payment.order.updater.update Which updates the payment_total column on the Spree::Order. This update already accounts for refunds when calculating payment_total.\nSee https://github.com/solidusio/solidus/blob/master/core/app/models/spree/order_updater.rb#L141\nruby\ndef update_payment_total\n    order.payment_total = payments.completed.includes(:refunds).map { |payment| payment.amount - payment.refunds.sum(:amount) }.sum\nend\nSo TLDR; Get rid of adjusted_payment_total because payment_total is already adjusted.\nEdit\nI'm realizing that this method may be used at times when the payment total has not been updated. So the question stands on what is the best way to fix this?. Issue #1525 \n. @jhawthorn @cbrunsdon https://github.com/solidusio/solidus/pull/1526/commits/44f0e6ea4c530137aab12cf42c56a130200dabee\n. Hold off on merging until I can apply to this file as well\nhttps://github.com/solidusio/solidus/blob/master/backend/app/views/spree/admin/orders/edit.html.erb#L17\n. Whats the status on this?\n. @tvdeyen That would be great to get a repo under solidusio-contrib.  My employer would find it very valuable to perform analytics using these geo-points.\n. It was brought up before that this would be better on the line item. For example add columns giftwrap, imprint etc.  However I don't think it would be very scalable to be adding a new column for every new personalization.  Also I believe this would require a lot of monkey patching.\n. For more detailed explanation see: https://github.com/solidusio/solidus/issues/1475#issuecomment-292367955. Awwww I see what you're saying.  I was under the assumption that it was these methods were returning Spree::PaymentSource and that Spree::WalletPaymentSource was a join table to those classes.. What is the reasoning for why the Spree::WalletPaymentSource (Join table) is returned rather than just the Spree::PaymentSource  In most cases won't you be calling wallet.default_wallet_payment_source.payment_source?. Ok, I finally understand what is happening. I mistook Spree::PaymentSource to be Spree::Payment and thought that Spree::WalletPaymentSource was just a join table to Spree::Payment. So calling wallet.default_wallet_payment_source.payment_source returned a Spree::Payment which had the polymorphic association.  However Spree::WalletPaymentSource is the actual polymorphic table (Not the join table).  I fully support this implementation understanding this now and closing the PR.. @mamhoff I agree, I don't think there is a good way to do this dynamically so I'm thinking of another way that this can be done similarly but extra methods will need to be defined by host apps. Closing this in favor of https://github.com/solidusio/solidus/pull/1992. This will allow other apps to use a concern such as:\n```ruby\nmodule Spree::Wallet::GiftCards\n  extend ActiveSupport::Concern\nincluded do\n    payment_source_helper Spree::GiftCard\n  end\nend\nSpree::Wallet.include Spree::Wallet::GiftCards\nuser.wallet.gift_cards #=> [Array]\n``. @cbrunsdon right now we are working on integrating with our WMS.  The idea was to send our wms what items to ship as theSolidus::Shipment` moves to ready.  This would ensure that payment is full, and that there is enough stock.  Normally the WMS could probably account for the stock portion  but the WMS we have a contract with doesn't have the most friendly API.. @jacobherrington I looked into it a while ago. I believe it is an easy fix, just a scoping issue. Yeah I can add a test for this. As far as the naming convention, I followed convention on how Spree admin chooses to display payment sources.\nSee: https://github.com/solidusio/solidus/tree/master/backend/app/views/spree/admin/payments/source_views\nIf we want to move away from that convention I will change the views mimic that payment source rather than the method. Yeah I can add a test for this. As far as the naming convention, I followed convention on how Spree admin chooses to display payment sources.\nSee: https://github.com/solidusio/solidus/tree/master/backend/app/views/spree/admin/payments/source_views\nIf we want to move away from that convention I will change the views mimic that payment source rather than the method. Let me know if the specs added are sufficient. Made changes as requested. What is the status of this?. I just pushed something new so it may have to do with that. I'll take a look\n. Look like I just needed to rebase my branch on master. I like the idea of can_supply? or close to that (can_dispurse?, can_fulfill?, can_allocate?) and the name makes sense for the functionality it will provide.  Items that are in stock, or backorderable, or don't require tracking. Possibly add a scope to the variant called suppliable to go with the in_stock scope.\nruby\nSpree::Variant.in_stock\nSpree::Variant.suppliable\nSee: https://github.com/solidusio/solidus/blob/master/api/app/controllers/spree/api/variants_controller.rb#L70. This is definitely something Deseret Book would much appreciate. From a quick glance everything looks good to me. I'll take a closer look later though.  My only request would be to add more documentation above each method and class. Also agree with everything else said above. @mtomov Great Video! I like your implementation as well. I've started a PR https://github.com/solidusio/solidus/pull/2816 on this. I made some small changes to your implementation. Since this would be a new feature, I find it best to start simple and as needs grow expanding on it later.\nI also left out\nruby\nmessage = error.respond_to?(:message) ? error.message : error\nAnd please correct me if I'm wrong but I believe the logger automatically extracts the message if the object passed in is an error object.. Here is a list of current Spree errors being raise for reference:\nList of current spree custom errors\nruby\nSpree::Core::GatewayError\nSpree::Exchange::UnableToCreateShipments\nSpree::LineItem::CurrencyMismatch\nSpree::OrderCapturingFailures\nSpree::OrderMutex::LockFailed\nSpree::Order::CannotRebuildShipments\nSpree::Order::InsufficientStock\nSpree::PromotionCodeBatch::CantProcessStartedBatch\nSpree::Reimbursement::IncompleteReimbursementError\nSpree::StockLocation::InvalidMovementError\nSpree::Stock::ShipmentRequired\nSpree::Stock::OrderRequired\nSpree::Wallet::Unauthorized\nList of generic raise errors\nThese are errors that don't raise any specific exception. For example:\nruby\nraise 'Some error'\nThese errors may be fine as is or we may want to create a custom error for\nsome so they are not classified RuntimeError directly. For example:\n```ruby\nraise \"Cannot set 'default' on a credit card without a user\"\nVersus\nraise Spree::CreditCardError, \"Cannot set 'default' on a credit card without a user\"\n```\nruby\nraise \"Cannot set 'default' on a credit card without a user\"\nraise \"The order association has been removed from InventoryUnit. The order is now determined from the shipment.\"\nraise 'perform should be implemented in a sub-class of PromotionAction'\nraise \"Attempted to call code on a Spree::Promotion. Promotions are now tied to multiple code records\"\nraise \"Attempted to call code= on a Spree::Promotion. Promotions are now tied to multiple code records\"\nraise \"unexpected match policy: #{preferred_match_policy.inspect}\"\nraise \"Implement me\"\nraise \"Adjustment is already created\"\nraise \"Adjustable does not match line item\"\nraise 'No master variant found to infer price'\nraise \"Unexpected originator type #{originator.class}\"\nraise \"Your database needs at least one completed order to render this preview\". I think this is a good idea. Using BigInt would probably be the best since it is what rails defaults to.  We recently hit an issues where one of our databases hit the int limit and it crashed a whole lot of services.. @BenMorganIO I'm shooting from the hip here so anyone correct me if I'm wrong. I believe the reasoning is the you can usually determine the order rows were inserted into the table by the traditional BigInt ids because typically they increment (Not always the case). If you have a very large table, indexing the created_at column will enable faster sorts. I think by default Rails sorts by id which is a primary key enabling quick sorts.\nYou can't make the same assumptions on UUID since it is a string and ordering by it would cause unexpected results as far as which order the rows were created.\nThe index for created_at would probably be something that would go hand in hand with the extension which uses uuid since it would not be needed on an incremental BigInt column.. @kennyadsl You're right I haven't written specs around this yet. If this is something the community/core team likes then I'll continue work on it.. @kennyadsl That part gets a little complicated and right now it would piggy back off of Devise Sessions controller.\nThink of whatever server is performing our authentication as our AuthServer.\nWhen a user's token expires, front-end app redirects to the AuthServer. The AuthServer would either recognize the user or it wouldn't.\nIf the AuthServer recognizes the user (still logged in), then it generates a new token and sends it back. See: https://github.com/solidusio/solidus/blob/b8258bffd9c42ff934c184cf598eb47512ccb26f/core/lib/spree/core/controller_helpers/auth.rb#L34-L42\nHowever if the user is no longer authenticated with the AuthServer, then the AuthServer renders the login page for the user to authenticate.. Yes, when I get time, I'm probably going to do this. It can be hard to make a big change like this without already seeing it in action. I'll probably release a gem that does this then if it is proven useful we can move it in.. This has been moved to an extension. See: https://github.com/skukx/solidus_jwt. The current structure for errors currently looks looks something like:\nruby\nmodule Spree\n  class Exchange < Spree::Base\n    class UnableToCreateShipments < StandardError; end\n  end\nend\nIs that a practice we want to follow as far as declaring/defining the errors within the models? Or would we rather do something like:\nruby\nmodule Spree\n  class Error < StandardError; end\n  class PaymentSourceError < Error; end\n  class CreditCardError < Error; end\nend\nEssentially where the errors are defined in one place rather than disbursed throughout the models.. From #2801 \nHere is a list of current Spree errors being raise for reference:\nList of current spree custom errors\nruby\nSpree::Core::GatewayError\nSpree::Exchange::UnableToCreateShipments\nSpree::LineItem::CurrencyMismatch\nSpree::OrderCapturingFailures\nSpree::OrderMutex::LockFailed\nSpree::Order::CannotRebuildShipments\nSpree::Order::InsufficientStock\nSpree::PromotionCodeBatch::CantProcessStartedBatch\nSpree::Reimbursement::IncompleteReimbursementError\nSpree::StockLocation::InvalidMovementError\nSpree::Stock::ShipmentRequired\nSpree::Stock::OrderRequired\nSpree::Wallet::Unauthorized\nList of generic raise errors\nThese are errors that don't raise any specific exception. For example:\nruby\nraise 'Some error'\nThese errors may be fine as is or we may want to create a custom error for\nsome so they are not classified RuntimeError directly. For example:\n```ruby\nraise \"Cannot set 'default' on a credit card without a user\"\nVersus\nraise Spree::CreditCardError, \"Cannot set 'default' on a credit card without a user\"\n```\nruby\nraise \"Cannot set 'default' on a credit card without a user\"\nraise \"The order association has been removed from InventoryUnit. The order is now determined from the shipment.\"\nraise 'perform should be implemented in a sub-class of PromotionAction'\nraise \"Attempted to call code on a Spree::Promotion. Promotions are now tied to multiple code records\"\nraise \"Attempted to call code= on a Spree::Promotion. Promotions are now tied to multiple code records\"\nraise \"unexpected match policy: #{preferred_match_policy.inspect}\"\nraise \"Implement me\"\nraise \"Adjustment is already created\"\nraise \"Adjustable does not match line item\"\nraise 'No master variant found to infer price'\nraise \"Unexpected originator type #{originator.class}\"\nraise \"Your database needs at least one completed order to render this preview\". I think what I would do is consider this Merge Request complete as is. Then open up another merge request which will re-evaulate the error classes and raised runtime exceptions.. @tvdeyen As the logger goes. I think it is an important feature to allow developers to decide where logs from solidus are sent. For the many that won't use this feature, this won't affect them. However for the few that may want to aggregate their logs, this is a simple and clean solution.\nruby\nconfig.logger = Logger.new('solidus.log')\nAs for the error reporter, I totally understand where you're coming from. I actually had coded this in the way you are speaking of. However I felt the solution fell short as far as extensibility. So extensibility was the reason I refactored it to be this way and allows extensions to be able to plugin. This also helps keep the code clean by keeping the different reporters separated.  If the community isn't in agreement on this I can switch it back. However I did feel the original solution was more complicated in the long run.. @tvdeyen As an owner and maintainer of the project you've got the final say on this. What direction would you like this to go? I'll make changes as needed. >> At least in my experience, we log everything to Rollbar and Filebeat and to a log file. This would make it easy to tie into all three of those services with little effort and as things change with new reporters/services it would be simple to reconfigure things\n\nI don't see why this is not handable by one error handler in your project.\n\nThe problem is that from our own project we can't send errors which occur within solidus.\nFor example:\nhttps://github.com/solidusio/solidus/blob/475d9db5d0291dd4aeddc58ec919988c336729bb/api/app/controllers/spree/api/checkouts_controller.rb#L26-L29\nSo within this rescue say we want to log the error to some 3rd party reporter. In order to do so, we'd need to override that method.\nThe ErrorReporter class allows us to tie into that. Whether that is by inheritance or by using the Composite pattern.. Example Usage:\nLets say we want to create a gem solidus_rollbar which reports solidus errors to rollbar.\n```ruby\nclass SolidusRollbarReporter < Spree::Core::ErrorReporter::Base\n  class << self\n    def report(error, severity, metadata)\n      Rollbar.send(rollbar_severity(severity), error, metadata)\n    end\nprivate\n\ndef rollbar_severity(severity)\n  level = Logger.const_get(severity.upcase)\n  [:debug, :info, :warning, :error, :critical, :error][level] || :error\nend\n\nend\nend\nRegister our new reporter\nSpree::Core::ErrorReporter.add_reporter(SolidusRollbarReporter)\n```\nNow all stores need to do is add solidus_rollbar to their gemfile and logs are automatically sent.\nFor HoneyBadger:\n```ruby\nclass SolidusHoneybadgerReporter < Spree::Core::ErrorReporter::Base\n  def self.report(error, severity, metadata)\n    args = metadata.slice(:error_message, :error_class, :tags, :context, :controller, :action,\n                          :parameters, :url, :backtrace)\n    Honeybadger.notify(error, args)\n  end\nend\nRegister our new reporter\nSpree::Core::ErrorReporter.add_reporter(SolidusHoneybadgerReporter)\n```\nAs for filebeat, we do a very very custom implementation where we log with a json formatted string.\n```ruby\nclass MyFilebeatReporter < Spree::Core::ErrorReporter::Base\n  def self.report(error, severity, metadata)\n    if error.respond_to?(:to_builder)\n      Filebeat.logger.send(severity, error.target!)\n    end\n  end\nend\nSpree::Core::ErrorReporter.add_reporter(MyFilebeatReporter)\n``` \nBy using the composite pattern it helps keep the logic of these different reporters separated.\nBut whichever pattern we choose I'll be happy with. I appreciate everybody's feedback, this helps a lot!. @ericsaupe That is not necessarily true. Solidus currently does pass a string rather than the exception itself into the logger. However even if that were changed it doesn't mean those errors will be reported to other services unless those services extend from the Rails logger. Not all services do that, and those that support it are not always configured to do so.. @tvdeyen I completely agree. I am more referencing rescued exceptions which won't bubble to those services. Some of those should still indeed be sent in my opinion. . @ericsaupe I think rescuing is fine, in certain cases we may want to log the exception rescued though. An example would be, \n```ruby\ndef foo\n  # Implementation\nrescue GatewayError => error\n  # Ok\n  Rails.logger.error \"Payment failed\"\n# Better\n  Rails.logger.error error\n# Track the exception\n  service.notify(error)\nend\n```\nAnd if it is an exception we want to track in a 3rd party then we add that implementation in the rescue as well. This is because the error won't bubble up, nor do we want it to. This is of course is a minority of cases however.  Most rescues we don't care about tracking that exception rescued because technically we've already handled it gracefully. So do we need to track it?\nI would say yes. Let's assume a customer calls in with an issue saying they get an error message at checkout. The error was handled gracefully and they were shown a nice flash message. However we have no way of knowing the exact error that happened. We have 1000's of logs every second flood in so searching those have become a last resort for us and sometimes we don't even know what to search for.  With our current setup we've been able to track rescued exceptions and quickly search for errors attached to those customers and quickly identify bugs (if any) or solutions.\nWe've gone a little off track though. The main issue remains on the complexity of the error reporter. What is the best pattern to use?\nSee: https://github.com/solidusio/solidus/pull/2816#issuecomment-417794859 and https://github.com/solidusio/solidus/pull/2816#pullrequestreview-149099919. @ericsaupe I think rescuing is fine, in certain cases we may want to log the exception rescued though. An example would be, \n```ruby\ndef foo\n  # Implementation\nrescue GatewayError => error\n  # Ok\n  Rails.logger.error \"Payment failed\"\n# Better\n  Rails.logger.error error\n# Track the exception\n  service.notify(error)\nend\n```\nAnd if it is an exception we want to track in a 3rd party then we add that implementation in the rescue as well. This is because the error won't bubble up, nor do we want it to. This is of course is a minority of cases however.  Most rescues we don't care about tracking that exception rescued because technically we've already handled it gracefully. So do we need to track it?\nI would say yes. Let's assume a customer calls in with an issue saying they get an error message at checkout. The error was handled gracefully and they were shown a nice flash message. However we have no way of knowing the exact error that happened. We have 1000's of logs every second flood in so searching those have become a last resort for us and sometimes we don't even know what to search for.  With our current setup we've been able to track rescued exceptions and quickly search for errors attached to those customers and quickly identify bugs (if any) or solutions.\nWe've gone a little off track though. The main issue remains on the complexity of the error reporter. What is the best pattern to use?\nSee: https://github.com/solidusio/solidus/pull/2816#issuecomment-417794859 and https://github.com/solidusio/solidus/pull/2816#pullrequestreview-149099919. @tvdeyen Thanks for input. I like your implementation. There is one thing missing which is the execution of each reporter:\nruby\ndef report(error, severity = :error, _metata = {})\n  Spree::Config.error_reporters.each do |reporter|\n    reporter.report(error, severity, metadata)\n  end\nend\nWe could maybe do something like:\n```ruby\nmodule Spree::ErrorReporter\n  def self.report(error, severity = :error, _metata = {})\n    Spree::Config.error_reporters.each do |reporter|\n      reporter.report(error, severity, metadata)\n    end\n  end\nend\nclass Spree::ErrorReporter::Logger\n  def report(error, severity, _metadata)\n    Spree::Config.logger.send(severity, error)\n  end\nend\nRegister the default reporter\nSpree::AppConfiguration\n  ...\n  attr_writer :error_reporters\n  def error_reporters\n    @error_reporters ||= [Spree::ErrorReporter::Logger.new]\n  end\nend\n```\nHowever with this implementation we might as well create a base reporter to create a contract that all reporters must uphold (implemented #report). \nI'm also debating changing ErrorReporter to just Reporter\n. @joshua-honig This is a great find. However this issue and pull request should probably be better suited for https://github.com/solidusio-contrib/solidus_stripe.  Stripe is not part of core and therefore the extension should be responsible for adding that view. Every payment method which inherits from Spree::Gateway already by default defines\ndef partial_name\n  \"gateway\"\nend\nIf a payment method defines a different partial name, it should be expected that they actually provide the correct partials.  That is just my opinion though and others may think differently.. To clarify some of these changes (each change should probably be documented in it's own commit):\nruby\nvalidates :user_id, uniqueness: { scope: [:payment_source_type, :payment_source_id] }\nThis change is due to a unique tuple key on the database. Adding the validation mirrors what is enforced at the database layer and allows activerecord to handle it.  What was a PG::UniqueViolation error becomes an ActiveRecord::RecordInvalid error.\n\nFor\nruby\nvalidate :validate_payment_source_ownership\nIt is possible that a user's wallet can have a payment source added to it which does not belong to the user.  This means a user could make transactions on a payment source that does not belong to them.. I'm really excited for this!. @tvdeyen I can't answer all but maybe a few of the issues you raised.\n\nWhy do we have the concept of adapters\n\nThis is what I actually like most about this implementation. Using the adapter pattern allows developers to not be locked into one event store.  For instance if I wanted to use Redis as in event store, I could write an adapter and plug it in to use that instead.  \nWhat I don't know, is that if I already have redis setup for my ActiveSupport caching, is it essentially accomplishing the same thing?\n\nSpree::Event.instrument does not seem like a good name for dispatching events. fire, commit, dispatch seem better candidates IMO\n\nI believe the reason instrument is used is because it mimics the rails api for issuing notifications:\nhttps://guides.rubyonrails.org/active_support_instrumentation.html#creating-custom-events\n. @tvdeyen What if I use report_key to be consistent with the controller https://github.com/solidusio/solidus/blob/master/backend/app/controllers/spree/admin/reports_controller.rb#L11 ? otherwise I think action is a good name too. the master variant is first => the master variant is *the* first. It is possible that payment.source is a Spree::Payment.\nSee: https://github.com/solidusio/solidus/blob/v2.4/backend/app/views/spree/admin/payments/show.html.erb#L16\nWe will need to account for that situation here as well:\n```ruby\njson.source do\n    ##\n    # payment.source could be a Spree::Payment. If it is then we need to call\n    # source twice.\n    # @see https://github.com/solidusio/solidus/blob/v2.4/backend/app/views/spree/admin/payments/show.html.erb#L16\n    #\n    payment_source = payment.source.is_a?(Spree::Payment) ? payment.source.source : payment.source\nif payment_source\n  json.partial!(\n    \"spree/api/payments/source_views/#{payment.payment_method.partial_name}\",\n    payment_source: payment_source\n  )\nelse\n  json.nil!\nend\n\nend\n```\nWhen I get a chance I'll add this to the PR. May be too high of a log level. Not a fan of this. I figured it would create backward compatibility as well as forward compatibility by allowing both options without clients needing to adjust. The token never gets saved to the database and has no need to.  It is encrypted with a secret, (By default Rails.application.secret_key_base). If the token fails to decrypt it is unauthentic or has been tampered with.. Correct\nsee: https://www.rubydoc.info/github/plataformatec/devise/Devise/Controllers/Helpers:after_sign_in_path_for\nWhen a user has logged in through the Devise controller this method is called.. Probably not, I wondered that myself. Probably not, I wondered that myself. I think this should be a decision for the developers. Some developers prefer to keep their logs aggregated. However I think it would be ok to default it to Rails.logger instead of creating a new logger by default. Then if devs want to aggregate their logs:\nruby\nconfig.logger = Logger.new('logs/solidus.log'). We need to be careful not to build this with one error reporter in mind.  The implementation does allow overriding if needed. \nruby\nclass MyCustomerHandler < Spree::Core::ErrorHandler::Base; end\n.\n.\n.\nconfig.error_handler_class = MyCustomerHandler\nAlso:\n```ruby\nErrorHandler.report(\"ma mia\")\nand\nerror = StandardError.new(\"ma mia\")\nErrorHandler.report(error)\n``\nWill have the same result when it comes to theLogger` class\nThere is no need to explicitly perform\nruby\nmessage = error.respond_to?(:message) ? error.message : error\nIn summary, I think we should start simple for now.. btw, thank you for your input. This is great stuff. Minor suggestion would be to add a comment as to why this is locked with a link to the issue that needs to be resolved until it can be relaxed again.. Yeah, I always hear mixed opinions on NotImplementedError and NoMethodError. Another opinion is stated here http://chrisstump.online/2016/03/23/stop-abusing-notimplementederror/.\nI personally am fine with any of those solutions. Sounds good, I like that better. I'm not sure if this method will remain after the current suggested changes but I'll definitely use responds_to? if it stays. I would prefer validates :user, presence: true. Not a big deal though. It may be worth adding a custom message here. I found the default message on this is going to be User id has already been taken. That message doesn't really denote that the violation is due to the tuple key. I'm guessing the reasoning for this is to mimic what happens in the Spree::Wallet#add method? I'm a fan prepending validation methods with validate so you know the purpose of that method is to validate and if called will add to the object errors. validate_payment_source_class. Would it be better to use prefix rather than suffix? I think out the gate we should be more descriptive on topics to leave room for growth. For example: spree.orders.finalized, spree.reimbursement.created. This way we have more of a hierarchical pattern when naming topics.. This is more of a question and less of a request. Would it be worth implementing more of an interface or strategy pattern? So instead of defining a module, have a base abstract class which all adapters should inherit from an therefore expected to implement instrument, subscribe, etc.\nI know I'm splitting hairs here but I love to learn. I think we should have a constant for each event topic.\n```ruby\nSpree::EventTopics::ORDER_FINALIZE\nor\nSpree::EventTopics::Order::FINALIZE\n``. I just read thatRails` uses the suffix convention which I find interesting.\nSee: https://guides.rubyonrails.org/active_support_instrumentation.html#creating-custom-events\n\nYou should follow Rails conventions when defining your own events. The format is: event.library. If your application is sending Tweets, you should create an event named tweet.twitter.\n\nI'm not a fan of it, but probably should stick to rails convention. I think you're right, we don't lose much by not having constants. However thinking from an extension stand point it would be easier to manage if constants were available.\nLets say I have many subscribers in my codebase defined with the static string 'order_finalize' and one day down the road that topic name changes. When I run bundle update, all of sudden my code breaks.  If I were to define my subscribers with the constant, running bundle update wouldn't break a thing. In general I always think it's best to avoid magic values when possible. I think this is great, I say splitting hairs because they all accomplish the same exact thing. Some are just more strictly enforced than others. I agree, I've come to a similar conclusion. It would make more sense for the extension that may create many subscribers to define the constant themselves at their discretion since they'd be the ones repeating that string throughout the codebase. ",
    "mbj": "Even when I was not asked for it I did a small code only pass on this. With some style flags that should when addressed not change semantics but represent them a bit \"prettier\".\n. I wounder if commit: https://github.com/athal7/solidus/commit/c5d72d6632a838a3d2d741d8bbb609e558ab39b5 would be better squashed into one of its parent commits.\nThis would reduce the noise for reviewers. Why introduce a style problem to fix it, both operations cancel each other out.\n. @athal7 You are referencing: https://github.com/solidusio/solidus/pull/467#issuecomment-152281968 in particular? If so. +1.\n. To all reviewers this is ready for review.\n. @jordan-brough How do you feel adding the FK / check constraint under postgresql by default? \n. > @mbj should we add an update for spree_shipments like you have for spree_line_items?\nLets keep this iteration as small as possible. Conceptually yes.\nWe only optimized /order/populate so far, all our optimizations can in theory also be applied to the shipments / inventory stuff. It suffers from the same design \"smells\". But for now lets focus on upstreaming what was proved to work in our case.\n\nI'm very  on adding the FK constraint. We have that FK in our own DB. We can use the new Rails 4.2 add_foreign_key support for that and get it on postgres and mysql right?\n\nYes you can. We have full FKs in our app active already and it catches tons of bugs (we have fixes for in our fork).\nI'd recommend to add FKs for everything you touch right now. Or even do a big pass adding FKs in postgresql specific syntax. Mostly because it catches so much. I'll look into upstreaming our FK generation / validation code. But not this iteration.\n. > The check constraint seems cool also, though I'm hesitant to start introducing too much db-specific stuff. Though this is just safety-check stuff and not behavioral stuff. Googling around it looks like if we wanted it for mysql also we'd have to add that via a trigger? Which I think has other implications we might not want to get into.\nI've no idea for MySQL. The problem with polymorphic associations is the low degree of DB side validation, this check constraint puts a bit of back-pressure in. For now I think the PostgreSQL specific check constraint is worth it. Especially as code bugs exposed in PostgreSQL will have a positive effect on MySQL installations even when the constraint there does not exist.\nLongterm I think we can likely untangle the polymorphic associations, but thats a future point to discuss.\n. > If we're repairing the order id I'm not sure why we wouldn't do that at the same time? (Even if you didn't do that originally.) Any missing data there is going to cause the null: false constraint we're trying to add here to fail. That's the only other type of adjustment in stock spree I believe.\nBecause I like to do one thing at a time, at this point. The patch as is was tested against our production system. Before we add more constraints (for example the FK on shipments) we probably want to check all data generation call sides for possible violations.\nI prefer 2 PRs over one. And I prefer even more to upstream what I have right now instead of delaying one (this) PR to add stuff that was not done yet.\n. I just activated the postgresql check constraint on the polymorphic association keys. Seems solidus has call sides that violate it. Investigating.\n. > @mbj Totally agree with you in general on doing one thing at a time. But are we on the same page here? We're adding null: false to spree_adjustments.order_id in this migration and I'm talking about repairing any spree_adjustments.order_id nulls for spree_adjustments.adjustable_type == 'Spree::Shipment' (just as we've done for line items). If we don't do that then the null: false in this migration could fail, which would not be a good experience for people trying to upgrade.\nI think I missed your point. In our case the order_id was fully reconstructible from the line items already. If you have bad data that is only reconstructible by shipments we need to add your statement too.\nSorry for the noise. BTW the postgresql check constraint on the adjustable_id / order_id found other violations. We likely have a patch for these. I hope this is a perfect example on why we want even postgresql specific checks in the code base. That will expose bugs that when fixed even will benefit MySQL users.\n. OT: The amount of entropy our databases show compared cross spree / solidus installations shows the big problems the code base has / had in the past / currently.\nI really hope we can primarily backfill missing validations and reduce the entropy and do not think about large features. Stabilizing the heck out of this thing before even doing \"equivalent sematics but cleaner code\" refactoring. Its much easier to improve the implementation of a consistent system.\n. > Longterm I think we can likely untangle the polymorphic associations\n\n+10000 I'd be really happy to see that happen\n\nWe did some experiments with promising results a while back on performance optimization passes. But it turns out the memory scope thing we developed was the better mid-term choice that also creates the infrastructure we need to do the reduction of polymorphic associations.\nWhen this PR got accepted, I can look into the memory scope one that fixes a lot of N * (N+1) instances in the order populator.\n. > I like this change to all_adjustments, and echo @jordan-brough with sentiments that there is much more to improve here, but this is a great first step.\nYes this is only a first step.\n. > To be clear: I think that's great and am not opposed to it at all. Like I said before, these are just additional safety checks, not behavioral differences, so that seems good to me. I'm mostly saying \"we haven't done this before so let's make sure everyone is on board\" and \"maybe we should also do it for mysql\". I don't think we should for mysql since it would involve triggers. @gmacdougall or @jhawthorn any thoughts on that stuff?\nI'm fine with that approach, but I'd love to not delay this PR to wait on a MySQL solution for weeks.\n. > @mbj This is looking great to me! If you can move the foreign key addition up out of the postgres if and use add_foreign_key for it that would be great.\nAFAIK add_foreign_key is not supported by the rails version we are running right now. I'l ldouble check this. This info is from our spree fork, not solidus one. I'm still building up the \"mental map\" for the solidus state of the project. This will take some time, but when I'm done I'll proactively use the least powerful primitive that does the job. (add_forkeign_key is less powerful than a generic SQL DML string).\n\nDo you want to move the polymorphic constraint into a separate PR or tackle it now? (Either way sounds great to me.)\n\nChecking our fork in a sec for fixes for the violating call sides. If they exist I'll include them into this PR, if not I'll extract the bug exposing check in a separate PR.\n. > Yeah, Solidus is on Rails 4.2, which supports it.\nK, thx on pointing me on this. If I can keep working on Solidus (clients decision, not mine) its likely the number of those pointers will reduce to zero as I internalize the state of this project over time.\n. > Yeah, Solidus is on Rails 4.2, which supports it. We've just recently begun making use of it, actually, thanks to @BenMorganIO: 8394c3c#diff-61cdaf6ae78f46af1b88b4cbb3614770R3\nActually there are reasons I cannot use this commit as a reference:\nhttps://github.com/solidusio/solidus/commit/8394c3c8ee4ad426a39155c8642e5c525096803d#diff-61cdaf6ae78f46af1b88b4cbb3614770R3\n- Rails generates indeterministic FK identifiers. I highly recommend to add name: $owner_table_$colum to the options. The default is something useles like fk_rails_$randomhex that makes comparing databases cross installations complex.\n- We know the AR layer handles destroys of adjacent records. Unless we remove this responsibility the actions set for on_update and on_delete are to permissive and do not mirror a case where we actually intentionally want the DB to do these cascading actions.\nI did not follow this commit for the reasons above. Should I add an issue to fix the above concerns I have with the reference commit?\nThis is not ready for review yet, as there are still invariant violating call sides poping up.\n. > Yes -- I do not want us to use cascade here. See our discussion here about cascade. We've decided that we don't want cascade anywhere since rails+sqlite doesn't support foreign keys at all yet (and we say we support sqlite).\nI went with explicit :restrict for now. This is most intention revealing. \n. @jordan-brough Ready for next pass.\nI needed to do some more cycles to catch all constraint violating call sides. All of them where hidden in specs and only manifest on specific sequences of execution.\n. > Thanks for sticking with this long discussion.\nThis is expected 1rst PR cost to pay when syncing with another team. I'd be more worried / concerned when this discussion had NOT happen.\n. You need more CI resources: Queued 16:14 waiting for builds to finish\n. I see this constantly. When both @dkubb and me are working at full speed at the current resource level we'd cause much huger build queues that slow down everyone.\nIs someone paying for CircleCI right now?\n. Each separate commit should pass the CI. This can be archieved with: Squashing the commit into one (not the best option). Or:\nPushing each commit separately to trigger build hooks. A PR example where we did that is here: https://github.com/MountainRoseHerbs/spree/pull/80 each of the 93 commits was pushed separately and passes the build.\nHaving each build green is also great for bisecting / code archeology / rebasing.\n. CircleCI is to my experience the better CI. But just lacks the matrix.\nAs I said in #466 I think we can expand the build-ci.rb script we currently use to trigger each project also under a different DB environment variable. Simulating the matrix feature.\nAdditional passes could be made to report each sub-project/DB variable combination build in separate via the github API.\nIf I get work authorized by the client, I could take this one.\n. > I do not share this opinion at all, but the rest of the team seems to like it.\nCurious. Can you expand your thoughts. As I do not share it (right now) there might be some news in your view.\n. > I like travis because it doesn't seem to have the same 4-container limit,\nI run with much more containers at work. I think you mean the 4 container \"free\" limit? A project at the intentions / goals / business-value of Solidus should not have to use the OSS tier.\n. I'm fine with any solution as long the bottleneck is solved.\n. > I've personally had troubles with Travis' stability, but not opposed to giving it another shot.\nsame. Significant problems. Especially determinism. Lots of VM noise killing timing measurements. In consistent host envs etc all introducing entropy to create non-repeatable builds.\nAlso the UI was utterly slow the moment I last time tried Travis. And yeah, I'd also be happy to try it out.\n. A question:\n- Why does sorting have to be in this class? Its a UI issue on what property they should be sorted. The sorting might even depend on data that is not available inside the estimator. Could depend on the order etc.\nA suggestion:\nIn my opinion passing class singletons as configuration primitive is wrong. While all class instances are subjected to honor the LSP (Liskov substitution Principle) the constructors are intentionally not covered by this. The configuration interface forces all constructors to ONLY depend on the shipping rates, no way to do real customization.\nWhat about to change this to expect a configuration object that responds to #call(rates) the object that does the sorting could than be initialized with any state we cannot even think about yet. And the call side inside the estimator does not need to care about providing any state.\nIf you think my question above is actually answered via: Only because of historical preference, we can even reduce the responsibilities of the estimator and place the sorting somewhere else, more close to the UI rendering.\n. > I would strongly recommend against designing interfaces that are more extensible than they need to be \"just in case\". Satisfy the use case you know about and avoid prematurely making the code more complex than you need it.\nAnd in case you need more complex state inside the sorter, you can wrap it up in an instance (that responds to #call(rates). And store it in the config location - That was my whole point initially.\n. A contract that requires 2 API calls for no gain is more complex than one that requires one.\n. Yes, use the least powerful primitive that does the job.\n. > @mbj btw I'd love to see a PR for moving the sorting elsewhere if you (or anyone) were up for it.\nI do not have any authorized budget to work on Solidus currently, sorry. My comments here are on my private time.\n. Curious why this does not caused warnings. I suggest to review the build setup to at least enable warnings.\n. No specs?\n. @mamhoff This project currently does not automatically verify code changes are paired with covering specs. While people seem to review code changes, the reviews are naturally (as we are all humans) of varying quality. \nHaving even an imperfect automated system in place that verifies the semantic change coverage will trigger the humans into performing a much higher quality review, as such systems never have a bad day.\nWhen we have our tax hangout, I might be able to convince you to put such a system in-place.\n. The whole comment section does not apply to Solidus as MySQL is officially supported. I'll kill it.\n. Yes because especially https://github.com/solidusio/solidus/commit/30ae28f2e24001214737130835a50d8f9fb7cdca only fixes data coming into the system. But will not fix missing data already in the system. And the data fix in https://github.com/solidusio/solidus/commit/b8b5e55661e2560437fb3b322ce284283e243dd8 is a point in time.\nBetween a spree/solidus user applied the earlier migrations and the moment this one (with a schema improvement) gets applied new bad data might have entered the system, via an unknown vector, or via the system running the old code while the new one is not deployed yet. Update at once scenario.\nI'd not do any assumption in what state the DB is and always be idempotent when possible.\nAt least in our case we needed to back-fill order_id values, before creating the FK. Our system has massive amount of requests so this time based problems arise.\n. Do you happen to know the MySQL syntax for the equivalent? I never used MySQL in my career.\n. All I know is: The postgresql one does not work ;)\n. Fixed.\n. No. I just miss mysql skills. I'll kill the branching and only use the raw SQL.\n. Sure. Will do. I just checked our internal migration and it also had this clause. It was dropped for spree upstreaming for some reason\n. > Can we add and order_id is null to this query though? That reduces the time for our data set on my dev box in postgres from ~60s to < 1s, since most of the data is good and we have an index on spree_adjustments.order_id.\nI did that.\n. Yes. BTW I'd ping you in case this is ready for a next pass. No need to waste your time that does not pass CI yet.\n. This is likely because you where reviewing while I was still editing.\nNow all 3 update statements are constrainted to only hit the orders where order_id IS NULL.\n. > This is failing for me under mysql\nCan you show me how it failed?\n\n(which our CircleCI unfortunately doesn't test)\n\nLets fix it. We already use multiple containers, I could easily change the build-ci.rb script to run each projects also against a different DB environment variable.\nThis would double the CI times, or in case you double containers would be at free (time) cost.\nI know this is not ideal, but an improvement.\n. And also we could add per subproject / DB combination status reports to the github PR via its API. I did that once for a client. Dunno if we have the time resources to do it here but still an option.\n. So if you double CI containers (or state a twice as long build is okay), I'd be fine to run the build-ci.rb improvement to include MySQL as a followup on this PR (assumption my client wants me contributing here, just trying to build up nice TODOs).\n. > Splitting the query into three statements fixes the issue.\nMySQL still amazes me. Will do.\n. Actually I think the adapter should not. As he'd had to implement a full SQL parser to determine the role of a ; character.\nLikely its a protocol level limitation by MySQL.\n. You should use Hash#fetch here when you know the key is suposed to be present. It makes no sense to use Hash#[] that will in the error case return nil hiding the \"true\" source of the error when trying to call #permission_sets on nil.\n. Can we use explicit parens here like in the rest of the code?\n. I'm pretty sure that this line is redundant. As Set#-= (or Array#-=) will likely return the receiver value.\n. And if its not redundant it should also use Hash#fetch ;)\n. There is no call side for the DummyAbility that passes in a user. Hence I'd argue to drop the argument altogether. And thus you could drop the full #initialize method.\n. Instead of passing the block literally you should be able to use the shorter (and also AST wise less complex form):\nstub_authorization!(&block)\nWhich makes it more clear the captured block is forwarded unmodified.\n. You consistently use single quotes in the literal expectations but not in the description? Can we sync these up?\n. > in this case, however, roles[x] can't ever be nil as it has a default value.\nIts not a plain hash? than ignore all my noise here.\n. I wounder if we should move the array literal to a (deep frozen) constant of type Set this would be more intention revealing. Set not because of performance, but to use a datastructure that does not allow duplicates, that would not make any sense for its used intention.\nPAYED_STATES = IceNine.deep_freeze(%w[paid credit_owed].to_set)\nDeep frozen to prevent any global state mutation by accident. \n. My argument is: Entropy in the system should be reduced. The less entropy on ANY level: Semantics, Syntax, Data the better.\nWill followup in a separate discussion.\n. I love global fixes.\n. Sets do not support duplicates. This state list is not supposed to contain duplicates.\nWhy use a data-structure that supports something that should not happen?\n. Cool. If I'd PR a global change now: Do I need to wait for a core meeting till that can be merged?\n. > My preference would be we let things settle for a few more days/weeks before we global change stuff.\nSo why do you accept any PRs right now, before this happened? Just want to understand the global plan here. Right now it does seem quite arbitrary, but thats from someone who does not know the global plan.\n. The problem is all that \"seems\" in the argument.\nYou have too options:\n- Pull the Spree stuff you need, but nothing else. Than fixes.\n- Fix all stuff you can and intermix with Spree stuff.\nBut what happens here seems arbitrary.\nI do not see the reason why all the other, non spree cherry-pick commits are okay, but mine would not be.\n. I'd prefer to ship the \"save\" version by default. People with performance issues typically know that in advance and test / optimize migrations by hand before \"blindly\" applying the stock version. At least we do.\n. If you remove a unique index, and effectively recreate it: There is a time frame violations can be inserted. By default this risk should not be taken.\n. Hence a transaction should exist. By default.\n. Also there is no spec that verifies the shipping_rate_sorter_class can be configured externally. This code could just hardcode the default class and no spec would notice.\n. This is leaking a global mutation into later specs.\n. This is leaking a global mutation into later specs.\n. k. Thx for confirming this.\n. ",
    "olistik": "@cbrunsdon fair enough, I assumed a specific context for the reader of the README.md: \"I'm on my development environment and I have just done gem install rails\" :-)\n. @cbrunsdon my OCD is kicking in :-D\nShouldn't we add bundle exec when spawning the rails server here https://github.com/solidusio/solidus/blob/master/README.md#sandbox then?\n. ",
    "metade": "Good point - I'll add a migration to do that.\nLooks like there are some random spec failures - don't think they're my fault!\n. All good points which I've now addressed!\n. @jhawthorn I'll give that a go to see how it feels.\n. I think that Shipment#address gives the illusion that we might be able to support shipping to different addresses but in practice this isn't the case.\nFor example, with an order that has 2 shipments with different addresses, if you edit the Order#ship_address how do you track which of the 2 Shipment#address should also be changed? \nOn top of that, there appear to be lots of bugs (e.g. updating an order ship address and #1141) that indicate that Shipment#address isn't being used consistently.\nSo this is why I feel it's redundant and can be removed.\nWe could think of an approach that supports shipments to multiple locations (e.g. based on @alexstoick's suggestion), but we should probably wait until someone wants to support that and implement it properly.\nBut I agree that it's not a decision that should be taken lightly and we should consult the community to see if anyone is actually shipping to multiple destinations.\n. I just spoke to @jordan-brough about this, and we agreed that instead of removing the spee_shipments.address_id column we should rename it.\nWhilst we do want to support the feature in the future there may be stores using the column in unexpected ways (e.g. in SQL for analytics etc, or potentially updating the column).\nRenaming the column would mean that these stores would realise that they need to change their application when upgrading, and we'd still be able to support the feature in the future.\nHowever, we shouldn't attempt to implement multiple ship addresses at this point.\nInstead we should wait until someone has this requirement and can design, implement and test the feature properly within their own store and then upstream the work into core when it's been tried and tested.\nLet me know if you agree with this approach and I'll rename the column to spree_shipments.address_override_id.\n. I like the idea of deprecated_address_id as it makes the intention clear - we no longer use this column.\nWhen we come back to implement shipments to multiple addresses this can potentially be renamed appropriately - but it will depend on the implementation.\nUnless there are any objections, I'll add a migration to do this.\n. I've added the migration (https://github.com/solidusio/solidus/pull/1138/commits/1678847abd2b71613b7157a61bbbe5d12f213df3) and rebased from master.\n. I've removed the extra references to Spree::Shipment#address that @jordan-brough picked up, and added an entry to the changelog as suggested by @mamhoff.\n. This is pretty much the old Spree::PromotionHandler::Cart#sale_promotions method - I'm sure it could be written better but given it's for a migration I thought it was best to just copy it across as it was.\n. I'm considering removing the scope and just calling where(apply_automatically: true) from Spree::PromotionHandler::Cart#sale_promotions as it's the only place that actually cares about it. \n. ",
    "peterberkenbosch": ":+1: Have some issues with tax included prices and whole order promotions as well. The promotion discount has to be taken into account when calculating tax as well. With the tax on line_items, and the promotions on the order this is currently very hard to do correctly.\n\nIn this sample there is a 10% discount on orders > $100. The tax amount should be calculated after promotions, making the tax amount $24.98 and not $27.75\nGod I hate taxes :D\n. @mamhoff Yeah, I solved it in this instance with re-adjusting the tax amount. Also with non-vat orders, calculating the promotion on the pre-tax-amount on the order. The case you describe with the different taxes per product are nearly impossible indeed.\n. thanks guys, I have not worked it out yet. Planning on starting with that tonight. More to come!\n. So, it looks like the main issue with the previous implementation is that there is no way to remove the line item added by the promotion when the promotion is no longer eligible. This is mainly an issue when a user adds the same product that will be added by the promotion. Otherwise we could just remove all the line items from the order with the same variant as in the promotion action. \nWe could iterate through the promotions, when not eligible, fetch the variant_ids when the the action type is the Spree::Promotion::Actions::CreateLineItems and remove the variants found from the order (with the correct quantity so the manual added items are not removed).\nCurrently no insight yet in how this will compromise the performance or complexity though. Other idea that might be something to experiment with, is to add an association to the line item with the promotion, or an 'added-by' field that will default to the current_user. We could even use that to track down admin added line items. However, not that keen on adding a polymorph association, it might be to complex. \nI will continue with the first approach experiment, to see if I can just make it work. Then I will take a look at performce.\n@dhonig @gmacdougall @jordan-brough wdyt?\n. Something like this: https://github.com/solidusio/solidus/blob/master/core/app/models/spree/promotion_handler/coupon.rb#L100\nbtw @jordan-brough this is currently still in master. That well hidden reference to the removed CreateLineItems action is still present :) \n. Right, something like that looks like a good solution, missed that particular implementation. Good ref.\u00a0\n--\u00a0\nPeter Berkenbosch\nGSM: (+31) (0) 64 84 61 653\nEmail: peter@pero-ict.nl\nSkype: peter.berkenbosch\nTwitter:\u00a0@pberkenbosch\u00a0\nWeb:\u00a0www.pero-ict.nl\nOn Thu, Nov 12, 2015 at 6:38 PM, Jordan Brough notifications@github.com\nwrote:\n\n\nadd an association to the line item with the promotion\nI think that could be a great idea.  Something like the join table on the CreateQuantityAdjustments  promotion action right?  I haven't thought it through in detail but recording the data in a discrete way seems like the easiest to reason about. @adammathys crafted that one so maybe he has some insights on it?\nThat well hidden reference to the removed CreateLineItems action is still present :) \nHah, nice find! I guess that one slipped past me. :) We should remove that...  Thanks.\nReply to this email directly or view it on GitHub:\nhttps://github.com/solidusio/solidus/issues/492#issuecomment-156178453\n. @alepore I like the conventions! \n. @jhawthorn do we need to revisit this one? \n. see #492, the promotion action that added line items was removed here. Working on getting this back in here. \n. :-1: I'm all for keeping standard rails conventions.\n. :tada: :+1: \n. This is by design @connecticus //cc @BenMorganIO properties are mapped 1:1 to products and just key:value pairs on the product. Option Types are the place to use those currently.\n. I like the suggestion @jordan-brough is making in #600 wdyt @jhawthorn?\n. :+1: Nice @mamhoff \n. Nice! :+1: \n. We need that here IMHO! (non creditcard stuff). \n. I see a Wallet as an abstraction for the payment sources, and ideally very loosely coupled with any state event change on Order. I have some comments inline as well that reflect that opinion. \n\n\nLove to discuss this further and move forward :)\n. Also, this PR is pointing to master right now. Should it be towards this branch? solidusio:jordan/non-credit-card-payment-sources-base\n. Got it @jordan-brough, I missed the add commit with the Spree::Wallet namespace here. Perfect!\n. wdyt @cbrunsdon @jhawthorn \n. Thanks @cbrunsdon! @jhawthorn wdyt? :)\n. @jordan-brough @mamhoff checking this out now, what's the status? Would love to help out where I can. I have some real life samples to work with as well. \n. Thanks @jordan-brough, will put some time in this the next few days.\n. @jordan-brough should we merge in (or rebase) master on this PR? The dependent PR's are merged in, would love to see a green CI build here as well :) \n. not sure either how you could explicitly test this, I think this change should just keep the existing specs green. I cherry-picked your commit in a local branch based of master and the specs are green now. Will submit a new PR with your commit in a sec. \n. @jrochkind do you mind updating this PR? I can do it as well, just let me know :) Thanks!\n. sure, on it @jrochkind \n. @jrochkind could you take a look as well? I have a bunch of merge conflicts that I'm not sure on how to solve them. //cc @jordan-brough\n. thanks @jrochkind, other solution could be to just close this and I will open up a new one with this behaviour. Does that help you? Did not want to hijack your PR.\n. Thanks @jrochkind!! @jhawthorn ready to go now //cc @jordan-brough \n. @Murph33 would you mind rebasing this one on master please? This should be okay to merge then @jhawthorn \n. Great! Thanks @Murph33! @jhawthorn ready to merge this from my point of view \ud83d\udc4d \n. @AlessioRocco could you maybe rebase this and update the eligible? method to satisfy hound? Thanks!\n. @mamhoff any change you could rebase this PR and update the CHANGELOG? Thanks!\n. any updates here? //cc @mamhoff @jhawthorn @SebAshton \n. cool! Thanks for updating @kennyadsl \n. correct me if I'm wrong @jhawthorn but the idea is to have those setting in the spree.rb config setup, to keep them static and not hitting the database. This might change with the multi store ideas though.\n. can we merge this? @jhawthorn @cbrunsdon \n. This makes a lot of sense, curious why we do not have a payment#refunded state though. \n. \ud83d\udcaf\n. perfect @jhawthorn, let me know @gevann if you need some help there.\n. \ud83d\udc4d \n. Close this in favour of #1707. Thanks @chrisradford. @DanielePalombo this needs a rebase with master.\n. Was about to mention that Daniele after I read the rest of this thread! \ud83d\udc4d \n. I think it's the ImageMagick -> Paperclip. That has been proven to be a nightmare on windows most of the times. Has been a while that I've seen these problems though.\n. @tvdeyen Fixed the conflict, when CI is green this is mergeable. . And it's not :), failing on the introduced spec even. Will investigate and fix.. So, in #1954 we deprecated Spree::Order#assign_default_addresses! and introduced Order.new.assign_default_user_addresses, I have updated this PR accordingly.. @tvdeyen we are all green here! . Interesting.. locally I have no failures but it's failing on CircleCI. @jhawthorn if you have a spare minute could you take a look what I mis here?\n. \ud83d\udc4d \n. Some background information: http://guides.rubyonrails.org/association_basics.html#bi-directional-associations\n. @gmacdougall @jhawthorn refactored a bunch! Ready for some more feedback. Thanks!\n. I think the first screenshot is related to #1472. Will make this happen here and refer to the issue.\n. yes @bbuchalter, rebase is definitely in order here, will be doing that when all lights are green :) Changelog is incoming as well.\n. This has been updated and rebased. Ready for merge when approved. //cc @gmacdougall @jhawthorn \n. done\n. @gmacdougall damn, you're right! It's missing the counter balance entries! \n. https://github.com/solidusio/solidus/pull/1513/commits/ec40ee8f1fdc2ec7f5152db9d6db1b586daebf7b\nHave to rebase the last one in there still. Waiting for last round of feedback\n. @gmacdougall will provide an improved version for this, so closing this one now.\n. public API does not change right? This cleans up so nicely :) I really like it. That being said, I think these kind of changes should be introduced very defensively.\n. @gevann this needs a rebase with master. \n. LGTM! \ud83d\udc4d \n. \ud83d\udc4d \n. \ud83d\udc4d \n. I actually like the 0 amount better then no adjustment at all, there is a difference accounting-wise between 0 amount tax and no tax. \n. \ud83d\udc4d \n. @magnusvk can you remember the use case for having the temporary_credit_card attr? Working on #1414 and I do not see why we should still need it.\n. yes, agree that we should have an active configuration option there. Right now only creditcards that have a profile are stored in the wallet. Might be good to add that in #1414 I guess.. closing this in favour of work being done here: #2965. Nice!!!. There is a better option I think, we can disable this for the specs but still have it for the system. Ran into this some time ago as well: https://github.com/StemboltHQ/solidus_affirm/pull/6/commits/106096c6a57d575b9a4a41c02838444e18a6a439. \ud83d\udc4d  . This is awesome!. Nice @tvdeyen! Static sites are sooooo fast too . Work is being done here right now. https://github.com/solidusio/solidus/pull/2855 . @dhonig my experience is that adjustments can clutter the reporting and exact intent of said adjustment when it's used for refunds. Agree 100% on the remark about new terrain. This needs some proper thought and discussion. I do like the first look of it though! . what are your thoughts about zero-ing out the order instead of rendering an error message?. After some more thought, I do think it\u2019s actually a better way to raise an exception for something that should not happen in the first place. This leaves any \"magic\" zero value orders out too. . True. Still WIP.\nOn 28 Jan 2019, 09:55 +0100, Andrea Longhi notifications@github.com, wrote:\n\n@peterberkenbosch thank you for this PR \ud83d\udc4f\nCan you confirm this PR is ready for review? I see in the description there's an unchecked checkbox, and also this comment suggests me that it's not... am I right?\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly, view it on GitHub, or mute the thread.\n. Thanks @kennyadsl, \n\nMy approach was to have the most minimal support needed to have offsite payment providers. We could for sure explore a callback controller base class that will lighten the load for those implementations for sure. Will post some more code here soonish with that to discuss further.. :shipit:  \ud83c\udf89 . @elia the last 2 commits could be rebased / rewritten? Not sure what snapshot means :). This is probably just on Sqlite3, but when I use this with the sandbox app there is (sometimes) a db locking problem when uploading multiple images at once\n```\nActiveRecord::StatementInvalid (SQLite3::BusyException: database is locked: INSERT INTO \"active_storage_blobs\" (\"key\", \"filename\", \"content_type\", \"metadata\", \"byte_size\", \"checksum\", \"created_at\") VALUES (?, ?, ?, ?, ?, ?, ?)):\n  \u21b3 /Users/peterberkenbosch/code/nebulab/solidus/backend/app/controllers/spree/admin/resource_controller.rb:57\n  Spree::Taxon Load (0.3ms)  SELECT \"spree_taxons\". FROM \"spree_taxons\" INNER JOIN \"spree_products_taxons\" ON \"spree_taxons\".\"id\" = \"spree_products_taxons\".\"taxon_id\" WHERE \"spree_products_taxons\".\"product_id\" = ?  [[\"product_id\", 7]]\n  \u21b3 /Users/peterberkenbosch/code/nebulab/solidus/core/app/models/spree/product.rb:384\n  Spree::Taxon Load (0.3ms)  SELECT \"spree_taxons\". FROM \"spree_taxons\" WHERE \"spree_taxons\".\"lft\" <= 9 AND \"spree_taxons\".\"rgt\" >= 10 ORDER BY \"spree_taxons\".\"lft\" ASC\n\u21b3 /Users/peterberkenbosch/code/nebulab/solidus/core/app/models/spree/product.rb:384\n```\n\n. it was used to have a choice to have the payment source saved or not. It has since then been unused indeed. Current wip around this attribute is being done here: https://github.com/solidusio/solidus/pull/2965. Good call @kennyadsl, I totally agree! Thanks. Will update this PR asap. sweet! I was just working on this. Trying to figure out how to \"hack\" the generated Gemfile. This will work! . > This has been fixed in Rails (I think just in master for now).\n\nWhat do you think about this solution made on factory_bot_rails using gsub_file instead of sed?\nruby\ngsub_file \"Gemfile\", /^gem 'sqlite3'$/, 'gem \"sqlite3\", \"~> 1.3.6\"'\nI think it's a bit more \"Rails friendly\".\n\nThis is not working in sandbox.sh since it's a shell script, not a ruby file. . Yes, I agree with @tvdeyen here. This will also open the possibility to add sources on other places. For example, adding bitcoin in \"my account\". Also.. naming things is hard :)\n. And with that name change, the method could be named just build I think.\n. \ud83d\udc4d \n. should == instead of >= be sufficient? If you refunded more then the amount paid there are some other issues going on IMHO. \n. Not sure yet, mostly here to solve the missing translation error we got in the model when the validation fails.\n. I like that! More clear what the intention is. On it.\n. yes.\n. we do need an after_create though to make sure we have the correct opening entry.\n. that is what happens here, did not use credit method though, since there is already a credit method here. \n. yes, way better.. updated!\n. improved readability for sure! Updated.\n. Yes, wanted to have something that was easily testable though. Looking into options here.\n. yup. WIP atm since I'm looking at how to best make that migration happen.\n. Updated the migration using a rake task and added the spec for that rake task.\n. Thanks! I can confirm that say will indeed be silent with VERBOSE=false\n. Yes, for sure! Updated that!\n. Yes, that and with documentation on the method. Magic vs Convenience, I will make sure to get the documentation on the method done first. :)\n. good catch! This is actually not needed like this at all.\n. I wanted to have a way to properly spec it, could not find a better way to do this. \n. small typo. should be Spree::Zone.for_address\n. the last method is returning !false hence the state machine continues. It's not raising an error mind you. It's just adding a model validation. if we were to raise an Exception here we would have stopped the state machine.. I'm not sure, I think added the model validation presents it cleanly to the end user. When raising an exception, when not caught somewhere, we end up with 500 screens. \nOn the other hand, when there is some sort of error tracking in place, we do send a quick and pressing message that something is not going as expected when we do raise an exception.. errors.add is not returning nil it returns an Array with error messages. that is correct, the redirect_url needs a payment method, we could use a safe operator here to just return nil instead of throwing an error though. . ",
    "dkubb": "\nWe have full FKs in our app active already and it catches tons of bugs (we have fixes for in our fork).\n\nHow we did this is we temporarily added immigrant as a gem dependency and used it to generate a migration that added the foreign keys. This allowed us to backfill missing FK's for all declared associations. We could create a future PR that uses the rails 4.2 add_foreign_key method that basically does the same thing.\n. There is also private_class_method which imho is cleaner than private methods in a singleton class, and also easier for some tooling to work with.\n. >  But @mbj can you help me understand the practical difference between \"provide an object that responds to call and accepts x and returns y\" versus \"provide a class that can be initialized with x and responds to foo which returns y\"?\nIMHO in both of these cases providing a class for sorting and selecting is overkill. In general I would suggest using the simplest possible interface that satisfies the use cases. In both of these cases sorting and selecting could be easily handled by a Proc object that responds to #call.\nI would strongly recommend against designing interfaces that are more extensible than they need to be \"just in case\". Satisfy the use case you know about and avoid prematurely making the code more complex than you need it.\n. > The actual contract we're asking for right now for these properties is:\n\n\nProvide an object that responds to new(rates) and returns an object that responds to sort\n\n\nYou're confusing implementation with the use case. The contract is not Provide an object that responds to new(rates) and returns an object that responds to sort .. the contract is \u201csort rates by some criteria\u201d and \u201cselect rates by some criteria\". That's all you need to do to solve the problem -- of course you can do more, but you can't do any less and still solve the problem. I'm arguing that you should do as little work as you need to in order to solve the problem; anything more is overkill.\n\nI don't see anything that's more overkill/open-ended/future-coding about that than the contract that call would give us:\n\nIf you can satisfy the use case with less code, or a simpler interface, why wouldn't you?\n. ",
    "lightcap": "I could have sworn that @cbrunsdon told us that y'all already practiced what @mbj is saying in the hangout we did last week. :confused: \n. Also, sorry for the PR hijack @GeekOnCoffee :-)\n. @cbrunsdon that argument is a pretty slippery slope to me. At what point do you start to allow changes that you consider to result in \"white noisy\" merges?\nWhile I can understand the mixed use convention, @mbj has offered a global change.\nPutting off quality changes for the reason above seems tenuous at best.\n. @jordan-brough Until what point?\n. @cbrunsdon I think we'll have to agree to disagree. Picking a date is fine, but at the moment you don't have any criteria on which to base if that date is appropriate when it comes. \nI think that's my larger issue here: There seems to be too much happening based on feels and appearances rather than on axioms and published rules. I know it's early in the project, but it's more important now than ever to establish precedent.\nThis PR is a perfect example of what happens without a set of published rules on a bigger, high traffic OSS project. A one line change has turned into significant conversation. Were the rules in place, a simple test, \"Does this propose change follow our rules/guidelines/axioms?\" could be applied. \nThis is even useful in the design world, where things tend to be less scientific and more feels based, under the best practice of Design Principles.\nAnd, while I'm thrilled that there's attempts at consensus building through the use of these core team meetings, it feels more like stonewalling from here. There's no reason to me that those same conversations that would happen behind the closed doors of a core team meeting couldn't happen in the broad daylight of a PR comment thread. Not to mention, I think that waiting for a once per week meeting adds significantly more drag and friction to getting things done quickly and well.\nI'm acutely aware that the core team is trying to make sure that there's as little friction as possible so that the momentum can build for Solidus and that Solidus represents a step in the right direction. But I think the (fuzzy) lines being drawn in the sand are a dangerous and slippery slope that ends in a project like Spree.\nAll that said, I know you guys are trying to do the right thing. And, believe me when I say that I don't think anyone is doing anything but what they think is best. I just have to disagree with the decisions so far. And, I've seen them in a few PRs now, in only one short day of watching.\n. > It does sound like you have some specific rules/guidelines/axioms you'd like the project to adopt, would you consider opening up an issue for them?\nI could. But, since several of the things we'd propose have already been decided against by the core team in the few PRs we've seen I think it may not be the best use of the Solidus team's time (or ours, of course).\nTo be specific here, probably our most fundamental axiom in projects we run\u2026\n\nUse the least powerful primitive.\n\n\u2026has already been dismissed a couple times. \nI'm happy to discuss this further in Slack so we don't keep polluting this thread. Just seemed important to answer your question here first.\n. ",
    "GeekOnCoffee": "@gmacdougall here you go, a PR that looks like I've done this before!\n. If so, we should do that everywhere (we use this same pattern elsewhere in the order model) \n. ",
    "negouseid": "I still get the same error, \nI set my shipping category to \"ground\" and \"ground Int\" \nset my shipping methods to \"Ground, North America, flat rate\"\n\"Ground,EU_VAT, flat rate\"\nSo I am missing something else, this was the first thing I tried. \nThanks for helping\n. ",
    "stewart": "Hmm, that's correct! I didn't see it in the inline doc I was referencing, and assumed it wasn't included in the calculation. Perhaps a good default then is:\nruby\ndef fully_discounted?\n  item_total + adjustment_total == 0.0\nend\n. Or, just check if total == 0.0 if we'd prefer to include the shipment_total in the fully_discounted calculation.\n. A bit overzealous, I'll admit. Opening a new PR.\n. Maybe flag for removal (raise error) in 1.2, mark as deprecated for 1.1?\nAlso possibly worth noting this method isn't a carry-over from Spree - it was added earlier this year (pre 1.0, I think?), by Bonobos (who then override it). I'm unsure if there's many other stores leaning on it.\nUltimately, I'll defer to what you or someone else in core think works out best - I'm just a tourist here.\n. :+1: for :scissors: \n. :+1: on more detailed CI output\n. I am :+1: for reasons expressed by @mamhoff & @CoralineAda - adding a CoC can let people know that there is a baseline for how people are expected to treat each other in project discussions, and outlines a process for dealing with unwelcome/harassing behaviour when it arises.\n. :+1:, great branch name.\n. :+1: it's an effective hack that cleans up after itself well.\n. :+1: \n. :+1: for namespacing, :100: for updating JS dependencies.\n. General support, and possibly as part of some of the promotions admin changes, although I'd likely be using an instance method there, as all of the promotions are already loaded by that point. If this doesn't seem useful to the majority of people, I'm happy to close the PR.\n. :+1: \n. :+1: \n. Hi @bbrangeo,\nThere is a specific Api::ImagesController used to upload images that you might find useful, as well as tests for further reference.\nIn the future, please ask support questions in the #support channel of the Solidus Slack.\nThe GitHub issues are for reporting bugs.\n. I believe the contains is also useful for promotion codes.. :+1:, thank you.. I don't believe that will work, as order will be evaluated at the time of factory definition, as opposed to when a factory instance is created.\n[...]/payment_factory.rb:9:in `block (2 levels) in <top (required)>': undefined method `user' for #<FactoryGirl::Declaration::Implicit:0x007f0bfda556d0> (NoMethodError)\n. It may be worth replacing this test with a view spec, but I'm uncertain how much value testing translations provides in this context.. ",
    "Mandily": "We've actually got that feature already spec'ed out in a future improvement. Good to see we're thinking in the same direction.\n. We've actually got that feature already spec'ed out in a future improvement. Good to see we're thinking in the same direction.\n. Thanks for your comments on restructuring the IA. Those ideas will be helpful in reorganizing it in the future. In favour of doing it in small chunks, it's makes sense to first make it consistent so that it's easier to expand and is more intuitive for new users. \nTaxonomies can be found in both products and settings. In future work, I'd like to remove it from the products menu and leave it in the settings. But let's save that conversation when we have a holistic view of the menu in a couple of issues. \nFor a visual of what's being proposed in this issue, see the image below. On the 'current' side, there's a few items that are black because they don't have specific pages tied to them. On the 'proposed' side you'll see I've removed the extra nav items and replaced them with their current child items from the left. The text in the parenthesis's are the actual content the link would lead to.\nThe second option would be to make all parent links exist solely to open their children like in the third 'less desirable' option below. It creates an extra step in accessing the listing pages, and also creates a sub menu in a couple of places that don't really need it. Based on how I see the menu functioning in the out of the box model, the first proposed solution looks the best to me. \nWhat I'm wondering is - what custom menu items have you added that would/wouldn't fit into this model?\n\n. @tvdeyen Instead of telling you of plans to implement a flyout in the next issue, I just went ahead and created it https://github.com/solidusio/solidus/issues/505 I think that may help steer decisions made on this issue so I wanted to get it up now. \nI see three options for the left nav structure/interaction model. (black = no page link, blue = page link) I see there being benefits to leaving it flexible because different sites have different needs, but I don't feel super comfortable creating a navigation with an inconsistent interaction model to do it. \nWhat do you guys think would be best for Solidus as a whole?\n\n. After chatting with @Sinetheta I think the best way to go is how Wordpress and the current menu in Solidus seems to be designed. \nDuplicate items like products at a parent and child menu, and clean up the labels a bit so that they're distinctly different than their parents. So 'products' is the parent and 'product listings' is the child. The flyout helps users access items below quickly, so we don't have to worry about the extra click so much. \n@tvdeyen This would mean that the first child item would be displayed when the user clicks on the parent. Displaying the last viewed page, or a blank page just doesn't make sense in this situation.\nIn the case where an item would only have one child, we make the parent the link instead of creating a sub menu. So the Orders and Reports page wouldn't have a child item.\nThis has been a good conversation even to arrive back at the original design. At least now I know the reasons behind it! Thanks guys!\nIs anyone against keeping the current structure/model and updating a couple of labels so that they're distinct?\n. I'm closing this issue as we've decided nothing needs to be done here.\n. I just had a good conversation with @stewart about the message area sticking to the bottom of the screen and wanted to share here with the rest of the folks inGitHub. \nCurrently it's stuck to the top of the page. I see that as a hindrance in getting to the navigation and action buttons that are up there. We also considered adding it under that bar/to the top of the page content, but that moves content up and down as it's displayed/removed, which is an extra bit of friction that I didn't want to deal with. \nThe best option was sticking it to the bottom of the page, where it would cover content, but not functionality and not adjust layout. Because our admin users are regular users of the app, I don't see a problem in the minimal amount of 'training' it would take to remember to look down instead of up. I suspect unless they see a flash of red, they wouldn't give a second thought to it anyway. As @stewart also pointed out, the translucence of the background also helps to remind users that it's temporary and content is behind. \n. So I'm currently envisioning three different button types:\n1. primary - blue - examples: new product, add rule, save, search\n2. secondary - blue inverted (white bg) - examples: download promo code list, cancel (used for cancel when the primary interaction would be creating something. If the user was on a page to specifically cancel an order it would be a primary button)\n3. negative action - red - examples: delete (although right now this is an icon, so not applicable)\nI'm not sure I understand how other action types could be colour coded. Can anyone give some concrete examples?\n. We're talking about two different models of styling our content. I'm proposing a model where we emphasize the most likely user path. What's being proposed by some others in this discussion is using a model where we colour code positive, neutral and negative actions. \nI think highlighting the likely path is more effective than highlighting the outcome of the action. It breaks down for me when the likely path is considered a negative action. Say the user wants to delete something, and we show them a dialog to be extra sure because they can't undo it. Based on the colour model, both delete and cancel are red. It takes an extra moment (increasing cognitive load if you want to get geeky about it) to make a decision because the colour is interfering with the desired path.\nWe could combine the two models as shown in the third column below, which makes sense from a UX perspective, but I could argue visually doesn't look as nice as the blue. The blue fits in with the overall look and feel of the UI a little better, while anything red would be the things that stands out on the page. I could be more easily swayed on this one though if someone had a reason for it. I've included a quick screenshot of a form in the current UI as an example. \nThoughts?\n\n\n. It's been a while since anything was said in this issue. I just wanted to update it with a note that we're still planning on releasing this in 1.4\n. I'd like to see the original 'move' icon used instead of the 'sortable' icon you've used here. A bit more space between the two icons would be nice too, so we can minimize the chance of the user missing their target and clicking on the wrong icon. \nDid you/can you remove that error message when the user tries to drag a row to the top level? It would be better if we could just not allow them to do that in the first place. \nOtherwise looks good!\n. I haven't posted all 4 of the following issues up yet, but we're starting to plan for the 1.3 release.\nAssuming we don't run into any problems along the way, we'd like to get a sticky header, 100% width, tabs and moving the settings right side navigation into the left nav in 1.3.\n. To update this ticket to reflect conversations outside of this thread - rebranding and colour changes will be in 1.4. Only structural things on the UI side will be addressed in 1.3.\n. As per the two reference issues above, work has been done to remove the grid from the header and align the title and buttons to the outer sides. We're still in talks as to whether the stickiness is useful at this point.\n. The 'configurations' title at the top of the column. I don't think there's much use for it. \n. Tabs have been merged into the admin. They'll be included in the 1.3 release.\n\n\n. I'm a couple of comments behind, but the reason I want to move the settings into the main navigation is because that's technically where it belongs. It never fit in the second level at the top in the old model so it was put into the right nav. \nOnce we started talking about it here, we realized it would be easier to scan if it was broken up into groups. More useable is the end goal. Less clicks is one of the ways to get there, but so is grouping. \nAs for taxonomies on the store settings page, I think if we started combining pages, we should look at all of the settings, which I'm not sure if we want to do right now. What if we created a category called products? Would it be useful for other things people are customizing their stores with?\n. Does anyone have thoughts on moving taxonomies into a \"Products\" category? Do your stores have other items that would benefit from a \"Products\" category or would we be creating this just for the sake of Taxonomies?\n. Thinking about this a little more, do we even need taxonomies in the settings? It's weird that it has two access points. It's like it doesn't belong. I'd rather make it accessible from one (products) and remove it completely from settings. What do you think?\n. This work has been completed and merged into the repo. It will be included in the 1.3 release.\n\n. I've updated the message above to reflect this, but just wanted to notify those who previously read this thread that #666 Allow left navigation to be collapsed has been moved from 1.2 to 1.3 due to time constraints.\n. #1078 Content layout bullet in the original comment above was updated with a issue number.\n. #1078 has been moved to release 1.4 due to time constraints. We've got templates built, but we won't want to rush through applying them to the admin for this release. \n. That's a good point. I've run into that in other interfaces as well. Are you picturing a browser tooltip-like thing or something more like the UI of the sub nav flyout?\n. We've been chatting about this issue in the Slack #gui channel and it looks like we're leaning in favour of using a tooltip.  It's the easiest to implement (some version of it was part of Spree) and seems the most intuitive out of our options. \nI think the trick will be to play with it and get the right amount of delay on the hover. We'll also need to make sure that it's styled so that it's not confused with the sub-navigation.\n. This was originally planned for the 1.2 release, but due to time constraints we'll be moving this to a future release.\n. We've been on pause for this one for a while, but you should see some traction on this one in the next few weeks. We're still aiming to get this in for 1.3.\n. Had a quick chat with @Sinetheta to nail down the requirements for this.\n- Default open on large screens.\n- Default close on small screens.\n- Remember user preferences on the computer/device they're using.\n- Stays open/close until user changes the preference.\n- Label on collapsed nav items to appear on hover. Tooltip should look consistent with admin, but different from menu styles.\n\n. I just ran into this problem right now. I'm glad someone else was confused and is also trying to fix it!\nIs it possible to have two different messages depending on whether option types have been created at all?\nOption types created but not added\n\"Option Types have not been set for this product. Set them for this product on the product page under the Option Types heading.\"\n(link goes to product detail page)\nOption types not created\n\"No option types were found. Create a new option type before creating a variant.\"\n(link goes to create a new option type page)\n. The casing is mixed in the app right now. I'd like to move towards sentence casing (Only the first letter of a line being capitalized) instead of title casing (the first letter of every word being capitalized) and plan on cleaning it up as we go along. \nPlease leave it as \"View store\".\n. Spacing looks good to me. Thanks @Murph33 for getting this in.\n. It seems to me that \"EDIT VARIANT - SIZE: M, COLOR: BLUE\" should actually be the title of this screen, instead of the title of the first section. Is there any chance we can add that to the page title? I'm not sure if we need the variant type in the title though, what do you guys think?\n(Eventually I'd like to get some breadcrumb functionality in the title instead of having the 'back to products list' button. But that's probably a little bit of scope creep for this thread)\n\n\n. I really like the page title update, that's harder to miss than where it was before. I have 3 more ideas for improving this:\n1. I know I had section titles in my wires, but I think it's cleaner, takes up less space and still gets the job done without them. \n2. It would be more consistent with the rest of the app if we could label the 'override tax category\" as 'variant tax category', and then have the default option be 'default'\n3. Shorten the width of the tax category field\n\n. This looks great! The \"Use Product Tax Category\" text is much clearer and it looks closer to fitting on one screen.  :+1:\n. This looks great. It's more clear and intuitive for users. :+1: for reducing cognitive load.\n. I agree that it should only be accessible from one place. But putting it in the stock menu item leads me down a rabbit hole of asking, when does something get put in settings, and when does it get put into a parent category of it's own? Playing devil's advocate here - some of those things look like they could go under 'orders'. \nDoes anyone have any thoughts on what's a setting and what's a sub section of a related parent?\n. We were planning both on creating templates and moving existing screens over to those new templates for 1.3. Due to time constraints, we're going to wait until a later release to merge the new layouts in.\n. After running through an exercise with more of the admin forms, I've realized that 3 layouts instead of 2 is actually more useful. So we'll have the full width layout and two forms layouts as noted in #1290.\n. Good catch! I didn't see that. Does anyone know why they're different?\n. How about we combine them into the same table then?\n\n. We've been having a conversation at Stembolt about the likelihood of multiple capture events on a payment. It seems like worst case its an edge case, and best case it doesn't happen at all. \n@mamhoff came up with the idea of two rows so that we don't have to deal with growing tables. As long as we span the rows across multiple columns in the payment section, I think this works. \nSingle capture (this is what would show most of the time)\n\nMultiple capture (edge case)\n\n. @mtomov What you're saying here makes sense. Store credit isn't a method that's in the Solidus sandbox and wasn't part of my mental model until I saw your example above.\nUntil we have more concrete evidence that users prefer to see everything holistically on page, I'd prefer to keep things as they are instead of changing data display.\n. I pulled this down to look at it and noticed one small thing. In the reports list the name is 'sales total' (singular) in the breadcrumbs it's plural - I don't care which it is, but can you make it consistent please?\nOtherwise it looks good!\n. I know you removed the H1 from the breadcrumbs to be more semantic, but could you add a font-size of 16px (or 1rem, whatever unit we use) to the breadcrumbs to give it a bit more prominence on the page? That will make it smaller than what it was to account for more horizontal space being used, but larger than the 13px it and the rest of the body text is now.\nOtherwise \ud83d\udc4d from the UI side.\n. This looks great and I love that we've got responsive working now too. I'm planning on tackling this at the SolidusConf hackathon next week. \nSmall plug to the community - even if you're not going to SolidusConf, you can take part in our hackathon remotely. The whole Stembolt team plus other conference attendees will be coding against the Solidus platform, so you can count yourself a part of it if you join in on the Solidus Slack channel. \n. I've started recruiting admin users for a cart sort that should help us organize the admin better. Will post back here when I have some results. We're looking for admin users, not developers that code on the platform. If that sounds like you or you know of anyone who wouldn't mind spending 10 - 15 minutes of time, please forward. \nThe survey will be open until Friday, June 10th at midnight.\nhttps://30336t5m.optimalworkshop.com/optimalsort/solidus-nav \n. I looked at the results of the cardsort and saw that while there were some obvious moves and label changes, there was also some items that were split between being located in settings vs products. I ran another type of test, called a tree test where the navigation was set, and users were given tasks to follow to see if they went in the right direction. \nAgain, not everyone thought the same way, but in creating a consistent convention of how we organize the navigation we should be able to account for the mental models of both groups. \nI've created a new navigation in a google spreadsheet with highlights for label changes. The new navigation is based around a structure where 'set it and forget' items (for example, things that end in 'types', 'categories', and 'methods') get created in 'settings' and then specifics for those get set in their respective section of the nav (for example, under orders and products). It's seems to be intuitive for about half of users, and the consistency should make it easier to learn by those it's not intuitive for. \nI do think the admin UI would benefit from a few more helpful links to other sections, but I'll save those for new issues. I've submitted another PR #1276 for the label changes as a precursor to this. If all that is required here is moving menu links around in all of the partials I can do that too, but I totally understand if the people with more programming knowledge want me to stay out of it. I'll leave it to @graygilmore to decide as he's the one who created the issue.\n. \ud83d\udc4d\n. \ud83d\udc4d\n. I updated the post above as well. This is how I see it: \nStatic no action required (example: download list, filter results - things that don't need to be done on a page)\nStatic action required (example: save your edits, cancel edits - when something needs to be done to commit user input)\nin the case of action required buttons, nothing in the button itself has changed, it's more of an indicator about what is happening in the page.\n. I dropped the ball on keeping up with this. I've had some time to mull this over, and had a chat with @Sinetheta to come up with the following:\nIdeally I'd like to see our interaction model use button types and icons being determined by priority, with a special case button colour for destroy items. \nPrimary buttons can happen multiple times on a page, but generally not in the same 'group'. So the 'save' button at the bottom of the page, and the 'new item' button in the header could both look the same because they're regarding two different functions on the page.\nFirst thoughts are primary buttons using blue, secondary grey, and all destroy items red. \nThis ensures the user can find what we deem to be their primary motivation in any particular area of the page, and we can better warn and prevent them from accidentally deleting something they shouldn't.\nHow do you all feel about that?\n. I'd like to add two things to the to do list. The first one may solve @jhawthorn's last point above.\n- [ ] Pull the master variant pricing and cost price off of the main product page, and out of the variant table to an area all it's own at the top of the page. \nThis would also include a new feature I'd like to start implementing in the back end which is tooltips for more information. Great information for newbies, totally unneeded and thus out of the way for the experienced users.\n\n- [ ] Add an option types summary area at the top of the page so that the user can tell at a quick glance what's being used in the table below. I suspect the table could get messy at times, and a quick snapshot of what they're working with would be handy. This should fit to the right of the master variant pricing.\n\n. Yes, it's a great pattern and I'd like to see it across the app, not just list pages. I thought I'd try to lure someone in with just the stock transfer page before we expanded it to the rest ;)\nI haven't cleared all my data to go through the admin empty, but there is the possibility that when we do, bullet 2 might be broken down into sub bullets if more than one piece of criteria needs to be met before a record can be created.\n. @Kingdutch the sole motivation was to keep the page clean and help the user focus better on the data. But I like your counter points about getting the user familiar with the controls and bulk editing even if it is just a small portion. \nI had future plans to collapse this area. So leaving it there isn't a big deal. I think we should do that.\nSo to edit @tvdeyen's previous comment:\n1. We have a page missing prerequisites. Displaying action to create it. Hiding actions that cannot be completed without them.\n2. A page with no data. Having a link to create a record\n3. A page with only few records. We omit the pagination\n4. A page with lots of records. We show the full feature set of filters and pagination.\n. @oojewale No updates. The last message is the most up to date, with the mocks up above being a little out of sync. If you get through this one page easily enough and are looking for more, let's sync up about how to tackle/track progress across all of Solidus.\n. I fall short when it comes to code things like this. I added more rows in my sandbox until I hit 15 and still no pagination. If someone else could confirm that this works as @tlindsay describes, I'd be happy to close this issue.\n. Sorry to be picky, but does it work for you too @mamhoff?\n. @mamhoff Where did we land with this? Are you taking care of this in another issue or should I leave this one open?\n. That makes sense and looks better to me \ud83d\udc4d \n. Can we be consistent with the use of capitalization and use a capital letter after the colons in the 'default' messaging? I could be swayed to use all lowercase if someone thinks that's better. What I'm after here is consistency. \n. Good call on the examples. I'm working through a few different page types myself to double check all those guidelines up there satisfy our real life examples. I'll post a few wireframes back to this thread when I'm done.\nAs for the mobile view - I don't have a good handle on how many people actually use solidus on tablets and phones, so until I understand their motivations a little better, I'd like to keep as much as possible responsive and in view.  So the title and help text would be shown before the form group, and in the sidebar model, the sidebar information would be shown after the main content panel. \n. I can argue (and did argue in my SolidusConf presentation) for buttons that are always in the same spot on the page (sticky header) and therefore always available and findable for the user. I can also argue for the other side where the buttons should be within easy reach and context of the form or information they're related to. It's really a good thing to do user testing on, and I don't have any of those at the moment, so I'm still pondering it.\n. Just a note that I've updated the first message in this thread to reflect some of the changes that were mentioned in the \"updates\" section. It's a bit hard to maintain this kind of stuff in GitHub, so I'm going to make the jump to adding these notes to the style guide. Will post back when it's been updated. Thanks everybody for your feedback thus far!\n. We've been using red as a colour for the action that will delete a record in the admin. It's a helpful secondary indicator (the first being the delete icon or word delete) but I wouldn't want to establish it as the first and only indicator because that leaves the system not as usable for the colour-blind folk. \nI'd also like to establish a different visual treatment for things that are already deleted compared to things that will perform a delete action. I like the idea of a strikethrough, possibly even a lighter shade of the text. \nSome other ideas:\nI'm not sure what the space considerations are, but this may be a good opportunity to use the \"i\" icon with tooltip that @jhawthorn used in #1266. Thinking a little ahead, if a user had three sku's, two of which had been deleted, it would be handy to have a 'deleted date' shown too. But that may be a little out of scope for what you're doing here. \nWhat do you think?\n. That sounds great \ud83d\udc4d \n. I'm fine with tackling any styling/consistency issues in the brand overhaul. This looks good to me \ud83d\udc4d \n. If this is main identifying information it shouldn't be hidden. The tooltips were created for adding supplementary information, not hiding main content. Once we get the new layout in, we'll have lots of space to list all of the variants attached to a product instead of limiting to just 5. There's a wireframe in #1290 of the products page with a variants section in the sidebar that could easily expand to fit all variant types. \nMy vote is to leave it as is and expand it to all variants once the new layouts are in.\n. I missed the leading paragraph. I've just updated it. Thanks @tvdeyen for the headings. Much better.\n. The Blue Steel theme is a work in progress, which is also why it's optional. When @Sinetheta moved the navigation to the left, he cleaned up the css so it would be easy to update with the blue steel colours, and then provided that colour palette if users wished to turn it on. \nIt's on our to do list, but we won't be updating the main content visual brand until we've finished up some of the higher level items like implementing bootstrap grids and cleaning up forms. #1078 \n. This looks so much cleaner!! Thanks for tackling this. \ud83d\udc4d \n. This is awesome! \ud83d\udc4d Way better than what we have now. With regards to the questions in your \"work to do\" section:\n- Multiple activation types could mean we use checkboxes instead of radio buttons if we want to allow a user to make any combination of options. If we wanted to restrict them to certain combinations, it might be better to make that combination a new radio button option.\n- Tooltips: the new bootstrap layouts will allow for substantial helpful information to be added to the sidebar, so we might want to just make a note of what we'd like on the page for the time being and then add that information when we switch this page over to the bootstrap layout in the future.\n. This looks great! My only comment/concern would be pulling those table titles out of the merged table cell and making them a proper heading so that it's a bit easier to scan the page. We could also then add one for \"Variant pricing\" which could be referred to in the tooltip messaging instead of \"the table below\".\n. While not a fan of that fieldset style, I do like the hierarchy it gives to the page and it's a better middle ground for us to work from when we update styles. \ud83d\udc4d \n. I also like the idea of the tooltips on the checkboxes. I don't completely understand what all of these are for, but I wonder if there's a way to group them up into something more meaningful for users? Do any of you have a pulse on that?\nThe stock locations page in the new layout would look something like this\n\nI know @omnistegan has been working on implementing the new layouts over the last couple of weeks. I wonder if we shouldn't wait at this point for those new layouts instead of reconfiguring stuff in skeleton. \n. I have a couple of thoughts on preselecting values in dropdowns. \n1. It's great if most of the time the user would select the same option anyway. This saves time, and cognitive load.\n2. It's not so great when you want a user to actually think about what's in a box. You can risk them skimming over it and setting something up improperly. \nWithout doing a full in depth exercise, I suspect that there's a good deal of dropdowns that would be suitable for a default value. \nWith regards to the edit functionality of the tables - I think this is a great idea and I secretly thought it was going to take a lot longer before we'd start to see more of this added into the admin. So I'm excited you're doing it now @mtomov. \nI agree with Thomas and John - Instead of using additional icons within the tables, it would be nice to use the same convention that the product stock screen uses - swapping out the edit and delete buttons for a checkmark and X. I think it streamlines both the interaction and the UI.\n\nIn the future, we could take this one step further and make everything in the page editable without having to go into an edit mode, and automatically save changes on field blur. But in the meantime I'm more than happy to see edit functionality being merged into the view pages themselves.\n. The checkmark and X buttons replace the edit and delete buttons when the user is in edit mode. Clicking on edit makes the whole row editable. Once the checkmark or X is clicked, the row goes back to view only, the edits are saved, and the edit and delete buttons appear again.\nI don't think we should avoid introducing a new and improved interaction model because a visual style is too garish. At some point I'd either like to update the select 2 inputs to v4 or restyle them ourselves with the rebrand. @jhawthorn might be better able to speak to that though.\nI realize this would also include a visual style change in the tables, but the best way I've seen this editable table thing done is that when a user hovers over a table row, it gets highlighted with the fields marked in white. \nI believe this is the best model, but before we go that way, I would want to understand if it's something that you think is doable across Solidus as a whole in a relatively short time period, because I would hate for a transition like this to take 4 years to complete.\n\n. I downloaded your code and played around with the new functionality. I like it a lot! \nIt would be nice if the styles between view and edit mode were the same, but I'm not sure if that's something we should tackle with this or leave it for the future rebrand. Especially as we can't do much with the dropdowns right now. What's your take on that? This might even be something I can do myself if you didn't want to get into the finicky css stuff.\nI know we technically don't need a save button on this page because we're auto saving, but I think we need to keep the save button on every page for peace of mind for the user. In the future, I'd like to introduce states to buttons, so if the page was saved, the button would look disabled, whereas if it needed to be saved, it would be brighter to attract attention. We don't need to do that for this feature, but I'd like to keep the save button here for future use.\nThe third thing I wanted to bring attention to was that we don't have a stop gate for catching the user while in the middle of edit mode. If they start to edit a row and don't click on the check or x, and then navigate to another page, changes are lost. This is a behaviour that is consistent across Solidus, but I'd like to do something to remedy it in the near future: I see three options for this:\n- Auto save rows when a user clicks outside of the row. This would negate the need for check and X buttons\n- notify the user when they try to leave the page with a modal window.\n- both of the above\nI'm a little more on the side of the adding this kind of functionality here than the save button, but I could be persuaded to add it in later if you had a good reason to leave it. \nWRT your most recent post, I like the idea of keeping the alt text an editable field. I was actually trying to figure out how we could do edit the thumbnail image too, but I think that gets more complicated than we want to get at this point. The good thing about making every field in a table editable is that we can then get rid of the edit pages. (WOOHOO!) I think the option types page you mentioned and a good handful of others would benefit from users being allowed to edit right in the table and getting rid of the edit pages altogether. In some cases we might have to add a few more columns to the table, but it shouldn't be too big of a deal. \nLet me know if you want to hash out any more ideas or need help identifying those pages. I've got an ongoing list that I can add those \"optional\" features I mentioned above, so let me know you're thoughts on the stop-gate solutions so I can log them in there if you decide to do them later.\nThanks so much for taking this on! . I agree, I don't think this would be appropriate for all tables, but any of the smaller ones where all data can be represented in a single row should eventually be moved over to something like this. To clarify -  it's EVERY FIELD in a small table, not EVERY TABLE.\nContrary to your auto-save point - if the user mistyped something, they can just go back in and edit it again. It's not like we're asking them to confirm with a dialog when they save it anyway, so that extra step isn't really reducing the risk of human error. \nI was also thinking on the styles that the check and X are presented in vs the edit buttons. If we remove the other row's buttons, we do remove the clutter, but we also remove the user's ability to edit more than one row at a time. At first I was thinking that would be a good idea, but the more I think on it, the more I think we need to give users the power and freedom to edit these things as quickly and easily as possible. I can't say for sure, but I imagine that when a user needs to edit something on one of these pages, it's probably more than just one row. This is also why I like the auto-save feature. It allows users to be more efficient in entering/changing their data.\nIn short - Solidus users are regular users of this software, I don't think we need to protect them from themselves as much as we would with a software that many people use only a few times. . By any chance can we get the cancel tooltip to be orange to match the rest? The red is associated with delete/destroy in my mind.. This looks great! I love how a small code change can make such a big difference to the usability of the admin.\n@mtomov Eventually I'd like to get to the point where we remove the buttons on the side and only show them on hover. Do you have any ideas/timeline on when we should implement that part? I'm also curious to know what the plan is for applying this code to the rest of the tables in the Solidus admin.\n. I will make a new issue in the next couple of days with other tables and link back to this one.. I agree with @tvdeyen, It would be nice for the droppable area to be the full width of the content area with a lighter grey background. But I'm also fine with leaving out colour details until we do a full pass over of the UI with the rebrand. \nI'm not sure what your rationale is for combining the two messages into the button, but I think it's works better as two distinct instructions instead of one joined. The button is not being used to drag and drop, so the CTA text inside should not be referencing it. So the button is used to browse, and then the message that the user can drag and drop is located outside of it. \nDisclaimer - I did not mock this up, I just found online\n\n. Perfect! And thank you for putting a lowercase 'u' on upload. \ud83d\udc4d \n. With regards to the point \"Add hint to \"advertise\"\" Instead of adding a hint, let's remove this from the admin. It's not worth the real estate or edge case of advertising a promotion on a specific page to keep. I had a chat with @jhawthorn and he's agreed. \nTwo of these items are big enough I think they can be broken out into their own issues. I'll create a separate one that will include a wireframe to cover both of these: \n- Fix responsive layout\n- Make the promotion code more prominent\nI can come up with some copy for \"Add hint to actions and rules\" if you can refresh my memory on the specifics of this. \nI think the rest are pretty straight forward. If anyone has questions about what's left up there, please feel free to comment or ping me directly in Solidus Slack under the same handle.. \ud83d\udc4d Looks good to me! . I also like the idea of putting the icons in the table to keep relative things grouped together, but it might be better to keep it separate for consistency right now, and then globally change the location of all icons in a separate PR. I realize in suggesting that though, someone would have to volunteer to do that chunk of work. This sounds like a thing that I might be capable of, but I'm not sure when I'll have the time. \nI can see how on first glance a user might think that the \"add item\" button at the bottom of the page would save the new row. I know they're figure it out and learn pretty quickly, but in the interest of a more intuitive UI, it would be nice if we could rename the label to \"Add new item\"\nThe note about the disabled button raises a bigger discussion about whether we want to put the user into a stateful interaction (which is how Solidus works now) to keep them focused on their task or make it stateless to give them more flexibility. Again, I'm inclined to say keep it consistent until we have a bigger bandwidth to think through and change things on a more global scale. . I'm not sure we need a label on the column \"actions\". But this works great otherwise.. It sounds like you're trying to solve a less than intuitive button design here. \nIf we're having issues with people understanding the icons in the button, I think we should redesign the button to make them more clearly understood on first glance. If users didn't know that these buttons cause \"actions\" to happen, we need to design a little more affordance into our button styles so they look interactive. \nDo you have any kind of data on this that would lead us to believe users are having difficulties with the buttons? I've wondered myself on and off for a while if simple text buttons would do better or worse, but without understanding the current situation, it's hard to improve.. My future dream/end game is to have a thing that looks like this at some point. Moving the buttons inside the table is one step closer to highlighting a full row with them included. So my vote it inside the table. \nIf people feel strongly about including a column label, then go for it. I think it's cleaner without it and self explanatory, but it's a small detail in the grand scheme of things. \n\n. To go back to the point about solving specific problems - I don't think this solves a problem. I thought it might be a step in the direction of the screenshot I included above, but after thinking about it further, it's not, because that screenshot is about removing lines and cleaning up the overall appearance. Adding lines around the buttons now is not setting us up to do that in the future.\nAs all English and many other languages read from left to right first, I don't see a problem with understanding that the buttons on the right are indeed related to the row at the left.\nI'm in favour of not merging this PR.. I would love to see a plan to deal with text that doesn't fit. I suspect if this happens at all it would be in the table headers. I'd be ok with truncating it like we do the admin email in the left hand column until we get a better layout sorted out.. The full width layout is for the listing pages with tables, but if there was a small table in a mostly form page I had hypothesized that text may not fit as shown in the example below. In the case that the text overflowed the table header that it was in, I thought it better to truncate it. Now thinking about it further, the best solution would be to simple wrap the text. :)\n\n. \ud83d\udc4d . I'm definitely for the full width on the table. \nThe third and fourth screenshots start to look a little odd to me with form fields moving around and empty space being on the left side of a row. Is there a way to clean that up at all without breaking extensions and shops as you mentioned above?\nAnd just to double check - is this replicable with the other listing pages as well?. To play devil's advocate - did you consider putting a max width on the search area so preserve the order/groupings of form elements a little better? \nThis was my idea in #1290 but I could see too how using less space up top could be more desirable. It also leads to the question of how well are those fields really organized at this point anyway? I wanted to move them around and even change the way a couple worked (as you can see in the checkboxes) but I was never super clear on how that would affect other stores. \nAny thoughts on this approach vs the full width one?\n\n. I agree \ud83d\udc4d . I like this a lot. I'm assuming we'd use the same thing in the settings where you set the master currency for each store?. I like search at the top for consistency in the rest of the app. Thanks for doing that. By any chance does anyone reading this thread have data on how admins use/want to use this page? It would be helpful to have to know what data we should display for them.\nA few thoughts:\n1. It might be nice to allow admins to filter the roles by any combination. Displaying those in checkboxes instead of a dropdown would work well for that.\n\nA pet peeve of mine is labels and table headers not matching and not in the same order. Could we\nlist the form fields in the order of Email, Role, Member since\n\nrename the table header \u201cUsers\u201d to \u201cEmail\u201d\n\n\nThis could be a global thing for all list pages - Displaying the total number of records (in this case \u201c322 users\u201d) would be nice for an at a glance idea of how many people had been through the store.\n\n\nAs noted by @jhawthorn in Slack, the table pagination is off, but he may be fixing that in a separate PR\n\n\nA couple of things I thought of, but would probably need admin validation from a few different groups before we implemented as you noted the technical load would increase:\n\nOther filters that might be useful\nrepeat buyers\ndropped cart users\n\nlocation\n\n\nOther information that might be useful for admins \n\nlink to last order\ntotal number of orders\ntotal number of dollars spent in the store\n\nWhat do you think of those things?. @tvdeyen Do you have a new screenshot you could share? I don't generally get into the code review part of reviewing :). A few more things have come to mind since looking at this last:\n- Could we change \"total sales\" to \"total spent'?\n- Can we add a sort caret to the last three columns?\nOtherwise this looks good!. I discovered data tables a few weeks ago while looking into bootstrap sort functionality as a whole. Would this be helpful? https://datatables.net/examples/styling/bootstrap.html. My bad, I was looking at some functionality on an address form on another site and got muddled when I was making this wire. This is more what I had in mind:\n\nThinking on it again today, I did come up with another option.\nAlternatively we could also put that form into a modal. I realize we don't use that model of interaction right now, but it's something going forward I'd like to do more of instead of routing the user to a new page.\n\n@mtomov What do you think of these options? It's hard for me to say which one is \"better\" without user input. Do you have any insight from working with clients?\n. @mtomov worked on a PR that added inline editing capabilities to the image variants screen to make it quicker and easier for admins to update fields. I think this could be extended to other tables in the admin so that users could both edit and create simple table rows inline instead of needing to go to other pages. I've broken up the opportunities into:\n1. Simply making existing inline editing capabilities available upon hovering of rows. Sometimes we'd be able to remove the edit button from the side if we were also removing a separate edit page, but in the case of pages with a large number of inputs, we'd keep the edit buttons to be able to link the user to that page.\n2. Making interactions consistent and moving save or update functions tied to a table row into icons located at the right side of the table, and removing them from underneath the table.\n3. Moving edit functionality into a table from a separate page (and thus removing the need for the separate page and for an edit button at the right side of the table)\n4. Moving new functionality into a table from a separate page (and thus removing the need for a separate page and for a new button in the header or elsewhere on the page.)\nI\u2019ve made a list of tables and what would need to be done to move edit and new functionality into the table here\nLet me know if there's any questions/concerns about this. . I'm of the thought that anything interactive on the page should have the affordance of a pointer cursor, or a text cursor if it's an input. I understand where the author of that linked post is coming from, that in theory interactive things should look like they can be interacted with, and therefore don't need the cursor to tell users. But in practice, we have flat designs with less affordance, and the pointer cursor only helps to reinforce. . Allowing admins to edit multiple things at once and worry about saving when they're done - would be a huge win for efficient design. In an ideal world, we have a save button in an easy-to-find spot on every page with states (#1162) that tell a user whether the page needs to be saved or not, instead of multiple save buttons down the page. We could even add a dialog/modal to warn the user if they tried to navigate away from the page without saving it first. Or maybe we even auto save. \nBut to get back to the original question - yes, edit multiple items and save once would be huge.. I like the content of what you're trying to say in the writeup in the style guide, but could we write it in a clearer way? Maybe something like this: \n\"Pill styling adds a second, easily scannable way to recognize status. They're most commonly used in, but not restricted to tables.\". re: \"Shouldn't complete be green?\" \nGreen is usually associated with an action - like \"go\" or \"active\" in this case. In the case of grey being used for complete, it means that a thing is done and you don't have to worry about doing anything else for it. The colours stand out more than the greys because they're the things still in flux that an admin might want to keep an eye on. The neutral things are the ones they don't have to worry about.\nThe caveat here being that most if not all of my colour theory is based on North American norms. Maybe these colours mean different things to you.\nMake sense? \n. I really like the spinner that replaces the search icon and the animations for extending the \"how do I use this?\" and the errors. One small UX request - Can we put a hover state and cursor: pointer on that link? I looked around a bit and couldn't find links anywhere else. This might be a new style worth putting in the style guide.. @Sinetheta If the quick switch field was in the header like Shopify, I suspect many would expect it to behave like the omnisearch in Shopify, which is not what this is. IMO it's better to leave it a little hidden, yet easily accessible by quick key like the Mac OS.. Visually looks good to me \ud83d\udc4d . When thinking about the alignment of the action buttons - the thing that I would most want to align to is the same action above or below the current row. So a particular action could always be found by scanning straight down. It's one more little piece (location) that helps a user identify what the action is. Kind of like how a colour blind person knows that the top light on a traffic light is stop even though they don't see red. \nFor example: all of the X's would line up straight down the side. \n\nThoughts?. I agree with @notapatch - it is confusing to have the prices looking like links. Swapping the variable for the product_body_text_color looks fine to me. Screenshot for anyone wondering what this looks like: \ud83d\udc4d \n\n. Sounds good to me @notapatch Can you post screenshots once you've made changes to the other areas please and thanks!. Looks good to me! \ud83d\udc4d . For a little more context - the idea here was that the action buttons would always be in view and accessible by putting them in the header. Create actions like \"new product\" would live there as well as save and cancel buttons once a user was in those new or edit views.\nAs for small/mobile screens, we could do the fancy thing of scrolling down the header goes away but scrolling up brings it back into view.. Safe from a technical or user perspective? I'm not sure of an alternative if it's code, but if it's the user you're worried about, we could use an interim 'Display Order (Taxon)' label that would be intuitive for familiar users and new users alike.\nTo clarify - this is only affecting the page title of this page:\n\nThe taxonomy tree still stays the same, and we're not getting rid of the 'taxon' terminology.\n\n. Is it possible to make the text \"variants tab\" actually link to the variants tab?\n. Change \"these\" to \"master variant\" to be more explicit\n. Be more explicit with the name of the table. \"These options are used to create variants in the variant table. They can be changed in the variants tab\"\n. The new bootstrap layouts have a place for this kind of information where we could also put links. Let's leave it in the tooltip for now, and when we convert over to the new layouts we can augment the text with a link in the sidebar.\n. The flyout is triggered by hovering, so it doesn't actually work on a touch screen. it's more of a bonus for desktop users than a feature removed for mobile though. With a single tap they can still open the menu to access the lower levels.. I actually prefer the before to the after. As a general rule, I try to keep less space between the lines of the same label/list item/paragraph and more between it and whatever is around. It helps keep the item grouped with itself a little better.. A bunch of these (this particular example included) can be removed and replaced with the inline editing solution that Martin worked on. I linked a drive document in #2042 for those. I'm ok with this style for the ones that remain. . \ud83d\udc4d . \ud83d\udc4d . ",
    "dougjohnston": "@peterberkenbosch Is this any further along? Since my marketing team is now asking for this, I'm going to be working on it one way or another.\nAlso, @alepore, that's sounds like a nice solution. Do you have any sample code you could post?\n. It fixes behavior more than changes it. \nWhen initially loading the order admin page, complete and incomplete orders are shown. That's expected. Clicking the 'only show complete order' checkbox removes the incomplete orders and shows only completed orders. Also expected. \nIf I then uncheck the box, I would expect it to show complete and incomplete orders again, but it was only showing incomplete orders. That's not expected (to me at least :smile: ) and that's the behavior this PR fixes.\nPerhaps it still warrants a note in the changelog. Do you want me to add that? Or, will you add it?\n. I see now that the naming of my test doesn't make sense within the context I put it in. I'll fix that.\n. ",
    "iqbalhasnan": "I'm on ruby ruby 2.1.5p273\n. ",
    "andremleblanc": "This looks really pretty, can't wait for it to be merged in :+1: \n. OMG it looks a billion times better :+1:\n. ",
    "alex-handley": "Thanks @athal7 ill investigate some more.\n. @Senjai Good idea, I always forget about the nested where syntax!\nI have updated the PR.\n. @Senjai Thanks for the mysql tip, I have been using pg for a while now so haven't come across this before.\nDoes this sound like a reasonable plan:\n- Add limit to existing migrations (this will fix the issue for future apps)\n- Start to add DbMaximumLengthValidator constraint to important fields.\n- Look at best migration path for existing apps that are missing limit\n. @cbrunsdon Yep, makes sense to apply it as a new migration but we will need to come up with a solution for all of the records that will become invalid for existing app's.\n@Senjai I may be mistaken but DbMaximumLengthValidator just uses the db level constraint so we can show a pretty Rails error rather then fail at db level.\n. @cbrunsdon looks like a good solution, should this only be on the user entered fields for now? e.g. addresses\n. @cbrunsdon I was looking at DbMaximumLengthValidator it is only used in one place, what don't you like about it? potentially we could just remove it as having a custom validator used in one place with its own specs doesn't make sense :)\n. @cbrunsdon The only feature I like about DbMaximumLengthValidator is its maintainability if say the way limit is retrieved changes in Rails.\n. @dangerdogz I am only going to add to user facing fields. I should have the migrate ready tomorrow for some feedback.\n. Morning, this is my first attempt at creating the migration:\nhttps://github.com/alex-handley/solidus/commit/f6e39b1d195446b9ee84b846fb609fc094dd18fe\nI am going to create a db dump from our prod and see if I encounter any issues.\nAny objection/suggestions to the included fields?\n. Hey, just to check in I have been pretty busy the last few weeks so only just got round to finishing this. \nI have built the migration with truncation protection and added the validates statements but one thing I have noticed is columns_hash crashes any script/task that runs when a DB/table doesn't exist e.g. db:create or bash build.sh. \nThis is because columns_hash tries to access the table and it doesnt exist yet which throws a ActiveRecord::StatementInvalid exception.\nHas anyone come across this before?\n. Agreed @dangerdogz I think we should stick with something like DbMaximumLengthValidator for the reasons you mentioned. \n. ",
    "ghost": "I would agree that this is a huge improvement. I don't mind the dark/cold nature of the design, and actually think it's a much more professional looking interface. It definitely has a strong Wordpress feel, but I wouldn't try to reinvent the wheel, just to make a more distinct separation.\nIn terms of the last 4 bullet points, I think they all make sense and would be great additions.\n. ",
    "davekiss": "IMHO, input labels and content area tabs could use a little bit of hierarchy, but overall, this is a huge improvement! Also, I know people love to hate WordPress, but maybe it isn't so bad of a thing that the ubiquity of a familiar UI has an influence here if there is a chance that admins might already be familiar with that system (I know in my case they would feel right at home)\nHave to agree about the blues being cold and the buttons missing \"action\" colors, as mentioned above.\n. ",
    "sukhchander": "@Mandily @bricesanchez i built a bootstrap based dashboard for my own 'version' of spree. it's functional but half complete. it's responsive. here are the screens. after forking spree last year i changed a bit of the internals as well as the UI. i shared the screens on the slack channel. sharing them here now. let me know if you'd like to use the functioning demo.\n\n\n\n\n. @tvdeyen i just updated #520 with screens of the work ive done so far to implement a boostrap|HAML|coffee|responsive dashboard\n. @erikaxel great points. a few people have to get together around the admin dashboard. i volunteer to be in that group.\n. @tvdeyen @Mandily i've implemented the collapsed nav as well as hover. who is working on the implementation of the refactored admin? i'd like to contribute or should i just create a fork?\nexpanded:\n\ncollpased:\n\n. sounds good\n. ",
    "ajkamel": ":+1: great ill work on the PR\n. @graygilmore :+1: on Bourbon it takes a nice approach however since Bootstrap is widely used I could see how it has a wider appeal.\n. @tvdeyen @Sinetheta I found the same issue with using the blue theme similar to @adaddeo.\nI found that manually overriding the spree_admin.scss file allowed me to import the blue theme however if I do not have that file it will not work.  Any ideas why?\n. Im seeing the same issue. I'll see if i can work on the PR.\n. @sahal2080 did you read this https://github.com/solidusio/solidus/wiki/Upgrading-from-Spree\n. @sahal2080 take a look at #592 I haven't personally done a migration since I started fresh.  You can also ask specific questions at the Slack #support room.\n. :+1:  for cleaning up dependencies!\n. I agree, I think having a good base set of guides to get started with Solidus would be key.  Starting with the Spree guides would be a great starting point.  Now... to find time to do this. :)\n. Hey Guys,  I created a repo to get the ball rolling on this and am open to pull requests.  The changes would be made in Markdown in the pages directory and asset images in the top level asset folder.\nhttps://github.com/ajkamel/solidus-guides\nhttp://ajkamel.github.io/solidus-guides\n. Solidus has now adapted this into their repo. PR's should be sent here https://github.com/solidusio/solidus_guides\n. Just added a url to the main page on the wiki for this.\n. @stabenfeldt you can find reference to the guides here https://github.com/solidusio/solidus_guides issues are marked as help wanted and we are accepting pull requests to complete the guides as of now we have the user guides up and they will be hosted on the Solidus domain soon. In the interim I've hosted them on my page for reference http://ashkamel.com/solidus-guides\n. This would be a great in the wiki or the guides. I'll keep it bookmarked.\n. Hmm good point. With that change it leaves it up to your config. \n. ",
    "tonobo": "Yeah thats exactly what i want, within german or the eu everybody needs to pay the german vat. Otherweise it must be refunded. The tax will be calculated by line item? If yes, does it also contains promition adjustments? Normally there where no problem to setup a custom tax calculator but i wasn't able to calculate all promotions. But thanks a lot guys, good work ;) \n. ",
    "larskluge": "Woo, this is awesome! Thanks @gmacdougall !! :)\n. ",
    "daisuke-3": "I think your suggestion is great! :muscle:\nI like haml more than slim though.\n. I have the same issue :dango: \n. ",
    "moholtzberg": ":-1: \n. I would think that moving the backend to a fremework like bootstrap would be a good idea.\nBut I would agree with @tvdeyen that the front end should be framework agnostic.\n. :-1:\n. ",
    "jamatthews": "Please stick with ERB!\n. ",
    "pusewicz": "Thanks!\n. I think it makes sense to have a framework that far more people are comfortable with. Adding a custom framework does not make the software easier to maintain. It's actually the opposite. Using something like Bootstrap (which is far more popular than Foundation) mean that the barrier to contribute is much lower.\n. :+1: \n. I believe we can close this?\n. @jhawthorn 4.0.2 is already available!\n. An alternative is to go with https://github.com/harvesthq/chosen.. ",
    "carchrae": "thanks @athal7 \nthat is a good point about other places this could happen via api endpoints.  certainly some more tests for these cases would be useful.  payments, for example.\ni checked the failing tests; it seems that the checkouts controller does test for complete (but in the controller), and, somewhat strangely, returns 200 and the order, if the order is already complete (instead of unauthorized or some error) https://github.com/solidusio/solidus/blob/master/api/spec/controllers/spree/api/checkouts_controller_spec.rb#L390\nnote however, that the order controller does not do this check.\ni wonder why can can was not used for the checkout controller check.  \nthe other failing test looks broken.  it updates the order to complete, then tries to transition: https://github.com/solidusio/solidus/blob/master/api/spec/controllers/spree/api/checkouts_controller_spec.rb#L383\n. @cbrunsdon - just's be clear;  you think it is a good idea for a customer to update their own shipping address?  what if you've shipped it?  \nthis is not stopping by default, it is stopping non-admins from updating a completed order.  sorry if that is not clear.\n. this is something that has always confused me; but perhaps it is fixed in solidus by now.\nthe order json returns \npermissions: {   can_update: false  }\nbut if you have the order_token you can update it no problem, and forever, it seems.\n. i never replied to the last comment from @cbrunsdon :  the json can_update  was not my main concern.  it was allowing a non-admin user to modify an order after it has been checked out.  at the time i wrote this, a customer could adjust the quantity after they paid for something.  :/  \nthis became a non-issue for us because we stopped exposing the solidus api and added another layer of control around it.  \n. ",
    "dfmedeiros": "@cbrunsdon - Thanks for the feedback!\n@jhawthorn - Yep, good catch! But I didn't get it correctly, what do you mean by select the stock items grouped by stock_location?\nMy plan is to select the correct stock items by variant_id including the stock_location and the variant itself, so we could check inside the loop. I think this would prevent the N + 1 as well. Something like:\n``` ruby\ndef requested_stock_items\n  Spree::StockItem.where(variant_id: unnalocated_variant_ids).includes(:variant, :stock_location)\nend\ndef build_packages(packages = Array.new)\n  requested_stock_items.each do |stock_item|\n    units_for_location = unallocated_inventory_units.select { |unit| unit.variant.eql?(stock_item.variant) }\n    packer = build_packer(stock_item.stock_location, units_for_location)\n    packages += packer.packages\n  end\n  packages\nend\n```\nWhat do you think about this approach? Do you recommend doing something else?\nThanks again.\n. @jhawthorn - Forget about my last comment, it doesn't work as I expected, but, I didn't get your last comment to select stock items grouped by stock location. I don't see how this would do any benefit for the queries on line 59.\n. @jhawthorn - Great, just fixed the typo. Thanks.\n. @jhawthorn - Great, just fixed the typo. Thanks.\n. @mamhoff - Yeah, I added the order clause to trigger the exact same query as before. If you check the shipping_rates association you'll see it's also ordered by cost.\n. @jhawthorn - Thanks for the feedback, but I'm kind of confused. Do you think this PR is useful or not? Should I just remove the order clause from the association?\nRight now I don't know a case which the old code would be faster but at least, on the application I'm working on, this fix and preloading some associations helped me a lot with performance improvements when displaying shipments and their details for some orders.\n. ",
    "tanmay3011": "@tvdeyen Added a comment so that you can get what exactly I have done and why\n. @jhawthorn Added comment!\n. @athal7 Where should I add comment to each file where I have used allow_blank or to any specific place\n. @athal7 presence validation shouldn't be removed since case of nil won't be handled in uniqueness validation. So presence validation is a must.\n. @athal7 Did you reload your console? \nAs far as to bring validation in affect you need to leave the name or code attribute blank\nWithout allow_blank\nruby\nSpree::AdjustmentReason.create!(name: \"\", code: \"\")\n   (0.1ms)  begin transaction\n  Spree::AdjustmentReason Exists (0.1ms)  SELECT  1 AS one FROM \"spree_adjustment_reasons\" WHERE LOWER(\"spree_adjustment_reasons\".\"name\") = LOWER('') LIMIT 1\n  Spree::AdjustmentReason Exists (0.1ms)  SELECT  1 AS one FROM \"spree_adjustment_reasons\" WHERE LOWER(\"spree_adjustment_reasons\".\"code\") = LOWER('') LIMIT 1\n   (0.0ms)  rollback transaction\nActiveRecord::RecordInvalid: Validation failed: Name can't be blank, Code can't be blank\nAs you can see above when I left name and code field blank uniqueness validation still gets fired\nWith allow_blank\nruby\nSpree::AdjustmentReason.create!(name: \"\", code: \"\")\n   (0.1ms)  begin transaction\n   (0.1ms)  rollback transaction\nActiveRecord::RecordInvalid: Validation failed: Name can't be blank, Code can't be blank\nUniqueness validation doesn't get fired. Only presence validation is enough to check in case record is left blank.\n. @athal7  Just see the example I posted. You need to leave name and code attribute blank in both cases to see the difference\n. @athal7 Do I need to do any changes now?\n. @jhawthorn Ok! Will update the PR and remove conflicts\n. ",
    "punjab": "@magnusvk Done! Squashed the two commits into one. Glad to contribute my first commit to solidus. Hopefully many more to come.\n. ",
    "bricesanchez": "Hahaha ! Thanks! :D\n. I'm working to plug Refinery CMS 3.0 with Solidus 1.2.x, i need this version to be able to going forward and this is a bump to stay current. Are you ok to use this version?\n. I'm ok with that and you @gmacdougall ?\n. > Not sure of the state of refinery.\n@dhonig It's better to ask the Refinery team to be sure of the state. To answer you, the CMS is going well, thanks :)\n\nI'm currently trying to get static pages working with Solidus.\n\nIf you only need static pages, you don't need a CMS, you could just use solidus_static_content or high_voltage gems\nIf you still need a CMS, feel free to try Refinery or Alchemy both have great features depending your needs and have a solidus authentication connector. @OrbitalAgility You could temporarily remove refinerycms-acts-as-indexed from your Gemfile and get Refinery running with Solidus, i've write a guide for Spree but it could be very similar for Solidus: http://www.brice-sanchez.com/5-easy-steps-to-use-refinery-cms-and-spree-e-commerce-on-the-same-ruby-on-rails-application/. ",
    "amicheals": "thank you. I will check out stack overflow\n. thank you. I will go to stack overflow and and take a look a @hhff \n. ",
    "wgriffiths": "I will start looking into this\n. ",
    "travisp": "Yes, I just tried importing spree factories into an app to use for testing, and the app lints all factories by default when all specs are run. It came up with these errors (after I modified the default user factory to have an 8 character password):\n* adjustment - Validation failed: Order can't be blank (ActiveRecord::RecordInvalid)\n       * tax_adjustment - Validation failed: Order can't be blank (ActiveRecord::RecordInvalid)\n       * customer_return_without_return_items - Validation failed: Return items can't be blank (ActiveRecord::RecordInvalid)\n       * image - No such file or directory @ rb_sysopen - /Users/travis/.rbenv/versions/2.2.3/lib/ruby/gems/2.2.0/gems/solidus_core-1.1.0/spec/fixtures/thinking-cat.jpg (Errno::ENOENT)\n       * refund - Validation failed: Amount is greater than the allowed amount. (ActiveRecord::RecordInvalid)\n       * base_shipping_method - Validation failed: Calculator can't be blank (ActiveRecord::RecordInvalid)\n       * stock_packer - undefined method `save!' for #<Spree::Stock::Packer:0x007feff84d6378> (NoMethodError)\n       * stock_package - undefined method `save!' for #<Spree::Stock::Package:0x007fefdd080320> (NoMethodError)\n       * stock_package_fulfilled - undefined method `save!' for #<Spree::Stock::Package:0x007feff84ae490> (NoMethodError)\n       * stock_item - Validation failed: Variant has already been taken (ActiveRecord::RecordInvalid)\n       * stock_movement - Validation failed: Variant has already been taken (ActiveRecord::RecordInvalid)\n       * stock_transfer_with_items - Validation failed: Code has already been taken (ActiveRecord::RecordInvalid)\n       * receivable_stock_transfer_with_items - Validation failed: Code has already been taken (ActiveRecord::RecordInvalid)\n       * store_credit_event - PG::NotNullViolation: ERROR:  null value in column \"action\" violates not-null constraint\n       DETAIL:  Failing row contains (4, 2, null, 100.00, 0.00, 2-SC-20140602164814476128, null, null, null, 2015-12-17 03:38:31.335739, 2015-12-17 03:38:31.335739, null).\n       : INSERT INTO \"spree_store_credit_events\" (\"store_credit_id\", \"amount\", \"authorization_code\", \"created_at\", \"updated_at\") VALUES ($1, $2, $3, $4, $5) RETURNING \"id\" (ActiveRecord::StatementInvalid)\n       * global_zone - Validation failed: Name has already been taken (ActiveRecord::RecordInvalid)\nOne or two of them look like expected errors, and a couple are only conflicts when multiple factories are run (although it would be nice if uniqueness wasn't violated in that case). A number of the others look like actually invalid factories.\n. @cbrunsdon In this particular case, this is a new Solidus store (not migrated from Spree). Our use case is somewhat unusual because we will be creating shipments, and tracking inventory, but the shipping method (and shipping address) are determined after checkout. Our approach of assigning some particular shipment that indicates an \"undefined\" method might be fine, but it does seem that skipping the delivery step could imply skipping the assignment of a shipment (and trying to calculate a shipping rate) altogether.\nHowever, we were also considering Solidus for a different use case that involved digital, non-physical goods. I imagine the fact that remove_checkout_step :delivery does not work without additional effort would be a pain point for anyone trying to use Solidus to sell goods that don't have shipments, although it's certainly possible. Googling brings up a number of people who have had this use case in Spree (but were able to get it to work in older version so spree just with the remove_checkout_step).\n. I wasn't aware of the translation overhaul. Without that it would probably be worth doing an audit of the translations to see what might be missing, but it's probably not worth it at this point. Thanks and closing this issue.\n. ",
    "AlessioRocco": "Working on it! . @bbuchalter for now I'm working on a good way to break the specs or notify the developer if we have some \"bad\" or not tested factories, for now I've just added the linter https://github.com/solidusio/solidus/pull/1976/commits/670c105807bcfc5388679fbe7c6860c6e537adf5 at the beginning of our test suite but more I understand about Factory in Solidus and more I think it's not a good solution, this is a duplication of what we do with a working factory shared example, basically the linter just try to create a factory and raise an error if it's fail, we do the same with this code https://github.com/solidusio/solidus/blob/master/core/spec/support/concerns/working_factories.rb#L7. A better way maybe could be to understand what factories are tested and then in some way notify the developer if there are some factories that aren't tested, currently I'm working on it.\nAbout your thoughts on \"FactoryGirl may not be the right tool\" I understand your point of view and I agree, for now I think that for mimic the store behavior we could use the method that Solidus give to us in the Factory as much as possible, for example the line_items created by :order_with_totals factory https://github.com/TommyJohnWear/solidus/blob/e3b043815e694f669b45947930049e99ab38fe40/core/lib/spree/testing_support/factories/order_factory.rb#L22-L30 could be changed by OrderContents#add method by create a Variant and then #add it to the order, I understand that the problem is that #add doesn't accept the price for the line_item, maybe we can add it as an extra option for the #add method. This way to proceed could also help us thinking about our API and improve it.\n\n@mamhoff I think that some factories are invalid just because the linter was run two or more times, for example the : stock_transfer factory work if you run the linter just one time but fail if you run it two time, in my PR I've changed it a little https://github.com/solidusio/solidus/pull/1976/commits/138d6561ff16dfac42bffd1cdd49bf9b4942a9d7 by adding a sequence, I did it just for this and I'm not sure that it's needed. . I've update this PR with a new match policy feature and the suggestions coming from @jhawthorn, @jasonfb and @cbrunsdon, in details:\n- Use preference to store role_ids\n- Update the specs like @jhawthorn suggested\n- Add the match policy preference so a user can choose if all roles or only any of it must match.\n- Fix the select2 fields when the rule was added the first time (I can see this bug also on other rules, I'll do a PR to fix it).\n- Add better translations\n. @jhawthorn @peterberkenbosch rebased and fixed the hound offences.\n. ",
    "mgharbik": "I just noticed that when creating new taxons, they don't get the right parent_id, but taxonomy_id (it worked for me only for first taxonomies of sample data whose ids are the same).\nI changed the js files that taxonomy_id is not really needed, otherwise I find it must work if we force to assign the parent_id in the api by removing the unless statement. \n. At the moment we don't use large trees with thousand entries, but we deal with transactions that create or update up to 600 trees at one time. awesome_nested_set goes really very slow here, moreover it may perform better than closure_tree in reading.\nI think the switch is not invasive since both gems have in common many methods that spree uses. I found closure_tree doesn't have any function which moves a node according to its position, so I did override the move_to_child_with_index method of  awesome_nested_set.\nThe only thing is I must remove the  acts_as_nested_set method call in the original Spree::Taxon model. Is there anyway to do that?\nIndeed, we didn't collaborate with spree before, so we don't know if using an  extension this way is actually the best solution to this problem or there is a better way to do so. Any advise or help will be really appreciated!\nThanks,\n. Thanks for the feedback, I just sent a PR with closure_tree. \nPS. It complains an error in the api while in development doesn't.\n. Hi @cbrunsdon, I am working on some benchmarks, I'll get back to you as soon as possible.\n. Hi again,\nAt some points, we were thinking maybe we would make tests for trees which are large (heigh number of nodes in each parent) as well as the profound ones (heigh number of levels). But I guess the stores would never have profound trees, so we skipped this case. Moreover, we tried also Adjacency List Structure that it would give good results since it does not have any extra table, neither there is no need to calculate lft and rgt.\nThe following results are all made under a 27_931 nodes tree, 4 levels and each parent produces 30 nodes.\n1. Generating the tree:\n```\n################## AWESOME NESTED SET\nuser     system      total        real\nGenerating the tree   341.430000  12.840000 354.270000 (765.117659) 12.75196098333333 min\n################## CLOSURE TREE\nuser     system      total        real\nGenerating the tree   249.890000   9.390000 259.280000 (367.055578) 6.11759296666667 min\n################## Adjacency List\nuser     system      total        real\nGenerating the tree   691.820000  10.810000 702.630000 (900.876022) 15.01460036666667 min\n```\nWhile generating the whole tree, we see that closure tree is a clear winner.\n1. Displaying the whole tree:\n```\n############### AWESOME NESTED SET\nuser     system      total        real\nDisplaying tree  15.830000   0.620000  16.450000 ( 17.845013)\n############### CLOSURE TREE\nuser     system      total        real\nDisplaying tree  20.530000   0.640000  21.170000 ( 22.585553)\n############### Adjacency List\nuser     system      total        real\nDisplaying tree  39.620000   0.830000  40.450000 ( 42.714692)\n```\nAs jstree was removed and now it must render the whole tree at once, we find this case is very significant. The winner here is nested set but closure tree still not bad. adjacency list takes almost double time.\n1. Inserting a new taxon:\n```\n############### AWESOME NESTED SET\nuser     system      total        real\nInserting taxon  0.070000   0.000000   0.070000 (  0.118796)\n############### CLOSURE TREE\nuser     system      total        real\nInserting taxon  0.090000   0.020000   0.110000 (  0.133249)\n############### Adjacency List\nuser     system      total        real\nInserting taxon  0.090000   0.010000   0.100000 (  0.109642)\n```\nHere the insertion is made in root at left. We took the average of 10 insertions approximately. \n1. Move a taxon\n```\n############# AWESOME NESTED SET\nuser     system      total        real\nMoving a taxon  0.080000   0.010000   0.090000 (  1.653846)\n############# CLOSURE TREE\nuser     system      total        real\nMoving a taxon  0.120000   0.020000   0.140000 (  0.199836)\n############# Adjacency List\nuser     system      total        real\nMoving a taxon  0.100000   0.010000   0.110000 (  0.203947)\n```\nHere we move the root's last descendant to the first child of root in the left. Average of 10 tries approximately.\n1. Remove a taxon\n```\n############# AWESOME NESTED SET\nuser     system      total        real\nRemoving a taxon  1.020000   0.060000   1.080000 (  3.554831)\n############# CLOSURE TREE\nuser     system      total        real\nRemoving a taxon  0.090000   0.020000   0.110000 (  0.125421)\n############# Adjacency List\nuser     system      total        real\nRemoving a taxon  0.080000   0.010000   0.090000 (  0.101363)\n```\nHere we remove the first root child. Average of 10 deletions approximately.\nComparing the last 3 operations Insert/Move/Remove, nested set is slow in moving nodes and even slower in deleting. adjacency list is more effective in these operations but it is very slow when displaying the tree. In general, it seems to be closure tree performs better in these kind of trees, but we would like to hear your feedbacks about this issue. If you have any doubts please let us know!\nWith kind regards,\n. @tvdeyen I didn't measure the templates rendering because I assumed that for solidus, the whole tree is retrieved once. As far as I understand it must work similar in both cases since all is done by the api controller, is it correct?\n. @cbrunsdon @jhawthorn Thanks for the fixes. It works perfect now, as well as the template rendering responds faster than before.\n. @jasonfb Sorry for the confusion! normally when we clone a product we got the following slugs:\n- original product: apache-baseball-jersey\n- cloned product: apache-baseball-jersey-26fff430-9ee0-4dad-909a-af15329d77ad\nI meant by \"generalize the slug\" (maybe the verb or expression is not appropriate), just generate the uuid code in both, so the slugs would be for example:\n- original product: apache-baseball-jersey-a877c085-1943-41f6-a778-75240f94bcce\n- cloned product: apache-baseball-jersey-26fff430-9ee0-4dad-909a-af15329d77ad\nWith kind regards,\n. I confirm I have this issue with solidus_globalizeactivated. I also believe there is an issue with the gem, I tried to install it in a new project but it gives:\n/Users/my-machine/.rvm/gems/ruby-2.2.1/bundler/gems/solidus_globalize-02ed2c1d3937/app/models/spree/store_decorator.rb:3:in `block in <module:Spree>': undefined method `translates' for Store:Module (NoMethodError)\nWithout solidus_globalize the error is raised only if the product is cloned twice.\n. @mamhoff I just sent you another PR. Thank you too for the tips!\n. @tvdeyen sorry for the late replay! Please check it now!. @joelind Thanks for explaining it better, this is exactly what I meant. I sent a PR for it in case #1353 \n. It's strange, you're right Spree.ajax supposes to do it.\nDoing this must reach the problem:\n- create promotion\n- add a rule of type User\n- select some users and save\n- reload the edit promotion page\n- can't load the users selected before\nI pass a screeshot\n. you're welcome! I pushed a new commit changing all the specs where the [] syntax appears. Sorry for these detected tabs, I modified the file in a console text editor and some lines were not aligned properly.\n. @mamhoff you're right, not really overriding, it just follows the same logic as awesome_nested_set, which is totally removed.\n. @mamhoff I fixed the corresponding tests. Here I ordered the taxons by permalink, avoiding a complex inner join into the hierarchy table, but if you have any other approach please let me know!\n. ",
    "rbngzlv": "Hi @cbrunsdon, good catch, I'm commenting in the issue https://github.com/solidusio/solidus/issues/626  for put together the two discussions.\nMy answer: https://github.com/solidusio/solidus/issues/626#issuecomment-170041545\n. Hi all, as @cbrunsdon said, my pull request is related to this issue.\nIn our case, we are skipping the delivery step of the checkout process because we are selling non-physical goods that don't have shipments.\nI think that the problem is confirming the order in the checkout process, because actually is possible to bypass the delivery step, so as I commented in the pull request I think that this is a regression because in the previous versions  we only need remove_checkout_step :delivery in a decorator to skip the delivery step, without additional effort.\nI copy here my comment in the pull request:\n\nThe commit https://github.com/solidusio/solidus/commit/7ba53b2c0c9a33140f299e04541834d6fbf9ccb1#diff-2c3e70899d4f22d0569021b01b0e307f added a before_transition to complete that checks the shipping rates, but if the delivery step is not present, the order doesn't have shipments.\n\nAlso, @cbrunsdon made a comment in the pull request that is interesting (https://github.com/solidusio/solidus/pull/572#issuecomment-162980755). The resume is: What about the stores selling physical and non-physical goods?.\nI answer here for put together the two discussions:\nWe have a store selling physical and non-physical goods, and the \"solution\" that we use is to not skip the delivery step and have one ShippingCategory named Digital that only have one ShippingMethod named Digital delivery with cost zero. So in the delivery step we can have packages where the user can choice the delivery method (UPS 24h, DHL ...) and other package containing all non-physical goods where the user can not select the delivery method (we have a hidden input field with the only delivery method available, the free digital delivery).\nPerhaps, we can do two steps?\n- First, merge the pull request (if all is ok) to fix the regression and allow the stores selling non-physical goods to skip the delivery step.\n- Second, open a new issue for search the best way to make this step optional, allowing the stores to sell physical and non-physical goods, and have the checkout with or without delivery step.\nMention me if I can help in some manner.\n. Done!. Done!. Reverted the translation change.. @tvdeyen Rebased on master and changed Spree.t(:key) to I18n.t('spree.key'). @tvdeyen rebased on master. More than three months have passed, is something blocking this small PR from being merged?\n. @kennyadsl and @tvdeyen I'm doing a friendly reminder about this PR. . @kennyadsl Done!. ",
    "exsuzme": "Thanks Clarke. @graygilmore what say you? Can my HTML classes pass through the pearly gates of Solidusio and find peace in the rolling hills of the return authorization table?\n. @graygilmore @jhawthorn @cbrunsdon done! \n. Whoops, got them all now.\n. ",
    "LyesBe": "In fact, I had Spree 3.0 installed and it was the cause of the compatibility issues. Also, I didn't change the names of the dependencies. Putting \"solidus_foo\" instead of \"spree_foo\" solved the rest of the issues.\nThank you for your answer, it was helpful. :)\n. ",
    "Scalechange": "It's clear from the comments that the frontend should be framework agnostic. If a choice was made, my choice would be bootstrap as it has very good implementation and support for responsive sites, but I guess the problem is that pre 3.0 spree users prefer what they built with and post 3.0 prefer bootstrap, so the logical solution is to make spree an engine with separate front end frameworks being developed by the respective supporters of each framework. Or put it to a vote.\n. ",
    "erikaxel": "Since we are collecting cents, here are 2:  (for the backend only)\nI think the backend really should be implemented with the help from one of the big frameworks. I have used Bootstrap, but any framework would really do. Two reasons:\n1) For developers: It considerably lessens the burden of extending and improving the backend for people new to Solidus. One of the things I used too much time on starting developing on Spree was to understand all the different custom solutions created at the Backend. All of the frameworks are better documented than Solidus backend, and probably always will be. \n2) For users: Our users loved when we migrated to Spree 3. Even though many things felt unfamiliar, the admin pages now worked across ALL devices/browsers and that made a big difference. This was especially true for mobile, and the users that do small fixes \"on the go\". I am not very happy about issues like \"this doesn't work on device X\", and I assume that most devs don't either. And since this problem is solved by several other frameworks already, it shouldn't be an issue that we need to tackle.\nI understand the history of the project and that the mega-commit was not the way, and that now is maybe not the time, but it feels like going forward with custom backend code might suffer from \"not invented here\"-syndrome.\nMaybe there is a way of integrating a framework piecewise (in parallell or after the other excellent backend fixes proposed?) Maybe start with using only the grid system from one of the big frameworks, or maybe just the CSS-reset, (ie just include the CSS as first include) or something similar? I do belive there must be a way of starting (and integrating!) this work without doing everything in one go. \n. A big :+1: \n@cbrunsdon Do you already have some of these PRs ready? Great if you can mention this issue when you post them so that we get a notice. I would love to hear more about the approaches you are considering.\nI have been thinking a little bit about how to do it with as small steps as possible, and have two thoughts:\n1) Use semantic SASS mixings on the existing skeleton tags.\nSomething like:\n.sixteen.column {\n @include make-md-column(12);\n}\nSince the old Skeleton is 16 columns, and Bootstrap has 12, we obviously will run into the same problems as  @graygilmore already mentioned, but maybe we then can fix those issues only where we need to in the first commit instead of changing all the HTML at once. \n2) Only include some parts of bootstrap by overriding the main include\nI have used this successfully in multiple projects, such as one where we only wanted to use the grid and the reset. \nYou might already have discussed these options, but I haven't found anywhere where it is publicly discussed. Looking forward to hear your thoughts on the different approaches you are considering.\n. Ups, my bad. The migration was there, but the price.set_default_price method still fails. Will investigate further and reopen if necessary.\n. @graygilmore Very valid point. I have made some small changes to make it blend more in. \nNow it looks like this:\n\n. ",
    "jakemumu": "Hey guys, if solidus isn't using bootstrap for it's responsive css, what is it using? my default solidus app is acting responsively, so just curious what's up there.\nThanks!\n. @Senjai sorry to bring an old thread back to life, but if users aren't meant to filter products by property than how are we meant to customize our products for filtering beyond things such as price & size?\nIs it possible for the Solidus team to post an example to this issue somewhere? I've been banging my head against the wall trying to filter by multiple properties at once.\nEssentially, I'm not sure what \"add their own model associated with products to act as a profile of sorts with proper normalization.\" entails.\nThanks,\nJ. ",
    "jgujgu": "@jakemumu skeleton right now\nhttps://github.com/solidusio/solidus/blob/master/frontend%2Fapp%2Fassets%2Fstylesheets%2Fspree%2Ffrontend.css#L4\n. Great catch...I was going to figure out a good way to do this myself, except less good. When I am beaten to the punch, it is usually because of another Asian guy in glasses.\n. ",
    "dt1973": "Personally I think we should worry less about front-ends and instead leave that up to each individual developer:\nhttp://motherfuckingwebsite.com/\n. We can't lock Sprockets forever. Please see https://github.com/fnando/i18n-js/issues/381 -- was this the commit @PikachuEXE was referring to at the end? https://github.com/fnando/i18n-js/commit/f5dcfac7721938b3f5440e81565c79bd48b6aa09\n. I understand. Thanks for your response!\n. I've written a reply in the spark-starter-kit issue. Thanks.\nOn Tue, Apr 5, 2016 at 4:37 PM, Thomas von Deyen notifications@github.com\nwrote:\n\n@dt1973 https://github.com/dt1973 I absolutely agree with @mradfaber\nhttps://github.com/mradfaber here, although the comment spark-solutions/spark-starter-kit#21\n(comment)\nhttps://github.com/spark-solutions/spark-starter-kit/issues/21#issuecomment-204130890\nfrom @damianlegawiec https://github.com/damianlegawiec is not very\nhelpful as well and just not true\nhttp://solidus.io/blog/2015/11/19/ux-roadmap-for-the-admin-interface.html.\nBut that's his opinion and ok, IMO.\nLet me say loud and clear, we do not support behavior like this in the\nSolidus community.\nPlease stop this! Thanks\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/issues/1038#issuecomment-205836303\n. @mradfaber I see you closed the other issue hence my email reply never made it. Here's the response I wrote 2 days ago:\n\nThank you for entitling me to my own opinion. No, but seriously, I wasn't being any more disrespectful than @damianlegawiec. I was simply stating what I see as abuse of a project I once loved dearly, the hijacking of Spree's good name and reputation in order to gain consumer confidence in Spark Solutions, making it seem at first glance to potential new customers like it was Spark Solutions that created Spree. Although a brilliant business tactic, I just don't see it as fair to those who actually created Spree.\nMight I also add that I find the accusations that I was attacking @damianlegawiec on a personal level and being xenophobic absolutely ridiculous. Not that it's anybody's business, but I've studied in Poland, had Polish girlfriends and currently have many Polish co-workers. I also don't appreciate you attacking my adulthood and threatening to have me banned from GitHub. I was just trying to help in the first place by offering to replace Spree with Solidus.\nThanks.\ncc: @mamhoff @tvdeyen @radar, @schof, @joneslee85, @BDQ, @cmar, @LBRapid, @paulcc, @davidnorth, @romul, @JDUtil, @huoxito, @danabrit, @devilcoders, @peterberkenbosch, @GeekOnCoffee, @stephskardal, @parndt\n. ",
    "yeonhoyoon": "@cbrunsdon :+1: \n. This is a very important concern for our team, and I assume it is the same for others as well.\n. :+1: \n. @cbrunsdon thanks, starting to dip my toe in solidus.\n. :sunglasses: \n. @mamhoff sure, squashed them.\n. @mamhoff @jhawthorn \nYou're right, I didn't look into the definition of ShippingMethod.calculators and thought it was just getting it from the database. Calculators were not loading in the new shipping method page, so I thought this might have been the cause.. maybe it was because I loaded the spree sample without a restart.\nThanks for taking the time to check the pull request & making a comment.\n. In case it might help anyone in the future, it was the problem with the IDE I was using(IntelliJ). I had both my app and solidus's code in the same project, and the ruby environment was loading duplicate classes into object space.. so Spree::Calculator::Shipping::FlatRate < Spree::ShippingCalculator was returning false. I removed the solidus code from the project and it worked.\n. ",
    "bradwbradw": "i'm not sure about removing Stock::Prioritizer entirely, since there's lots of documentation out there that says that we should override sort_packages with our own business logic based on geography, logistics, minimum thresholds and what-not.  At minimum I'd suggest to at least keep sort_packages should anyone want to override it. thanks for the quick fix @gmacdougall !. thanks for the quick fix @gmacdougall !. ",
    "tka": "try to lock sprockets-rails version\nref. https://github.com/solidusio/solidus/commit/5988804b30805419e42d116a17746e0c22842ee4\n. ",
    "edenisn": "Thanks @tka \n. ",
    "krishnasrihari": "bundle update works\n. ",
    "jstewsy": "bundle update worked for me as well.\n. ^ second that\n. ",
    "isantoshsingh": "bundle update worked for me too\n. ",
    "davidpatters0n": "also worked for me too. Maybe worth adding to the documentation maybe. \n. @cbrunsdon -  I have ran into this issue, I have been given an existing project that was maintained by someone else for whom I cannot get in contact with. But am running into the same issue as detailed above. The steps that I have taken are as followed: \n1)  bundle install\n2)  bundle exec rake db:create\n3)  bundle exec rake db:migrate\n4)  bundle exec rake db:seed # At which point it fails here. \nGemfile\n``` ruby\nsource 'https://rubygems.org'\nruby '2.1.2'\nBundle edge Rails instead: gem 'rails', github: 'rails/rails'\ngem 'rails', '4.2.3'\nUse postgresql as the database for Active Record\ngem 'pg'\ngem 'haml'\ngem 'erb2haml'\ngem 'rails_12factor', group: :production\ngem 'foundation-rails'\ngem 'devise'\nUse SCSS for stylesheets\ngem 'sass-rails', '~> 5.0'\nUse Uglifier as compressor for JavaScript assets\ngem 'uglifier', '>= 1.3.0'\nUse CoffeeScript for .coffee assets and views\ngem 'coffee-rails', '~> 4.1.0'\nSee https://github.com/rails/execjs#readme for more supported runtimes\ngem 'therubyracer', platforms: :ruby\ngem 'foundation-icons-sass-rails'\nUse jquery as the JavaScript library\ngem 'jquery-rails'\nBuild JSON APIs with ease. Read more: https://github.com/rails/jbuilder\ngem 'jbuilder', '~> 2.0'\nbundle exec rake doc:rails generates the API under doc/api.\ngem 'sdoc', '~> 0.4.0', group: :doc\ngem 'nested_form_fields'\ngem 'paperclip', '~> 4.1'\ngem 'aws-sdk', '< 2.0'\nUse ActiveModel has_secure_password\ngem 'bcrypt', '~> 3.1.7'\nUse Unicorn as the app server\ngem 'unicorn'\nUse Capistrano for deployment\ngem 'capistrano-rails', group: :development\ngroup :development, :test do\n  # Call 'byebug' anywhere in the code to stop execution and get a debugger console\n  gem 'byebug'\n  gem 'pry'\n  # Access an IRB console on exception pages or by using <%= console %> in views\n  gem 'web-console', '~> 2.0'\n# Spring speeds up development by keeping your application running in the background. Read more: https://github.com/rails/spring\n  gem 'spring'\nend\ngem 'spree', '3.0.1'\ngem 'spree_gateway', github: 'spree/spree_gateway', branch: '3-0-stable'\ngem 'spree_auth_devise', github: 'spree/spree_auth_devise', branch: '3-0-stable'\n```\nconfig/initalizers/spree.rb\n``` ruby\nSpree.config do |config|\n  # Example:\n  # Uncomment to stop tracking inventory levels in the application\n  # config.track_inventory_levels = false\nend\nSpree.user_class = \"Spree::User\"\n```\n``` ruby\nclass User < ActiveRecord::Base\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, :timeoutable and :omniauthable\n  devise :database_authenticatable, :registerable,\n    :recoverable, :rememberable, :trackable, :validatable\n  has_one :parameters\n  accepts_nested_attributes_for :parameters, :allow_destroy => true\n  has_many :materials, through: :parameters\n  accepts_nested_attributes_for :parameters, :allow_destroy => true\n  enum type: [:roofer, :supplier, :disposal]\nhas_attached_file :business_logo, :styles => { :medium => \"300x300>\", :thumb => \"100x100#\" }, :default_url => \"/images/no-image.png\"\n  validates_attachment_content_type :business_logo, :content_type => /\\Aimage\\/.*\\Z/\nvalidates :name, presence: true\n  validates :business_name, presence: true\n  validates :business_address, presence: true\n  validates :service_range, presence: true, numericality: {only_integer: true, greater_than: 0}\nend\n```\nDavids-MacBook-Pro-2:Xyz davidpatterson$ bundle exec rake db:seed\nloading ruby /Users/davidpatterson/.rbenv/versions/2.1.2/lib/ruby/gems/2.1.0/gems/spree_core-3.0.1/db/default/spree/countries.rb\nloading ruby /Users/davidpatterson/.rbenv/versions/2.1.2/lib/ruby/gems/2.1.0/gems/spree_core-3.0.1/db/default/spree/roles.rb\nloading ruby /Users/davidpatterson/.rbenv/versions/2.1.2/lib/ruby/gems/2.1.0/gems/spree_core-3.0.1/db/default/spree/states.rb\nloading ruby /Users/davidpatterson/.rbenv/versions/2.1.2/lib/ruby/gems/2.1.0/gems/spree_core-3.0.1/db/default/spree/stores.rb\nloading ruby /Users/davidpatterson/.rbenv/versions/2.1.2/lib/ruby/gems/2.1.0/gems/spree_core-3.0.1/db/default/spree/zones.rb\nloading ruby /Users/davidpatterson/.rbenv/versions/2.1.2/lib/ruby/gems/2.1.0/bundler/gems/spree_auth_devise-7b24ad162393/db/default/users.rb\nCreate the admin user (press enter for defaults).\nEmail [spree@example.com]:\nPassword [spree123]:\nrake aborted!\nNoMethodError: undefined method `spree_api_key=' for #<Spree::User:0x007fd3a606f0a0>\n/Users/davidpatterson/Code/xyz/db/seeds.rb:11:in `<top (required)>'\nTasks: TOP => db:load_dir\nNot entirely sure what I could be missing, but i have also come across this similar issue: https://github.com/spree/spree/issues/4463 and this does not apply am i missing something and more does my Gemfile look correct? \n. Will do thanks for the response. \n. @gmacdougall as you may see in this discussion I reported the following issue spree_api_key using Spree. Now i decided to scrap my app and start again fresh using Solidus. All was working well up until I added devise into my app. I followed the instructions on devise and installed as so. As part of the set up of devise you're told to run rails generate devise MODEL which will create the model along with the additional modules applied inside it. My problem is still as explained above but now using Solidus. \nMy issue arise when I try to do the rake db:seed and after pressing enter and manually entering a password\nCreate the admin user (press enter for defaults).\nEmail [admin@example.com]:\nPassword [test123]:\nrake aborted!\nNoMethodError: undefined method `spree_api_key=' for #<Spree::User:0x007fbbac3e2258>\n/Users/davidpatterson/Code/xyz/db/seeds.rb:11:in `<top (required)>'\nTasks: TOP => db:load_dir\n(See full trace by running task with --trace)\nThe above tells me that I don't have the setter spree_api_key, however here the migration is in the core\nDetail about my app\nGemfile\n```\nsource 'https://rubygems.org'\ngem 'solidus'\ngem 'solidus_auth_devise'\nBundle edge Rails instead: gem 'rails', github: 'rails/rails'\ngem 'rails', '4.2.4'\nUse sqlite3 as the database for Active Record\ngem 'sqlite3'\ngem 'pg'\ngem 'sass-rails', '~> 5.0'\ngem 'uglifier', '>= 1.3.0'\ngem 'coffee-rails', '~> 4.1.0'\ngem 'jquery-rails'\ngem 'turbolinks'\ngem 'jbuilder', '~> 2.0'\ngem 'sdoc', '~> 0.4.0', group: :doc\ngem \"font-awesome-rails\"\ngem 'devise'\ngem 'solidus'\ngem 'solidus_auth_devise'\ngroup :development, :test do\n  gem 'pry-rails'\nend\ngroup :development do\n  gem 'web-console', '~> 2.0'\n  gem 'spring'\nend\n```\napp/model/user.rb\n``` ruby\nclass User < ActiveRecord::Base\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, :timeoutable and :omniauthable\n  devise :database_authenticatable, :registerable,\n         :recoverable, :rememberable, :trackable, :validatable\nhas_one :parameters, foreign_key: 'company_id'\n  accepts_nested_attributes_for :parameters, allow_destroy: true\nhas_many :materials, through: :parameters\n  belongs_to :role\nend\n```\ndb/seeds.rb\n``` ruby\nSpree::Core::Engine.load_seed if defined?(Spree::Core)\nSpree::Auth::Engine.load_seed if defined?(Spree::Auth)\n%w(roofer supplier disposal).each do |role|\n  Role.find_or_create_by({name: role})\nend\n```\nConfig/intializers/spree.rb\n``` ruby\nSpree.config do |config|\n  config.use_static_preferences!\n  config.currency = \"USD\"\n  config.mails_from = \"store@example.com\"\nend\nSpree.user_class = \"Spree::LegacyUser\"\n```\nNote that in my gemfile i have\ngem 'devise'\ngem 'solidus'\ngem 'solidus_auth_devise'\nAdditionally I looked at this issue\nfrom Spree repo and as quoted\n\nThat's indicating it was trying to use Spree::User not your User model.\n\nand further says: I'm guessing that you're trying to mix using spree_auth_devise with using your own user class instead\nAnother thing that I noticed is by default config/initializers/spree.rb the Spree.user_class = \"Spree::LegacyUser\" is this right? Either way I tried changing that value so it was Spree.user_class = Spree::User and re-ran the rake db:create. rake db:migrate, rake db:seed and still no luck :disappointed: \nPlease LMK if i can provide any more information that will support my issue. Thank you. \n. To cut a long story short the way I've gone about getting around this is simply if you want to use devise and solidus_auth_devise you cannot and i repeat cannot have a user model. No if buts or maybes this just causes conflicts and headaches. So my suggestion for anyone who come across the same error as I did, is simply create a model that named anything else but User. I say this because I tried multiple as shown below: \n1. Remove solidus_auth_devise which was suggested in spree so thought lets try that. \n2. Change the value of Spree.user_class = Spree::LegacyUser to  Spree.user_class = \"User\"\n3. Remove the solidus_auth_devise and comment out Spree::Auth::Engine.load_seed if defined?(Spree::Auth) from the seeds file as suggested by this comment\nand none of these above worked. Just don't create a user simple\n. Thanks for the feedback @jasonfb \n. ",
    "gregblass": "Bundle update isn't doing the trick for me...\n. ",
    "olivierlacan": "@gregblass and others, don't try to update or lock sprockets. You need to change your configuration syntax to pass a block according to @rafaelfranca:\nruby\nRails.application.config.assets.configure do |env|\n  env.register_engine('.slim', Slim::Template)\nend\nhttps://github.com/rails/sprockets-rails/issues/292#issuecomment-165894932\nMight be relevant to @magnusvk.\n. ",
    "Samira64": "bundle update worked for me too. bundle update worked for me too. ",
    "ashwin47": "Same here.\n. ",
    "lexuszhi1990": "i got the same error here. I create a new rails app, and add \ngem 'solidus'\ngem 'solidus_auth_devise'\nto gemfile, then bundle install, run bundle exec rails g spree:install, then got this error:\n/.rbenv/versions/2.2.1/lib/ruby/gems/2.2.0/gems/handlebars_assets-0.22.0/lib/handlebars_assets.rb:20:in `block in register_extensions': undefined method `register_engine' for nil:NilClass (NoMethodError)\n    from /Users/david/.rbenv/versions/2.2.1/lib/ruby/gems/2.2.0/gems/handlebars_assets-0.22.0/lib/handlebars_assets.rb:19:in `each'\nhere is my gemfile.lock\n```\nGemfile.lock\nGEM\n  remote: https://rubygems.org/\n  specs:\n    actionmailer (4.2.2)\n      actionpack (= 4.2.2)\n      actionview (= 4.2.2)\n      activejob (= 4.2.2)\n      mail (~> 2.5, >= 2.5.4)\n      rails-dom-testing (~> 1.0, >= 1.0.5)\n    actionpack (4.2.2)\n      actionview (= 4.2.2)\n      activesupport (= 4.2.2)\n      rack (~> 1.6)\n      rack-test (~> 0.6.2)\n      rails-dom-testing (~> 1.0, >= 1.0.5)\n      rails-html-sanitizer (~> 1.0, >= 1.0.1)\n    actionview (4.2.2)\n      activesupport (= 4.2.2)\n      builder (~> 3.1)\n      erubis (~> 2.7.0)\n      rails-dom-testing (~> 1.0, >= 1.0.5)\n      rails-html-sanitizer (~> 1.0, >= 1.0.1)\n    activejob (4.2.2)\n      activesupport (= 4.2.2)\n      globalid (>= 0.3.0)\n    activemerchant (1.48.0)\n      activesupport (>= 3.2.14, < 5.0.0)\n      builder (>= 2.1.2, < 4.0.0)\n      i18n (>= 0.6.9)\n      nokogiri (~> 1.4)\n    activemodel (4.2.2)\n      activesupport (= 4.2.2)\n      builder (~> 3.1)\n    activerecord (4.2.2)\n      activemodel (= 4.2.2)\n      activesupport (= 4.2.2)\n      arel (~> 6.0)\n    activesupport (4.2.2)\n      i18n (~> 0.7)\n      json (~> 1.7, >= 1.7.7)\n      minitest (~> 5.1)\n      thread_safe (~> 0.3, >= 0.3.4)\n      tzinfo (~> 1.1)\n    acts_as_list (0.7.2)\n      activerecord (>= 3.0)\n    addressable (2.4.0)\n    arel (6.0.3)\n    awesome_nested_set (3.0.2)\n      activerecord (>= 4.0.0, < 5)\n    bcrypt (3.1.10)\n    binding_of_caller (0.7.2)\n      debug_inspector (>= 0.0.1)\n    bourbon (4.2.6)\n      sass (~> 3.4)\n      thor (~> 0.19)\n    builder (3.2.2)\n    byebug (8.2.1)\n    camertron-eprun (1.1.0)\n    cancancan (1.13.1)\n    canonical-rails (0.0.11)\n      rails (>= 3.1, < 5.0)\n    carmen (1.0.2)\n      activesupport (>= 3.0.0)\n    cldr-plurals-runtime-rb (1.0.1)\n    climate_control (0.0.3)\n      activesupport (>= 3.0)\n    cocaine (0.5.8)\n      climate_control (>= 0.0.3, < 1.0)\n    coffee-rails (4.1.1)\n      coffee-script (>= 2.2.0)\n      railties (>= 4.0.0, < 5.1.x)\n    coffee-script (2.4.1)\n      coffee-script-source\n      execjs\n    coffee-script-source (1.10.0)\n    colorize (0.7.7)\n    concurrent-ruby (1.0.0)\n    css_parser (1.3.7)\n      addressable\n    debug_inspector (0.0.2)\n    deface (1.0.2)\n      colorize (>= 0.5.8)\n      nokogiri (~> 1.6.0)\n      polyglot\n      rails (>= 3.1)\n    devise (3.5.3)\n      bcrypt (~> 3.0)\n      orm_adapter (~> 0.1)\n      railties (>= 3.2.6, < 5)\n      responders\n      thread_safe (~> 0.1)\n      warden (~> 1.2.3)\n    devise-encryptable (0.1.2)\n      devise (>= 2.1.0)\n    erubis (2.7.0)\n    execjs (2.6.0)\n    ffaker (1.32.1)\n    font-awesome-rails (4.5.0.0)\n      railties (>= 3.2, < 5.0)\n    friendly_id (5.0.5)\n      activerecord (>= 4.0.0)\n    globalid (0.3.6)\n      activesupport (>= 4.1.0)\n    handlebars_assets (0.22.0)\n      execjs (~> 2.0)\n      multi_json (~> 1.0)\n      sprockets (>= 2.0.0, < 4.0)\n      tilt (~> 1.2)\n    highline (1.6.21)\n    htmlentities (4.3.4)\n    i18n (0.7.0)\n    jbuilder (2.3.2)\n      activesupport (>= 3.0.0, < 5)\n      multi_json (~> 1.2)\n    jquery-rails (4.0.5)\n      rails-dom-testing (~> 1.0)\n      railties (>= 4.2.0)\n      thor (>= 0.14, < 2.0)\n    jquery-ui-rails (5.0.5)\n      railties (>= 3.2.16)\n    json (1.8.3)\n    kaminari (0.16.3)\n      actionpack (>= 3.0.0)\n      activesupport (>= 3.0.0)\n    loofah (2.0.3)\n      nokogiri (>= 1.5.9)\n    mail (2.6.3)\n      mime-types (>= 1.16, < 3)\n    mime-types (2.99)\n    mini_portile2 (2.0.0)\n    minitest (5.8.3)\n    monetize (1.3.1)\n      money (~> 6.6)\n    money (6.6.1)\n      i18n (>= 0.6.4, <= 0.7.0)\n    multi_json (1.11.2)\n    nokogiri (1.6.7.1)\n      mini_portile2 (~> 2.0.0.rc2)\n    orm_adapter (0.5.0)\n    paperclip (4.2.4)\n      activemodel (>= 3.2.0)\n      activesupport (>= 3.2.0)\n      cocaine (~> 0.5.5)\n      mime-types\n    paranoia (2.1.4)\n      activerecord (~> 4.0)\n    polyamorous (1.3.0)\n      activerecord (>= 3.0)\n    polyglot (0.3.5)\n    premailer (1.8.6)\n      css_parser (>= 1.3.6)\n      htmlentities (>= 4.0.0)\n    premailer-rails (1.8.2)\n      actionmailer (>= 3, < 5)\n      premailer (~> 1.7, >= 1.7.9)\n    rabl (0.11.7)\n      activesupport (>= 2.3.14)\n    rack (1.6.4)\n    rack-test (0.6.3)\n      rack (>= 1.0)\n    rails (4.2.2)\n      actionmailer (= 4.2.2)\n      actionpack (= 4.2.2)\n      actionview (= 4.2.2)\n      activejob (= 4.2.2)\n      activemodel (= 4.2.2)\n      activerecord (= 4.2.2)\n      activesupport (= 4.2.2)\n      bundler (>= 1.3.0, < 2.0)\n      railties (= 4.2.2)\n      sprockets-rails\n    rails-deprecated_sanitizer (1.0.3)\n      activesupport (>= 4.2.0.alpha)\n    rails-dom-testing (1.0.7)\n      activesupport (>= 4.2.0.beta, < 5.0)\n      nokogiri (~> 1.6.0)\n      rails-deprecated_sanitizer (>= 1.0.1)\n    rails-html-sanitizer (1.0.2)\n      loofah (~> 2.0)\n    railties (4.2.2)\n      actionpack (= 4.2.2)\n      activesupport (= 4.2.2)\n      rake (>= 0.8.7)\n      thor (>= 0.18.1, < 2.0)\n    rake (10.4.2)\n    ransack (1.6.6)\n      actionpack (>= 3.0)\n      activerecord (>= 3.0)\n      activesupport (>= 3.0)\n      i18n\n      polyamorous (~> 1.2)\n    rdoc (4.2.0)\n    responders (2.1.1)\n      railties (>= 4.2.0, < 5.1)\n    sass (3.4.20)\n    sass-rails (5.0.4)\n      railties (>= 4.0.0, < 5.0)\n      sass (~> 3.1)\n      sprockets (>= 2.8, < 4.0)\n      sprockets-rails (>= 2.0, < 4.0)\n      tilt (>= 1.1, < 3)\n    sdoc (0.4.1)\n      json (~> 1.7, >= 1.7.7)\n      rdoc (~> 4.0)\n    select2-rails (3.5.9.1)\n      thor (~> 0.14)\n    solidus (1.1.0)\n      solidus_api (= 1.1.0)\n      solidus_backend (= 1.1.0)\n      solidus_core (= 1.1.0)\n      solidus_frontend (= 1.1.0)\n      solidus_sample (= 1.1.0)\n    solidus_api (1.1.0)\n      rabl (>= 0.9.4.pre1, < 0.12.0)\n      solidus_core (= 1.1.0)\n      versioncake (~> 2.3.1)\n    solidus_auth_devise (1.2.3)\n      deface (~> 1.0.0)\n      devise (~> 3.5.1)\n      devise-encryptable (= 0.1.2)\n      json\n      multi_json\n      solidus_core (>= 1.1.0.alpha, < 2)\n    solidus_backend (1.1.0)\n      bourbon\n      handlebars_assets\n      jquery-rails\n      jquery-ui-rails (~> 5.0.0)\n      select2-rails (= 3.5.9.1)\n      solidus_api (= 1.1.0)\n      solidus_core (= 1.1.0)\n    solidus_core (1.1.0)\n      activemerchant (~> 1.48.0)\n      acts_as_list (~> 0.3)\n      awesome_nested_set (~> 3.0.1)\n      cancancan (~> 1.10)\n      carmen (~> 1.0.0)\n      deface (~> 1.0.0)\n      ffaker (~> 1.16)\n      font-awesome-rails (~> 4.0)\n      friendly_id (~> 5.0.4)\n      highline (~> 1.6.18)\n      json (~> 1.7)\n      kaminari (~> 0.15, >= 0.15.1)\n      monetize (~> 1.1)\n      paperclip (~> 4.2.0)\n      paranoia (~> 2.1.0)\n      premailer-rails\n      rails (~> 4.2.0)\n      ransack (~> 1.6.0)\n      responders\n      state_machines-activerecord (~> 0.2)\n      stringex (~> 1.5.1)\n      truncate_html (= 0.9.2)\n      twitter_cldr (~> 3.0)\n    solidus_frontend (1.1.0)\n      canonical-rails (~> 0.0.4)\n      jquery-rails\n      solidus_api (= 1.1.0)\n      solidus_core (= 1.1.0)\n    solidus_sample (1.1.0)\n      solidus_core (= 1.1.0)\n    spring (1.6.0)\n    sprockets (3.5.2)\n      concurrent-ruby (~> 1.0)\n      rack (> 1, < 3)\n    sprockets-rails (3.0.0)\n      actionpack (>= 4.0)\n      activesupport (>= 4.0)\n      sprockets (>= 3.0.0)\n    sqlite3 (1.3.11)\n    state_machines (0.4.0)\n    state_machines-activemodel (0.3.0)\n      activemodel (~> 4.1)\n      state_machines (>= 0.4.0)\n    state_machines-activerecord (0.3.0)\n      activerecord (~> 4.1)\n      state_machines-activemodel (>= 0.3.0)\n    stringex (1.5.1)\n    thor (0.19.1)\n    thread_safe (0.3.5)\n    tilt (1.4.1)\n    truncate_html (0.9.2)\n    turbolinks (2.5.3)\n      coffee-rails\n    twitter_cldr (3.2.1)\n      camertron-eprun\n      cldr-plurals-runtime-rb (~> 1.0.0)\n      json\n      tzinfo\n    tzinfo (1.2.2)\n      thread_safe (~> 0.1)\n    uglifier (2.7.2)\n      execjs (>= 0.3.0)\n      json (>= 1.8.0)\n    versioncake (2.3.1)\n      actionpack (>= 3.2)\n      activesupport (>= 3.2)\n      railties (>= 3.2)\n      tzinfo\n    warden (1.2.4)\n      rack (>= 1.0)\n    web-console (2.2.1)\n      activemodel (>= 4.0)\n      binding_of_caller (>= 0.7.2)\n      railties (>= 4.0)\n      sprockets-rails (>= 2.0, < 4.0)\nPLATFORMS\n  ruby\nDEPENDENCIES\n  byebug\n  coffee-rails (~> 4.1.0)\n  jbuilder (~> 2.0)\n  jquery-rails\n  rails (= 4.2.2)\n  sass-rails (~> 5.0)\n  sdoc (~> 0.4.0)\n  solidus\n  solidus_auth_devise\n  spring\n  sqlite3\n  turbolinks\n  uglifier (>= 1.3.0)\n  web-console (~> 2.0)\n```\n. ",
    "samanmohamadi": "This is a known bug with handlebars-assets gem, which is resolved in master.\nAdding the line :\ngem 'handlebars_assets', github: 'leshill/handlebars_assets'\nto your Gemfile will solve your problem until a new version contains the relevant fix.\nhttp://stackoverflow.com/questions/34379554/solidus-installation-failure\n. there is a presumption about default checkout flow in other places which makes difficult to customize checkout flow.\n```\napp/models/spree/order/checkout.rb\nbefore_transition to: :confirm, do: :add_store_credit_payments\n```\n```\napp/controllers/spree/checkout_controller.rb\ndef update\n...\nsuccess = if @order.state == 'confirm'\n       @order.complete\n    else\n        @order.next\n    end\n...\nend\n``\n. If I use another step between delivery and payment, I don't need confirm state after payment any more because it doesn't make sense to ask for confirmation after money was captured.\nAnother issue is thatconfirmation_required?` is deprecated and I must remove it in checkout flow which probably cause consequence problems.\n. #757 \n. Thank You for answer.\n. ",
    "dividedharmony": "Working on it!. This didn't have the Solidus Hackathon label, but I thought it was simple enough, so I put in PR #1965 if this issue is still relevant. @jordan-brough Good point. I can add a validation such that OptionValuesVariants are unique within the scope of any given product.. @jhawthorn Thanks for pointing that out! I've switched back over to the Bootstrap way of doing things.. If the shipping costs are taxed, is there a good way to display that information on this interface?. Yes, that's much cleaner. I'll make that change now. ",
    "stabenfeldt": "Hi,\nTried again from latest master. Only 1 failing here:\n``` ruby\n\n\nSetup Spree Backend and running RSpec...\n\n\nSwitching Gemfile...\nRandomized with seed 26756\n..................................................................................F  HTML screenshot: file:///Users/martins/Work/MyShop/solidus/backend/spec/dummy/tmp/capybara/screenshot_2015-12-21-17-52-1\n4.763.html\n  Image screenshot: file:///Users/martins/Work/MyShop/solidus/backend/spec/dummy/tmp/capybara/screenshot_2015-12-21-17-52-14.763.png\n............................................................................................................................................................................................................\n..............................................................................................................................................\n.....................................................*............................................................................................................\nPending: (Failures listed here are expected and do not affect your suite's status)\n1) Order Details as Admin Shipment edit page splitting to location should warn you if you have not selected a location or shipment\n     # Not yet implemented\n     # ./spec/features/admin/orders/order_details_spec.rb:177\nFailures:\n1) Payments with a pre-existing payment lists and create payments for an order\n     Failure/Error: expect(find('#payment_status').text).to eq('PAID')\n   expected: \"PAID\"\n        got: \"BALANCE DUE\"\n\n   (compared using ==)\n # ./spec/features/admin/orders/payments_spec.rb:98:in `block (3 levels) in <top (required)>'\n\nFinished in 10 minutes 19 seconds (files took 4.63 seconds to load)\n591 examples, 1 failure, 1 pending\nFailed examples:\nrspec ./spec/features/admin/orders/payments_spec.rb:75 # Payments with a pre-existing payment lists and create payments for an order\n```\n\nCorresponding .html file\nCheers,\nMartin\n. @jhawthorn No worries! I'm pleasantly surprised by how quick you guys respond and patch bugs. Overall a positive experience reporting this bug. :+1: :wink: \n. closing as I debug more myself.\n. By bad, I had spelled initializers wrong. The guide works. \nAt least if you specify 1.5.7 for aws-sdk.\nGemfile\ngem 'aws-sdk', '~> 1.5.7' # Amazon Web Sevices for attachments (Must be at this version for paperclip support, not v2)\n. @saroar: Try right clicking with the mose on a Taxon. That will open a menu. It is not possible to click the right arrow. I tried that first too. :-)\n\n. @saroar BTW, you can add screenshots directly to the issue by drag and drop.\n. It works locally in development mode with both v1.2 and master (88f2f9), but non of them works in production.\nThis happens when I click the \"Add taxon\" button on the top right on admin/taxonomies/5/edit:\nChrome console\n\n^ No error messages here.\nheroku logs -t\n2016-01-27T14:29:22.477532+00:00 heroku[router]: at=info method=POST path=\"/api/taxonomies/5/taxons\" host=my-beta.herokuapp.com request_id=e95122b8-6482-4310-96bf-a1df781fde5b fwd=\"84.215.77.255\" dyno=\nweb.1 connect=0ms service=62ms status=201 bytes=1231\n2016-01-27T14:29:22.399995+00:00 app[web.1]: Started POST \"/api/taxonomies/5/taxons\" for 84.215.77.255 at 2016-01-27 14:29:22 +0000\nMore stack trace gist\n. Hi,\nI still have the same problem here. :-(\n. @tvdeyen Please reopen. :-)\n. @manoharkshetty: The problem disappeared when I upgraded to latest version of the master branch.\n. Strange, I ran rake railties:install:migrations without bundle exec. Then it copied a few more migrations.\nbash\n$ rake railties:install:migrations\nRunning via Spring preloader in process 3918\nCopied migration 20160202210323_add_api_key_to_spree_users.spree_api.rb from spree_api\nCopied migration 20160202210324_resize_api_key_field.spree_api.rb from spree_api\nCopied migration 20160202210325_rename_api_key_to_spree_api_key.spree_api.rb from spree_api\nCopied migration 20160202210326_add_index_to_user_spree_api_key.spree_api.rb from spree_api\nCopied migration 20160202210327_create_users.solidus_auth.rb from solidus_auth\nCopied migration 20160202210328_rename_columns_for_devise.solidus_auth.rb from solidus_auth\nCopied migration 20160202210329_convert_user_remember_field.solidus_auth.rb from solidus_auth\nCopied migration 20160202210330_add_reset_password_sent_at_to_spree_users.solidus_auth.rb from solidus_auth\nCopied migration 20160202210331_make_users_email_index_unique.solidus_auth.rb from solidus_auth\nCopied migration 20160202210332_add_deleted_at_to_users.solidus_auth.rb from solidus_auth\nCopied migration 20160202210333_add_confirmable_to_users.solidus_auth.rb from solidus_auth\nThanks @Senjai :+1: \n. I could not find the migration that is supposed to add deleted_at to users either:\n``` bash\n$ ls db/migrate/user | xargs ack deleted_at  # Nothing\n$ ls db/migrate/user | xargs ack time\ndb/migrate/20160202194922_add_timestamps_to_spree_roles_users.spree.rb\n5:    add_column :spree_roles_users, :created_at, :datetime\n6:    add_column :spree_roles_users, :updated_at, :datetime\ndb/migrate/20160202194927_create_spree_user_stock_locations.spree.rb\n7:      t.timestamps null: true\ndb/migrate/20160202194968_add_spree_user_addresses.spree.rb\n9:      t.timestamps null: false\ndb/migrate/20160202194969_add_id_and_timestamp_to_promotion_rule_user.spree.rb\n5:    add_column :spree_promotion_rules_users, :created_at, :datetime\n6:    add_column :spree_promotion_rules_users, :updated_at, :datetime\n``\n. I did however find https://github.com/spree/spree_auth_devise/blob/master/db/migrate/20140904000425_add_deleted_at_to_users.rb, but that migration is not located in mydb/migrate. Got the missing gems by runningrake railties:install:migrations. @jhawthorn Awesome, thanks for fixing the issue so quickly! :-)\n. I couldn't find the deface gem in my Gemfile, but it was installed globally on my machine.\nAfter adding it to Gemfile and running bundle, thenrake deface` tasks started to behave as expected.\nThanks for letting me know about the gem. :-)\n. ",
    "blacktea3937": "thank you @cbrunsdon, I actually test the Spree_marketplace at Spree_drop_ship on Spree. I can't say they run very smoothly. Quite some bugs. Spree_marketplace is only workable on Spree 2.3, not even 2.4. \nIf @dhonig can make it compatible with Solidus, that will be great! I believe there will be a good interest for this extension with Solidus!\nthank you @dhonig and @cbrunsdon!\n. Hi @dhonig I also tried to integrate the Spree_marketplace and Spree_drop_ship with Solidus, here are what I found:\n1) It seems Spree_drop_ship can be integrated by doing some modifications at .Gemspec file. Only issue I found is: \"WARN  DurableDecorator: Spree::Shipment#after_ship decoration uses an invalid SHA. The original method definition could have been tampered with!\"\n2) While integrating Spree_marketplace seems causing some issues with the database (after modifying .Gemspec file too): \"SQLite3::SQLException: no such column: spree_payment_methods.environment:\"\nWonder whether you have any findings?\nthanks!\n. ",
    "AknEp": "Hi @mtomov,\nI found https://github.com/boomerdigital/solidus_marketplace\nbut It seems to be in progress.\n. ",
    "usmanasif": "Any update upon this extension @solidus_marketplace\n. ",
    "Blackening999": "I strongly suggest to add a Troubleshooting section to README or consider hotfixes automatically merge to the master. \nI've installed raw solidus gem (not bleeding edge pointing to github repo) and it's 1.1.0. The issue still the same.\nI've lost 1 hour to find out the solution for that :\\\nThank you\n. ",
    "sairam": "@jhawthorn Let me know if you'd want me to add any specific tests. I am trying to get familiar with the codebase.\n. ",
    "dfranciosi": "Neat :gem: :+1: \n. @connecticus considering that solidus_globalize has globalize as a dependency, that PR will solve our problems. We should ask globalize maintainers to merge it /cc @jhawthorn @tvdeyen @caesarsol @alepore\n. I can confirm that it doesn't work yet\ncould not connect to server: No such file or directory (PG::ConnectionBad)\n    Is the server running locally and accepting\n    connections on Unix domain socket \"/var/run/postgresql/.s.PGSQL.5432\"?\n. @gmacdougall done \ud83d\ude09 \n. @gmacdougall good catch, anyway we have tons of data-hook in this partial and around the codebase too, do you think it's purpose of this PR to remove this one in particular?\n. @gmacdougall Ok, perfectly fine with me, I'm going to add a commit.\n. ",
    "JohnMorales": "I agree that the LICENSE and README files would need to be hand reviewed. Possibly simply excluded. from a mass rename. \n@tvdeyen in reference to squashing the commits, I was concerned that making code changes and directory renames in a single commit would confuse git from keeping history across the renamed directory. That's why I did the directory rename separately, but I have no proof whether or not git can handle parent directory renames and file content changes without losing history.\nThat said this is a change that has to be done in a fell swoop, as it will get stale fairly quickly and really cannot co-exist with other branches. Therefore, I suggest we take the lessons learned, but the whole exercise should be redone when we're ready to actually pull the trigger.\n. yeah np, I understand why it makes sense to hold off, just keep in mind that it's almost never a good time to do something like this..\nFrom someone that is considering using Solidus after building a prototype in Spree, I'd rather have a large change like this done before starting a new project.\n. ",
    "mttc1": "Hi @jhawthorn, in general is good practice have the prefix Spree::, for example the line bellow included that, and yes I have an issue when I try to override this method.\nThanks. \n. Hi @jhawthorn, in general is good practice have the prefix Spree::, for example the line bellow included that, and yes I have an issue when I try to override this method.\nThanks. \n. ",
    "sanchojaf": "Sorry the last comment was mine, using other user\n. Thanks @cbrunsdon for your feedback. I updated the pull request. Thanks.\n. ",
    "bcrunsdon": "Seems reasonable to me :+1: \n. ",
    "krtschmr": "ruby 2.1.6 / 2.2.2\nrails 4.2.4 / 4.2.5\n. ruby 2.1.6 / 2.2.2\nrails 4.2.4 / 4.2.5\n. solidus 1.0.3 is working (but somehow i tagged gemfile with v1.0 but got 1.03)\n. solidus 1.0.3 is working (but somehow i tagged gemfile with v1.0 but got 1.03)\n. i've added to Gemfile and bundle update\ngem 'solidus'\ngem 'solidus_auth_devise'\njust ran rake to still have green tests, so i'm all good to run.\ni run bundle exec rails g spree:install\nwhich gives following output\n\n  create  config/initializers/spree.rb\n  append  public/robots.txt\n  create  vendor/assets/javascripts/spree/frontend\n  create  vendor/assets/javascripts/spree/backend\n  create  vendor/assets/stylesheets/spree/frontend\n  create  vendor/assets/stylesheets/spree/backend\n   exist  vendor/assets/images/spree/frontend\n   exist  vendor/assets/images/spree/backend\n  create  vendor/assets/javascripts/spree/frontend/all.js\n  create  vendor/assets/stylesheets/spree/frontend/all.css\n  create  vendor/assets/javascripts/spree/backend/all.js\n  create  vendor/assets/stylesheets/spree/backend/all.css\n   exist  app/overrides\n  append  db/seeds.rb\n copying  migrations\ncreating  database\n    rake  db:create\n\nDatabase 'project_rails5_development' already exists\nDatabase 'projectr_rails5_test' already exists\n     running  migrations\n        rake  db:migrate VERBOSE=false\ngenerating cartons\n(1ms)\nlinking inventory units to cartons\n(1ms)\n     loading  seed data\n        rake  db:seed \n\"create 8 user\"\nrake aborted!\nNameError: undefined local variable or method `spree' for #\n\n\n. i've added to Gemfile and bundle update\ngem 'solidus'\ngem 'solidus_auth_devise'\njust ran rake to still have green tests, so i'm all good to run.\ni run bundle exec rails g spree:install\nwhich gives following output\n\n  create  config/initializers/spree.rb\n  append  public/robots.txt\n  create  vendor/assets/javascripts/spree/frontend\n  create  vendor/assets/javascripts/spree/backend\n  create  vendor/assets/stylesheets/spree/frontend\n  create  vendor/assets/stylesheets/spree/backend\n   exist  vendor/assets/images/spree/frontend\n   exist  vendor/assets/images/spree/backend\n  create  vendor/assets/javascripts/spree/frontend/all.js\n  create  vendor/assets/stylesheets/spree/frontend/all.css\n  create  vendor/assets/javascripts/spree/backend/all.js\n  create  vendor/assets/stylesheets/spree/backend/all.css\n   exist  app/overrides\n  append  db/seeds.rb\n copying  migrations\ncreating  database\n    rake  db:create\n\nDatabase 'project_rails5_development' already exists\nDatabase 'projectr_rails5_test' already exists\n     running  migrations\n        rake  db:migrate VERBOSE=false\ngenerating cartons\n(1ms)\nlinking inventory units to cartons\n(1ms)\n     loading  seed data\n        rake  db:seed \n\"create 8 user\"\nrake aborted!\nNameError: undefined local variable or method `spree' for #\n\n\n. nevermind. it seems that it's loading my seed.rb and then the error occurs. propably because all custom User stuff isn't done yet. cough.. nevermind. it seems that it's loading my seed.rb and then the error occurs. propably because all custom User stuff isn't done yet. cough.. ",
    "CoralineAda": ":+1: \n. @gmacdougall \n1) Since when is a diversity and inclusivity statement political?\n2) Codes of conduct need to be in place before an incident arises.\n3) Not all harassment is illegal or against ToS.\n. @BenMorganIO I suggest closing this issue to all but project maintainers now that Elia and meh are here. They're bad players from the opal gate nonsense.\n. @BenMorganIO It's disappointing to see that some Stembolt employees don't feel the same way. We'll see how this turns out.\n. ",
    "elia": ":-1: \n@gmacdougall is right, even many pro-CoC people agrees with him that's political:\n\n\n\n. @kennyadsl @jacobherrington ready for a review! \ud83c\udf89. \ud83d\udce3 status update\nFor anyone interested in the status of this PR, we're testing it on some real projects in order to make the transition to ActiveStorage as smooth as possible. \nThe tests we've conducted so far are generally positive, but there are some rough edges and minor problems I need to address before considering it ready for merging.. @dankmitchell, @peterberkenbosch that's great! \ud83d\ude4c\nPlease report here anything that comes up, any suggestion on how to improve is very appreciated, even minor tweaks in communication via deprecation/warning messages. We want this to be as easy as possible for everyone \ud83c\udfc4\u200d\u2642\ufe0f. > @elia the last 2 commits could be rebased / rewritten? Not sure what snapshot means :)\nSorry for the confusion, they're a couple of quick fixes I pushed while trying this branch on a project. \nThey're meant as WIP, I'll absolutely streamline them and add proper testing before this is greenlighted for a merge \u2705. I've fixed the internal SVG size and padding and updated the description with before/after screenshots.. This is relevant doc from Rails: https://guides.rubyonrails.org/engines.html#a-note-on-decorators-and-loading-code\nNot sure if this habit came first on Rails or on Spree, but it might be good to adhere to whatever standard Rails has (except for extremely good reasons).. @kennyadsl the merit goes to @bitberryru, also noting that those aren't actual decorators. I agree that article should be linked in the docs. Maybe would be good to fix Rails docs too, if we come up with a good proposal.. > After revisiting the conversation I think we should support Ruby 2.2.2+ as that is what Rails 5 supports.\n\ud83d\udc4d Closing then, can be easily reopened if the decision is revised.\nOne last thing I'd like to mention is that Rails 6 will require 2.5+, going from 2.2 to 2.3 seems to me a reasonable requirement in exchange for a bunch of language features. It  doesn't sound likely for a project to be able to upgrade to the latest solidus and being \"stuck\" on 2.2. \nMy last 2\u00a2 anyway \ud83d\ude04.. It's probably worth deprecating it in v2.7.x and keep the removal from master, there's no risk of leaving the deprecation there forever. A good place for the script could be bin/circleci-halt-for-doc-only-changes or .circleci/halt-for-doc-only-changes and move everything inside it. That way what it does should be self-evident and well contained.. It's fine, for single letter options you're allowed to keep the argument attached to the option. But I'll change them to their expanded version because it's more understandable for the casual reader.. I think it would be better to use a simple callable instead of a class that responds to #call and pass options directly to call, also a constant would be more straightforward than a method:\n```suggestion\n  deprecated_code_handler = StopWithError\n  # deprecated_code_handler = DoNothing\n  # deprecated_code_handler = MoveToSpreePromotionCode\n  deprecated_code_handler.call(self, promotions_with_code)\n\n```\nand then below:\n```rb\nPlease note that this will block the current migration and rollback all\nthe previous ones run with the same \"rails db:migrate\" command.\nStopWithError = ->(migration, promotions) {\n  raise StandardError, \"You are trying to drop 'code' column from \"\\\n    \"spree_promotions table but you have at least one record with that \"\\\n    \"column filled. Please take care of that or you could lose data. See:\" \\\n    \"\\n\" \\\n    \"https://github.com/solidusio/solidus/pull/3028\"\\\n    \"\\n\"\n}\n```\nThis is much simpler and has the advantage of having the configuration near the error location, making it easier to find. will wait for https://github.com/solidusio/solidus/pull/3070 to be merged before fixing this \ud83d\ude42. Thanks, this always trips me up \ud83d\ude04. This module is included by both AS implementations (Image and Taxon) and is an extraction of repeated code. The call between extracting/DRYing and leaving the duplication was, admittedly, close. But in the end I ended up refactoring in order to avoid the risk of leaving one of the two behind when fixing stuff.. I can do that, but used this way there's no risk of incurring in the problem described in #2572 (at least I don't see it). The problem there was using the class keyword on an autoloaded constant with different superclass declaration.\nSometimes it was class A < B, sometimes class A, depending on load-order if the second form was loaded first it would result in an error (the other way around works because you can omit the superclass when reopening a class).\nLet me know if the change is still needed \ud83d\udc4d . The spree.rb template is for new apps and makes sense not suggesting Paperclip, but shouldn't we advertise support here for legacy apps, at least until it's phased out?. ActiveStorage is available on Rails 5.2+, instead of using a complex if with checks on the versions rails/all already takes care of requiring everything you get the current Rails version. Further checks are then just based on defined? ActiveStorage.\nLet me know if it needs a separate commit \ud83d\udc4d . It's later extracted into def redefine_attachment_writer_with_legacy_io_support, if that's not enogh I can add commets to both the original and the extracted version, let me know \ud83d\udc4d . It will autoload Spree::Image and then if it's the configured module will go back and load itself. \nThat said I tried to load it by itself but I didn't succeed, so I don't think that's an issue, do you have any specific case in mind?. I tried to stick to how it's done within AS, I think it will probably need to be revised once Rails 5.1 support is dropped. thanks good catch!. ",
    "krainboltgreene": "I won't contribute without a COC.\n. @wstucco Because I can't trust a contributor list that doesn't have the same level of standards for their community as rubygems.\n\nthis stuff as issues\n\nIt's not an Issue, this is a Pull Request. For a file. Into the repository.\n. @wstucco Would you be OK with a library that didn't have tests? A project with no roadmap?\n. Then there's no problem having them written down...unless you think there\nhave been zero issues in the Ruby community?\nOn Jan 4, 2016 6:16 PM, \"Massimo Ronca\" notifications@github.com wrote:\n\n@krainboltgreene https://github.com/krainboltgreene\nI could\u2026\nit depends\nBut that's not my point, my point is that people need a framework of trust\nwhen trust is not to be expected, if we already trust each other, why do we\nneed a framework of trust?\n@BenMorganIO https://github.com/BenMorganIO\nI think the ruby community takes a lot of value in being inviting and open\nIn my experience, it already did before Cocs where implemented\nIn my opinion it's because people in the community are welcoming, not\nbecause of rules\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/solidusio/solidus/pull/643#issuecomment-168872841.\n. \n",
    "meh": "I won't contribute with a COC.\n. @CoralineAda hey, so are you :panda_face: \n. ",
    "jeremyw": "A COC harms no one. :+1: to welcoming a diverse community.\n. @Mandily Oddly they are showing different timestamps...\n. Fixes #1350 \n. See #1350. The issue is not the API key but the params.\n. I think I fixed the root cause of this issue here: https://github.com/solidusio/solidus/pull/1349\n. ",
    "wstucco": "@krainboltgreene \n\nI won't contribute without a COC.\n\nhonestly: why?\n@CoralineAda \nHave you ever considered that there is someone on this planet that won't consider having or not having a COC an issue? (no pun intended! I swear!)   \nI'm not a member of solidus community, but I'm an Opal user, and I think we should respect the decision of those that don't want to discuss this stuff as issues, they probably see issues as a way to signal a bug, a missing feature, a way to do things better, not for this.\nThey made a decision and probably they know someone won't contribute because of that, and they accept the risk.\nEvery decision they take will make someone in the community happy, piss off someone else but most of the users won't even notice the difference.\n. @krainboltgreene\nI understand that, but why?\naren't they trustworthy already?   \n\nIt's not an Issue, this is a Pull Request. For a file. Into the repository.\n\nsame reasoning applies.   \nI'll stop here, didn't want to intrude, I'm just curious about this Coc thing, it can polarize the discussion in a way I don't see very productive, but that's just my opinion.\n. @krainboltgreene\nI could\u2026 \nit depends \nBut that's not my point, my point is that people need a framework of trust when trust is not to be expected, if we already trust each other, why do we need a framework of trust?   \n@BenMorganIO \n\nI think the ruby community takes a lot of value in being inviting and open\n\nIn my experience, it already did before Cocs where implemented \nIn my opinion it's because people in the community are welcoming, not because of rules \n. @krainboltgreene \nexactly!\nI have no reason to oppose, it's not my project\nI just don't think that projects that don't have \"them written down\" are less trustworthy, until proven otherwise    \n@BenMorganIO \nlicensing is a very different topic\nlicenses are enforced by law, Cocs are not \n. ",
    "mowings": "I won't contribute unless someone buys me waffles.\n. ",
    "j1696788": "I think that a lot of people or supportive of the code of conduct in itself but are very wary of the methods and the resulting atmosphere.\nhttps://twitter.com/CoralineAda/status/684143225519472640\nIt's been 2 days, the discussion is ongoing and the the process is very civil, people are expressing opinions and arguing in a respectful manner and @CoralineAda is calling out Solidus publicly and associating it with Opal/Opalgate.\nHow is this not bullying? How is this professional? Why do need to publicly people who politely disagrees with you?\nYou know very well that this will leads to the usual mobbing of both supporters and detractors. It's always the same accounts who jump unto those kind of threads and extinguish any hopes of a productive discussion. You're as much responsible for this as a project leader is responsible for the comments of the core members.\nPeople would be a lot more supportive of those issues is it was possible to discuss them without being browbeaten into submission.\n. ",
    "tfaruq": "Thank you for the feedback!\n. ",
    "connecticus": "@BenMorganIO, Thank you. It is solidus_globalize-related issue I think. Just try to add any options in different products and look at the /admin/properties All properties does not reuse existing property name and adding a new one.\n. Thank you, guys, but I think nothing to discuss, it is globalize bug (w/o globalize Solidus  is working as well as Spree till 3.X).\nAnd Spree 3.X has had same issue - https://github.com/spree/spree/issues/6556\n. Thank you very much @cbrunsdon \n. Solution:: There's an issue with find_by_id and globalize. It's documented here: globalize/globalize#423\nIt creates a strange query \nSELECT \"spree_properties\".* FROM \"spree_properties\" INNER JOIN \"spree_property_translations\" ON \"spree_property_translations\".\"spree_property_id\" = \"spree_properties\".\"id\" \nWHERE \"spree_property_translations\".\"name\" = '--- !ruby/object:ActiveRecord::StatementCache::Substitute {}' \nAND \"spree_property_translations\".\"locale\" IN ('pt', 'en') LIMIT 1\nWe can just waived use find_by :name to workaround globalize/globalize#423 bug\ncore/app/models/concerns/spree/ordered_property_value_list.rb\nruby\ndef property_name=(name)\n  if name.present?\n    property = Property.where(name: name).first ||\n    Property.create(name: name, presentation: name)\n    self.property = property\n  end\nend\n. @jhawthorn, thank you, you're right, it's my fail because it is this solidus_globalize-related issue (as I said before). @tvdeyen I will try make PR in solidus_globalize, but straight way is described by @caesarsol i think.  \n@dfranciosi, what wrong with this PR?  https://github.com/globalize/globalize/pull/449\nWhat we can to do?\n. ",
    "caesarsol": "hello, i was about to patch solidus_globalize for that issue (with @dfranciosi), we will post our solution asap.\nis globalize unmanaged? \nthis PR from 6 months ago is still open...\nhttps://github.com/globalize/globalize/pull/449\n. ",
    "isaacfreeman": "Sounds great. I'm particularly keen on \"complete a task in one page\". Having product admin divided among multiple pages is a real source of confusion for clients.\n. That's cool. I also agree with @mamhoff's approach. My code started as minimal change for a single client, but his is better architecture for Solidus in general.\nI'm not so sure about keeping a single large private method, inasmuch as when I subclass the coordinator I'll still need to duplicate a lot of code for the sake of inserting a single line in a query. But I appreciate the argument that private methods shouldn't be considered extension points, and I can see the value in explicitly declaring a coordinator_class instead of just providing hooks for monkey patching.\nI'll close this and submit another PR along the suggested lines.\n. @jhawthorn: Sure. Can you point me to any existing documentation I can use as a model?\n. @mtomov: Thanks! Agree on all your points. In particular, you're right about the show method \u2013 I was too quick to assume I couldn't do it for backward compatibility reasons, but of course you're right that it's not a problem.\nHow would you feel about simply using BaseReport as a parent class name rather than Reporter? It's closer to the domain object as understood by users, and the :base: prefix is used elsewhere in Solidus for similar purposes.\nAlso, would it be more convenient to continue with this PR, or close it while I follow up and open a new one later?\n. @mtomov: Dossier looks good, but as you say it's an extra dependency, and I'd rather not add dependencies to the main Solidus distribution. However, if we go ahead with #1262 and move reports to their own spree_reports gem, I'd feel a lot more comfortable adding dependencies to that. We'd know then that people are opting in to using the reports, and we wouldn't be adding the dependency for people who'll never use it.\n. Agree completely on all the form design guidelines.\nThe layouts also look good, but I'm a bit unclear on when we'd use the Helpful Layout and when we'd used the Sidebar Layout. Could we get a couple of examples for each of where they'd be used?\n. User testing FTW.\n. @jasonfb: Makes sense to me. While this was intended to be a minor patch, and I don't have a philosophical objection to soft-deleting, I do think the admin UI should be very clear about the state of the system. It makes sense that people should know when they're looking at a variant that's since been deleted.\nHow about I do the following?\n1. Show soft-deleted variants on a TransferItem in red text, as for deleted products in a search where Show Deleted has been checked.\n2. Add an additional brief text to clarify the situation: either \"This variant has since been deleted\" or \"This variant has since been replaced by another with the same SKU\" depending on the situation.\n3. Get @Mandily's input on the above as a short-term UX solution.\n4. Ask @Mandily to consider the wider question of how to portray deleted entities across Solidus, and possibly cover this in the style guide.\n. @Mandily: I don't mind extending the scope \u2013 UX is always relevant. I would like though, to keep this issue scoped to just the TransferItem page, with the understanding that a more holistic review of how deleted items are rendered across all admin pages would be a separate issue.\nSo revised plan for deleted variants on this one page:\n1. Lighter shade of text and strikethrough\n2. Tooltip icon with first line of text saying \"Variant deleted on [Date]\"\n3. Where relevant, an additional line of text saying \"This variant has since been replaced by another with the same SKU\"\n. It seems there's already a CSS class for deleted items in a table, so I'll stick with that.\nCurrently it looks like this:\n\nAnd hovered:\n\nStill some code to tidy up, but let me know if anyone wants changes.\n. OK, this is up to date with comments so far.\n. Well, I'm glad to hear that people like having the SKUs there, as making them visible was my first contribution to Spree! I originally intended the list of SKUs to be a temporary half-step, with the goal of eventually merging the variants table into the main product edit page. \nI certainly agree that a tooltip is the wrong UI component for this job. I do think though that we need something to keep long lists of variants under control, and I'm not very happy with the \"and N others\" solution I originally used for lists longer than five items. If it's valuable to see the SKUs (and have them rendered as links to the variants) then it's somewhat arbitrary to say you need to go to the variants page to see the sixth one.\nHow would people feel about using a collapse widget instead of a tooltip? The design would be similar to the existing one, with the addition that \"and N others\" would be clickable to reveal what those N other SKUs actually are. That would keep long lists under control, but keep the full list of SKUs a click away instead of making admins visit the variants page.\nOff the top of my head, I can't think of another place in Solidus admin that has a collapse widget, so \nthis would add a new UI element. On the other hand, this list of SKUs is already a bit of a departure.\nAlternatively, if the consensus is that \"and N others\" is sufficient and we don't need any changes, then I'm fine to close the issue. With proper UX work now being done, I'm confident that there's an end in sight to my original temporary solution.\n. OK, closing this.\n. I frequently type in \"spree123\", then have to go and look up what it is now. This would be a help for people like me whose muscle memory is better than their regular memory.\n. This is a big usability improvement from a small change. \ud83d\udc4d \nCould we provide some additional indication to users that clicking a radio button will reveal further controls? Most radio buttons don't do that, and the initial state has no controls to the right, so it might not be obvious. This could be as simple as adding an ellipsis ... after the labels for those radio buttons that bring up other fields.\nBeyond the scope of this pull request, I feel like these four radio buttons are conceptually closer to being Promotion Rules than attributes of the overall Promotion. They're all conditions under which the promotion will be activated. I appreciate that would entail a significant change to the code, but I wonder whether promotions would be easier to understand if we could push more features down into Rules.. \ud83d\udc4d \nI'd like to see master variants displayed to users throughout Solidus admin alongside regular variants. That is, instead of saying \"this is a product with no variants\", we should be saying \"this is a product with one variant \u2013 click here if you want to make another\". I appreciate the original intent was to avoid complexity for beginners, but I've worked on too many sites where clients and former devs had apparently never encountered the concept of a variant at all, and instead extended the product model in cumbersome ways. Variants aren't hard to understand, and the concept only has to be learnt once to forestall a lot of expensive re-writing later.\n\nSo... this is a positive step.\n. The value of a style guide isn't measured by how often it's referenced, but by how well it reduces friction everywhere else.. Having the \"Actions\" column label clarifies the purpose of the wordless action buttons. I think this is valuable, because the actions are typically pretty abstract and hard to capture in an icon. On many admin pages they're also used frequently, despite being small click targets. So anything that gives them some context could be a big help.\nIt might also be some small help to people using screen readers, but obviously there's much more to do there.. @Mandily: Good point that I'm conflating two different problems. If we were focusing on making the action buttons easy to understand, adding an \"Actions\" label at the top of the column isn't a solution I'd propose. And I don't have any particular data on users' experience with the action buttons, so it makes sense to treat that as a separate issue.. @jhawthorn: Yeah, I was in two minds about whether to submit this as an issue or a PR, but I figured we might as well start with some code.\nI'll have a look for such a repository. My suspicion is that there's more likely to be something that records full address formats in all their glorious complexity than something that focuses on the specific question of whether to include states or not. But we'll see.\nI'm happy to either leave this open for discussion, or close it and open an issue that links to it as one possible implementation we're not currently pursuing.. Thanks @mamhoff. I'll see what I can find there, and close this.. One spec not passing. Not sure why, but I'll investigate.. I've always found .present? a bit more readable, but I'm happy to match code style elsewhere in Solidus.\n. Good idea, will do.\n. I'm not sure if this list is intended to be complete yet, but I'd suggest adding\n- Product (including products, variants, taxonomies, properties, options and prices)\n- Promotion\n. \"Stock\" might be a better term than \"Inventory\", as it's what's used in the backend menu.\n. Spelling mistake here: \"province\".\n. Another typo here: \"position\" is missing an i.\nI'd also suggest using postal_code_position. While it's longer, it's the generic term and makes it a noun. Using just the adjective \"postal\" could cause confusion, as there are other concepts in Solidus that relate to postage.\n. Likewise here, postal_code_specified would be clearer.\n. Typo: \"This amount will be distributed\". Possibly clearer first sentence:\n\"This amount will be distributed between line items proportionally to their price.\". I think this sentence is redundant, but if we want to emphasise that this amount is the total, it should appear before the example.. ",
    "sahal8020": "I strongly advise the Solidus core team to have a centralized and public place for the roadmap. This way new people can instantly see where this is heading and also feel that this project has higher chances of longevity. It's even better if the community was allowed to add and vote on features so those votes can be used as one of the metrics for what to tackle next. \nSomething like Trello Voting Board or similar will do.\n. Not really. There were no links to it on the main page or website. I blame that on other github libraries which, when you click on their wiki tab, there's nothing there to be found :\\\n\nSolidus 1.1 should be released soon which will support upgrades from Spree 3.0\n\nI'm actually using Spree 3. Since Solidus 1.1 is out, does that mean it's ready? \n\nOne major difference is that Solidus doesn't include Spree 3.0's change to a bootstrap frontend and backend.\n\nHow can that issue be resolved? Is the situation better with Solidus 1.2?\n. ",
    "sullivanLi": "thank you all, solidus 1.1.1. fixed it\n. ",
    "saroar": "thanks for your quick reply what about this spree_mail_settings gem ?\n. https://github.com/spree-contrib/spree_mail_settings/issues/23\n. ok this this but very luck of documentation for customise and customise also very difficult but thanks \n. @gmacdougall i will give try standard ActionMailer configuration. thanks will update later \n. add gem 'turbolinks'  solve problem \n. TypeError in Spree::Home#index\nShowing /Users/alif/.gem/ruby/2.2.3/gems/solidus_frontend-1.1.1/app/views/spree/shared/_products.html.erb where line #31 raised:\nno implicit conversion of nil into String\n. how can i add default image this is problem when i don't upload default photo ?\n. yes i know what was the problem in spree was default image for every products but in Solidus don't have that features so when i am trying to post my products without image it give this error but if u upload image it work hope u will solve this bug in future :)\n. This is your error if u read \nno implicit conversion of nil into String\nso find where this Nil came from ,ur which attributes are should be string and u getting nil so u can write if else statement when that attirbutes will be nil u convert it string hope this will help you \n. When i click Add Taxon does not working some times \n{\"error\":\"You must specify an API key.\"}\nFailed to load resource: the server responded with a status of 404 (Not Found)\n. hope it will help \nhttp://prntscr.com/9t9gib\n. ",
    "softr8": "You're right, maybe Adjustment finalization is the way to go, I'll update the code and we'll see how it looks\n. On it. The problem happens when the product does not have Spree::Config.default_pricing_options.currency in its prices, not sure if the fix would be preventing users to update the currency in /admin/products/xyz/prices/xx/edit or add an extra flag to prices list specifying which one is the default, what do you think @mamhoff @jhawthorn ?. Try updating Solidus: https://github.com/solidusio/solidus/commit/03a48593b195d3f5e7b87f6cfd2818a5ef25375b. Done! I was unsure how to name the config variable, suggestions welcomed! . what do you think @gmacdougall ?. Done @mamhoff, let me know what you think now... Thanks!. Actually, the failing spec was a test that sometimes fails, I saw it red in other PR's. My guess is that a simple rebuild would've made it green.\nI didn't change default_price method at all, the reason I changed the form was because we have an external job that imports prices in bulk from a Google SpreadSheet, and if a variant didn't have any price yet, the variant edition was breaking, that's why I used find or build.. Actually, the failing spec was a test that sometimes fails, I saw it red in other PR's. My guess is that a simple rebuild would've made it green.\nI didn't change default_price method at all, the reason I changed the form was because we have an external job that imports prices in bulk from a Google SpreadSheet, and if a variant didn't have any price yet, the variant edition was breaking, that's why I used find or build.. Any comment @mamhoff ? I can rollback the view change if you feel it is not that safe.. Done! let me know if it still makes sense.\nThanks!. ",
    "chris-barklem": "I have just created a new build of the following:\nsource 'https://rubygems.org'\n```\nruby '2.3.1'\nBundle edge Rails instead: gem 'rails', github: 'rails/rails'\ngem 'rails', '4.2.6'\nUse postgresql as the database for Active Record\ngem 'pg', '~> 0.15'\nUse SCSS for stylesheets\ngem 'sass-rails', '~> 5.0'\nUse Uglifier as compressor for JavaScript assets\ngem 'uglifier', '>= 1.3.0'\nUse CoffeeScript for .coffee assets and views\ngem 'coffee-rails', '~> 4.1.0'\nImage uploding\ngem 'paperclip'\nUse jquery as the JavaScript library\ngem 'jquery-rails'\nTurbolinks makes following links in your web application faster. Read more: https://github.com/rails/turbolinks\ngem 'turbolinks'\nBuild JSON APIs with ease. Read more: https://github.com/rails/jbuilder\ngem 'jbuilder', '~> 2.0'\nbundle exec rake doc:rails generates the API under doc/api.\ngem 'sdoc', '~> 0.4.0', group: :doc\ngem 'solidus'\ngem 'solidus_auth_devise'\ngem 'solidus_i18n', '~> 1.0'\ngem 'solidus_globalize', github: 'solidusio-contrib/solidus_globalize', branch: 'master'\ngem 'solidus_product_description_editor', '~> 1.0', '>= 1.0.1'\ngem 'solidus_social', '~> 1.0'\ngroup :development, :test do\n  # Call 'byebug' anywhere in the code to stop execution and get a debugger console\n  gem 'byebug'\nend\ngroup :development do\n  # Access an IRB console on exception pages or by using <%= console %> in views\n  gem 'web-console', '~> 2.0'\n# Spring speeds up development by keeping your application running in the background. Read more: https://github.com/rails/spring\n  gem 'spring'\nend\ngroup :production do\n  # Heroku helper\n  gem 'rails_12factor'\n  # Image storage for heroku production\n  gem 'aws-sdk', '< 2.0'\nend\n```\nI have the same error:\n```\nRendered /Users/barklem/.rvm/gems/ruby-2.3.1/gems/solidus_frontend-1.2.2/app/views/spree/home/index.html.erb within spree/layouts/spree_application (1400.3ms)\nCompleted 500 Internal Server Error in 1885ms (ActiveRecord: 79.1ms)\nActionView::Template::Error (no implicit conversion of nil into String):\n    28:       \n    31:             <%= link_to image_tag(product.display_image.attachment(:small), itemprop: \"image\"), url, itemprop: 'url' %>\n    32:           \n    33:           <%= link_to truncate(product.name, length: 50), url, class: 'info', itemprop: \"name\", title: product.name %>\n    34:           \n```\n. I have just created a new build of the following:\nsource 'https://rubygems.org'\n```\nruby '2.3.1'\nBundle edge Rails instead: gem 'rails', github: 'rails/rails'\ngem 'rails', '4.2.6'\nUse postgresql as the database for Active Record\ngem 'pg', '~> 0.15'\nUse SCSS for stylesheets\ngem 'sass-rails', '~> 5.0'\nUse Uglifier as compressor for JavaScript assets\ngem 'uglifier', '>= 1.3.0'\nUse CoffeeScript for .coffee assets and views\ngem 'coffee-rails', '~> 4.1.0'\nImage uploding\ngem 'paperclip'\nUse jquery as the JavaScript library\ngem 'jquery-rails'\nTurbolinks makes following links in your web application faster. Read more: https://github.com/rails/turbolinks\ngem 'turbolinks'\nBuild JSON APIs with ease. Read more: https://github.com/rails/jbuilder\ngem 'jbuilder', '~> 2.0'\nbundle exec rake doc:rails generates the API under doc/api.\ngem 'sdoc', '~> 0.4.0', group: :doc\ngem 'solidus'\ngem 'solidus_auth_devise'\ngem 'solidus_i18n', '~> 1.0'\ngem 'solidus_globalize', github: 'solidusio-contrib/solidus_globalize', branch: 'master'\ngem 'solidus_product_description_editor', '~> 1.0', '>= 1.0.1'\ngem 'solidus_social', '~> 1.0'\ngroup :development, :test do\n  # Call 'byebug' anywhere in the code to stop execution and get a debugger console\n  gem 'byebug'\nend\ngroup :development do\n  # Access an IRB console on exception pages or by using <%= console %> in views\n  gem 'web-console', '~> 2.0'\n# Spring speeds up development by keeping your application running in the background. Read more: https://github.com/rails/spring\n  gem 'spring'\nend\ngroup :production do\n  # Heroku helper\n  gem 'rails_12factor'\n  # Image storage for heroku production\n  gem 'aws-sdk', '< 2.0'\nend\n```\nI have the same error:\n```\nRendered /Users/barklem/.rvm/gems/ruby-2.3.1/gems/solidus_frontend-1.2.2/app/views/spree/home/index.html.erb within spree/layouts/spree_application (1400.3ms)\nCompleted 500 Internal Server Error in 1885ms (ActiveRecord: 79.1ms)\nActionView::Template::Error (no implicit conversion of nil into String):\n    28:       \n    31:             <%= link_to image_tag(product.display_image.attachment(:small), itemprop: \"image\"), url, itemprop: 'url' %>\n    32:           \n    33:           <%= link_to truncate(product.name, length: 50), url, class: 'info', itemprop: \"name\", title: product.name %>\n    34:           \n```\n. I found the fix for me. I was using the settings from spree for aws:\n```\nattachment_config = {\ns3_credentials: {\n    access_key_id:     ENV['AWS_ACCESS_KEY_ID'],\n    secret_access_key: ENV['AWS_SECRET_ACCESS_KEY'],\n    bucket:            ENV['S3_BUCKET_NAME']\n  },\nstorage:        :s3,\n  s3_headers:     { \"Cache-Control\" => \"max-age=31557600\" },\n  s3_protocol:    \"https\",\n  bucket:         ENV['S3_BUCKET_NAME'],\n  url:            \":s3_domain_url\",\nstyles: {\n      mini:     \"48x48>\",\n      small:    \"100x100>\",\n      product:  \"240x240>\",\n      large:    \"600x600>\"\n  },\npath:           \"/:class/:id/:style/:basename.:extension\",\n  default_url:    \"/:class/:id/:style/:basename.:extension\",\n  default_style:  \"product\"\n}\nattachment_config.each do |key, value|\n  Spree::Image.attachment_definitions[:attachment][key.to_sym] = value\nend\n```\nThe issue was the default_url. Its should be:\ndefault_url:    'noimage/:style.png',\nNow everything is working as expected.\n. I found the fix for me. I was using the settings from spree for aws:\n```\nattachment_config = {\ns3_credentials: {\n    access_key_id:     ENV['AWS_ACCESS_KEY_ID'],\n    secret_access_key: ENV['AWS_SECRET_ACCESS_KEY'],\n    bucket:            ENV['S3_BUCKET_NAME']\n  },\nstorage:        :s3,\n  s3_headers:     { \"Cache-Control\" => \"max-age=31557600\" },\n  s3_protocol:    \"https\",\n  bucket:         ENV['S3_BUCKET_NAME'],\n  url:            \":s3_domain_url\",\nstyles: {\n      mini:     \"48x48>\",\n      small:    \"100x100>\",\n      product:  \"240x240>\",\n      large:    \"600x600>\"\n  },\npath:           \"/:class/:id/:style/:basename.:extension\",\n  default_url:    \"/:class/:id/:style/:basename.:extension\",\n  default_style:  \"product\"\n}\nattachment_config.each do |key, value|\n  Spree::Image.attachment_definitions[:attachment][key.to_sym] = value\nend\n```\nThe issue was the default_url. Its should be:\ndefault_url:    'noimage/:style.png',\nNow everything is working as expected.\n. Hi @jhawthorn fixed the issue within minutes. Seemed to be a bug in the globalize gem.\n. Hi @jhawthorn fixed the issue within minutes. Seemed to be a bug in the globalize gem.\n. Thank you.\nChanging the default boolean to 'true' in spree stores table fixed the issue.\n. Thank you.\nChanging the default boolean to 'true' in spree stores table fixed the issue.\n. Here is the console output:\nStarted GET \"/t/type-of-tea/white\" for ::1 at 2016-05-22 11:47:15 +0200\n  ActiveRecord::SchemaMigration Load (0.7ms)  SELECT \"schema_migrations\".* FROM \"schema_migrations\"\nProcessing by Spree::TaxonsController#show as HTML\n  Parameters: {\"id\"=>\"type-of-tea/white\"}\n  Spree::User Load (1.0ms)  SELECT  \"spree_users\".* FROM \"spree_users\" WHERE \"spree_users\".\"deleted_at\" IS NULL AND \"spree_users\".\"id\" = $1  ORDER BY \"spree_users\".\"id\" ASC LIMIT 1  [[\"id\", 1]]\n  Spree::Store Load (1.0ms)  SELECT  \"spree_stores\".* FROM \"spree_stores\" WHERE \"spree_stores\".\"code\" = $1 LIMIT 1  [[\"code\", \"localhost\"]]\n  Spree::Store Load (0.8ms)  SELECT  \"spree_stores\".* FROM \"spree_stores\" WHERE (url like '%localhost%')  ORDER BY \"spree_stores\".\"id\" ASC LIMIT 1\n  Spree::Store Load (0.3ms)  SELECT  \"spree_stores\".* FROM \"spree_stores\" WHERE \"spree_stores\".\"default\" = $1  ORDER BY \"spree_stores\".\"id\" ASC LIMIT 1  [[\"default\", \"t\"]]\n  Spree::Order Load (1.3ms)  SELECT  \"spree_orders\".* FROM \"spree_orders\" WHERE \"spree_orders\".\"completed_at\" IS NULL AND \"spree_orders\".\"currency\" = $1 AND \"spree_orders\".\"guest_token\" = $2 AND \"spree_orders\".\"store_id\" = $3 AND \"spree_orders\".\"user_id\" = $4 LIMIT 1  [[\"currency\", \"EUR\"], [\"guest_token\", \"2rKUauYcYhXsO6hPSpCN9w\"], [\"store_id\", 1], [\"user_id\", 1]]\n  Spree::Order Load (1.1ms)  SELECT  \"spree_orders\".* FROM \"spree_orders\" WHERE \"spree_orders\".\"user_id\" = $1 AND \"spree_orders\".\"frontend_viewable\" = $2 AND \"spree_orders\".\"store_id\" = 1  ORDER BY \"spree_orders\".\"created_at\" DESC LIMIT 1  [[\"user_id\", 1], [\"frontend_viewable\", \"t\"]]\n  Spree::Taxon Load (1.9ms)  SELECT  \"spree_taxons\".* FROM \"spree_taxons\" INNER JOIN \"spree_taxon_translations\" ON \"spree_taxon_translations\".\"spree_taxon_id\" = \"spree_taxons\".\"id\" WHERE \"spree_taxon_translations\".\"permalink\" = '--- !ruby/object:ActiveRecord::StatementCache::Substitute {}\n' AND \"spree_taxon_translations\".\"locale\" IN ('en', 'es', 'ca') LIMIT 1\n  Rendered public/404.html (2.2ms)\nCompleted 404 Not Found in 384ms (Views: 262.9ms | ActiveRecord: 21.7ms)\n. Here is the console output:\nStarted GET \"/t/type-of-tea/white\" for ::1 at 2016-05-22 11:47:15 +0200\n  ActiveRecord::SchemaMigration Load (0.7ms)  SELECT \"schema_migrations\".* FROM \"schema_migrations\"\nProcessing by Spree::TaxonsController#show as HTML\n  Parameters: {\"id\"=>\"type-of-tea/white\"}\n  Spree::User Load (1.0ms)  SELECT  \"spree_users\".* FROM \"spree_users\" WHERE \"spree_users\".\"deleted_at\" IS NULL AND \"spree_users\".\"id\" = $1  ORDER BY \"spree_users\".\"id\" ASC LIMIT 1  [[\"id\", 1]]\n  Spree::Store Load (1.0ms)  SELECT  \"spree_stores\".* FROM \"spree_stores\" WHERE \"spree_stores\".\"code\" = $1 LIMIT 1  [[\"code\", \"localhost\"]]\n  Spree::Store Load (0.8ms)  SELECT  \"spree_stores\".* FROM \"spree_stores\" WHERE (url like '%localhost%')  ORDER BY \"spree_stores\".\"id\" ASC LIMIT 1\n  Spree::Store Load (0.3ms)  SELECT  \"spree_stores\".* FROM \"spree_stores\" WHERE \"spree_stores\".\"default\" = $1  ORDER BY \"spree_stores\".\"id\" ASC LIMIT 1  [[\"default\", \"t\"]]\n  Spree::Order Load (1.3ms)  SELECT  \"spree_orders\".* FROM \"spree_orders\" WHERE \"spree_orders\".\"completed_at\" IS NULL AND \"spree_orders\".\"currency\" = $1 AND \"spree_orders\".\"guest_token\" = $2 AND \"spree_orders\".\"store_id\" = $3 AND \"spree_orders\".\"user_id\" = $4 LIMIT 1  [[\"currency\", \"EUR\"], [\"guest_token\", \"2rKUauYcYhXsO6hPSpCN9w\"], [\"store_id\", 1], [\"user_id\", 1]]\n  Spree::Order Load (1.1ms)  SELECT  \"spree_orders\".* FROM \"spree_orders\" WHERE \"spree_orders\".\"user_id\" = $1 AND \"spree_orders\".\"frontend_viewable\" = $2 AND \"spree_orders\".\"store_id\" = 1  ORDER BY \"spree_orders\".\"created_at\" DESC LIMIT 1  [[\"user_id\", 1], [\"frontend_viewable\", \"t\"]]\n  Spree::Taxon Load (1.9ms)  SELECT  \"spree_taxons\".* FROM \"spree_taxons\" INNER JOIN \"spree_taxon_translations\" ON \"spree_taxon_translations\".\"spree_taxon_id\" = \"spree_taxons\".\"id\" WHERE \"spree_taxon_translations\".\"permalink\" = '--- !ruby/object:ActiveRecord::StatementCache::Substitute {}\n' AND \"spree_taxon_translations\".\"locale\" IN ('en', 'es', 'ca') LIMIT 1\n  Rendered public/404.html (2.2ms)\nCompleted 404 Not Found in 384ms (Views: 262.9ms | ActiveRecord: 21.7ms)\n. I took a look:\n| => rails console\nSpree::Taxon.find_by_permalink!(\"type-of-tea/white\")\nRunning via Spring preloader in process 1492\nLoading development environment (Rails 4.2.6)\nirb(main):001:0> Spree::Taxon.find_by_permalink!(\"type-of-tea/white\")\n  Spree::Taxon Load (1.5ms)  SELECT  \"spree_taxons\".* FROM \"spree_taxons\" INNER JOIN \"spree_taxon_translations\" ON \"spree_taxon_translations\".\"spree_taxon_id\" = \"spree_taxons\".\"id\" WHERE \"spree_taxon_translations\".\"permalink\" = '--- !ruby/object:ActiveRecord::StatementCache::Substitute {}\n' AND \"spree_taxon_translations\".\"locale\" = $1 LIMIT 1  [[\"locale\", \"en\"]]\nActiveRecord::RecordNotFound: Couldn't find Spree::Taxon\nI will dig deeper.\n. I took a look:\n| => rails console\nSpree::Taxon.find_by_permalink!(\"type-of-tea/white\")\nRunning via Spring preloader in process 1492\nLoading development environment (Rails 4.2.6)\nirb(main):001:0> Spree::Taxon.find_by_permalink!(\"type-of-tea/white\")\n  Spree::Taxon Load (1.5ms)  SELECT  \"spree_taxons\".* FROM \"spree_taxons\" INNER JOIN \"spree_taxon_translations\" ON \"spree_taxon_translations\".\"spree_taxon_id\" = \"spree_taxons\".\"id\" WHERE \"spree_taxon_translations\".\"permalink\" = '--- !ruby/object:ActiveRecord::StatementCache::Substitute {}\n' AND \"spree_taxon_translations\".\"locale\" = $1 LIMIT 1  [[\"locale\", \"en\"]]\nActiveRecord::RecordNotFound: Couldn't find Spree::Taxon\nI will dig deeper.\n. You would think that from the message. But the path is set for all three languages. Maybe its i18n related, globalize or similar.\n. You would think that from the message. But the path is set for all three languages. Maybe its i18n related, globalize or similar.\n. gem 'solidus_globalize', github: 'solidusio-contrib/solidus_globalize', branch: 'master' still not fixed.\n. gem 'solidus_globalize', github: 'solidusio-contrib/solidus_globalize', branch: 'master' still not fixed.\n. ",
    "mdavo6": "Thanks @chris-barklem , your comment just saved me a lot of time.\n. ",
    "felixyz": "@chris-barklem Thank you so much! If you have the time, I'd really like to hear how you reached that conclusion and whether you (or anyone else) have any explanation for why this was necessary. \n. ",
    "hakkiplaten": "Not common knowledge to everone. We can't expect all our users to be experts.\nUsually when I install Forem one of the first things I do is to copy all the views to my own app so I can start customizing. Solidus' default layout is pretty amateurish, so any serious developer would most certainly start modifying the views, CSS and JS right away in order to create something that is more beautiful and more likely to bring in sales.\nI just think it's an important piece of info that shouldn't be left out of the main docs. Which is why, probably, Radar placed it in his main docs. And as we know, nobody's done more for Solidus than him.\nRef. https://github.com/solidusio/solidus/graphs/contributors\n. @jasonfb I personally wish to do the HTML from scratch because I believe I can make it even simpler and more semantic, thus achieving greater power and flexibility when it comes to making the site look like a million bucks.\nAt least during Spree's days, the HTML was a mess. Not sure in what direction Solidus has taken it now though.\nRegardless, I can easily understand how this is not everybody's cup of tea.\n. ",
    "abhishek77in": ":+1: I am using solidus for my project. It would help to see this information in Readme or at the least in Wiki. Thanks.\n. ",
    "dpsk": ":+1:  on this one\n. ",
    "mtylty": "\ud83d\udc4d for leaving the README alone and using guides/wiki\n. I was unable to reproduce this bug...\n. is this going to be completed with one PR per page?\n. @Mandily I've asked myself the same question about capitalization.\nI've ended up with a mixed solution because I've used capitalization whenever the default was the exact string (i.e. Any Country appears in the select dropdown) and lowercase to follow the example of the checked default provided in aaef78d835444dd669c83ba0a49e88508892e150.\nI'm concerned with consistency as well. Should I change the lowercase defaults to uppercase? It makes more sense to me to display the exact string when the default is part of the available choices.\n. I'll add a commit to fix the downcase text\n. I'm working on this and probably almost done... \nI have one doubt though... Should we keep the user_total_amount column on the spree_store_credit_events table or can we just rename the column?\nI'm asking because I really can't figure out why something like that should be saved in the Spree::StoreCreditEvent model even though I'm sure it must have some kind of logic behind it...\n. Do you have some work planned to deprecate StoreCreditEvents, refactor the code and then close this bug?\nBecause if you think it's not worth it to fix this bug before the refactor I'd better stop and work on some other issue \ud83d\ude04.\n. @useiichi I think this is related to the solidus_i18n extension, you'd better open an issue there.\nThat said, I tried adding the solidus_i18n extension to the sandbox app but I was unable to reproduce this bug.\n. The new backend will look like something like this:\n\n. I've changed the migration to add NULL default and migrate all the old data.\nAbout the data migration: I've manually tested the various cases and it seems to be working for me (it correctly recalculated all the remaining amounts for all the store credit events I had in the sandbox). Can't say if there are some edge cases I'm not considering... Please take a look at the comments on the migration and tell me if you think it could be right.\nI noticed there is a DEPRECATION WARNING on display_remaining_amount when amount_remaining is nil saying I should give \"0.00\" as an argument... Maybe it's better to leave the default of the new column to 0.0?\n. @kennyadsl this should be good to go, I made the requested changes.\nI think it needs to be re-reviewed because I added a couple of changes that are probably worth talking about.\nI talked this through with @kennyadsl and we decided to go for StoreCredit.includes(:store_credit_events).find_each to actually load the records to migrate so that, if you have a huge number of store credits, the server won't try to load all the records at once into memory.. @kennyadsl done!. I was unable to reproduce this bug. \nI made everything work by adding the code like so:\nconfig/routes.rb:\n```Rails.application.routes.draw do\n  mount Spree::Core::Engine, :at => '/solidus'\nSpree::Core::Engine.routes.draw do\n    namespace :admin do\n      get 'models/index'\n    end\n  end\nend\n```\nspree/admin/models_controller.rb:\nclass Spree::Admin::ModelsController < Spree::Admin::BaseController\n  def index\n  end\nend\nConfiguration for the additional menu item:\nconfig.menu_items << config.class::MenuItem.new([:models], 'icon-name', url: :admin_models_index_path)\nAnd everything pretty much worked like expected. @digitalWestie could you try this configuration and see if you still get the unexpected behavior?. @vladstoick I'm working on this as well, would you mind splitting the work? We could work on solidus_core and solidus_backend separately.. This is also missing validations for dates but I can imaging we want this to have validations so that there can only be one valid tax rate at a time.. I ended up duplicating code that's in Spree::Promotion to duplicate the same starts_at/expires_at logic. It made perfect sense to me to use that logic in Spree::TaxRate as well.. Will PR shortly.. @cbrunsdon you're right, it could be an awesome feature.\nRecently I needed something like this for a store that had two \"filter areas\", one at the top and one on the side (each with its own set of models to search on) and I think using an instance method would have saved me a lot of time.\n. I'm starting to wander if it's worth moving this inside the controller and saved in an instance variable.\n. yes it is... It's just that I don't like using too many .tap and .new inside views \ud83d\ude1b \n. I'll see what I can do... I'm not that good with style and html \ud83d\ude05 . I'm not sure... is this a false positive?. @kennyadsl you're right I didn't notice the when doesn't actually have code in it. Thanks!. ",
    "joeswann": "Ah yes, okay I think it was a conflict with rails composer and devise. Just installed with rails new and it worked flawlessly. Just me being dumb, please close!\n. ",
    "jemagee": "But is a cancelled order data that needs to be preserved?  Is there reporting that segregates out cancelled orders?  Cancelled orders are different than returns, they are basically orders that never happened.  So why are they being saved?\n. ",
    "swcraig": "@mamhoff's justification makes sense. May we close this?. I have updated the CHANGELOG and rebased onto master in #2185.. May we close this? #2185 was merged.. May we close this? #2185 was merged.. There doesn't appear to be any further action required. May we close this?. This was fixed by #1590. I can't recreate on master.. I rebased this and opened a new PR in which CircleCI passed.. I am working on the regression spec.. I didn't investigate the one failing spec, but this typo has been fixed in 74d7b940 from PR #2056.\nhttps://github.com/solidusio/solidus/pull/2056/files#diff-3329c5ee0df3de06561549745b116615R1367. @loicginoux Nice catch. I am more than happy to write a PR myself, unless you specifically would like to do it! Let me know.. https://github.com/solidusio/solidus/pull/2140#discussion_r132139967\n@tvdeyen I didn't change the name arrays to use %w syntax because the other arrays in this file use multi-word values and I felt that consistency in the file would be favoured. Instead I spread the arrays over multiple lines when they grew past 80 characters. Let me know if you want me to revert the arrays to sit on single lines again (or whatever solution you find reasonable).. If we are interested, there is a style require_parentheses_when_complex that enforces parentheses around the conditional if it includes more than a single entity (like the expression in your PR description).\nhttps://github.com/bbatsov/rubocop/blob/master/lib/rubocop/cop/style/ternary_parentheses.rb#L41-L51\nStyle/TernaryParentheses:\n   EnforcedStyle: require_parentheses_when_complex\n. I believe this PR in solidus_auth_devise will fix the issue. Once a new version of solidus_auth_devise is released with this fix we should be able to close this.. Just as a note, we use the (generally) American spelling of canceled throughout most of our English translations. Should an issue be made to transition into using cancelled with two ls? It's sort of a nitpick, but we may as well make all of the uses uniform.\nBoth spellings seem to be acceptable and correct.. Just as a note, we use the (generally) American spelling of canceled throughout most of our English translations. Should an issue be made to transition into using cancelled with two ls? It's sort of a nitpick, but we may as well make all of the uses uniform.\nBoth spellings seem to be acceptable and correct.. Closed in favour of #2337 . I think the best approach will be to merge #2337 before pulling out Paperclip.. This is ready for another review. There have been a few changes since the last reviews. I have added Variant#gallery.best_image. This method will fallback to using the first associated product image if a variant itself has no images.\nWhen a variant has no images itself, why do we allow developers to choose to fallback to the first associated product image in some cases but not others? Could I remove the #best_image method and move this into a config value (Spree::Config.fallback_to_product_images)?. I think this is good to go. I've added ImagesHelper#image_or_default for the admin/frontend views. This will fallback to a Spree::Image if an image cannot be found for a product/variant.. Thank you for the feedback.\n~~The galleries have an #image_urls method in addition to an the #images method. The JBuilder API endpoints. the product thumbnails partial on the frontend, and images/_image_row  in the backend expect Spree::Images (that respond to Paperclip API calls). I can't see an easy way to rewrite these with only URLs while keeping the same behaviour.~~\n~~The actual display logic no longer needs to know Paperclip's API (there is no more accessing of the #attachment of an image). A sort of unfortunate result is that the views need to specify the image size twice (in case there is no image and we need to fallback to use the CSS of class= placeholder <size>. Like here for example.~~\nThanks to @derrickp for his input on this.\nThe variant and product galleries return an Enumerable of images (things that must respond to #url, #alt, #viewable_id, and #id**). The  display logic no longer knows about Paperclip's API.  The only place that still knows about the Paperclip API is the relevant JBuilder image partial in solidus_api.\nInstead of having complex fallback rules, both the variant and product galleries can return empty Enumerables. Our image partials in the frontend/backend have historically dealt with nil \"images\" by applying the CSS of class= placeholder <size>. Instead of defining a hacky Paperclip image default, we should have stores use this CSS to define what to display in the case that there are no images.\n** If we are fine with removing this modal in the admin we can get rid of #id requirement. This is also the only place we use that modal. \nI'm interested in hearing what we think of where this is going.. I have this to the point where we don't reference Paperclip specific calls anywhere in the views.  We do continue to use Paperclip specific logic in the solidus_api controller for images, and in the actual form for uploading images. We can probably deal with these when someone goes to pull Paperclip into an extension.. This is ready for another review. \nI plan on transitioning Spree::Image to function as a \"presenter\" class for images on the frontend. It's sort of weird right now because it represents a Paperclip image, but instead of getting rid of it and using a new class (Spree::Picture) if/when someone rips out Paperclip we could just keep it and define the interface there.\nI am pretty happy with how this looks; the current state of the PR would make it easy for someone to pull out Paperclip, the only places that would need special attention are the places I mentioned in a previous comment.\nVery happy to discuss this either here or by DM on Slack if any of this isn't clear.. Could we possibly take another look at this? With Rails 5.2/ActiveStorage close to release I think there should be some consideration to get Paperclip out.. With Paperclip officially being deprecated can we take a serious look at merging this? When this is merged it will make extracting Paperclip into an extension much easier. I also think this is a better general approach to dealing with images in core/the view layer.\n@tvdeyen feedback would be appreciated.. There is a PR open to remove stringex if that is what we want to do.. Thank you for the feedback @fylooi and @aaronlifton2.\nWould the sort of documentation I've added to Spree::EventBus and Spree::MailProcessor be of value?. Thank you for the encouraging words @fastjames.\nI've gone ahead and stopped sending live AR objects to the processors. I have also moved the publishing of events to be after our transactions have completed. Thank you @jhawthorn for the feedback.\nI think that it should be up to specific processors to make the decision whether to run their code in-process or through ActiveJob. This PR is not intended to implement an asynchronous message queue. The event bus (we are open to changing the nomenclature) provides a better mechanism for stores to add their own custom callbacks to run given the firing of an event. In my opinion, if one of my callbacks (subscribers) throws an exception I want my system to blow up. I don't want my application to continue execution in a possibly compromised state. If I want to write a subscriber that runs asynchronously, or does aggressive exception handling, or sends things to SQS for example, I am still free to do that.\nThis implementation does not stop someone from writing asynchronous event subscribers, and I think defaulting to ActiveJob makes it more difficult to write in-process handlers, rather than vice-versa.\nIf this still isn't what we are going for, or we have misunderstood the concerns about this, we are very open to continue making changes and get this into a merge-able state.. This is good for a merge when we are ready. Thank you everyone for the feedback.. Thanks for pointing out the stale code @fastjames. I think the community is still unsure whether they want to see this change in Solidus. Once we get the green light I will rebase and update the branch with the changes.. The work in #2337 most likely needs to be merged before we are able to easily extract Paperclip into an extension.. I am no longer actively working on this.\n@elia has graciously picked up the work here.. Thanks John, I didn't even think about that. I'll get something else for this.. I think the last sentence needs to be completed.. I think this is an old reference and should be updated to Spree::Stock::SimpleCoordinator.. I guess the reason I would want the base class is so that it's obvious the interface that should be implemented for galleries in general. But I understand your point and can make the changes.\n:duck: :duck:\n. stringex would \"dasherize\" everything as part of its to_url method. ActiveSupport::Inflector doesn't do that, so some specs related to this would fail (t2_child is expected to be convereted to t2-child, which ActiveSupport#parameterize alone does not do).. \"...perform a HARD destoy\".  All three of the deprecation warnings have this.. I don't see how I am going to be able to write this _thumbnails partial using only image URLs. At some point an image is going to need the context of which variant it is for. What do you think, @tvdeyen?\nIf we have situations like this (and the admin/_image_row partial), I think it would make sense for the galleries to return an \"Image\" class. If a developer wants to drop in a different implementation they can provide their own image class that responds to #url, #id, #viewable_id, and #alt. I was thinking something like this:\n```\nclass MyImageClass\n  def initialize(image)\n    @image = image\n  end\ndef url(size)\n    @image.the_way_this_image_library_gets_urls(size)\n  end\n# etc...\nend\nclass MyVariantGallery\n  def images\n    however_the_images_are_stored.map { |image| MyImage.new(image) }\n  end\nend\n```. This partial is given an image url (the caller has already decided the size and retrieved the relevant url). I've updated the naming to be more clear.\nDoes that make sense?. Something to note here. We don't use an image's alt attribute in either frontend or backend. Would being able to access image.alt here be an argument for using a custom image class like I suggest in this PR comment? That image class could have a strict interface #url(size), #id (for that single-use modal in backend/image/_image_row), #viewable_id, and #alt.\nIs there a reason why we haven't historically been rendering an image's alt attribute? @mamhoff @tvdeyen. is not be visible. Should these be two sentences?. After thinking about this, I think that we can transition Spree::Image to function as this presenter. I don't think there is much value in adding another class (Spree::Picture), when we can use Spree::Image to do the same thing. I've updated the PR to reflect this.. I agree this is not ideal. I've removed suppress_mailer from the event object, and have made a (possibly presumptuous) decision within the MailProcessor:\nreturn if event.carton.shipments.any?(&:suppress_mailer)\nThe suppress_mailer flag is defined on a Shipment. Having the carton and order in the event does not give the necessary context of which shipment has triggered the CartonShippedEvent.\nThoughts?. That works for customer-related notifications, but couldn't there be other processors that don't care about the suppress_mailer flag? For example, a processor that sends event information to a service like statsd.. Something got chopped here.. Was the word \"on\" missed after the word \"method\"?. Do you mean the order must be greater than $100 USD?. I think you are missing an ending ` for bundle install.\n  . sprockets. I think this should be \"require specific updates\".. \"The amount of deprecation warnings\". I think \"deprecated\" instead of \"depreciated\".. I think \"deprecated\" instead of \"depreciated\".. Nice word choice :1st_place_medal: . \"Spree 3.0 introduces ~is~ a\". I think the start of this sentence got chopped somewhere.. There's an extra \"e\", in \"extensions\".. Should this say \"methods\"?. \"Minor versions are \"?. ",
    "jrochkind": "Some parts of Spree expect the CR to belong to just one order, I think. And there are some validations that seem to that effect. But it's enforced unevenly, yeah.  It probably should be enforced better both through schema changes and better validations. \nFor instance, a CR should belong to an Order, and validation should refuse to let a ReturnItem that doesn't belong to the same order be added. Likewise, a CR should not be able to be associated with a ReturnAuthorization belonging to a different Order.  Or, if a CR always has a ReturnAuthorization (I'm not sure if that's true), then CR#order should actually just be a proxy to reimbursement.order, it doesn't even need it's own order_id. \nSome of these changes can be done in a pretty backwards compatible way, they will just make it impossible to do things that probably shouldn't have been intended anyway. Others will be less backwards compatible -- there are certain methods returning arrays now that really ought to return single objects (eg CustomerReturn#return_authorizations -- is it really intentional you have more than one RA for a single Return?  Or maybe it is... the hardest part here is actually figuring out what's the the intended use case, and what's a mistaken design or bug, as virtually nothing is documented). \nAnyway, this PR does nothing more than make the FactoryGirl factory for testing support return more reasonable happy path data for folks to use in their tests. :)  I am implementing return functionality in a local app, and needed more reasonable data than the factory was creating for my specs. \n. Some parts of Spree expect the CR to belong to just one order, I think. And there are some validations that seem to that effect. But it's enforced unevenly, yeah.  It probably should be enforced better both through schema changes and better validations. \nFor instance, a CR should belong to an Order, and validation should refuse to let a ReturnItem that doesn't belong to the same order be added. Likewise, a CR should not be able to be associated with a ReturnAuthorization belonging to a different Order.  Or, if a CR always has a ReturnAuthorization (I'm not sure if that's true), then CR#order should actually just be a proxy to reimbursement.order, it doesn't even need it's own order_id. \nSome of these changes can be done in a pretty backwards compatible way, they will just make it impossible to do things that probably shouldn't have been intended anyway. Others will be less backwards compatible -- there are certain methods returning arrays now that really ought to return single objects (eg CustomerReturn#return_authorizations -- is it really intentional you have more than one RA for a single Return?  Or maybe it is... the hardest part here is actually figuring out what's the the intended use case, and what's a mistaken design or bug, as virtually nothing is documented). \nAnyway, this PR does nothing more than make the FactoryGirl factory for testing support return more reasonable happy path data for folks to use in their tests. :)  I am implementing return functionality in a local app, and needed more reasonable data than the factory was creating for my specs. \n. thanks jhawthorn. I may have gotten confused between various versions of spree/solidus i've been working with/in as to exactly what happens in what version, thanks for the spec and verification that it does do something useful in solidus master. \n. thanks jhawthorn. I may have gotten confused between various versions of spree/solidus i've been working with/in as to exactly what happens in what version, thanks for the spec and verification that it does do something useful in solidus master. \n. Yep, I hadn't figured out what was actually using ffaker, but that makes sense @mamhoff, will do. \n. Yep, I hadn't figured out what was actually using ffaker, but that makes sense @mamhoff, will do. \n. Also, I hadn't realized you could require individual factories -- nice, that's what I wanted to do myself, really. \n. Also, I hadn't realized you could require individual factories -- nice, that's what I wanted to do myself, really. \n. (My other goal is to be able to easily use factories in development, not just test. In development, you won't have spec_helper/rails_helper requiring all the various stock dependencies, so things need to require their own dependencies if they aren't auto-required by the gem, or you need to do a whole bunch of requires first yourself). \n. (My other goal is to be able to easily use factories in development, not just test. In development, you won't have spec_helper/rails_helper requiring all the various stock dependencies, so things need to require their own dependencies if they aren't auto-required by the gem, or you need to do a whole bunch of requires first yourself). \n. Pretty sure the CI failure has nothing to do with this PR. \n. Pretty sure the CI failure has nothing to do with this PR. \n. I am super frustrated being stuck with the old version of byebug. YES, it is a problem, I effectively can't use byebug at all (via pry.binding or just byebug) even not in feature tests, without getting exceptions because of known problems with the ancient version of byebug you're using and recent MRI's. \nI agree with @eric1234 , without the upgrade it doesn't work well anywhere, feature tests or otherwise. \nThis issue was closed in favor of #1016, but #1016 is also closed, for reasons I don't understand. \nI would really really like something to be done here. \n. I am super frustrated being stuck with the old version of byebug. YES, it is a problem, I effectively can't use byebug at all (via pry.binding or just byebug) even not in feature tests, without getting exceptions because of known problems with the ancient version of byebug you're using and recent MRI's. \nI agree with @eric1234 , without the upgrade it doesn't work well anywhere, feature tests or otherwise. \nThis issue was closed in favor of #1016, but #1016 is also closed, for reasons I don't understand. \nI would really really like something to be done here. \n. I do not have a problem only if I start specs through rake. Byebug is not usable with MRI 2.3.1 on my dev machine -- whether starting via rake or not. \nThis is a known issue with the version of byebug we are using, it's too old to work with MRI 2.3. \n. I do not have a problem only if I start specs through rake. Byebug is not usable with MRI 2.3.1 on my dev machine -- whether starting via rake or not. \nThis is a known issue with the version of byebug we are using, it's too old to work with MRI 2.3. \n. Huh, weird. Yeah, I can try. Except I haven't managed to actually run the entire suite locally which is tricky. \nThe general thrust of the change makes sense? Cool. \n. Huh, weird. Yeah, I can try. Except I haven't managed to actually run the entire suite locally which is tricky. \nThe general thrust of the change makes sense? Cool. \n. This one is kind of a brain twist: #<Double \"Spree::Variant_1574\"> received unexpected message :price with (no args)\n. This one is kind of a brain twist: #<Double \"Spree::Variant_1574\"> received unexpected message :price with (no args)\n. I took a stab at trying to fix the specs, but gave up, the data graph and business logic just got too complicated for me to keep track of and figure out what it ought to be doing -- it's surprisingly hard to make a realistically behaving Order/LineItem.  I'll just make the change to the factory locally in an override for me, I guess. Thanks for the feedback. \n. I took a stab at trying to fix the specs, but gave up, the data graph and business logic just got too complicated for me to keep track of and figure out what it ought to be doing -- it's surprisingly hard to make a realistically behaving Order/LineItem.  I'll just make the change to the factory locally in an override for me, I guess. Thanks for the feedback. \n. These comments focus on the data modelling, especially how it's reflected in the ActiveRecord classes and their names. \n1. Instead of WalletSource, spree_wallet_sources, and WalletSource#source, I would suggest WalletPaymentSource, spree_wallet_payment_sources, and WalletPaymentSource#payment_source.  The current naming makes it confusing what a WalletSource#source is -- what sort of object/class?  @jordan-brough mentions he was being consistent with Payment#source, which I might do different if we had it to do over too, but at least there, there's an orthographic relationship between Payment#source and PaymentSource, that isn't there between Wallet#source and PaymentSource. I'd leave Payment#source the same for backwards compat, but WalletPaymentSource#payment_source for clarity. \n2. On the topic of \"it's unclear what a WalletSource#source actually is\", right now an unrestricted polymorphic association there will let you set any ActiveRecord model as the source/payment_source. Suggest a validation and/or a setter argument checker that prevents you from setting anything but is_a? Spree::PaymentSource.  Or else you can set a User, an Order, a Store, anything as a source, which will lead to disaster. \n3. In a CC only world, we had User#credit_cards -- which was every CC a user had ever used, expired or not, not necessarily just those meant to be in the current 'wallet' (a concept we didn't have before). But are we sure we'll never need User#payment_methods, all payment methods ever used by a user, whether in current wallet or not? Maybe a user wants to see all the payment methods they've ever used? Or an Admin does? (for fraud detect purposes?).   If we're pretty sure this will never be needed, that's fine. But if it were needed, going through all the user's Orders probably isn't great. If it were needed, then we might want user_payment_sources with a boolean in_wallet, instead of just wallet_payment_sources.  The danger is if we later discover it's needed, we'll have to rename all these tables/models/associations again, which we don't want to have to do.  The flip side is added un-needed complexity for something we might not need. \n4. It might be worth considering using ActiveRecord Single Table Inheritance for PaymentSources, instead of an abstract_class = true.  STI would mean all payment sources would live in the same spree_payment_sources table, instead of each living in their own table.\n   - The downside is, the downside of STI, they're all in the same table, which has every column in it needed for any payment source, could get large and confusing, and extensions adding new PaymentSource sub-classes would have to make sure not to interfere with each other's column names (with possibly different types!).\n   - The upside is the WalletSource#source/WalletPaymentSource#payment_source association would not need to be polymorphic -- it would be an ordinary belongs_to :payment_source, and STI takes care of it.   Avoiding a polymorphic association there would also allow you to actually have User#wallet_payment_sources as an AR association, with all the goodness you get from AR associations (caching, includes/preloading) -- with the polymorphic belongs_to on the join table as current, I would be scared to try to get AR to actually do a User has_many :through PaymentSource, I don't think it will do it well (and pre-loading or other efficiencies are obviously impossible anyway).  It would also make a bunch of the above points kind of settle themselves:\n     - You wouldn't need to worry about 2 above, it's no longer a polymorphic association. \n     - it would be easier to have both User#payment_sources and a User#wallet_payment_sources has_many :through associations, as plain old AR associations (using a scope on the in_wallet boolean in the join table, AR can handle that), to accommodate point 3 above. \n     - especially if doing the previous bullet point, the naming would make sense as UserPaymentSource, spree_user_payment_sources, UserPaymentSource#payment_source, standard AR conventions. \n. These comments focus on the data modelling, especially how it's reflected in the ActiveRecord classes and their names. \n1. Instead of WalletSource, spree_wallet_sources, and WalletSource#source, I would suggest WalletPaymentSource, spree_wallet_payment_sources, and WalletPaymentSource#payment_source.  The current naming makes it confusing what a WalletSource#source is -- what sort of object/class?  @jordan-brough mentions he was being consistent with Payment#source, which I might do different if we had it to do over too, but at least there, there's an orthographic relationship between Payment#source and PaymentSource, that isn't there between Wallet#source and PaymentSource. I'd leave Payment#source the same for backwards compat, but WalletPaymentSource#payment_source for clarity. \n2. On the topic of \"it's unclear what a WalletSource#source actually is\", right now an unrestricted polymorphic association there will let you set any ActiveRecord model as the source/payment_source. Suggest a validation and/or a setter argument checker that prevents you from setting anything but is_a? Spree::PaymentSource.  Or else you can set a User, an Order, a Store, anything as a source, which will lead to disaster. \n3. In a CC only world, we had User#credit_cards -- which was every CC a user had ever used, expired or not, not necessarily just those meant to be in the current 'wallet' (a concept we didn't have before). But are we sure we'll never need User#payment_methods, all payment methods ever used by a user, whether in current wallet or not? Maybe a user wants to see all the payment methods they've ever used? Or an Admin does? (for fraud detect purposes?).   If we're pretty sure this will never be needed, that's fine. But if it were needed, going through all the user's Orders probably isn't great. If it were needed, then we might want user_payment_sources with a boolean in_wallet, instead of just wallet_payment_sources.  The danger is if we later discover it's needed, we'll have to rename all these tables/models/associations again, which we don't want to have to do.  The flip side is added un-needed complexity for something we might not need. \n4. It might be worth considering using ActiveRecord Single Table Inheritance for PaymentSources, instead of an abstract_class = true.  STI would mean all payment sources would live in the same spree_payment_sources table, instead of each living in their own table.\n   - The downside is, the downside of STI, they're all in the same table, which has every column in it needed for any payment source, could get large and confusing, and extensions adding new PaymentSource sub-classes would have to make sure not to interfere with each other's column names (with possibly different types!).\n   - The upside is the WalletSource#source/WalletPaymentSource#payment_source association would not need to be polymorphic -- it would be an ordinary belongs_to :payment_source, and STI takes care of it.   Avoiding a polymorphic association there would also allow you to actually have User#wallet_payment_sources as an AR association, with all the goodness you get from AR associations (caching, includes/preloading) -- with the polymorphic belongs_to on the join table as current, I would be scared to try to get AR to actually do a User has_many :through PaymentSource, I don't think it will do it well (and pre-loading or other efficiencies are obviously impossible anyway).  It would also make a bunch of the above points kind of settle themselves:\n     - You wouldn't need to worry about 2 above, it's no longer a polymorphic association. \n     - it would be easier to have both User#payment_sources and a User#wallet_payment_sources has_many :through associations, as plain old AR associations (using a scope on the in_wallet boolean in the join table, AR can handle that), to accommodate point 3 above. \n     - especially if doing the previous bullet point, the naming would make sense as UserPaymentSource, spree_user_payment_sources, UserPaymentSource#payment_source, standard AR conventions. \n. There's no ideal solution, but I think STI is probably less complex than an approximation of a polymorphic many-to-many, which is kind of what's there now. (AR can't actually do a polymorphic many-to-many reliably, which is maybe why the many-to-many association isn't actually defined here, despite the many-to-many-like join table). But there are definitely plusses and minuses either way, I can see either decision, none we have in front of us seem ideal. \nI would say the relevant pattern that maybe makes the JSON data structure @mamhoff suggests appropriate, is when you have a bunch of rows in the same table that need wildly different attributes, and those attributes do not (ever!) need to be queryable.  One place this is used in current Solidus is PromotionRule preferences -- which are actually also STI, I think? (So STI is not totally new to Solidus, I think?)  (And any other place that use Spree::Preferences::Preferable is also using a JSON data structure. Hard to figure out where that might be, the way it's being done right now). \nSerialized-in-one-column data struture is basically a hacky workaround escape hatch, but sometimes you need a workaround escape hatch. :)  But yeah, I'm not sure which is the best decision here, just that it's probably worth considering -- whatever ends up merged is gonna be with us a while (hopefully, we don't want another backwards breaking change soon), and is part of the core bones of solidus so everyone will be dealing with it. \n. There's no ideal solution, but I think STI is probably less complex than an approximation of a polymorphic many-to-many, which is kind of what's there now. (AR can't actually do a polymorphic many-to-many reliably, which is maybe why the many-to-many association isn't actually defined here, despite the many-to-many-like join table). But there are definitely plusses and minuses either way, I can see either decision, none we have in front of us seem ideal. \nI would say the relevant pattern that maybe makes the JSON data structure @mamhoff suggests appropriate, is when you have a bunch of rows in the same table that need wildly different attributes, and those attributes do not (ever!) need to be queryable.  One place this is used in current Solidus is PromotionRule preferences -- which are actually also STI, I think? (So STI is not totally new to Solidus, I think?)  (And any other place that use Spree::Preferences::Preferable is also using a JSON data structure. Hard to figure out where that might be, the way it's being done right now). \nSerialized-in-one-column data struture is basically a hacky workaround escape hatch, but sometimes you need a workaround escape hatch. :)  But yeah, I'm not sure which is the best decision here, just that it's probably worth considering -- whatever ends up merged is gonna be with us a while (hopefully, we don't want another backwards breaking change soon), and is part of the core bones of solidus so everyone will be dealing with it. \n. @dhonig So STI has already been 'introduced', this would not be introducing it.  If Spree::PaymentMethod and Spree::Gateway are both already STI, that does seem rather tantalizingly analagous, doesn't it?  (Unless it hasn't worked out well and seems a bad idea in retrospect for them!)\nThe part of this PR that moves further toward abstracting away from CreditCard to a generalized polymorphic PaymentSource is, I'd suggest, more significant (and important to get right) than the Wallet part. \nOrder is gonna need an association to PaymentSource too, isn't it? At least eventually. I don't completely follow how it's being done in this PR.  And Order to PaymentSource might even need to be many-to-many --- you can theoretically pay for an order with more than one PaymentSource, right?\nWouldn't it be nice if the Order/PaymentSource relationship were an ordinary rails many-to-many (has_many :through) to an STI table, instead of a weird kind-of polymorphic many-to-many, like the Wallet/User->PaymentSource relationship in this PR?  If a true generalization of CC to PaymentSource is to be accomplished, then PaymentSource probably needs to be a full participant in the ecology, including ability to make has_many and has_many :through associations to PaymentSources -- which probably requires STI.\n. @dhonig So STI has already been 'introduced', this would not be introducing it.  If Spree::PaymentMethod and Spree::Gateway are both already STI, that does seem rather tantalizingly analagous, doesn't it?  (Unless it hasn't worked out well and seems a bad idea in retrospect for them!)\nThe part of this PR that moves further toward abstracting away from CreditCard to a generalized polymorphic PaymentSource is, I'd suggest, more significant (and important to get right) than the Wallet part. \nOrder is gonna need an association to PaymentSource too, isn't it? At least eventually. I don't completely follow how it's being done in this PR.  And Order to PaymentSource might even need to be many-to-many --- you can theoretically pay for an order with more than one PaymentSource, right?\nWouldn't it be nice if the Order/PaymentSource relationship were an ordinary rails many-to-many (has_many :through) to an STI table, instead of a weird kind-of polymorphic many-to-many, like the Wallet/User->PaymentSource relationship in this PR?  If a true generalization of CC to PaymentSource is to be accomplished, then PaymentSource probably needs to be a full participant in the ecology, including ability to make has_many and has_many :through associations to PaymentSources -- which probably requires STI.\n. Makes sense, thanks @jordan-brough \n. Makes sense, thanks @jordan-brough \n. That was harder than expected, just redid it from scratch for this one-line change. \n. Or perhaps adjust_count_on_hand should actually be written in terms of set_count_on_hand? \n. Here's the failure from circleci:\n```\n1) Spree::StockItem#after_save inventory_cache_threshold is set count on hand stays above threshold\n     Failure/Error:\n       expect do\n         subject.set_count_on_hand(8)\n       end.not_to change { subject.variant.updated_at }\n   expected result not to have changed, but did change from 2016-04-24 20:20:41.258599812 +0000 to 2016-04-24 20:20:41.258599000 +0000\n # ./spec/models/spree/stock_item_spec.rb:223:in `block (4 levels) in <top (required)>'\n\n```\nHuh?  Anyone have an idea what's going on? How does no change but adding a db lock to guard against race conditions result in a variant getting it's updated_at touched when it wasn't before?\nAny ideas?\n. Thanks so much @peterberkenbosch !\n. Thanks! Last time I looked the CI was failing although I couldn't figure out why; unrelated?\nI also wonder if the sku lookup in this area should be exact match only, not partial match -- or they're going to be flooded with imprecise results after sku lookup actually works. \nI suggest I add that before merging (I've done that in my local fix in my local app). \n. Okay on sku_start. \nAh, true on the master variant only thing, that's a problem. Not sure how to solve that, I'll see if I can figure it out. \nKeep in mind that at present, sku lookup simply does not work at all, it's not looking up skus. \n. Okay, here's my stab at it. \nHaven't really tested this. It probably needs automated tests, but I'm not sure I'm going to be able to do it. \n. I'm not sure how to start here regarding specs. Can anyone suggest an existing feature spec I can model this off of? \nOr is there anyone that wants to help by writing a feature spec?\nOr do any committers want to @jhawthorn that a feature spec may not be required for a merge? (Although I realize things have turned out slightly more complicated since his comment to that effect). \nI suspect the product_picker.js currently has no specs because it's kind of painful to write. \n. error handling changed, rebased and squashed. \n. yes, none of it is currently very consistent, and the stuff that is consistent doesn't generally make sense. \nI did discover the hard way in production that if a promotion raises in eligible?, it can keep any cart from checking out ever, as checkout will check eligible for a bunch of promotions. So raising seems bad. \nAnd I agree that validation makes sense (I added it locally in my app already in fact). \nI guess I'd plead that you maybe not require me to make changes in other classes I wasn't touching in order to get this merged? I'm happy to make this one do whatever you think is best, but it doesn't seem like refactoring all the rules needs to be a pre-req of giving the Taxon rule a 'none' policy consistent with the one already in Product? Which is really all I need at present. \nI can make Taxon rule consistent with current Product rule if you want... Which would mean an unrecognized match policy would just be treated like whatever happens to come last in the 'else' clause. In Product that is none, in Taxon prior to this PR that was any. So, bah. \nBah, I guess if you really need me to fix everything to merge this, I can, but I'm not thrilled about it. :)\n. It really does seem like a separate change/commit/PR to refactor the way a bunch of promotions work, vs adding a none rule to Taxon. No?\nBut if you need it done, and in this PR, I can...\n. Sure!  I'm not sure this PR actually introduces any additional inconsistency, because it was already inconsistent.  Otherwise I could make this consistent with what was there before... except I can't, because there's no consistency in what was there before. :) But sure. \n. @jordan-brough if you DO feel like messing with promotions more, I suspect the places that CALL eligible? should wrap it in a rescue, and return the generic \"software error\" message on rescue. Becuase of what I discovered that a promotion eligible? that raises in any circumstances can prevent people from buying things (even if that promotion wouldn't have applied to them if it were working).  That's one of the worst things that can happen in an e-commerce site, heh. Yeah, one of our large customers had a couple hours where nobody could purchase anything, oops. \n. Anything I can do to get this merged? If you want me to change the 'default' case for an unrecognized match policy, I can do so, any way you like. The way it is now was based on feedback from @jasonfb . @jordan-brough , @jhawthorn ?\n. I had been hoping to get this in 1.3.0, so I could stop monkey-patching locally, but thems the breaks!\nIs there anything I can do to help move this forward? @jordan-brough , would you like me to change this PR to be consistent with what you're doing in #1184? \n. Okay, the controversy here was over how an unrecognized/error match_policy is treated. \nI have changed it to be strictly and exactly backwards compat, a nil or unrecognized match_policy defaults to any, just as it did before. \nCan we merge this now, regardless of larger changes for promotion rule consistency being proposed by @jordan-brough in another PR?  We should be able to add the Taxon None Match rule (so it's consistent with existing Product None Match rule) without having to deal with refactorings of error handling in taxon promotion rules in general -- this does that, just adds the taxon None Match rule, without changing error handling at all, it is still as it ever was.  \nI'd really like this to be merged and in an eventual release, so I can stop monkey-patching it in locally! @jordan-brough ?\n. @peterberkenbosch if you have time now, that would be much appreciated. \n. Okay, I'll try to take a look. Honestly, 4.5 months after making this very small PR, I'm not too interested in it anymore, I'll just keep monkey patching the behavior into my local app, this like 20 line simple PR doesn't seem worth the amount of attention it's requiring for reasons I don't entirely understand. \nbut I'll prob have time to at least take a look today. \n. Hm, the merge is confusing me too. Were the specs re-factored to no longer use shared examples?\n@peterberkenbosch if you feel like writing a brand new PR that also adds a 'none match' policy to Taxon Promotion, I'd be thrilled and not feel hijacked. But otherwise I'll prob get around to figuring it out eventually, despite my whining. But yeah, please, feel free. \n. @peterberkenbosch FWIW I have the actual taxon.rb merged, figuring out the spec now. \n. rebased and squashed. \n. Fixed with proper existing code. Rebased and squashed. \nGood catch @jhawthorn, thanks. Must have accidentally copy pasted from an old version of spree (I work with some apps still in spree these days). \n. Any way to get this merged? @jhawthorn @mamhoff ? Anything I can do?\n. Thank you!\n. nice, thank you! \n. Thanks for comments @kennyadsl .  The scenario I had was simply wanting to turn off certain emails (that we didn't want, or wanted handled in other custom ways), while leaving on other emails where it was convenient to take the default and not have to re-implement them ourselves.  \nAll your comments are good, if someone gives me indication that this feature could be merged, I'd implement them all, thanks!\n. In particular, solidus_auth_devise adds a mailer for password reset that inherits from Spree::BaseMailer, so is effected by send_core_emails config. \nI wanted to turn off the built-in order/shipment mailers, but use the solidus_auth_devise password reset mailer that I had no interest in overriding or re-implementing. \nThere's no good way to do that, since send_core_emails config will disable all mailers that inherit from Spree:::BaseMailer. \n. Another alternative is a lambda, I guess. In config, or a class variable. But again the problem is how that lambda gets access to everything it needs to make the decision. \nSpree::BaseMailer.should_deliver = proc { |class, method, *args|  Spree::Config[:send_core_emails] }\nBenefit over the sub-class is it's clear what the public api is. Rather than a sub-class that might depend on any part at all of the superclass. Composition over inheritance. If all we mean to expose is the ability to set custom logic for whether to deliver, then set up the API so that's exactly what is provided. \nI suppose it could even be Spree::Config, although I don't know if there's any precedence for lambda/procs in Spree::Config. \n. And more thoughts, sorry for so many words. \nI assume that you can provide your own EmailDispatcher-compliant class by config or a class variable or something. \nIf you do that, and it's a sub-class of the built-in EmailDispatcher, I suggest that is actually no safer with regard to forward compatibility than class_eval decorators. In both cases, your customization is dependent on the current behavior of the built-in EmailDispatcher -- including even possibly protected/private methods (because both a sub-class and class_eval extended or prepended logic have access to protected/private, and could include logic dependent on current behavior there, depending on how written).  \nSo a sub-class doesn't actually seem to be any step forward with regard to forward-compatibility than the class_eval or Module.prepend approach. \nThe composition approach, which you also provide an example for, could be, in that at least it only has access to public methods from the built-in EmailDispatcher.  But in order not to have to copy-and-paste or reinvent code, there would need to be sufficient public methods, and all of those public methods would be 'public API' that could not be changed on Solidus side without potentially breaking things downstream. \nDoes Solidus currently have a theory of what is 'public API'  and what isn't? Any public method anywhere? Or more restricted? \nAnd also, currently some things can be customized with the Spree::Config, and other 'config points', I think, still exist as class methods.  Is there a preference in Solidus to try to move to exclusively Spree::Config, or will we keep using a mixture of both going forwards, whatever seems to make sense for the particular config point?\n. i've got an idea for an EmailDispatcher, I agree that's a better way to do it, I'll try to PR that soon. \nIt probably shouldn't be called EmailDispatcher, probably shouldn't even have the word email in it -- it could hypothetically be switched out for something that sends these notifications via other or additional methods too (txt message, slack, carrier pigeon). Any ideas for a name? \n. how will it decide what assumption to make? Different for each rule, as it is presently?\n. Okay, that sucks. I don't completely understand the issue, but the result is that byebug is totally broken. \nThe whole point of byebug is being able to step through code, but with this old version of byebug, stepping through code on MRI 2.3.1 frequently results in an exception, because it's too old a version of byebug to work with MRI 2.3.1. \nIs there anything we can do?\nCan we not include pry-byebug in the gemspec at all, but just byebug and pry by themselves? Ah, I see that's what you proposed in #1005 -- why did you close it, I don't entirely understand from the conversation?\nI would really like to be able to use a version of byebug that actually works with MRI 2.3. \n. > ```\n\nbefore_filter :load_roles, :load_stock_locations, only: [:edit, :new]\n```\n\nAh, thanks. It probably would be a good idea to add an aggregate method load_everything_needed_to_display_form or whatever, so individual places that need to do that don't need to keep track of each individual method they need to call. (I think load_stock_locations was added only recently, and there was only one place that needed to manually do it at that time, so it didn't occur to the authors). \nBut I think that's a separate refactor, probably not a pre-req for this PR (I hope my mouth hasn't just made more work for myself haha). \n. Is this ready to merge? Does it close #1192 ?\n. @jhawthorn or anyone else, cleaned up code and PR description here, I would love some feedback, if you like the direction I'll move on to writing tests and changing any details you have feedback on. Thanks! \n. @mamhoff thanks! I'll fix bugs and add tests and maybe clean up deprecation messages a big, but wanted to get confirmation that the basic design would be liked before spending that time. Thanks! \n. Done and ready for review for merge whenever. \nOops, except still need to squash all the commits which became numerous. \n. I could move some or all of the configuration from class methods to Spree::Config, not sure which is best. \n. The current Store.default implementation is screwy, creating a non-persisted store with new. \nSo if you call Store.default with no default store in the db, you get an unpersisted one returned, which maybe something will try to save at a later point (say, if you assign it to an association and save the target), or maybe won't.  This is a mess. \nSo while I agree lazily creating a store in default doesn't feel right, it's for a long time already done this, although in an even harder to predict way -- the one it lazily creates doesn't even have the default attribute set!\nSo my initial thought was to just change Store.default  to where(default: true).first_or_create -- if it's going to lazily create a store (which it has been doing for a long time), at least set it's default attribute to true, and persist it. \nBut this doesn't work, because a Store can't be saved without a name, url, and mail_from_address too.  \nSo maybe Store.default shoudln't be lazily creating anything. \nThe problem is this will make a whole bunch of tests in my local app fail, that have always passed before. I'm probably not alone.  Because I use DatabaseCleaner to wipe the database in between every test (I guess solidus suite does not do this?), so there's always 0 Spree::Store's at the beginning of a test. \nBut after this change, any test that involves current_order(create_order_if_neccesary: true) (and probably more) will end up raising, unless it creates a default store in advance. When they all used to work. I guess the answer could just be find all my failing tests and add a before { create(:store, default: true) } to them.  I guess maybe that works. I think people are going to find it painful. \nI have run into related problems like this with test environments and 'seed' data, and I have no good general purpose solution, I've always ended up having to write code I didn't like. \nIncidentally, in investigating it, I discovered that the current specs for Spree::Store.default are pretty useless. They say they are testing to make sure .default should ensure there is a default if one doesn't exist yet and .default should ensure there is only one default, but they do not test/verify this, the current specs don't in fact test anything other than their own setup, unless I'm missing something. \n. @jordan-brough \n\n@jrochkind I believe the before_save :ensure_default_exists_and_is_unique here means\n\nAha, right. \nHowever, I think in fact, if anything does try to save the thing lazily created from Store.default -- it'll just fail validation anyway, since it has no name, email, or mail_from_address.  (Not sure how recent those presence validations are).  So that lazily created Store.new returned from Store.default at present is just a disaster waiting to happen. You can easily accidentally trigger a save (without even knowing what you got from Store.default wasn't yet persisted in the first place), by assigning it to an association on some other record (which is probably what you want Store.default for after all). \n. Does anyone know how Solidus' own specs take care of making sure a default store is there?\nI know a default store starts out in the generated dummy app, which I guess works if you're using transactional test destroy method, but that doesn't work for capybara feature tests, they presumably wipe out the whole db... frontend at least is using DatabaseCleaner truncation for tests tagged js. I can't figure out how these specs are passing at all, without creating a default Store first. \nI guess I can try to debug it and figure it out. \n. @mtomov I agree with your bullet points as desirable, but I've found it awfully hard to implement. \nIt's pretty dangerous to keep an AR in a class attribute, as it'll end up shared between threads in many scenarios (including worker threads, multi-threaded dispatch with puma, and others), and AR models are not thread-safe to be shared between threads.  If you marked it readonly (an AR feature), it might be safer, but I wouldn't want to count on it, this stuff gets complicated. \nI think sharing an AR model between threads, as will happen eventually if it's cached at the class level, is probably a not good idea. \nSo I'm not sure there's any good way to accomplish those points, if every order needs a store, which has already been committed to I think?\nIt is a pickle. \n. @jhawthorn changed the arg name as you asked, new rebased code made our comments including your thumbs up disappear. Mind adding it again? \n. @jhawthorn removed the unneccesary delete_all. thanks for feedback! \n. I don't think it is, the before save is intentionally changing some things on the order that probably require it being updated. (It's our own super hacky legacy implementation of store credits from before it was included in solidus, possibly based on an old spree extension by someone else, that does store credits as adjustements).  I mean, it might be possible, but it would require more understanding of this legacy code and of solidus than I currently have. \nI've resorted to setting a 'my_callback_in_progress' to true and then back to false around the order updater, and have the before_save callback return if my_callback_in_progress.  Hacky, but it does the job. \n. although maybe i should leave the issue open until someone removes the misleading comment? I dunno. \n. readonly! will make that particular in-memory copy refuse to save changes, but some other part of code could still change the same row in the db. \nedit: It could work if readonly! is set in the source for the model itself, based on some attribute, at fetch time (in an AR hook prob), so anywhere that read a particular record got it in a read-only state. \nedit again: Oh, if it never gets persisted at all, I guess that could work as well?\n. > Made Spree::Order validate :store_id\nIs this being removed from 1.3 then?\nIs master the place where I get the latest will-become 1.3, it doesn't have it's own branch or anything (and does this mean we have no way to merge PR's that are not intended for 1.3, since it's already been feature-frozen, but are good to merge for a future release?)\nI have an app that began on spree 2.4, and I'm working on updating it to solidus -- i want to go all the way to 1.3 before deploy, since 1.3 is so imminent. Obviously won't deploy until 1.3 is actually released in such a case. But for my upgrade work, should I be updating to master and targetting that?  (Already did a bunch of work to deal with required store on order, heh). \nThanks!\n. Thanks!  I just mis-read the diff and thought the CHANGELOG was removing notice of this. I see the notice is somewhere else, although doesn't specifically talk about validations, just more broadly that orders need a store. \nThe validation is one of the largest things I'm dealing with updating an old legacy app from solidus 1.2 to 1.3, largely but not exclusively just issues of test setup. Def good to be in the changelog. \n. Thanks! Yeah, very strange. \nI was using update (without the bang) rather than update! in my own repro, but sounds like it makes no difference. \n. Cool, thanks for finding that. It is a big annoying, one is used to ActiveRecord working a particular way, such that update (an AR method) not actually updating the thing in memory is definitely surprising. \nI don't totally understand what's going on in that code, why it's not an ordinary AR association that would get cached as ordinary by AR.  Ah, becuase ship_address is really default_address, and you don't want to look it up each time... actually I totally don't understand what's going on. Why isn't it just a normal AR association, that gets cached for the particular model instance as normal AR associations do (and AR takes care of updating with update and other relevant cache invalidation)?\n. Cool, thanks for finding that. It is a big annoying, one is used to ActiveRecord working a particular way, such that update (an AR method) not actually updating the thing in memory is definitely surprising. \nI don't totally understand what's going on in that code, why it's not an ordinary AR association that would get cached as ordinary by AR.  Ah, becuase ship_address is really default_address, and you don't want to look it up each time... actually I totally don't understand what's going on. Why isn't it just a normal AR association, that gets cached for the particular model instance as normal AR associations do (and AR takes care of updating with update and other relevant cache invalidation)?\n. The more I look at the code, the more confused I get. I totally do not understand what's going on, I guess with the new address book architecture?\nI don't understand how that commit that just touches Spree::UserAddressBook is effecting Order#ship_address at all, as Order#ship_address is just an ordinary AR association belongs_to :ship_address, foreign_key: :ship_address_id, class_name: 'Spree::Address' which doesn't immediately appear to have anything to with with Spree::UserAddressBook\n. The more I look at the code, the more confused I get. I totally do not understand what's going on, I guess with the new address book architecture?\nI don't understand how that commit that just touches Spree::UserAddressBook is effecting Order#ship_address at all, as Order#ship_address is just an ordinary AR association belongs_to :ship_address, foreign_key: :ship_address_id, class_name: 'Spree::Address' which doesn't immediately appear to have anything to with with Spree::UserAddressBook\n. @jhawthorn both of those links are to the UserAddressBook ~~model~~ concern. I don't understand how UserAddressBook is effecting the ship_address on Spree::Order, here.  I see UserAddressBook is actually a concern mix-in, which I didn't notice at first. \nBut Spree::Order doesn't seem to include it: Spree::Order.is_a?(Spree::UserAddressBook) # => false. \n. @jhawthorn both of those links are to the UserAddressBook ~~model~~ concern. I don't understand how UserAddressBook is effecting the ship_address on Spree::Order, here.  I see UserAddressBook is actually a concern mix-in, which I didn't notice at first. \nBut Spree::Order doesn't seem to include it: Spree::Order.is_a?(Spree::UserAddressBook) # => false. \n. Doesn't look like Spree::Order is delegating ship_address to anything else...\nirb(main):027:0> Spree::Order.instance_method(:ship_address).source_location\n=> [\"/Users/jrochkind/.gem/ruby/2.2.4/gems/activerecord-4.2.6/lib/active_record/associations/builder/association.rb\", 114]\nBut it's really hard to say what's going on here, indeed. \n. I would not want all slugs by default to have ugly UUIDs in them, that's not a very \"friendly\" id at all. \n. taken care of by #1251\n. Thanks! It's still unclear to me whether I really need to run the rake task or not -- the release notes now only mention it in passing in one place about historical tax data for shipping.  My app appears to be running fine without having run it. Can the release notes be made more clear about how strong the requirement or recommendation for the rake task is, what it actually is gonna do, and if I'm making a mistake in skipping it? :)\n. I think in the front-ends we've done where I am, we don't even show tax until the final 'confirm' step.  \nDoes default solidus frontend actually show tax in the cart?  it would be interesting to do a survey of major e-commerce sites (including European-audience-focused ones) and see how many do, at what point they show tax, and if they show it line-item-specific. \nI think tax still needs to be (at least optionally) calculated, and ideally stored, on a line-by-line basis.  This came up in the slack channel recently where someone was explaining how some U.S. states charge sales tax on only certain categories of products, and buy-something-get-something-else-free promotions complicate this further, especially when the two products are in different sales tax categories, and different states have different rules for how much sales tax is owed in that situation. \nI think the solution is probably just refraining from automatically calculating/assigning tax when a line item is added to an order/cart, but instead having an explicit calculate_and_assign_sales_tax method/hook on an order, which is called at certain parts of the checkout process -- ideally easily customized as to which steps of the add-to-cart and checkout process call the method/hook. \n. Right on. \n\nThe customized calculator could hopefully decide at what states it should recalculate taxes?\n\nI'm not sure if it makes sense for the calculator to decide this. I'd think ideally the calculator would simply calculate, and whatever was calling the calculator would decide when to call it and assign it's results to models. \nBut that may not fit into the current architecture as well, as far as supporting the customization needed. But i think it's a confusion of responsibility to have the calculator deciding when to calculate.  The decision of when to calculate has to do with your UI, when you need to show tax to the user -- the calculator should not be concerned with or aware of such, or have to be modified when your UI choices change, the calculator should just be concerned with calculating. \n. Ah, yeah, I understand existing architecture constrains. \nI understood that in what was being proposed by jordan-brough, you'd miss out on tax calcs unless you used the OrderUpdateAttributes anyway already. If that's not an acceptable situation (I am not sure), then jordan's proposal doesn't work, right? If it is, then it becomes okay to plan on tax calculation points being customized via extension points in the OrderUpdateAttributes, not in a tax calculator. I think?\n. Ah, it was me that was confused, I didn't realize/forgot the two things are different. I don't really entirely understand what's going on -- is OrderUpdater triggered from the front-end CheckoutsController? (That's where I saw the OrderUpdateAttributes being used; why is it using OrderUpdateAttributes instead of OrderUpdater? Is OrderUpdater still triggered at some point by frontend checkouts controller?)\nAnyway, yeah, if that works, great. You understand the arch better than me, I'm happy with any plan that plans for extension/customization points as to when tax calculation happens somewhere that's part of general order updating, not a tax calculator. \n. My thought has been that it's crazy spree/solidus lets you modify a complete order at all. I think the case:\n\n\nUser completes an order for widget A ($10) and widget B ($20) and submits payment\nUser asks to have widget B cancelled, and admin deletes widget B's line item from the order and grants a refund for widget B.\n\n\nProbably not even to be possible. Instead, an adjustment cancelling out that item would be the way to go. But now I realize that leads to it's own problems with taxes, calculated promotions, etc. \nSo I don't really know. \n. Good idea. You might end up needing to pull back on the ActiveSupport::Deprecation raise, it might result in CI forcing you to fix lots of Rails deprecations before you're actually ready to, since they happen on Rails schedule not yours -- I can't tell if the CI is run on a fixed version of Rails, or on \"latest version available that matches a dependency requirement\".  If the latter, you'll start getting CI failures when rails releases new deprecations even if nothing has actually broke, and they'll appear on random PR's that just happened to happen at the same time as the rails change. \nBut it's worth a try if you want, but I'd suggest be willing to roll back the change with regard to ActiveSupport::Deprecation in particular, if it ends up being a pain. I think the AS::Deprecation raise is less clear about whether it's a good idea. \nThe Spree::Deprecation change to fail CI on any deprecations is more clearly a definite good. It will prevent people from passing CI when committing a new deprecation warning, unless they've also changed every place in internal solidus code that uses the now-deprecated func.  As well as prevent future commits that accidentally use the now-deprecated func because the developer didn't notice it had become deprecated. (I guess the only downside would be if it discourages people from comitting needed deprecations, because of the added cost of doing so). \n. I think it's probably just okay to remove, I can't think of any use case for it (when I saw it there myself a month or so ago, I couldn't figure it out either, heh).  In what cases would a promotion be associated with exactly one and only one user?  A single-user-specific promotion seems unlikely. \nIf you want to be extra safe, you could have the migration that removes it written to make sure the column is nil in the database, and refrain from removing it if it has any values, emitting some scary warning that you might want to look into it and remove it yourself. \n. thanks, I've needed this before. \n. I agree with warning people that Solidus is basically a framework, a tool for programmers, and probably not for beginners -- and i agree that some of the Spree marketing probably too much tried to make it seem otherwise. \nI'm an experienced Rails developer, I've figured out Spree-then-Solidus, partly with the help of colleagues who already were familiar with it (not sure how they've figured it out) -- but I still think some better docs are a good idea. Heck, any docs are a good idea. :)  \nI made use of the Spree docs (before I had switched to Solidus), and found them very helpful even though they are incomplete and occasionally wrong. But someone coming to Solidus doesn't neccesarily know to look at the Spree docs, and they'll become less useful as Solidus continues to diverge.  \nDifferent people learn different ways, I'm a lover of documentation. Docs are never going to eliminate the need to code-read sometimes/eventually (heck, we all need to dive into Rails code itself sometimes), but they're still very useful to give you a foundation.  You need to have an audience in mind when doing any writing, and I agree the audience for Solidus docs is devs with some substantial ruby/Rails/webdev experience, not complete beginners.  Solidus is complicated stuff, and even an experienced developer (depending on learning style/preferences) needs docs to provide a foundation for understanding the parts and how they fit together, the intended golden paths and installation procedures, etc.  The docs can also be open about which parts are still rough, not working as well as we'd like, or not as easy to customize as we'd like, which is also incredibly useful info for an experienced dev coming to Solidus -- they don't need to be promotional materials like Spree maybe sometimes tried. \nI understand that the main reason there aren't really any Solidus docs yet is just limited resources and that nobody's gotten around to it, not anti-doc sentiment. \n. Are you sure it's unrealistic to support both rails 4 and 5?  It might be worth at least considering if that's possible, when looking at the test failures in Rails 5 and how to address them.  The changes between Rails 4 are 5 are not huge, probably smaller than between 3 and 4 -- and I've worked previously on a somewhat analagous (large, complex) Rails Engine that managed simultaneous rails 3 and 4 compat. (Now, Rails 2 to 3 -- forget about it!).  ONE version supporting both Rails 4 and 5, followed by a version supporting only Rails 5, can make the upgrade process a LOT easier -- because you can first upgrade solidus and get all tests to pass, then upgrade Rails and do the same (or vice versa).  I always find it hugely painful when a major dependency switches from one major Rails version to the next without an intermediate version that supports both. \nBut if there isn't going to be a version that supports both, then I agree the right way to do it is with a version that moves from Rails 4 to 5, with as few Solidus backwards incompat as possible (including not removing current deprecated behavior). \nAnother thing to do would be to consider calling that version the next solidus 1.x instead of 2.0.  Solidus declares a dependency on Rails.  Just release a 1.4 (or 1.5, or wherever we're up to then) that bumps the Rails dependency to ~> 5.0.0, and bundler won't let them upgrade to it until they've upgraded to Rails 5 too, even if their solidus dependency in their local gemfile is ~> 1.0. \n. I've worked on a Rails engine that supported Rails 3 and 4 with few or no (can't remember for sure if it was zero) Rails.version checks, just a few respond_to? checks like good ruby.  I think it depends on the nature and number of the failures in Rails 5. \nBut I can respect not trying to support both; I think changing the Rails version number with no other intentional backwards incompat is probably a good move in that case. \nI still think calling the next 1.x would be a reasonable move, to save 2.0 for actual removal of deprecated behavior and other breaking changes (the PaymentSource stuff?).  While technically a dependency only change could be considered a breaking change, I also think it could be considered not. What problems will it actually cause for anyone if it's 1.x?  Since a bundle update will refuse to update to the rails-5-requiring solidus version unless the local app updates it's rails dependency too, I can't think of any. \n. I've worked on a Rails engine that supported Rails 3 and 4 with few or no (can't remember for sure if it was zero) Rails.version checks, just a few respond_to? checks like good ruby.  I think it depends on the nature and number of the failures in Rails 5. \nBut I can respect not trying to support both; I think changing the Rails version number with no other intentional backwards incompat is probably a good move in that case. \nI still think calling the next 1.x would be a reasonable move, to save 2.0 for actual removal of deprecated behavior and other breaking changes (the PaymentSource stuff?).  While technically a dependency only change could be considered a breaking change, I also think it could be considered not. What problems will it actually cause for anyone if it's 1.x?  Since a bundle update will refuse to update to the rails-5-requiring solidus version unless the local app updates it's rails dependency too, I can't think of any. \n. Nice work! \n. Nice work! \n. I just added this to my locally copied migration\n```\n      store = Store.first\n  if Rails.env.test?\n    store = Store.create!(code: \"spree_1\", name: \"Spree Test Store 1\", url: \"www.example.com\", mail_from_address: 'spree@example.org')\n  end\n\n```\n. jhawthorn says in slack migraitons aren't intended to work in test like that. \nhttps://solidusio.slack.com/archives/solidus/p1467225143000964\n. I think it would probably be better to still see the SKU's without a tooltip hover.  They are the main identifying features of a product for many of our customers.  Keep in mind you can search products by sku, it's potentially confusing to require a click and a hover to see the thing you searched for to verify you got the thing you wanted. \n. thank you! I was just looking at this styling and wishing for exactly what you did. \n. @tvdeyen Capybara actually requires you to do case-sensitive matching on what actually is rendered by the browser. It is intentional on Capy's part, for better or worse.  So yeah, them's the breaks. \n. @tvdeyen Capybara actually requires you to do case-sensitive matching on what actually is rendered by the browser. It is intentional on Capy's part, for better or worse.  So yeah, them's the breaks. \n. @jasonfb re removing validations:  I guess I'd worry that relying on Rails internals like that is likely to break in future Rails versions, and require me to spend serious time doing detective work to figure out the 'new' undocumented/unsupported way to do it. \nBut I think you're right to identify the difficulty of removing validations as the key problem here. If there were a better/less-confusing/more-supported way to remove existing validations as a general tool, it would make Solidus model classes more customizable and reduce need for special purpose customizations or getting everything exactly right for every possible app.   I wonder if Solidus could provide some generalized support for that, somehow. \n. Yes, I think the main reason to eliminate them is that internationally not everyone has a 'first name' and a 'last name'. Some people only have one name. Some people have multiple names (including more than two), and it's not obvious which is the 'first name' and which is the 'last name', as in your Asian examples. Some people switch to 'given name' and 'family name' to try and avoid the Asian confusion, but this doesn't really avoid the confusion, names are just way more variable internationally than one from the U.S. might assume. \nAlso when it comes to shipping addresses especially -- aren't shipping addresses not uncommonly a company name followed by an address? Companies/organizations also don't tend to have 'first names' and 'last names'. There is a company field in the Spree::Address -- but what if my shipping address is simply \"JRochkind LLC, 10 Maple Drive, etc\"?\n. I think you def got to think a bit about backwards compat for existing stores, including ones that are live and may have current tokens in use. \n. fixed commit message, thanks, sorry about that. \n. And I notice now there actually was a bugfix to this method in solidus_auth_devise in April at 42c8f80.  All the more reason to centralize this in solidus -- I think I copied the pre-April code into a local app that uses non-devise auth, which I'll now have to go look at and see if it has the same bug and should be fixed!\n. @bbuchalter it will work without changes to solidus_auth_devise, but in an ideal world solidus_auth_devise would replace the implementation here with something like:\nuser.on_sign_in(guest_token: auth.cookies.signed[:guest_token]) if user.is_a?(Spree::User)\nTo avoid copy-paste duplication of code now in core. If a given solidus_auth_devise version is meant to work with multiple solidus versions, then that might have to be wrapped in a if user.respond_to?(:on_sign_in), with the current implementation being the else case. \n. I think there are three options as far as conditionals in solidus_auth_devise\n1. Never ever change solidus in ways that are backwards-incompat with solidus_auth_devise. (Note this one is not technically backwards incompat, but it does extract code not related to devise and put it in solidus core, and it would be wise for solidus_auth_devise to use it from solidus rather than keep it's own copy)\n2. Pin solidus_auth_devise releases to specific versions of solidus.  Right now soldius_auth_devise has an unrestricted dependency on solidus -- it's gemspec says it works with any version of solidus at all. I'm not sure that's exactly true, I think you needed to upgrade solidus_auth_devise to a later versions with some recent solidus releases to actually work? But this isn't expressed in the gemspec. If it were, and there were a clear policy on what versions of solidus a given version of solidus_auth_devise supported, then it wouldn't need conditionals as often, it could use API with the minimum allowed version of solidus for the particular version of solidus_auth_devise. \n3. Keep using conditionals all over the place. \nI can't think of any other alternative. 1 seems unacceptable to me, saying that solidus is never ever allowed to change in any way that might require (or even suggest?) changes to solidus_auth_devise.  I have no opinion between 2 and 3 -- personally, I'm trying to get out of using solidus_auth_devise, which is what this PR (plus others already and coming) are targetted at, trying to go even further with having a clear auth API for solidus, not just 'whatever solidus_auth_devise does'.  This PR is towards that. \nAs long as you aspire to have any/latest version of solidus_auth_devise work with any version at all of solidus, I think it's gonna need to have lots of conditionals. But that's a question for the maintainer(s) of solidus_auth_devise, or the overall architects of solidus. \nThis PR does not require any changes to solidus_auth_devise, it won't break anything -- but it does make a change that rather suggests a corresponding change to solidus_auth_devise. \n. That's an confusing comment at the line @jhawthorn  mentions \"This is done intentionally to avoid loading the association.\"  But it doesn't avoid loading the association at all, it does load the association... then caches it. \nSince it says its' working around a bug elsewhere in spree, and when that bug is remedied it should be removed....   I wonder if that mysterious bug elsewhere in spree is covered by tests, so if the tests still pass it means that line isn't needed?\n. Rails caches/memoizes associations itself of course -- it's unclear why ordinary AR caching isn't sufficient here. \n. I've run into other inconsistencies with how actionable? works, I think when it was added to spree it was done a bit sloppily.  I previously PR'd a fix that actionable? didn't pay attention the boolean bit for promotion-eligible, but eligible? did.  Some of this stuff is behind the general lack of reliability people find with line-item-specific things on promotions. \n. Yep, I agree with @jhawthorn, this is basically meant to fix what I think was an omission in the implementation of the multi-code feature, it should have included this to begin with. Just fixing it in the simplest way possible, entirely backwards compatible.  \nI'll fix the mutation of the input parameter that @jhawthorn pointed out. \nIf committers don't want to make this fix to the current architecture, insisting instead on a more major refactoring of the feature (perhaps backwards compat perhaps not), you can reject/close this PR.  I can't commit to doing that major refactoring myself though, especially cause I've found that major refactorings are unlikely to be approved by committers who will disagree with each other about how it should look. :) \nIf this does get accepted, I think the next step is some slight fixes to the admin UI, to deal with confusion several people have reported on the slack channel about how to create a promotion with just one code.  With a base code stored, the UI can actually tell whether it's a multi-code promotion or a single-code promotion, and adjust labels accordingly to only say 'base code' if it really is a base code. \nReally, I think the original multi-code implementation was merged not really finished, just trying to finish it in a backwards compat way. \n. Do what you gotta do. My use case that inspired this was I want to be able to say \"Add N more codes\" (where N can == 1!), and get codes added, without the code making this request having to know through some out of band source what the correct 'base code' is.  \nI'd put handling that use case in as a request for your alternate proposed refactoring, and additionally a clear path for making the admin UI less confusing than it is now, although I don't think that has to be in the PR improving the behind-the-scenes. (Multiple reports of people not understanding how to add a single-code promotion from current admin UI). \n. I don't know, would it? How? What would make it easier to improve (eg) the graphic design design of the backend if everything were in separate repos, what is challenging for you about it being one repo?\nAre you talking just about code structure in repositories, or are you talking about \"release management\" issues, how the gems are compatible with each other?\n. I don't understand what's harder about 'forking everything else'.  It's just a single git clone statement and/or github \"fork\" button depending on how you do it. It's the same either way, if it's the entire solidus repo or a repo just for one of the gems. \nWhat is making it harder for you when it's all of the gems in one repo? It's still just a single command, I'm not clear on what is hard about it. \nHave you done this yet, or are you just worried about it? I'd suggest giving it a try, I don't think you are going to find it a problem. \nIf you want to have an app that depends on your custom forked version of just one of the solidus gems but uses standard releases for the others -- you can definitely still do that, no problem. If that's what you're worried about. \n. You can still use a forked version of backend, while using release versions of everything else. It does, you're right, require a bit more work on your end, as bundler won't point at a subdirectory of a git repo. But it's still possible.   \nOne way to do it would be to checkout the solidus repo (or your fork) locally, probably put it in ./vendor, and then use bundler path to point directly to the core subdirectory for the frontend gem, but keep using ordinary releases from rubygems for all other gems. You'd probably want to do this as a git submodule, so your vendor copy still has a git connection to your forked repo, and you can still pull and such. \nYou don't need to include the umbrella solidus gem in your Gemfile, you can include each individual solidus Gem in your Gemfile directly, with different sources. gem 'solidus_frontend', path: 'vendor/solidus/core' ; gem 'solidus_backend' etc.  Maybe you didn't realize you can specify each individual gem separately in your gemfile, even though they are in the same repo and even though there is the umbrella solidus gem?\nIn any case, you'll have to deal with merge conflicts with the stuff you edited in frontend. You shouldn't have any merge conflicts anywhere else since you aren't touching code anywhere else. \nCompare to rails which is set up very analagously. There is a gem rails which consists solely of dependencies on activerecord, actionpack, etc.  You can list the umbrella rails in your Gemfile -- or you can list each individual gem separately, which is usually done if you want to leave one out (say you don't need activerecord), but can also be done if you want different sources for different gems.  All rails gems are in the same rails repo, in subdirectories, with their own gemspecs. \nThe workflow you suggest, of running off a custom local fork of a solidus gem in production, is, if I understand right (I'm not a committer), not recommended by solidus, not a use case that is prioritized, probably not a great idea, not the way solidus intends itself to be used. \nBut if you want to do it, you still can. It is slightly more inconvneient, I agree, because you have to deal with git submodules or some other mechanism that will accomplish similar. \n. @peterberkenbosch I also know more about Solidus then I did four months ago when I first wrote this, which leads me to ask...\nIs the lock really neccesary in set_count_on_hand, like it is in adjust_count_on_hand? Maybe adjust_count_on_hand only needs the lock becuase of self.count_on_hand = count_on_hand + value, which isn't in set_count_on_hand, so maybe the lock isn't neccesary. \nOR maybe the lock is neccessary to keep process_backorders(count_on_hand - count_on_hand_was) working correctly, with the right counts. \nI think it might be, but i'm not sure. The more you learn, the less you know! :)\nEither way, it would be very enlightening to figure out what's making it fail on CI though, that's for sure!\n. Also note that FactoryGirl has no API to remove an attribute from an existing factory, or even to delete an existing factory altogether and replace it with a new one.  this makes it especially difficult to deal with the solidus user_factory insisting on setting attributes that your custom auth user model doesn't have, like password_confirmation and login. \n. @jordan-brough I had a separate PR to guard the admin view form at #1390, submitted a month ago. \nI didn't think of the factory issue when I submitted that one. \nI would love it if they were both merged soon, but I'm wary to combine them into one PR since they don't depend on each other and I don't want to give anyone a reason to reject the whole thing because they don't like half of it. \nBut #1390 already has a thumbs-up from jhawthorn 18 days ago, if you want to go and add your thumbs up and merge it, that would certainly make me happy. \n. oops, just saw a bug in this PR, about to fix it and rebase....\n. @jordan-brough per conversation on other issue: I have confirmed that attribute_method?(:password_confirmation) does work fine on a Devise user model, so the code here is acceptable. \nI'd rather use respond_to?(:password_confirmation=) because that's what really matters for whether the factory will raise or not -- but I don't think there's any good way to do that on a class, rather than an instance. \nI feel okay about using attribute_method? in the factory guard, but respond_to? in the template guard. \n. @jordan-brough per conversation on other issue: I have confirmed that attribute_method?(:password_confirmation) does work fine on a Devise user model, so the code here is acceptable. \nI'd rather use respond_to?(:password_confirmation=) because that's what really matters for whether the factory will raise or not -- but I don't think there's any good way to do that on a class, rather than an instance. \nI feel okay about using attribute_method? in the factory guard, but respond_to? in the template guard. \n. @mtomov switched to view spec. Github's recent changes seem to mean that rubocop's warnings that no longer apply to any code in this branch stay there forever, as does our comments on source code lines no longer in this branch. Kind of annoying. \n. I don't understand the CI failure, and think it is unrelated to this PR?\n. I don't understand the CI failure, and think it is unrelated to this PR?\n. ping? @mtomov? Anything else I can do?. In many parts of Solidus, I've noticed that amount means a Money object. But not always, and sometimes a Money object is not called an amount. \n. Nice!\nHow about making the skeleton CSS optional -- perhaps an app has to add a require line to their application.css manifest to get it. It would be nice if those who don't have customizations needing it could dispense with it altogether -- mainly to keep it from interfering with any other styles (like bootstrap row).\n. db:environment:set is a rails5 thing I think?\n. Definite huge improvement. \nWhether part of one PR or not, I think the \"view\" and \"edit\" screens for existing Promotion need attention too. Might make sense to make part of same PR for 'edit' at least, since that's actually the same partial I think, if you don't attend to it it could make it even worse. \nOne of the problems with \"edit\" screen is it is currently, is that it's not possible to show actual base code for multi-code promotions, since it's not preserved. Current edit screen just picks the first code in the database, and labels it 'base code' in the UI, which isn't right.  PR #1410 would make promotions remember their base code, which could allow view/edit on an existing promotion to make more sense. \n. Without Spree::Order#tax_zone, what's the right way to tell what tax zone an Order is in for calculating taxes?  Am I missing something?\n. It works the way it currently is, but Google recommends using the same version of the URL in most of your internal links as the canonical URL -- which makes a lot of sense. If they don't currently match, as it appears they do not, it's probably easier to change the canonical URL than to change all internal links. \n.  I'm not sure I understand why it's calculating based on line_item.inventory_units.not_canceled.reject(&:original_return_item ).size in the first place.\nIs it trying to exclude cancelled items, becuase it expects previously cancelled items would have resulted in the LineItem#total being updated? Does that actually happen? I think maybe it doesn't?\nShould this just be calculating based on a straight total/quantity?  I'm not saying I'm sure, I'm just having trouble following what this is supposed to do, especially in cases where say one unit is cancelled, then a day later another unit is cancelled. . To be clear, the twitter_cldr API is, I think, strictly backwards compat, but some unicode transformations and validations may differ, due to updated unicode info. I think it makes sense for the gemspec to continue allowing twitter_cldr 3.x as well as 4.x, to not force people to update if they don't want to. . I didn't change either one on purpose, I just copied it from... somewhere. Weird. Were those things just changed recently?  I may have forked for this PR before the change?  I'm super confused, I don't understand that code enough to have changed it intentionally, I copied it from somewhere, I didn't mean to change it. \nI don't entirely understand what's going on, but I can change it however you like. \n. I want to fix this, realized in production that a raise here can keep anyone from checking out ever, which is bad. \nPreviously, with an unrecognized match_policy it just assumed it meant any.  I think the alternatives are keeping that behavior, or just rejecting eligibility (and logging?) with an unrecognized match_policy. \nAny thoughts?\n. yes\n. It doesn't seem the same to me with regard to what we're talking about. productAutocomplete and userAutocomplete above both target specific classes -- data- attributes would be better, but classes work -- rather than every single select2 on the page, which is what @jordan-brough was questioning right?\nBut this update in create.js.erb is weird to begin with (.js.erb is probably always troubling), it would be nice if there were a completely different way to do it. \nMeanwhile, I don't really understand why you need to set the select2 attributes minimumResultsForSearch, dropdownAutoWidth, and allowClear on ajax update here at all, but if you really do need to set them, and set them for every single select2 on the page, then this is the appropriate way to do it... but why is that going on?\n. the leading underscore was what gave me a clue it wasn't being used when I saw it in source (see it had been auto-added in the past by a rubocop automated fix thing), so I felt bad removing it just because I've added a deprecation warning on what's still a no-op argument! but I will since you asked, sure. \n. i'm pretty sure rspec around handles that for you. \n. yep, rspec around already takes care of this for you. rspec docs are so awful, but here's a demo, you can run this file by itself to see. https://gist.github.com/jrochkind/04725b9f864d0cdedd7c8a7474cdd183\n. yep, I thought it might be, but it's so easy to mess this test up so it's not testing what you want (as it was before), that I thought it good to put in the explicit delete to make absolutely sure it's testing what it's supposed to. \nEspecially because it requires macro knowledge of what's going on in the test suite and solidus code (some code that at some point has lazily created a default store?) to be sure there aren't any stores created before.  Truncating at the start of the test suite isn't enough, you also need to be certain you have something running before each test that makes sure the db is being reset. Which there should be -- but I still don't understand how all the other tests that require a default store existing actually work in that case!  \nThere is so much macro knowledge you need to be sure, and so many things that could change to make it not so, and such risk of the test not testing what is intended (as it was before this PR),  it just seemed safer to explicitly enforce the expectations instead of just counting on everything else working how you expect. \nBut if you still don't after this persuasive essay, I'll get rid of it. Let me know? \n. okeydoke, I'll delete it. I still have no idea how a bunch of other tests (especially controller/feature tests) are managing to pass without any apparent creation of a spree default store, now that orders require stores. I guess something must be creating a spree default store somewhere else I haven't noticed. \n. i think there isn't the typo you think, but I see a few other bugs in this passage now that you bring my attention to it, that perhaps are making it confusing what the intent is. I'll clean it up if this is a good direction. Thanks! \n. I don't think it makes much difference either way as to method name/separate vs same method -- admin_layout= is still a method of course. If it's admin_layout=, it doesn't really matter if you do it with attr_writer or not, it's irrelevant, whatever works best. \nI don't personally have a problem with the same method being a setter and getter, in this context, and I do think it reads naturally in a view, similar to content_for. But I see the argument that a separate = method might be more clear. I think either are fine. \nI agree with @jhawthorn please don't use instance variables for API/contract between two entities, even though Rails sometimes seems to encourage it. As long as you don't do that. \n. This is confusing me, even with the comment. It overrides the  let(:user) { create(:user) } on line 5?  I thought that user on line 5 was the logged in (admin) user, but here it's the user created by the admin creating users? But only if user is first accessed (and thus lazily initialized) after the action to create a user?  What is determining the logged in (admin) user then?\nI think it might be less confusing if you either called this one by a different name (let(:created_user)) if things will still work if you do so, and/or skip the clever let altogether, and just do a created_user = Spree.user_class.last in context of the expectations.  If I'm understanding how the tests are actually working, which I may not be. \n. As I look at this code more though, the name admin_layout is a bit confusing to me -- I thought it would be a Rails layout template, but it looks like it's actually supposed to be the name of a class, yes? \n. This is insisting on adding the class name new-layout if @admin_layout is set at all. Is admin_layout a boolean, or is the name of a (I think?) css class.  Should this be <%= @admin_layout.presence %> instead? And should the class name new-layout be more descriptive, like full-width-layout or something? \n. okay, maybe I kind of sort of understand. this still seems pretty tricky reading the code. I'd suggest some brief docs explaining how it all works somewhere. \n. Okay, I think this is confusing enough that some documentation is def going to be required for people to figure it out. I still suggest that in the Rails context using the word 'layout' as something you can set, to a value that has nothing to do with the Rails concept of 'layout' (which is a template, or the name of a template)... might be worth considering if that's a good idea, in an already somewhat confusing setup. \n. I think it important to be able to switch out an ActionMailer back-end for another back-end (likely using a third party HTTP API), without having to copy-and-paste or reproduce standard logic around notifications -- such as suppressing a certain notification event. You should be able to turn off a certain notification event without worrying about whether it's an ActionMailer or another delivery mechanism, or worrying that someone later changing the back-end delivery method will break your attempt to disable certain messages. \nAdditionally, I think sub-classing is really no better than class_eval, just like class_eval it exposes the entirety of internals as dependencies of your customization. It's safest if you can write a new non-ActionMailer backend without having to sub-class -- composition over inheritance, this keeps the contractual API as clear and as small as possible. \nSo splitting the logic between the NotificationDispatch and the particular back-end, by default ActionMailerDispatch, was an attempt to meet these design goals. \nThe lambda stuff definitely can be gotten rid of.  I don't think the lambda stuff knows too much about the actual mailers -- all the lambda stuff knows about is the method signature of the particular notification, it doens't actually know anything at all about the actual mailers.  Prior to this PR, the only documentation or logic of \"what is the method signature of a particular notification event\" was to look at each individual ActionMailer class.  With the idea of being able to swap out an ActionMailer back-end for another delivery mechanism, I think this is unacceptable -- there needs to be a single central place that specifies exactly what signatures your custom back-end delivery needs to respond to. That's the only point of the \"lambda stuff\".   It could be dispensed with  if you don't think that's neccesary -- but I think there needs to be an easy  (and test-verifiable) answer to \"I want to implement a non-ActionMailer back-end, exactly what messages/signatures does it need to respond to in order to handle all notifications\", and the \"lambda stuff\" was the simplest possible solution to that I could think of. \nEvery element of this design is actually intentional to meet a particular design goal. It does look like several classes that each don't do much -- but I think this is what you get when you want simple objects with clean API's composed together (instead of inheritance) -- I think it's actually the sign of a good OO design ala Sandi Metz et al. \n. Without this, if I want to write a new back-end replacing ActionMailer delivery with another delivery mechanism (likely an HTTP api, say, mailgun; this was one of the design goals suggested by jhawthorn which I agree with) -- where would I go to look at exactly what messages my new back-end needs to respond to?\nJust the existing ActionMailer-based implementation?  While it's the default, I don't think it should be privileged like that, I think a specification of what the different notifications are, and what their signature sare, needs to be somewhere that is not coupled to ActionMailer. \nThat is the only and entire point of the self.signatures stuff.  \nEspecially because these signatures can and have evolved in the past (both new ones added, and existing ones had their parameters changed), and will continue to do so in the future, I think a central specification of exactly what the notifications are and what their parameters are is needed to allow alternate non-ActionMailer back-ends to be written in a sustainable way, that allows the signatures to continue to evolve in a way that's maintainable for alternate non-ActionMailer back-ends that may be in local code or plugins. \n. > In general we want factories not to set attributes that aren't actually required\nIs this true? I think of factories as creating 'typical' objects, not neccessarily minimal objects. \n. not sure, but I didn't change that at all in this PR, all it does is guard existing template code in a check. If that line ought to be changed, different PR I think?\n. They aren't exactly interchangeable, but there's no good way to write a migration to set that data, because that data simply isn't there -- that's what this PR fixes. \nI suppose you could write a migration that looked through all existing promotions, if they have promotion codes and if those codes all begin with the same prefix (assuming that prefix is always followed by an underscore, which the existing CodeBuilder does, but you could hypothetically have a custom CodeBuilder which does something else), then extract that prefix and set it as base_code?\nThat seemed far too error-prone and weird to try, to me. \n. to be more clear: Prior to this PR, if you look at an existing Promotion, the first promotion code (if any) is shown on screen labelled (labelled incorrectly) \"base code\". \nThat's just a mess, but the actual base code was not stored anywhere to display instead. After this change, the actual base code is stored somewhere and can be displayed properly. But for backwards compatibility and with existing promotions that do not have a stored base code, it still falls through to the old behavior. \nAs I warn in the PR, this change leaves a lot of internal API (class/method) API being kind of confusing. A lot of existing design is... not the choices I would have made. But I intentionally made the smallest possible change to get a properly stored base_code. \nIf people would rather I change more to make the internal API more reasonable, I certainly can -- but it's very challenging to figure out how to do so in a way that is both backwards compatible and makes the code less rather than more confusing. \n. Prior to this change, if you tell the CodeBuilder to create one code, it insists on creating that code without a suffix -- the one code created is just the 'base_code' by itself. \nEven ignoring actual admin UI, I had tried to use the CodeBuilder itself to create one additional code, with suffix -- I could not do so, it won't do it. \nThe CodeBuilder was I guess written with the assumption that it would only be used on new promotion creation. \nSo this change keeps the intent and backwards compatible API of the CodeBuilder -- which seems to be \"Decide whether to use a suffix based on how many codes there are\" -- but makes it work for both about-to-be-created new promotions, and existing promotions. For existing promtions \"how many codes there are\" needs to take into account not just the codes you are about to add, but the codes that existed already as well. \nAgain, this is not the API I would have done, but it's what's there, and I'm trying to not rewrite the whole thing, and maintain backwards compatibility. \nI am happy to ammend the commit message to be whatever you want if you have a suggestion. \n. I am also happy to rewrite the internal API to be more consistent. If I didn't care about backwards compatibility, I wouldn't have the CodeBuilder deciding whether to use a suffix based on how many codes there are at all, I'd have another option. If I did care about backwards compatibility... it may have to do some kind of *args checking thing. \nInitially I was going down that route, but I think the chances of me getting such a PR approved are not very high, so didn't want to do all that work only to have it sit here forever without getting approved. \n. Is anything in solidus using the return value? (Guessing not). Another more or less backwards compatible option would be false for nothing happened (is that even still possible?), but :active and :inactive for attached in each of those states. \nOr, if the return value isn't meant to be relied upon as stable API, just return nil always. Or maybe true always to be more backwards compat to people who were using it anyway. \n. AREL matches just results in SQL like, right?  Is SQL like neccesarily case-insensitive database-independently?  I don't think so? Anything I'm missing?\n. okay if the consensus is a view spec is correct and sufficient, I can do that. \n. huh, under the new github system it looks like hound comments don't go away even if you fix em and force push? THAT's annoying. \n. I'm not sure what I think about the theory of factories being intended to make typical vs minimal objects -- perhaps there sometimes need to be mutiple versions of a factory to handle multiple cases (see product, with base_product, product, and then various even more complicated products), but I have no strong feelings either way about this particular change, it seems fine. Someone can later add a person_with_lots_of_stuff factory if needed. \n. @mtomov I'll change to a view spec, that does make sense, backend previously had no view specs at all, which is maybe what discouraged me from using it before. Hopefully that'll deal with the test failure from unreliable spec too. \n. Not sure, I'm not really sure which is right in general, I only used attribute_method? in the other one cause that's what was already there. \nHypothetically one could have a user model that provides password_confirmation and password_confirmation= methods through means other than an AR/AM attribute. In fact, Devise may do that, oops, it may be the other one that's broken. \nI think respond_to is right here, not sure what's right there I'll look into it more, I think it might be legit to use different guard methods in a factory for writing tests vs a template in the live app. \n. is it possible for an ordinary Spree::User to be viewing the admin backend at all? I guess it doesn't matter for a view test though. \nI believe it does need to be a saved user (with an id) (or something mocked similarly), so generating a path to the admin user edit page for the user will work. \nI am wary of mocking too much, because of other spree/solidus tests that mock so much they become unreliable. \nI think it's prob okay the way it is, most 'realistic' test scenario, but if you require a different approach here just let me know. I suppose it can be create(:user), or a built non-saved user with it's id mocked out so a path can still be generated.... that latter one is not attractive to me for several reasons though. \n. good call. I guess the alternative is promotion_attributes = promotion_attributes.merge(base_code: base_code). Is that what makes sense?\n. done\n. Spree.user_class.new is quicker than factorygirl?  I guess it can be build instead of create if it doesn't need to persist, but I feel like it oughta be an admin user?. Sure, that makes sense, I'll change it to be that.  (I'm not sure it actually has any intentional breaking changes, I couldn't find any; but may have unintentional breaking changes and bugs; and I agree with the principle to not force people to upgrade)\nThis was allowing as low as 0.15.1 before, does that not work on Rails5 at all, I should require at least . done. . ",
    "modreoci": "Ok\n. This is probably the same problem like https://github.com/solidusio/solidus/issues/720\n. here are the JS declaration in head section of the page source code and content of vendor/assets/javascripts/spree/backend/all.js and vendor/assets/javascripts/spree/frontend/all.js files:\nhtml\n<script src=\"/assets/jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js?body=1\"></script>\n<script src=\"/assets/jquery_ujs.self-d602bdfe68ffc63b9f9cc512872aa3cfff046228a0a36e90dd476e8ef54c1b09.js?body=1\"></script>\n<script src=\"/assets/handlebars.self-f34dc7344cb4b7ef71749fc1095378a12419c079a2d058bf69e4a6de17d780eb.js?body=1\"></script>\n<script src=\"/assets/jquery-migrate-1.0.0.self-a44e88afbd8fd3c7aaca1e39b744d8bc214bdde7abe26aa2efedebda507f4f92.js?body=1\"></script>\n<script src=\"/assets/jquery-ui/core.self-93be4d22eda916787802a64d8f88b52db8a9027d4ccbbc0942625324a7d12d44.js?body=1\"></script>\n<script src=\"/assets/jquery-ui/datepicker.self-6267be6d4d0f0e8665be3b4d6ac07f40ba23a32aff8eaa5d1bfc00f76a9eeae7.js?body=1\"></script>\n<script src=\"/assets/jquery-ui/widget.self-c1602241ddc51216b58391768667068867b8e15b9efc722befcd25771eda6819.js?body=1\"></script>\n<script src=\"/assets/jquery-ui/mouse.self-c513294e8da73f31f84ba3ef11e2a1180a47faea0eb2fea4a53fc26153dd21fd.js?body=1\"></script>\n<script src=\"/assets/jquery-ui/sortable.self-df2d80a36f9dfbe0facc596ccd92af83ca50d38e4cd6a84810aaf5d40b8cd181.js?body=1\"></script>\n<script src=\"/assets/jquery-ui/position.self-e693ced4ecfa1a276f0b794f32c1d30d792764b08788bf68ecfa3b388c291333.js?body=1\"></script>\n<script src=\"/assets/jquery-ui/menu.self-7abc1c9401509a7e4fc609b1e461be6fd17e8116e8fda19cc59d05ba79aefb68.js?body=1\"></script>\n<script src=\"/assets/jquery-ui/autocomplete.self-3befc48aba87cead090cfd014562b2771a662ac6d2c8197b24c08b2d9f3d9f2d.js?body=1\"></script>\n<script src=\"/assets/modernizr.self-1ff114e2b7f6561a06bb5aa27cf4fb378a39d5f48f19de021c184f0b943dfdd6.js?body=1\"></script>\n<script src=\"/assets/jquery.cookie.self-1dec4a19b349d7b4ad9cc11e52edff9751d3f21d7bee793dc0cea9fa26b4d643.js?body=1\"></script>\n<script src=\"/assets/jquery.jstree/jquery.jstree.self-4133052a7f69ba15d0e4f85db43d4dc0ff19499b5fc5e512d704ce4b3e92f07b.js?body=1\"></script>\n<script src=\"/assets/jquery.powertip.self-53bcc0f1862902ffcc04fa3d92b36a25e8043c725c2e58892507b5831765d92e.js?body=1\"></script>\n<script src=\"/assets/jquery.vAlign.self-93c2d93d50540ea69bb1947da8c47db1cb999e43a1d44eea64a9c0f905265937.js?body=1\"></script>\n<script src=\"/assets/equalize.self-2429556ce88750e7ac4bc4373e67ead261e1bb45b4256cc22c625ea0a239f787.js?body=1\"></script>\n<script src=\"/assets/responsive-tables.self-4f997e8a9de2e68a2953b3581b9c1b7c70eb93994db16fb6a47ec1edd4042540.js?body=1\"></script>\n<script src=\"/assets/underscore-min.self-021fe858458a21f957db9e00304531d29f0e10edb24dcc4525d17f366e81d4cd.js?body=1\"></script>\n<script src=\"/assets/backbone.self-0977290d5e68ce40d516cd4dc3965586680024e51399f0ee54ee8ed3a99b1506.js?body=1\"></script>\n<script src=\"/assets/jsuri.self-090126b483ac28538a8bd132dce89500493c079744010067a5e79b94f57c0122.js?body=1\"></script>\n<script src=\"/assets/spree.self-37438e395f595cb96942414834c537ac3dcd867099030bf39fa6b1d83bb7a078.js?body=1\"></script>\n<script src=\"/assets/spree/backend/backbone-overrides.self-9a40496b6228e0efe1bf756a14c5c9b04e42bb9d19ea5a8ad8b337de22839c7e.js?body=1\"></script>\n<script src=\"/assets/select2.self-3b8f3d27d1d4f2a9c4aecae89a981946329466fe7ed02d61cbc8e77a77ff4516.js?body=1\"></script>\n<script src=\"/assets/spree/backend/spree-select2.self-c309416c87a8a22af8582a07280e95255071974f4201c8a940ae22d36331e375.js?body=1\"></script>\n<script src=\"/assets/spree/backend/templates/orders/customer_details/autocomplete.self-e072013ea1cadbb36c7b3c8cab8c88913c6415e343c05f7dcc42cf3f9be9e874.js?body=1\"></script>\n<script src=\"/assets/spree/backend/templates/products/sortable.self-666558cc769833b3c0a0b8311d1f41fcd4f4ddcb66209e1bd7a9d66f6115feaa.js?body=1\"></script>\n<script src=\"/assets/spree/backend/templates/promotions/calculators/fields/tiered_flat_rate.self-6114a3c1a60d974735530ffbad5b6a91a91177eb4a314a24e5169d032b31194e.js?body=1\"></script>\n<script src=\"/assets/spree/backend/templates/promotions/calculators/fields/tiered_percent.self-cbd95e4d79e2a45c1e1c0754447974eadd548ae1204ea08694d2823f3837acbd.js?body=1\"></script>\n<script src=\"/assets/spree/backend/templates/promotions/rules/option_values.self-d7aa2ad471690f663aa89137468c8e6b0348826d043050936c838df5369e8ec1.js?body=1\"></script>\n<script src=\"/assets/spree/backend/templates/promotions/rules/option_values_select.self-fd858bcd42aa79b283b7bdc654dc242fced2f219cd7a4d0823c6d92049ab0d4e.js?body=1\"></script>\n<script src=\"/assets/spree/backend/templates/stock_items/stock_location_stock_item.self-45cc5ec743ff81118dff81fbb7addfff02ccf0f366da9c6a18792ec9df5a1a0a.js?body=1\"></script>\n<script src=\"/assets/spree/backend/templates/stock_transfers/transfer_item.self-3b5f4ec97cbd592dcb55dcc13e9f8640bac7b9d13605827eacb0efeace1211d1.js?body=1\"></script>\n<script src=\"/assets/spree/backend/templates/variants/autocomplete.self-1729d0b6641fb4a2c0ec9fd65755743bcef34a7524d1f99b8e5dfd2f480c9d50.js?body=1\"></script>\n<script src=\"/assets/spree/backend/templates/variants/autocomplete_stock.self-fe3b00a03114a7aeccc270aa598e7a7ae58159ea86fd7b1fba861ceb2446bd63.js?body=1\"></script>\n<script src=\"/assets/spree/backend/templates/variants/line_items_autocomplete_stock.self-aab5d6b9daa4e4e5af8774c4b3f5a58fe207d84526403c2863233ad4b7bba66a.js?body=1\"></script>\n<script src=\"/assets/spree/backend/templates/variants/split.self-df63921bff0cad4e23a2fbe6c26826fb26693f8e9af7fe2a407f94081168538e.js?body=1\"></script>\n<script src=\"/assets/spree/backend/address_states.self-ba56176b071bba4b3dd9d37037968c0b14b7f273cd575d92b2366ca0c12d51d2.js?body=1\"></script>\n<script src=\"/assets/spree/backend/adjustments.self-f424dd62e6a97d6d0a68dd249cf0fd6d683ec1103d383fb460a71ea6043e2c01.js?body=1\"></script>\n<script src=\"/assets/spree/backend/admin.self-f7d1243044285da52e929299189b4741f80846988fb399488b0b6c7adfab6d4b.js?body=1\"></script>\n<script src=\"/assets/spree/backend/handlebars_extensions.self-d522a9864dd8b5335c4d3ae50a0a10624423000401114c05b13f1c70d09ad051.js?body=1\"></script>\n<script src=\"/assets/spree/backend/variant_autocomplete.self-1deb1ebd96e171fb3698081dea52a1a0b5cf681d10e5c8acf41d3962a2bd7e96.js?body=1\"></script>\n<script src=\"/assets/spree/backend/taxon_autocomplete.self-b6a8c9219d9d85ad71d64347cead64cd5a27a81c175a4c64b231d4103303c8cd.js?body=1\"></script>\n<script src=\"/assets/spree/backend/option_type_autocomplete.self-eb7e5317365d5664e759645d29aa96ae3a1fdc2fcbd35c8e54b964197c371850.js?body=1\"></script>\n<script src=\"/assets/spree/backend/user_picker.self-67695e426987218e49e41d1ccc3d77dffa3c1f0f83eb436ec67703f41ac03537.js?body=1\"></script>\n<script src=\"/assets/spree/backend/product_picker.self-c7d4184f07154d247b453d32ebe5343a28a4b520c51486d2f753a96eeb0bcc9a.js?body=1\"></script>\n<script src=\"/assets/spree/backend/option_value_picker.self-eb8367fd95bee59fb085fe475aca809b059fd15d017d84c2cdab58f3ef448dba.js?body=1\"></script>\n<script src=\"/assets/spree/backend/taxons.self-9a81c2fa01733baacd3626c61f8dbc2d7ae3ed13fdf35fbedb14a4907a9924f3.js?body=1\"></script>\n<script src=\"/assets/spree/backend/calculator.self-d316b5a2aab2474aeb2511fab6598ae43daa42e10c06bd4c89ad84cc6c72acc2.js?body=1\"></script>\n<script src=\"/assets/spree/backend/checkouts/edit.self-b923c190b35922bd3a9175f547a1897485bed70f66177485e3aec20ab99d5cf2.js?body=1\"></script>\n<script src=\"/assets/spree/backend/flash.self-3d7b30bba992421bbb4b71ade200c4f1f6423d550961a5c0c5c3648e940f71af.js?body=1\"></script>\n<script src=\"/assets/spree/backend/gateway.self-a85d96964a8a83812250f8247581d535702429a72d595644dbc45ab7089b0a6d.js?body=1\"></script>\n<script src=\"/assets/spree/backend/general_settings.self-12aaf193c584799558713dfd457a6002060e3ad092d193794bbbf1dd256ccaf8.js?body=1\"></script>\n<script src=\"/assets/spree/backend/images/index.self-d8c23181e833c0167149bcc6ef2d15fa81a4b1cd654cb7ed2bc72fb1d2e65b61.js?body=1\"></script>\n<script src=\"/assets/spree/backend/images/new.self-12c7302781de0d7e91e4191793b3efabdcedd48c62eb85252bb9b0cf887d835c.js?body=1\"></script>\n<script src=\"/assets/spree/backend/line_items.self-be93006ad766e71220a3ecacb85f44449b853c185736febf59b7e0d165818253.js?body=1\"></script>\n<script src=\"/assets/spree/backend/line_items_on_order_edit.self-74848a6defb7e7b1208a2b92b29728b293d49a7ec7d408163e5189ac2d726a66.js?body=1\"></script>\n<script src=\"/assets/spree/backend/nested-attribute.self-13205b7ec73468859638e5eb0c708500862615d33d63ed65b846dc95c8aca15a.js?body=1\"></script>\n<script src=\"/assets/spree/backend/number_field_updater.self-0d0d45183448d5f1560b4ca26a914673f489e50ee7252af657fb79da2e71aea9.js?body=1\"></script>\n<script src=\"/assets/spree/backend/orders/edit.self-cda8464314692da18ba87c23a78f40890371589017ac878de28366cc139a5d15.js?body=1\"></script>\n<script src=\"/assets/spree/backend/orders/edit_form.self-438a4f9b1b9fa1a46b8ec37b9a7c83b544dc7428b6116860ac8c95d808fbbe2c.js?body=1\"></script>\n<script src=\"/assets/spree/backend/payments/edit.self-3e4b6dd96050703ce8e576511fe32b26b006dc4cd0c3e4b058bcb2f67e13bd72.js?body=1\"></script>\n<script src=\"/assets/jquery.payment.self-983a08c163a6f2b48dc839552b1a8dfb2865a1529721ee3fb950369344cb0d5c.js?body=1\"></script>\n<script src=\"/assets/spree/backend/payments/new.self-9c9785c8204d067b3c7bb53e83c471aab5093107807d5d8dcb4b90d2f33b4aca.js?body=1\"></script>\n<script src=\"/assets/spree/backend/progress.self-abd9595d988639a95a58240eb01f864d5d8ad6faebee50f4472f85d1885d9b56.js?body=1\"></script>\n<script src=\"/assets/spree/backend/promotions.self-8178746956e8f971bd5fc3e1f3f75d0f78323aacad1f4276c33055956086339b.js?body=1\"></script>\n<script src=\"/assets/spree/backend/returns/expedited_exchanges_warning.self-4c028664459e8747b1e16af98cb3d2bfc64c768d4ae9e01be76a8e3cf609d87c.js?body=1\"></script>\n<script src=\"/assets/spree/backend/returns/return_item_selection.self-ba25a0050690c95bf50f28502b8803f5f3e6932710f84cff57e4bb86789bba0c.js?body=1\"></script>\n<script src=\"/assets/spree/backend/routes.self-b1d3e4efba8415ee11602fddc101207e090560c2597fc5a8b04395c398d3ecfb.js?body=1\"></script>\n<script src=\"/assets/spree/backend/select_payments.self-170be1a61db4a50ab371d77e691b6a82144b3a770b9abfdc1a020fab06f177e1.js?body=1\"></script>\n<script src=\"/assets/spree/backend/shipments.self-2bdd2d7c95f885f009edb81e7641dcd4d99ff884484700ed47c3e7237fc06d6b.js?body=1\"></script>\n<script src=\"/assets/spree/backend/states.self-9ff974b696bb334ede5d1d9d01c1258260c07686b8408e32a90996055cfc4333.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_management/index.self-f06bde4c8f8788232ca829488622af0f8d070cc2abdad6e98f39aaa89f96d42a.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_management/index_add_forms.self-c6198ccd7de629074bb9729f19c20eb072a64f18ea76b4c928f04e0070db4d9a.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_management/index_update_forms.self-4cceb695f9a973f685ddc9f90496eb7cff3cb859dc2552abb0059bf31939f6a4.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_management/stock_item.self-2677659d6180b96b8291479ac5e36c47c09da26903b8bd203bd05cbd1f7d8956.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_movement.self-fae812196423ef8dcfb7db5a67fe4177c7b30cac4a0ee064af82c3a899973781.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_transfers/count_update_forms.self-3425d1d8cf2f3df3854bbf46fb0add1652980ddc3b3ae7db475e30efb14df27d.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_transfers/edit.self-c48469c5fb18488c9344c628fff7109f77c9e55117f10ac9c73908215efcc6c0.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_transfers/receive.self-f393d4a887f06118889820559e6fb6c11635d98fb3f26dd2baf6499d61c93161.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_transfers/received_counter.self-46472e878198c689aeebc3813cc391dcef45ae0e003e1c1b63c4a88fc49ae5f0.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_transfers/ship.self-05babe05e2b3c67fa0b881a6697a20216ba6a3f9e226795aa9da6ae606d0e388.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_transfers/stock_transfer.self-622c054c27e35d836a05017dda92c66af8dc2b16276dcd01b8a2407282564601.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_transfers/transfer_item.self-592243220e9bbe84e9c5ee33582e4dc5741e0b06f6fbee632a6c53b2c2b609f7.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_transfers/transfer_item_deleting.self-3c1327e759c6016b5f46652ae619f10c39549daf6e3c24acd8e1b1d5e18af6cc.js?body=1\"></script>\n<script src=\"/assets/spree/backend/stock_transfers/variant_form.self-e5b86ae7c665bc0a94e7a68357842c516a9fd690dc2fc43978cfe504515de44f.js?body=1\"></script>\n<script src=\"/assets/spree/backend/store_credits.self-598cfa68c02b4a7d78bce9d1780c2e549b420d4a905ab8244b9997f8ab8087a3.js?body=1\"></script>\n<script src=\"/assets/spree/backend/taxon_tree_menu.self-ae8cfe2453db5b16dba4143f1eb5396fa5dc5ebbcb44421c5f45ea3c80b40c7d.js?body=1\"></script>\n<script src=\"/assets/spree/backend/taxonomy.self-d3ec6782a2934dff5c7c51cdfde637b8a501e7298347ea8f9d03e99651ce5906.js?body=1\"></script>\n<script src=\"/assets/spree/backend/variant_management.self-7d5e5368aac25bf6e49f975163751a34fd5a59101caf3488d750021430c618f5.js?body=1\"></script>\n<script src=\"/assets/spree/backend/zone.self-d50ab9c1b3fcacc876540a8afccd24c64aa947aef5156959919a804212bafa22.js?body=1\"></script>\n<script src=\"/assets/spree/frontend/backend.self-5dbbb568ea86c98f34e784914c654db223a08758441e4a0566d225be31ad5f97.js?body=1\"></script>\n<script src=\"/assets/spree/backend.self-76f0a23ad5f8028895d20de39faa555dd2d46a6f5d1d6b03b546f9d0156372c5.js?body=1\"></script>\n<script src=\"/assets/spree/backend/translations.self-7bcdcc666225797e4a90e5c359bae576d4b3b295b3a35de401ae9fbbc2486d9c.js?body=1\"></script>\n<script src=\"/assets/spree/backend/solidus_i18n.self-75a11da44c802486bc6f65640aa48a730f0f684c5c07a42ba3cd1735eb3fb070.js?body=1\"></script>\n<script src=\"/assets/spree/backend/solidus_globalize.self-75a11da44c802486bc6f65640aa48a730f0f684c5c07a42ba3cd1735eb3fb070.js?body=1\"></script>\n<script src=\"/assets/spree/backend/all.self-6bc763d76cec2c478cda75a45cba1849fdc646ac84a45db81497ebf4c268d75a.js?body=1\"></script>\nvendor/assets/javascripts/spree/backend/all.js\n``` javascript\n// This is a manifest file that'll be compiled into including all the files listed below.\n// Add new JavaScript/Coffee code in separate files in this directory and they'll automatically\n// be included in the compiled file accessible from http://example.com/assets/application.js\n// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the\n// the compiled file.\n//\n//= require jquery\n//= require jquery_ujs\n//= require spree/backend\n//= require_tree .\n//= require spree/backend/solidus_i18n\n//= require spree/backend/solidus_globalize\n```\nvendor/assets/javascripts/spree/frontend/all.js\n``` javascript\n// This is a manifest file that'll be compiled into including all the files listed below.\n// Add new JavaScript/Coffee code in separate files in this directory and they'll automatically\n// be included in the compiled file accessible from http://example.com/assets/application.js\n// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the\n// the compiled file.\n//\n//= require jquery\n//= require jquery_ujs\n//= require spree/frontend\n//= require_tree .\n//= require spree/frontend/solidus_i18n\n``\n. I'll try...\n. Two times **TypeError: view is null**/assets/jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js?body=1`\n. The first:\ngetStyles()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:6705\njQuery.cssHooks[name].set()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:7217\n.style()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:7141\njQuery.fn[funcName]/<()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:10941\naccess()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:4415\njQuery.fn[funcName]()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:10909\n<anonymn\u00e1>\n core.self-93be4d22eda916787802a64d8f88b52db8a9027d4ccbbc0942625324a7d12d44.js:141\n<anonymn\u00e1>\n core.self-93be4d22eda916787802a64d8f88b52db8a9027d4ccbbc0942625324a7d12d44.js:20\n<anonymn\u00e1>\n core.self-93be4d22eda916787802a64d8f88b52db8a9027d4ccbbc0942625324a7d12d44.js:12\n. The second:\ngetStyles()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:6705\ncurCSS()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:6716\n.css()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:7183\nisHidden()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:4310\nshowHide()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:6909\n.hide()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:7367\njQuery.fn[name]()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:8049\n<anonymn\u00e1>\n jquery.jstree.self-4133052a7f69ba15d0e4f85db43d4dc0ff19499b5fc5e512d704ce4b3e92f07b.js:2701\njQuery.Callbacks/fire()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:3233\njQuery.Callbacks/self.fireWith()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:3363\n.ready()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:3583\ncompleted()\n jquery.self-c64a74367bda6ef8b860f19e74df08927ca99d2be2ac934e9e92d5fd361e0da4.js:3618\n. ``` ruby\nsource 'https://rubygems.org'\nBundle edge Rails instead: gem 'rails', github: 'rails/rails'\ngem 'rails', '4.2.5'\ngem 'solidus', '1.1.1'\ngem 'solidus_auth_devise'\ngem 'rails-i18n'\ngem 'devise-i18n'\ngem 'globalize'\ngem 'solidus_i18n', github: 'solidusio-contrib/solidus_i18n', branch: 'master'\ngem 'solidus_globalize', github: 'solidusio-contrib/solidus_globalize', branch: 'master'\nUse sqlite3 as the database for Active Record\ngem 'pg'\nUse SCSS for stylesheets\ngem 'sass-rails', '~> 5.0'\nUse Uglifier as compressor for JavaScript assets\ngem 'uglifier', '>= 1.3.0'\nUse CoffeeScript for .coffee assets and views\ngem 'coffee-rails', '~> 4.1.0'\nSee https://github.com/rails/execjs#readme for more supported runtimes\ngem 'therubyracer', platforms: :ruby\nUse jquery as the JavaScript library\ngem 'jquery-rails'\nTurbolinks makes following links in your web application faster. Read more: https://github.com/rails/turbolinks\ngem 'turbolinks'\nBuild JSON APIs with ease. Read more: https://github.com/rails/jbuilder\ngem 'jbuilder', '~> 2.0'\nbundle exec rake doc:rails generates the API under doc/api.\ngem 'sdoc', '~> 0.4.0', group: :doc\nfor heroku\ngroup :production do\n  gem 'rails_12factor'\n  gem 'puma'\nend\nUse ActiveModel has_secure_password\ngem 'bcrypt', '~> 3.1.7'\nUse Unicorn as the app server\ngem 'unicorn'\nUse Capistrano for deployment\ngem 'capistrano-rails', group: :development\ngroup :development, :test do\n  # Call 'byebug' anywhere in the code to stop execution and get a debugger console\n  gem 'byebug'\nend\ngroup :development do\n  # Access an IRB console on exception pages or by using <%= console %> in views\n  gem 'web-console', '~> 2.0'\n# Spring speeds up development by keeping your application running in the background. Read more: https://github.com/rails/spring\n  gem 'spring'\nend\nruby \"2.3.0\"\n```\n. Updated... It works! :-)\n. Thanks a lot! ;-)\n. Sorry I'm not very skilled in RoR. I tried it and it produce error in resolving dependencies:\n```\nFetching git://github.com/globalize/globalize.git\nFetching gem metadata from https://rubygems.org/...........\nFetching version metadata from https://rubygems.org/...\nFetching dependency metadata from https://rubygems.org/..\nResolving dependencies...\nBundler could not find compatible versions for gem \"globalize\":\n  In Gemfile:\n    globalize\nsolidus_globalize was resolved to 3.1.0.beta, which depends on\n  globalize (~> 5.0.1)\n\n```\nGemfile:\n``` ruby\nsource 'https://rubygems.org'\nBundle edge Rails instead: gem 'rails', github: 'rails/rails'\ngem 'rails', '4.2.5'\ngem 'solidus', '1.1.1'\ngem 'solidus_auth_devise'\ngem 'rails-i18n'\ngem 'devise-i18n'\ngem 'globalize', github: 'globalize/globalize', branch: 'master'\ngem 'solidus_i18n', github: 'solidusio-contrib/solidus_i18n', branch: 'master'\ngem 'solidus_globalize', github: 'solidusio-contrib/solidus_globalize', branch: 'master'\nUse sqlite3 as the database for Active Record\ngem 'pg'\nUse SCSS for stylesheets\ngem 'sass-rails', '~> 5.0'\nUse Uglifier as compressor for JavaScript assets\ngem 'uglifier', '>= 1.3.0'\nUse CoffeeScript for .coffee assets and views\ngem 'coffee-rails', '~> 4.1.0'\nSee https://github.com/rails/execjs#readme for more supported runtimes\ngem 'therubyracer', platforms: :ruby\nUse jquery as the JavaScript library\ngem 'jquery-rails', '~> 3.1.4'\nTurbolinks makes following links in your web application faster. Read more: https://github.com/rails/turbolinks\ngem 'turbolinks'\nBuild JSON APIs with ease. Read more: https://github.com/rails/jbuilder\ngem 'jbuilder', '~> 2.0'\nbundle exec rake doc:rails generates the API under doc/api.\ngem 'sdoc', '~> 0.4.0', group: :doc\nfor heroku\ngroup :production do\n  gem 'rails_12factor'\n  gem 'puma'\nend\nUse ActiveModel has_secure_password\ngem 'bcrypt', '~> 3.1.7'\nUse Unicorn as the app server\ngem 'unicorn'\nUse Capistrano for deployment\ngem 'capistrano-rails', group: :development\ngroup :development, :test do\n  # Call 'byebug' anywhere in the code to stop execution and get a debugger console\n  gem 'byebug'\nend\ngroup :development do\n  # Access an IRB console on exception pages or by using <%= console %> in views\n  gem 'web-console', '~> 2.0'\n# Spring speeds up development by keeping your application running in the background. Read more: https://github.com/rails/spring\n  gem 'spring'\nend\nruby \"2.3.0\"\n```\n. This one:\n2016-04-09T08:12:37.365850+00:00 app[web.1]:     81:             <td class=\"align-center\"><%= image_tag product.display_image.attachment(:mini) %></td>\n. Here is the response from heroku console:\nirb(main):004:0> Spree::Product.last.display_image\n  Spree::Product Load (2.4ms)  SELECT  \"spree_products\".* FROM \"spree_products\" WHERE \"spree_products\".\"deleted_at\" IS NULL  ORDER BY \"spree_products\".\"id\" DESC LIMIT 1\n  Spree::Product Load (2.4ms)  SELECT  \"spree_products\".* FROM \"spree_products\" WHERE \"spree_products\".\"deleted_at\" IS NULL  ORDER BY \"spree_products\".\"id\" DESC LIMIT 1\n  Spree::Variant Load (1.4ms)  SELECT  \"spree_variants\".* FROM \"spree_variants\" WHERE \"spree_variants\".\"deleted_at\" IS NULL AND \"spree_variants\".\"product_id\" = $1 AND \"spree_variants\".\"is_master\" = $2 LIMIT 1  [[\"product_id\", 5], [\"is_master\", \"t\"]]\n  Spree::Variant Load (1.4ms)  SELECT  \"spree_variants\".* FROM \"spree_variants\" WHERE \"spree_variants\".\"deleted_at\" IS NULL AND \"spree_variants\".\"product_id\" = $1 AND \"spree_variants\".\"is_master\" = $2 LIMIT 1  [[\"product_id\", 5], [\"is_master\", \"t\"]]\n  Spree::Image Load (1.4ms)  SELECT  \"spree_assets\".* FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_id\" = $1 AND \"spree_assets\".\"viewable_type\" = $2 AND \"spree_assets\".\"type\" IN ('Spree::Image')  ORDER BY \"spree_assets\".\"position\" ASC LIMIT 1  [[\"viewable_id\", 5], [\"viewable_type\", \"Spree::Variant\"]]\n  Spree::Image Load (1.4ms)  SELECT  \"spree_assets\".* FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_id\" = $1 AND \"spree_assets\".\"viewable_type\" = $2 AND \"spree_assets\".\"type\" IN ('Spree::Image')  ORDER BY \"spree_assets\".\"position\" ASC LIMIT 1  [[\"viewable_id\", 5], [\"viewable_type\", \"Spree::Variant\"]]\n  Spree::Image Load (1.7ms)  SELECT  \"spree_assets\".* FROM \"spree_assets\" INNER JOIN \"spree_variants\" ON \"spree_assets\".\"viewable_id\" = \"spree_variants\".\"id\" WHERE \"spree_variants\".\"deleted_at\" IS NULL AND \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_variants\".\"product_id\" = $1 AND \"spree_assets\".\"viewable_type\" = $2 AND \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"type\" IN ('Spree::Image')  ORDER BY \"spree_assets\".\"position\" ASC, \"spree_variants\".\"position\" ASC LIMIT 1  [[\"product_id\", 5], [\"viewable_type\", \"Spree::Variant\"]]\n  Spree::Image Load (1.7ms)  SELECT  \"spree_assets\".* FROM \"spree_assets\" INNER JOIN \"spree_variants\" ON \"spree_assets\".\"viewable_id\" = \"spree_variants\".\"id\" WHERE \"spree_variants\".\"deleted_at\" IS NULL AND \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_variants\".\"product_id\" = $1 AND \"spree_assets\".\"viewable_type\" = $2 AND \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"type\" IN ('Spree::Image')  ORDER BY \"spree_assets\".\"position\" ASC, \"spree_variants\".\"position\" ASC LIMIT 1  [[\"product_id\", 5], [\"viewable_type\", \"Spree::Variant\"]]\n=> #<Spree::Image id: nil, viewable_id: nil, viewable_type: nil, attachment_width: nil, attachment_height: nil, attachment_file_size: nil, position: nil, attachment_content_type: nil, attachment_file_name: nil, type: \"Spree::Image\", attachment_updated_at: nil, alt: nil, created_at: nil, updated_at: nil>\n. The same behavior also on localhost... :-(\n\nlocalhost console output:\n2.3.0 :001 > Spree::Product.last.display_image\n  Spree::Product Load (2.5ms)  SELECT  \"spree_products\".* FROM \"spree_products\" WHERE \"spree_products\".\"deleted_at\" IS NULL  ORDER BY \"spree_products\".\"id\" DESC LIMIT 1\n  Spree::Variant Load (1.3ms)  SELECT  \"spree_variants\".* FROM \"spree_variants\" WHERE \"spree_variants\".\"deleted_at\" IS NULL AND \"spree_variants\".\"product_id\" = $1 AND \"spree_variants\".\"is_master\" = $2 LIMIT 1  [[\"product_id\", 11], [\"is_master\", \"t\"]]\n  Spree::Image Load (1.1ms)  SELECT  \"spree_assets\".* FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_id\" = $1 AND \"spree_assets\".\"viewable_type\" = $2 AND \"spree_assets\".\"type\" IN ('Spree::Image')  ORDER BY \"spree_assets\".\"position\" ASC LIMIT 1  [[\"viewable_id\", 24], [\"viewable_type\", \"Spree::Variant\"]]\n  Spree::Image Load (1.2ms)  SELECT  \"spree_assets\".* FROM \"spree_assets\" INNER JOIN \"spree_variants\" ON \"spree_assets\".\"viewable_id\" = \"spree_variants\".\"id\" WHERE \"spree_variants\".\"deleted_at\" IS NULL AND \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_variants\".\"product_id\" = $1 AND \"spree_assets\".\"viewable_type\" = $2 AND \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"type\" IN ('Spree::Image')  ORDER BY \"spree_assets\".\"position\" ASC, \"spree_variants\".\"position\" ASC LIMIT 1  [[\"product_id\", 11], [\"viewable_type\", \"Spree::Variant\"]]\n => #<Spree::Image id: nil, viewable_id: nil, viewable_type: nil, attachment_width: nil, attachment_height: nil, attachment_file_size: nil, position: nil, attachment_content_type: nil, attachment_file_name: nil, type: \"Spree::Image\", attachment_updated_at: nil, alt: nil, created_at: nil, updated_at: nil>\n. Here is the only modification I did in spree.rb accordin the recomendation:\n``` ruby\nSpree.user_class = \"Spree::LegacyUser\"\nattachment_config = {\ns3_credentials: {\n    access_key_id:     ENV['AWS_ACCESS_KEY_ID'],\n    secret_access_key: ENV['AWS_SECRET_ACCESS_KEY'],\n    bucket:            ENV['S3_BUCKET_NAME']\n  },\nstorage:        :s3,\n  s3_headers:     { \"Cache-Control\" => \"max-age=31557600\" },\n  s3_protocol:    \"https\",\n  bucket:         ENV['S3_BUCKET_NAME'],\n  url:            \":s3_domain_url\",\nstyles: {\n      mini:     \"48x48>\",\n      small:    \"100x100>\",\n      product:  \"240x240>\",\n      large:    \"600x600>\"\n  },\npath:           \"/:class/:id/:style/:basename.:extension\",\n  default_url:    \"/:class/:id/:style/:basename.:extension\",\n  default_style:  \"product\"\n}\nattachment_config.each do |key, value|\n  Spree::Image.attachment_definitions[:attachment][key.to_sym] = value\nend\n```\n. ",
    "cindyward1": "Hi Clarke, thank you for your prompt response.\nThe problem occurs with the relatively-new selectable part/variant feature of spree-product-assembly, of which I am still exploring all of the implications. The feature allows the user to select the variant of the part that they want included with the bundle. For example, if you have a bundle of a T-shirt part and a bag part, you can select in the product show view whether you want a blue size L or a green size XL T-shirt, etc. After the user clicks the add to cart button, the selected_variant ends up in params[:options] in the orders_controller. The logic for handling the bundle expects the \"selected variants\" information to be in the options argument. When it tries to get the information out of the options hash, there's nothing there, and so the code aborts.\nHere's the error from the spree-product-assembly's test suite:\n1) Adding items to the cart when adding a bundle to the cart when one of the bundle items has a user-selectable variant the cart includes the variant when listing bundle items\u00a0 \u00a0 \u00a0\nFailure/Error: click_button \"add-to-cart-button\"\u00a0 \u00a0\nNoMethodError:\u00a0 \u00a0 \u00a0 \u00a0undefined method []' for nil:NilClass\u00a0 \u00a0 \u00a0# ./app/models/spree/order_contents_decorator.rb:67:invariant_id_for'\nHere's the variant_id_for method that's encountering the problem (from order_contents_decorator.rb that is modifying core/app/models/spree/order_contents.rb):\ndef variant_id_for(part, selected_variants)\n  if part.variant_selection_deferred?\n    selected_variants[part.id.to_s]\n  else\n    part.part.id\n  end\nend\nIf variant selection has been deferred, it expects to see the selected variants in the options hash (which is passed to this method as selected_variants). Since the hash is empty, trying to find a value for a non-existent key fails, thus the nil:NilClass error.\nWhen I look at the core/app/models/spree/order_contents.rb, many of the methods pass an options parameter as options = {}. This leads me to believe that the authors of the code intended to allow the possibility of the option hash's not being empty. The authors of spree-product-assembly used this possibility to implement their code, but Solidus removed it which guarantees that the options hash will be empty when the order is populated. I'm asking for it to be put back because the logic to create line items for user selected parts/variants requires params[:options] from the view. There may be other functionality in the future that also wishes to use the options hash to pass information into the order populator.\nPlease let me know if you need more information. Thanks again for your response ... Cindy\n. I apologize that I did not address your question about a WIP repository in my previous response. My spree-product-assembly port is pretty broken right now, but hopefully I'll have it in much better shape by the end of Monday. I'll LYK when I push a WIP release out to solidus_product_assembly on Trial Guides' github. What's in there now is an unmodified copy of spree-product-assembly, and it won't even bundle install in its current state.\n. I talked to Allison, and I'm working on some specs.. The documentation for Spree::LineItem says that #options=  \"Sets options on the line item and updates the price. The options can be arbitrary attributes on the LineItem.\"\nThe ability to set arbitrary line item options does not seem to be tested in core/spec/models/spree/order_contents_spec.rb or core/spec/models/spree/line_item_spec_rb. line_item_spec.rb tests options that update price but not arbitrary options. order_contents_spec.rb appears to ignore options altogether.\n@mamhoff may be right about the disproportionate amount of spec setup.. ",
    "jcjohn-ultd": "I am having the same issue in version 1.2.0. Looking into the issue, I am getting HandlebarsTemplates is not defined in variant-autocomplete.js line 5. Other than that, the link, Add Taxon, goes to the taxonomy path like the view code indicates it should.\n. I am sorry I wrote such a vague report. Here are more details:\nI am currently running a fresh install in development mode.\nGemfile\n```\nsource 'https://rubygems.org'\nruby '2.1.6'\ngem 'rails', '4.2.5.1'\ngem 'pg', '~> 0.15'\ngem 'sass-rails', '~> 5.0'\ngem 'uglifier', '>= 1.3.0'\ngem 'coffee-rails', '~> 4.1.0'\ngem 'jquery-rails'\ngem 'turbolinks'\ngem 'jbuilder', '~> 2.0'\ngem 'sdoc', '~> 0.4.0', group: :doc\ngroup :development, :test do\n  gem 'byebug'\nend\ngroup :development do\n  gem 'web-console', '~> 2.0'\n  gem 'spring'\nend\ngem 'refinerycms', '~> 3.0.0'\ngem 'quiet_assets', :group => :development\ngem 'refinerycms-acts-as-indexed', ['~> 2.0', '>= 2.0.0']\ngem 'refinerycms-wymeditor', ['~> 1.0', '>= 1.0.6']\ngem 'sprockets-rails', '~> 2.0'\ngem 'truncate_html', '0.9.2'\ngem 'solidus', '~> 1.2.0'\ngem 'solidus_auth_devise'\ngem 'solidus-refinerycms-authentication', github: 'refinerycms-contrib/solidus-refinery-authentication', branch: 'master'\n```\n\n. It seems my problem is related to something else. A straight install of the latest solidus seems to have fixed the issue.\n. ",
    "CallMeSH": "Hey, \nHere is my Gemfile.lock:\n```\nGIT\n  remote: https://github.com/solidusio/solidus.git\n  revision: 56227745e8de5ec8d1be40f5d050ddd68b668016\n  tag: v1.2.0.rc1\n  specs:\n    solidus_api (1.2.0.rc1)\n      rabl (>= 0.9.4.pre1, < 0.12.0)\n      solidus_core (= 1.2.0.rc1)\n      versioncake (~> 2.3.1)\n    solidus_backend (1.2.0.rc1)\n      bourbon (>= 4, < 6)\n      handlebars_assets\n      jquery-rails\n      jquery-ui-rails (~> 5.0.0)\n      select2-rails (= 3.5.9.1)\n      solidus_api (= 1.2.0.rc1)\n      solidus_core (= 1.2.0.rc1)\n    solidus_core (1.2.0.rc1)\n      activemerchant (~> 1.48.0)\n      acts_as_list (~> 0.3)\n      awesome_nested_set (~> 3.0.1)\n      cancancan (~> 1.10)\n      carmen (~> 1.0.0)\n      ffaker (~> 1.16)\n      font-awesome-rails (~> 4.0)\n      friendly_id (~> 5.0)\n      highline (~> 1.6.18)\n      json (~> 1.7)\n      kaminari (~> 0.15, >= 0.15.1)\n      monetize (~> 1.1)\n      paperclip (~> 4.2.0)\n      paranoia (~> 2.1.4)\n      premailer-rails\n      rails (~> 4.2.0)\n      ransack (~> 1.6.0)\n      responders\n      sprockets-rails (~> 2.0)\n      state_machines-activerecord (~> 0.2)\n      stringex (~> 1.5.1)\n      truncate_html (= 0.9.2)\n      twitter_cldr (~> 3.0)\nGEM\n  remote: https://rubygems.org/\n  specs:\n    actionmailer (4.2.5)\n      actionpack (= 4.2.5)\n      actionview (= 4.2.5)\n      activejob (= 4.2.5)\n      mail (~> 2.5, >= 2.5.4)\n      rails-dom-testing (~> 1.0, >= 1.0.5)\n    actionpack (4.2.5)\n      actionview (= 4.2.5)\n      activesupport (= 4.2.5)\n      rack (~> 1.6)\n      rack-test (~> 0.6.2)\n      rails-dom-testing (~> 1.0, >= 1.0.5)\n      rails-html-sanitizer (~> 1.0, >= 1.0.2)\n    actionview (4.2.5)\n      activesupport (= 4.2.5)\n      builder (~> 3.1)\n      erubis (~> 2.7.0)\n      rails-dom-testing (~> 1.0, >= 1.0.5)\n      rails-html-sanitizer (~> 1.0, >= 1.0.2)\n    activejob (4.2.5)\n      activesupport (= 4.2.5)\n      globalid (>= 0.3.0)\n    activemerchant (1.48.0)\n      activesupport (>= 3.2.14, < 5.0.0)\n      builder (>= 2.1.2, < 4.0.0)\n      i18n (>= 0.6.9)\n      nokogiri (~> 1.4)\n    activemodel (4.2.5)\n      activesupport (= 4.2.5)\n      builder (~> 3.1)\n    activerecord (4.2.5)\n      activemodel (= 4.2.5)\n      activesupport (= 4.2.5)\n      arel (~> 6.0)\n    activerecord-postgis-adapter (3.1.3)\n      activerecord (~> 4.2)\n      rgeo-activerecord (>= 4.0.4)\n    activesupport (4.2.5)\n      i18n (~> 0.7)\n      json (~> 1.7, >= 1.7.7)\n      minitest (~> 5.1)\n      thread_safe (~> 0.3, >= 0.3.4)\n      tzinfo (~> 1.1)\n    acts_as_list (0.7.2)\n      activerecord (>= 3.0)\n    addressable (2.4.0)\n    arel (6.0.3)\n    awesome_nested_set (3.0.2)\n      activerecord (>= 4.0.0, < 5)\n    bcrypt (3.1.10)\n    binding_of_caller (0.7.2)\n      debug_inspector (>= 0.0.1)\n    bourbon (4.2.6)\n      sass (~> 3.4)\n      thor (~> 0.19)\n    builder (3.2.2)\n    byebug (8.2.1)\n    camertron-eprun (1.1.0)\n    cancancan (1.13.1)\n    carmen (1.0.2)\n      activesupport (>= 3.0.0)\n    cldr-plurals-runtime-rb (1.0.1)\n    climate_control (0.0.3)\n      activesupport (>= 3.0)\n    cocaine (0.5.8)\n      climate_control (>= 0.0.3, < 1.0)\n    coffee-rails (4.1.1)\n      coffee-script (>= 2.2.0)\n      railties (>= 4.0.0, < 5.1.x)\n    coffee-script (2.4.1)\n      coffee-script-source\n      execjs\n    coffee-script-source (1.10.0)\n    colorize (0.7.7)\n    concurrent-ruby (1.0.0)\n    css_parser (1.3.7)\n      addressable\n    debug_inspector (0.0.2)\n    deface (1.0.2)\n      colorize (>= 0.5.8)\n      nokogiri (~> 1.6.0)\n      polyglot\n      rails (>= 3.1)\n    devise (3.5.4)\n      bcrypt (~> 3.0)\n      orm_adapter (~> 0.1)\n      railties (>= 3.2.6, < 5)\n      responders\n      thread_safe (~> 0.1)\n      warden (~> 1.2.3)\n    devise-encryptable (0.1.2)\n      devise (>= 2.1.0)\n    diff-lcs (1.2.5)\n    doorkeeper (3.1.0)\n      railties (>= 3.2)\n    erubis (2.7.0)\n    execjs (2.6.0)\n    factory_girl (4.5.0)\n      activesupport (>= 3.0.0)\n    factory_girl_rails (4.5.0)\n      factory_girl (~> 4.5.0)\n      railties (>= 3.0.0)\n    ffaker (1.32.1)\n    font-awesome-rails (4.5.0.0)\n      railties (>= 3.2, < 5.0)\n    friendly_id (5.1.0)\n      activerecord (>= 4.0.0)\n    globalid (0.3.6)\n      activesupport (>= 4.1.0)\n    handlebars_assets (0.22.0)\n      execjs (~> 2.0)\n      multi_json (~> 1.0)\n      sprockets (>= 2.0.0, < 4.0)\n      tilt (~> 1.2)\n    highline (1.6.21)\n    htmlentities (4.3.4)\n    i18n (0.7.0)\n    jbuilder (2.4.0)\n      activesupport (>= 3.0.0, < 5.1)\n      multi_json (~> 1.2)\n    jquery-rails (4.1.0)\n      rails-dom-testing (~> 1.0)\n      railties (>= 4.2.0)\n      thor (>= 0.14, < 2.0)\n    jquery-ui-rails (5.0.5)\n      railties (>= 3.2.16)\n    json (1.8.3)\n    kaminari (0.16.3)\n      actionpack (>= 3.0.0)\n      activesupport (>= 3.0.0)\n    loofah (2.0.3)\n      nokogiri (>= 1.5.9)\n    mail (2.6.3)\n      mime-types (>= 1.16, < 3)\n    mime-types (2.99)\n    mini_portile2 (2.0.0)\n    minitest (5.8.3)\n    monetize (1.4.0)\n      money (~> 6.7)\n    money (6.7.0)\n      i18n (>= 0.6.4, <= 0.7.0)\n      sixarm_ruby_unaccent (>= 1.1.1, < 2)\n    multi_json (1.11.2)\n    nokogiri (1.6.7.1)\n      mini_portile2 (~> 2.0.0.rc2)\n    orm_adapter (0.5.0)\n    paperclip (4.2.4)\n      activemodel (>= 3.2.0)\n      activesupport (>= 3.2.0)\n      cocaine (~> 0.5.5)\n      mime-types\n    paranoia (2.1.5)\n      activerecord (~> 4.0)\n    pg (0.18.4)\n    polyamorous (1.3.0)\n      activerecord (>= 3.0)\n    polyglot (0.3.5)\n    premailer (1.8.6)\n      css_parser (>= 1.3.6)\n      htmlentities (>= 4.0.0)\n    premailer-rails (1.9.0)\n      actionmailer (>= 3, < 5)\n      premailer (~> 1.7, >= 1.7.9)\n    rabl (0.11.8)\n      activesupport (>= 2.3.14)\n    rack (1.6.4)\n    rack-test (0.6.3)\n      rack (>= 1.0)\n    rails (4.2.5)\n      actionmailer (= 4.2.5)\n      actionpack (= 4.2.5)\n      actionview (= 4.2.5)\n      activejob (= 4.2.5)\n      activemodel (= 4.2.5)\n      activerecord (= 4.2.5)\n      activesupport (= 4.2.5)\n      bundler (>= 1.3.0, < 2.0)\n      railties (= 4.2.5)\n      sprockets-rails\n    rails-deprecated_sanitizer (1.0.3)\n      activesupport (>= 4.2.0.alpha)\n    rails-dom-testing (1.0.7)\n      activesupport (>= 4.2.0.beta, < 5.0)\n      nokogiri (~> 1.6.0)\n      rails-deprecated_sanitizer (>= 1.0.1)\n    rails-html-sanitizer (1.0.2)\n      loofah (~> 2.0)\n    railties (4.2.5)\n      actionpack (= 4.2.5)\n      activesupport (= 4.2.5)\n      rake (>= 0.8.7)\n      thor (>= 0.18.1, < 2.0)\n    rake (10.5.0)\n    ransack (1.6.6)\n      actionpack (>= 3.0)\n      activerecord (>= 3.0)\n      activesupport (>= 3.0)\n      i18n\n      polyamorous (~> 1.2)\n    rdoc (4.2.1)\n      json (~> 1.4)\n    responders (2.1.1)\n      railties (>= 4.2.0, < 5.1)\n    rgeo (0.5.2)\n    rgeo-activerecord (4.0.5)\n      activerecord (~> 4.2)\n      rgeo (~> 0.3)\n    rspec-core (3.4.1)\n      rspec-support (~> 3.4.0)\n    rspec-expectations (3.4.0)\n      diff-lcs (>= 1.2.0, < 2.0)\n      rspec-support (~> 3.4.0)\n    rspec-mocks (3.4.1)\n      diff-lcs (>= 1.2.0, < 2.0)\n      rspec-support (~> 3.4.0)\n    rspec-rails (3.4.0)\n      actionpack (>= 3.0, < 4.3)\n      activesupport (>= 3.0, < 4.3)\n      railties (>= 3.0, < 4.3)\n      rspec-core (~> 3.4.0)\n      rspec-expectations (~> 3.4.0)\n      rspec-mocks (~> 3.4.0)\n      rspec-support (~> 3.4.0)\n    rspec-support (3.4.1)\n    sass (3.4.21)\n    sass-rails (5.0.4)\n      railties (>= 4.0.0, < 5.0)\n      sass (~> 3.1)\n      sprockets (>= 2.8, < 4.0)\n      sprockets-rails (>= 2.0, < 4.0)\n      tilt (>= 1.1, < 3)\n    sdoc (0.4.1)\n      json (~> 1.7, >= 1.7.7)\n      rdoc (~> 4.0)\n    select2-rails (3.5.9.1)\n      thor (~> 0.14)\n    sixarm_ruby_unaccent (1.1.1)\n    solidus_auth_devise (1.3.0)\n      deface (~> 1.0.0)\n      devise (~> 3.5.1)\n      devise-encryptable (= 0.1.2)\n      json\n      multi_json\n      solidus_core (>= 1.1.0.alpha, < 2)\n    spring (1.6.2)\n    sprockets (3.5.2)\n      concurrent-ruby (~> 1.0)\n      rack (> 1, < 3)\n    sprockets-rails (2.3.3)\n      actionpack (>= 3.0)\n      activesupport (>= 3.0)\n      sprockets (>= 2.8, < 4.0)\n    state_machines (0.4.0)\n    state_machines-activemodel (0.3.0)\n      activemodel (~> 4.1)\n      state_machines (>= 0.4.0)\n    state_machines-activerecord (0.3.0)\n      activerecord (~> 4.1)\n      state_machines-activemodel (>= 0.3.0)\n    stringex (1.5.1)\n    thor (0.19.1)\n    thread_safe (0.3.5)\n    tilt (1.4.1)\n    timecop (0.8.0)\n    timeliness (0.3.8)\n    truncate_html (0.9.2)\n    turbolinks (2.5.3)\n      coffee-rails\n    twitter_cldr (3.2.1)\n      camertron-eprun\n      cldr-plurals-runtime-rb (~> 1.0.0)\n      json\n      tzinfo\n    tzinfo (1.2.2)\n      thread_safe (~> 0.1)\n    uglifier (2.7.2)\n      execjs (>= 0.3.0)\n      json (>= 1.8.0)\n    validates_timeliness (4.0.2)\n      timeliness (~> 0.3.7)\n    versioncake (2.3.1)\n      actionpack (>= 3.2)\n      activesupport (>= 3.2)\n      railties (>= 3.2)\n      tzinfo\n    warden (1.2.4)\n      rack (>= 1.0)\n    web-console (2.2.1)\n      activemodel (>= 4.0)\n      binding_of_caller (>= 0.7.2)\n      railties (>= 4.0)\n      sprockets-rails (>= 2.0, < 4.0)\nPLATFORMS\n  ruby\nDEPENDENCIES\n  activerecord-postgis-adapter (~> 3.1)\n  byebug\n  coffee-rails (~> 4.1.0)\n  doorkeeper (~> 3.1)\n  factory_girl_rails (~> 4.5)\n  jbuilder (~> 2.0)\n  jquery-rails\n  pg (~> 0.18.4)\n  rabl (~> 0.11.8)\n  rails (= 4.2.5)\n  rspec-rails (~> 3.0)\n  sass-rails (~> 5.0)\n  sdoc (~> 0.4.0)\n  solidus_auth_devise (~> 1.3, >= 1.3.0)\n  solidus_backend!\n  solidus_core!\n  spring\n  timecop (~> 0.8.0)\n  turbolinks\n  uglifier (>= 1.3.0)\n  validates_timeliness (~> 4.0)\n  versioncake (~> 2.3.1)\n  web-console (~> 2.0)\nBUNDLED WITH\n   1.10.6\n```\nNo particular configuration made, no stock configuration made.\nThe exception happens when I run next! on that order:\n{\n  \"id\": 4,\n  \"number\": \"R797163544\",\n  \"item_total\": \"15.0\",\n  \"total\": \"15.0\",\n  \"ship_total\": \"0.0\",\n  \"state\": \"address\",\n  \"adjustment_total\": \"0.0\",\n  \"user_id\": null,\n  \"created_at\": \"2016-01-21T18:34:02.551+01:00\",\n  \"updated_at\": \"2016-01-21T18:44:44.567+01:00\",\n  \"completed_at\": null,\n  \"payment_total\": \"0.0\",\n  \"shipment_state\": null,\n  \"payment_state\": null,\n  \"email\": null,\n  \"special_instructions\": null,\n  \"channel\": \"spree\",\n  \"included_tax_total\": \"0.0\",\n  \"additional_tax_total\": \"0.0\",\n  \"display_included_tax_total\": \"\u20ac0.00\",\n  \"display_additional_tax_total\": \"\u20ac0.00\",\n  \"tax_total\": \"0.0\",\n  \"currency\": \"EUR\",\n  \"covered_by_store_credit\": false,\n  \"display_total_applicable_store_credit\": \"\u20ac0.00\",\n  \"order_total_after_store_credit\": \"15.0\",\n  \"display_order_total_after_store_credit\": \"\u20ac15.00\",\n  \"total_applicable_store_credit\": 0.0,\n  \"display_total_available_store_credit\": \"\u20ac0.00\",\n  \"display_store_credit_remaining_after_capture\": \"\u20ac0.00\",\n  \"display_item_total\": \"\u20ac15.00\",\n  \"total_quantity\": 5,\n  \"display_total\": \"\u20ac15.00\",\n  \"display_ship_total\": \"\u20ac0.00\",\n  \"display_tax_total\": \"\u20ac0.00\",\n  \"token\": \"sgjtrDj3ePeRWa2aptA6zQ\",\n  \"checkout_steps\": [\n    \"address\",\n    \"delivery\",\n    \"payment\",\n    \"confirm\",\n    \"complete\"\n  ],\n  \"payment_methods\": [],\n  \"bill_address\": {\n    \"id\": 1,\n    \"firstname\": \"Charles-Henri\",\n    \"lastname\": \"DUMALIN\",\n    \"full_name\": \"Charles-Henri DUMALIN\",\n    \"address1\": \"36 Rue des Tours\",\n    \"address2\": null,\n    \"city\": \"Paris\",\n    \"zipcode\": \"75000\",\n    \"phone\": \"06666666\",\n    \"company\": null,\n    \"alternative_phone\": null,\n    \"country_id\": 75,\n    \"state_id\": 924,\n    \"state_name\": null,\n    \"state_text\": \"O\",\n    \"country\": {\n      \"id\": 75,\n      \"iso_name\": \"FRANCE\",\n      \"iso\": \"FR\",\n      \"iso3\": \"FRA\",\n      \"name\": \"France\",\n      \"numcode\": 250\n    },\n    \"state\": {\n      \"id\": 924,\n      \"name\": \"Nord-Pas-de-Calais\",\n      \"abbr\": \"O\",\n      \"country_id\": 75\n    }\n  },\n  \"ship_address\": {\n    \"id\": 1,\n    \"firstname\": \"Charles-Henri\",\n    \"lastname\": \"DUMALIN\",\n    \"full_name\": \"Charles-Henri DUMALIN\",\n    \"address1\": \"36 Rue des Tours\",\n    \"address2\": null,\n    \"city\": \"Paris\",\n    \"zipcode\": \"75000\",\n    \"phone\": \"06666666\",\n    \"company\": null,\n    \"alternative_phone\": null,\n    \"country_id\": 75,\n    \"state_id\": 924,\n    \"state_name\": null,\n    \"state_text\": \"O\",\n    \"country\": {\n      \"id\": 75,\n      \"iso_name\": \"FRANCE\",\n      \"iso\": \"FR\",\n      \"iso3\": \"FRA\",\n      \"name\": \"France\",\n      \"numcode\": 250\n    },\n    \"state\": {\n      \"id\": 924,\n      \"name\": \"Nord-Pas-de-Calais\",\n      \"abbr\": \"O\",\n      \"country_id\": 75\n    }\n  },\n  \"line_items\": [\n    {\n      \"id\": 2,\n      \"quantity\": 5,\n      \"price\": \"3.0\",\n      \"variant_id\": 2,\n      \"variant\": {\n        \"product_id\": 2,\n        \"id\": 2,\n        \"name\": \"Vin de pays\",\n        \"sku\": \"VIN-123\",\n        \"price\": \"3.0\",\n        \"weight\": \"0.0\",\n        \"height\": null,\n        \"width\": null,\n        \"depth\": null,\n        \"is_master\": true,\n        \"slug\": \"vin-de-pays\",\n        \"description\": \"\",\n        \"track_inventory\": false,\n        \"option_values\": [],\n        \"images\": [],\n        \"display_price\": \"\u20ac3.00\",\n        \"options_text\": \"\",\n        \"in_stock\": true,\n        \"is_backorderable\": true,\n        \"total_on_hand\": null,\n        \"is_destroyed\": false\n      },\n      \"adjustments\": [],\n      \"single_display_amount\": \"\u20ac3.00\",\n      \"display_amount\": \"\u20ac15.00\",\n      \"total\": \"15.0\"\n    }\n  ],\n  \"payments\": [],\n  \"shipments\": [\n    {\n      \"id\": 15,\n      \"tracking\": null,\n      \"number\": \"H07521527448\",\n      \"cost\": \"0.0\",\n      \"shipped_at\": null,\n      \"state\": \"pending\",\n      \"shipping_rates\": [\n        {\n          \"id\": 1,\n          \"name\": \"Test shipping\",\n          \"cost\": \"5.0\",\n          \"selected\": true,\n          \"shipping_method_id\": 1,\n          \"shipping_method_code\": \"\",\n          \"display_cost\": \"\u20ac5.00\"\n        }\n      ],\n      \"selected_shipping_rate\": {\n        \"id\": 1,\n        \"name\": \"Test shipping\",\n        \"cost\": \"5.0\",\n        \"selected\": true,\n        \"shipping_method_id\": 1,\n        \"shipping_method_code\": \"\",\n        \"display_cost\": \"\u20ac5.00\"\n      },\n      \"shipping_methods\": [\n        {\n          \"id\": 1,\n          \"code\": \"\",\n          \"name\": \"Test shipping\",\n          \"zones\": [\n            {\n              \"id\": 1,\n              \"name\": \"EU_VAT\",\n              \"description\": \"Countries that make up the EU VAT zone.\"\n            }\n          ],\n          \"shipping_categories\": [\n            {\n              \"id\": 1,\n              \"name\": \"Default\"\n            }\n          ]\n        }\n      ],\n      \"manifest\": [\n        {\n          \"variant_id\": 2,\n          \"quantity\": 5,\n          \"states\": {\n            \"on_hand\": 5\n          }\n        }\n      ],\n      \"adjustments\": [],\n      \"order_id\": \"R797163544\",\n      \"stock_location_name\": \"default\"\n    }\n  ],\n  \"adjustments\": [],\n  \"credit_cards\": []\n}\n. I can confirm the fix \n. I can confirm it's fixed!\nConfgratulations :thumbsup:\n. Unfortunately no, still waiting for help from the Solidus team. \n. ",
    "manoharkshetty": "We are also facing the issue with version 1.1.1.\n. ",
    "wuboy0307": "I want the speed of static preference, but also want to make the preference updatable in admin web, not just by initializer. \nadmin web can be managed by any one who has privilege. But initializer can only be touched by developers who can modify source code and check in. \nFor example, if I change send_core_emails setting in admin web. In your version of source code, this change will be reverted next time I restart the server unless I add them into initializer. But in my version, I update static preference and persist the data as well. Next time when server restart, it will eager load the persist data to static preference, so the change will still be there, and data will still be fetched from static preference from now on.\nFurther more, even there are more than one server. Once configuration has been changed by one server. another server can just call use_static_preferences! again to reload from database without restart (of course you need a button to do so in admin web). In your version, there's nothing you can do.\nWhat I want to clarify is: a configuration is something you can always change in admin web. If I want some hash data which can only load on initialization time. Why don't I just use a yaml file and load it into a hash?\n. ",
    "Murph33": "Will do, thanks!\n. So I feel totally happy with the first commit I just have one thing I want to touch base on before I set up a PR.\nhttps://github.com/magiclabs/solidus/commit/056dfdfb74ef137fc5d05454016df9176f3e8eaf#diff-3\nHere you've changed away from including the span using a content tag as part of the label to just writing it out explicitly.  The only functional difference is obviously clicking the * now won't select the field.  Just wanted to address this other change before putting in a PR since it isn't really part of switching to better I18n use.  I don't' know if across the entire project this will increase or decrease consistency or if one of these is generally a better practice we want to use.\n. :+1: Will do.\n. Appears to be some orphan Spree.t(:back_to_countries_list) translation that doesn't even have an entry in the en.yml\nIt only shows up on the admin page when you're adding or editing a country\nhttps://github.com/solidusio/solidus/blob/master/backend/app/views/spree/admin/countries/new.html.erb\nhttps://github.com/solidusio/solidus/blob/master/backend/app/views/spree/admin/countries/edit.html.erb\nhttps://github.com/solidusio/solidus/blob/master/core/config/locales/en.yml\nJust add it in as a general translation in a different PR?  I don't think it can be cleaned up the way the other things are.\nAlso @tvdeyen there is still states_required: States Required in the en.yml even though that translation is no longer being used anywhere.  Was this intentional or just something not cleaned up yet because you weren't spending hours going over someone else's work?  Even if someone had used that translation somewhere else taking it out shouldn't affect the actual look as it will still render to the same text just inside of a missing translation span.  \nIs cleaning out en.yml of unused translations even a concern?\n. For sure that makes total sense\nRight now I'm looking at https://github.com/magiclabs/solidus/commit/efc9c6cae613649ec2eceaa21ce0f903eb5c1074#diff-4 and it's not a big difference but that has changed the for attribute of the label so now it's pointing towards customer_return_stock_location_id instead of customer_return_stock_location which wouldn't matter except there is a select2 element at the top of the screen with the same ID so now clicking the label takes you to the top of the screen instead of doing nothing like before this change.  Could change it to something like <%= f.label :stock_location_id, for: \"nil\" %>.  I don't know how the select2 box is really generated and how simple it would be to change it's ID or if that's really a thing.  \nThe one other change I made was replacing <%= Spree.t(:item_received?) %> which didn't have a translation even with <%= Spree::ReturnItem.human_attribute_name(:item_received?) %> and adding the corresponding entry in the dictionary but I'm now wondering if that doesn't really fit. Happens at the bottom of https://github.com/magiclabs/solidus/commit/efc9c6cae613649ec2eceaa21ce0f903eb5c1074#diff-1\nJust want to get these couple things sorted out before I submit another PR.\nedit: Also adding back in the generic exchange_for: Exchange for as it's referenced somewhere.  Will check the other removed translations as well and add back in where necessary noting that they can be removed later once the other references are gone.\n. For sure that makes total sense\nRight now I'm looking at https://github.com/magiclabs/solidus/commit/efc9c6cae613649ec2eceaa21ce0f903eb5c1074#diff-4 and it's not a big difference but that has changed the for attribute of the label so now it's pointing towards customer_return_stock_location_id instead of customer_return_stock_location which wouldn't matter except there is a select2 element at the top of the screen with the same ID so now clicking the label takes you to the top of the screen instead of doing nothing like before this change.  Could change it to something like <%= f.label :stock_location_id, for: \"nil\" %>.  I don't know how the select2 box is really generated and how simple it would be to change it's ID or if that's really a thing.  \nThe one other change I made was replacing <%= Spree.t(:item_received?) %> which didn't have a translation even with <%= Spree::ReturnItem.human_attribute_name(:item_received?) %> and adding the corresponding entry in the dictionary but I'm now wondering if that doesn't really fit. Happens at the bottom of https://github.com/magiclabs/solidus/commit/efc9c6cae613649ec2eceaa21ce0f903eb5c1074#diff-1\nJust want to get these couple things sorted out before I submit another PR.\nedit: Also adding back in the generic exchange_for: Exchange for as it's referenced somewhere.  Will check the other removed translations as well and add back in where necessary noting that they can be removed later once the other references are gone.\n. It's not a duplicate ID that is the problem it's that the label is now pointing towards a different ID than it had been before\nhtml\n<label for=\"customer_return_stock_location_id\">Stock Location</label>\ninstead of\nhtml\n<label for=\"customer_return_stock_location\">Stock Location</label>\nAdding the other explicit part of the name doesn't fix this issue as it's kind of a convergent thing with the select2 hidden box created at the top of the screen.  We need to either explicitly change the ID of the select2 box (I don't know if this is simple or easy) or explicitly set the for attr for this label.  I don't know if moving forward other labels will have a similar problem or not.  \nedit:  This is an issue that happens all over the site and is apparently a known select2 issue so just ignore it since it's very out of scope.\n. Just thought I'd mention here that while I'm not touching the Spree.t(:no_resouce_found) problem right now in the new PRs I'm planning on handling that in one commit (or PR) to handle all instances of it at once instead of having it spread throughout ~20  other PRs.\n. We talk about some things \"state\" and it's \"status\" fairly interchangeably since they are synonyms.  Do we want to change that to only talk about the \"state\" of something at least in regards to things that have their model attribute as state?  \n```\nshared/_order_summary.html.erb\n<%= Spree.t(:status) %>:\n\n```\nIn particular I'm talking about times like this where we're explicitly showing the order's state but we call it its status.\n. In reference to https://github.com/solidusio/solidus/pull/856#discussion_r52799804:   \nRight.  I forgot that that was the preferred implementation.  It might make the most sense to do one PR after all the other ones are merged to make these changes in one fell swoop since I believe some have already been merged in where the name of a foreign key was put in as an attribute on a different model in the dictionary.\n. My theory was only readding the removed translations when something in the codebase was still referencing them as of the end of the commit that took them out.  Those places were the only places those two translations were touched in the codebase.\n. That makes sense and I was wondering if that was a thing.\n. So I tossed those other translations into new translations on model attributes that don't have corresponding column in the DB but if we want to do that I might need to take another sweep through the forms to be consistent because I'm pretty sure there are still some Spree.t( ) translations in table headers.\n. No.  Making that change and adding that model to the dictionary seems like a better fix.\nedit: Spree::Exchange does not support model_name \n. That sounds best, thanks.\n. What would be nicest would be if we could get new_object_url to work with orders and then we wouldn't need to pass a URL at all but I don't know if that's feasible at all without either bad monkey patching or completely rewriting the world since most of the logic for that function exists on the ResourceController that most other things seem to inherit from instead of BaseController.  I do agree that new_resource_url would be better.\n. My view was that we are just temporarily using RMA instead of Return Authorizations until we change to a wider default content so to change the model_name.human to be RMA would show up in a lot of places instead of just temporarily using admin.tab.rma.\n. @tvdeyen, It came up that @graygilmore did check out the bootstrap tabs and it doesn't encompass what we're looking for during the meeting https://github.com/solidusio/solidus/pull/870#issuecomment-191972012.  Also the current plan is to add the bootstrap .js components on a need to have basis so the tabs.js wouldn't be in unless someone explicitly adds it.  As a beginner I can attest to the ease of using @graygilmore's tabs as well :)\n. In the error message it's that text that is rendered now but the text that is displayed on the page is Shipping Category.  This is also just reverting the text back to before the change to use attribute translation.  I guess the error message is pulled from the labels model by default and it is smart enough to use a label translation if one is implemented\n. Hey I just wanted to poke this because I noticed a problem one of the changes made in a different PR had introduced (that would be fixed by this PR).  So currently we're seeing a poorly formatted confusing message with unhelpful links.\nConfusing\n\nClear\n\nThese things are second nature to people familiar with solidus/spree but more helpful messages like these could help people acclimatize to our environment.\n. @mamhoff has pulled this in to some great looking work in #1019\n. I've realized the actual placements could be a bit better going to rebase them in\n. :+1: Will look into it.\n. I was a bit hasty opening this since #870 isn't merged yet and if that implementation changes this will need to be rebased possibly drastically.  Closing for now.  Will reopen when appropriate.\n. Took them out.  No point in having code we aren't using and don't need.\n. Should probably change store to Store for consistency sake I would think.  I don't know why the choice was made to have every word start with a capital (almost) was made but I assumed there was one\n. After talking about it we're not sure we want to push in a sticky header quite yet but are happy with the other changes so we will leave this for debate and ponderings in #630 and make a new PR for the skeleton work.\n. I am ambivalent on changing the selectors to the catchall or not.  It would really just come down to depending on the behaviour an admin would want if they decided to extend that part of the app.  I don't know how likely that is or not.  I was also just waiting to see if someone else had an opinion to share on it or if @Sinetheta wanted to lay down the :hammer:.\n. Yes we can.  Should have removed it already come to think of it.  I will get some kind of a changelog thrown together as well.  Thanks.\n. I just wanted to draw attention to how I implemented https://github.com/Murph33/solidus/blob/change_settings_to_tabs/backend/app/views/spree/admin/shared/_settings_sub_menu.html.erb : My one concern is that currently it gives a link to the first thing in each of the conditional lists if any of the conditionals pass.  I don't know how likely it is for someone to be able to display states but not zones and I thought this would be fairly safe.  I was wondering if someone has a way that isn't too messy to ensure it links to something the user can display for certain without a messy conditional.\n. Other changes are coming as well.\n. Just like to add I'd started doing some work on this before getting side tracked with things.  I do intend to get back to finishing it when I have some available time.\n. With order_tabs I'd rather rename that to something more descriptive then pull the information out to every page.  Partials being responsible for some of the breadcrumbs does make sense in some of the cases.\n. I went with Sales Total because the report list is calling an actual value on the report and changing that would seem out of scope but I think Sales Totals would make more sense in each place.\n. So @Sinetheta hacked something much nicer together on the hackdays and kindly kept me involved by giving me a PR which apparently github doesn't notify you of.  I finally noticed today when I asked him how it was coming along so it is merged now.  I see Gray already commenting so I won't ping him.  Hoping you're still giving the thumbs up @tvdeyen! \n. I would just like to point out that the appearance of the breadcrumbs have changed since it's no longer in an H1 (which as Gray pointed out was a mistake in the first place) so if style opinionated people would chime in that would be appreciated.  All I did was bump the size some since they are in the old title's position and the small text size didn't look right to me.  I imagine this will get changed around some as we continue to make changes to the admin.\n. This has been updated to use the plural_resource_name helper and rebased on master.  Yes/No @tvdeyen, @Mandily, @Sinetheta , @mamhoff, @jhawthorn, @graygilmore, et al?\n. Changed pictures in original post and bumped the font size.\n. I apologize while also blaming @Sinetheta for any unnecessary new lines that have appeared.  You were right @tvdeyen that did require a link_to in there, good catch.  I'm agreed with Kevin as well when you factor in the build up in partials we have that this while not necessarily being a perfect world implementation, is serviceable.   \nFixed the link_to and rebased on current master.\n. Rebased on current master.  Would really appreciate if we could get this merged or decide on some other change as I know @Mandily is eager to have it in so we can continue moving forward.\n@tvdeyen, @jhawthorn, thanks.\n. That's definitely a good idea @mtomov and I think it's within scope for this.  After all we're just improving that little part of the page and them being links is much nicer.\n. Rebased on master, thanks @peterberkenbosch \n. With regards to that I've done some preliminary work using the layouts @graygilmore is introducing in #1114 on the index views without any forms and it's just been adding one line of <% admin_layout 'full-width' %> and removing references to the old skeleton system.\n. My way of looking at it is the table is showing the shipment but it's describing a bunch of line_items that make up the shipment.\n. Explicitly state a different model's attribute to avoid adding a translation for the attribute to the model?  This just seems kind of what the opposite of what I thought we were going for.\n. Though an added benefit besides eliminating the code would be this stops the select2 label bug.\n. Alright, sounds good to me I'll make the change.  Just wanted a little clarification.\n. I'd just made it <%= f.label Spree::StockLocation.model_name.human %> and it's working fine.  Everyone happy with that?  Or go for the more verbose option?\n. Well labels seem to be broken currently with select2 so when it actually works \"properly\" it activates the select2 bug.  I don't know if we want to implement it properly now so it will be broken but hopefully when select2 is patched it works or have it incorrect right now so if/when it's fixed it behaves properly.\n. Will go with correct code and wait for the select2 fix.  that seems like the most correct option short of fixing select2 and submitting them a PR.\n. Word came from on high to completely ignore the select2 bug and not worry about it.  So just properly formed label and wait for them to patch it I guess.  Thanks for the help!\n. :label is already translated to \"Description\" though from #743.  If we want to maintain the same naming scheme with having the column as name we'd either need some kind of :label_name thing in the dictionary or to alter from the other PR changes, or change the appearance of this page\n. I was iffy about this.  active is an attribute on the model (a boolean) but inactive is not.  I did add it in though to make this work obviously.\n. I was wondering the same thing but this is maintaining consistency with the previously used translation and I think when I checked out it shows up in a case sensitive place on a page.\n. You already took care of that in #764 :)\n. It was a missing translation I noticed in the order/carton partial while I was working.  Perhaps could have just added it alone in a separate PR.\n. There is no payment_methods scope in the base solidus dictionary and the default PaymentMethods are named \"Credit Card\", \"Store Credit\", and \"Check\".  Only Check is close to the syntax we are using in the I18n dictionary for keys.  The current way it works just by abusing the functionality of default not throwing a translation missing when it's used.  This manipulation was the way I thought of actually using keys in the dictionary though I agree it isn't the cleanest approach.\n. That does make the most sense.  Can't see a good reason to manipulate something so we can translate Credit Card to Credit Card (in any language)\n. I felt that by combining it we don't take any assumptions about the grammar of a language someone might be using.  Simply shows that we want to provide a link to creating a new payment method and a note explaining that there currently are none.  \n. number already translates to Identifier so we could still use that if we're okay changing the visual look or we could add identifier as a key in the dictionary and have it translate to Payment Identifier although it isn't a database column and just an alias attribute for number.    Or we could have Spree::Payment.model_name.human Spree::Payment.human_attribute_name(:number) but that seems pretty terrible. \n. I didn't have any tests fail when taking it out.  https://github.com/solidusio/solidus/pull/235, which brings it in, doesn't actually tell us why it's needed either.\n. Yeah.  This wasn't merged in yet but it would be taken care of https://github.com/solidusio/solidus/pull/876/files#diff-3 if it's merged first or need to be rebased to take care of.  I did this wrong in a number of places (every place in that PR) but since some were merged and some not I thought it made the most sense to handle it all in one PR and rebase as necessary.\nEither way I can handle this change now instead of pushing something into master just to immediately change it.\n. This doesn't work quite like this since .page-actions is applied to the ul which is inside of that div with the toolbar class and datahook.  Works when applied to the toolbar div obviously but are we keeping that?  I would like to eliminate the empty h1 even though it shouldn't hurt, empty elements used to influence aren't great.\n. Good points, thanks once again Gray.  Slotting it into the _forms.scss also reminded me to remove the now unused span.or and also let me nest the styles into the same position in the stylesheet that span.or had been.\n. Those were the only locations that a <span class=\"or\"> showed up.  I can't off the top of my head confirm that the elements with .filter-actions only ever had two two elements in it so I'm not certain that a * + * selector would be safe.\n. I went through and spot checked.  Those rules cover all existing cases and * + * would add no new ones.  The other occasions of the filter-actions class being used that did not include the span class=\"or\" element are just for spots with individual buttons or links such as the search forms.\n. I think I saw that translation used on a page so I tossed in the change but after investigating it seems like the old choice of Front End and Backend isn't as strange as I thought.\n. Spree::ReturnItem doesn't have a total column in the DB so I went with reimbursement to maintain the wording in my efforts to not add attributenames when there is no column.  In hindsight that was overly stringent.\n. Something along those lines was my thought when I was going through but in hindsight I suppose since they're just empty content_fors with no text in them they might not count as adding content to that and therefore causing the element to render on the page. I imagine we would want to add a &nbsp; or something to make sure the element still renders for the potential deface overrides.\n. Oh, my thought was that without some text in that content_for that then there would no longer be a page_actions element on the page and possibly people would be defacing that but I haven't checked this hypothesis.\n. Could someone correct me if I'm wrong but I was fairly certain that the order merging logic is all contained in Core and was just unnecessarily being called in the front end.  After this change the order merging should just happen on the sign in which should be handled by the authentication system a user chooses. \n. No, that is where open orders, I believe, are associated with the signing in user in order to keep them from being lost.  Orders will now be merged here in solidus auth devise.  Something similar will need to be implemented in other authentication systems.\n. I could change my entry to instruct them they could also just emulate the set_current_order logic themselves instead of hooking into the helper and using it if you would like, but I still don't see where Solidus Frontend comes into play.  The merging logic used to be called there but this is removing that.\n. ",
    "alexweissman": "@jhawthorn I went through a similar experience, and was very frustrated to find that Select2, as well as all of the major alternatives, do not seem to be maintained or in active development.\nFortunately, Kevin has added me as a maintainer/developer on the Select2 repo which means that I now have the ability to merge PRs, push to the repo, and create releases.  Since it seems like you also depend on Select2 for the time being, would you and your team be interested in helping to resurrect the project?\nI've set up a room on my chat server (https://chat.userfrosting.com/channel/select2) as a place to discuss Select2 and its future, for the time being.. Thanks, I am aware of Chosen and Selectize, but I was under the impression that they won't be doing any further development either.  For example, Chosen's release notes for 1.7.0:\n\nFrom this version on, until further notice, no new features will be added, so pull requests for features will not be accepted. However, pull requests for bugfixes are still very much appreciated.\n. \n",
    "krunalinnovify": "which spree version use in solidus? \n. ",
    "ridem": "What about https://readthedocs.org/ for a solidus-doc repository?\nThis would remove the hassle of setting up a MediaWiki server and to have two different workflows for reviewing changes.\nExample: http://cartodb.readthedocs.org/en/latest/install.html\nThe workflow would not be that big of a problem, with the \"Edit on Github\" button. As it's text, people could edit the docs directly from Github.\n. I meant from a ReadTheDocs page (top-right corner).\nI agree that there's a tradeoff here, but I think most people actually able to contribute to the docs can edit a text on github, and a solidus-doc repository could have a different set of people maintaining it.\n. Thanks for your answer! I was actually on the v1.3 branch when it happened, the same problem occurred because it was the same commit.\nHere's the full backtrace:\n``\n=> Booting Puma\n=> Rails 4.2.6 application starting in development on http://0.0.0.0:3000\n=> Runrails server -h` for more startup options\n=> Ctrl-C to shutdown server\n/usr/local/lib/ruby/gems/2.2.0/gems/activerecord-4.2.6/lib/active_record/dynamic_matchers.rb:26:in method_missing': undefined local variable or methodacts_as_list' for # (NameError)\n    from /path/to/solidus/master/core/app/models/spree/payment_method.rb:4:in <class:PaymentMethod>'\n    from /path/to/solidus/master/core/app/models/spree/payment_method.rb:2:in'\n    from /path/to/solidus/master/core/app/models/spree/payment_method.rb:1:in <top (required)>'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:457:inload'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:457:in block in load_file'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:647:innew_constants_in'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:456:in load_file'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:354:inrequire_or_load'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:494:in load_missing_constant'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:184:inconst_missing'\n    from /path/to/solidus/master/core/app/models/spree/gateway.rb:2:in <module:Spree>'\n    from /path/to/solidus/master/core/app/models/spree/gateway.rb:1:in'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:457:in load'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:457:inblock in load_file'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:647:in new_constants_in'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:456:inload_file'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:354:in require_or_load'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:494:inload_missing_constant'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:184:in const_missing'\n    from /path/to/solidus/master/core/lib/spree/core/engine.rb:48:inblock in '\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/initializable.rb:30:in instance_exec'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/initializable.rb:30:inrun'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/initializable.rb:55:in block in run_initializers'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:226:inblock in tsort_each'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:348:in block (2 levels) in each_strongly_connected_component'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:420:inblock (2 levels) in each_strongly_connected_component_from'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:420:in block (2 levels) in each_strongly_connected_component_from'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:420:inblock (2 levels) in each_strongly_connected_component_from'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:429:in each_strongly_connected_component_from'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:419:inblock in each_strongly_connected_component_from'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/initializable.rb:44:in each'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/initializable.rb:44:intsort_each_child'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:413:in call'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:413:ineach_strongly_connected_component_from'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:419:in block in each_strongly_connected_component_from'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/initializable.rb:44:ineach'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/initializable.rb:44:in tsort_each_child'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:413:incall'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:413:in each_strongly_connected_component_from'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:419:inblock in each_strongly_connected_component_from'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/initializable.rb:44:in each'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/initializable.rb:44:intsort_each_child'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:413:in call'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:413:ineach_strongly_connected_component_from'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:347:in block in each_strongly_connected_component'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:345:ineach'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:345:in call'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:345:ineach_strongly_connected_component'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:224:in tsort_each'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/tsort.rb:203:intsort_each'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/initializable.rb:54:in run_initializers'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/application.rb:352:ininitialize!'\n    from /path/to/my/solidus/project/config/environment.rb:5:in <top (required)>'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/polyglot-0.3.5/lib/polyglot.rb:65:inrequire'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/polyglot-0.3.5/lib/polyglot.rb:65:in require'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:274:inblock in require'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:240:in load_dependency'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/activesupport-4.2.6/lib/active_support/dependencies.rb:274:inrequire'\n    from /path/to/my/solidus/project/config.ru:3:in block in <main>'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/rack-1.6.4/lib/rack/builder.rb:55:ininstance_eval'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/rack-1.6.4/lib/rack/builder.rb:55:in initialize'\n    from /path/to/my/solidus/project/config.ru:innew'\n    from /path/to/my/solidus/project/config.ru:in <main>'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/rack-1.6.4/lib/rack/builder.rb:49:ineval'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/rack-1.6.4/lib/rack/builder.rb:49:in new_from_string'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/rack-1.6.4/lib/rack/builder.rb:40:inparse_file'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/rack-1.6.4/lib/rack/server.rb:299:in build_app_and_options_from_config'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/rack-1.6.4/lib/rack/server.rb:208:inapp'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/commands/server.rb:61:in app'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/rack-1.6.4/lib/rack/server.rb:336:inwrapped_app'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/commands/server.rb:139:in log_to_stdout'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/commands/server.rb:78:instart'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/commands/commands_tasks.rb:80:in block in server'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/commands/commands_tasks.rb:75:intap'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/commands/commands_tasks.rb:75:in server'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/commands/commands_tasks.rb:39:inrun_command!'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/railties-4.2.6/lib/rails/commands.rb:17:in <top (required)>'\n    from /path/to/my/solidus/project/bin/rails:8:inrequire'\n    from /path/to/my/solidus/project/bin/rails:8:in <top (required)>'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/spring-1.7.1/lib/spring/client/rails.rb:28:inload'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/spring-1.7.1/lib/spring/client/rails.rb:28:in call'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/spring-1.7.1/lib/spring/client/command.rb:7:incall'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/spring-1.7.1/lib/spring/client.rb:30:in run'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/spring-1.7.1/bin/spring:49:in'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/spring-1.7.1/lib/spring/binstub.rb:11:in load'\n    from /usr/local/lib/ruby/gems/2.2.0/gems/spring-1.7.1/lib/spring/binstub.rb:11:in'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/rubygems/core_ext/kernel_require.rb:54:in require'\n    from /usr/local/Cellar/ruby22/2.2.4/lib/ruby/2.2.0/rubygems/core_ext/kernel_require.rb:54:inrequire'\n    from /path/to/my/solidus/project/bin/spring:13:in <top (required)>'\n    from /path/to/my/solidus/project/bin/rails:3:inload'\n    from /path/to/my/solidus/project/bin/rails:3:in <top (required)>'\n    from -e:1:inload'\n    from -e:1:in `'\n```\nIf it can help, here is my Gemfile:\n``` ruby\nsource 'https://rubygems.org'\nruby '2.2.4'\ngem 'rails', '~> 4.2.6'\ngem 'pg'\ngem 'sass-rails'\ngem 'uglifier', '>= 1.3.0'\ngem 'coffee-rails', '~> 4.1.0'\ngem 'therubyracer', platforms: :ruby\nActiveModelSerializers\ngem 'active_model_serializers', '~> 0.10.0'\nUse Puma as the app server\ngem 'puma'\ngroup :development, :test do\n  gem 'foreman'\n  gem 'rails_real_favicon'\n  gem 'pry'\n  gem 'pry-remote'\n  gem 'pry-stack_explorer'\n  gem 'pry-nav'\n  gem 'better_errors'\n  gem 'binding_of_caller'\n  gem 'awesome_print'\ngem 'spring'\n# testing\n  gem 'rspec-rails', '~> 3.0'\n  gem 'rspec-activemodel-mocks'\n  gem 'rspec-activejob'\n  gem 'spring-commands-rspec'\n  gem 'shoulda-matchers', require: false\n  gem 'factory_girl'\n  gem 'factory_girl_rails'\n  gem 'database_cleaner'\n  gem 'ffaker'\n  gem 'quiet_assets'\n  gem 'bullet'\nend\ngem 'web-console', '~> 3.0', group: :development\ngroup :test do\n  gem 'capybara'\n  gem 'capybara-screenshot'\n  gem 'launchy'\n  gem 'vcr'\n  gem 'webmock'\n  gem 'test_after_commit'\n  gem 'codeclimate-test-reporter', require: nil\nend\nHeroku fixes\ngroup :production, :staging do\n  gem 'rails_12factor'\n  gem 'rack-timeout'\n  gem 'font_assets', github: 'masterexploder/font_assets'\n  # Password-protected for staging\n  gem 'lockup'\nend\nFile uploads - Amazon\ngem 'paperclip'\ngem 'aws-sdk', '< 2.0'\ngem 'fog-aws'\ngem 'dragonfly-s3_data_store'\nCaching\ngem 'dalli' # memcache\ngem 'rack-cache' # http caching\ngem 'kgio' # faster kgio IO system\nRollbad\ngem 'rollbar'\nNew Relic\ngem 'newrelic_rpm'\nTasks\ngem 'sidekiq'\ngem 'sinatra', require: nil\nFront end\ngem 'haml'\ngem 'react-rails'\ngem 'js-routes'\ngem 'i18n-js', '>= 3.0.0.rc11'\nSolidus\ngem 'solidus', github: 'solidusio/solidus', branch: 'v1.3'\ngem 'solidus_auth_devise', github: 'solidusio/solidus_auth_devise'\ngem 'solidus_gateway', github: 'solidusio/solidus_gateway'\ngem 'braintree'\ngem 'solidus_braintree'\nCMS\ngem 'alchemy-solidus', github: 'AlchemyCMS/alchemy-solidus', branch: 'master'\ngem 'alchemy_cms', github: 'ridem/alchemy_cms', branch: 'ams-0.10'\n```\nI tried again today, and can confirm that the issue appeared after this commit.\n. Thanks for the investigation @jhawthorn !\n. \ud83d\udc4d You're right, my bad, this was just one query!. Thanks @mamhoff for the feedback.\nYou're right, I didn't go into the nitty gritty of the countries that were not states but for which the subregion was needed for shipping. And typed is not released, yes.\nAre you aware of any database stating whether subregions are needed in address forms for a given country?\n. ",
    "brchristian": "@mamhoff I appreciate your leading me to this thread via PR #1360.\nPerhaps I can say a bit more about my use-case, as I do not know of a way to avoid the n-queries issue. I\u2019d like to generate a Solidus report showing Shipments and their ShippingMethods. In a big report, we\u2019re looking at maybe 50k rows or something.\nMy logs look like a big pile of this:\nruby\n  Spree::ShippingRate Load (4.2ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223042 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  Spree::ShippingMethod Load (0.3ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 1 LIMIT 1\n  Spree::ShippingRate Load (0.5ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223094 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  Spree::ShippingMethod Load (0.7ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 17 LIMIT 1\n  Spree::ShippingRate Load (0.6ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223114 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  CACHE (0.0ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 1 LIMIT 1  [[\"id\", 1]]\n  Spree::ShippingRate Load (0.8ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223220 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  CACHE (0.0ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 1 LIMIT 1  [[\"id\", 1]]\n  Spree::ShippingRate Load (0.6ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223230 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  CACHE (0.0ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 1 LIMIT 1  [[\"id\", 1]]\n  Spree::ShippingRate Load (1.5ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223243 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  CACHE (0.0ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 1 LIMIT 1  [[\"id\", 1]]\n  Spree::ShippingRate Load (0.4ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223252 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  CACHE (0.0ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 1 LIMIT 1  [[\"id\", 1]]\n  Spree::ShippingRate Load (0.4ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223259 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  CACHE (0.0ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 1 LIMIT 1  [[\"id\", 1]]\n  Spree::ShippingRate Load (0.4ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223291 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  CACHE (0.0ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 1 LIMIT 1  [[\"id\", 1]]\n  Spree::ShippingRate Load (0.4ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223307 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\nNote that because of the way that selected_shipping_rate is implemented, it is not possible to avoid 50k queries via .includes(:shipping_rates), as you can see here. Note that the first line pre-loads all of the ShippingRates for the Shipment objects, but we still make 50k queries.\nruby\n  Spree::ShippingRate Load (0.6ms)  SELECT `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` IN (223042, 223094, 223114, 223220, 223230, 223243, 223252, 223259, 223291, 223307, 223336, 223380, 223382, 223402, 223430, 223431, 223465, 223484, 223491, 223525)  ORDER BY cost ASC\n  Spree::ShippingRate Load (0.4ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223042 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  Spree::ShippingMethod Load (0.3ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 1 LIMIT 1\n  Spree::ShippingRate Load (0.4ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223094 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  Spree::ShippingMethod Load (0.3ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 17 LIMIT 1\n  Spree::ShippingRate Load (0.4ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223114 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  CACHE (0.0ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 1 LIMIT 1  [[\"id\", 1]]\n  Spree::ShippingRate Load (0.4ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223220 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  CACHE (0.0ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 1 LIMIT 1  [[\"id\", 1]]\n  Spree::ShippingRate Load (0.4ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223230 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\n  CACHE (0.0ms)  SELECT  `spree_shipping_methods`.* FROM `spree_shipping_methods`  WHERE `spree_shipping_methods`.`id` = 1 LIMIT 1  [[\"id\", 1]]\n  Spree::ShippingRate Load (0.4ms)  SELECT  `spree_shipping_rates`.* FROM `spree_shipping_rates`  WHERE `spree_shipping_rates`.`shipment_id` = 223243 AND `spree_shipping_rates`.`selected` = 1  ORDER BY cost ASC LIMIT 1\nDoes anyone have a suggestion for how I can avoid n (50k) queries here? Maybe I\u2019m missing something, which is totally possible.\nThe beauty of making selected_shipping_rate an association is that we can also make shipping_method/selected_shipping_method an association. Then it becomes possible to write things like Shipment.all.includes(:selected_shipping_method), which, again, sidesteps this 50k-queries problem. I\u2019m not sure of another way to avoid this. Again I\u2019m open if people can share their best practices here. What\u2019s the recommended way of handling this situation?\nCheers!\n. @mamhoff Ah, it turns out that I was wrong in my above comment. I was accidentally going off of the old Spree code, which didn\u2019t use that ruby detect loop but instead modified the shipping_rates scope. In Solidus 1.0 I can indeed avoid the n-queries issue with an includes(:shipping_rates).\nI apologize for any confusion and thanks for your help!\n. For some reason, the migration that installed for me was simply:\n```ruby\nThis migration comes from spree (originally 20141217215630)\nclass UpdateProductSlugIndex < ActiveRecord::Migration\n  def change\n    remove_index :spree_products, :slug\n    add_index :spree_products, :slug, unique: true\n  end\nend\n```\nWe are using the rubygems Solidus 1.2.2 release.\nIs this a versioning thing? Perhaps the 1.2.2 release doesn\u2019t have the safe methods? If that\u2019s the case it might be worth a new minor version release: 1.2.3 or whatever.. @jhawthorn Looking back at the 1.2 branch it does seem like the safe methods were added after the 1.2.2 release, but there has not yet been a 1.2.3 release. Might be worthwhile if other people on the upgrade path may experience the same issue as we did.. If the general consensus is that a clean history is more important than consistent style, then that makes sense to me.\nWould it be worth adding a small section to the contributor guide to the effect of \"here\u2019s our style guide, we want new commits to look this way, but as a policy do not accept strictly cosmetic PRs?\". (I realized that I had missed about 50 instances which were immediately preceded by an open brace or parenthesis, so I\u2019ve added a second commit that takes care of those as well.). @kennyadsl squashed! \ud83d\udc4d . @jhawthorn Great point. Would you suggest simply removing the version requirement altogether?. @jhawthorn That sounds great. Done & done.. @jhawthorn No prob! But it looks like something weird got into the changelog by accident. Let\u2019s just take that out before we merge.. e.g., perhaps this can be extracted into https://github.com/solidusio/solidus_multi_domain?. @kennyadsl I\u2019m using the latest gem release, which is 2.2.1.\nI note that out of the box, the default 2.2.1 store makes six Spree::Store find calls per pageview! (Three for the main layout, and three for the cart partial.)\nMy hunch is that only a small fraction of the Solidus user base have more than one Store. My personal opinion is that six SQL calls per pageview is a lot of DB chatter to support what is (IMO) a somewhat niche use-case.\nWhat do you think about trying to move this functionality out into the solidus_multi_domain gem and support a single store by default in the vanilla Solidus gem?. @kennyadsl Also, the commit you referenced was reverted by https://github.com/solidusio/solidus/commit/0abb4d043408e31aa0da8dc4e514016ae7c190c6!. @kennyadsl Oh, I think you are right about the deprecation. Sorry and thanks for the correction!\nWhen I create a brand new blank Solidus app, @request.env['SERVER_NAME'] is \"localhost\" by default, and so the conditional for store_key is always true.\nWhat\u2019s more, I think that there is some redundancy because store_key can be either the HTTP_SPREE_STORE field or the SERVER_NAME. This forces us in https://github.com/solidusio/solidus/blob/master/core/app/models/spree/store.rb#L25 to check by code and by url, generating two queries.\nSeems like we can clean this up, for sure!. @jhawthorn Oh I actually didn\u2019t know that about the master branch. But that said, the README does specify using the rubygems version of Solidus, so that\u2019s why I was suggesting we say Rails 5.0, just so people don\u2019t get tripped up. The alternative, which would also work, is to suggest they use the master github version of Solidus (rather than the rubygems release).. Closing issue. Thanks, @jacobherrington!. @bbuchalter Agreed that it\u2019s a semantics issue!\nAs you say, yes, the alternative and more minimal fix is just a PR to restrict the default Sales Total scoping in the Reports controller.\nI can see the argument in either direction and am happy to go wherever majority opinion lies. Curious to kind of take the temperature of the community here and see what people think makes most sense.. Closing here and linking to the recent discussion at https://github.com/solidusio/solidus/pull/2131. @mamhoff That all sounds good to me. I\u2019ve closed the open issue at #2099 and am including here two additional commits: one to add the canceled and not_canceled scopes, and another to refactor the first commit in this branch to use that new syntax.. @mamhoff I think I\u2019ve addressed your notes here, so let me know if there\u2019s anything else I can add to this!. @mamhoff Yes, happy to add a spec! Will try to get to that before the end of this week.. @mamhoff Yes, happy to add a spec! Will try to get to that before the end of this week.. @mamhoff Actually, just added the specs now. That should take care of it. Let me know if you want anything further and I\u2019m happy to add it; otherwise I think we are probably good to merge.. @mamhoff No worries, that sounds great. I\u2019ve done a reorganization of those commits as you suggest, and have thrown in a rebase onto the latest master to boot.. @mamhoff We good to go with this one?. Hi @mamhoff just wanted to ping and see if we are good to go, would it be possible to merge this? We have been adding this in our app through a decorator and it\u2019d be nice to remove that and simply be able to use the latest master.\nI\u2019ve just rebased again if that\u2019s helpful!. Hi @tvdeyen are we good to merge this? Lmk if there is anything more we need and I am happy to hop on it. Cheers!. @tvdeyen Rebased! \ud83d\udc4d . Hi @kennyadsl thanks for taking a look. To clarify, you would like me to leave :display_amount and :display_price in the getter method line below, but remove them from the MASTER_ATTRIBUTES getter+setter block above?. Your earlier comment was quite clear, I just wanted to double check before I did anything!\nThat all makes total sense to me and I\u2019ve made the changes and pushed the latest version to this branch just now.. @tvdeyen Oh, you are completely correct! My apologies and thanks for the heads up. I have updated the PR accordingly.. @tvdeyen Sorry for any confusion. Closing this!. @kennyadsl Thank you for looking into this! We were just running into this issue ourselves last week.\nDoes it make sense for legacy stores to drop the type column? And if so, should that be part of this migration?. Closing this as I think #3108 has all the relevant info and discussion. Thanks for the heads up!. @kennyadsl That\u2019s a good idea! I\u2019m surprised that current didn\u2019t fail, actually.\nWhat if we change from something like this:\nruby\nexpect(subject.order_count).to eq BigDecimal(order_count)\nto something like this:\nruby\nexpect(subject.order_count).to eq subject.orders.complete.count\nIf that seems reasonable to you, I can add a commit to this PR.. @kennyadsl sounds good, I have added the spec to this PR!. ",
    "joshhepworth": "I'm going to wait for the CircleCI results, but I'll at the very least be closing and resubmitting to fix the Hound violation.\n. @jhawthorn That was because of a misunderstanding of what happens with nested statements/transactions on my part. I will add them back in. Should I close this PR and submit a new one, add a new commit, or force push an amended commit to this same PR?\n. @jhawthorn bang methods added!\n. I just ran into this issue as well, and actually had to address this in the Products API as well due to this line: https://github.com/solidusio/solidus/blob/master/api/app/helpers/spree/api/api_helpers.rb#L54\nThe because the Spree::Product#any_variants_not_track_inventory? method is private, I ended up with this in _product.json.jbuilder, which is not pretty for a few reasons:\n```\n  json.(product, *@product_attributes - [:total_on_hand])\njson.total_on_hand(product.total_on_hand.to_f.infinite? == 1 ? nil : product.total_on_hand)\n```\nI'm not sure if this is acceptable, or if you'd rather have a solution that cleaned this up a little more extensively. I'm also not sure if the product_attributes helper ends up touching other endpoints as well.. ",
    "kovalevsky": "@cbrunsdon Unfortunately, no.\nRansack version described as ~> 1.6.0. So bundler is allow to use only versions that varies with the last (minor) number.\nExample:\n```\nbundle update ransack\nFetching gem metadata from https://rubygems.org/.........\nFetching version metadata from https://rubygems.org/...\nFetching dependency metadata from https://rubygems.org/..\nResolving dependencies..........................................\nBundler could not find compatible versions for gem \"ransack\":\n  In Gemfile:\n    ransack (= 1.7.0)\nsolidus was resolved to 1.2.0, which depends on\n  solidus_backend (= 1.2.0) was resolved to 1.2.0, which depends on\n    solidus_core (= 1.2.0) was resolved to 1.2.0, which depends on\n      ransack (~> 1.6.0)\n\n```\n. @tvdeyen Nice idea!\nShould I change the PR?\n. @cbrunsdon I updated PR. Now .gemspec just allows to use 1.7, not requires it.\n. ",
    "AdnanTheExcellent": "When the address is updated, the taxrate should be adjusted if the @order.tax_zone changes.\npseudo code:\n```\nold_tax_zone = @order.tax_zone\nCODE_TO_UPDATE_SHIP_ADDRESS_HERE\nunless old_tax_zone == @order.tax_zone\n   Spree::TaxRate.adjust(@order.tax_zone, @order.line_items)\nend\n``\n. it still needs the.tax.destroy_all` at the end. the code i proposed was to just show the initial sql query before the .tax for fetching the adjustments and how the two were returning different results. With the .tax it shouldnt destroy any other type of adjustments. \nIf you changed line 90 to:\nSpree::Adjustment.where(adjustable_id: relevant_items.map(&:id)).tax.destroy_all\nit should work fine\n. Ah ok, i see what you're saying now. \nThis should do the trick:\nrelevant_items.map(&:adjustments).map(&:tax).flatten.destroy_all\n. True, but master does the same thing now that they extracted the code to Spree::Tax::ItemAdjuster. It only does 1 object at a time so i would have to loop over each item and do items.length SQL queries. \nhttps://github.com/solidusio/solidus/blob/master/core/app/models/spree/tax/item_adjuster.rb#L28\n. I have been facing this issue for a while too. We have disabled inventory units because it completely blows up our site when enabled. We deal with manufacturing units so an order can have hundreds of thousands of inventory units. It looks like spree already did the quantity column implementation with this commit:\nhttps://github.com/spree/spree/commit/0beb977b31e02adb34646afbb216ae6525f68f05\nIs there a technical reason why this implementation has not been ported over to solidus (that i am unaware of) besides that nobody has gotten around to it? If not, I can try to tackle it but i'm fairly busy with my 9-5 and not sure if i'll have time to get it done. . @loicginoux try adding following functions in your order decorator:\n```\n  def ensure_updated_shipments; end\ndef refresh_shipment_rates; end\n```\nThis should override those order methods and prevent the shipments from being updated with new rates as well as prevent the shipments from being destroyed. Hope that helps. You will have to manually update your shipments though, which it seems like you want to do. \n. ",
    "cee-dub": "Great! No rush to merge this, I'm overriding it locally for now.\nCould maybe use some CSS? I'm not good at that.\n. I guess I'd prefer :mini, since that's default.\n. ",
    "dholdren": "Closing, this is no longer happening.. \ud83d\udc4d awesome. I'd love to see this merged so I can remove my local hack\n. It looks like this is the commit that introduced the bug: https://github.com/solidusio/solidus/commit/c6fa6226d3028a2259461e66376c888588c02a5e\n. thanks for this :+1:\n. I'm about to implement this in my store's code, would love to see this merged in\n. a version of this PR with specs: https://github.com/solidusio/solidus/pull/1386\n. yeah I wasn't sure which way to go. product_picker.js does it this way: https://github.com/solidusio/solidus/blob/master/backend/app/assets/javascripts/spree/backend/product_picker.js#L18\n. oh my bad, added that at the last minute. will change back to .each\n. ",
    "MFRWDesign": "@mfrwdesign is working on this. @mfrwdesign is working on this. @tvdeyen Good now? :). ",
    "rafaelfranca": "Awesome! Thank you for checking\n. ",
    "eric1234": "Looks like f4834987 caused the conflict. Resolved so once the tests finish we should be good to go.\n. It is a preference. The only bit of trickery here is that the default is halfway intelligent. Rather than break compatibility for folks that are using the permissions sets (I assume someone is since the feature was created) it detects the usage and sets the default according to that detection.\n. All cleaned up. I'll leave it up to you to decide how you want to version. Strictly speaking you are breaking compatibility so if you are a semantic versioning zealot you bump to version 2 but seeing as it impacts so few sites (problably one) the pragmatic approach would be just to note it in the release notes.\n. I def understand about not wanting to prefix everywhere. Too much boilerplate. But given the pluggable nature of users combined with this being a highly used extension point (most stores will have more extensive custom user data) I think like the main menu, the benefits outweighs the annoying boilerplate.\n. This has been rebased. Once the tests are greenlit you should be good to merge.\n. Added the indent to conform to the project style. Once tests complete this should be good to merge.\n. I'll have to come back to it in a day or so as #975 restructured things so much (for the better) I'll have to re-implement.\n. Only took a month and a half :) but finally came back around to updating this PR so that the code works with the new admin config navigation.\n. Just added an additional commit of some additional areas where logic is duplicated and non consistent.\n. K, a26b808 now addresses the regression.\n. Commits have been squashed and rebased to master.\n. Without the upgrade it doesn't work well anywhere. As it currently stands if I:\n1. Set a breakpoint in the code (either debugger or binding.pry).\n2. Run the spec to let it hit the breakpoint\n3. Hit c to continue (i.e. I don't even have to do anything in between)\nFrom that point on everything fails with the argument error linked to above. Seems having the debugger work everywhere but feature tests is better than have it not work anywhere.\n. How would that work? Developers would add to the Gemfile and not commit that? I like the idea of a debug tool being available out of the box. Just wish it actually worked. :)\nOn most projects I just link in byebug as I don't find I can ever remember all the advanced pry stuff and I generally just stick with basic stuff (next, continue, puts, etc). Any chance these problems are due to a combination of pry and byebug and if we just used byebug we wouldn't have the problems? I realize for pry enthusiasts they hate to loose their tool set but a non-working debugger isn't any better.\nIf you are open to just having byebug I can test it out and see if it works for the feature testing.\n. I'm not sure the pry bug is active anymore. I wanted to see if moving to just plain byebug allows us to have a working debugger. So first I wanted to duplicate the feature test bug so I could confirm that just using byebug doesn't exhibit the same behavior. But to my surprise I couldn't duplicate the bug under pry either. Here are my attempted step to reproduce:\n1. In the admin/taxons feature spec I added binding.pry after the visit statement. I used this as a test since this spec is a js feature spec and therefore would be using capabara.\n2. I ran the spec with the following SPEC=spec/features/admin/taxons_spec.rb:24 rake spec\n3. When it hit the breakpoint I typed puts page.driver.cookies.\n4. Based on the pry bug report I expected to get a timeout but instead is instantly returns a hash fof the cookies.\nI'm not sure if it's because of the pry upgrade I did, the fact that ruby has moved onto newer versions or what, but the bug no longer seems present. I think we are safe to just commit my patch if someone can perhaps confirm my steps.\n. I did a bit of testing and was able to reproduce the issue. Just printing the cookies didn't cause the issue like the issue described but trying to visit pages as you suggested does not work with either pry or even just plain byebug.\nThis means we have two choices. Upgrade byebug so you can continue without getting the error I describe. Leave the old version of byebug in place which means you can step through all code (including capybara feature tests). Either way we have a broken debugger. Not sure which is worse. \n. Ah yea, forgot to make the addition of username: postgres conditional on the DB being pg.\nIt's possible that DATABASE_URL might work. Is there a way I can provide that when creating a sandbox and that is used in the generated app?\n. I attempted to use DATABASE_URL but cannot seem to get it to work with me. First I tried:\nDATABASE_URL=postgres://postgres@127.0.0.1/sandbox_development rake sandbox\nThis seemed to be trying to use the connect but since it didn't generate with the pg gem it get's an error.\n``\nCouldn't create database for {\"adapter\"=>\"postgresql\", \"pool\"=>5, \"timeout\"=>5000, \"database\"=>\"sandbox_development\", \"username\"=>\"postgres\", \"host\"=>\"127.0.0.1\"}\nrake aborted!\nGem::LoadError: Specified 'postgresql' for database adapter, but the gem is not loaded. Addgem 'pg'` to your Gemfile (and ensure its version is at the minimum required by ActiveRecord).\nGem::LoadError: pg is not part of the bundle. Add it to Gemfile.\n```\nNext I attempted to also specify the database type in an attempt to get the gem loaded via DB=postgresql DATABASE_URL=postgres://postgres@127.0.0.1/sandbox_development rake sandbox. This resulted in the following error:\ncould not connect to server: No such file or directory\n    Is the server running locally and accepting\n    connections on Unix domain socket \"/var/run/postgresql/.s.PGSQL.5432\"?\nSo it seems to be correctly generated with the PG driver but now it's not using my connection string anymore and trying to connect via a domain socket. Any suggestions to getting it working with DATABASE_URL?\n. I'll give it a whirl today and let you know if it resolves my issue.\n. This doesn't solve the issue but I discovered something else in the process. The problem only occurs if I start the specs through rake. So:\nSPEC=spec/path/to/file_spec.rb rake spec\non the other hand if I go through the rspec command:\nbundle exec rspec spec/path/to/file_spec.rb\nI don't get the issue. So now that I have a way to work around the issue I'm fine with doing whatever you guys want. Leave it as is, use your patch, etc.\n. Agreed. Unfortunately my upstream commits are limited to just stuff I hit while working on my primary goal. Systematically going through all screens to make sure everything is include_all_helpers=false happy is beyond my scope. But my config is set to false so if I hit any other screens as I'm hacking will send upstream.\n. Found a few more while working so just added them to the same branch. Let me know if you guys prefer me to squash the commits.. The last paragraphs in my original PR message explained why I opted for silently modifying over explicit validation. I saw it as the lesser of two evils but that is a bit of opinion. If you guys prefer validation then go ahead and close the PR.. I didn't expect so a small little change to make so much discussion. To get this thing closed and move onto more exciting things I have updated the PR to strip so that spaces within a code are supported.\nI also went ahead and combined it with the existing downcasing method to reduce the clutter.\nAs if you should merge this or use @jhawthorn validation version (or both) I'll leave that up to you guys. I prefer the system just do what they mean rather than having the user try to remove characters they cannot see but understand if you prefer it the other way.\nRegardless the PR is updated so it is ready if you do want to merge. If not then feel free to close.. K, squashed and rebased to master. My frustration with overzealous code linters removed. :). Yes, you are correct. I had thought about that but didn't think in practice folks would have that many codes on a single promotion. If that is a concern we could address in one of two ways:\n\nJust remove the code sorting similar to the usage sorting. I know my store won't be using codes at that scale so can just make it a local change. I think this is the best approach as sorting by code isn't probably a huge issues for most stores.\nYou could define a new relationship that is scoped to just a single code and sort on that. This would scale to any size of codes but probably not worth the code complexity.. Yea, I'll just remove it. I was really thinking the sort would focus around promos with a single code and with multiple codes it would be more undefined. The store I am working with really just uses single codes so I'll just bring it local.. @jordan-brough \n\n158053c - This backs the code sorting back out.\n4e03ad8 - This adds a hook to include references that I need to be able to do the code sorting locally. It's in the same design as the hook for includes. Defaults to a no-op.\nab90f50 - Not strictly related to sorting but related to the same page. A minor consistency fix I'm trying to sneak in. :). If that case it was previously broken. Previously the shipment went to the ready state only because it was checking if inventory units where \"not backordered\". But just because the shipment was once again ready the individual inventory units where still in the \"canceled\" state and there is not path from \"canceled\" to shipped because allow_ship? is only true if on-hold.\nThis is actually a good example of why having the logic in two places (and be different) is problematic. On master if you cancel an item then try to ship it you will likely get an error because you cannot ship the inventory unit anymore since it is canceled and not on-hold.\nWith my new code the logic has a single source of truth which means since you cannot ship the inventory unit the shipment is also moved back to pending. If you want to make the spec pass as originally designed then we need to update the allow_ship? method in InventoryUnit to be on_hand? || canceled?.\nIf that sounds good I'll make the change and revert this test to it's original check.\n. I am wrong above. I did a bit of testing with this and it doesn't try to ship the canceled item as there is a filter to remove all but the on-hand ones. I'm working right now on making another pass at the code to try to remove some of this duplicated logic while still satisfying the existing specs.\n. I assume the \"ambiguous first argument\" is indicating I should add parens. So gsub!(/\\s+/, '') (under the idea that somehow that is clearer).\nIs the unexpected token error referring to the safe navigation operator? Is this a project decision (compat with older Ruby) or just hound not knowing the more modern syntax?. Up to you guys regarding the internal whitespace. I will say I have had a real world case where the admin put whitespace in the middle and couldn't see it because of the small font size. The question is how far do we go to make it fool proof since there is always a bigger fool?\nWe do know whitespace should never be in a code so doesn't seem to hurt to remove it. The person who pays my paycheck is the one who added the whitespace so if you prefer strip I'll just have to do a local override.. Crap, again my store not using multiple codes is biting me here as I'm not considering all the use cases. So basically:\n\nTo allow searching by code we need the distinct: true.\nHaving the distinct: true prevents us from sorting on custom criteria as anything in the ORDER BY must also be in the SELECT.\n\nOption 1 - Something like distinct: params[:q][:codes_value_cont].present?. That way we are only doing distinct if searching on codes. Of course I would still need to resolve cases where the user is sorting on custom criteria but also searching on codes....\nOption 2 - Drop this and the promotion_references completely as we get in a can of worms where one page has 10 extension points for every possible thing a developer might want to tweak. Are all those extension points more complex than just monkey-patching collection. Downside to this is I know solidus has a goal of discouraging monkey-patching.\nOption 3 - Perhaps your promotions_scope hook could is the solution. Then I could also add a custom select that includes my custom sort (satisfying the SQL requirement that anything in ORDER BY also be in SELECT when using DISTINCT)\nI think option 3 is the best. I can test that out to see if it works. Regarding monkey-patch vs config. If it was done as a config I wonder if we could do it at the Spree::ResourceController level. This way every resource controller has a hook to tweak it's scope to be customized. It could check for a config variable named after the controller name. If it doesn't exist then not tweaking needed.. ",
    "aptinio": "After further testing, the issue apparently only happens on Heroku. Closing this for now while investigating further.\n. ",
    "docelic": "Great, thanks!\n. @eduardopatrick to just use Rails 5.2.0 and have it all working with Solidus (until the issue is resolved), there is just a small change you need to do:\n1) Create a new/test Rails project with option --skip-bundle or -B added at the end, e.g. \"rails new myproject -B\", so that it does not run bundler automatically. (Or if it does run it automatically, just press Ctrl+C to stop it). Just make sure you stop it before it installs Rails 5.2.1.\n2) Then edit the file \"Gemfile\", find line: \"gem 'rails', '~> 5.2.0'\" in it, and set version to just \"5.2.0\" so that the whole line becomes \"gem 'rails', '5.2.0'\n3) Run \"bundle\" manually\n4) And from there you are good to go as you normally would\nAlso, if you already have Rails 5.2.1 because it got installed when bundler ran and you don't know how to remove it, then really the simplest way to start clean is to just create a new system user and install Ruby via a tool called RVM (https://rvm.io) in it. This will install Ruby locally under that account for maximum flexibility (e.g. you can just remove the whole ~/.rvm/ directory and try again if you don't get it right on the first try).. @fabioaraujo121 thanks! The issue is not directly related to Solidus, and from what I see, the PR which we are waiting on which would fix the issue is here: https://github.com/activerecord-hackery/ransack/pull/951\n(I believe after the above is merged, we're then waiting for a new/redone release of ransack 1.8.9 containing this fix.). @louishugens if you want to remove parts of rails 5.2.1, do as follows:\n1) First run gem list to see all your installed gems. You might even run gem list | grep 5.2.1 to narrow the list to gems probably relating to rails 5.2.1\n2) For each gem you want to remove, run gem uninstall GEM_NAME -v=5.2.1\nIf you have already ran 'bundle' with 5.2.1 left enabled, then these choices will remain remembered in file Gemfile.lock. So what you need to do (after changing version to 5.2.0 as advised above) is to run bundle update so that the versions get recalculated to 5.2.0.\nHope it helps.. According to https://github.com/solidusio/solidus/pull/2826 looks like it works with Rails 5.2.1 now.\nJust the source needs to be taken from github and not the release (which isn't out yet), so the instruction from https://github.com/solidusio/solidus to install Solidus by adding the following to Gemfile:\ngem 'solidus'\ngem 'solidus_auth_devise'\njust needs to point solidus to GitHub, i.e. be:\ngem 'solidus', github: 'solidusio/solidus'\ngem 'solidus_auth_devise'\n. ",
    "isindexer": "Thanks @jhawthorn \n. Hi @flyfy1 \nDid you solve this issue ?. :+1: thanks. Hi, will it fix this issue too : #1711 ?\nThx. thanks @ericsaupe . Hi\nI am working with sebfie on the business side. \nThe problem when using the split functionnality is that the total amount of the order is recalculated. If a promotion has ended during the picking packing shipping process, it leads to a gap between the original amount, the payment and the recalculated amount (payment_state = balance_due or credit_owned). \nCreating as many cartons as needed to fully shipped the order prevents us from this problem. But we need the shipment to be  ready for that. \nHope it helps to understand the aim of this PR. Correct me if i am wrong Sebfie but we don\u2019t need extra-code to ship the rest of the shipping. \nTo be honnest, we never use the \u00b4ship\u00b4 button. We only use a worker . Thanks kennyadsl. \nThe synthesis you wrote here is perfect \ud83d\udc4c. ",
    "mradfaber": "@dt1973 You are entitled to your own opinions but there are rules of conduct you should read about: https://github.com/blog/2039-adopting-the-open-code-of-conduct\nShow some respect to other people's time & effort - you are being disrespectful and xenophobic without any reason except for the fact that we (Spree Core Team) are trying to support Spree-based stores and their developers. It's a thankless job and we don't expect any thank-yous. But attacking us like that... I'm very disappointed in you as a reasonable adult. \nIf you continue your ways I will be submitting your posts to GitHub admins as abusive both personally towards @damianlegawiec (https://github.com/spark-solutions/spark-starter-kit/issues/21) and in general (i.e. national origin). I am sure that open-source community will not tolerate any harassment of this sort. I'm sure I can expect Solidus community support in this matter.\nI would rather agree to disagree. Thank you.\n. @tvdeyen Point noted Thomas! I'll make sure we'll refrain from any hasty or emotional comments. And thank you for your support regarding appropriate conduct. Respect!\n. ",
    "JDutil": "@dt1973 I don't give a crap what you have to say please stop cc'ing me and the rest of the core team on this non-sense. We're all friends from working together over the years on spree & solidus.  Just because people decided to go their own ways for their own business reasons, doesn't mean we don't still get along and respect eachother.  Please just stop.\n. @kennyadsl was just looking at this for Hacktoberfest, and I think this may already be resolved in that I can't reproduce that behavior on master. I don't see any flash message it just redirects me to the shipments not the cart. \n. I don\u2019t think it\u2019s an easier approach although I did like the idea.\nI just briefly tried removing the controller action and route, and it effected a lot of places currently using the route helper.  I imagine many extensions or applications are still using the route as well.\nThe simpler solution would be the flash message and redirect even if it\u2019s not as nice.\nHow exactly did you reproduce this issue?  Perhaps I\u2019m missing something, but I didn\u2019t see the problem when I tried. My orders must be in a different state than expected to reproduce the issue.. @kennyadsl @VitaliyAdamkov I took over where this issue left off and opened https://github.com/solidusio/solidus/pull/2912/files if you guys want to review my fixes there.. @antstorm about all the deprecation warnings I fixed all but one that I'm leaving for a new issue to resolve which is: \n[DEPRECATION] `symbol_position:` option is deprecated - use `format` to specify the formatting template.\nAs far as I can tell we're passing symbol_position into format method:\nhttps://github.com/solidusio/solidus/blob/master/core/spec/lib/spree/money_spec.rb#L179\nhttps://github.com/solidusio/solidus/blob/master/core/lib/spree/money.rb#L54\nhttps://github.com/solidusio/solidus/blob/master/core/lib/spree/money.rb#L77\nHowever I think the deprecation warning is raised whether the option was passed to new money initialization or the format method, so I'm not positive, but it seems like it may be a false positive on throwing the warning. Otherwise the instructions on how to fix it are not clear to me if you could elaborate:\nhttps://github.com/RubyMoney/money/blob/master/lib/money/money/formatting_rules.rb#L105-L107\n. Thanks @antstorm that makes sense \ud83d\udc4d . @tvdeyen Thanks. I get an error trying to use destroy it looks like it was renamed dispose at some point, but that appears to work as intended for unbinding events.\nhttps://github.com/twbs/bootstrap/blob/v4-dev/js/src/tooltip.js#L212\nI also noticed this is happening all over the place so going to make a pass through the admin to see where else needs to be fixed before this is merged.. @kennyadsl yea it looks like it.  I'll probably close this in favor of fixing in that file so solution works everywhere, but my initial attempts don't seem to work.. Closed in favor of https://github.com/solidusio/solidus/pull/2890. @jacobherrington I don\u2019t see the html safe issues from the other PR, but there are style breaks that will need to be fixed. Doesn\u2019t look major at all just a line break was added between the currency symbol and value, but I still need to fix specs too. . @jacobherrington I believe specs should be passing now if you want to take another look. I didn't end up having to make any styling changes I just had to remove the gsub changing whitespace into html entity for whitespace as that was causing invalid html to render making the line break. The spec changes are mainly just taking into account the spans that are now rendered, and were not rendered before.  In theory this should be fine for most stores, but there is always the possibility some custom styles my conflict... . @tvdeyen I updated this PR so that Money is now initialized in core/config/initializers/money.rb, but that meant I needed to change the spec to use rails_helper instead of spec_helper.  Now the main apps using solidus can simply override the Money defaults by adding their own initializer if they want to.. @ericsaupe squashed \ud83d\udc4d . @kennyadsl added to the changelog.. @kennyadsl yea there shouldn't be visual changes unless you've customized how your price is displayed for something like having a big number and small decimals or something along those lines or are applying css to a span tag instead of a class. \nI don't think anyone should really be effected unless they went out of their way to really change the pricing display, but going forward these new spans rendered will allow people to more easily do any custom styles for big currency symbol or number and small decimal etc.... @kennyadsl was going to ask in Slack for anyone's idea on how to fix this.  The specs pass locally for me, but the deprecation warning seems to cause Circle to fail.  Not really sure what to do to fix it.  \nI also noticed we're still using some Spree.t methods in Javascript that we probably want to rename and/or deprecate as well, but I haven't dug into that yet.. I prefer @kennyadsl solution will update :+1:. I agree this should be done in a more configurable manner, but I don\u2019t think we should require everyone to update their apps with an initializer by default. I\u2019m thinking just allow apps to override the setting if they really want to. WDYT?. This was fixed, but comment didn't get hidden.. ",
    "Serabe": "Sorry for the late response. I've been digging and making some tests (no pun intended) and this is something that really need to be solved in FactoryGirl / Spring side. Thank you for takin a look at this!\n. The screenshots are taken from master, but this is happening in 1.2 as well.\n. @jordan-brough thank you for the explanation, now this is all much clearer.\nFor your second point on what's missing: I don't think creating a the RMA after is a good solution, but the user is left in a state where it cannot fix the situation in any way I have found: the item appears as reimbursed, but such reimbursement is rejected and no other reimbursement can be created.\nYour explanation has been much helpful, thank you for taking the time to write it!\n. ",
    "apepper": "REVIEW (6f3189b)\n- Pointed RubyGems links to github.\n- Made localhost links clickable.\n- Fixed a small syntax error.\n. REVIEW (4dd1e81)\n- Removed core/app/models/spree/product_scope.rb by reverting my commit\n- Removed core/app/models/spree/product_scope/scopes.rb by applying https://github.com/spree/spree/pull/5940 / https://github.com/spree/spree/commit/6880c4d80e5797d205a76293d8811861baedc7e5\n. REVIEW (82c1307)\n- Rewrote branch and force pushed it, to only contain 82c1307.\n. Would it be possible to add this to 1.3.0.beta2?\n. AFAIKS only solidus_frontend provides a README.md. All other gems do't provide a README file.\nThat's why I still think, that linking to rubygems is the better way.\n. ",
    "flyfy1": "Problem solved after upgrading to Rails 4.2.6 + bundle update\n. but why not allowing the admin to set the default_currency?\n. @gmacdougall but if store.default_currency is nil.. then \"add to cart\" would throw error.\n(I think u can easily verify that with master branch of Solidus)\n. Ahh Yeah thanks @cbrunsdon. I agree the pull request itself is nice, just trying to understand the code base also :)\n. @cbrunsdon Thx for ur post. BTW, do u know how to reference to the data-hook if it's defined in the form_for ? or is there any example that I can reference to, for deface into the ERB code?\n. @mamhoff another reason I need to get confirm/cancel moved out is that.. I need to replace the second fieldset with another one (or to hide the second fieldset).. therefore, a separation is needed (since I want to avoid unnecessary)\nYeah sure I can do a squash\n. Squashed :)\n. @mamhoff How can I proceed? Anyone can help merge this pull request?\n. @Mandily Thanks for your comments. I see the reason now.\n@mamhoff I've moved the button back into the fieldset. I think we can happily merge the code now :) (only one line change now)\n. @mamhoff Yes, for the standard CSS semantic class, I think I'll need to assign a class to the second field set. But does it means that all the data-hook should be deprecated?\nBecause I thought the idea of data-hook is for deface to hook-in & update the content related, and that's the main motivation to add in the data-hook.\n. @jasonfb It's actually different name: one is \"option-type-edit-form\" and they other one is \"option-value-edit-form\"\n. Currently I can see the remove_from being defined.. however, where is this method called? I searched through the solidus core but I cannot find a single place where this remove_from method being called... (except in spec). Thx for the review. What else do I need to do, to get it merged?\n. Great! I didn't know local_assigns before\n. Hi I've just noticed your issue. I think my latest pull request solves the issue: #1591 \n. @dgra I've further looked into this issue.. for your case, did u use create_quantity_adjustments action?. @dgra I'm looking into this issue cuz I was facing sth similar.. Are u able to replicate the issue on the master branch of solidus? If u can.. could u post a screenshot indicating the issue~? Thanks!. When I was digging into the issue, I think the potential cause is a bit complicated.. let me try to describe them below:\n- When building the variants with rebuild VAT price set, and my product is with tax included in price, a price with default country as nil would be created. This price is the set-price, minus the computed tax\n- When adding product into cart, a line item is created. This line item would try to figure out the price from variant.price_for(pricing_options) (check source code here). However, the price_for is trying to figure out a correct price from the country field, but the pricing_options is telling the variant to get country information from delivery address or billing address (depends on setting).\n- At the time of add-to-cart, this address information hasn't been set yet\nTherefore, the LineItem would use the price from the default export price (the price without country), which is the price without Tax. Bug.\n. It seems to solve the issue after setting the cart_tax_country_iso upon store via:\nruby\nSpree::Store.first.update(cart_tax_country_iso: \"SG\")\nAnd it solved the issue.\nHowever, there's another issue:\nlet's say now we're selling to 2 countries: China & Singapore, with tax rate 17% for China, and 7% for Singapore:\n\nWith the default tax country set to Singapore, the price follows that for Singapore. However, when the consumer put in address for China, the item price is not updated.\nI think an extra step of refreshing price (and tax) in LineItem is needed, after the address is put in\n. @mamhoff ahh it's not a issue for me.. (we're only selling to 1 country currently). I was just trying to  give a bad input..\n. Could anyone take a look at this pull request...?\n. Thanks @jhawthorn for ur comments, I'll look into and see if I can add in some test cases to expose the issue.\nBTW, what's the changes we made in 1.4 you're referring to, could u point me to any reference? Thanks :)\nUpdate: after some digging, I found this change log. This \n\nUse in-memory objects in OrderUpdater and related areas\n\nis what u're talking about right~?. @jhawthorn Thanks for ur comment and information.. I've further looked into the issue, and I think I shouldn't do #save in the process of evaluation, since it's updated in the update_item_totals later on. The cause of the bug because of the reload method in CreateQuantityAdjustments: https://github.com/solidusio/solidus/blob/master/core/app/models/spree/promotion/actions/create_quantity_adjustments.rb#L60.\nI think that issue should be raised in a separate pull request.\nAgain, thanks a lot for ur comments & inspiration.. I've raised a new pull request #1597 with test :). Thanks @jhawthorn for the review & code. However.. u need to remove the binding.pry to make the test pass :). There're some discussion on-going about bringing back the Add Item Promotion Action, for example, #492. However, I think this code should be remove first; if there's a need to add it back, it should be included in another pull request.. Thanks @cbrunsdon for your insights. I think there're two approaches:\n\n\ncurrent approach: make the coupon codes included by default, only select wanted ones from the PromotionChooser. Currently, the PromotionChooser would pick the promotion with the largest amount of discount, and mark the rest to be not eligible. Notice that, in this approach, once a promotion is in, it's always in, even when the promotion is not eligible for this order.\n\n\nanother approach: each time an order is updated, try to: 1) activate the eligible promotions; 2) deactivate the non-eligible promotions. Let's define P to be the set of promotions currently in the order, by following this approach, we guarantees that:\n\nthe promotions currently in P are the, and only the, eligible promotions for the order;\nwhenever a promotion is activated (because it satisfies the condition), the activate method would be called, which further calls the perform method of each PromotionAction within this promotion;\nwhenever a promotion is removed, remove_from(order) would be called upon this promotion, which cleans up the side-effect of this promotions.\n\n\n\nI think:\n\nthe current approach only supports the amount-based promotion -- i.e., each promotion must have a money value, and cannot support any side-effect (since one cannot remove the side effect when the promotion become not eligible).\n\nthe second approach brings in a possibility for promotion with side effects, (for example, free-item, which adds an item with 0 as price into the cart), therefore can further support more dynamic kind of promotions. However, in this case, the PromotionChooser needs to be customised also.. Additionally, I think the current idea of supporting \"one promotion at a time\" is a bit wired, and there're two problems I can see:\n\n\ndue to the design, although we're allowing one promotion with one at a time, we can allow free-shipping to exist together with other kind of promotions (which means, in a way, more than 2 promotions at the same time), and there's no way to disable that.\n\nif there're one promotion with 2 promotions which give a money-value discount, only one of them is eligible. A valid use case could be: give user 20% off in the first place, and then minus $100 if the remaining amount is > 1000.. I don't quite understand.. if we have code like:\n\n```ruby\nclass Product\n  def m\n    puts \"Product::m\"\n  end\nend\nmodule Spree\n  class Product\n    def m\n      puts \"Spree::Product::m\"\n    end\n  end\nclass Caller\n    def call_product\n      Product.new.m\n    end\n  end\nend\nSpree::Caller.new.call_product\n```\nshouldn't the Spree::Product to be called by the Caller by default?. @fylooi When I was reading Rails Docs upon module loading today, at section 6.2, it mentioned sth below (cannot copy with style so I just include the screenshot):\n\nI think it's something related to your issue (and which also means, seems to make ur pull request valid). @fylooi I haven't looked through the documentation yet.. nor do I sure if u should continue with the PR. probably need comments from the core team. Meanwhile, I think it's definitely helpful to create a sample App and surface the problem... Looking forward to the fix. This issue bugged me for quite a while also.. Thanks @mtomov . I ended up building a customized endpoint for remove coupon also, similar idea followed :). Just in case anyone needs to see how to do, here's what I did:\n\n. @gus4no it has been a while since last time I develop in solidus.. I was probably on Solidus Master at that time.. Let me try on v2.2 and see how. The issue is gone with solidus 2.2.1\nThanks for reviewing issue again.. @mamhoff What's your idea about this issue?. @radar & @alepore: I'm not very experienced with this issue; I'm encountering the issues described above so I'm proposing this pull request. Please comment if this is a wrong solution.\n. @alepore Yeah I think column_exists should do the trick, since it's a query.\nHowever, I'm curious why your app already already contain that field? Because when u include Solidus, and do the bundle exec rake railties:install:migrations, it would copy all the migrations at the same time.\nIf ur app already contains a depthfield, that means it already contains the spree_taxons table right?. @alepore OK  I see.. Thanks! In that case.. I'll suggest simply remove the condition check on the depth field.. Thanks for pointing out.. fixed :)\n. why the admin_vat_country_iso is used here, rather than default_country_iso?\n. why do we need this [nil] (for all country)? What's an export price?\n. Spree::LineItem.new(variant: variant, order: order) it self doesn't call the #copy_price method, but build the order object does.\nInstead, one should do: \n``` ruby\nlet(:order) { create :order }\n...\nSpree::LineItem.new(variant: variant, order: order).save\n```\n(with a clean order created, without calling copy_price)\nSee #1591 \n. ",
    "loicginoux": "\nthe user is left in a state where it cannot fix the situation in any way I have found: the item appears as reimbursed, but such reimbursement is rejected and no other reimbursement can be created.\n\nWould it be a solution, for stores that have the validator RMARequired, to not let the user create a CustomerReturn if the RMA item is not already created ? \nWe would have an error message before creating the \"Customer Return\" rather than after. This way, it would let the user continue creating other planned returns or customer returns rather than blocking completely what can be done on the interface.\n. Any news on this ? I have an issue that looks really similar.\nI have one product on my order, with a line item promotion adjustment applied to it (10% discount on the product). I add a second product with promotionable = false to the cart and the promotion on the first product is canceled, more precisely it's still eligible but the amount is set to 0.\nAfter adding the second product, the promotion eligibility is recalculated. it's still found the line item promotion eligible.\nWe also recalculate its amount. \nAt this point the Spree::Promotion::Actions::CreateItemAdjustments#compute_amount return 0 because of this line:\nreturn 0 unless promotion.line_item_actionable?(order, adjustable)\nthis is because in promotion#line_item_actionable? the promotion is not eligible at the order level:\nif eligible?(order, promotion_code: promotion_code) # return false\nbecause the order is \"blacklisted\" in promotion#eligible?.\n2 quick suggestions for a fix:\n\nFirst one, in line_item_actionable? we remove the condition on \nif eligible?(order, promotion_code: promotion_code)\nSecond one, this method promotion#line_item_actionable? is not necessary and we should replace it everywhere by promotion#eligible?(line_item)\n\nIf one of these seems like a good fix, I could send a PR.. checked on Slack, he is doing it. . Do you still have the issue with 2.4 or master branch ? . Sorry for late feedback, I'll upgrade to 2.4.0 shortly and come back on this as soon as I can. Thank you.. Taxon touches the taxonomy tree in #touch_ancestors_and_taxonomy.\nProduct touches Taxon and Taxonomies but not classification.\nNot sure what you mean by \" touching on both sides does not create race conditions\"  but touching a product or a taxon does not create a problem (infinite touch loop, if it's what you meant...). Hi, Sorry that may be my bad english :S \nYou need to set up a role that has only \"display stock permission\" and \"display product\". He should not be able to manage neither stock nor product.\nLet me know if you have any more questions. The cause is actually different from my understanding: \n- in v2.2.1, there were this bug  #2215. The shipping method was not added to second shipment so the total of the order was not changed and the payment was kept in state \"paid\".\n- in v2.4.0, this bug is fixed, so when we split the order, the new shipment creates a new shipping method and the total of the order is updated (new_order_total = old_order_total + new_shipping_methode ). The payment is passed to \"balance due\" so when creating the new shipment, it is not passed in state ready but stays in state \"pending.\nin v2.4.0, After splitting, If I pay the difference and come back tho state \"paid\". My 2 shipments are now ready.\nNow the problem is the following, when splitting a shipment, the end client should not have to pay extra money because he will receive his order in 2 packages. Correct me if am wrong but that's actually the behaviour I am seeing with 2.4.0.\n. Your solution would work but I don\u2019t totally agree. From a business point of view, If the logistic department cannot ship in one package and have to send more than one package for X internal reason, the user should not have to pay for it. It's a logistic problem.\nI could add an adjustment to offset the missing payment, that would work, but it should be the default behaviour. I can't imagine a case where the user will be willing to pay for that.... Ok, I agree with you in the case you describe, where the user hasn't paid yet his order, and he knows that sending multiple packages will have an added cost, but in this case he chose it.\nI think this is a different case when order has already been paid in full, in this case the user is not aware of the additional cost and he shouldn't because that's the problem of the seller.\nAre these two cases not different ? Should not they be treated differently ? \nand this second case cannot be unique to our business and treated in our app only, isn't that true for all businesses ?. Ok I understand your point... even if I disagree :)\nThat's ok, no problem, we will then do it with an added adjustment or free shipping to compensate the added cost, that should work indeed.\nClosing the issue.\nThank you.. Ok, there is some news, I think it comes from a misunderstanding from our part between shipments and cartons.\nIn our case, the logistic department send us a a notification with the data of what packages have been shipped/sent from the warehouse. With this data, our app updates the DB with the correct state of shipments/cartons/order.\nWhat we did, when receiving this information, was the same as what we can do in the UI of the backend via the button \"split\", i.e. using the method transfer_to_location. That was then creating a new Shipment object, so updating the order total and we had all the problems above.\nWe actually changed this logic and instead created cartons for each notification received from the logistic department. This way, the shipment object stays unique, the order total is not updated and the price stays the same. We now do that via Spree::OrderShipping.new(order).ship(...).\nSo the problem is that we didn't understand what the \"Split\" button really meant from the business perspective. Actually, the \"shipments\" tab in backend order page has to be seen as a way to visualize and create \"sub-order\" via the split action, in the case when there is more than one wharehouse (or expedition point). \nSeing it this way the solidus behaviour is correct. Hopefully, with the new documentation, there will be less misunderstanding like these. Thanks for yout time \ud83d\udc4d \n. We actually run into an issue similar. I explain it here in case it helps to have more information for a possible solution. After investigating the bug we got to the point where these 2 lines were causing the bug. \n```\nmodels/spree/promotion.rb : line 134\nspecific_rules = rules.for(promotable) # THIS IS THE LINE IN QUESTION\nreturn [] if specific_rules.none?\n```\nIn our case we noted that for a promotion of type \"free shipping\", when we add a line item to the cart, we have: \npromotion.elligible?(line_item) == true\nThis is because specific_rules == [] and thus eligible_rules(line_item) == []\nIt does not seem logical. I was expecting a free shipping promotion to not be eligible for a line item. That may be the case when running the promotion against the order but not against the line item.\n. as a custom fix for our app, I followed your advice to remove completely the specific_rules, and always work with the order and do the elligible tests agains the rules like this:\n```\ndef eligible_rules(promotable, options = {})\n    # Promotions without rules are eligible by default.\n    return [] if rules.none?\n    eligible = ->(r) do\n      order = promotable.is_a?(Spree::Order) ? promotable : promotable.order\n      r.eligible?(order, options)\n    end\nif match_all?\n  # If there are rules for this promotion, but no rules for this\n  # particular promotable, then the promotion is ineligible by default.\n  unless rules.all?(&eligible)\n    @eligibility_errors = rules.map(&:eligibility_errors).find(&:present?)\n    return nil\n  end\n  rules\nelse\n  unless rules.any?(&eligible)\n    @eligibility_errors = rules.map(&:eligibility_errors).find(&:present?)\n    return nil\n  end\n  rules.select(&eligible)\nend\n\nend\n```\nThis seems to be working for us so far.... just to let you know, we use this relation in our code, but overwrote this association like this:\nSpree::Shipment.has_many :cartons, -> { distinct }, through: :inventory_units\nas suggested in rails release note 5.0 http://edgeguides.rubyonrails.org/5_0_release_notes.html#active-record-deprecations\nShould we better change our code and pass by the inventory_units association ?. @sebfie is not here this week but I think this change would fix the issue we are having with partial shipped shipments.. That's not related to Solidus, that's a ruby issue in your code\nRails.application.config.spree.promotions.rules << Spree::Promotion::Rules::MyPromotionRule\n. \"Default\" is the name of the default stock location. . One question: In the context of multiple shipment address, what's the use of order.ship_address ? Is it still necessary to have this address linked to the order if the association is only \"valid\" when the shipments ship to a unique address.. To respond to my last comment, I use the order.ship_address as a default address for a shipment, so by default a shipment has shipment_id: nil and so it refers to the order ship address.\nNow I have another issue with this case :\n1 - I set the order ship address, it creates all the shipments with default address\n2 - I update one shipment address to be different from the order.ship_address, \n3 - I update the order.ship_address.\nResult: it will destroy and recreate all the shipments and therefore I loose the modified shipment address. \nHow could I keep a modified shipment address when updating the order ?. ok, all in one commit now. thx for the review !. Ok I changed commit description and removed one correct grammar on test description . Ok, I think when someone works on an order he will want to keep it open while looking at a product details quickly but doesn't matter. I changed it.. Thats what I though too but we actually used on_hand inventory units only because we saw this method from inventory_unit.rb:\ndef allow_ship?\n     on_hand?\n   end\n. ok, I'll add this test.. I'll change that, it's better yes.. Actually, we cannot really use that condition because this method is called also for all children via:\n```  \nafter_update :update_child_permalinks, if: :saved_change_to_permalink?\n...\ndef update_permalinks\n  set_permalink\n# This will trigger update_child_permalinks if permalink has changed\n  save!\nend\n````\nit breaks current test, I will leave it this way.. Test added. yes updated. I added 2 more tests. ",
    "gus4no": "Working on it \ud83d\udc77 . On it. Hello @flyfy1 what version of solidus are you using? I could not reproduce this on v2.2. Working on this. \ud83d\udc77 . @gmacdougall About what we talked, what do you think of using this\nin_stock_only = ActiveRecord::Type::Boolean.new.cast(params[:in_stock_only])\nto ensure it's converted to a boolean and not only check for presence this already handles '1', '0', 'false','true', false, true. @gmacdougall what do you think now?. @gmacdougall Tests added. @tvdeyen Squashed! :). @gmacdougall I think it's ready now!. @mamhoff Changelog updated and commits squashed! :). Ready @tvdeyen, sorry it took long for such a simple change, hope all is good now. :). ",
    "hectoregm": "The main problem is that splitting a completed order doesn't fill the address and the shipping method\nfor the new shipment, this later raises an error when doing a transition to shipped:\nActiveRecord::RecordInvalid: Validation of Address can't be blank, Shipping method can't be blank.\nhttps://github.com/solidusio/solidus/blob/master/core/app/models/spree/order_shipping.rb#L51\nwhen creating a Spree::Carton called on the after_transition hook for shipped.\n. @forkata yeah I read the proposal to delegate to Order#ship_address but I think we can use this spec\nfor #trasnfer_for_location right ?, I could remove address expectation and the injection of address.\n. @forkata made the changes we mentioned and added aggregate_failures block\n. ",
    "omnistegan": "I've spent some time working with @Mandily on the product related pages. I'm still working through a few small improvements and then I'll submit a PR for the product edit page and solicit comments.\n. Changed the product layout to use bootstrap classes instead of skeleton classes.\nWhile most pages in admin were unaffected by enabling bootstrap grid classes, the new product form was not displaying correctly as noticed by @jhawthorn and @graygilmore \nHere is how the new product form renders on the /admin/products page looks in solidus currently.\n\nHere is how new product form renders on /admin/products/new\n\nHere is how new product is rendered with bootstrap grid classes enabled, but with no changes to the views.\n\nAnd finally, here is how the new product form renders using bootstrap classes via the changes in commit f89a9e74731dae680e09521be28b5a788a7261f2\n\nWith bootstrap grid classes enabled and the products views displaying correctly using bootstrap grid classes, work can start on migrating the remainder of admin views to bootstrap classes.\n. Here is what it looks like with fieldset legend style headers.\n\n. @jhawthorn @mamhoff The options table was suggested to help the user quickly reference if they have prices set for all the relevant variants.\nA select box of variants is available to the user when creating a new price, so options are not very useful to display on the prices index page.\n. A couple of updated screenshots with options table removed, and only showing variants table if the product has variants.\nWithout variants:\n\nWith variants:\n\n. Here are a few of the changes I was able to make thanks to all of your feedback. I hope I was able to address some of your concerns.\n- Removed the .container-fluid from the edit form. Bootstrap encourages the use of a container or container-fluid as a parent of row classes. It may be possible to place one in the admin layout, but there are not any issues I could find placing rows inside a fieldset. That is, using row classes at the top level of the form partial and not having a container or container-fluid anywhere on the page.\n- Used bootstrap mixin for .form-section. This way we can override bootstrap's gutter and set our own margins. Because the form-section itself is placed inside a bootstrap column, the row mixin needs to exist for nested columns to work.\n- Position .text-field-addon absolutely.\n- Reworked empty space to be filled with empty bootstrap columns rather than nesting rows.\ne.g.\nhtml\n<div class=\"row\">\n  <div class=\"col-md-6 col-xs-12\">\n    Some Content\n  </div>\n  <div class=\"col-md-6 hidden-sm-down\"></div>\n</div>\ninstead of\nhtml\n<div class=\"row\">\n  <div class=\"col-xs-12\">\n    <div class=\"row\">\n      <div class=\"col-md-6 col-xs-12\">\n        Some Content\n      </div>\n    </div>\n  </div>\n</div>\n. I haven't written an extension yet, so I'm going to tackle this. :). Thanks, rebased this commit: b1bb56fe6a42f28c95f731a591cf670659bde336\n. Thanks, noted in the ChangeLog.\n. Yes, but not if it is displayed as a Tooltip because the Tooltip is only displayed on mouseover. We could instead place this text so it is always visible and attach the link.\n. Good suggestion, updated.\n. This style is used on the edit page with the admin_layout method. <% admin_layout 'left-aligned' %> Other options available are 'centered' or 'full-width' (like the product index page). Maybe another name would be clearer.\n. This class places a font awesome character in the right of a text field for context.\n<span class=\"fa fa-caret-down text-field-addon\"></span>\nI'm not sure if absolute positioning is possible because it needs to sit relative to the right side of it's parent.\nPointer events are disabled so that clicking the icon will still allow access to the field below.\nThese kinds of icon addons may be frequently used in the new layouts, so it's probably worth us finding a cleaner solution.\nUpdate: I've placed the icon absolutely here.. This class is applied to the div that contains forms that dynamically appear above tables, like the new_product_wrapper on the product index page.\nWhen the new product partial is rendered into the index layout, it is rendered left-aligned (with this class) rather than inheriting <% admin_layout \"full-width\" %> from the index page.\n. This is for the right 1/3 column, specifically the helpful text on SEO. Maybe helpful-text-column instead?\n. This container-fluid pads the form where it is rendered.\nBecause this is a partial, it doesn't sit inside admin layout directly. We could place a container around the render call, but it seems to make sense to have it here if we want it at all.\n. The problem is with holding less than full-width columns on a row by themselves.\nHere we want the SKU field to always be on it's own line visually, but if the SKU div and the Name div are in the same row, they will sit on the same line (at medium and above).\nSome better spacing here could make the grid structure read clearer.\n. I've updated the markup to use hiding columns rather than use additional nesting. This keeps content from being indented as far and uses hidden-**-down tags on empty divs to pad empty space.\nSee my comment for some markup in comparison.. I've updated the left-aligned classes (this one, and the form style) to be named max-width.\nThis seems to be in line with the function they serve and how they are being discussed in #1290 and other related comments.. I like this better. Also we can use it when we return the decimal instead of using a cast_to_d method. How would you feel about:\n```ruby\n    def self.parse\n      ...\n  # Handle empty string for ruby 2.4 compatibility\n  BigDecimal.new(number.presence || 0)\nend\n\n```. ",
    "RitaD": "I\u2019m currently working on this, expect a PR soon!\n. ",
    "SebAshton": "Happy to will get cracking on this.\nSo we agree on the approach, an ideal solution will:\n- use a service object to validate whether the terms_and_conditions attribute is required to complete that step.\n  - perhaps have an early return if a Spree::Config is set to false\n- use the service object in a  before_action on update within Spree::CheckoutController\n- use the service object in a before_action on next and complete within Spree::API::CheckoutController\n. duplicates #1196 \n. closes #1313 \n. Anyone else stumbling into this error, the solution is to set the following in an initializer:\n```\nhttps://github.com/ohler55/oj/blob/master/pages/Options.md#nan-symbol\nFixes issue with Infinity in JSON\nrequire 'oj'\nOj.default_options = {\n  mode: :compat,\n  nan: :huge\n}\n```. ",
    "RoryMacDonald": "Couple of thoughts on this:\n- If we're not persisting this value, then what happens when a user accepts T&Cs and wants to make a change to shipping / basket contents? Expect they will need to accept the T&Cs again. This behaviour will differ to the rest of the checkout forms, which isn't great from a UX perspective.\n- I'd echo @bbuchalter views that this is important business logic and am also unsure if solidus_frontend (or a JS checkbox) is the right place for this. \n. ",
    "oojewale": "@Mandily, any update on this? A couple of friends and I are about to start working on it.\n. @Mandily, any update on this? A couple of friends and I are about to start working on it.\n. ",
    "jtapia": "@oojewale https://github.com/solidusio/solidus/pull/1963. thanks guys \ud83d\udc4d \n. hey guys, this is my proposal to fix that https://github.com/solidusio/solidus/pull/2589. @tvdeyen I just changed the approach, what do you think?. @tvdeyen right, my bad, fixed. with es-MX you can see this:\n\nand later I got a missing translation error, I created this PR https://github.com/solidusio/solidus_i18n/pull/129 to fix that, with es, es-EC and es-CL is working fine\n@sechix what is the locale that are you using?. I think this would make the code more readable. @kennyadsl done, please let me know what do you think. @BenMorganIO thanks for the comments and @gmacdougall thanks, glad to help \ud83d\udc4d . @BenMorganIO https://github.com/solidusio/solidus/pull/2795 and https://github.com/solidusio/solidus/pull/2796. @kennyadsl done. @kennyadsl sure, what is the process to move the exension into the solidus-contrib organization?. @kennyadsl I just sent to you the invite, thanks. @kennyadsl right, my bad, I just did it. I was able to reproduced it and created this PR https://github.com/solidusio/solidus/pull/3067, this fixed the issue, let me know your thoughts. @kennyadsl sure, checking it. @spaghetticode I just added a test, please let me know what do you think. @spaghetticode please let me know what do you think, thanks. @spaghetticode should we remove the Needs Tests tag?. @kennyadsl I asked @softr8 to rebase the PR #2504, I'm going to close this one. I just tested it and yes, we can use only table-responsive, I sent the changes https://github.com/solidusio/solidus/pull/2589/files. I'm reloading the payment methods because I got this error if I use the payment_method created before:\npry(#<RSpec::ExampleGroups::SpreeAdminPaymentMethodsController::Update>)> payment_method.reload\nActiveRecord::RecordNotFound: Couldn't find Spree::PaymentMethod::StoreCredit with 'id'=1 [WHERE \"spree_payment_methods\".\"type\" IN ('Spree::PaymentMethod::StoreCredit')]\nfrom /Users/kaifan11/.rbenv/versions/2.5.1/lib/ruby/gems/2.5.0/gems/activerecord-5.2.0/lib/active_record/relation/finder_methods.rb:346:in `raise_record_not_found_exception!'\nI think it's because of the payment method reference, any ideas?. @BenMorganIO because of the error I didn't use the payment_method reference, for example, here:\n```\ndescribe \"#update\" do\n      # Regression test for https://github.com/solidusio/solidus/issues/2789\n      let(:payment_method) { create(:store_credit_payment_method) }\n      let(:params) do\n        {\n          id: payment_method.id,\n          payment_method: {\n            name: 'Check',\n            type: 'Spree::PaymentMethod::Check'\n          }\n        }\n      end\n  it 'redirects to payment method edit page' do\n    put :update, params: params\n    expect(response).to redirect_to(spree.edit_admin_payment_method_path(payment_method))\n  end\n\n  it 'updates the resource' do\n    expect { put :update, params: params }.to change { payment_method.reload.name }.from('Store Credit').to('Check')\n  end\nend\n\n```\nI'm getting this:\nActiveRecord::RecordNotFound: Couldn't find Spree::PaymentMethod::StoreCredit with 'id'=1 [WHERE \"spree_payment_methods\".\"type\" IN ('Spree::PaymentMethod::StoreCredit')]. doing that I got another error\n```\n1) Spree::Admin::PaymentMethodsController#index respects the order of payment methods by position\n     Failure/Error: expect(assigns(:payment_methods).to_a).to eql([second_method, first_method])\n   expected: [#<Spree::GatewayWithPassword id: 3, type: \"Spree::GatewayWithPassword\", name: \"Second\", description:...=>\"1235\"}, preference_source: nil, position: 2, available_to_users: true, available_to_admin: true>]\n        got: [#<Spree::GatewayWithPassword id: 3, type: \"Spree::GatewayWithPassword\", name: \"Second\", description:...=>\"1235\"}, preference_source: nil, position: 3, available_to_users: true, available_to_admin: true>]\n\n   (compared using eql?)\n\n   Diff:\n   @@ -1,3 +1,4 @@\n    [#<Spree::GatewayWithPassword id: 3, type: \"Spree::GatewayWithPassword\", name: \"Second\", description: nil, active: true, deleted_at: nil, created_at: \"2018-07-03 19:13:28\", updated_at: \"2018-07-03 19:13:28\", auto_capture: nil, preferences: {:server=>\"test\", :test_mode=>true, :password=>\"1235\"}, preference_source: nil, position: 1, available_to_users: true, available_to_admin: true>,\n   - #<Spree::GatewayWithPassword id: 2, type: \"Spree::GatewayWithPassword\", name: \"First\", description: nil, active: true, deleted_at: nil, created_at: \"2018-07-03 19:13:28\", updated_at: \"2018-07-03 19:13:28\", auto_capture: nil, preferences: {:server=>\"test\", :test_mode=>true, :password=>\"1235\"}, preference_source: nil, position: 2, available_to_users: true, available_to_admin: true>]\n   + #<Spree::GatewayWithPassword id: 1, type: \"Spree::GatewayWithPassword\", name: \"Bogus\", description: nil, active: true, deleted_at: nil, created_at: \"2018-07-03 19:13:28\", updated_at: \"2018-07-03 19:13:28\", auto_capture: nil, preferences: {:server=>\"test\", :test_mode=>true, :password=>\"haxme\"}, preference_source: nil, position: 2, available_to_users: true, available_to_admin: true>,\n   + #<Spree::GatewayWithPassword id: 2, type: \"Spree::GatewayWithPassword\", name: \"First\", description: nil, active: true, deleted_at: nil, created_at: \"2018-07-03 19:13:28\", updated_at: \"2018-07-03 19:13:28\", auto_capture: nil, preferences: {:server=>\"test\", :test_mode=>true, :password=>\"1235\"}, preference_source: nil, position: 3, available_to_users: true, available_to_admin: true>]\n\n```. done, thanks. thanks, done. thanks, done. thanks, done. done. done. done. right, done. done. fixed. fixed. @ccarruitero what do you think?. done here https://github.com/solidusio/solidus/pull/3066/files#diff-72468e52a59aedfe8a3443597f1a6f3aR836. done here https://github.com/solidusio/solidus/pull/3066/files#diff-72468e52a59aedfe8a3443597f1a6f3aR836. done here https://github.com/solidusio/solidus/pull/3066/files#diff-72468e52a59aedfe8a3443597f1a6f3aR836. done here https://github.com/solidusio/solidus/pull/3066/files#diff-72468e52a59aedfe8a3443597f1a6f3aR836. @tvdeyen right, I made this change here https://github.com/solidusio/solidus/pull/3066/files#diff-173268f0a85c59ef13e0753726e16ba8R13. @spaghetticode I just changed the approach, please let me know what do you think. ",
    "tlindsay": "This is already how it works for me on the latest release (1.3.0.rc1) and also on master. It also seems to be consistent with the code for that view.\n\n. ",
    "mdesantis": "Hello, I'm taking care of this issue. There are a couple of questions about it:\n\nCurrently, Solidus isn't made to handle the case when default country is not set, as it can be inferred by the search results below, which expect id to be defined:\n\n```\nResults for \"Country.default.id\"\nfrontend/app/controllers/spree/checkout_controller.rb:\n  196:        default = { country_id: Spree::Country.default.id }\napi/app/views/spree/api/config/show.json.jbuilder:\n  3:  json.default_country_id(Spree::Country.default.id)\nbackend/app/controllers/spree/admin/orders/customer_details_controller.rb:\n  16:            country_id = Spree::Country.default.id\n```\n\n\nThe case default country not included in available countries, that is surely an unwanted case, isn't handled (as pointed out above by @bbuchalter); there are multiple ways that come to mind in order to handle it:\n\n\nignore such case and let its behaviour be undefined\n\n\nraise an error\n\n\nsilently ignore the default country\n\n\nraise a warning and ignore the default country\n\n\nWhat I would do is:\n\n\nHandle the case where default country is not set, ignoring its value when setting the default country\n\n\nI'm unsure what I'd do in this case, I think I would go with iii, otherwise iv\n\n\nAny thoughts?. Hey there, it seems to be fixed now; this is what I get reproducing the steps above: \n\nSolidus gems versions as below:\n```\n\nbundle show | grep solidus\n  * solidus_api (2.8.2)\n  * solidus_auth_devise (2.1.0)\n  * solidus_backend (2.8.2)\n  * solidus_core (2.8.2)\n  * solidus_support (0.2.2)\n```\n. This issue seems to have been fixed in https://github.com/solidusio/solidus/commit/0ecd93ea50029b40d90ea9e6d6b7fcb5eb2fc71b. @kennyadsl, #3059 isn't related to this issue, since it doesn't mess with shipment adjustments.\n\nI worked recently on Spree::UnitCancel and I can't remember any attempt there to create adjustment for shipment costs, so I suspect to be that way by design. If instead we all agree that when we go on 'Cancel Items' tab and we cancel line items the related shipment costs should be adjusted accordingly, we should work on that as it is a \"feature\", from a developer point of view. @ericsaupe, by my checks, cancelling items doesn't take in consideration shipment costs using any shipment method: does it match with your observations? . Hello! I propose this one: https://github.com/chmln/flatpickr\nIt has time selection too, while none among https://github.com/dbushell/Pikaday, http://bootstrap-datepicker.readthedocs.io/en/latest/ and https://fengyuanchen.github.io/datepicker/ seem to have time selection (feel free to check, maybe I couldn't spot it reading their documentations).\nI used flatpickr in a Rails project recently, so I know how to integrate it in a Rails project, and I know that works well with turbolinks. It works great on mobile too.\nI'm gonna try to integrate it into a solidus sandbox and see what happens :-)  in the meantime, happy new year!. >  maybe we don't need files for themes and plugins we are not going to use. WDYT?\nI think it's bad either way. The right way to import an external client side library in Rails nowadays is using yarn, but I didn't detect any use of it in solidus. Copy pasting external libraries is bad, it introduces all the issues that we, as Rails developers, had on server side before bundler was introduced, that is third party libraries not synced with upstream, hardly upgradable (as I pointed out in 6.) and thus rarely updated. Not to mention that sometimes developers feel the right to edit copy pasted third party libraries, making updatings a nightmare.\nIn order to keep as most as possible third party libraries synced with upstream I usually import all the libraries code, even the unused code, but it's definitely possible to cherry pick the used files. I think the choice depends by the current solidus way to manage third party libraries.. @kennyadsl I moved the datepicker code to a single file, is it ok? :-). Yes, it's fine for me. If you want help just ask ;)\n\nMaurizio De Santis\nIl 17 gen 2018 12:02 AM, \"John Hawthorn\" notifications@github.com ha\nscritto:\n\nThis looks great to me \ud83d\udc4d\nI hope you don't mind I've taken it to #2477\nhttps://github.com/solidusio/solidus/pull/2477 with a few small changes:\n\nRebased (Fixing the build)\nAdded localization\nFixed CRLF line endings\nRemoved unused flatpickr files\n\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly, view it on GitHub\nhttps://github.com/solidusio/solidus/pull/2477#issuecomment-358137111,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AARSuLGU-h8O248vK4EPH-nG8CNafGL8ks5tLSqMgaJpZM4RQ-Rz\n.\n. If the mutablething is used just to mark the default record yes, it shouldn't be much more complex than rename mutable to default and swap the values; if otherwise the mutable thing is there to represent some separated logic we could add a default column in order to manage this record and leave the mutable thing alone.. @peterberkenbosch could it be this Rails issue? rails/rails#30937 it's marked as closed but it was closed for stale. What about this part of Rails docs:\nUsing Class#class_eval is great for simple adjustments, but for more complex class modifications, you might want to consider using ActiveSupport::Concern. ActiveSupport::Concern manages load order of interlinked dependent modules and classes at run time allowing you to significantly modularize your code.\n\nWorking on Solidus I found having to use class_eval pretty awkward, instead using ActiveSupport::Concern sounds better to me (more flexible, more idiomatic). The cons is that it requires a simple but huge change: move Solidus models logic to concerns. But it would also give us the opportunity to reorganize and modularize models logic. \nCould it worth the effort?. @kennyadsl well, actually I didn't try anything practical, I'm checking what they mean in the Rails docs just now. Basically, if in Solidus you move all the class logic to a main concern, e.g.:\n```ruby\nmodule Spree\n  class PromotionRule < Spree::Base\n    include Spree::Models::PromotionRule\ndef hello\n  'Hello from Solidus'\nend\n\nend\nend\n```\nThen in your application you could have:\n```ruby\nmodule Spree\n  class PromotionRule < Spree::Base\n    include Spree::Models::PromotionRule\ndef hello\n  \"#{super} and from my app\"\nend\n\nend\nend\n``\nBut it's actually not a \"decoration\", it's a \"redefinition + include all the previous logic\": you are actually redefiningSpree::PromotionRule`. So, in order to use this technique, also extensions should implement all the logics into concerns, and then in your app you'll have to write something like:\n```ruby\nmodule Spree\n  class PromotionRule < Spree::Base\n    include Spree::Models::PromotionRule\n    include Spree::SomeExtension::Models::PromotionRule\ndef hello\n  \"#{super} and from my app\"\nend\n\nend\nend\n```\nMoreover, you'll have to do the same for every class defined by Solidus (e.g. in the example above if you want to customize Spree::Base, you have to move in Solidus core all the Spree::Base logic to a main concern and in your app redefine 'Spree::Base' + extend it).\nI'm unsure whether is better or not: from one hand it makes your app classes more explicit about what they include, from the other hand it's more verbose than class_eval implementation. Any thoughts?. @bitberryru you're right, I was re-inventing prepend :-) indeed I like your implementation, ideally I'd want something like that integrated into ActiveSupport::Concern, so to have at the same time the advantages of Concerns and of Prepends. There are various examples of it out there:\n\nhttps://gist.github.com/bcardarella/5735987\nhttps://github.com/DavyJonesLocker/ruby-easy_auth/blob/master/lib/easy_auth/active_support/concern.rb\nhttps://gitlab.com/gitlab-org/gitlab-ee/commit/f62067552441620527afeb03bbed26e4ab2da301\n\nAnyway, great news on the Rails side: rails/rails#34946 has been merged, so now it's official that talking about decorators in this context it's not appropriate!. Yes, I'm sorry, I made a mistake while editing the commit message removing the Bundler version part, which happens to be unrelated. It's too early to open this PR here, I'm going to close it and open again later. I'm going to close this PR because, as @spaghetticode made me notice, within Spree::UnitCancel#adjust!, if we use inventory_unit.order.recalculate there's no need anymore to use inventory_unit.line_item.adjustment_total += amount, so the whole argument about order associations tree out-of-sync falls apart. Instead, I just opened #3059 which adds failing tests for the issue reported here.. One thought about Rails 6 and ActionText: are there any places in Solidus where we'd like to use it? Any places where we write rich text?. @kennyadsl commit splitting :+1: . @spaghetticode , what about fully embracing the JavaScript metaphore and replace publish, subscribe and unsubscribe respectively with trigger, on and off?. Regarding instrument with or without block: I think that if the reported timings are not used the block is redundant and even misleading: looking at it it tells me that there is a reasoning behind it and that it is required for something.\n\nthe block clarifies what actions are part of the order finalization process (you may argue that in this specific example the method is already named finalize!, so there's no need to add another wrapper, but this is just a basic example...\n\nExactly, there's the method scope for that\n\nif I had to stick to a convention I'd wrap rather than not, at the cost of being sometimes redundant\n\nif I had to stick to a convention I'd not wrap rather than yes, because we are using ActiveSupport::Notification as event dispatcher, we aren't using it as timings reporter, so the blocks are redundant\n\nyou get the ability to do what Rails does, for example calculating the time required to perform the action (the code inside the block)\n\nBut since does timings are not used it just adds unneeded complexity; also, even if you need those timings, the code wrapped by the block should accidentally correspond with the code that you need to measure, so it's pretty unreliable to me. Fixing PR: #3088. @kennyadsl ~I guess they have a template for the new Rails app~ just checked and they didn't have already a template :disappointed: , but we don't have it, and I wouldn't add it just for this edit. Anyway, since in lib/sandbox.sh there is also\n```sh\ncat <> Gemfile\ngem 'solidus', path: '..'\ngem 'solidus_auth_devise', '>= 2.1.0'\ngem 'rails-i18n'\ngem 'solidus_i18n'\ngroup :test, :development do\n  platforms :mri do\n    gem 'pry-byebug'\n  end\nend\nRUBY\n```\nI could convert both of them to the \"Rails template way\", WDYT?. @kennyadsl :+1: I'll do that in another PR. @jacobherrington here we are! can you please check that what I wrote makes sense? I feel it could be expressed better. No, it is a typo! Nice catch!. I actually already implemented the former behavior, and I saved that code in the case it was decided to preserve that behavior. If requested I can switch to that.. Yes, we could talk together about that in the issue discussion maybe? I don't know if all the points I made above in the pull request comment will be considered :flushed:. promtion -> promotion. 2 -> two (you are not indicating a quantity here). What about create!?. I totally agree with that :+1: . @spaghetticode thanks for the review! unfortunately no, we can't use where: one of the points of this PR is about replacing where with select, since the former doesn't return the same object ids of @order.inventory_units, while the latter does; and Spree::OrderCancellations requires that. What about extracting it into a method? It could be reused in that way (I noticed it's used elsewhere). ",
    "kwstannard": "What about just setting the default location to a read only address instead of having a completely new class?\nruby\ndef default_cart_tax_location\n  a = Spree::Address.new(country: Spree::Country.find_by(iso: cart_tax_country_iso))\n  a.readonly!\n  a\nend\nedit: apparently readonly! is more complicated than that.\nedit2: Spree::Address overrode readonly?, change it to super || persisted? and it will work.\n. @jrochkind that is fine since this address is not a record in the DB.\n. This worked for me thanks :)\nedit: actually, I am getting this failure. Seems like I need phantomjs installed, which is reasonable, but I would think the build would just error out instead of cause test failure.\nCliver::Dependency::NotFound:\n              Could not find an executable [\"phantomjs\"] on your path.. ",
    "florianguenther": "What is the preferred solution for this?\nIs someone working on the issue?. yes, this was the problem, there are adjustments referencing non existing orders.\nthanks\n. ",
    "agustif": "So a PR to add tooltips would make sense if someone was to give this a try? I would like to give back to core but need easy/simple entry-level stuff to be able to commit to it and success.\n. ",
    "sviechnikov": "In 1.49.0 it was fixed ...\n. I have this messages:\nThe bundle currently has activemerchant locked at 1.48.0.\nBundler could not find compatible versions for gem \"activemerchant\":\n  In Gemfile:\n    solidus (>= 0) ruby depends on\n      solidus_sample (= 1.2.2) ruby depends on\n        solidus_core (= 1.2.2) ruby depends on\n          activemerchant (~> 1.48.0) ruby\n. I have the same message ... \n\"The specifier ~> has a special meaning, best shown by example. ~> 2.0.3 is identical to >= 2.0.3 and < 2.1. ~> 2.1 is identical to >= 2.1 and < 3.0. ~> 2.2.beta will match prerelease versions like 2.2.beta.12\"\nI found this on http://bundler.io/gemfile.html\n. It means, activemerchant can be updated in rage: from 1.48.0 to 1.48.9\n. @mamhoff, it is trouble for me, because my project will be released very soon and I have many dependencies with 1.2.2 version. I'm really glad about new 1.3.0 and will use it in feature projects. \nMaybe Solidus team can make little branch with possibility to upgrade activemerchant?\nIf it can be ...\n. ",
    "ezekg": "What's the status on this? Like @Kingdutch, I assumed you could implement your own front-end but that doesn't actually seem to be the case, even though the readme makes it sound like it is.\n. ",
    "gbrlcustodio": "Does it still unsolved?. ## Steps to reproduce\n\nCreate a rails 5 api only project;\nAdd solidus_api and solidus_auth_device\nRun the spree generator bundle exec rails g spree:install\n\noutput\nsh\n/home/gabriel/.rvm/gems/ruby-2.3.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:293:in `require': cannot load such file -- sass/rails (LoadError)\n    from /home/gabriel/.rvm/gems/ruby-2.3.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:293:in `block in require'\n    from /home/gabriel/.rvm/gems/ruby-2.3.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:259:in `load_dependency'\n    from /home/gabriel/.rvm/gems/ruby-2.3.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:293:in `require'\n    from /home/gabriel/.rvm/gems/ruby-2.3.0/gems/solidus_auth_devise-1.6.2/lib/solidus_auth_devise.rb:4:in `<top (required)>'\n    from /home/gabriel/.rvm/gems/ruby-2.3.0/gems/bundler-1.14.3/lib/bundler/runtime.rb:91:in `require'\n    from /home/gabriel/.rvm/gems/ruby-2.3.0/gems/bundler-1.14.3/lib/bundler/runtime.rb:91:in `block (2 levels) in require'\n...\nIf I remove devise_auth_devise from Gemfile, than the generator runs, but, it creates vendor assets - that I guess it should not.\nAny clue?. ",
    "acrolink": "Thanks @jasonfb .. I read the documentation you pointed to .. I think this task should be easier to do than the way it is now, nothing compares to directly editing views and controllers .. What I understood is that modifying the views/controllers files is possible but that would mean editing the global ones. Maybe I can avoid this by installing solidus/spree locally within my app.\n. @jasonfb Thanks, that made things clearer for me.\n. ",
    "marknfischer": "I had same issue last week and today with this button.  Would love to \"try it out with the click of a button.\"  I'm obviously not going into production with that architecture.  But seeing it working w/o spinning up a local rails instance would be awesome.\n. ",
    "cassidyclawson": "Just another +1 that the button doesn't work. I think ya'll show try to save it because the button is a great way for people like me to demo the app.\n. ",
    "michaelminter": "I get \nBundle completed (39.73s)\n       Cleaning up the bundler cache.\n !\n !     cannot load such file -- bundler/lockfile_parser\n !\n/app/vendor/ruby-2.3.1/lib/ruby/2.3.0/rubygems/core_ext/kernel_require.rb:55:in `require': cannot load such file -- bundler/lockfile_parser (LoadError)\n    from /app/vendor/ruby-2.3.1/lib/ruby/2.3.0/rubygems/core_ext/kernel_require.rb:55:in `require'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/helpers/bundler_wrapper.rb:128:in `block in parse_gemfile_lock'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /app/vendor/ruby-2.3.1/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/helpers/bundler_wrapper.rb:85:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/helpers/bundler_wrapper.rb:126:in `parse_gemfile_lock'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/helpers/bundler_wrapper.rb:110:in `lockfile_parser'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/helpers/bundler_wrapper.rb:73:in `specs'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/helpers/bundler_wrapper.rb:53:in `has_gem?'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/ruby.rb:659:in `block in create_database_yml'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /app/vendor/ruby-2.3.1/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:48:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:44:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/ruby.rb:657:in `create_database_yml'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/ruby.rb:102:in `block (2 levels) in compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/ruby.rb:751:in `allow_git'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/ruby.rb:98:in `block in compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /app/vendor/ruby-2.3.1/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:48:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:44:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/ruby.rb:88:in `compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/rails2.rb:49:in `block in compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /app/vendor/ruby-2.3.1/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:48:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:44:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/rails2.rb:47:in `compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/rails3.rb:38:in `block in compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /app/vendor/ruby-2.3.1/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:48:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:44:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/rails3.rb:37:in `compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/rails4.rb:41:in `block in compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /app/vendor/ruby-2.3.1/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:48:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:44:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/rails4.rb:40:in `compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/solidus.rb:66:in `compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/bin/compile:16:in `block (2 levels) in <main>'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:131:in `log'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/bin/compile:15:in `block in <main>'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:35:in `block in trace'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /app/vendor/ruby-2.3.1/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:35:in `trace'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/bin/compile:11:in `<main>'\n !     Push rejected, failed to compile Ruby app.\n !     Push failed\n. ",
    "sheerun": "Confirming\n. ",
    "nhodges": "Now it fails because of interdependency issues.\nGemfile requires rails (= 4.2.7.1) however the version of solidus_core it resolves to requires rails (~> 5.0.0)\nWhy not point the Heroku template at the latest working release?\nhttps://heroku.com/deploy?template=https://github.com/solidusio/solidus/tree/v1.4.0.beta1\nEdit: Tried that and ran into the issue @michaelminter is facing regarding bundler/lockfile_parser not loading for whatever reason.\n. ",
    "Elffers": "Update: The issue appeared to be that I was only providing a zip code in the address attributes, but the Payment source that is created (and instance of Spree::CreditCard) is associated to an Address object that has validations on the other address fields if any address attribute is found.\nSo I am now able to correctly process a payment through stripe, but the states are still not accurately reflected in the admin dashboard, which I am assuming has something to do with customizing the state machine.\n. I am trying to incorporate a shipping price into the total amount charged for an order, but shipping is simply calculated as a flat rate based on which country we are shipping to. It seemed easier to use adjustments rather than going through the actual Shipment phase, since that has a lot of needless complexity.\nI am using the Importer in an action override of the frontend Spree::OrdersController. \n. ",
    "countchokcula": "I figured it out. you can edit the image sizes in the image tag method inside of the parameters where it says attachment. I changed the symbol from :small to :large <%= link_to image_tag(product.display_image.attachment(:large), itemprop: \"image\"), url, itemprop: 'url' %>\n. Oops. i forgot to remove my old migration files. I wiped the entire database and deleted all of the random migrations files from the old solidus. easy!. ",
    "DanielePalombo": "@jhawthorn i'm working on this issue, I'm almost done\n. @adaddeo Have you try if my PR resolve your issue?\n. Conflicts are fixed. CHANGELOG updated.. Updated. Thanks!. Hi @jhawthorn  ,\ni understand what do you mean, i agree with you probably it's better  clarify to the admin user the stock status and how the stock items in the order are splitted.\nI propose to change the update quantity logic and give the possibility to change the quantity for each stock item. I drew a mockup to show you how i want implement this.\nIn order cart page with one item added in order, the user click on edit for change the quantity.\n\nThe admin show the order_stock_locations details.\n\nThe admin can change specific quantity for each order_stock_locations . When done click apply button to update the quantities.\n\nWhat do you think about it?\n. Before rebase or other changes, I'm waiting to know if my proposed solution can be alright.\n. Sorry I don't understand what do you mean. \nCould you explain the problem some more?. @mtomov i hope now it's ok for you.\n. My and @mtylty started to investigate this issue and we found these related issues: #1254, #1107, https://github.com/spree/spree/issues/6229 , spree/spree#5907\n. After some insights i refactor the code to keep backward compatibility\n. @bbuchalter,\nthanks for your attemps. \n\nbut I believe we now need some feature tests to automate some of this QA if wish to avoid future regressions.\n\nI Agree with you!\nI can confirm the result after the same steps, but maybe i found a workaround. After the refund i create an adjustment ,or delete the item from cancel tab, and the balance becomes 0 and the state paid.\n\n\nI don't know if this can resolve your issues or if we can create an adjustment after the reimbursment... i would like to deepen the discussion.\n. Ok, I'll rebase it next weekend.. I rebased it.. It works with FulfilmnetChanger. My tests was with the latest stable version (v2.3). \nThank you.\nWe can close this issue.. Thanks for the fast answer.\nIf I have backorderable stock item with count on hand 0, I can receive new order for this product, then after the order the related count on hand should be negative. This allow me to understand how many items are out of stock. \nEven in the previous screenshots the count on hand is negative after I made an order with more quantity than availability.. @kennyadsl I have rebased it!. Hi @tvdeyen, I moved the callback in the controller. What do you think about it now?. Yes @jacobherrington, I'm waiting a response on it.. I'm on it. I'm on it. Thank @seand7565 to have fixed this bug. LGTM !. I used raw  because i copied from https://github.com/solidusio/solidus/blob/c5b9e0242291a2249ea62b046cc973b530957d51/core/app/views/spree/order_mailer/confirm_email.html.erb#L18\nLike in other html templates, i don't use sanitize, the only thing to do is escape the text.\n. Thanks, i push the changes\n. I think text is appropriate. In this way we prevent inserting the html code (link, images ecc...) and the documents can be printed in proper format.\nref https://github.com/solidusio/solidus/issues/1196#issuecomment-222467628\nThe terms and conditions should be in a format that can be printed or saved \u2013 therefore avoid pop-up windows and ensure that they fit within the width of the page and are presented in a way that they will print properly.\nFor proper work with text formatting maybe it's better leave the textarea.\n. :+1: replaced textarea with div. I also removed the terms and conditions text.\n. The problem is that the existing code use a percentage to calculate the value of each line item. This works without problem when quantity is factor of 100 , but in other cases this returns a repeating decimal percentage and the result is a little bit different.\nEx:\nexisting code: \n```\ndef percentage_of_line_item(inventory_unit)\n  1 / BigDecimal.new(inventory_unit) \nend\n...\n30 * percentage_of_line_item(3) # 30 * 0.333333333333333333 = 9.99999999999999999\n```\nwhat we want is 10 not 9.99999999999999999\nwith fix we have:\n30 / 3 # 10\nReplaced the test from / line_item_quantity to * ( line_item_price / line_item_total ) because the code https://github.com/nebulab/solidus/pull/4/files#diff-f271b0c846fcbc382f43fdfa7f6a0c89R24 use a percentage instead a division\n. ok, i replaced my code.\nDuring my investigation i found round_to_two_places method in Spree::Calculator::DefaultTax. Maybe we could use this method? I made this commit with my proposal.. This is a test for Spree::InventoryUnit#finalize_units!.. Fixed!. with is repeated two times. if repeted twice. Maybe I'm wrong, but seems like gateway method  https://github.com/solidusio/solidus/blob/f2a921e02f73a13cf509c3423bb1a782296e69a3/core/app/models/spree/payment_method.rb#L130-L137  returns an instance of this payment method. Gateway_options is the variable provided to the gateway class.. This method was stubbed because the reimbursement in this spec does not receive the order, so the reimbursement creation failed.\nNow I'm going to check that order is provided before run recalculate on it.. ",
    "bjvoth": "Ha! I was sure this was too easy to screw up. @mamhoff I'm pretty sure the PR is coming from me now.\n. Ha! I was sure this was too easy to screw up. @mamhoff I'm pretty sure the PR is coming from me now.\n. ",
    "dportalesr": "Hi! I'm working on a project with Solidus v1.2 and we recently updated it to use TL5. I can confirm the address form validation is broken when coming from a turbolink. If this get merged, is there a way that this fix will be backported to the version I'm using? Or should I patch it myself?\nThanks in advance!\n. ",
    "photoshovel": "Will try and connect with @jordan-brough to see how supporting other payment sources might look in the future.\nI'll create a new pull request with squashed commits against Solidus master branch.  We needed the functionality now, so will just use our fork of 1.3.  Set email address in GitHub client to try and connect commits to my GitHub account.\nDon't know enough about Solidus yet to understand order importer vs / core models.  I had tried to write in similar style of existing API calls.  Would someone be able to direct me to similar use of core models I could use as an example?\n. Abandoning this pull request and replacing with PR 1387 against Solidus master.\n. @mamhoff  I will try and remove that merge commit.  Had a commit in there to clean-up those newlines but appears to have gotten left out/dropped when I rebased.  Will get that back in there too.\n. Bummer.  We've had this running on our own branch since last year and was hoping it would get folded-in.  For our Solidus deployment, we don't utilize the Admin/Customer web interfaces at all.  Run inside AWS Elastic Container Service within private VPC.  Solidus is just another 3rd-party API to us so we can keep our 'books' in-house.  Would be great if the API was more richly-featured.\nCreated other new API calls I've been meaning to submit, mostly around promotions/coupon-codes\u00a0to allow just-in-time creation of Customer-specific coupons, on demand, as well as for 'Brand Ambassador' promotion coupons.. Bummer.  We've had this running on our own branch since last year and was hoping it would get folded-in.  For our Solidus deployment, we don't utilize the Admin/Customer web interfaces at all.  Run inside AWS Elastic Container Service within private VPC.  Solidus is just another 3rd-party API to us so we can keep our 'books' in-house.  Would be great if the API was more richly-featured.\nCreated other new API calls I've been meaning to submit, mostly around promotions/coupon-codes\u00a0to allow just-in-time creation of Customer-specific coupons, on demand, as well as for 'Brand Ambassador' promotion coupons.. ",
    "gevann": "Simple approach used, and specs removed.\n. @jhawthorn I've made those requested changes. @tvdeyen Implemented your suggestions on the extension. Thanks for the feedback, you two!\n. @mamhoff no problem, I'll take care of that as you and @tvdeyen have suggested. Thanks for the feedback.\n. @tvdeyen @mamhoff, spoke with @cbrunsdon, he says to keep the tests despite the hard-coding.\n. I believe this is closed by https://github.com/solidusio/solidus/pull/2582. Requested changes have been made, thanks!. Suggested changes have been made, thanks!. Requested changes have been made, thanks :smile: . I've addressed @kennyadsl concern, enabling stores that wish to do this to easily configure whether or not they build shipments based upon an order without having to decorate any spree classes.. Requested changes have been made, thanks!. @kennyadsl I believe your changes have been addressed.. No. Work on this was stopped when it was originally approved.. Requested changes made, thanks!. Yes I did.. I see your point. I've removed the default user constant in this PR - what do you think about rather than using creator=nil that  we use creator=<user> where <user> is the 'spree@example.com' user it used to be? That way nobody who wants the current behaviour will have to change anything but we can still remove that constant and stop depending on it?. I'll make that change, thanks!\n. I have run this locally and it passes for me with the same seed, with DB=postgres. Does anybody have any ideas of what I can poke in to here to replicate? Does this fail or pass for any of you?. Ah I didn't realize that, thanks John! Will fix.. Fixed. Thanks for the feedback!. @kennyadsl you are correct, thanks!. Will do\n. \ud83d\udc4d  added back in\n. yup - sorry - fixed\n. agreed - will change\n. sounds good, I'll add that scope\n. In the existing core/spec/models/spree/payment_method_spec.rb file's describe .available specs, there are four payment methods created, with display_on values of 'front_end', 'back_end', 'both', and nil.\nThe existing functionality filters with (p.display_on == display_on.to_s || p.display_on.blank?). This behaviour of .blank? makes the live above (and the three value logic) necessary; the existing specs assert that there are two methods available for both. This should mean that there would be three each available for frontend and backend, as there are two for both and one each for those particular locations, however the specs show that this is not the case.\n. I agree. Originally it was meant to be default: true and avoid tri-value logic, however the edge case of nil valued display_ons make tri-value logic necessary.\n. I think a new folder would be clearest -- I didn't want to add one myself as I'm new to Solidus, so I just chose a place where I found other shared examples being defined currently.\n. Resolved.. Resolved.. Resolved.. Resolved.. Resolved.. Resolved.. Changes made, thanks!. I thought it would be simpler to leave it in the same before and after blocks where the rest of the setup and teardown were taking place. I can move it out to a let! if that's preferred.. ",
    "tibastral": "Ok understood. But if we want to improve one part (say the graphic design of the backend), wouldn't it easier if everything was separated in different repos ?\n. Imagine I want to fork the frontend gem, but I don\u2019t want to fork everything else. Would be easier if the gem was separate.\n. Ok. Let's say it another way (BTW thank you for taking the time to answer to me).\nI want to change the frontend, but to stay mainstream with the other parts of solidus (especially the core).\nPossibly my pull requests will change a lot of things, so you won't be able to merge them.\nImagine we are in the gems world where the frontend gem is different from the core gem. And you update the core gem. If I want to update my frontend gem in order to make it work with the new core, I just have to put the new version inside the gemspec of the frontend gem and make the frontend tests pass and that's it.\nRight now if I want to change the frontend part, and someone update the core, I will always have to rebase or merge it inside my branch and possibly I'll have a ton of modifications inside the frontend I don't want, but I won't be able to rely on the gems versioning.\n. Thanks for the explanation, will try it this way :)\n. ",
    "andreylyand": "I was using Windows, I have installed Ubuntu, set the app up again, and now everything works!\n. ",
    "aitbw": "Hello there @ericsaupe, tried to reproduce this issue, but no success with the current master revision (7665973)\nCan you confirm if this issue is still occuring? If so, could you provide more details so I can have a further look on it?. I think this can be closed as per #1553, can you confirm this @kennyadsl ?. As per #1590, this one's fixed @kennyadsl :tada:. Working on it!. Another one that's fixed @kennyadsl . I think this one can be closed as per #2041, right @kennyadsl?. Unable to reproduce on master with rev. 3e43b22. This seems fixed via #2187, @kennyadsl . Fixed via #2862, @kennyadsl . Fixed via #2112. I think this can be safely closed :tada: . Fixed via #2682 and #2862, @kennyadsl . Closing via #2711. I think the easiest solution for that would be to create sample price data for the most traded currencies in the world (see this) and add documentation explaining why products don't show up with certain currencies to avoid confusion between newcomers, @kennyadsl. WDYT?. I think this is the same as #2856 and it was fixed via #3044. Hey @jacobherrington, can you elaborate further on this? With current master, I'm able to change the start date of a promotion after it was created.. I'll have a look at this one :smile_cat: . As today (02/25/2019), this issue is still present, although partially, in master @ 7665973\nBy partially, I mean:\n\nItem does get canceled\nThe payment balance gets updated accordingly, as the order says credit is owed to the client\nAs @gerritwessels previously mentioned, Spree::InventoryUnit does transition its state to canceled\n. I'll have a look at this one :). :thinking: but you can skip CI builds by adding [ci skip] to the commit message, here's more information about it. Noted @kennyadsl :ok_hand: let me have a look on that. As a workaround, you can do bundle exec rake sandbox and it will seed the DB without errors. It looks like the problem occurs when you want to use MySQL or PostgreSQL.. @jacobherrington :thinking: that's weird, I've created ~4 sandboxes with SQLite without any issues.. ## Update (12/06/2018)\n\nThis issue also arises when using MySQL as DB, but it happens more frequently with PostgreSQL. I haven't been able to reproduce this problem with SQLite.. > I think that might be an implementation detail best left up to the stores themselves\n+1, I think the same\n\nWhat do you think is the best UX?\n\nBased on the work done in #2960 and #2977, the obvious choice would be to disable said input when the Track inventory levels and Propagate all variants flags are disabled. Nevertheless, if you're not tracking inventory levels (let's say you have a store that only sells digital products), I don't see why you'd need more than one stock location.. @kennyadsl, I meant maybe we could do something like this, but I'm more fond of the first option.. Done @jacobherrington! . Closing via #2992. Superseeded by solidusio-contrib/solidus_legacy_stock_system#9. Superseeded by solidusio-contrib/solidus_legacy_stock_system#9. Superseeded by solidusio-contrib/solidus_legacy_stock_system#9. Done @kennyadsl :heavy_check_mark: I think #3079 is facing a different problem. Let me have a look at it.. Let me have a look at this.. Hey @fkoessler, thanks a lot for reporting this issue! I tried to reproduce it on my machine but I wasn't able to do so. Could you provide a spec for this so I can take a further look?. Great work as usual, @tvdeyen ! Just one question:\nOn Payment capture, on the after screen \u2014the icon in the middle shouldn't be a blue check mark? Same as Payment save, on the after screen.. Hi @kinduff, thanks a lot for PR. I have a few improvements / questions on this:\n\n\nI think the Dockerfile is still missing some essential packages, such as postgresql-client and imagemagick \u2014I think we should add them in order to provide a seamless Docker experience\n\n\nI'm no Docker expert, but I think we should be using docker compose to handle database responsabilities. What do you think?\n\n\nDoes this work without any extra configuration on Solidus?\n\n\nThe last time I worked with Docker, when we ran the commands to build the container, Docker did not respect the files' ownership \u2014this means we had to use sudo for every command every time we were not using Docker, which was very annoying. Is this the case here? If so, can we think of a solution?\n\n\nDoes the full spec suite runs green without any extra configuration? I remember the --no-sandbox flag had to be included to the Headless Chrome setup under Docker containers.\n\n\nLet me know what you think! :hugs:. Hey @kinduff, thanks for the answers! Just one question:\n\nimagemagick is already installed. I'm not sure about postgresql-client since by default sandbox environment is using sqlite, so for a demo purposes it works well.\n\nAre you sure about this? Because on the last project I worked on, we had to install imagemagick when building the container.. Closed via #3112 . I'll be having a look at this one.\nUPDATE: Hey @doke, just took a look at this issue and I can't reproduce it. Can you provide us with more details? Thanks!. I think this is a duplicate of #3135?. Hi @edmunteanu, thanks for reporting this issue! Unfortunately, I've been unable to reproduce this bug so far, both with master and v2.6.3\nI do see an error though, which is:\nruby\nActiveRecord::RecordNotFound in Spree::Admin::ImagesController#index\ncan't find record with friendly id: \"some-id\"\nIf you can provide us with some extra details (i.e.: configuration, extensions in use), that'd be great! :raised_hands: . You mean something like #{Spree::Shipment.table_name}.shipped_at, right? That would help in case we were to change the table's name, is that correct?. Sounds reasonable, I'll push a new commit for it :smile_cat: . Hey @jacobherrington, thanks for your comments! I'll address them in a few. Just one question:\nYou mean a better message would include something like Spree::Api::CouponCodesController#create?. Yeah, completely! I'll fix that too :ok_hand:. Resolved via 4559a00. Resolved via 4559a00. Resolved via 4559a00. Yes, it fails unless we assign the user to the order, as you proposed. Both options are completely valid.. Now that #2958 is merged, you can use click_button \"Apply Code\" to take advantage of the new endpoints and avoid deprecation warnings :tada:. Same as the previous comment. @kennyadsl @jacobherrington I've been trying to implement this extension-level, but so far it is not working :-( I'll let you know if I come up with a more clean solution. See solidusio-contrib/solidus_legacy_stock_system#9. Why are we creating a new variable in here? Can't we use images directly?. I can understand the reasoning to create a new variable in here but I think the name is too generic and can cause confusion with the images variable, something like master_image might be better. WDYT?. Can you change responses for responds? Thanks!. Perfect! :+1:. I think we could remove the comma from here, WDYT?. A quote is missing at the end of this line.. I think you can remove lines 199, 201, 202, and replace it with accept_confirm { Please select the split destination. }. Under core/app/models/spree/image/paperclip_attachment.rb, we have %w(image/jpeg image/jpg image/png image/gif) \u2014I think, for consistency, we should use the same syntax in here too. sorterd -> sorted. sorterd -> sorted. Should be worded as active stock locations.. Shouldn't it be suffix instead of postfix?. It's not entirely clear why item won't receive #do_something but will receive #do_something_else. Can you elaborate further on this, @spaghetticode?. Typo: reimbusement for reimbursement. I'm assuming @ericsaupe took inspiration from the message above. I think we could fix both in this PR.. They should; I checked the generated SQL on the sandbox and the output was the same for both calls, but somehow, the result is not the same. (at least, not in this scenario.)\nI will investigate further to understand what's going on here.. @kennyadsl I added this:\nruby\nputs store.shipping_method_ids.inspect\nto the scope and found that store.shipping_method_ids is returning just one shipping method ID, whereas store.shipping_methods.ids is returning all the IDs for the shipping methods associated to the store.\nCan't understand why this is happening, as the generated SQL is exactly the same for both, and some unit tests I created for this work as expected with either. Maybe there's a bug present in Rails (as mentioned first by @afdev82 in here) or something else we're missing out.. One small question: is this going to render as it is on the guides? If so, is there a way we can collapse it?. Yeah sure, let me have a further look at it. From what I can understand from @memotoro's comment and the proposed patch is that, OrderDisplay works only to create orders without any further actions, whereas OrderManagement allows full control over them. Since we're only talking about backend, this feels reasonable.\nAs @tvdeyen said on his comment below, if you can create an order, you probably should be able to update it as well.. ",
    "vladstoick": "I have updated adjustments_helper.rb which fixed all specs\n. @jordan-brough I've added a spree_promotion_codes.promotion_code_batch_id field and also a download button so you can download codes for a single batch\n. @jordan-brough I've added a spree_promotion_codes.promotion_code_batch_id field and also a download button so you can download codes for a single batch\n. @cbrunsdon, @tvdeyen: I think I went over everything you mentioned\n- Use #.t everywhere + updated en.yml file\n- Fix mail specs: I am now using email = ActionMailer::Base.deliveries.last to check that the email has the correct details.\n- download route now has a default format of csv\n- Fixed various where too many things were specs stubbed\n- I've moved the #status method in the view as it felt that even if we were returning a :symbol we were still doing all those checks in the view to use the correct translations. I can move it back / to a helper if the logic seems too complicated for the view\nCan you have a look over this again when you have time?\n. @tvdeyen, @cbrunsdon did you have a chance to look over this again?\n. I am adding a comment here as some changes are now outdated\n@tvdeyen:\nRegarding: send_file:\nI just used what was used in promotion_codes_controller. However, is it possible to use send_file for this? I was able to use send_data and render_to_string.\nEmail body & URLs:\nI have moved the body to individual erb files but I have noticed there's no default action_mailer.default_url_options so I can't generate URLs (I could add that in the spec but then by default the sandbox would have errors). I have added the promotion name in the meanwhile.\n@cbrunsdon, @jordan-brough I think I covered all of your concerns. I have added a new column state \nI have left all my commit history - easier to see changes this way. @cbrunsdon, @tvdeyen, @jordan-brough: Is this still being consider or should I close this PR?. I will start working on this. @mtylty I think this one might be easier if just one person works on it so I can let you work on it if you already started working. I've added the readonly check thinking it was just some special case, not knowing about the immutability part since our store is still on 1.0. However, if we remove it all specs pass except this one which doesn't seem related at all. Putting in the merge function doesn't seem explicit it at all, and the validation still runs when creating the new address.\n1) Spree::CheckoutController#update fails to transition to complete from confirm when the country is not a shippable country due to no available shipping rates for any of the shipments\n     Failure/Error: order.update_attributes(state: 'confirm')\n     ActiveRecord::ReadOnlyRecord:\n       Spree::Address is marked as readonly\n     # ./spec/controllers/spree/checkout_controller_spec.rb:358:in `block (5 levels) in <top (required)>'\n``` which doesn't seem related at all.\n. Yeah, that's true. Doing a reload after save! should be enough right?\n. https://github.com/solidusio/solidus/pull/1524#discussion_r83457606\n. Done :)\n. Changed it \ud83d\udc4d . ",
    "frankie-loves-jesus": "Can't you just provide context by making comments and properly sectioning your translation files? And like the guys mentioned, being more specific. Personally I gave up on scopes a long time ago. Didn't like the extra weight.\n. Wouldn't it be better if we switched to https://github.com/selectize/selectize.js altogether?. That's the problem with Bootstrap in general, it messes up your markup with unnecessary classes and grid divisions. Don't get me wrong -- grids are good where they're really needed, like in architecture and graphic design, but not in HTML and CSS where semantic markup and media queries can do the job just as easily.\nIf container-fluid is not actually a Bootstrap class, well at least I hope you got my point :-)\n. ",
    "BravoSimone": "Working on it! \ud83d\udc4d . I've made a dump right after the migration, and after the reset.\nI'm adding the \"after migration dump\" marked on what to me should be added and what not.\n```\nNEED TO ADD\nSpree::ShippingCategory.create!([\n  {name: \"Default\"}\n])\nNEED TO ADD\nSpree::StockLocation.create!([\n  {name: \"default\", default: false, address1: nil, address2: nil, city: nil, state_id: nil, state_name: nil, country_id: nil, zipcode: nil, phone: nil, active: true, backorderable_default: true, propagate_all_variants: true, admin_name: nil, position: 0, restock_inventory: true, fulfillable: true, code: nil, check_stock_on_transfer: true}\n])\nTHIS DIFFERS\nSpree::Store.create!([\n  {name: \"Sample Store\", url: \"example.com\", meta_description: nil, meta_keywords: nil, seo_title: nil, mail_from_address: \"store@example.com\", default_currency: nil, code: \"spree\", default: true, cart_tax_country_iso: nil}\n])\nIN THIS WAY\nSpree::Store.create!([\n{name: \"Spree Demo Site\", url: \"demo.spreecommerce.com\", meta_description: nil, meta_keywords: nil, seo_title: nil, mail_from_address: \"spree@example.com\", default_currency: nil, code: \"spree\", default: true, cart_tax_country_iso: \"US\"}\n])\nGENERATED IN SEEDS TOO\nSpree::ReturnReason.create!([\n  {name: \"Accidental order\", active: true, mutable: true},\n  {name: \"Better price available\", active: true, mutable: true},\n  {name: \"Damaged/Defective\", active: true, mutable: true},\n  {name: \"Different from description\", active: true, mutable: true},\n  {name: \"Different from what was ordered\", active: true, mutable: true},\n  {name: \"Missed estimated delivery date\", active: true, mutable: true},\n  {name: \"Missing parts or accessories\", active: true, mutable: true},\n  {name: \"No longer needed/wanted\", active: true, mutable: true},\n  {name: \"Unauthorized purchase\", active: true, mutable: true}\n])\nNEED TO ADD\nSpree::RefundReason.create!([\n  {name: \"Return processing\", active: true, mutable: false, code: nil}\n])\n\"original\" IS ADDED IN MIGRATION\nSpree::ReimbursementType.create!([\n  {name: \"original\", active: true, mutable: true, type: \"Spree::ReimbursementType::OriginalPayment\"},\n  {name: \"Store Credit\", active: true, mutable: true, type: \"Spree::ReimbursementType::StoreCredit\"}\n])\nAFTER RESET \"Gift Card\" IS ADDED\nSpree::StoreCreditCategory.create!([\n  {name: \"Default\"}\n])\nNOT NEEDED\nSpree::StoreCreditType.create!([\n  {name: \"Expiring\", priority: 1},\n  {name: \"Non-expiring\", priority: 2}\n])\nNOT NEEDED\nSpree::StoreCreditUpdateReason.create!([\n  {name: \"Credit Given In Error\"}\n])\nNOT NEEDED\nSpree::PaymentMethod.create!([\n  {type: \"Spree::PaymentMethod::StoreCredit\", name: \"Store Credit\", description: \"Store Credit\", active: true, deleted_at: nil, auto_capture: nil, preferences: {}, preference_source: nil, position: 0, available_to_users: false, available_to_admin: false}\n])\n``\nWhat do you think about it?.seed.rbrequires every file intodb/default/recursively so each timerake db:seed` is used it will also load this data. Hi, I really want to take care of this issue but I can't understand the first step to reproduce the bug, can you provide more detailed instructions?. ",
    "useiichi": "thanks for.\nI'm going to open an issue in solidus_i18n.\n. ",
    "chrisradford": "We're tracking slightly behind master, but we can pull that into our branch. Thanks!\n. Can remove reusable? since all payment sources in the wallet are reusable. Move this to start of method with:\nreturn if user.order.nil?. Change to a return if wallet_payment_source.nil?. ruby\ndef default_wallet_payment_source. Ah, thanks!. ",
    "dgra": "@flyfy1 Hi, thank you for looking into this. I was not using the create_quantity_adjustments action. I believe I was using the create_item_adjustments action when I ran into this problem.. @flyfy1 I had time to dig back into the problem I was facing. It turns out our frontend code was using the apply_coupon_code api call https://github.com/solidusio/solidus/blob/v1.4/api/app/controllers/spree/api/orders_controller.rb#L81-L91 to apply the coupons which doesn't cause a reload_totals as far as I can tell. This was causing our in-memory order to be out of sync. So my problem doesn't appear to be a solidus issue anymore. I appreciate you taking a look and helping to narrow my focus on this.. @jhawthorn @cbrunsdon I just wanted to checkup on the state of this PR. Thank you guys.. @jhawthorn @cbrunsdon Is there any update on this PR?. @gmacdougall No problem and thank you for looking at this. I knew it had a few db calls but I should have done a better job of reducing those. Thank you again for looking at this and reducing those calls. . @gmacdougall You are right. I removed that method and I will rebase these commits into a single commit if/when this gets approved or when prompted to. . Thank you so much for providing feedback on this!. @gmacdougall Just checking up on the status of this PR. Any update?. I can take this.. @cbrunsdon I will change that, my original thinking for the other way was to save database calls but it only saves us one db call. Thank you for your feedback.. Good eye. Changing now. Thanks.. Good point. I will reduce the scope. Thank you!. ",
    "chukitow": "I updated the method using the name that you suggested @jhawthorn :)\n. Hey @jhawthorn is there anything else that you want me to do for this PR? :)\n. I updated the PR using the new rails 5 methods instead of the raw query @jhawthorn \n. I already did the change that you requested @mamhoff \ud83d\ude2c \n. I just rebased but not sure why there are some errors in the tests \ud83e\udd14 \n. Looks like conflicts where resolved @jacobeubanks . You are right, I thought this was going to be my first PR without comments hahaha, I'll change it ASAP\n. ",
    "bofrede": "The iOS problem is finally about to go away.\nhttps://webkit.org/blog/7093/release-notes-for-safari-technology-preview-19/. ## Without this fix, the taxon menu looks like this\n Cars\n Ferrari\n Lotus\n Mercedes\n Boats\n Regal\n* Wellcraft\nWith this fix, the taxon menu looks like this\n\nCars\nFerrari\nLotus\nMercedes\nBoats\nRegal\nWellcraft\n\n. Now simplified and squashed as per @kennyadsl's request.. I agree it can be simplified a little.\nHowever &.current is a too specific selector.. ",
    "rsiddle": "@jrochkind That's correct. Google treats URLs separately based on their underlying character code (the original source link I posted shows the examples, with them mentioning the 200 status response). The following URLs may seem the same, but they are evaluated differently:\n- http://example.com/test\n- http://example.com/Test\n- http://example.com/TEST\n- http://example.com/test/\n- http://www.example.com/test\n- https://example.com/test\n- https://www.example.com/test\nIt's best to use the non-trailing slash consistently\n. @kennyads The canonical tag is an indicator to show which page your want Google to rank. At the moment, the internal links are all pointing to the non-trailing slash, which is a very strong indicator that it's the correct URL. The product index page then has a canonical tag which states that another URL is the desired URL (with trailing slash). By removing the trailing slash from the canonical tag, we're telling Google that we want to use the desired (non-trailing slash) version.\n. @mamhoff Updated to include correct price.. ",
    "evil-c": "Hi @CallMeSH, \nCurious if you found a workaround/solution to this yet.  I've run into the same issue.\nThanks.\n. ",
    "Rob117": "Is this not getting merged? If so, can we close it?\nIt looks useful, but leaving it open in the branches without comment for a month doesn't seem to be doing it justice.. ",
    "Shigawire": "@skukx I am sorry for necromanting this old issue Issue, but I do have the same problem here. Some of our products have a deposit fee that will be returned once the customer returns the used product to the store. Think of the product as for example the cartridge of a gas grill.\nThe deposit is not taxable, but a fixed amount per product. To my understanding, a custom Adjustment would be the way to go here, or am I mistaken?. ",
    "masterkain": "This doesn't seem to keep track of quantities. Originally I tested with another setup.\n3 variants, sizes: S M L\n3 stock locations: A B C\neach stock location has x1 on hand of each variant, so stock location A has 1 on hand of size S, 1 on hand of M and one on hand L.\nbackorderable is false.\nadd 3xS, 1xM and 1xL to the cart, proceed to checkout, you'll get a Was only able to package 3 inventory units of 5 requested\nThe problem seems to lie in the Spree::Stock::Adjuster class or the caller, which removes the packages' contents without keeping an eye on the requested quantity. In the example above I expected to find 3 packages:\n- from stock location A: 1xS, 1xM, 1xL\n- from stock location B: 1xS\n- from stock location C: 1xS\ninstead we get:\n- from stock location A: 1xS, 1xM, 1xL\nand when this single survived package goes to meet the new package validation method, it explodes due to different count.\nhttps://github.com/solidusio/solidus/pull/566/files#diff-f745e7e3f9127a9402e212724d8e66f3R181\n. this seems to work for me https://github.com/nebulab/solidus/commit/4f2f5ee9d15af9996ce1f0fb47157da7443c0299 you might want to consider. ",
    "bosskovic": "@jhawthorn you are right, we are using an older version of solidus (1.3.1) and the user picker does seem to work in a fresh solidus app updated to the most recent version.\nWe rely on a number of forks of solidus gems and can not quickly update solidus in our app, but I expect that when we do, the problem will be gone there as well. I will close this request now.. ",
    "laurawadden": "on it :). working on it. @mamhoff mentioned that you actually should be able to delete the master price.\nHowever, it is a bug that when you go back to \"product details\", the master price is still shown (even though it's already deleted). Expected behaviour should be that the field should be blank.. 'Product Stock' doesn't make sense either because the page just says 'Stock Item Not Found'. hiding that tab, too.. Thanks for the comments/feedback.\nI don't think it's worth adding the redirects in the controller unless you come across the problem (in real life) at some point in the future. This is really a small, dark, unvisited corner of the application.\n@mamhoff As for looking more into the soft-deleted variants and prices (and why they aren't just there?), I think that's a good idea for the future.. Found this bug while working on #1861 . ",
    "fschwahn": "good point @tvdeyen - I think this is not an issue because of the structure of the routes (as you mention), but I have only a very superficial knowledge of the solidus/solidus_i18n codebase.. Yes. Some more information:\nThis only happens when building a new product model, the validations are then run twice because of association autosave. There is already a spec in place (https://github.com/solidusio/solidus/blob/b7ca586099d7dec60c37fb69801dc55c5b7e34bf/core/spec/models/spree/variant_spec.rb#L73) which checks that the correct number of prices are added which doesn't trigger this behaviour because it operates on already saved products / variants. I can submit a PR which modifies this spec to showcase this problem.. @mamhoff thanks for your feedback,\nI think the second route you outlined is probably the solution which is more correct, I'll try to put something together.\nAs for the spec, this error only happens when the product itself has not been saved yet (ie. only when the variant is saved along with the product). The 8 prices come from 4 master prices, 4 new_variant prices which are created when the product & variant are created. I'll try to make the spec clearer.. Squashed & provided a commit message with some context.. Makes sense, thanks for the heads up.. Cool! I searched the issue tracker for this, but apparently not well enough \ud83d\ude1e . ",
    "fylooi": "@flyfy1 \nYes, that would be the case if the constants were all in one file.\nIn this case, it calls my preexisting Product model. Suspect Rails autoloading might have something to do with it. Specifying the namespace results in correct behaviour and aligns with the rest of the code.\n. Hmm. Moved past that code and can't dig up the point of reproduction. I'll reopen this PR if I can get a handle on it. . @flyfy1 \nThe problem is actually a combination of Rails autoloading and development code reloading. Have experienced a couple of other model name conflicts but still unable to reproduce this in a test app. Disabling Spring and setting config.eager_load = true in development appears to prevent these conflicts, with a slightly degraded dev experience.\nEnsuring that all models in controllers are consistently invoked with the Spree:: namespace should solve this. The current code is a mix of namespaced and non-namespaced model calls. \nIf you guys are okay with this, I can do the changes and update this PR.\n. Updated the PR to cover all model invocations in controllers and models.. Managed to reproduce one case. Documenting the steps for reference. \nThis is as of v1.4.\nAssuming you have a Country model defined in your host application:\n1. Add a reference to Country in an around_action in ApplicationController. yield after calling a method on Country\n2. Visit CustomerDetailsController#edit\n```\n      def edit\n          country_id = Country.default.id\n          @order.build_bill_address(country_id: country_id) if @order.bill_address.nil?\n          @order.build_ship_address(country_id: country_id) if @order.ship_address.nil?\n      @order.bill_address.country_id = country_id if @order.bill_address.country.nil?\n      @order.ship_address.country_id = country_id if @order.ship_address.country.nil?\n    end\n\n```\nThe Country.default.id call will call the host Country class, and will fail if the host class doesn't have default defined.. @jhawthorn \nJust spent a few hours trying to figure out why my automatic free shipping promotion was failing sporadically. Finally traced it to one product with promotionable=false. Would love to have this as an option. \n. Just upgraded to 2.2.1, seeing this as well. . @jordan-brough \nThanks for the review. Have applied the requested changes, merged your PR and rebased master. . This is a very extensible approach, but I feel that care needs to be taken to maintain accessibility for Solidus beginners and/or stores which don't need to do much customization. \nMy experience replacing the Order mailers with a Mailchimp service call as a first time Solidus user: \n- Figuring out where the mailer gets triggered was a challenge. \n- Had to follow the order flow through solidus_frontend into solidus_core through Order and Checkout. \n- Monkey patchedSpree::OrderMailer.confirm_emailusing anOrderMailerDecorator`. \nWith this approach, I would need to understand the event bus design pattern & implementation in addition to Solidus's core modeling and checkout structure. Some documentation in the code would go a long way. \n. My bad, copied that as I wasn't familiar with the factories. Also needs to be a let!.. ",
    "oniram88": "That was more a proof of concept as a pr. What do you mean with PORO? It's better to make a class eval like in spree/order/*.rb??\nOr it's better to expose a complete new class that encapsulate all the validation logic with delegation from-to order class?\nI will make validation as soon as we have more stable solution.. as proposed by @mamhoff , I changed into a PORO version. It is not yet complete by tests, but first I wanted to be sure that this was the direction to take.\nI picked up the pieces of @mamhoff  and composed by several small fixes.\nI hope that at least the yard documentation is OK, it's my first pull-request for a project of this level, and I have yet to engage the correct methodology. yes, it's a typo!! thanks. ",
    "rainhead": "All right. If there's any way to make this clearer, it'd be appreciated. It confused us.. ",
    "dankmitchell": "+1 for this. Caused my new store a big head ache :-/. This is high priority issue IMO. I hope it can be resolved soon \ud83d\udc4d \nJust to reiterate, at present if you have a free shipping promo set up then all orders are getting Free Shipping regardless of their value . This is high priority issue IMO. I hope it can be resolved soon \ud83d\udc4d \nJust to reiterate, at present if you have a free shipping promo set up then all orders are getting Free Shipping regardless of their value . I now realise there is a more recent and up to date PR https://github.com/solidusio/solidus/pull/2187 so fingers crossed it goes into the next release or as a patch for 2.3. I now realise there is a more recent and up to date PR https://github.com/solidusio/solidus/pull/2187 so fingers crossed it goes into the next release or as a patch for 2.3. Can this move forward now?. Thanks for the update @elia! @peterberkenbosch and I are using this branch for a new project so we might be able to help.... It\u2019s worth nothing that whilst it appears we have a choice right now, Webpack will be the default for compiling JS in Rails 6 - https://github.com/rails/rails/pull/33079. ",
    "dvassev": "@mtomov Thank you very much for this. I didn't notice that we you guys were using verb first and it makes a ton of sense. . @jhawthorn Thank you for the suggestions. . It is definitely more readable and more accessible even for people coming from other languages.   . ",
    "did": "hey @mtomov, thanks for the quick reply. In dev, I get the same odd behaviour with both a request from curl and an AJAX request from the browser. The logs look the same compared to a simple GET request from the browser, except that it takes way more time to render some partials (it's totally random, not always the same) with an AJAX/curl request.\nI wonder if other developers noticed that behaviour, especially when Solidus is used with Turbolinks in development.\nHowever, in production, the rendering times are the same.. hey @jhawthorn, good catch man, you nailed it! thanks!. ",
    "justinstander": "undefined method `remove' for #. ",
    "sechix": "Thanks a los mamhoff. One more question, do you know if there are any solidus marketplace ? The one that is here do not exist in gem.. Hello, I have the same problem, how did you fix it?. ok, I know but It was to update the gems. So I guess that I have to change the gems code. `source 'https://rubygems.org'\nruby ENV['CUSTOM_RUBY_VERSION'] || '2.3.1'\ngem 'rails', '~> 5.0.0', '>= 5.0.0.1'\ngem 'pg', '~> 0.18'\ngem 'puma', '~> 3.0'\ngem 'sass-rails', '~> 5.0'\ngem 'uglifier', '>= 1.3.0'\ngem 'coffee-rails', '~> 4.2'\ngem 'jquery-rails' , github: 'rails/jquery-rails'\ngem 'turbolinks', '~> 5'\ngroup :development, :test do\n  gem 'byebug', platform: :mri\nend\ngroup :development do\n  gem 'web-console'\n  gem 'listen', '~> 3.0.5'\ngem 'spring'\n  gem 'spring-watcher-listen', '~> 2.0.0'\nend\ngem 'tzinfo-data', platforms: [:mingw, :mswin, :x64_mingw, :jruby]\ngem 'solidus', github: 'solidusio/solidus'\ngem 'solidus_auth_devise'\ngroup :development, :test do\n  gem 'rspec-rails', '~> 3.5'\nend\ngem 'coffee-script-source', '~> 1.12', '>= 1.12.2'\ngem 'paperclip'\ngem 'aws-sdk', '~> 2.6', '>= 2.6.48'\ngem 'solidus_paypal_braintree', github: 'solidusio/solidus_paypal_braintree'\ngem \"solidus_signifyd\"\ngem 'solidus_i18n', github: 'solidusio-contrib/solidus_i18n', branch: 'master'\ngem 'solidus_social' , github: 'solidusio-contrib/solidus_social'\ngem 'solidus_related_products'\ngem 'solidus_editor', github: 'solidusio-contrib/solidus_editor', branch: 'master'\ngem 'solidus_print_invoice' , github: 'solidusio-contrib/solidus_print_invoice'\ngem \"solidus_comments\"\ngem 'solidus_product_feed'\ngem 'solidus_papertrail'\ngem 'solidus_log_viewer', github: 'solidusio-contrib/solidus_log_viewer'\ngem 'solidus_sitemap', github: 'solidusio-contrib/solidus_sitemap', branch: 'master'\ngem 'solidus_static_content', github: 'solidusio-contrib/solidus_static_content'\ngem \"bootstrap-sass\"\ngem 'solidus_reviews', github: 'solidusio-contrib/solidus_reviews'\ngem \"solidus_legacy_return_authorizations\"\ngem 'solidus_prototypes', github: 'solidusio-contrib/solidus_prototypes', branch: 'master'\ngem 'solidus_geocoding'\ngem 'spree_marketplace', github: 'sechix/spree_marketplace'\ngem 'spree_drop_ship', github: 'sechix/spree_drop_ship'\ngem 'solidus_user_prices', github: 'resolve/solidus_user_prices'\ngem 'solidus_user_roles', github: 'boomerdigital/solidus_user_roles'\ngem 'solidus_contact_us', :git => 'https://github.com/2beDigital/solidus_contact_us'\ngem 'dotenv-rails', :require => 'dotenv/rails-now'\ngem \"recaptcha\", require: \"recaptcha/rails\"\ngem 'solidus_wishlist', github: 'deseretbook/solidus_wishlist'\ngem 'solidus_recommendations', github: 'skukx/solidus_recommendations'\ngem 'solidus_editor', github: 'solidusio-contrib/solidus_editor', branch: 'master'\ngem 'solidus_import_products', github: '2BeDigital/solidus_import_products'\ngem 'delayed_job_active_record'\ngem 'delayed_job'\ngem 'solidus_gateway' , github: 'solidusio/solidus_gateway'\ngem 'solidus_product_feed'\ngem 'spree_barcodes', github: 'recmode/spree_barcodes', branch: 'master'\ngem 'alchemy_cms', github: 'AlchemyCMS/alchemy_cms', branch: 'rails-5'\ngem 'alchemy-solidus', github: 'sechix/alchemy-solidus', branch: 'master'\ngem 'solidus_cmd'\ngem 'solidus_minicart', :git => 'https://github.com/2beDigital/solidus_minicart', branch: 'master'\ngem 'solidus_subscriptions', github: 'solidusio-contrib/solidus_subscriptions', branch: 'master'\ngem 'whenever', :require => false\ngem 'blockuijs-rails',  :git => 'https://github.com/BoTreeConsultingTeam/blockuijs-rails.git'\ngem 'blot'\ngem 'solidus_product_recommendations', github: 'sechix/solidus_product_recommendations', branch: 'master'\ngem 'solidus_account_recurring', github: 'sechix/solidus_account_recurring' , branch: 'master'\ngem 'stripe'\ngem 'solidus_trackers', github: 'solidusio-contrib/solidus_trackers', branch: 'master'\ngem 'spree_scan_and_go', github: 'reinaris/spree_scan_and_go'\ngem 'solidus_active_shipping', :git => \"git://github.com/solidusio-contrib/solidus_active_shipping\"\ngem 'solidus_product_labeling', github: 'sechix/solidus_product_labeling' , branch: 'master'\ngem 'solidus_smart_free_shipping', github: 'sechix/solidus_smart_free_shipping', branch: 'master'\ngem 'spree-point-of-sale', github: 'sechix/spree-point-of-sale' , branch: 'master'\ngem 'solidus_waiting_list', github: 'sechix/solidus_waiting_list'\ngem 'spree_report_products_ran_out_of_stock', github: 'sechix/spree_report_products_ran_out_of_stock'\ngem 'solidus_special_offer', github: 'samanmohamadi/solidus_special_offer' , branch: 'master'\ngem 'spree_recently_sold_products', github: 'sechix/spree_recently_sold_products' . Hi, now i solved this error but now get :/app/app/controllers/users_controller.rb:2:in <top (required)>': uninitialized constant User (NameError)\nI have follow steps to deploy perfectly doing also migrations and seed. I don't know why i get this error if app works in localhost.. It's solved!!!!. I upload images ok, \n\n but if refresh page don't display nothing:\n\nIn frontend also:\n\nMy app works ok in localhost. The problem it's in production heroku and aws s3. Images are uploaded to aws s3, but I don't know whats happen. This Is standard  code, I don't change nothing in images and product images.\nThese are my images in aws s3:\n\nI have this gem 'aws-sdk', '~> 2.6', '>= 2.6.48'  because solidus 2.2 don't accept lower version of this gem.. This is heroku logs  refreshing page after upload an image in admin ok. In fact the images appears in mu aws s3 bucket:\nSELECT  1 AS one FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_id\" = $1 AND \"spree_assets\".\"viewable_type\" = $2 AND \"spree_assets\".\"type\" IN ('Spree::Image') LIMIT $3  [[\"viewable_id\", 41], [\"viewable_type\", \"Spree::Variant\"], [\"LIMIT\", 1]]\n2017-04-28T20:22:46.528506+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Spree::Image Exists (1.5ms)  SELECT  1 AS one FROM \"spree_assets\" INNER JOIN \"spree_variants\" ON \"spree_assets\".\"viewable_id\" = \"spree_variants\".\"id\" WHERE \"spree_variants\".\"deleted_at\" IS NULL AND \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_variants\".\"product_id\" = $1 AND \"spree_assets\".\"viewable_type\" = $2 AND \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"type\" IN ('Spree::Image') LIMIT $3  [[\"product_id\", 23], [\"viewable_type\", \"Spree::Variant\"], [\"LIMIT\", 1]]\n2017-04-28T20:22:46.533706+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Spree::Image Load (1.6ms)  SELECT \"spree_assets\".* FROM \"spree_assets\" INNER JOIN \"spree_variants\" ON \"spree_assets\".\"viewable_id\" = \"spree_variants\".\"id\" WHERE \"spree_variants\".\"deleted_at\" IS NULL AND \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_variants\".\"product_id\" = $1 AND \"spree_assets\".\"viewable_type\" = $2 AND \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"type\" IN ('Spree::Image') ORDER BY \"spree_assets\".\"position\" ASC, \"spree_variants\".\"position\" ASC  [[\"product_id\", 23], [\"viewable_type\", \"Spree::Variant\"]]\n2017-04-28T20:22:46.581735+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered collection of vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/images/_image_row.html.erb [0 times] (0.0ms)\n2017-04-28T20:22:46.582025+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/images/index.html.erb within spree/layouts/admin (215.3ms)\n2017-04-28T20:22:46.716119+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_js_locale_data.html.erb (43.3ms)\n2017-04-28T20:22:46.716550+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_head.html.erb (93.9ms)\n2017-04-28T20:22:46.832511+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_navigation_header.html.erb (1.8ms)\n2017-04-28T20:22:46.885906+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 5 overrides found for 'spree/admin/shared/_menu'\n2017-04-28T20:22:46.887323+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 'static_content_pages_admin_tab' matched 1 times with '[data-hook='admin_tabs']'\n2017-04-28T20:22:46.887445+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: [WARNING] No :original defined for 'static_content_pages_admin_tab', you should change its definition to include:\n2017-04-28T20:22:46.887447+00:00 app[web.1]:  :original => 'b7b242ee058673679949d7e3050be5974938294d' \n2017-04-28T20:22:46.892164+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 'add_profile_admin_tabs' matched 1 times with '[data-hook='admin_tabs']'\n2017-04-28T20:22:46.892263+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: [WARNING] No :original defined for 'add_profile_admin_tabs', you should change its definition to include:\n2017-04-28T20:22:46.892265+00:00 app[web.1]:  :original => '0e4968124769d806ee2e5497a0eba1ec54e9e1c7' \n2017-04-28T20:22:46.897869+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 'converted_admin_tabs' matched 1 times with '[data-hook='admin_tabs']'\n2017-04-28T20:22:46.898002+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: [WARNING] No :original defined for 'converted_admin_tabs', you should change its definition to include:\n2017-04-28T20:22:46.898003+00:00 app[web.1]:  :original => '4858b1c3ebb6a3c21f99d4ad9b2be108c01cbdd5' \n2017-04-28T20:22:46.902996+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 'add_user_roles_menu_links' matched 1 times with '[data-hook='admin_tabs']'\n2017-04-28T20:22:46.903572+00:00 app[web.1]:  :original => '8c9746b5aad16192e4e3fa008f60db2b5f92bf86' \n2017-04-28T20:22:46.903571+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: [WARNING] No :original defined for 'add_user_roles_menu_links', you should change its definition to include:\n2017-04-28T20:22:46.908480+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 'alchemy_cms_tab' matched 1 times with '[data-hook=\"admin_tabs\"]'\n2017-04-28T20:22:46.908654+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: [WARNING] No :original defined for 'alchemy_cms_tab', you should change its definition to include:\n2017-04-28T20:22:46.908655+00:00 app[web.1]:  :original => '656a067594799663f1bd9e127fabdd910f30b9bb' \n2017-04-28T20:22:46.959838+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 'remove_overview_tab' matched 0 times with 'erb[loud]:contains('overview')'\n2017-04-28T20:22:46.957907+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 1 overrides found for 'spree/admin/shared/_tabs'\n2017-04-28T20:22:47.001411+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 3 overrides found for 'spree/admin/shared/_product_sub_menu'\n2017-04-28T20:22:47.003312+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 'add_product_relation_admin_sub_menu_tab' matched 1 times with '[data-hook=\"admin_product_sub_tabs\"]'\n2017-04-28T20:22:47.003481+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: [WARNING] No :original defined for 'add_product_relation_admin_sub_menu_tab', you should change its definition to include:\n2017-04-28T20:22:47.003483+00:00 app[web.1]:  :original => 'd1a70da8f31da0a082c6c5333d9837dcaca65c65' \n2017-04-28T20:22:47.009162+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 'reviews_admin_tab' matched 1 times with '[data-hook='admin_product_sub_tabs']'\n2017-04-28T20:22:47.009404+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: [WARNING] No :original defined for 'reviews_admin_tab', you should change its definition to include:\n2017-04-28T20:22:47.009405+00:00 app[web.1]:  :original => '28962cc89a844ec5dc4d70cd346620fd0cb5d7fd' \n2017-04-28T20:22:47.015222+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 'prototypes_product_tabs' matched 1 times with '[data-hook='admin_product_sub_tabs']'\n2017-04-28T20:22:47.015410+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: [WARNING] No :original defined for 'prototypes_product_tabs', you should change its definition to include:\n2017-04-28T20:22:47.015411+00:00 app[web.1]:  :original => '7f3178a1505da3e95702de242814fa9509d483e0' \n2017-04-28T20:22:47.037401+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_product_sub_menu.html.erb (3.9ms)\n2017-04-28T20:22:47.076989+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 2 overrides found for 'spree/admin/shared/_settings_sub_menu'\n2017-04-28T20:22:47.078833+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 'solidus_paypal_braintree_admin_navigation_configuration' matched 1 times with '[data-hook='admin_settings_sub_tabs']'\n2017-04-28T20:22:47.079024+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: [WARNING] No :original defined for 'solidus_paypal_braintree_admin_navigation_configuration', you should change its definition to include:\n2017-04-28T20:22:47.079026+00:00 app[web.1]:  :original => 'aee99c0cedfe77667dae07e13e72d37f602417ff' \n2017-04-28T20:22:47.104290+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 'converted_admin_configurations_menu' matched 1 times with '[data-hook='admin_settings_sub_tabs']'\n2017-04-28T20:22:47.104571+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: [WARNING] No :original defined for 'converted_admin_configurations_menu', you should change its definition to include:\n2017-04-28T20:22:47.104573+00:00 app[web.1]:  :original => '64e11ec9004698d8a05a060082fad91706ad14b6' \n2017-04-28T20:22:47.115199+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_settings_sub_menu.html.erb (5.1ms)\n2017-04-28T20:22:47.162385+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_promotion_sub_menu.html.erb (1.6ms)\n2017-04-28T20:22:47.205552+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_stock_sub_menu.html.erb (1.9ms)\n2017-04-28T20:22:47.206422+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_tabs.html.erb (244.3ms)\n2017-04-28T20:22:47.209244+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_menu.html.erb (288.0ms)\n2017-04-28T20:22:47.259097+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/gems/solidus_auth_devise-1.6.2/lib/views/backend/spree/admin/shared/_navigation_footer.html.erb (3.2ms)\n2017-04-28T20:22:47.259176+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_navigation.html.erb (486.6ms)\n2017-04-28T20:22:47.307563+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 1 overrides found for 'spree/admin/shared/_header'\n2017-04-28T20:22:47.310325+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: [WARNING] No :original defined for 'print_buttons', you should change its definition to include:\n2017-04-28T20:22:47.310326+00:00 app[web.1]:  :original => 'ffdd7ab1b3ad3fffbfb214275f68f410d6be3f49' \n2017-04-28T20:22:47.340343+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_header.html.erb (1.3ms)\n2017-04-28T20:22:47.310148+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Deface: 'print_buttons' matched 1 times with '.page-actions'\n2017-04-28T20:22:47.443011+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_spinner.html.erb (1.0ms)\n2017-04-28T20:22:47.387124+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_flash.html.erb (1.2ms)\n2017-04-28T20:22:47.497832+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_table_filter.html.erb (1.0ms)\n2017-04-28T20:22:47.543918+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus-e4c0d53e12da/backend/app/views/spree/admin/shared/_sidebar.html.erb (0.7ms)\n2017-04-28T20:22:47.610624+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus_editor-be8573de5aa0/app/views/shared/editor_engines/_tiny_mce.html.erb (1.4ms)\n2017-04-28T20:22:47.611039+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8] Completed 200 OK in 1512ms (Views: 1338.7ms | ActiveRecord: 19.6ms)\n2017-04-28T20:22:47.610671+00:00 app[web.1]: [d9d703a1-0ca0-48fb-b75d-3dadd88825f8]   Rendered vendor/bundle/ruby/2.3.0/bundler/gems/solidus_editor-be8573de5aa0/app/views/shared/_rich_editor_javascript.html.erb (38.1ms)\n2017-04-28T20:22:47.622295+00:00 heroku[router]: at=info method=GET path=\"/admin/products/camisa-blanca-con-detalle-leopardo/images\" host=pislow-production.herokuapp.com request_id=d9d703a1-0ca0-48fb-b75d-3dadd88825f8 fwd=\"90.171.50.177\" dyno=web.1 connect=0ms service=1798ms status=200 bytes=90692 protocol=https\n2017-04-28T20:22:50.080103+00:00 heroku[router]: at=info method=GET path=\"/favicon.ico\" host=pislow-production.herokuapp.com request_id=324431e6-3694-4bf9-b8c7-96e2d71e9e00 fwd=\"90.171.50.177\" dyno=web.1 connect=0ms service=2ms status=200 bytes=143 protocol=https\n2017-04-28T20:22:50.633807+00:00 app[worker.1]:   Delayed::Backend::ActiveRecord::Job Load (1.4ms)  UPDATE \"delayed_jobs\" SET locked_at = '2017-04-28 20:22:50.631647', locked_by = 'host:3887634c-598a-4dc4-9cd1-86c3b2bc9fb9 pid:4' WHERE id IN (SELECT  \"delayed_jobs\".\"id\" FROM \"delayed_jobs\" WHERE ((run_at <= '2017-04-28 20:22:50.631017' AND (locked_at IS NULL OR locked_at < '2017-04-28 16:22:50.631097') OR locked_by = 'host:3887634c-598a-4dc4-9cd1-86c3b2bc9fb9 pid:4') AND failed_at IS NULL) ORDER BY priority ASC, run_at ASC LIMIT 1 FOR UPDATE) RETURNING *\n2017-04-28T20:23:00.638637+00:00 app[worker.1]:   Delayed::Backend::ActiveRecord::Job Load (2.0ms)  UPDATE \"delayed_jobs\" SET locked_at = '2017-04-28 20:23:00.635276', locked_by = 'host:3887634c-598a-4dc4-9cd1-86c3b2bc9fb9 pid:4' WHERE id IN (SELECT  \"delayed_jobs\".\"id\" FROM \"delayed_jobs\" WHERE ((run_at <= '2017-04-28 20:23:00.634133' AND (locked_at IS NULL OR locked_at < '2017-04-28 16:23:00.634253') OR locked_by = 'host:3887634c-598a-4dc4-9cd1-86c3b2bc9fb9 pid:4') AND failed_at IS NULL) ORDER BY priority ASC, run_at ASC LIMIT 1 FOR UPDATE) RETURNING *\nMy gemfile:\n```\nruby ENV['CUSTOM_RUBY_VERSION'] || '2.3.1'\ngem 'rails', '~> 5.0.0', '>= 5.0.0.1'\ngem 'pg', '~> 0.18'\ngem 'puma', '~> 3.0'\ngem 'sass-rails', '~> 5.0'\ngem 'uglifier', '>= 1.3.0'\ngem 'coffee-rails', '~> 4.2'\ngem 'rails_12factor'\ngem 'jquery-rails' , github: 'rails/jquery-rails'\ngem 'turbolinks', '~> 5'\ngem 'jbuilder', '~> 2.5\ngroup :development, :test do\n  gem 'byebug', platform: :mri\nend\ngroup :development do\n  gem 'web-console'\n  gem 'listen', '~> 3.0.5'\n  gem 'spring'\n  gem 'spring-watcher-listen', '~> 2.0.0'\nend\ngem 'tzinfo-data', platforms: [:mingw, :mswin, :x64_mingw, :jruby]\ngroup :development do\n  gem \"better_errors\"\n  gem \"binding_of_caller\"\nend\ngem 'solidus', github: 'solidusio/solidus'\ngem 'solidus_auth_devise'\ngroup :development, :test do\n  gem 'rspec-rails', '~> 3.5'\nend\ngem 'elasticsearch-model'\ngem 'elasticsearch-rails'\ngem 'bonsai-elasticsearch-rails'\ngem 'coffee-script-source', '~> 1.12', '>= 1.12.2'\ngem 'paperclip'\ngem 'aws-sdk', '~> 2.6', '>= 2.6.48'\ngem 'solidus_paypal_braintree', github: 'solidusio/solidus_paypal_braintree'\ngem \"solidus_signifyd\"\ngem 'solidus_i18n', github: 'solidusio-contrib/solidus_i18n', branch: 'master'\ngem 'solidus_social' , github: 'solidusio-contrib/solidus_social'\ngem 'solidus_related_products'\ngem 'solidus_editor', github: 'solidusio-contrib/solidus_editor', branch: 'master'\ngem 'solidus_print_invoice' , github: 'solidusio-contrib/solidus_print_invoice'\ngem \"solidus_comments\"\ngem 'solidus_product_feed'\ngem 'solidus_papertrail'\ngem 'solidus_log_viewer', github: 'solidusio-contrib/solidus_log_viewer'\ngem 'solidus_sitemap', github: 'solidusio-contrib/solidus_sitemap', branch: 'master'\ngem 'solidus_static_content', github: 'solidusio-contrib/solidus_static_content'\ngem \"bootstrap-sass\"\ngem 'solidus_reviews', github: 'solidusio-contrib/solidus_reviews'\ngem \"solidus_legacy_return_authorizations\"\ngem 'solidus_prototypes', github: 'solidusio-contrib/solidus_prototypes', branch: 'master'\ngem 'solidus_geocoding'\ngem 'spree_marketplace', github: 'sechix/spree_marketplace'\ngem 'spree_drop_ship', github: 'sechix/spree_drop_ship'\ngem 'solidus_user_prices', github: 'resolve/solidus_user_prices'\ngem 'solidus_user_roles', github: 'boomerdigital/solidus_user_roles'\ngem 'solidus_contact_us', :git => 'https://github.com/2beDigital/solidus_contact_us'\ngem 'dotenv-rails', :require => 'dotenv/rails-now'\ngem \"recaptcha\", require: \"recaptcha/rails\"\ngem 'solidus_wishlist', github: 'deseretbook/solidus_wishlist'\ngem 'solidus_recommendations', github: 'skukx/solidus_recommendations', branch: 'master'\ngem 'solidus_editor', github: 'solidusio-contrib/solidus_editor', branch: 'master'\ngem 'solidus_import_products', github: '2BeDigital/solidus_import_products'\ngem 'delayed_job_active_record'\ngem 'delayed_job'\ngem 'solidus_gateway' , github: 'solidusio/solidus_gateway'\ngem 'solidus_product_feed'\ngem 'spree_barcodes', github: 'recmode/spree_barcodes', branch: 'master'\ngem 'alchemy_cms', github: 'AlchemyCMS/alchemy_cms', branch: 'rails-5'\ngem 'alchemy-solidus', github: 'sechix/alchemy-solidus', branch: 'master'\ngem 'solidus_cmd'\ngem 'solidus_minicart', :git => 'https://github.com/2beDigital/solidus_minicart', branch: 'master'\ngem 'solidus_subscriptions', github: 'solidusio-contrib/solidus_subscriptions', branch: 'master'\ngem 'whenever', :require => false\ngem 'blockuijs-rails',  :git => 'https://github.com/BoTreeConsultingTeam/blockuijs-rails.git'\ngem 'blot'\ngem 'solidus_product_recommendations', github: 'sechix/solidus_product_recommendations', branch: 'master'\ngem 'solidus_account_recurring', github: 'sechix/solidus_account_recurring' , branch: 'master'\ngem 'stripe'\ngem 'solidus_trackers', :git => 'https://github.com/solidusio-contrib/solidus_trackers.git', branch: 'master'\ngem 'solidus_events_tracker', github: 'vinsol/solidus_events_tracker'\ngem 'spree_scan_and_go', github: 'reinaris/spree_scan_and_go'\ngem 'solidus_active_shipping', :git => \"git://github.com/solidusio-contrib/solidus_active_shipping\"\ngem 'solidus_product_labeling', github: 'sechix/solidus_product_labeling' , branch: 'master'\ngem 'solidus_smart_free_shipping', github: 'sechix/solidus_smart_free_shipping', branch: 'master'\ngem 'spree-point-of-sale', github: 'sechix/spree-point-of-sale' , branch: 'master'\ngem 'solidus_waiting_list', github: 'sechix/solidus_waiting_list'\ngem 'spree_report_products_ran_out_of_stock', github: 'sechix/spree_report_products_ran_out_of_stock'\ngem 'solidus_special_offer', github: 'samanmohamadi/solidus_special_offer' , branch: 'master'\ngem 'sidekiq'\ngem 'spree_recently_sold_products', github: 'sechix/spree_recently_sold_products'\ngem 'searchkick'\ngem 'solidus_searchkick', github: 'elevatorup/solidus_searchkick', branch: 'master'\ngem 'postcode_validation'\ngem 'solidus_prototypes', github: 'solidusio-contrib/solidus_prototypes', branch: 'master'\ngem 'solidus_log_viewer', github: 'solidusio-contrib/solidus_log_viewer'\ngem 'solidus_user_address_book', github: 'vinsol/solidus_user_address_book', branch: 'master'\ngem 'cookies_eu' , github: 'infinum/cookies_eu', branch: 'master'\ngem 'solidus_papertrail'\n```\nI have checked again heroku config for aws variables and are ok, in fact connect to aws s3, the strange is that upload images but not read them.. Hi @jhawthorn the problem is that images are uploaded ok to s3, in fact I are able to display them in my bucket, but problem is that solidus can't read them the after. With cdn are you able to display images after (even uploading is ok)?\nIn solidus gemfile I have:gem 'aws-sdk', '~> 2.6', '>= 2.6.48'\nWhich version of aws-sdk do you have?\nThanks a lot , continue conversation in support channel, can you send me link to?. This error is in production  because it's the environment where I use s3 due to heroku.\nHowever I have tried with paperclip configuration and I get error posting :\n2017-05-02T15:51:18.613728+00:00 heroku[router]: at=info method=POST path=\"/admin/products/camisa-blanca-con-detalle-leopardo/images\" host=pislow-production.herokuapp.com request_id=0978ddd2-321f-4631-bb89-5d3ce364c03f fwd=\"213.151.116.210\" dyno=web.1 connect=0ms service=2121ms status=500 bytes=33467 protocol=https\n2017-05-02T15:51:18.677217+00:00 heroku[router]: at=info method=POST path=\"/admin/products/camisa-blanca-con-detalle-leopardo/images\" host=pislow-production.herokuapp.com request_id=ca2d0ce1-a6fa-49e7-b5a3-7919a02852c4 fwd=\"213.151.116.210\" dyno=web.1 connect=0ms service=2198ms status=500 bytes=33466 protocol=https\nCDN let me upload images, the problem is that after couldn't find. I use same credentials and bucket as CDN with paperclip.\n. Ok.It was commented:\n# Enable serving of images, stylesheets, and JavaScripts from an asset server.\n  # config.action_controller.asset_host = 'http://assets.example.com'\nWhich asset host I have to set: http://pislow.s3-eu-west-2.amazonaws.com ??. I have just put a host but loose all my stylesheets :( and paperclip doesn't work. Yes @AndreiMotinga it is a little :(  . I don't mind to use paperclip or cdn, I only want to deploy to heroku but heroku needs a storage for images. \nNow I have paperclip config:\n`if ENV['AWS_ACCESS_KEY_ID']\n  Paperclip::Attachment.default_options.merge!(\n    :storage => :fog,\n    :fog_credentials => {\n      :provider => \"AWS\",\n      :aws_access_key_id => ENV['AWS_ACCESS_KEY_ID'],\n      :aws_secret_access_key => ENV['AWS_SECRET_ACCESS_KEY']\n    },\n    :fog_directory => ENV[\"S3_BUCKET_NAME\"]\n  )\nSpree::Image.attachment_definitions[:attachment].delete(:url)\n  Spree::Image.attachment_definitions[:attachment].delete(:path)\nend`\nbut nothing:\n[POST /admin/products/camisa-blanca-con-detalle-leopardo/images] invalidate, pass\n2017-05-02T17:35:53.746049+00:00 heroku[router]: at=info method=POST path=\"/admin/products/camisa-blanca-con-detalle-leopardo/images\" host=pislow-production.herokuapp.com request_id=88fb1f7b-0f5b-4745-905e-b45a6f24090b fwd=\"213.151.116.210\" dyno=web.1 connect=0ms service=1671ms status=500 bytes=33657 protocol=https\nI have checked with amazon providers that my heroku config params are ok.\n. Sorry, but I am a little confused. As a summary, to connect solidus with store s3:\nAdd gems:\ngem 'paperclip'\ngem 'aws-sdk', '~> 2.6', '>= 2.6.48'\nAdd in production.rb:\nconfig.paperclip_defaults = {\n  :storage => :s3,\n  :bucket => ENV[\"S3_BUCKET_NAME\"]\n}\nCreate aws.yml with:\n`production:\naccess_key_id: ENV['AWS_ACCESS_KEY_ID']\n  secret_access_key: ENV['AWS_SECRET_ACCESS_KEY']`\nAdd create paperclip.rb with:\n`if ENV['AWS_ACCESS_KEY_ID']\n  Paperclip::Attachment.default_options.merge!(\n    :storage => :fog,\n    :fog_credentials => {\n      :provider => \"AWS\",\n      :aws_access_key_id => ENV['AWS_ACCESS_KEY_ID'],\n      :aws_secret_access_key => ENV['AWS_SECRET_ACCESS_KEY']\n    },\n    :fog_directory => ENV[\"S3_BUCKET_NAME\"]\n  )\nSpree::Image.attachment_definitions[:attachment].delete(:url)\n  Spree::Image.attachment_definitions[:attachment].delete(:path)\nend`\n. Now crushed due to favicon. \nThere is a way to store both app assets (as favicon) and products images in s3 for PRODUCTION AND HEROKU. Could you detail steps as a summary? sorry and thanks for your help, but I only need clarify steps to connect all assets with s3. The guidelines not are clear, and it is confusing.. perfect, I am in \ud83d\udc4d . Confirmed !!! Is in 2.3.0.alpha, in 2.2 works ok.. What happens finally with this pull? . Ah!!! Ok, you are right!!! Sorry for the misunderstanding.\nI will reproduce and open another one for dullicate variants. I added gem activemerchant last version, and now I get NameError: uninitialized constant Spree::Admin::ImagesHelper.. Finally i solved by myself, adding and install Last gem of archive_merchant. Solved, it was due to solidus_user_roles gem. ok, thanks!!!. \nUpdate product:\n\nAfter update (even refreshing page):\n\n\n. I solved creating this file, I am using solidus_stripe extension, but I guess that happen with each of payments gateway. Ok, thanks!!!!. ok, solved!!! Missing migrations... thanksssss. Sorry , I am not able,  I don't have the error now. For example, in our case we use the same images always for all variants, so never assign the images to any variant. So if I am looking for a product I have to see the image associated in this case the master because don't have a specific image. This is the normal behavior in solidus. And don't disturb the other  case, only add functionality.. @VzqzAc Only when variant don't show image has to display master image. This is how hows in every part of solidus. I have this in vendor/assets/javascripts/spree/backend/all.js:\nvendor/assets/javascripts/spree/backend/all.js\n\n. I realized that it is not related to variant autocomplete, none of the script work , I guess it is due to the jquery error that I have in every page of solidus admin.\n\nI have added this to vendor all.js folling your pr but still error:\n\n. Hi, yes I had a syntax error , sorry. Solved!. ",
    "Arpsara": "Updated specs with success! :). ",
    "eoinkelly": "Not comparing across currencies seems sensible. I'll have a go at a PR and then we'll have something concrete to discuss.. ",
    "mntmn": "I'm having the same problem with 2.5.0beta2. Also the variant prices don't include the taxes but add them on top, even if specified otherwise.\nhttp://dump.mntmn.com/solidus-variants-bug.png. Full stracktrace: https://gist.github.com/mntmn/c88d8bdc21099cf68efc9e76f78ca77d\nGemfile and Gemfile.lock: https://gist.github.com/mntmn/aba30deef8b3d07019230ecf332920c3. ",
    "aamyot": "also  https://github.com/solidusio/solidus/pull/1659. lol... of course!  this wasn't meant to be posted here.  Sorry about the confusion.\nThanks.. ",
    "vishalzambre": "@tvdeyen  Hey,\nIn any calculators if it is flat rate discount or shipping it should check order currency because lets take an example :\nWeb portal is working in  multiple currency\nIf order currency is INR\nand web portal default currency is USD and all shipping and promotions are created in USD.\nNow in case of shipping if order in US requires 10$ of shipping and in INR (India) It may requires 100$ to ship. Same with promotion.. @mamhoff Hey sorry for late reply yes, I'll look into this.. I worked around conversions for the above solution, I think not required to change in core.. ",
    "Magnusvb": "John, you are totally right!\nI had cloned (by mistake) the Master and used these files in my installation - which is version 2.1. Replacing with the right file solved the problem.\n@graygilmore: I could not find the file with the settings, which made me wonder about the versions...\nSorry for the false issue (and late respons)! Many thanks!. ",
    "kooinam": "So is it safe to replace  \n\nunless shipment.pending?\n\nto\n\nif !shipment.pending? and !shipment.ready?\n\nbecause the things is the UI is currently allowing transferring stock location for a shipment in READY state. ",
    "ShuaibMalik1": "Thanks for your reply. i am new on that and i am tying every thing to find that solution but i do't get. it's realy helpfull to me if you could suggest any thing to me for that\nthanks. ",
    "aayush2610": "Hey @jhawthorn I would like to contribute to this issue. I was not able to create a store with two stock locations, can you help with that? . ",
    "vfonic": "Not sure if .present? should be added or if that should be removed altogether. Also not sure if this particular piece of code requires a test.. As far as I could see, there's no way to end up with empty guest_token (with the standard Solidus code). However, saying that, and thinking about all the possible ways you can change the data in the database, I'd say in some strange edge case, it's possible.\nI'll see to make the validation change on Order model.. @jhawthorn I'm not sure why would validates :guest_token, presence: true fail (but it does)?. I've never seen the UI in which \"Add Item\" is disabled. From my experience, the button/link is enabled and, when the user clicks on it, it adds a new empty row (or if we don't want that, we can focus on the above empty row). If the user didn't want to do this, s/he can remove that row.\nTo me, this UI looks like:\nI fill in the cart item details and then \"Add Item\" button is enabled, so I click on it to confirm adding this first item. Of course this is wrong, since \"Add Item\" doesn't confirm my action, but the button on the right does.\nPS I've noticed that action buttons/icons in solidus admin are usually outside of the table and table row. I think if the action button is referring to the item in the table row, it should be inside the table itself:\n\nNot sure why it was explicitly made look like it doesn't belong to the table.\nPPS I'm trying to bring a new \"outside\" view. Maybe I'm wrong in some things so please either correct me or ignore me if you want to ship things faster. ;). @jhawthorn \nI was talking generally:\n\nPS I've noticed that action buttons/icons in solidus admin are usually outside of the table...\n\nI'll start the discussion in #gui. > The names aren't ideal, but it's never made visible to the user. IMO it's not worth changing them due to the incompatibilities it will cause. Either way, outside the scope of this PR.\nI think that developers should also be considered users. It will be easier for solidus developers to jump on certain code part and make changes, as well as for solidus gem users, to figure out how to use the solidus code API (not JSON API).. We should also agree about which rules the linter should use then. I just created a PR for CoffeeScript, but not sure that the configuration is what you guys are looking-for/agree-on?. I personally think we should convert those coffeescript files to javascript and use js exclusively.. Just ran rubocop and here's the output:\n1392 files inspected, 1154 offenses detected. Finally someone with OCD like me! \ud83c\udf89 \nAlthough I like this change, I don't know whether it's considered to be a \"religious war\" that you're fighting, as I've realized that solidus code style guidelines are very loose. It looks like you can write your code any way you want as long as it looks readable (no fighting over hash styles, single/double quotes, etc.)\nThis change affects a lot of files and will require most of current PRs to be updated (or this PR to be updated again after those other PRs have been merged).. \ud83d\udc4d I fully agree. I think the syntax should be updated as the changes are done to the file/to the code with old syntax.. Ah, I think the issue was with the background color not getting light green/light red. And the tooltip was completely missing. I don't recall exactly, as it was in Feb when I created this issue. But it seems to be fixed now. So I'm closing this issue. Thanks for looking into this!. It would be good if someone who has already done that, to share back with the community. ;). I just did a quick Google search and it seems like there's no consensus whether or not to use \"Actions\" label or leave it blank. I prefer having \"Actions\" heading as the icons might not be intuitive, as @isaacfreeman pointed out and it provides a little bit more of a structure, by answering a question: \"What does this column represent/contain?\"\nFun fact: On the other hand, code-wise, if I remove \"Actions\" title, this PR will be much smaller.\nHere are the screenshots with and without the \"Actions\" title:\n\n\nPlease also note that, on tables that have sorting by column, actions title remains black/unsortable.\nShould I keep the title or remove it?. @jhawthorn It was confusing for me, who is unfamiliar with the interface, so I asked and proposed the changes. I don't know of any UI where the action icons are outside of the table and table row they refer to. It's not clear, especially when there's only one row: there are some buttons on the right of the table, there are some buttons below the table...\nI see others mostly agree with putting action icons inside of the table. Are you ok with that or you have strong opinion against?\nWhat about \"Actions\" label? \ud83d\udc4d / \ud83d\udc4e ? I'd like to keep the label (obviously, since I made the change) . I think it does. I opened this PR exactly because to me, those buttons looked like they could belong to the table, but maybe also not. Also, it wasn't clear what those buttons represented. Of course, it's clear once you hover over them, but not before that.\nI'm not talking about moving towards future version of design. I'm talking about improving current design. And that's what we should focus right now, while we don't have the new design.\nAnyway, I guess this won't get merged. I've never seen UI look like this and I disagree with leaving these changes out.. Since solidus' users are developers and there's no documentation of solidus...at all, I think the filtering of the bad data should happen at any user-entry point aka developer API aka any public method. In this case, that would be the OrderContents. Whether it would be a default of 1 or a validation error, that's another discussion, but it should not be possible to create invalid OrderContents (that would be OrderContents with quantity of zero.. Resolved merge conflicts with master. Oh, I didn't know that. Well, in that case, I can replace has_one with has_many:\nrb\n  has_many :user_addresses, -> { active }\n  has_many :users, through: :user_addresses\nThis was my first implementation, but I thought it's impossible for an address to be shared by multiple users, so I changed it to has_one.\nPS has_many works (of course) even if there's only one user (and one address). Hi @jhawthorn, what do you think of Address.has_many :user_addresses? I think this should work for every case.. Bump!\nI think the changes I made after @jhawthorn's comment should work for every case and would not require users who need this functionality to have to do class_eval to add this functionality.. I need Address.lastname to be filled in in my specs and I think the proper way would be to add it here in the solidus codebase. Is there any specific known reason why would the lastname be nil in the factory?. That makes sense. I'll modify the factory in my code. \nThanks for the explanation! . Bump!\nInfo straight from awesome_nested_set Readme:\nhttps://github.com/collectiveidea/awesome_nested_set/blob/fbc84118a0ba495b934ea5cadbdcc56847ec2aa0/README.md#indexes\nPerhaps we could add an index to depth column as well?\n. @omnistegan thanks for the PR! I've submitted an issue about similar bug when adding a line item with quantity being zero. If you find time to look into that one, would be great:\nhttps://github.com/solidusio/solidus/issues/1726\nI've also noticed that a lot of code in add_to_line_item and remove_from_line_item is the same. In fact, I'm sure these two methods could be merged into one.. Thank you!!! :) \nReally needed this and I overcomplicated it when I tried to fix it. . Wouldn't it be better to always have admin_breadcrumb at the top of every non-partial template?\nLike this we ensure that the method is called only once. Otherwise, we can't reuse _form partial without getting the \"Shipments\" breadcrumb, no matter which page we're on.. Is there a default fallback language for when locale is not set?\nI'd assume that would be English. In that case, this makes more sense:\njs\nvar defaultLocale = document.documentElement.lang || 'en';. There's a big discussion whether semicolons should be always added or not in JS. I'd lean towards the \"mandatory semicolons\", simply because it prevents unexpected errors from happening. You can see one such example in this SO answer:\nhttp://stackoverflow.com/a/8108912/336806\n. This function looks like something I'd like to be able to also use on frontend. It seems to be impossible without including solidus_backend. Is there a central place where such functions could go?\nAlso, defaultLocale could be calculated in a centralized place.. Speaking of, is there any linter used for JS? What are the JS style rules (e.g. semicolons). I think the more preferred way would be to use :disabled CSS3 selector. Although they are the same, some explanation why use one over the [disabled] can be found here:\nhttp://stackoverflow.com/a/20146936/336806\nIt works in cross-browser:\nhttp://caniuse.com/#feat=css-sel3\n. These should be translated:\nScreenshot:\n. Nevermind, this is a solidus_i18n issue. Not related to these changes, but you could add this fix in:\nrb\ncurrency: adjustments.first.order.try(:currency)\n=>\nrb\ncurrency: order.currency\n...since you're always passing order variable and it's always defined.. I think it's better having this inlined inside of the it block:\nrb\norder = create(:completed_order_with_totals)\nIt's always better to have the code contained in the single place, than trying to figure out where did this variable come from (especially if let! is used and not let).. Is there any process for reporting this new translation to solidus_i18n? Perhaps an issue could be created on the solidus_i18n repo when translation-changes/new-translation-is-added?. nitpick: \"location\". Filed. I guess we can both agree that \"temporary fix\" tends to stay around much longer than what we planned it to stay. :). Do you mean it's always preferred in solidus project(s) or it's generally always preferred? Because I prefer not to use it and I can find some good arguments why it should be avoided:\nhttps://robots.thoughtbot.com/lets-not\nhttp://linduxed.com/blog/2014/08/24/writing-more-readable-rspec-tests/\nOf course there are always arguments pro and contra. Just asking out of curiosity.. I'm not sure how does handlebars know to translate this correctly?\nI haven't seen any translations for, for example: {{ t \"select_stock\" }} on line 2. using singular here, like it's used for tab above, could change if needed. You mean to have this in _form:\nerb\n<% order = order_form.object %>\n?. Updated. ",
    "winterblack": "Fixed, thank you.. Fixed, thank you.. ",
    "gregdaynes": "Looking into this, I tested it out using by adjusting show_decision: true\nThe following screenshots are from Safari 11 on macOS\n\n\nThe text is white, but inside a coloured tooltip - this is consistent with the rest of the backend UI\nWere you seeing it without the tooltip bubble (coloured background)? \nWhat browser/device were you using?. I'll look into this later today. . ",
    "f3lan": "Working on it \ud83d\ude38 . ",
    "puranjay6": "Can i now see the backend only shipping methods ? . ",
    "webuilder240": "===== before Explain =====\n```\nQUERY PLAN\n\nSeq Scan on spree_products  (cost=0.00..1.11 rows=9 width=405)\nFilter: ((deleted_at IS NULL) OR (deleted_at >= '2017-03-21 13:46:05.023347'::timestamp without time zone))\n(2 rows)\nEXPLAIN for: SELECT \"spree_product_option_types\".* FROM \"spree_product_option_types\" WHERE \"spree_product_option_types\".\"product_id\" IN (9, 7, 6, 1, 2, 3, 4, 8, 5)\nQUERY PLAN\n\nBitmap Heap Scan on spree_product_option_types  (cost=9.86..21.16 rows=61 width=32)\nRecheck Cond: (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[]))\n->  Bitmap Index Scan on index_spree_product_option_types_on_product_id  (cost=0.00..9.85 rows=61 width=0)\nIndex Cond: (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_option_types\".* FROM \"spree_option_types\" WHERE \"spree_option_types\".\"id\" IN (1, 2) ORDER BY \"spree_option_types\".\"position\" ASC\nQUERY PLAN\n\nSort  (cost=12.01..12.02 rows=2 width=460)\nSort Key: \"position\"\n->  Seq Scan on spree_option_types  (cost=0.00..12.00 rows=2 width=460)\nFilter: (id = ANY ('{1,2}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_products_taxons\".* FROM \"spree_products_taxons\" WHERE \"spree_products_taxons\".\"product_id\" IN (9, 7, 6, 1, 2, 3, 4, 8, 5)\nQUERY PLAN\n\nBitmap Heap Scan on spree_products_taxons  (cost=9.86..21.16 rows=61 width=32)\nRecheck Cond: (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[]))\n->  Bitmap Index Scan on index_spree_products_taxons_on_product_id  (cost=0.00..9.85 rows=61 width=0)\nIndex Cond: (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_taxons\".* FROM \"spree_taxons\" WHERE \"spree_taxons\".\"id\" IN (4, 10, 7, 9, 8, 3, 6)\nQUERY PLAN\n\nSeq Scan on spree_taxons  (cost=0.00..1.19 rows=7 width=271)\nFilter: (id = ANY ('{4,10,7,9,8,3,6}'::integer[]))\n(2 rows)\nEXPLAIN for: SELECT \"spree_product_properties\".* FROM \"spree_product_properties\" WHERE \"spree_product_properties\".\"product_id\" IN (9, 7, 6, 1, 2, 3, 4, 8, 5) ORDER BY \"spree_product_properties\".\"position\" ASC\nQUERY PLAN\n\nSort  (cost=21.54..21.64 rows=40 width=64)\nSort Key: \"position\"\n->  Bitmap Heap Scan on spree_product_properties  (cost=9.63..20.48 rows=40 width=64)\nRecheck Cond: (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[]))\n->  Bitmap Index Scan on index_product_properties_on_product_id  (cost=0.00..9.62 rows=40 width=0)\nIndex Cond: (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[]))\n(6 rows)\nEXPLAIN for: SELECT \"spree_properties\".* FROM \"spree_properties\" WHERE \"spree_properties\".\"id\" IN (1, 9, 10, 2, 3, 11, 4, 5, 6, 7, 8)\nQUERY PLAN\n\nBitmap Heap Scan on spree_properties  (cost=9.74..20.53 rows=11 width=84)\nRecheck Cond: (id = ANY ('{1,9,10,2,3,11,4,5,6,7,8}'::integer[]))\n->  Bitmap Index Scan on spree_properties_pkey  (cost=0.00..9.73 rows=11 width=0)\nIndex Cond: (id = ANY ('{1,9,10,2,3,11,4,5,6,7,8}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_variants\".* FROM \"spree_variants\" WHERE \"spree_variants\".\"deleted_at\" IS NULL AND \"spree_variants\".\"is_master\" = $1 AND \"spree_variants\".\"product_id\" IN (9, 7, 6, 1, 2, 3, 4, 8, 5) ORDER BY \"spree_variants\".\"position\" ASC [[\"is_master\", nil]]\n    QUERY PLAN\n\nSort  (cost=1.57..1.59 rows=10 width=105)\nSort Key: \"position\"\n->  Seq Scan on spree_variants  (cost=0.00..1.40 rows=10 width=105)\nFilter: ((deleted_at IS NULL) AND (NOT is_master) AND (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[])))\n(4 rows)\nEXPLAIN for: SELECT \"spree_option_values_variants\".* FROM \"spree_option_values_variants\" WHERE \"spree_option_values_variants\".\"variant_id\" IN (10, 11, 12, 13, 14, 15, 16, 17, 18, 19)\n QUERY PLAN\n\nBitmap Heap Scan on spree_option_values_variants  (cost=10.07..21.69 rows=72 width=28)\nRecheck Cond: (variant_id = ANY ('{10,11,12,13,14,15,16,17,18,19}'::integer[]))\n->  Bitmap Index Scan on index_spree_option_values_variants_on_variant_id  (cost=0.00..10.05 rows=72 width=0)\nIndex Cond: (variant_id = ANY ('{10,11,12,13,14,15,16,17,18,19}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_option_values\".* FROM \"spree_option_values\" WHERE \"spree_option_values\".\"id\" IN (1, 5, 7, 6, 2, 3, 4)\nQUERY PLAN\n\nBitmap Heap Scan on spree_option_values  (cost=9.10..19.29 rows=7 width=92)\nRecheck Cond: (id = ANY ('{1,5,7,6,2,3,4}'::integer[]))\n->  Bitmap Index Scan on spree_option_values_pkey  (cost=0.00..9.10 rows=7 width=0)\nIndex Cond: (id = ANY ('{1,5,7,6,2,3,4}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_prices\".* FROM \"spree_prices\" WHERE \"spree_prices\".\"currency\" = $1 AND \"spree_prices\".\"country_iso\" IS NULL AND \"spree_prices\".\"variant_id\" IN (10, 11, 12, 13, 14, 15, 16, 17, 18, 19) ORDER BY country_iso IS NULL, updated_at DESC, id DESC [[\"currency\", nil]]\n      QUERY PLAN\n\nSort  (cost=11.33..11.33 rows=1 width=93)\nSort Key: ((country_iso IS NULL)), updated_at DESC, id DESC\n->  Bitmap Heap Scan on spree_prices  (cost=4.17..11.32 rows=1 width=93)\nRecheck Cond: (country_iso IS NULL)\nFilter: (((currency)::text = 'USD'::text) AND (variant_id = ANY ('{10,11,12,13,14,15,16,17,18,19}'::integer[])))\n->  Bitmap Index Scan on index_spree_prices_on_country_iso  (cost=0.00..4.17 rows=3 width=0)\nIndex Cond: (country_iso IS NULL)\n(7 rows)\nEXPLAIN for: SELECT \"spree_assets\".* FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_type\" = $1 AND \"spree_assets\".\"viewable_id\" IN (10, 11, 12, 13, 14, 15, 16, 17, 18, 19) ORDER BY \"spree_assets\".\"position\" ASC [[\"viewable_type\", nil]]\n  QUERY PLAN\n\nSort  (cost=8.19..8.19 rows=1 width=344)\nSort Key: \"position\"\n->  Index Scan using index_assets_on_viewable_type_and_type on spree_assets  (cost=0.14..8.18 rows=1 width=344)\nIndex Cond: (((viewable_type)::text = 'Spree::Variant'::text) AND ((type)::text = 'Spree::Image'::text))\nFilter: (viewable_id = ANY ('{10,11,12,13,14,15,16,17,18,19}'::integer[]))\n(5 rows)\nEXPLAIN for: SELECT \"spree_variants\".* FROM \"spree_variants\" WHERE \"spree_variants\".\"is_master\" = $1 AND \"spree_variants\".\"product_id\" IN (9, 7, 6, 1, 2, 3, 4, 8, 5) [[\"is_master\", nil]]\nQUERY PLAN\n\nSeq Scan on spree_variants  (cost=0.00..1.40 rows=9 width=105)\nFilter: (is_master AND (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[])))\n(2 rows)\nEXPLAIN for: SELECT \"spree_option_values_variants\".* FROM \"spree_option_values_variants\" WHERE \"spree_option_values_variants\".\"variant_id\" IN (4, 8, 5, 9, 7, 6, 1, 2, 3)\n QUERY PLAN\n\nBitmap Heap Scan on spree_option_values_variants  (cost=9.86..21.24 rows=65 width=28)\nRecheck Cond: (variant_id = ANY ('{4,8,5,9,7,6,1,2,3}'::integer[]))\n->  Bitmap Index Scan on index_spree_option_values_variants_on_variant_id  (cost=0.00..9.85 rows=65 width=0)\nIndex Cond: (variant_id = ANY ('{4,8,5,9,7,6,1,2,3}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_prices\".* FROM \"spree_prices\" WHERE \"spree_prices\".\"currency\" = $1 AND \"spree_prices\".\"country_iso\" IS NULL AND \"spree_prices\".\"variant_id\" IN (4, 8, 5, 9, 7, 6, 1, 2, 3) ORDER BY country_iso IS NULL, updated_at DESC, id DESC [[\"currency\", nil]]\nQUERY PLAN\n\nSort  (cost=11.32..11.33 rows=1 width=93)\nSort Key: ((country_iso IS NULL)), updated_at DESC, id DESC\n->  Bitmap Heap Scan on spree_prices  (cost=4.17..11.31 rows=1 width=93)\nRecheck Cond: (country_iso IS NULL)\nFilter: (((currency)::text = 'USD'::text) AND (variant_id = ANY ('{4,8,5,9,7,6,1,2,3}'::integer[])))\n->  Bitmap Index Scan on index_spree_prices_on_country_iso  (cost=0.00..4.17 rows=3 width=0)\nIndex Cond: (country_iso IS NULL)\n(7 rows)\nEXPLAIN for: SELECT \"spree_assets\".* FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_type\" = $1 AND \"spree_assets\".\"viewable_id\" IN (4, 8, 5, 9, 7, 6, 1, 2, 3) ORDER BY \"spree_assets\".\"position\" ASC [[\"viewable_type\", nil]]\n  QUERY PLAN\n\nSort  (cost=8.19..8.19 rows=1 width=344)\nSort Key: \"position\"\n->  Index Scan using index_assets_on_viewable_type_and_type on spree_assets  (cost=0.14..8.18 rows=1 width=344)\nIndex Cond: (((viewable_type)::text = 'Spree::Variant'::text) AND ((type)::text = 'Spree::Image'::text))\nFilter: (viewable_id = ANY ('{4,8,5,9,7,6,1,2,3}'::integer[]))\n(5 rows)\n```\n==== after Explain ====\n```\nQUERY PLAN\n\nSeq Scan on spree_products  (cost=0.00..1.11 rows=9 width=405)\n   Filter: ((deleted_at IS NULL) OR (deleted_at >= '2017-03-21 13:47:21.974743'::timestamp without time zone))\n(2 rows)\nEXPLAIN for: SELECT \"spree_product_option_types\".* FROM \"spree_product_option_types\" WHERE \"spree_product_option_types\".\"product_id\" IN (9, 7, 6, 1, 2, 3, 4, 8, 5)\nQUERY PLAN\n\nBitmap Heap Scan on spree_product_option_types  (cost=9.86..21.16 rows=61 width=32)\n   Recheck Cond: (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[]))\n   ->  Bitmap Index Scan on index_spree_product_option_types_on_product_id  (cost=0.00..9.85 rows=61 width=0)\n         Index Cond: (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_option_types\".* FROM \"spree_option_types\" WHERE \"spree_option_types\".\"id\" IN (1, 2) ORDER BY \"spree_option_types\".\"position\" ASC\nQUERY PLAN\n\nSort  (cost=12.01..12.02 rows=2 width=460)\n   Sort Key: \"position\"\n   ->  Seq Scan on spree_option_types  (cost=0.00..12.00 rows=2 width=460)\n         Filter: (id = ANY ('{1,2}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_products_taxons\".* FROM \"spree_products_taxons\" WHERE \"spree_products_taxons\".\"product_id\" IN (9, 7, 6, 1, 2, 3, 4, 8, 5)\nQUERY PLAN\n\nBitmap Heap Scan on spree_products_taxons  (cost=9.86..21.16 rows=61 width=32)\n   Recheck Cond: (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[]))\n   ->  Bitmap Index Scan on index_spree_products_taxons_on_product_id  (cost=0.00..9.85 rows=61 width=0)\n         Index Cond: (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_taxons\".* FROM \"spree_taxons\" WHERE \"spree_taxons\".\"id\" IN (4, 10, 7, 9, 8, 3, 6)\nQUERY PLAN\n\nSeq Scan on spree_taxons  (cost=0.00..1.19 rows=7 width=271)\n   Filter: (id = ANY ('{4,10,7,9,8,3,6}'::integer[]))\n(2 rows)\nEXPLAIN for: SELECT \"spree_taxons\".* FROM \"spree_taxons\" WHERE \"spree_taxons\".\"parent_id\" IN (6, 4, 9, 8, 7, 10, 3) ORDER BY \"spree_taxons\".\"lft\"\nQUERY PLAN\n\nSort  (cost=1.20..1.20 rows=1 width=271)\n   Sort Key: lft\n   ->  Seq Scan on spree_taxons  (cost=0.00..1.19 rows=1 width=271)\n         Filter: (parent_id = ANY ('{6,4,9,8,7,10,3}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_product_properties\".* FROM \"spree_product_properties\" WHERE \"spree_product_properties\".\"product_id\" IN (9, 7, 6, 1, 2, 3, 4, 8, 5) ORDER BY \"spree_product_properties\".\"position\" ASC\nQUERY PLAN\n\nSort  (cost=21.54..21.64 rows=40 width=64)\n   Sort Key: \"position\"\n   ->  Bitmap Heap Scan on spree_product_properties  (cost=9.63..20.48 rows=40 width=64)\n         Recheck Cond: (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[]))\n         ->  Bitmap Index Scan on index_product_properties_on_product_id  (cost=0.00..9.62 rows=40 width=0)\n               Index Cond: (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[]))\n(6 rows)\nEXPLAIN for: SELECT \"spree_properties\".* FROM \"spree_properties\" WHERE \"spree_properties\".\"id\" IN (1, 9, 10, 2, 3, 11, 4, 5, 6, 7, 8)\nQUERY PLAN\n\nBitmap Heap Scan on spree_properties  (cost=9.74..20.53 rows=11 width=84)\n   Recheck Cond: (id = ANY ('{1,9,10,2,3,11,4,5,6,7,8}'::integer[]))\n   ->  Bitmap Index Scan on spree_properties_pkey  (cost=0.00..9.73 rows=11 width=0)\n         Index Cond: (id = ANY ('{1,9,10,2,3,11,4,5,6,7,8}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_variants\".* FROM \"spree_variants\" WHERE \"spree_variants\".\"deleted_at\" IS NULL AND \"spree_variants\".\"is_master\" = $1 AND \"spree_variants\".\"product_id\" IN (9, 7, 6, 1, 2, 3, 4, 8, 5) ORDER BY \"spree_variants\".\"position\" ASC [[\"is_master\", nil]]\nQUERY PLAN\n\nSort  (cost=1.57..1.59 rows=10 width=105)\n   Sort Key: \"position\"\n   ->  Seq Scan on spree_variants  (cost=0.00..1.40 rows=10 width=105)\n         Filter: ((deleted_at IS NULL) AND (NOT is_master) AND (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[])))\n(4 rows)\nEXPLAIN for: SELECT \"spree_option_values_variants\".* FROM \"spree_option_values_variants\" WHERE \"spree_option_values_variants\".\"variant_id\" IN (10, 11, 12, 13, 14, 15, 16, 17, 18, 19)\nQUERY PLAN\n\nBitmap Heap Scan on spree_option_values_variants  (cost=10.07..21.69 rows=72 width=28)\n   Recheck Cond: (variant_id = ANY ('{10,11,12,13,14,15,16,17,18,19}'::integer[]))\n   ->  Bitmap Index Scan on index_spree_option_values_variants_on_variant_id  (cost=0.00..10.05 rows=72 width=0)\n         Index Cond: (variant_id = ANY ('{10,11,12,13,14,15,16,17,18,19}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_option_values\".* FROM \"spree_option_values\" WHERE \"spree_option_values\".\"id\" IN (1, 5, 7, 6, 2, 3, 4)\nQUERY PLAN\n\nBitmap Heap Scan on spree_option_values  (cost=9.10..19.29 rows=7 width=92)\n   Recheck Cond: (id = ANY ('{1,5,7,6,2,3,4}'::integer[]))\n   ->  Bitmap Index Scan on spree_option_values_pkey  (cost=0.00..9.10 rows=7 width=0)\n         Index Cond: (id = ANY ('{1,5,7,6,2,3,4}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_prices\".* FROM \"spree_prices\" WHERE \"spree_prices\".\"currency\" = $1 AND \"spree_prices\".\"country_iso\" IS NULL AND \"spree_prices\".\"variant_id\" IN (10, 11, 12, 13, 14, 15, 16, 17, 18, 19) ORDER BY country_iso IS NULL, updated_at DESC, id DESC [[\"currency\", nil]]\nQUERY PLAN\n\nSort  (cost=11.33..11.33 rows=1 width=93)\n   Sort Key: ((country_iso IS NULL)), updated_at DESC, id DESC\n   ->  Bitmap Heap Scan on spree_prices  (cost=4.17..11.32 rows=1 width=93)\n         Recheck Cond: (country_iso IS NULL)\n         Filter: (((currency)::text = 'USD'::text) AND (variant_id = ANY ('{10,11,12,13,14,15,16,17,18,19}'::integer[])))\n         ->  Bitmap Index Scan on index_spree_prices_on_country_iso  (cost=0.00..4.17 rows=3 width=0)\n               Index Cond: (country_iso IS NULL)\n(7 rows)\nEXPLAIN for: SELECT \"spree_assets\".* FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_type\" = $1 AND \"spree_assets\".\"viewable_id\" IN (10, 11, 12, 13, 14, 15, 16, 17, 18, 19) ORDER BY \"spree_assets\".\"position\" ASC [[\"viewable_type\", nil]]\nQUERY PLAN\n\nSort  (cost=8.19..8.19 rows=1 width=344)\n   Sort Key: \"position\"\n   ->  Index Scan using index_assets_on_viewable_type_and_type on spree_assets  (cost=0.14..8.18 rows=1 width=344)\n         Index Cond: (((viewable_type)::text = 'Spree::Variant'::text) AND ((type)::text = 'Spree::Image'::text))\n         Filter: (viewable_id = ANY ('{10,11,12,13,14,15,16,17,18,19}'::integer[]))\n(5 rows)\nEXPLAIN for: SELECT \"spree_variants\".* FROM \"spree_variants\" WHERE \"spree_variants\".\"is_master\" = $1 AND \"spree_variants\".\"product_id\" IN (9, 7, 6, 1, 2, 3, 4, 8, 5) [[\"is_master\", nil]]\nQUERY PLAN\n\nSeq Scan on spree_variants  (cost=0.00..1.40 rows=9 width=105)\n   Filter: (is_master AND (product_id = ANY ('{9,7,6,1,2,3,4,8,5}'::integer[])))\n(2 rows)\nEXPLAIN for: SELECT \"spree_option_values_variants\".* FROM \"spree_option_values_variants\" WHERE \"spree_option_values_variants\".\"variant_id\" IN (4, 8, 5, 9, 7, 6, 1, 2, 3)\nQUERY PLAN\n\nBitmap Heap Scan on spree_option_values_variants  (cost=9.86..21.24 rows=65 width=28)\n   Recheck Cond: (variant_id = ANY ('{4,8,5,9,7,6,1,2,3}'::integer[]))\n   ->  Bitmap Index Scan on index_spree_option_values_variants_on_variant_id  (cost=0.00..9.85 rows=65 width=0)\n         Index Cond: (variant_id = ANY ('{4,8,5,9,7,6,1,2,3}'::integer[]))\n(4 rows)\nEXPLAIN for: SELECT \"spree_prices\".* FROM \"spree_prices\" WHERE \"spree_prices\".\"currency\" = $1 AND \"spree_prices\".\"country_iso\" IS NULL AND \"spree_prices\".\"variant_id\" IN (4, 8, 5, 9, 7, 6, 1, 2, 3) ORDER BY country_iso IS NULL, updated_at DESC, id DESC [[\"currency\", nil]]\nQUERY PLAN\n\nSort  (cost=11.32..11.33 rows=1 width=93)\n   Sort Key: ((country_iso IS NULL)), updated_at DESC, id DESC\n   ->  Bitmap Heap Scan on spree_prices  (cost=4.17..11.31 rows=1 width=93)\n         Recheck Cond: (country_iso IS NULL)\n         Filter: (((currency)::text = 'USD'::text) AND (variant_id = ANY ('{4,8,5,9,7,6,1,2,3}'::integer[])))\n         ->  Bitmap Index Scan on index_spree_prices_on_country_iso  (cost=0.00..4.17 rows=3 width=0)\n               Index Cond: (country_iso IS NULL)\n(7 rows)\nEXPLAIN for: SELECT \"spree_assets\".* FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_type\" = $1 AND \"spree_assets\".\"viewable_id\" IN (4, 8, 5, 9, 7, 6, 1, 2, 3) ORDER BY \"spree_assets\".\"position\" ASC [[\"viewable_type\", nil]]\nQUERY PLAN\n\nSort  (cost=8.19..8.19 rows=1 width=344)\n   Sort Key: \"position\"\n   ->  Index Scan using index_assets_on_viewable_type_and_type on spree_assets  (cost=0.14..8.18 rows=1 width=344)\n         Index Cond: (((viewable_type)::text = 'Spree::Variant'::text) AND ((type)::text = 'Spree::Image'::text))\n         Filter: (viewable_id = ANY ('{4,8,5,9,7,6,1,2,3}'::integer[]))\n(5 rows)\n```. I confirmed Explain, I made a mistake.\nThe reason I found it is because it detected using bullet Gem.\nI'm not Checking Explain...\nbecause this PR is Closed.\nJust in case pasted Explans.\nThanks.. ",
    "Draiken": "Yeah, I'll see if I can do it :slightly_smiling_face:\nThis is probably bad data then, closing. @mamhoff of course... I'll add it as soon as I have time\nWhen you say request spec, you mean a feature, or controller spec?. Added a controller spec, but since this behaviour is already tested on the model level by testing #duplicate I feel this spec doesn't add much value. The feature spec for it is more than enough IMO\nUnless we are testing a route no longer exists, or the view to see the generated button, I'm not sure what you want me to test. I have the same issue. Seems to be related to localization since I use pt-BR and have the exact same issue. My guess is that the datepicker format has a specific format and i18n changes the default date formats, causing the disconnect between the actual value from the input and the datepicker's display. This line shows how the datepicker format uses i18n to decide the datepicker format. This seems wrong to me, as I imagine the datepicker will always accept one specific format, so it should be hard coded.. To expand a bit: on the context of solidus_i18n you see a field called spree.date_picker.format and it makes sense to localize that to the local format. However by doing that you break the datepickers on the admin (haven't tested others, but I imagine everywhere that this helper is used will give the same result).\nI propose we hard-code the datepicker format to something that always works, since this is not a presentational value but instead a value that is used by a third party library.. ",
    "aaronrussell": "Thanks - that's pointed me in the right direction. I've solved this in my app by overriding CheckoutController#before_address in a decorator:\n```ruby\ndef before_address\n  # It's safe to call assign_default_addresses! here as it does nothing if order has no user\n  # and won't override an existing address on the order\n  @order.assign_default_addresses!\n# if the user has a default address, a callback takes care of setting\n  # that; but if he doesn't, we need to build an empty one here\n  default = { country_id: Spree::Country.default.id }\n  @order.build_bill_address(default) unless @order.bill_address\n  @order.build_ship_address(default) if @order.checkout_steps.include?('delivery') && !@order.ship_address\nend\n```\n. ",
    "Perkir": "Hello! \nI mean options in admin panel. \nProducts -> Display Order\nYou're right i need to use Spree::Product. . \nThis screen demonstration this bug. 1.Language from  solidus_i18n its \"ru\"\n2.Solidus version its 2.1.0. ",
    "m1foley": "For future web searchers: the root cause is likely running the database setup on Heroku.\n```sh\nheroku run rails generate spree:install\netc\n```. ",
    "luukveenis": "I added these commits to #1801 since they address the same issue.. @adammathys thanks for the feedback :grin: \n\nThe date picker fields in the admin submit the date as yyyy/mm/dd which gets parsed to a datetime as beginning of day. Since Spree::Promotion already has an expires_at field, which uses the default beginning of day behaviour, I thought it best to be consistent with that.\nI added a similar check to promotions on the transition to complete. If the credit has expired, the store credit payments are removed and the checkout flow is restarted with an error message displayed to the user.\nThe current behaviour when reimbursing an order that was paid for with store credit is to \"credit\" the balance back to the existing Spree::StoreCredit record instead of creating a new one, so it would keep the same expiration date. I think this makes sense, but any feedback is appreciated.. @kennyadsl thanks for the feedback.\n\nI would be in favour of removing the Spree::StoreCreditType model/association and the logic around automatically assigning the type (expiring/non-expiring) based on the Spree::StoreCreditCategory.\nhttps://github.com/solidusio/solidus/blob/master/core/app/models/spree/store_credit.rb#L272-L281\nThe credit type and category don't have a direct association and this is the main point of confusion I think. With the added expires_at field, we should just be able to infer whether a credit is expiring or non-expiring by whether it has an expiry date set.\nIf that code is removed, the Spree::StoreCreditCategory model only stores one attribute (name). In a new Solidus installation, we only create the Default store credit category. I'm not sure if this is used by anyone, but I also don't see any harm in keeping it.. Thanks for the feedback!\nUnfortunately where(store: store) doesn't work, because the payment method <-> store association is a has_many :through.\nThe reason for the conditional is to keep the existing, or at least expected, behaviour where if the store doesn't have any payment methods, we return all of them instead of an empty collection.\nI agree the ArgumentError is not a drastic improvement. I discussed this with @jhawthorn on Friday and would be okay just letting it error the usual way too.. Sorry, I don't follow why it should only be allowed on a non_expiring category?\nMy thinking was that if we have an expiring category, one would expect those credits to have an expiration date (otherwise they wouldn't be expiring). Similarly if a credit is non_expiring it should not have an expiration date. If anything I would consider adding a validation that a non_expiring credit does not have an expiration date set.. I changed the naming on this because it was confusing. We have both a Spree::StoreCreditCategory and a Spree::StoreCreditType model.\nThis attribute is called non_expiring_credit_types, but its value is set to the default Spree::StoreCreditCategory name, not a Spree::StoreCreditType. Also in the non_expiring? method, it checks if the current CreditCategory's name is in the array, so calling it a credit type is misleading. The way it's currently implemented, all store credit categories are considered expiring, since it's checking the name of a category against the name of a type.\nI found this confusing while working on it, but if you prefer to keep it as is please let me know. Otherwise I'll add deprecation warnings.. I discussed this with @cbrunsdon offline because I initially had this in a before_transition to: :complete. He brought up that there would likely be scenarios where admins would want to push through an order with expired credit and having it in a transition hook would prevent them from being able to do that. In general, having it at the model level would make it hard to opt out of this behaviour if desired.\nI could also add something to the API checkout controller to ensure similar behaviour, or is there a place you prefer this sort of logic to live?. To be honest, I'm not sure what the intention was with the original implementation. Since there was never an expiry date set anywhere, all credits were essentially non_expiring, though some had the expiring type.\nIn my mind when I read that a store credit has an expiring type, I would expect it to have an expiry date. This does make existing expiring credits invalid, so I understand the argument for maintaining compatibility with current behaviour.. > Yet this behaviour is absolutely essential for store credits to work now.\nI don't entirely agree with this. For users with custom frontends, not including this change will simply maintain current behaviour. If they wish to use expiring credits, they will have to pull this into their frontend, similar to any of the other logic that happens in before_actions in the CheckoutController.\n\nI would expect the exact opposite of that behaviour to be desired. Admins shouldn't accidentally be able to use expired store credits.\n\nIn our store - and presumably others - there are cases where the order may be held for review before completion (ie: fraud review). For cases like this, we can't guarantee that the order state at the time of checkout will be the same as when it gets approved. It's possible that the credits were valid when the user checked out, but have expired by the time an admin has a chance to review the order.\nAnother very common customer service use case is users that make it to the confirm page and think they completed the order. When they realize they haven't gotten an order confirmation email, they call customer service to have them complete the order and we can run into the same issue.\nThere is some potential for admins to accidentally use expired credit, but I think that's better than putting this in a transition hook that prevents them from completing these orders altogether, when there are valid use cases for doing so.. This can probably be a number_field as well. It's only used in admin forms for numeric values.. ",
    "NoelDiazMesa": "Thank you very much anyway, but, one question, which you use to debug??? I like byebug but it's not posible.. ",
    "gaurav945": "@kennyadsl I had completely ignored that endpoint, I am so sorry for that, thank you so much for your help, closing the issue now. :). @kennyadsl some help, please.... Thanks for the quick reply, I have a follow up query, which is, then how to handle the following scenario :\nSuppose, I have a web app, which uses Solidus APIs & the flow is similar to Solidus's flow. Now, let's say that I am on the confirm your order page, but I would like to go back & change my shipment provider, then how will I do that then, without transitioning the state ?. Okay & I am sorry for any inconvenience caused, I am actually new to all this, raising issues on github & such technical stuff, so I didn't know what would be the right place to discuss these kind of things. \n. Thanks, I just came across it by chance !!\nAlso, I am not as good a Rails developer as you guys, so, I only understood like 10-20 % of what you guys are talking about, but I am glad that someone noticed it & is working on a fix for it. :)\nAlso, if you don't mind, @mamhoff could you please explain to me what is an out-of-sync object graph ? I heard this term for the first time. . Hey @mamhoff thanks for the explanation. I had no clue of those things & I have been using Solidus for the past 8-9 months. :-P\nI guess I still have way lot more to learn. Thanks :)). ",
    "Reddshift": "Going to working on this for Hack days - starting with Products and Variants at @mamhoff 's recommendation.. @mamhoff here is my pull request for Products and Variants - let me know what you think.  All feedback is welcome, wanting to make this as clear and helpful as possible.\nhttps://github.com/solidusio/solidus/pull/1939. Starting on the Shipping documentation.. @mamhoff created a pull request for the Shipping guide: https://github.com/solidusio/solidus/pull/1966\nSince Clarke just announced Stembolt would be hiring a technical writer to do documentation, should I or others continue working on these?. Sounds good @mamhoff -- porting the Spree guides is fairly low effort compared to the extensive work that could be done to take documentation further. I agree that it is worth doing, even just to have some documentation until someone is hired.  I'll try to fit in porting some more.... Good catch - missed this when porting from the Spree version -- irb/console is definitely ruby.  Fixing.. ",
    "benjaminwil": "Hey, just chiming in to mention that there are open pull requests for ported payments documentation (#2388), adjustments documentation (#2459), and zones documentation (#2375), as well as updates to many of the existing Solidus guides (see all my pull requests for a list).\nI would appreciate feedback and criticism from any and all of you.. It looks like everything is working with Rails 5.1.x now, so no roll back would be necessary now.\nIf this actually was an issue, it is now even more trivial. Closing!. Hey @jtme, I just deployed a demo app with custom credentials and was able to log in.\nCould you double-check that you're still unable to do this?. Merged in #2737. My apologies. In my attempt to format the original document consistently, I made this PR much longer than it actually should be - and I introduced some formatting errors as a result, too.. Because my other PRs depend on the changes here in guides/overview-of-shipments.md I won't be able to create additional PRs unless this one is merged.\nMy apologies for botching this round. I'm sure there's a better way to do/organize this.. Okay, I'm going to close this and re-open a new pull request. That one will be a comprehensive everything-about-shipments PR that is well organized\u2014an article for each commit.\nThanks for all the feedback so far. It will not be lost. \ud83d\udc4c. Thanks for this!\nIn case you haven't seen #2353 and #2375, I'm working through all of the existing Solidus documentation and adding more. In the near future I would like to break up this payments documentation into multiple articles.\nI think this would give us more space to provide examples and tutorials, like you pointed out in your comment on the \"Adding your custom gateway\" sub-article.. Thanks for the updates. I would :+1: this.\nThere's still more work to be done here (for example, around getting started with custom payment gateways), but the essentials are covered clearly.\nThanks for your work on this @ccarruitero.. @mamhoff I've fixed the outstanding issues per your review. \ud83d\udc4d Please re-review when you get the chance.. @tvdeyen Hey, I updated the asset management guide per your review. When you have a chance could you re-review?. @tvdeyen Thanks for the review. All of the issues are fixed.. @gmacdougall Thank you for your review. I've addressed all your comments. Next time you have a chance, could you re-review my changes?. @adammathys Thanks for your review. I've addressed your comments. If you could re-review whenever you've got a chance that'd be great. \ud83d\udc4d . Thanks for the review @adammathys. I've committed changes for all your comments.\nIf you could approve that would be great. :+1:. Thanks for the review @adammathys. I've committed changes for all your comments.\nIf you could approve that would be great. :+1:. @avremel Thanks for catching that error. Fixed!. @kennyadsl Thanks for the review. I've addressed all your comments. :+1:. Ah, thanks. I blanked on the master bit. It would have been nice for the Solidus v2.4.2 to have mentioned this in the README since most people use solidus_auth_devise, too. But I guess it's too late.. Thank you. :clap:. I just realized that I need to update this branch with a section about version maintenance and EOL policies.\nEdit: :heavy_check_mark: . @kennyadsl Thanks for the mention :+1: . @kennyadsl Yes, thanks. \ud83d\ude0a. Nice! Thanks for this \ud83d\udc4f . @tvdeyen Thank you for the comments.\nI wonder if a required attribute would complicate product creation and product imports? While I agree that it would improve the admin UX it might be a bigger issue than this PR should address.. @kennyadsl Thank you for pointing this out.\nI am not sure what the best way to deal with placeholder text should be. It may be confusing to use a standard date like 01-01-1985. The placeholder text would also have to account for different date formats if the user is using a format like MM.DD.YY instead. For now, I have just removed the placeholder all together.\nI have instead added a more descriptive tooltip.\n. @kennyadsl Thanks for your patience \u2013 I should dropped those changes before.\nI've now dropped those older commits entirely.. @jhawthorn I have spent some time looking into ways that we can generate REST API documentation from the existing specs, but I haven't come across anything that wouldn't require additional dependencies and DSL-beyond-RSpecland. If you have any recommendations/preferences, I'd be interested to hear about them.\nI'm happy to do any of the work that comes along with making this happen.. This pull request is no longer necessary because #2740 was merged.. I am under the impression that the changelog was just generated from commit messages, except for the major changes block for each version. . @tvdeyen Thank you for the feedback. I think my most recent commit addresses all your comments.. @kennyadsl You should be able to access the https version of the Solidus Guides site now. I\u2019m going to change a few things here and then reopen this. . Fixed! Sorry about that.. No problem. Didn't intend to abandon this, and I fixed that YML \u2013 why couldn't we merge it?. @kennyadsl Thanks for your comments. I just updated the commit to fix the issues you commented on.. Thanks @jacobherrington! I think this is a super valuable addition to the Solidus guides. :+1:\n. So awesome. \ud83c\udfb6. > This is currently not linked anywhere in public guides pages.\nI have a PR open to address the need for multiple tables of contents in the guides: #2770.\nI am happy to pick it up again and rebase it if y'all would consider merging it.. Good call. I also have written another article that outline what a carton is, but I think it should be mentioned in this overview as well.. Absolutely. Thanks for noting this.\nRight now, all of the legacy content uses >80 character lines. I will be pruning these sections in further pull requests. (I'm just superficially breaking up these PRs since there is a lot of content.). Ah, thanks for catching this.\nAre there caveats worth mentioning, then? For example, If you have a \"USA\" and a \"North America\" zone, could risk over-taxing customers if you have poorly configured tax rates.. My bad. This is legacy content and shouldn't be diffed at all. This will be fixed in my new shipment setup examples article.. I'm creating a separate article for the solidus_active_shipping gem, but I can see it belonging either as part of that repository or in an \"Supported extensions\" guide in the future.. My bad: I didn't make any changes here but this (and some other lines) appear in the diff. This is from the legacy shipments article, and it's being cleared out.. Just added a note about this in 753c5ce. Thanks.. I ended up removing most of the content under the \"Match the delivery service's provided name\", but do you mean this whole article? . Thanks for this!. I wasn't 100% clear on this distinction until you brought up Spree::Stock::Package in a comment. I've made a to-do so that this article would clearly make a distinction between packages and shipments. Thanks so much for your reviews.. This is actually on my to-do list!. Right now the [Orders](orders) link here doesn't go anywhere, and we don't have an equivalent page worth linking to yet.. Thanks for this (and your continued patience as I figure this stuff out). \ud83d\udc4d . Aah, you're very right. Not sure how I missed that. \ud83d\ude2a Thanks!. I was just initially confused, since VAT would never \"adjust\" the price. Wanted to make sure it was clear for everyone!. Thanks for this.\nWhat would be the use case for setting the tax_address to be a TaxLocation?. \u2764\ufe0f Agreed. I added this at the bottom of the section. Thank you.. Thanks for catching this @afdev82. Should be shipment-setup-examples.md. I will push an update soon.. Fixed. Thanks!. Thank you. I will also update this in the README.. I actually took this from the README:\n\nYou can also enable fail fast in order to stop tests at the first failure\nFAIL_FAST=true bundle exec rspec spec/models/state_spec.rb\n\nWould you :+1: my removing this from the README as well?\nI would agree that we should remove this if it's common rspec knowledge. Instead I'll just explicitly state to reference the rspec documentation for testing needs.. You actually can't add states or countries from Settings -> Locations -> ... anymore. This needs to be updated.. The italics at *n*th order here messes up the syntax highlighting for the rest of the article, but GitHub renders the Markdown fine, and my text editor's syntax highlighting is fine. Weird?. I added a note about this. :+1:. I am not sure I know the correct answer to this. If the red shirt only comes in one size, then it should be one of the green shirts. Right?\nWould it be best practice to assign the master variant to the \"lowest common denominator\" between the shirts?\nI started working on an example with mugs:\n```\nThe master variant should be the \"lowest common denominator\" between all of your\nvariants. For example, if you have five variants on your mug product that have                                                                                                     \noption types of \"Color\" and \"Size\", as well as different prices, it would be\nadvantageous to set the master variant to the variant that has the most common\ncolor, size, and price.\n| \"Mug\" variant | Color | Size    | Price |\n|---------------|-------|---------|-------|\n| 1             | Green | Regular | $12   |\n| 2             | Green | Large   | $14   |\n| 3             | Red   | Regular | $12   |\n| 4             | Red   | Large   | $14   |\n| 5             | White | Regular | $12   |\nIn the table above, the \"Mug\" variant 1 or 3 would be appropriate master\nvariants. This is because the majority of the variants share values with them\n(\"Green\" or \"Red\", \"Regular\", and \"$12\"). \n```. But beyond what the master variant \"should\" be, I also added this information to the \"Master variants\" section:\nBy default, the master variant is the first variant created for a product.. I added a link to more information about master variants here. It lives in the variants.md article. I've extended that section as well. \ud83d\udc4d Thank you.. You are very right. I've extended the products and variants bullet points here.. Update: Gregor and I chatted privately and sorted this out. Silly me, generic master variants are the way to go.. :-1: My bad.. Thanks Martin! :+1:. :+1: Thanks. Rebased with this change.. Thank you for pointing this out! For now, I will simply remove this item from the list.. @kennyadsl Thanks for pointing this out. Just updated this bit.. There aren't any other guides on this topic yet, so I'm going to add a bit more information here. Thanks for pointing this out!. Thank you. This prompted me to restructure the documentation around returns. All of the RMA-related documentation I wrote now lives in it's own returns/ section, and I've added a stub specifically about Spree::ReturnItems to the inventory overview.\nThere is definitely more to say about RMAs, ReturnItems and other aspects of the returns system. That will have to be added in future PRs.. I just ran through the requirements in this article with a User model that I set up with Devise. If someone was already using Devise for their user model they could use this article to integrate it with Solidus.\nWhy do you feel that mentioning Devise here as an example confuses?. Maybe this is just a very old comment then!\n# Default implementation of User.\n  #\n  # @note This class is intended to be modified by extensions (ex.\n  #   spree_auth_devise)\nWhen I edit this article in my next commits, I'll be sure to update this comment as well.. :joy: Probably not. Thanks for catching that.. No, I think that I should mention that. Thank you!. Good call. Some initial docs I wrote introducing static model preferences was just merged, so I will link there.. I'm trying to check that this is possible now. Would it make sense to change object to order for this example? Or is the whole example kind of unrealistic, maybe?. Good call. Fixed!. I think that \"Percent Per Item\" makes sense in the admin UI. I think I just wanted to note this in case someone was looking for \"Percent on Line Item\" in the admin and weren't finding it.. Yes, good call. Thank you!. Done! Thanks for the suggestion.. :+1: . We should add a newline after this paragraph to separate it from the paragraph below.. Missing state! invalid. I agree, we could have alternatively merged the paragraphs. But they are about different states. . I am going to include an example like this, thank you.. Would making \"Available On\" input required complicate the product creation process in other ways?\nI was hesitant to suggest this for this PR as I think it is another can of worms.. Thank you for making a note of this. While the options value is created by the Spree::Payment::Processing#gateway_options the way that I wrote this didn't really make sense.\nI'm going to simplify it shortly and leave explanations to the \"Gateway options\" section below.. I caught this in #2717 . Good call, thank you. Fixed.. I'm not sure how this example would be applied to shipping in a zones context. But I do agree that this example should be added elsewhere.\nThe example here that I am providing is generic but clear.. Thanks for drawing attention to this, I will tweak this sentence.\nBut I think that this is expected behavior and doesn't need to be explained.\nIf a customer enters a new address in their second order, then the new address \"updates\" the address on file that is exposed in the backend UI.\nAnd at the moment, the backend UI doesn't expose the list of old or alternative addresses.. Thanks for pointing this out. Going to make sure that we get https today.. Thank you. This was intentional, but I think that it makes more sense to indent these lists this way:\n- If returning, Solidus determines whether the customer is a guest.\n    - If customer was logged in during a previous session, Solidus determines\n      whether customer should be logged in again.\n  - If new, `guest_token` cookie might be generated for the customer.\nBecause the \"If customer was logged in...\" item relates specifically to the returning customers item above.. Thank you, I had overlooked that. I will be adding a new list item to account for this functionality.. I will run through an order and double-check this now. Thank you.\nMy understanding was that a sold stock item is no longer counted as on hand, because it has been sold and will be shipped.\n. I just ran through an order. The count_on_hand decreases as soon as an order has been placed \u2013 so before the shipment is shipped.. Oops, thank you! Fixing.. Small typo. I think this should say [supported extensions] rather than [supported extension].. I believe the syntax you are intending to use here is [SimpleCov][simplecov].\nSee reference-style links in the Markdown spec.. The contributing article says that the Solidus guides use sentence-style capitalization (Getting started) for article titles and subheadings, not title-style (Getting Started). See https://guides.solidus.io/contributing.html\nIf we change this, we should change all of the subheadings throughout the guides, and update the contributors guide as well.. I see what you mean now. Carry on as you see fit. \ud83d\udcaf . ",
    "AndreiMotinga": "@sechix, post you gemfile and heroku log where result occurs. \nalso check that you have all the environment variables set properly oh heroku. @sechix \nin my case, aws settings copied from wiki sorta broke things \nin aws settings I changed \npath:          \"/products/:id/:style/:basename.:extension\",\n    default_url:   \"/products/:id/:style/:basename.:extension\",\n to \npath:          \"/:class/:id/:style/:basename.:extension\",\n    default_url:   \"/:class/:id/:style/:basename.:extension\",\nIt might be the case for you too.... \nAlso, since images aren't read,  what is the error in browser console? . I've just noticed the same problem.  There are no errors. \nit seems that images are stored in filesystem instead of being uploaded to aws. I'm not sure how to troubleshoot. Any help? . @jhawthorn, I'm trying to use cdn \n```\nSpree.config do |config|\n  attachment_config = {\n    s3_credentials: {\n      access_key_id: ENV.fetch(\"S3_ACCESS_KEY\"),\n      secret_access_key: ENV.fetch(\"S3_SECRET\"),\n      bucket: ENV.fetch(\"S3_BUCKET\")\n    },\nstorage:        :s3,\ns3_headers:     { \"Cache-Control\" => \"max-age=31557600\" },\ns3_protocol:    \"https\",\ns3_region:      ENV.fetch(\"S3_REGION\"),\nurl:            \":s3_alias_url\",\ns3_host_alias:  ENV.fetch(\"S3_HOST\"),\nbucket:         ENV.fetch(\"S3_BUCKET\"),\n\nstyles: {\n  mini:     \"48x48>\",\n  small:    \"100x100>\",\n  product:  \"240x240>\",\n  large:    \"600x600>\"\n},\n\npath:          \"/:class/:id/:style/:basename.:extension\",\ndefault_url:   \"noimage/:style.png\",\ndefault_style: \"product\"\n\n}\nattachment_config.each do |key, value|\n    Spree::Image.attachment_definitions[:attachment][key.to_sym] = value\n  end\nend unless Rails.env.test?\n```\njust to be clear, I don't have the setting you mentioned. . @jhawthorn, @jasonfb, \nhttp://sparky.md/   - you can login with test@test.com and password\nI've just tried and it seems like images on products are loaded properly, while images on taxons are stored in filesystem. \n. @jasonfb, this is exactly the problem. \nwhen uploadoing images on products - they are stored properly on CDN\nfor taxons they are stored in filesystem. \nworks \nhttp://sparky.md/admin/products/li-ion-br2-10-8li-hd/images - admin product images \nhttp://sparky.md/ru/products/li-ion-br2-10-8li-hd  - product page \ndoesn't seem to be working \nhttp://sparky.md/admin/taxonomies/7/taxons/60/edit -  uploading image on taxon store locally \nP.S The admin panel is in English. . @jasonfb, \nI will definitely try your previous advice on removing cdn, and using aws directly. Will do later today. . sechix, I understand your frustration. I still don't understand how to use cdn with heroku. \nSome resources say that cdn should point to your domain, others that is should point to bucket. It's unclear. \nIf it points to domain, then it won't find images. \nif it points to bucket, then you gotta have to have all the assets compiled and uploaded to bucket each time you deploy your app... I didn't find lots of blog posts/resources doing that... so.. to me it's still unclear. . @jasonfb,  Thank you for such detailed response, it actually cleared something for me.\n In general, the approach you described is the one I use.  I think my confusion originated from \n\"enabling serving static files\" on heroku was somewhat of a \"not the appropriate way of doing things\", yet I couldn't figure out, how can you do it, if those are disabled... \nIt never occurred to me, that you could use 2 separate cloudfronts.   What I did usually was just serve images from s3 via cdn, and assets locally. \nThat being said, I think the issue I have doesn't have anything to do with my setup. After all images are uploaded and stored properly... But not icons. \nhere's default solidus app - https://github.com/AndreiMotinga/am-solidus-default-store\nhere's that app on heroku - https://am-solidus-default-store.herokuapp.com\nUploading images on products works as expected. \nImages on taxonomies, are store in filesystem. \nyou can take a look at app on github, It has few gems on it, but nothing that should affect this issue. \nyou can also take a look at aws.rb - https://github.com/AndreiMotinga/am-solidus-default-store/blob/master/config/initializers/aws.rb\nAs to the using it without CDN... Wiki is not clear on which gems should be added to gemfile \naws? fog? paperclip ?   should paperclip setting also be added?  where? \nI'm gonna dig deeper, but as of now, documentation is somewhat unclear. \n. @jhawthorn,  with this \n```\nSpree.config do |config|\n  attachment_config = {\n    s3_credentials: {\n      access_key_id: ENV.fetch(\"S3_ACCESS_KEY\"),\n      secret_access_key: ENV.fetch(\"S3_SECRET\"),\n      bucket: ENV.fetch(\"S3_BUCKET\")\n    },\nstorage:        :s3,\ns3_headers:     { \"Cache-Control\" => \"max-age=31557600\" },\ns3_protocol:    \"https\",\ns3_region:      ENV.fetch(\"S3_REGION\"),\nurl:            \":s3_alias_url\",\ns3_host_alias:  ENV.fetch(\"S3_HOST\"),\nbucket:         ENV.fetch(\"S3_BUCKET\"),\n\nstyles: {\n  mini:     \"48x48>\",\n  small:    \"100x100>\",\n  product:  \"240x240>\",\n  large:    \"600x600>\"\n},\n\npath:          \"/:class/:id/:style/:basename.:extension\",\ndefault_url:   \"noimage/:style.png\",\ndefault_style: \"product\"\n\n}\nattachment_config.each do |key, value|\n    Spree::Image.attachment_definitions[:attachment][key.to_sym] = value\n  end\nend unless Rails.env.test?\n```\nwe update keys on Spree::Image, however Taxon is not setup properly. \nspree/taxons.rb \nmodule Spree\n  class Taxon < Spree::Base\n    ....\n    has_attached_file :icon,\n      styles: { mini: '32x32>', normal: '128x128>' },\n      default_style: :mini,\n      url: '/spree/taxons/:id/:style/:basename.:extension',\n      path: ':rails_root/public/spree/taxons/:id/:style/:basename.:extension',\n      default_url: '/assets/default_taxon.png'\n    ...\nSo Taxon should probably be configured as well? any other models? . @jhawthorn, should wiki be updated with \n```\nSpree.config do |config|\n  attachment_config = {\n    s3_credentials: {\n      access_key_id: ENV.fetch(\"S3_ACCESS_KEY\"),\n      secret_access_key: ENV.fetch(\"S3_SECRET\"),\n      bucket: ENV.fetch(\"S3_BUCKET\")\n    },\nstorage:        :s3,\ns3_headers:     { \"Cache-Control\" => \"max-age=31557600\" },\ns3_protocol:    \"https\",\ns3_region:      ENV.fetch(\"S3_REGION\"),\nurl:            \":s3_alias_url\",\ns3_host_alias:  ENV.fetch(\"S3_HOST\"),\nbucket:         ENV.fetch(\"S3_BUCKET\"),\n\nstyles: {\n  mini:     \"48x48>\",\n  small:    \"100x100>\",\n  product:  \"240x240>\",\n  large:    \"600x600>\"\n},\n\npath:          \"/:class/:id/:style/:basename.:extension\",\ndefault_url:   \"noimage/:style.png\",\ndefault_style: \"product\"\n\n}\nattachment_config.each do |key, value|\n    Spree::Image.attachment_definitions[:attachment][key.to_sym] = value\n    Spree::Taxon.attachment_definitions[:icon][key.to_sym] = value\n  end\nend unless Rails.env.test?\n```\n? . sechix, join solidus slack.  if you want to, I'd be happy to help you if I can. . @softr8, that indeed helped, thank you. I should have figured it out myself.\nI wasn't expecting it, since I got other app ( new and clean) without this problem, so my guess was that it's cause of some bad data. \nI'm guessing, maybe cause this old/broken app has some mailers in it, and other doesn't... \nAnyhow, thank you. . So it's been 2 days, any reflection on this? \n. :). this pull to solidus_globalize is not necessary with this change . I'd like to take a stab at it. Since I'm just starting out with open source,  any advice or guidance on how I should approach this would be appreciated. . > I'm not totally comfortable with us making sweeping changes simply because another library is broken.\nI agree, it makes sense. However, in this particular case, the change required is very simple and won't change anything about the solidus, other than make it slightly more flexible.  \nPlus, even when some other translation project will appear, will it face the same problem ?. ",
    "shawno": "Tested with v2.2 and got the same retults. . ",
    "spaghetticode": "@jhawthorn thanks for the insight. \nAs you correctly wrote those dynamic finders are not actually deprecated right now, but according to https://github.com/rails/rails/blob/master/activerecord/lib/active_record/base.rb their usage is already sort of discouraged:\n# == Dynamic attribute-based finders\n  #\n  # Dynamic attribute-based finders are a mildly deprecated way of getting (and/or creating) objects\n  # by simple queries without turning to SQL. They work by appending the name of an attribute\n  # to <tt>find_by_</tt> like <tt>Person.find_by_user_name</tt>.\n  # Instead of writing <tt>Person.find_by(user_name: user_name)</tt>, you can use\n  # <tt>Person.find_by_user_name(user_name)</tt>.\nI still see replacing mildly deprecated code an improvement, however small it might be, with the immediate bonus that the only available internationalization gem for solidus will start to work well again.. @mamhoff That's a good point, thank you. I changed the commit description and the PR title as well with a more descriptive text.. @mamhoff sorry I took the commit message matter too lightly. I hope it's now fine with you.. The reason is due to the following code in backend/app/controllers/spree/admin/products_controller.rb:105: \n@collection = @collection.with_deleted if params[:q].delete(:deleted_at_null) == '0'\nI would change it as follow: \n@collection = @collection.with_deleted if params[:q][:deleted_at_null] == '0'\nbefore opening a new PR with my changes I would like to ask you if there's a good reason for deleting deleted_at_null from params[:q] in that line. Thanks!. @mtomov I'm not sure I completely understood your last sentence. Did you mean that, instead of using deleted_at_null we may use a (new?) scope on the model, which we also use as a ransackable scope, and then we also change the param name on the erb view?\nAnyway, I choose the simplest path for my PR: remove the delete method call. I also added a simple controller spec for it.\n. @mtomov with a little help from @kennyadsl I think I finally got your point. I am working on a new implementation that uses ransackable scopes, which has the extra benefit of tidying up a bit the code in the controller. I think that's an improvement over my first version, so I will update my PR ASAP. But if you don't prefer the new version then I can still go back to the first proposal ;). Thanks for the suggestion, I've just added also an expectation in an existing feature spec as well.. @softr8 thanks for this PR \ud83d\udc4f \nCan you please rebase this with current master?. @kennyadsl thank you for the answer. \nSo, you're basically saying that the procedure is right when it creates 2 payments, the first with zero amount that is invalidated when the second, the real one is created. \nI can understand debugging may benefit from this process, and for sure Solidus devs are more knowledgeable than me on managing ecommerce checkouts, so I trust your opinion on this matter. \nAgain thank you for sharing the information. \n. I am now thinking I should close this PR. I believe that the simplest way to solve my issue is to customize the BaseController.unauthorized_redirect lambda where necessary, just like the gem solidus_auth_devise does in https://github.com/solidusio/solidus_auth_devise/blob/master/lib/spree/auth/engine.rb. @kennyadsl regarding your question about routes, what you wrote is certainly true, but I think I am missing something as I don't see why this can be a problem. Can you explain the reason?. I think I understand your concerns. Looking at a concrete example, spree_auth_devise file lib/frontend/spree/users/show.html.erb overwrites the new file frontend/app/views/spree/users/show.html.erb. \nOne way to look at this, is to consider the new files in Solidus codebase as sensible defaults that are naturally overwritten by the current version of solidus_auth_devise.  After all, their code is the same right now, so no harm done. \nIssues arise when one of the two files changes. \nSolidus changes will be masked by spree_auth_devise file as long as that file exist also in the gem. I think this first scenario is not a big issue, again as I'd rather consider Solidus file as (hidden) default, at least initially. spree_auth_devise is still in charge.\nIMHO a more significant issue is when the file inside spree_auth_devise gets updated, as the updates should probably also be manually backported to Solidus' file.\nI think one way to minimize code backporting may be to address all current issues in spree_auth_devise, this should give us some stability, and basically freeze that gem's development. \nAs soon as a new version of Solidus with the new file is released, a new version of  spree_auth_devise stripped of the very same file can be released. The new gem version would require the new Solidus release, of course. \nWhat do you think? Does this strategy seem too clumsy to you?\n. @kennyadsl \ud83d\udc4d on deprecations/warnings when an old version of solidus_auth_devise is found.. @benjaminwil can you rebase this with master?\nAlso, I think that while sorting translation keys is a good idea, it also makes harder to see actual changes with this PR.. @mayanktap after the push --force I see there are some spurious changes in the commits for CHANGELOG.md file. Can you rework your commits and remove these changes?\n. I tried to reproduce the issue and I think that as of today it's gone. \nWith a single item purchase I followed the steps and I got the shipment destroyed, the stock movement that replenishes the stock created and the payment state changed to Credit owed\nSame happens with 2 different items, the only difference is this time the shipment does not get destroyed, which is right.\nDid not check all the code details, but I noticed some action happens in  Spree::OrderInventory#remove_from_shipment where the shipment is destroyed and the stock location replenished.\n. @peterberkenbosch thank you for this PR \ud83d\udc4f \nCan you confirm this PR is ready for review? I see in the description there's an unchecked checkbox, and also this comment suggests me that it's not... am I right?. @aldesantis I think that a good way to add custom configuration, especially when developing a Soliuds plugin, may be by inheriting from Spree::Preferences::Configuration class, like Solidus does. That's the path I followed when developing the solidus_customer_images plugin, see this PR for some real implementation.. I'm no expert here, so please forgive me if this is nonsense. \nI share @kennyadsl's concerns in regards to not using the state machine. Having a state machine and being (very easily) able to not follow it kind of invalidates it, IMHO. \nAlso, in general I try to follow the principle \"there should be only one way to do it\" when it comes to complicate things. This is because having multiple paths to achieve one goal can easily lead to confusion and inconsistencies. \nI wonder if the scope of this PR can be limited to previous states. To me it seems kinda less dangerous to revert the state of the order only to previous ones.. @kennyadsl I updated the code according to your comments, adding a couple of commits to facilitate your understanding of the changes. \nWhen it's ok for you I'd like to rebase/squash and update the PR description/commit message in order to reflect the latest changes introduced. Just let me know when it's fine for you (or please add more comments if something is still not OK \ud83d\ude38 ) . The issue is caused by rails caching the assets... you can fix the issue simply by removing the content of tmp/cache/assets/ directory. \nWhy is the issue happening? The routes used in the backend for JS API calls are defined and stored in the JS object Spree.routes, youn can inspect its contents in the browser javascript console.\nThese URLs prefix comes from Spree.pathFor defined in core/app/assets/javascripts/spree.js.erb:\nSpree.mountedAt = function() {\n  return \"<%= Rails.application.routes.url_helpers.spree_path(trailing_slash: true) %>\";\n};\nWhile Rails.application.routes.url_helpers.spree_path changes when you change the Spree mount path, this JS file, once generated, is not going to change, as its MD5 checksum is still the same. So the cached version in the tmp/cache/assets/ directory is going to be used.. @jacobherrington I think this can be closed. @RyanQuey acknowledged the answer was valid on StackOverflow. . @mayanktap I see there are three commits, two of them seems to me to be merge commits. Can you remove them? \nThis gist may help if you have problems updating the code on your local fork.. @mayanktap I see there are three commits, two of them seems to me to be merge commits. Can you remove them? \nThis gist may help if you have problems updating the code on your local fork.. @mayanktap I'm not sure I understand your last comment. the ideal situation for this PR is to have only one commit, this one which includes both the code and the spec. I think both code and spec can live in a single commit as they're minimal. \nThe other 2 commits should be removed, as they are merge commits that don't belong to this PR.\nI hope this helps :)\n. @mayanktap I'm not sure I understand your last comment. the ideal situation for this PR is to have only one commit, this one which includes both the code and the spec. I think both code and spec can live in a single commit as they're minimal. \nThe other 2 commits should be removed, as they are merge commits that don't belong to this PR.\nI hope this helps :)\n. @jtapia thank you for this PR.\nThe channel attribute is not set explicitly, but at line 32 order.update_attributes!(params) adds it to the order.\n. @jtapia thank you for this PR.\nThe channel attribute is not set explicitly, but at line 32 order.update_attributes!(params) adds it to the order.\n. @jtapia I think the tests don't verify that the payment source is correctly saved. They only test that the controller action returns a 201 or a 404.\nAlso, I ran the tests commeting the code you added in Spree::Api::OrdersController and they still pass, so I'm a bit puzzled \ud83e\udd14... did not investigate more though. \n. @jtapia I think the tests don't verify that the payment source is correctly saved. They only test that the controller action returns a 201 or a 404.\nAlso, I ran the tests commeting the code you added in Spree::Api::OrdersController and they still pass, so I'm a bit puzzled \ud83e\udd14... did not investigate more though. \n. @jtapia let's wait for somebody from the core team to chime in for that.. @jtapia let's wait for somebody from the core team to chime in for that.. @jtapia thanks for the PR.\nI checked the spec, and it passes regardless of the presence of the fix, so my guess is that the changed code is not exercised by it. \nCan you verify this? Thank you!. @jtapia thanks for the PR.\nI checked the spec, and it passes regardless of the presence of the fix, so my guess is that the changed code is not exercised by it. \nCan you verify this? Thank you!. count me in for option 1 \ud83d\udc4d . @mdesantis I'm not sure about that. I feel that this is Ruby so there's no particular benefit in adhering to an interface/naming that it's not strictly ours. Also, on off trigger are mainly jQuery AFAIK .\nAnother reason why I'm not much into this change is that while I like easy to type (short) and remember methods, I learned in the past that they can be a PITA to search in a codebase, especially when they're as generic as on and off can be.. @mdesantis I'm not sure about that. I feel that this is Ruby so there's no particular benefit in adhering to an interface/naming that it's not strictly ours. Also, on off trigger are mainly jQuery AFAIK .\nAnother reason why I'm not much into this change is that while I like easy to type (short) and remember methods, I learned in the past that they can be a PITA to search in a codebase, especially when they're as generic as on and off can be.. I've been working a bit more on this implementation. The main improvements are:\n\n\nSpree::Event now delegates the bulk of its methods to the adapter, which defaults to Spree::Event::Adapter::ActiveSupportNotifications. This will make super-easy switching to a different implementation by simply changing the adapter: \nSpree::Event.adapter = Spree::EventBus\n\n\nSpree::Event.listeners returns a hash with all Solidus related subscriptions, grouped by event name. The implementation is again delegated to the adapter, as ActiveSupport::Notifications already has a nice way for managing this\n\n\nSpree::Event.unsubscribe now accepts a subscription object (it will unsubscribe only that subscription) or an event name (it will unsubscribe all subscriptions to that event)\n\n\nsome specs for Spree::Event module in order to improve coverage. I've been working a bit more on this implementation. The main improvements are:\n\n\nSpree::Event now delegates the bulk of its methods to the adapter, which defaults to Spree::Event::Adapter::ActiveSupportNotifications. This will make super-easy switching to a different implementation by simply changing the adapter: \nSpree::Event.adapter = Spree::EventBus\n\n\nSpree::Event.listeners returns a hash with all Solidus related subscriptions, grouped by event name. The implementation is again delegated to the adapter, as ActiveSupport::Notifications already has a nice way for managing this\n\n\nSpree::Event.unsubscribe now accepts a subscription object (it will unsubscribe only that subscription) or an event name (it will unsubscribe all subscriptions to that event)\n\n\nsome specs for Spree::Event module in order to improve coverage. @skukx thanks for your answer to @tvdeyen questions, what you wrote is much similar to what floats in mind \ud83d\udc4d\n\n\nStill I'd like to expand a bit on the questions: \n\nWhy wrap the code in a block for instance? Active support uses this to instrument the code, but we don\u2019t have to\nI'm not 100% sure what you mean here... if are you referring for example to the block enclosed in this:\nruby\nSpree::Event.instrument 'order_finalize', order: self do\n  all_adjustments.each(&:finalize!)\n  # ...\nend\nthen yes, there's no real need to wrap the code inside a block. We could move the event instrumentation code at the bottom of the method, but I personally prefer the other way for some reasons:\n the block clarifies what actions are part of the order finalization process (you may argue that in this specific example the method is already named  finalize!, so there's no need to add another wrapper, but this is just a basic example... if I had to stick to a convention I'd wrap rather than not, at the cost of being sometimes redundant)\n you get the ability to do what Rails does, for example calculating the time required to perform the action (the code inside the block)\n\nAnyway, I think both ways can be used depending on the situation\n\nWe need to have more events than just one when something updates.\n\nThe examples I provided are just examples that show how to change some previous code to something that is still very similar but can emit events we can leverage on. The order finalization event was a low-hanging fruit, as the method was already there, and it made sense being able to subscribe to an event about order finalization. \nOf course I agree this is just a step in the process, so there's much more that can be done, but I personally don't feel comfortable in modifying the existing processes to that extent, at least not now. \nMaybe someone more experienced than me with Solidus and its processes can come up with better examples that go in that direction. \n\nSpree::Event.instrument does not seem like a good name for dispatching events. fire, commit, dispatch seem better candidates IMO\n\nI also rather prefer a different naming, but I'd stick with ActiveSupport names for these reasons:\n we're all Rails programmers, so it makes totally sense to me using the same interface (many of us are possibly already accustomed to it)\n ATM the only provided adapter is for ActiveSupport::Notification, so to me it makes sense sticking with its interface\n* I don't know how successful the ActiveSupport::Notification adapter is going to be, but if it is going to be the default one, I think choosing the same interface makes sense\n. @skukx thanks for your answer to @tvdeyen questions, what you wrote is much similar to what floats in mind \ud83d\udc4d\nStill I'd like to expand a bit on the questions: \n\nWhy wrap the code in a block for instance? Active support uses this to instrument the code, but we don\u2019t have to\nI'm not 100% sure what you mean here... if are you referring for example to the block enclosed in this:\nruby\nSpree::Event.instrument 'order_finalize', order: self do\n  all_adjustments.each(&:finalize!)\n  # ...\nend\nthen yes, there's no real need to wrap the code inside a block. We could move the event instrumentation code at the bottom of the method, but I personally prefer the other way for some reasons:\n the block clarifies what actions are part of the order finalization process (you may argue that in this specific example the method is already named  finalize!, so there's no need to add another wrapper, but this is just a basic example... if I had to stick to a convention I'd wrap rather than not, at the cost of being sometimes redundant)\n you get the ability to do what Rails does, for example calculating the time required to perform the action (the code inside the block)\n\nAnyway, I think both ways can be used depending on the situation\n\nWe need to have more events than just one when something updates.\n\nThe examples I provided are just examples that show how to change some previous code to something that is still very similar but can emit events we can leverage on. The order finalization event was a low-hanging fruit, as the method was already there, and it made sense being able to subscribe to an event about order finalization. \nOf course I agree this is just a step in the process, so there's much more that can be done, but I personally don't feel comfortable in modifying the existing processes to that extent, at least not now. \nMaybe someone more experienced than me with Solidus and its processes can come up with better examples that go in that direction. \n\nSpree::Event.instrument does not seem like a good name for dispatching events. fire, commit, dispatch seem better candidates IMO\n\nI also rather prefer a different naming, but I'd stick with ActiveSupport names for these reasons:\n we're all Rails programmers, so it makes totally sense to me using the same interface (many of us are possibly already accustomed to it)\n ATM the only provided adapter is for ActiveSupport::Notification, so to me it makes sense sticking with its interface\n* I don't know how successful the ActiveSupport::Notification adapter is going to be, but if it is going to be the default one, I think choosing the same interface makes sense\n. @tvdeyen @mdesantis thank you for your feedback.\nAs no other feedback came supporting my opinions I decided it was best to follow your suggestions. So I removed the blocks in the examples, and renamed Spree::Event::instrument as Spree::Event::fire.. @tvdeyen @mdesantis thank you for your feedback.\nAs no other feedback came supporting my opinions I decided it was best to follow your suggestions. So I removed the blocks in the examples, and renamed Spree::Event::instrument as Spree::Event::fire.. @kennyadsl I'm still kind of uncertain. \nI mean, there was no real reason in the first place for these specs to be broken, in fact most of the time they were green anyway... apart from the real issue I fixed with the second commit (which anyway was not relevant for the  original appear_before failing check, as appear_before uses the unscoped page.body) I could not find something deterministic in the failures.\nI think only the future can make us certain about this.. @kennyadsl I'm still kind of uncertain. \nI mean, there was no real reason in the first place for these specs to be broken, in fact most of the time they were green anyway... apart from the real issue I fixed with the second commit (which anyway was not relevant for the  original appear_before failing check, as appear_before uses the unscoped page.body) I could not find something deterministic in the failures.\nI think only the future can make us certain about this.. Sorry for the noise, opened by mistake \ud83d\ude1e. Sorry for the noise, opened by mistake \ud83d\ude1e. After some input from @aitbw about the possible behavior regarding the failing spec, it seems reasonable that when a single payment exists and it is marked as void then the order payment status changes to Failed. \nOn the other hand, when there are other pending payments, the state remains as Balance Due.\nSo I added one more spec (and did some refactoring later) in order to properly expose this behavior.. After some input from @aitbw about the possible behavior regarding the failing spec, it seems reasonable that when a single payment exists and it is marked as void then the order payment status changes to Failed. \nOn the other hand, when there are other pending payments, the state remains as Balance Due.\nSo I added one more spec (and did some refactoring later) in order to properly expose this behavior.. I had to change the code as shown or the specs would fail. \nThe reason behind this is unclear to me, as I didn't expect that changing only the message name (from :find_by_number! to :find_by!) would make the specs to fail, but that's what happens.\nThe relevant line for that before block is:\n@order = Spree::Order.includes(:adjustments).find_by_number!(number: params[:order_id])\nSpree::Order.includes(:adjustments) is not an instance of Spree::Order, but an instance of Spree::Order::ActiveRecord_Relation, so I am puzzled about how it worked before my changes.. Thank you for the suggestion, receive_message_chain did the trick indeed. I think the best thing for me, with my limited knowledge of what is happening here, is to revert the code to what it was before.. @kennyadsl I think your note makes sense, that code is not necessary. I'm changing the code soon.. \ud83d\udc4d \n. \ud83d\udc4d . Yes, the goal is to revert the order status to delivery, and there is no apparent need to restart from the cart state, but my guess is that using #restart_checkout_flow and add one #next! call may be better, at least in the long run, as #ensure_updated_shipments might develop in a more complex method that adds more (required) behavior to the restarting process. I'd rather follow the path than create a new one with code such as @order.update state: :delivery or someting similar.\nOn the other side what makes me frown a bit is the @order.next! line, as it may have one meaning today (advance the order state to delivery) but that can change in the future. \nMaybe the best thing would be to restart_checkout_flow and remove the next!.\nI'm not sure about what's the best solution, so I'm committed to following the advice of people with a better understanding of the checkout process and its intricacies.. @kennyadsl It's not necessarily assuming that the following step is the last... but it must be executed after the order passed the delivery step, for some reasons.  \nI'll share some context regarding why I added this if clause, I think it may help us in finding a better solution for the issue you exposed. \nThe reason is that, without that if, this spec fails. The spec seems to be still relevant to me, so adding the if allowed me to add the functionality while still keeping the existing behavior.  \nToday I tried to dig deeper in the issue regarding the spec mentioned above, and this is what I found out. After moving my before_action to the end of the chain things improved a little, but not enough. \nThe reason for having that specific if is that the before_action CheckoutController::before_payment may manipulate the order, specifically these lines:\nruby\n        @differentiator = Spree::Stock::Differentiator.new(@order, packages)\n        @differentiator.missing.each do |variant, quantity|\n          @order.contents.remove(variant, quantity)\n        end\nBesides, the line @order.contents.remove(variant, quantity) has the side effect of changing the order state from payment to address \ud83e\udd14. Have not checked why, but I guess some ActiveRecord callback is responsible for that. \nMissing contents must be removed before running the new before_action, or behavior will change, and as said before, the removal happens only when the customer tries to see the checkout/payment page, which happens after delivery is completed. I think the state ordering delivery -> payment is quite robust, as generally order total should be calculated only after shipping charges and taxes are known, both depending on addresses. But YMMV, so robust may not be enough.\nAnother option would be to move the new code in the before_payment method, so it's executed when it starts to be relevant, but that would limit its execution only to that precise step, eventually limiting its usefulness, that's why I think this is not a viable solution. \nThe current solution has the strong disadvantage that @order.passed_checkout_step?('delivery') does not make clear why the step must be passed, and the strong connection with the existing before_payment method. \nA different approach may be to leverage the existing code in before_payment and change the if to this, for example:\nruby\n      packages = @order.shipments.map(&:to_package)\n      @differentiator = Spree::Stock::Differentiator.new(@order, packages)\n      if @differentiator.missing.empty?\n      # ...\nThis way, there's no more explicit dependence on order steps and their names. What do you think? . good catch! \ud83d\udc4d . Specs pass because they don't exercise the path that was wrong. I'll fix the path and add another test for that branch of the if.. You're right, something went wrong with my cut & paste refactoring. It should be fine now, thank you for spotting the bug \ud83d\udc1b . I suppose the number of promotions might be quite high in some databases. In that case find_each should  work better than each. There's also this instance of each that can be replaced with find_each. Sorry for not finding it earlier. . I think that, by defining this method here, you're polluting the main namespace. I think that this method can be moved inside the Rspec.feature block or, since this method is used only once here, it could be removed and the code inlined directly where it's used.. @rubenochiavone I think this example readability may benefit from using Rspec implicit subject. In Rspec the default subject is an instance of the class being specified (similar to described_class.new(args) but without any arguments... see here):\nit { expect(subject).to be_invalid }\nor, even more concisely:\nit { is_expected.to be_invalid }. As present? is !blank? (see here) then  this can become if coupon_code.blank? || promotion.blank?. @mdesantis good catch! (the previous version was not scoped on the current order) \nBut I think that using ::where would work better than #select: \nruby\n@order.inventory_units.where(id: inventory_unit_ids)\nAlso, when using where I think there is no need to do map(&:to_i). Just a minor annoyance, but I think that Spree::Payment.new.redirect_url would raise an error, as payment_method is nil. I think that the condition should be a bit different Now it's verified when the action is credit and the payment is not completed. I think it should be:\n<% if action == 'credit' && payment.completed? %>\nas we want to show the button only when the payment is complete. I think this if condition is responsible for most (if not all) the failing specs, I think it should be different.\nWhat's happening now is that, when all previous conditions are not met, then the action link is printed only if the payment is void or invalid.\nI guess that among these actions that are filtered out by the conditional there's something that should be printed anyway. These actions come from this line:\n<% allowed_actions = payment.actions.select { |a| can?(a.to_sym, payment) } %>. Not sure why it happens, but when using  :rack_test driver expect(page).to have_selector '.sort_link.desc' fails. It always finds sort_link.asc only.\nThese classes don't seem to be changed by javascript, as clicking the link generates a page reload, so I can't explain why:\nruby\nCapybara.current_driver = :selenium_chrome\n=> :selenium_chrome\nvisit '/admin/users?q[s]=created_at+desc'\n=> nil\nexpect(page).to have_selector '.sort_link.desc'\n=> true\nCapybara.current_driver = :rack_test\n=> :rack_test\nvisit '/admin/users?q[s]=created_at+desc'\n=> nil\nexpect(page).to have_selector '.sort_link.desc'\nRSpec::Expectations::ExpectationNotMetError: expected to find visible css \".sort_link.desc\" within #<Capybara::Node::Element tag=\"table\" path=\"/html/body/div[5]/div/div/table\"> but there were no matches. I think that, since you're using payment_method only once, you can inline this let directly where it's used and save one line without compromising readability: \nruby\namount: '10.0',\npayment_method: create(:payment_method).name,\nsource: {. I think js: true is not needed for these specs. I think that this spec would benefit from a context that explains what's happening here, for example\ncontext \"when payment_method is missing\" do\n. I think it's worth expanding a bit the expectations for this spec. The title says that it creates a payment but actually here we just check that the response is successful. I think adding something like this may be an improvement: \npayment = json_response['payments'].first\nexpect(payment['amount']).to eql \"10.0\"\nexpect(payment['source']['last_digits']).to eql \"1111\".  \ud83d\udc15 the file is updated, but the hound did not acknowledge the change... resolving myself.  \ud83d\udc15 the file is updated, but the hound did not acknowledge the change... resolving myself. \ud83d\udc4d I think making this configurable is a nice addition\nRegarding the naming, I think both are fine but yes, probably suffix is more common. \ud83d\udc4dmakes sense. I meant that this code (the initializer callback) could be moved to another gem, for example to a solidus extension/part that is responsible of sending emails. \nMore in general adding subscriptions using an initializer seems to me reasonably simple and convenient, it may be the standard way to do this... what do you think?. Yes, that's the reason why I chose the suffix. Sticking with conventions is usually the best choice \ud83d\udc4d . I guess it mostly depends on specific situations. The main advantage of using an adapter is that you can easily change the adapter at runtime and still call the same interface and get the work done. \nIf you are thinking about any specific implementation that may work better in this situation then please share it, all improvements are welcome :). Yes, maybe. The benefit I can see for using constants is that we can kind of document all the events at the top of each class.  It would be easier to spot all of them. Do you have other benefits in mind? \nThere's no hard constraint that would force devs to use constants, so the rule can be easily bypassed. A rule easily bypassable is usually not worth much.\nAFAIK Rails codebase does not use any constant with ActiveSupport notifications, so maybe we can use the same direct approach without loosing much? Still pondering our options.... This is a stale comment. \ud83d\udc4d I agree constants are stronger than simple strings, but constant renaming and behavior changes may anyway break things in the future. I'm still thinking about other ways to make this more robust. Let's wait for some other feedback on this, thank you!. Sure, I hope this clarifies the spec. \nThis line adds a subscription to the event. When the event is fired item.do_something will be called:\nruby\nlet!(:subscription) { Spree::Event.subscribe(subscription_name) { item.do_something } }\nin the before block a new subscription is added, so there's going to be a total of two subscriptions for the event:\nruby\nSpree::Event.subscribe(subscription_name) { item.do_something_else }\nBut before firing the event, we unsubscribe the first subscription:\nruby\nsubject.unsubscribe subscription\nLater the rspec example verifies that the first block is not called (subscription removed), but it verifies that the second one is. This also serves the purpose of checking that when you remove a subscription all other subscriptions are still in place. . They mean the same thing \ud83d\ude04 but surely I agree it's better to be consistent with naming also here \ud83d\udc4d . \ud83d\udc4d . ",
    "picazoH": "nice PR :clap: thank you @spaghetticode . ",
    "swively": "On it!. @jhawthorn  and @cbrunsdon  expressed negativity towards Spree::Backend::Callbacks, so I've avoided using one in the controller in this case\n. Thank you for the feedback, Jordan! Forgive me, I can only reply to comments on the code.\nYou are correct that this change would potentially break Refund.total_amount_reimbursed_for,\nso I have added a scope to make sure the method only performs on transacted refunds. \nThe goal of this PR is to remove the implicit call of perform! so that refunds could be created\nwithout automatically performing them, for the purposes of data importing \n. Good catch! Unfortunately github no longer collapses comments on outdated diffs\n. I believe you have to be a member of solidusio, regardless of whether you authored the PR\n. Sorry Jordan, I definitely agree with what you've suggested. \nHad to augment your method suggestion slightly, to be more verbose and to return the refund.\nThanks again for the feedback!\n. I discussed this with @jhawthorn and we agreed it is better as is.\nUsing the create_and_perform! method from the controller meant building a refund model and then forgetting it and making a new one:\ndef create\n  @refund.attributes = refund_params                                            \n  if performed_refund = Spree::Refund.create_and_perform!(@refund.attributes)\n    flash[:success] = flash_message_for(performed_refund, :successfully_created)\n    respond_with(performed_refund) do |format|                                  \n      format.html { redirect_to location_after_save }                           \n    end                                                                         \n  else                                                                          \n    flash.now[:error] = @refund.errors.full_messages.join(\", \")                 \n    respond_with(@refund) do |format|                                           \n      format.html { render action: 'new' }                                      \n    end                                                                         \n  end                                                                           \nend\n. I addressed this as well as fleshed out the changelog a bit more verbosely.\nThanks again\n. @jhawthorn suggested going a different route and making a save_and_perform! method that I'll get into next week\n. @jordan-brough \nChanged to #perform_and_save! as per suggestions from @jhawthorn and @cbrunsdon \nHopefully this appeases all parties!\n. At that point all perform_and_save! would do is call perform!, as it really doesn't need to return self either.\nI think we should stick with the first iteration of having to call the public method perform! on a refund to perform it, and rely on the Changelog or the RDoc on the method to inform users of the need to explicitly perform their refunds. \n. I think opting to remove this validation might be the best route. It allows us to create refunds before calling perform! on them, rather than building them without saving to the database. It also allows data imports of refunds without transaction_ids, which is a potentital scenario. \nThe error handling within the #perform! call should be enough to alert users that a refund transaction was unsuccessful, as a transaction_id is required for the method to succeed.. Thank you for all your input on these changes Jordan, you've helped shed a lot of light on potential vulnerabilities with a change such as this. I know adding state to the refund model is something that not everyone will agree with.\nUltimately for the average user these changes won't have any negative implications, but for some users they will have more power over how their store handles refunds.. ",
    "RostislavKorin": "same issue. ",
    "blairanderson": "looks like i'm having this as well. \n-----> Ruby app detected\n-----> Compiling Ruby/Rails\n       Compiling solidus\nERROR:  While executing gem ... (Gem::FilePermissionError)\n    You don't have write permissions for the /var/lib/gems/2.3.0 directory.\nlogger: unrecognized option '--no-ri'\nUsage:\n logger [options] [<message>]\nEnter messages into the system log.\nOptions:\n -i                       log the logger command's PID\n     --id[=<id>]          log the given <id>, or otherwise the PID\n -f, --file <file>        log the contents of this file\n -e, --skip-empty         do not log empty lines when processing files\n     --no-act             do everything except the write the log\n -p, --priority <prio>    mark given message with this priority\n     --octet-count        use rfc6587 octet counting\n     --prio-prefix        look for a prefix on every line read from stdin\n -s, --stderr             output message to standard error as well\n -S, --size <size>        maximum size for a single message\n -t, --tag <tag>          mark every line with this tag\n -n, --server <name>      write to this remote syslog server\n -P, --port <number>      use this UDP port\n -T, --tcp                use TCP only\n -d, --udp                use UDP only\n     --rfc3164            use the obsolete BSD syslog protocol\n     --rfc5424[=<snip>]   use the syslog protocol (the default for remote);\n                            <snip> can be notime, or notq, and/or nohost\n     --msgid <msgid>      set rfc5424 message id field\n -u, --socket <socket>    write to this Unix socket\n     --socket-errors[=<on|off|auto>]\n                          print connection errors when using Unix sockets\n     --journald[=<file>]  write journald entry\n -h, --help     display this help and exit\n -V, --version  output version information and exit\nFor more details see logger(1).\n !\n !     \"NOKOGIRI_USE_SYSTEM_LIBRARIES=1 gem install --no-ri --no-rdoc railties:'~>5.0.1'\" failed\n !\n/app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/solidus.rb:88:in `sh': \"NOKOGIRI_USE_SYSTEM_LIBRARIES=1 gem install --no-ri --no-rdoc railties:'~>5.0.1'\" failed (RuntimeError)\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/solidus.rb:26:in `compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/bin/compile:16:in `block (2 levels) in <main>'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:131:in `log'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/bin/compile:15:in `block in <main>'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:35:in `block in trace'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /usr/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:35:in `trace'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/bin/compile:11:in `<main>'\n !     Push rejected, failed to compile Ruby app.\n !     Push failed. ",
    "andrewkmin": "Why was this closed? @quesurifn any insights?. Hmm.. so in terms of the api key there's legitimately no way to get it?. Gotcha. Thanks man and best of luck. @quesurifn . @kennyadsl thanks! I'm a NodeJS developer but I'm trying to get my feet wet in a Solidus/Rails project. What is the API key good for? From the Spree docs, it seems like all that's really necessary is the order token, correct?. @kennyadsl ah I see, thanks.\nFor me, I'm not looking to get into the cart interactions and the actual requests that are made when a user is interacting with the site. Instead, I'm looking to draw data from the store itself (products/inventory, order history, etc.) and with Solidus, I'm not sure that there's an easy way to do so out-of-the-box. Do we have to implement these endpoints ourselves?. @quesurifn\nMy routes.rb file looks like the following:\n--\nRails.application.routes.draw do\n\u00a0 | \u00a0\n\u00a0 | # This line mounts Spree's routes at the root of your application.\n\u00a0 | # This means, any requests to URLs such as /products, will go to Spree::ProductsController.\n\u00a0 | # If you would like to change where this engine is mounted, simply change the :at option to something different.\n\u00a0 | #\n\u00a0 | # We ask that you don't use the :as option here, as Spree relies on it being the default of \"spree\"\n\u00a0 | \u00a0\n\u00a0 | get 'design' => 'spree/static_pages#design'\n\u00a0 | get 'food' => 'spree/static_pages#food'\n\u00a0 | get 'faq' => 'spree/static_pages#faq'\n\u00a0 | get 'refer' => 'spree/static_pages#refer'\n\u00a0 | get 'careers' => 'spree/static_pages#careers'\n\u00a0 | get 'terms' => 'spree/static_pages#terms'\n\u00a0 | get 'dashboard' =>'spree/dashboard#index'\n\u00a0 | post 'dashboard/reorder/:id' => 'spree/dashboard#reorder'\n\u00a0 | root to: 'spree/home#index', constraints: ShopConstraint.new(false)\n\u00a0 | root to: 'spree/dashboard#index', constraints: ShopConstraint.new(true)\n\u00a0 | get '/explore' => 'spree/home#index', as: 'shop_page', constraints: ShopConstraint.new(true)\n\u00a0 | mount Spree::Core::Engine, :at => '/'\n\u00a0 | # For details on the DSL available within this file, see http://guides.rubyonrails.org/routing.html'\n\u00a0 | end\nDo I need to add back the routes that were included in the original documentation, as per this link? Thanks in advance https://github.com/spree/spree/blob/master/api/config/routes.rb\n. @quesurifn Thanks so much for the help man. Situation resolved. Turns out that the issue I was having was sending requests incorrectly -- once I fixed that, everything started working. Silly mistake haha . ",
    "quesurifn": "@andrewkmin No. Spree got me further and we have launched the solution and are receiving orders. To be honest, I'd stay away from spree based solutions altogether and look at other ecommerce solutions. I'm there are some pretty nice Node solutions and Golang solutions. There was a headless api ecommerce solution I really liked too. But seriously, solidus and spree aren't worth you and your teams troubles. . I ditched it for other reasons before I found a solution. @andrewkmin . @andrewkmin http://guides.spreecommerce.org/api/\nSolidus is build on spree 2.3 hence the docs will work. . They way spree / solidus works is all the core files are in the GEM kind of like NPM packages. (I'm a node dev too). The only difference is we spree is a complete solution unlike express so the routes are predefined. If you want to modify a core file you can override it by following the same folder structure as spree and creating a file with the same name (unlike NPM packages). \nAs far as your routes you can leave it how you found it because the gem has all that stuff. @andrewkmin \n. @andrewkmin \nI actually don't use auth for my api. I didn't see the need.\nIf you want to go that route I believe you can just set in spree.rb initializer:\nSpree::Api::Config[:requires_authentication] = false. @andrewkmin  NP. Good luck. Ruby / Rails is infinitely more temperamental than node. . ",
    "ranxiang": "comment and spec added, please review.\nThis is the first time for me to open a pull request, let me know if anything still unclear.\nThanks.. Just saw the comment due to the time differences, thanks all, I'll improve the comment and squash the commits before create the pull request next time.. ",
    "oeN": "The problem is related to https://github.com/select2/select2/issues/2750\nWe need to change the way solidus init the select2(). \nTo solve this specific problem is enough to override the backend/app/views/spree/admin/products/new.js.erb and change $('.select2').select2(); to $('select.select2').select2();\nI am changing all the points where solidus uses $('.select2').select2(); to $('select.select2').select2(); and then I'll open a PR. Thank you! I'm looking to the failure right now.. @gmacdougall I've tried but I was unable to replicate the error, it seems that the failure spec fails randomly (at least in my environment). Is it possible? Do you know if someone has a problem like this?\nWith ruby 2.4.0 I was unable to even run the spec because of poltergeist.\nWith ruby 2.3.0 I'm able to run the spec but it fails randomly most of times because of poltergeist with errors like:\n- Request to 'http://127.0.0.1:62594/admin' failed to reach server, check DNS and/or server status\n- Timed out with the following resources still waiting data:image/png;base64,iVBOR.....\nAnd sometimes the spec pass without problems. Do you have any advice to solve this and get the PR merged?\nThank you!!. Yes, I have opted for the name selector select instead of the ID to solve this problem quickly and with the minimum amount of code.. @tvdeyen I've tried to add the information on the commit, let me know if is fine. I thought I had to stay in the character limit \ud83d\ude04 . @kennyadsl Thanks for the comments! About the \"unparsable\" format, I think that we can avoid this check, for now, for two reasons:\n\nthe inputs are managed by JS code\nadding this check feels like a kind of defensive programming . \n",
    "nhippenmeyer": "This is causing the order_updater spec which distinguishes between adjustments and eligible adjustments to fail.  I'm unclear on why this distinction exists in the first place.. @gmacdougall I updated the PR description with steps to reproduce this bug.  I'm not sure what to do about the failing test here, should the free shipping adjustment show up as an adjustment on the order if it's not being applied because the rules aren't satisfied?  My suspicion is that it should not in which case I can update the order_updater_spec.rb. ",
    "asecondwill": "I'm not quite sure which to use still though.  If I want to get a stable (2.4.2) version running smoothly with quite a few extensions, which version of rails should i go back to? 5.0?. ",
    "samdking": "Hi, I have this same problem. Could you refer me to the branch you mentioned @tvdeyen? Is there any plan to merge this into a release?. ",
    "pascalj": "After going through some commits and reading the comment at processing.rb I thought everything was in place for partial captures. Unfortunately the feature was removed shortly after it was introduced, rendering the comment outdated/wrong.\nI cannot find a belonging PR, but I guess this stems from the difference between:\n\npartial payments (multiple captures for one payment)\npayments with a lower captured amount than the authorized amount (e.g. after editing on the payment index page)\n\nI'd gladly add a new method to the controller to get around that, but the transition to completed is done in the payment (Processing#capture!) itself. After a payment is completed there cannot be any more captures.\nAdjusting the capture method even more with unknown side effects will probably be reverted again in the future, just as before. So I'd like to add a partial_capture! method which emits a capture event and leaves the payment in its current state until fully captured. Another option would be to split the payment as before. Any thoughts/preferences on that?. I'd like to get some feedback on the general behaviour of capturing. For some code that allows partial capturing see #2039.\n\nI tried to not introduce a new method in processing and use the already available capture! method. The problem is that it has different semantics than I expected: it will capture the amount specified as an argument and reduce the overall amount of the payment and transition to completed. I think this was done for cases when an order is auto-captured and the remaining sum to pay is smaller than what was authorized. That way payments will always end up in complete, even if only a part is captured.\nThis is reflected in the two failing specs:\n/spec/models/spree/payment_spec.rb:454 \"Spree::Payment processing #capture! when payment is pending capturing a partial amount updates the amount of the payment\"\n./spec/lib/tasks/order_capturing_spec.rb:26 \"order_capturing:capture_payments with a mix of canceled and shipped inventory charges the order\"\n\nWhat option do you prefer?\n1. Add a new method inside of the payment processing a la partial_capture!(amount)?\n2. Don't change the amount any more (kind of what #2039 does) and change the specs in that regard. Could be a braking change, but it's definitely an edge case.\n3. \"Force\" payments to completed after their order was completed, no matter what their respective  uncaptured_amount is.\n4. None of the above, but <thing>?\nAny feedback is welcome!. Absolutely, it's not that common. Examples are Paypal and Amazon Pay which both work with only one authorization.\n\nThis amount cannot exceed the original amount that was authorized less any previously captured amount on this authorization. Copying @cbrunsdon's response from #2039 so it's all in one place:\nI definitely think the change is a good direction (multiple captures when payment gateways support it), but I'm worried that this is going to be a big change that everyone will get, even when multiple capture is not supported by payment gateways.\nI do however think this is a very reasonable, and not too intrusive for an extension, would you consider supporting it in that way? If it lives there for a while and the kinks get worked out, I would be happy to re-examine it for core in a future release.\n\nYes, I can see why touching that part of Solidus could cause problems, especially for third party code. I'll try to ship it as an extension - this would potentially allow to use it with older Solidus versions, too. Without overriding anything it'll:\n\nadd a small controller to handle the partial_capture without changing the payment's amount\nadd the form to the payment page\nmaybe add a callback to the order updater to complete the payments once an order is complete\n\nThanks for all your feedback!. Thanks @cbrunsdon! I responded in #2032 to keep the discussion there. Closing this PR in favor of an extension.. ",
    "pmn4": "I hear you on the readability.\nI wrote an initial version which used Spree::Country.create(array_of_attribute_hashes), but found that ActiveRecord creates individual INSERT statements.\n. funny, rubocop autocorrected those lines! happy to switch them back. none. just thought it would read nicely next to the following line.\nwill call in place. TIL!\nwill do.. good question. tbh, I copied that piece from Spree core version and never tested it. ",
    "DadiHall": "Is it possible to somehow to access the General settings in solidus 2.3?. Is it possible to somehow to access the General settings in solidus 2.3?. ",
    "subhashsaran": "recalculate Sounds better than spree update_with_updater!\nhttps://github.com/spree/spree/blob/v3.1.5/core/app/models/spree/order.rb#L235-L243\n\ud83d\udc4d . ",
    "ccarruitero": "@kennyadsl sorry for not provide a description.\nWell, the reason of this PR is because after add solidus_gateway all new gateways are shown like Payment Method that is not very useful.\n@tvdeyen yes, human method use I18n. But not sure if is the best way in this case.. Seems to still returning Payment Method after add a locale\nRunning via Spring preloader in process 7273\nLoading development environment (Rails 5.1.2)\n2.4.1 :001 > payments = Rails.application.config.spree.payment_methods.sort_by(&:name)\n => [Spree::BillingIntegration::Skrill::QuickCheckout (call 'Spree::BillingIntegration::Skrill::QuickCheckout.connection' to establish a connection), Spree::Gateway::AuthorizeNet (call 'Spree::Gateway::AuthorizeNet.connection' to establish a connection), Spree::Gateway::AuthorizeNetCim (call 'Spree::Gateway::AuthorizeNetCim.connection' to establish a connection), Spree::Gateway::BalancedGateway (call 'Spree::Gateway::BalancedGateway.connection' to establish a connection), Spree::Gateway::Banwire (call 'Spree::Gateway::Banwire.connection' to establish a connection), Spree::Gateway::Beanstream (call 'Spree::Gateway::Beanstream.connection' to establish a connection), Spree::Gateway::BraintreeGateway (call 'Spree::Gateway::BraintreeGateway.connection' to establish a connection), Spree::Gateway::CardSave (call 'Spree::Gateway::CardSave.connection' to establish a connection), Spree::Gateway::CulqiGateway (call 'Spree::Gateway::CulqiGateway.connection' to establish a connection), Spree::Gateway::DataCash (call 'Spree::Gateway::DataCash.connection' to establish a connection), Spree::Gateway::Eway (call 'Spree::Gateway::Eway.connection' to establish a connection), Spree::Gateway::Linkpoint (call 'Spree::Gateway::Linkpoint.connection' to establish a connection), Spree::Gateway::Maxipago (call 'Spree::Gateway::Maxipago.connection' to establish a connection), Spree::Gateway::Migs (call 'Spree::Gateway::Migs.connection' to establish a connection), Spree::Gateway::Moneris (call 'Spree::Gateway::Moneris.connection' to establish a connection), Spree::Gateway::PayJunction (call 'Spree::Gateway::PayJunction.connection' to establish a connection), Spree::Gateway::PayPalGateway (call 'Spree::Gateway::PayPalGateway.connection' to establish a connection), Spree::Gateway::PayflowPro (call 'Spree::Gateway::PayflowPro.connection' to establish a connection), Spree::Gateway::Paymill (call 'Spree::Gateway::Paymill.connection' to establish a connection), Spree::Gateway::PinGateway (call 'Spree::Gateway::PinGateway.connection' to establish a connection), Spree::Gateway::SagePay (call 'Spree::Gateway::SagePay.connection' to establish a connection), Spree::Gateway::SecurePayAU (call 'Spree::Gateway::SecurePayAU.connection' to establish a connection), Spree::Gateway::SpreedlyCoreGateway (call 'Spree::Gateway::SpreedlyCoreGateway.connection' to establish a connection), Spree::Gateway::StripeGateway (call 'Spree::Gateway::StripeGateway.connection' to establish a connection), Spree::Gateway::UsaEpay (call 'Spree::Gateway::UsaEpay.connection' to establish a connection), Spree::Gateway::Worldpay (call 'Spree::Gateway::Worldpay.connection' to establish a connection), Spree::PaymentMethod::BogusCreditCard (call 'Spree::PaymentMethod::BogusCreditCard.connection' to establish a connection), Spree::PaymentMethod::Check (call 'Spree::PaymentMethod::Check.connection' to establish a connection), Spree::PaymentMethod::SimpleBogusCreditCard (call 'Spree::PaymentMethod::SimpleBogusCreditCard.connection' to establish a connection), Spree::PaymentMethod::StoreCredit (call 'Spree::PaymentMethod::StoreCredit.connection' to establish a connection)] \n2.4.1 :002 > payments.first.model_name.i18n_key\n => :\"spree/billing_integration/skrill/quick_checkout\" \n2.4.1 :003 > I18n.t('spree.billing_integration.skrill.quick_checkout')\n => \"Quick Checkout\" \n2.4.1 :004 > payments.first.model_name.human\n => \"Payment Method\". I was testing with PayPalGateway, and with PayuLatamGateway.\nI think these gateways still use the provider's API.. I'm closing this.\nAfter some debugging I found that not persist the number and verification is a solidus feature instead a bug.. I understand that people will desire customize their homepage in different way than products page.\nI just was thinking that building an entire home page from scratch will be the option most used for customize the home page.\nBut like you mention could be people that made their customization on top of current template, and removing this could cause unnecessary problems in their implementation.\nAnyway I'm closing this.. I just update the pull request removing the methods. Well is difficult to know where is firing the error, without an error trace or more details about the gems that you are using in your project.\nCan you reproduce the error in a new solidus app?. I'm agree to move testing dependencies from common_spree_dependencies, but in order to reduce the repetition I think that we could introduce new files for wrap common testing dependencies.\nI was thinking in one file like common_testing_dependencies where add testing gems that are repeated in all solidus gems, excluding sample. I think will be mainly the gems added in core without timecop and with_model. \nAn another  like common_integration_testing_dependencies where add common integration gems. Here I think will be only capybara and capybara-screenshot for now.. Seems to be incompatible dependencies between latests alchemy-devise and alchemy-solidus. There is a PR in progress for fix that in alchemy-solidus.\nI recommend you to use another version of alchemy-devise that be compatible or use alchemy-solidus from the PR that fix the dependency until be merged.\nAnother option is to use solidus_auth_devise instead alchemy-devise. Thanks all for your comments.\nI'll update this accordingly. I'm not agree with remove the state_machines gem.\nI feel that reimplementing state_machines functionality on each model is something repetitive.\nAside, we are assuming that everyone want to use the default states, I think if someone require states completely different for their use case, would be necessary more work to do than is currently.\nLike you mention maybe state_machines is difficult to understand, but instead remove I think we should improve documentation in that field.\nFinally if you want to remove state_machines, I think a better way could be find and alternative or do a module replacement for that, and allow configure in some way what to use for the states.. Hi @damienlethiec \nThis seems to be a issue with bootsnap and not with solidus. There is a similar issue in bootsnap repository's issue tracker https://github.com/Shopify/bootsnap/issues/147. @mobentec Can you share the code you did? Otherwise it's complicated to figurate what is the problem.\nPersonally, for mail previews I prefer to use letter_opener_web that not require too much extra configuration. @tvdeyen the changes looks good. Definitely better than the current view.\nBut, I'm not sure we should allow the user just update the stock. I think will be better keep a record about why the stock change, maybe generating a stock movement,  that way is more easy track an error when occurred.. When you have a product with variants, the master sku becomes unused. So I think is correct the current behaviour in solidus.\nI understand that is necessary for your use case, but you can add this functionality with an extension instead.. About building extensions that provide only business logic, not sure how to avoid monkey patching without a configurable class or preference.\nMaybe we can start evangelizing the community about avoid class_eval for monkey patching when posible, and request feedback from extensions developers about more configurable entry points that are necessary.\nAside, not sure that we need solidus_cmd. rails already has a command to generate engines (rails plugin new), and allow us to use custom templates too. And we can use bundler for generate a regular gem.. Yeah, there shouldn't  be a problem.\nI'm going to update the elements to use class.. Yeah, is more clean like you propose :+1: \nI'll update the pulll request accordingly. There is a typo in the link text. Should be solidus_cmd, without the backslash.. ~I think we should remove this changes since are in https://github.com/solidusio/solidus/pull/2358~. ~same as comment above~. I just used Stripe from solidus_gateway. So, not sure if this list of supported gateways apply to solidus_gateway right now?. I think this reference for how to add a custom gateway is too vague. I think we should extend this information in another guide maybe.. I'm not sure if we should maintain a list of supported gateways here. I think that reference to another resource where we can find gateway extensions could be better.\nWhat do you think?\nI was thinking in extensions.solidus.io. I like how show the builds for each version, so you can know if a project is maintained, but don't have a way to filter the extensions. Another option could be solition that find extensions from github (finding by repository description and name, I think so). Another option?. I'll remove that link. I think the file should be in javascript instead coffee.\nFrom backend README:\n\nThough we have existing CoffeeScript files, any new files should be in javascript (ES5).. Surely is outside the scope of this changes.\n\nBut we have similar backbone views that use a conditional value editing with a handlebars template.  (ex: orders/shipping_methods) I think that approach is better than show/hide with css.\nMaybe we can create a common view for use in this cases.. I think will be better add the extra checking with the conditional. ",
    "Yekutiel": "\nThanks for the report.\n\nThanks for the quick, informative, and helpful response.\n\nI believe this was failing because of missing solidusio/solidus_auth_devise#102, which wasn't in a release yet. \n\nAh. Ok. I see.\n\nI've just released a new version of solidus_auth_devise and this should be fixed.\n\nI successfully deployed Solidus on Heroku therefore I assume your supposition was correct.. ",
    "ahwong5": "@cbrunsdon You have omitted to update the home controller as well, therefore the products at frontend homepage has lost the ability to paginate.\nAnd also when performing Search, it doesn't paginate as well. I'm not sure which file need to update.\nThanks.. ",
    "notapatch": "Rebased and updated the commit message improvements from @swcraig, thanks. \nI am hoping this will be my first Solidus contribution. I won't lie anything else will result in disappointed cockatoo reaction and you don't want to go into a weekend with that on your conscious. . ### Frontend checkout 'address' page\n\nyou have to uncheck the \"Use Billing Address\" checkbox to see the difference\nWithout the change what you see is the input boxes taking up part of the width whereas other elements use the full-width. \nThis change brings Shipping address in line with the Billing Address.\nWhen grepping id=\"billing\" I can only find billing in checkout/_address so this change should not affect anything else in the application. . I am open to suggestions on what color variable you would like the price text to be but since it isn't a link ... this is more an \"anything but link color\" pull request.\n\nThe price still remains distinct through size alone.. I didn't explain it very well - I did not mention this was for the products#show page (I will do print screens to help reviewers) and not the products#index page as in the above image. \nHowever, as @Mandily points out .. the products#index page is also using the link colors for non-links. If people are agreeable, I can extend the pull request to include the price on the product's index page - I will also check if price appears consistently throughout the front end application before resubmitting.  \n. # What do shopping sites do with price colors?\nI took the first 20 sites from Alexa shopping category [1] and 3/4 of the websites had the non-sale price in black. Four sites used a brand or accent color on #index and the #show page and one site had different price colors on index and show. \nIn other words, if I show the price in black and leave a variable to change the price color then we can mock the requirements for 95% of the websites in the top 20. \nWhat did I change?\nI chose an application unique dark gray color so that anyone picking the color can grep and find it quickly - #252525.\nWhat pages were changed?\nproducts#index, products#show, orders#edit, checkout order summary panel (affecting Address, Delivery, Payment)  and checkout confirm.\nProducts#index  Before\n\nProducts#index After\n\nOrders#edit Before\n\nOrders#edit After\n\nCheckout order summary panel Before\n\nCheckout order summary panel After\n\nit would probably look nicer if the \"Order Summary\" panel had a more consistent look with the Billing and Shipping panels\n\n\nCheckout - confirm Before\n\nCheckout - confirm After\n\n\"Sub total\" and \"order total\" should be de-emphasized as the shopper is more interested in the amounts than the titles  - this will give a \"cleaner\" look to the page.\n\n\nDiscussion\nFor a few lines of code, this is a big change to the appearance - we might only want the change affecting products#index and products#show for now? Or make the change and update the checkout pages to go with the price color change? \n[1] - I did not count Amazon.co.uk as I assumed it was the same as Amazon.com, Netflix because they required a login and I assume they aren't going to be a standard shopping site.",
    "Eth3rnit3": "\nI have this error message after the update to 2.4 do you have any idea where it might come from?\nserver-side : \nActionView::Template::Error (\".state.sold\" failed to @extend \".pill-sold\".\nThe selector \".pill-sold\" was not found.\nUse \"@extend .pill-sold !optional\" if the extend should be able to fail.\n):\n    4: <meta content=\"width=device-width, initial-scale=1.0, maximum-scale=1\" name=\"viewport\">\n    5: <%== meta_data_tags %>\n    6: <%= canonical_tag(current_store.url) %>\n    7: <%= favicon_link_tag 'favicon.ico' %>\n    8: <%= stylesheet_link_tag 'spree/frontend/all', media: 'screen' %>\n    9: <%= csrf_meta_tags %>\n   10: <%= javascript_include_tag 'spree/frontend/all' %>. yes only the file variables_override. scss I'm going to compare it right now and I'm telling you. no unfortunately the file is empty in solidus . you're right, if I add the line: \n\n@import 'spree/backend/components/pills'\n\nto my file, it works ; -) Thank you. not really sorry, actually. \nonly a css problem that made a mistake earlier. actually the problem was that I overloaded the $state class in my variables_override file. thank you, maybe we'll see you soon.. ",
    "davidmaogomezz": "Hi, How can I use bootstrap in my application (frontend)?. Hi, How can I use bootstrap in my application (frontend)?. ",
    "benmzh": "Thanks @trevorh2007 for the detailed breakdown. I've had the same problem with my live site. I'll use the quick fix but would prefer a more long term solution eventually. I'll stay tuned.. ",
    "thetre97": "this still doesn't work for me..?\nlog below...\n-----> Ruby app detected\n-----> Compiling Ruby/Rails\n       Compiling solidus\nWARNING:  You don't have /app/.gem/ruby/2.3.0/bin in your PATH,\n      gem executables will not run.\nSuccessfully installed i18n-0.8.6\nSuccessfully installed thread_safe-0.3.6\nSuccessfully installed tzinfo-1.2.3\nSuccessfully installed concurrent-ruby-1.0.5\nSuccessfully installed activesupport-5.1.4\nSuccessfully installed rack-2.0.3\nSuccessfully installed rack-test-0.7.0\nSuccessfully installed mini_portile2-2.3.0\nBuilding native extensions.  This could take a while...\nSuccessfully installed nokogiri-1.8.1\nSuccessfully installed loofah-2.0.3\nSuccessfully installed rails-html-sanitizer-1.0.3\nSuccessfully installed rails-dom-testing-2.0.3\nSuccessfully installed builder-3.2.3\nSuccessfully installed erubi-1.6.1\nSuccessfully installed actionview-5.1.4\nSuccessfully installed actionpack-5.1.4\nSuccessfully installed thor-0.20.0\nSuccessfully installed method_source-0.8.2\nSuccessfully installed railties-5.1.4\n19 gems installed\n      create  \n      create  README.md\n      create  Rakefile\n      create  config.ru\n      create  .gitignore\n      create  Gemfile\n         run  git init from \".\"\nInitialized empty Git repository in /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/sandbox/.git/\n      create  app\n      create  app/assets/config/manifest.js\n      create  app/assets/javascripts/application.js\n      create  app/assets/javascripts/cable.js\n      create  app/assets/stylesheets/application.css\n      create  app/channels/application_cable/channel.rb\n      create  app/channels/application_cable/connection.rb\n      create  app/controllers/application_controller.rb\n      create  app/helpers/application_helper.rb\n      create  app/jobs/application_job.rb\n      create  app/mailers/application_mailer.rb\n      create  app/models/application_record.rb\n      create  app/views/layouts/application.html.erb\n      create  app/views/layouts/mailer.html.erb\n      create  app/views/layouts/mailer.text.erb\n      create  app/assets/images/.keep\n      create  app/assets/javascripts/channels\n      create  app/assets/javascripts/channels/.keep\n      create  app/controllers/concerns/.keep\n      create  app/models/concerns/.keep\n      create  bin\n      create  bin/bundle\n      create  bin/rails\n      create  bin/rake\n      create  bin/setup\n      create  bin/update\n      create  bin/yarn\n      create  config\n      create  config/routes.rb\n      create  config/application.rb\n      create  config/environment.rb\n      create  config/secrets.yml\n      create  config/cable.yml\n      create  config/puma.rb\n      create  config/spring.rb\n      create  config/environments\n      create  config/environments/development.rb\n      create  config/environments/production.rb\n      create  config/environments/test.rb\n      create  config/initializers\n      create  config/initializers/application_controller_renderer.rb\n      create  config/initializers/assets.rb\n      create  config/initializers/backtrace_silencers.rb\n      create  config/initializers/cookies_serializer.rb\n      create  config/initializers/cors.rb\n      create  config/initializers/filter_parameter_logging.rb\n      create  config/initializers/inflections.rb\n      create  config/initializers/mime_types.rb\n      create  config/initializers/new_framework_defaults_5_1.rb\n      create  config/initializers/wrap_parameters.rb\n      create  config/locales\n      create  config/locales/en.yml\n      create  config/boot.rb\n      create  config/database.yml\n      create  db\n      create  db/seeds.rb\n      create  lib\n      create  lib/tasks\n      create  lib/tasks/.keep\n      create  lib/assets\n      create  lib/assets/.keep\n      create  log\n      create  log/.keep\n      create  public\n      create  public/404.html\n      create  public/422.html\n      create  public/500.html\n      create  public/apple-touch-icon-precomposed.png\n      create  public/apple-touch-icon.png\n      create  public/favicon.ico\n      create  public/robots.txt\n      create  test/fixtures\n      create  test/fixtures/.keep\n      create  test/fixtures/files\n      create  test/fixtures/files/.keep\n      create  test/controllers\n      create  test/controllers/.keep\n      create  test/mailers\n      create  test/mailers/.keep\n      create  test/models\n      create  test/models/.keep\n      create  test/helpers\n      create  test/helpers/.keep\n      create  test/integration\n      create  test/integration/.keep\n      create  test/test_helper.rb\n      create  test/system\n      create  test/system/.keep\n      create  test/application_system_test_case.rb\n      create  tmp\n      create  tmp/.keep\n      create  tmp/cache\n      create  tmp/cache/assets\n      create  vendor\n      create  vendor/.keep\n      create  package.json\n      remove  config/initializers/cors.rb\n      remove  config/initializers/new_framework_defaults_5_1.rb\n[\"/tmp/d20170920-100-1favjrm/bundler-1.13.1/gems/bundler-1.13.1/lib\", \"/app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib\", \"/app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/vendor\", \"/app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib\", \"/usr/local/lib/site_ruby/2.3.0\", \"/usr/local/lib/x86_64-linux-gnu/site_ruby\", \"/usr/local/lib/site_ruby\", \"/usr/lib/ruby/vendor_ruby/2.3.0\", \"/usr/lib/x86_64-linux-gnu/ruby/vendor_ruby/2.3.0\", \"/usr/lib/ruby/vendor_ruby\", \"/usr/lib/ruby/2.3.0\", \"/usr/lib/x86_64-linux-gnu/ruby/2.3.0\"]\n-----> Using Ruby version: ruby-2.2.4\n-----> Installing dependencies using bundler 1.13.1\n       Running: bundle install --without development:test --path vendor/bundle --binstubs vendor/bundle/bin -j4\n       Fetching gem metadata from https://rubygems.org/.........\n       Fetching version metadata from https://rubygems.org/..\n       Fetching dependency metadata from https://rubygems.org/.\n       Resolving dependencies....\n       Installing rake 12.1.0\n       Installing concurrent-ruby 1.0.5\n       Installing i18n 0.8.6\n       Installing minitest 5.10.3\n       Installing thread_safe 0.3.6\n       Installing builder 3.2.3\n       Installing erubi 1.6.1\n       Installing mini_portile2 2.3.0\n       Installing rack 2.0.3\n       Installing websocket-extensions 0.1.2\n       Installing nio4r 2.1.0 with native extensions\n       Installing mime-types-data 3.2016.0521\n       Installing arel 8.0.0\n       Installing execjs 2.7.0\n       Installing bcrypt 3.1.11 with native extensions\n       Installing rb-fsevent 0.10.2\n       Installing ffi 1.9.18 with native extensions\n       Installing thor 0.20.0\n       Using bundler 1.13.1\n       Installing camertron-eprun 1.1.1\n       Installing cancancan 1.17.0\n       Installing method_source 0.8.2\n       Installing cldr-plurals-runtime-rb 1.0.1\n       Installing climate_control 0.2.0\n       Installing coffee-script-source 1.12.2\n       Installing polyglot 0.3.5\n       Installing orm_adapter 0.5.0\n       Installing tilt 2.0.8\n       Installing multi_json 1.12.2\n       Installing kaminari-core 1.0.1\n       Installing mimemagic 0.3.2\n       Installing pg 0.21.0 with native extensions\n       Installing puma 3.10.0 with native extensions\n       Installing rails_serve_static_assets 0.0.5\n       Installing rails_stdout_logging 0.0.5\n       Installing state_machines 0.5.0\n       Installing stringex 1.5.1\n       Installing truncate_html 0.9.3\n       Installing solidus_support 0.1.5\n       Installing turbolinks-source 5.0.3\n       Installing rainbow 2.2.2 with native extensions\n       Installing money 6.9.0\n       Installing nokogiri 1.8.1 with native extensions\n       Installing tzinfo 1.2.3\n       Installing websocket-driver 0.6.5 with native extensions\n       Installing mime-types 3.1\n       Installing rack-test 0.7.0\n       Installing sprockets 3.7.1\n       Installing warden 1.2.7\n       Installing autoprefixer-rails 7.1.4\n       Installing uglifier 3.2.0\n       Installing cocaine 0.5.8\n       Installing coffee-script 2.4.1\n       Installing rb-inotify 0.9.10\n       Installing rails_12factor 0.0.3\n       Installing turbolinks 5.0.1\n       Installing monetize 1.7.0\n       Installing activesupport 5.1.4\n       Installing twitter_cldr 4.4.2\n       Installing mail 2.6.6\n       Installing handlebars_assets 0.23.2\n       Installing sass-listen 4.0.0\n       Installing globalid 0.4.0\n       Installing activemodel 5.1.4\n       Installing carmen 1.0.2\n       Installing jbuilder 2.7.0\n       Installing sass 3.5.1\n       Installing activejob 5.1.4\n       Installing activerecord 5.1.4\n       Installing paperclip 5.1.0\n       Installing state_machines-activemodel 0.5.0\n       Installing bourbon 4.3.4\n       Installing acts_as_list 0.9.7\n       Installing awesome_nested_set 3.1.3\n       Installing friendly_id 5.2.2\n       Installing kaminari-activerecord 1.0.1\n       Installing paranoia 2.3.1\n       Installing polyamorous 1.3.1\n       Installing state_machines-activerecord 0.5.0\n       Installing rails-dom-testing 2.0.3\n       Installing loofah 2.0.3\n       Installing rails-html-sanitizer 1.0.3\n       Installing activemerchant 1.71.0\n       Installing actionview 5.1.4\n       Installing kaminari-actionview 1.0.1\n       Installing kaminari 1.0.1\n       Installing actionpack 5.1.4\n       Installing actioncable 5.1.4\n       Installing actionmailer 5.1.4\n       Installing railties 5.1.4\n       Installing sprockets-rails 3.2.1\n       Installing ransack 1.8.3\n       Installing rails 5.1.4\n       Installing responders 2.4.0\n       Installing coffee-rails 4.2.2\n       Installing jquery-ui-rails 5.0.5\n       Installing jquery-rails 4.3.1\n       Installing font-awesome-rails 4.7.0.2\n       Installing sass-rails 5.0.6\n       Installing versioncake 3.3.0\n       Installing canonical-rails 0.2.1\n       Installing deface 1.2.0\n       Using solidus_core 2.4.0.alpha from source at `.`\n       Installing devise 4.3.0\n       Using solidus_sample 2.4.0.alpha from source at `.`\n       Using solidus_api 2.4.0.alpha from source at `.`\n       Using solidus_backend 2.4.0.alpha from source at `.`\n       Using solidus_frontend 2.4.0.alpha from source at `.`\n       Using solidus 2.4.0.alpha from source at `.`\n       Installing devise-encryptable 0.2.0\n       Installing solidus_auth_devise 1.6.4\n       Bundle complete! 19 Gemfile dependencies, 111 gems now installed.\n       Gems in the groups development and test were not installed.\n       Bundled gems are installed into ./vendor/bundle.\n       Post-install message from handlebars_assets:\n       Remember to rake assets:clean or rake assets:purge on update! this is required because of handlebars updates\n       Post-install message from paperclip:\n       ##################################################\n       #  NOTE FOR UPGRADING FROM 4.3.0 OR EARLIER       #\n       ##################################################\n       Paperclip is now compatible with aws-sdk >= 2.0.0.\n       If you are using S3 storage, aws-sdk >= 2.0.0 requires you to make a few small\n       changes:\n       * You must set the `s3_region`\n       * If you are explicitly setting permissions anywhere, such as in an initializer,\n       note that the format of the permissions changed from using an underscore to\n       using a hyphen. For example, `:public_read` needs to be changed to\n       `public-read`.\n       For a walkthrough of upgrading from 4 to 5 and aws-sdk >= 2.0 you can watch\n       http://rubythursday.com/episodes/ruby-snack-27-upgrade-paperclip-and-aws-sdk-in-prep-for-rails-5\n       Bundle completed (34.04s)\n       Cleaning up the bundler cache.\n[\"/tmp/d20170920-100-1favjrm/bundler-1.13.1/gems/bundler-1.13.1/lib\", \"/tmp/d20170920-100-1favjrm/bundler-1.13.1/gems/bundler-1.13.1/lib\", \"/app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib\", \"/app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/vendor\", \"/app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib\", \"/usr/local/lib/site_ruby/2.3.0\", \"/usr/local/lib/x86_64-linux-gnu/site_ruby\", \"/usr/local/lib/site_ruby\", \"/usr/lib/ruby/vendor_ruby/2.3.0\", \"/usr/lib/x86_64-linux-gnu/ruby/vendor_ruby/2.3.0\", \"/usr/lib/ruby/vendor_ruby\", \"/usr/lib/ruby/2.3.0\", \"/usr/lib/x86_64-linux-gnu/ruby/2.3.0\"]\n/tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/callbacks.rb:712:in `block (2 levels) in skip_callback': Before process_action callback :set_current_order has not been defined (ArgumentError)\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/callbacks.rb:708:in `each'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/callbacks.rb:708:in `block in skip_callback'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/callbacks.rb:622:in `block in __update_callbacks'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/callbacks.rb:620:in `reverse_each'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/callbacks.rb:620:in `__update_callbacks'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/callbacks.rb:707:in `skip_callback'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/actionpack-5.1.4/lib/abstract_controller/callbacks.rb:181:in `block (3 levels) in <module:ClassMethods>'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/actionpack-5.1.4/lib/abstract_controller/callbacks.rb:74:in `block in _insert_callbacks'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/actionpack-5.1.4/lib/abstract_controller/callbacks.rb:73:in `each'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/actionpack-5.1.4/lib/abstract_controller/callbacks.rb:73:in `_insert_callbacks'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/actionpack-5.1.4/lib/abstract_controller/callbacks.rb:180:in `block (2 levels) in <module:ClassMethods>'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/solidus_auth_devise-1.6.4/lib/controllers/frontend/spree/users_controller.rb:2:in `<class:UsersController>'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/solidus_auth_devise-1.6.4/lib/controllers/frontend/spree/users_controller.rb:1:in `<top (required)>'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/polyglot-0.3.5/lib/polyglot.rb:65:in `require'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/polyglot-0.3.5/lib/polyglot.rb:65:in `require'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies.rb:292:in `block in require'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies.rb:258:in `load_dependency'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies.rb:292:in `require'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies.rb:379:in `block in require_or_load'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies.rb:36:in `block in load_interlock'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies/interlock.rb:12:in `block in loading'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/concurrency/share_lock.rb:149:in `exclusive'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies/interlock.rb:11:in `loading'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies.rb:36:in `load_interlock'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies.rb:357:in `require_or_load'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies.rb:335:in `depend_on'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies.rb:251:in `require_dependency'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/engine.rb:476:in `block (2 levels) in eager_load!'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/engine.rb:475:in `each'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/engine.rb:475:in `block in eager_load!'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/engine.rb:473:in `each'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/engine.rb:473:in `eager_load!'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/engine.rb:354:in `eager_load!'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/application/finisher.rb:67:in `each'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/application/finisher.rb:67:in `block in <module:Finisher>'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/initializable.rb:30:in `instance_exec'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/initializable.rb:30:in `run'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/initializable.rb:59:in `block in run_initializers'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/ruby-2.2.4/lib/ruby/2.2.0/tsort.rb:226:in `block in tsort_each'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/ruby-2.2.4/lib/ruby/2.2.0/tsort.rb:348:in `block (2 levels) in each_strongly_connected_component'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/ruby-2.2.4/lib/ruby/2.2.0/tsort.rb:429:in `each_strongly_connected_component_from'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/ruby-2.2.4/lib/ruby/2.2.0/tsort.rb:347:in `block in each_strongly_connected_component'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/ruby-2.2.4/lib/ruby/2.2.0/tsort.rb:345:in `each'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/ruby-2.2.4/lib/ruby/2.2.0/tsort.rb:345:in `call'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/ruby-2.2.4/lib/ruby/2.2.0/tsort.rb:345:in `each_strongly_connected_component'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/ruby-2.2.4/lib/ruby/2.2.0/tsort.rb:224:in `tsort_each'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/ruby-2.2.4/lib/ruby/2.2.0/tsort.rb:203:in `tsort_each'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/initializable.rb:58:in `run_initializers'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/application.rb:353:in `initialize!'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/config/environment.rb:5:in `<top (required)>'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/polyglot-0.3.5/lib/polyglot.rb:65:in `require'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/polyglot-0.3.5/lib/polyglot.rb:65:in `require'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies.rb:292:in `block in require'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies.rb:258:in `load_dependency'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/activesupport-5.1.4/lib/active_support/dependencies.rb:292:in `require'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/application.rb:329:in `require_environment!'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/command/actions.rb:16:in `require_application_and_environment!'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/commands/generate/generate_command.rb:19:in `perform'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/thor-0.20.0/lib/thor/command.rb:27:in `run'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/thor-0.20.0/lib/thor/invocation.rb:126:in `invoke_command'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/thor-0.20.0/lib/thor.rb:387:in `dispatch'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/command/base.rb:63:in `perform'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/command.rb:44:in `invoke'\n    from /tmp/build_4165844f0c42dd5feaf646541f9c8b7e/solidusio-solidus-1c0d0bb/vendor/bundle/ruby/2.2.0/gems/railties-5.1.4/lib/rails/commands.rb:16:in `<top (required)>'\n    from bin/rails:4:in `require'\n    from bin/rails:4:in `<main>'\nlogger: unrecognized option '--auto-accept'\nUsage:\n logger [options] [<message>]\nEnter messages into the system log.\nOptions:\n -i                       log the logger command's PID\n     --id[=<id>]          log the given <id>, or otherwise the PID\n -f, --file <file>        log the contents of this file\n -e, --skip-empty         do not log empty lines when processing files\n     --no-act             do everything except the write the log\n -p, --priority <prio>    mark given message with this priority\n     --octet-count        use rfc6587 octet counting\n     --prio-prefix        look for a prefix on every line read from stdin\n -s, --stderr             output message to standard error as well\n -S, --size <size>        maximum size for a single message\n -t, --tag <tag>          mark every line with this tag\n -n, --server <name>      write to this remote syslog server\n -P, --port <number>      use this UDP port\n -T, --tcp                use TCP only\n -d, --udp                use UDP only\n     --rfc3164            use the obsolete BSD syslog protocol\n     --rfc5424[=<snip>]   use the syslog protocol (the default for remote);\n                            <snip> can be notime, or notq, and/or nohost\n     --msgid <msgid>      set rfc5424 message id field\n -u, --socket <socket>    write to this Unix socket\n     --socket-errors[=<on|off|auto>]\n                          print connection errors when using Unix sockets\n     --journald[=<file>]  write journald entry\n -h, --help     display this help and exit\n -V, --version  output version information and exit\nFor more details see logger(1).\n !\n !     \"bundle exec rails g spree:install --auto-accept --user_class=Spree::User --enforce_available_locales=true --migrate=false --seed=false --sample=false\" failed\n !\n/app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/solidus.rb:86:in `sh': \"bundle exec rails g spree:install --auto-accept --user_class=Spree::User --enforce_available_locales=true --migrate=false --seed=false --sample=false\" failed (RuntimeError)\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/solidus.rb:69:in `run_assets_precompile_rake_task'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/ruby.rb:104:in `block (2 levels) in compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/ruby.rb:757:in `allow_git'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/ruby.rb:98:in `block in compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /usr/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:48:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:44:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/ruby.rb:88:in `compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/rails2.rb:49:in `block in compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /usr/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:48:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:44:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/rails2.rb:47:in `compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/rails3.rb:38:in `block in compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /usr/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:48:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:44:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/rails3.rb:37:in `compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/rails4.rb:41:in `block in compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /usr/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:48:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:44:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/rails4.rb:40:in `compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/solidus.rb:62:in `compile'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/bin/compile:16:in `block (2 levels) in <main>'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/base.rb:131:in `log'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/bin/compile:15:in `block in <main>'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:35:in `block in trace'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:18:in `block (2 levels) in instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:40:in `yield_with_block_depth'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:17:in `block in instrument'\n    from /usr/lib/ruby/2.3.0/benchmark.rb:308:in `realtime'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:16:in `instrument'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/lib/language_pack/instrument.rb:35:in `trace'\n    from /app/tmp/buildpacks/4503e3a76977915f47253edc22ff766cf41874cec155814eeb2bed137037cc920729733d948ffeb2124e6612e9bfcc160ea3849de67fe7190e0f7d126454c288/bin/compile:11:in `<main>'\n !     Push rejected, failed to compile Ruby app.\n !     Push failed. I also managed to successfully deploy. thanks @swcraig !. ",
    "digitalWestie": "Using solidus 2.3.0, same problem here. . Just tried on master working fine :+1: . ",
    "aosorio1": "I'll check that plugin. Thanks for your response. . ",
    "vassalloandrea": "Please don't consider this PR. Sorry was my fault.. After thinking about this PR I'm going to close it whereas BackorderedFirst allocator can be used in a specific situation and shouldn't be added on the Solidus core.. Hey @afdev82, while I'm searching the problem on Solidus, I found that the issue can be resolved creating on the Solidus admin a new shipping method with the new shipping category or adding the new shipping category to an existing shipping method.\nHere the Spree::Stock::Estimator class retrieves all the shipping methods to build the shipping rates calling this class method without returning any shipping method.\nEditing a shipping method\n\n. ",
    "afdev82": "Added more details with https://github.com/solidusio/solidus_cmd/pull/14. We can close this now.. No, I'm using also 'de', 'en', 'fr'. Solidus is the v2.4.2, but the same code is also in the master.\nSolidus_18n is the v1.2.0.\n. Because I don't need different settings for my locale, in general the locale of the store is set to \"en-US\" because I need different currency formats, but for select2 it should fallback to en.\nIMHO it's not handled correctly in the code, the fix is not completely general, because if I wanted to have the js file for \"en-US\" it doesn't work, but as far as I saw the files are only simply translations in different languages and I think it's fine in this way.\n\nAnyway, what about creating a new select2_locale_en-US.js file here instead?\n\nAnyway, I'm using custom forks of the two projects with small changes. This PR was only to contribute.. Ok, I get the point ;)\nIn the end it could be more general just to add the file, as you already said.\nFor me it would be unnecessary, but since we don't have a fallback mechanism, it would be fine for all.. See #2805. Because I needed only for that... But once we have this field we could use it also for other methods that send emails.\nIn my case the need was to have only the confirmation order emails in BCC to other email addresses.. What you say it makes sense.\nI just thought that the functionality to receive an email when an order is performed instead of having to log in in the website and check there, was pretty common and nothing stops to add the same functionality for other emails too.\nI wanted only to reduce the need to override views / methods in my app just to add the bcc field to the emails, because it's always a problem with upgrades.\nIf it's worth to have in the core or in an extension, I don't know.. Ok :+1: . I just run bundle exec i18n-tasks normalize inside the core directory. @kennyadsl usually the translations are alphabetically ordered and so on \"normalized\". In this way in both projects (solidus_i18n and solidus) they are in the same place and it's easier to translate them. I would like to add the check for the health of the translations in the ci, in this way every time someone adds a translation it should be in the right place.\nAt the moment there will be a lot of work to get it working, I tried to check and I have to fine tuning the configuration of the i18n-tasks gem.. Hm... I just run bundle exec i18n-tasks normalize inside the core directory, and then committed the result. And I did this in two commits to make it clearer, if you want we can remove the normalize commit, but it should be fine to always execute this command. If you execute bundle exec i18n-tasks health, it tells you that the translations are not normalized, then I executed that.. I see... I have to check, I don't know why now.. No sorry, I didn't have time to continue on that :(. Hi @vassalloandrea , thank you for your help.\nI was already using the UPS Ground (EUR) for one category and the UPS Ground (EU) for the other and it didn't work, but I think I found out why.\nThe shipping methods have different currency, if I use the same currency in both, it works.\nFor sure it works if I add both shipping category to the same shipping method, but my setup is with two different shipping methods, because I want two different rates per category.\nOnline in my app I use the same currency for both shipping methods, so it should be something else. I'm debugging the two parts that you pointed out in my app, trying to figure out.. I find the source of the error in my app. It's something very strange.\nAfter this line I don't have any shipping_method anymore: https://github.com/solidusio/solidus/blob/e2ef677cfff4b4cc264d8eaa20b6edcf545fa05d/core/app/models/spree/stock/estimator.rb#L58\nThe reason is this line in the scope available_to_store:\nhttps://github.com/solidusio/solidus/blob/e2ef677cfff4b4cc264d8eaa20b6edcf545fa05d/core/app/models/spree/shipping_method.rb#L44\nIf I execute package.shipment.order.store.shipping_methods I get my two shipping methods that I have for each shipping category:\n```\n, #]>\n``\nbutpackage.shipment.order.store.shipping_method_idsreturns only the id of the first shipping method!package.shipment.order.store.shipping_methods.idsreturns[2,1], so I don't know what's going on here.\n. I found the problem.\nI'm using thesolidus_multi_domaingem, that doesn't have theinverse_of` option for the association.\nhas_many :store_shipping_methods, inverse_of: :store\nIf I add it, it works! I will submit a PR for the gem in order to fix this.. Anyway, it's strange that if I don't have this option, the two methods returns different results, I don't know the internals of ActiveRecord, maybe this is a bug there.. The character is escaped: https://daringfireball.net/projects/markdown/syntax#backslash. This link is broken, or am I missing something?. Also this link seems to be broken. ",
    "Segellion": "I'm not sure if that's compatible? I work through installing alchemy, to come to this error after adding alchemy-solidus to my gemfile:\nBundler could not find compatible versions for gem \"alchemy_cms\":\n  In snapshot (Gemfile.lock):\n    alchemy_cms (= 4.1.0.beta)\nIn Gemfile:\n    alchemy_cms\nalchemy-devise was resolved to 4.1.0.beta, which depends on\n  alchemy_cms (< 4.99, >= 4.0.0.beta)\n\nalchemy-solidus was resolved to 1.0.0, which depends on\n  alchemy_cms (~> 3.2)\n\nRunning bundle update will rebuild your snapshot from scratch, using only\nthe gems in your Gemfile, which may resolve the conflict.\nAnd after running bundle update came to this error:\nBundler could not find compatible versions for gem \"alchemy_cms\":\n  In Gemfile:\n    alchemy_cms\nalchemy-devise was resolved to 4.1.0.beta, which depends on\n  alchemy_cms (< 4.99, >= 4.0.0.beta)\n\nalchemy-solidus was resolved to 1.0.0, which depends on\n  alchemy_cms (~> 3.2). I'm currently trying to get static pages working with Solidus. Maybe alchemy isn't the best choice? I can't get it to work. But there is a gem for Solidus static pages... which also seems to use deprecated libraries.\n\nsolidus_static_content was resolved to 1.0.0, which depends on\n      deface (~> 1.0.2)\nAm I going about this all wrong? I have spent the past two days juggling between deprecated gems.. Because I could not get a CMS running with Solidus, I attempted to use the solidus_static_content gem. Which is is unable to install due to deface being outdated. I had posted my attempt earlier. but this is the error I receive when I attempt to install solidus_static_content:\nsolidus_static_content was resolved to 1.0.0, which depends on\ndeface (~> 1.0.2). I'm sorry, i've deviated from the original topic of this thread. I'm no longer working with refineryCMS because I figured the solidus_static_content gem would be easier.\nI have since managed to get it running (albeit the documentation is out of date and needs an update)\nMy rails instance is running again! Although I get the following error displayed in my browser when I hit localhost:\nPG::UndefinedTable: ERROR: relation \"spree_pages\" does not exist LINE 8: WHERE a.attrelid = '\"spree_pages\"'::regclass ^ : SELECT a.attname, format_type(a.atttypid, a.atttypmod), pg_get_expr(d.adbin, d.adrelid), a.attnotnull, a.atttypid, a.atttypmod, c.collname, col_description(a.attrelid, a.attnum) AS comment FROM pg_attribute a LEFT JOIN pg_attrdef d ON a.attrelid = d.adrelid AND a.attnum = d.adnum LEFT JOIN pg_type t ON a.atttypid = t.oid LEFT JOIN pg_collation c ON a.attcollation = c.oid AND a.attcollation <> t.typcollation WHERE a.attrelid = '\"spree_pages\"'::regclass AND a.attnum > 0 AND NOT a.attisdropped ORDER BY a.attnum. ",
    "askl56": "Given that PR has been merged, can this be closed? @swcraig . Is there any update on this being merged/where it fits into the roadmap?. Anyone on this?. @gmacdougall Happy to help in any way I can. Any update on this?. ",
    "derrickp": "I've added a new spec to order_cancellations and I've refactored the spec in unit_cancel so that it doesn't do a reload anymore.. I tried that, but the line items that are on the inventory units were all different objects that pointed to the same line item record. So each time the code came through the adjustment_total was still at 0.. It worked for me in the spec as well, but once I tried it in the sandbox app it failed. I will try again however and see if it was just a fluke failure.. The only time you'd need to modify this list specifically was if you wanted to change the MailProcessor list, which as @cbrunsdon mentioned eventually might be pulled out entirely. \nHowever, if all you wanted to do was subscribe to the same event, any other object can call Spree::Config.event_bus.subscribe(:order_cancelled, OTHER_PROC) and it will not change the existing subscriptions. You can have any number of subscribers to an event, so a store can fairly easily call that function to add themselves to the list if they had some functionality they wanted to made sure happened in response to the event. The only concern then is that they call subscribe early enough in the startup of the app so as to be able to get the events when they happen. . ",
    "aldesantis": "@kennyadsl @derrickp FYI, there's also a problem with taxes when cancelling items. The taxes should be subtracted from line_item.total because they're already recalculated on top of the new net total:\nruby\n-((line_item.total - line_item.additional_tax_total).to_d / line_item.inventory_units.not_canceled.reject(&:original_return_item).size). Improved this with a better, configurable design that doesn't require opening and modifying SimpleCoordinator.. @kennyadsl this was documented in the guides. Please let me know how they look.. @kennyadsl done.. @gmacdougall addressed.. @BenMorganIO @tvdeyen @kennyadsl I addressed the requested changes (sorry for the delay!) in separate commits so you can look at them. Let me know if it all looks good and I will squash the commits together.\nEDIT: Nevermind, squashed now per @kennyadsl's request.. @tvdeyen @BenMorganIO I think this might be ready for merging?. @kennyadsl sorry about that, it should be okay now.. \ud83c\udf89 . @spaghetticode do you have any use cases/suggestions here? If you can make an example of a situation where you've had to define an app-wide preference that would be great.\nOne of the options I have in mind is defining your own module for app/engine-level preferences, e.g.\n```ruby\nmodule MyExtension\n  class Configuration\n    attr_accessor :dummy_preference\n  end\ndef self.config\n    @configuration ||= Configuration.new\n  end\ndef self.configure\n    yield config\n  end\nend. @kennyadsl agreed!. @BenMorganIO you mean on this specific method or in the guides?. @kennyadsl the problem with that is if someone overrides @stock_locations and we sort in a different variable (let's say @sorted_stock_locations), they also have to override @sorted_stock_locations, otherwise it will contain the result of the sorting of the original @stock_locations variable.. @kennyadsl fixed.. @BenMorganIO I agree that it's weird, but this is how specs are written for the other models too (including type: :model), so I chose to stick with the convention here.. Whoops, fixing!. @kennyadsl this was fixed, can you check?. *Rails. ",
    "HuntBurdick": "The issue was in pages_controller.rb\nI was inheriting from ApplicationController and not Spree::Admin::BaseController.. ",
    "lgiacalone3": "@luukveenis fixed!. @jhawthorn @luukveenis Just removed that last commit that replaced the text_field with a number_field.. ",
    "kochis": "I realize this is over a year old, but wanted to check if there's any update on this.\nAlso wanted to say that I really like the idea of an event / pub-sub based solution for handling all the different state transitions that can occur. This was actually something that was a major pain-point for us (callback-hell), and we even made a couple attempts at implementing it ourselves.\nUltimately, I think the biggest challenge was knowing all the different types of events that could occur. It would be great if there was a way to compile a list of all the different transactions could occur / would make sense to hook into. I guess really it's any model change, so maybe ActiveSupprt::Notifications makes the most sense, but coming with a list of events before implementing might be a good way to track progress on the issue.\nAnyways, love this idea, and think it would be solving a major pain point for a lot of developers \ud83d\ude4c . ",
    "aaronlifton2": "I really like this idea - the only problems I see are not being able to easily modify or delete the default spree subscriptions.. Ahh ok, thanks. Will do.. I thought about this, perhaps using css columns would work better than nested tables here? Unless you already got it working.. Why not use angular or react for the backend instead? A collection of jquery code has made it kind of hard to add more js features to the backend, at least for me. I ended up putting angular in the solidus backend.. ",
    "skanderm": "\nIf someone can give me an example of why you'd want to add a new adjustable or create custom adjustments, I would love to learn more about it.\n\nI've been looking for an easy way to add positive adjustment fees/charges based on rules, and I think I need a custom adjuster. Specifically, I need the opposite of a promotion - i.e. a charge if there's only 1 item of a specific product or a charge per quantity of another product (such as a disposal fee).\nI was directed to look into creating custom calculators, but I don't think charges/fees fit wherever promotions are called.. ",
    "halo": "I believe polyamorous has been fixed in https://github.com/activerecord-hackery/polyamorous/pull/28 and ransack has been fixed in https://github.com/activerecord-hackery/ransack/pull/868. ",
    "damienlethiec": "Hi @jhawthorn \nSorry to come back to you! Rails 5.2.0.rc2 is out (http://weblog.rubyonrails.org/2018/3/20/Rails-5-2-RC2/). Any news about the status of the gems Solidus depends on? Do you know when will we be able to use Solidus with Rails 5.2?\nThanks a ton :). Hello @jhawthorn :)\nAny news?\nThanks a lot!! :). Hello @jhawthorn . Thanks for the great work. I am beginning a new solidus app with Rails 5.2 soon. Should I use the Github version of the gem for the moment? When with the 5.2 compatible version of Solidus released? Thank you :). Thanks a ton for the answer!! Any idea of when a compatible version could be ready (even if I understand you don't have any control over CanCanCan). Great, thank you!. ",
    "benbonnet": "just tried on 5.2, source in the gemfile from master; getting the following :\nsolidus was resolved to 2.6.0.alpha, which depends on\n      solidus_core (= 2.6.0.alpha) was resolved to 2.6.0.alpha, which depends on\n        actionpack (~> 5.1.0)\nthis one  sound like it should work, but it's not at it yet probably ?. ",
    "grichardomi": "Admin - Edit Product Details,  option types and taxons not translating might be a JS issue\nI will accept cost proposal from anyone who can help fix this problem. Please respond to: cedarcity21@gmail.com\n . Alberto,\nThanks for responding. I did not check the front-end. It is the back-end,\nthat I'm most concerned about.\nGuy\nhttps://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=webmail&utm_term=icon\nVirus-free.\nwww.avast.com\nhttps://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=webmail&utm_term=link\n<#DAB4FAD8-2DD7-40BB-A1B8-4E2AA1F9FDF2>\nOn Sun, Jan 21, 2018 at 1:36 AM, Alberto Vena notifications@github.com\nwrote:\n\nDo you mean in frontend checkout, address step?\n\u2014\nYou are receiving this because you authored the thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/solidusio/solidus/issues/2519#issuecomment-359235422,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AY00NuA3HEIp4r-0SaGBX-yU1yxlqplaks5tMwUNgaJpZM4RljgN\n.\n. Thanks John for the feedback.\n\nAdmin -> user -> address was not working in my solidus app. So I cloned and\nran sandbox version over two weeks ago. States are not working for me.\nThere could something abnormal, not necessarily the sandbox but in my\nserver environment. I'm using ubuntu instance. Is this possible?\nhttps://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=webmail&utm_term=icon\nVirus-free.\nwww.avast.com\nhttps://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=webmail&utm_term=link\n<#DAB4FAD8-2DD7-40BB-A1B8-4E2AA1F9FDF2>\nOn Tue, Jan 30, 2018 at 11:25 AM, John Hawthorn notifications@github.com\nwrote:\n\nI can't reproduce this, it is working here. Can you provide more details?\nhttps://camo.githubusercontent.com/cf75bc2b109b34a967662106e40deb7bd3408745/687474703a2f2f692e68617774682e63612f732f70443748657055422e706e67\n\u2014\nYou are receiving this because you authored the thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/solidusio/solidus/issues/2519#issuecomment-361705810,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AY00Nt0QwnAu_SDlHwBfXTN-I1uXj8Tpks5tP2zGgaJpZM4RljgN\n.\n. Let's say I have \"Builders, States and  Services\" taxonomies. In Admin Edit Product, all Taxons for builders, states, and services are listed in the dropdown list.\n\nI would like to be able to filter which taxonomies get listed. In this case, I would like the dropdown list box to list only \"Services\" taxons. \nWould like to see this:\nServices -> Senior Care\nServices -> Nurse \nDo not want this:\nBuilders -> Wall\nBuilders-> Mason\nServices -> Senior Care\nServices -> Nurse \nStates -> Utah\nStates -> Texas\n. Managed to get this work by modifying taxon_autocomplete.js. ",
    "pelargir": "@mamhoff done!. ",
    "DanielAmah": "I will love to fix this bug if no one is working on it. Thanks. ",
    "codias": "Thank you very much for the quick response and you were right.\nChanged it to rails '>= 5.1' now all is working fine.\nthx. ",
    "bitberryru": "I found this bug too.\nThis behavior is caused by this code (https://github.com/solidusio/solidus/blob/master/core/app/models/spree/product/scopes.rb#L65)\nadd_search_scope :in_taxon do |taxon|\n      includes(:classifications).\n      where(\"spree_products_taxons.taxon_id\" => taxon.self_and_descendants.pluck(:id)).\n      order(Spree::Classification.arel_table[:position].asc)\nend\nAnd there is not a single chance that it will work correctly for products attached to several taxons that coincide with the condition\nwhere(\"spree_products_taxons.taxon_id\" => taxon.self_and_descendants.pluck(:id))\nIt looks like this bug was born when positions was added to classifications (products_taxons).\nFor quick fix you can override this scope.\nadd_search_scope :in_taxon do |taxon|\n      includes(:classifications).\n      where(\"spree_products_taxons.taxon_id\" => taxon.id).\n      order(Spree::Classification.arel_table[:position].asc)\nend\n. Changed commit message, is it okay now?. Just try to visit this page with russian locale and you will get exception.. \nException screenshot, just visit /admin/promotion_categories?locale=ru\nP.S. Spree also has this bug last 2 years. Also I never saw that count parameter was not numerical. Everywhere it is number. It is assumed by pluralization rules that it will be a number, check it https://github.com/svenfuchs/rails-i18n/tree/master/lib/rails_i18n/common_pluralizations - everywhere comparisons only with numbers.\nThis code is just randomly working correctly for the English language.. I have not found more similar errors (via grep), but if I notice something like this I will definitely make a pool request! Solidus is great project with clean code (in comparison with spree) and I will help make it better :). Yep, you are right. I fixed it.. Now using plural_resource_name in spec.\nSquashed into one commit.. Thought that branch name will be enough.\nCommit message changed :). Squashed. > @bitberryru failures should go away if you rebase against master, thanks!\nThank you, done.. Also, In solidus_gateway I noticed these partials https://github.com/solidusio/solidus_gateway/tree/master/lib/views/backend/spree/admin/log_entries\nBut I did not find support of these partials in solidus. Seems that long time ago there was custom log entry rendering, in history I found this commit https://github.com/spree/spree/issues/5475\nWhat you think about returning back this feature?. I would also suggest to stop using the *_decorator*.rb pattern for preloading overrides.\nFirst, technically in these files are not decorators, rather patches/overrides.\nSecondly, when you use gem draper rails preloads draper's decorators too. This is unlikely to lead to problems, but it does not look pretty :)\nI suggest using *_override*.rb. > I'm just wondering what happens with this Pull rails dependency out of core into solidus_rails PR that we want to merge before the 3.0 release. Will we need to change something there as well in your opinion?\nAutoloading provided by ActiveSupport and it definitely should be used in new solidus_core gem (without rails).\n\nI think it's just matter of choosing the new pattern. I'll open an issue about it.\n\nYep, It is actual only for new projects. Thanks :). Of course, I support it :)\nThe name should be changed, it will not break anything but this will be consistent with the principle of least surprise/astonishment. It is ruby way for sure.\n\nMaybe would be good to fix Rails docs too\n\nIt would be great \ud83d\udc4d\ud83c\udffb\ud83d\udc4d\ud83c\udffb\ud83d\udc4d\ud83c\udffb. @mdesantis As far as I understand, you are trying to re-invent \"prepend\" :)\nFor my application, I use my own Spree::Extension module, which is very similar to ActiveSupport::Concern except one thing - my \"concern\" prepending, not including.\napp/lib/spree/extension.rb\n```\nmodule Spree\n  module Extension\n    def prepend_features(base)\n      super\n      base.singleton_class.prepend const_get('ClassMethods') if const_defined?(\"ClassMethods\")\n      base.class_eval(&@_overrode_block) if instance_variable_defined?(:@_overrode_block)\n    end\ndef overrode(&block)\n  raise MultipleIncludedBlocks if instance_variable_defined?(:@_overrode_block)\n  @_overrode_block = block\nend\n\ndef class_methods(&class_methods_module_definition)\n  mod = const_defined?(:ClassMethods, false) ?\n            const_get(:ClassMethods) :\n            const_set(:ClassMethods, Module.new)\n\n  mod.module_eval(&class_methods_module_definition)\nend\n\n# This method prepends extension to appropriate class (ex. SomeClassNameOverrideSomething to SomeClassName)\ndef override!(delimiter = 'Override')\n  overridable_class = Object.const_get(self.to_s.split(delimiter).first)\n  overridable_class.prepend(self)\nend\n\nend\nend\n```\nAnd typical override looks like\napp/controllers/spree/checkout_controller_override_processing_offsite.rb\n```\nmodule Spree\n  module CheckoutControllerOverrideProcessingOffsite\n    extend Spree::Extension\noverrode do\n  before_action :check_important_things, only: [:update]\nend\n\nprivate\n\ndef completion_route\n  return custom_path(...) if condition?\n  super\nend\n\ndef check_important_things\n   # ...\nend\n\noverride! # same as Spree::CheckoutController.prepend(self)\n\nend\nend\n```\nAs you see you can use super because your patch will be prepended, not included, it happens when you call override! inside it.\nThis allows you to extend any external classes and use inheritance features like you're declaring a child class.. The point is that I want to test that the answer contains exactly validation errors same as in other resource controller's actions\nFor example:\nhttps://github.com/solidusio/solidus/blob/518765fd145b7072d80c141503cea2cce484793f/backend/spec/controllers/spree/admin/resource_controller_spec.rb#L97. This validation is only for testing as you can see. Adding it to en.yml is weird. But if you do not like the phrase itself, then you can offer absolutely any one to your taste.. @jacobherrington done. Done. ",
    "VzqzAc": "Thanks for your response @jhawthorn, I'd also prefer not to use it but yeah, it's necessary, in case current_shipment is deleted it is frozen at the time order.updater.update is called and causes runtime errors while trying to update item adjustments in OrderUpdater model. I started working on fixing this, I've rebased against master (heroku's master) in a fork I have, looks like the highlighted line @kennyadsl points is not the problem per se, after rebasing I'm getting\nbash\n/app/tmp/buildpacks/5d51a38112e2190359fa255183c8bd4ece02a1addd9e6b285cccd67eb2ff9771a87dd90fe05d6ec64f7aca596e8c18c171474ac464cd56b347ece7c9ae3586ad/lib/language_pack/helpers/bundler_wrapper.rb:130:in `read': No such file or directory @ rb_sysopen - ./Gemfile.lock (Errno::ENOENT)\nwhich should not happen since the Gemfile.lock is in the root path of the buildpack folder? I'm not familiar with the heroku buildpack flow/logic though, so I might be missing something. . I got the button to work again after some dirty monkey patches on both this repo and the heroku-buildpack-solidus-demo one, you can try it here, this is for sure not a good solution, I'm still playing around to find a proper one and I have some suspicions on the solidus.rb file on the buildpack repo, but in case you want to check there's my work so far\nUpdate: I've broken it again, since I'm still playing with it. Pretty much the change I made was actually committing the Gemfile.lock into solidus (\ud83d\udeab) since after rebasing with heroku's master (base of this fork) it complains about the Gemfile.lock not existing, I removed the --skip-bundle flag from the sandbox creation here and added the bundler gem but it is still not adding the file, of course what I did is not desired at all \ud83d\ude05 but the info might help someone trying to fix this too.\nUpdate 2: I'm thinking that the problem is the .gitignore file in solidus, it includes the Gemfile.lock which makes sense since it's a gem, but might be screwing up the actual deploy? I think this would be better to be discussed on slack.... Issued on polyamorous/Related?: https://github.com/activerecord-hackery/polyamorous/issues/45 and https://github.com/activerecord-hackery/polyamorous/issues/46\nAlso seems like any migration with joins will fail, not only remove_order_id_from_inventory_units but looks like that's the first one using it in our queue. I agree with that @jacobherrington, having a product that does not track inventory to actually count the inventory might be a very special use case. In the projects I've worked on we have different images for each variant, so I think that showing the master variant's image could lead the user to think they're choosing that variant.\nBut I think @jacobherrington has a point too, users that can use the admin panel, and add products to orders, might have better knowledge of the application flow and thus rely on SKUs to make sure it's the variant they want.\nStill, I think that relying on the master variant could have some UX issues. Right @sechix, we should keep consistency in this case in my opinion, if the way it is showed in this part changes, it should come along with many other places updated, so might be better to keep it as is in the rest of the project. By a bit of investigation, I see that the problem is that https://github.com/solidusio/solidus/blob/master/frontend/app/controllers/spree/checkout_controller.rb#L54 which invokes https://github.com/solidusio/solidus/blob/master/core/app/models/spree/order_update_attributes.rb#L18-L25 does not perform a ship address update, I thought on a way to solve it, by following kind of what is being made with the payments in the same class, something like\n```ruby\n    def apply\n      order.validate_payments_attributes(@payments_attributes)\n  assign_order_attributes\n  assign_payments_attributes\n  assign_ship_address_attributes unless order.use_billing.in?([true, 'true', '1']) # Or moving the `Spree::Order#use_billing?` method to be public and call it\n\n  order.save\nend \n# ...\ndef assign_ship_address_attributes\n    # update order.ship_address attributes\nend\n\n```\nBut I'm not sure if this is a path we'd like to follow, that was just my first thought to fix this. I agree on that @kennyadsl, solving this by resetting the value on the frontend does not perform a final solution, however, it would be good to still finalize #2417 so we send the proper params in the request.\nI do also like @cedum's approach, normalization of the state if needed (which is this bug), and validate the state (since the validate state is receiving a non-normalized state here because of the previous method)\nhttps://github.com/solidusio/solidus/blob/6b5c90034f1406b53982bde35ad69295878393b4/core/app/models/spree/address.rb#L216-L220. ",
    "crashtech": "Current version of rails doesn't support group  method on association.. ",
    "fkoessler": "Hello, I'd like to follow up on this issue and am available to work on a PR to allow shipping cost refund.\nSince a Shipment is not something one can return, we could work with a Reimbursement instance that has no associated ReturnItems?\nWe should somehow link the Reimbursement to the Shipment though. This could be done by adding an optional relation between Reimbursements and Shipments. How does that sound?\nFrom the UX point of view, should we add a new \"Refund\" tab that allows refunding all kind of non returnable items ? (I can only think of shipments for the moment) or should we add a line for shipping costs in the Customer return tab as shown in @loicginoux 's screenshot?\nI think both options have their pros and cons.\nI'm interested in your feedback.. I've been working on shipping costs refunds, here's where I stand so far:\nModels\nI added a new Settlement model.\nIt is similar to the ReturnItem model.\nIt is used to store how much we want to refund for a shipment (as well as keeping track of status).\nIt could potentially be used later to store how much to refund for something else than a shipment, as long as it's not a return item.\nHere's a class diagram that shows the associations:\n\nUX\nIt doesn't make sense to edit the settlements when picking items to return (shipments are not things you can return).\nThat's why I suggest to allow creating settlement when editing the reimbursement.\nThe UX could look like this:\n\nPlease share your feedbacks.\nWould this new feature be considered for merging?. Similarly to the customer returns table, the shipments table could have a \"Amount before tax\" column as well as a \"Total\" column, instead of \"Amount\" and \"Total\":\n\n. Thanks a lot for taking the time to review this PR.\nMy experience is that adjustments are not adapted for refunds because:\n- a negative adjustment will recompute the order's total amount and change its status to 'credit owed', which does not reflect the reality\n- after the adjustment is created, we still have to create a reimbursement of the same amount as the adjustment\n- it makes it difficult to analyse what has happened, we need to look at adjustment labels to identify refunds. This is much easier done if refunds are stored in a settlement table\nShipping cost refunds is very common in Europe in our line of business.\nSettlements could also allow for more than just refunding shipping costs, it's actually a model that can be used to store any kind of refund / compensation.\nFor example, it could be used to store a commercial gesture. In this case, the settlement would not be associated with a shipment. To allow for such feature, the model can be kept as is, it's just a matter of adding the UI to allow for this action.\nI would not say this is a minor feature.\nThat being said, I understand the reticence to introduce another model with its database table that will need to be maintained.\nLet us know your decision about what should be done: document / improve & merge or create a solidus extension.\nAnd thanks again for the great work on solidus :). This is actually the same issue as https://github.com/solidusio/solidus/issues/2645.\nNote that you won't be able to reproduce the bug if you have a user with email spree@example.com. Hello @aitbw \nOK, I'll provide a spec or a PR for this issue when I have a bit more time.. ",
    "Ruberto": "\ud83d\udc4d  It does the same thing if you set the currency to ZAR.\nI have also set the default currency in the system settings on the admin page while the app was running with no change. . I managed to get around the issue, I did some byebug's and found that the line_item on the order was not valid, just as you mentioned @jacobherrington. I also noticed the currency in the line_item was set to the previous currency. I deleted all the orders/line_items in the DB, and now I can add things to my cart just fine.. ",
    "mihado": "I started a proof of concept:\nhttps://github.com/valiants/solidus_graphql\nhttps://github.com/mihado/test_solidus_graphql/blob/master/app/graphql/types/query_type.rb\nAt this stage, I aim to create a read only graphql end point which will provide products & variants.. hi @elia, do you know how I can configure the upload to use a path within a bucket, instead of uploading everything to the root path of a bucket? thanks. this should be config.taxon_attachement_module. ",
    "gianlucarizzo": "I think it's all okay now. fixed!. ",
    "nxtbz": "Mysql failure?. ",
    "Leoxxid": "I can do this? I want start in the open source world. . I can do this? I want start in the open source world. . ",
    "jgayfer": "@tvdeyen Thanks for all the great feedback! I've gone ahead and made most of the requested changes. \nI haven't pulled out the change_state! method into a module yet, as I wasn't able to decide on the best way to do so. While there is shared functionality in the change_state! method, the four models in question use it a bit differently. For example, not all of the models need to create a StateChange, creating a StateChange requires a value for it's name, and Reimbursement uses the reimbursement_status attribute instead of state. It's entirely possible to pull it out into a module, but because of the reasons just mentioned, my initial sketch had more parameters than I would have liked.\nWith all that being said, I'd love to hear any insight you may have on a better way to pull out the shared functionality!\nLastly, in regards to things like CANCELABLE_STATES on inventory units (and other constants) and potentially turning them into methods (or adding them to the config), I haven't made any changes yet. I wasn't sure if this was something we were wanting to look into now, or if it should be a future change instead.\nThanks again for taking time to review my work. @tvdeyen I made the change regarding the database migration (which definitely makes sense). I will make this change to my other PRs early next week.\nRegarding ActiveModel::Dirty, I just want to confirm that the goal is to use it to check what the previous state was without having to assign an extra variable? (For example, when I use previous_state to make note of what the original state was).. @tvdeyen Changes have been made.\nI wasn't entirely sure exactly how someone might want to go about changing what states are valid, so I tried to keep the options open.\nThere is a new constant VALID_STATES which can be overridden should someone desire to change what states are allowed. I also added a validation function validate_state which checks to see if the current state is included in VALID_STATES. The inclusion of this function allows for a potentially more detailed custom state validation process as changing the VALID_STATES constant may not cover every use case.. @tvdeyen Changes have been made :+1: . @tvdeyen Requested changes have been made. See my comments on #2656 . @tvdeyen I've changed the database migration to use the actual value. Same question applies as in #2656  about ActiveModel::Dirty though.. @tvdeyen Made some changes. See my comments on #2656.. @tvdeyen Changes have been made :+1: . @tvdeyen Changes have been made. See my comments on #2656. Thanks for the input!. @tvdeyen I've changed the database migration to use the actual value. Thanks for reviewing my work!. @tvdeyen Thanks for pointing this out, didn't notice some were failing. Will get to it this week.. @tvdeyen Specs are green now :heavy_check_mark: . @tvdeyen Made some changes. Please see my comment on #2656.. @tvdeyen Changes have been made :+1: . @tvdeyen Made some of the requested changes! See my comments on #2656.. @tvdeyen I've changed the database migration to use the actual value. Same question applies as in #2656  about ActiveModel::Dirty though.. @tvdeyen Made the requested changes. Check out my comment on #2656.. @tvdeyen Changes have been made :+1: . Accident. @kennyadsl Done!. @tvdeyen I've rebased against master. @tvdeyen Rebased. Will do!. Oh, just realised the frozen_string_literal at the top of the file takes care of this already.. @kennyadsl No, it's not. It was just a template/example of the styles we are using. I'll remove it!. ",
    "stem": "Hi,\nIn order to not loose what Kevin said on slack a few days ago, I paste it here : \n - this was probably intentionally remove here 96a553d\n - and extracted to solidusio-contrib/solidus_stock_transfers\n - but the associations snuck back in here 747293a\n. @kennyadsl yes I agree for the UI but I thought that there was a reason to not use the plural form in https://github.com/solidusio/solidus/blob/f26550641f103d43bdb850bae23c74c0e20f8542/core/config/locales/en.yml#L1203\nFor the variables part, I don't understand where you want me to pluralize @promotion_code. Most of them are for a single code as it lets the user create a new code and the only one I find for multiple codes is already in its plural form. @kennyadsl done and it's \u2705 . According to https://opensource.guide/code-of-conduct/, this draft lacks some points : \n- What happens if someone violates the code of conduct\n- How someone can report violations\nI think the the Contributor Covenant is good and used as a base by rails. @kennyadsl yes, we should do an includes, but I don't know on what relation we can do it.\nawesome_nested_set does not seem to define a has_many ancestors so I'm not sure if we can take that road. I've asked them for advice because I don't see any \"clean\" way to resolve this. If they can point us to a good direction, we should probably refactor pretty_name and permalink to work the same way (using ancestors or parent but not both)\nThe \"wrong\" / \"ugly\" way could be to refactor pretty_name to recursively preload all parent_id we found with something like : \n```\ndef index\n  @taxons = ....\n  preload_ancestors(@taxons)\nend\ndef preload_ancestors(taxons)\n  return if taxons.empty?\nActiveRecord::Associations::Preloader.new.preload(taxons, [:parent])\n  preload_ancestors(taxons.map(&:parent).compact)\nend\n```\nThis is really ugly, and will generate 1 query per level of the selected taxon's maximum depth. It may or may not be more efficient than 1 query per taxon, depending of the number of taxons listed and the maximal depth selected \ud83d\ude1e \n. I understand your concerns about associate_parents but it's publicly defined on the model using act_as_nested_set, so I don't think this method is intended to be internal.\nConcerning bullet, I don't know how to use it.\nBecause the product's page on the backend use the taxons api, I've logged the SQL queries for a product with 8 taxons : \n\nwithout this PR : \n```\nStarted GET \"/api/taxons?ids=7%2C9%2C3%2C4%2C5%2C6%2C8%2C10&per_page=8&without_children=true\" for 127.0.0.1 at 2018-12-24 09:08:36 +0100\nProcessing by Spree::Api::TaxonsController#index as JSON\n  Parameters: {\"ids\"=>\"7,9,3,4,5,6,8,10\", \"per_page\"=>\"8\", \"without_children\"=>\"true\"}\n  Spree::User Load (0.3ms)  SELECT  \"spree_users\". FROM \"spree_users\" WHERE \"spree_users\".\"deleted_at\" IS NULL AND \"spree_users\".\"spree_api_key\" = ? LIMIT ?  [[\"spree_api_key\", \"ac228f7e112cf85bb4f238563d63831b472140d87eef4771\"], [\"LIMIT\", 1]]\n   (0.2ms)  SELECT \"spree_roles\".\"name\" FROM \"spree_roles\" INNER JOIN \"spree_roles_users\" ON \"spree_roles\".\"id\" = \"spree_roles_users\".\"role_id\" WHERE \"spree_roles_users\".\"user_id\" = ?  [[\"user_id\", 1]]\n  Spree::Role Load (0.2ms)  SELECT \"spree_roles\". FROM \"spree_roles\" INNER JOIN \"spree_roles_users\" ON \"spree_roles\".\"id\" = \"spree_roles_users\".\"role_id\" WHERE \"spree_roles_users\".\"user_id\" = ?  [[\"user_id\", 1]]\n\n(0.2ms)  SELECT COUNT() FROM (SELECT  1 AS one FROM \"spree_taxons\" WHERE \"spree_taxons\".\"id\" IN (?, ?, ?, ?, ?, ?, ?, ?) LIMIT ? OFFSET ?) subquery_for_count  [[\"id\", 7], [\"id\", 9], [\"id\", 3], [\"id\", 4], [\"id\", 5], [\"id\", 6], [\"id\", 8], [\"id\", 10], [\"LIMIT\", 8], [\"OFFSET\", 0]]\n   (0.2ms)  SELECT COUNT() FROM \"spree_taxons\" WHERE \"spree_taxons\".\"id\" IN (?, ?, ?, ?, ?, ?, ?, ?)  [[\"id\", 7], [\"id\", 9], [\"id\", 3], [\"id\", 4], [\"id\", 5], [\"id\", 6], [\"id\", 8], [\"id\", 10]]\nSpree::Taxon Load (0.2ms)  SELECT  \"spree_taxons\".* FROM \"spree_taxons\" WHERE \"spree_taxons\".\"id\" IN (?, ?, ?, ?, ?, ?, ?, ?) LIMIT ? OFFSET ?  [[\"id\", 7], [\"id\", 9], [\"id\", 3], [\"id\", 4], [\"id\", 5], [\"id\", 6], [\"id\", 8], [\"id\", 10], [\"LIMIT\", 8], [\"OFFSET\", 0]]\nSpree::Taxon Load (0.2ms)  SELECT \"spree_taxons\". FROM \"spree_taxons\" WHERE \"spree_taxons\".\"lft\" <= 2 AND \"spree_taxons\".\"rgt\" >= 3 AND (\"spree_taxons\".\"id\" != 3) ORDER BY \"spree_taxons\".\"lft\" ASC\n  Spree::Taxon Load (0.2ms)  SELECT \"spree_taxons\". FROM \"spree_taxons\" WHERE \"spree_taxons\".\"lft\" <= 4 AND \"spree_taxons\".\"rgt\" >= 5 AND (\"spree_taxons\".\"id\" != 4) ORDER BY \"spree_taxons\".\"lft\" ASC\n  Spree::Taxon Load (0.2ms)  SELECT \"spree_taxons\". FROM \"spree_taxons\" WHERE \"spree_taxons\".\"lft\" <= 6 AND \"spree_taxons\".\"rgt\" >= 11 AND (\"spree_taxons\".\"id\" != 5) ORDER BY \"spree_taxons\".\"lft\" ASC\n  Spree::Taxon Load (0.2ms)  SELECT \"spree_taxons\". FROM \"spree_taxons\" WHERE \"spree_taxons\".\"lft\" <= 7 AND \"spree_taxons\".\"rgt\" >= 8 AND (\"spree_taxons\".\"id\" != 6) ORDER BY \"spree_taxons\".\"lft\" ASC\n  Spree::Taxon Load (0.2ms)  SELECT \"spree_taxons\". FROM \"spree_taxons\" WHERE \"spree_taxons\".\"lft\" <= 9 AND \"spree_taxons\".\"rgt\" >= 10 AND (\"spree_taxons\".\"id\" != 7) ORDER BY \"spree_taxons\".\"lft\" ASC\n  Spree::Taxon Load (0.2ms)  SELECT \"spree_taxons\". FROM \"spree_taxons\" WHERE \"spree_taxons\".\"lft\" <= 14 AND \"spree_taxons\".\"rgt\" >= 15 AND (\"spree_taxons\".\"id\" != 8) ORDER BY \"spree_taxons\".\"lft\" ASC\n  Spree::Taxon Load (0.2ms)  SELECT \"spree_taxons\". FROM \"spree_taxons\" WHERE \"spree_taxons\".\"lft\" <= 16 AND \"spree_taxons\".\"rgt\" >= 17 AND (\"spree_taxons\".\"id\" != 9) ORDER BY \"spree_taxons\".\"lft\" ASC\n  Spree::Taxon Load (0.2ms)  SELECT \"spree_taxons\". FROM \"spree_taxons\" WHERE \"spree_taxons\".\"lft\" <= 18 AND \"spree_taxons\".\"rgt\" >= 19 AND (\"spree_taxons\".\"id\" != 10) ORDER BY \"spree_taxons\".\"lft\" ASC\nCompleted 200 OK in 134ms (Views: 123.7ms | ActiveRecord: 2.9ms)\n```\n\nwith this PR : \n```\nStarted GET \"/api/taxons?ids=7%2C9%2C3%2C4%2C5%2C6%2C8%2C10&per_page=8&without_children=true\" for 127.0.0.1 at 2018-12-24 09:07:21 +0100\nProcessing by Spree::Api::TaxonsController#index as JSON\n  Parameters: {\"ids\"=>\"7,9,3,4,5,6,8,10\", \"per_page\"=>\"8\", \"without_children\"=>\"true\"}\n  Spree::User Load (0.4ms)  SELECT  \"spree_users\". FROM \"spree_users\" WHERE \"spree_users\".\"deleted_at\" IS NULL AND \"spree_users\".\"spree_api_key\" = ? LIMIT ?  [[\"spree_api_key\", \"ac228f7e112cf85bb4f238563d63831b472140d87eef4771\"], [\"LIMIT\", 1]]\n   (0.2ms)  SELECT \"spree_roles\".\"name\" FROM \"spree_roles\" INNER JOIN \"spree_roles_users\" ON \"spree_roles\".\"id\" = \"spree_roles_users\".\"role_id\" WHERE \"spree_roles_users\".\"user_id\" = ?  [[\"user_id\", 1]]\n  Spree::Role Load (0.2ms)  SELECT \"spree_roles\". FROM \"spree_roles\" INNER JOIN \"spree_roles_users\" ON \"spree_roles\".\"id\" = \"spree_roles_users\".\"role_id\" WHERE \"spree_roles_users\".\"user_id\" = ?  [[\"user_id\", 1]]\n\nSpree::Taxon Load (0.4ms)  SELECT  \"spree_taxons\".* FROM \"spree_taxons\" WHERE \"spree_taxons\".\"id\" IN (?, ?, ?, ?, ?, ?, ?, ?) LIMIT ? OFFSET ?  [[\"id\", 7], [\"id\", 9], [\"id\", 3], [\"id\", 4], [\"id\", 5], [\"id\", 6], [\"id\", 8], [\"id\", 10], [\"LIMIT\", 8], [\"OFFSET\", 0]]\nSpree::Taxon Load (0.2ms)  SELECT \"spree_taxons\".* FROM \"spree_taxons\" WHERE (((((((\"spree_taxons\".\"lft\" < 2 AND \"spree_taxons\".\"rgt\" > 3 OR \"spree_taxons\".\"lft\" < 4 AND \"spree_taxons\".\"rgt\" > 5) OR \"spree_taxons\".\"lft\" < 6 AND \"spree_taxons\".\"rgt\" > 11) OR \"spree_taxons\".\"lft\" < 7 AND \"spree_taxons\".\"rgt\" > 8) OR \"spree_taxons\".\"lft\" < 9 AND \"spree_taxons\".\"rgt\" > 10) OR \"spree_taxons\".\"lft\" < 14 AND \"spree_taxons\".\"rgt\" > 15) OR \"spree_taxons\".\"lft\" < 16 AND \"spree_taxons\".\"rgt\" > 17) OR \"spree_taxons\".\"lft\" < 18 AND \"spree_taxons\".\"rgt\" > 19)\n(0.2ms)  SELECT COUNT() FROM (SELECT  1 AS one FROM \"spree_taxons\" WHERE \"spree_taxons\".\"id\" IN (?, ?, ?, ?, ?, ?, ?, ?) LIMIT ? OFFSET ?) subquery_for_count  [[\"id\", 7], [\"id\", 9], [\"id\", 3], [\"id\", 4], [\"id\", 5], [\"id\", 6], [\"id\", 8], [\"id\", 10], [\"LIMIT\", 8], [\"OFFSET\", 0]]\n   (0.2ms)  SELECT COUNT() FROM \"spree_taxons\" WHERE \"spree_taxons\".\"id\" IN (?, ?, ?, ?, ?, ?, ?, ?)  [[\"id\", 7], [\"id\", 9], [\"id\", 3], [\"id\", 4], [\"id\", 5], [\"id\", 6], [\"id\", 8], [\"id\", 10]]\nCompleted 200 OK in 157ms (Views: 143.0ms | ActiveRecord: 1.8ms)\n```\nOf course, the other queries are the same, but in this case, the total number came down by 7 queries (8 taxon's ancestors that are loaded in 1 query instead of 8)\nIf you point me to a way you wanna test it, I can write a spec to ensure the N+1 doesn't reappear.. > @stem \ud83d\udc4bHey there! Any update here?\n@kennyadsl, I'll look into it now that I'm back from vacations \ud83c\udfd6\nYour experiment seems to do the job so I'll take that road and update this PR to add theses tests. FYI, I've found and fixed another N+1 with the taxon's children while ensuring that the tests were OK.\nThat helps us moving from 11 queries to 5 for the 2 leafs in this simple example : \n- Brand\n  - Ruby\n    - Rails\n      - 3.2.2\n  - Python\n    - 3.0. @kennyadsl I've rebased and squash some commits. Let me know if I can do something more to improve this PR.. @kennyadsl is there anything I can do to improve or merge this one ?. @kennyadsl I've removed the query_counter part, but kept the rspec matcher in case we need to investigate other N+1. Let me know if you think I should also remove that.\n. @kennyadsl done !. Agree !\nI was using the same as in https://github.com/solidusio/solidus/blob/f26550641f103d43bdb850bae23c74c0e20f8542/core/config/locales/en.yml#L1203\nDo you want me do modify both of them to be more like the rest of the translations ?. I have copied it from https://github.com/solidusio/solidus/blob/475d9db5d0291dd4aeddc58ec919988c336729bb/backend/app/controllers/spree/admin/promotions_controller.rb#L27\nI'll update both !. Shouldn't it be @promotion.promotion_codes.new ?. There is at least also https://github.com/solidusio/solidus/blob/1909a1c40504ef9309e4685ab9c0426eb9706239/backend/app/views/spree/admin/promotions/edit.html.erb#L8 and https://github.com/solidusio/solidus/blob/1909a1c40504ef9309e4685ab9c0426eb9706239/backend/app/views/spree/admin/promotions/edit.html.erb#L14 that were already there.\nMaybe we don't need that kind of granularity or maybe it wasn't though of before.\nShould we create an issue to discuss and review all promotion code ACLs and improve them to be more customisable if we think we should do so ?. @promotion.build_promotion_code does not seems to exists : \nirb(main):009:0> promotion = Spree::Promotion.last\nirb(main):010:0> promotion.build_promotion_code\nTraceback (most recent call last):\n        1: from (irb):10\nNoMethodError (undefined method `build_promotion_code' for #<Spree::Promotion:0x00007f625b3b2e18>)\nDid you mean?  build_promotion_category\nAnd new or build return the same object : \nirb(main):011:0> promotion.promotion_codes.build\n=> #<Spree::PromotionCode id: nil, promotion_id: 65, value: nil, created_at: nil, updated_at: nil, promotion_code_batch_id: nil>\nirb(main):012:0> promotion.promotion_codes.new\n=> #<Spree::PromotionCode id: nil, promotion_id: 65, value: nil, created_at: nil, updated_at: nil, promotion_code_batch_id: nil>\nI've switched to build. Unfortunately, self_and_ancestors generate a new SQL query each time it's called and works on a taxon instance\nIn our case, it will do a query for each taxon we're loading and I'm trying to avoid exactly that \ud83d\ude15 \n. I might have spoken too fast. I'll try to use it instead of my new scope. I'll let you know what I find. @kennyadsl : I confirm that we can reuse the method from awesome_nested_set. good catch !. As you might already know, the param already exists : https://github.com/solidusio/solidus/blob/475d9db5d0291dd4aeddc58ec919988c336729bb/api/app/views/spree/api/taxons/index.json.jbuilder#L6\nKnowing that, I think we should respect the caller decision to not load the children, and doing that includes at all time will do the opposite.\nLet me know what you think.. ",
    "adamdunkley": "@kennyadsl Thanks\nI couldn't work out who would want it to be \"any\" either. I did also consider changing default values but didn't, I'll have a look at the best way of doing it and update the PR. . Resolved. Will update along with the defaulting changes. ",
    "davideghz": "ok, I completely misunderstood the meaning of 'package' here :) thx\nI think this \"issue\" can be safely closed. I just noticed that\nhttps://github.com/solidusio/solidus/blob/cf9eebdf62a1fb2512f6b40243c9d89410d4dba7/core/app/assets/javascripts/spree.js.erb#L15-L17\nis evaluated as\nSpree.mountedAt = function() {\n  return \"/\";\n};\nwhile in my rails console I get\n2.4.2 :001 > Rails.application.routes.url_helpers.spree_path(trailing_slash: true)\n => \"/store/\"\nnot sure how to proceed from here tho. ",
    "jordan81": "I'm running into I think the same issue with mounting not engine not at the root. Viewing and Creating new Taxons is not working when changing mounting location from '/'. 404 errors show file not found for \"/api/taxononomies/\" when mounting point is /store/ using the \"Add Taxon\" Button.. ",
    "memotoro": "@webmaster219 I'm not sure if this gem is going to help you, but I use it to add static pages in stores for T&Cs, help, etc. I actually forked the project and did some bespoke changes for my stores. It works fine. Have a look. https://github.com/solidusio-contrib/solidus_static_content. @kennyadsl @tvdeyen . Changes as requested. Let me know your thoughts. Regards. Hello @ericsaupe @tvdeyen @kennyadsl \nSorry for the late replay. I had issues merging last time that I've squashed my commits to make it a single commit. Have a look and it is passing the CI tests.\nRegards. @merlielmag @jacobherrington Store Credits are applied automatically if the user has some positive balance in their account. When you setup your payments, unchecked the option \"available for users\", in that way there is no code asking for the missing template. If you setup a payment with \"available for users\" it is because you are giving the user the option to select that payment. As I said before, store credits are applied automatically and it is visible during the checkout, so there is no need of template. Give it a go and let me know if it works.. @kennyadsl You are right here. Permission ':create' should be enough. I'll fix it.. Hello @kennyadsl . \nThere are two classes to manage the permissions sets Spree::PermissionSets::OrderManagement and Spree::PermissionSets::OrderDisplay. The OrderManagement establishes the ':manage' permissions. The display establishes the ':display' and ':admin' permissions. If I want to restrict a user with only the permission OrderDisplay, I have to check for ':manage' permission as for some reasons, the ':create' permission on OrderDisplay is still allowing the button to be rendered, allowing the user to click the New Order button, and creating an empty order that it cannot be modified, not great user experience I guess. I'm not sure why the ':create' is still available on OrderDisplay. Do you know how to fix this issue? Maybe I misunderstood the OrderDisplay role. Let me know your thoughts about it.. @kennyadsl . You're right. I'll fix it.. @kennyadsl Same comment with the OrderDisplay issue mentioned above.. Hello @kennyadsl \nDo you have any thoughts about my previous comments on PermissionSets? \nRegards. ",
    "order4adwriter": "Still haven't gotten any response from you.\nI assure you that my intentions are sincere and I will provide quality content for your open source project repo....\nBesides, you'll definitely have the final say anyway..whether to accept my contribution or not...\nLooking forward to your positive reply.. ",
    "matteocellucci": "Hello, I am currently managing an API service in the project in which I am working. I'd like to share our experience. In our case, unlike @benjaminwil , we wanted to automate the generation of the documentation starting right from the tests. We have greatly appreciated how this approach is amalgamated within an agile environment.\nInitially we tried to use Dredd. It has a very Rspec-based DSL very intuitive and descriptive, but needs Node for the generation and maintenance of the SwaggerUI.\nIn the end we used Rswag, also based on Rspec-land, but trying to improve its DSL. It is based on Swagger2.0 and it is limited but it suites our first API version.\nWe are now thinking again to Dredd, beacuse other gems have necessitated the installation of Node as a dependency.. If I'm not wrong, successful DELETE return a status of 204. ",
    "exocode": "Hi there, any news on this topic. \nCame here by a research for Activestorage. I saw the team on Spree did an update: They already implemented ActiveStorage. (https://spreecommerce.org/spree-3-5-and-3-6-with-rails-5-2-ruby-2-5-and-activestorage-support-released/)\nMy questionis if there is a near future where this feature will be migrated?\nThank you very much. ",
    "wycleffsean": "Be sure to run migrations, you need this https://github.com/solidusio/solidus/blob/master/core/db/migrate/20180313220213_add_available_locales_to_stores.rb. ",
    "MarcusPianco": "unsubscribe\n2018-05-30 13:27 GMT-03:00 James Gayfer notifications@github.com:\n\nThis file wasn't included in the initial PR as it was filtered by the\n.gitignore for Solidus.\n\nYou can view, comment on, or merge this pull request online at:\nhttps://github.com/solidusio/solidus/pull/2752\nCommit Summary\n\nAdd Gemfile.lock to docs site project\n\nFile Changes\n\nA guides/Gemfile.lock\n   https://github.com/solidusio/solidus/pull/2752/files#diff-0 (161)\n\nPatch Links:\n\nhttps://github.com/solidusio/solidus/pull/2752.patch\nhttps://github.com/solidusio/solidus/pull/2752.diff\n\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/solidusio/solidus/pull/2752, or mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AE--Zr7lT-lZd1IrA7mBbQW-2CCQnEYcks5t3sh8gaJpZM4UTnMY\n.\n\n\n-- \nMarcus Pianc\u00f3\nUniversidade Federal de Alagoas\nInstituto de Computa\u00e7\u00e3o\n. ",
    "snarfmason": "@jacobherrington Apologize for missing this post. My github notifications have been a mess, I need to get that back under control. Thank you for rebasing that for me. . ",
    "jacquesporveau": "Eh I had an old version of Solidus and the PR will look different than this. Closing for now and will open another PR when I have the right solution implemented.. Eh I had an old version of Solidus and the PR will look different than this. Closing for now and will open another PR when I have the right solution implemented.. I don't believe that the Netlify test failures are due to changes that I've made. Seems to be checking solidus guides and I have not made any changes to those said guides.. I don't believe that the Netlify test failures are due to changes that I've made. Seems to be checking solidus guides and I have not made any changes to those said guides.. Thanks guys!\n. Thanks guys!\n. ",
    "jacobeubanks": "@tvdeyen Agreed! Change made.\nThanks for the speedy responses!. @kennyadsl Thank you!. Thanks for your response!\nI agree with @gmacdougall and @jacobherrington. Though I think this is an improvement, I'm not sure if this small change is worth breaking frontends.. @tvdeyen Good idea! Change made. Thanks!. ",
    "eyewritecode": "Is anyone working on this? @jacobherrington @kennyadsl? i would like to give it a try. @jacobherrington I reproduced the \"error\" and just wanted to make sure i understand the issue here! When you say the server should log a warning... do you mean something like \nruby \nlogger.info(\"some text\") \nAs for this \n\nThere is also an argument to be made that it shouldn't be possible to create a promotion with no actions.\n\nI think it makes more sense too. @jacobherrington Can't seem to figure  out why the test weren't passing so i decided to cancel the PR. ",
    "coorasse": "Good catch. Yes, that would happen. \nDo you want me to add a note to the Changelog? Another option would be to call @taxon = load_taxon directly inside the action...even though I would prefer the current version.. Good. I updated the CHANGELOG and squashed. \ud83d\udc4d . I cannot really think of a deprecation warning: we could override can? and accessible_by methods of cancancan and raise a warning when can? is called with delete, new_action, read or display and when accessible_by is called with :read or :display.\nThe calls to accessible_by(ability, :read) should be replaced by accessible_by(ability) but this would not work before this update! \u26a0\ufe0f \nAlso can? :read, resource should be changed to the specific action can? :show or can? :edit, etc, but again: it would not work before this change.\nThe calls to can? :delete, resource could already be replaced by can? :destroy, resource.\nAlso the calls to can? :new_action, resource could already be replaced by can? :create, resource.\nThe main problem was this alias:\nalias_action :show, to: :read\nalias_action :index, :read, to: :display\nwhich caused read to be the same of show and display to be both read and index...\nI am not even sure what this means \ud83d\ude04. If you notice, in fact, the changes I had to do in the code itself were not actually many. It is more a renaming issue. I can make a new comment and show in detail how/why the problem is raised only in version 3.0.0.\nI let you guys decide about how to move here: I have not enough knowledge about the project.\nI pointed the finger \ud83d\ude04 and I can provide all help you need but I think this might break quite some stuff.\n. In cancancan 3.0.0 when two abilities are merged, also the aliased_actions are merged.\nSolidus defines the following aliases in base ability:\n{\n:destroy=>[:delete], \n:update=>[:edit], \n:create=>[:new, :new_action], \n:read=>[:show], \n:display=>[:index, :read]\n}\nbase ability is the merged with other abilities where the default aliases are defined. The following:\n{\n  :read => [:index, :show],\n  :create => [:new],\n  :update => [:edit]\n}\nwith the following aliases as a result:\n{\n:destroy=>[:delete], \n:update=>[:edit], \n:create=>[:new], \n:read=>[:index, :show], \n:display=>[:index, :read]\n}\nThe call that Solidus performs on Spree::Order.accessible_by(ability, :read) in version 3.0.0 fails because the following rule:\ncan [:read, :update], Order do |order, token|\n  order.user == user || (order.guest_token.present? && token == order.guest_token)\nend\n is now identified as possible interesting rule and cancancan raises an issue because this is a block rule (do...end) defined on a collection action read. yes. exactly. I also double checked to be sure but the find_by! raises an exception if the element is not found, returning 404.. this is not necessary anymore. The default is :index which is by default aliased by :read.. this method was never accessible. why don't we remove it?. this is supported already. you can use read.. delete was never used. new_action was never used. block conditions should be defined only for actions on object instances, not classes, therefore this rule applies only on :show, :edit, :update. This was actually working by mistake since version 2.0 of cacancan. why should it not be allowed?. it changes from :show to :index but all the rules are defined for :read instead of :display which was including also :read. it's quite complicated, I know, I don't know why all these aliases were generated before.  accessible_by(ability, :show) would not make sense because you want a list of objects. :show is for single instances.. it was defined with :index and since :read was an alias of :show, no rule was defined for :index. in fact, I replaced it with a random action called :impossible_action and no test failed. There is only one test and it checks that this endpoint should not be accessible \ud83e\udd37\u200d\u2642\ufe0f . That's why I asked myself: \"why don't we remove it?\". :read was aliased by :display and rules were (almost) always defined on :display. You can see that most of the changes are about that: https://github.com/solidusio/solidus/pull/3148/files#diff-82b30f937458e7c1052c326354dc18cbL8. ",
    "vochicong": "It's the same here.. ",
    "TristanToye": "Just ran into this as well, reached out to slack channel for support. . ",
    "captproton": "I get an error too: \nhttps://gist.github.com/captproton/3db5bfe2b93d76d7a6d17117c3e5a389. ",
    "rsipakov": "Hey there,\nThe same situation. It is not resolved.\nBest,\nRostyslav\n\nOn Aug 13, 2018, at 12:26 AM, Omar V. notifications@github.com wrote:\nI got the button to work again after some dirty monkey patches on both this repo and the heroku-buildpack-solidus-demo https://github.com/VzqzAc/heroku-buildpack-solidus-demo/tree/fix-heroku-buildpack one, you can try it here https://github.com/VzqzAc/solidus/tree/fix-heroku-buildpack, this is for sure not a good solution, I'm still playing around to find a proper one and I have some suspicions on the solidus.rb file on the buildpack repo, but in case you want to check there's my work so far\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub https://github.com/solidusio/solidus/issues/2797#issuecomment-412405440, or mute the thread https://github.com/notifications/unsubscribe-auth/Ago4Ml18xnR67Nq-pO9-QUo2WGUA4Mnkks5uQP_-gaJpZM4VIqoB.\n\n\n. ",
    "dschuermann": "Great, Thanks. I will try downgrading to rails 5.1 for now.. I added\nruby\nconfig.action_controller.default_protect_from_forgery = false\nto my config/application.rb for now to work around it.. Yup, for now I don't want to fork Solidus to fix it. But, let's see which other requirements will appear :grin: \nI just started working on a project that uses Solidus as the backend and calls its API on Android.. ",
    "cedum": "UUIDs as a primary are required mostly in distributed architectures/datastores, because generating correctly serial numbers in such architectures is much more challenging. IMHO this is the main reason when choosing UUIDs becomes sound from a practical perspective.\nSolidus, being basically a monolith, has no such limitations.\nWhen evaluating \"faster writes\", keep in mind that when having primary UUIDs in almost all cases it'll require to have also a \"sort index\" on a column like created_at. This means every INSERT will require (at least) two writes on disk.\nI'd stick with autoincrementing integers as a primary. There's quite a big cost of migrating to UUIDs and honestly I don't see strong benefits to justify the conversion of all the primary indexes on a production database to a completely different datatype.. Pushed some changes that DRYes the partial double verification support file as per @kennyadsl suggestion.\nI refactored also the module into a plain RSpec.configure block, mostly because I think there're no benefits to isolate it into a module (+ it was requiring ActiveSupport).\nIt made sense to me to extract also the c.verify_partial_doubles = true setting; in cases where a different setting is required in a single component, it can be easily overridden.\nWdyt?. Should be related to this part:\nhttps://github.com/solidusio/solidus/blob/6b5c90034f1406b53982bde35ad69295878393b4/core/app/models/spree/address.rb#L181-L220\nI'm splitting this logic in two parts: one that performs the state normalization before the validation occurs and another that performs the actual validation. As discussed also in #2417 it should nullify the state when a country w/o states has been chosen.. :heavy_check_mark: done!. ",
    "dustineichler": "@skukx LGTM. Probably a good idea to update Solidus guides with implementation and use details.. @jarednorman agreed. i've looked into this. i see two issues: updating namespace and db migration e.g. - solidus_.. @patleb \"implementation details\" and stakeholder issues aren't mutually exclusive. No one is disputing this is a cosmetic update. No one is disputing potential impact. No one is saying we're doing it for the sake of it. We are looking for better anecdotes in this discussion than, \"could potentially do more harm than good\" and \"i don't see any advantages\".\nCan you speak to some of the work you're doing and how this change might affect those projects.. salient point here is and has been data migration. i don't see this as an insurmountable problem. providing a solution to help with data migration might be one way to go, but updating the implementation shouldn't be impedance to advancing an idea.\n. Proposing:\n\nmaintain Spree as a legacy namespace.\nmaintain compatibility with spree extensions.\nprovide data migration tool.\n\n. I'm talking about how we distribute extensions through solidusio or solidusio-contrib for one and two how extensions are packaged as a Rails::Engine. \nHow this would ultimately work... Unclear, but I've been looking at:\n1. https://github.com/solidusio/solidus/blob/master/core/lib/spree/app_configuration.rb\n2. https://github.com/solidusio/solidus/blob/master/guides/source/developers/preferences/app-configuration.html.md\n3. https://github.com/solidusio/solidus/blob/master/guides/source/developers/preferences/class-extension-points.html.md\n. What does a solidus extension built with Rails::Engine give us that we couldn't easily replace with a standalone or simplified Ruby gem? Namespace isolation? Can't really think of anything else off the top of my head. Engine initialization hooks can be replaced with Rails::Railtie. Also worth investigating: Classboxes. \n\nhttp://scg.unibe.ch/archive/papers/Berg03aClassboxes.pdf\nhttps://blog.codeship.com/ruby-refinements/. @kennyadsl good points. should update. suggestion on title change? might be worth closing and moving to solidus_cmd too.. @kennyadsl i like it. building up solidus cli has many benefits. not just here imo. i also think it's a good idea to expand-provide employable patterns beyond what's initially generated. lastly, providing a boiler plate is a good idea. 1. helps set extension expectation 2. ensure minimum quality. 3. reduce setup time.. \n",
    "christophebeling": "I have the same issue for the frontend btw.. This is happening for me too.. ",
    "nori3tsu": "I had the same issue both v2.6.1 and v2.7.0, but I finally have resolved.\n$ rails generate spree:install\nthen\n$ bundle exec rake assets:precompile. ",
    "salbertson": "@BenMorganIO rebased and tests are passing. Thanks!. @BenMorganIO @tvdeyen what do you think?. @tvdeyen @jacobherrington sounds good, whatever y'all think makes the most sense.\nWould this work?\n\nOr this, without the badge, to support services or companies without badges?\n. Done!\n\n. @jacobherrington done!. ",
    "pedrofurtado": "@VzqzAc @jacobherrington The ActiveRecord 5.2.1 changed the number of parameters used by some classes in Private API. Because of this, some gems from activerecord-hackery (ransack, polyamorous, etc.) is broken.. ",
    "eduardopatrick": "I'm testing by the first time and having the same problem, anyone could say how can I  use thoose gems in a stable version. Sorry if I'm writting at the wrong place, but I really want to test solidus in my projects.. ",
    "fabioaraujo121": "Thanks, @docelic ! Saved a big time!\nBut, anyways, what is really happening with Solidus and Rails 5.2.1?. ",
    "louishugens": "man i can get rid of rails 5.2.1. help please :( . Thanks @docelic ,the thing is even with \"bundle update\" and rails 5.2.0 specified in the gemfile, rails 5.2.1 is being installed. Maybe some other gem is requiring it? How to check that? Thanks\n. you are right @tvdeyen, it's rails 5.2.1 that i see in it. how can i get rid of it and replace with rails 5.2.0?. ",
    "huoxito": "@kennyadsl see https://github.com/nebulab/solidus/pull/15 that might help\nthat last spec failure might be related to a monetize version change. I noticed that latest master build was still Using activerecord 5.1.6 I tried to run the test on that version but it still failed. When I diff my local bundle with the one in circleci a monetize gem bump made me think it could be related.\nI don't know yet whether it's a problem with the test setup or something wrong with monetize. It seems worth checking though, calculations shouldn't break like that.. also related https://github.com/RubyMoney/monetize/issues/118#issuecomment-416904973 . I've set monetize back to ~> 1.8 thanks. @tvdeyen it does indeed, we don't have to raise the version I can add it back to ~> 1.8 let me konw. think this could be ~> 1.8 since it works with both 1.8 and 1.9 versions. ",
    "JuanCrg90": "\ud83d\ude04 Thanks. Updated, Thank you \ud83d\ude04 . Updated Thanks for the suggestion \ud83d\ude04 . Updated Thank you \ud83d\ude04 . ",
    "joshua-honig": "For others encountering this, the immediate workaround was to add the following file to my own project:\napp/views/spree/api/payments/source_views/_stripe.json.jbuilder:\n```ruby\nfrozen_string_literal: true\njson.partial!('spree/api/payments/source_views/gateway', payment_source: payment_source)\n``. @skukx That makes sense. This really represents an incremental requirement for payment method plugins, to be implemented by each plugin. In our case we're actually using https://github.com/solidusio/solidus_gateway, notsolidus_stripe, but same idea. Given the deprecation alert now in the readme forsolidus_gatewayI'll put it on my medium term list to transition tosolidus_stripe`.\nThat said, this change will likely break most other currently supported payment plugins, because none of them will have the newly required jbuilder corresponding to their own partial_names. \nFor example, the currently supported https://github.com/solidusio/solidus_paypal_braintree gem defines partial_name and method_type to be 'paypal_braintree' (see solidus_paypal_braintree/gateway.rb#L41-L44):\nruby\n    def partial_name\n      \"paypal_braintree\"\n    end\n    alias_method :method_type, :partial_name\n..but does not have a _paypal_braintree.json.jbuilder in lib/views/backend/spree/admin/payments/source_views/\nRather than just breaking them and waiting for each of them to encounter, figure out, and fix this same issue, perhaps there could be an automatic fallback to the gateway jbuilder, with a corresponding warning?. ",
    "jontarg": "Just upgraded to 2.7 from 2.5 and found this same issue. We're using solidus_gateway.. ",
    "octave": "Adding distinct: true fixes it at the end of this line:\nhttps://github.com/solidusio/solidus/blob/425240b84f670558aab61df2655be9a75e00dda0/api/app/controllers/spree/api/variants_controller.rb#L29\nLike this: .ransack(params[:q]).result(distinct: true). ",
    "merlielmag": "Hi @memotoro, you are right!\nI was trying to let the user choose to pay between Store Credit or other payment method, but realized that the automatic behavior works perfect!\nThank you!. ",
    "ValerianV": "Actually, i have the same problem.\nI installed solidus_il8n\ngem 'solidus_i18n', '~> 2.0'\ngem 'rails-i18n', '~> 5.1'\ngem 'kaminari-i18n', '~> 0.5.0'\nand, on the backend, whenever i select another langage, it switch back to english.. ",
    "patleb": "Thx!. Changing solidus_frontend for solidus_storefront might help also.. @jacobherrington, project namespace is an implementation detail, I don't see how this could affect the stakeholders matter (the project is already marketed as Solidus).\nI don't mean to be harsh, but I really don't see any advantages to change namespacing just for the sake of it: I would say that it could potentially do more harm than good and it doesn't clarify anything (quite the contrary, you know from where the code comes from --> Spree).\nAs someone who works with both projects (Spree and Solidus), I can tell that there is more similar code than completely different one and both are using almost identical data modeling and ideas. I understand that the project evolved in parallel to Spree at some point, but it hasn't been a rewrite, it's an evolution and wouldn't make things easier to read, write or understand to change the namespace.\nAn example of fork of a known project which kept the namespace of the original project is OpenProject which is a fork of Redmine and both are doing pretty well as is.. > \"implementation details\" and stakeholder issues aren't mutually exclusive\nIn what way if I might ask? I'm talking about this specific issue, not about all those in existence. In this case, I'm pretty sure this is irrelevant: when was the last time a stakeholder spoke up about how you name your classes or how some files are named?\n\nNo one is disputing this is a cosmetic update\n\nYes, sorry to say, but I doubt that you were refering to a \"necessary\" cosmetic touch here:\n\nObviously this would be a big lift, but necessary...\n\nAlso, I don't know why you're saying No one is saying we're doing it for the sake of it, you're contradicting the intention of your previous statement about cosmetic: how is cosmetic changes isn't for the sake of changing? If you ignore the stakeholder matter, then no other advantages has been brought up. Also, I tried to come with some, but failed to see something better than \"it just makes sense to have the project name as the same namespace\": I know it would be nice, but I really think it's too late for this (by maybe 5 years).\n\nWe are looking for better anecdotes\n\nReally?! So basically, what I said about Spree meaning something about the code provenance, the fact that some teams use both Solidus and Spree, the quasi-identical data modeling (which you can verify by yourself by diffing the generated Spree and Solidus schema.rb), the \"not helping\" about understanding code and the example of a successful project with the same scenario as Solidus is worth nothing?\n\nCan you speak to some of the work you're doing and how this change might affect those projects.\n\nWhat are you trying to say here? You want me to justify why I should be heard and if it's worth it? If this isn't your intention, then I suggest that you rephrase this line in the future by something like \"I think I might not see how it could affect some projects, can you tell me how this change could affect what you're working on?\". For which I might happily answer:\nWell, our main product supports both Spree and Solidus and we take advantage of what's shared between both project to simplify migration from one or the other if the client wishes to. Also, changing the namespace will add a headache for migrating data, every model using polymorphism and STI will be impacted: you cannot just rename the code, the data will have to be migrated as well. Finally, all extensions will need to be migrated and we'll have to modify every extension we have that we share with both Spree and Solidus: it'll add an architectural indirection by either using some kind of classes/constants aliases or extracting into modules, we'll have two sets of migrations, etc.\nChanging the namespace will break all applications out there, not just mine and, as I said, I would like to come up with some advantages, but there is none of interest I could come up with.\nAs a last consequence, changing the namespace will touch basically every files and a high percentage of lines as well. So as someone who works through the library and use git comments to understand some decisions and how some parts are interrelated, it'll be quite inconvenient when I have to always jump several commits behind the big namespacing refactor to check what was changed and for which reason.\nTo sum up, I just think it's too late to make this kind of change, it's just not worth it (unless you ignore all the points I brought up... again).. @jacobherrington, thx, no problems. I can understand how this might help if you assume that assessment includes reading the source code, but I've rarely seen it done this way (although, I personally do it, but more as a curiosity than an obligation at the first steps). Most of the time, it starts with the getting started and playing with the demo. So, as a side note, if differentiation is important, I would tend to think that doing it through the code isn't the most effective/rewarding place to do it (it may or may not help).\n@dustineichler, I understand that you're on the defensive because I'm opposed to the idea for reasons I've brought up, but please try to understand what I'm saying because this is exactly what I'm doing \"advancing the idea\", just not in the direction you would like it to be. You're ignoring or minimising what I'm saying as if it was of no consequences. I'm not saying it's complicated to migrate data, I'm saying everyone will have to do it if goes forward.\n\nsalient point here is and has been data migration\n\nNo, there are other points I've talked about. Can you please give some advantages of your own on this subject? Because you pretty much proposed the idea, but just dismissed any disadvantages brought up as if the issue should not be challenged.\n. These points are disadvantages disguised as solutions to the consequences: they are adding to the cost, they are not bringing any benefits. It's a little bit concerning that you cannot propose any advantages whatsoever or maybe I haven't been clear enough. A good example of advantage is what @jacobherrington proposed: it would have the benefit to clarify that Solidus is an independent entity from Spree if the code is assessed by stakeholders.\nAnyway, I think I made my points clear, I have no more time for this issue, I'll let the core team discuss this.\nHave a nice day!\n. Sure, no problem :). Please expand on the pattern you are referring to (it sounds like you are suggesting to use something other than bundler or mixing up some unrelated concepts).. > How this would ultimately work... Unclear\nThis doesn't help much and doesn't really make your case about extensions being \"an idea whose time has past\" or how it would help with maintainability.\nExtensions are distributed as gems which bundler pulls from whatever location you specify (local path, github, rubygems, etc.). So, if you don't go through solidusio or solidusio-contrib, then you're suggesting to replace bundler with something else?\nI'm pretty sure you're mixing up some concepts here. There is nothing preventing you to not use Rails::Engine, but you will have to require manually your files and do yourself all the steps that engines do take care of: initialization hooks, generators (migrations and such), assets, locales, etc.\nAll in all, this doesn't make a lot of sense. Is pulling some extensions into the main project (like Rails did with ActiveStorage for example) would be something that fits with what you're trying to say/expose? If not, then please give some details about the problem(s) you're trying to solve, because you're proposing a change with an unknown solution to an unknown/non-existant problem otherwise.\n. @jarednorman, thanks for your input and clarifying what was the intention of the issue (if this is really what it was about), because I thought it was way more intrusive/impactful than that. I can live with a different generator for extensions which isn't integrated with Rails and ignore all the conventions, I use a different one anyway.\nRight now, the only thing I think is wrong (not ideal) with the extensions is the pattern already discussed here. Otherwise, I don't see how Rails::Engine and class_eval/prepend are problematic (you seem to be aware of something that I am not).\n. I see your point. Although, the problems you brought up aren't specific to class_eval, but to an ignored/overlooked principle of writing extensible code: the open-closed principle (should be open for extension, but closed for modification).\nSo, for this instance, this means that you should use class_eval to modify behavior by providing some hooks and/or a public interface to implement if modifications are to be expected/encouraged and modifying/using private parts should be discouraged by being explicit about it: meaning using the private keyword and/or prefixing with an underscore _ (which would be prefered if class_eval is expected to be used). The usage you describe is a misused of class_eval. It's very easy to blame the knife when you cut yourself, but unless you evaluate the context, you might be blaming the wrong thing.\nBasically, I don't see an issue with this because the cause of headache isn't class_eval per se: you'll have the same problems if you encapsulate the behavior in another class and delegate. What I mean by this is that unless you architecture your class in an extensible way, then the same problems will arise. Not only that, but you might not have other choices, but to reopen the class or call send because the encapsulation isn't the right one. Sometimes class_eval is the right call, sometimes it's not, there are a whole bunch of ways to address the same problem. I'm guessing we see class_eval in Spree/Solidus often because more often than not we need to add a table related to other existing tables and it would imply to add relations between existing models. The easiest way to do this is by reopening the model and adding has_many, has_one, belongs_to and whatnot and it doesn't violate the open-closed principle.\nRegardless of all I've just said, if you really want to make your extension maintenance bulletproof and independant of how extensions are implemented by others, not not using class_eval isn't the most robust way, because it's a losing battle to impose your way to do things. What we do with our overrides regardless of using or not class_eval, \u00ecnclude, prepend, is we have a base test helper which compare a snapshot of the file(s) we modified when we made the modifications and run a diff everytime we update the gems. This will tell you what has changed and if the modifications should be addressed.\n. @jarednorman, you said that you were surprised that I don't see an issue with class_eval and that you were curious how other people feel... so, naturally, I expressed my point of view and gave some actionable tips. Which, as I understand now, were unsolicited and you actually meant that I was wrong to not see an issue regardless of whatever and you wanted to hear people from Southeast Solidus specifically.\nYou have to understand that I have an obligation (which means I would rather not) to check from time to time for issues that would impact our clients in the long run. So, if there is an issue with the title \"RFC: Replace Solidus Extensions with new library package and distribution pattern\", I will most certainly associate risk and money to this kind of change and I have to inform myself about what the issue actually is. So, it's a little unfortunate that issues are now used as a forum.\nAlso, please, if the discussion is about how extensions are architectured/configured, then use these terms in the description of the issue instead of \"library package\" which would mean \"gems\" and \"distribution pattern\" which would mean \"bundler\".\n\nLet's try to keep the discussion constructive\n\nCould you please expand on the non-constructive part(s) of what I wrote? I don't get it.\n\nand focus on ideas that have been explicitly suggested and avoid speculating too much\n\nSorry, but there was nothing explicit about what was written in this issue, that's why I jumped in.\n\nNo one is suggesting replacing bundler\n\nMy questions weren't answered about the distribution part... so, I guess you're answering my question about bundler with this.\n\nor banning the use of class_eval\n\nYou specifically said \"I see our adoption of class_eval/prepend is a significant burden\" and I was merely suggesting that it might not be the cause of the burden with an actual explanation, a scenario and alternatives.\nAlright, I'm out. Have a good one!. ",
    "mayanktap": "Hi @jacobherrington , I am able to reproduce this issue in my local machine and tried to fix. I guess I would be able to fix this. \nI would like to work on this. Can I ? . @jacobherrington , According to my understanding and investigation, I made some changes and tested it thoroughly. I will raise the PR so that you can review and take decision accordingly. \nI would just need some guidance in the process of making PR.\nI want to verify one point regarding the process of raising PR: \n1.) I am raising PR as base branch as master. That means the new branch that I will create to push the change will be from master branch. Is it correct? \n. Also , Is there any naming convention regarding the name of the branch? I didn't find anything related to this in CONTRIBUTION documentation. \n. Ok then I will raise the PR after another round of testing. . @jacobherrington . Please check the above PR https://github.com/solidusio/solidus/pull/2898 raised corresponding to the issue. . Please refer to this new PR(https://github.com/solidusio/solidus/pull/3063) for the fix of this issue. . @ericsaupe , @jacobherrington Thanks for your review comments. \nActually, I am familiar in using GIT from terminal instead from UI and because of that I was not able to figure out where GIT commit message is to be changed. I will make the necessary changes in the commit message. \nRegarding the failing test, I check the test case and tried to run the test with and without my code which leads to the failing of same test. So as per my understanding, the failing of test case is not because of the this change. \n@ericsaupe , Can you please specify what kind of regression test are you talking about? . @ericsaupe , I got it what you have said but I am confused in how to get distinct variants that we expect.\nAs per my understanding, I tried the following code snippet: \nit \"returns unique products\" do\n  expect( subject.count ).to eq(Spree::Variant.count)\nend\nhere subject is Spree::Variant.suppliable and yes the above expectation won't be correct because Spree::Variant.suppliable can't be equal to Spree::Variant because suppliable returns certain variants according to conditions.\nSo, can you suggest how can we get distinct variant that we expect from suppliable function. . @ericsaupe , @jacobherrington\nI have improved my commit history with proper commit message. Can you please review this PR? I am not sure how to add reviewers in this PR.. Hi @spaghetticode ,\nI guess you are talking about this change \nI removed those CHANGELOG.md changes because that change was not available in solidus/master and I don't want to merge any changes to solidus/master which are not in the scope of this PR. \nTo avoid more confusion, I am closing this PR and creating the new one. The new PR is: https://github.com/solidusio/solidus/pull/3063\n. Hi @spaghetticode ,\nThis is the new PR(replacement for https://github.com/solidusio/solidus/pull/2898) that consist the resolution for issue: https://github.com/solidusio/solidus/issues/2868\nPlease have a look and let me know in case of any discrepancy. . @spaghetticode ,\nCan we also proceed with making it a single commit by marking the two other commit as fixup? \nOtherwise I will proceed with the above. . @spaghetticode ,\nDone. Please check. . @jacobherrington , @ericsaupe \nCan you please review the changes? . ",
    "VitaliyAdamkov": "Sorry, not good enough. Ruby 2.4.2, Rails 5.1.6, Solidus 2.4.2\nAt production puma's error log mostly consists from deprecation notice lines: 67%.\nI wanted to stop that & thought that just replacing :html with :html_wrap would be enough.\nBut in that case behavior of display_price changes to inappropriate:\n\nit renders view with another structure, what breaks css styles\nin some cases it renders plain html as text\n& sometimes it renders broken tags, that are separated with &nbsp;'s instead of regular spaces. cause it rendered price span with \"&nbsp;\" string inside, instead of ' ' (space), at view at my dev environment. \n",
    "antstorm": "Not sure why your front-end looks like this because html would also require result string to be html_safe or sanitisation to be off when rendering. @jacobherrington yes, we're aiming for a new major version to be released soon, hence all the deprecation warnings. Hopefully there's enough info on how to remove these messages, making the future transition into Money v7 much easier for you. @JDutil the deprecation warning might be a bit confusing since it's referring to :format option for Money#format the method, not the method itself. Have a loot at this \u2014 https://github.com/RubyMoney/money/blob/master/lib/money/money/formatter.rb#L214-L219. Does it make sense?. @JDutil please ping me if you need any help moving forward. ",
    "LucasKuhn": "I was getting the same error, got rid of it by adding a format rule rule ( format: '%u %n' ) and stripping the .to_html that was being called at the end :). ",
    "trottomv": "I've found this jquery plugins that could be solve this issue https://github.com/hernansartorio/jquery-nice-select. @jacobherrington I can try to do it. I have the code ready for this issue, can I pull a request?. ",
    "kingsleywang2013": "@kennyadsl I am happy to pull a request for this change. Did you start to implement it now? If not, i can do this part.. ",
    "rymai": "\nThanks. This is great.\n\n\ud83c\udf89 \n\nPlease rebase to get rid of the Netlify errors.\n\nDone, thanks!. @kennyadsl Thanks! \ud83c\udf89 . Actually I realized that it doesn't look so... I bumped into this issue when trying to reorder the stock locations in the Admin (the UI still allows to do that, so maybe we should just remove that...).\nThat also triggers a more interesting discussion: my original thought was that the stock locations ordering would be used in the simple shipment coordinator, but it's not. At least I think we should change @stock_locations = Spree::StockLocation.active to @stock_locations = Spree::StockLocation.order_default.active there... but that's another discussion. :D. > I think you want to look at this recently merged PR #2783 that would allow to use the position if needed creating and using a new StockLocation sorter class.\n@kennyadsl Thanks for the pointer! That will fulfill my need perfectly! Looking forward for the next version! :)\n. @tvdeyen Done, thanks! \ud83c\udf89 . ",
    "michaelmichael": "Thanks! Rebased.. Thanks guys. I didn't know contributing to Solidus would be so easy. Hope to contribute more.. ",
    "potomak": "The same issue has been addressed by https://github.com/solidusio/solidus/pull/2921. The approach is slightly different, but both PRs fix this deprecation warning.. ",
    "yono": "@kennyadsl \nThank you for your approval!\n\nHow did you noticed that? \ud83d\ude42\n\nWhen I upgrade solidus version in our product, I read the version's whole CHANGELOG.\nNow I trying to upgrade solidus version to 2.7, so I read the PR's CHANGELOG twice.. ",
    "ychaker": "from working with people who manage the products but are very tech averse, I would say that if you disable or remove the ability to edit the count, please also add a tooltip or something explaining why. it's a tiny thing that would go a long way.. ",
    "gerritwessels": "Regarding Spree::Shipment records that transition to 'shipped' when all the inventory_units are 'canceled'\nI quickly poked around in the code to see if I could see anything obvious.\nThis line:\nhttps://github.com/solidusio/solidus/blob/35010c23483086e1be832708bd06d30bb05b1a88/core/app/models/spree/order_cancellations.rb#L141\nQuick fix for this could be:\n```\nBefore we update a shipment to 'shipped':\nEnsure that ALL the inventory_units for this shipment are in either a 'shipped' or 'canceled' state AND ensure that they are NOT ALL in a 'canceled' state\nif (shipment.inventory_units.all? { |iu| iu.shipped? || iu.canceled? }) && (!shipment.inventory_units.all? { |iu| iu.canceled? })\n```. ",
    "ellypham": "This issue is happening with me as well.\n\nWhen I click to cancel an item in the cancel tab https://cl.ly/75f534244949\nThen I go to the shipment tab, the item shows up as cancelled (1 x Canceled) and the order total is recalculated correctly https://cl.ly/d9818718ebfc\nHowever, when I go to the cart tab, the qty still shows as 1. Since the item was cancelled, shouldn\u2019t this show up as 0? https://cl.ly/8715e86f2b36\nThis would be confusing for a customer who is going to check their account page, because the qty is 1 and should be 0 if that item was cancelled https://cl.ly/534b1cc4953c\n\nAnd if I try to update the qty from 1 to 0, the Order Total gets updated again (which is the wrong amount) https://cl.ly/49c26fc85fbc. This issue is happening with me as well.\n\n\nWhen I click to cancel an item in the cancel tab https://cl.ly/75f534244949\n\nThen I go to the shipment tab, the item shows up as cancelled (1 x Canceled) and the order total is recalculated correctly https://cl.ly/d9818718ebfc\nHowever, when I go to the cart tab, the qty still shows as 1. Since the item was cancelled, shouldn\u2019t this show up as 0? https://cl.ly/8715e86f2b36\nThis would be confusing for a customer who is going to check their account page, because the qty is 1 and should be 0 if that item was cancelled https://cl.ly/534b1cc4953c\nAnd if I try to update the qty from 1 to 0, the Order Total gets updated again (which is the wrong amount) https://cl.ly/49c26fc85fbc. \n",
    "nvh0412": "thanks @tvdeyen @jarednorman for this discussion, closing issue. . @jacobherrington a mistake with my git tree, I fixed. Thanks so much, jacob \ud83d\udcaf . @jacobherrington seems like we have a flaky test https://circleci.com/gh/solidusio/solidus/10020#tests/containers/1, ironically I can't rerun to make it pass.. @jacobherrington so we have to wait for the fix of this flaky test to merge this PR?. ",
    "deepaksisodiaa": "after solving this error i am getting this error \"alias_method': undefined methodapply_free_shipping_promotions' for class `#' (NameError)\"\nwhen i am trying to run \"bundle exec rails g spree:install\". ",
    "Nittarab": "I'm sorry, I did not have time to finish it... . ",
    "vinu-pillai": "After installing solidus successfully in Ubuntu machine, I have received the following on the browser after starting the server -\nSass::SyntaxError in Spree::Home#index\nShowing /var/lib/gems/2.3.0/gems/solidus_frontend-1.4.2/app/views/spree/shared/_products.html.erb where line #31 raised:\nUndefined mixin 'display'.\nTrace of template inclusion: /var/lib/gems/2.3.0/gems/solidus_frontend-1.4.2/app/views/spree/home/index.html.erb\nRails.root: /home/solidus/solidusmp\nnot sure what this error is related to, but I am unable to find a solution.\n. > It looks like you are using a very old Solidus version (1.4.2) can you try with the latest version (2.7.1)?\nHi Kenny -  Thanks for your reply, \nI tried but bundle install & bundle update is taking 1.4.2. Here is the output -\nUsing solidus_core 1.4.2\nUsing devise-encryptable 0.2.0\nUsing solidus_api 1.4.2\nUsing solidus_sample 1.4.2\nUsing solidus_auth_devise 2.1.0\nUsing solidus_backend 1.4.2\nUsing solidus_frontend 1.4.2\nUsing solidus 1.4.2\nBundle complete! 14 Gemfile dependencies, 115 gems now installed\nhere is the version of ruby and rails -\n$ ruby --version\nruby 2.3.1p112 (2016-04-26) [x86_64-linux-gnu]\nrails -v\nRails 4.2.6\nIs there a way to invoke the latest version in bundle install/bundle update?\n. ",
    "forever-sumit": "@kennyadsl , before this fix no any specs are failing, I will try to add spec that cover my fix.. Hey @jacobherrington, Due to other work load, I'm not able to write the spec yet.\nif you guys feel my changes is okay to merge then please merge it. I'll write the spec later when I get a chance.. ",
    "rubenochiavone": "Didn't saw https://github.com/solidusio/solidus/pull/3023 :smile: since it was not linked with issue. Thanks for the feedback.\nBefore opening the PR let me ask you, is using codecov.io ok? If so, could you create a CODECOV_TOKEN to be used in the PR?\n\nI'm not sure if we really need to create another CircleCi job for that. Can't we use an existing one? Coverage should be the same right?\n\nDefinitively. We can improve on that during the PR. Yeah, my bad.\nAlthough looking it again, I found out that current code and the one you proposed do a SELECT 1 + SELECT queries.\nSpree::Image Exists (0.3ms)  SELECT  1 AS one FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_id\" = ? AND \"spree_assets\".\"viewable_type\" = ? LIMIT ?  [[\"viewable_id\", 1], [\"viewable_type\", \"Spree::Variant\"], [\"LIMIT\", 1]]\n  Spree::Image Load (0.3ms)  SELECT  \"spree_assets\".* FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_id\" = ? AND \"spree_assets\".\"viewable_type\" = ? ORDER BY \"spree_assets\".\"position\" ASC LIMIT ?\nInitially I proposed\nruby\nimgs = images\nreturn imgs if imgs.size > 0\nWhich trigger a count query then return the collection proxy.\n(0.1ms)  SELECT COUNT(*) FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_id\" = ? AND \"spree_assets\".\"viewable_type\" = ?  [[\"viewable_id\", 1], [\"viewable_type\", \"Spree::Variant\"]]\n  Spree::Image Load (0.2ms)  SELECT  \"spree_assets\".* FROM \"spree_assets\" WHERE \"spree_assets\".\"type\" IN ('Spree::Image') AND \"spree_assets\".\"viewable_id\" = ? AND \"spree_assets\".\"viewable_type\" = ? ORDER BY \"spree_assets\".\"position\" ASC LIMIT ?\nI had to refactor because @houndci-bot complained about using .size > 0.\nSo, the best of both would be:\nruby\nreturn images if images.size > 0 # or return images if images.count > 0\nWDYT?. Agreed.. Same from https://github.com/solidusio/solidus/pull/3032/files#r246951318 applies here. > Maybe this logic should go into the VariantGallery directly.\nNice point, but since variant gallery class could be changed in config isn't it better to leave this implementation inside Variant class?\ncore/lib/spree/app_configuration.rb:417\nclass_name_attribute :variant_gallery_class, default: 'Spree::Gallery::VariantGallery'\n\nAlso, I think it can be simplified with something similar\ndef images\n  @images ||=\n    @variant.images.presence ||\n    (!@variant.is_master? && @variant.product.master.images).presence ||\n    Spree::Image.none\nend\n\n\n.presence would eventually (after 2-3 methods) call .empty?.\nrails/rails/activerecord/lib/active_record/associations/collection_proxy.rb:841\n# Returns +true+ if the collection is empty. If the collection has been\n      # loaded it is equivalent\n      # to <tt>collection.size.zero?</tt>. If the collection has not been loaded,\n      # it is equivalent to <tt>!collection.exists?</tt>. If the collection has\n      # not already been loaded and you are going to fetch the records anyway it\n      # is better to check <tt>collection.length.zero?</tt>.\n      # ...\n      def empty?\n.exists will always rely on database - see rails/rails/activerecord/lib/active_record/relation/finder_methods.rb:277. Maybe .length?\nrails/rails/activerecord/lib/active_record/associations/collection_proxy.rb:814\n##\n      # :method: length\n      #\n      # :call-seq:\n      #   length()\n      #\n      # Returns the size of the collection calling +size+ on the target.\n      # If the collection has been already loaded, +length+ and +size+ are\n      # equivalent. If not and you are going to need the records anyway this\n      # method will take one less query. Otherwise +size+ is more efficient.\nwhat about .size?\nrails/rails/activerecord/lib/active_record/associations/collection_proxy.rb:786\n# Returns the size of the collection. If the collection hasn't been loaded,\n      # it executes a <tt>SELECT COUNT(*)</tt> query. Else it calls <tt>collection.size</tt>.\n      #\n      # If the collection has been already loaded +size+ and +length+ are\n      # equivalent. If not and you are going to need the records anyway\n      # +length+ will take one less query. Otherwise +size+ is more efficient.\n      # ...\n      def size\nSo, when there are images return images if images.length.zero? is more effiecient, otherwise return images if images.size.zero? is more efficient. Not sure what is best :grimacing:\nSome people from SO recommends .size - https://stackoverflow.com/questions/12253277/size-length-and-count-in-rails.\n\nI think it's safe to assume that each product has a master variant without the need to check that.\n\nYeah, but some tests fails. Maybe update those test cases?\n```\n$ cd core\n$ bundle exec rspec\n...\nFailures:\n1) Spree::Gallery::VariantGallery behaves like a gallery #images \n     Failure/Error: master_images = product.master.images\n NoMethodError:\n   undefined method `master' for nil:NilClass\n Shared Example Group: \"a gallery\" called from ./spec/models/spree/gallery/variant_gallery_spec.rb:20\n # ./app/models/spree/variant.rb:397:in `display_images'\n # ./app/models/spree/gallery/variant_gallery.rb:14:in `images'\n # ./lib/spree/testing_support/shared_examples/gallery.rb:5:in `block (3 levels) in <top (required)>'\n # ./lib/spree/testing_support/shared_examples/gallery.rb:7:in `block (3 levels) in <top (required)>'\n\n```\nWDYT?. @order.line_items.all? { |item| availability_validator.validate(item) } means that at least one line item is not valid, right? So, I'm not sure that unavailable_items = @order.line_items.map(&:name).to_sentence is right because it lists all line items as unavailable. Perhaps\nruby\nunavailable_items = @order.line_items.select { |line_item| !availability_validator.validate(line_item) }.map(&:name).to_sentence\nwould do (haven't tested). WDYT?. Thank you for the insights!\n\nNot sure which benefits would we have doing this, can you please explain better what's your concern? In my opinion this is a logic only related to which images we want to display for a variant and should stay in this VariantGallery class that has been added exactly to cointain this kind of logic.\n\nAgreed. Just to note some concerns\n\nMaybe a client code could benefit from this model method somewhere else without being required to use VariantGallery class\nAlso a different variant gallery class could decide which method to use\n\n\nYou are right about .size being more efficient only if we don't need to also take records anyway, so only when there are no images for that variant. I think this is an implementation detail though and we should just rely on the method that fits more in terms of code readabilty/simplicity here.\n\n:+1: \n\nYes, specs there use:\nlet(:variant) { Spree::Variant.new }\nwhich is fast but I think it does not reflect an intact data representation.\nMaybe we should use:\nlet(:variant) { build_stubbed(:variant) }\n\n:+1: \n\nand probably, into another PR, we should also add a validation on the variant since right now we can't call .valid? on an instance of Spree::Variant that does not have the product set:\nv = Spree::Variant.new\n=> #<Spree::Variant id: nil, sku: \"\", weight: 0.0, height: nil, width: nil, depth: nil, deleted_at: nil, > is_master: false, product_id: nil, cost_price: nil, position: nil, cost_currency: nil, track_inventory: true, tax_category_id: nil, updated_at: nil, created_at: nil>\nirb(main):090:0> v.valid?\nTraceback (most recent call last):\n        1: from (irb):90\nRuntimeError (No master variant found to infer price)\n\nShould I create an issue?\n. :+1: \nDone, please review :smile: . Updated commit message and PR description to reflect reviewed changes. We didn't, copy+paste mistake... Fixed it :smile: . Done. Agreed. Done. Agreed, it got quite long. Ruby's statement if condition is too good to don't use it. :smile:\n@kennyadsl contribution might reduce it though - https://github.com/solidusio/solidus/pull/3043#discussion_r249722989.. Sounds good. :+1: . Hm, after reviewing the code I'm having second thoughts. How can we validate product presence in variant if product requires a master variant to be present?\nThe funny thing is that product automatically builds master variant, but I was unable to find build_master method definition. Maybe I'm missing something :frowning_face: \nhttps://github.com/solidusio/solidus/blob/adc75347b93fa9a51195051530b892f3d3379486/core/app/models/spree/product.rb#L74-L76\nAny idea?. I see. :+1: . Done. Done. Whoa, that's great and works perfectly! Do you mind if I add a reference to implicit subject?\nruby\nit { is_expected.to be_invalid } # implicitly defined subject, see https://relishapp.com/rspec/rspec-core/v/3-5/docs/subject/implicitly-defined-subject. Ok, cool. :+1: . Done. ",
    "opsb": "apologies, PR is for a fork, will close this one. ",
    "CharlyJazz": "@ericsaupe Thats gold. We need that in the documentation. The people want create PWA, and modern front end architectures.. Thank for u support bro! @ericsaupe  :tada: :tada: . ",
    "kinduff": "Thanks for your input @aitbw, I'm quoting and responding.\n\nI think the Dockerfile is still missing some essential packages, such as postgresql-client and imagemagick \u2014I think we should add them in order to provide a seamless Docker experience\n\nimagemagick is already installed. I'm not sure about postgresql-client since by default sandbox environment is using sqlite, so for a demo purposes it works well.\n\nI'm no Docker expert, but I think we should be using docker compose to handle database responsabilities. What do you think?\n\nI'm all in with docker-compose files, but since this is a demo just to run and see Solidus, I think we should treat it as is, since it's using sqlite. If we want to provide the developers a Docker guidance, as an official way to setup the project - for dev, staging and production, I can help with that. \n\nDoes this work without any extra configuration on Solidus?\n\nWorks with Solidus out of the box, since it's just a demo meant to be ran in local and not a development platform.\n\nThe last time I worked with Docker, when we ran the commands to build the container, Docker did not respect the files' ownership \u2014this means we had to use sudo for every command every time we were not using Docker, which was very annoying. Is this the case here? If so, can we think of a solution?\n\nIt's not the case since it's using a sandbox user to lock it out, since the owner of the app is this user, you don't need sudo. If you need to /bin/bash into containers to modify things, then the setup for Docker and the application is not set correctly.\n\nDoes the full spec suite runs green without any extra configuration? I remember the --no-sandbox flag had to be included to the Headless Chrome setup under Docker containers.\n\nI'm working on adjustments to enable the tests suits on this image related to chromedriver, it's necessary but it's shouldn't be a blocker since it doesn't break the backend/frontend demo as this image is intended to provide. . > Are you sure about this? Because on the last project I worked on, we had to install imagemagick when building the container.\nYes @aitbw, give it a try:\ndocker run --rm -it kinduff/solidus-demo:latest convert --version\nShould output:\nVersion: ImageMagick 6.9.7-4 Q16 x86_64 20170114 http://www.imagemagick.org\nCopyright: \u00a9 1999-2017 ImageMagick Studio LLC\nLicense: http://www.imagemagick.org/script/license.php\nFeatures: Cipher DPC Modules OpenMP \nDelegates (built-in): bzlib djvu fftw fontconfig freetype jbig jng jp2 jpeg lcms lqr ltdl lzma openexr pangocairo png tiff wmf x xml zlib\nI also updated the README to point to the correct image, sorry about that. You should be able to run it too as a demo server.. @kennyadsl That's awesome. Let me know how I can help or if I can be added as a collaborator :+1: . @jacobherrington I :heart: your suggestions. I was thinking to use a namespace like Dockerfile.demo but your lib suggestion sounds way better. I'll address these changes in a bit, and also the changes on the README file.. @jacobherrington Just pushed the latest updates by your request. How do you think we could push this demo image to the official Solidus Dockerhub?. Looks like everything is set up, we're just missing to have the docker image in the official Dockerhub account.. ",
    "genarorg": "ah! thanks for pointing that out. I can make the change in solidus_auth_devise, so that the behavior would be consistent to that of core. How does that sound?. ",
    "doke": "Sure, this is running in a staging environment in production. Looking at the server logs I can see that it is sometimes calling GET \"/api/taxons?\" with a token parameter and sometimes it is not. Please see the below gist for a more detailed log dump. This is the result of editing a product and then clicking in the taxon field, then clicking in the option types triggering the GET requests to populate the dropdowns.\nhttps://gist.github.com/doke/5d57b9cc9e266e543c37ac10aca28b65\nRequest with an API key, returns ok:\n\nStarted GET \"/api/taxons?per_page=50&page=1&without_children=true&q%5Bname_cont%5D=&token=e24aa8cacfaa8dd3308807568b21a4b582dfca834d424938&=1552433529651\" for 49.255.167.97 at 2019-03-13 07:32:11 +0800\nProcessing by Spree::Api::TaxonsController#index as JSON\n  Parameters: {\"per_page\"=>\"50\", \"page\"=>\"1\", \"without_children\"=>\"true\", \"q\"=>{\"name_cont\"=>\"\"}, \"token\"=>\"e24aa8cacfaa8dd3308807568b21a4b582dfca834d424938\", \"\"=>\"1552433529651\"}\n  Spree::User Load (0.7ms)  SELECT  spree_users. FROM spree_users WHERE spree_users.deleted_at IS NULL AND spree_users.spree_api_key = 'e24aa8cacfaa8dd3308807568b21a4b582dfca834d424938' LIMIT 1\n   (3.8ms)  SELECT spree_roles.name FROM spree_roles INNER JOIN spree_roles_users ON spree_roles.id = spree_roles_users.role_id WHERE spree_roles_users.user_id = 1\n  Spree::Role Load (0.5ms)  SELECT spree_roles. FROM spree_roles INNER JOIN spree_roles_users ON spree_roles.id = spree_roles_users.role_id WHERE spree_roles_users.user_id = 1\n  Spree::Taxon Load (2.4ms)  SELECT  spree_taxons. FROM spree_taxons ORDER BY spree_taxons.taxonomy_id ASC, spree_taxons.lft ASC LIMIT 50 OFFSET 0\n  Spree::Taxon Load (5.2ms)  SELECT spree_taxons. FROM spree_taxons WHERE ((((((((((((spree_taxons.lft <= 1 AND spree_taxons.rgt >= 18 AND (spree_taxons.id != 1) OR spree_taxons.lft <= 2 AND spree_taxons.rgt >= 3 AND (spree_taxons.id != 3)) OR spree_taxons.lft <= 4 AND spree_taxons.rgt >= 5 AND (spree_taxons.id != 4)) OR spree_taxons.lft <= 6 AND spree_taxons.rgt >= 7 AND (spree_taxons.id != 5)) OR spree_taxons.lft <= 8 AND spree_taxons.rgt >= 9 AND (spree_taxons.id != 6)) OR spree_taxons.lft <= 10 AND spree_taxons.rgt >= 11 AND (spree_taxons.id != 8)) OR spree_taxons.lft <= 12 AND spree_taxons.rgt >= 13 AND (spree_taxons.id != 9)) OR spree_taxons.lft <= 14 AND spree_taxons.rgt >= 15 AND (spree_taxons.id != 14)) OR spree_taxons.lft <= 16 AND spree_taxons.rgt >= 17 AND (spree_taxons.id != 15)) OR spree_taxons.lft <= 19 AND spree_taxons.rgt >= 24 AND (spree_taxons.id != 11)) OR spree_taxons.lft <= 20 AND spree_taxons.rgt >= 21 AND (spree_taxons.id != 12)) OR spree_taxons.lft <= 22 AND spree_taxons.rgt >= 23 AND (spree_taxons.id != 13)) OR spree_taxons.lft <= 25 AND spree_taxons.rgt >= 26 AND (spree_taxons.id != 18)) ORDER BY spree_taxons.lft ASC\n  Rendering /var/www/staging/application-name/shared/bundle/ruby/2.3.0/gems/solidus_api-2.8.2/app/views/spree/api/taxons/index.json.jbuilder\n   (1.0ms)  SELECT COUNT(*) FROM (SELECT  1 AS one FROM spree_taxons ORDER BY spree_taxons.taxonomy_id ASC, spree_taxons.lft ASC LIMIT 50 OFFSET 0) subquery_for_count\n  Rendered /var/www/staging/application-name/shared/bundle/ruby/2.3.0/gems/solidus_api-2.8.2/app/views/spree/api/shared/_pagination.json.jbuilder (1.8ms)\n  Rendered /var/www/staging/application-name/shared/bundle/ruby/2.3.0/gems/solidus_api-2.8.2/app/views/spree/api/taxons/index.json.jbuilder (4.4ms)\nCompleted 200 OK in 64ms (Views: 4.5ms | ActiveRecord: 13.7ms)\n\nRequest without API key, 401:\n\nStarted GET \"/api/option_types?ids=1\" for 49.255.167.97 at 2019-03-13 07:32:09 +0800\nProcessing by Spree::Api::OptionTypesController#index as JSON\n  Parameters: {\"ids\"=>\"1\"}\n  Spree::User Load (0.6ms)  SELECT  spree_users.* FROM spree_users WHERE spree_users.deleted_at IS NULL AND spree_users.spree_api_key = '' LIMIT 1\n  Rendering   Rendered Filter chain halted as :authenticate_user rendered or redirected\nCompleted 401 Unauthorized in 8ms (Views: 1.4ms | ActiveRecord: 0.6ms)\n\nThis next gist shows editing a Taxon:\nhttps://gist.github.com/doke/0d8d45be4af313f50a0b8b13dc9c5f39\nYou can see some GET requests to /api/taxons include the token (which return fine) and some do not (which 401). I can also see that it is attempting to do a user lookup without an api key:\n\nSpree::User Load (1.2ms)  SELECT  spree_users.* FROM spree_users WHERE spree_users.deleted_at IS NULL AND spree_users.spree_api_key = '' LIMIT 1\n\nI can reproduce this with Curl:\n\ncurl -X GET -H \"Content-type: application/json\" -H \"Accept: application/json\"  \"https://server/api/option_types?ids=1\"\n{\"error\":\"You must specify an API key.\"}\n\nWith token:\n\ncurl -X GET -H \"Content-type: application/json\" -H \"Accept: application/json\"  \"https://server/api/option_types?ids=1&token=e24aa8cacfaa8dd3308807568b21a4b582dfca834d424938\"\n[{\"id\":1,\"name\":\"Size\",\"presentation\":\"Size\",\"position\":1,\"option_values\":[{\"id\":1,\"name\":\"OS\",\"presentation\":\"OS\",\"option_type_name\":\"Size\",\"option_type_id\":1,\"option_type_presentation\":\"Size\"},{\"id\":2,\"name\":\"XL\",\"presentation\":\"XL\",\"option_type_name\":\"Size\",\"option_type_id\":1,\"option_type_presentation\":\"Size\"},{\"id\":4,\"name\":\"L\",\"presentation\":\"L\",\"option_type_name\":\"Size\",\"option_type_id\":1,\"option_type_presentation\":\"Size\"},{\"id\":5,\"name\":\"M\",\"presentation\":\"M\",\"option_type_name\":\"Size\",\"option_type_id\":1,\"option_type_presentation\":\"Size\"},{\"id\":6,\"name\":\"S\",\"presentation\":\"S\",\"option_type_name\":\"Size\",\"option_type_id\":1,\"option_type_presentation\":\"Size\"},{\"id\":3,\"name\":\"XS\",\"presentation\":\"XS\",\"option_type_name\":\"Size\",\"option_type_id\":1,\"option_type_presentation\":\"Size\"}]}]. I have resolved something here. I had the staging site behind an http basic auth (configured through nginx). Turning this off for the /api/ endpoint was not enough. Disabling it for the entire site combined with a browser history clear worked.\n\nIssue still there though that some calls to /api/ are sending the api key and some are not.\nSorry if this started a goose chase! Perhaps the docs should reflect a warning about running behind basic auth. Thanks.. ",
    "twist900": "@aitbw you are right, closing. ",
    "jdibella": "There is in fact a great way to handle this:\n\nTo protect against this, you can actually define a new ActiveRecord model inside your migration that only gets used for that migration\n. \n",
    "ono": "hmm, probably it won't work. promotion.active? should return false when it's expired. I will fix that...\n. oops!\n. updated the PR\n. yep, i prefer expect to change too. to be honest, i wouldn't test dependent first of all as @jordan-brough wondered but i'm happy to make the change if we need it.\n. @jordan-brough done :)\n. ",
    "houndci-bot": "Annotation keywords like TODO should be all upper case, followed by a colon, and a space, then a note describing the problem.\n. Space missing inside }.\n. Extra blank line detected.\n. Extra blank line detected.\n. Space missing inside }.\n. Extra empty line detected at block body beginning.\n. Indent the right bracket the same as the start of the line where the left bracket is.\n. Use 2 spaces for indentation in an array, relative to the start of the line where the left square bracket is.\n. Use next to skip iteration.\n. Keep a blank line before and after private.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Extra blank line detected.Extra empty line detected at block body end.\n. Space missing inside }.\n. Use only ascii symbols in identifiers.Space missing inside {.\n. Use empty lines between method definitions.\n. Extra empty line detected at block body beginning.\n. Line is too long. [103/80]\n. Line is too long. [95/80]\n. Line is too long. [108/80]\n. Shadowing outer local variable - items.Line is too long. [84/80]\n. Extra blank line detected.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Extra blank line detected.\n. Align the elements of an array literal if they span more than one line.\n. Space missing inside }.\n. Space missing inside }.\n. Trailing whitespace detected.\n. Space missing inside }.\n. Space missing inside }.\n. Block argument expression is not on the same line as the block start.\n. Block argument expression is not on the same line as the block start.\n. Pass &:inventory_units as an argument to flat_map instead of a block.\n. Space between { and | missing.Space missing inside }.\n. Prefer map over collect.Space between { and | missing.\n. Prefer map over collect.Space between { and | missing.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Space inside { missing.Space inside } missing.\n. Unnecessary spacing detected.\n. Unused block argument - evaluator. If it's necessary, use _ or _evaluator as an argument name to indicate that it won't be used.\n. end at 45, 26 is not aligned with order.line_items.flat_map do |line_item| at 34, 27 or inventory_units: order.line_items.flat_map do |line_item| at 34, 10.\n. Incorrect indentation detected (column 10 instead of 8).\n. Indent the first parameter one step more than the start of the previous line.\n. Indent the first parameter one step more than the start of the previous line.\n. Indent the first parameter one step more than the start of the previous line.\n. Indent the first parameter one step more than the start of the previous line.\n. Extra blank line detected.\n. Redundant self detected.\n. Extra blank line detected.\n. Extra blank line detected.\n. Align the operands of an expression spanning multiple lines.\n. Use \\ instead of + or << to concatenate those strings.Align the operands of an expression spanning multiple lines.\n. Use \\ instead of + or << to concatenate those strings.\n. Useless protected access modifier.\n. protected (on line 26) does not make singleton methods protected. Use protected inside a class << self block instead.\n. protected (on line 26) does not make singleton methods protected. Use protected inside a class << self block instead.\n. protected (on line 26) does not make singleton methods protected. Use protected inside a class << self block instead.\n. protected (on line 26) does not make singleton methods protected. Use protected inside a class << self block instead.\n. protected (on line 26) does not make singleton methods protected. Use protected inside a class << self block instead.\n. Space missing to the left of {.\n. Space missing to the left of {.\n. Useless assignment to variable - table_name.\n. Extra empty line detected at class body beginning.\n. Space between { and | missing.Space missing inside }.\n. Redundant self detected.\n. Space missing inside }.\n. Hash#has_key? is deprecated in favor of Hash#key?.\n. Extra blank line detected.\n. Unnecessary spacing detected.Operator = should be surrounded by a single space.\n. Space inside { missing.Space inside } missing.\n. Incorrect indentation detected (column 8 instead of 12).\n. Redundant self detected.\n. Use empty lines between method definitions.\n. Surrounding space missing in default value assignment.\n. Missing space after #.\n. Missing space after #.\n. Missing space after #.\n. Extra empty line detected at module body end.\n. Useless assignment to variable - line_item.\n. Extra blank line detected.\n. Extra blank line detected.\n. Align the elements of an array literal if they span more than one line.\n. Use line_items[\"0\"][:options] = {currency: \"GBP\", price: 1.99} instead of line_items[\"0\"].merge! options: {currency: \"GBP\", price: 1.99}.Space inside { missing.Space inside } missing.\n. Use line_items[\"0\"][:options] = { currency: \"GBP\", price: 1.99 } instead of line_items[\"0\"].merge! options: { currency: \"GBP\", price: 1.99 }.\n. Unnecessary spacing detected.\n. Prefer double-quoted strings unless you need single quotes to avoid extra backslashes for escaping.\n. Prefer map over collect.\n. unexpected token tRBRACK\n(Using Ruby 2.3 parser; configure using TargetRubyVersion parameter, under AllCops)\n. unexpected token tRSHFT\n(Using Ruby 2.3 parser; configure using TargetRubyVersion parameter, under AllCops)unexpected token tIDENTIFIER\n(Using Ruby 2.3 parser; configure using TargetRubyVersion parameter, under AllCops)\n. unexpected token tEQQ\n(Using Ruby 2.3 parser; configure using TargetRubyVersion parameter, under AllCops)\n. unexpected token tCOLON\n(Using Ruby 2.3 parser; configure using TargetRubyVersion parameter, under AllCops)\n. unexpected token tLSHFT\n(Using Ruby 2.3 parser; configure using TargetRubyVersion parameter, under AllCops)\n. Prefer map over collect.\n. Trailing whitespace detected.\n. Unused method argument - options. If it's necessary, use _ or _options as an argument name to indicate that it won't be used.\n. Space missing inside }.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Tab detected.\n. Extra blank line detected.\n. Extra empty line detected at method body beginning.\n. Remove debugger entry point save_and_open_page.\n. Redundant self detected.\n. Final newline missing.\n. Unnecessary spacing detected.\n. Extra blank line detected.\n. Redundant return detected.\n. Extra blank line detected.Extra empty line detected at method body end.\n. Extra blank line detected.\n. Extra blank line detected.\n. Useless assignment to variable - signature. Did you mean signatures?\n. Redundant self detected.\n. Redundant self detected.\n. Redundant return detected.\n. Space missing inside }.\n. Space missing inside }.\n. Space missing inside }.\n. Extra blank line detected.\n. Use || instead of or.\n. unexpected token tCONSTANT\n(Using Ruby 2.3 parser; configure using TargetRubyVersion parameter, under AllCops)\n. Add parentheses to nested method call create factory.\n. Prefer map over collect.\n. Use casecmp instead of downcase !=.\n. Prefer map over collect.\n. Prefer detect over find.\n. Space missing inside }.\n. Annotation keywords like TODO should be all upper case, followed by a colon, and a space, then a note describing the problem.\n. Unused block argument - example. You can omit the argument if you don't care about it.\n. Hash#has_key? is deprecated in favor of Hash#key?.\n. Unnecessary spacing detected.\n. Unnecessary spacing detected.\n. Annotation keywords like TODO should be all upper case, followed by a colon, and a space, then a note describing the problem.\n. Align the operands of a condition in an if statement spanning multiple lines.\n. Align the operands of a condition in an if statement spanning multiple lines.\n. Hash#has_key? is deprecated in favor of Hash#key?.\n. Extra empty line detected at block body beginning.\n. Indentation of first line in file detected.\n. Unused method argument - format. If it's necessary, use _ or _format as an argument name to indicate that it won't be used. You can also write as locals(*) if you want the method to accept any arguments but don't care about them.\n. Extra empty line detected at class body end.\n. Unused method argument - end_time. If it's necessary, use _ or _end_time as an argument name to indicate that it won't be used. You can also write as parse_end_time(*) if you want the method to accept any arguments but don't care about them.\n. Unused method argument - format. If it's necessary, use _ or _format as an argument name to indicate that it won't be used. You can also write as content(*) if you want the method to accept any arguments but don't care about them.\n. Space missing inside }.\n. Unused block argument - evaluator. If it's necessary, use _ or _evaluator as an argument name to indicate that it won't be used.\n. Surrounding space missing in default value assignment.\n. Use the new Ruby 1.9 hash syntax.\n. Use backticks around command string.\n. Redundant self detected.\n. Trailing whitespace detected.\n. Extra empty line detected at method body end.\n. Extra empty line detected at class body end.\n. Extra empty line detected at class body beginning.\n. Extra empty line detected at block body end.\n. Extra empty line detected at block body end.\n. Extra empty line detected at block body end.\n. Extra empty line detected at block body end.\n. Extra empty line detected at block body end.\n. Extra empty line detected at block body end.\n. Extra empty line detected at block body end.\n. Extra blank line detected.\n. Extra empty line detected at class body end.\n. Extra empty line detected at method body end.\n. Extra empty line detected at class body beginning.\n. Extra empty line detected at block body end.\n. Extra empty line detected at block body end.\n. Extra empty line detected at block body end.\n. Extra empty line detected at block body end.\n. Extra empty line detected at block body end.\n. Extra empty line detected at block body end.\n. Extra empty line detected at block body end.\n. Extra blank line detected.\n. Extra empty line detected at class body end.\n. Redundant begin block detected.\n. Redundant self detected.\n. Avoid using rescue in its modifier form.\n. Final newline missing.\n. Final newline missing.\n. Final newline missing.\n. Unused block argument - app. You can omit the argument if you don't care about it.\n. Space missing after colon.\n. Space found before comma.Space inside } missing.\n. Use yield instead of block.call.\n. Closing method call brace must be on the line after the last argument when opening brace is on a separate line from the first argument.\n. Use next to skip iteration.Space after keyword unless is missing.\n. Unused method argument - block. If it's necessary, use _ or block as an argument name to indicate that it won't be used.\n. Tab detected.} at 83, 1 is not aligned with within('.selected .admin-subnav') {  at 81, 8.\n. Tab detected.\n. Trailing whitespace detected.\n. Tab detected.} at 77, 1 is not aligned with within('.selected .admin-subnav') {  at 75, 8.\n. Tab detected.\n. Trailing whitespace detected.\n. Tab detected.} at 65, 1 is not aligned with within('.selected .admin-subnav') {  at 63, 8.\n. Tab detected.\n. Trailing whitespace detected.\n. Tab detected.} at 59, 1 is not aligned with within('.selected .admin-subnav') {  at 57, 8.\n. Tab detected.\n. Trailing whitespace detected.\n. Tab detected.} at 53, 1 is not aligned with within('.selected .admin-subnav') {  at 51, 8.\n. Tab detected.\n. Trailing whitespace detected.\n. Tab detected.} at 47, 1 is not aligned with within('.selected .admin-subnav') {  at 45, 8.\n. Trailing whitespace detected.\n. Tab detected.} at 15, 1 is not aligned with within(\".admin-nav-header\") {  at 13, 8.\n. Tab detected.Trailing whitespace detected.\n. Trailing whitespace detected.\n. Space between { and | missing.Unused block argument - env. If it's necessary, use _ or _env as an argument name to indicate that it won't be used. Also consider using a proc without arguments instead of a lambda if you want it to accept any arguments but don't care about them.Space inside { missing.Operator => should be surrounded by a single space.Space inside } missing.Space missing inside }.\n. Space between { and | missing.Unused block argument - env. If it's necessary, use _ or _env as an argument name to indicate that it won't be used. Also consider using a proc without arguments instead of a lambda if you want it to accept any arguments but don't care about them.Space inside { missing.Operator => should be surrounded by a single space.Space inside } missing.Space missing inside }.\n. Space inside { missing.Space inside } missing.\n. Use Hash#key? instead of Hash#has_key?.\n. Extra empty line detected at block body end.\n. Use next to skip iteration.\n. Closing method call brace must be on the line after the last argument when opening brace is on a separate line from the first argument.\n. Remove debugger entry point save_and_open_page.. unexpected token tRBRACK. Unused block argument - user. You can omit the argument if you don't care about it.. Space inside { missing.Space inside } missing.. Unused block argument - user. You can omit the argument if you don't care about it.. Unused block argument - user. You can omit the argument if you don't care about it.. Space inside { missing.Space inside } missing.. Space inside { missing.Space inside } missing.. Space inside { missing.Space inside } missing.. Use !empty? instead of size > 0.. Use !empty? instead of size > 0.. Remove debugger entry point save_and_open_page.. Use order.payment_total.zero? instead of order.payment_total == 0.. Use payments.valid.size.zero? instead of payments.valid.size == 0.Use empty? instead of size == 0.. unexpected token errorambiguous first argument; put parentheses or a space even after the operator. unexpected token errorambiguous first argument; put parentheses or a space even after the operator. Don't use parentheses around a method call.Omit parentheses for ternary conditions.. Do not use spaces between -> and opening brace in lambda literals. Put empty method definitions on a single line.. Useless assignment to variable - length.. Extra empty line detected at block body beginning.. Extra blank line detected.. Extra blank line detected.. Redundant self detected.. Convert if nested inside else to elsif.. Extra blank line detected.. Trailing whitespace detected.. Space after keyword if is missing.. Extra empty line detected at class body beginning.. Extra empty line detected at class body beginning.. Unused method argument - auth_object. If it's necessary, use _ or _auth_object as an argument name to indicate that it won't be used. You can also write as ransackable_scopes() if you want the method to accept any arguments but don't care about them.. Space inside { missing.. Use parentheses in the method call to avoid confusion about precedence.. Closing method call brace must be on the same line as the last argument when opening brace is on the same line as the first argument.. Closing method call brace must be on the same line as the last argument when opening brace is on the same line as the first argument.. Missing space after #.. Incorrect indentation detected (column 6 instead of 4).Missing space after #.. Missing space after #.. Missing space after #.. Incorrect indentation detected (column 8 instead of 6).Missing space after #.. Incorrect indentation detected (column 6 instead of 8).Missing space after #.. Missing space after #.. Incorrect indentation detected (column 4 instead of 6).Missing space after #.. end at 13, 6 is not aligned with let(:promotion) do at 7, 2.. Extra empty line detected at block body end.. Space missing inside }.. unexpected token tCOMMA. unexpected token tCOMMA. unexpected token tCOMMA. Space inside { missing.. Extra empty line detected at block body beginning.. Extra empty line detected at block body beginning.. Extra empty line detected at class body end.. private (on line 27) does not make singleton methods private. Use private_class_method or private inside a class << self block instead.. Useless private access modifier.. Redundant self detected.. Redundant self detected.. Inconsistent indentation detected.. Indent when as deep as case.. Inconsistent indentation detected.. Indent when as deep as case.. unexpected token tRCURLY. unexpected token tLCURLYunexpected token tRCURLY. Unused block argument - example. You can omit the argument if you don't care about it.. Unused method argument - user_id. If it's necessary, use _ or user_id as an argument name to indicate that it won't be used.. Parenthesize the param change { shipment.adjustments.count } to make sure that the block will be associated with the change method call.. Block body expression is on the same line as the block start.. Block body expression is on the same line as the block start.. Block body expression is on the same line as the block start.. Block body expression is on the same line as the block start.. Put empty method definitions on a single line.. Redundant self detected.. Redundant self detected.. Space found before comma.. Useless assignment to variable - count. Use + instead of +=.. Useless assignment to variable - count. Use + instead of +=.. Parenthesize the param change { ActionMailer::Base.deliveries.size } to make sure that the block will be associated with the change method call.. Redundant self detected.. Use %i or %I for an array of symbols.. Use def with parentheses when there are parameters.. Use def with parentheses when there are parameters.. Useless assignment to variable - other_product.. Useless assignment to variable - variant.. Trailing whitespace detected.. Missing space after #.. Missing space after #.. Missing space after #.. Missing space after #.. Missing space after #.. Missing space after #.. Missing space after #.. Missing space after #.. Missing space after #.. Use should.zero? instead of should == 0.. Use should.zero? instead of should == 0.. Use should.zero? instead of should == 0.. Use should.zero? instead of should == 0.. Use should.zero? instead of should == 0.. Use should.zero? instead of should == 0.. Ambiguous negative number operator. Parenthesize the method arguments if it's surely a negative number operator, or add a whitespace to the right of the - if it should be a subtraction.. Ambiguous negative number operator. Parenthesize the method arguments if it's surely a negative number operator, or add a whitespace to the right of the - if it should be a subtraction.. Ambiguous negative number operator. Parenthesize the method arguments if it's surely a negative number operator, or add a whitespace to the right of the - if it should be a subtraction.. Ambiguous negative number operator. Parenthesize the method arguments if it's surely a negative number operator, or add a whitespace to the right of the - if it should be a subtraction.. Use uncaptured_amount.zero? instead of uncaptured_amount == 0.. Space inside } missing.. Space inside } missing.. Extra empty line detected at block body end.. Use reject instead of inverting select.. Use reject instead of inverting select.. Space inside { missing.Space inside } missing.. Space inside { missing.Space inside } missing.. Space inside { missing.Space inside } missing.. Space inside { missing.Space inside } missing.. Space inside { missing.Space inside } missing.. Space inside } missing.. Space inside { missing.Space inside } missing.. Surrounding space missing for operator =>.. Surrounding space missing for operator =>.. Surrounding space missing for operator =>.. Unnecessary spacing detected.. Extra empty line detected at block body beginning.. Space inside } missing.. unexpected token tRSHFTunexpected token tIDENTIFIER. unexpected token tEQQ. unexpected token tOROPunexpected token tIDENTIFIER. unexpected token tLSHFT. Trailing whitespace detected.. Use underscores() as decimal mark and separate every 3 digits with them.. Use current_shipment.inventory_units.count.zero? instead of current_shipment.inventory_units.count == 0.. Closing method call brace must be on the same line as the last argument when opening brace is on the same line as the first argument.. Closing method call brace must be on the same line as the last argument when opening brace is on the same line as the first argument.. Redundant return detected.Unnecessary spacing detected.. Use def with parentheses when there are parameters.. Redundant self detected.. Redundant self detected.. Redundant self detected.. Redundant return detected.. Redundant return detected.. Redundant return detected.. Redundant return detected.. Redundant return detected.. Redundant return detected.. Redundant return detected.. Redundant return detected.. Redundant return detected.. Redundant return detected.. Surrounding space missing in default value assignment.. Unused block argument - v. If it's necessary, use _ or v as an argument name to indicate that it won't be used.. Unused block argument - v. If it's necessary, use _ or _v as an argument name to indicate that it won't be used.. Omit parentheses for ternary conditions.. Unused block argument - v. If it's necessary, use _ or _v as an argument name to indicate that it won't be used.. Unused block argument - v. If it's necessary, use _ or _v as an argument name to indicate that it won't be used.. Omit parentheses for ternary conditions.. Remove debugger entry point binding.pry.. Remove debugger entry point binding.pry.. Remove debugger entry point binding.pry.. Remove debugger entry point binding.pry.. Space missing inside }.. Space missing inside }.. Extra empty line detected at block body beginning.. Extra empty line detected at block body beginning.. Extra empty line detected at block body beginning.. Space inside { missing.Surrounding space missing for operator =>.Space inside } missing.. Closing method call brace must be on the line after the last argument when opening brace is on a separate line from the first argument.. Closing method call brace must be on the line after the last argument when opening brace is on a separate line from the first argument.. Remove debugger entry point binding.pry.. Closing method call brace must be on the line after the last argument when opening brace is on a separate line from the first argument.. Closing method call brace must be on the line after the last argument when opening brace is on a separate line from the first argument.. Remove debugger entry point binding.pry.. Closing method call brace must be on the line after the last argument when opening brace is on a separate line from the first argument.. Closing method call brace must be on the line after the last argument when opening brace is on a separate line from the first argument.. Redundant self detected.. Prefer detect over find.. Redundant self detected.. Prefer detect over find.. Space inside { missing.Space inside } missing.. Space inside { missing.Space inside } missing.. Do not use spaces between -> and opening brace in lambda literals. Do not use spaces between -> and opening brace in lambda literals. Do not use spaces between -> and opening brace in lambda literals. Do not use spaces between -> and opening brace in lambda literals. Do not use spaces between -> and opening brace in lambda literals. Do not use spaces between -> and opening brace in lambda literals. Do not use spaces between -> and opening brace in lambda literals. Do not use spaces between -> and opening brace in lambda literals. When using method_missing, define respond_to_missing? and fall back on super.. When using method_missing, fall back on super.. Useless assignment to variable - include_private.. Align the operands of a condition in an if statement spanning multiple lines.. Align the operands of a condition in an if statement spanning multiple lines.. Align the operands of a condition in an if statement spanning multiple lines.Use value.zero? instead of value == 0.. Align the operands of a condition in an if statement spanning multiple lines.. Align the operands of a condition in an if statement spanning multiple lines.. Align the operands of a condition in an if statement spanning multiple lines.Use value.zero? instead of value == 0.. Surrounding space missing in default value assignment.. Add an empty line after magic comments.. Use value.zero? instead of value == 0.. Add an empty line after magic comments.. Missing space after #.. Use the new Ruby 1.9 hash syntax.. Use the new Ruby 1.9 hash syntax.. Use the new Ruby 1.9 hash syntax.. Use the new Ruby 1.9 hash syntax.. Use the new Ruby 1.9 hash syntax.. Use the new Ruby 1.9 hash syntax.. Use the new Ruby 1.9 hash syntax.. Surrounding space missing for operator &.. Space between { and | missing.. Duplicated key in hash literal.. unexpected token tRSHFTunexpected token tIDENTIFIER. unexpected token tEQQ. unexpected token tLSHFT. Space inside { missing.Space inside } missing.. Space missing inside }.. Space missing inside }.. Use proc instead of Proc.new.. Missing space after #.. Missing space after #.. Pass array contents as separate arguments.. Add parentheses to nested method call File.dirname ENV['BUNDLE_GEMFILE'].. 1 trailing blank lines detected.. 1 trailing blank lines detected.. Do not use :: for method calls.. Redundant begin block detected.. Operator = should be surrounded by a single space.Unnecessary spacing detected.. Operator = should be surrounded by a single space.Unnecessary spacing detected.. Unused block argument - attachment. You can omit all the arguments if you don't care about them.Unused block argument - style. You can omit all the arguments if you don't care about them.. Use amount.zero? instead of amount == 0.. Use max.zero? instead of max == 0.Use i.zero? instead of i == 0.Use (i % max).zero? instead of i % max == 0.. Use items_count.zero? instead of items_count == 0.. Block body expression is on the same line as the block start.. Block body expression is on the same line as the block start.. Use max.zero? instead of max == 0.Use i.zero? instead of i == 0.Use (i % max).zero? instead of i % max == 0.. Use items_count.zero? instead of items_count == 0.. Use empty lines between method definitions.. Extra blank line detected.. Use empty lines between method definitions.. Extra blank line detected.. Use underscores() as decimal mark and separate every 3 digits with them.. Space between { and | missing.. Use dir to get an absolute path to the current file's directory.. Use warn instead of $stderr.puts.. Unused block argument - attachment. You can omit all the arguments if you don't care about them.Unused block argument - style. You can omit all the arguments if you don't care about them.. Extra empty line detected at module body beginning.. Extra empty line detected at class body beginning.. Do not use parentheses for method calls with no arguments.. 1 trailing blank lines detected.. 1 trailing blank lines detected.. Extra blank line detected.. Avoid when branches without a body.. Extra blank line detected.. Inconsistent indentation detected.. unexpected token tSTRING. bare backslash only allowed before newline. Useless assignment to variable - inventory_units.. Redundant self detected.. Prefer the use of lambda.call(...) over lambda.(...).. Space found before comma.. Unused method argument - taxon. If it's necessary, use _ or _taxon as an argument name to indicate that it won't be used. You can also write as applicable_filters_for() if you want the method to accept any arguments but don't care about them.. Extra empty line detected at block body end.. unexpected token kEND. unexpected token kEND. unexpected token kEND. unexpected token kEND. Use attr_reader to define trivial reader methods.. Pass array contents as separate arguments.. Pass array contents as separate arguments.. Extra blank line detected.. Unused block argument - evaluator. If it's necessary, use _ or _evaluator as an argument name to indicate that it won't be used.. Do not use %W unless interpolation is needed. If not, use %w.. Shadowing outer local variable - rate.. Shadowing outer local variable - rate.. Trailing whitespace detected.. Space found before comma.Space missing inside }.. Space missing inside }.. 'Spree' is not defined     no-undef. '$' is not defined         no-undef. '$' is not defined         no-undef. '$' is not defined                            no-undef. '' is not defined                            no-undef. 'addVariantFromStockLocation' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. Space inside { missing.Space inside } missing.. Unused method argument - options. If it's necessary, use _ or options as an argument name to indicate that it won't be used.. Surrounding space missing in default value assignment.. 'Spree' is not defined     no-undef. '$' is not defined         no-undef. '$' is not defined         no-undef. '$' is not defined                            no-undef. '' is not defined                            no-undef. 'addVariantFromStockLocation' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. 'Spree' is not defined  no-undef. Missing magic comment # frozen_string_literal: true.. Missing magic comment # frozen_string_literal: true.. Missing magic comment # frozen_string_literal: true.. Missing magic comment # frozen_string_literal: true.. Trailing whitespace detected.. Pass array contents as separate arguments.. Pass array contents as separate arguments.. Missing magic comment # frozen_string_literal: true.. Missing magic comment # frozen_string_literal: true.. Missing magic comment # frozen_string_literal: true.. Use self instead of Object#to_s in interpolation.. Use self instead of Object#to_s in interpolation.. Space missing inside }.. Missing magic comment # frozen_string_literal: true.. Missing magic comment # frozen_string_literal: true.. Add an empty line after magic comments.. Add an empty line after magic comments.. Lint/ScriptPermission: Script file list.rb doesn't have execute permission.. Layout/LeadingCommentSpace: Missing space after #.. Style/ParenthesesAroundCondition: Don't use parentheses around the condition of an if.. Style/ParenthesesAroundCondition: Don't use parentheses around the condition of an if.. Layout/EmptyLinesAroundBlockBody: Extra empty line detected at block body beginning.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/ExtraSpacing: Unnecessary spacing detected.. Layout/ExtraSpacing: Unnecessary spacing detected.. Layout/LeadingCommentSpace: Missing space after #.. Layout/LeadingCommentSpace: Missing space after #.. Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Layout/IndentationConsistency: Inconsistent indentation detected.. Layout/IndentationConsistency: Inconsistent indentation detected.. Layout/EmptyLinesAroundAccessModifier: Keep a blank line before and after private.. Layout/EmptyLinesAroundBlockBody: Extra empty line detected at block body end.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/ExtraSpacing: Unnecessary spacing detected.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/RedundantSelf: Redundant self detected.. Style/RedundantSelf: Redundant self detected.. Style/RedundantSelf: Redundant self detected.. Style/RedundantSelf: Redundant self detected.. Layout/ExtraSpacing: Unnecessary spacing detected.. Lint/UselessAssignment: Useless assignment to variable - event.. Layout/TrailingBlankLines: Final newline missing.. Lint/UselessAssignment: Useless assignment to variable - aspect_ratio.. Lint/DeprecatedClassMethods: File.exists? is deprecated in favor of File.exist?.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/RedundantReturn: Redundant return detected.. Layout/SpaceAroundKeyword: Space after keyword if is missing.. Style/OptionalArguments: Optional arguments should appear at the end of the argument list.Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/SpaceAroundOperators: Operator ? should be surrounded by a single space.Layout/ExtraSpacing: Unnecessary spacing detected.. Layout/EmptyComment: Source code comment is empty.. Style/HashSyntax: Use the new Ruby 1.9 hash syntax.. Style/HashSyntax: Use the new Ruby 1.9 hash syntax.. Style/HashSyntax: Use the new Ruby 1.9 hash syntax.. Layout/SpaceInsideHashLiteralBraces: Space inside { missing.Layout/SpaceInsideHashLiteralBraces: Space inside } missing.. Performance/StringReplacement: Use tr instead of gsub.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/TrailingWhitespace: Trailing whitespace detected.. Layout/TrailingBlankLines: Final newline missing.. Lint/UselessAssignment: Useless assignment to variable - aspect_ratio.. Lint/DeprecatedClassMethods: File.exists? is deprecated in favor of File.exist?.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/RedundantReturn: Redundant return detected.. Layout/SpaceAroundKeyword: Space after keyword if is missing.. Style/OptionalArguments: Optional arguments should appear at the end of the argument list.Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Lint/Syntax: unexpected token error. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/TrailingBlankLines: Final newline missing.. Lint/UselessAssignment: Useless assignment to variable - aspect_ratio.. Lint/DeprecatedClassMethods: File.exists? is deprecated in favor of File.exist?.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/RedundantReturn: Redundant return detected.. Layout/SpaceAroundKeyword: Space after keyword if is missing.. Style/OptionalArguments: Optional arguments should appear at the end of the argument list.Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Lint/Syntax: unexpected token error. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/ParenthesesAroundCondition: Don't use parentheses around the condition of an if.. Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FormatStringToken: Prefer annotated tokens (like %s) over unannotated tokens (like %s).. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Lint/Syntax: unexpected token error. Layout/TrailingWhitespace: Trailing whitespace detected.. Layout/TrailingWhitespace: Trailing whitespace detected.. Layout/TrailingWhitespace: Trailing whitespace detected.. Style/FormatStringToken: Prefer annotated tokens (like %s) over unannotated tokens (like %s).. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Lint/Syntax: unexpected token error. Lint/DuplicateMethods: Method Spree::Gallery::VariantGallery#images is defined at both core/app/models/spree/gallery/variant_gallery.rb:6 and core/app/models/spree/gallery/variant_gallery.rb:15.. Lint/DuplicateMethods: Method Spree::Gallery::ProductGallery#images is defined at both core/app/models/spree/gallery/product_gallery.rb:6 and core/app/models/spree/gallery/product_gallery.rb:15.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/ExtraSpacing: Unnecessary spacing detected.. Layout/ExtraSpacing: Unnecessary spacing detected.. Lint/Syntax: unexpected token error. Lint/UnusedMethodArgument: Unused method argument - desired. If it's necessary, use _ or _desired as an argument name to indicate that it won't be used. You can also write as allocate_inventory() if you want the method to accept any arguments but don't care about them.. Lint/UnusedMethodArgument: Unused method argument - desired. If it's necessary, use _ or _desired as an argument name to indicate that it won't be used. You can also write as allocate_inventory() if you want the method to accept any arguments but don't care about them.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Lint/UnusedMethodArgument: Unused method argument - error. If it's necessary, use _ or _error as an argument name to indicate that it won't be used. You can also write as handle() if you want the method to accept any arguments but don't care about them.Lint/UnusedMethodArgument: Unused method argument - severity. You can also write as handle() if you want the method to accept any arguments but don't care about them.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/SpaceBeforeComma: Space found before comma.. Style/HashSyntax: Use the new Ruby 1.9 hash syntax.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/TrailingWhitespace: Trailing whitespace detected.. Layout/EmptyLines: Extra blank line detected.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/TrailingWhitespace: Trailing whitespace detected.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.Layout/CommentIndentation: Incorrect indentation detected (column 1 instead of 0).. Layout/EmptyLinesAroundBlockBody: Extra empty line detected at block body end.. Lint/UselessAssignment: Useless assignment to variable - previous_order. Did you mean previous_user?. Layout/EmptyLinesAroundBlockBody: Extra empty line detected at block body end.. Lint/UnusedBlockArgument: Unused block argument - evaluator. If it's necessary, use _ or _evaluator as an argument name to indicate that it won't be used.. Layout/BlockEndNewline: Expression at 18, 53 should be on its own line.. Layout/MultilineBlockLayout: Block body expression is on the same line as the block start.. Layout/EmptyLinesAroundClassBody: Extra empty line detected at class body end.. Layout/EmptyLinesAroundClassBody: Extra empty line detected at class body end.. Layout/EmptyLinesAroundClassBody: Extra empty line detected at class body beginning.. Layout/EmptyLinesAroundClassBody: Extra empty line detected at class body beginning.. Layout/SpaceInsideBlockBraces: Space missing inside }.. Layout/TrailingWhitespace: Trailing whitespace detected.. Layout/EmptyLinesAroundBlockBody: Extra empty line detected at block body beginning.. Layout/SpaceInsideBlockBraces: Space missing inside {.Layout/SpaceInsideBlockBraces: Space missing inside }.. Layout/EmptyLineAfterMagicComment: Add an empty line after magic comments.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/ExpandPathArguments: Use expand_path('dummy/config/environment.rb', dir) instead of expand_path('../dummy/config/environment.rb', FILE).. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/SpaceInsideHashLiteralBraces: Space inside { missing.Layout/SpaceInsideHashLiteralBraces: Space inside } missing.. Lint/Syntax: unexpected token error. Use 1 space after <% instead of 0 space.Use 1 space before %> instead of 0 space.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/MultilineOperationIndentation: Align the operands of a condition in an if statement spanning multiple lines.. Layout/TrailingWhitespace: Trailing whitespace detected.. Lint/Syntax: unexpected token tRBRACK. Lint/Syntax: unexpected token error. Layout/TrailingBlankLines: 1 trailing blank lines detected.. Layout/TrailingBlankLines: 1 trailing blank lines detected.. Layout/SpaceInsideBlockBraces: Space between { and | missing.. Lint/AmbiguousOperator: Ambiguous splat operator. Parenthesize the method arguments if it's surely a splat operator, or add a whitespace to the right of the * if it should be a multiplication.. Lint/AmbiguousOperator: Ambiguous splat operator. Parenthesize the method arguments if it's surely a splat operator, or add a whitespace to the right of the * if it should be a multiplication.. Style/NestedParenthesizedCalls: Add parentheses to nested method call described_class.available restrict_to_zone: 'Custom Zone'.. Style/NestedParenthesizedCalls: Add parentheses to nested method call described_class.available restrict_to_zone: nil.. Style/NestedParenthesizedCalls: Add parentheses to nested method call described_class.available restrict_to_zone: nil.. Style/NestedParenthesizedCalls: Add parentheses to nested method call described_class.available restrict_to_zone: 'Checkout Zone'.. Style/NestedParenthesizedCalls: Add parentheses to nested method call described_class.available restrict_to_zone: 'Custom Zone'.. Style/NestedParenthesizedCalls: Add parentheses to nested method call described_class.available restrict_to_zone: nil.. Lint/AmbiguousOperator: Ambiguous splat operator. Parenthesize the method arguments if it's surely a splat operator, or add a whitespace to the right of the * if it should be a multiplication.. Lint/AmbiguousOperator: Ambiguous splat operator. Parenthesize the method arguments if it's surely a splat operator, or add a whitespace to the right of the * if it should be a multiplication.. Lint/AmbiguousOperator: Ambiguous splat operator. Parenthesize the method arguments if it's surely a splat operator, or add a whitespace to the right of the * if it should be a multiplication.. Style/ZeroLengthPredicate: Use !empty? instead of size > 0.. Style/ZeroLengthPredicate: Use !empty? instead of size > 0.. Style/ZeroLengthPredicate: Use !empty? instead of size > 0.. Style/ZeroLengthPredicate: Use !empty? instead of size > 0.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/EmptyLinesAroundExceptionHandlingKeywords: Extra empty line detected after the rescue.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/TrailingBlankLines: Final newline missing.. Style/InverseMethods: Use reject instead of inverting select.. Layout/TrailingWhitespace: Trailing whitespace detected.. Layout/TrailingWhitespace: Trailing whitespace detected.. Layout/TrailingWhitespace: Trailing whitespace detected.. Lint/Syntax: unexpected token tRPAREN. Lint/Syntax: unexpected token tCOLON. Lint/Syntax: unexpected token tCOLON. Lint/Syntax: unexpected token tCOLON. Lint/Syntax: unexpected token tCOLON. Lint/Syntax: unexpected token tSTRING_BEGLint/Syntax: unexpected token tCOLON. Lint/Syntax: unexpected token tCOLON. Lint/Syntax: class definition in method body. Lint/Syntax: module definition in method body. Lint/Syntax: unexpected token tRPAREN. Lint/Syntax: module definition in method body. Lint/Syntax: class definition in method body. Lint/Syntax: module definition in method body. Lint/Syntax: unexpected token error. Style/MultipleComparison: Avoid comparing a variable with multiple items in a conditional, use Array#include? instead.. Layout/SpaceBeforeComma: Space found before comma.. Layout/EmptyLineAfterMagicComment: Add an empty line after magic comments.. Layout/EmptyLineAfterMagicComment: Add an empty line after magic comments.. Layout/TrailingBlankLines: 1 trailing blank lines detected.. Tag col is self-closing, it must end with />.. Tag col is self-closing, it must end with />.. Tag col is self-closing, it must end with />.. Tag col is self-closing, it must end with />.. Tag col is self-closing, it must end with />.. Tag col is self-closing, it must end with />.. Tag col is self-closing, it must end with />.. Use 1 space before %> instead of 0 space.. Lint/Syntax: unexpected token error. Lint/AmbiguousOperator: Ambiguous negative number operator. Parenthesize the method arguments if it's surely a negative number operator, or add a whitespace to the right of the - if it should be a subtraction.. Layout/TrailingWhitespace: Trailing whitespace detected.. Layout/LeadingCommentSpace: Missing space after #.. Layout/LeadingCommentSpace: Missing space after #.. Layout/LeadingCommentSpace: Missing space after #.. Lint/AmbiguousOperator: Ambiguous splat operator. Parenthesize the method arguments if it's surely a splat operator, or add a whitespace to the right of the * if it should be a multiplication.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/SpaceAroundEqualsInParameterDefault: Surrounding space missing in default value assignment.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Layout/LeadingCommentSpace: Missing space after #.. Layout/LeadingCommentSpace: Missing space after #.. Layout/LeadingCommentSpace: Missing space after #.. Style/CommentAnnotation: Annotation keywords like TODO should be all upper case, followed by a colon, and a space, then a note describing the problem.. Style/CommentAnnotation: Annotation keywords like TODO should be all upper case, followed by a colon, and a space, then a note describing the problem.. Lint/Syntax: unexpected token error. Lint/UselessAssignment: Useless assignment to variable - attachment_variant.. Style/MethodDefParentheses: Use def with parentheses when there are parameters.. Style/MethodDefParentheses: Use def with parentheses when there are parameters.. Style/MethodDefParentheses: Use def with parentheses when there are parameters.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. No space detected where there should be a single space.. Style/FormatStringToken: Prefer annotated tokens (like %s) over unannotated tokens (like %s).. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Lint/Syntax: unexpected token error. Style/HashSyntax: Use the new Ruby 1.9 hash syntax.. Layout/LeadingCommentSpace: Missing space after #.. Layout/EmptyLineAfterMagicComment: Add an empty line after magic comments.. Style/EachWithObject: Use each_with_object instead of inject.Style/EmptyLiteral: Use hash literal {} instead of Hash.new.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/CaseEquality: Avoid the use of the case equality operator ===.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/RescueStandardError: Avoid rescuing without specifying an error class.. Layout/LeadingCommentSpace: Missing space after #.. Layout/LeadingCommentSpace: Missing space after #.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Lint/AmbiguousOperator: Ambiguous splat operator. Parenthesize the method arguments if it's surely a splat operator, or add a whitespace to the right of the * if it should be a multiplication.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Style/FrozenStringLiteralComment: Missing magic comment # frozen_string_literal: true.. Lint/AmbiguousOperator: Ambiguous splat operator. Parenthesize the method arguments if it's surely a splat operator, or add a whitespace to the right of the * if it should be a multiplication.. Layout/EmptyLinesAroundAccessModifier: Keep a blank line before and after private.. Use 1 space before %> instead of 0 space.. Layout/LeadingCommentSpace: Missing space after #.. Layout/LeadingCommentSpace: Missing space after #.. Layout/MultilineMethodCallBraceLayout: Closing method call brace must be on the line after the last argument when opening brace is on a separate line from the first argument.. Layout/BlockAlignment: end at 232, 4 is not aligned with context \"when order has only a void payment\" do at 214, 2.. Layout/BlockAlignment: end at 231, 6 is not aligned with it \"does not allow successful order submission\" do at 226, 4.. Tag col is self-closing, it must end with />.. Tag col is self-closing, it must end with />.. Tag col is self-closing, it must end with />.. Lint/Syntax: unexpected token error. Lint/Syntax: unexpected token error. Style/MultilineIfThen: Do not use then for multi-line if.. Style/MultilineIfThen: Do not use then for multi-line if.. Style/MultilineIfThen: Do not use then for multi-line if.. Style/MultilineIfThen: Do not use then for multi-line if.. Style/MultilineIfThen: Do not use then for multi-line if.. Layout/SpaceInsideBlockBraces: Space missing inside {.Layout/SpaceInsideBlockBraces: Space missing inside }.. Layout/SpaceInsideBlockBraces: Space missing inside {.Layout/SpaceInsideBlockBraces: Space missing inside }.. Style/HashSyntax: Use the new Ruby 1.9 hash syntax.. ",
    "timrossinfo": "Thanks @jhawthorn, good point! I will update this to ~> 1.7\n. ",
    "davidedistefano": "Thanks for your feedback! Can you please tell me what browser you are using and at which window width do you see this jumpy scrolling behaviour.. @graygilmore thanks for your feedback! We thought that having a mixin would be easier to add features to media query in future development, without updating code in the whole project. Also the mixin version seems to be a little more user friendly and more \"readable\". \nBut your suggestion also makes sense and we're open to change code in this direction if you want. . Actually we tried to add a CSS transition to the nav, but while using only CSS allows you to have a cleaner code, you don't have the same power as you have with Javascript :) \nWe found a bug in particular that occurs while resizing the window, as explained by this GIF:\n\nSo we thought that in order to avoid focusing too much on the transition effect, we'd implement a first version of the collapsible navigation without effect.\nAny suggestion to avoid this bug?. ",
    "gitmihalis": "I don't think the !have_states? 'required' logic makes sense for anything else besides styles here. It's simple enough to remove the required: true attribute for a fringe case where address-level1 would not be required, but the form is for Debit/Credit or Shipping which do require an address.. Yes, I could take it out.. ",
    "shcyiza": "kennyadsl is right my intend was to sumbit the form with the onclick: 'this.form.submit()' option... But it's no big deal... Eventhought the ecommerce design don't have no sumbit button for their filters... That's why i implemented it.. ",
    "ahoernecke": "If both return nil, it should signify that the system is trying to clear the default payment source (wallet_payment_source=>nil) and that the default payment source is already not set (default_wallet_payment_source=>nil). Since we just return for this case, nothing would change, which I would think is what would be wanted.\n. @jhawthorn, made the change to not compare against the ids.. ",
    "Empact": "I suggest disabling the Bundler/OrderedGems cop instead of doing this. Alphabetical ordering is second to group by functionality / ordering by importance, in my mind at least.. ",
    "juliancheal": "@Empact @mamhoff good points. I've reverted the Gemfile change. And I'll make a followup PR with the removal of the cop. \ud83d\udc4d . ",
    "craigjbass": "We were just looking at the Store Credits functionality this morning and agree with @luukveenis's assessment. We found the inconsistency in naming pretty confusing (note it's also inconsistent in the backend UI).\nAlso, we're actually lost as to what Category and Types are trying to achieve? I.e. what is the difference? Wondering if anyone here could shed some light onto this. From what we could see it didn't seem like there needed to be two models representing this concept.. @luukveenis - yes. It also means the current implementation is far more complicated than it should be (to achieve the same thing). I'm personally new to Solidus eCom but seems like it is a really difficult affair to backtrack on design decisions, due to fear that it will break someone's proprietary setup? . ",
    "Sciyguy": "Yes, you are correct. I've fixed this in my local repo already, althouhg it had worked as commited too. On the other hand, it is also not enterily correct to name the slovenian translation of solidus sl-SI. It should be only sl (as iso code). Wrong name couses other problems, for example jquery validation on checkout pages... I can commit both fixes if desired, otherwise I'll update only current pull request. . ",
    "bazfer": "What I suggested is what worked for me, but if either one of these two alternatives resolve as well and the pattern is preferred, sure, why not.. ",
    "andyyang": "Could I help to add the comment?. ",
    "gylaz": "We've switched to naming these by linter name (rather than language), so this should either be erb_lint or its alias erblint.. For legacy reasons, old keys are still supported. It's just the new keys that are added (and all the new documentation) are now by linter name (given that for certain languages we now support multiple linters).. ",
    "jkojro": "Hi @coorasse! But if :read alias was :show shouldn't it be changed like this scope = Spree::Product.with_deleted.accessible_by(current_ability, :show).includes(*product_includes) to keep same logic? Isn't your change changing scope from show to index now?.  (current_ability, :read) made scope of products that user is authorized for action :show I gues.. @coorasse Could you explain why is it unaccessible?. "
}