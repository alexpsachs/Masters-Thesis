{
    "addyosmani": "Could you let me know if that sufficiently solves the issue? Now only writes to disk if opts.dest is specified. Added tests to check against the pre-generated output too.\n. Good idea. We'll add support in a future release.\n. Awesome! Mostly hoping to mimic what was done for https://github.com/addyosmani/psi/blob/master/bin/cli.js but something even more minimal wouldn't be bad at all :)\n. Should be fixed now. If I've missed something, do let me know :)\n. Good idea. Will add!\n. These have been added. Closing :)\n. Fixed.\n. SGTM. Thanks for the reply :) Will get this rebased and get a sane default in place.\n. Thanks!\n. :star: \n. Hmm. I haven't tested on Windows yet but this looks very curious. \nCould you let me know if you're able to get this sample using Critical running for you correctly on Windows https://github.com/addyosmani/critical-path-css-demo? \nAlternatively, just verifying the module works in your environment would be of great help. I'm trying to determine if this is a test harness issue, fs, penthouse or straight-out something silly I'm doing in the module.\n. Appreciate it!\n. That's crazy. I wonder if the same issues occur with running https://github.com/pocketjoso/penthouse standalone vs. my module. I don't have a windows box handy but will try to debug this issue next week and get to the bottom of it.\n. Interesting. There's something silly I'm doing in this module then. Looking into it.\n. @XhmikosR pushed some potential fixes to master. Could you let me know if there's any difference in test output?\n. Thanks to Sindre we have a fresh rewrite now in master. Any luck now?\n. This is really weird. @sindresorhus I don't suppose you have any hints that would be worth considering here, would you?\n. I wonder if it's more sensible for our API tests to just test against the output of each method directly rather than writing to disk and comparing the read-in input. Do any of our non i/o tests pass on Windows?\n. I've been testing the module on Windows 8 today and ran into the same issues @XhmikosR mentions above. In addition, even if we're not just talking about the unit tests, the demo app using this module also seems to silently fail (builds, but critical path CSS is not inlined). \nSomething like this however does work (pardon Notepad):\n\nIn contrast, I was able to get the penthouse test working locally on windows with no issues.\n. Working on fixes. Have 4 tests passing now. Just a few more to go :)\n. Good catch. We could indeed just simplify that further. I think you're right that the critical.css file might just be the one that needs correcting. Most of the tests are failing on inlining atm.\n. Hah! I didn't realize that was supported :)\n. :star:\n. \n:') Thanks @sindresorhus. I really appreciate all the fixes. Going to through them now in more detail so I can try to avoid some of the sillier things I've done here in the future.\nWill also aim to use Apache-2.0 instead of Apache2 (I've been using this in other repos too so will get them similarly updated).\n. Changes LGTM. Thanks again, @sindresorhus :horse: :cake: :tada: \n. There are two directions we could go here. One is adding support for just throwing raw HTML at Critical so you don't have to write to disk (simpler) and the other is adding support for remote resources. One argument for not going for the latter is that it's not too much additional code to get Critical working with http separately.\nIf we go down the remote path, I think you'd need to keep in mind that Oust will want to try extracting all of the remote stylesheets and that would need to be factored in as well. If you could talk about how you would solve this in more detail we could consider it further.\ncc @sindresorhus for an FYI.\n. @micahblu Could you share a little information about what OS and version of Node you were testing with? I'd like to try reproducing the issue you're running into. Also, sorry for your first experience with Critical needing a little debugging. Hopefully we can improve over time :)\n. If you could submit a PR that would be hugely appreciated! Thank you :)\n. Thanks for the suggestion. As this is just a Node module rather than a Gulp plugin, we do have tests albeit not gulp-qunit ones. If someone however ends up writing a Gulp plugin on top of us, that would definitely benefit from Gulp tests.\n. @bezoerb Thanks for addressing some of the pointers Sindre has been making so far. I think we need to work on docs a little more, but I'll take another look once the tests are passing too. We won't be able to land this until we're all green :)\n. Thanks for the code review @sindresorhus :)\n. Thanks @bezoerb! \n. We currently expect that Critical is used as part of a post-build step where your stylesheets have been squashed down to a single stylesheet but I agree that we should factor in all stylesheets.\nBrainstorming process:\nAccept HTML \nExtract stylesheets\nNew temp file/stream: Combine extracted stylesheets (let's call this X)\nStrip stylesheets from input HTML\nNew temp file/stream: Add back X to your HTML, now with all styles in one source\nGenerate critical path CSS\nrest of process as normal\n. This should be fixed in master now :)\n. Issue re-opened. Thanks for the detailed feedback!\n. Do you have a demo or reproducible test of where this was failing? The change LGTM otherwise but I'd like to verify what wasn't working before we merge it in.\n. Change LGTM. Merging. Thank you!\n. LGTM. Thanks!\n. At the moment a particular workflow is assumed (see https://github.com/addyosmani/critical#demo-projects) whereby this shouldn't cause issues, but I agree that we should only inline the critical-path CSS. \nI think the diffing functionality you describe could also be useful, but I would be concerned about it's accuracy. Perhaps we can tackle the first problem :)\n. I'll provide feedback on stylediff this week. Thanks for the PR and raising the issue.\n. Could you rebase this against master please?\n. @bezoerb interested in your take on how useful this might be. I'm on the fence about the level of configuration power we provide for sub-tasks here and a second opinion would be useful :)\n. Thanks for working on this. If you could squash your commits I think we can get this in this week.\n. Tested this earlier in the week and changes LGTM post squash. Thanks for working on this.\n. :+1: \n. We'll test master for a few days just to check for issues and then cut a new release if all goes well.\n. Thanks! Fixed :)\n. Updating the rest of the apps retroactively. We've now updated through a few releases.\n. Thank you for testing and the review!\n. Thanks to the fix provided by @bezoerb, this is now in 0.3.1 https://www.npmjs.org/package/critical \n. Thanks for getting a fix out for this so soon! Landing a patch release for this shortly.\n. Understood. I appreciate any time you're able to spend on the issue around tests.\n. Tests are passing with this change and update LGTM. Thanks!\n. When you say multiple sources, do you mean an array of source files for input? We could probably support that but would need to figure out how to cleanly handle destinations.\nE.g For inputs A and B, do we output A-critical.html, B-critical.html or overwrite A and B with the output HTML containing the inlined CSS? Maybe we could simplify what you need down a little..\n``` js\ncritical.generateInline({\n    // Your base directory\n    base: 'dist/',\n// HTML source\nsrc: ['index.html', 'about.html', 'contact.html'],\n\n// Your CSS Files (optional)\ncss: ['dist/styles/main.css'],\n\n// Viewport width\nwidth: 320,\n\n// Viewport height\nheight: 480,\n\n// Target for final HTML output\nhtmlTarget: '.',\n\n// Target for generated critical-path CSS (which we inline)\nstyleTarget: 'styles/main.css',\n\n// Minify critical-path CSS when inlining\nminify: true\n\n});\n``\n. @bezoerb Interested in your thoughts on whether we should support this. I imagine this gets tricky later on if we factor in stripping styles already inlined (critical CSS will differ per page).\n. Sorry for the delay! I'm fine with the wrapper method. Do you want to go ahead and adjust for support?\n. I think this is worth adding as an option. PerhapsremoveFromStylesheetscould adequately handle this and pass it throughcave`?\n. @bezoerb would this be best handled as part of inline-critical or critical?\n. Let's do it as part of inline-critical and work on smoothing out any integration work that needs to be done as part of Critical. SG?\n. sounds good :)\n. Looks like it's still planned, but hasn't quite been started yet :)\n. Let's do an npm version bump today :) It's been a while since we properly released (October)\n. Thanks for working on this (and tests!) @bezoerb!\nI think that inlineImages should be optional and set to false by default. The reason for this is that based on research around data-URI performance on mobile: http://www.mobify.com/blog/data-uris-are-slow-on-mobile/. Thoughts?\n. :+1: Thanks for this :) Also I've been meaning to ask - if you think you'll continue to be interested in helping out with the module (you've made a bunch of great contributions so far) I'd be happy to invite you to be a co-maintainer. Interested?\n. Whoops :) Let me take care of that now :)\n. Done. You're now a collaborator! For large changes I think it would still be useful for us to discuss in PR just to vet with the community but otherwise you should be able to commit directly to master now. Thanks for all your help once again!\n. @johanbuys could you try installing directly from master and see if you're able to get it working as expected? We may well need to update the gulp app tutorial. \n. Master should be working fine. We hope to get out a new release shortly.\n. @bezoerb It would be great to update our tests to account for any URL changes once we've figured out how to safely avoid accidental path translations. Are you able to verify this change in path occurs?\n. I wonder if this is something we could setup via Travis at all. I'll explore it, but good to hear tests are green post-fix.\n. ping @bezoerb re: question above.\n. Changes LGTM. Thanks for working on this @bezoerb! \n. Closed as dupe.\n. Hey @bezoerb. I like the review process for slightly larger changes like this. I promise I haven't forgotten about this PR :) Just need to find time to review. Will try to get to it before the end of the week. These should definitely land before the next release. \n. I've landed this :) I do think we should do more extensive testing before cutting the next tag including this work, but let's try to get a new release out in the coming week or two.\n. Are you using https://github.com/addyosmani/critical-path-css-demo? Can you run rm -rf node_modules && npm cache clean followed by npm install git://github.com/addyosmani/critical.git and let us know if you run into the same issue?\n@bezoerb I think some of our users are running into issues with the README/API changes introduced recently with the CLI updates. We might want to update https://github.com/addyosmani/critical-path-css-demo. I'll try to take a look this week.\n. @propertunist can you try https://github.com/addyosmani/critical-path-css-demo? (updated)\n. It's possible that there's something in the structure of your page that isn't correctly getting parsed in our pipeline or is causing a silent failure somewhere along the line. Is it possible to share a minimal version of your HTML and styles so we can take a look at what is causing breakage for you?\n. +1. If you can share as much information about your setup as possible that would go a great way towards helping us nail down if this is a config issue or a critical issue.\n. @bezoerb is this just me (tried from master) or do we need to revise the example? The cat version of this works fine.\n. Phew. Thanks for patching that. Good to know it wasn't just me :) I'll hold off on notifying users of a new CLI being available until we've had a chance to test this further.\n. I agree the current naming scheme could be confusing and we can do more to improve it :+1:  \nI personally don't mind us auto-selecting the correct task based on filetype but feel we're going to run into cases where .html/.htm aren't going to be sufficient signals. What should someone do if they're working against content with a different extension? \nLet's leave this open in case we get some more feedback from the community. The proposed solution may well work out.\n. All 29 tests are passing locally using 0.2.53. @bezoerb @sindresorhus if one of you can verify too, we should be good to update.\n. Correct me if I'm wrong: we're now clear on tests passing, but CLI exit codes are still giving us issues. This is otherwise good to go soon.\n@samccone Thanks for stepping in to help oversee some of the reviews. It's appreciated.\n. > @addyosmani would you mind adding the appveyor hooks mentioned in #45?\nThis should be enabled now. If we've missed anything at all, feel free to yell!\n. Thanks @sindresorhus! \n. Looks like this should be good to go once we've bumped grunt-critical. Local updating and linking seems to suggest this will address things for @superKalo. Thanks for being on top of this @bezoerb!\n. @bezoerb I think it's time for another release. Lets do this shortly. Sorry for being afk this past week! Catching up with threads now.\n. Do we need to bump inline-critical version used here too?\n. :+1:\n. @austinpray were you able to verify if the fix in master addresses the issue sufficiently? We'd love to close this if so.\n. Yay!\n. Thanks Sam. @sindresorhus in case you get to reviewing this before I do, some context: https://twitter.com/samccone/status/567410396135710720\n. Ah. Sorry we didn't catch this sooner. Hoping we can nail the exit code issue. Thanks for looking at the tests @bezoerb!\n. \\o/\n. Thanks for weighing in @pocketjoso. I'm personally in favour of bumping the dimensions up to a higher default. cc'ing @sindresorhus @bezoerb for their take before we make any changes here. \n. @bezoerb go for it!\n. Here's a list of our currently outdated deps:\ncli (package: ^0.6.5, latest: 0.6.6)\ncheerio (package: ^0.18.0, latest: 0.19.0)\nclean-css (package: ^2.2.4, latest: 3.1.9)\nimageinliner (package: ^0.2.2, latest: 0.2.3)\noust (package: ^0.2.0, latest: 0.2.3)\npenthouse (package: 0.3.0, latest: 0.3.1)\ntmp (package: 0.0.24, latest: 0.0.25)\ninline-critical (package: ^0.1.0, latest: 0.1.2)\nIs there anything else we shouldn't bump along with this?\n. LGTM. Thanks @bezoerb! :) \nWould you like to draft release notes about the deprecated options? I'm happy for you to cut a new release after this (or I can if you prefer). If there are any other repo privs you need to do this feel free to let me know.\nHappy Saturday!\n. > Should we also deprecate those options for generate and generateInline?\nI think so.\n. Reviewed. Thanks for working on this!\n. \ud83c\udfa9\ud83d\udc4f\n. @ivanjuras Are you using stable? (0.5.7) or master? As @bezoerb notes above, we'll need to know what version you're using in order to assist further.\n. :+1: \n. Whoops. Was looking at this yesterday and thought I had LGTMd. A late LGTM :) Thanks!\n. Changes initially LGTM. Waiting for the CI checks to complete.\n. Hmm. CI tests are green up to this change https://ci.appveyor.com/project/addyosmani/critical/build/80. Were you able to get the tests passing with your PR?\n. Due to the age of this PR, we're going to close it. If there's interest or need in re-exploring it please re-ping the thread.. Have you tried https://docs.npmjs.com/getting-started/fixing-npm-permissions?\n. I'm personally fine with the warning given this includes the CLI and we expect people to use it globally too. Happy to take @bezoerb's thoughts on this on board.\n. :+1: \n. Yep. Sorry I've been out of town for a few weeks but I'll take a look. Thanks for working on this :star: \n. Thanks for working on this! I'll take a look in the morning :)\n. The list of changes here on the whole LGTM. To avoid blocking any further work here lets land it.\n. Changed landed in https://github.com/addyosmani/critical/commit/36d2ff826e92fde4756e52dc118c13edc8a40ec6. We just need to make sure we update it now :)\n. > That seems legit to me, although I am still not really satisfied with the whole set of asset configuration params.\nI share similar concerns with the current set of config patterns.\n\nWe may need to find a way to simplify base, assetPaths, pathPrefix and domainPrefix in the future.\n\nI would be open to us doing this as part of a major version bump. I don't currently have a concrete vision for the pattern that would simplify them but am open to hearing suggestions.. I completely missed the pings on this. Sorry @bezoerb! My GitHub notifications are..out of hand:\n\nThis LGTM and I like the idea of using version. Let's land this one and close up #142.\n. @XhmikosR will do :)\n. This should be less of an issue now that https://github.com/addyosmani/critical/commit/6a2e12946ffa27325cb9a7f81b1c658eead8c32a has landed, right?\n. One nit. Thanks\n. Thanks for filing a bug. Hmm. I'm trying to think about the best layer to tackle this at. We could potentially do it in https://github.com/bezoerb/inline-critical (cc @bezoerb) allowing you to readjust paths accordingly. \n. @leogdion Thanks again for the PR. Could you rebase this against master?. Thanks for the PR!\n. I fully agree with us doing this for the next major version.. @schoenwaldnils Are you still running into this error? If so, is your repo for this project up somewhere?. We'll be cutting a new release today.. Per @bezoerb this should be better handled in master today. \n(btw, @bezoerb just fixed tests and pushed a patch release. Going to try going through the PR backlog shortly). Thanks for working on addressing the conflicts in https://github.com/addyosmani/critical/pull/224, @yesman82! . With https://github.com/addyosmani/critical/pull/178 and https://github.com/addyosmani/critical/pull/224 we're exposing the ability to allow passing full configs to penthouse or inline-critical. I believe this will address the need for custompageheader configuration as outlined in your PR.. To be honest, I'm still somewhat skeptical of the value of code coverage tooling that doesn't include some form of UI hit-testing. That said, even today tools like critical need to work around this by allowing authors to specify their dynamic styles separately or come up with a whitelist of dynamic styles that aren't going to be removed. I could see us using headless + coverage while still having to expose these workarounds for the end user.. @pocketjoso Wow. That's...pretty incredible :) Thanks for keeping an eye on the repo and for letting us know! That'll save a whole lot of time! We really appreciate you working on that migration \ud83c\udf89 \ud83c\udf70 . > I will release Penthouse 1.0 this week (using chrome headless via Puppeteer); I've just been writing up a release blog post, and waiting for the Puppeteer team to close a few important bugs.\n\\o/ This is amazing work, @pocketjoso. I can't thank you enough for the tireless work in getting Penthouse updated to use headless Chrome. I sit across from the Puppeteer team and if you find yourself blocked on anything at all, please feel free to ping and I'll have a chat with them.  \n\n1.0 will be backwards compatible (except for that Puppeteer requires Node>=6.4.0), so this means you can upgrade without changing a thing! (the reason for the major version bump is more to mark Penthouse as stable tech).\n\nI had been very curious to what extent backward compat would be maintained, but this sounds great.\n\n@phaistonian When I test the same in my local, two tests are failing for me. Here is the error log.\n\nSame here. This appears to occur during sequential invocations rather than running in parallel. \n\nAs I've said before you can test this version on penthouse@next, but at this stage I've run it in production for more than a week and generated over 100,000 critical css files - it's definitely in better shape in every way than the previous version of penthouse.\n\nThis is a good confidence booster. I believe @reznord is interested in working on @next support for critical and might put together a PR for us to switch over as a next step.\n\noptional; perhaps not relevant for you - Penthouse 1.0 supports generating before/after screenshots (with/without critical css - in both cases the page rendered without JS), these can be used to increase confidence that the critical css is correct.\n\nWhoa whoa whoa. That's actually very interesting. A part of my workflow when using critical has always been to do the comparison of the before and after. I'd been wondering if it made sense for a mode that would generate before/after screenshots and do an image diff or visual similarity diff (using SSIM) to inform the user whether the output was 100% as expected. Your work here sounds like it would provide at least the first part of this and I'd love to make sure our readme reflects how to use it with critical via Penthouse.. Thanks for any time spent digging into the AppVeyor test failures, @bezoerb. Appreciate it! . That sounds reasonable.\n. Can you reset this? oust 0.3.0 is now out with the PR you submitted.\n. Can we drop the nvmrc?\n. friendly ping on this @leogdion \n. ",
    "sindresorhus": "lgtm\n. Reference on how to implement a simple CLI: https://github.com/sindresorhus/trash/blob/master/cli.js\n. You might want to try meow if you want to minimize boilerplate ;)\n. I would normally say overkill, but since it's a generated source that is meant to optimize rendering times I think it's ok in this case. Though I would make minification true by default.\n. @XhmikosR run the test from master now and paste in the output ;)\nAlso look at the terminal output from installing dependencies. The phantomjs install might have failed.\n. > `var lineBreak = process.platform == 'win32' ? /\\r\\n/g\n\n: /\\n/g;` would work too.\n\nYou want require('os').EOL.\n. Can you explain the use-case of the 'cssPath' option?\n. Can you also document these?\n. The option, here: https://github.com/addyosmani/critical#options\n. https://github.com/addyosmani/critical/releases/tag/v0.5.2\n. @addyosmani Yup https://github.com/addyosmani/critical/releases/tag/v0.5.3\n. @bezoerb Did you return the stream? That's how gulp know when it's done.\n. @bezoerb You need to fix the merge conflict.\n. It should be generated in an os.tmpdir() folder instead so it's not littering up the project folder. Maybe using: https://github.com/sindresorhus/tempfile\n. https://github.com/addyosmani/critical/releases/tag/v0.5.4\n. :+1: Lgtm.\n. :+1: \n. Sure\n. Only cheerio, clean-css, tmp needs updating though. The other ones semver match latest.\n. /* eslint-disable xo/no-process-exit */\n. @addyosmani You should use Apache-2.0 instead of Apache2 in package.json's as the former is a valid SPDX license identifier\n. why?\n. open an issue rather than putting in a todo\n. don't throw in async code\n. use async version\n. space\n. separate var statements\n. space\n. space\n. not the change i was talking about.\n. That's really up to @addyosmani, but if you got more than a few nested function it does make sense.\nI would use https://github.com/petkaantonov/bluebird\n. space after \"opts.cssPath,\"\n. When doing pull requests it's nice to use the existing code style ;)\n. You could DRY this up a bit by using a module like https://github.com/sindresorhus/temp-write FWIW :)\n. You shouldn't throw in async. Return the error.\n. encoding is moot here\n. i think the dot here is moot\n. oh, nvm.\n. Don't hard-wrap\n. CSS\n. single-quotes\n. The column separators should be aligned with the others.\n. This is not a good way to specify it. It forces all files to be normalized, even binary. It also makes the line above it moot.\nInstead, specify explicitly the file types to LF normalize.\n. But if someone adds a JPG and it becomes corrupted.\n. Meow v4 has breaking changes. You need to adapt to those: https://github.com/sindresorhus/meow/releases/tag/v4.0.0 (Note how specifying minimist options changed). This needs to be changed: https://github.com/addyosmani/critical/blob/2f332dc8986e31b820b33f2e2cd98b4816b3d81a/cli.js#L43-L57. ",
    "JimmyRittenborg": ":+1: \n. ",
    "bezoerb": "CLI already available\n. All green now on windows even though the newlines had to be fixed in inline-critical\n. Tests still green on windows. Closing this for now.\n. Remote access is available in master.\nSee #94 for details.\nAnyone else willing to test this?\n. Closing this as the requested feature is released in v0.7.0\n. @sindresorhus thanks for the feedback.\nI'll give it another try. \ncssPath use-case\nI was trying out this plugin in a grunt build step where my css files were in a different folder than base+ hrefs[0]. As i think about it this option is useless as the use-case can also be handled by specifying the file(s) directly through the css option in a more robust manner. So this option can be dropped\n. @sindresorhus Can you also document these? which ones?\n. @sindresorhus @addyosmani \nWhat do you think? This PR also fixes #23 \nThe two failing tests are broken because there's now a different output when taking in all stylesheets.\nWhen commenting out the second stylesheet in fixtures/index.html all tests pass.\nI'll try to fix them later this day\n. green ;)\n. I think this one can be closed. \nFixed by #22 \n. This should be fixed by now. Feel free to re-open if there are still issues we did not consider yet.\n. For the first problem i would consider generating the critical-path css and inline it above the first link tag rather than adding a link tag to the critical css and inline this one later. So it's secured that the right styles get inlined. The inline method should also wrap the existing link tags with noscript and add a js block at the end of the body tag to load the stylesheets async.\nWhat do you think? Do you need the inline functionality as exists for your assumed workflow? In this case i would implement an additional inlineSource method besides the existing one.\nI started working on a stylediff module yesterday: stylediff which looks quite promising at the moment. It's non destructive so that it's removing to less styles rather than removing to much. I'll open another PR when this one is stable. \n. I've added a PR for the first Problem here: #29\n. First i think limiting the file size is very useful. Otherwise the generated css could blow up in size when there is for example a 500k background image referenced inside the css. When there's a hint inside the readme about the recommended max size it should be ok to let users overwrite the default setting for this.\nCurrently i'm more unclear about the inline method itself and if should rather take the generated css as an argument to provide the functionality used inside the callback in generateInline to inline the css. \n. @micahblu @addyosmani I think Image inlining as well as rebaseRelativePaths should move to generate function. Here's the only place where we got the original stylesheet path for each file.\n. @addyosmani thanks for the talk ;)\n. @addyosmani \nThis PR made some modifications for the generateInline task.\nI'll hope it fits for your workflow\n. @addyosmani ping\nWhat do you think?\n. squashed\n. sorry for this one, just found out that this one is not working as expected...\nI'll send another PR to fix the issues\n. you've got an encoded \" at the end of all links in the release notes which makes all links fail ;)\n. @addyosmani Looks good. Also testet locally and works like expected.\n. There was a race condition when running multiple tasks in parallel because there was only one temporary file where all the style rules were applied to. \nShould be fixed with the PR\n. @addyosmani there is still a minor issue with the test for this fix. Because both calls use the same files there can also be a short amount of time when they overlap and the tests fail. I'll do another PR with a more robust testcase after i get some sleep ;)\n. @sindresorhus i like https://github.com/sindresorhus/temp-write but unfortunately the use of the created tempfile in penthouse screw up phanromjs. But i took the uuid module out of it for filename creation. That's much smarter. Thanks for the hint ;)\n. @addyosmani i've thought about the tricky part already (see https://github.com/bezoerb/inline-critical/issues/1). It doesn't matter if we support multiple sources or not. We need an appropriate way to handle this as soon as we're stripping of the injected styles. If not this feature will only be available to one pagers. \nFor handling multiple sources we might need to add some simplified pattern like the ones used in gruntjs.\n{cwd: 'src', src: ['**/*.html'], dest: 'dest/b1/'}\n{src: ['src/bb1.html', 'src/bbb1.html'], dest: 'dest/b1/'}\n{src: ['src/bb1.html', 'src/bbb1.html'], dest: ['dest/bb1.html', 'dest/bbb1.html']}\nOr we could also implement some sort of a streamable wrapper method for use with gulp \n. I would prefer the wrapper method. I think the file handling stuff is best done by the used task runner e.g. gulp or grunt or ...\n. @justinmusgrove the mentioned feature of htmlmin is part of grunt not part of htmlmin itself.\nFor the use with grunt you can use grunt-critical wich uses critical under the hood.\n@addyosmani what do you think? gulp wrapper method or globbing pattern\n. @addyosmani ping\n. I'm quite busy at the moment but this will be the next issue as soon as i've some time left to work on this.\n. https://github.com/addyosmani/critical#gulp\n. @addyosmani i would say that removing the inlined rules belongs to inline-critical. In this case we need to update the inline method though. \n. What's SG? ;)\n. I should have figured that one out,... \nYes, sounds good! :)\n. @addyosmani feature is still in master. Waiting for npm version bump\n. Hey @pocketjoso, \nwe're removing the critical css per page so i'll consider this to be safe. You can lookup  https://github.com/bezoerb/inline-critical/issues/1 for some implementation details. \nYou should get cache hits as soon as you're refreshing the same page but i agree that extracting the critical css doesn't make much sense when you're serving a site with different critical css on each page. \n. > What site does not have different critical css on each page?\nJust take any of the one page sites flying around\n. the extract option is disabled by default. We're only providing the functionality to users if it's needed.\n. We should mention the caching issue with this option in the readme.\n. f2428a480154fce93af504009e1f4eb5016262e0\n. Closing this as the imageinliner can already be turned off. \nSee: https://github.com/addyosmani/critical/blob/master/test/02-generate.js#L126\n. Awesome research. After reading i totally agree in changing the default value to false. I'll update the PR soon\n. Changed the default behavior so images won't get inlined by default.\nReady to go ;)\n. @justsee formatting is set to four spaces in .editorconfig. Can you please post your options where minification occurs with minify set to false. The module works as expected in all tests.\n. Currently there is no support for remote stylesheets in critical. Unfortunately the script is also missing a check to test if the linked stylesheet is remote or not. Therefore it's crashing when trying to read the file.\nI would also suggest to keep font loading out of the critical path and use an asynchronous loading approach instead. \n. @sondr3 should be fixed now\n. Shure! I'm happy to help out :)\n. @addyosmani no invitation yet ;)\n. @addyosmani totally agree in discussing larger changes in a PR. \nBy the way, what about https://github.com/addyosmani/critical/issues/38? ;)\n. @micahblu tried this configuration on a osx and everything works just as expected. Can you provide some more infos on the thrown err? \nYou can add a callback function to see whats causing the error like this:\njavascript\ncritical.generateInline({\n        base: 'dist/',\n        src: 'about.html',\n        cssPath: 'stylesheets/',\n        styleTarget: 'stylesheets/critical.css',\n        htmlTarget: 'about.html',\n        width: 320,\n        height: 480,\n        minify: true,\n        maxInlineImageSize: 10240\n },function(err){ if (err) {console.log(err);}});\n. Could you try again using the master branch after tracing the issue?\n. @johanbuys did you install from npm or did you use the master branch from Github?\nWhat's the output? \n. @djmadeira @tchaecker can you try installing the cli branch\nnpm install git://github.com/addyosmani/critical.git#cli there's another change in there which addresses this problem.\n. This looks lika an weird issue with npm. Which npm version are you using?\nI got the same error on installation with 1.3.11on windows.\nAfter upgrading with the official installer from http://nodejs.org/ to version 1.4.28 everything works as expected.\n. @addyosmani any ideas? \n. Ok, seems like some cache issue after renaming a file. I've duplicated the branch and this seems to work. Try npm install git://github.com/addyosmani/critical.git#cli-test\n. @tchaecker damn, we were talking about different issues. i should have read the complete error message ;) thanks @alfredbez \n. @tchaecker does the cli branch fix the toString error for you?\n. try installing with --save-dev option.\nnpm install --save-dev git://github.com/addyosmani/critical.git#cli-test\n. maybe you could post a link to a gist which holds your gulpfile\n. @tchaecker sorry, this was my fault. i forgot adding the main file in package.json after restructuring the project files.\nI just updated the branch. Could you please try again?\n. no, width and height defaults to 320/480 but these values should be set based on your page/layout\n. You'll need to call critical.generateInline for each html file you want to process. \nSupport for multiple files is planed. See #38 \n. @solenoo this can be achieved by passing the option styleTarget to critical.generateInline\nSee: https://github.com/addyosmani/critical#generate-and-inline-critical-path-css\n. npm install http://github.com/addyosmani/critical/tarball/master\n. Yes, please open up a new issue if the error isn't already covered in this thread.\n. Closing as this should be fixed by now. \nFeel free to re-open if there's still something we didn't consider yet.\n. Fixed the issue using slash\n@addyosmani any chance for running automated tests on windows machines?\n. btw, all unit tests were green on my windows 7 vm after adding the fix.\n. @addyosmani @r-flash sorry for the delay.\npath.sep internally depends on process.platform so it makes no difference.\nSee https://github.com/joyent/node/blob/master/lib/path.js#L23\n. @addyosmani I've just configured appveyor to run tests on windows but it looks like they don't start automatically. I think you need to add the following webhook for push and on pull request to critical:\nhttps://ci.appveyor.com/api/github/webhook?id=cn6jw7r3ur0gmyg6\n. @addyosmani added you as admin to the appveyor project\n. this issue duplicates #19\n. Hey @addyosmani,\njust wanna know if you're fine with this whole review process or if you would prefer that i merge in the changes myself once all the tests pass? Just don't want to spam your mailbox or waste your time ;)\n. @addyosmani pingping ;)\n. Definitely agree with that. \n. i updated the package.json to address this issue.\nCan you please try again?\n. you should not use sudo npm install to install local packages.\n. Tested against master\n- downloaded homepage from www.ureka.org as a complete file\n- put inlined styles in separate css files \n- run cat index.html | node ~/GitHub/critical/cli.js -im > test.html\nEverthing went fine except that i was asked if phantomjs is allowed to access https://assets.swarmcdn.com``\n. Did you specifiy the correct base path?\nIf that does not fix your issue it might be helpful to give a little more context by posting your critical config here\n. hey @solenoo, \nsorry for the late response.\nThe output you are getting from critical seems correct for your configuration.\nWe're rewriting assets paths to be absolute to your base directory.base: 'public/'and an image path like/public/components/minified/img/someImage.jpgshould result in/components/minified/img/someImage.jpgwhich should be fine assuming your docroot is pointing to thepublic/folder. \n. @solenoo Any progresses on this subject?\nThanks in advance.\n. wow,... that root url is really weird ;) I'm not quite sure i got this right.\nSo your docroot is more like a symlink to a real folder on your server but without a symlink. So you got no folder like/Appwhich we could use to compute the asset path.\nI'm not quite sure but i think there was a good reason to make this path absolute. I'll think this over again and maybe there's a chance to compute relative paths. Otherwise we could provide some option to configure a path prefix.\n@addyosmani any thoughts?\n. I think apathPrefixoption would be the most robust solution to this issue. \n. I would go for the first one as using a path relative to baseDir will fail as soon as you are serving document from e.g./App/Controller/some.html.\n. Nope, this wasn't just you. \nThis should be fixed now. Working fine for me with the fix provided in https://github.com/addyosmani/critical/commit/dc0d98ebbaa1949548a9cc473bc287b59d341e28 but we should add some cli tests, too. \n. @addyosmani can you confirm this one is fixed? So we could close this issue?\n. Fixed\n. What about addinginlineas an option forgenerate, deprecategenerateInlineand leave only thedestoption.\nSo we would only expose thegeneratemethod and do inlining when theinlineoption is set.\n. Started another [branch](https://github.com/addyosmani/critical/tree/deprecated) \nThis one is currently blocked by https://github.com/pocketjoso/penthouse/issues/53\nSee: https://travis-ci.org/addyosmani/critical/jobs/59405654\n. merged in master, so this could be closed\n. Take a Look here https://github.com/bezoerb/grunt-critical/issues/5\n. @biokillos sorry for the late response. I've just released a new [inline-critical](https://github.com/bezoerb/inline-critical) version which enables you to either pass in an selector for thebeforeelement or just skiploadCSSby ignoring alllinktags.linktags inside ofnoscriptwill be ignored by default so in case you're using loadCSS already and there are no link tags left it should just be fine. The options won't be passed throughcriticalyet so you'll have to generate the critical css first and inline it viainline-criticalin the next step. \nHope this helps\n. @cleberdantas this one still needs some work to make it ready for shipping. \nSee comments above and https://github.com/addyosmani/critical/issues/19#issuecomment-49987848 \n. Created an issue atpenthouse`\nhttps://github.com/pocketjoso/penthouse/issues/37\n. hey @addyosmani,\ni think we need a version bump to get critical back running. \n. Thanks\n. I'll try this evening\n. @addyosmani All tests are passing on Windows & OSX. Tests for grunt-critical passing, too.\n. @lkdnvc The image paths in the critical css are currently rewritten to absolute urls so you should configure your base option to reflect your server docroot.\nE.g. asuming your local dev directory structure to be something like this:\nshell\n/var/www/somedomain.com/\n                     \u251c\u2500\u2500 package.json\n                     \u251c\u2500\u2500 node_modules/...\n                     \u251c\u2500\u2500 ...\n                     \u2514\u2500\u2500 dist/\n                           \u2514\u2500\u2500 sometext/\n                                 \u2514\u2500\u2500 my-site/\nyour base option should be set to dist\nbase: 'dist/'\n. @lkdnvc Any progresses on this subject?\nThanks in advance.\n. @juanbrujo as we don't know the path to the HTML file relative to the document root there's no robust solution for computing the asset path relative to the HTML right now but you can configure a relative path prefix to achieve this when you use the current master of critical. \nSee https://github.com/addyosmani/critical#options \n. @juanbrujo we made some progress on this topic. The asset paths inside the critical css should now stay relative in case they were relative in the original css. Could you check the vinyl branch if this fixes your issue?\nnpm install --save-dev git+https://github.com/addyosmani/critical.git#vinyl\n. @juanbrujo good point. Thanks for the detailed explanation :) Currently the src file is resolved relative to base and the dest file gets written relative to process.cwd which somehow doesn't make sense as the relative asset paths are computed relative to src. I think this needs a bit more concept ;)\n. @juanbrujo sorry for the late response. This should be fixed by now. dest path is now computed relative to base directory. \nI'm closing this for now. Feel free to reopen if there's anything we missed to fix.. Until now there is no way to ignore specific selectors but you can specify which css files to use. \nAs a workaround you could define the font in a separate css file and concat this after you applied critical.\n. I've just released filter-css. A small module to filter out css rules.\nWe could add an ignore option to critical and use filter-css to remove the ignored rules from the critical css.\n. @oliverfarrell wanna give it a try?\n. Seems to work ;)\n88\n. I would prefer some review by any gulp pro in here before merging.\n/cc @sindresorhus? ;)\n. Hey @alanontheweb,\nthanks for testing :) \n1) The wrong file extension should be fixed with my last commit. I've added some more tests to cover this behavior. \n2) Just tried this with Web-Starter-Kit and everything seems to work as expected. Only the \"below the fold\" content is rendered without css after removing the loadCSS block. Can you provide some more infos on this?\n. Hey @alanontheweb,\ni pushed my last commit just before writing the comment.\nhttps://github.com/addyosmani/critical/pull/59/files#diff-c4506f1d6ae9e2220d7195c3c555d8b5R316\ni think you'll have to redownload the source ;)\n. Hey @alanontheweb \nspecifying the stylesheet in the css option only affects the css files used to create the critical path css.\nCurrently there's no option to also ignore specific styles from async loading. Note that all stylesheets which are rendered to the noscript block are also loaded async with loadCSS. \nNow the second issue. I don't see the problem yet why you can't use absolute paths, sorry.\nI tried a similar scenario with the resources from wsk again. \n1. Adding some nested folders e.g. app/test/another-test/ \n2. Put styleguide.html inside \n3. Point stylesheets to absolute path /styles/components.css\n4. run gulp to build dist html\n5 run gulp criticalwith the following configuration\njavascript\ngulp.task('critical', function () {\n    gulp.src('dist/**/*.html')\n        .pipe(critical({base: 'dist/',css: ['dist/styles/components.css','dist/styles/main.css']}))\n        .pipe(gulp.dest('dist'));\n});\nNavigating to localhost:3000/test/another-test/styleguide.html afterwards causes my external stylesheet to be loaded asynchronously from /styles/components.css \nThe whole page looks as expected.\n. hey @alanontheweb,\nThe entire stylesheet with duplicates get loaded when you disable the extract option but you can rely on browser cache if you don't load a different stylesheet for every page. See #39.\nI think it makes sense to open a new ticket for the errors with extract:true\n. Any review updates here?\n/cc @addyosmani @sindresorhus \n. I got some unsatisfying behaviour when running the gulp task\n``` bash\n\u276f gulp critical\n[00:06:40] Using gulpfile ~/Sites/web-starter-kit/gulpfile.js\n[00:06:40] Starting 'critical'...\n[00:06:40] Finished 'critical' after 7.11 ms\n~/Sites/web-starter-kit  14s\n```\nCan anyone tell me why gulp assumes the task has finished after 7.11ms and it actually took 14s?\nWhere is the problem here and how can we fix it?\n. @sindresorhus I thought so. See https://github.com/addyosmani/critical/pull/59/files#diff-c4506f1d6ae9e2220d7195c3c555d8b5R295\nBut maybe i got something wrong. I've not completely understood the whole stream thing yet ;)\n. @sindresorhus thanks!\n. @sindresorhus merge conflicts fixed locally but my tests are failing (so does travis do on master) \nWe need to fix cli tests and add the missing file for the multidimensional css test (fixture/test-adaptive-final.css - fixture/test- is ignored\nI'll go for the CLI changes (or do you want? ;)) \n@samccone could you rename your css file and add it?\nWhen my local npm test is green i'll push & rebase\n. @samccone yep, that' really odd. Npm shouldn't exit with code 0 on errors. Thanks\n. @samccone tests are working as expected now. I skipped your test until we can add your test files. \n/cc @addyosmani @sindresorhus \n. this is just a few seconds ahead ^^\n. @addyosmani you're right. I already got a fix for the exit codes and i'm currently trying to write a testcase for it\n. @micahblu you need to adjust your require statement var critical = require('critical').stream;\nSee: https://github.com/addyosmani/critical/tree/critical-gulp-stream#gulp\n. This one is not merged yet. Are you shure you are using the critical-gulp-stream branch?\nnpm install --save-dev git://github.com/addyosmani/critical#critical-gulp-stream \n. Played around with this branch a bit and everything seems to work just as expected.\nFrom my perspective this could be merged for the next release\nJust need to fix some windows stream tests.\n@addyosmani would you mind adding the appveyor hooks mentioned in #45?\n. Try to install master from npm npm install git+https://github.com/addyosmani/critical.git as this feature hasn't been shipped yet.\n. i'm working on a pull request\n. unfortunately we only can use tempfile for the temporary generated stylesheets.\nCritical also creates temporary html files when the html option is used instead of src.\nThese files need to be inside the base directory.\n@KingScooty could you try the PR branch and see if this fixes your issue?\n. @alanontheweb just added a fix to inline-critical. Want to give it another try?\n. @alanontheweb any updates here?\n. Closing this due to lack of feedback. Feel free to reopen if the problem still exists. This looks like an issue with cheerio.\nSee https://github.com/cheeriojs/cheerio/issues/521\nI'll check if there is a workaround for this\n\nAm 05.02.2015 um 18:43 schrieb Kaloyan Kosev notifications@github.com:\nHello all,\nI am having an interesting issue in my latest project. When I trigger Critical to inject the critical styles in my html (dest: '_site/index.html') it breaks my SVG logo image.\nHere is the image before:\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nAnd here is the image after:\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nNotice how by the end of each in the input we have a self closing tag \"/>\". However in the output the self closing tag is transformed to just \">\", without the \"/\" and unfortunately the SVG is messed up :(\nCan somebody help me?\nThanks in advance,\nKalo.\n\u2014\nReply to this email directly or view it on GitHub.\n. @superKalo the SVG issue should be fixed in master. Wanna give it another try?\n. @addyosmani we need to bump critical first to bump the dependency in grunt-critical\n. @samccone yep, critical and grunt-critical are both patched. :)\n. @diagramatics which part of the svg is broken? \nIt seems that there's still an issue in cheeriojs. See https://github.com/cheeriojs/cheerio/issues/521\n. just bumped inline-critical\n. I thought patch versions would be loaded automatically but it seemed that this wasn't the case for the cheerio patch so i've just bumped & fixed the versions in inline-critical\nI'll try later today and give you a hint.\n. @addyosmani looks good. No need for a version bump.\n. I will check this weekend. maybe relates to https://github.com/bezoerb/grunt-critical/issues/53. Currently this looks like another issue in inline-critical or cheerio.\nIn my tests everything works fine if i remove the <title>Title</title> tag.\nAs soon as there's a <title> inside the svg things get messy.\n\nI'll investigate further to see if this can be fixed in inline-critical or if we have to file a bug over at cheerio/htmlparser2. Opened a PR over at htmlparser2: https://github.com/fb55/htmlparser2/pull/259. I also pushed a temporary fix to inline-critical so SVGs should be fine from now on.\n@catalinred: Would you mind checking again with critical@next?. @catalinred: can you provide a test case for this or share the files/config to reproduce the issue? This would massively speed up the fix :). @catalinred: i've updated inline-critical which is used internally to inline the critical css.\nIt now uses jsdom instead of cheerio for DOM manipulation and the parsing is limited to the document head.\nThe document body should remain unchanged besides the <noscript> blocks which are added to the end of the document.\nSo maybe a fresh installation of critical@next (v2.0.0-10) could resolve your problem. @catalinred: i think i managed to get rid of the memory error :)\nWould you mind trying again? (Critical should be in version v2.0.0-12). Yay \ud83d\ude01 . This issue should be fixed now fixed in master\n. LGTM,\nthanks!\n. :+1: \n. Thanks, I'll take a look at it\n. Should not be closed by comment\n. Exit codes should be fixed with c469c030524b0e3b16164279940d41a12bf450cd\n/cc @addyosmani @samccone \n. Thanks\n. I'm fine with higher defaults :+1: \n. @addyosmani wanna merge that in? I would like to tidy up our test mess a bit after this one's closed.\n. here we go ;)\nchanged the folder structure a bit:\n``` bash\ntest\n\u251c\u2500\u2500 01-module.js\n\u251c\u2500\u2500 02-generate.js\n\u251c\u2500\u2500 03-inline.js\n\u251c\u2500\u2500 04-generateInline.js\n\u251c\u2500\u2500 05-cli.js\n\u251c\u2500\u2500 expected\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generate-adaptive.css\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generate-default.css\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generate-image-big.css\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generate-image-skip.css\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generate-image.css\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generateInline-external-extract.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generateInline-external.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generateInline-extract.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generateInline-minified.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generateInline-svg.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generateInline.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 inline-image.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 inline-minified.html\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 inline.html\n\u251c\u2500\u2500 fixtures\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generate-default.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generate-adaptive.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generate-image.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generate-default-nostyle.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generateInline.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generateInline-external.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 generateInline-svg.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 inline.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 inline-image.html\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 images\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 styles\n\u2514\u2500\u2500 helper\n    \u2514\u2500\u2500 testhelper.js\n``\n. as well as adding some more assertions in [testhelper.js](https://github.com/addyosmani/critical/blob/TidyTests/test/helper/testhelper.js#L26)\n. @alanburke The [loadcss](https://github.com/filamentgroup/loadCSS) function should be placed in theheadfor performance reasons.\n. Should be fixed by now as we're on penthouse 0.10.9\nFeel free to reopen if there are still problems on this topic.. Done.\n. thanks sindre, although it's too late (1dd89b63292e88967bc7e86080ab2d6d6705ff28) ;)\nI would complete appveyor integration for tests on windows later this day and then we should be fine for a new patch version.\n. https://github.com/addyosmani/critical/releases/tag/v0.5.7\n. Would still need some description in the Readme\n. LGTM\n. :+1: \nWould you mind adding a testcase for the new behavior?\n. Thanks @cormacmccarthy \n. @addyosmani ping ;)\n. @addyosmani i'm happy to draft some release notes. Should we also deprecate those options forgenerateandgenerateInline? See #53 for further notes\n. @addyosmani https://github.com/addyosmani/critical/releases/edit/untagged-ab71c0f6c25d652214bd\nI think a can make a release on GitHub but i'm missing the required permissions to publish a new version on npm.\n.cheerioconverts special characters to unicode. We usecheerioto inline the critical path css. \n. Fixed entity encoding in [inline-critical`](https://github.com/bezoerb/inline-critical/commit/91f0c24d1714849cd69d3dc3e776ad182a61b3cf)\nThanks @yethee \n. Added an issue for this in inline-critical\n. Waiting for https://github.com/fb55/htmlparser2/pull/129 to be merged\n. @tbredin it looks like this should be fixed now. Want to give it another try?\n. Tests are green so i'm closing this one. Please feel free to re-open it if the error still occurs\n. looking forward to get some feedback ;)\n. Filtering values is not supported yet by filter-css.\nI planed to support this but I'm not quite sure about the syntax yet\n. @rupl Added declaration matching. Wanna give it another try?\n. @rupl ping ;)\n. @rupl it seems the interface of filter-css isn't optimal yet ;)\nYou could have achieved this with the following:\njs\nignore: {\n  declarations: [/background-image/, /src/],\n  types: ['@font-face']\n}\nMaybe you would like to help me making it better?\nhttps://github.com/bezoerb/filter-css/issues/1\n. @rupl thanks for the support :)\n. @addyosmani what do you think about the dropped possibility to generate html and css in one run. Are you fine with that?\n. @addyosmani ping ;)\n. @addyosmani so i guess you are fine with the changes ;)\n. \\o/ \n. @approached tmp folder cleanup should be handled by the os.\n. @approached your problem should be fixed in master\n. This is not yet published on npm. You'll need to use the master branch for .stream.\n. @nbrustein what's the benefit of not inlining all?\n. @nbrustein some thoughts on this PR:\ninline-styles is only used by the inline method which will be marked deprecated in the next release as the related workflow feels kind of sluggish. \nThe suggested workflow for critical is one of the following:\na) Let critical generate and inline the critical-path css for you\nb) Let criticaljust generate the critical path css and do the inlining yourself (you could use inline-critical for that). \nDoes one of those workflows is suitable for your use case (except for the whitelist part ;)) or do we need to take something else into consideration?\nThere's an ignore option available in inline-critical which hasn't landed in critical yet but looks like it fits your needs.\nAnd after we need tests covering your changes. Without a test case this PR won't be merged\n. Critical already adds a noscript async fallback for the existing stylesheets when inlining the critical path css with inline-critical so you shouldn't need to implement this on your own. \n. @brianmontana just updated inline-critical to ignore link tags which are already wrapped by noscript. Do you want to check if this solves your problem?\nBtw, what is your workflow with critical? It looks like you are using the inline method which is marked as deprecated. (See https://github.com/addyosmani/critical/blob/master/index.js#L101)\n. @ivanjuras looks like you're trying to use the stream method. This one isn't shipped yet and therefore only available in the master branch of critical . Are you sure you've got the right version?\n. Try with master npm install git+https://github.com/addyosmani/critical.git\nstream isn't available in the stable version (0.5.7) yet.\n. @johjacb do you also got this bit?\nvar critical = require('critical').stream;\n. Try to install master from npm npm install git+https://github.com/addyosmani/critical.git as this feature hasn't been shipped yet.\nIf this doesn't work out for you it would be helpful if you could provide your critical config and the part of your css which should be ignored \n. ^^\nThanks for using critical \n. Try to install master from npm npm install git+https://github.com/addyosmani/critical.git as this version hasn't been shipped yet. \nThe docs for the latest version on npm an be found here\nwhen using master you can simply write your gulp task like this:\n``` javascript\nvar critical = require('critical').stream;\ngulp.task('critical', function () {\n    return gulp.src('index.html')\n        .pipe(critical({base: './', inline: true, width: 320, height: 480, minify: true}))\n        .pipe(gulp.dest('dist'));\n});\n``\n. @raphaelgoetter we finally released critical 0.6.0\nWant to give it another try?rm -Rf node_modules/critical && npm install critical. See: https://github.com/filamentgroup/loadCSS#usage\n. @jonorherrington currently it's not possible to use critical with an url but i'm sure we could add this feature in one of the next releases. See #19. \nUsing a bunch of partials also isn't possible as we need the full html page to compute the critical path css. How should we detect the above-the-fold content if we just have some partials and don't know how they will be sticked together?\n. @jonorherrington remote resources are now supported inmaster. \nWant to give it a try to see if it fits your needs?\n. handling PHP is a bit out of scope for this project but you could use [php2html](https://github.com/bezoerb/php2html) to create the html files in the first place\n. @pocketjoso thanks :+1: \n. @raphaelgoetter wanna try using a clean install of critical?rm -Rf node_modules/critical && npm install --save-dev critical. thanks again @pocketjoso \n. Any updates on this one? I guess this should be fixed by now, right?\n/cc @pocketjoso, @raphaelgoetter . closing this due to inactivity. Seems fixed after all ;). I think this might be an issue in [penthouse](https://github.com/pocketjoso/penthouse)\n@pocketjoso any thoughts on this?\n. @pocketjoso any updates on Penthouse's side?\n. Just updated to penthouse 0.7.0\nSeems to work just as expected.\nThanks @pocketjoso \n. @jmartsch i'm sure we could add this feature in one of the next releases. See #19 and #90.\nUntil then you could use [inline-critical](https://github.com/bezoerb/inline-critical) for inlining.\n. @jmartsch just got another thought on your issue. Even with critical supporting urls i think it wouldn't be possible to inline the results to yourheader-critical.php` as the inlining only works with html.\nWhen using php it's easy to inline the generated critical css yourself by just using something linke this:\nhtml\n<style><?php include 'critical.css'; ?></style>\n<script>\n   function loadCSS(a, b, c) { \u2026 }\n   loadCSS('mystylesheet.css');\n</script>\n<noscript>\n   ...\n</noscript>\n. @jmartsch remote resources are now possible when you are using the master branch.\nWant to give it a try?\n. @jmartsch for simple use cases it should just work when you use an url for the src parameter.\nWhen you want to inline images, too you should also configure assetPaths\nuse npm install --save-dev git+https://github.com/addyosmani/critical.git\n. you can also try the cli with some urls:\ne.g.\nnode_modules/.bin/critical http://2015.jsconf.eu/ -m\n. No, sorry. Hope to have some free time in the next days to work on this.\n. @jmartsch i guess you missed the base option ;)\nI added some default value as this is mostly relevant for image inlining and the extract option and has no real impact when neither of these are used.\nYou don't need inline:false as this is the default value.\nWant to try again?\n. That's weird. \nI tried to reproduce your error:\nrm -Rf node_modules/critical && npm install --save-dev git+https://github.com/addyosmani/critical.git\njavascript\ngulp.task('critical', function() {\n    return critical.generate({\n        src: 'http://www.heise.de',\n        dest: '.tmp/critical.css',\n        minify: true\n    });\n});\nbash\n\u276f gulp critical\n[00:06:56] Using gulpfile ~/test/gulpfile.js\n[00:06:56] Starting 'critical'...\n[00:07:02] Finished 'critical' after 6.6 s\nand got some critical css from heise.de\ncss\n.heisetopnavi #heisetopnavi_sub_container ...\n. @jmartsch the issue is reproducible on windows. I've fixed this for external urls in master but the gulp still hangs when using local files. \n. @jmartsch this should be solved in master by now\n. @jmartsch i'm investigating this at the moment. \nLooks like something's holding back the process.exit\nshell\n[23:12:15] Finished 'critical' after 3.43 s\n  critical:gc exit triggered +27s\n  critical:gc cleanup triggered +1ms\n  critical:gc cleanup done +1ms\n. so i guess the time lag results from an uncleared timeout in penthouse\nWhen i manually patch penthouse to clear the timeout after phantomjs is done the 20-30s lag is gone\n. https://github.com/pocketjoso/penthouse/pull/98\n. Pull request accepted & penthouse bumped.\nThe delay is gone :)\n. @julienetie could you provide some more information about your setup? \n. @julienetie i've made some tests but i couldn't reproduce your issue.\nThe background-image in the critical css always resolves to url('/funny-how.jpg')\nWhich version of critical are using? \n. You also could use the stream method when using with gulp.\n. @julienetie any updates on this one? \n. We've made some progress on this topic @julienetie. The asset paths inside the critical css should now stay relative in case they were relative the first place. Could you check if your issue is fixed in the vinyl branch?\nnpm install --save-dev git+https://github.com/addyosmani/critical.git#vinyl\n/cc @SerzN1\n. Closing this due to lack of feedback. Feel free to reopen if you still got problems on this one.. This problem sounds really weird.\nCould you provide some more details about your critical configuration so we can dig in a bit?\n. ;)\n. @tigranpetrossian could you try again with the master branch?\nnpm install git+https://github.com/addyosmani/critical.git\n. Thanks\n. @vlrprbttst critical couldn't handle php files as this is a server side language which needs it's own interpreter. You could use grunt-php2html to convert your files to html in the first place and use these with critical to generate the critical path css.\nYou could then use the following code to inline the css in your page:\nhtml\n<style><?php include 'critical.css'; ?></style>\n<script>\n   function loadCSS(a, b, c) { \u2026 }\n   loadCSS('non-critical.css');\n</script>\n<noscript>\n   ...\n</noscript>\n. @vlrprbttst i've created a gist with a working solution for using critical with php.\nYou'll only need php-cgi installed and in your PATH.\nhttps://gist.github.com/bezoerb/a7ef67781f9ccafe36c2\n. @addyosmani I think this one's ready to merge. Do you wanna take a look before merging or are you confident everything's fine\n. so i guess you're fine with the changes ;)\n. @SerzN1 this is not released yet.\nTry npm install --save git+https://github.com/addyosmani/critical.git\n. @killercup think tests are failing because of a syntax change in loadcss.\nI've already fixed this in my current development branch.\nSee https://github.com/addyosmani/critical/commit/2b9c8bdff0aeda1cdaba71e58562c258c7a4aa4b.\n. @petulla The task configuration looks ok but it's pretty hard investigate your issue without the used html,css and js. Can you post a link to the website you are working on? \nYou are using dest and htmlTarget in your task. Is this just for debugging purpose or are you using both (css & html) in a later step of your build process? I'm asking because we've deprecated the htmlTarget and styleTarget options and therefore this won't be possible after 1.0.x. If there's a proper usecase for this we might need to think this over. \n. Closing this due to lack of feedback. Feel free to reopen if you still got problems on this one.. Can you provide an use case for this fix?\nAs far as i can see there's always a string returned from penthouse and therefore there is no stream available to destroy. In case of an error the the rejected promise is returned. \n. you could try the extract option. See https://github.com/addyosmani/critical#options\n. Nice catch. Can you provide a test for your fix?\n. LGTM \n. @yahreen i can't see anything unusual in the provided output. Is there another stylesheet loaded after main.min.css? can you provide a link to your page or a gist with the <head> section?\n. @yahreen commented in the gist \n. @yahreen i've just added the latest version of loadcss to master.\nMaybe this fixes your problem?\nWant to give it a try?\nbash\nrm -Rf node_modules/critical && npm install --save-dev git+https://github.com/addyosmani/critical.git\n. @FernandoGOT you can set the DEBUG environment variable to critical:* to get some additional output but this doesn't include cpu & memory usage. As this isn't shipped yet you'll need to use the current master\n. Closing this due to lack of feedback. Feel free to reopen if you still got problems on this one.. @tarciozemel: Any updates on this one? . Closing this due to inactivity. Seems fixed after all ;). The extract option only works in conjunction with inline: true \nThe workflow is:\n- Generate critical.css\neverything below is handled in inline-critical\n- Extract critical.css from main.css\n- Inline critical.css\n- Save modified main.css in the same folder as main..css\n- use loadCSS to load the modified main..css\nIf you just generate the critical path css without inlining you can use cave to remove the critical styles from your main.css\n. @KingScooty: Sorry for the late response. Do you still need assistance on this one?. Closing this due to inactivity.. @drcmda this issue could not be solved here as the inlining is handled by inline-critical. I made an issue over there\n. closed in favor of https://github.com/bezoerb/inline-critical/issues/47\n. Multiple HTML sources are not supported by now. You may generate the critical css for both pages and squash the styles together with clean-css.\nBut why don't you just inline the critical css for the homepage in the head of your homepage and the one for the landingpage in the landingpage?\n. No, the inline option can only produce a complete static html file. When you want to include critical in a partial you'll need to generate the critical css and do the inlining yourself. \n. Good catch. Looks like we need to patch oust for this one.\nhttps://github.com/addyosmani/oust/pull/17\nWhen this PR is accepted we can filter extracted stylesheets. \n/cc @addyosmani\n. fixed in 07be40bab23eb518bb689062b43f0db507c9a1f9. I'm also totally fine with the warning as this should be installed globally when used on the command line.\nMaybe we should also change the CLI part in the readme and add some npm install -g critical \n. https://github.com/addyosmani/critical/commit/2a1193039721aad7f8818aa713a5d61baa2b6999\n. Added global install instructions to the CLI section in the readme\n. @oskarrough this is currently not possible with critical. inline-critical already has an option for this but there's no way to pass this configuration value from critical at the moment.\nI'm considering an inlineOptions property which will be passed directly to inline-critical.\n. would be possible after https://github.com/addyosmani/critical/pull/178 has landed\njs\ncritical.generate({\n    base: 'test/',\n    src: 'index.html',\n    dest: 'styles/styles.min.css',\n    minify: true,\n    width: 1300,\n    height: 900\n    inline: { ignore: /ignored\\.css/ }, \n});. Closing this due to inactivity. Feel free to open an issue for inline-critical if there's anything left to fix.. @Tempurturtul i've provided a fix in the vinyl branch. Could you check if this fixes your issue?\nnpm install --save-dev git://github.com/addyosmani/critical#vinyl\n. @Tempurturtul there was an incompatibility to vinyl < v0.5.3. This should be fixed now by 846c233e1bf26b129b002ea7fc8d1fa3429ee2d0\n. Closed as this seems to be fixed. Feel free to reopen if the error still exists. still needs some work\n. @addyosmani wanna take a look?\n. Still needs some work (see https://github.com/addyosmani/critical/issues/57)\nAsset paths should be computed relative to dest instead of the src path.\nWhen no dest is available we need a target path option which should default to the src path\n. \\o/ green again :)\nAdded destFolder option used to compute the relative asset path. \nAsset paths are now computed in this order:\n- relative to destFolder if option is set\n- relative to dest if option is set\n- relative to src file \n@addyosmani: Want to take a look again? (Sorry for the 31 changed files ;))\n. @micahblu could you test against the master or vinyl branch? I Think this could be related to the recently fixed memory leaks in penthouse. I just tested gulp + critical on a folder with 36 files and got no memory leak warnings. So i guess this is should already be fixed. \n. @frankwaalkens critical doesn't support server-side languages like ASP or PHP as parsing these files is a bit out of scope for this project.\nYou can alternatively use the corresponding url to your server as src to process the files.\n. You'll need to use some module like gulp-remote-src or process every url manually. Maybe \n``` javascript\nvar critical = require('critical');\n['https://www.npmjs.com/package/package', 'https://www.npmjs.com/package/browserify'].forEach(function(url) {\n    critical.generate({\n        src: url,\n        dest: url.replace('https://www.npmjs.com/package/','') + '.css'\n    });\n});\n``\n. @JakeHenshall which version of critical are you using\n. @JakeHenshall: Sorry for the late response. Do you still need assistance on this one?. we can use the penthouse forceInclude option to achieve this. \n. Just added theincludeoption\nhttps://github.com/addyosmani/critical/compare/88f66ba...39498 \n. @thomasdigby. The include option is available in [v0.7.2](https://github.com/addyosmani/critical/releases/tag/v0.7.2)\n. @thomasdigby can you confirm this works for you?\n. Theincludeoption can be specified in the penthouse options.\nClosing this due to inactivity.. @pedrokost This file is just a redirect to/fleet-monitor/so you shouldn't create critical css for this file at all. \n. Critical won't touch or rewrite non-relative urls in your css so you could easily point your assets to the CDN before using critical. Otherwise they'll be fetched twice. First from the CDN when rendering the critical path and then from your webserver as soon as your stylesheet gets loaded.\n. Nice catch. I think we should rather fix this issue instead of adding another option as workaround\n. That seems legit to me, although I am still not really satisfied with the whole set of asset configuration params. We may need to find a way to simplifybase,assetPaths,pathPrefixanddomainPrefixin the future. @addyosmani what do you think? Would love to hear your opinion on this. \n. Closing this as asset urls can now be rebased using therebaseoption. There's also a possibility to pass in a callback function to have complete control over each asset. @addyosmani ping ;)\n. Thanks @addyosmani and never mind the missing pings ;)  \n. just tried the cli with some local url and it worked just as expected. Is there some sort of authentication required? What's the output when you just try to fetch the url usingwgetorcurl?\n. yes, but i have an apache running. I'll see if i can set up an nginx and try again.\n. with nginx everything is fine, too.\nPlease enable debug and run again:export DEBUG='critical:*' && node_modules/.bin/critical http://dev.lovindublin.com/ -mMaybe this helps locating the error\n. If this doesn't help i would add some additional debug logs in a separate branch until we can nail down the cause of the 403\n. @miralize, @mikeebee \nI've added a fix for this issue. Could you please check again using themasterbranch?\nThanks @pocketjoso :)\n. @mikeebee can you check the availability ofhttp://localurl.dev/` using curl?\nbash\ncurl http://localurl.dev/\n. Hmm,... it's hard to guess why critical get's an 403 while trying to fetch the page. Could you give some more insights on your setup? \n. Closing this as nothing happened in the last 2 years ;)\nThink this should be way better with the next version. The prerelease version can be installed with npm i critical@next\nFeel free to reopen if the issue still exists.\n. Maybe a bit late but i added the reference you asked for ;). Even if the PR is already merged i guess it would be better to clear the temporary files on uncaughtException and re-throw the error.\n. Resolved in d46c08c609fafc83a44e8328e5fd8272097d681f\n. Thanks for working on this. \nJust waiting for appveyor to green up\n. Thanks :)\n. @vlrprbttst have you tried setting base fo ./_dev ?\n. We published a new prerelease version. You can now use the rebase option to specify/overwrite image paths. You even can define a transform function which will be called for every asset reference found in the stylesheet\nYou can install the new version with npm i critical@next\nThanks. Closing this for now but feel free to re-open if anything doesn't fit. It looks like you missed the stream function. See https://github.com/addyosmani/critical#gulp\n. Thanks for working on this @vladh!\nWould you mind adding a testcase for the 404?\n. Thanks :)\n. @addyosmani, @rd4704 sorry for the late response. I think this issue could be resolved by https://github.com/addyosmani/critical/pull/127\n. We published a new prerelease version. You can now use the rebase option to specify/overwrite image paths. You even can define a transform function which will be called for every asset reference found in the stylesheet\nYou can install the new version with npm i critical@next\nThanks\nClosing this for now but feel free to re-open if anything doesn't fit. Sorry but there's currently no other way than running the ghPages task after critical is done. (See #60). What about allowing objects for penthouse as well as inline-critical in the options that are directly passed down to the corresponding library with reasonable defaults based on the critical configuration. This would bring more flexibility and also keeps the options for critical clean.  Somthing like:\ncritical.generate({\n    inline: true, // uses default options\n    base: 'dist/',\n    penthouse: { strict: true, timeout: 50000, ... }\n});\nor \ncritical.generate({\n    inline: { extract: true, ignore: /fonts.googleapis/ }, \n    base: 'dist/',\n    penthouse: { \n        strict: true, \n        timeout: 50000, \n        phantomJsOptions: {\n            'proxy': 'http://proxy.company.com:8080',\n            'ssl-protocol': 'SSLv3'\n        }\n    }\n});. See https://github.com/addyosmani/critical/pull/178. @hermagrini did you found the issue?\n. there's no published version for this yet.\nCould you try the master branch?\n. Spotted the error in penthose\nPR submitted. When this is merged we should get our windows tests green again\n/cc @XhmikosR \n. The last patch version bump of penthouse broke windows compatibility:\nhttps://github.com/pocketjoso/penthouse/blob/0.9.11/lib/index.js#L56\n. Thanks :)\n. Thanks for the report and sorry for the late response ;)\nI'll take a look\n. Did some debugging and it seems like one of the files are missing (for me it was the css).\nbash\n[00:03:22] Starting 'critical'...\nENOENT: no such file or directory, open '.tmp/styles/main.css'\nFatal undefined\nI'll add some error reporting tomorrow. \n```js\nconst critical = require('critical').stream;\nconst {log, colors} = require('gulp-util');\n// Generate & Inline Critical-path CSS\ngulp.task('critical', () =>\n    gulp.src('dist/*.html')\n        .pipe(critical({...}))\n        .on('error', err => log(colors.red(err.message)) )\n        .pipe(gulp.dest('dist'));\n);\n```\n=>\nbash\n[06:27:16] Starting 'critical'...\n[06:27:16] ENOENT: no such file or directory, open '.tmp/styles/main.css'. ~~Can you post your error messages?~~ i should reload the page before commenting :)\n/cc @herrkessler @ValentinBrclz @Milance1992 \n. Closing this as nothing happened in the last 2 years. \nFeel free to reopen if the issue still exists.. 2 years later...\n...done ;). Closing this as nothing happened in here for the last 2 years. Anyone feel free to re-open if any suggestion comes up \n. Thanks :)\n. @thany you can log the errors using gulp-util\n```js\nconst critical = require('critical').stream;\nconst {log, colors} = require('gulp-util');\n// Generate & Inline Critical-path CSS\ngulp.task('critical', () =>\n    gulp.src('dist/*.html')\n        .pipe(critical({...}))\n        .on('error', err => log(colors.red(err.message)) )\n        .pipe(gulp.dest('dist'));\n);\n```\n=>\nbash\n[06:27:16] Starting 'critical'...\n[06:27:16] ENOENT: <errormessage>\nCan you share the error message? . @thany any updates? Does the error still exist?. @bambamboole: Yes. See https://github.com/addyosmani/critical/blob/master/test/02-generate.js#L459 ff.\n. @bambamboole have you tried the inline: true option?\ninline-critical has a target option to specify a selector where the critical css gets prepended. So if the default inine settings in critical doesn't work out, you could use inline-critical yourself to do the inlining for you as long as your template is parsable by cheerio. Closing this as nothing happened in the last 2 years. \n. Thanks :)\n. Thanks for reporting and sorry for the late response. We'll adding a fix for this in the next release.. v1.0.0 Released. . @schoenwaldnils the stream function wraps generate for gulp. You can use it like this:\n```\nconst log = require('gulp-util').log;\nconst colors = require('gulp-util').colors;\nconst critical = require('critical').stream;\nconst rename = require(\"gulp-rename\");\n// Generate & Inline Critical-path CSS\ngulp.task('critical', function () {\n    return gulp.src('_site/index.html')\n        .pipe(critical({\n              base: '_site'\n              width: 320,\n              height: 480,\n              minify: true,\n        })).on('error', function(err) { log(err.message); })\n        .pipe(rename('main-critical.css'))\n        .pipe(gulp.dest('build'));\n});\n```\nTo get a little more verbose you can toggle the debug mode on the CLI with\nbash\nexport DEBUG=\"critical:*\"\ngulp critical\nMaybe the debug output leads us to the cause of your issue. Closing as this one seems to be fixed by penthouse v0.11.11. @pocketjoso Thanks for your work!. @k9ordon this version is already covered by \"penthouse\": \"^0.10.0\". Closing this as nothing happened in here for the last 2 years ;)\nFeel free to reopen if the issue still exists.. @Pustelto: this is some misleading behavior. src is relative to base directory and dest is relative to current working dir. This should be unified in the master branch. For now you can either use dest: 'dist/ic.html' or use the streams method:\n```js\nconst critical = require('critical').stream;\ngulp.task('critical', () => \n  gulp.src('dist/*.html')\n    .pipe(critical({base: 'dist/', inline: true, ...]}))\n    .pipe(gulp.dest('dist'));\n);\n```. @emix7 can you share your configuration?. Closing this as nothing happened in the last 2 years. \nI think this should be way better with the next version. The prerelease can be installed with npm i critical@next. Asset paths can be configured with the rebase option \nFeel free to reopen if the issue still exists.. @mkhazov I think you're right with the cheerio assumption. I think the only way to avoid this issue is to use critical to only generate the critical-path css and then do the inlining yourself.. I'm closing this issue for now. Feel free to open an issue in inline-critical. Maybe we'll find another HTML parser which can handle this.. Thanks for the ping @pocketjoso :)\nI already worked on the dependency update in the bump-dependencies branch.\nUnfortunately i'm randomly running in some ECONNRESET errors and i haven't yet figured out what's causing them.\n. @midzer: I completely agree with @pocketjoso \nWhen i run critical from the commandline like this:\nsh\ncritical https://feuerwehr-eisolzried.de \nI get the same results without anything missing.\nhttps://www.diffchecker.com/NZzBnVEn. @midzer: sorry for the late response.\nI'm working on a new release of critical. You can install it using npm i critical@next\nMaybe you could check if this update solves your issue?. @denistrator Thanks for reporting the issue. This seems to be an error with cheerio (Used for parsing the html document)\n. See: https://github.com/fb55/htmlparser2/pull/129. Just identified & fixed (hopefully) another issue with inlined svgs.\nClosing this issue due to inactivity. You can follow the progress in #63. Closing this as nothing happened in the last 2 years. \nI think this should be way better with the next version. The prerelease can be installed with npm i critical@next\nAll penthouse options can be passed through with the penthouse option \n. You can catch the errors in gulp itself by defining an error listener to the stream.\nI've added the following to the Readme\njavascript\n// Generate & Inline Critical-path CSS\ngulp.task('critical', function () {\n    return gulp.src('dist/*.html')\n        .pipe(critical({base: 'dist/', inline: true, css: ['dist/styles/components.css','dist/styles/main.css']}))\n        .on('error', function(err) { gutil.log(gutil.colors.red(err.message)); })\n        .pipe(gulp.dest('dist'));\n});. According to the spec, an inline SVG is expanded to the full size of the viewport:\nhttps://www.w3.org/TR/SVG/single-page.html#struct-SVGElementHeightAttribute\nSo even if some browsers will by default use 300x150 as the default size for an SVG, you can't rely on having this default. It seems phantomjs uses 100% height and is therefore pushing the .After element out of the way unless the size of the svg is limited somehow\n. @pocketjoso: is this intended?. @davidhellmann: can you share the live url?. @davidhellmann: I just released a patch version fixing an issue with multiple dimensions used to generate the critical-path css. Would you mind checking again with the latest version of critical?. Closing this as nothing happened in the last 1,5 years. \nI think this may be fixed in the next version. \nThe prerelease can be installed with npm i critical@next\nFeel free to re-open if the issue still exists.. Closing this as it seems that this is not an issue with critical itself. Feel free to reopen if you need further assistance on this.. This may have been fixed in v0.8.4\nJust tried in a similar setup with the current version and everything seems ok.\nGulp:\njs\nvar critical = require('critical');\ngulp.task('criticalmain', function(cb) {\n    critical.generate({\n        inline: false,\n        base: '.',\n        src: '.tmp/html/default/index.html',\n        css: ['.tmp/styles/main.css'],\n        width: 1300,\n        height: 900,\n        dest: 'tmp.css',\n        minify: true,\n        extract: true,\n        ignore: ['font-face']\n    }, cb);\n});\nFile structure\n```shell\n\u251c\u2500\u2500 .tmp\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 html\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 default\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u00a0\u00a0\u00a0 \u2514\u2500\u2500 index.html\n\u2502\u00a0\u00a0 \u2502\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 styles\n\u2502\u00a0\u00a0  \u00a0\u00a0 \u2514\u2500\u2500 main.css\n\u2502\n\u2502\n\u2514\u2500\u2500 gulpfile.js\n```\nCould you try again with the current version? If it fails you might run the criticalmain task using \nshell\nDEBUG='critical:*' gulp criticalmain\nand post the output?. @ArtyomSvinin could you run critical with the debug environment variable set as I mentioned above? This might give some insights about the issue. I'm currently on vacation but i could take another look when I'm home again. . Maybe this is related to https://github.com/addyosmani/critical/pull/219. Should be fixed in v1.0.0. Feel free to reopen if the error still exists.. @fBosch: Thanks for reporting this. After adding test cases for generate and stream i found an issue caused by a configuration change introduced in clean-css@v4.0.0.\nWould you mind checking your setup again with the critical v0.8.3?. Closing this as nothing happened in the last 2 years. \nFeel free to reopen if the issue still exists.. @richhollis: would you mind testing the development branch?\nSee: https://github.com/addyosmani/critical/pull/198. @pajtai: Thanks for working on this. The issue is caused by a change introduced in vinyl v2.0.1. \nThe path of the file object now gets normalized. This results in https://jekyllrb.com/ getting normalized to https:/jekyllrb.com which isn't a valid url anymore.\nI think we should start there and fix the cause and not the effects. I'm also working on a fix for this right now.. @pajtai could try again the development branch?\nSee: https://github.com/addyosmani/critical/pull/198\n. fixed with #198. @valeriosillari critical doesn't support template-engines. This would be way ahead of scope for this plugin. You'll have to do it just like you explained ;)\n\nI need to take a page created in pug, parse the \"final\" html and css, using critical to set new inline code and then inject again into pug file.\n\nSee https://github.com/addyosmani/critical/issues/94 for further information.\n. Awesome \ud83d\ude0a\nYes, please write a test for this. I'll take a deeper look this evening. \nThanks for working on this.. Changes look good to me. An entry for the css option in the table would be nice. Seems like we've missed it.\nI will merge this as soon as you got the test up & running ;). Thanks @Adam-Meisen!. Closing this in favor of #320\n. @chovy: Sorry for the late response. Critical computes the css required for the initial page view so there's a good chance that some parts of the css will be dropped before inlining. If you just want to inline the css you should consider using inline-critical . Closing this due to lack of feedback.\nI think this even may be fixed in the next version. \nThe prerelease can be installed with npm i critical@next\nFeel free to re-open if the issue still exists.. Closing this as nothing happened in the last 2 years. \nI think this should be way better with the next version. The prerelease can be installed with npm i critical@next\nFeel free to reopen if the issue still exists.. You can pass inline: false as an option to critical . @retyui: This should be addressed here. Unfortunately i don't have much time to work on this right now but you're welcome to add a PR to inline-critical. Hey @davidhellmann,\nsorry for the late response. Can you provide some more insights on your problem?\nI'm currently not quite sure how to help you as your last comment indicates that the issue might be in your setup and not in critical itself.\n. Closing this due to lack of feedback.\nFeel free to re-open if the error still exists. \nMaybe try the latest version of critical first ;) . @rmckeel: Thanks for detailed issue report. I'll take a look. @rmckeel: sorry for the delay. You should use the href attribute on your link tag as the srcattribute is not supported here ;) (See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/link)\nI've checked your example with the correct html and everything works fine as expected. . @rmckeel: Sorry for the late response. \nI've just ran the test twice using critical.generate as well as critical.stream and everytime i ended up with the expected result:\n```html\n<!DOCTYPE html>\n\n\n\nTitle\n",
    "XhmikosR": "Sure thing. I'll test things out when I'm back.\nOn Jul 5, 2014 12:40 PM, \"Addy Osmani\" notifications@github.com wrote:\n\nHmm. I haven't tested on Windows yet but this looks very curious.\nCould you let me know if you're able to get this sample using Critical\nrunning for you correctly on Windows\nhttps://github.com/addyosmani/critical-path-css-demo?\nAlternatively, just verifying the module works in your environment would\nbe of great help. I'm trying to determine if this is a test harness issue,\nfs, penthouse or straight-out something silly I'm doing in the module.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/addyosmani/critical/issues/14#issuecomment-48082368.\n. I can't even install the dependencies for the demo... too many errors.\n\nAt first I thought it's because of too long filenames. I even moved the repo in C:\\ but I still can't install the deps.\n. Full log for the demo https://gist.githubusercontent.com/XhmikosR/2ce380c87e80a8de980f/raw/critical-demo-npm-install.log\n. Nope, penthouse works fine by doing npm install && npm test...\n. Sure, I'll try when I'm back\u263a\nOn Jul 7, 2014 2:29 AM, \"Addy Osmani\" notifications@github.com wrote:\n\n@XhmikosR https://github.com/XhmikosR pushed some potential fixes to\nmaster. Could you let me know if there's any difference in test output?\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/addyosmani/critical/issues/14#issuecomment-48130432.\n. ```\nC:\\Users\\xmr\\Desktop\\critical>npm test\ncritical@0.1.3 test C:\\Users\\xmr\\Desktop\\critical\nmocha test.js --timeout 15000\n\n|\n.././\n2 passing (3s)\n  6 failing\n1)  generates critical-path CSS successfully:\n     Uncaught AssertionError: false == true\n      at C:\\Users\\xmr\\Desktop\\critical\\test.js:33:9\n      at C:\\Users\\xmr\\Desktop\\critical\\index.js:60:15\n      at C:\\Users\\xmr\\Desktop\\critical\\node_modules\\mocha\\node_modules\\glob\\node_modules\\graceful-fs\\graceful-fs.js:104:5\n      at Object.oncomplete (fs.js:107:15)\n2)  generates minified critical-path CSS successfully:\n     Uncaught AssertionError: false == true\n      at C:\\Users\\xmr\\Desktop\\critical\\test.js:47:9\n      at C:\\Users\\xmr\\Desktop\\critical\\index.js:63:13\n      at ChildProcess. (C:\\Users\\xmr\\Desktop\\critical\\node_modules\\penthouse\\lib\\index.js:43:13)\n      at ChildProcess.emit (events.js:98:17)\n      at Process.ChildProcess._handle.onexit (child_process.js:809:12)\n3)  generates critical-path CSS without writing to disk:\n     Uncaught AssertionError: false == true\n      at C:\\Users\\xmr\\Desktop\\critical\\test.js:60:9\n      at C:\\Users\\xmr\\Desktop\\critical\\index.js:63:13\n      at ChildProcess. (C:\\Users\\xmr\\Desktop\\critical\\node_modules\\penthouse\\lib\\index.js:43:13)\n      at ChildProcess.emit (events.js:98:17)\n      at Process.ChildProcess._handle.onexit (child_process.js:809:12)\n4)  inlines critical-path CSS successfully:\n     Uncaught AssertionError: false == true\n      at C:\\Users\\xmr\\Desktop\\critical\\test.js:72:7\n      at C:\\Users\\xmr\\Desktop\\critical\\index.js:92:9\n      at C:\\Users\\xmr\\Desktop\\critical\\node_modules\\mocha\\node_modules\\glob\\node_modules\\graceful-fs\\graceful-fs.js:104:5\n      at Object.oncomplete (fs.js:107:15)\n5)  inlines critical-path CSS without writing to disk:\n     Uncaught AssertionError: false == true-\n  6)  inlines and minified critical-path CSS:s:83:7\n     Uncaught AssertionError: false == truex.js:95:9\n      at C:\\Users\\xmr\\Desktop\\critical\\test.js:96:7\n      at C:\\Users\\xmr\\Desktop\\critical\\index.js:92:9mocha\\node_modules\\glob\\node\n      at C:\\Users\\xmr\\Desktop\\critical\\node_modules\\mocha\\node_modules\\glob\\node_modules\\graceful-fs\\graceful-fs.js:104:5\n      at Object.oncomplete (fs.js:107:15)\nnpm ERR! Test failed.  See above for more details.\nnpm ERR! not ok code 0\n```\n. I tried a couple hours ago after those patches and I still get the same\nfailures...\nOn Jul 8, 2014 11:58 PM, \"Addy Osmani\" notifications@github.com wrote:\n\nThanks to Sindre we have a fresh rewrite now in master. Any luck now?\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/addyosmani/critical/issues/14#issuecomment-48398707.\n. Sure, I'll do it first thing tomorrow.\n\nOn Wed, Jul 9, 2014 at 12:54 AM, Sindre Sorhus notifications@github.com\nwrote:\n\n@XhmikosR https://github.com/XhmikosR run the test from master now and\npaste in the output ;)\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/addyosmani/critical/issues/14#issuecomment-48404409.\n. https://gist.github.com/XhmikosR/8b69a2a39841f9edfd05\n. With LF forced for the test files, I get 3/6 passed BTW.\n. With this patch and LF forced for all the repository files I get 3 failing tests.\n\n```\nC:\\Users\\xmr\\Desktop\\critical>npm test\n\ncritical@0.1.4 test C:\\Users\\xmr\\Desktop\\critical\nmocha test.js --timeout 15000\n\n|\n..../\n5 passing (44s)\n  3 failing\n1)  generates critical-path CSS successfully:\n     Error: timeout of 15000ms exceeded\n      at null. (C:\\Users\\xmr\\Desktop\\critical\\node_modules\\mocha\\lib\\runnable.js:139:19)\n      at Timer.listOnTimeout [as ontimeout] (timers.js:110:15)\n2)  generates minified critical-path CSS successfully:\n     Error: timeout of 15000ms exceeded\n      at null. (C:\\Users\\xmr\\Desktop\\critical\\node_modules\\mocha\\lib\\runnable.js:139:19)\n      at Timer.listOnTimeout [as ontimeout] (timers.js:110:15)\n3)  generates critical-path CSS without writing to disk:\n  Uncaught AssertionError: \"body {\\n    padding-top: 20px;\\n    padding-bott\n\nom: 20px;\\n}\\n\\n\\n.header,\\n.marketing{\\n    padding-left: 15px;\\n    padding-r\n=== \"body {\\r\\n    padding-top: 20px;\\r\\n    padding-bottom: 20px;\\r\\n}\\r\\n\\r\\n\\\nr\\n.header,\\r\\n.marketing{\\r\\n    padding-left: 15px\n      + expected - actual\n  +body {<CR>\n  -body {\n\n\n\npadding-top: 20px;\n\n\npadding-bottom: 20px;\n  -}\n\n\npadding-top: 20px;\n\n\npadding-bottom: 20px;\n  -.header,\n  -.marketing{\n\npadding-left: 15px;\npadding-right: 15px;\n  -}\n\n+}\n+\n  -.header {\n  -    border-bottom: 1px solid #e5e5e5;\n  -}\n+\n+.header,\n  -.header h3 {\n  -    margin-top: 0;\n  -    margin-bottom: 0;\n  /-    line-height: 40px;\n  -    padding-bottom: 19px;\n  -}\n+.marketing{\n\npadding-left: 15px;\n  -.jumbotron {\ntext-align: center;\n\nborder-bottom: 1px solid #e5e5e5;\n  -}\n\n\npadding-right: 15px;\n  -.jumbotron .btn {\n\nfont-size: 21px;\npadding: 14px 24px;\n  -}\n\n+}\n+\n  -.marketing {\n  -    margin: 40px 0;\n  -}\n+\n+.header {\n  -@media screen and (min-width: 768px) {\n  -    .container {\n  -        max-width: 730px;\n  -    }\n\nborder-bottom: 1px solid #e5e5e5;\n  -\n.header,\n.marketing{\npadding-left: 0;\npadding-right: 0;\n}\n\n+}\n  +\n  +\n+    margin-top: 0;-\n  +    margin-bottom: 0;\n  +    line-height: 40px;\n  +    padding-bottom: 19px;\n  +}\n  +\n  +\n  +.jumbotron {\n  +    text-align: center;\n  +    border-bottom: 1px solid #e5e5e5;\n  +}\n  +\n  +.jumbotron .btn {\n  +    font-size: 21px;\n  +    padding: 14px 24px;\n  +}\n  +\n  +\n  +.marketing {\n  +    margin: 40px 0;\n  +}\n  +\n  +\n  +@media screen and (min-width: 768px) {\n  +    .container {\n  +        max-width: 730px;\n  +    }\n  +\n  +    \n  +    .header,\n  +    .marketing{\n  +        padding-left: 0;\n  +        padding-right: 0;\n  +    }\n  +\n  +    \n  +    .header {\n  +        margin-bottom: 30px;\n  +    }\n  +    \n  +    \n  +    .jumbotron {\n  +        border-bottom: 0;\n  +    }\n  +}\n  -\n  -    .header {\n  -        margin-bottom: 30px;\n  -    }\n  -\n  -\n  -    .jumbotron {\n  -        border-bottom: 0;\n  -    }\n  -}\nat C:\\Users\\xmr\\Desktop\\critical\\test.js:28:16\n  at C:\\Users\\xmr\\Desktop\\critical\\index.js:75:21\n  at C:\\Users\\xmr\\Desktop\\critical\\node_modules\\mocha\\node_modules\\glob\\node_modules\\graceful-fs\\graceful-fs.js:104:5\n  at Object.oncomplete (fs.js:107:15)\n\n\nnpm ERR! Test failed.  See above for more details.\nnpm ERR! not ok code 0\n```\nSo I'd say we should have this merged.\n. Cool, almost there 3/4 passing. One thing I notice with the tests branch is\nthat fixture\\styles\\critical.css is modified and is different so that must\nbe the one failing test.\nAlso the isWindows variable seem to be only used once, it's your call if\nyou want to keep it. var lineBreak = process.platform == 'win32' ? /\\r\\n/g\n: /\\n/g; would work too.\nOn Sun, Jul 13, 2014 at 11:51 PM, Addy Osmani notifications@github.com\nwrote:\n\nWorking on fixes. Have 4 tests passing now. Just a few more to go :)\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/addyosmani/critical/issues/14#issuecomment-48851599.\n. Didn't know this existed either, thanks.\n. Maybe a rebase and squash and should be ready :)\n. @addyosmani: irrelevant to this but please check the grunt-uncss notifications too :)\n. @sindresorhus: any idea about this? You can see the live failure here https://ci.appveyor.com/project/addyosmani/critical/build/189/job/q87tb7eta4nmhh3x#L286\n\nAll the environment variables are there, defined and pointing to the right directory.\nAlso CC @bezoerb just in case you have any idea\n. tempfile seems to work properly:\n```\n\n\ncsspath C:\\Users\\xmr\\AppData\\Local\\Temp\\3ad24bf2-aaa4-48cf-9418-66b6beea4249.css\n```\n\n\nSo, the issue must be in the rest of tmp handling.\nEDIT: I give up for now.\nIt's like tmp has its options messed up somewhere in file-helper.js.\n. Thanks! I couldn't spot it for the life of me :/ Was it an issue due to ^\nin penthouse dependency?\nOn Aug 17, 2016 22:37, \"Ben Z\u00f6rb\" notifications@github.com wrote:\n\nSpotted the error in penthose\nPR submitted. When this is merged we should get our windows tests green\nagain\n/cc @XhmikosR https://github.com/XhmikosR\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly, view it on GitHub\nhttps://github.com/addyosmani/critical/issues/149#issuecomment-240522792,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AAVVtQ2aHD0MuQmJtjTCl2kqXAIuOxnOks5qg2LbgaJpZM4JZfCi\n.\n. @pocketjoso: you should add AppVeyor to prevent Windows issues in the future.\n. And the AppVeyor failure we see here is what I reported in #149.\n. So, we are almost ready; I updated the indent-string calls to the new API, fixed all ESLint errors except that process exit one.\n\nAfter that CI should be green.\n@sindresorhus, any idea how to disable the no-process-env error? I tried to suppress it inline in gc.js with /* eslint no-process-exit: 0 */ but doesn't seem to have any effect.\n. Thanks, the PR should be ready to merge if Travis in green.\n. It seems node.js 0.12 is broken.\nShould I just require >= 4? See https://github.com/XhmikosR/critical/commit/df744f116105527a2d96362da58238f03e52d4cb\nI also made all tests run on Windows successfully (bypassing the missing tmp directory issue locally).\n```\nv4.4.7\n2.15.8\n\ncritical@0.7.3 test C:\\Users\\xmr\\Desktop\\critical\nxo && mocha test/*.js --timeout 100000\n\ntest\\02-generate.js:1:1\n  \u203c  1:1  File must be at most 300 lines long  max-lines\ntest\\05-cli.js:1:1\n  \u203c  1:1  File must be at most 300 lines long  max-lines\n2 warnings\nModule\n    \u221a should call callback method with an error on generating if src and base not specified\n    \u221a should return rejected Promise for generating without callback if src and dest not specified\n    \u221a should call callback method with an error on generateInline if src and base not specified\n    \u221a should return rejected Promise for generateInline without callback if src and dest not specified\n    \u221a throws on inlining if src and dest not specified\nModule - generate\n    \u221a should generate critical-path CSS (1970ms)\n    \u221a should throw an error on timeout (94ms)\n    \u221a should generate critical-path CSS with query string in file name (1828ms)\nIgnoring http://cloud.typography.com/6020032/784002/css/fonts.css (403)\n    \u221a should ignore stylesheets blocked due to 403 (2861ms)\nIgnoring http://cloud.typography.com/6020032/784002/css/404.css (404)\n    \u221a should ignore stylesheets blocked due to 404 (2533ms)\n    \u221a should generate multi-dimension critical-path CSS (1484ms)\n    \u221a should generate minified critical-path CSS (1970ms)\n    \u221a should generate minified critical-path CSS successfully with external css file configured (1843ms)\n    \u221a should inline relative images (1486ms)\n    \u221a should inline absolute images (1455ms)\n    \u221a should skip to big images (1453ms)\n    \u221a considers \"inlineImages\" option (1437ms)\n    \u221a should not screw up win32 paths (1438ms)\n    \u221a should respect pathPrefix (1438ms)\n    \u221a should generate and inline, if \"inline\" option is set (1941ms)\n    \u221a should generate and inline critical-path CSS (1907ms)\n    \u221a should generate and inline minified critical-path CSS (1875ms)\n    \u221a should handle multiple calls (3704ms)\n    \u221a should inline critical-path CSS ignoring remote stylesheets (2563ms)\n    \u221a should inline critical-path CSS with extract option ignoring remote stylesheets (2955ms)\n    \u221a should inline critical-path CSS without screwing svg images  (1516ms)\n    \u221a should inline and extract critical-path CSS (2344ms)\n    \u221a should inline and extract critical-path CSS from html source (2266ms)\n    \u221a should consider \"ignore\" option (1828ms)\n    \u221a should handle empty \"ignore\" array (1891ms)\n    \u221a should handle ignore \"@font-face\" (1469ms)\n    \u221a should keep styles defined by the include option (1468ms)\nModule - generate (remote)\n    \u221a should generate critical-path CSS (1845ms)\n    \u221a should generate multi-dimension critical-path CSS (1453ms)\n    \u221a should generate minified critical-path CSS (1922ms)\n    \u221a should generate minified critical-path CSS successfully with external css file configured (1799ms)\n    \u221a should inline relative images (1453ms)\n    \u221a should inline relative images fetched over http (1469ms)\n    \u221a should inline absolute images (1470ms)\n    \u221a should inline absolute images fetched over http (1455ms)\n    \u221a should skip to big images (1453ms)\n    \u221a considers \"inlineImages\" option (1422ms)\n    \u221a should not screw up win32 paths (1453ms)\n    \u221a should respect pathPrefix (1438ms)\n    \u221a should generate and inline, if \"inline\" option is set (1875ms)\n    \u221a should generate and inline critical-path CSS (1859ms)\n    \u221a should generate and inline minified critical-path CSS (1955ms)\n    \u221a should handle multiple calls (3828ms)\n    \u221a should inline critical-path CSS handling remote stylesheets (3579ms)\n    \u221a should inline critical-path CSS with extract option handling remote stylesheets (3132ms)\n    \u221a should inline critical-path CSS without screwing svg images  (1516ms)\n    \u221a should inline and extract critical-path CSS (2359ms)\n    \u221a should consider \"ignore\" option (1829ms)\n    \u221a should handle empty \"ignore\" array (1844ms)\n    \u221a should handle ignore \"@font-face\" (1469ms)\n    \u221a should keep styles defined by the include option (1438ms)\nModule - inline (deprecated)\n    \u221a inlines critical-path CSS successfully\n    \u221a inlines and minified critical-path CSS\n    \u221a inlines and minified critical-path CSS and consider \"inlineImages\" option\nModule - generateInline (deprecated)\n    \u221a should generate and inline critical-path CSS (1812ms)\n    \u221a should generate and inline minified critical-path CSS (1844ms)\n    \u221a should handle multiple calls (3735ms)\n    \u221a should inline critical-path CSS ignoring remote stylesheets (2360ms)\n    \u221a should inline critical-path CSS with extract option ignoring remote stylesheets (2796ms)\n    \u221a should inline critical-path CSS without screwing svg images  (1532ms)\n    \u221a should inline and extract critical-path CSS (2437ms)\n    \u221a should inline and extract critical-path CSS from html source (2406ms)\n    \u221a should generate and inline critical-path CSS and store css (1938ms)\nCLI\n    acceptance\n      \u221a should return the version (1468ms)\n      \u221a should work well with the critical CSS file passed as an option (3266ms)\n      \u221a should work well with the critical CSS file piped to critical (3328ms)\n      \u221a should exit with code 1 and show help (1453ms)\n    acceptance (remote)\n      \u221a should generate critical path css from external resource (3331ms)\n    mocked\n      \u221a should pass the correct opts when using short opts (219ms)\n      \u221a should pass the correct opts when using long opts (187ms)\n      \u221a should set inline to false when prefixed with --no (109ms)\n      \u221a should set inline to false when passing a falsy value (109ms)\n      \u221a should use \"generateInline\" when passing htmltarget (79ms)\n      \u221a should use \"generate\" when not passing htmltarget (94ms)\n      \u221a should use \"generateInline\" when passing --inline (94ms)\n      \u221a should use \"generate\" when not passing --inline (94ms)\n      \u221a should use \"generate\" when not passing falsy value for --inline (109ms)\n      \u221a should rewrite \"styleTarget\" to \"dest\" when using \"generate\" (125ms)\nStreams\n    \u221a should emit error on streamed file\n    \u221a should support vinyl buffer streams (1797ms)\n    \u221a should use \"generateInline\" if inline option is set (1953ms)\n    \u221a should use \"generate\" if inline option is false (3377ms)\n    \u221a should ignore css files not specified when using css option (1454ms)\n    \u221a should ignore css files not specified when using css option (inline) (1486ms)\n    \u221a should respect ignore option (inline) (1548ms)\n    \u221a should respect ignore option (inline) (1547ms)\n91 passing (2m)\n```\nSo only node.js 0.12 support is left (which is due to indent-string update).\n. /CC @bezoerb @addyosmani \n. @bezoerb: this should be documented if it's intended, otherwise it's a bug in filter-css.\nThe README there states:\n\nPer default filter-css will be applied to all parts of the CSS. This behavior can be customized by disabling specific matchers\n\nIf we have to specify explicitly\njs\nignoreOptions: {\n  matchSelectors: true,\n  matchTypes: true,\n  matchDeclarationProperties: false,\n  matchDeclarationValues: false,\n  matchMedia: false\n}\nthen something seems wrong :/. I believe this can be closed now @bezoerb . Works fine for me here.. @bezoerb: perhaps you need to set the onload handler to null like they recommend upstream?\nhttps://github.com/bezoerb/inline-critical/blob/master/index.js#L148\n\nWe also recommend nulling the onload handler once it is used, since some browsers will occasionally re-call the handler upon switching the rel attribute to stylesheet:\n\nhtml\n<link rel=\"preload\" href=\"path/to/mystylesheet.css\" as=\"style\" onload=\"this.onload=null;this.rel='stylesheet'\">\n<noscript><link rel=\"stylesheet\" href=\"path/to/mystylesheet.css\"></noscript>. So, you say that v2.0.0 works and v2.0.1 causes the issue? If that's the case, I guess you should report the issue to https://github.com/filamentgroup/loadCSS. Regardless, I still think, @bezoerb should set the onload event to null per the upstream README.. I confirm that the issue indeed exists. I might try to pinpoint the issue when I have some time unless someone else beats me to it.. I believe the issue is what I said above @bezoerb. I just tested IE 10 with this.onload=null; like the upstream docs and works fine. So we definitely need this.\nI made https://github.com/bezoerb/inline-critical/pull/231. Confirmed, works fine. You can close this issue.. Delete your local node modules folder and package lock and install\neverything again.\nIt's definitely fixed but I guess Ben could release a new patch critical\nversion to circumvent your issue which others will have too.\nOn Dec 15, 2017 12:06, \"Konrad \u010cern\u00fd\" notifications@github.com wrote:\n\nthanks guys for an effort and a fix, but it is still failing on IE11...\nshould I create another issue on loadCSS and close this one or how to\nproceed?\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly, view it on GitHub\nhttps://github.com/addyosmani/critical/issues/264#issuecomment-351965786,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AAVVtcTeJH1h-_csqRMqwEIVBnP_qPEcks5tAkSdgaJpZM4RCE_R\n.\n. I tested on IE 10 which had the problem and the fix fixed it for me. I will\ntry IE 11 in a few minutes but my guess is it will work there too.\n\nOn Dec 15, 2017 12:20, \"Konrad \u010cern\u00fd\" notifications@github.com wrote:\nI just did but it is still failing. this.onload=null is now applied but\nstill loads css again and again... are you testing on IE11 as well?\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly, view it on GitHub\nhttps://github.com/addyosmani/critical/issues/264#issuecomment-351968948,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AAVVtbIajDdLIpJe8dZmHOwmNgDm0GGuks5tAkfqgaJpZM4RCE_R\n.\n. Yup, works fine for me, the issue is fixed as expected from my initial testing too.\nIf you have any more issues you should report them upstream since now the code is the recommended one. Just don't forget to post an issue to the repo that needs any updates if something is changed upstream.. Until a new patch release of critical is out, you can just do the following:\nrm -rf ./node_modules/ ./package-lock.json\nnpm i\n@bezoerb: please release a new patch version where you explicitly bump inline-critical to the latest version.. While I'm on Windows and your test repo is probably from macOS (so I had to make a couple of changes), I tried it with msys2. I can reproduce your issue there with IE10, but I don't see how it's related to critical, when it happens if I remove your postbuild script which actually runs critical.\n. Hmm, the CI failures seem unrelated to these changes.. Actually, I'm gonna close this for now.. @bezoerb this can be closed now. OK, the problem is twofold:\n\nWe already inline our custom main CSS (which is just a few bytes) so critical doesn't see any links. I can work around this by not inlining it for development\nThe other CSS file we need as input is a remote one, which we load via loadjs. critical doesn't see this stylesheet at all. @bezoerb: thanks for the quick fix! Although I already changed our code, I'll give it a go tomorrow and get back to you.. @bezoerb: confirmed; it now works with remote URLs. Thanks!. Yes, just don't use imports because they are blocking.\n\n@bezoerb you can close this issue, it's unrelated to critical.. @bezoerb I personally don't see any warning with 1.3.4 either. You can check the CI too.. @bezoerb: were you able to reproduce?. @bezoerb: unfortunately I can't share the source. Is there a gulp + critical demo repo I can use to try to replicate this?. @bezoerb: there's definitely a regression somewhere. I'll try to set up a test repo, but it would save me some time if I could just try an existent repo.. @bezoerb: I pinpointed the cause. The error is thrown in my case when any HTML files include this:\nhtml\n<meta http-equiv=\"refresh\" content=\"0; url=https://example.com/\" />\nSo, you should be able to reproduce the error with this test file:\n```html\n<!doctype html>\n\n\nhttps://example.com/\n\n\n\n\n    The next meta makes critical (or puppeteer) throw:\n    Protocol error (Runtime.callFunctionOn): Cannot find context with specified id undefined\n    \n\n\n\n```\nTest repo: https://github.com/XhmikosR/critical-css-test\nI haven't tried other OS'es/env, so here is my env:\n\nWindows (7 or 10 doesn't matter)\nnode.js 10.5.0\nnpm 6.1.0\n. This error makes critical unusable on sites using any redirect via the meta tag.. @bezoerb: I'd expect critical to move on with the next HTML file.\n\nNote that these files are automatically generated by static page generators. And filtering them out would be a PITA.. i.e. not throw.. @bezoerb: I will try it tomorrow and let you know. Thanks for looking into it!. @bezoerb: tested it and seems to work fine :). I'll wait for the next npm release, but this seems fixed now.. @bezoerb BTW, maybe you could update all deps?. Thanks @bezoerb, it works fine!. @bezoerb: you want me to try and rebase this?. We should fix the tests to pass...\nEDIT: I made #330 for this.. @bezoerb: should we use Yarn on AppVeyor too? I find the current situation inconsistent, although it shouldn't really matter which package manager is used :). We could probably abstract the cmd code but maybe later after the tests are green.. #326 needs to be smaller somehow :/ Maybe try to move some patches to master like the linting changes and then rebase that branch.. @bezoerb should I remove nsp since it's shutting down?\nEDIT:\nI went ahead and removed nsp. Please do not squash the patches. @bezoerb: you shouldn't have squashed this.. For some reason it seems the build doesn't finish properly. Let's keep this open for a while, might be something with Travis.. @bezoerb: I updated this, now down to 14 errors and everything is more consistent.. @bezoerb: updated. It should be OK now hopefully.. That's not a rebase FYI.. You can clearly see the merge commits. That is not a rebase.. Just make sure you try what I said above, because I notice http links to packages in your package-lock.json :). @bezoerb can you login to coveralls and disable commenting for coveralls?. Are you sure this change was meant to be included in this PR?\n. Nothing in particular. I just don't like the fact that this change is\nunrelated to the rest. You could make a new PR for this and keep things\nclean.\nOn Jun 11, 2016 23:49, \"Ben Z\u00f6rb\" notifications@github.com wrote:\n\nIn cli.js\nhttps://github.com/addyosmani/critical/pull/129#discussion_r66711590:\n\n@@ -142,7 +142,7 @@ function run(data) {\n             if (err) {\n                 error(err);\n             } else {\n-                process.stdout.write(val);\n-                process.stdout.write(val, process.exit);\n\nI'm sure there was some reason i put it there even if i can't get it right\nnow as this doesn't have anything todo with the PRs main purpose. Do you\nhave any insights on this being a bad practice?\n\u2014\nYou are receiving this because you commented.\nReply to this email directly, view it on GitHub\nhttps://github.com/addyosmani/critical/pull/129/files/1d124336fb5352b7c6734f669bb4f713b0a29f66#r66711590,\nor mute the thread\nhttps://github.com/notifications/unsubscribe/AAVVtYNsNnoz5U2xeSvk7hUqQxOh-tvdks5qKx9lgaJpZM4IJ0Vx\n.\n. I know, but for the current repo only PNG files are marked as binary.\n. True that. I assume people don't blindly commit, but I changed the patch\nwith explicit reference to files.\n\nOn Wed, Aug 3, 2016 at 2:29 PM, Sindre Sorhus notifications@github.com\nwrote:\n\nIn .gitattributes\nhttps://github.com/addyosmani/critical/pull/157#discussion_r73322086:\n\n@@ -1 +1,3 @@\n- text=auto\n  +* text  eol=lf\n\nBut if someone adds a JPG and it becomes corrupted.\n\u2014\nYou are receiving this because you authored the thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/addyosmani/critical/pull/157/files/0fa1d51b17653df34a39523462b507ea21c73a7d#r73322086,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AAVVtfVlInwEeR_CbkEJOUtaVHZvILqXks5qcHuKgaJpZM4JbMyz\n.\n. It has an extra space between the |.\n. Thanks. I haven't even got so far, because tests fail anyway.... Yeah, I'm not done yet :). \n",
    "TJkrusinski": "Also, I suppose you could allow for css to be access via http as well.\n. ",
    "demohi": "+1\nand  command line \n. ",
    "donaldallen": "Right now, is it possible to use Critical with a PHP project, like WordPress? All the examples I've seen are reading static HTML files, but for dynamically generated templates, I'm guessing it's not possible.\n. ",
    "thomasplevy": "@donaldallen +1 on using this with dynamic content\n. ",
    "almeric": "+1 on dynamic content! \nWould be awesome if we could parse a xml/json sitemap to determine what pages there are\n. ",
    "leggomuhgreggo": "+1 awwww shucky ducky\n. ",
    "marcobiedermann": "I want to integrate critical on a node server which does not have any rendered html files. So +1 from my site for url / http access\n. ",
    "vdclouis": "+1\n. ",
    "relhtml": "+1 For this feature. \nFrom my understanding, in order to determine the Critical CSS from a series of partials, you would need some sort of headless browser (PhantomJS?) to render the page as a whole, then determine the \"above-the-fold\" content from there? \n. ",
    "danimalweb": "This is a great idea +1.\n. Seems to be working well. However I am also getting the memory leak warnings.\n(node) warning: possible EventEmitter memory leak detected. 11 listeners added. Use emitter.setMaxListeners() to increase limit.\nTrace\n    at process.addListener (events.js:160:15)\n    at process.on.process.addListener (node.js:802:26)\n    at module.exports (/home/admin/web/lambda.local/public_html/node_modules/critical/node_modules/penthouse/lib/index.js:69:13)\n    at tryCatcher (/home/admin/web/lambda.local/public_html/node_modules/critical/node_modules/bluebird/js/main/util.js:24:31)\n    at ret (eval at <anonymous> (/home/admin/web/lambda.local/public_html/node_modules/critical/node_modules/bluebird/js/main/promisify.js:154:12), <anonymous>:12:39)\n    at /home/admin/web/lambda.local/public_html/node_modules/critical/index.js:167:20\n    at tryCatcher (/home/admin/web/lambda.local/public_html/node_modules/critical/node_modules/bluebird/js/main/util.js:24:31)\n    at Promise._settlePromiseFromHandler (/home/admin/web/lambda.local/public_html/node_modules/critical/node_modules/bluebird/js/main/promise.js:454:31)\n    at Promise._settlePromiseAt (/home/admin/web/lambda.local/public_html/node_modules/critical/node_modules/bluebird/js/main/promise.js:530:18)\n    at Async._drainQueue (/home/admin/web/lambda.local/public_html/node_modules/critical/node_modules/bluebird/js/main/async.js:182:12)\n    at Async._drainQueues (/home/admin/web/lambda.local/public_html/node_modules/critical/node_modules/bluebird/js/main/async.js:187:10)\n    at Async.drainQueues (/home/admin/web/lambda.local/public_html/node_modules/critical/node_modules/bluebird/js/main/async.js:15:14)\n    at process._tickCallback (node.js:448:13)\n. I am getting the same error in my build.\nTypeError: Bad argument\n    at TypeError (native)\n    at ChildProcess.spawn (internal/child_process.js:278:26)\n    at exports.spawn (child_process.js:367:9)\n    at generateCriticalCss (REMOVED/node_modules/penthouse/lib/index.js:102:10)\n    at process._tickCallback (internal/process/next_tick.js:103:7). ",
    "marcustisater": "+1 would love to use this in a WordPress project. \n. ",
    "micahblu": "Also using the nearly exact first sample config I get a node error:\npath.js:360\n        throw new TypeError('Arguments to path.join must be strings');\nFrom the following sample config:\n``` js\nvar gulp = require('gulp');\nvar critical = require('critical');\ngulp.task('critical', function() {\ncritical.generateInline({\n    // Your base directory\n    base: 'dist/',\n\n    // HTML source\n    src: 'index.html',\n\n    // Viewport width\n    width: 320,\n\n    // Viewport height\n    height: 480,\n\n    // Target for final HTML output\n    htmlTarget: 'index-critical.html',\n\n    // Target for generated critical-path CSS (which we inline)\n    styleTarget: 'stylesheets/styles.css',\n\n    // Minify critical-path CSS when inlining\n    minify: true\n});\n\n});\n```\n. @addyosmani Thanks for the quick reply! I actually resolved the other issues. I have however run into a new issue seemingly with one of the dependencies dealing with CSS background images. Below are the errors generated:\nbash\nfs.js:432\n  return binding.open(pathModule._makeLong(path), stringToFlags(flags), mode);\n                 ^\nError: ENOENT, no such file or directory 'stylesheets/chosen-sprite.png'\n    at Object.fs.openSync (fs.js:432:18)\n    at Object.fs.readFileSync (fs.js:286:15)\n    at /var/www/html/WireCash-website/node_modules/critical/node_modules/imageinliner/src/image.js:60:28\n    at Array.map (native)\n    at inlineImages (/var/www/html/WireCash-website/node_modules/critical/node_modules/imageinliner/src/image.js:48:36)\n    at module.exports (/var/www/html/WireCash-website/node_modules/critical/node_modules/imageinliner/src/image.js:90:12)\n    at inlineDeclarations (/var/www/html/WireCash-website/node_modules/critical/node_modules/imageinliner/src/inliner.js:64:37)\n    at /var/www/html/WireCash-website/node_modules/critical/node_modules/imageinliner/src/inliner.js:94:9\n    at Array.forEach (native)\n    at Function._.each._.forEach (/var/www/html/WireCash-website/node_modules/critical/node_modules/imageinliner/node_modules/underscore/underscore.js:79:11)\nThe image file in question is there? perhaps the relative path is off?\nI'll keep digging in to see if there's something amiss on my end and I appreciate your help.\n. Here's a setup I have that illustrates the errors I'm getting:\nhttps://github.com/micahblu/critical-test\njust run npm install then gulp critical\n. @addyosmani I've found and corrected the bug here. The issue was with imageinliner not receiving the proper directory path from var dir = path.dirname(href); at line 26 in inline-style.js. This only reflects the current directory and not nested ones. I corrected the issue by utilizing a base var already setup so the current fix I have is:\nvar dir = base + path.dirname(href);\nIf you'd like I could submit a pr with the fix. Critical is now working splendidly! A much needed tool, thanks for making it.\n. Hi @addyosmani thanks for the merge, happy to help. I don't believe we have fixed this particular issue. I have a fix and I'll do my best to explain.\nThere are actually two issues here. The first is that there is not an option to set a max image file size for in-lined images. Google page speed kept complaining about prioritizing my atf content and I found that it was indeed an in-lined background image causes this. So I built in an option to set the max file image size and once I did that I was able to skip images that were too large and keep round trips for atf content to a minimum. Google was happy.\nHowever in doing this I re-encountered this #24 issue which is that in the event images are not in-lined, the relative css paths are no longer referencing the proper paths. To be clear I am speaking of fonts and images paths which are not being in-lined by image inliner. My previous pr gave the image inliner module the proper path to work with it so it could inline those images but does nothing to workout the new relative paths for these resources once their in-lined into a html file that is outside the root css dir.\nSo for example If I have a stylesheet located at root/stylesheets/styles.css and an image directory at root/img/\nThen the following styling rule will fail to locate the proper image path once in-lined, assuming the html file is not in the stylesheets dir..\nbackground: url(../img/mypic.jpg);\nIt would also fail even if img folder was in the stylesheets dir and we had\nbackground: url(img/mypic.jpg);\nWhen referenced from let's say root/index.html those paths are not valid. The behavior is the same for fonts.\nI have written a fix for this which, essentially re-bases the relative path based on the base path set by configuration or cwd.\nI'll shoot over a pr after I set up some tests\n. Surely: https://github.com/micahblu/critical-test, git clone, npm install, gulp critial, you'll see generated errors when attempting to source a relative image file\n. Should not only the critical path styles be in-lined, then once the doc is loaded a link tag is appended to the doc with the full stylesheet as Google's css optimization example demonstrates? \nhttps://developers.google.com/speed/docs/insights/OptimizeCSSDelivery#example\nSince the critical css is already generated before inline-styles is invoked, it could easily be used by it. Currently it grabs the entire css string from the link tag from within the htmlTarget. Is this intended and I'm not understanding the proper workflow?\n. Hey Addy, just checking in to see if there's something amiss with this pull request?\n. Is anyone working on this?\n. Will do this weekend. Thanks for the quick response\n. I'm getting an error trying to implement this. Also it might be a good idea to put up example usage in the readme. \nI have the following gulpfile.js\n``` js\nvar gulp = require('gulp'),\n    critical = require('critical'),\n    fs = require('fs');\ngulp.task('critical', function () {\n  gulp.src('dist/*/.html')\n    .pipe(critical({\n        base: 'dist/',\n        css: ['dist/stylesheets/styles.css']\n    }))\n    .pipe(gulp.dest('dist'));\n});\n```\nand I'm getting the following error:\nshell\n[15:14:09] Starting 'critical'...\n[15:14:09] 'critical' errored after 6.95 ms\n[15:14:09] TypeError: object is not a function\n    at Gulp.<anonymous> (/Users/micahblu/Projects/WireCash-Website/gulpfile.js:8:11)\n    at module.exports (/Users/micahblu/Projects/WireCash-Website/node_modules/gulp/node_modules/orchestrator/lib/runTask.js:34:7)\n    at Gulp.Orchestrator._runTask (/Users/micahblu/Projects/WireCash-Website/node_modules/gulp/node_modules/orchestrator/index.js:273:3)\n    at Gulp.Orchestrator._runStep (/Users/micahblu/Projects/WireCash-Website/node_modules/gulp/node_modules/orchestrator/index.js:214:10)\n    at Gulp.Orchestrator.start (/Users/micahblu/Projects/WireCash-Website/node_modules/gulp/node_modules/orchestrator/index.js:134:8)\n    at /usr/local/lib/node_modules/gulp/bin/gulp.js:121:20\n    at process._tickCallback (node.js:419:13)\n    at Function.Module.runMain (module.js:499:11)\n    at startup (node.js:119:16)\n    at node.js:906:3\n. @bezoerb thanks for the quick reply, I had noticed that I was missing the .stream after I commented, I have added it, unfortunately the error persists.\ngulpfile is now:\n``` js\nvar gulp = require('gulp'),\n    critical = require('critical').stream,\n    fs = require('fs');\n// Generate & Inline Critical-path CSS\ngulp.task('critical', function () {\n    return gulp.src('dist/*/.html')\n        .pipe(critical({base: 'dist/',css: ['dist/stylesheets/styles.css']}))\n        .pipe(gulp.dest('dist'));\n});\n```\nerror is:\nshell\n[15:25:28] Starting 'critical'...\n[15:25:28] 'critical' errored after 6.12 ms\n[15:25:28] TypeError: undefined is not a function\n    at Gulp.<anonymous> (/Users/micahblu/Projects/WireCash-Website/gulpfile.js:10:15)\n    at module.exports (/Users/micahblu/Projects/WireCash-Website/node_modules/gulp/node_modules/orchestrator/lib/runTask.js:34:7)\n    at Gulp.Orchestrator._runTask (/Users/micahblu/Projects/WireCash-Website/node_modules/gulp/node_modules/orchestrator/index.js:273:3)\n    at Gulp.Orchestrator._runStep (/Users/micahblu/Projects/WireCash-Website/node_modules/gulp/node_modules/orchestrator/index.js:214:10)\n    at Gulp.Orchestrator.start (/Users/micahblu/Projects/WireCash-Website/node_modules/gulp/node_modules/orchestrator/index.js:134:8)\n    at /usr/local/lib/node_modules/gulp/bin/gulp.js:121:20\n    at process._tickCallback (node.js:419:13)\n    at Function.Module.runMain (module.js:499:11)\n    at startup (node.js:119:16)\n    at node.js:906:3\n. I have found that critical is undefined when .stream is added. I'm not that familiar with node streams so I'm unsure why that is happening. When I remove the .stream the critical object is restored\n. @bezoerb looks like the stream export is missing in index.js?\n. I am not! lol that would explain it.. +10 to get this merged to master asap. Thanks @bezoerb :)\nWorks, though I am getting some warnings:\nshell\nnode) warning: possible EventEmitter memory leak detected. 11 listeners added. Use emitter.setMaxListeners() to increase limit.\nTrace\n    at process.addListener (events.js:160:15)\n    at process.on.process.addListener (node.js:773:26)\n    at module.exports (/Users/micahblu/Projects/WireCash-Website/node_modules/critical/node_modules/penthouse/lib/index.js:69:13)\n    at tryCatcher (/Users/micahblu/Projects/WireCash-Website/node_modules/critical/node_modules/bluebird/js/main/util.js:24:31)\n    at ret (eval at <anonymous> (/Users/micahblu/Projects/WireCash-Website/node_modules/critical/node_modules/bluebird/js/main/promisify.js:154:12), <anonymous>:12:39)\n    at /Users/micahblu/Projects/WireCash-Website/node_modules/critical/index.js:167:20\n    at tryCatcher (/Users/micahblu/Projects/WireCash-Website/node_modules/critical/node_modules/bluebird/js/main/util.js:24:31)\n    at Promise._settlePromiseFromHandler (/Users/micahblu/Projects/WireCash-Website/node_modules/critical/node_modules/bluebird/js/main/promise.js:454:31)\n    at Promise._settlePromiseAt (/Users/micahblu/Projects/WireCash-Website/node_modules/critical/node_modules/bluebird/js/main/promise.js:530:18)\n    at Async._drainQueue (/Users/micahblu/Projects/WireCash-Website/node_modules/critical/node_modules/bluebird/js/main/async.js:84:12)\n    at Async._drainQueues (/Users/micahblu/Projects/WireCash-Website/node_modules/critical/node_modules/bluebird/js/main/async.js:89:10)\n    at Async.drainQueues (/Users/micahblu/Projects/WireCash-Website/node_modules/critical/node_modules/bluebird/js/main/async.js:14:14)\n    at process._tickCallback (node.js:419:13)\n. I upgraded to the latest version of node v5.4.1 and still the issue however the error trace is a bit different:\n(node) warning: possible EventEmitter memory leak detected. 11 SIGTERM listeners added. Use emitter.setMaxListeners() to increase limit.\nTrace\n    at process.addListener (events.js:239:17)\n    at module.exports (/home/micah/Projects/wirecashwebsite/node_modules/penthouse/lib/index.js:77:13)\n    at tryCatcher (/home/micah/Projects/wirecashwebsite/node_modules/bluebird/js/main/util.js:26:23)\n    at ret (eval at <anonymous> (/home/micah/Projects/wirecashwebsite/node_modules/bluebird/js/main/promisify.js:163:12), <anonymous>:13:39)\n    at /home/micah/Projects/wirecashwebsite/node_modules/critical/lib/core.js:166:20\n    at tryCatcher (/home/micah/Projects/wirecashwebsite/node_modules/bluebird/js/main/util.js:26:23)\n    at Promise._settlePromiseFromHandler (/home/micah/Projects/wirecashwebsite/node_modules/bluebird/js/main/promise.js:507:31)\n    at Promise._settlePromiseAt (/home/micah/Projects/wirecashwebsite/node_modules/bluebird/js/main/promise.js:581:18)\n    at Async._drainQueue (/home/micah/Projects/wirecashwebsite/node_modules/bluebird/js/main/async.js:128:12)\n    at Async._drainQueues (/home/micah/Projects/wirecashwebsite/node_modules/bluebird/js/main/async.js:133:10)\n    at Immediate.Async.drainQueues [as _onImmediate] (/home/micah/Projects/wirecashwebsite/node_modules/bluebird/js/main/async.js:15:14)\n    at processImmediate [as _immediateCallback] (timers.js:383:17)\n. @bezoerb I'm going to close this for now as it only appears to be happening on my ubuntu machine? I've tried the task on several other machines and was unable to recreate the issue. Thanks for the quick reply.\n. One of the biggest issues here is the silent fail. I use critical.stream and have also gotten the dreaded fatal undefined. I am able to retrieve the actual error by adding console.log(err) in index.js @ line 195 inside the if(err) condition. I woudl think the line above: return cb(new PluginError('critical', err.message)); would console out the error but it does not. I think this may be an error with gulp itself. Regardless critical should fall back on console.log to ensure errors are properly displayed.. Thanks @bezoerb . @bezoerb I agree. The recommended size from the imageinliner repo is 10240, which works out pretty well, I could jot that in. Also I'd like to point out that this merge also address issue #24.\n. ",
    "dstroot": "Also seeing this with inlined images? \nreturn binding.open(pathModule._makeLong(path), stringToFlags(flags), mode);\n                 ^\nError: ENOENT, no such file or directory '_site/assets/css/data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAABCAYAAACsXeyTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAFUlEQVQIHWNIS0sr/v/PwMMDzY+ADqMahlW4J91AAAAAElFTkSuQmCC'\n. ",
    "jhbruhn": "I am having the same problems, CSS images are not working for me. I can't provide a demo, but can confirm that images do not work.\n. ",
    "iamskok": "@addyosmani Thanks for the explanation, but I'm looking for something like @bezoerb suggested, though I think that both variants need to be supported and will be useful.\nAnd the other question is how will critical handle stripping styles out from styleTarget when the actual inlined css will be different for each html source file? Can you please provide some more details on what's going on behind the scenes. \n. ",
    "justinmusgrove": "I just ran across critical and tested against a single page, good work folks. My next step was to run against all of my pages and appears discussion is in the works to support it. To give a little context, I have a static site built with Jekyll that I wrap the build process with grunt as it is easier to manage profiles and post processing items such as concatenation of css & js, html minifications, etc. My next step was to add critical to grunt prod as a post build task. \nhtmlmin has a similar feature where you can specify a src and destination in which you want to target. Since Jekyll output directory is \u2018_site\u2019 all I want to do is run the process against the files replacing the existing ones, it looks something like this in the htmlmin config: \nfiles: [{\n  expand: true,\n  dot: false,\n  cwd: \"_site\",\n  dest: \"_site\",\n  src: \"**/*.html\"\n}]\nLet me know if you need help testing. Thanks, Justin\n. ",
    "frankwaalkens": "This solution won't work when using absolute paths to my files on the server. (we use .cshtml files).\n. Src with multiple files on the server won't work for me since you guys implemented multiple src files with: src: [*.html].\n. ",
    "kretzm": "Would love to see this implemented!\n. ",
    "bevacqua": "Pulled! https://github.com/bezoerb/inline-critical/pull/3\n. safe*\n. ",
    "pocketjoso": "Hey guys, looks like you already shipped this, but just wanted to sanity check this feature:\nIs it safe for you to remove the critical css from original stylesheets? Wouldn't you stand without necessary CSS if you remove something that's critical on one page, but non-critical on the next? Or do you only remove css that's critical on every page?\nAnd regardless of whether it's safe or not.. Don't you want to rely on the cached CSS as soon as you can? If you refresh the same page, you should hit the cache, and ideally no critical css should be served (because it's no longer needed). If you extract the critical css however, you'll never be able to rely on the cached css...\nDidn't realise you were having this discussion, but I get this question from time to time on Penthouse, and my answer is as above - no, it doesn't make sense to extract the critical css. Am I missing something?\n. @bezoerb If you're removing it per page, aren't you then making each page's full css unique? Meaning you can't rely on cache?\n\nwhen you're serving a site with different critical css on each page. \n\nWhat site does not have different critical css on each page?\n. They still have multiple accessible URLs, which you could start at (in most cases).. \nBut I see what you're saying now. If you're only concerned with SPA's with a single page refresh, then what Im talking about becomes less of a problem. You would only be able to provide critical css for one page though, which is not ideal.\nSo I wonder now, is it really Critical's position to only be supporting SPA's with no page refreshes, and with only one entry page? @addyosmani ? \nThe benefits of removing the critical css from the full css are really minimal. But in doing so Crtitical has become useless for anything but the case with single refresh SPA's with one entry page. \nAm I missing something?\n. Okay, that makes all makes sense. I agree that some info on this in the readme would be a good solution.\n. Resolved in Penthouse 0.2.53.\n. @samccone could I get one of the URLs you needed this fix for? Just want to check if there's something Penthouse can do better. Cheers \n. @samccone Hmm. I just generated critical CSS for that page using Penthouse, and it renders perfectly across all viewports on Chrome iOS (for me)...\n. @samccone Is the invalid background value 'orange' intentional? Or should it be orange?\n. :)\nWhat does the test case demonstrate? That if you generate the critical css at a dimension lower than what you subsequently use it for, it will not have the necessary rules? If that's not obvious from the documentation here in critical, as well as in Penthouse, then we should improve on that - but it's absolutely expected. That's why we say to use a large dimension, as it will more or less always work for smaller screen sizes (but not the other way around).\nIf you want a test that \"breaks\", all you have to do is to use absolute positioning to lift something from below the fold (on the dimensions tested) to above the fold for a smaller screen size. \nWhat am I missing? \n. If that answer was a bit brief:\nMy original intention when writing Penthouse was to generate critical css for multiple breakpoints and then merge them. I just found that it was virtually never needed, so I dropped those plans. If there is a decent case for that, I might add it directly to Penthouse.\n. I just looked and saw that critical unfortunately uses rather mobile looking dimensions, 480x320, in all examples - meaning that everyone who just copy pastes those snippets will end up with critical css that doesn't handle elements that don't show up in the smaller viewport specified... I think this should change, so I opened an issue for that: #69.\nI wonder of that relates to the issues you are talking about @samccone ?\n. As long as it's optional I don't really think it's harmful - but I still haven't seen any case where it's needed? For the problem you've described so far:\n\nI want to generate a snap across multiple device resolutions.\n\nAll you have to do is to specify the largest dimension you want it to work for, and it will work for all lower dimensions. That is, for the url you pointed to, and in the test case. If you have cases that are different, I'm still very keen to hear about them!\n. > We legitimately want the site to look nice on mobile and large screen sites without a weird jump while using critical.\nOf course I understand that. I would not deploy critical css on my site that produced a flash of unstyled content - that's probably worse of a perceived performance issue than the slower load!\n. The expected files (css, html) generated for me by critical (on OSX) all got different whitespace formatting than the ones in there previously. I hope you don't mind about this. If you care to review the changes in these files, ?w=1 is your best friend (although doesn't help for the newlines..)\n. I pushed a new patch yesterday for penthouse to keep critical animation declarations and @keyframes - 0.9.10.\nIf you manually remove your installed penthouse/critical folder in your node_modules (depending on whether you are on npm@3 or lower) and then re-do npm install you should get the latest penthouse version, with this fix.\nLet me know if that solves your issues (not sure it will solve all of them, but least keyframes should remain, if they are critical).\n. If I understand you correctly the issue should be handled by Penthouse, and is already raised here: https://github.com/pocketjoso/penthouse/issues/58\nI haven't had time to get around to it yet, but hopefully will next weekend if not sooner.\n. @bezoerb This should be resolved in Penthouse 0.3.4.\n. > Unsafe JavaScript attempt to access frame with...\nAh I see, that's a different error.\nIt's still for Penthouse to handle; I'll re-open the issue https://github.com/pocketjoso/penthouse/issues/58.\n. @raphaelgoetter Since I can't reproduce these errors reliably, do you reckon you could test the fix I have in mind locally on your machine?\nOpen node_modules/penthouse/lib/config.json and add two lines:\n\"localToRemoteUrlAccessEnabled\": true,\n\"webSecurityEnabled\": false\nIf you can report back whether that resolves your issues, then if it does I will merge that fix into Penthouse (which will then come to critical).\n. @raphaelgoetter Thanks for testing that. I will go with another solution then, I hope I can finish that today, but can't promise so. Will post here when I have it ready.\n. @bezoerb You're right, Penthouse so far doesn't parse media queries other than for the purpose of removing empty ones.\n@raphaelgoetter Can you open an issue in Penthouse and I'll try to get something in this weekend?\n. Opened an issue: https://github.com/pocketjoso/penthouse/issues/67\n. @raphaelgoetter No rush, it's not going to be resolved overly quickly on Penthouse's side anyway.\n. I'll add this functionality to Penthouse now, will have a new release with a fix for it later today.\n. Unmatched media queries are now removes as per Penthouse@0.7.0\n. @vlrprbttst You could use of Penthouse, create critical css for each page, and then inline if yourself via php. That's what I've been doing for my own site, with this kind of code in a php header file:\nif (file_exists($critcssfile)) {\n    <style><?php include($critcssfile);?></style>\n...\n}\nFor convenience I just named my critical css exactly the same as each php file, just with an extra .css extension, so f.e. about.php.css.\n. Someone else asked me the same question so I created a gist for this solution:\nhttps://gist.github.com/pocketjoso/58cb89ad9e69e4da297e\n. @vlrprbttst Critical uses Penthouse to generate critical css, so as long as you put in the same css you'll get exactly the same result.\nI always advice against extracting the critical css from the full css as I think there are only benefits to doing so in the majority of cases.\n. I think I misunderstood what you meant with extracting relevant css - you mean that the critical css is missing some rules that should be there? Please open an issue on the Penthouse repo with some more details and I'll look into it!\n. This is due to how Penthouse deals with invalid css. Could you please raise the issue there and I'll respond to it?\nCheers,\nJonas\n. You could always add process.setMaxListeners(0) in your code, which will mute this warning.\nNot sure why critical itself is leaking though.\n. What about:\nhttps://jonassebastianohlsson.com/criticalpathcssgenerator/\nhttps://criticalcss.com\n(doesn't do exactly the same thing as critical, but similar)\n. typography.com don't allow scraping of their stylesheets due to their licensing.\nI presume critical needs to be updated to handle this. My own quick and dirty solution for the same problem for another project:\nfetch(urlThatMightReturn403)\n...\n.catch(function (e) {\n    if (e.message.toLowerCase() === 'forbidden') {\n      console.log('ignoring forbidden css', cssUrl)\n      return ''\n    }\n. If you want to wait for both of these two stylesheets to load before applying them, my suggestion would be to concatenate them into one stylesheet.\n. Fixed in 0.9.12 - thanks @bezoerb !\n. Will have a look at it, thanks @XhmikosR.\n. @herrkessler this is indeed an phantomjs issue, via penthouse. If you post an issue there and find a way to share the css you're using with me (either link from issue), or send it in private message to me, then I can debug further.. @YewTreeWeb Something must have gone wrong in your install step. The missing config file is here.. Regarding the install error, I just fixed a (new) bug with the missing config.json file in 0.11.11 - so if you re-install criticial/penthouse you should get the fix for this problem.. @kenshaw It would be a Penthouse problem; Penthouse is what generates the critical css. I'll give it a try.. .. although I notice that what you've posted is not html. Isn't that causing problems? I'm not completely up to date to if critical does any preprocessing to transpile certain template languages to html.. I can confirm that something causes the .card rule(s) to go missing in the critical css given by Penthouse. Looking into why that's the case.. So it's an issue with the minified bootstrap css and the AST parser Penthouse uses (this one, you can see the problem here:\nhttp://iamdustan.com/reworkcss_ast_explorer/#/e8Tdpm7KWq/1\n\nThe .card rule, and a lot of other rules, are being swallowed by a base64 background-image url declaration value.\n\n@kenshaw : Hmm. If you were using Penthouse directly you could fix this problem for yourself by unminifying the full css before calling Penthouse... However using critical you don't really have this option... yet.\n@bezoerb and other critical maintainers: I have found no better fix in Penthouse for this type of problem than unminifying the full css, however I don't want to bake unminification into the Penthouse library. I want to keep the scope of Penthouse  small, and Penthouse was meant to be used in a build step, on pre-production css, so this problem should be less common for pure Penthouse users.\nSince critical works directly with html files however, it seems more likely that users will show up with minified css assets. Could you start unminifying the css before calling Penthouse (unminifyCss: true)? This type of AST parsing problem is not very common, but there are some valid base64 declaration values that cause problems. I am also looking in parallel for a more forgiving AST parser, in case you know one.. This (incorrect parsing of original css, especially when containing errors) has been resolved in the latest  (1.2) version of Penthouse - https://github.com/pocketjoso/penthouse/releases/tag/v1.2.0.\n@bezoerb @addyosmani Would be great to see an upgrade pushed out.. @midzer The online generator is on the latest penthouse version - critical is not. I presume this is the culprit. With the latest penthouse version no more hacks are needed to get around CSS parsing issues.\nFriendly ping @bezoerb for a release update - did you try the latest Penthouse version (1.3, although the majority of Penthouse became fault tolerant in 1,2)? If you encountered any issues, please let me know. If there was just no time available to test it yet then I fully understand!. Thanks for the update!\nOn Mon, Jan 8, 2018 at 11:24 PM, Ben Z\u00f6rb notifications@github.com wrote:\n\nThanks for the ping @pocketjoso https://github.com/pocketjoso :)\nI already worked on the dependency update in the bump-dependencies\nhttps://github.com/addyosmani/critical/tree/bump-dependencies branch.\nUnfortunately i'm randomly running in some ECONNRESET errors\nhttps://travis-ci.org/addyosmani/critical/builds/319980576 and i\nhaven't yet figured out what's causing them.\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly, view it on GitHub\nhttps://github.com/addyosmani/critical/issues/181#issuecomment-356116073,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AG3BANdB41k7QF_Yy1x1_PnBuQDk4pTBks5tIpWPgaJpZM4LDOg_\n.\n\n\n-- \nhttps://jonassebastianohlsson.com http://jonassebastianohlsson.com\n@pocketjoso http://twitter.com/pocketjoso\n. @midzer Critical is currently using the latest version pf Penthouse, just as my online generator. Hence if you have a difference it should be related to the input - that critical for some reason is not seeing the original css containing these styles. Are these styles coming from a separate source than the ones that are kept?. Hmm but then you really should get the same critical styles from critical\nas from the online generator. Are you sure these styles are critical -\nshown in the critical viewing for the first render (before js)?\nLe sam. 31 mars 2018 21:23, midzer notifications@github.com a \u00e9crit :\n\n@pocketjoso https://github.com/pocketjoso Thx for your reply\nAll styles are located in main.min.css. Specifying this file in css\nparameter makes no difference either.\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly, view it on GitHub\nhttps://github.com/addyosmani/critical/issues/181#issuecomment-377717005,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AG3BAFV1lnSzWuNZfMr417YGaQtkKOD7ks5tj9e-gaJpZM4LDOg_\n.\n. @midzer Tip: the comparison is much easier to understand if your unminify the css first.\n\nSo it looks to me that somehow you are feeding the wrong html/url into critical. That would explain why the page it is looking at is not what you think it is, not containing the content you think, and hence why you get a different critical css.\nSo can you double check your critical setup, and maybe try with a completely different url? I suspect this is the problem on your end.. How do you know these resources have not loaded?\nThe page should already be fully loaded without any wait timing at all. I\nmeant to remove that timing value from Penthouse, but someone had a\nspecific use case for it.\nOn 8 Dec 2016 23:26, \"Micah Blu\" notifications@github.com wrote:\n\nThe minimal wait time of 100ms is causing pages to fail by not allowing\nenough rendering time for pages with moderate to heavy resources, mostly\nbeing images.\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/addyosmani/critical/issues/183, or mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AG3BAJdpeiZzsMcuR6n8BiKgWQhaiPxUks5rGIP8gaJpZM4LIW1T\n.\n. @borisirota Penthouse intentionally filters out psuedo selectors that require user interaction, i.e. :active, :focus, :hover, in order to keep the critical css as small as possible.\n\n:visited should be kept, but I see that it currently isn't. Can you please create an issue for this on the Penthouse repo?. Yes - it's removed here.\nThe idea is that the first render is static - user initiated animations get activated when full css & js loads.\n@SergeyYermak - Do you have a use case where it would be relevant for the critical css to contain properties? Remember that these properties will arrive when the full css loads.. @SergeyYermak What initiates the slide effect normally? Page opening doesn't trigger any css transitions, you must be adding a class or similar, with js?. Critical css is for the first render, which happens before JS. The smaller the critical css the faster the first render can happen, hence why measures like the removal of transition properties are taken.\nThat being said, we don't want to break anyone's site. The issue in your case must be that your JS loads before your full css, hence initiating this supposed animation before the supporting (read: full) CSS is there.\nMy general advise here would be to use a @keyframe animation instead of transition for this effect. A @keyframe animation can happen as soon as the (critical) css loads, without the help of any Javascript (so much sooner) - and is for this reason not removed from critical css. If you're really keen on keeping your code as it is, I'm open for a PR for Penthouse to override the default properties (pattern) array for what properties to remove.. @libertarismus One potential reasons for these issues could be if your css contains errors. This can throw off the CSS parser (of Penthouse, which is responsible for generating the critical css). Are you linting your CSS at all?. Jacob, Penthouse, the library doing the critical css generation, checks the top of the getBoundingClientRect for each element, not the bottom, so there must be something else going on in your case.\nDo you lint your styles? Errors in the original css is known to sometimes throw of the css parser that's being used, causing missing styles.. Penthouse has blockJSRequests:true as a default, so thats' what you're seeing. Critical css is used for the first render before Javascript has even been requested, so styles for elements inserted via javascript should not be included in the critical css. By the time the page loads your full CSS should already be loaded, and will hence provide the style for such elements.. My only hunch about these errors are that they could be related to the blocking fs.read/writeFileSync calls currently inside Penthouse; that phantomjs somehow doesn't handle that well. I haven't had time to try this hypothesis though.. @teodragovic this is due to an upstream issue in Puppeteer - but I just published a new penthouse version (1.1.4) that downgrades puppeteer to avoid this issue. Please reset your penthouse module (how depends on your package manager, but you can f.e. uninstall critical and install it again) - and re-test - should work again.. I should have been more clear: the issue I'm referring to have only been there the last few days, so if you had an issue from before then it's unfortunately likely to still be there after this. Do try it though as you never now.. critical. Penthouse doesn't change any paths as it just receives css content without any file paths. https://criticalcss.com however (my paid service on top of penthouse) resolves paths correctly. :)\nBut yeah this must just be some bug in critical that hopefully shouldn't be too hard to fix - I have no insight into this code however.. @bezoerb cool! I think it would be great if we could discuss this together, to make sure Penthouse is used as efficiently as possible, and also to discover any potential changes in Penthouse that would help you. Can you send me an email, or DM on twitter (@pocketjoso)?. Just FYI I'm now looking to migrate Penthouse to headless chrome, so if you wait another ~ 2 weeks you can get this migration without any changes to critical, aside from a Penthouse version bump. \ud83d\udc4a . I have a headless chrome version of Penthouse with feature parity now, just fiddling with support for Linux etc - if you want to play with it it's available on the next tag (penthouse@next), currently as penthouse@rc-4. I will take some time before shipping this as latest.\n(penthouse) pr is here: https://github.com/pocketjoso/penthouse/pull/174. @phaistonian maybe you can just manually replace the penthouse lib in your node_modules with the one from penthouse@next - if you can get critical to run with it it will work out of the box, as I made the API backwards compatible.. @bezoerb @addyosmani and others:\nI will release Penthouse 1.0 this week (using chrome headless via Puppeteer); I've just been writing up a release blog post, and waiting for the Puppeteer team to close a few important bugs. \n1.0 will be backwards compatible (except for that Puppeteer requires Node>=6.4.0), so this means you can upgrade without changing a thing! (the reason for the major version bump is more to mark Penthouse as stable tech).\nI recommend taking advantage of some changes though:\n- Use cssString instead of css (filepath), to avoid unnecessary i/o.\n- Parallel execution now works, so you might want to utilise this better. Now concurrent penthouse calls get run in different tabs in chromium, rather than as separate browser instances, as was previously the case. This does not only make execution much faster, but also avoid cases where PhantomJS would occasionally just crash, even without hitting resource limits. Note that in the default settings the shared browser instance will get closed as soon as there is no pending call.\n- optional; perhaps not relevant for you - Penthouse 1.0 supports generating before/after screenshots (with/without critical css - in both cases the page rendered without JS), these can be used to increase confidence that the critical css is correct.\n- get rid of const penthouseAsync = Bluebird.promisify(penthouse), as Penthouse has been returning promises since 0.11.0\n- test using file:/// protocol for local files via Chrome headless - which hopefully works across platforms and hence can remove the need for critical to be [starting local servers for the generation])https://github.com/addyosmani/critical/blame/master/lib/core.js#L207)\nYou can check the readme from the chrome headless Penthouse PR; it is mostly up to date and I will fix the remaining this week.\nAs I've said before you can test this version on penthouse@next, but at this stage I've run it in production for more than a week and generated over 100,000 critical css files  - it's definitely in better shape in every way than the previous version of penthouse. . So this is when running a lot of invocations in sequence, am I right? not in parallel? I'll look into it - thanks for testing both of you!. @phaistonian Well the intention is to keep the browser instance running, to save some time and resources, but it currently closes as soon as the puppeteer task finishes - so before the next call happens when you run them in sequence. Sounds like there's some timing issue when the two calls happen close after each other (but not in parallel).. So for full transparency @addyosmani, as I will disclose in the release post for Penthouse 1.0 (perhaps you know this already) - all my work on Penthouse is pretty much \"funded\" via the premium SASS service I built on top (https://criticalcss.com), which has been using image diffing since the start. It's also from where I've found most of the issues in Penthouse, and got the confidence that Penthouse works well, since it's used really heavily there. Will post another blog post about criticalcss.com too soon and my story about a successful open source revenue model for a \"side project\". :). And @addyosmani re sitting next to the Puppeteer team - that's awesome! You already found the most critical issue on my list (https://github.com/GoogleChrome/puppeteer/issues/662).\n~~I have nothing else critical that I've already opened issues for, but other things on my mind are:~~\n~~- problems with thrown errors such as the ones making critical's tests fail - but I need to take a closer look my self on this first to see whether it's something I can fix in Penthouse. There are fewer such thrown errors since the commits after 0.10.2 (specifically since https://github.com/GoogleChrome/puppeteer/commit/e5c17eecb93b995c78515e8b1b0df13c392efd8e), but...~~\n~~.. it also seems to me that there's been some performance regressions in Puppeteer since 0.10.2, at least how I use it (with JS disabled). On average my puppeteer execution now seems at least about 1s slower (from about 10s to 12s) - but I have not isolated the cause (exact commit) for this yet hence why I haven't raised an issue in Puppeteer yet. It is possible, but unlikely, that the regression did not come from a change in Puppeteer.~~\nUpdate: after debugging this today I found and resolved these regressions on my end - they were not coming from Puppeteer. \ud83d\udc4d \n\nI also understand that Puppeteer have other priorities than making execution as fast as possible with JS disabled, so hey perhaps this is known and intentional. All in all Chrome headless is lightyears faster than PhantomJS anyway. :)\n. Finally @addyosmani I have been thinking about backwards compatibility, and the return value of Penthouse, per the discussion we had in London a while ago. I considered breaking the api to return an object with both the critical css and debug/error info as you asked for back then, but for this release I'm almost sold on going for compatibility, so I can get maximum adaptation as the release is just so much better than the current version.. Update: Just published penthouse@1.0.0-rc14 which fixes the bug with target closed errors as reported by @phaistonian in https://github.com/addyosmani/critical/issues/229#issuecomment-329372102.\nDoing final sanity testings, preparing to merge this into the Penthouse master branch for 1.0 version. However in addition to the release post I'm writing I also need to make sure Penthouse's README is up to date - so not sure I will manage to finish this tonight, let's see.\n@addyosmani and @bezoerb - I added 2 more points re changes critical should take up when adopting this new penthouse version (no need to promisify, and should be able to skip starting local servers for local files): https://github.com/addyosmani/critical/issues/229#issuecomment-329296574\n. @reznord pushed one more commit that prevents rejecting the returned promise when Penthouse is called in callback mode - have not pushed this to npm though as I'm hoping to merge to master (next) instead :).\nAnd in the bigger picture would be great for critical to start using the Promise based api instead.. \ud83c\udf89 Penthouse 1.0 is here\ud83c\udf89: \nhttps://medium.com/@pocketjoso/penthouse-1-0-official-release-ece995b0d29e. @bezoerb yeah commented in Penthouse repo.. What node version are you on?\nSince penthouse started using generators (polyfilled to work for node 4 here, support for node version below 4 was dropped. Perhaps this is your issue?. Could you update to a newer node version and test - 7 perhaps?\nIf it still fails something has gone wrong during the installation, if so I would try removing critical (yarn/npm remove critical) and re-adding it.. Sure, just npm install or yarn add it.. Can you please paste the errors here?\nIt could also be worthwhile to remove and re-install all the node_modules, especially if you're using npm (and not yarn), as they can get into a corrupted state sometimes: rm -rf node_modules && npm install. Thanks for the feedback, will investigate.. @oskarrough the lockfile looks good now - but one of the AppVeyor test runs failed. It seems to me like an irrelevant intermittent failure, so it should work if we just retry it. I don't have admin access to restart from within the CI though - can you just push again? (you need to make a change first though, which you can do by rebasing on master, or dropping the last commit and just re-adding it again).. ```\nnpm install\n\nphantomjs-prebuilt@2.1.15 install C:\\projects\\critical\\node_modules\\penthouse\\node_modules\\phantomjs-prebuilt\nnode install.js\nmodule.js:327\n    throw err;\n    ^\nError: Cannot find module 'json-stable-stringify'\n    at Function.Module._resolveFilename (module.js:325:15)\n    at Function.Module._load (module.js:276:25)\n    at Module.require (module.js:353:17)\n    at require (internal/module.js:12:17)\n    at Object. (C:\\projects\\critical\\node_modules\\request\\node_modules\\har-validator\\node_modules\\ajv\\lib\\compile\\util.js:19:20)\n```\n\nOnly one Node 4, and only on the windows (appveyor) tests.\nThis problem looks completely unrelated to the code change you've made @oskarrough.\n@bezoerb Do you know anything about this?. Just FYI: Once a PR for #229 lands these problems should all go away.. @developer-lindner this is due to how Penthouse handles invalid original CSS (with syntax errors) - it runs it through a normalisation process that currently goes through Chrome which currently leads to all properties Chrome doesn't use being dropped.\nPenthouse can be run with strict: true to throw on CSS syntax errors, instead of doing the normalisation - but I don't think this flag is handled in critical. cc @bezoerb \n@developer-lindner If you could run your css through any kind of CSS linter, fix the problems, and run critical again, it should fix this issue for you.\n\nEven without any css fixes from your end, the display:flexrewrite should not happen once the work in #229 is done; updating to Penthouse 1.0 - as it uses a modern version of Chrome that does support the latest flex. I'm not 100% about this though; whether the property is still re-written like this in modern chrome (internally).. It has landed (last week), you can try it now!. As long as your site (and css) is going to stay this size, you can just inline the full css and not worry.. Yep probably.. @bezoerb would be nice for critical to output a warning when it's run with these incompatible settings. @BB-000 It's possible that the issue comes direct from Penthouse, the underlying critical css generating library. Would it be possible for you to retry using that library directly, and if you can reproduce the bug, raise an issue there instead/as well?. Can you try running directly towards Penthouse, and getting incorrect styles, opening an issue there instead? If the issue is coming from Penthouse, most likely you have errors in your original CSS, causing the AST parsing to fail. You can try posting your css into this AST explorer, on the CSS tab and ensure it can parse your css without any errors - or even better run your CSS through a css linter (I use stylelint) and fix the issue they raise.. More likely that the problem came from 1.0.0 than specifically 1.1.3 - but let's debug in penthouse repo.. Converts from what to what exactly?\nMight be because of Penthouse normalisation of your original css, if so this will be fixed (in Penthouse) sometime this week when this pr is merged: https://github.com/pocketjoso/penthouse/pull/209.. Yeah this comes from puppeteer. So far penthouse only mentions it in the readme here:\nhttps://github.com/pocketjoso/penthouse#not-working-on-linux\nFeel free to open a PR to expand on that section in the readme (in Penthouse).. @bezoerb It doesn't(fully)  minify the css, but the csstree parser that penthouse 1.2 started using does trim some whitespace when turning the ~ ast back into a string, so that's what you're seeing.\nYou should still minify on top of this to get the smallest possible critical css (especially if your minification process does more complex operations than just trimming whitespace, f.e. merging rules).. > [00:30:38] Protocol error (Runtime.callFunctionOn): Execution context was destroyed. undefined\nThis error is tracked in Penthouse and a fix for it is coming:\nhttps://github.com/pocketjoso/penthouse/issues/202#issuecomment-361909817\nIt happens when the page the critical css generation is working on issues a redirect to another page (~~ window.url = something else).. And just a friendly reminder from me that removing \"duplicated\" rules from the original css is in the majority of cases bad practice, as you no longer have a shared full stylesheet that the browser will cache and that will be re-used on later page loads.. If you server side render it, yes.. > It works even without server side rendering...\nNo.\nEven though critical (the package) might run without throwing any errors, and even return you a critical css - it is not of any use without (some kind of) server side rendering.\nCritical css is used to enable browsers to render your website before it has loaded CSS + JS, based purely on the initial HTML (i.e. what your server returns) and the critical css. If your HTML is empty, the first render with critical css will be blank, hence no better than not using critical css at all.\nGoogle's PageSpeed Insights has in my view been a major culprit as for why people have false conceptions about critical css, as it always just measured signals and never real performance (read more f.e. here), and would hence give thumbs up to things like non server side rendered react + critical css usage despite it making no difference for performance. With the recent update, even  PSI should show now more clearly show you the lack of real performance improvement of this type of critical css usage.\nYou don't have to do perfect server side rendering (identical rendering) but if do none, your performance efforts are better spent on something other than critical css.\n\nI'm trying to be helpful here so if there's any confusion about what I've written, please tell me! I might write up a blog post about this.\n. I think you should be able to change the default penthouse timeout from critical. The critical library accepts a penthouse options object, you can set it to: {timeout: 60000} to see if that resolves your issue.\nIf your still get timeouts, then something on your site seems to be causing Penthouse to hang. If so, can you share a public url that you are generating critical css for, and I can test it?. As I mentioned earlier, it's most likely one of two things that is happening.\nJob is really running out of time\nIf you are running critical/penthouse for lots of pages/urls/dimensions at the same time, then it's possible that your computer is just slowing down because too much execution is done in parallel. You can try reducing the number of critical css files you are trying to execute at the same time, and/or increasing the timeout.\nJob is hanging\nIn this case it's most likely something specific on the page that causes the problem. To help with this, I need the specific URL you are using so that I can debug.\n@danchukas I'm sorry, I think you replied to me before, but somehow I only got an email, and I didn't see your reply here.. It was mentioned that hertz.com causes timeouts like this in Penthouse. What causes the problem on hertz.com is this code in the html:\nhtml\n<meta HTTP-EQUIV=\"REFRESH\" content=\"0; url=/rentacar/errors/jsCookieErrorPage?nojs=true\">\nThis causes the page to unload during the critical css generation, which is not supported. In earlier versions of Penthouse this would cause penthouse to hang and thus timeouts, but this was changed in Penthouse@1.6.1, which the latest Critical version uses. Instead an error is thrown.\nWhat do do\n\nupgrade to the latest critical version\nif some urls still do not work, note down exactly which ones\nif you are getting the specific PAGE_UNLOADED_DURING_EXECUTION error, look for meta refresh tags and window.location assignments (i.e. page redirects)\nif you can't figure out what's going wrong, share url\n. 404 means there was no such file on the server. So this would normally mean it's a problem on your end (or the sites you're loading css from).. I see, then indeed it's a bug in critical.. Looks like this is the underlying issue:\n(Puppeteer doesn't run under WSL (Windows subsystem for Linux)\nhttps://github.com/GoogleChrome/puppeteer/issues/1837. Is it really showing at the top of the page before any javascript is executed? If so, then it would be a bug. Could you share a url for where this is happening?. Normally it should indeed be included in this scenario. This is really a Penthouse issue, but in either case - to debug I will need at least a public url for which this happens, or even better a reduced reproducable test case.. @dalimian I tried generating critical css for your site, and it looks fine:\n\n\nAre you referring to carousel controls not showing, or something else?\nThe critical css generation happens without any javascript running, as critical css is used before javascript has loaded in the browser. So any javascript injected content will not be styled by critical css.. There were big changes to the critical css generation in the 1.0 release, coming from Penthouse, the library responsible for the critical css generation. What is your url? I can take a look at what's going wrong.. No, I can test either version. The version without critical css implemented would be easier though.. Okay I just tested the critical css generation with the latest Penthouse verison - no problem there. As long as you don't have a configuration problem, your issue must be coming directly from critical itself. cc @bezoerb . @pachiraDIG can you expand, what do you mean with a \"class-based\" feature?. @pachiraDIG this doesn't make any sense to me, at least not for generating _critical _css - are you doing something completely different? Critical css is about showing what is in the viewport, for which you need to specify the dimensions.\nIn addition, if you're use case is just about filter your css based on classes, it's overkill to use critical (and penthouse), as it uses a Chrome browser and takes much more time than what it would take to just filter the css.. Well like I said before it is overkill using Critical and penthouse for your use case. Just use a css parser like css-tree (the one Penthouse uses) and filter out the rules you don't want. This execution time for this will be orders of magnitudes faster than using Penthouse (via Critical).. @jared-stilwell before critical can support this, penthouse, the underlying library has to add support. Please add an issue there (first check that there isn't already one, there might be). Cheers. @Genuifx if your SPA is server side rendered, i.e. html contains the same content as your SPA presents, then yes, it will work fine.\nIf you require Javascript to show content, then there's no point. Your first render, if you try to use critical css, will be blank (as JS has not loaded yet).. > @pocketjoso awesome! Does Critical use puppeteer to achieve it? if so, why not wait for js executing, it seems we can get the first render.\nThe idea with critical css is to make the first render happen directly after the HTML has been received - before JS is loaded. Hence when you depend on JS to render content, critical css makes no sense. You won't get any performance benefit from using it.\n(yes penthouse uses puppeteer, and yes it's easy to configure, but as I said makes no sense)\n\nAnother question is after using Critical to extract CSS if we need drop duplicate CSS from our app? Cause extracting stylesheet, in my opinion, just copies the CSS code to Style element. \n\nOnly the full stylesheet is cached and re-used on subsequent page visits. It needs to contain all styles.. I would rather suggest setting up a simple queue, like in this example:\nhttps://github.com/pocketjoso/penthouse/blob/master/examples/many-urls.js\n(you can probably run at least 5 jobs at the time in parallel - but of course it depends on your machine). Hi @sheerun,\nOf course the first call to action would ideally be to reduce the size of your full css, but I can understand if that's not feasible at least not as a quick solution.\nFor your workaround, first keep an eye on how big your page css is. If it's too large it will slow down your first render, if so it would make more sense to keep both a regular critical css (fast first render), then extract a full page css (quicker full css loaded), and finally also have the full css (cache styles for full site).\nHow to do this in critical: I think setting huge height is an acceptable workaround. Sure, a more proper feature support in the library could perform a different check for \"presence\" of different css selectors, but the end result should be the same. What your asking for is also quite an edge case, so if there's already a way you can achieve what you want, I think that might have to be enough. Did you try setting a high height?. The first render with critical css happens before Javascript is loaded, this is one of the reasons it can be fast. So no, the critical css will not style your dynamic content, your full css should do that.. > to inline critical css on page request\nThis is not a good idea. Generating critical css is too slow and too CPU intensive to do while serving requests. A critical css generation call fires up a Chromium browser to evaluate what css is critical for this page. Exactly how long execution takes depends on your site, but say 5s as a ballpark figure. Edit: if no external network requests are needed; everything comes via local html file with relative (local) asset links, then it will be less than 5s, but we're still talking too much time to block serving a request.\nIf you have static pages it makes much more sense to generate the critical css during build time.\nIf you really want to do it dynamically, I would separate the critical css generation from the serving of the page request; fire it off async, or add it to some kind of queue, maybe cron job. Then cache it, and serve it on the next matching request. In either case if you want to do this dynamically you have to cache aggressively, as it's just too expensive to re-compute for each request.. It's still present here.. I find it quite annoying to upgrade sub-dependencies with yarn... Normally enough to do: yarn remove penthouse && yarn add penthouse. (however will only work if penthouse is the only dep on this fork of css, which should be the case though). I think fixing this will fix the build problem.. yeah this is what I was fearing. I don't have any better method for this than to yarn remove all of them, re-adding all of them...\nYou could also go in and just paste the correct resolve url into the yarn file, but generally editing this file is yucky (since it's generated).. this should be the right value for that line though.. would love to have more info in this - to help you debug, and fix if there's a bug in penthouse!. In case the timing is right, I suspect I just fixed the bug you came across, here:\nhttps://github.com/pocketjoso/penthouse/pull/279\nIt's not yet published into latest for Penthouse, but should be in a few days. There's a release candidate that has the fix, if you want to test it sooner:\npenthouse@1.10.1-rc.. ",
    "justsee": "Cool - just noticed two minor things:\n- if inlineImages is false minification occurs even if minify is false.\n- formatting is a bit off from the standard two spaces in the rest of the project that I can see\n. ",
    "sondr3": "Yeah, I figured as much, but I looked quickly at the issues and couldn't see anything related to this and wanted to ask. I'll keep toying around :)\n. Wow, that's some really quick response. I'll try it again tomorrow morning, thanks a lot\n. ",
    "johanbuys": "I was having the same issue. \nMy issue was that the included phantomjs (node_modules/penthouse/node-modules/phanom/bin...) binary was not able to run, in my case it was due to dependencies of phantomjs not being resolved.\nOne quick thing to try, do you have phantomjs installed on the target system, while not needed, the dependancies are, see here: https://github.com/ariya/phantomjs/issues/10904\n'libfontconfig' was the culprit for me, \n     apt-get install libfontconfig\ndid the trick.\n. Hmm sorry guys, seems like there are still some issue. While the above was an issue for me because phantomjs was not running, it is crashing now. \nThe toString errors occur if no output was generated by phantom... So if phanotmjs is not able to run or it crashes it produces the same errors. I am running Ubuntu server 12. on 14 it works.\nI was able to get more output by calling critical with the callback function after the options: \ncritical({\n   //options\n   },function(err,out){\n        if(err)console.log(err);       \n    });\n. @bezoerb I first tested against my own code, then followed the gulp app tutorial, both times using npm to install.\nUbuntu 12.04 Server LTS, the issues happen, on server 14.04 it seems to work as expected. \n. Output was \nPhantom js exit code null\nand then the same toString errors on line 138. (as mentioned above that is to be expected as there is no test for the criticalcss object being non null and thus the subsequent calls to criticalcss.toString will fail. \nWhen I added the callback to print the error object I get the standard PhantomJs Crash output with dump file.\n. @addyosmani \nHi I just tried it, cloned the gulp tutorial and the master branch of critical and it worked. Then just for good measure installed the master branch into my old sample that was crashing and it's also working now.\nI must also just add, this maybe a coincidence but just for completeness sake, I also fixed up some permission issues I was having with npm (npm install as root) (I saw that Critical was installed in ~/.npm as root.)  Cause vs Causality?\n. ",
    "alfredbez": "43 fixed that bug already, try to install from master\nbash\nnpm install http://github.com/addyosmani/critical/tarball/master\n. npm ERR! Please check if you have git installed and in your PATH.\n@tchaecker try git --version\n. You've to add git to your PATH.\n- check where your git install is (something like \"C:\\Program Files (x86)\\Git\")\n- then add the bin directory to your PATH with the following command: set PATH=%PATH%;C:\\your\\path\\to\\git\\bin (e.g. set PATH=%PATH%;C:\\Program Files (x86)\\Git\\bin)\nYou can add git to your PATH during install process\n. @tchaecker Does the critical-directory exist in D:\\websites\\wskm\\aip\\node_modules?\n. remove public/ from src,styleTarget& htmlTarget\nDoes it work without the width& height options?\nI'd suggest the following code:\njs\ngulp.task('critical', function() {\n    critical.generateInline({\n        base: 'public/',\n        src: 'layouts/index.html',\n        styleTarget: 'assets/build/css/app.min.css',\n        htmlTarget: 'layouts/index.html',\n        width: 320,\n        height: 480,\n        minify: true\n    });\n});\n. @solenoo your problem is another one than this issue.\nTake a look at #38 for your multiple pages problem\n. ",
    "tchaecker": "I still have the issue after installing from master. I hope I'm not missing something obvious.\nD:\\websites\\wskm\\web-starter-kit-master>npm install http://github.com/addyosmani/critical/tarball/master\n\\\n\nphantomjs@1.9.12 install D:\\websites\\wskm\\web-starter-kit-master\\node_modules\\critical\\node_modules\\penthouse\\node_modules\\phantomjs\nnode install.js\n\nDownload already available at C:\\Users\\TCH-DE~1\\AppData\\Local\\Temp\\phantomjs\\phantomjs-1.9.8-windows.zip\nExtracting zip contents\nRemoving D:\\websites\\wskm\\web-starter-kit-master\\node_modules\\critical\\node_modules\\penthouse\\node_modules\\phantomjs\\lib\\phantom\nCopying extracted folder C:\\Users\\TCH-DE~1\\AppData\\Local\\Temp\\phantomjs\\phantomjs-1.9.8-windows.zip-extract-1415026515942\\phantomjs-1.9.8-windows -> D:\\websites\\wskm\\web-starter-kit-master\\node_modules\\critical\\node_modules\\penthouse\\node_modules\\phantomjs\\lib\\phantom\nRemoving C:\\Users\\TCH-DE~1\\AppData\\Local\\Temp\\phantomjs\\phantomjs-1.9.8-windows.zip-extract-1415026515942\nWriting location.js file\nDone. Phantomjs binary available at D:\\websites\\wskm\\web-starter-kit-master\\node_modules\\critical\\node_modules\\penthouse\\node_modules\\phantomjs\\lib\\phantom\\phantomjs.exe\ncritical@0.4.0 node_modules\\critical\n\u251c\u2500\u2500 slash@1.0.0\n\u251c\u2500\u2500 uuid@2.0.1\n\u251c\u2500\u2500 bluebird@2.3.10\n\u251c\u2500\u2500 oust@0.2.2 (minimist@1.1.0)\n\u251c\u2500\u2500 clean-css@2.2.16 (commander@2.2.0)\n\u251c\u2500\u2500 cheerio@0.17.0 (entities@1.1.1, lodash@2.4.1, dom-serializer@0.0.1, CSSselect@0.4.1, htmlparser2@3.7.3)\n\u251c\u2500\u2500 imageinliner@0.2.3 (css-parse@1.7.0, underscore@1.7.0, mime@1.2.11, mkdirp@0.3.5, optimist@0.6.1, css-stringify@1.4.1)\n\u251c\u2500\u2500 inline-critical@0.0.5 (reaver@1.2.0, cave@2.0.0)\n\u2514\u2500\u2500 penthouse@0.2.51 (nopt@3.0.1, phantomjs@1.9.12)\nD:\\websites\\wskm\\web-starter-kit-master>gulp\n[15:55:41] Using gulpfile D:\\websites\\wskm\\web-starter-kit-master\\gulpfile.js\n[15:55:41] Starting 'clean'...\nD:\\websites\\wskm\\web-starter-kit-master\\node_modules\\critical\\node_modules\\bluebird\\js\\main\\async.js:95\n                throw res.e;\n                         ^\nTypeError: Cannot call method 'toString' of undefined\n    at D:\\websites\\wskm\\web-starter-kit-master\\node_modules\\critical\\index.js:150:30\n    at tryCatch1 (D:\\websites\\wskm\\web-starter-kit-master\\node_modules\\critical\\node_modules\\bluebird\\js\\main\\util.js:45:21)\n    at Promise$_callHandler as _callHandler\n    at Promise$_settlePromiseFromHandler as _settlePromiseFromHandler\n    at Promise$_settlePromiseAt as _settlePromiseAt\n    at Promise$_settlePromises as _settlePromises\n    at Async$_consumeFunctionBuffer as _consumeFunctionBuffer\n    at Async$consumeFunctionBuffer (D:\\websites\\wskm\\web-starter-kit-master\\node_modules\\critical\\node_modules\\bluebird\\js\\main\\async.js:40:14)\n    at process._tickCallback (node.js:419:13)\n. I have https://www.npmjs.org/package/gulp-git installed but I get errors with that command. \nD:\\websites\\wskm\\aip>npm install git://github.com/addyosmani/critical.git#cli\nnpm WARN git config --get remote.origin.url returned wrong result (git://githu\nb.com/addyosmani/critical.git) undefined\nnpm WARN git config --get remote.origin.url returned wrong result (git://githu\nb.com/addyosmani/critical.git) undefined\nnpm ERR! git clone git://github.com/addyosmani/critical.git undefined\nnpm ERR! git clone git://github.com/addyosmani/critical.git undefined\nnpm ERR! not found: git\nnpm ERR!\nnpm ERR! Failed using git.\nnpm ERR! This is most likely not a problem with npm itself.\nnpm ERR! Please check if you have git installed and in your PATH.\nnpm ERR! System Windows_NT 6.1.7601\nnpm ERR! command \"D:\\Program Files\\nodejs\\node.exe\" \"D:\\Program Files\\nod\nejs\\node_modules\\npm\\bin\\npm-cli.js\" \"install\" \"git://github.com/addyosmani/\ncritical.git#cli\"\nnpm ERR! cwd D:\\websites\\wskm\\aip\nnpm ERR! node -v v0.10.32\nnpm ERR! npm -v 1.4.28\nnpm ERR! code ENOGIT\nnpm ERR!\nnpm ERR! Additional logging details can be found in:\nnpm ERR!     D:\\websites\\wskm\\aip\\npm-debug.log\nnpm ERR! not ok code 0\n. I have 1.4.28. Somehow my npm isn't updating. \nD:\\websites\\wskm\\aip>npm install -g npm@2.1.5\nC:\\Users\\tch-desktop\\AppData\\Roaming\\npm\\npm -> C:\\Users\\tch-desktop\\AppData\\Roaming\\npm\\node_modules\\npm\\bin\\npm-cli.js\nnpm@2.1.5 C:\\Users\\tch-desktop\\AppData\\Roaming\\npm\\node_modules\\npm\nD:\\websites\\wskm\\aip>npm -v\n1.4.28\n. D:\\websites\\wskm\\aip>npm install git://github.com/addyosmani/critical.git#cli-test\nnpm WARN git config --get remote.origin.url returned wrong result (git://github.com/addyosmani/critical.git) undefined\nnpm WARN git config --get remote.origin.url returned wrong result (git://github.com/addyosmani/critical.git) undefined\nnpm ERR! git clone git://github.com/addyosmani/critical.git undefined\nnpm ERR! git clone git://github.com/addyosmani/critical.git undefined\nnpm ERR! not found: git\nnpm ERR!\nnpm ERR! Failed using git.\nnpm ERR! This is most likely not a problem with npm itself.\nnpm ERR! Please check if you have git installed and in your PATH.\nnpm ERR! System Windows_NT 6.1.7601\nnpm ERR! command \"D:\\Program Files\\nodejs\\node.exe\" \"D:\\Program Files\\nodejs\\node_modules\\npm\\bin\\npm-cli.js\" \"install\" \"git://github.com/addyosmani/critical.git#cli-test\"\nnpm ERR! cwd D:\\websites\\wskm\\aip\nnpm ERR! node -v v0.10.33\nnpm ERR! npm -v 1.4.28\nnpm ERR! code ENOGIT\nnpm ERR!\nnpm ERR! Additional logging details can be found in:\nnpm ERR!     D:\\websites\\wskm\\aip\\npm-debug.log\nnpm ERR! not ok code 0\n. Sorry for your time. My bad, I'm still learning to use Gulp. I have git installed but the git command does not work in that directory. Will figure that out. :(\n. Thank you. I managed to get Git running and install the package. \n. @bezoerb Maybe, but it doesn't work, yet. I'm not sure if I overlooked something again. \nD:\\websites\\wskm\\aip>npm install git://github.com/addyosmani/critical.git#cli-test\n|\n\nphantomjs@1.9.12 install D:\\websites\\wskm\\aip\\node_modules\\critical\\node_modules\\penthou\nse\\node_modules\\phantomjs\nnode install.js\n\nDownload already available at C:\\Users\\TCH-DE~1\\AppData\\Local\\Temp\\phantomjs\\phantomjs-1.9\n.8-windows.zip\nExtracting zip contents\nRemoving D:\\websites\\wskm\\aip\\node_modules\\critical\\node_modules\\penthouse\\node_modules\\ph\nantomjs\\lib\\phantom\nCopying extracted folder C:\\Users\\TCH-DE~1\\AppData\\Local\\Temp\\phantomjs\\phantomjs-1.9.8-wi\nndows.zip-extract-1415798612676\\phantomjs-1.9.8-windows -> D:\\websites\\wskm\\aip\\node_modul\nes\\critical\\node_modules\\penthouse\\node_modules\\phantomjs\\lib\\phantom\nRemoving C:\\Users\\TCH-DE~1\\AppData\\Local\\Temp\\phantomjs\\phantomjs-1.9.8-windows.zip-extrac\nt-1415798612676\nWriting location.js file\nDone. Phantomjs binary available at D:\\websites\\wskm\\aip\\node_modules\\critical\\node_module\ns\\penthouse\\node_modules\\phantomjs\\lib\\phantom\\phantomjs.exe\ncritical@0.4.0 node_modules\\critical\n\u251c\u2500\u2500 get-stdin@3.0.0\n\u251c\u2500\u2500 slash@1.0.0\n\u251c\u2500\u2500 object-assign@1.0.0\n\u251c\u2500\u2500 tmp@0.0.24\n\u251c\u2500\u2500 meow@2.0.0 (minimist@1.1.0, camelcase-keys@1.0.0)\n\u251c\u2500\u2500 clean-css@2.2.17 (commander@2.2.0)\n\u251c\u2500\u2500 indent-string@1.2.0 (minimist@1.1.0, repeating@1.1.0)\n\u251c\u2500\u2500 oust@0.2.2 (minimist@1.1.0)\n\u251c\u2500\u2500 bluebird@2.3.11\n\u251c\u2500\u2500 lodash@2.4.1\n\u251c\u2500\u2500 cli@0.6.5 (exit@0.1.2, glob@3.2.11)\n\u251c\u2500\u2500 cheerio@0.17.0 (entities@1.1.1, dom-serializer@0.0.1, htmlparser2@3.7.3, CSSselect@0.4\n.1)\n\u251c\u2500\u2500 imageinliner@0.2.3 (css-parse@1.7.0, underscore@1.7.0, mime@1.2.11, mkdirp@0.3.5, opti\nmist@0.6.1, css-stringify@1.4.1)\n\u251c\u2500\u2500 inline-critical@0.0.5 (reaver@1.2.0, cave@2.0.0)\n\u2514\u2500\u2500 penthouse@0.2.51 (nopt@3.0.1, phantomjs@1.9.12)\nD:\\websites\\wskm\\aip>gulp\nError: Cannot find module 'critical'\n    at Function.Module._resolveFilename (module.js:338:15)\n    at Function.Module._load (module.js:280:25)\n    at Module.require (module.js:364:17)\n    at require (module.js:380:17)\n    at Object. (D:\\websites\\wskm\\aip\\gulpfile.js:33:16)\n    at Module._compile (module.js:456:26)\n    at Object.Module._extensions..js (module.js:474:10)\n    at Module.load (module.js:356:32)\n    at Function.Module._load (module.js:312:12)\n    at Module.require (module.js:364:17)\n. I probably missed something really obvious, but this is the result:\nD:\\websites\\wskm\\aip>npm install --save-dev git://github.com/addyosmani/critical.git#cli-test\n\nphantomjs@1.9.12 install D:\\websites\\wskm\\aip\\node_modules\\critical\\node_modules\\penthouse\\node_modules\\phantomjs\nnode install.js\n\nDownload already available at C:\\Users\\TCH-DE~1\\AppData\\Local\\Temp\\phantomjs\\phantomjs-1.9.8-windows.zip\nExtracting zip contents\nRemoving D:\\websites\\wskm\\aip\\node_modules\\critical\\node_modules\\penthouse\\node_modules\\phantomjs\\lib\\phantom\nCopying extracted folder C:\\Users\\TCH-DE~1\\AppData\\Local\\Temp\\phantomjs\\phantomjs-1.9.8-windows.zip-extract-1415799636654\\phantomjs-1.9.8-windows -> D:\\websites\\wskm\\aip\\node_modules\\critical\\node_modules\\penthouse\\node_modules\\phantomjs\\lib\\phantom\nRemoving C:\\Users\\TCH-DE~1\\AppData\\Local\\Temp\\phantomjs\\phantomjs-1.9.8-windows.zip-extract-1415799636654\nWriting location.js file\nDone. Phantomjs binary available at D:\\websites\\wskm\\aip\\node_modules\\critical\\node_modules\\penthouse\\node_modules\\phantomjs\\lib\\phantom\\phantomjs.exe\ncritical@0.4.0 node_modules\\critical\n\u251c\u2500\u2500 get-stdin@3.0.0\n\u251c\u2500\u2500 slash@1.0.0\n\u251c\u2500\u2500 object-assign@1.0.0\n\u251c\u2500\u2500 tmp@0.0.24\n\u251c\u2500\u2500 oust@0.2.2 (minimist@1.1.0)\n\u251c\u2500\u2500 clean-css@2.2.17 (commander@2.2.0)\n\u251c\u2500\u2500 meow@2.0.0 (minimist@1.1.0, camelcase-keys@1.0.0)\n\u251c\u2500\u2500 cli@0.6.5 (exit@0.1.2, glob@3.2.11)\n\u251c\u2500\u2500 indent-string@1.2.0 (minimist@1.1.0, repeating@1.1.0)\n\u251c\u2500\u2500 bluebird@2.3.11\n\u251c\u2500\u2500 lodash@2.4.1\n\u251c\u2500\u2500 imageinliner@0.2.3 (css-parse@1.7.0, underscore@1.7.0, mkdirp@0.3.5, mime@1.2.11, optimist@0.6.1, css-stringify@1.4.1)\n\u251c\u2500\u2500 cheerio@0.17.0 (entities@1.1.1, dom-serializer@0.0.1, htmlparser2@3.7.3, CSSselect@0.4.1)\n\u251c\u2500\u2500 inline-critical@0.0.5 (reaver@1.2.0, cave@2.0.0)\n\u2514\u2500\u2500 penthouse@0.2.51 (nopt@3.0.1, phantomjs@1.9.12)\nD:\\websites\\wskm\\aip>gulp\nError: Cannot find module 'critical'\n    at Function.Module._resolveFilename (module.js:338:15)\n    at Function.Module._load (module.js:280:25)\n    at Module.require (module.js:364:17)\n    at require (module.js:380:17)\n    at Object. (D:\\websites\\wskm\\aip\\gulpfile.js:33:16)\n    at Module._compile (module.js:456:26)\n    at Object.Module._extensions..js (module.js:474:10)\n    at Module.load (module.js:356:32)\n    at Function.Module._load (module.js:312:12)\n    at Module.require (module.js:364:17)\nAdditional information: My gulpfile.js (paths are not set for critical, yet)\n/\n\n-  Web Starter Kit\n-  Copyright 2014 Google Inc. All rights reserved.\n  \n-  Licensed under the Apache License, Version 2.0 (the \"License\");\n-  you may not use this file except in compliance with the License.\n-  You may obtain a copy of the License at\n  \n-      http://www.apache.org/licenses/LICENSE-2.0\n  \n-  Unless required by applicable law or agreed to in writing, software\n-  distributed under the License is distributed on an \"AS IS\" BASIS,\n-  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-  See the License for the specific language governing permissions and\n-  limitations under the License\n  \n/\n'use strict';\n// Include Gulp & Tools We'll Use\nvar gulp = require('gulp');\nvar $ = require('gulp-load-plugins')();\nvar del = require('del');\nvar runSequence = require('run-sequence');\nvar browserSync = require('browser-sync');\nvar pagespeed = require('psi');\nvar reload = browserSync.reload;\nvar gulp = require('gulp'),\n    critical = require('critical'),\n    fs = require('fs');\n// Generate & Inline Critical-path CSS\ngulp.task('critical', function () {\ncritical.generateInline({\n    base: 'dist/',\n    src: 'index.html',\n    cssPath: 'stylesheets/',\n    styleTarget: 'stylesheets/critical.css',\n    htmlTarget: 'index.html',\n    width: 320,\n    height: 480,\n    minify: true,\n    maxInlineImageSize: 10240\n});\ncritical.generateInline({\n    base: 'dist/',\n    src: 'about.html',\n    cssPath: 'stylesheets/',\n    styleTarget: 'stylesheets/critical.css',\n    htmlTarget: 'about.html',\n    width: 320,\n    height: 480,\n    minify: true,\n    maxInlineImageSize: 10240\n});\n});\nvar AUTOPREFIXER_BROWSERS = [\n  'ie >= 10',\n  'ie_mob >= 10',\n  'ff >= 30',\n  'chrome >= 34',\n  'safari >= 7',\n  'opera >= 23',\n  'ios >= 7',\n  'android >= 4.4',\n  'bb >= 10'\n];\n// Lint JavaScript\ngulp.task('jshint', function () {\n  return gulp.src('app/scripts/*/.js')\n    .pipe(reload({stream: true, once: true}))\n    .pipe($.jshint())\n    .pipe($.jshint.reporter('jshint-stylish'))\n    .pipe($.if(!browserSync.active, $.jshint.reporter('fail')));\n});\n// Optimize Images\ngulp.task('images', function () {\n  return gulp.src('app/images/*/')\n    .pipe($.cache($.imagemin({\n      progressive: true,\n      interlaced: true\n    })))\n    .pipe(gulp.dest('dist/images'))\n    .pipe($.size({title: 'images'}));\n});\n// Copy All Files At The Root Level (app)\ngulp.task('copy', function () {\n  return gulp.src([\n    'app/',\n    '!app/.html',\n    'node_modules/apache-server-configs/dist/.htaccess'\n  ], {\n    dot: true\n  }).pipe(gulp.dest('dist'))\n    .pipe($.size({title: 'copy'}));\n});\n// Copy Web Fonts To Dist\ngulp.task('fonts', function () {\n  return gulp.src(['app/fonts/**'])\n    .pipe(gulp.dest('dist/fonts'))\n    .pipe($.size({title: 'fonts'}));\n});\n// Compile and Automatically Prefix Stylesheets\ngulp.task('styles', function () {\n  // For best performance, don't add Sass partials to gulp.src\n  return gulp.src([\n    'app/styles/.scss',\n    'app/styles/__/.css',\n    'app/styles/components/components.scss'\n  ])\n    .pipe($.changed('styles', {extension: '.scss'}))\n    .pipe($.rubySass({\n      style: 'expanded',\n      precision: 10\n    }))\n    .on('error', console.error.bind(console))\n    .pipe($.autoprefixer({browsers: AUTOPREFIXER_BROWSERS}))\n    .pipe(gulp.dest('.tmp/styles'))\n    // Concatenate And Minify Styles\n    .pipe($.if('*.css', $.csso()))\n    .pipe(gulp.dest('dist/styles'))\n    .pipe($.size({title: 'styles'}));\n});\n// Scan Your HTML For Assets & Optimize Them\ngulp.task('html', function () {\n  var assets = $.useref.assets({searchPath: '{.tmp,app}'});\nreturn gulp.src('app/*/.html')\n    .pipe(assets)\n    // Concatenate And Minify JavaScript\n    .pipe($.if('.js', $.uglify({preserveComments: 'some'})))\n    // Remove Any Unused CSS\n    // Note: If not using the Style Guide, you can delete it from\n    // the next line to only include styles your project uses.\n    .pipe($.if('.css', $.uncss({\n      html: [\n        'app/index.html',\n        'app/styleguide.html'\n      ],\n      // CSS Selectors for UnCSS to ignore\n      ignore: [\n        /.navdrawer-container.open/,\n        /.app-bar.open/\n      ]\n    })))\n    // Concatenate And Minify Styles\n    // In case you are still using useref build blocks\n    .pipe($.if('.css', $.csso()))\n    .pipe(assets.restore())\n    .pipe($.useref())\n    // Update Production Style Guide Paths\n    .pipe($.replace('components/components.css', 'components/main.min.css'))\n    // Minify Any HTML\n    .pipe($.if('.html', $.minifyHtml()))\n    // Output Files\n    .pipe(gulp.dest('dist'))\n    .pipe($.size({title: 'html'}));\n});\n// Clean Output Directory\ngulp.task('clean', del.bind(null, ['.tmp', 'dist']));\n// Watch Files For Changes & Reload\ngulp.task('serve', ['styles'], function () {\n  browserSync({\n    notify: false,\n    // Run as an https by uncommenting 'https: true'\n    // Note: this uses an unsigned certificate which on first access\n    //       will present a certificate warning in the browser.\n    // https: true,\n    server: ['.tmp', 'app']\n  });\ngulp.watch(['app//*.html'], reload);\n  gulp.watch(['app/styles//.{scss,css}'], ['styles', reload]);\n  gulp.watch(['app/scripts/__/.js'], ['jshint']);\n  gulp.watch(['app/images/*/'], reload);\n});\n// Build and serve the output from the dist build\ngulp.task('serve:dist', ['default'], function () {\n  browserSync({\n    notify: false,\n    // Run as an https by uncommenting 'https: true'\n    // Note: this uses an unsigned certificate which on first access\n    //       will present a certificate warning in the browser.\n    // https: true,\n    server: 'dist'\n  });\n});\n// Build Production Files, the Default Task\ngulp.task('default', ['clean'], function (cb) {\n  runSequence('styles', ['jshint', 'html', 'images', 'fonts', 'copy'], cb);\n});\n// Run PageSpeed Insights\n// Update url below to the public URL for your site\ngulp.task('pagespeed', pagespeed.bind(null, {\n  // By default, we use the PageSpeed Insights\n  // free (no API key) tier. You can use a Google\n  // Developer API key if you have one. See\n  // http://goo.gl/RkN0vE for info key: 'YOUR_API_KEY'\n  url: 'https://example.com',\n  strategy: 'mobile'\n}));\n// Load custom tasks from the tasks directory\ntry { require('require-dir')('tasks'); } catch (err) {}\n. https://gist.github.com/tchaecker/817fa4dcc40b5ecb3eb9\n. Yes. http://prntscr.com/55miqe\n. No errors anymore. Awesome. I need to update the paths to check the results but will only be able to do so by tomorrow morning. Thank you so much!\n. Just as feedback from yesterday: It works really well. PageSpeed went from 82 mobile / 91 Desktop to 94 mobile / 94 Desktop (just compression missing). \n. ",
    "djmadeira": "Same problem. If I use the callback syntax, no error gets passed, but the output is empty. If I use the built in options I get this:\n/Users/dj/Projects/djmadeira.com/wp-content/themes/djmadeira-wptheme/node_modules/critical/node_modules/bluebird/js/main/async.js:95\n                throw res.e;\n                         ^\nTypeError: Cannot call method 'toString' of undefined\n    at /Users/dj/Projects/djmadeira.com/wp-content/themes/djmadeira-wptheme/node_modules/critical/index.js:150:30\n    at tryCatch1 (/Users/dj/Projects/djmadeira.com/wp-content/themes/djmadeira-wptheme/node_modules/critical/node_modules/bluebird/js/main/util.js:45:21)\n    at Promise$_callHandler [as _callHandler] (/Users/dj/Projects/djmadeira.com/wp-content/themes/djmadeira-wptheme/node_modules/critical/node_modules/bluebird/js/main/promise.js:660:13)\n    at Promise$_settlePromiseFromHandler [as _settlePromiseFromHandler] (/Users/dj/Projects/djmadeira.com/wp-content/themes/djmadeira-wptheme/node_modules/critical/node_modules/bluebird/js/main/promise.js:675:18)\n    at Promise$_settlePromiseAt [as _settlePromiseAt] (/Users/dj/Projects/djmadeira.com/wp-content/themes/djmadeira-wptheme/node_modules/critical/node_modules/bluebird/js/main/promise.js:845:14)\n    at Promise$_settlePromises [as _settlePromises] (/Users/dj/Projects/djmadeira.com/wp-content/themes/djmadeira-wptheme/node_modules/critical/node_modules/bluebird/js/main/promise.js:988:14)\n    at Async$_consumeFunctionBuffer [as _consumeFunctionBuffer] (/Users/dj/Projects/djmadeira.com/wp-content/themes/djmadeira-wptheme/node_modules/critical/node_modules/bluebird/js/main/async.js:77:12)\n    at Async$consumeFunctionBuffer (/Users/dj/Projects/djmadeira.com/wp-content/themes/djmadeira-wptheme/node_modules/critical/node_modules/bluebird/js/main/async.js:40:14)\n    at process._tickCallback (node.js:419:13)\n. ",
    "solenoo": "Thank you for fixing this issue it was a real pain in the bt, however I'm still having issues printing my inline css. This is how my gulp task looks gulp.task('critical', function () {\n    critical.generateInline({\n        base: 'public/',\n        src: 'public/layouts/index.html',\n        styleTarget: 'public/assets/build/css/app.min.css',\n        htmlTarget: 'public/layouts/index.html',\n        minify: true\n    });\n});\n. Well I didn't really get the width and heigh, is that like it only work in those criteria. Cause I want the critical path to work on all resolutions, not just one particular\n. I've tried 2560/1440 but nothing happens :(. Also if I want this critical path to work on multiple pages not just the homepage, do I need to call the critical.generateInline multiple times or can I just set the htmlTarget to /.html\n. I have a question since I can't get it to inline my CSS in the HTML, can I copy it in a different css file, so I can check if it's at least getting something, maybe that's the problem.\n. Man I'm dumb I haven't been calling the css file the entire time, thank you so much :). One last request though, since I have smarty php in my html and when I use the critical task it changes all my \" to &quot, how can I prevent that from happening ?\n. Hi, sorry for the delay so here is an example of my configuration for the critical task.\ngulp.task('critical',['sass'], function() {\n    critical.generateInline({\n        base: 'public/',\n        css: 'public/assets/build/style.css',\n        styleTarget: 'assets/build/css/critical.css',\n        htmlTarget: 'layouts/index.html',\n        width: 1024,\n        height: 400\n    });\n});\nI think the problem might be somewhere in the clean.js, around the function that is commented // strip parentheses in urls if possible (no spaces inside)\n. ",
    "propertunist": "i'm seeing the same 'toString' errors here (i'm a new user of critical and gulp). i got lost somewhere in this thread.. is the solution to install the github master of critical?\nthanks\n. ok, do i need to remove the already installed version somehow and copy the github master into my working directory? (i didn't find a link explaining how to install the master version anywhere)\n. oh ok, thanks - i just ran that and am getting errors. do you prefer me to create a new issue for that?\n. ok, i did originally not use sudo; however, i got permission errors and more errors that way.\ni just ran the process again without sudo and all looks good this time, thanks.\nfrom what i can see, the critical process did not produce any output against my test file, so there is still some issue of some form to resolve, though the download and install from github looks ok. thanks\n. no, i'm not using the demo repo.. although i have looked at it.\ni have saved an html file from my live site (which is originally generated via PHP) and am looking to process that page locally using critical.\n. sure, i downloaded the homepage from www.ureka.org as a complete file via firefox and applied critical to that html page locally.\n. ok i am v. busy here presently, but will come back to this asap. thanks\n. ",
    "r-flash": "Perfect. Just one question: wouldn't it be safer to use path.sep in the condition rather than process.platform?\n. ",
    "cormacmccarthy": "I'm having this same issue. Not sure if the circumstances are the same, but, I'll try and explain in case it helps:\n- My app code resides in /Package/Dynamic/ and compiles into /Application/Dynamic/. \n- My node server serves up everything inside of /Application/Dynamic/ as http://my.url.com/App/ (note how weird the \"root\" url of my app is, in that it is a subdirectory of the actual site. Before you judge, I have no control over this and agree that on the surface it seems stupid.  Try and think of it like http://www.reddit.com/r/my-app though and maybe it will seem more acceptable...)\n- My /Package/Dynamic/css/styles.css file has a relative paths to /Package/Dynamic/fonts/myfont.eot (& .svg, etc). \n- When it gets digested by critical, my font paths turn into /fonts/myfont.eot instead of fonts/myfont.eot. \nSo, there's the problem. Instead of looking for the fonts in http://my.url.com/App/ it is looking for them in http://my.url.com/ because of the absolute pathing. If there was some url option that I could pass http://my.url.com/App/ into to inform critical of the actual absolute path, I'd do that. Or, if there was some way to say \"don't prepend relative paths with /\" I'd do that too.\nHope this helps, thanks! Also: I'm using grunt-critical (in case it matters)\n. Looks like this may be the culprit:\nhttps://github.com/addyosmani/critical/blob/master/index.js#L150\nI'm going to try changing that locally and seeing if it does what I want.\n. Correct, there is no folder like /App that we could use to compute the asset path.\nThe production server is neither controlled by me nor available to me. Not only that, but, I'm not easily able to change the structure of the project itself (as I'm basically a contractor working with a team specifically for initial page-load speed/optimizations).\nThanks!\n. Either of these will work. I made it so that if you wanted you could simply specify \"\" as the pathPrefix to achieve relative pathing.\nJavascript\n    var pathPrefix = (typeof opts.pathPrefix === \"undefined\") ? \"/\" : opts.pathPrefix;\n    return normalizePath(match.replace(filePath, path.join(pathPrefix, relativeToBase)));\n``` Javascript\n    // prepend / to make it absolute\n    if (typeof opts.useRelativePaths === \"undefined\" || opts.useRelativePaths === false) {\n        relativeToBase = path.join('/', relativeToBase);\n    }\nreturn normalizePath(match.replace(filePath, relativeToBase));\n\n``\n. Sorry, don't mean to be a pain, but, we are using this, by way of grunt-critical, in a project at SalesForce that needs to go live. Any chance at getting it released? If not, I need to know so I can make other plans. Thanks!\n. That just won't work for me. I need it to be relative to the HTML file wherever it happens to be. It is in a different place indevand inqaand inprod`. Otherwise I'll have to have specific critical tasks for each of those places.\nAlso, I was unaware you could have more than one dest? Unless I'm misunderstanding why this is a big deal... If I'm understanding you correctly, if you target two different dest files for output and they are in two different directory depths then (of course) this is going to screw up because the pathPrefix will only be valid for one of those two outputs. But, if it is just a single dest file, then, why would it matter if this was relative instead of absolute?\n. ",
    "asuh": "This ticket took me a while to find, and it's good to know, but looking at the Critical Path CSS Demo makes it appear think styleTarget and htmlTarget are the way to go and not deprecated.\n. ",
    "khalwat": "I'm doing the inlining myself, because I'm using a CMS system, so it actually was inlined... but I figured out my mistake.\nloadCSS() was inserting itself before the last ",
    "rosslavery": "Can you elaborate on your solution to this? It looks like your sentence was cut off.\nI'm encountering the exact same issue. The inlined css of above-the-fold styles is impacting the classes that override those styles in the below-the-fold content.\nLooking into it a bit more, it seems like the inline-critical package's loadCSS function inserts the <link> tag before the first script tag it finds.\n. Hey @bezoerb , thanks for the link. My fix was the same.\n. ",
    "biokillos": "I have the same issue, but cannot reorder script tags, i.e. having cloudflare or browser extensions that push them at the top. loadCSS() has a useful argument that allows to point an element and inserts all stylesheets before it. So the questions are:\n1. Can I pass the argument?\n   or\n2. Can I inline css in HTML, but withous using 'yours' loadCSS() and instead use 'mine' with the argument, stylesheets passed\n. @bezoerb anything?\n. ",
    "cleberdantas": "Will not be merged? cc @danshearmur \n. ",
    "juanbrujo": "@bezoerb and the output has to be absolute? can't be a relative directory, so I wouldn't change it when in production?\n. @bezoerb ok tested it and it's working fine but a couple of concerns. this is my folder structure (test):\n\nand this is the config (I'm forcing the height to test the output):\njs\ncritical.generate({\n    inline: true,\n    base: 'dist/',\n    src: 'index.html',\n    dest: 'index-critical.html',\n    width: 1300,\n    height: 1200\n});\nas you can see even if base is in dist/ the file output is being created in the project root directory. With that result, assets url's are being created like if it would reside inside dist/:\njs\n.incognito .box-producto:before {\n  background-image: url(assets/images/sprites.png);\n  background-position: 0 0;\n  ...\n(I hope I was clear explaining \ud83d\ude30)\n. ",
    "alanontheweb": "+1 for ignoring specific stylesheets. I specified which CSS file to use but it doesn't seem to be using that information to ignore the other...\n. Hi, I had initially tried the original Critical script with success for my index page and was looking for this feature to critical different templates. I got the script to compile but I'm not sure if I'm doing something wrong. Here's what I noticed:\n1) Files output with a .css extension (but contain markup and inline styles)\n2)After renaming to .html, the page renders fine BUT if you remove the loadCSS script, then the page no longer renders. A quick view at the inspector tools showed me this - \nbody, html {\n  height: :after,:before{box-sizing:border-box}body,html{font-size:10.hide{display:none!important;visibility:hidden}.row{width:.row:before{content:\" \";display:table}.row:after{clear:both}.row .row{width:auto;margin-left:-.9375rem; etc\nAs you can see the output is screwy. Did I do something wrong?\n. Hey @bezoerb,\nIt's no problem. Thanks for writing this :)\nSo upon further testing on a clean Foundation template, it seems to be working well. On my current project, something is getting screwed up, so I'll have to debug my gulp tasks, html, css to see if I can spot something.\nDid you push your last commit? I downloaded the source files from here just a few hours ago and they still have the .css extension bug.\n. Yup, that fixed the extension issue, haha. I'll report back if I figure out what's wrong with my other build. Thanks again!\n. I got everything working now (the combineMQ gulp plugin was causing issues for some reason). Do you know if there's a way to exclude a css file from being picked up? It's adding an external font stylesheet to the noscript and removing it from the source. I tried specifying the CSS (  css: ['dist/styles/main.css'],) but it still doesn't seem to do anything differently.\n. This is so close to working! The only two issues I'm experiencing is the one I listed above, AND that I can't use absolute paths. Example - \nGulp is globbing through several HTML files, and some are in subdirectories. In my HTML, my path is \"/assets/css/app.min.css\" (note the slash at the beginning).\nThis does not work or result in generating multiple CSS files, and it doesn't append the appropriate filename to the LoadCSS snippet functions.\nRemoving the front slash to just \"assets/css/app.min.css\" MAKES THE WHOLE THING WORK. However, once the files are outputted, the loadCSS is pointing to a relative asset, and this breaks the pages that are inside a subdirectory, since it can't find the CSS there.\nI hope this is an easy fix. \n. Okay, so I think I figured it out. It does work with both absolute and relative paths, as long as you don't use the extract function (which creates its own unique stylesheet per page). If you use  extract: true, then it only works with a relative path.\nHelp me understand something though - If we don't use extract, the stylesheet remains intact. When we use cssLoad to pull in the stylesheet, is it pulling in duplicate styles then (additional kb), or does the script know to ignore the styles contained in the critical CSS?\nIf it's pulling in the entire stylesheet w/ duplicate styles I would really like to use the extract function with absolute paths. \nAlso, it's with extract: true that the loadCSS function pulls in a blank. Notice the end of the file, without any stylesheet paths appended.\n\n(function(u){function loadCSS(e,t,n){\"use strict\";function r(){for(var t,i=0;i<d.length;i++)d[i].href&&d[i].href.indexOf(e)>-1&&(t=!0);t?o.media=n||\"all\":setTimeout(r)}var o=window.document.createElement(\"link\"),i=t||window.document.getElementsByTagName(\"script\")[0],d=window.document.styleSheets;return o.rel=\"stylesheet\",o.href=e,o.media=\"only x\",i.parentNode.insertBefore(o,i),r(),o}for(var i in u){loadCSS(u[i]);}}(['','']));\n\nmy gulp file-\ngulp.task('critical', function () {\n    return gulp.src('build/* / .html')\n    .pipe(critical({\n        base: 'build',\n        width: 1024,\n         height: 768,\n        minify:false, //leave false, bug (and it's minified with previous task)\n         extract: true\n    }))\n    .pipe($.rename({ suffix: '.critical' }))\n        .pipe(gulp.dest('build'));\n});\n. Yeah, that's very true. I thought about the caching. It might be a good compromise that way actually. And I'll throw that into a new ticket. I wasn't sure if it was specific to the recent changes you made or in the original plugin.\nThanks so much!\n. ",
    "rupl": "I think ignoring specific stylesheets is a big ask, and often people are concatenating everything together like @bezoerb said. Some sort of rule for excluding specific properties would be grand, e.g. exclude font-face blocks, anything with url as a value, etc.\nMy current workflow just includes a small test to scan the generated file for these problematic strings so I don't accidentally ship them.\n. Wow nice! I will give this a spin tomorrow on a couple sites and see how it works.\n. I dropped this into a couple projects and all my functional tests worked brilliantly!\nI'm trying to get a branch going that ignores specific values (e.g. url) but I haven't nailed it yet.\n. whoops yeah the branch I mentioned was for filter-css, not critical. The version in this PR works great for selectors and other blocks like @font-face\n. The type/declarations ignores seem to be mutually exclusive. Using the filter-css docs I was able to either filter a block like @font-face OR filter out a declaration like url\nHere is the syntax that made the declarations work:\njs\n{\n  ignore: {declarations: [/background-image/, /src/]}\n}\nThe syntax for @font-face was as follows:\njs\n{\n  ignore: ['@font-face']\n}\nSo I couldn't figure out how to combine them. I tried something like this:\njs\n{\n  ignore: [{declarations: [/background-image/, /src/]}, '@font-face']\n}\n. ah ha, that makes sense now that I see it. I'm happy to drop some thoughts in the other issue.\n. :tada: \n. seems like a dupe dependency here? it told me it was opting for 0.0.1 when I installed\n. ",
    "oliverfarrell": "+1 for this. Currently get some print media queries returned so would be useful to ignore specific media queries at the very least.\n. ",
    "samccone": "@bezoerb no problem, will do it tonight when I get back to my other computer. Odd that my branch even passed on CI... raises an interesting question as to why it ever passed \n. xref https://github.com/addyosmani/critical/issues/67\n. @bezoerb looks like you need to rebase off of the latest master so that this can be cleanly merged\n. :+1: @peterblazejewicz great find, good catch, thanks @addyosmani and @bezoerb as always\n. Let me know if I can be of any help here\n. looks like this has been fixed in the latest release, thanks guys @bezoerb @addyosmani \n. the best way to review the diff is via this link\nhttps://github.com/samccone/critical/commit/4d2cb1a7071aa67f4e777df4ec9d78e3bddc386d?w=1\nSince a large % of the file was indented by one level, ignoring the whitespace change will let you see what I actually did. :+1: \n. Thanks for the in-depth review @sindresorhus and @bezoerb nits and issues have been resolved.\n. hey @pocketjoso checkout http://marionettejs.com .. the effect is quite noticeable on chrome on IOS\n. @pocketjoso my \"test\" example is a nice reduced test case for you\nhttps://github.com/addyosmani/critical/blob/master/test/fixture/adaptive.html\nhttps://github.com/addyosmani/critical/blob/master/test/fixture/styles/critical-adaptive.css\nDepending on what size you snaphot it at, you will not get the same elements, which makes sense, but I want to generate a snap across multiple device resolutions. \n. heh it should be orange :orange_book:  :) \n. It does not for us @pocketjoso.\nWe legitimately want the site to look nice on mobile and large screen sites  without a weird jump while using critical. For us, due to our layout shifting a bit, we want to merge multiple snapshots together. I think it is a really useful thing, and something that adds a bunch of value. Sure for most people even adding critical css is a huge bonus, so the number of people that take it as far as we are on marionettejs.com is ... slim I am sure.\nAlas, this is useful for us but maybe it is a dumb idea.\n. Upon further thought, it looks like the CLI testing is masking the exit status of mocha since it is calling process.exit when it prints the help output.\n:crying_cat_face: \n. \n. cc @bezoerb \n. Great catch @bezoerb it very much should, or rather the write to disk should happen at this final step.\nI will update the logic in this commit to do just that.\n. ",
    "zgosalvez": "Installed this today. Been getting the same TypeError: undefined is not a function error, after following the instructions at https://github.com/addyosmani/critical#gulp \nIf I remove .stream I get TypeError: object is not a function\n. @bezoerb Oh ok. I assumed it's already available since it's in master.\n. ",
    "Snugug": "I'm likewise getting memory leak warnings\n. Here's my critical task:\nhttps://github.com/Snugug/gulp-armadillo/blob/master/tasks/critical.js\n. Okay, this was a weird one to track down, but everything's fine! There was a XMLHttpRequest somewhere that wasn't returning correctly and in Chrome that was writing something crazy stupid that included tag styling and that's where this was coming from.\n. ",
    "KingScooty": "Hmm. Well it's definitely littering my project folder, and stays long enough to affect tasks running after it :/ It's littering /_site, which i set as the base dir for critical.\nI'm using the config from @addyosmani's example:\n``` javascript\n// Copy our site styles to a site.css file\n// for async loading later\ngulp.task('copystyles', ['build'], function () {\n    return gulp.src(['_site/assets/stylesheets/main.css'])\n        .pipe(rename({\n            basename: \"site\"\n        }))\n        .pipe(gulp.dest('_site/assets/stylesheets'));\n});\n// Generate & Inline Critical-path CSS\ngulp.task('critical', ['build', 'copystyles'], function (cb) {\n// At this point, we have our\n  // production styles in main/styles.css\n// As we're going to overwrite this with\n  // our critical-path CSS let's create a copy\n  // of our site-wide styles so we can async\n  // load them in later. We do this with\n  // 'copystyles' above\ncritical.generateInline({\n    base: '_site/',\n    src: 'index.html',\n    styleTarget: 'assets/stylesheets/main.css',\n    htmlTarget: 'index.html',\n    width: 320,\n    height: 480,\n    minify: true\n  }, function(err, output) {\n    cb(err);\n  });\n});\n``\n. @bezoerb Awesome!\n. @bezoerb Yep, that sorts my issue right out! :+1: \n. Can we get a release for this? Save me having to update the package.json in my projects to use the master branch.\n. Is this only working when using the inline option? When inline is disabled, extract doesn't seem to work as i'm still getting duplicate CSS.\n. @bezoerb Ah, okay, that makes a bit more sense. I assumedcritical` would handle removing the critical styles from my main.css too - it's a a shame it doesn't!\nI've just had a go of cave, but i can't seem to get it to work with my gulp pipeline. The terminal command works, but it's a little clunky, and outputs un-minified css :/\nDo you know how to get cave working inside gulp via pipes?\n. ",
    "superKalo": "@bezoerb thanks!\nI am actually using it via the grunt plugin, so I guess the grunt plugin needs to be updated too.\n. ",
    "peterblazejewicz": "@bezoerb \n\nthe SVG issue should be fixed in master. Wanna give it another try?\n\nYes, that's correct. If we prepare grunt-critical install with master our problem is fixed!\nThanks!\n. :bow: Thanks!\n. ",
    "diagramatics": "Hm, this hasn't worked properly on my end. Tried even using master and the output still breaks my inline SVG. I'm using io.js and Windows 8.1.\n. The same as above, <path /> tags lost the slash. Converting them to normal tags (<path></path>) doesn't work too.\n. So I manually bumped cheerio to 0.19.0 and everything works fine now. Thanks for the issue reference!\n. ",
    "catalinred": "Hi,\nNot sure if it's ok to resurrect this, but I think this issue \"is happening\" again. \nI had to remove critical this morning from within a project at work because the inline SVG's got broken after the critical task ran.\nAs far as I tested, is the same behavior as @superKalo described above.\nMy setup includes critical w/ Gulp\nLooking forward to hearing from you.\nThanks!\nEdit:\nIn case this helps, here's what happens exactly in my case:\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"0\" height=\"0\" display=\"none\">\n    <symbol id=\"uniqueID\">\n        <title>Title</title>\n        <path d=\"...\"/>\n        <path clip-rule=\"evenodd\" d=\"...\" fill-rule=\"evenodd\"/>\n    </symbol>\n</svg>\nbecomes\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"0\" height=\"0\" display=\"none\">\n    <symbol id=\"uniqueID\">\n        <title>Title</title>\n        <path d=\"...\">\n        <path clip-rule=\"evenodd\" d=\"...\" fill-rule=\"evenodd\"/></path>\n    </symbol>\n</svg>. @bezoerb Sorry for the delay, I had some days off.\nJust tested this morning with critical@next (2.0.0-4) and apparently it doesn't work for me at all, it doesn't insert the inline style in my .html files anymore. \nIn case it helps, I'm on a Windows 10 machine with Node v10.14.1 and I'm getting the following whenever using critical > 2.0:\n\nUnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). (rejection id: 2)\n[DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.\n\nI don't know, maybe it's just me?! I will try to run things on a Linux machine later today.... > @catalinred: can you provide a test case for this or share the files/config to reproduce the issue? This would massively speed up the fix :)\n@bezoerb  I'm sorry for replying that late. The truth is I'm not able to replicate my project's issue in a minimal scenario.  Will have to dig deeper to see what I'm missing out in there.. > @catalinred: i've updated inline-critical which is used internally to inline the critical css.\n\nIt now uses jsdom instead of cheerio for DOM manipulation and the parsing is limited to the document head.\nThe document body should remain unchanged besides the <noscript> blocks which are added to the end of the document.\nSo maybe a fresh installation of critical@next (v2.0.0-10) could resolve your problem\n\nHi @bezoerb, here's what happens now with the 2.0.0-10 critical version: \nFATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory\n 1: 00007FF7AABD121A v8::internal::GCIdleTimeHandler::GCIdleTimeHandler+4810\n 2: 00007FF7AABAA5B6 node::MakeCallback+4518\n 3: 00007FF7AABAAFA0 node_module_register+2160\n 4: 00007FF7AAE3B3EE v8::internal::FatalProcessOutOfMemory+846\n 5: 00007FF7AAE3B31F v8::internal::FatalProcessOutOfMemory+639\n 6: 00007FF7AB379304 v8::internal::Heap::MaxHeapGrowingFactor+11476\n 7: 00007FF7AB36FA67 v8::internal::ScavengeJob::operator=+25543\n 8: 00007FF7AB36DFDC v8::internal::ScavengeJob::operator=+18748\n 9: 00007FF7AB376F57 v8::internal::Heap::MaxHeapGrowingFactor+2343\n10: 00007FF7AB376FD6 v8::internal::Heap::MaxHeapGrowingFactor+2470\n11: 00007FF7AAF19DD7 v8::internal::Factory::NewFillerObject+55\n12: 00007FF7AAFB1F7D v8::internal::WasmJs::Install+30749\n13: 0000002FF06DC5C1\nnpm ERR! code ELIFECYCLE\nnpm ERR! errno 134\n\nWindows machine\nNode.js v10.15.0\ncritical 2.0.0-10\n\nI didn't give up yet, but I'm so close. Still working on a minimal scenario to replicate this behavior.\nThanks again for your hard work. :)\nLater edit:\n@bezoerb I think I managed to make a minimal/rough demo, hope that helps.\nhttps://codesandbox.io/s/z63n58yp34. > @catalinred: i think i managed to get rid of the memory error :)\n\nWould you mind trying again? (Critical should be in version v2.0.0-12)\n\nThank you, it works w/ critical v. 2.0.0-12. ",
    "austinpray": "Sweet! I'll give it a shot!\n. Just tried it and it worked. Reintroduced the \"extract: true\" option in the original scenario and I get the expected out. Thank you guys!\n. o\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u256e(\uff61\u275b\u1d17\u275b\uff61)\u256do\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361\u0361 \n. ",
    "alanburke": "@bezoerb Thanks! I stand corrected.\nThe demo at http://addyosmani.github.io/critical-path-css-demo/output/critical/ shows it in the footer. \n. ",
    "rasteiner": "I'm having a similar problem. I don't think it's strictly related to bootstrap, I just think it doesn't include the @keyframes declarations that are used. I guess this \"bug\" might actually come from penthouse and not critical... \n. ",
    "yethee": "cheerio has option decodeEntities (by default: true)\ncheerio.load(String(html), {\n  decodeEntities: false\n});\nIn this case the content will remain the same, without replace special characters to entities.\n. ",
    "martindrzka": "Thank you guys, cheerio saved me...\n. ",
    "approached": "I know.\nBut if it used on a server without server restarting, that don't would deleted from os.\n. ",
    "adam-lynch": "Ah ok. Yeah, I've done that. Thanks.\n. ",
    "booleanbetrayal": "@bezoerb - if styles are shared across multiple pages, then inlining them in each page actually results in a poorer user experience, as those styles are loaded multiple times, unnecessarily rather than loaded once and then pulled from browser cache as needed. This PR appears to be allowing selective targeting of specific CSS files for inlining, which seems like a great feature to me! :+1: \n. ",
    "nbrustein": "We lazy load some of our styles.  We have whole sections of our site that most users will not see, and so we don't load those styles until a user goes there.  (we use ocLazyLoad for that: https://github.com/ocombe/ocLazyLoad)\n. It sounds like the ignore option will be good enough for us.  I'll go ahead and close this.  Thanks.\n. ",
    "brianmontanaweb": "Instead of checking against 'stylesheet' string in \nhtml\n<link rel=\"stylesheet\" href=\"styles/style.css\">\ninline-styles.js allows an option of setting a string to check in rel and inlining that specific css link element. \nhtml\n<link rel=\"critical\" href=\"styles/critical.css\">\n. Oops fixed it, works perfectly now! Thanks Ben!\n. ",
    "ivanjuras": "I'm using 0.5.7. It seems to be something with Gulp Orchestrator:\n'critical' errored after 6.53 ms\n[23:58:46] TypeError: undefined is not a function\nat Gulp.<anonymous> (MYDIRECTORY\\gulpfile.js:135:12)\nat module.exports (MYDIRECTORY\\node_modules\\gulp\\node_modules\\orchestrator\\lib\\runTask.js:34:7)\nat Gulp.Orchestrator._runTask (MYDIRECTORY\\node_modules\\gulp\\node_modules\\orchestrator\\index.js:273:3)\nat Gulp.Orchestrator._runStep (MYDIRECTORY\\node_modules\\gulp\\node_modules\\orchestrator\\index.js:214:10)\nat Gulp.Orchestrator.start (MYDIRECTORY\\node_modules\\gulp\\node_modules\\orchestrator\\index.js:134:8)\nat MYDIRECTORYnpm\\node_modules\\gulp\\bin\\gulp.js:129:20\nat process._tickCallback (node.js:355:11)\nat Function.Module.runMain (module.js:503:11)\nat startup (node.js:129:16)\nat node.js:814:3\n. @bezoerb Yep, it's working now. Thank you very much.\n. ",
    "johjacb": "I'm seeing this issue now after updating to 0.6.0.\n$ gulp critical\n[09:39:21] Using gulpfile ~/Sites/fizz/gulpfile.js\n[09:39:21] Starting 'critical'...\n[09:39:21] 'critical' errored after 6.34 ms\n[09:39:21] TypeError: object is not a function\n    at Gulp.<anonymous> (/Users/awake/Sites/fizz/gulpfile.js:118:15)\n    at module.exports (/Users/awake/Sites/fizz/node_modules/gulp/node_modules/orchestrator/lib/runTask.js:34:7)\n    at Gulp.Orchestrator._runTask (/Users/awake/Sites/fizz/node_modules/gulp/node_modules/orchestrator/index.js:273:3)\n    at Gulp.Orchestrator._runStep (/Users/awake/Sites/fizz/node_modules/gulp/node_modules/orchestrator/index.js:214:10)\n    at Gulp.Orchestrator.start (/Users/awake/Sites/fizz/node_modules/gulp/node_modules/orchestrator/index.js:134:8)\n    at /usr/local/lib/node_modules/gulp/bin/gulp.js:129:20\n    at /Users/awake/Sites/fizz/node_modules/assemble/node_modules/assemble-utils/node_modules/session-cache/node_modules/continuation-local-storage/node_modules/async-listener/glue.js:188:31\n    at process._tickCallback (node.js:355:11)\n    at Function.Module.runMain (module.js:503:11)\n    at startup (node.js:129:16)\n    at node.js:814:3\nusing this bit from the docs\ngulp.task('critical', function () {\n    return gulp.src('builds/*.html')\n        .pipe(critical({base: 'builds/', inline: true, css:['builds/styles/components.css','builds/styles/main.css']}))\n        .pipe(gulp.dest('builds'));\n});\n. i do not - i added it in and am no longer see the error. thanks!\n. ",
    "JZL": "That still didn't work, \nI tried \n// critical = require(\"/home/jonah/Dropbox/Public/MDJCL/yeoman/node_modules/critical/lib/core.js\");\n// critical = require(\"/home/jonah/Dropbox/Public/MDJCL/yeoman/node_modules/oldCritical/index.js\");\ncritical = require(\"critical\")\ncritical.generate({\n    // Inline the generated critical-path CSS\n    // - true generates HTML\n    // - false generates CSS\n    inline: true,\n    // Your base directory\n    base: 'dist/',\n    // HTML source\n    // HTML source file\n    src: 'index.html',\n    // Target for final HTML output.\n    // use some css file when the inline option is not set\n    dest: 'index-critical.html',\n    // // Minify critical-path CSS when inlining\n    // minify: true,\n    // // Extract inlined styles from referenced stylesheets\n    // extract: true,\n    // Prefix for asset directory\n    // ignore css rules\n    ignore: ['font-face']\n});\nand in gulp\ngulp.task('critical', ['copystyles'], function(cb) {\n    const critical = require('critical')\n    critical.generateInline({\n        inline: true,\n        base: 'dist/',\n        src: 'index.html',\n        // htmlTarget: 'index.html',\n        dest: 'index-critical.html',\n        minify: true,\n        width: 1300,\n        height: 900,\n         ignore: ['@font-face', /url\\(/,/SIFONN_BASIC/g, 'font', /font/, /font/g, /@font-face/g]\n    }, cb.bind(cb));\n});\nboth of which did not work. \nThe css is simply\n@font-face {\n    font-family:'testt';\n    src:url(../fonts/SIFONN_BASIC.otf) format(\"opentype\");\n}\nand, oddly, every time I call the testt font, it tries to reload the font\nWhat actually is in the inline css is\n@font-face{font-family:testt;src:url(/fonts/SIFONN_BASIC.otf) format(\"opentype\")}\n. It works now. I do not know what changed but the code is either \n```\ngulp.task('critical', ['copystyles'], function(cb) {\nreturn gulp.src('dist/*.html')\n    .pipe(require('critical').stream({\n// Inline the generated critical-path CSS\n// - true generates HTML\n// - false generates CSS\ninline: true,\n\n\n// Your base directory\nbase: 'dist/',\n\n// HTML source\n\n// HTML source file\n// src: 'index.html',\n\n// Target for final HTML output.\n// use some css file when the inline option is not set\n// dest: 'index-critical.html',\n\n// // Minify critical-path CSS when inlining\nminify: true,\n\n// // Extract inlined styles from referenced stylesheets\nextract: true,\n\n// Prefix for asset directory\n\n// ignore css rules\nignore: ['@font-face']\n\n}))        .pipe(gulp.dest('dist'));\n```\nOr\n// critical = require(\"/home/jonah/Dropbox/Public/MDJCL/yeoman/node_modules/critical/lib/core.js\");\n// critical = require(\"/home/jonah/Dropbox/Public/MDJCL/yeoman/node_modules/oldCritical/index.js\");\ncritical = require(\"critical\")\ncritical.generate({\n    // Inline the generated critical-path CSS\n    // - true generates HTML\n    // - false generates CSS\n    inline: true,\n    // Your base directory\n    base: 'dist/',\n    // HTML source\n    // HTML source file\n    src: 'index.html',\n    // Target for final HTML output.\n    // use some css file when the inline option is not set\n    dest: 'index-critical.html',\n    // // Minify critical-path CSS when inlining\n    minify: true,\n    // // Extract inlined styles from referenced stylesheets\n    extract: true,\n    // Prefix for asset directory\n    // ignore css rules\n    ignore: ['@font-face']\n});\nThanks!\n. ",
    "raphaelgoetter": "Thanks for the advice.\nTried 3 times to install, but freezes each time :/\n. Hello @bezoerb , thank you for the update, it works !\nBTW, in the compiled HTML file,  why is the script loaded in head part ? Doesn't it block rendering ?\n. Thanks :)\n. Could do the job, thanks.\n. Nope, error is still there : \n\nUnsafe JavaScript attempt to access frame with URL about:blank from frame with URL file:///Users/raphael/Desktop/goetter.fr/node_modules/critical/node_modules/penthouse/lib/phantomjs/core.js. Domains, protocols and ports must match.\n\nThe script that fails : \njavascript\n<script type=\"text/javascript\">\n  if(screen.width>767) {\n  var bigjs = document.createElement('script');\n  var el = document.getElementById('flickr_badge_wrapper');\n  bigjs.src = 'http://www.flickr.com/badge_code_v2.gne?count=12&display=latest&size=s&layout=x&source=user&user=29174632%40N00';\n  bigjs.type = 'text/javascript';\n  bigjs.onload = function() {\n    document.getElementById('flickr_badge_wrapper').innerHTML = b_txt;\n  };\n  if (el) el.appendChild(bigjs);\n}\n</script>\n. Hello,\nThe closest file I found was : \ncritical/node_modules/penthouse/lib/phantomjs/config.json\nActual config : \n{\n    \"ignoreSslErrors\": true,\n    \"sslProtocol\": \"tlsv1\"\n}\nAdded : \n\"localToRemoteUrlAccessEnabled\": true,\n\"webSecurityEnabled\": false\nSame issue still :( \n\nUnsafe JavaScript attempt to access frame with URL about:blank from frame with URL file:///Users/raphael/Desktop/goetter.fr/node_modules/critical/node_modules/penthouse/lib/phantomjs/core.js. Domains, protocols and ports must match.\n. No emergency for me :)\nThat's very kind of you.\n. Sorry, i'm on holidays with very few connexion :/\n. \n",
    "jonorherrington": "Good point about the partials. I was thinking off the cuff when I wrote that down. \nThanks for the quick feedback. I look forward to seeing this feature added in an upcoming release. \n. ",
    "jmartsch": "Thank you for the quick reply and suggestion.\nI am looking forward to the next version :)\n. I thought of the same :) Thanks.\n. @bezoerb Yes I want to try it, what is the parameter for the remote resource? Could not find it in the readme. Just enter an URL in the src parameter?\n. As I installed this via npm I am getting an old version (0.6.0). Just have to figure out, how to get master branch via npm.\n. Running node_modules/.bin/critical http://localhost/mysite/www -m works.\nBut when I use gulp I get the following error:\nUnhandled rejection Error: A valid source and base path are required.\nHere is my gulp task\ncoffee\ngulp.task 'criticalCSS', ->\n  critical.generate\n    inline: false,\n    src: 'http://getbootstrap.com/'\n    minify: true\n  return\n. Bump. Any news on this?\n. It just doesn\u00b4t work. I updated to latest version, then\nran my gulp task\n``` coffee\ncritical = require('critical');\ngulp.task 'criticalCSS', ->\n  return critical.generate\n    src: 'http://www.heise.de'\n    base: './'\n    dest: './critical.css'\n```\nThen the task runs forever. It generates one temporary .html and two .css files. But the contents are always coming from getbootstrap.com and not from the domain I entered in src. Am I doing something wrong?\nAlso the resulting destination file \"critical.css\" is not written and the temp files are not deleted.\n. Maybe this is a problem on Windows? I am using Windows 10 (Win 8.1 at time of first writing) and tried it with node 4.2.1 and 0.12.7, but none of them finishes. I tried using penthouse directly and it ran fine.\nAlthough now after removing and reinstalling critical, the content gets pulled from heise.de, but using your code example also leaves the temp files, and the process does not finish. Seems like Phantomjs keeps running and doesn\u00b4t quit.\n. @bezoerb It works now but it does take a long time for the task to finish although gulp says the task is finished.\nPS C:\\xampp\\htdocs\\jmd> gulp critical\n[11:48:27] Requiring external module coffee-script/register\n[11:48:43] Using gulpfile C:\\xampp\\htdocs\\jmd\\gulpfile.coffee\n[11:48:43] Starting 'critical'...\n[11:48:43] Finished 'critical' after 7.69 ms\nAfter the message appears, the files are generated, but ending the process and deleting of the temporary files does take another 20-25 seconds after that in my case.\n. @bezoerb Thanks for taking your time looking into this :)\n. You\u00b4re the best. Thanks for everything :)\n. ",
    "pajtai": "I get a timeout with the example in the thread, and for remote html pages with absolute link, I get enoent errors\ne.g. <link href=\"/vendor/fontawesome/css/font-awesome.min.css\" rel=\"stylesheet\">\nproduces\nUnhandled rejection Error: ENOENT: no such file or directory, open 'vendor/fontawesome/css/font-awesome.min.css'\n    at Error (native). Maybe the absolute links are not being flagged as external due to the isExternal method. . I solved it with a test modification of my node_modules with a pretty ugly hack. If src is external than I passed a flag from core.appendStylesheets to file.resourcePath indicating that file.resourcePath should return the \"base url\" concated with the absolute url.\nMaybe including an opts.baseUrl could force all stylesheet links to be pulled in remotely, or there could be some other config to help indicate that you want all resources pulled in remotely? Assuming there might be some other places this affects things like absolute img urls, etc.. Edit: closed this pr, and rebased and sent a new pr.. Sent a pr https://github.com/addyosmani/critical/pull/197 that simply checks if opts.src is remote, and if it is, it assumes all stylesheets should be remote.\nIt's rebased to 1 commit.. Confirmed fixed on Critical v0.8.4. What are you using for opt.src? I'm assuming you can just use something that starts with http://. Something like http://0.0.0.0. I'm closing this pull request, since I see there's more work I have to do to get things to work.\nUsing a remote url for opts.base is not working as I thought it would.. Thanks for the info @bezoerb . I did see https:/jekyllrb.com in one of my console logs, and wasn't sure what caused it.. @bezoerb Works well, thanks!. Since critical is for usage in node, why not use the node core module instead of an npm?. ",
    "julienetie": "Sure:\nSo this is the css src \nbackground: #222 url('../funny-how.jpg') repeat-y;\nwhich critical outputs into the html as:\nbackground: #222 url('funny-how.jpg') repeat-y;\ngulpfile.js\ngulp.task('build-404-critical-css', ['build-404-css'], function() {\n    return critical.generateInline({\n        base: './',\n        src: './src/html/404.html',\n        css: ['./style/404.min.css'],\n        htmlTarget: './404/index.php',\n        exclude: true,\n        width: 1366,\n        height: 4000,\n        minify: true\n    });\n});\n. Thanks @bezoerb, I'll give it a try.\n. ",
    "SerzN1": "You must use option\npathPrefix: '/' + yourPath\nYour code will be immediately on the page.\n. Hi @addyosmani . Does not work today with gulp npm install --save critical.\n. ",
    "tigranpetrossian": "@bezoerb Works as charm. Thank you!\n. ",
    "vlrprbttst": "oh, so no way of using it on any php site?\nthanks!\n. thanks a lot! but do i still need to convert php to html? that's something I can't do unfortunatly\n. @pocketjoso thanks! that's what I'm using at the moment but I was thinking of switching cause your plugin doesn't extract all the relevant css.. some are missing and that creates a pretty ugly FOUC :/\n. oh ok! then I'll keep using penthouse then. I didn't understand your last statement, what do you mean?\nthanks anyway  @bezoerb \n. yes exactly :) i will!\n. ah! thanks :) is there a way to drop the /  - my project is a domain subfolder and I've just noticed that with the / in front of the url it is still looking for the resource in the wrong place (root of the domain). My base url is set to ./ in the html pages, but I wouldn't want to set an absolute url (which wouldn't work as well i guess)\n. i've been trying everything with no success :sob: \n. ",
    "killercup": "@addyosmani, thanks for the quick reply!\nHuh, the CI failed. There are a lot of errors outside anything related to streams, though.\n. I just ran the tests on the latest commit on master and they fail as well :(\nDid some dependencies update recently with breaking changes? (I also had some problem with npm3, but could hotfix them, see bezoerb/inline-critical#11.)\n. Meanwhile, everything works fine in my setup after it printed the error and I could fix a stupid typo in my paths. Oh, and my PageSpeed score just went from 91 to 100, so thank you for making critical :)\n. Thanks, @bezoerb. So, I guess this will be resolved after your branch is merged, then? I can wait until then :)\n. ",
    "ryanmargheriti": "I was having the same issue. I found explicitly setting the stylesheet (as well as having it in the html) fixed my problem. \n@petulla I see that you already setting the stylesheet so this won't fix your issue, but might be helpful for others who land on this page. \n. ",
    "eimfach": "The main file of penthouse is: https://github.com/pocketjoso/penthouse/blob/d5824c40132a6e5f63b6373a43c76a8ce693753e/lib/index.js\nthe exported function you promisify requires the options object and a callback (which I added). If an error occures, or the process exits, the callback is invoked with the sdtout of the phantomjs childprocess. According to the node api docs the sdtout stream could still be open, even if the process already exited. Therefore you need to destroy the delegated sdtout stream explicity in the critical module\n. But yes you are right, there is a string conversion.. Maybe this is the root problem with the race conditions we have\n. ",
    "cometta": "it is working. thank you.\n. ",
    "gisu": "And only on a index.html other Files like article.html have no doubled Inline CSS.\n. ",
    "patrikholcak": "Yup. Will do tomorrow.\n. Done and dusted. The test seems to pass fine!\n. ",
    "yahreen": "@bezoerb Here is a gist of the head output:\nhttps://gist.github.com/yahreen/703bd08b14f39377a82b\n. @bezoerb Commented back in Gist\n. @bezoerb That did the trick! Thanks a bunch!\n. ",
    "tarciozemel": "Just tried and still nothing; same error.  =/\nPS: I'm in a Vagrant environment, but all the other gulp tasks are OK, so I presume this is not influencing in nothing.\n. ",
    "Joostvanderlaan": "The method suggested by @bezoerb is best, to generate critical CSS for each file.\nThis is how I did it (using Gulp):\n``` javascript\n// Critical Render path CSS tasks - https://github.com/addyosmani/critical-path-css-demo#tutorial\ngulp.task('copystyles', function() { // Copy our site styles to a site.css file for async loading later\n    return gulp.src(['dist/styles/main.css'])\n        .pipe($.rename({\n            basename: 'site'\n        }))\n        .pipe(gulp.dest('dist/styles'));\n});\n// Generate & Inline Critical-path CSS\ngulp.task('critical', function(cb) {\n    runSequence(['default'], ['criticalhome', 'criticalblog'], cb);\n});\ngulp.task('criticalhome', ['copystyles'], function(cb) {\n    // At this point, we have our\n    // production styles in main/styles.css\n    // As we're going to overwrite this with\n    // our critical-path CSS let's create a copy\n    // of our site-wide styles so we can async\n    // load them in later. We do this with\n    // 'copystyles' above\n    critical.generate({\n        // Inline the generated critical-path CSS\n        // - true generates HTML\n        // - false generates CSS\n        inline: true,\n        base: 'dist/',\n        // HTML source file\n        // src: ['index.html','blog/index.html','typography/index.html'],\n        // src: 'index.html',\n        src: 'index.html',\n        // styleTarget: 'styles/main.css',\n        // Your CSS Files (optional)\n        css: ['dist/styles/main.css'],\n        // htmlTarget: 'index.html',\n        // Viewport width\n        width: 1300,\n        // Viewport height\n        height: 900,\n        // Target for final HTML output.\n        // use some css file when the inline option is not set\n        dest: 'dist/index.html',\n        // Minify critical-path CSS when inlining\n        minify: true,\n        // Extract inlined styles from referenced stylesheets\n        extract: true,\n        // ignore css rules\n        ignore: ['font-face']\n    }, cb);\n});\ngulp.task('criticalblog', ['copystyles'], function(cb) {\n    critical.generate({\n        inline: true,\n        base: 'dist/',\n        src: 'blog/index.html',\n        css: ['styles/main.css'],\n        width: 1300,\n        height: 900,\n        dest: 'dist/blog/index.html',\n        minify: true,\n        extract: true,\n        ignore: ['font-face']\n    }, cb);\n});\n```\n. I agree with @bezoerb since the install instructions now state npm install --save critical without -g.\nSo in case you want to keep preferglobal, I think it should be added in the readme.\n. ",
    "ospar0829": "Multiple HTML sources  will be very useful for AngularJS with multiple views, where all critical css of every view (at least home and landing pages) should be inline in the index.html\n. ",
    "JacobDB": "This would also be extremely useful for CMS builds, which arguably could use these kinds of speed improvements the most. I'm trying to get this working with WordPress, and there really doesn't appear to be an elegant way to do it. I can't really generate a new CSS file for every page, because there may be new pages created, or the site may be too large to make that feasible (having hundreds of custom header.php files for a gigantic site wouldn't really work).\nWhat I'd really like to be able to do is specify an array of \"key\" pages that get parsed, and a single combined critical gets output. Yes, there would be some unused code depending on the page being viewed, but this is a lot more practical than going the other route.\nUntil this is supported (and I know it may never be), my plan is to loop through a set of pages, generating CSS, and then cleaning it up any duplicate code and injecting it in to my header. It'll be kind of a mess, but it should work.. @stephenasamoah I ended up creating an array of one example page per template, using that to generate a critical CSS file for each template, and including it on each page that uses the same template. Seems to be working alright for me, but I'll definitely look in to your suggestions :). Yea, styles are linted, no errors that I'm aware of. The task I'm using is here, if that helps:\nhttps://github.com/JacobDB/new-site/blob/master/gulpfile.js#L117-L150\nI'm sure I'm doing something wrong, will look in to it when I have a bit more time and get back with what I find.. @jcklpe kind of, but honestly it's still something I struggle with. I think the main problem with my stuff is that I'm running on WSL, and there seems to be some issue with this module in WSL; last I checked it was working fine on Mac or Linux, but it's been a while since I've worked with it.. I just did a few more test cases:\n|Machine|System|Node Version|Status|\n|---|---|---|---|\n|1|Windows - WSL|v8.9.4|Failure|\n|1|Windows - CMD|v8.9.4|Success|\n|2|Windows - WSL|v6.10.3|Failure|\n|2|Windows - CMD|v.7.8.0|Success|\n|3|Windows - WSL|v8.9.4|Failure|\n|3|Windows - CMD|v8.9.4|Success|\n|4|Mac - Terminal|v7.0.0|Success|. Here's a repository containing my test script: https://github.com/JacobDB/critical-test. Interesting, thanks for that. There's a new update for Windows 10 coming out next month, maybe it'll fix whatever incompatibility that's causing this.. ",
    "stephenasamoah": "You're right, @JacobDB. Loop through the HTML files, concatenate the generated critical CSS files, then use a plugin like nano to remove duplicate code and minify the output.\nTo reduce the strain of unneeded critical CSS on per page basis, I use loadCSS to sift through the code and apply critical styles as needed.. ",
    "geosigno": "+1 enhancement for managing multiple HTML sources.. node -v => 4.2.3\n. I already try to remove it and add it again, without success.\nMy solution is very heavy and doesn't support any update of node for now...\nMaybe there is way to add \"regenerator-runtime/runtime\" manually?. By adding it manually the error is gone, but other errors appears... \nIs critical ready to be use with Gulp 4? And are you sure node 4 is the minimum version to have?. Unhandled rejection TypeError: this is not a typed array.\n    at Function.from (native)\n    at C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\critical\\lib\\file-helper.js:77:38\n    at bound (domain.js:280:14)\n    at runBound (domain.js:293:12)\n    at tryCatcher (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\util.js:16:23)\n    at MappingPromiseArray._promiseFulfilled (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\map.js:61:38)\n    at MappingPromiseArray.PromiseArray._iterate (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise_array.js:114:31)\n    at MappingPromiseArray.init (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise_array.js:78:10)\n    at bound (domain.js:280:14)\n    at MappingPromiseArray.runBound (domain.js:293:12)\n    at Promise._settlePromise (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise.js:566:21)\n    at Promise._settlePromise0 (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise.js:614:10)\n    at Promise._settlePromises (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise.js:693:18)\n    at Promise._fulfill (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise.js:638:18)\n    at MappingPromiseArray.PromiseArray._resolve (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise_array.js:126:19)\n    at MappingPromiseArray._promiseFulfilled (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\map.js:101:18)\n    at MappingPromiseArray.PromiseArray._iterate (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise_array.js:114:31)\n    at MappingPromiseArray.init (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise_array.js:78:10)\n    at bound (domain.js:280:14)\n    at MappingPromiseArray.runBound (domain.js:293:12)\n    at Promise._settlePromise (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise.js:566:21)\n    at Promise._settlePromise0 (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise.js:614:10)\n    at Promise._settlePromises (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise.js:693:18)\n    at Promise._fulfill (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise.js:638:18)\n    at MappingPromiseArray.PromiseArray._resolve (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise_array.js:126:19)\n    at MappingPromiseArray._promiseFulfilled (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\map.js:101:18)\n    at Promise._settlePromise (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise.js:574:26)\n    at Promise._settlePromise0 (C:\\projects\\mb\\trunk\\FrontCode\\node_modules\\bluebird\\js\\release\\promise.js:614:10). I update node from 4.2.4 to 4.8.0 with nvm and this is working now. Many thanks for the help @pocketjoso  :)\nPerhaps \"node\": \">=4.0\" in package.json should be updated, or maybe the issue was coming from myself with some corrupted repo...\n. ",
    "ethyde": "Ok, thanks.\n. ",
    "luckyraul": "@bezoerb @addyosmani any updates ? \n. ",
    "Inalkar": "@bezoerb I have encountered with the same issue. Can you look into it? FYI https://github.com/addyosmani/oust/pull/17 has been already implemented.. ",
    "bakaat": "Closed in favour of https://github.com/pocketjoso/penthouse/issues/102\n. ",
    "josenobile": "I use server push in HTTP2 (in https://www.hostingfacil.co). The resources can be pushed to the browser, but it won't be loaded/executed/utilized if not is called. Then, it only add speed in the download. I recommend still adding the critical CSS inline even if the css file is pushed.\n. I'm affected too. This bug is related to critical, penthouse or phantomjs? I want to fix it.. Related to https://github.com/joyent/node-http-signature/issues/70. ",
    "Tempurturtul": "Thanks bezoerb. Here's the error I'm now receiving in all cases (without Plumber, output is \"Fatal undefined\"):\nshell\n[07:35:29] Starting 'critical'...\n[07:35:29] Finished 'critical' after 30 ms\n[07:35:29] Plumber found unhandled error:\n Error in plugin 'critical'\nMessage:\n    Path must be a string. Received <File \"index.html\" <Buffer 3c 21 44 4f ... >>\n[07:35:29] Plumber found unhandled error:\n Error in plugin 'critical'\nMessage:\n    Path must be a string. Received <File \"views/foo.html\" <Buffer 3c 21 44 4f ... >>\n. Confirmed; thank you!\n. In index.js:\njavascript\nexports.stream = function (opts) {\n    // ...\n        var options = _.assign(opts || {}, {\n            // src: file\n            src: file.path\n        });\n    // ...\nSeems to provide correct behavior in test cases.\nShould I open a new pull request? I don't know the etiquette here and I greatly appreciate how quickly you worked on this. :+1: \n. ",
    "JakeHenshall": "Hi,\nI'm still having issues getting this to work.\nCan anyone help out.\nThanks.\n. @bezoerb I was using \"critical\": \"^0.6.0\" but since then ive updated to 0.7.1from npmjs\n\nCould it be todo with not having \".generate\".\nJake.\n. ",
    "edast": "there is still an issue, when you have css hosted on CDN, and in that css you have relative paths to assets, like backgrounds:\nbody {\n    background: #141414 url(../images/bg.jpg) left top repeat fixed;\n}\ncritical would include this asset with relative url, and in this case it would be fetched from webserver and then again from CDN\n. Having it as on option is beneficial at least for us - we can generate inline css before deployment and before hitting live environment. \nIt might be a good idea to detect where assets are coming from and insert domain automagically, but I would still want option to be able to override it.\nIf you can pass css files to be included directly from file system, then why not pass option to override domain?\n. ",
    "AllThingsSmitty": "Wow, I wasn't aware of those resources. Thanks, @pocketjoso. \ud83d\udc4d\ud83c\udffc\n. ",
    "akrawchyk": "I want this for https://github.com/addyosmani/critical/pull/142 thanks @bezoerb! \n. Actually on second thought, I didn't realize we're expecting the loadCSS to be added to the page with the inline option set. I like this more! I've been adding the rel=\"preload\" links to my HTML manually and running critical over that. Instead this automates it.\n. Note, this depends on https://github.com/addyosmani/oust/pull/19. I've updated the package.json with the repo for the changes to the oust package as an example.\n. These tests fail with the current master on node v6.2.1 branch as well:\n1. CLI acceptance should work well with the critical CSS file passed as an option\n2. CLI acceptance should work well with the critical CSS file piped to critical\n3. CLI acceptance (remote) should generate critical path css from external resource\nSeems to be related to https://github.com/nodejs/node/issues/3389 since the data returned from the call to execFile is a Buffer.\n. I believe this is the issue causing failing tests https://github.com/nodejs/node/issues/6666.\nSeems from https://github.com/nodejs/node/blob/357f904169c39bbc9c2d8558bbffce2337c83c1b/lib/child_process.js#L153 the buffer is not recognized as the expected encoding.\nTo workaround, I've casted the output from stdout as strings. If the output is already a string, it will remain a string, but if it's a buffer, it'll be converted to a string.\n. So I'm wondering if https://github.com/addyosmani/critical/pull/129 is a better idea. I'm pleased oust supports preload links, but I noticed inline-critical automates the preload pattern.\nThis still might be useful, however, if there are manually added preload links in the HTML that critical will parse. Perhaps both PR's make sense?\n. ",
    "miralize": "Experiencing the same issue. Gulp 3.9.1 & Node v6\nUsing directly with the cli outputs the same issue\nnode_modules/.bin/critical https://lovindublin.com/ -m\nError: Wrong status code 403 for [object Object]\n   Usage: critical <input> [<option>]\n. Trying node_modules/.bin/critical http://dev.lovindublin.com/ -m\nError: Wrong status code 403 for [object Object]\n   Usage: critical <input> [<option>]\ncURL curl http://dev.lovindublin.com/\n\nHTTP/1.1 200 OK\nServer: nginx/1.10.0\nDate: Sat, 07 May 2016 21:25:23 GMT\nContent-Type: text/html; charset=utf-8\nConnection: keep-alive\nSet-Cookie: CraftSessionId=xxxxx; path=/; HttpOnly\nExpires: Thu, 19 Nov 1981 08:52:00 GMT\nCache-Control: no-store, no-cache, must-revalidate\nPragma: no-cache\ncharset: utf-8\n\n<full html of page>\nHave you tried the cli with node v6?\n. I think I found the issue for me at least. I use a font service from typography.com and they redirect a css file to a local css file. It seems the css wont follow redirects\n        <link href=\"//cloud.typography.com/6020032/784002/css/fonts.css\" rel='stylesheet' />\nIf I take that line out or include only my main css file, it compiles\n. Yes this works thanks @bezoerb ! \ud83c\udf7b \nIgnoring http://cloud.typography.com/6020032/784002/css/fonts.css (403 Forbidden)\n. @mikeebee Change the line in your package.json where critical is set to \"critical\": \"addyosmani/critical#a4eea4bd41c547d00acaf31e4412c6e58d25308f\",\n. ",
    "mikeebee": "@bezoerb sorry to be a simpleton but how do I use the master branch? The npm package doesn't seem to have changed.\n. @miralize thanks!\nOk, it now appears to be ignoring the page I pointed it at. Also, I'm getting these errors...\n[12:52:27] Starting 'critical'...\nIgnoring http://localurl.dev/ (403 Forbidden)\nIgnoring http://localurl.dev/ (403 Forbidden)\nIgnoring http://localurl.dev/ (403 Forbidden)\nUnhandled rejection TypeError: Bad argument\n    at TypeError (native)\n    at ChildProcess.spawn (internal/child_process.js:274:26)\n    at exports.spawn (child_process.js:339:9)\n    at module.exports (projectdir/node_modules/penthouse/lib/index.js:67:8)\n    at tryCatcher (projectdir/node_modules/critical/node_modules/bluebird/js/release/util.js:16:23)\n    at ret (eval at <anonymous> (projectdir/node_modules/critical/node_modules/bluebird/js/release/promisify.js:184:12), <anonymous>:13:39)\n    at projectdir/node_modules/critical/lib/core.js:155:24\n    at run (projectdir/node_modules/core-js/modules/es6.promise.js:104:47)\n    at projectdir/node_modules/core-js/modules/es6.promise.js:115:28\n    at flush (/Users/mike/Sites/the-australian-ballet/node_modules/core-js/modules/$.microtask.js:19:5)\n    at doNTCallback0 (node.js:417:9)\n    at process._tickCallback (node.js:346:13)\n. Yeah, all good. Took 8 seconds.\n. Sure thing, what info would be helpful?\n. ",
    "dimbslmh": "Yes, that's what I need. Thanks for the fast response.\n. ",
    "jmarantz": "The reference from PageSpeed Insights is live, in the second note below the example: https://developers.google.com/speed/docs/insights/OptimizeCSSDelivery#example\n. ",
    "thadeetrompetter": "134\n. Wonder if the uncaughtException handler is needed in the first place. After all, an uncaught exception bubbling up to process will trigger an exit event anyway an initiate the cleanup process. The only thing you'll be missing out on would be making the process exit with code 99 from the uncaughtException handler, but does that matter?\n. @bezoerb: Can we agree that this issue has been resolved now?\n. ",
    "caraya": "I reinstalled critical from NPM and now it works. Can't figure out what caused the error. Sorry for the noise\n. ",
    "hinok": "I've found that critical generates the same, one big CSS file in /tmp dir for \"new recommended loadCSS usage\" and standard <link rel=\"stylesheet\"...>.\nThat CSS file is then passed to penthouse so probably this issue is related to penthouse / phantomjs.\n. @addyosmani Sorry for that long time. It's solved, thank you.\n. ",
    "vladh": "Done! :)\n. ",
    "sp90": "Wasn't critical sorry\n. ",
    "chasegiunta": "Also experiencing this... Related to #60 possibly? Not placing temp files in any directory, instead placing them in project root.\n. ",
    "leogdion": "Fixed spaces in table\n. I'd prefer @bezoerb request #178 and I am no longer using this library regardless.. Yes\n. done. let me know if there is anything else.\n. ",
    "hmagrini": "Yeah, I forgot to update sorry.\nSo the issue was that some invalid css was being bundled during compile, I didn't realize until I run CSSLint against the bundle. What makes this annoying is that both the SASS compiler and Penthouse fail silently.\n. ",
    "zenopopovici": "@bezoerb Yep. Closing. Sorry.\n. ",
    "bikubi": "In a similar situation, I had the same error message; in my case dist/main.css was missing, resp. wasn't there yet.\n. ",
    "joshmoyers": "I have been getting the same issue as well. I have learned that I can do individual html files, but only if I reference that file directly (example: dist/index.html instead of dist/.html or dist/__/.html)\n. ",
    "ValentinBrclz": "I am getting the same error now... it would be great if this issue serves to improve the error reporting of the script.\n. ",
    "herrkessler": "same here. javascript\ngulp.task('critical', function () {\n    return gulp.src('dist/*.html')\n        .pipe(critical({\n            base: 'dist/', \n            inline: true, \n            minify: true, \n            pathPrefix: '/', \n            css: ['dist/css/app.css']\n            }))\n        .on('error', err => log(colors.red(err.message)) )\n        .pipe(gulp.dest('dist'));\n});\nleads to:\n[10:04:45] Penthouse timed out after 30s.\nFrom what I see from the Penthouse issues, it's phantomjs that gets stuck with some network settings and/or external assets.. @pocketjoso Thanks for you effort, I made it myself, changed some paths here and there, now it works.. ",
    "rwwagner90": "@addyosmani any suggestions?\n. ",
    "carpusmedia": "Strange, re-ordered a few things in the CSS file, now html.test as a selector seems to work fine as well.\nWas a problem on our end.\nThanks!\n. ",
    "thany": "Currently on a holiday, so I will when I return and have some time to get the project running again. Sorry for the delay.. Sorry, the project this was for, had been discontinued. So I don't know if this issue is still on.. ",
    "bambamboole": "yeah perfect!\n. ",
    "nealoke": "This only occurs if the critical({ base }) is different then the gulp.dest() path\n. @pajtai any documentation on how to actually use this for localhost? I tried lots of configs but still can't get it to work. Thanks!. Below is my current config which doesn't throw any error however does not get the critical css. It does include the .popup styles though. Thanks for looking into it!\nNote that my gulpfile is in a sibling folder of the application, hence the ../app/styles/...\n{\n    inline: false,\n    pathPrefix: 'http://localhost/nest',\n    base: 'app/',\n    css: '../app/styles/global.css',\n    dimensions: [\n        {\n            width: 320,\n            height: 650\n        },\n        {\n            width: 1200,\n            height: 900\n        }\n    ],\n    ignore: [/url\\(/, '@font-face'],\n    include: ['.popup']\n}. ",
    "gmhenderson": "Here's the error I'm seeing (not sure if it's the same as you):\n[10:30:31] Error: self signed certificate\n    at Error (native)\n    at TLSSocket.<anonymous> (_tls_wrap.js:1060:38)\n    at emitNone (events.js:86:13)\n    at TLSSocket.emit (events.js:185:7)\n    at TLSSocket._finishInit (_tls_wrap.js:584:8)\n    at TLSWrap.ssl.onhandshakedone (_tls_wrap.js:416:38)\nThis is actually an error from request. A quick and dirty hack is to replace line 85 of file-helper.js with:\nrequest({url: uri, strictSSL: false}, function (err, resp) {\nThe strictSSL option needs to be set to false.\n. ",
    "spAnser": "I managed to fix this by putting this at the top of my javascript.\njavascript\nprocess.env.NODE_TLS_REJECT_UNAUTHORIZED = \"0\". ",
    "schoenwaldnils": "@addyosmani Yes, I do. But I now saw that there is a .steam missing in the require for gulp.\nAlso missing in your tutorial:\nhttps://github.com/addyosmani/critical-path-css-demo#tutorial\nBut even if I add the steam, then I get following:\nTypeError: critical.generate is not a function\n    at Gulp.<anonymous> (/Users/nils/repos/schoenwaldnils/blog/gulpfile.babel.js:298:12)\n    at module.exports (/Users/nils/repos/schoenwaldnils/blog/node_modules/orchestrator/lib/runTask.js:34:7)\n    at Gulp.Orchestrator._runTask (/Users/nils/repos/schoenwaldnils/blog/node_modules/orchestrator/index.js:273:3)\n    at Gulp.Orchestrator._runStep (/Users/nils/repos/schoenwaldnils/blog/node_modules/orchestrator/index.js:214:10)\n    at Gulp.Orchestrator.start (/Users/nils/repos/schoenwaldnils/blog/node_modules/orchestrator/index.js:134:8)\n    at /usr/local/lib/node_modules/gulp/bin/gulp.js:129:20\n    at _combinedTickCallback (internal/process/next_tick.js:67:7)\n    at process._tickCallback (internal/process/next_tick.js:98:9)\n    at Module.runMain (module.js:592:11)\n    at run (bootstrap_node.js:394:7)\n    at startup (bootstrap_node.js:149:9)\n    at bootstrap_node.js:509:3. ",
    "jonathanmelville": "Sadly I'm having the same problem and I'm not able to get past it:\n[09:27:06] Starting 'critical'...\n[09:27:07] Finished 'critical' after 1.58 s\nUnhandled rejection TypeError: Bad argument\n    at ChildProcess.spawn (internal/child_process.js:289:26)\n    at exports.spawn (child_process.js:385:9)\n    at generateCriticalCss (/Users/jonathanmelville/boxes/atlantaballet/node_modules/penthouse/lib/index.js:95:10)\n    at process._tickCallback (internal/process/next_tick.js:103:7). ",
    "scottsweb": "Seeing similar errors on my build today too:\nUnhandled rejection TypeError: Bad argument\n    at TypeError (native)\n    at ChildProcess.spawn (internal/child_process.js:274:26)\n    at exports.spawn (child_process.js:362:9)\n    at generateCriticalCss (/home/scott/Sites/admin-console/node_modules/penthouse/lib/index.js:102:10)\n    at process._tickCallback (node.js:368:9). ",
    "YewTreeWeb": "I am also getting a similar error for when I try with Shopify and Jekyll\nUnhandled rejection Error: Unable to open config: \"/Users/mathew/Websites/shopify/lavida_new/node_modules/penthouse/lib/phantomjs/config.json\"\nError opening url 'undefined': undefined\n    at ChildProcess.<anonymous> (/Users/mathew/Websites/shopify/lavida_new/node_modules/penthouse/lib/index.js:291:29)\n    at emitTwo (events.js:106:13)\n    at ChildProcess.emit (events.js:191:7)\n    at Process.ChildProcess._handle.onexit (internal/child_process.js:215:12). @pocketjoso Thank you for the sending me the link to the config and for the bug fix.. ",
    "jadchaar": "Had this error as well, and it seems like an install issue like pocketjoso said. I suspect it was an issue with installing the package and getting a halt with a \"run as root/administrator\" prompt. This could have corrupted the installation. I fixed it by clean installing the package with the following commands:\nsudo npm uninstall critical\nsudo npm install critical --save-dev. ",
    "LordRembo": "@amorphine  I'm having a similar issue. I have a url containing a '-' that is giving me the same 500 error when Gulp tries to run critical. Did you find a solution for this?. ",
    "Pustelto": "Ok, thanks. I just wasn't sure if this is desired behavior or not, it wasn't clear from docsumentation.. ",
    "yesman82": "Conflicts fixed with pull request #224 . ",
    "emix7": "Hi Bezoerb,\nthank you for replying and sorry my late reply\nmy config is:\n// https://github.com/addyosmani/critical\ngulp.task('critical', function(cb) {\n    critical.generate({\n        base: 'public/tmpl/common',\n        src: 'http://localhost/site.com/public/',\n       // css: ['public/css/main.css'],\n     css: ['src/css/newstyle.css'],\n        dimensions: [{\n            width: 320,\n            height: 480\n        }, {\n            width: 768,\n            height: 1024\n        }, {\n            width: 1280,\n            height: 960\n        }],\n       // dest: '_templates/critical_css_home.css',\n       dest: 'critical_css_home.html',\n        extract: false,\n       inline:true,\n          minify: false,\n        pathPrefix: 'http://localhost/site.com/public/',\n       // include: ['.c-slideshow, .c-more-to-see, .c-slideshow-gallery__container, .c-loader, .c-slideshow--hero'],\n       // exclude: ['@font-face']\n    });\n});\nand in the source .css I have things like:\n@font-face {\n  font-family: 'Jura';\n  src: url(../assets/fonts/Jura.eot); / IE9 Compat Modes /\n  src: url('../assets/fonts/Jura.eot?#iefix') format('embedded-opentype'), / IE6-IE8 /\n       url('../assets/fonts/Jura.woff2') format('woff2'), / Super Modern Browsers /\n       url('../assets/fonts/Jura.woff') format('woff'), / Pretty Modern Browsers /\n       url('../assets/fonts/Jura.ttf')  format('truetype'), / Safari, Android, iOS /\n       url('../assets/fonts/Jura.svg#svgFontName') format('svg'); / Legacy iOS /\n}\nthank you!. ",
    "HugoHeneault": "I have the same issue. :(\nAre font-face handled?. ",
    "kenshaw": "Sorry, forgot to mention that this causes a \"flash of unstyled content\" on the v5 version prior to the maxcdn css being retrieved.. Not sure if this is helpful or not, but I also just checked the bootstrap v4 alpha 3 and alpha 4, and they include the correct classes.. Thanks for the quick response. I can confirm that using the non-minified version of Bootstrap makes this issue go away.\nReally confusing though, but I really appreciate you guys working on this! Many thanks!. ",
    "lukebussey": "I'm running into the same issue, but because of my particular build process, I can't unminify the CSS beforehand.\nThe parsing issue is caused by this line in Bootstrap's _variables.scss file:\nsass\n$navbar-light-toggler-bg: url(\"data:image/svg+xml;charset=utf8,%3Csvg viewBox='0 0 32 32' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath stroke='#{$navbar-light-color}' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 8h24M4 16h24M4 24h24'/%3E%3C/svg%3E\");\nThe part causing the problem is the stroke color: stroke='#{$navbar-light-color}' which is compiled to: stroke='rgba(0,0,0,.5)'\nChanging this to a solid hex color E.g. stroke='#7F7F7F' fixes the issue.\n. ",
    "midzer": "Great find @lukebussey \nLets see if i can dig more into this issue.. Tbh i have no clue where to start on this issue :[\nFurthermore with quick fix from @lukebussey it appears latest v1+ critical extracts only navbar components for me. This results in too less CSS being inlined for my project. Too bad I had to revert to v0.8.4.. @lukebussey It appears latest penthouse doesn't need this bootstrap hack any more.\nMiserably, there is still some CSS missing for my critical gulp task.\nI tried the online version via https://jonassebastianohlsson.com/criticalpathcssgenerator/ and all necessary CSS is extracted.\n@pocketjoso I have no idea where to look. Do you have any idea what is wrong with my critical task config? Thanks in advance! https://github.com/midzer/eisolzried/blob/master/_tasks/critical.js. @pocketjoso in my build environment package.json of penthouse in node_modules folder states I'm currently using version 1.3.0.. Bumping this one as css generated from latest critical still differs from css generated from https://jonassebastianohlsson.com/criticalpathcssgenerator/\nMy critical config:\ninline: true,\nbase: '_site/',\ncss: ['_site/assets/css/main.min.css'],\nminify: true\nSite: https://feuerwehr-eisolzried.de/\nHaving a quick look what is missing: all carousel class, all necessary col-* classes, row class.. @pocketjoso Thx for your reply\nAll styles are located in main.min.css. Specifying this file in css parameter makes no difference either.. I really don't know whats going on there :\\\nHere's a diff between online generator css (left) and inlined critical css (right) using before stated settings https://www.diffchecker.com/ysBsWWiz. First of all thx again for your help @pocketjoso and @bezoerb \nI figured out whats going on! Finally using local production build critical css is being fully generated same as via online gerator or critical cli + url.\nRight now there's a caveat though. It's only fully generated if I specify\n<link rel=\"stylesheet\" href=\"assets/css/main.css\">\nin HTML <head> instead of regular\n<link rel=\"stylesheet\" href=\"/assets/css/main.css\">\nBut I need this beginning / as otherwise other sub-pages could't find respective css file any more.\nAfter digging in some related issues I tried to specify \"\" for pathPrefix but this is of no help at all.\nSetting optional css parameter to ['_site/assets/css/main.css'] didn't work, too.. Update to previous post:\nI still can't inline full critical CSS automatically and have to do it manually which is kinda annoying.\nIf some1 has time to help me out on this issue, would be really awesome.. After updating npm packages yesterday I discovered not all critical CSS being extracted any more.\nUpdating to current master didn't solve it, too.. @bezoerb I'm using stream call anyway. Here's my gulp task https://github.com/midzer/eisolzried/blob/master/_tasks/critical.js. Basically i wanted to achieve a theme switch by clicking on a button in my website.\nFirst of all, i have a regular main.min.css and right below i used a link with no href and populated its value with JS on button click to have extended css loaded for a new theme. Worked like charm for all tested browsers. Miserably this link without href resulted in a warning by Chromium 59.\nSo i tried to put href=\"\" making critical crash in one of its depencies (took me quite a while to figure out the involved commit g). If you like, i open a seperate issue for this one.\nSurfing the web, i stumbled upon disabled attribute. Thanks for your link to MDN. I think i have to bookmark this one :+1: \nContrary to your example, my initial, disabled link looks like the following:\n<link rel=\"stylesheet\" id=\"theme-link\" href=\"SOMEPROPERPATH\" disabled>\nresulting in\n<link rel=\"preload\" id=\"theme-link\" href=\"SOMEPROPERPATH\" disabled=\"disabled\">\nedit:\nThanks again for your answer, @bezoerb \nI followed your posted MDN advice by setting disabled property via scripting which works flawlessly for all browsers.. @bajras Try to specify your .css file path directly via criticalCSS css config parameter. ",
    "borisirota": "Sure. I created issue 149. Thanks !. Fixed !. ",
    "SergeyYermak": "@pocketjoso: I have some text at the top of my page. It slides from one side to center when page is opening. But with critical css it just stands still at the center.. @pocketjoso yep, it is some js that initiates it. My code animates elements when they are in the viewport. So the top part of the page needs to be animated from the beginning. It adds css class that changes elements position and opacity (depending on transition property that should be there allready).. It would be nice to have some option to include those removed properties.. ",
    "davidhellmann": "Looks fine, sorry no notifications.. Looks like some dependencies faults. \nIn old projects all fine but when I delete the node_modules folder and do a yarn install it's broken. \nmeeeeeeeeeh :D. const criticalDest = element.template + '_critical.min.css'\nwhen I change the line above to this it works\nconst criticalDest = config.dist.markup + element.template + '_critical.min.css'\nLooks like base doesn't work?\nbase: config.dist.markup,. ",
    "joaogarin": "Currently having the same issue, where you able to find out the problem?. ",
    "gCardinal": "No, I tried to figure it out some more after I posted this, but couldn't find the solution. I also don't know those libraries very well so it's difficult for me to figure out what causes the issue.. ",
    "connor-baer": "I just ran into the same issue and found a solution. @gCardinal, your investigation pointed me into the right direction. Thank you!\nThe problem is that - for whatever reason - Phantom wasn't actually installed by phantomjs-prebuilt. The phantom folder and the location.js file are missing in the lib folder. You can fix this by running...\nnpm install phantomjs-prebuilt --phantomjs_cdnurl=https://bitbucket.org/ariya/phantomjs/downloads\n...as stated in the phantomjs-prebuilt documentation.. ",
    "swlopes": "I got it working by downgrading to version 0.8.0. ",
    "DzmVasileusky": "@swlopes thanks for advice.\nI ended with using \nvar exec = require('child_process').exec;\ngulp.task('criticalmain', function() {\n  exec('node critical.js');\n});\nAnd in the critical.js all the critical generators.. ",
    "codewithpassion": "Same problem here. Fixed with downgrading to 0.8.. ",
    "SirBirdy": "with 0.8.4 I alos get this error \n\nUnhandled rejection Error: File.contents can only be a Buffer, a Stream, or null.\n\nedit: solved it also with exec ->\ngulp.task('critical', function (cb) {\n    exec('node critical.js', function (err, stdout, stderr) {\n        console.log(stdout);\n        console.log(stderr);\n        cb(err);\n    });\n});. ",
    "ghost": "with v. 0.8.4 I have this problem too. Can someone help with this problem ?. @bezoerb sorry, but I did not really understand the task (probably due to the fact that I do not have a high level of programming), but I really like your plugin and I would like to work with it.\nBelow I quote a link to the Gulp configurator and screenshots of how the project looks at the moment and what its structure is. If you need to take a more detailed look, I can upload the project to GitHub.\n```\nvar gulp = require(\"gulp\"),\nsass = require(\"gulp-sass\"),\npug = require(\"pug\"),\nhtmlmin = require(\"gulp-htmlmin\"),\ngulpRemoveHtml = require('gulp-remove-html'),\n\nuncss = require(\"gulp-uncss\"),\nautoprefixer = require(\"gulp-autoprefixer\"),\ncombineMq = require(\"gulp-combine-mq\"),\ncleanCss = require(\"gulp-clean-css\"),\nsourcemaps = require(\"gulp-sourcemaps\"),\n\nuseref = require('gulp-useref'),\nuglify = require('gulp-uglify'),\ngulpif = require('gulp-if'),\ncssnano = require('gulp-cssnano'),\nstyleInject = require(\"gulp-style-inject\"),\nrename = require(\"gulp-rename\"),\n\nchanged = require('gulp-changed'),\ncache = require(\"gulp-cache\"),\ndel = require(\"del\"),\n\nimagemin = require(\"gulp-imagemin\"),\nimageminSvgo = require(\"imagemin-svgo\"),\nimageminPngquant = require('imagemin-pngquant'),\nimageminWebp = require('imagemin-webp'),\nimageminMozjpeg = require('imagemin-mozjpeg'),\nwebp = require('gulp-webp'),\n\nnotify = require(\"gulp-notify\"),\nplumber = require(\"gulp-plumber\"),\n\nbrowserSync = require(\"browser-sync\"),\nconnect = require('gulp-connect-php'),\ncritical = require('critical'),\n\nrunSequence = require(\"run-sequence\");\n\nvar paths = {\n    mainHtml: \".Full/index.html\",\n    allHtml: \".Full//*.html\",\n    mainScss: \".Full/scss/main__jump.scss\",\n    headerScss: \".Full/scss/header__jump.scss\",\n    footerScss: \".Full/scss/footer__jump.scss\",\n    allScss: \".Full/scss//.scss\",\n    allJs: \".Full/js//*.js\",\n    mainPhp: \".Full/index.php\",\n    allPhp: \".Full//.php\",\n    allCss: \".Full/css/*.css\",\ndestPath: \".Full/\"\n\n}\ngulp.task(\"sassNow\", function () {\n    return gulp.src(paths.mainScss)\n        .pipe(changed('.Full/css'))\n        .pipe(sourcemaps.init())\n        .pipe(sass()).on('error', console.log.bind(console))\n        .pipe(autoprefixer({browsers: ['last 2 versions', '>5%', 'IE 8', 'IE 9']}))\n        .pipe(cleanCss({compatibility: \"ie8\"}))\n        .pipe(combineMq({\n            beautify: true\n        }))\n        .pipe(uncss({\n            html: [paths.mainHtml],\n            ignore: [/.is-active/, /.is-hide/, /.error/, /.valid/, /.animated/]\n        }))\n        .pipe(sourcemaps.write(\"./\"))\n        .pipe(gulp.dest(\".Full/css\"))\n        .pipe(browserSync.reload({\n            stream: true\n        }))\n});\ngulp.task(\"sassHead\", function () {\n    return gulp.src(paths.headerScss)\n        .pipe(changed('.Full/css'))\n        .pipe(sourcemaps.init())\n        .pipe(sass())\n        .pipe(autoprefixer({browsers: ['last 2 versions', '>5%', 'IE 8', 'IE 9']}))\n        .pipe(cleanCss({compatibility: \"ie8\"}))\n        .pipe(combineMq({\n            beautify: true\n        }))\n        .pipe(uncss({\n            html: [paths.mainHtml],\n            ignore: [/.is-active/, /.is-hide/, /.error/, /.valid/, /.animated/]\n        }))\n        .pipe(sourcemaps.write(\"./\"))\n        .pipe(gulp.dest(\".Full/css\"))\n        .pipe(browserSync.reload({\n            stream: true\n        }))\n});\ngulp.task(\"sassFooter\", function () {\n    return gulp.src(paths.footerScss)\n        .pipe(changed('.Full/css'))\n        .pipe(sourcemaps.init())\n        .pipe(sass())\n        .pipe(autoprefixer({browsers: ['last 2 versions', '>5%', 'IE 8', 'IE 9']}))\n        .pipe(cleanCss({compatibility: \"ie8\"}))\n        .pipe(combineMq({\n            beautify: true\n        }))\n        .pipe(uncss({\n            html: [paths.mainHtml],\n            ignore: [/.is-active/, /.is-hide/, /.error/, /.valid/, /.animated/]\n        }))\n        .pipe(sourcemaps.write(\"./\"))\n        .pipe(gulp.dest(\".Full/css\"))\n        .pipe(browserSync.reload({\n            stream: true\n        }))\n});\ngulp.task(\"images\", function () {\n    return gulp.src(\".Full/img/*/.+(png|jpg|gif|svg|ico)\")\n        .pipe(cache(imagemin({\n            progressive: true,\n            progressive: true,\n            imageminSvgo: {removeViewBox: false, cleanupAttrs: false},\n        use: [\n                imageminPngquant({\n                    verbose: \"true\",\n                    quality: '50-65',\n                    speed: 1\n                }),\n                // imageminSvgo({\n                //     plugins: [\n                //         {removeViewBox: false, cleanupAttrs: false}\n                //     ]\n                // }),\n                imageminMozjpeg({\n                    progressive: true\n                })\n                // imageminWebp({\n                //     quality: 50,\n                //     method: 6\n                // })\n            ]\n        })\n    ))\n    .pipe(gulp.dest(\"Clean/img\"));\n\n});\ngulp.task('convertInWebP', function () {\n    return gulp.src('.Full/*/.{jpg,png}')\n        .pipe(webp({\n            quality: 5,\n            method: 1\n        }))\n        .pipe(gulp.dest('.Full/'))\n});\ngulp.task(\"fontsTransition\", function () {\n    return gulp.src(\".Full/fonts//*\")\n        .pipe(gulp.dest(\"Clean/fonts\"))\n});\ngulp.task(\"videoTransition\", function () {\n    return gulp.src(\".Full/video//\")\n        .pipe(gulp.dest(\"Clean/video\"))\n});\ngulp.task(\"phpTransition\", function () {\n    return gulp.src(\".Full//.php\")\n        .pipe(gulp.dest(\"Clean/\"))\n});\ngulp.task(\"baseFileTransition\", function () {\n    return gulp.src(\".Full/.+(png|jpg|txt|php|ttf)\")\n        .pipe(gulp.dest(\"Clean/\"))\n});\ngulp.task(\"accessTransition\", function () {\n    return gulp.src(\".Full/.htaccess\")\n        .pipe(gulp.dest(\"Clean/\"))\n});\ngulp.task(\"webpTransition\", function () {\n    return gulp.src(\".Full//.+(webp)\")\n        .pipe(gulp.dest(\"Clean/\"))\n});\ngulp.task(\"useref\", function () {\n    return gulp.src(\".Full/html\")\n        .pipe(useref())\n        .pipe(gulpif('.js', uglify()))\n        .pipe(gulpif('.css', cssnano({zindex: false})))\n        // .pipe(gulpif('.html', htmlmin({collapseWhitespace: true})))\n        .pipe(gulp.dest('Clean'));\n});\ngulp.task(\"clean\", function () {\n    return del.sync(\"Clean\").then(function (cb) {\n        return cache.clearAll(cb);\n    });\n});\ngulp.task(\"clean:dist\", function () {\n    return del.sync(['Clean/*/']);\n});\ngulp.task(\"browserSync\", function () {\n    browserSync.init({\n        server: {\n            baseDir: \".Full/\"\n        }\n        // proxy: \"jump.dev\"\n    })\n});\ngulp.task(\"inlineStyle\", function () {\n    return gulp.src(\"Clean/index.html\")\n        .pipe(styleInject({\n            encapsulated: true,\n            read: false,\n            path: 'Clean/'\n        }))\n        .pipe(gulp.dest(\"Clean\"));\n});\ngulp.task('cleaningProductHtml', function () {\n    return gulp.src('Clean/*.html')\n        .pipe(gulpRemoveHtml())\n        .pipe(gulp.dest('Clean/'));\n});\ngulp.task(\"createIndexPhp\", function () {\n    return gulp.src('Clean/index.html')\n        .pipe(rename('index.php'))\n        .pipe(gulp.dest('Clean/'));\n})\ngulp.task('critical', function (cb) {\n    critical.generate({\n        inline: true,\n        base: '.',\n        src: '.Full/index.html',\n        css: '.Full/css/main__jump.css',\n        dest: 'Full.css',\n        minify: true,\n        width: 320,\n        height: 480,\n        extract: true,\n        ignore: ['font-face']\n    }, cb);\n});\ngulp.task(\"watch\", [\"browserSync\", \"sassNow\", \"images\", \"fontsTransition\", \"videoTransition\", \"baseFileTransition\"], function () {\n    gulp.watch(paths.allScss, [\"sassNow\"]);\n    gulp.watch(paths.allCss).on(\"change\", browserSync.reload);\n// gulp.watch(\"Full/*.html\", browserSync.reload);\ngulp.watch(paths.mainHtml).on(\"change\", browserSync.reload);\n// gulp.watch(paths.allHtml).on(\"change\", browserSync.reload);\n// gulp.watch(paths.mainPhp).on(\"change\", browserSync.reload);\ngulp.watch(paths.allPhp).on(\"change\", browserSync.reload);\ngulp.watch(paths.allJs).on(\"change\", browserSync.reload);\n\n});\ngulp.task('default', function (callback) {\n    runSequence(['sassNow', 'browserSync', 'critical', 'watch'],\n        callback\n    )\n});\ngulp.task('build', function (callback) {\n    runSequence(\n        'clean:dist',\n        // ['sassHead', 'sassFooter'],\n        ['sassNow', 'useref', 'images', 'fontsTransition', 'videoTransition', \"baseFileTransition\", \"phpTransition\", \"webpTransition\", \"accessTransition\"],\n        // 'inlineStyle',\n        'cleaningProductHtml',\n        // \u0415\u0441\u043b\u0438 \u043d\u0443\u0436\u0435\u043d index.php\n        // 'createIndexPhp',\n        'critical',\n        callback\n    )\n});\n```\nand screenshots:\nhttp://joxi.ru/Y2L4LnGcpW9w26\nhttp://joxi.ru/4AkQwdxT68yKmq\n. ",
    "fbosch": "@bezoerb: I'm still having issues with inconsistent file sizes.\nI don't, however, think it has anything to do with differences between stream and generate method any longer.\nI've noticed that if i'm doing something computationally intensive, while generating the styles; I tend to get a larger file size. Could some timeout have anything to do with it?. I think I've found out why now... I deferred loading of styles while generating the critical path css, don't do that.. ",
    "libertarismus": "@pocketjoso  I have linted my sass files now and only got warnings using scss-lint and afterwards linted my css files using csslint and got one error.\nThe error was removed when i switched the outputstyle of sass from compressed to expanded so I have only warnings now and mostly unimportant stuff about the alphabetical order of attributes.\nThe problem with critical persists though.\nThe webproject which has the problem is commited to the following branch:\nhttps://github.com/libertarismus/libertarianism.info/tree/criticaldebug\nI build it using the command:\ngrunt myserv. ",
    "richhollis": "Later raised #195 is the same problem I have. I will close this issue as #195 has been assigned bug status.. @bezoerb Sure. Just tested it here - looks good. Generating now for location urls. Thanks!. ",
    "jcklpe": "@JacobDB  did you ever get this working with Wordpress? I'm trying to webpackify my asset management for WP theme development. . I am also running WSL haha so yeah, that would probably be a problem for me too. \nI currently do my critical path CSS using the wp plugin Autoptimize, but it has a lot of manual requirements and I'd love to find a way to do it that's more straightforward and automatic. I'd even be up for using a PHP serverside solution but it seems that all the WP plugins that are built for that are paid subscriptions and I prefer to not get vendor lock in. . ",
    "laurenskling": "I get Error: Cannot find module \".\" importing critical in a webpack2 build. :(. ",
    "Jacfem": "Not sure if you're still curious about it, but I'm currently trying to integrate with this plugin that's a webpack wrapper around critical: https://github.com/nrwl/webpack-plugin-critical\n. ",
    "neoswf": "we are using it in our project, together with a on-build-webpack plugin. After build has finished, inside the callback we call CriticalCSS.generate(...). ",
    "NikolaySolodukhin": "neoswf, could show example of you config please?. ",
    "MindSculpt": "@bezoerb Just wanted to follow up on this as it does appear to be an issue with penthouse, and @pocketjoso is currently debugging.. This appears to have been an isolated repo-specific issue. Seems to be cleared up now.. ",
    "Adam-Meisen": "Should I write a test for this change?. I've written a test, and added the css option to README.md.\nThe only potential hangup I can see is the extract option. It doesn't cause any errors if opts.css is an array of Vinyl objects and opts.extract is true, but I don't think it will actually extract the inlined CSS from the Vinyl files. I'm not sure about this, though, as the code that actually does the extraction seems to live in another module and might just be writing directly to disk.\nEDIT: Scratch that, it works fine. I was looking at the wrong files.  Looks like It outputs a unique css file per page, as expected.. Uses the -nostyle template to make sure that styles are being loaded only from the provided Vinyl objects, and not from css files on disk.. Should generate the same results as the first test, but with stylesheets passed as Vinyl objects instead of links.. ",
    "computapars": "critical_multiple_ex.txt\nI've been using a recursive function to go through an array of pages on my local development environment. Not sure if this helps.. ",
    "rowbot-weisguy": "Hi @strarsis I've been trying to figure out the same thing this week.\nHere's what I've got in my gulpfile.babel.js. \ngulp.task('critical', () => {\n  gulp.src(['./build/**/*.html'])\n    .pipe(critical({\n      base: './build',\n      inline: true,\n      width: 320,\n      height: 480,\n      minify: true,\n      timeout: 60000\n    }))\n    .on('error', (err) => { gutil.log(gutil.colors.red(err.message)); })\n    .pipe(gulp.dest('./build')); // output again to overwrite old html\n});\nIt's not working as I'd like it. It always times out under this configuration. In the site I'm working on, I'm looping through ~100 pages, and I have to set the timeout to an incredibly high number to make it work. I'm considering doing something like @computapars shared now, where I manually specify critical paths from which to generate the CSS, and then inline that into every page. \nLet me know if you learn anything... \ud83e\udd14 . ",
    "arminnaimi": "I can confirm that the same issue happens on GitLab CI.. ",
    "retyui": "Yes you are right ,\nOnly I need, that in the mode inline: true it would be possible to exclude the addition of an inline polyfill script rel=\"preload\"\nSo I'm trying to reduce the size of my <head> in the processed files!. I try solve the problem https://github.com/retyui/critical/commit/3f79ed60cca53a42f076ee033af5cf6dad66a783. ",
    "rmckeel": "@bezoerb Good catch, perhaps my Rubber Ducky should have caught that one.\nHowever, the problem remains after I re-run, I now get this output.  Should not #mydiv be part of the critical CSS running under near-default conditions?  It is the only element, and is visible at top left of the page.  Even explicitly setting width: 1300 and height: 900 does not change the output.  Only body { color: blue }.\n```\n<!DOCTYPE html>\n\n\n\nTitle\n",
    "rtkd": "Hi, i'm running into the same difficulties.\nnode: v8.5.0\ncritical: \"^0.9.1\"\ngulp: \"^3.9.0\"\ntest.html\nhtml\n<!DOCTYPE html>\n<html lang=\"de\">\n    <head>\n        <meta charset=\"utf-8\">\n        <title>Index</title>\n    </head>\n    <body>\n        <header id=\"header-main\">test</header>\n    </body>\n</html>\ntest.css\n```css\nbody {\n    background: #f00; }\nheader-main {\ncolor: #0f0; }\n\ncritical test.csscss\nbody {\n  background: red;\n}\ngulpnode\n// options\n'critical':\n{\n    'src': config.rootsrc + 'html/build/test.html',\n    'dst': config.rootdst + 'css/',\n    'options':\n    {\n        'base'      : config.rootdst,\n        'css'       : config.rootdst + 'css/app.min.css',\n        'minify'    : false,\n        'inline'    : false,\n        'height'    : 1024,\n        'width'     : 1280\n    }\n},\ngulp.task('build:critical', function()\n{\n    return gulp\n        .src(config.css.critical.src)\n        .pipe(critical(config.css.critical.options))\n        .on('error', function (err) { console.log(err.message); })\n    .pipe(gulp.dest(config.css.critical.dst))\n;\n\n});\n```\nI fed sources before and after minification to same avail.. I've set up a more sane env for testing: Node: 6.11.4, NPM: 5.4.2, Gulp: 3.9.1, Critical: 0.9.1\nIssue persists. Also, when I explicitly include the element 'include'   : ['#header-main'] everything is fine.. ",
    "RobertJGabriel": "Sorry for being annoying, any update on this :) Same issue. @bezoerb just tired again with the lastest and still the same issue :(. Yep I am. Have any questions about it ?. ",
    "teodragovic": "Hi, I think I have the same problem. Only output I got is styles for <html> and <body> elements and @font-face rules.\nHere is my reduced example (I'm using Windows 8, Node 6, npm 5):\nhtml:\n<!doctype html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"utf-8\">\n    <title>Title</title>\n    <link rel=\"stylesheet\" href=\"/main.css\">\n</head>\n<body>\n<div class=\"bg--purple-dark\">\n    <h1 class=\"txt--white\">Title</h1>\n</div>\n</body>\n</html>\ncss:\n```\nbody { background: red; }\n.bg--purple-dark { background: rebeccapurple; }\nh1 { font-weight: bold; }\n.text--white { color: white; }\n```\ngulp:\ngulp.task( 'critical:css', () =>\n    gulp.src( `${config.outputDir}/**/*.html` )\n    .pipe( critical.stream({\n        base : `${config.outputDir}/`,\n        css : [ `${config.outputDir}/main.css` ],\n    }) )\n    .on( 'error', err => console.error( err ) )\n    .pipe( gulp.dest( config.outputDir ) )\n);\nI also tried using CLI command critical build/index.html --base build > critical.css and output is the same. Per recommendations in Penthouse repo I checked my styles in AST explorer and used their online tool and output was as expected. This error started when I upgraded to v1.0.0., before it worked fine so I'm thinking it has something to do with Chrome Headless not being supported on Windows but same thing happens when I deploy.. @pocketjoso yup, that solves it for me. Thank for such a quick response!. I'm not sure if I have same problem but I started getting this in my console when deploying (locally everything works and on server worked last friday dec. 8th):\n[08:20:15] Starting 'critical:css'...\n(node:14320) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): Error: Page crashed!\n(node:14320) DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.\n(node:14320) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 2): Error: Page crashed!\n(node:14320) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 3): Error: Page crashed!\n(node:14320) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 4): Error: Page crashed!\n{ [Error: undefinedundefinedError: Penthouse timed out after 30s. ]\n  message: 'undefinedundefinedError: Penthouse timed out after 30s. ',\n  showStack: false,\n  showProperties: true,\n  plugin: 'critical',\n  __safety: { toString: [Function: bound ] } }\nthe Page crashed part got me thinking that it's not Chrome starting problem but something else with dependencies that's changed.. ",
    "einsteinreloaded": "I am facing similar type of issue but in my case when i run the critical.generate again it outputs the correct css.\nUpdate:\nIn the page i am facing this has a carousel can that be a cause.. ",
    "zomars": "I'm also looking for this! Maybe src could receive an array of URLs as input.. I totally agree with this. ",
    "mainak-grmtech": "Here is the code to get critical css from multiple external URL:\n```\nvar HostUrl= 'http://example.com/';\nvar UrlForGeneratingCriticalCss = {\n    homepage: ['home'\n    ],\n    category-pages:['category-1','category-2'],\n    blog-pages:['blog','blog-inner'],\n};\ngulp.task('criticalloop', function () {\n    for (var key in UrlForGeneratingCriticalCss) {\n        var bundle = key;\n    for(var EachUrl in UrlForGeneratingCriticalCss[bundle])\n    {\n       var TargetUrl = HostUrl+UrlForGeneratingCriticalCss[bundle][EachUrl];\n       var outputCssName = './css/critical-'+UrlForGeneratingCriticalCss[bundle][EachUrl]+'.css';\n       critical.generate({\n            src: TargetUrl,\n            dest: outputCssName,\n            minify: true,\n            ignore: ['@font-face',/url\\(/]\n        });\n    }\n}\n\n});\n```. ",
    "pratham2003": "@jahvi \nHow are you loading your critical CSS?\nInlining it into HTML or loading as a file in HEAD?\nIf inlining you don't need to concatenate them, just load the critical CSS unique to that page template.. Thanks, @pocketjoso and @bezoerb I'll try them out.\n. I ended up using es6-promise-pool\nWorks nicely.\nRemember to set concurrency to 1 or 2 if you are using XAMPP.\nXAMPP isn't meant to handle concurrent requests very well.\nconfig-example.yaml\n```\nCritical CSS Base URL\nCRITICALCSS:\n  base_url: \"http://example.com\"\n  concurrency: 2\n  pages:\n    front-page: \"/\"\n    page-392: \"/?p=392\"\n    page-382: \"/?p=382\"\n    special-category-fallback: \"/?p=1820\"\n    global-fallback: \"/?p=1427\"\n```\nmy gulp critical task\n```\ngulp.task('critical', /['build'],/ function (cb) {\n// constructing array out of list-object returned by config.yaml so I can pop each item.\n  var pages = Object.keys(CRITICALCSS.pages).map(function(val){\n    return { key: val, url: CRITICALCSS.pages[val] };\n  });\n// Modified example code from promiseProducer docs\n  var promiseProducer = function() {\n    const page = pages.pop();\n    if (!page) {\n      return null;\n    }\n// critical.generate returns a Promise.\nreturn critical.generate({\n  base: '/',\n  src: CRITICALCSS.base_url + page.url,\n  css: [\n    'dist/assets/css/app.css'\n  ],\n  styleTarget: 'dist/assets/css/critical/' + page.key + '.css',\n  minify: true,\n  dimensions: [\n    { width: 375, height: 1200 },\n    { width: 1024, height: 1400 },\n    { width: 1280, height: 1500 }\n  ],\n  ignore: ['@font-face'],\n  include: [\n    '.foundation-mq',\n    '.is-dropdown-submenu',\n  ]\n})\n\n}\nvar pool = new PromisePool(promiseProducer, CRITICALCSS.concurrency)\nvar poolPromise = pool.start();\npoolPromise.then(function () {\n    console.log('All critical css files generated');\n    cb();\n  }, function (error) {\n    console.log('Failed to generate all/some critical css files: ' + error.message)\n  })\n});\n```\nThanks for this awesome library :)\nAble to get 100/100 pagespeed score with almost no FOUC.. ",
    "jahvi": "I'm inlining them, the problem is that I don't have that much control over what to load when (because of limitations on the CMS system) so in our case it would be a lot simpler to inline all critical path css in the head.\nFor now @mainak-grmtech solutions works very well as a workaround.. ",
    "futureweb": "any news on this? ;-). ",
    "raxbg": "Critical seems to be saving all files directly under /tmp/ (or whatever is appropriate for the OS) losing the directory structure of the originally linked file. So for example your some/deep/dir/style.css will be downloaded to something random like /tmp/sdfhwek2kj2kl234l42.css. Critical will then compute the absolute paths of linked resources in that CSS based on /tmp/sdfhwek2kj2kl234l42.css instead of the original some/deep/dir/style.css. I have made a hack that fixes this, but probably breaks a plethora of other things.\n@bezoerb please look into this issue. Also my temporary fix for this can be found in these 2 commits a3436941244d3226a339c5631e34d6b11086398c and 74d383c3a3a97cc0d0907657b07dc46813e9c55c.\nUpdate: + commit f868945ff051f9a316b8cdeb74c814f78586a986. I agree completely. In fact I have seen many sites that behave like that. I made a small change to the file-helper.js which allows you to specify the user agent through an environment USER_AGENT variable. Please see the referenced pull request.\nI hope that we will get official support for this in the next release.. @tamorim Thanks for sharing this. It's exactly what was needed \ud83d\udc4d . ",
    "mintymatt": "Still an issue, any more news on this? :) \nCurrent quick fix:\n```js\nconst glob = require(\"glob\"),\n    replace = require(\"replace\");\nglob('./public_html/critical/*.critical.min.css', {}, function(error, files){\nif (error){\n    console.log(\"Unable to correct paths? \", error);\n}\n\nreplace({\n    regex: \"public_html/\",\n    replacement: \"\",\n    paths: files,\n    recursive: true,\n    silent: true,\n});\n\n});\n```. ",
    "yawlhead91": "@addyosmani @bezoerb  hey I figured out the issue, if you see here at \nhttps://github.com/addyosmani/critical/blob/master/lib/file-helper.js#L329-L343\nThe issue is on line 340 , I just made a small change here , it was trying to assign a array as the content as opposed to the buffer inside the array. I can do a quick pull request if you wouldlike. \njavascript\nreturn fs.readFileAsync(file.path).then(function (contents) {\n      file.contents = contents.pop();\n      return file;\n});\nBy the way just finished your javascript patterns book addy, great work.\n. @bezoerb I would say that they are related, the only thing that both these cases have in common is gulp.  I am going to spend a few hours today debugging this issue in depth, and make some test reproduce the issues.. @bezoerb yes in my case I have tested it locally quite a bit with success. But you are right about the test, as i said In my other comment I will spend some time this weekend getting tests to you reproducing the issue. It is proven quite hard to reproduce the issue in mocha. My apologies about the other tests. \ud83d\udc4d \n. ",
    "dylanspurgin": "I am still seeing this error using v1.0.0. Everything is working (very slowly) if I downgrade to 0.8.0.. ",
    "matteodelabre": "I\u2019m experiencing the same issue. I noticed that it always happens when postcss-uncss is required in the gulpfile. Here is a minimal setup for reproducing the bug. After extracting, you just need to run npm install then npm start. You\u2019ll notice that if you comment the line requiring postcss-uncss in the gulpfile, everything works again.\n(Node version 8.2.1, npm version 5.3.0.)\n. ",
    "mauricionr": "could you provide a link? :smile:\nit's a open source project you are using? \ni would like to see the client side code and the server side implementation? \nthanks @RobertJGabriel . ",
    "donoskaro": "I have managed to solve this, for anyone with the same issue you have to specify something for the base path (I specified http://localhost:8888) as well as pass the absolute path to the src option (i.e. `http://localhost:888/some-page').. ",
    "prateekbh": "idea of having css extracted with the help of coverage tool is really good as I guess that is what lighthouse uses. Also users rely on it as well. Although what happens to dynamic classnames?\nripple classes, hidden dialog classes etc.. With coverage tool I record the activity and run tasks the most necessary actions on page and then see the results, not sure how we deal with this in the most generic way. ",
    "kurtextrem": "Don't we have snippets that generate critical css? If I'm not mistaken Chrome headless is able to inject scripts into pages - what if we combine the coverage report with those snippets?. ",
    "reznord": "@pocketjoso: That's super cool. Will try it on a different branch and test it.. I will be working on it in a separate branch in my fork. . @phaistonian When I test the same in my local, two tests are failing for me. Here is the error log.. Yup.. @pocketjoso everything works super awesome, except for this:\n(node:5200) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): Error: Error: Penthouse timed out after 0.001s.\n(node:5200) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.. ",
    "phaistonian": "So let me get it. \nIs there a way we can use Critical with headless chrome now?\nps: I am using headless Chrome any chance I get - it feels NOT dirty, fast and overall awesome.\n. @pocketjoso Worked like charm!\nOne little thing: \nI get this\nUnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 3): Error: Protocol error (Target.closeTarget): Target closed.\nall the time.  It doe not affect the result, but it's a bit annoying. . Having used the lighthouse/chrome-launcher/chrome-launcher (not Puppeteer) to perform some related tasks, I think the issue has to do with the fact that there's a new task launched before the previous Target (Protocol) is closed.\nPerhaps an \"await\" would do the trick :). So? Almost there?:). How about a next tag until this is done?\ni.e yarn add critical@next . @bezoerb  I am afraid it's quite complex - the whole process - to get it down to a sharable example.\nHere's the config though:\n```js\n  const res = await critical.generate({\n    userAgent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.86 Safari/537.36',\n    minify: true,\n    extract: false,\n    inline: false,\n    dimensions,\n    html,\n    ignore,\n    // concurrency: 1,\n    user: AUTH_USERNAME,\n    pass: AUTH_PASSWORD,\n// https://github.com/addyosmani/critical/blob/master/CHANGELOG.md#v200--2018-11-27\npenthouse: {\n  timeout: 360000,\n  include,\n},\n\n});\n```\nMy theory is that, because I am running multiple critical.generate in a loop, somehow the temp files are removed before they are used.. Works like a charm :)\nThank you.. oh while - there, you might want to fix this too.\n\nrebase can also be a function.. ",
    "stereobooster": "Is there a PR to fix node6 tests?. ",
    "Grawl": "I found this Chrome extension: Critical CSS extractor\nWorks good for my sites.. @mikeytown2 How do you run like critical https://github.com/? I get an error: \"file\" argument must be a non-empty string. ",
    "bajras": "Thanks for the quick reply.\n@midzer The CSS file name is hashed by Webpack so they dont remain the same after builds.\n@bezoerb I tried that too and when I do that it cant find the index file. \nAfter the HtmlWebpackPlugin has been ran the folder structure looks like this for dist folder:\n```\n\u251c\u2500\u2500 dist/\n\u2502   \u251c\u2500\u2500 nailba               \n\u2502       \u251c\u2500\u2500 appreciation               \n\u2502            \u2514\u2500\u2500 index.html\n\u2502            \u2514\u2500\u2500 static\n\u2502                    \u2514\u2500\u2500 css\n\u2502                    \u2514\u2500\u2500 js\n``\nThe url path in the index file is correct but and critical is going inside index.html too and finds the css url but searches fordist/nailba/appreciation/nailba/appreciation/static/css/app.20a8c875cb801af30e6c44a1821d6815.css \n`\nAlso if I didnt have sub folders and everything was inside dist only it works  . this work as @midzer mentioned as I can't figure why the base options isnt working.\njavascipt\nsrc: path.resolve(__dirname, '../dist/nailba/appreciation/index.html'),\ndest: path.resolve(__dirname, '../dist/nailba/appreciation/index.html'),\ncss: path.resolve(__dirname, '../dist/nailba/appreciation/static/css/app.css')\nBut I want to hash the css and use that instead of app.css all the time but when I try to use contenthash it doesnt work? Any Idea?\njavascript\nnew ExtractTextPlugin({\n  filename: utils.assetsPath('css/[name].[contenthash].css')\n}),\nnew HtmlCriticalPlugin({\n  css: path.resolve(__dirname, '../dist/nailba/appreciation/static/css/[name].[contenthash].css')\n})\nI want to use the same [name].[contenthash] for two plugins, is that even doable? Thanks. \n. ",
    "smartinio": "Did you find a solution to this @bajras ?. ",
    "oskarrough": "How about now @pocketjoso? https://github.com/addyosmani/critical/pull/234/commits/27e43ebb2b07bc1bfb260ce4b295f9ab378d3584#diff-8ee2343978836a779dc9f8d6b794c3b2L623. @pocketjoso I tried to retrigger a build a few days ago but it also failed on AppVeyor. What else can we try?. Thank you for the review and catching this! I tried \"reyarning\" but it didn't remove it. Seems some other packages also need it.\nS/l/critical (fix-github-package) $ yarn why css                                          20s 806ms\nyarn why v0.27.5\n[1/4] Why do we have the module \"css\"...?\n[2/4] Initialising dependency graph...\n[3/4] Finding dependency...\n[4/4] Calculating file sizes...\ninfo Reasons this module exists\n   - \"filter-css\" depends on it\n   - \"inline-critical\" depends on it\n   - \"inline-critical#cave\" depends on it. ",
    "DanchMax": "Yes it.s realy was problem with css, tahks for quickly answer. ",
    "mikeytown2": "This looks like the cause \n\nTLS 1.0 and 1.1 deprecated\nDrupal.org uses the Fastly CDN service for content delivery, and Fastly has depreciated support for TLS 1.1, 1.0, and 3DES on the cert we use for Drupal.org, per the mandate by the PCI Security Standards Council.\n\nhttps://www.drupal.org/drupalorg/blog/whats-new-on-drupalorg-august-2017. @Grawl I installed critical like this\nyarn global add https://github.com/addyosmani/critical.git#headless-chrome. import can in in the CSS as well; this syntax just makes testing it a lot easier. What file would I need to edit in order to do a pull request for this feature? Could you point me the right direction? . What file would I need to edit in order to do a pull request for this feature? Could you point me in the right direction?. ",
    "rjh427": "Just stumbled into this issue myself, after attempting to use a test suite on a new site. I've seen much written about passing arguments to phantomjs on the command line, that doesn't help me much because  this suite is invoked programatically in a PHP environment. I'm using self-signed certs in my dev environment too, but it's also an issue on the production site with CA-issued certs as well. Is there a fix? . :+1: . ",
    "developer-lindner": "@mikeytown2 \ninside your script use: \nprocess.env.NODE_TLS_REJECT_UNAUTHORIZED = \"0\";\nbefore using critical.generate(). Nevermind... got it!\nignore: ['@font-face', 'content', 'font-family', 'clearfix'],\nignoreOptions: {\n        matchSelectors: true,\n        matchTypes: true,\n        matchDeclarationProperties: false,\n        matchDeclarationValues: false,\n        matchMedia: false\n}. @pocketjoso thank you for your fast reply, seems like penthouse 1.0 has almost landed. Will give it a try as soon as it is available!. @pocketjoso I would.. but the PR (https://github.com/addyosmani/critical/pull/246) is still open and the package.json still has \"penthouse\": \"^0.11.13\".. @bezoerb just tested it yesterday and it works like a charm!. Go?. @bezoerb Thank you! But i've tried that already... class-selectors didn't work at all?!\nLooks broken to me.... I use include too for some non-visible stuff but the ignore option didn't work as expected for class-selectors. Just tried it again and now it did work?! I don't get it... thanks for taking time!. Ya must be the normalization... should be font-size: 0.75rem; for example.\nHopefully the PR will soon be available! Thank you!. It works even without server side rendering.... ",
    "ethanhinson": "Thank you!\n. ",
    "shervud": "Hi everyone.\nI have a question. In my project I use node 4.4.2 , so I don't have a chance to update my node to >=6 version.\nMore over, I use grunt-critical (by bezoerb) v.0.3.0 which is based on critical (current module) with 0.9.0 version.\nWhat my config of dependencies should be to run on node version >=4 my grunt-critical and of cource critical?\nThank you very much!\n. @bezoerb yeah, thank you. \nBy the way, I'm still looking for the way of using grunt-critical v 0.3.0 at node >=4 & <= 6. All I need is to get features from penthouse (renderWaitTime, blockJSRequests) which occurs in its 0.10.3 version.\nWould you know may be...\nIs there a way to make it? May be by using npm-shrinkwrap to lock versions of several packages, etc...\n. Hi, I have also faced with the same problem. I contacted with Penthouse lib developer and he said that problem is on critical lib side.\nAn ugly issue \"Unhandled rejection Error: css should not be empty\" appears only on URLs whose  body does not have any css includings such as: <link href=\"url-to-css.css\" />.\nSome URLs implement css sources includings in the following way:\n<style>@import('url-to-css.css');</style>\nAnd it seems critical and penthouse modules libs ignore such files.\nSo, if some site has the next html:\n<html>\n<head>\n<style>@import('http://example.com/styles/my-style.css');</style>\n<link href=\"http://example.com/styles/my-prints.css\" media=\"print\" />\n</head>\n<body>...</body>\n</html>\nThe critical will throw an error and will never work. While the following implementation will work and critical will be generated:\n<html>\n<head>\n<link href=\"http://example.com/styles/my-style.css\" media=\"all\" />\n<link href=\"http://example.com/styles/my-prints.css\" media=\"print\" />\n</head>\n<body>...</body>\n</html>\np.s. Take in consideration, in 1st case there was , but it does not work due to media=\"print\" attribute.. ",
    "sarahxoxo": "It seems like a node version problem,\nafter i update my node to v6.11.4 it works!\n. ",
    "rfgamaral": "\nAs long as your site (and css) is going to stay this size, you can just inline the full css and not worry.\n\nYou're saying to just inline everything? In that case, wouldn't be simpler for me to just use some Gulp  plugin for inlining a CSS file instead of using Critical?. Thanks.. I did some further debugging on this issue and I don't understand what's going on... PageSpeed splits reports between mobile and desktop, let's focus on mobile for now.\nIf I have the critical rules above, especially the background-image one, I get all those warnings. But If I inline just the following code (which got stripped given the critical rules):\ncss\n@media (min-height:481px) and (max-height:736px) and (orientation:portrait) {\n    #background {\n    background-image: url(assets/images/background-736h.8f5354d0.jpg);\n    }\n}\nI no longer get the warnings above, everything is fine. I don't get this... Why do I get all those render-blocking resources (JS and CSS) if I simply remove the inlined background-image that is part of the critical-path CSS?\nIn other words, I want to inline all my CSS but load background images asynchronously, is this not possible? Am I doing something wrong?. I think this is has something to do with the loadCSS function, it's blocking everything else, somehow.. ",
    "djbuch": "I found this : https://github.com/pocketjoso/penthouse/pull/197. ",
    "AlexMiroshnikov": "I suspect that extract now doesn't work even when inline: true is set. Not 100% sure yet, but I'm going to provide a minimalistic sample.\nUPD\nWell, it works, but not in the way I would expect it to work.\nHave a look at https://github.com/AlexMiroshnikov/critical-css-playground .\nRun the command from README and verify the data/original.XXX.css and the out/critical.html files. In the inlined css (in the html file) there will be a fragment .top-passage{color:red}, while in the css there still be a fragment\ncss\n.top-passage {\n  color: #f00;\n}\nI guess it should not be there, should it?. ",
    "lili21": "same issue here. extract not working.\nindex.html\nhtml\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\">\n  <title>Critical</title>\n  <link rel=\"stylesheet\" href=\"style.css\">\n</head>\n<body>\n  <div id=\"root\"></div>\n</body>\n</html>\nstyle.css\n```css\nbody,\nhtml {\n  height: 100%;\n  font-family: PingFang SC, Helvetica Neue, Helvetica, STHeitiSC-Light, Arial, sans-serif;\n  line-height: 1.5;\n  font-size: .37333rem;\n  -webkit-font-smoothing: antialiased\n}\nroot {\nheight: 100%;\n  width: 10rem;\n  margin: 0 auto\n}\n.Home-page--home__PLzhO {\n  margin-top: 1.06667rem\n}\n.Home-page--home__PLzhO a {\n  display: block;\n  padding: .26667rem 0;\n  text-align: center;\n  font-size: .42667rem;\n  font-weight: 700;\n  color: #66ab93\n}\n```\nafter execute\nbash\ncritical dist/index.html -iem > dist/index-critical.html\nindex-critical.html\nhtml\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\">\n  <title>Critical</title>\n  <style>\n    body,html{height:100%;font-family:PingFang SC,Helvetica Neue,Helvetica,STHeitiSC-Light,Arial,sans-serif;line-height:1.5;font-size:.37333rem;-webkit-font-smoothing:antialiased}#root{height:100%;width:10rem;margin:0 auto}\n  </style>\n  <link rel=\"preload\" href=\"style.css\" as=\"style\" onload=\"this.onload=null;this.rel='stylesheet'\">\n  <noscript><link rel=\"stylesheet\" href=\"style.css\"></noscript>\n  <script>!function(n){\"use strict\";n.loadCSS||(n.loadCSS=function(){});var o=loadCSS.relpreload={};if(o.support=function(){var e;try{e=n.document.createElement(\"link\").relList.supports(\"preload\")}catch(t){e=!1}return function(){return e}}(),o.bindMediaToggle=function(t){var e=t.media||\"all\";function a(){t.media=e}t.addEventListener?t.addEventListener(\"load\",a):t.attachEvent&&t.attachEvent(\"onload\",a),setTimeout(function(){t.rel=\"stylesheet\",t.media=\"only x\"}),setTimeout(a,3e3)},o.poly=function(){if(!o.support())for(var t=n.document.getElementsByTagName(\"link\"),e=0;e<t.length;e++){var a=t[e];\"preload\"!==a.rel||\"style\"!==a.getAttribute(\"as\")||a.getAttribute(\"data-loadcss\")||(a.setAttribute(\"data-loadcss\",!0),o.bindMediaToggle(a))}},!o.support()){o.poly();var t=n.setInterval(o.poly,500);n.addEventListener?n.addEventListener(\"load\",function(){o.poly(),n.clearInterval(t)}):n.attachEvent&&n.attachEvent(\"onload\",function(){o.poly(),n.clearInterval(t)})}\"undefined\"!=typeof exports?exports.loadCSS=loadCSS:n.loadCSS=loadCSS}(\"undefined\"!=typeof global?global:this);</script>\n</head>\n<body>\n  <div id=\"root\"></div>\n</body>\n</html>\nand the style.css still contain the inlined style. I'm using critical@1.3.3. the output of find dist -name '*.css'\nbash\ndist/b.css\ndist/c.css\ndist/a.css\nDEBUG info\n\nwow. Turns out I have to execute it this way\nbash\ncritical dist/index.html -im -c dist/b.css -c dist/c.css -c dist/a.css\ninstead of \ncritical dist/index.html -im -c dist/b.css dist/c.css dist/a.css\n. supportive of globbing ?\nbash\ncritical dist/index.html -im -c dist/*.css. It's runnable, but not the way I suppose.. Just tried it. Still doesn't work as expected. Tried it again. It works on 2.0.0-3. \ud83d\udc4d . ",
    "julienchazal": "@addyosmani  @bezoerb Same here, extract not working even with inline:true\nPlus it would be great to extract even if using inline:false\njavascript\n new HtmlCriticalWebpackPlugin(\n            {\n                base: path.resolve(__dirname, 'app/views/frontoffice/criticalcss/'),\n                src: 'http://local.website.fr',\n                dest: 'accueil-min.css',\n                css: 'public/stylesheets/frontoffice.min.css',\n                // include: ['.dropdown-menu', 'nav', '.navbar', '.nav', '.navbar-nav'],\n                extract: true,\n                minify: true,\n                width: 1300,\n                height: 900,\n                penthouse: {\n                    blockJSRequests: false,\n                }\n            }),. ",
    "crazychicken": "@addyosmani @bezoerb Same here,\nhttps://github.com/anthonygore/html-critical-webpack-plugin/issues/23. ",
    "JonWatkins": "Took a while to get back here and close this, but I ended up running it in a child process this lets it do exactly what I needed.. ",
    "simon-jouet": "Hi @JonWatkins,\nYou closed this issue, but I believe this is still a valid issue and the temporary file should be removed without having to stop node.. ",
    "BB-000": "I tested using Penthouse web service on the same page/stylesheet and the style was included correctly once. I am using filamentgroups grunt criticalcss https://github.com/filamentgroup/criticalCSS, I'll post an issue there \nhttps://github.com/filamentgroup/criticalCSS/issues/56 . ",
    "topogigiovanni": "Thanks for your suggestions @pocketjoso, but the CSS file is valid. Running Penthouse directly in v1.1.3, I have the same wrong result. I will open the issue there. \nI still wonder if other Critical lib users are not experiencing the same problem due to this Penthouse version change. If so would not it be interesting to define the dependency for version v1.1.2?. Issue opened in Penthouse repo\nhttps://github.com/pocketjoso/penthouse/issues/204. ",
    "chromadesign": "I am getting this rather cryptic error as well and can't find what the problem (it's not an empty href). I've tried different source URLs (local and remote) as well as different destination directories to no avail. Any idea how I can get to the bottom of this?\nFancy Log spits out the following error message after the task finishes:\n Error: EISDIR: illegal operation on a directory, read errno: -4068, code: 'EISDIR', syscall: 'read' }. ",
    "thewilkybarkid": "Yeah, we had a separate bug that didn\u2019t install all the packages. The problem here is the 0 exit code, as it didn\u2019t cause our build to fail and created problems further down the line.. ",
    "hendrikeng": "@teodragovic did u solve the issue? i am running into the same problem.\nfollowing the steps didn't help https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md\nit all works lokal but not on the server\nnevermind, got it working with @bezoerb suggestion \nhttps://github.com/Interlutions/docker-node/blob/master/Dockerfile\nbash\napt-get update\napt-get install -y wget --no-install-recommends\nwget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -\nsh -c 'echo \"deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main\" >> /etc/apt/sources.list.d/google.list'\napt-get update\napt-get install -y google-chrome-unstable gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils --no-install-recommends\nrm -rf /var/lib/apt/lists/*\napt-get purge --auto-remove -y curl\nrm -rf /src/*.deb. ",
    "rokerkony": "it was my first try and unfortunately, it didn't help\nthe only solution which helped till now is to put back polyfill from this commit:\nhttps://github.com/bezoerb/inline-critical/commit/5317ba2f55a31e56b38d83a22a3cf9e8b7a241f4#diff-b9cfc7f2cdf78a7f4b91a753d10865a2. @XhmikosR sorry I was not precise... I used just a polyfill used in tests from this PR\nand what I read is, that 2.0.0 is deprecated as it was published incorrectly that is probably why is this PR with 2.0.1. thanks guys for an effort and a fix, but it is still failing on IE11...\nshould I create another issue on loadCSS and close this one or how to proceed?. I just did but it is still failing. this.onload=null is now applied but still loads css again and again... are you testing on IE11 as well?. ok, thx for testing...\nmaybe it is influenced by an angular app... I will try to test it on minimal code and then compare with our app if it works... if not I will try to investigate directly in loadCSS repo\nwe can close this issue here for now, right?. Hey guys, would you be so kind and could anyone try this?\nhttps://github.com/rokerkony/angular-critical-ie11-bug\nThis is a minimal angular app generated by CLI with critical on top of it, just run npm run serveDist after cloning the repo and it will install deps, build, apply critical and run http-server.\nThis is still failing for me ... If you confirm I will probably open an issue in the angular repo.. ok... I think it is caused by Zone.js which is monkey patching a load event...\nafter I have commented out all occurrences of 'load' (4 occurrences) events it works ...\nclosing this issue and going to open one there.... ",
    "0reo27": "Got the same issue. Bumped the version of inline-critical. Working great now. I just tested on IE11. I guess we just need to wait for the author to bump the version?. Just wanted to chime in again. Simply did a yarn remove critical -D, yarn add critical -D and it's working without any additional configuration.\n@rokerkony, thanks for reporting the bug and thanks to @XhmikosR and @bezoerb for sorting it out. Critical is an awesome tool for sure! :). ",
    "princewn": "If the plugin do not support JS frame rendering,do you have a plan to do this and when?. ",
    "jdrzj": "Hi, I got the same error when running critical.\nI got node 7.3.0, gulp 3.9.1.\nedit:\ncritical version: 1.1.0. I tried to rollback to version 0.9.1 with:\n$ npm install critical@0.9.1 --save\nbut I got the error message:\n[10:08:59] Using gulpfile ~/code/landing-pages/gulpfile.js\n[10:08:59] Starting 'critical'...\nFatal undefined. But running it from CLI works.. ",
    "fjorgemota": "I'm having the same problem here.\nHowever, instead of just showing ERESET from times to times...I'm having the following error shown randomly - too:\n[00:30:38] Protocol error (Runtime.callFunctionOn): Execution context was destroyed. undefined\n[00:30:38] no writecb in Transform class\nCuriously, this only happens when using public/**/*.html as the src to the gulp task. When using just public/*.html all runs fine.\n. Oh. Nice!\nNow it makes sense the fact that sometimes ERESET error is shown, sometimes that error is shown.\nI will try today to execute spawn a new instance of critical for each HTML file found, to see if most files are, at least, processed (trying to avoid those who redirect to another pages).\nAnyway, thanks for the answer. =). ",
    "begincalendar": "Is anyone able to consistently reproduce this issue?\nIt occurs sporadically for me and hence is infeasible to debug.. ",
    "shiftie": "Hi, I can't use critical on Travis & sometimes it also fails in local as well with:\n```\nevents.js:183\n      throw er; // Unhandled 'error' event\n      ^\nError: read ECONNRESET\n    at _errnoException (util.js:1022:11)\n    at TCP.onread (net.js:615:25)\nI'm using promise based flow:\ncritical.generate(....).then(....).error(....);\n```\nany updates concerning this?\nedit.:  @lewisnyman looks like this is related to websockets library not handling errors from 3.3.3 (version currently resolved from Penthouse dependencies (puppeteer)), so you can either force resolve ws@3.3.2 or wait for a Penthouse update to add an error handler.\nhttps://github.com/websockets/ws/issues/1256#issuecomment-352288884. ",
    "Fenrirkp": "My gulp-task:\n\n\n    gulp.task('critical', function () {\n        return gulp.src('app/*.html')\n        .pipe(critical({\n            base: 'app/',\n            inline: true,\n            width: 600,\n            height: 1080,\n            extract: true\n        }))\n        .pipe(gulp.dest('app/'));\n    });\n. That's ok. I have only one page.. \n",
    "brezanac": "I can confirm. It's especially problematic with data attributes containing values like JSON etc.\n<div data-something='{ \"key\" : value }'></div>\nbecomes\n<div data-something=\"{ \" key\"=\"\" :=\"\" value=\"\" }\"=\"\"></div>\n  . ",
    "sergeiliski": "This is still open and I was wondering if there was a solution to this? As far as I know, it's not possible to pass the decodeEntities: false that is suggested in the cheerio#720. ",
    "nairod": "I faced this problem too, with the stable version. With the next version this problem has gone. \nThanks for your work!. ",
    "kanishk-anand-oyo": "I gave the css file in the css:[ ] array, but the program doesn't generate critical css if there isn't a css file in users.ejs\nconst critical=require(\"critical\");\ncritical.generate({\n    base: 'public/stylesheets',\n    src:'../../views/users.ejs',\n    css:['public/stylesheets/users.css'],\n    dest: '../../views/users.ejs',\n    inline: true,\n    extract: true,\n    width: 800,\n    height: 1100,\n});\nMy users.ejs is:\n'\n\nusers\n    note no stylesheets referenced in the file\n\n\ninside body =>some html here\n\n`\nBut as soon as I insert an irrelevant css file to users.ejs and run the same code for critical css, the program generates critical css of the file given in css:[ ] array . \nAny ideas how to run it without having to give an irrelevant css file.\n. ",
    "Simpleqode": "Seems like Penthouse does. Anyways, seems like babel-jest released a small update to resolve the issue, so I think this issue can be closed.. ",
    "epcliff": "Hi, I have the same issue. It was working before and now I suddenly get this penthouse error message. Also, I already changed the timeout option and still getting the error. Is there a way to find out the exact error? . ",
    "mems": "I think it's related to a bug in penthouse: https://github.com/pocketjoso/penthouse/issues/274\nAnd it has been fixed in penthouse@1.9.0. ",
    "chenesan": "OK I got it. Thanks!. ",
    "situ185": "I have a similar issue...\ni have added the http and https proxies to the npm config but still doesnt work.\ni added the PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true in config but still the same issue. this is what I did to get over this:\n-I installed critical in my personal machine\n-Copied the critical node modules form node_modules folder including the .bin folder\n-Copied the dependencies object from the package.json from  my personal machine to the development machine\n-run npm install. ",
    "emiespo": "Read better: it is trying to access http instead of https (as it should be). If I change that line to https, it works :). My bad: I've edited the comment to explicit state the URL is protocol-relative (so it should NOT go to http, but https).. ",
    "dalimian": "let me reword\nI have an absolute positioned div at the bottom of my html markup but I have it show at the top of the page, not a bug, this is by design. so I expect this lib to consider it in viewport and extract the styles, but it doesn't.. Thanks for quick reply. we\u2019re trying to incorporate this at www.edmunds.com/, and the css for nav header does not make it into critical. thanks @pocketjoso, in your version it does show, I was referring to the header bar, one that has the New Cars, Used Cars, etc, looks good in your mock, does not in mine\nin my version it looks like this, notice the top bar missing\n\nwhat did you specify for viewport width/height? \nwhen I leave it out, thus using the defaults - width: 1300, height: 900 or overriding to height: 1200 - the bar is missing. when I specify height:10000 it works, I want it to work with height:900\n. thanks @bezoerb \nwhen I try your command it works for me too, but doing it from js api does not, maybe im not using the api correctly\nI created a small repo reproducing the issue - https://github.com/dalimian/critical-test\n@pocketjoso. @bezoerb . ",
    "wizardnet972": "I agree if there are no styles to inline there might be something wrong.\nBut take a look at this case of offline-webpack-plugin, it produce a html file (manifest.html) with this content: \n<!doctype html>\n<html manifest=\"manifest.appcache\"></html>\nAnd after that, I run the critical to iterate each html file inside dist. As you can see I can't predict the content of the HTML.\nThe problem comes when it failed the entire build. Sure, I can catch this error, but take a consider that files are generated by third-party and I got an error about them. \nSo this is why I need to critical just return html without any error.\nAre you agree?. ",
    "Jack89ita": "Any news about this?. ",
    "BrianEmilius": "I have this same issue.\ncritical version 1.3.0\ngulp version 4.0.0. ",
    "GeorgeTaveras1231": "@pocketjoso Would you need both versions to be live?. @pocketjoso Here you go: https://s3.amazonaws.com/qa-theknot.com/xo-landing-pages/vhp/v0.1.0-0.no-critical-css/index.html. ",
    "tamorim": "@raxbg I hope that you don't mind that I've opened a PR myself too.\nI'm already rolling with a critical fork with the userAgent option for some weeks at my job.\nSeeing your comment gave me some strength to rebase and add a test for it haha, I hope that you like the solution too!\nI'm open to any feedback. @bezoerb I'm super happy to land this change!\nJust one more thing... I noticed that a file from my WIP ended up on the PR \ud83d\ude48 \nMaybe you'll want to remove it, the file is test/expected/generate-adaptive-useragent.css. ",
    "billouboq": "Same here, using it with gulp and gulp says the task is done but it's not exiting. It may be because puppeteer process does not exit properly.\nI'm using this on a website with a lot of external scripts (ads, A/B testing, tags, monitoring, etc), so browser is always busy doing external ajax call and other things so maybe it is blocking puppeteer from closing, just a thought.\nDon't have time at work to review this properly, but will do if I find time.. Thank you for this, unfortunately I'm not working on the project using it so I can't :/ but that's awesome anyway !. ",
    "japrescott": "I realized, I have misunderstood styleTarget, as it is intended to save the critical styles, not the \"leftover\". After reviewing the code, I've created two forks and added the option overrideOriginal to critical and inline-critical.\nAs this can be a very dangerous option for people not fully understanding what is happening it could lead to loss of their original files. Thus, I am a bit hesitant to create pull request.. ",
    "dolanb12": "Could one simply set the width and height options to 0, and use the include option to specify the correct divs? Would this be clean?. ",
    "pachiraDIG": "I see,\nI'd love to see this implemented -- a \"class-based\" feature to go along with the height-based feature for determining what is and isn't critical css.\nAny takers?  : ). @bezoerb forceInclude is just what I was looking for, thanks! I now see the include option in the latest version documentation. I was previously looking at the front page readme. \nMy only other question is -- what would be the best way to get Critical to not use viewport width & height to determine the critical css? I'd like to use the include option as the sole method for determining what's generated.. I'm sorry, I didn't provide a reference case. Here's the project.\nThis is a website format, not a single website. So the underlying template will be used over and over again.\nIf you feel Critical is overkill for this type of site, what might you recommend to automate the process?. Hope that makes sense, I'm simply layering absolute-positioned sections on top of each-other, rather than displaying them vertically, one-by-one, as Critical is traditionally designed for. So I'd like to be able to use it strictly for this case. . ",
    "Genuifx": "@pocketjoso awesome! Does Critical use puppeteer to achieve it? if so, why not wait for js executing, it seems we can get the first render.\nAnother question is after using Critical to extract CSS if we need drop duplicate CSS from our app? Cause extracting stylesheet, in my opinion, just copies the CSS code to Style element. \ud83d\ude38 . got it.(\u204e\u204d\u0334\u031b\u1d17\u204d\u0334\u031b\u204e). ",
    "sheerun": "(we can hack around this by setting huge height but I don't believe this is the correct solution). In our case full CSS for initial view of single page is not much bigger than full CSS of first visible viewport of this page so there's no sense to do triple load you mention. Critical is good at removing CSS needed only after interactions but we really need CSS for full height of the page so users can interact before full CSS is loaded (or JavaScript is loaded). \nSetting huge height kind of works, but I'm not convinced it's efficient memory-wise and it involves \"magic number\".\nSorry if I'm mistaken, but isn't the solution as simple as always returning true from isElementAboveFold in https://github.com/pocketjoso/penthouse/blob/master/src/browser-sandbox/pruneNonCriticalSelectors.js ?. I don't know, I use critical and this is issue about critical.. :). ",
    "dkrnl": "Hi!\nI use critical css with 100vh:\nwidth: 1920,\n    height: 99999, // 1080,\n    dimensions: [{\n        width: 320,\n        height: 99999, // 568,\n    }, {\n        width: 768,\n        height: 99999, // 1024,\n    }, {\n        width: 1200,\n        height: 99999, // 900,\n    }, {\n        width: 1920,\n        height: 99999, // 1080,\n    }, {\n        width: 3840,\n        height: 99999, // 2160,\n    }],\n99999 -- magic number \ud83d\ude0a. ",
    "alljamin": "I have specified var critical = require('critical'); but have not written the gulp.task. Once gulp.task gulp.task('critical', function(done) {...}); is created - the error dissapears.. ",
    "coveralls": "Pull Request Test Coverage Report for Build 727\n\n0 of 0   changed or added relevant lines in 0 files are covered.\nNo unchanged relevant lines lost coverage.\nOverall coverage remained the same at 88.35%\n\n\n|  Totals |  |\n| :-- | --: |\n| Change from base Build 725: |  0.0% |\n| Covered Lines: | 537 |\n| Relevant Lines: | 583 |\n\n\ud83d\udc9b  - Coveralls\n. ## Pull Request Test Coverage Report for Build 727\n\n0 of 0   changed or added relevant lines in 0 files are covered.\nNo unchanged relevant lines lost coverage.\nOverall coverage remained the same at 88.35%\n\n\n|  Totals |  |\n| :-- | --: |\n| Change from base Build 725: |  0.0% |\n| Covered Lines: | 537 |\n| Relevant Lines: | 583 |\n\n\ud83d\udc9b  - Coveralls\n. ## Pull Request Test Coverage Report for Build 737\n\n0 of 0   changed or added relevant lines in 0 files are covered.\nNo unchanged relevant lines lost coverage.\nOverall coverage remained the same at 88.341%\n\n\n|  Totals |  |\n| :-- | --: |\n| Change from base Build 736: |  0.0% |\n| Covered Lines: | 551 |\n| Relevant Lines: | 598 |\n\n\ud83d\udc9b  - Coveralls\n. ## Pull Request Test Coverage Report for Build 737\n\n0 of 0   changed or added relevant lines in 0 files are covered.\nNo unchanged relevant lines lost coverage.\nOverall coverage remained the same at 88.341%\n\n\n|  Totals |  |\n| :-- | --: |\n| Change from base Build 736: |  0.0% |\n| Covered Lines: | 551 |\n| Relevant Lines: | 598 |\n\n\ud83d\udc9b  - Coveralls\n. ## Pull Request Test Coverage Report for Build 758\n\n0 of 0   changed or added relevant lines in 0 files are covered.\nNo unchanged relevant lines lost coverage.\nOverall coverage remained the same at 89.712%\n\n\n|  Totals |  |\n| :-- | --: |\n| Change from base Build 757: |  0.0% |\n| Covered Lines: | 551 |\n| Relevant Lines: | 589 |\n\n\ud83d\udc9b  - Coveralls\n. ## Pull Request Test Coverage Report for Build 773\n\n2 of 2 (100.0%)  changed or added relevant lines in 1 file are covered.\nNo unchanged relevant lines lost coverage.\nOverall coverage remained the same at 89.712%\n\n\n|  Totals |  |\n| :-- | --: |\n| Change from base Build 770: |  0.0% |\n| Covered Lines: | 551 |\n| Relevant Lines: | 589 |\n\n\ud83d\udc9b  - Coveralls\n. ## Pull Request Test Coverage Report for Build 769\n\n0 of 0   changed or added relevant lines in 0 files are covered.\nNo unchanged relevant lines lost coverage.\nOverall coverage remained the same at 89.712%\n\n\n|  Totals |  |\n| :-- | --: |\n| Change from base Build 763: |  0.0% |\n| Covered Lines: | 551 |\n| Relevant Lines: | 589 |\n\n\ud83d\udc9b  - Coveralls\n. ## Pull Request Test Coverage Report for Build 798\n\n52 of 58 (89.66%)  changed or added relevant lines in 6 files are covered.\nNo unchanged relevant lines lost coverage.\nOverall coverage decreased (-0.3%) to 89.437%\n\n\n|  Changes Missing Coverage | Covered Lines | Changed/Added Lines | % |\n| :-----|--------------|--------|---: |\n| src/config.js | 10 | 12 | 83.33%\n| cli.js | 4 | 8 | 50.0%\n | **Total:** | **52** | **58** | **89.66%** | \n|  Totals |  |\n| :-- | --: |\n| Change from base Build 770: |  -0.3% |\n| Covered Lines: | 590 |\n| Relevant Lines: | 634 |\n\n\ud83d\udc9b  - Coveralls\n. ## Pull Request Test Coverage Report for Build 777\n\n0 of 0   changed or added relevant lines in 0 files are covered.\nNo unchanged relevant lines lost coverage.\nOverall coverage remained the same at 89.712%\n\n\n|  Totals |  |\n| :-- | --: |\n| Change from base Build 774: |  0.0% |\n| Covered Lines: | 551 |\n| Relevant Lines: | 589 |\n\n\ud83d\udc9b  - Coveralls\n. ## Pull Request Test Coverage Report for Build 804\n\n0 of 0   changed or added relevant lines in 0 files are covered.\nNo unchanged relevant lines lost coverage.\nOverall coverage remained the same at 88.822%\n\n\n|  Totals |  |\n| :-- | --: |\n| Change from base Build 803: |  0.0% |\n| Covered Lines: | 600 |\n| Relevant Lines: | 647 |\n\n\ud83d\udc9b  - Coveralls\n. ## Pull Request Test Coverage Report for Build 805\n\n0 of 0   changed or added relevant lines in 0 files are covered.\nNo unchanged relevant lines lost coverage.\nOverall coverage remained the same at 88.822%\n\n\n|  Totals |  |\n| :-- | --: |\n| Change from base Build 803: |  0.0% |\n| Covered Lines: | 600 |\n| Relevant Lines: | 647 |\n\n\ud83d\udc9b  - Coveralls\n. ## Pull Request Test Coverage Report for Build 807\n\n0 of 0   changed or added relevant lines in 0 files are covered.\nNo unchanged relevant lines lost coverage.\nOverall coverage remained the same at 88.822%\n\n\n|  Totals |  |\n| :-- | --: |\n| Change from base Build 806: |  0.0% |\n| Covered Lines: | 600 |\n| Relevant Lines: | 647 |\n\n\ud83d\udc9b  - Coveralls\n. ",
    "orthes": "@bezoerb good feedback. Sure, that makes sense. I'll look into it.. I rembased the branch over master, unfied cleancss with minify option, added it to CLI and added a test. @XhmikosR i did rebase it over master. good ol git rebase master. it had some merge conflict in README which i resolved and for some reason it ended up looking like this. no idea why.. I'll create a separate PR. I don't know why this one ended up in this state. ",
    "fraktar": "target: {css: 'critical.css',  uncritical: 'auncritical.css'}\ntarget didn't work for me. \nHowever, I managed to use dest and now I can generate a critical.css file in the main.css directory.\nHere's my Gulp file:\n```\nvar log = require('fancy-log');\nvar critical = require('critical').stream;\n// Generate & Inline Critical-path CSS\ngulp.task('critical', function() {\n  return gulp\n    .src('_site/assets/css/main.css')\n    .pipe(critical({\n      base: '_site/assets/css/', \n      css: ['_site/assets/css/main.css'], \n      dest: 'critical.css',\n      inline: false, \n      minify: true, \n      dimensions: [\n        {\n          height: 320,\n          width: 480,\n        },\n        {\n          height: 900,\n          width: 1200,\n        },\n      ]\n    }))\n    .on('error', function(err) {\n      log.error(err.message);\n    })\n});\n```\nI'm sure there's a better way of doing this, but feel free to test my config in your own setup.\nPS: I'd appreciate feedback on how to make my task better as well.. ",
    "joshuaavalon": "@bezoerb Sorry,  for  wasting your time. I think I found where is the problem. I was using node scripts/postbuild.js instead of npm run.. Confirmed it works in v2.0.0-13.. ",
    "egorovli": "Thanks. Yeah, that is totally understandable. I just can\u2019t figure out a way to disable modification of source CSS. Currently I came up with\njs\n{\n  base: './',\n  rebase: asset => asset.url,\n  // ...\n}\nDoes it look like a correct approach?. Thanks a lot!. ",
    "arthurvr": "function (output) {\n. ignore: ['@font-face', /(some|regexp)/, '.my-selector']\n. ",
    "lenovouser": "suggestion\nsudo: required. "
}