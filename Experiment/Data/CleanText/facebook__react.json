{
    "benjamn": "@petehunt good question. I believe jstest actually creates a new window environment for each test, which would mean that the <iframe> strategy is as close as we can get in a real browser: https://phabricator.fb.com/diffusion/E/browse/tfb/trunk/www/scripts/third_party/jstest/runner/run-single-jstest.js\nSo I think/hope that we will have fewer disagreements between phantom and jstest.\nIt's still masking the fact that dumpCache doesn't work the same way, yes. But making dumpCache work would require rewriting the module system that Browserify uses. That's not out of the question by any means, but right now it's nice to be testing the same imperfect module system that we ship in production Browserify bundles.\ncc @jeffmo who might know better\n. @zpao you mean we should modify browserify so that it generates something that works as an AMD module?\nRequireJS does have the ability to load modules on demand, which is a different sort of philosophy from the monolithic package that browserify produces. Both approaches can be worthwhile, and it should be easy to support both. We've just implicitly preferred the monolithic package approach so far.\n. FWIW grunt test builds just enough stuff to run the Jasmine specs, so it takes a lot less time than grunt build.\n. The CoffeeScript grammar appears to be fairly well-defined and extensible. So it might be even easier to write a transformer for XML literals in CoffeeScript than it was to implement JSX using Esprima.\n. @zpao I haven't been able to get r.js to work yet (even when I use it generate the define-wrapped modules), but I don't see why it shouldn't work.\n. What's the nature of the issues?\n. Are there any .js files in src/ yet?\nAlso potentially useful: what node --version are you running, and what OS?\n. Installed 0.8.23 but no luck reproducing. Will try on a Mountain Lion machine tomorrow. Thanks for the report.\nDo you see this failure with an empty .js file? If using an empty file makes the failure go away, perhaps you can try cutting out different parts of the file to figure out the minimal contents that trigger the failure?\nIt could be a problem with fs.watch on Mountain Lion, though. That's my hunch.\n. One more idea: the module cache might have gotten into a bad state somehow. Try clearing it by deleting the directory ~/.commoner/module-cache?\n. I know this is still broken. Still working on a fix.\n. I know this is still broken. Still working on a fix.\n. @adambrunner yep, that's the only way right now (though I use {' '} directly, myself). This is definitely something we want to fix.\n. @adambrunner yep, that's the only way right now (though I use {' '} directly, myself). This is definitely something we want to fix.\n. Hypothesis: The only thing that keeps commoner from exiting in --watch mode right now is the { persistent: true } option passed to fs.watch. That means the process will stay alive while there are any files left to watch. But some text editors save files by deleting and then re-writing them, which causes fs.watch to un-watch the file (because the original inode that inotify cared about got discarded).\nWhen there's only one file, unwatching it causes Node to think no files need to be watched, so the process exits.\ncc @jeffreylin\n. Opened a new Commoner issue: https://github.com/benjamn/commoner/issues/18\nEven though @akrieger said the Commoner tests pass for him, that's only because --watch mode test coverage is\u2026 lacking. :frowning:\n. That's another regrettable but known issue: I suspect you're missing the /** @jsx React.DOM */ comment at the top of the file (which won't be necessary soon, but currently is still important).\ncc @zpao\n. Just to try something else: bin/jsx can take a single file name on the command line: bin/jsx app/helloworld.js. Does that also not show any transformations? Or did you try that already?\n. The deletion is by design, at least. The files that end up in the output directory are actually hard-linked with master versions that are kept (by default) in ~/.commoner/module-cache/*.js. Each build unlinks and then relinks the files in the output directory, so if the relink fails it will look like the file was just deleted.\nNot sure why the relinking might be failing.\nIn case ~/.commoner is on a different device from node_modules, you could try relocating the cache:\nbin/jsx --cache-dir module-cache -w js/ html/js/\n. The original issue still needs fixing, by the way. Still working on that.\n. Had an idea for this: we could generate a browserified bundle where each module dynamically creates a <script> tag with the module source. Then hopefully PhantomJS could give the right line numbers for individual module files.\n. @jordow any luck with this? Still can't reproduce it here, but happy to dig deeper if it's still a problem.\n. Fixed by @yungsters via https://github.com/facebook/react/pull/91.\n. This is in! https://github.com/facebook/react/commit/67cf44e7c18e068e3f39462b7ac7149eee58d3e5\n. Recommended workaround for the time being: just run grunt test again; due to caching, it will pick up where it left off.\n. Confirming that reducing MAX_READ_COUNT for Commoner's file reading queue makes the problem go away:\nhttps://github.com/benjamn/commoner/blob/f006bac9c9152e6ffcb33eb8cc3a6f994f57a794/lib/util.js#L56\n. The one reservation I have about purging it is that it's tricky to get the\nglobal object reliably in a way that works both in the browser and on the\nserver. Function(\"return this\")() is my go-to technique, but that's far\nfrom obvious (especially because of the strict mode considerations).\n. I have ideas.\nIf we take the plunge of forking browserify, then a lot of things become possible. A proper mocking system would be relatively easy to implement if we could redefine browserify's implementation of require.\nBut I don't think we have to fork browserify. Instead, it looks like we can transform our own source files during testing so that require(\"mock-modules\") can manipulate their module.exports, swapping a mocked version of exports in and out as necessary. We can do this either in bin/jsx or using a browserify source transform. I prefer bin/jsx because then, in principle at least, mocking would work with any module packaging tool (i.e. it would not depend on the browserify interface).\nNeed to investigate further, but I think this is really promising.\n. This PR depends on https://github.com/facebook/react/pull/177, just to be clear.\n. Superseded by https://github.com/facebook/react/pull/193.\n. Merging with prejudice.\n. @zpao we can do \"~1.9.0\" (which is a good idea, since right now we have >=), but I think that will still match the bad version: 1.9.1-1.\n. Looks like we can't have || >=1.9.1-2 until that version actually exists, super lame.\n. Closing in favor of https://github.com/facebook/react/pull/261.\n. Closing in favor of https://github.com/facebook/react/pull/261.\n. Accidentally closed. Confused by GitHub IRC bot. #156 is still open.\n. Superseded by https://github.com/facebook/react/pull/193.\n. @spicyj Can you rebase this to trigger the Travis tests again?\n. If you rebase this the tests should go green.\nI'm planning to fill in my TODO once it's merged\u2014is that what you had in mind?\n. I'll make sure to incorporate these changes exactly into my upstream commit.\n. Submitted an upstream patch for this (meant to be identical).\n. @zpao very sorry; I see that I misread your comment. What will this break upstream?\n. Upstream diff: https://phabricator.fb.com/D890554\n. cc @jeffmo @zpao \n. We polyfill Function.prototype.bind in tests, because PhantomJS doesn't support it, either:\nhttps://github.com/facebook/react/blob/0441d4c7f5/src/test/all.js#L9\nWe could polyfill it all the time (not just in tests), but we seem to have a BYOP (bring your own polyfills) attitude about other built-in methods.\n. That's right, this just builds the module into build/modules/ along with any dependencies not already built with React. Which seems safe enough to me\u2026\n. That's right, this just builds the module into build/modules/ along with any dependencies not already built with React. Which seems safe enough to me\u2026\n. @zpao Some Commoner tasks I created following our discussion:\nhttps://github.com/benjamn/commoner/issues/42\nhttps://github.com/benjamn/commoner/issues/41\nhttps://github.com/benjamn/commoner/issues/40\n. @zpao Some Commoner tasks I created following our discussion:\nhttps://github.com/benjamn/commoner/issues/42\nhttps://github.com/benjamn/commoner/issues/41\nhttps://github.com/benjamn/commoner/issues/40\n. @spicyj Which minification stage are you referring to?\n. @spicyj Which minification stage are you referring to?\n. This makes things like https://github.com/facebook/react/pull/325 unnecessary, I think.\n. This makes things like https://github.com/facebook/react/pull/325 unnecessary, I think.\n. https://github.com/benjamn/recast/commit/e5fc90bafcae94af59f34ddd13c30a85641b2986 is a worthwhile change within recast, but not strictly necessary to resolve this issue. With that said, here's 0.4.17: https://github.com/benjamn/recast/commit/b438bbdfe7ba131cdf5e1633007c2715c52ced0a.\n. https://github.com/benjamn/recast/commit/e5fc90bafcae94af59f34ddd13c30a85641b2986 is a worthwhile change within recast, but not strictly necessary to resolve this issue. With that said, here's 0.4.17: https://github.com/benjamn/recast/commit/b438bbdfe7ba131cdf5e1633007c2715c52ced0a.\n. I like this!\nCouldn't you just do return /^(data|aria)-[a-z_][a-z\\d_.\\-]*$/.test(arg); in the new function?\n. I like this!\nCouldn't you just do return /^(data|aria)-[a-z_][a-z\\d_.\\-]*$/.test(arg); in the new function?\n. We also restrict the version of phantom we use to avoid problems with the latest versions. See package.js.\n. We also restrict the version of phantom we use to avoid problems with the latest versions. See package.js.\n. Ah yes, that line has changed a bit since 0.4-stable. Here's the latest version specifier: https://github.com/facebook/react/blob/658f41cb30/package.json#L52\nIt seems likely that, while the react tests passed when 0.4-stable was tagged, with what was then the latest version of phantomjs, running npm install on that revision today would fail because more recent versions of the phantomjs package have been released.\n@zpao do we need a branch fix? I think this PR should do the trick.\n. @dillonforrest thanks for digging into this! We have a similar Function.prototype.bind polyfill that we shim during grunt test: https://github.com/facebook/react/blob/master/src/test/phantomjs-shims.js (required by https://github.com/facebook/react/blob/3dc1074908/src/test/all.js#L5).\nIf you're testing your own React components in PhantomJS, it's up to you to providing a similar polyfill. This pull request ended up getting closed because we don't want to avoid using .bind in the React core or bloat the core with polyfills just because of PhantomJS.\nSo I think the current recommendation is to pick your own fallback implementation of Function.prototype.bind if you need to use PhantomJS. That consistent with your views, @zpao?\n. Will do!\n. @piranha resultList is populated out of order by the line resultList[resultIndex] = renderNode;, but should end up being a dense array of the same length as markupList. At least that's the idea.\n. Can we not expect Testling-CI to run grunt for us?\n. Looks good, but can you rebase?\n. Awesome.\n. What's broken?\n. What about things like var style = { margin: [10, 20] }? This would expand those to margin:10px;margin:20px, when the intent was probably to produce margin:10px 20px;.\n. @cpojer if you want to create an upstream diff I'll stamp it\n. Don't we want to do this only when __DEV__ is true?\n. :+1:\n. Published commoner v0.8.13 to NPM.\n. We could go with --harmony, which Node v0.11 has established to mean \"only some of ES6 Harmony.\"\n. @jeffmo good idea! https://github.com/benjamn/commoner/issues/50\n. try grunt clean?\n. I really wish we'd done this from the beginning. My only concern is for backwards compatibility. Maybe target this for the next minor version bump and make a big deal of it in the release notes?\n. Have an issue filed to support this better: https://github.com/benjamn/commoner/issues/49\n. To be clear, I'd like to hold off on merging this pull request until Commoner has better support for writing multiple files per source module.\nI would be willing to accept a version of this pull request that only appended the encoded source map to the end of the module (without writing a separate file), however.\n. Well, browserify can presumably write one source map for the entire bundle, which is somewhat easier than writing individual source maps for each module. It also has an option for embedding the map in the bundle file.\n. Ah, I see. That definitely is relevant to our interests\u2026\n. Ping. Also, do we want to support --source-map-inline if --source-map-files is available? Can Browserify understand/combine non-inline source map files?\n. We probably want the same logic for bin/jsx-internal, too.\n. Why are lots of ID lookups happening in the first update? Perf certainly matters, but so does complexity, and being able to simply say we don't touch the id attribute. Want to be sure there's not a solution that preserves that story while also addressing performance.\n. :+1: :+1: :+1: :+1: :+1: :+1:\n. Shouldn't this be testing y in x instead, to account for the case where x is something like { y: undefined }?\n. Oh, I see, in most of these cases checking y in x would be pointless because the code is iterating over keys that are guaranteed to be in the object.\nI have to say I don't agree that a 5% performance improvement in a micro-benchmark is worth a change in semantics that is arguably less correct. And I suspect you'll see a loss of performance if you actually start checking for keys that aren't defined on the base object, as @plievone pointed out.\n. So what I would actually support is removing the hasOwnProperty check entirely, and relying on for-in to visit all the keys, inherited or otherwise. There's no need to check something that is already guaranteed by the loop semantics.\n. @spicyj well, @petehunt's patch exposes us to that risk, so we should just keep hasOwnProperty if we're concerned about that\n. Where does the done function come from? Presumably it's passed to the nextUpdate(component, function(done) {... callback function?\n. @thomasboyt is this still happening for you?\n. @thomasboyt is this still happening for you?\n. This is great!\n. We probably want to change the file names so they don't imply the use of browserify. Maybe something more generic, like grunt/config/bundle.js etc.?\n. We probably want to change the file names so they don't imply the use of browserify. Maybe something more generic, like grunt/config/bundle.js etc.?\n. Eh, here's a use case for require(\"react-tools\").React: https://github.com/benjamn/react-meteor/blob/master/src/require-react.js\n. Eh, here's a use case for require(\"react-tools\").React: https://github.com/benjamn/react-meteor/blob/master/src/require-react.js\n. Note that this pull request needs no upstream patch, since the src/test/worker.js file doesn't exist there.\n. What command are you running, and in what directory? I'm having trouble reproducing the slow-down with just browserify -r react.\n. The react.js file (which is un-minified) probably contains @providesModule directives that are confusing Commoner. @michael-jarosik Does the problem persist if you remove the react.js file from dev/js/?\n. Feel free to reopen/tweak this issue if it would help on top of the recent no-rethrowing improvements.\n. Awesome.\n. There's definitely something weird going on here. The error message is as accurate as it can be, though it's generally difficult to guess (at the framework level) what the root source of the problem was.\nWhen we've seen errors like this in the past, it was typically because .cloneNode() was being used by client code to make copies of React-generated nodes, also copying the data-reactid attribute (which is supposed to be unique), but my brief investigation doesn't point there this time.\n. There's definitely something weird going on here. The error message is as accurate as it can be, though it's generally difficult to guess (at the framework level) what the root source of the problem was.\nWhen we've seen errors like this in the past, it was typically because .cloneNode() was being used by client code to make copies of React-generated nodes, also copying the data-reactid attribute (which is supposed to be unique), but my brief investigation doesn't point there this time.\n. That story is consistent with my findings: the invariant in ReactMount.getID was failing because cached !== node, where cached was a <span> and node was something like { impl: cached, ...}, so it sounds like the node was one of the ShadowDOM wrappers you're talking about.\n. That story is consistent with my findings: the invariant in ReactMount.getID was failing because cached !== node, where cached was a <span> and node was something like { impl: cached, ...}, so it sounds like the node was one of the ShadowDOM wrappers you're talking about.\n. @arv React creates most of its nodes by setting .innerHTML, so unless Polymer is hooking that setter, that might be one way raw DOM nodes get exposed?\n. @arv React creates most of its nodes by setting .innerHTML, so unless Polymer is hooking that setter, that might be one way raw DOM nodes get exposed?\n. Just in case you still have an old version of the commoner dependency installed, you can do rm -rf node_modules/commoner; npm install .\n. Just in case you still have an old version of the commoner dependency installed, you can do rm -rf node_modules/commoner; npm install .\n. Sounds reasonable, but you probably need to do the npm publish since I don't think I have NPM credentials for react-tools.\n. What about changing it to\njs\nvar child = spawn({\n  cmd: \"node\",\n  args: [path.join(\"bin\", \"jsx-internal\")].concat(args)\n}, function(error, result, code) {\n. Cool, I can put up a PR for that (unless you have the time, @jbrantly).\n. This makes me wish components were EventEmitters and anyone could subscribe to e.g. the \"update\" event: component.once(\"update\", function onNextUpdate(event) { ... }).\n. This makes me wish components were EventEmitters and anyone could subscribe to e.g. the \"update\" event: component.once(\"update\", function onNextUpdate(event) { ... }).\n. Fixed better by https://github.com/facebook/react/pull/1330.\n. @zpao I'll take care of creating an internal diff.\n. Note that JSON.parse(JSON.stringify(obj)) not only fails to clone cycles but also throws an exception if there are any cycles. As long as these tests pass, that seems fine, but I wonder if there's a way of cloning the objects that allows for cycles.\n. :+1:\ncc @sebmarkbage @zpao @yungsters\n. I'm a big fan of this idea.\n. @zpao just merged the version you posted internally, thanks\n. lgtm if the tests pass\n. For \"environments that don't polyfill global\":\njs\nif (\n  typeof global === \"object\" &&\n  global !== null &&\n  typeof global.process !== 'undefined' &&\n  global.process.env &&\n  process.env.NODE_ENV === 'test'\n) {\nWould that address your concerns, other than the general lack of maintenance resources?. I realize this is a drive-by comment, so I may be missing some nuances, and I certainly don't expect any change of course for this proposal.\nHowever, I can't help noticing that every example of unsubscribe seems to depend on data that was also passed to, or returned by, the subscribe method. If you wanted to simplify the API even further, one pattern that I've seen for subscription APIs is to have a single subscribe method that returns a suitable unsubscribe function, which automatically has access to any data that was available within the subscribe function (like any closure in JS).\nIn other words, this example:\njs\n// Create a wrapper component to manage the subscription.\nconst EventHandlerSubscription = createComponent({\n  getValue: eventDispatcher => eventDispatcher.value,\n  subscribe: (eventDispatcher, callback) => {\n    const onChange = event => callback(eventDispatcher.value);\n    eventDispatcher.addEventListener(\"change\", onChange);\n    return onChange;\n  },\n  unsubscribe: (eventDispatcher, subscription) => {\n    eventDispatcher.removeEventListener(\"change\", subscription);\n  }\n});\ncould be simplified to just\njs\n// Create a wrapper component to manage the subscription.\nconst EventHandlerSubscription = createComponent({\n  getValue: eventDispatcher => eventDispatcher.value,\n  subscribe(eventDispatcher, callback) {\n    const onChange = event => callback(eventDispatcher.value);\n    eventDispatcher.addEventListener(\"change\", onChange);\n    return () => eventDispatcher.removeEventListener(\"change\", onChange);\n  }\n});\nAre there ever any situations where unsubscribe is called with arguments that were not produced by a subscribe method? If so, then I understand the need for an independent unsubscribe method. If not, I hope you'll consider the ergonomic improvement of passing information to the unsubscribe function using a closure / lexical scope. Two methods (getValue and subscribe) instead of three, and no need to explain how the unsubscribe function gets its information.\nThanks for listening to this outsider's unsolicited hot take. \u270c\ufe0f. > This might make the promise use-case more awkward to explain, since you would have to return a no-op function. (I would expect subscribe to always return a function. Otherwise I think it would be too easy to introduce a memory leak.)\nI've definitely seen versions of this kind of API where subscribe can optionally return nothing, in case there's nothing to unsubscribe from, though it might be wise to require explicitly returning false in those cases (so you have to think about what you're doing, at least).. The first example that comes to mind is the proposed Observable constructor, to which you're supposed to pass the equivalent of the subscribe function, which then may return a function to unsubscribe:\n```js\nnew Observable(observer => {\n  // Create an event handler which sends data to the sink\n  let handler = event => observer.next(event);\n// Attach the event handler\n  element.addEventListener(eventName, handler, true);\n// Return a cleanup function which will cancel the event stream\n  return () => {\n    // Detach the event handler from the element\n    element.removeEventListener(eventName, handler, true);\n  };\n});\n``. How about \"the fastest way to update the UI when the data changes\"?\n. How do I get it to install into a temp directory?\n. Would it be useful to have an implementation ofsetImmediatehere? Perhaps with a queue for batching so that all the deferred events fire in the same (later) event loop tick?\n. The tests will pass, but there will be fewerexpect`-ations counted in the final tally.\nThese tests can still be run in the browser if you do grunt test --debug.\n. Sure, sure.\nFor what it's worth, the static_upstream polyfill doesn't bother with constructor function binding, either. Seems like a nontrivial cost to pay for a minority use case.\n. Not entirely sure how this motivates React. Maybe just tack on a \"so\u2026\" clause to make the implication explicit?\n. callee.arguments.length = 1 plz\n. Apologies in advance: when you visit a node, it becomes your responsibility to traverse its children, so there needs to be a this.genericVisit(call); line here at the end. No way you could have known; sorry.\n. Is this appropriate to commit upstream? Auto-mocking would take care of this in theory, but the details need some more work.\n. Same comment about committing upstream.\n. @petehunt are you saying that ReactDefaultInjection should not be auto-mocked upstream by default (as far as I know it is currently mocked automatically)?\n. Nice job figuring that out. I hoped it would come in handy some day!\n. removeNextSiblings it is, then!\n. Nice, :+1:\n. @jakubmal could you just inline this call below, instead of creating a closure here?\n. Yeah I don't like the /** either but there are other variables commented that way in this file. I'll change it.\nHappy to use a more specific name.\nThe local assignment to firstChildren was intended to avoid the scope chain lookup for the module-level variable, since that search loop could be hot.\n. Why, yes I can! http://jsperf.com/outer-variable-aliasing\n. Can you call require(\"./phatomjs-shims\") here, and not include <script src=\"phantomjs-shims.js\"></script> in index.html below?\n. These end up being defined in global scope. If we're going to use this as a standalone .js file, maybe wrap it in an immediate-invoked function expression?\n. I'm assuming the problem here is that populist tries to create <script> tags instead of just defining module wrapper functions. The only benefit of that approach is that you get more accurate line numbers. Do you know if there's any way to create scripts programmatically in a worker?\n. Curious why the node.value = 'giraffe' is ignored here.\n. So ReactTestUtils.Simulate.input(node) should cause node.value to be reset? Do you happen to know where that happens?\n. I'm trying to upgrade the jsdom module that we use for our internal test environment. It's a big jump (v0.2.15 to v0.8.6), so no surprise there are problems, but one of them happens to be that node.value remains \"giraffe\" after this input event. I'll investigate some more. Thanks for confirming this is the expected behavior.\n. How confident are we about spaces in file names? I'd be tempted to just use underscores here.\n. I think this requires us to run grunt build before grunt test, so that build/react.js will be built. Wondering if we should make grunt test depend on grunt build.\n. Is this ; needed?\n. cc @spicyj who last worked with ReactWebWorker-test: thoughts?\n. Since you've got your own scope here, why not just\njs\nvar parts = __filename.split('/');\nparts.pop();\nvar __dirname = parts.join('/');\n. Why can't this be document.write-ten?\n. Or: why shouldn't these be document.createElement-ed?\n. Since there's no immediate rush, let's do the right thing. Done == perfect, unless there's a good reason to cut corners.\n. Not sure I see the point in making this a dynamic JS file instead of generating a simple HTML file. Am I missing something?\n. Can we get rid of this file if we're using SauceLabs instead of Testling?\n. We generally don't leave commented-out code lying around. Feel free to just remove this.\n. Since scripts is a NodeList, you probably want scripts.item(i) here (and below).\n. Maybe just if (key.indexOf(\"grunt-\") === 0) grunt.loadNpmTasks(key);?\n. Please remove related bits from grunt/config/populist.js.\n. Comment this? Looks interesting!\n. Any risk we might be running the tests on a shared machine and have port conflicts?\n. Still want to get rid of this file if possible.\n. Maybe make the || trail at the end of the lines so the img tokens line up vertically? I love it when that happens.\n. Our style elsewhere in the React codebase is to indent multi-line if conditions just past the if (, even though we use two spaces for indentation, just saying.\n. Can you also remove the obsolete parts from grunt/config/jsx/jsx.js?\n. Did we figure out if grunt.log.writeln exists?\n. I'm going to turn that question back to you: can you think of a good way to remind us, or a better solution? This pull request makes it possible for one mindful person to prevent confusion for everyone, and that's a step in the right direction.\n. @zpao will probably complain that you should always use braces and break lines, even for if statements like these.\n. What arguments does bundle.transform expect?\n. We generally indent .method calls by two spaces when they fall on the next line like this.\n. Can you make these methods take multiple arguments, like the standard console.error and console.log methods?\n. Why is console._flush() necessary here? Is it a widely-implemented method? Maybe call it only if it exists?\n. To answer my own question: I guess bundle.transform takes a transform function to apply to the bundle.\n. oh derp, nvm\n. Nit: this line is now pretty long. Please format like test:webdriver:phantomjs below.\n. Same formatting comment.\n. Thanks for updating the style here.\n. This can just be .sort(function(a, b) { return results[b].length - results[a].length }), right?\n. Note to self: figure out how to log a similar URL for Sublime text and/or Emacs.\n. Maybe put some faith in var hoisting and just say var mockMap = require(\"mock-modules\").getMockMap() here, without the var mockMap; above?\n. To be fair, trailing commas are OK in array literals (they don't even create an array hole\u2014you need two trailing commas for that).\n. Is this regular expression any different from /^\\s/?\n. Maybe comment about this character, the \"zero-width non-breaking space\" (it's one of my favorites).\n. Any theory (or reference) as to why this has any effect?\n. I prefer typeof useWhitespaceWorkaround === \"undefined\" or useWhitespaceWorkaround === void 0, since undefined is just an identifier that could be reassigned to something else in theory.\n. A few more tests (with more/different whitespace) would be great here.\n. Yeah, I think just: \"Any character would do here, but \\uFEFF has the potential advantage of being zero-width/invisible.\"\n. Would it behave the same way if you set the .innerHTML while the node was detached, and then reattached it?\njs\nvar parent = node.parentNode;\nvar nextSib = node.nextSibling;\nparent && parent.removeChild(node);\nnode.innerHTML = ...;\nparent && parent.insertBefore(node, nextSib);\n. Yeah, I think just add \\f.\n. :+1:\n. As noted on twitter, this is unsafe because the .process callback is only called the first time a module is built, so source map files will be written correctly for clean builds but not for incremental rebuilds.\nCommoner needs to know about additional files before any processing takes place, so that it can make sure they get into the output directory, whether or not processing was necessary.\n. I would prefer to call this task bundle instead of commonjs, because we're bundling CommonJS modules together, and bundle is a generic term that makes sense regardless of which particular bundling tool we use.\n. And, by the same logic, this file (and the corresponding config file) should be called bundle.js.\n. Shouldn't we call done(false) here to fail the build?\n. Why unescape and not decodeURIComponent?\n. Won't this ignore the existing array? Is that what we want (instead of concatenating or merging somehow)?\n. Maybe grunt.file.write(options.output, ...?\n. probName?\n. If I recall correctly, (function() { return this })() won't return the global object in strict mode, which is part of the reason we were using Function(\"return this\")() before.\n. Yeah, or how about adding ExecutionEnvironment.global?\n. I'm also fine with the no-op approach (I suggested false above).. ",
    "mz121star": "@zpao \n thanks\uff0c I get it. \n react is gorgeous !\n. ",
    "vjeux": "See #114  :)\n. We can't make it work with the default language unfortunately. It is a <script> tag that executes automatically. We need to use Javascript1.7 or CoffeeScript.\nThe goal is to provide a HelloWorld JSFiddle that people can modify and fork that is properly configured.\n. This would be ideal indeed, but meanwhile this is a working solution\n. Let me update it so we have to put /* @jsx React.DOM / in the code instead of having the script automatically inserting it.\n. http://jsfiddle.net/vjeux/25Rhk/ Here's how the new base fiddle\n. Using JS1.7 we lose syntax highlighting unfortunately. We can already make it work with the normal Javascript but since the code is executed it displays a javascript error every time you run it. I haven't found a way to make that parsing error go away without also losing syntax highlighting :(\n. I just mailed Piotr Zalewa the author of JSFiddle about the issue.\n. @jordow: Ping!\n. New docs mention it :)\n. We're 2 months into the release, let's close it out :)\n. I'll rebase it tomorrow to fix the conflicts\n\nChristopher \"vjeux\" Chedeau\nFacebook Engineer\nhttp://blog.vjeux.com/\nOn Jun 11, 2013, at 10:36 PM, Timothy Yung notifications@github.com wrote:\n\nWhat's the consensus? This seems fine to me.\nHowever, there are merge conflicts.\n\u2014\nReply to this email directly or view it on GitHub.\n. \n. Ping @zpao \n. You can do the following right now:\n\ngetStyle: function() {\n  return {\n    fruit: {border: '1px solid black'}\n  }\n},\nrender: function() {\n  return <div style={this.getStyle()}>Hello</div>;\n}\nLet's close this out until someone comes with a real proposal :)\n. It's now working :) Closing\n. Ping, I'd rather not have to change the date :)\n. This hasn't been updated in 6 months, closing it. Please re-open if you think that it should still be done\n. Does it only happens for onClick or also for onTouchStart, onDblClick ...?\nDoes attaching an onClick event listener to the dom node fixes the issue?\n\nChristopher \"vjeux\" Chedeau\nFacebook Engineer\nhttp://blog.vjeux.com/\nOn Jun 27, 2013, at 10:45 PM, Lee Byron notifications@github.com wrote:\n\nstyle=\"cursor:pointer\" also fixes this :)\n\u2014\nReply to this email directly or view it on GitHub.\n. :+1: \n. @chenglou thanks, fixed :)\n. @zpao \n. Changed the date to monday\n. We talked about it several times and we agreed that we should support  but no one actually wrote the code to support it yet.\n\nIn the meantime you can do\nvar Component = Namespace.Component;\n\nThanks for the report :)\n. @jakubmal: I said that it shouldn't be too hard. But I'm pretty sure it's not a one liner :)\n. Why the safety guard?\n. Ping ping\n. \n. This is not really actionable. Closing this one\n. cc @jordwalke \n. Better integration in the way\n. This is still an issue today: http://jsfiddle.net/vjeux/WMMLZ/\n. Accepted :)\n. I just reduced the test case to 19 lines.\n. @petehunt: yeah changing 2) to use a span works as expected\n. @brianr: I cannot reproduce what you are seeing: http://jsfiddle.net/vjeux/FwvMt/ It also bugs if I use a different string\n. Nevermind, it's a Chrome inspector bug. The values are actually there.\n\n. Oh ... maybe we want to replace null by something more meaningful to the user. Like 'this is a pooled instance'\n. Ping ping ;)\n. What's the status here. Do we want to go forward with this change?\n. @vjeux approved\n. \n. What's the status here?\n. What's the status here?\n. I really like this change :)\n. Is it good to be taken in?\n. Ping\n. Nice!\n. Who should review this?\n. Who should review this code?\n. What's the status here? Do we want to pursue this diff?\n. Do you know who should review this diff?\n. I feel like those use cases can easily be addressed by a small wrapper that has feature detection.\nvar style = {\n  cursor: grabCursorWithPrefix(),\n  backgroundColor: rgbaWithFallback(200, 54, 54, 0.5)\n};\nBut, if you really need to write them using fallback, you can just make a CSS rule for them and add use a class.\n. Ok I'm sold, let's do it :)\n. If you don't need any state, you can return {}; instead of null\n. I'm good with it, letting @zpao do the final accept\n. I'm regularly sending people towards DOMContainer which has a small yet useful API but we don't provide it. That would be a great addition to addons.\n. FYI: Internally there's\n- flattenChildren but that returns a map: https://github.com/facebook/react/blob/bdf2a9bb124b8fc34120949b322202497741f239/src/utils/flattenChildren.js\n- mapAllChildren that iterates but doesn't create an array: https://github.com/facebook/react/blob/bdf2a9bb124b8fc34120949b322202497741f239/src/utils/mapAllChildren.js\n. Ping @petehunt \n. @jenso: Why not doing b) and having a component per file? We do that internally and it's worked very well for us.\n. Supporting arbitrary JS expression may be tricky. What happens if you write\n<Foo[myVar()]>\n  ...\n</Foo[myVar()]>\nAre the two expressions executed? What if they don't match? Lots of corner cases\n. #334\n. This is a regression of React 0.4.0. It was working in React 0.3.2.\nReact 0.3.2 (works): http://jsfiddle.net/vjeux/t6qL9/\nReact 0.4.0 (throws): http://jsfiddle.net/vjeux/Yh95C/\n. I know it's lame but can you sign the CLA so I can take this in? https://developers.facebook.com/opensource/cla\nThanks!\n. Awesome, it'll be live the next time I do a batch of updates on the website :)\n. @SubtleGradient proposed the following:\n<Card>\n  <Title insertAsProps=\"title\" ... />\n  <Body insertAsProps=\"body\" ... />\n</Card>\nThat would be the equivalent of doing\n<Card\n  title={<Title ... />}\n  body={<Body ... />}\n/>\nEDIT: insertAsProps prop isn't needed when passed as a prop value.\n. A React component can be seen a function. It's arguments are props and local variables is state. If you think as it this way, it actually make sense to pass the title as a prop. What's inside of the tag has a special meaning which is children. It feels like a hack to manipulate and modify the children to split them into different groups.\n. When using dangerouslySetInnerHTML, you are using the HTML5 parser which is not an XML parser. It has a lot of weird rules in order to parse any HTML you throw at it in backwards compatible ways.\nJSX is a proper XML parser though and should handle your code properly.\n. For FB people going to take this kind of code. When pulling in, make sure that you check for existing code that uses the same name using onError=. For onLoad it broke two call sites that accidentally transferred it to DOM nodes using this.transferPropsTo.\n. A more real-world example is a data table with sorting. You touch all the elements the first time\n. Thanks a lot for doing this. Here's a suggestion.\n\nGeneric sentence saying to use both shim and sham\nshim provides the following that React needs:\n- ...\nsham provides the following that React needs:\n- ...\n. Does it have any effect on performance? I fear that adding a try catch there is going to be bad for perf\n. Nice, this is an awesome fix then :)\n. Oh nice, I didn't know they had a way to plugin new languages. When I tried, jsfiddle was the only one where I could hack into it and make JSX work-ish.\n. You can use github to edit the docs inline and send a PR directly from there :)\n\nhttps://github.com/facebook/react/blob/master/docs/docs/06-forms.md\n. I really like this change!\ncc @yungsters @jordwalke @petehunt @sebmarkbage \n. I'm curious, why do you want them?\n. Thanks for opening an issue, this is very useful to get confusing error messages with examples. cc @jeffmo \n. Remove the unrelated modification and i'm taking it in\n. \"I did a torture test of it\". Can you also put that code somewhere? It would be really useful to track it over time and for the next time we want to modify the ids\n. Ping, 0.9 is now live :)\n. 0.9 is out, ping? :)\n. Can you give an example of such bug?\n. @hllau: this should be an easy fix, do you want to try to fix it and submit a pull request?\n. :+1:\n. It starts getting messy, what about:\nInstallation\n\nThe fastest way to get started is to serve JavaScript from the CDN:\n\nhtml\n<!-- The core React library -->\n<script src=\"http://fb.me/react-0.3.0.min.js\"></script>\n<!-- In-browser JSX transformer, remove when pre-compiling JSX. -->\n<script src=\"http://fb.me/JSXTransformer-0.3.0.js\"></script>\n- You can play around using this base JSFiddle.\n- We've built a starter kit which might be useful if this is your first time using React. It includes a webpage with an example of using React with live code.\n- If you'd like to use bower, it's as easy as: bower install --save react\n. Why are you doing those updates during the next frame? We already know what needs to be changed during this frame. We're losing 16ms of responsiveness (even more for setTimeout polyfill).\n. Make PyReact a link to https://github.com/facebook/react-python/\n. Well, all those tools are about JSX :)\n. Let me pull out React Page on its own heading instead\n. Thanks. Btw if you have a better sentence to put here feel free to suggest one. I'm not really fan of this one but can't find something better :)\n. Okay, getting rid of them. While they are distracting, they make the links a lot easier to read. Since some of them are spanning into two lines, it's hard to see which one is which\n. I added the spacing which helps and limited the number of posts to 10. So it's better than it was before. We can iterate on this later on with a real designer :)\n. I tried to add a param as explain in Jekyll docs ( http://jekyllrb.com/docs/templates/ )\n{% include buttons_unit.html colorscheme=\"light\" %}\nbut unfortunately it didn't work :( It spits an error saying that there are unknown characters in the declaration.\n. This is now react-page\nhttps://github.com/facebook/react-page/\n. Note: if you modify this.state but don't do it through setState you still need to call forceUpdate()\n. This article is so awesome. Thanks a lot :)\n. Probably here: http://facebook.github.io/react/docs/tooling-integration.html\n. nit: can you indent it\nclean_title = Sanitize.clean(title)\n  .downcase\n  .gsub(/\\s+/, \"-\")\n  .gsub(/[^A-Za-z0-9\\-_.]/, \"\")\n. We agreed that this is not going to be part of v1, can you remove this file.\n. nit: add new lines at the end of the files\n. nit: indent 2 spaces\n. I don't think you need that since you don't have live sample anymore\n. nit: whitespace before />\n. Can you add a line saying that <MyComponent /> is the equivalent of <MyComponent></MyComponent>\n. (Not needed for now): Would be nice to have counter examples and how to solve them\n. Would be really nice to have some examples here\n. nit: we use single quotes in React codebase. Would be nice to be consistent in the examples too\n. nit: put mountNode on the next line\n. nit: line break\n. there's something weird going on with this line\n. I think you want to kill this file\n. I think you want to kill this file\n. nit: we also use single quotes instead of double for strings\n. super-like-stamp\n. missing () after getDOMNode\n. As we talked on IRC. Let's just do that all the time\n. mind removing the trailing whitespace? :)\n. undefined should also be valid. Otherwise a function like this would fatal:\ngetInitialState: function() {\n  if (something) {\n    return {some: 'abc'};\n  }\n}\n. you don't need [' ... ']. this.refs.item0.animate();\n. add the big speech about an alternative way to do it at the end (after the example)\n. > Rather, let the parent call the todo animate() method.\nAlso mention that you use refs in order to get a reference to the child.\n. - component A -> child component\n- component B -> parent component\n. can you add a conditional for IE8 ?\n. For future reference: http://www.phpied.com/conditional-comments-block-downloads/\n. fyi, :first-child works on IE8. A common way to work around is to special case on first-child and swap the left/right :)\n. hmm, can you put a screenshot of how it looks like?\n. nit: can you fix the typo documentation\n. nit: space around -\n. nit: space around -\n. nit\n. nit\n. nit: please put the content of the if on it's own line\n. same\n. nit: you don't need the else since you return from the if branch\n. nit: space around =\n. nit: just reuse the variable i\n. nit: the code convention is to indent this way:\nthis.staggerTimeout = setTimeout(\n  this.addStagger,\n  TICK,\n  staggerClassName\n);\n. nit: we usually don't indent all the way. This makes it very easy to reach the 80 columns limit :)\nvar cascade = (this.props.cascade > 0) ?\n  this.props.cascade :\n  this.props.leaveCascade;\n. nit: put the else part in the next line to make it easier to read\nvar append = isValidJSIdentifier(name) ?\n  '.' + name :\n  '[' + JSON.stringify(name) + ']';\n. , /* isNamespace */ true)\n. nit: put the ); on it's own line. We're not really using lisp parenthesis convention on the js codebase\n. nit: put ) + '(', on the next line\n. note: you don't need the else since you return from the if branch :) This lets you have one less level of indentation\n. same here\n. As we discussed on IRC, your tool is better than this one, mind removing it? :)\n. s/Generic React Exception/React Exception/\n. this breaks a test internally because tagName is not defined. If you add\ntagName: 'IMG',\nthen it works fine.\n. why not xmlnsXlink? xlinkNamespace seems like a weird name\n. Should we use .hasOwnProperty('id')? I don't really know if we have a coherent way to deal with the prototype chain anyway.\n. unrelated. Can you submit another PR for that\n. globalObj = this; maybe?\n. is it still needed? I don't see any handle in the arg list\n. remove\n. The doc block says that it returns a boolean but this is not. You probably want to update the doc block\n. and make this return null\n. missing docblock for forceReactRootID\n. missing forceReactRootID\n. this is a handle and no longer a DOMElement\n. this is no longer a DOMElement (same for all of them in this file)\n. this is unused, kill it\n. mind adding a comment as to what target (worker) and modules (object where keys are module names and values the actual module) are.\n. You could simulate return values via a callback. I don't think you handle them though\n. how*\nWould be nice indeed :)\n. oh yeah!\n. you wrote still twice\n. :+1: \n. Woops, fixed\n. done\n. thanks i removed all the dots and commas\n. Would be awesome if you could add Lou Husson <loucore@gmail.com >, he's been helping a lot with the roundups. I swear that I merged a round-up commit from him but I can't find it :(\n. it's just ;harmony, not =true\n. This is going to blow up. n^2 storage where n is the length of the html. Going to be huge very quickly and you don't really need it. Can you just find the first character that differs instead and display [-20;+20] range from there?\n. The name doesn't reflect what it does anymore\n. i === string1.length || i === string2.length will never happen\n. no need the temporary idx variable anymore, just return i\n. return -1;\n. I have a feeling that it's not going to work correctly across browsers. But since it's just for a debug message, I think we can live with it for now and see how it behaves.\n. the convention is to only indent by 2 spaces when it spans into multiple lines\n. yeah, would be nice to only compute that difference in DEV\n. the result type should be number (JS doesn't expose an int type)\n. this is pretty hacky :p\n. can you revert this change\n. and do all the difference computation here?\n. oh also, put back the attribute when you are done, ideally we should leave the dom back in the state it was before\n. nit: it fits with the previous line\n. setAttribute\n. restore it just after getting the outerHTML. The farther away you do it, the more chance that it'll introduce a bug down the line\n. nit: combine with the previous line\n. nit: combine with the previous line\n. nit: if it doesn't fit in 80 columns, put ); on its on line after\n. nit: merge with the previous lines\n. this entire if now fits in one line\n. noooo :( Can you just put ReactMarkupChecksum.CHECKSUM_ATTR_NAME, on its own line? then I don't have any other comment anymore\n. nit: single quote and space around +\n. nit: single quote\n. nit: === instead of ==\n. ReactElement<any>\n. Instead of returning number, could you do\njs\ntype ReactNodeType = 0 | 1 | 2;\njs\ngetType: function(node: ReactElement<any>): ReactNodeType {\nthis way it'll prevent people from passing arbitrary numbers, flow will force to use the literal 0, 1, 2 or anything that returns those values. It's not perfect but much better.\n. ReactElement<any>\n. any is probably the right call here, could you put ?any though. Even if it doesn't change anything in the type, it convey the fact that the function accepts a nullable value.\n. Can you type the return function, if we put any, it doesn't bring any benefit since flow is just going to ignore it.\njs\n?{ [name: string]: ReactElement<any> }\n. Can you try mixed instead of any. Any will ignore it whereas mixed will ensure that the type stays consistent thorough. It's usually better when you don't know the type.\n. Looks good to me, it passes flow right?\n. @spicyj do you know if it is safe to do?\n. If if is, I would also do the same for textarea instead of doing nodeName.toLowercase() \n. I guess that I need to typecast to any then. Can someone stamp it or request changes? Thanks!\n. Thanks! https://github.com/facebook/react/pull/7110\n. My understanding was:\n- selfDebugID?: number means that the argument is optional but whenever it is set, it is always a number.\n- selfDebugID: ?number means that there's always an argument but it can be null.\nBut, it looks like it doesn't work that way. I'll post in the flow group.\nhttps://flowtype.org/try/#0PQKgBAAgZgNg9gdzCYAoVUCuA7AxgFwEs5swAvAUwCc4B5K27CgQSoHMAKADwH4AuMNkwBbAEbUAlAKFjqYAN6owYKhXyYqpLmAA+OsAEYADAG5UAXww4CxUhS4BDAjACejFu24CeM8VSmCIn4KSipqGlq6+sZmlqiUNPTurJwSZgl0DEwpHMZp6PZO+K7JnvmFzm7ZnnlmQA\n. I have no idea what flow weak does, can you educate me? Also what isn't working with normal flow?\n. I just pinged the flow team and @flow weak is described as a hack, very experimental and not recommended because it keeps errors latent. We have less than 20 files in the entire codebase using it. So, we should not using it on React :)\n. nit: should you return the value of the call?\n. Yeah we should warn and not throw. I have a feeling that it's going to start triggering a ton of warnings on existing react native apps so someone from the team needs to do the work of cleaning up fb codebase before shipping this.\n. Smaller number being higher pri is inconsistent in the way I would read that line\n. Two options there:\n- Allow negative priorities (or make every priority negative so that the ordering is maintained)\n- Allow floating point number priorities\nNot sure if they are better than the status quo though\n. is it useful to return undefined; as the last line of a function?\n. (same here)\n. We have the same lines on www fyi: https://fburl.com/407281661\n. I typed everything any that I did not need to type ReactComponentTreeHook\n. I'm not sure if I should put them in this file (which is a bit random) or in a different file\n. Instead of having each function handle both cases, I made a different function for each one. I find it to be easier to read and understand what's going on, and I believe it should be a tiny bit faster :)\n. By splitting it, it is now obvious that those two functions are only needed in the object case\n. create was only being used once, I inlined it here\n. I'm using getDisplayName here instead of reimplementing a bad version of it\n. It took me a while to figure out how instantiateReactComponent worked, this is super convoluted :)\n. While trying to fix flow, I ended up moving that inline check here instead of the call site. I can revert it\n. I added two invariants to make sure that we ensure that the item has been properly extracted out. The fact that it is actually set depends on a ton of different files so it may be a good idea to enforce it at runtime, idk\n. bad find/replace, should probably restore (even though it's also correct)\n. second invariant\n. I'm not sure how to name this one since it's going to conflict with the ReactElement name. I've thought about appending Type but it kind of sucks to have all the types have Type at the end... In a normal codebase, the same name works because flow assumes instanceof. But in the React codebase, a lot of things return random objects with weird constructions :p\n. I'm not sure that our www pipeline understands this. I think it's really dumb and only look for if (__DEV__) as the previous code used two nested ifs\n. can you add an inline comment saying what null means in this context, it's not clear\njs\n}, /* whatever */ null);\n. missing if check here\n. Today I learned that you can use try without catching!\n\n. Can you explain why you initialize debugID outside of a dev block when you only use it in __DEV__?\n. Did anything change for this block of code? Or is it just code formatting?\n. What happens if you have components that recursively render themselves, would it end an incorrect one? Should we put the debugID in there to make it unique?\n. \ud83d\udc4d \n. Or if two components are not named and you end up with 'Unknown' https://github.com/facebook/react/blob/master/src/isomorphic/hooks/ReactComponentTreeHook.js#L176\n. Not really about your diff but should we have a unique way to check if an element is composite? ReactTestUtil has a different way of testing it: https://github.com/facebook/react/blob/1c5a639c37039a9c60752980dfee168129b76b32/src/test/ReactTestUtils.js#L114-L123\n. \ud83d\udc4d \n. It seems like debugID is always set with this._debugID. Is there a reason why you need a local variable for it in the first place, especially since it requires you to write some code that could be confusing like this?\n. Got it, yeah we usually don't pass the argument when not used.\n. btw, a total n00b question but what is so special about debugID === 0 that we need to check against everywhere?\n. Not from this PR but I'm usually pretty against this kind of contractions, constructor is not that much longer and will not confuse anyone.\n. Thanks for the early return, this makes the code much easier to understand than having many nested layers of if statements\n. How bad would it be to have the debugID check inside of measureLifeCyclePerf? This way you can greatly simplify all the call sites\n. FYI, this was an issue with ES3 but is no longer an issue with ES5 and we do have a transform for it.\n\n. I wish that JS had some compile time ways of doing zero-cost abstractions instead of having to copy some non trivial logic twice. In C I would have used a macro for it.\n. you are only using debugID in a __DEV__ context in this diff right? Or is there something I'm missing?\n. Ok, this is one place where you are passing it down outside of a dev context\n. In all the other blocks, you mirrored character for character the two branches but didn't do it here, I think it would be valuable to update this code to look exactly the same as the perf branch\n. \ud83d\udc4d \n. Sorry I wasn't clear, I meant writing the one above\njs\ninst.componentDidUpdate.bind(inst, prevProps, prevState, prevContext),\ninstead of\njs\n() => inst.componentDidUpdate(prevProps, prevState, prevContext),\nthis way it's clear there's a parallel between the two\n. So good, I was going to ask if you could make this less verbose and repetitive :)\n. Probably overkill but if canUsePerformanceMeasure is not true, I would just do shouldMark = function() {}.\nYou could use the same technique by clearing shouldMark when you end profiling and bring it back when you start profiling. This way you don't even have to do that test.\nI have no idea what are the perf implications of this but since we're talking about super hot functions, it may be worth it.\n. In practice this is always called with a string. If I put it optional, then flow complains about the concatenation of react-${name} down below.\nI chose to keep the types in the comments but we may want to get rid of them\n. I'm not sure how to type those. In the comment it says it is optional but there's no checks in practice in the call sites: https://github.com/facebook/react/blob/a229cdba7fd00799d82c1bab23704220d47e6331/src/renderers/shared/stack/reconciler/ReactCompositeComponent.js#L1024\nIf I put it required, then flow won't let me type it. I'm not sure if we should update the call sites with a check or lie to flow and say it is always defined and trust the user to properly inject it.\n. When ReactInstance and Updates will be implemented, need to go back here and properly type them\n. arg, I ran npm test but didn't run the lint. Travis is soo backed up, I'll send a quick fix\n. I'm doing two implementations in the two branches below, I want both to match the same API. What is the flow way of doing things?\n. Looks like I don't even need this block anymore, if I remove it, it works with flow!\n. @sebmarkbage See https://github.com/facebook/react/pull/7570\n. That's correct! Less code needed :)\n. I created those two types in order to name them in the code even though they are not properly typed yet.\n. This will probably need to be moved to a different place later. @cpojer told me during his jest flowification hackathon that it's better to put them inside of the file you're working on and when you need it in another place, then extract them, instead of doing it the other way.\n. I tried to add an invariant saying that if ownerID is null, enforce that parentID is not null, but it throws in tons of places in tests.\n. Do you know if we can kill this now?\n. I'm not very happy with this change but I can't think of a better way that wouldn't involve a massive change.\nhttps://www.facebook.com/groups/flowtype/permalink/1132169456831668/\n. \ud83d\udc4d \n. since Transaction was not flowified, this didn't do anything!\n. The flow team wants to make this an error in the future. We shouldn't be able to use a non-flow file as type as it silently turns it into any. (Internal discussion: https://www.facebook.com/groups/flowtype/permalink/1132421916806422/ )\n. I'm not sure I understand your suggestion, do you want me to change the API such that it does:\njs\nMixin.OBSERVED_ERROR = {};\nmodule.exports = Mixin;\nthis way the mixin, which is the transaction is exported and does the \"right\" thing, but at the cost of changing the API and updating all the callsites (probably only a few).\nOr do you want me to export this as Transaction type and then change the call site to not use require but instead import type?\n. also, the way I wrote it works by accident, Transaction.Mixin doesn't exist yet in this line :p\n. \ud83d\udc4d will do!\n. The file is not @flow so it's not doing anything but prevents eslint from thinking that SpecPolicy is unused.\n. The only call site of this function gives a variable of type ReactInstance, so if we follow the type system, this function is always going to return true and the invariant is dead code.\nThe only reason this function exists is that the entire code base is not respecting the type system. So adding a type mixed or any isn't going to make any difference :)\nIf you insist, I can change it to mixed, I don't really mind\n. I'm afraid that doing\njs\nCallbackQueue = PooledClass.addPoolingTo(CallbackQueue);\nis going to confuse flow in the file (I haven't tried).\nIf creating a new variable, I'm not sure how to call it, maybe\njs\nvar PooledCallbackQueue = PooledClass.addPoolingTo(CallbackQueue);\nmodule.exports = PooledCallbackQueue;\nwhich is also inconsistent with the ThingWithSameNameAsFile rule.\nThere's precedent with this in the Relay world where you first declare your React component and then do\njs\nmodule.exports = Relay.createContainer(ReactComponent, { ... graphql query ... });\nPeople are also doing this with Redux\njs\nmodule.exports = connect(...\nI'm happy to change it to something else :)\n. I'm more than happy to change it to something else, I'm just not sure what this something else is.\n. Since topLevelTypes returned the same value as the key, this was a no-op except for the case where the event is not in the list where it would return undefined.\nIt turns out that just above we check if the event is in the mediaEvent list ( https://github.com/facebook/react/blob/6a659606415d4853026df6e6d525274fdc7d35ea/src/renderers/dom/shared/ReactDOMComponent.js#L288 ) which is a subset of topLevelTypes, so this should be safe.\n. ReactTestUtils is doing a for loop on this, hence why we need to keep it as an object and can't just make it just live in the type system:\nhttps://github.com/facebook/react/blob/6a659606415d4853026df6e6d525274fdc7d35ea/src/test/ReactTestUtils.js#L619-L629\n. Expanding the types of ReactElement as I go along. Flow coverage tool in nuclide is super useful to see what flows sees in the code I flowify :)\n. flow is not smart enough to know that this check is flowing through the variable for the next condition\n. I had to change === null to == null in order to check for undefined. I'm not really sure if it's safe to do or not, I'd appreciate a careful review here!\n. I found out about this by going through the internal flow support group. Let me ping Flow people about this\n. There's already a command flow coverage <file> but it just shows the summary which isn't really useful:\n\nWould be awesome if it printed in ascii art what nuclide shows:\n\n. cc @thejameskyle\n. Omg, @andreypopp it works!\n\n. > It would be nice if we could enforce this somehow but I guess making the check more relaxed should not be a big deal.\nFlow is really good at describing what types a value can be and enforcing it. Instead of having everyone aggressively check things even though they couldn't possibly be in that state but it's too hard to figure it out by reading at the code.\n. you should probably remove the return undefined; line below, which is pretty much useless anyway\n. This is a great side effect of adding flow types to the codebase, it surfaces how things are really used :p\n. This blames to https://github.com/facebook/react/commit/999b0f9b3e2d0b1e83c0b6339ed0af876702b2f3\n. cc @spicyj, let me know if you have more context on this/any concern.\n. \ud83d\udc4d \n. I wonder if I can just generate all those at runtime from the event name. I'll try this out\n. See https://github.com/facebook/react/pull/7616\n. > (elem: ?HTMLElement) => void isn't right - you can get a component instance passed in (in the case of refs on composite components).\nGood catch! I need to figure out what the type of a component instance is.\n\nI think we probably want to define this correctly as much as possible and not leave partially correct types on fields (probably fine to leave any on to-be type fields).\n\nAgreed, I want anything to be typed to be fully correct.\n. Great idea, thanks for the suggestion, I'll do that!\n. I thought I ported it back but it slept through the several revisions I've done, oops. Good to know it is no longer needed.\n. Good catch, I can't wait for flow to warn when you're doing checks that do not make sense based on the type you have.\n. Our unit tests do have examples where it can be number and string indeed.\nSo sorry for the churn here, I'm going to try to be more careful next time.\n. Okay, this means that this code is behaving in a weird way. We are doing .ref of a number and string which doesn't make sense but happens to be working.\n. Jest upgrade path was so good. For each option that was deprecated, there was a big blob of text saying why and what was the new one I needed to use.\n\n. Note that js, json and node are the default ones (that are needed to run the tests) and we need in addition coffee and ts for our integration testing with those.\n. Jest now warns when it runs files that do not have any tests. We shouldn't even run this file through jest but because it is in the __tests__ folder and ends with .js, it is automatically being ran.\nAdding .js.setup extension is a quick fix to make it work.\n. Jest changed the way console.log are outputted by adding two spaces before each line\n. Jest now marks test files with no assertions as failing. I also really dislike having dead code in the codebase. If we are going to test proptypes with flow one day, we'll recreate this file.\n. We manually call unmock on a bunch of file even though automocking is off for the repo. There's now a warning in Jest for that :)\n. toMatch used to silently convert the string into a RegExp and no longer does it. Replacing the few call sites we had to match the new behavior. It's IMO a good thing to have to pass a RegExp to toMatch :)\n. We can either\n- move the setupSpecEquivalenceReporter.js file outside of __tests__ folder or\n- hardcode that file name in the package.json config\nI think the current solution is better than those two others. Let me know if you have a better idea\n. I will just remove the ^ character so that it doesn't need to start at EQUIVALENCE\n. Just did npm install --save-dev some-random-module and reprinted it correctly. I had no idea this was a thing, TIL :)\n. This removes the describe block and unindent everything. Sadly github doesn't have support for hiding whitespace-only changes :(\n. All this code path was really weird and not needed anymore. We can just run jest --coverage to do the same thing.\n. @cpojer told me to try and remove those as jest should be more robust. I'll put them back if they cause issues.\n. This fixed a bug with coverage and node 4\n. Jest has this annoying mode where you can either use the default where it runs coverage on all the files that are required by tests (the current mode) or you can manually specify all the files/folders you want to whitelist and blacklist.\nMy thinking was that outside of this thirty party component file, the rest is actually good. When I tried doing it on everything then it reported a bunch of useless stuff.\nBy the way, we don't need all that logic anymore, jest has a setting collectCoverageFrom in package.json that lets us configure it: https://github.com/facebook/jest/blob/master/package.json#L47\nIf you want to go through all the files and make it list only the things we care about, let me know.\n. This is the issue that I raised where flow doesn't have a way to have a variable defined only in __DEV__, the workaround is to always set the type to what's in __DEV__ as you just did.\n. Can you avoid making it a global and instead create a file ReactSyntheticEvent.js (or append Type if it already exists) and whereever you use ReactSyntheticEvent do\njs\nimport type { ReactSyntheticEvent } from 'ReactSyntheticEvent';\n. nit: trailing comma (in all the places)\n. [Discussion] it feels weird that null is before the actual type, I would have written it \njs\nPluginModule | null\nI don't mind it that way but I'd love to know if there's thoughts behind it\n. I like that it is now lowercase :)\n. Can you avoid using Object. I would prefer that you create a type for it and mark it as any at the top of the file rather than having a partially typed variable. The rule of thumb I'm using is that it should either be a precise type or any, this way when you run flow coverage you know if you're 100% good to go or flow doesn't even try.\n. same here, please use any for now if you don't know the exact type\n. @zpao I put back the old coverage paths, should be good to review\n. All the tests are passing but i'd love a second pair of eyes to know if this is safe\n. I rewrote the logic such that empty components are properly handled now.\n. wow, I have no idea that flow supports both bool and boolean\n. Yeah, flow doesn't know that push() isn't messing up with everything. I figured moving it one line after isn't a big deal to make flow happy\n. \n. What's the point of calling it here? Why not just put productionTypeChecker?\n. you can leave the trailing comma :)\n. why use a regex here and not just a string? also if it's a regex you'd probably want to escape the dot\n. why not jest.fn?\n. I've been adding a space between {} but looks like the convention on www is not to (15k vs 500). Good thing you're helping on this effort so that I don't start diverging by mistake :p\n. we're still using var in the React codebase\n. I would put this if inside of the previous one. This way you don't need to make let pluginModule; outside of the block\n. You probably want to extract out this condition outside of the loop. It doesn't make sense to loop on a null value anyway\n. why is this nullable? What's the point of having a dispatch config if there aren't any events that can trigger it?\n. I typed PooledClass so you may be able to use it and it's going to get typed:\nhttps://github.com/facebook/react/blob/a70acb37d9dc392b395bd921d90d5488542c2402/src/shared/utils/PooledClass.js#L105-L111\nhttps://github.com/facebook/react/blob/a70acb37d9dc392b395bd921d90d5488542c2402/src/renderers/shared/utils/CallbackQueue.js#L106\nThe downside of my version is that it ignores the arguments of the constructor.\nOn a tangent, I think we should stop using definitions that are shipped with flow for the internal codebase and duplicate them for now. When they are good enough inside of React then have React ship a react.flow.js file based on our definitions and remove them from flow altogether.\n. we're still using module.exports for non-types in the react codebase fyi.\n. (I just verified and putting the ? before the : makes it not accept null which is what we want)\n. This is so good to have this written in the code!\n. Sounds like a good workaround, thanks for evaluating all the possible solutions :)\n. In a follow up diff would be great to type this as\njs\n'currentPageScrollLeft' | 'currentPageScrollTop'\nalong with adding @flow on ViewportMetrics.js: https://github.com/facebook/react/blob/67f8524e88abbf1ac0fd86d38a0477d11fbc7b3e/src/renderers/dom/client/utils/ViewportMetrics.js\n. Nice! I realized that flow didn't guess the correct type and couldn't think of a way to to make it do so. I didn't think about adding the type in the declaration :)\n. this may help a tiny bit on perf as well :)\n. For this kind of things I really enjoy using flow :)\n. \ud83d\udc4d \n(FYI, I have no idea what this code is doing so I'm really asking questions here, you are probably writing the correct type definition :))\n. https://github.com/facebook/react/blob/a8741963dc661432caa906c295a0477691bad614/src/renderers/shared/stack/event/SyntheticEvent.js#L258-L260\nIf you type SyntheticEvent in this file, and replace the exports to be\njs\nmodule.exports = PooledClass.addPoolingTo(SyntheticEvent, PooledClass.fourArgumentPooler);\nthen it'll automatically get getPooled and release static methods because PooledClass.addPooling has been typed. The only caveat is that I didn't find a way to get the correct type of getPooled arguments which are the constructor arguments (if you find a way that would be awesome).\n. I think that adding @flow to SyntheticEvent would kill two birds in one stone :)\n. Is this the correct type here in render? Should we make this verbose thing a named type on its own as we start to use it in a fair amount of places? If yes, what should we call it?\n. The code is duplicated for those two conditions but they do not end up being computed twice because that's under two different branches\n. https://facebook.github.io/react/docs/glossary.html#react-nodes\nLooks like the docs says that ReactNode cannot be false and can be an array\n. I'm still unsure how to handle things that are not properly typed yet. One one side mixed is good because it gives some kind of safety as flow is going to try and guess what the type is, on the other side, having any is great because it shows up as untyped in the flow coverage tool in Nuclide.\nSo far, I've chosen to leave everything that isn't properly typed as any. This way either something is fully and correctly typed and we can have faith in it, or it's not and shows up as completely untyped.\nPlease let me know what you think about it :)\n. Okay, let's use mixed instead of any then :)\n. This is going to be a --very hot-- function, could you write it in a way that does the minimum amount of possible allocations.\n. The type definition is not correct as it doesn't handle falsy values nor nested arrays :)\n. FYI, the reason we are doing typeof X !== 'undefined' is because if you do X !== undefined and X isn't a global variable, JS is going to throw an exception.\nIn this case, styleObjOrArray is a local variable so it always exists in scope and you can safely do styleObjOrArray !== undefined.\n. We should also allow false as it's nice to be able to do cond && style which will return false when cond is false\n. This is a pretty expensive operation. A faster way is to recursively iterate on the array and update the result variable directly in the outer scope instead of mutating the array in place.\n. I'd love to get feedback from @sebmarkbage on how to integrate with the React reconciliation. This is how we started with React native but now we are first doing a pass to check if something has changed in order to not have to flatten when that's not the case.\n. A way to quickly disable a test.\nThere's also fit which is handy as it tells jest (or jasmine) to only run that specific test, so you don't need to comment out everything else when trying to troubleshot a single one.\n. Looks like it's not documented on the jest page for some reason: http://facebook.github.io/jest/docs/api.html#content\ncc @cpojer \n. @gaearon it.only is already in master and will be available the next time a release get cut: https://github.com/facebook/jest/pull/1632\n. There isn't. In this case, since there's only one Object.assign, could you replace with class ... extends ReactMultiChild which flow should understand\n. This is weird :(\n. Can you put and remove <any>\njs\nimport { ReactElement } from 'ReactElementType';\nWe're trying to use the internal type (and not the one provided by flow) inside of the codebase\n. Please change Object to either any, mixed or the proper type.\nThe problem with using Object is that it makes it look like it is flow typed but in practice flow doesn't know any of its attributes so it cannot verify anything about it.\nWe're trying to either have the correct type or mixed (and if mixed doesn't work then any)\n. @zpao I added the second class usage in the codebase last week, so it's probably consistent so far :p\n. any\n. I wrote it in a way that we can only do one commit on the facts branch per commit on master by being able to pass more arguments. But yeah, I can put this one in the flow matrix and the fiber one in the test matrix.\nI don't think we should add a facts matrix to get all of them batched together.\n. It's really really useful to log all the commands the script is doing in order to troubleshot what's going on, especially since we can't ssh into a travis box and debug.\nDo you think we shouldn't log commands?\n. I added GITHUB_USER as this breaks without and was planning to the defaults here (facts-tracker / this dummy email address). I will make the username be Travis CI and update the other commands use it as well\n. I spent soooo much time trying to get this right. I should have known that you were going to say that and did it way earlier as this is the obvious way to go.\n. I have the habit of exiting with a non-zero values in this kind of tests, but you are right, this time we actually want to exit with 0 :)\n. Copy and paste :p\n. Great suggestion, let me do that. I'll leave the check in just in case someone doesn't remember about it and accidentally leaks the token\n. Omg, thanks! I couldn't figure out what I did wrong. Of course, sending it to the tokenizer of bash like this is going to interpret them as different arguments and be in one line when echo sees it! Good catch!\n. Technically, haste doesn't have the constraint that filename needs to be unique nor that it matches the name that you require. Haste only looks at the @providesModule token in the first comment of the file.\nMost people on fb codebase use the same filename because why invent a new name and it indeeds make it easier to search files by name.\nNow, React in addition to haste has an export step to npm that takes all the files, move them to the root directory and rewrites all the require('Module') to require('./Module') which uses the filename.\nSo in the React codebase, filenames must match the name of the @providesModule. React Native doesn't have the same step so you can name your files whatever you want for example.\nFeel free to leave this comment as is, but I figured I would let you know what is exactly happening :)\n. Looking at the history of the commits, it looks like a bad merge?\n. You may want to explain somewhere why you put parenthesis here. The only reason is to prevent automatic semi-colon insertion in return.\n. I'd love to change the style of those. The red background is very aggressive.\n. People are likely coming to the documentation because they want to write things using React, not because they want to understand how the internals of React are working.\nWhat do you think about making the first few docs page as a progressive disclosure of all the concepts through examples of things you can do with React instead of being three big sections on each concept.\n. nit: \"blorp\"\n. =\"blue\"\n. Yeah, i'm not sure what children has anything to do here :)\nThe two times I ran into are:\n(1) trying to write a \"\njs\n<C prop=\"this is \\\"something\\\"\" />\nis a syntax error as the \\ is not escaping the \"\n(2) trying to use an unicode sequence\njs\n<C prop=\"\\u2192\" />\nwill not display the unicode \u2192, it's just going to display \\u2192. Instead you need to do\njs\n<C prop=\"&#8594;\" />\n// or\n<C prop={\"\\u2192\"} />\n. nit: we use single quote for js strings\n. Fixed by https://github.com/prettier/prettier/pull/853, it'll be in 0.21. You may be interested in the implementation of the string printing.\nhttps://github.com/prettier/prettier/blob/master/src/printer.js#L2836-L2909. This is a leftover from the recast fork. I'll remove the \\n, it doesn't make sense.. That's a good point, I can see how it would be useful! Let me try it out.. https://github.com/prettier/prettier/pull/862. https://github.com/prettier/prettier/pull/860. @jlongster I really like the decision we made to add parenthesis around && even though they are not necessary. People tend to put them anyway.. Btw, the way prettier works is to cram as much as possible within the limit. So it's usually not a good idea to go too far away from 80 columns as the result tend to look crowded.. you may want --trailing-comma=all. --jsx-bracket-same-line (btw, all the options have been added to match the fb styleguide, so you want to put them all :p). fyi, if you have those kind of specially structured data, you can add // @prettier-ignore on the line before and prettier will leave it as is.. This is fixed in master, I'll do a new release tomorrow with those fixes:\nhttps://github.com/prettier/prettier/commit/705ac7d3cf23e8b6f2cd612d5a3cdf2360a5c32c. (And, it does break www). This is not expected that the toEqual argument is split on multiple lines.\nI cannot repro neither on the website nor master: https://prettier.github.io/prettier/#%7B%22content%22%3A%22function%20f()%20%7B%5Cn%20%20function%20f()%20%7B%5Cn%20%20%20%20expect(diff(%5Cn%20%20%20%20%20%20%7Ba%3A%20%5B1%5D%2C%20b%3A%20%5B3%5D%7D%2C%5Cn%20%20%20%20%20%20%7Ba%3A%20%5B2%5D%2C%20b%3A%20%5B4%5D%7D%2C%5Cn%20%20%20%20%20%20%7Ba%3A%20%7Bdiff%3A%20diffA%7D%2C%20b%3A%20%7Bdiff%3A%20diffB%7D%7D%2C%5Cn%20%20%20%20)).toEqual(%7Ba%3A%20%5B2%5D%7D)%3B%5Cn%20%20%7D%5Cn%7D%5Cn%22%2C%22options%22%3A%7B%22printWidth%22%3A80%2C%22tabWidth%22%3A2%2C%22singleQuote%22%3Atrue%2C%22trailingComma%22%3A%22all%22%2C%22bracketSpacing%22%3Atrue%2C%22jsxBracketSameLine%22%3Atrue%2C%22parser%22%3A%22babylon%22%2C%22doc%22%3Afalse%7D%7D. This is correctly putting the argument of toEqual in a single line.. This is expected that diff( goes to its own line.. The pattern I've been using at fb is:\njs\nif (thisCondition &&\n    thatCondition &&\n    anotherCondition) {\n  const x = 5;\n}. Oh, I think I know what happened. You started with 120 columns which formatted it as\njs\nexpect(diff(...)).toEqual({\n  a: [2],\n});\nand we have a rule that says if an object was expanded, we keep it expanded, so when you moved it back to 80 columns, the diff got expanded and this one stayed expanded as well.\nThat rule is not ideal but this is the best trade-off we could find as there are valid reasons why objects could be inlined or expanded depending on the context.. I fixed this yesterday. I'll do a release this morning with the fix. Sorry about this!\nIt's going to look like this:\njs\n  manageChildren: jest.fn(function manageChildren(\n    parentTag,\n    moveFromIndices = [],\n    moveToIndices = [],\n    addChildReactTags = [],\n    addAtIndices = [],\n    removeAtIndices = []\n  ) {\n    autoCreateRoot(parentTag);. https://github.com/prettier/prettier/releases/tag/1.2.0. js\nString(markup). ",
    "petehunt": "@jordow I have a mixin that does this for IG that I want to get into react_contrib.\nThis is probably a good idea for us to do, however if we use React.autoBind() on the function passed to setInterval() it'll suppress the errors when the component unmounts. I'm pretty sure that killing the setInterval() is better though.\nI'm inclined to take this (once rebased) if everyone's OK with it.\n. @jeffreylin can you take this one for CDN stuff?\n. Yep this is definitely better. This was a hackathon project and still shows in some places :P\n. BTW, I am super stoked to get rid of all the keyUp's in the examples! You rock, thanks for finding high-leverage fixes.\n. Ah there's a bug in the tutorial; can you add a \"return false\" to handleSubmit and document that as well? Thanks.\n. needs rebase\n. Overall I like this very much :)\n. yolo\n. I aggro-committed a few minor edits https://github.com/facebook/react/commit/fad7d58fc9ef8da03acc6f4d1a11a2844f4cd2ce\n. A simple test case here would be great too, since it's unlikely this will have many callsites in prod code for a while it may break and go unnoticed without one.\n. \u221a react has no idea though\n. Nice catch @benjamn !\nLooks like it may not matter much like you said: ge() which is battle-tested from FB uses array indices so I'm going to merge.\n. Should we include my Quora post about Angular vs React?\n. if @yungsters is good, I'm good.\n. Do you think jshint would be receptive to a syntax transform patch?\n. @benjamn and I came up with a game plan on IRC; we'll be opening more specific actionable issues moving forward.\n. test plan: bump to absurd version number with engineStrict: true, it fails, change version to what it is in the diff, it worked.\n. @kirbysayshi You should just be able to do <div data-custom-uri={this.props.uri} /> and it'll work. data- attributes are special cased.\n. I think that the value of copying and pasting HTML and having a (mostly) working component is huge. So +1 to class :)\n. :) also see ReactStateSetters (another internal thing we should probably expose).\n. Yes, I've wanted this for resize as well. We talked once about adding maybe a onWindowResize event that fires on every component, but how would it bubble?\n. You can try npm install jsxc and using the jsxc command instead. Let me know if that works.\n. Sorry, does npm install -g jsxc work?\n. @zpao does this actually browserify it? I thought it would just build it to build/modules?\n. @jordwalke I am pretty sure we have done all we can here -- at least I think we've tracked down every callsite where PooledClass would have helped us. I updated our recast transforms to log every syntax construct that would cause an obvious allocation and couldn't find anything. I was thinking maybe there was an array slice or a bind() in there, but @spicyj's experiment shows that this is not the case.\n. CLA is processed, thanks!\n. should we throw ReactStateSetters on there?\n. AnalyticsEventPlugin ?\n. What happens if you change step 2 to a span instead of a div? It works, right?\n. If anyone wants to look into this, the bug is probably here https://github.com/facebook/react/blob/master/src/core/ReactNativeComponent.js#L280\n. @spicyj it looks like you're emptying content and then may put new innerhtml or text into it. This would be 2 dom mutations. Possible to make it one?\n. FB layers has so many internal deps that we don't even use them at IG. Instead I suggest we open source the react layers stuff plus the light IG shim. You don't get the nice behaviors but the value for the community lies mostly in the architecture IMO.\n@yungsters if we redid layers today would we do it any differently (ie I think we could do it with composition)? This could be a nice greenfield opportunity. \n. @yungsters yeah Layer is awesome -- what I'm wondering is why we use a mixin rather than composition to hook it up to React.\n. Yeah\n. That makes sense, but the return value for renderLayers() is a little confusing (I've never used multiple layers in a component before), and it's not clear at first glance that it follows React's normal data flow.\n. So I think that if we had frags I wouldn't mind putting the  components in the render() method. While it would be kind of weird that it is not anchored to the DOM, if we had frags we would have precedent for components that don't render to anything in that place in the DOM and it would just be 1 paradigm to learn.\n. To be clear we do use ReactLayer and ReactLayeredComponentMixin at IG, just not any of the FB layer behaviors or Layer impl itself (yet), but they are API compatible for FB layers and behaviors by design. I am in favor of bringing all that to open-source, just want to make sure that we think about making any API cleanup before doing it.\n. I think that it may be helpful to link to the Dom differences page from jsx gotchas, no?\n. I'd like to add that I used to have the same concern as you, however if the props themselves constituted the \"identity\" of a component then we'd always throw a component away whenever data changes. Not only is this slow, it also will destroy e.g. form inputs / selection position.\nIn many cases reading from this.props in getInitialState() is an antipattern. If you're computing a value from this.props in getInitialState() when this.props changes the state value will be out of date. Additionally this means that the state you're storing on this.state is not actually the minimal representation of the component's state.\nInstead you should try to avoid reading from this.props in getInitialState() and instead compute the value inside of render() based on this.props and this.state. That will usually do what you want.\nIn your particular use case notice that the minimal set of state needed is selected in MessageList. Your Content component should instead take a callback that \"asks\" the MessageList to change its selected state. Does that make sense?\n@chenglou is going to document this.\n. One other thing: you can override the identity by setting a \"key\" prop on the component. \n. If you just tweak a style attribute, we'll only mutate the style attribute. We use keys and component class as a heuristic to indicate that we want to blow away a whole subtree and replace it with innerHTML which is faster than dirty checking the rendered markup and doing many individual DOM mutations. This heuristic is actually quite effective in our experience.\n@vjeux is working on a blog post about this.\nTelling a component to change is indeed not great practice, especially with refs. However, in React data only flows down the tree automatically. In order to flow data back up, you pass a callback to inform the top of the tree that there was a data change (we now have some sugar called ReactLink to make this a bit more streamlined). The reason that we do this explicitly is because data fundamentally flows one way in von neumann machines and if you don't make the data flow explicit we've found it becomes very hard to maintain.\n. It was off by a few -- I think he had a mixed file. \"Save with unix line endings\" fixed it.\n. ping\n. Thanks!\n. @andreypopp is right, this is just extra GC, not a memory leak.\nIf you do the split/map/filter/map ahead of time (once) it'll save a bunch of allocations. Also adding a key prop will probably speed up the transition a bit as well: http://jsfiddle.net/X5Bnb/\n. Looks good. I know I'm somewhat backpedaling on this but maybe after the fruit machine thing you can mention we've been in production since 2011 :)\n. @zpao are you cool with this? I had to hack around it here: https://github.com/petehunt/react-touch/blob/gh-pages/src/thirdparty/TapEventPlugin.js\n. Hey there, sorry for the long reply time on this.\nI'm thinking about that callback parameter since maybe we use componentDidEnter() and componentWillLeave() to actually implement the animations themselves rather than rely on ReactTransitionGroup to do it. Since animations take time we'll need a callback to inform the TransitionGroup when the animation is completed (specifically for leave animations so the TransitionGroup knows when to remove the DOM nodes).\nDoes this make sense?\n. This feature is now in ReactTransitionGroup as part of the rewrite. Thanks for the API @pgherveou !\n. OK, I'm going to work on getting this in this week.\n. Sadly this is going to have a conflict at the next sync. I think the best thing to do is to wait for @zpao to do it and rebase on top (I'm not sure what will happen if I fix the conflict internally and merge here... will probably \"just work\" but I'm not 100% sure how that works)\n. I'll be merging this this week! Sorry for the delay!\n. Yes this is great. Did you sign the cla? Let me know and I'll merge!\n. +1 let's just kill it if it's not in use\n. suggested muffinizing in https://github.com/ForbesLindesay/umd/issues/10\n. Will make these changes, but aren't package.json and React.js automatically updated to the latest version?\n. build is green now. i thought tests were broken in master, looks like i was wrong!\n. +1 for the flag. It's useful but hard to make the argument that JSX is \"just function calls\" if we add all that.\n. I think this should get high priority since it'll let us expose ReactTestUtils publicly so we can write a doc on testing.\n. OK, I just realized that these are already being delivered as part of the react npm package -- going to send a simple PR soon.\n. welp, the API i'm implementing had them in their docs -- oh well.\n. Can you sign our CLA and comment here so we can merge this? Thanks! http://developers.facebook.com/opensource/cla\n. Regarding vendor prefixing: we talked about doing vendor prefixing in React a while ago but decided it was a lot of bytes and complexity for little payout.\n. this lgtm, pulling it in\n. @fingermark Now that we're going to add an immutable deep-update addon, I'm starting to think that this could be a useful addition if we can get it right.\nI think we can do what @syranide suggested if we provide a helper for Google Closure Compiler.\nWhat do you think of: this.linkState(keyPath({a: {b: {c: true}}}))?\n. Yes, keyPath({a: {b: {c: true}}}) would be the equivalent of today's [keyOf({a: null}),keyOf({b: null}),keyOf({c: null})] which is what you need to do if you want to minify correctly. This would turn into ['a', 'b', 'c'] so the final invocation would be this.linkState(['a', 'b', 'c'])\n. Ideally ReactLink + update() (the immutable setter that IG uses and we're open-sourcing as an addon) could be combined to build Om/Cortex-style cursors, which could then be used to implement LinkedState\n. I am just wondering if people will WTF over that object literal syntax, since most people don't care about closure compat. I would personally prefer it. I think this kind of API would fly more in npm than as an official addon.\n. Also -- I could land react-raf-batching in addons so people will know it's there (@sebmarkbage will probably like this). Is this something people are interested in?\n. injectEventPluginsByName() should be pretty safe, no?\n. I wonder if we should add PureMixin too? Anything else?\n. I think we should expose mapChildren() more obviously and document it\n. @yungsters how do you feel about this?\n. pulling in, seems good to me but I am not the event/browser expert\n. I think this is outside the scope of React core. When we have a community components page we would be down to officially \"bless\" a router to reduce analysis paralysis, but I don't think it should live in the core.\nI would also be open to a React official blog post that describes how to build an app from the ground up with a router.\n. Why can't it be a React component with the route as a prop?\n. Why can't it be a React component with the route as a prop?\n. i tested it and it printed json to stdout. and running regular grunt still works\n. Got benchmarks? :)\n. seems legit\n. pulling in\n. Thanks for fixing this. We definitely needed it. Everything else looks great!\n. note: tests don't pass and haven't tested the full browser gamut yet, but pretty sure this is gonna be good\n. Imagine FB timeline was a big React component and we navigated from one user to another user without using a key attribute. Then we would run into this on the first update. After the first update the cache is warm and everything is fast, but that initial cold cache behavior can be really slow with a large number of elements.\n. we'll go with @spicyj\n. I'm 99% sure that this is OK since there isn't that much work done in this frame.\n. +1\n. kk, pulling this in\n. @ehd @zpao @sebmarkbage what if we added a DEV and browser-only global always? We could mangle it so it's unlikely to conflict with another variable in the global scope. We could also use this to detect multiple versions of React running on the same page...\n. I wonder if some people don't want their stuff inspectable in prod.\n. it's in\n. @bobeagan can you sign the CLA at https://developers.facebook.com/opensource/cla? Then we can merge.\n. @bripkens if you want to make the API synchronous that would be awesome!\n. I have an add-on coming to help with this. Stay tuned!\n. Nice\n. @zpao\n. this was accepted internally and will merge soon\n. While this is true it sucks for people who want to do full-page server rendering. I think if we claim to support full-page server rendering we should at least support doctype.\n. They are not called on the initial render of the transition group, only when they are added to an already mounted transition group\n. ...which should probably be documented\n. @zpao takes this one, but I do think that name is better.\n. Empty?\nSent from my iPhone\n. @zpao takes this one, not me.\n. pulling in\n. this got killed before but I think we need to revisited invariants in general, so pulling this in.\n. pulling in\n. pulling in\n. Anytime you call anything in render() that uses these you may break server rendering or make some interactions behave strangely. This is a bug we had at Instagram -- you should not read from the rng or clock in a reactive system since your code may be rerun at any time.\n. We want as many things to be warnings as possible so we can compile them out in prod\n. componentWillEnter() is only called when items are added to an existing TransitionGroup (see http://facebook.github.io/react/docs/animation.html#componentwillentercallback).\nI think you can accomplish what you want with componentDidMount(). If you have any ideas for documenting this in a better way, runtime warnings, new features or if this doesn't fit your use case, please reopen. Thanks!\n. Hell yes!\n. Looks good, can you sign our CLA at https://developers.facebook.com/opensource/cla and comment here when you're done? Then I can merge.\n. Oops! Thanks for this :) Have you signed our CLA? https://developers.facebook.com/opensource/cla\nOnce that's done comment here and I can merge it in.\n. Oh man, I am going to start using this!\n. Think so... figuring it out now :)\n. @SanderSpies you're exactly who I had in mind for this! :)\n. You guys sure about this? If we don't include this we're basically committing to re-explaining this over and over again.\n. any reason for not using <pre>?\n. React's lifecycle will guarantee that componentWillMount() is called before componentWillUnmount(), so you don't need to do this check :D See http://facebook.github.io/react/docs/advanced-components.html\n. You've been reading Twitter too much :P\n. That'll work too!\nIf you're interested in micro-optimization, I think that in v8 adding intervalID here will be slightly faster, as adding a new key to an object will result in a new hidden class being created (see https://developers.google.com/v8/design)\nBut at the end of the day, I highly doubt you'll see an impact from that in this application. \n. They're in the tutorial for automated source extraction\n. Nice work jumping into the React event subsystem.\nWe'd still like to support IE8 if possible. Fortunately, our synthetic event system means that we can use keyUp and click to simulate onInput in older browsers such that it works as expected.\nHowever, since users won't expect onInput to work in IE8 anyway, I wonder if it's worth building this into the event plugin.\n@jordow -- what do you think? Should we simulate onInput using keyUp and click in some event plugin? I think I'm in favor of it.\n. Might be a bit clearer what's going on if these were constants\n. nit: most of the places in the codebase we use multiple var statements\n. setTimeout() can be quite slow, if we want to do it this way we should check for requestAnimationFrame() and postMessage() and do it with those instead (as a requestAnimationFrame() abstraction, perhaps).\n. I don't think there's a precedent for this yet. Hmm.\n. Isn't this dangerous though? What if on key down you replace a node but it ends up having the same id? Then the event will go to the wrong node. \n. close this?\n. Yeah, if we want this to be at all performant we should pull in your setImmediate() polyfill from IG. I wonder if we can make it smaller due to our use of es5-shim (like by removing some of the fallback cases).\n. :+1: will update\n. I like it, but I wish we could condense that down to a single bullet since this isn't our main point. Feel free to send a PR.\n. See the next line\n. whoa, sweet\n. React->Reactive\n. Remove parentheses\n. and determine -> to determine\n. I liked the old one better, since it gives context as to why we were first\n. I liked the old one better\n. use onsubmit\n. Please use ExecutionEnvironment.canUseDOM such that this module could be required and not fatal if there is no document symbol in scope. I'm not sure if it'll get required in practice or not, but a good idea nonetheless.\n. Is this going to screw up scroll/cursor position within the textarea?\n. What if we put these in ReactCompositeComponent._performComponentUpdate() instead? That way we won't have to copy-paste it everywhere, and it'll be closer to where the batching logic will eventually live.\n. !this.props.dangerouslySetInnerHTML is better I think, since people often misread == to be ===.\n. !this.props.children\n. props.content ? \n. Eventually we should s/monkeypatched/injected/g in the comments in this file to be More Professional, but doesn't have to block this diff \n. Can you add an explicit invariant for > 1 children with a specific message? And write a quick expect(...).toThrow() test?\n. \u221a\n. I really don't like double equals in JS just because it is pretty confusing (see my review bug above :P)\nWhat if we did: typeof this.props.dangerouslySetInnerHTML === 'undefined' ? jsperf clocked this as faster than == null, anyway (http://jsperf.com/undefined-checks, though this is so insignificant it doesn't matter at all :P)\n. Alright, that's fine then.\n. Greig\n. This seems out of place to me, since they aren't TodoMVC. We could put these under a separate heading, or not include them at all.\n. We should throw this in a separate module that is webworker-safe and supports a better RAF polyfill (@benjamn has a good one)\n. without transforming it\n. This appears unused\n. Seems to be like we can just use a for loop to iterate over this and we'll get the behavior we want, right?\nIn addition to being less code, it saves us some array allocations which will save memory/gc.\n. Just splitting it out into a separate module is fine for now. Him or I can drop his polyfill in there later.\n. I wonder if doing this._pendingUpdateCallbacks.length = 0; is better here.\nPros: if we get lots of updates we save array allocs\nCons: if we get lots of components with single updates we hold on to empty array refs\nMy intuition is that throughout the lifetime of a component this will be worth it, on average. @jordwalke @yungsters ?\n. Performance nazi time:\nhttp://jsperf.com/array-init-vs-init-push\nCan you init with [callback] if null, else push?\n. @jordwalke knows the core better than I, but your approach here in general seems pretty solid (and he's on vacation!). I'm pretty sure leaving this as is and making a note to ask @jordwalke when he gets back if we should refactor is the right thing to do.\n. This is a great point. Let's make this function injectable. That way we can use multiple strategies:\n1. Run synchronously\n2. Batch into rAF\n3. Change our events system to call ReactComponent.performPendingUpdates() at the end of each event loop, and queue if in an event handling path, otherwise run synchronously.\nBut we don't need to provide all of those right now. In fact, simply starting with \"run synchronously\" by default may be the easiest course of action for now and we can pick the strategy in a follow up PR\n. Right, but if you rewrite your for loop to be:\nfor (var i = 0; i < componentsWithPendingUpdates.length; i++) {\nwon't that continue to loop until it's exhausted? Then we just truncate the array at the end.\n. I believe we should try/finally this, right?\n. this looks unused\n. Mocking ReactDefaultInjection will break React, since it configures a bunch of things.\n. It is not mocked automatically. Everything in React is exempted by default. If ReactDefaultInjection were mocked React would not know anything about the browser, since it's where we inject the events system, DOM properties and tags.\n. Can you camelCase this? We try to stick to the WebIDL version of these names. Also, I believe you need MUST_USE_ATTRIBUTE here (at least based on my tests in Chrome)\n. I am 99% sure this is fine but it's possible that our open-source packager doesn't understand else if (__DEV__). It should since I believe it is just a nested if statement and esprima will find it, but please verify that the release build does not contain this callsite.\n. What's this doing here? Do we need it? It's not really written to our conventions (specifically relative paths, requiring at the end of a file etc)\n. Why don't we instead do this in the cleanup function of a Transaction? Right now it looks like this is unnecessary unless there is some sort of exception. \n. The comment for this method is no longer correct, can you fix it?\n. This adds an extra regex eval in a hot code path. I wonder if that's a real perf issue and if memoization would help.\n. This is the only callsite; can we get rid of the boolean arg?\n. \"If your components don't use global variables\" seems out of place; you could probably get rid of it.\n. Typo: \"implementaiton\"\n. Maybe move this function to its own module and require() it from ReactMount and here?\n. This is already defined in the codebase. Maybe create a DOMNodeTypes module and put that constant in there?\n. That's probably a good idea. @benjamn ?\n. Great feedback. I like what you wrote but I think we need to make it smaller (1 sentence) or it'll be too much text.\n\nReact implements one-way reactive data flow which reduces boilerplate and is easier to reason about than alternatives.\n. > It can also render on the server using Node.js.\n\n?\n. Can we just call it React and not React.js? I know we're inconsistent but React is the correct name (and .js harkens back to the pre-module days...yuck).\n. Yep, that's one great way to do it. But let's think of how we'd do it with only React.\nFirst, let's add the additional requirement that the initial page load needs to show the products (i.e. no extra AJAX call on first load). This makes the example more complex / educational.\nThe new minimal set of state now includes the current set of products (currentProducts), since this could change over time.\nFor the initial load we want to initialize currentProducts to the JSON that the server sent down with the page. So we change the products prop to be called initialProducts and copy it into state in getInitialState() (i.e. return {currentProducts: this.props.initialProducts})\nThen we can use React's lifecycle hooks (somewhat outside the scope of this post) to start a setInterval() that polls the server. When the server comes back with new data, just do this.setState({currentProducts: responseFromServer}).\nMake sense? Great feedback, thanks.\n. You're asking that because you're concerned about performance, right?\nThe thing that makes React really cool is that you only add optimization hints rather than refactor your code to optimize perf. So for your example: what's the most logical way to write your app if you didn't care about perf? It would be to still setState() on the entire list, right?\nIf it becomes slow, you can override shouldComponentUpdate() on your list item to get your perf where you want it to be. This should be a whole separate blog post though :)\n. No, these comments are super helpful. Maybe we should work some of what you said.\n. This page could be filled out by giving a little backstory about why this build exists (officially supported add-on libraries with important functionality that should really live in npm, but we aren't there yet with a common packaging format).\n. React codebase convention is to have a single var statement for each declaration.\n. break after equals\n. use keyOf()\n. \"change tracking or dirty checking the model\" doesn't have the same ring to it :)\n. Really struggling with this. tbh, I liked the old one better but it was really aggressive. Any ideas?\n. I'm trying to say that when you use two way data binding it becomes very difficult to reason about correctness or performance issues\n. I'm trying to draw a distinction between techniques like Angular's transclusion which requires massging your data into and out of the DOM to use composition and react-style composition.\n. nit: i'd just put the var here (I think it's more consistent with our coding conventions)\n. You can just do child.componentDidEnter(). Methods are bound to the component automatically for you -- the only reason we do it above is to attach the key argument.\n. These will be auto-bound. Don't worry about binding here.\n. Oh you're right, this may happen before autobinding. Sorry!\n. can you do:\n``` javascript\nif (typeof event.which !== 'undefined') {\n  return event.which;\n} else if (typeof event.charCode !== 'undefined') {\n  return event.charCode;\n}\nreturn event.keyCode;\n``\n. how about nulls or empty arrays? may be cool to get the keySet and checkObject.keys(keySet).length === 0. key prop\n. We could probably put these hooks inside oftransition()(which would make it easy to add that callback argument)\n. When I run this in our test runner it has some extra whitespace. Can youtrim()it?\n.this._pendingProps` should never be undefined. If it is we screwed up and created a new hidden class\n. If we took document as a param (rather than relying on the global) we could use this from node with jsdom\n. no time, @subtleGradient said he would fix it later\n. Change this to \"See the [onScrollDoesn't work in IE8] GitHub issue for more information\" and we can merge!\n. \"some APIs have changed since then\" ? Then we can merge!\n. \"when using react naively it is 67% faster, but when combining it with angular's transclusion it is 450% slower\"\n. tbody fool\n. also this can be done with (prefixed?) CSS\n. The way you treat index here rubs me the wrong way... if you do it this way I believe you're baking additional assumptions about the caller of this function (that it's called on two components in the same position). While that was true before it seems like a bit of a weird assumption to bake in, no?.\nCan you change getComponentKey() to look at _mountIndex or does that break stuff?\n. Ideally the code that serializes and deserializes keys to the data-reactid attribute should live in one module. I think we can cut down on the size of these in the future so it'd be nice to have that in mind as we change this code.\n. Can you add:\nThis tells JSX to process the file for React. If you don't include the pragma your source will remain untouched, so it's safe to run the JSX transformer on all JS files in your codebase if you want to.\n. console.error() ?\n. why not just use uglifyify?\n. can you use ReactChildren.map() here?\n. Can you use ExecutionEnvironment.canUseDOM?\n. It looks like if you use both checkedLink and valueLink you're gonna have a bad time. Can we invariant() that if a checkedLink is present you cannot provide a valueLink?\nAlso, does this mean that onChange() is ambiguous? What's changing, checked or value?\n. This is getting passed null on some internal flows (when looking at window). Can you guard for it? if (id && ..)?\n. add a unit test for extra win!\n. would be nice to not have to copy/paste this...can you move it to a module that makes sense (or its own)?\n. Please make a function for invariant(false, 'This message'); and put the literal string as the second argument. That way it won't add useless bytes to the build.\n. I think that this is buggy. IDs won't work here. I'll need to come up with something that follows the owner hierarchy.\n. That's a great idea\n. I am cool with this\n. this fails our internal typechecker. making it lowercase makes it succeed. can you make this change?\n. this is terrible. can someone please help me explain it better?\n. when @zpao syncs it will be more clear. Basically the CSSTransitionGroup wraps every child in a component CSSTransitionChild that provides the transition lifecycle hooks. It passes that child whether enter or leave transitions are enabled. If those props change while animating it won't receive those changes since the child is no longer in props.children\n. should we rename this to withBatchedUpdates()?\n. sometimes it sorts by inclusiveTime, not exclusiveTime\n. I would prefer if we had a general function somewhere that does this conversion that is used in both render() and renderComponent()\n. I know you are just following what's already here, but I think we should consolidate these constants\n. I believe this will break closure compiler minification. I think this would be a good idea if we could detect if it is not a valid JS identifier (ie. contains -) and use this only for invalid identifiers\n. Hmm, maybe we can show this off by adding localStorage integration?\n. Let's land it and get improvements in later. My bad.\nSent from my iPhone\nOn Mar 14, 2014, at 11:46 PM, \"Bill Fisher\" notifications@github.com<mailto:notifications@github.com> wrote:\nIn examples/todomvc-flux/js/stores/TodoStore.js:\n\n\n* TodoStore\n/\n  +\n  +var AppDispatcher = require('../dispatcher/AppDispatcher');\n  +var EventEmitter = require('events').EventEmitter;\n  +var merge = require('react/lib/merge');\n  +\n  +var _todos = {};\n  +var _areAllComplete = false;\n  +\n  +/*\n* Create a TODO item.\n* @param  {string} text The content of the TODO\n*/\n  +function create(text) {\n// Hand waving here -- not showing how this interacts with XHR or persistent\n\n\nI can add simple localStorage for sure, but that only tells a fraction of the tale. How far down that road do you want to go? Optimistic rendering? Error states? I left all this out to keep it simple, but yes I can certainly add some code to maintain localStorage data.\n\u2014\nReply to this email directly or view it on GitHubhttps://urldefense.proofpoint.com/v1/url?u=https://github.com/facebook/react/pull/1258/files%23r10633780&k=ZVNjlDMF0FElm4dQtryO4A%3D%3D%0A&r=qYx6qLphxKhA5vHBqr9vuw%3D%3D%0A&m=BRHagu3bvL4bbWUINRG8GNDXQ3hgM%2B73yLAPYAwsfCw%3D%0A&s=a776804ecdefb82bc87a4f6246b37501ce5f45d7530f31f2858b0ce5dcf13e4e.\n. can you a-z this while you're here? got messed up in a codemod.\n. backtick quotes around the method names?\n. backtick quotes around these methods too?\n. backticks on updateText\n. I think people will have questions about stores depending on other stores.\n. maybe realign this downward line?\n. just sanity check: console.error() is available everywhere console is available, right?\n. I think this should be in an \"advanced API\" section. Most people won't use this and will be confused.\n. This is by far and away the most useful part of the profiler. We should highlight this.\n. I think we should write a brief profiling tutorial or case study.\nThe reason for this is that this profiler is very bad at capturing absolute numbers especially since it only runs in dev. Instead, the profiler is designed to make it stupid simple to find the relatively expensive parts of your app and tell you exactly how to fix it.\n. Sounds good, but let's rewrite this introduction then:\n``\nReact is usually quite fast out of the box. However, in situations where you need to squeeze every ounce of performance out of your app, React provides a [shouldComponentUpdate()`](http://facebook.github.io/react/docs/component-specs.html#updating-shouldcomponentupdate) hook where you can add optimization hints to React's diff algorithm.\nIn addition to giving you an overview of your app's overall performance, ReactPerf is a profiling tool that tells you exactly where you need to put these hooks.\n```\n. It's less RFC and more old. I can add those flags.\n. You need to provide usage yourself. It does describe all of the options. I wanted to put some common use cases in here to make the tool more usable.\n. ",
    "zpao": "I changed this to only rewrite the file on version bumps in de2832c0c0ec1b54f06334ae25a0bf8fc947dc9e, so I'm going to call it good enough and close this out.\n. Thanks Martin! I'll take a look at this soon, we've just been following up with some other issues today. Not forgotten though :)\n. This might be OK to do short term, but we should do our best to get JSX to a point where we can ask to add JSX to the language choices.\n. These look good to me - I think this better conveys the idea that modifying this.state isn't great. Effectively they're the same since we call setState anyway.\nIt looks like @petehunt actually modified these examples since you pulled, so it's probably worth rebasing to make sure you're working from the latest copy\n. @rnd174 I haven't done that but I think that's the sort of question you should ask in the mailing list or on stack overflow, it's not really appropriate for github (and especially on a totally unrelated pull request).\n. Going to use #417 instead.\n. Did this upstream instead (more comprehensive linter): 315645804133e190e23be954787f5d64144d33d5\n. Manually merged: 523bde4dc5e07801ee6104050509456635993e11\n. without looking at anything but the screenshot, I feel strongly that \"pitfalls\" should not be the 2nd thing in our reference material\n. @spicyj is totally right. I was hoping to have 0.4 out before anybody hit this issue but since we're still working on 0.4, I'll put out 0.3.3 on Monday. Sorry @remixz!\n. 0.3.3 came out a while ago and we're up at 0.4.2 now. Let me know if you still have any issues!\n. There's no way for me to request changes (I miss phabricator)... We should only do this for the minified build, but it's happening for all of them.\n. I think this got fixed by 100af48f53e292898562f76e0edc9fc7ce50b04e, but haven't confirmed\n. And confirmed that it's working in master.\n. Good catch!\n. Commited as cb01363260b6e43981c286cac9818a13dc1e6a91 (not worth the branching history)\n. Seems like the right thing to do! :+1:\n. Well, we need to consider if we want JSX to be general purpose. As we talk about pulling it into it's own project we need to think about how it'll get used. If we want to keep with this idea that it's generic and you can plug in any \"namespace\", then we need to keep that working. Right now the transform takes @jsx Namespace and uses that to turn <div> into Namespace.div. But then we also have to make sure we support other transforms (e.g. React's displayName) that will be tool specific. Also, if I plug in a pure wrapper that does document.createElement, then I don't want to support custom components.\nIf we didn't have the concern of supporting other targets, then I would just say we'll transform anything that's type=\"text/jsx\" and *.jsx on the command line (or *.react.js).\nFor the in-browser transform, we talked about doing something like <script src=\"file.js\" type=\"text/jsx\" data-jsx-namespace=\"React.DOM\"></script>. Still doesn't quite solve the multiple transform possibilities without a map from namespace to transforms (React.DOM would use react and reactDisplayName).\nFor bin/jsx we could start accepting a list of transforms? If we assume JSX is a separate package, it ships the jsx executable. Then React would depend on JSX. React could ship the set of transforms it needs and maybe create a customized reactjsx executable that is basically just an alias to jsx --transform react --transform reactDisplayName $1 or whatever.\n. Any more concerns about this? I'm guessing this is still an issue, though I'm not sure how often people are hitting it.\nI think another option would be to simply restrict you to a single setState call at certain points in the lifecycle. We'd count in __DEV__, have invariants as needed, and then reset at the right times. Does that make sense?\n. Looks good! Update the date & check it in!\n. @mathieumg Can you sign the CLA (https://developers.facebook.com/opensource/cla), and then we'll get this in!\n. Awesome, thanks! That first change isn't actually important but doesn't hurt and keeps things consistent so :thumbsup: \n. @sverrejoh As somebody who works on React, I'm saying that merely exposing this function doesn't add the tags to the JSX list. So if you want to be able to run jsx on your code and have new tags be converted to React.DOM.newtag then we need to do more.\nReact: https://github.com/facebook/react/blob/master/src/core/ReactDOM.js\nJSX: https://github.com/facebook/react/blob/master/vendor/fbtransform/transforms/xjs.js\n. :boom: 63b58cf6b593a8442477721a0c9645b6440c75b3\n. 894bb03b230336490d20e38cf1f44e9d4d4b78cc\n. I don't think we're going to do this.\n. Based on our lack of movement on this and some of the discussion in the associated PR, I'm going to wontfix this. If it comes up again though I'm open for discussing further.\n. We have many issues about this now, with some of our latest thoughts here: https://groups.google.com/forum/?fromgroups#!topic/reactjs/xovHWHGHPCA\nWhatever we get to, we won't have multiple ways of doing something...\n. We have a fix for &nbsp; coming soon! (cc @jeffmo)\n. It's been a while since we changed these docs. If these issues are still relevant, can you update with details and I'll reopen.\n. :thumbsup:\n@benjamn Are you game to remove those config files?\n. Thanks Hugo! Can you sign the CLA (https://developers.facebook.com/opensource/cla) and then we can get this merged in.\n. No worries. Thanks a lot!\n. \nSharing my favorite macro (surewhynot) since we don't have phabricator\n. @phleet Nice catch! Can you sign the CLA (https://developers.facebook.com/opensource/cla) and then I can merge this in!\n. Awesome. Thanks a lot!\n. Writing docs the hour before a launch on very little sleep never works quite right... Thanks!\n. Squashed & pushed 64d72f8c4b1054c97393124d85681f0e168064fa\n. May have jumped the gun on this... trying to get a reduced test case that fails (so far I can only make passing test cases).\n. Ok, this isn't related to batching at all. It's actually the age-old objects are passed byref problem.\nIn the case we were hitting, we have an object storing data coming from the server. Sometimes the server will say \"update the number we have stored for this object\", so we set object.test++, then re-render with object as a prop.\nHere's a test case demonstrating the problem:\n```\n  it('should pass shouldUpdate the correct values', function() {\n    var _propsWereDifferent = [];\n    var count = 0;\nvar data = { test: 1 };\n\nvar Component = React.createClass({\n  shouldComponentUpdate: function(nextProps, nextState) {\n    _propsWereDifferent[count++] =\n      nextProps.data.test !== this.props.data.test;\n  },\n  render: function() {\n    return <div/>;\n  }\n});\n\nvar instance = <Component data={data} />;\n\nReactTestUtils.renderIntoDocument(instance);\ndata.test++;\ninstance.setProps({ data: data });\ninstance.setProps({ data: data });\ndata.test++;\ninstance.setProps({ data: data });\n\nexpect(_propsWereDifferent.length).toBe(3); // pass\nexpect(_propsWereDifferent[0]).toBe(true); // pass\nexpect(_propsWereDifferent[1]).toBe(false); // fail\nexpect(_propsWereDifferent[2]).toBe(true); // fail\n\n});\n```\nThe best way to work around this is probably to pull as much off of data and set each property as props on your component instead.\n. FWIW, this isn't a bug in React - this is something to be aware of in all JS. JSX makes this a little less obvious.\n. Thanks!\n. Nice! We'll definitely take this. I'm on my phone and can't check right now, but if you haven't already, can you sign the CLA (https://developers.facebook.com/opensource/cla)?\nAlso, I'm excited to see somebody working on (what I would call react-rails)! I started to after initial launch but got sidetracked. I actually set up  http://rubygems.org/gems/react-source to get started on this (following the same pattern as coffeescript and ember I think - having 2 distinct gems). I got hung up on the non-node thing too but never figured out the best way. We're going to have slight discrepancies between bin/jsx and this so we should figure out the best thing to do about that.\nIf we do react-rails in this repo, we'll need to shuffle some things around. Lets chat and figure out the best way to do this\n. By discrepancies I mean that the transform is slightly different. bin/jsx gives a little bit more power and options (like stripping __DEV__, transforming into common js). I think it's fine for them to differ a bit though, so long as they have the same default behavior.\nAs for getting react-rails in here, I think we'd need to restructure the repo a little bit (ie lib/ is set up for react-source, but we'd want a different lib/ for react-rails, so I'm thinking we would put each under it's own directory, or both under a gems/ dir). Otherwise, I think the ember-rails route makes sense.\n\nload and run should not be exported when window/document is not available. If I understand it right here, I'll fix it. Anything beside this?\n\nI think that should do it! Do that and I'll merge this in.\n. @jeffmo, this is all you on the esprima side. We'll obviously want to make sure this change is fine internally before we take it.\n@jakubmal Feel free to open PRs against facebook/esprima#fb-harmony (that's the branch we use internally and here in React - npm has git dependency issues, that's why we point at a tarball for a rev in our package.json). I think we intentionally lag behind master since we've done some considerable work in our branch, though @jeffmo knows better. We'll almost certainly want some tests :) We didn't add our other tests in vendor/fbtransform/, but we have some other React specific ones and we'd want to add some internally before we point React at a new rev.\n. I think React.addons.TransitionGroup mostly covers this. If not, let's figure out what else needs to happen to make animations in React as good as possible.\n. Oh I guess TransitionGroup handles #227 but not this without restructuring a bit...\n. Ok, I think we can close this based on React.addons.TransitionGroup\n. Can you rebase this?\n. I'm going to do more testing soon, but this appears to be resulting in a pretty tragic lose of click events on facebook via iPad. There might be some other things going on though.\n. Hey @jakubmal, I'm actually working on this right now. Going to have a branch in my repo very shortly. Sorry if this is duplicating work, but let's converge on a single solution! I'll post here once mine is up and you can tell me it sucks and we should just use yours - I actually haven't written a proper gem (react-source doesn't count) so I'm probably doing a lot wrong!\n. Doing a little bit of cleanup, but it works!\n\n. @jakubmal I pushed out React (and more important react-source) v0.4.1 yesterday with you changes to JSXTransformer, so now the gem dependency can work without having to build and install react-source locally. I also just synced my branch with what's going to end up in the separate repo (https://github.com/zpao/react/tree/contrib-react-rails/contrib/react-rails). If you wanted to do any work, feel free to start doing PRs against that! I have a list of todos in the readme. The biggest thing will be tests, though if you think some other part of this is higher pri, feel free to hack on whatever. Anything will help! I'll make sure we maintain authorship into the new repo if we get changes in before the standalone repo opens up.\n. @jordwalke I made https://github.com/facebook/react/wiki/Release-Process when we launched, though it needs a little bit of tweaking (and would need more if we do this)\n. FWIW, I'm definitely going to pull this into its own repo. Hopefully today or tomorrow.\n. We shipped 0.5 with this. :boom: \n. Good catch! 2 things:\n1. Can you sign the CLA (https://developers.facebook.com/opensource/cla)?\n2. Can you also update the other place we reference 8080 (the basic-jsx-external example)\n. Thanks a lot @gasi! For future reference, you can use git commit --amend to overwrite your previous commit and then git push -f to overwrite your branch. GitHub picks that up and updates the existing pull request. I don't mind this either, just thought I'd share!\n. Paging @yungsters.\n. Going to close out then in favor of just adding docs.\n. You don't by chance want to write tests for this do you? I know we don't have much coverage for our form components...\n. Agreed! We must have a falsey check that needs to be smarter\n. :thumbsup:\n. Looks good to me! I'll pull this in internally and merge ASAP (probably Sunday or Monday).\n. @chenglou We should add a test for this to make sure we don't break it later. Want to add one?\n. Ah, this looks like a could possibly be with inputs and the fact the defaultValue sets value. If you add a data attribute data-formid={this.props.formId} you'll see that we're actually left with the 2nd input, but it's value got overwritten. I didn't check, but I bet that's the case in the 2nd fiddle too.\nNow that said, these edge cases of reconciliation are why we ended up with the key prop. Let's get @jordwalke and @sebmarkbage in here to weigh in, but I think we might just throw this into the \"use key to fix it\" bucket.\n. > In this case, the behavior across similar components on the same render differs, It's unpredictable and leaves the impression that it's a quirk of the framework (that just happens to be solvable elegantly using another concept). Overriding an input text but not an input checkbox can never be an intended behavior.\nI agree that we should have consistent behavior here. Best I can tell from a quick check is that we actually do. Your checkboxes don't change because you're using checked= instead of defaultChecked=, so you're actually testing 2 different things. If you use defaultChecked= you get the same behavior as text inputs.\nI also agree that this is unexpected and something we should spend more time figuring out the right answer. This might be something we can just fix in the form components.\n. I just did the exact same thing. Seems like something we would have done intentionally but I'll check! (might be a DOM quirk (or quirky spec) we're working around.\n. Well, the reason it's broken locally is because npm install phantomjs doesn't actually leave you with an executable phantom because it tries to modify the wrong file :( (https://github.com/Obvious/phantomjs/issues/83).\nI'm not sure that explains why Travis is unhappy since it's supposedly has phantom already in it's path. Unless it also has an executable with broken permissions... I do get npm ERR! weird error 3 in both places though I have a better error logged locally instead of just \"Error\" on Travis.\n. All solved. Updated in cb00d3e66c7e701d894199b0c1635579f52818ec\n. Sorry @ericclemmons, it could have been :) I tried to do a pass for missing attributes pre-0.4 but if you notice anything missing from https://github.com/facebook/react/blob/master/src/dom/DefaultDOMPropertyConfig.js, feel free to open an issue or PR\n. @ericclemmons Still interested in fixing this?\n. We just had a big discussion here. We're going to send out some proposals internally soon and I'll post them on the google group too (with link here in case you aren't signed up).\n. As promised: https://groups.google.com/forum/#!topic/reactjs/xovHWHGHPCA\n. Hey @chenglou, can you rebase? (feel free to squash too if you want). Let's ignore @petehunt's comment since @yungsters accepted and Pete's getting on a plane soon anyway. We'll come back to what he said when we figure out the real consistent behavior here.\n. I think you saw some of our discussions on IRC about this. I think this is totally reasonable to do, we think we might just want to come up with a more explicit API. cc @jordwalke @sebmarkbage \n. Nice find, and thanks for the PR!\nLet's actually change it so that it points at the first guide. I think pointing at the reference section is a bit awkward.\nAlso, can you sign the CLA (https://developers.facebook.com/opensource/cla)? We need that done before we can merge in.\n. I like it. I'll squash this and commit it in the morning, then get the site updated. Thanks a lot!\n(And I'm glad you like the CLA process. I'll pass that on to the people who worked on it!)\n. Thanks for pre-squashing :) It helps GitHub close the issue when I push it (without the green button). I'm going to do another pass for 404s and then push this out.\n. This is interesting and definitely solves a real problem. I agree that it's awkward to mix event handling systems... I bet @jordwalke has some thoughts about this.\nIs your thinking that add/removeEventListener would work on the top level component returned from render? Or all events of that type that occur for any component inside this one? You're jQuery code targets specific <a>s. Would you want the machinery to do that in React as well?\n. I think this is something @jordwalke or @yungsters will be best equipped to answer since they've worked on the whole events system the most. Unfortunately they are both on vacation so not around to comment. Until then, maybe somebody else could comment? @petehunt? @sebmarkbage?\n. Awesome! I rebased & pushed it as 3d1cc16a9b143b96b353b7b03c06ca0f7e544304\n. I hate to say it but we have a diff that just went in and added another use... :grimacing: The diff will be worth it though. Merge coming in the AM.\n. :thumbsup: I'll do the usual internal diff dance in the AM but this is good to go. Thanks!\n. already landed upstream, so merging.\n. Oh man, sorry I missed the questions. Do whatever you guys need and think is right, I'm going to step back and let you go wild and just try to guide. Not being 100% familiar with all of the cookbooks out there, I think it would be great to have working code. And thanks to codeblock highlighting (it'll become a thing one day!), we can do better than most people. If the code needed is long, perhaps we pull the relevant parts out but have a link to a working jsfiddle or something.\n@mcsheffrey I'll let you handle the Jekyll parts. I'm thinking all under /cookbooks or something. We have sidebar navigation for docs in _config.yml, so something like that would work. Eventually we'll rewrite the docs from Jekyll but not today.\nGo wild, I'm excited for both of you to work on this! I set up https://github.com/facebook/react/wiki/Cookbooks - feel free to use it, or not. Let me know if you need any help, or some guidance. Thanks!\n. You could make that work and that might be the best option short term, but ultimately I'd like these checked in. My ideal world is one in which I could clone the React repo before getting on a plane without wifi and I have everything I need to learn about React, even if it means I have to read some Markdown instead of a better looking site.\n. I'm not interested in checking the wiki in, though that page could serve as the beginning of an index page. When it's checked in, it should be working with Jekyll, and I'd like to hold off checking anything in until it's at a point where we're happy publishing it (otherwise things get way too complicated for me). Working in a long-running branch in one of your repos is probably the best way to do this - the wiki is an easier way to organize and the effort so that's why I made that.\n. Clsoed by #318 \n. Pete is fixing this internally, diff syncing out soon. Going to close out in the meantime.\n. I thought we weren't going to ship it in the default package and have instructions for a separate build...\n. Ah yea, you're right. Carry on!\n. While this is open, @benjamn and I also talked about making some changes to commoner, specifically avoiding watching unless explicitly asked and making sure no-argument invocation works.\n. Just going to pull it in without waiting for internal accept. Good catch.\n. It's been pointed out that leaving CommitSyncScript in the authors file is silly. I agree, so will fix.\n. I know I talked about pushing this out into the future, but what if we get rid of the pruning entirely? If we just stick with the constant replacement, uglify strips out the dead code blocks. In theory, slightly faster builds ;)\nI just tested with a bunch of different cases (using __DEV__ standalone, combined with other conditions, in an else if, with other else conditions after) and it worked really well.\n. I'm usually more a fan of String.prototype.match but whatever works. Thanks!\n. Going to close this out, but want to come back to it. The branch will live on (and get rebased eventually)\n. :boom: Thanks!\n. Ok, I've been slowly digesting this over the past few days and here are my thoughts (some we talked about):\n1. Let's rename this \"Tips\" or something. Since we deviated from the cookbooks format, it feels a bit disingenuous to call them that.\n2. We should make sure we keep filename, page title, and sidebar link title in sync, at least for this first push. I think they all started that way but with tweaking they've fallen out of sync. Also, make sure titles are title-cased (I noticed it mostly in the sidebar).\n3. Feeding off 2\u2026 if we go with the titles we have in the files, I think some will span multiple lines in the sidebar. We've avoided this so far because it's a pretty bad experience. I'll leave it up to you to make the decision on what happens here.\n4. The order of entries is seemingly random. Style is talked about in 2 docs but they're split by several other unrelated docs. Let's bring these together. On that note, if the leading numbers on the filename aren't helpful, feel free to get rid of them.\n5. That left nav has gotten really long. I don't think this is a problem for you to solve but it might be time to bring in some JS and get some collapsing going.\nI'm going to do a pass through and tweak some grammar (curse my newspaper editor past) and send a PR over (hopefully tomorrow), but I think we're almost ready to merge this in and get it out into the world!\n. I have a PR open for this, just need to apply it to jstransform\ncheers,\nPaul\nOn Sep 22, 2013, at 11:03 AM, \"Jonathan Jacobs\" notifications@github.com<mailto:notifications@github.com> wrote:\nThis seems to be a problem in the jstransform library, the problem begins with the docblockRe expression. Catering for \\r\\n in this expression allows the parse to find the JSX docblock and continue with the rest of the parse (which seems to trim strings, presumably removing the trailing \\r.)\n\u2014\nReply to this email directly or view it on GitHubhttps://urldefense.proofpoint.com/v1/url?u=https://github.com/facebook/react/issues/366%23issuecomment-24886972&k=ZVNjlDMF0FElm4dQtryO4A%3D%3D%0A&r=laHZhPsrTTGL9mHVyUC%2BICFnZxZCH4LNzfo%2BOgrHdsw%3D%0A&m=CLopvf7s9m65pJyLmahetLyYhw2ijYcbPWdcfG3p7is%3D%0A&s=954f1aa607e1d3be7833b26b0ac2bdabecf1cd9ae3901cde5f5cbaf9d6e22b8c.\n. These tests are good. It would also be nice to see a test focused on a non-form based input, but we can always revisit that.\n. It may be a bit hacky @brianr but you managed to find your way around core pretty quickly. Let me know if you're interested in some other tasks :)\n. What if there are multiple mount points? Should we attach our suite of listeners at each mount point? Or is there a tipping point where we should instead just go top level?\n. Sweet! I think this will be a big win. Definitely keep us up to date on progress :)\n. @yazaddaruvala Thanks for taking a go at this! Definitely keep sending things our way as you find weak points in the docs.\nI think for this, we'll go with what @chenglou is doing to link to the document since it's really React, not JSX.\n. Let's use the format we use for other \"Note\" callouts, blockquotes. Check out the other jsx file. Also, let's reword and call out style specifically (maybe just as an example attribute) as something since people are landing here.\n. :thumbsup: That should be it!\n. React will re-use the component that was there since it's the same type and at the same position in the tree. This is intentional for many reasons (speed, memory, etc) but since you assumed the opposite, I understand where the confusion is coming from. Since the component is being reused, getInitialState won't be called again, so you won't be re-setting this.state.color like you do during component initialization. React does provide a hook here for you though - componentWillReceiveProps(docs).\nNow that said, I think you'll want to carefully consider the implications - you're controlling your component from multiple places now which can get messy and make things a bit harder to reuse. I don't know the full scope of what your application is doing so maybe it'll work out great for you. I noticed though that you take an alternative approach for selection, passing a callback and leaving it entirely up the to prop (you set an initial state in Message but don't use it).\n. A lot of the quirks of React come from our desire for speed. In this case, if we threw the child away just because a property changed, we would also need to remove the DOM node, then create a new one that was virtually identical except for one attribute. All of that is expensive and slow. Part of React's philosophy is that data should be able to flow through your application so if you have top level data changing frequently (maybe a backbone model or something) then you really want to minimize the set of things that change down the line from there.\nHopefully that helps a bit. If you have more questions about it, this is a great question for the newsgroups and could probably be made into an interesting blog post.\n. Thanks!\n. It's not actually a Chrome bug - since the event is pooled, the instance is actually cleaned up by the time you expand. That's why the initial rendering shows details (because it read them and wrote out right away) but the expansion doesn't. I got confused by this a while back before @yungsters explained it to me.\n. This should be relatively easy. What should we do with inline <script> tags?\n. I bet this actually needs to be fixed in commoner :/\n. Off by one? Is there a pattern? This is likely something that actually needs to be fixed in jstransform.\n. Is there a way to use React as a defined module instead of as a global? I know we have the UMD wrapper on there so it should be possible. I'm not familiar enough with requirejs though.\nIf that's possible, then let's update for that. Otherwise this is fine.\n. Awesome. Thanks a lot!\n. @shripadk I'm going to wontfix this based on the above. I appreciate the discussion though and love hearing ideas people have for improving the way React works. Keep them coming :)\n. After talking with @yungsters, I'm not convinced yet that this is a good idea. I think it could be useful if data is used widely, but it still has a pretty minimal usage across the web. If we do decide we want this, there are a number of things about the implementation we'll want to change (this should ultimately work much more like the style prop).\n. @spicyj it does :) I used http://facebook.github.io/react/jsx-compiler.html\n. I think we can just fix the trailing whitespace issue independently. I'd argue that's a big that it ends up in there at all :)\n. Let's put the 50px into a variable so this gets updated automatically if we change the navbar height.\n. Nice! I did a minimal test to make sure it still works with <input>s (where the attribute actually has meaning) - http://jsfiddle.net/zpao/HF4mV/. But we should be making sure we still work with CSS selectors like this (which actually seems like a great way to test this whole module...)\n. Let's ignore the window resize and whatever other events that React attaches and uses internally for now. If possible, it would be great to end up removing those entirely but that should probably be a separate effort.\n. :shipit: \n. \n. Thanks!\n. Nice catch. data:text/html,<input type=\"submit\"> is usually \"Submit\" (though in Firefox it's \"Submit Query\" which is weird).\n. @syranide Can you fix or update the failing test? (I think the test is right, so something in your code probably needs to change).\n. FWIW, we just added onTransitionEnter and onTransitionEnd in c2e48740fc9d2c47eb62d9a1ab4a9372fa749087 (I have no idea if there's overlap there, but wanted to give you a heads up)\n. @petehunt, what's the status on this now with CSSTransitionGroup?\n. ping\n. We're all synced so do your thang\n. Any update?\n. No rush, just checking in. Focus on exams!\nOn Dec 5, 2013, at 8:36 PM, \"Cheng Lou\" notifications@github.com<mailto:notifications@github.com> wrote:\n@zpaohttps://urldefense.proofpoint.com/v1/url?u=https://github.com/zpao&k=ZVNjlDMF0FElm4dQtryO4A%3D%3D%0A&r=laHZhPsrTTGL9mHVyUC%2BICFnZxZCH4LNzfo%2BOgrHdsw%3D%0A&m=LdkvWdkr9U88A6QngkFwaMCMol9O7TuUs%2F1EDSr4zYI%3D%0A&s=6a83bf04a7d76f89f31b8e6b891cbb862ef3f80314e1f084613a5a1e304271ef do you need the docs soon? Exams over next week only.\n\u2014\nReply to this email directly or view it on GitHubhttps://urldefense.proofpoint.com/v1/url?u=https://github.com/facebook/react/pull/588%23issuecomment-29963130&k=ZVNjlDMF0FElm4dQtryO4A%3D%3D%0A&r=laHZhPsrTTGL9mHVyUC%2BICFnZxZCH4LNzfo%2BOgrHdsw%3D%0A&m=LdkvWdkr9U88A6QngkFwaMCMol9O7TuUs%2F1EDSr4zYI%3D%0A&s=3b46c502820ffa2c8a199bec29d6d663e2af8527c4dbd60090537e19b83bc5a6.\n. @sebmarkbage Can you handle reviewing and syncing this one?\n. I knew it could be done :smiley:. Nice work!\n. wooooo!\n. Can you apply internally and make sure everything checks out fine there?\n. Whoa, awesome :)\n. It might be confusing to show it in the same box. Maybe a new error box below? Or the red could be nice. Let's do something though.\nIt would actually be even cooler to debounce so we don't parse the editor content until after keypresses stop (would avoid the flashes). The 2 combined would make for a much better experience.\n. What version of IE are you having problems with? We support IE8+ in standards mode right now. IE8 in quirks mode shows the behavior you're seeing. If this is your own page, then just add a doctype and that should force standards mode (which I imagine you want anyway).\n. Good point! We use an intermediate tool that does caching and some other smart things. I'm going to pass this off to @benjamn because he's the author of commoner.\n. @petehunt is gallivanting around the world so I'll merge this in. Thanks a lot!\n. :+1: \n. Closing in favor of #630. Thanks a lot for noticing the misuse @youngjay! Definitely don't hesitate if you see anything else wrong.\n. Few things:\n1. please update the version in the core package.json\n2. update the version in React.js\n3. we'll want to update the commonerConfig version in package.json (to force a cachebuster)\n4. the browser tests don't run - ReferenceError: process is not defined (cc @benjamn, @subtleGradient)\n. No, only docs/_config.yml is auto updated. The rest is manual (but that's why there are tests to make sure they are updated, they were failing :wink:)\n. Pulled locally, added a few more things, then screwed up with a fast-forward merge. https://github.com/facebook/react/compare/9270d3d56ea3b196acc099409a38e6c07b191e46...153b75f186a78c876cc11678d1abbdf5e13a3b5b has all the commits.\n. :thumbsup: otherwise. test test test :)\n. :+1: \n. :+1: \n. If we're going to change the public one, I'm going to shoot down the idea of doing es6 without a flag.\nLet's change the public jsx separately. We'll also need to do something so commoner knows to bust the cache when the flag changes.\n. Yea, that first commit will go away. http://paulshen.github.io/react-bench/ has some benchmarks.\nAlso, let's turn on the esnext option for jshint so lint passes\n. Yea, we've accepted that lowercase is the only real option here. npm actually even prohibits capitalized package names. That might force us to eventually change internally, but it at least makes it a relatively painless transition.\n. Ok, so part of the decision was made. We're going to base 0.8 on 0.5-stable. We're not going to take any API changes, but we'll take bugfixes from master. This makes things way easier and also let's people switch to 0.8 without worrying about breaking changes. This also means we need to do what we did for #439 and list out commits that will need to be cherry-picked/backported and excluded.\nBuilding and testing is going to lack the coverage we have on master, but that's fine. With any luck we'll have vNext cut soon (it's unlikely anything will happen there before 2014).\nPlease add commits/PRs that you think should be in 0.8 and I'll update the description of this issue with the updated state.\n. @spicyj suggested a spreadsheet... here's all the changes in master that should be considered: https://docs.google.com/spreadsheet/ccc?key=0AmorHpAY7s4edEZWQmRXVnU3Y3NZUjlOWTY0MDNVS2c&usp=sharing\nGenerated with this and imported as a CSV:\ngit log --pretty=format:'%h | %s | https://github.com/facebook/react/commit/%h' --reverse --abbrev-commit --no-merges 48281a1...master src\nWe'll figure out changes outside of src/ outside of the spreadsheet\n. Can you confirm master is fixed @Daniel15?\n. @STRML, are you still interested in doing this?\n. npm react doesn't have any other dependencies so that's weird. Perhaps you were using react and react-tools at the same time? Either way, we want this update so \u2026 :shipit:\n. You say it can be null but no tests to confirm (also doesn't look like that's true)\n. :thumbsup: Can you sign the CLA? https://developers.facebook.com/opensource/cla\n. This is a great idea. I'd love for us to have a more complete set of tooling available.\n. These are pretty safe but I'm still a little bit concerned about supporting these. I know we've said addons is dangerous and we'll change it at anytime, but I'm afraid we're going to see more copypasta of things that aren't supported.\nSo I'd like us to make sure we harden our APIs before exposing them as much as possible. Again, these are probably fine (then event hub is the one I'm nervous about) so I think it's fine here\n. Yea, it's more about the case where a component you include injects an event plugin and that's totally outside your control. We're moving quickly into the world where people are using React and we're not having that close contact we had for the first few months. We're not seeing all the ways the uses are unfolding and I'm just getting a bit nervous is all.\nFeel free to go for it.\n. This goes back through many file moves and I'm certain it's unintentional.\n. Can you remove the require('ExecutionEnvironment') call since that's not used anymore.\n. Ok, we're going to do member expressions. I think we're going to start with supporting <Foo.Bar.Baz /> - not entirely sure what to do about <Foo[\"Bar\"].Baz /> (@jeffmo?)\nIf you're still interested in picking this back up @syranide, I think you're best situated to get back into it.\n. cc @petehunt who might care about this\n. I'm going to target 0.10 for this since it doesn't seem likely this is going in in the super immediate future.\n. Does this fix #788?\n. Does this fix #788?\n. (this isn't actually fixed yet is it @vjeux, @spicyj?)\n. @xixixao sorry for the pain, especially with Jekyll. I take full responsibility on that one, I knew it when we were getting the site started and I could move fast. wintersmith looks a lot better than I remember (pre 2.0?) and I might give that a try if our react-page project doesn't work out.\nAny suggestions on devDependencies? I'm guessing that was phantomjs? Or maybe one of them now has a binary build so downloads node source? Either way, we have to balance here and I'd like to make it easy for all and not waste everybody's bandwidth.\n. This is probably reasonable, though it'll break some people's current expectations. I do like that it would leave .js files alone by default. @benjamn?\n. I bet @benjamn can add something to commoner to make this easier so you don't have to hack it.\n. I think starting with embedded sourcemaps is a good idea. Any idea how something like browserify handles them? (interested for our own purposes...)\n. I was wondering what if you knew what it would do if each of the files it was putting into the bundle had an embedded map. No worries if you don't know!\n. What if we just made React.PropTypes.isRequired work? Adding any in there feels like writing code just to write code. Though it does conform to the same pattern, so nobody would accidentally write isRequired.string. Any thoughts @yungsters?\n. I would really like to avoid adding anything to __internals and I would encourage you not to depend on that. That's basically there only to make the devtools work and I would like to kill it ASAP.\nIf @spicyj's suggestion doesn't work for you and you're doing this in node-land, you could require('react/lib/ReactCompositeComponent') directly. No guarantees on those APIs right now but it's there.\n. :thumbsup: Nice catch. Thanks!\n. Thanks for the report. That's definitely a bug in the example code.\nThe problem is that we're using the index in the array for key, which isn't consistent for items across passes when you don't remove the last time. You can instead use the text of each item as the key, at least for the small demo. If you ever have 2 items in the array that have the same text, you'll run into a different set of issues.\nSee http://jsfiddle.net/zpao/U6u4K/ where I have it working correctly.\n. The occasional grunt clean isn't a bad thing.\n. Nothing jumps out as terrible on a quick read, so I'm going to let @petehunt take on the real review.\nCan you also sign the CLA? We'll need that before we can merge.\n. Might as well take this, even if we end up taking #828.\n. Do you know if things have changed in es5-shim recently? Last I checked Object.create was the only thing needed that was in es5-sham, and we actually call that out separately immediately below.\n. I'm not attached to what we have there now since it's obviously a problem (hope I didn't come off that way). What @vjeux proposed sounds great. Let's follow the same pattern for the console polyfill.\nCould you also sign the CLA? Then we can merge away when it's ready.\n. Play around with different amount of whitespace padding, as well as a whitespace only string. Looks like there are a few edge cases to handle here.\n. :+1: \n. I actually think we stopped supporting rendering into the document recently. cc @petehunt \n. I think it would be great to expand on the docs here. It might even make sense to make a whole page detailing browser support.\n. I've actually made a pretty concerted effort to not support things that were marked deprecated in HTML4 (that means it was deprecated ~15 years ago). This is why React doesn't support the <font> or <center> tags. For this reason I feel pretty strongly that we should be encouraging best practices in React and not support things like bgColor (next we'll need to support background).\nHonestly, I wouldn't mind getting rid of other obsoleted things as well (including cellSpacing and cellPadding).\nYou'll notice from its use that this is a \"default\" property config. While there is a barrier to shipping your own configs, this has been our plan for a while. At that point, perhaps there's an HTML4 config that somebody could build.\nBut, I'm open to discussion.\n(And per the point about working with ancient Dreamweaver output... if you're switching to using React, it sounds like the perfect time to update from these no longer supported attributes. Perhaps the html->jsx tool could catch these and convert to inline styles.)\n. This happened before with an update to browserify. Probably one of it's real-node mocks changed (haven't bothered looking into it)\n. Yea, I don't want to do this right now. Maybe later.\n. :thumbsup: \n. :thumbsup: \n. AFAIK only Webkit does. (And I guess by association, Blink)\n. Mostly seems sane to me. I'm going to defer to @sebmarkbage for the ConvenienceConstructor related things as he's spent a lot of time there and may have some reason for wanting to keep the in check (may be relevant looking at ES6 classes)\n. @syranide - I like the idea of injection. We need to make the transform step injectible though too to make this really viable. jsx --with-svg src dest or something like that. I don't know that it'll happen right now though...\nI guess we should probably do this as-is for the time being, even though I'm not wild about the noise. So a couple things I'd like to see:\n- tests for the nsAttr setting\n- see if we can get the post-gzip size down (a 10% increase isn't trivial)\n- some indication that these changes are compatible with closure compiler advanced\n. I like. Suggestions for changing internally? I'm guessing we could just codemod existing callsites to be SimulateNative.* and move on, though we may want to do a pass and see if some of those should be testing the synthetic.\n. You say that, but npm is all for shipping your 10 line function as a module.\n. Closed with #1005 \n. Work around is to publish a new React package with an update to envify. (or modify your installed react package to use a different version).\n. Going to merge and move around a bit. I talked with @jeffmo and I think the consensus was that we would just publish this to npm on its own.\n. :thumbsup: There are actually still a non-trivial number of attributes that aren't currently supported (mostly as an oversight).\n. Just talked with @benjamn a second too late, but we're going to revert and ship 0.9 with the knowns (browserify) instead of introducing this right now. I want to cut that branch this week so hopefully we'll reland this in master right after that.\n. 0.9 will be out soon with that.\n. fwiw, I would strongly suggest precompiling your jsx to js before sending to a browser.\n. I ended up going with renaming. Now I'm living dangerously and just pushing.\n. @benjamn That's the easiest to fix: React = Npm.require('react'). I was more concerned with cases where people were accessing something like require('react-tools/build/modules/*')\n. I appreciate the effort, but let's revert the changes to src/ I don't actually care and I think I'm going to remove the maxlen rule entirely (with a soft enforce).\n. I\"m going to say, let's shelve for 0.10. I want to make sure we expose things meaningfully and not just because.\n. Yea, I think making <null/> work might end up being a mistake, for IE8 and also because I think it's too magical. Let's do something a little less drastic and not piggyback on React.DOM. React.NullComponent (need that namespacing @jeffmo so we can do <React.NullComponent/>).\n. I'm fine with this. We haven't exposed it on the component instance yet?\n. Can you rebase? 5c953a7bdd606337ce6d93b157a78117a8c6148f happened.\n. Any updates on what we're going to do here?\n. I will respectfully say \"meh\" and that I generally don't agree with overriding builtins. Would love to hear more about the bugs encountered.\n. Is this changed from 0.8? Or not a new problem?\n. I guess this supercedes #1072? Or should we do both? How is IE8 impacted?\n. I think it's probably worth mentioning that these methods don't have access to props/state. I bet there will be some article/SO answer saying to use statics for things you shouldn't (especially with the descriptor warning), so we could help prevent the misinformation.\n. Thanks! If there's more we want to change in the docs, let's open another PR.\n. Might as well fit it into 0.9. Have I said lately that we should do a proper pass through DOM attributes again?\n. Let's hold off on this.\n. Yup\n. Thanks for the report. We're tracking this in #1072.\n. I can't remember why we don't already have this, maybe somebody else remembers?\nAlso, before we can merge this, you'll need to sign the CLA.\n. Hmm, the way you worded this is confusing, it made me think you meant that <Component context=\"foo\" /> was no longer allowed, not that you couldn't use context as this.context. @spicyj - suggestions?\n. Thanks! I squashed into a single commit to make it easier to cherry-pick into the branch.\n. I'm not 100% sure if this falls into the same class of things that will start warning in 0.9, but we're aware of the problems this reuse pattern has led to and are moving towards a solution. cc @sebmarkbage \nClosing for now though since this is currently user error (even if we've done a bad job of communicating that, sorry!).\n. \n. @benjamn sounds like commoner trying to do too many things :/\n. ab2d59f8b02dfe65d2fe11960389671816904a06\n. :thumbsup: \n. FWIW, this works just fine for me in Firefox 27\n. Squashed to 5049fc6b059e25ebad4dc4fe9a2d3c0dd4794ea3\n. Thanks! @spicyj - want to get this in as is and add a new page later?\n. I'm assuming but want to confirm - this fixes the layers bug we were talking about on Thursday?\n. I think I'm going to end up deprecating the tools section of the site and just use the wiki. I'm not 100% sure of that yet, but I added this there - https://github.com/facebook/react/wiki/Complementary-Tools\n. I didn't really get to give this a close look last time around so a couple things:\n- Minification step (grunt build:min) takes forever and a day. Any idea why? To the point where grunt build is unusable for actual work.\n- We should really rename these files from browserify if we aren't using it (you mentioned last time it wasn't the interesting part, but once we get this ready 2nd commit to move them would be nice).\n- What do we need deamdify for? I don't think we have anything with the AMD prelude.\n- Will this have stable sorting? One problem with browserify early on was that require path building was async and resulting in the build file being nondeterministic, which was a non-trivial pain.\n- Your UMD is slightly different from the one browserify uses (https://github.com/ForbesLindesay/umd/blob/master/template.js), namely the part where yours doesn't check for other globals, only window. Any foreseeable problems?\n- All of the intermediate license headers are getting stripped out. That should be fine but we'll want to stop using simpleBannerify But I ask because I wanted to know the reasoning.\nAnd to bring in the table you had last time:\n| orig | orig.gz | diff | diff.gz | filename | diff % | diff.gz % |\n| --- | --- | --- | --- | --- | --- | --- |\n| 392755 | 78327 | -26789 | -20464 | JSXTransformer.js | -7% | -26% |\n| 602322 | 123001 | -4635 | -1843 | react-with-addons.js | -1% | -1% |\n| 121441 | 33430 | -17999 | -3576 | react-with-addons.min.js | -15% | -11% |\n| 549027 | 112014 | -2098 | -1096 | react.js | -4% | -1% |\n| 112340 | 31015 | -16826 | -3389 | react.min.js | -15% | -11% |\n. fwiw, putting {\"bar\"} onto a new line gets parsed how you would expect. It's an awkward balance and svg definitely makes this trickier :( - check http://jsfiddle.net/wVQr3/\n. Thanks!\n. Codemod in. He wasn't actually fixing them, just touching code around them so would have been merge hell.\n. Talked about where this should go offline, we're putting it here for now.\n. I actually get a different error in Firefox as it's trying to get the node for an event. Can repro in Chrome though.\nTypeError: Argument 1 of Node.contains does not implement interface Node.\nStack trace:\ncontainsNode@http://fb.me/react-0.9.0.js:14157:5\n...\n. @petehunt?\n. :thumbsup: bring it in\n. Thanks! We actually build the gh-pages branch so we'll overwrite these changes next time we build. Could you update this to be against master branch with edits to https://github.com/facebook/react/blob/master/docs/docs/videos.md\n. I'm mostly certain this is intentional but I forget exactly why. @petehunt?\n. No, simply that those attributes won't appear in your markup. It also means Resxt can't mount those nodes. I'll clarify a bit.\n. @sorribas version, how are you running it, any details to help repro?\ncc @benjamn - this is in commoner.\n. Thanks!\n. Filed in the devtools repo - https://github.com/facebook/react-devtools/issues/32, let's move any further discussion there.\n. Chromium (and I think historically webkit) actually deviate from spec here and add the hyphenated versions in the style object.\n. This is already available at grunt.config.data.pkg\n. You can actually just npm install path/to/react-tools-version.tgz instead of this dance.\n. Nit: ); on new line if it doesn't fit. And maybe found = indexOf >= 0 (it makes me want it to be a bool)\n. And last and definitely least: I think we're enforcing the braced ifs rule. I think grunt jshint:package will tell you that! :)\n. Nope :)\n. Personally I think this would make more sense before API\n. Good catch! 2 things:\n\n... onSubmit handler to the form that clear the form fields ...\n\n\"clears\"\n\n... if the user has entered text in both.\n\nThis doesn't flow as well as I'd like. How about something like \"when the form is submitted with with valid input\"?\n. ternary across this many lines is groosssss. Can you just use if?\nWhat about just using the shim @ https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind - this here is not quite the same.\n. These become no-ops internally, yea?\n. This is the only behavior that's bugging me. Since this nav is important for getting around the docs, hiding it is a bummer. Can you do something else with it instead? (Maybe unfloat, and compact it a bit?)\n. We're actually using bourbon so that we don't have to write all these out in the sass. Can you update to use the @include transition syntax (docs: http://bourbon.io/docs/#transitions)?\n. I have {{ post.date | date_to_xmlschema }} in my site - I think jekyll ships that formatter for us.\n. Might want to pass this through xml_escape too\n. This is actually a pretty naive implementation (eg. if the element had class=\"reallyopen\" it would not work right).\njs\nvar classes = ' ' + element.className + ' ';\nvar hasClass = classes.indexOf(' ' + className + ' ') > -1\n// then add/remove, trim, set\n. If you're attached to RegExps, you might be able to just use '\\b' + tclass + '\\b' when constructing so it matches word boundaries.\nThe other thing we should do is actually set up listeners instead of hijacking window.onload. We do this in our transform script so we should do that: https://github.com/facebook/react/blob/master/vendor/browser-transforms.js#L106-L110\n. This came up before: let's stick with ~0.6.10 (>= 0.6.10 will install anything greater, even across major versions, ~ is safer) - https://npmjs.org/doc/json.html#Tilde-Version-Ranges\n. Bolding this feels extraneous (fwiw, I feel the same about most of the other inline bolding on this page)\n. Can you remove this unused variable? It's not caught by lint because we skip __test__s since so many of them have transforms.\n. Please leave requires alone  in src/ - they need to remain global to work at FB and should get transformed as part of the build step into CommonJS modules for browserify into build/modules/.\n. I think you might need to use a string as the key to protect against key crushing. @jordow knows more about all of that.\n. The feels a little hacky since it actually relies on us using __DEV__, but it works. It'd be nice to pass the config in from jsx then we could look at debug there. But I'll take it!\n. This is backwards isn't it? We want to leave the call as is for __DEV__ and strip when !__DEV__\n. Nit: Not actually important, but we usually write our empty elements as <div/>. Can you update to do that? I'm pulling this in and getting it reviewed now, but that's my only comment.\n. Talked with @spicyj... nevermind!\n. @sebmarkbage Has pointed out that renderComponent can get used in non-DOM situations (eg, we use it for some <canvas> rendering where the container is not the canvas). Can you move this invariant into ReactComponent#_mountComponentIntoNode (https://github.com/facebook/react/blob/master/src/core/ReactComponent.js#L514)? That will ensure we're only doing this for DOMish components.\n. Should have mentioned this before but you can just do React.renderComponent and then you don't need to require ReactMount (one less thing for automocking to maybe mess up)\n. Handlebar -> Handlebars\n. We use   for everybody else. Why not include his last name?\n. I would actually include the first line too... \"that\" is kinda confusing because there's nothing for that pronoun to reference.\n. Let's do this like we have other notes, with blockquotes (see the bottom of advanced components). I'm also not 100% sure this is the right place to bring this note up, but we should say it somewhere so seem ok. \n. Let's change this to just check props.children and props.dangerouslySetInnerHTML since we only have the 2 things to check.\n. I haven't thought this through, but it feels like this method can be simplified. I wouldn't worry about trying to though, just sharing my gut feeling.\n. From discussing internally... me:\n\nIs this better than ReactComponent.DOMIDOperations.updateInnerHTMLByID? Based on the name it seems like we should be using that instead.\n\n@yungsters:\n\nYou're right, using updateInnerHTMLByID with a null argument might be more correct.\nThis pass over the props is to remove any props that no longer exist in nextProps but did in lastProps. So using textContent worked before.\n\nSetting this property on a node removes all of its children and replaces them with a single text node with the given value.\n\nSource: https://developer.mozilla.org/en-US/docs/Web/API/Node.textContent\n. Yea, we don't need to do any math to make sure you don't have both of these props. Math worked better than straight logic once you have 3.\n. Octal literals are deprecated in es5 but it looks like hex still works. I guess it doesn't actually matter but I would consider using parseInt...\n\nEDIT: realize now that this was already there, just shuffled\n. We should do our multiline strings the same way in the same file... We should maybe put them in a new file and read them in too...\n. Bad @benjamn. No modifying files unnecessarily.\n. Still unnecessary but whatever :wink: \n. Nit: weird line break yo\n. Nit: curlies\n. Nit: this is confusing formatting. Just put the comment above and keep the code normal looking\n. Still weird but I don't really care much. Personally...\njs\n    entry.module.exports = entry.mocked ||\n                           (entry.mocked = getMock(entry.actual));\nOr even...\njs\n    entry.mocked || entry.mocked = getMock(entry.actual);\n    entry.module.exports = entry.mocked;\nIn other news. Definitely blue. No, red.\nMerge if this is good to go. Passing tests are good :)\n. I actually like the before better, for this and the header. Though we could kill the 2nd use of \"React\"... instead of \"while reading about React\" we could say \"while reading these guides\".\nI like the rest of the changes though! I'll merge it in when you update\n. Nit: can you actually put all props on newlines? That's what we do when we need to wrap for one (see a little further down for what we did to the <div>.\n. \"700 people\"\n. Don't link to linkedIn. That's... terrible :) Talk with Jordan and see what url he want you to link to. I would also mention that Tom and Jordan are FB employees, or even just say React developers.\n\nI highly recommend you watching this video.\n\nI would just say \"I highly recommend this video\".\nAnd lastly, I would consider moving this down from the top. It's a community roundup, not what FB is doing roundup :)\n. > put many of them on react-samples Github repo\nput many of them on his react-samples GitHub repo\n. > integrality\nNot sure what you meant to type there... entirety?\n\nThe goal was to add a lot more explanation on why we built React and what the best practices are. \n\nThe goal was to add more explanation about why we built React and what the best practices are.\n. Nit: unindent (align with open tag)\n. I'm not 100% sure, but I think we can only have 1 describe per test file and that might be why phantom is failing. Even if not, we should move this into it's own file (just use the same docblock from this file).\n. And then we should call this renderTextInput\n. If we're going to make .bind(undefined, ...) work as well, then we should update the commit message.\n. Not a huge deal, but formatting nit - move  to new line, indented. There are a few instances of this.\n. We should maybe just export this from ReactComponent, but then requiring it might lead to some circular dependencies :/\n. Let's say \"initial release\" instead of \"beta\" (here and at the bottom)\n. Oy... this is a recipe for getting out of sync.\n. We talked offline, but for posterity's sake\u2026\nMy concern is that jstransform and react end up with different versions of our esprima. This could cause problems with browserifying. We could ensure that they use the same version with some manual work, but if all we need esprima for is Syntax, then we should probably make jstransform export that. @jeffmo is looking into a way to make that possible.\nNow that said, I don't think I have any issue getting this in and iterating in master.\n. Can you remove source-map and base62 from here?\n. trailing comma isn't valid json and so :boom: https://travis-ci.org/facebook/react/builds/10509242\n. Eh, mostly but not entirely. Also react-page is definitely not just about JSX. Let's pull it out a level.\n. I find these a bit distracting and I like that our sidebars have the same design to them.\n. Yea, I'm not entirely happen without them either :/\n. Can you add <!-- template.html --> at the top here? We call out all of the \"files\" throughout the rest of the tutorial. It should be obvious but in the effort to reduce having to context switch at all... :)\n. We can fit this whole var instance = .... onto a single line, so lets do that.\n. Let's actually ensure that the right error is thrown. I know we don't do that across the board but we're trying to move in that direction. You can see how that works throughout https://github.com/facebook/react/blob/master/src/core/tests/ReactPropTypes-test.js\n. small nit: this is longer than 80 chars so our linter is a bit unhappy. I think it's silly but @petehunt doesn't and so let's move the function down and line up with the opening quote.\n. I'm not entirely happy with that wording... let's say something closer to this (feel free to tweak it):\nMany members of the community use Stack Overflow to ask questions. Read through the [existing questions](http://stackoverflow.com/questions/tagged/reactjs) tagged with **reactjs** or [ask your own](http://stackoverflow.com/questions/ask)!\n. Fun fact... this test fails when I pull it in because our test environment doesn't behave properly :(\n. Can you rebase & update the other new place that uses this? It's in the same file. Also, @sebmarkbage, heads up about that.\nActually, why the rename, you still get a single instance?\n. Uh yea, this is bad. Apparently we are the 1%. I just checked and we make the whole function a noop. :astonished: Not sure if that's a bug in recast or if maybe we just need to change the way we're using it... thoughts @benjamn?\nFor the time being...\nelse {\n  if (__DEV__) {\n    ...\n  }\n}\n...works, so let's do that.\n. Can you rebase? getValue is gone now (you got rid of it!)\n. Also, this is unrelated to what the rest of this diff is about, right? (or is defaultValue resulting in warnings? I vaguely remember you saying that but I can't find it)\n. @petehunt might actually complain about this and opt for setting each individually to avoid allocating an object here (though it gets allocated in the constructor anyway so it's probably not the end of the world.\n. nit: missing semicolon\n. Can you remove the trailing comma (our internal linter catches it because we have a crazy combo of jshint and jslint, or something, but jshint won't catch it on it's own unless https://github.com/jshint/jshint/pull/1141 makes it in)\n. We're going to double listen in webkit. We should probably do these separately and stick with the early exit.\n'transition' in testEl.style // true\n'WebkitTransition' in testEl.style // true\n. while you're here, want to make this just }, this);?\n. We already killed this internally too, so I'll end up getting rid of it at the same time.\n. Can you move this to the previous line now that it fits?\n. I didn't think of this earlier (and I'm not going to block this diff), but we should probably consider using Node.ELEMENT_NODE and Node.DOCUMENT_NODE).\n. Great catch (and I love that you wrote tests)!\nWe have a function called invariant, so just require that at the top var invariant = require('invariant'); and then use it here. It'll throw errors for you.\nThen let's just use typeof here and put it first thing in the function.\ninvariant(typeof listener === 'function', 'error message here %s', registrationName);\n. Can you change this to 'CallbackRegistry'?\n. Nit for when we figure out exactly what to do: just put the string in here directly. We strip it out in our minification step. You can see how we handle the long line issue (https://github.com/facebook/react/blob/master/src/addons/transitions/ReactTransitionGroup.js#L41-L45 for example)\n. Did I mention that it's awesome you wrote tests? Let's use the test helpers here - expect(function(){ Callback... }).not.toThrow() and expect(...).toThrow()\n. Like @jordwalke said, I'm going to figure this out in a separate diff. But good call.\n. Nit: spaces here - if (condition) {\n. This message is a little bit misleading - nothing is actually wrong with the JSX, just the fact that they're using the transformer in the browser. How about something more along the lines of this?\n\nWarning: something something something. Be sure to precompile your JSX for production - link\n. I'm going to let @jeffmo take a look at this. We had talked about some other ways to do it so I think we should solidify a plan with him before taking it further. One thing we actually got rid of before open sourcing was this default namespace. I think we should stick with that and instead make it possible for the tools (eg bin/jsx, vendor/browser-transforms.js) to specify the namespace. In React, they would specify React.DOM but some other library may want something else.\n. Nit: // unless docblock.\n\nAlso, since we're only using this in findComponentRoot, would it make sense to name it something a little more relevant and then skip the assignment in the function? It's not an allocation in the same sense, but memory needs to be mapped so might as well avoid it entirely.\n. Ah I see. I never thought about that affecting the engines' ability to optimize\u2026 can you back that claim up? :)\n. js :)\n. I don't think you need a regex anywhere. Like I said, we shouldn't be changing anything that is already a string. This issue is also focused on the attributes, but this actually changes he content of the node, not the attributes.\n. Why?\n. We should probably pop this out into it's own test file.\n. Couldn't we just say var global = {}? I guess that wouldn't end up catching the cases where we use global internally...\n. I'm going to be super original\u2026 ReactWebWorker-test.js\n. https://github.com/facebook/react/blob/master/src/dom/components/ReactDOMInput.js#L81\n. '' + text will call text.toString() for you. So I think the best bet will actually be to clean this code up a little bit so we aren't special casing anything (maybe empty string is fine).\n. I bet with the change to escapeTextForBrowser, you can actually stop special casing anything here.\n. Don't use the String constructor. We should use the same pattern we've been doing to convert to a string.\nFurther, I think it might be better to actually get this where we set this.state.initialValue - it's only set once and that way we can do 1 string operation instead of doing it every render pass.\n. Nit (here and elsewhere)... space after : and ) - toString: function() {\n. 3 things....\n1. Let's make sure we remove the require('invariant') at the top of the file\n2. Let's take this chance to add spaces around the +\n3. Let's keep the short circuit for the empty string so we can avoid the concat and replace operations. I would hope engines optimize that away anyway but...\n. We should be able to get rid of this and the check below using it, right? If we want {toString:...} to work we need to stop special casing types here.\n. This is a syntax error. I'm a bit concerned you aren't actually running tests since they haven't been building for a while now.\n. This test is already in there and you modified it above.\n. Let's make sure we have a corresponding test for objects too.\n. Ditto, the object case should work here too so we're consistent.\n. Please revert this. It should be fixed but separately.\n. I don't think this should be in the guides section. It's way too much information for somebody just learning about react and walking through the site. I also think we should have a better title... \"About the Diff Algorithm\"? or something that is a bit less of a awkward (I don't have a good reason, this just feels awkward to me)\n. I didn't mean to imply we should get rid of it. How about we just put it in the reference section?\n. I said it on IRC, but for posterity, please use title casing for headers. Then merge away (or squash and push directly)!\n. Probably want to keep this as a string key for GCC.\n. We should be able to get rid of this'' +since that's what happens inescapeTextForBrowser. Also, these 3 lines should all fit on 1 line now.\n. This also all fits on 1 line now. Please update/remove the comment above since it's not relevant anymore.\n. Can you add to this comment explaining why we do need to forceinitialValueto be a string (it will be used as the child to <textarea>)\n. This also all fits on 1 line now.\n. This description is wrong. Can you do a pass through and organize the test cases a little bit and ensure the descriptions of each test case is up to date? Mostly I'm looking for consistent order and descriptions between these and theReactDOMTextareatests.\n. One interesting additional thing we should do here is actually just change the object like you did above and call forceUpdate to ensure that works. So long as we aren't convertingvalueto a string directly (see my comment above) then it should _just work_\n. Let's not remove all of this, but instead change it toexpect(...).not.toThrow(). We should still expectconsole.warnis called twice, but we can also expect that the value in the node is[object Object]. nit: let's skip the assignment and justexpect(escapeTextForBrowser(true)).toBe('true');- it helps keep the tests shorter and easier to skim.\n. I was told we can actually remove this short circuit. Sorry for telling you otherwise before.\n. :( - please make sure there's a newline at the end of the file (also the test file).\n. Please remove this empty line.\n. We wanted to check the value was[object Object]here.\n. I think it needs to be&:hover. I'm actually surprised sass didn't complain when trying to compile this.\n. We should be able to usename=\\\"{#clean_title}\\\"on the anchor and get rid of the id on the header.\n. Maybe restructuring the html is actually best here -header- that also helps my concern about putting block level elements inside inline elements without making the` display: block.\nAnd then we can do the css like:\n``` scss\nh1, h2, etc {\n  a {\n    color: $darkTextColor;\n&:hover {\n  text-decoration: underline;\n}\n\n}\n}\n```\nEdit: Also, you'd only need to change the &:hover to include color if we are already setting color in a global a:hover rule, otherwise it should just inherit.\n. Apparently! Good catch.\n. I've thought about this before but ended up letting us add a couple constants. I think we should only be accessing these in places where we know we're in a browser environment (since we're checking nodeType), but I wasn't sure at the time so didn't press the matter. Since then though we've added the constants in a couple other places and so long as it's supported in all browsers, we should probably just use Node.*. If anybody knows for sure or wants to test all browsers to make sure, chime up :)\n. For the time being, let's just keep this in like this and then followup to replace everything across the codebase separately.\n. Sorry for the delay, I didn't realize you were waiting on us!\nAbout the separate module, I think we actually went in the opposite direction (I think we had a ReactID module) and coupled this more tightly to avoid some circular dependencies.\nSo for now go ahead and export that function.\n. I don't think we need the > (since we shouldn't have anything but anchors as children) but whatever\u2026\n. Can you get rid of the var container = (lint is complaining about unused variables - not caught in this repo because we don't lint the tests)\n. Can you change this type to {DOMElement|DOMDocument}\n. I would actually just use React.addons.classSet({... here (that matches how we usually use it internally too). I would even call is classString to mirror your example above.\n. This sentence is pretty awkward and long. Let's make it something shorter and maybe break it up shorter segments that can be read on their own.\n\nWhen using classSet(), pass an object with keys of the CSS class names you might or might not need. Truthy values will result in the key being a part of the resulting string.\n. I'm not sold on this title...\n. Fine, but I would still do\n\nvar classString = classSet({\n    ...\n  });\n. I considered calling it React.addons.cx but that's so meaningless. We could do the shorthand like that\u2026\n. This page is really empty now. I think it might be worth having a sentence about each of the addons with links to their respective pages. If you're just pressing \"next\" through the docs it's not clear that there's any additional information written besides this.\n. > that should really live ~~in npm~~ on their own\n. This comment isn't quite right... IE8 supports Array.prototype.slice natively so there's no shim being used. It just doesn't support slicing NodeLists.\n. emacs sucks :trollface: \n. Can you make this a \"CONSTANT\"?\nAlso, is this something that we want to put into package.json and read from there in bin/jsx[-internal]? The change that prompted this wouldn't matter publicly but we talked about that before (changes to jsx formatting, which are likely to come soon).\n. Drop this whole ruleset (isn't doing anything).\n. Let's move hash link outside the headers rule, and then if you want to keep the coincidental override of :hover color, make it explicit.\n. How would you feel about running this against src/, that way we don't require a build step first (which you don't have set up, so a clean checkout and grunt complexity isn't helpful). I think it might also be advantageous to ignore tests, at least for now.\n. What are these files for? Do we need them to exist in the root? Maybe we could put them into .grunt and keep the root a bit cleaner.\n. Should this be TEST_TYPE?\n. Let's add a > Note about the previous API here. Since we aren't providing and deprecation notices we should mention it somewhere. Something like we did for http://facebook.github.io/react/docs/top-level-api.html#react.unmountcomponentatnode\n. Nit: can you drop \"the\" from \"with the add-ons\"?\n. \"Until\" isn't the right word here. At least the way I understand that, it means it stopped working in 0.5, which isn't true. Maybe just s/0.5/0.6/. Also, \"The\" shouldn't be capitalized. But also also, the name of the parameter isn't important. I would instead say something like \"Prior to v0.6, the DOM node was passed in as the final argument. If you were using this, you can still access the DOM node by calling this.getDOMNode().\"\n. This is why I said \"last\", so the sentence could be reused blindly :wink:. But in this case it was the third argument.\n. Yup, there's no way I'll accept something that doesn't do this the right way. \"Unless muffined by applicable law \u2026\"\n. Style here would be\njs\nfunction name(\n  args, args, args\n) {\n  code;\nBut other than that I'm going to step back and let you work with @jeffmo again\n. This results in a lookup and a set (double the touching of the DOM). Can we bring it back to just setting? (getDefaultValueForProperty also can touch the DOM, so this isn't great overall). Then we can move the whole thing inside an if that checks hasSideEffects first.\n. function shouldIgnoreValue\n. Let's format this like this (a couple extra parens, but it's easier to parse)\njs\n  return (\n    value == null ||\n    (DOMProperty.hasBooleanValue[name] && !value) ||\n    (DOMProperty.hasPositiveNumericValue[name] && (isNaN(value) || value < 1))\n  );\n. I still think this belongs in the reference section. Can you rebase on top of the nav changes and move it there?\n. > React\nReact's\nAlso, let's turn on the :superscript option for redcarpet and then use that syntax - O(n^(3))\n. nit: extra comma that our lint complains about (need to figure out linting these tests...)\n. This is what polyfills are for? Or is the polyfill not loaded yet?\n. Can you put these into a config file. This file is pretty noisy already.\n. The jsperf linked in the docblock has very different results for using array vs args (also different across browsers...).\n. Yea, 2 statements is fine. It's just a test so I won't be too picky\n. https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video#attr-loop says this is a boolean. Do we want HAS_BOOLEAN_VALUE here?\n. Let's do this cleanup separately.\n. Docs -> docs\n. Could combine this whole if & condition into a single return statement.\n. Oh we had another change in here that didn't get synced out :( We had detection to ensure displayName wasn't already defined on the object. I'm going to add that in here and then let you rebase.\n. Getting @sebmarkbage to review internally, but lint caught this unused variable.\n. I should have caught this when you first created this, but can you actually move the \"See...\" down to right before the console.warn? The message can get amended with more information in the if block here and it's weird if the link comes before the other info.\n. Yea, I think that's what was happening.\n. Have you tested that this even works? I'm not sure if the transform actually will parse hyphenated tags.\n. We only need things on this list where they don't match up. You have a bunch of attributes you can remove here.\n. This object has gotten out of control. I think if we're going to do this, we should just have an array and build the object on first run.\n. Yea, we opted to just show it to people in the browser we support. When we get a FF extension (who wants to write it with me?), we'll show the message there too.\nOtherwise, I think we should just market the extension more strongly on the site so that people with other browsers know that Chrome+extension is an option.\n. And while it may work here, the transform step definitely doesn't allow hyphenated nodes - <font-face> gets transformed to React.DOM.font-face.\n. grunt.file.exists('build/modules') &&\n. window doesn't necessarily exist where you might call this.\n. We should be using attributeName just in case they don't match up.\n. I say screw XHTML support and go bare. We've already decided we aren't ignoring the value (shouldIgnoreValue), so I think we should do it for all hasBooleanValue properties.\n. While this is async (chances are that will be decided first), we can use waitFor instead of this which only happens to work because it's sync. Then you can do expect directly in here.\n. I think we can leave the Unmountable part out of here. All server rendering would go through this, not just the unmountable string.\n. I would format like this & leave the existing code under it:\njs\nif (transaction instanceof ReactServerRenderingTransaction) {\n  return ret + '>';\n}\n. We explicitly aren't using the DOM at all here, so I think we can simplify this whole thing a lot.\n. Let's fix those separately. Though this might all solve itself (or rather somebody else will solve it).\n. Follow the code and see what's down that path and if it matters. I don't think it does (shouldn't be adding listeners, nor doing anything with the DOM, but not 100% sure what actually is happening).\n. So are these tests not actually testing anything?\n. Ah, I see now. That's deceptive.\n. We've already determined that value is truthy (see shouldIgnoreValue) so I think we can get rid of that check.\n. I'm not sure that this should be an invariant... do we want to stop execution or should we let it keep running and just warn? @petehunt?\n. Nit: newline above.\n. Can you actually put the use strict under this that way we keep directives at the top.\n. REview from @yungsters:\n\nInstead, would this be easier to follow?\njs\nupdateOptions(this, this.getValue());\n. > And then:\njs\n// Only update options if controlled.\nvar value = this.getValue();\nif (value != null) {\n  updateOptions(this, value);\n}\n. 2014\n. \"doesn't belong\" doesn't sound right. \"of a different type\" sounds a little bit better. Also, let's make it a sentence, with a period at the end.\n. That should stay 2013 (my script will change this to 2013-2014). But the test file was created in 2014 so really should have 2014.\n. R\n. Should be safe to just remove this whole object. Though it gets set to an empty object anyway.\n. ?\n. I think this should be EmptyComponent to match our general pattern of composite components.\n. Please remove this line.\n. Need a closing paren for that markdown.\n. Thanks!\n. Not used, is this doing something magical?\n. @petehunt fixed: 4642a70277150352c46c415aac963bc695dc9d48\n. > This uses React's synthetic event system\n\nThis statement isn't true yet, need #939 first.\n. Let's use our \"standard\" format for notes and get that red box.\n\nNote:\n...\n. Ok, @petehunt's review: let's make this var warning = emptyFunction, then reassign warning in the __DEV__ check, and export once at the end. We should probably change invariant to match this style too.\n. Can we fix this independently? Also a new test? I'm not convinced yet that we'll take the rest.\n. What is this saying?\n. I think reusing the variable here has lots of potential and led to some bad patterns. Let's call one of them renderedComponent? (unless the confusion is the whole point of the tip)\n. This whole thing feels a little awkward and leaves me with more questions than I had coming in. Maybe it would make sense to make it clear what the problem is before going straight into code (beyond the title?)\n. We should move this check into mixSpecIntoComponent\n. Yea, it's totally painful. I actually wonder if maybe this should be memoized too (since we actually come through here for each child).\n. Can you rebase and update for descriptors. This isn't going to be the right thing anymore.\n. nit: we use single quotes for strings\n\nLet's also add a comment explaining why we're doing this detection. And while you're doing a comment, try to do sentences as much as possible.\n. :cry:\n. Would you believe that this finally got looked at? And then it was pointed out we could skip most of these else branches and let early returns do their thing.\n. If you take a look at line 414 above, you see we have some references to line numbers (looks like {3,16-17,31}) - these allow us to do highlighting of certain lines on the website. Since you're adding lines in the middle here and later, we need to adjust the line numbers so the same thing stays highlighted.\n. Yea, agreed. (though if you really want to throw, there's nothing stopping you)\n. > null and false can also be used as return values. This is a nice shorthand to indicate you don't want anything rendered into the DOM. Behind the scenes, React renders a <script> tag to work with our current node tracking. When returning null or false, this.getDOMNode() will return null.\nOr something like that. I wouldn't mention undefined. Might also want to add the null note to getDOMNode()\n. Can you list the specific browsers that need this so that we can know when it's safe to remove.\n. So basically http://kangax.github.io/es5-compat-table/non-standard/#Callable_RegExp (also, s/phantom/android browser because old Webkit)\n. I've been overruled by @yungsters. He suggested HAS_OVERLOADED_BOOLEAN_VALUE which has much more meaning than \"booleanish\". Sorry for leading you astray!\n. 2014\n. Sorry for the delay! Let's make this part a little bit less repetitive. And then can you add a comment above EVENT_NAME_MAP declaration explaining why we need to do this.\njs\nvar isString = typeof event === 'string';\nif (isString || event.usable()) {\n. I was going to complain and say that this doesn't really need ReactReconcileTransaction to be injected. And we had a bunch of tests which were failing because they only inject the batching strategy (some flux-related code uses ReactUpdates directly). But then I just made those tests use ReactDefaultInjection instead.\n. What's the plan when something like #1009 happens? Would we just merge the two here? Or would we want to export html & svg separately? (note, there will inevitably be some overlap).\n. I actually don't think we should export this here. We can make the npm package require the new module.\n. Let's move this out to the top level (npm-dom-property-config/) and not inside npm-react/ (try to keep each standalone module separate so we don't end up packaging them together)\n. I was thinking main would require('./lib/DOMPropertyInjectionConstants') and re-export it however it wants. There's no real reason to export it here (especially html/svg split, which is incoming, btw)\n. @marcins yea, sorry about the back and forth. I'm working on getting more people involved in reviews here earlier. The double review process sucks and we know it. You won't have anybody else come back in a week and say something to counter @yungsters.\n. We should start writing docblocks for the purpose of each module. It's really non-obvious when skimming.\n. Maybe require React and then modify the object and re-export just the changed bits? I guess we need the different injection...\n. globalObj = this would be wrong, that's the scope of this module. We used to have globalObj = Function('return this;')() because that executes in a new global scope. But then we didn't need it and we removed it to be CSP safe. Not sure about self or global either... does one of those work in node?\n. 1. Can you have the image link open the video permalink - http://tagtree.tv/thinking-in-react\n2. Can you make principles of 'Thinking in react' title case and link to that page in our docs? We could drop the quotes too. (i.e. just [Thinking in React](/react/docs/thinking-in-react.html))\n. Let's keep this block ABC order\n. Also, we don't list the non-standard ones here, but in a paragraph below.\n. This moves code that was try/catch outside so we might end up in some failure cases we didn't previously experience. That said, it's probably ok.\nBut you can drop the surrounding parens here.\n. Where is spec coming from? You will probably want something like this.constructor.displayName (but do make sure whatever you use works).\nFurther though, I think we could probably just go right ahead and use warning instead of __DEV__ check + monitorCodeUse + console.warn (I'd need to do a quick check of fb code to see how many potential things that would cause issues with - warning gets overridden internally to basically alert in the fail case).\n. Meh, we don't try/catch any other user-specified lifecycle functions so at least we'll be consistent.\n. I think we actually want to make this classID and then map it below. As long as we're doing this camel case thing, we should try to be consistent.\nHave you tested this to ensure it works (and please test the update path where you rerender with a different value).\n. From @salier - \"This is breaking in IE8, where mountAt is [object DispHTMLDocument].\"\nWe can probably just revert this part.\n. I'm looking at another comment where this broken something... investigating\n. > Supernit-that-can-be-ignored: Use backticks (`) when quoting code, and add a period. :D\n\n\u2014 @yungsters\n. > This exposes internals (like _owner) to a public API. Please, no? At least expose the minimal API, e.g. by passing ownerName as an argument.\n\u2014 @sebmarkbage\n. > Can we just always wrap the user provide message with the owner name? Seems like this could be useful to find any component failing prop types.\n\u2014 @sebmarkbage \n. Anywhere where we have to fallback to 1.0? I don't really know what I'm talking about so hopefully somebody else does...\n. Nit: please remove trailing whitespace here\n. Publish date is Thursday so \"Today marks...\"\n. > 1.5k pull requests\n\nThat's issues & pull requests.\n\nKhan Academy, New York Times and Airbnb\n\nI'm a strong believer in the Oxford comma.\n. Tense is inconsistent in here. And while it was a newish idea for the web, I don't know that I'd claim breakthrough (let's remember to try to be humble). I'd actually consider dropping this whole paragraph\n. disaster: Titanic, Hindenburg, 9/11\nnot a disaster: people's response to a JS library\nAlso, tense again. \"challenges ... received\"\n. Clojure or Clojurescript or does it not matter?\n. > I personally wonder how many worthy ideas have been trivially dismissed as ridiculous before they could take off. Fortunately, React made it through\nMeh, sounds like fine commentary for a personal blog but a bit too editorial for us to be saying. I would personally drop this paragraph and extend the previous one to thank the community for opening up to different ideas and something along those lines. We should also thank our external contributors.\n. >  Functionally re-render everything and diffing the results was counterintuitive\nre-render_ing_\n\ninitial reception was very negative\n\nStill really strong. I know the strength helps play up the comeback story, but let's go with something a bit softer. Maybe \"varied\" or \"not entirely supportive\" or something like that which flips it around a bit.\n. > Fast forward one year, it\u2019s actually harder to spot negative comments about React.\nNot completely sold on this sentence, maybe we can just keep this paragraph about the positives and acknowledgements. Maybe we could lead off with saying how support and usage have grown recently, not directly discuss people's comments.\nI also think calling out individual contributors fits better here than in the previous paragraph.\n. Let's be consistent with our other patterns (and also types).\nExecutionEnvironment.canUseDOM ? window : null\n. We shouldn't need this one since the case & spelling is identical.\n. FYI, I removed this line when I merged it in.\n. Do you need mocks?\n. I wouldn't say unknown. I would say unsupported (well, \"unsupported\" though technically it works sometimes).\n. Please match existing style. if (...) {\n. probably want to use hasOwnProperty instead of undefined property lookup to avoid gaming the system. We've had a few other fixes related to that.\neg @jsx constructor\n. emptyFunction is a function so this shouldn't throw. It might be getting mocked. Let's just not use emptyFunction at all in these tests.\n. transform has all of this code. Let's reuse - transform can call transformAsObject then do it's additional sourcemap inline.\nAlso, I'm not wild about transformAsObject as a name, but don't know what else I would call it.\n. > if you are using browserify, the envify transform is needed\nWhen I read that, I think that I need to go figure out how to install envify and make that transform work. I think it's worth saying somehow that we already have that setup and browserify will just work if you set NODE_ENV.\n. Nit, but single spaces after sentences and other punctuation (you have a mix of 2 and 3).\nStill thinking about the best way to actually share the server code.\n. Since we list envify as a dependency and list the transform in package.json - no additional work is needed by consumers. Nobody has to go learn about browserify transforms or anything about envify. Your wording implies there's an exercise for the reader.\n. We don't need these props at all in this test.\n. > Firefox has problems when the sourcemap source is a proper URL with a protocol and hostname, so just use the path.\nI'm assuming you meant the next one.\n\nThings seem to work fine if we just use filename.js instead of path/to/filename.js, but ...\n\nSo given http://hostname:port/path/to/filename.js, we have to strip it down to path/to/filename.js at least. We could strip it all the way to filename.js, which also works (and is what I originally tested). The potential downside (I didn't back this up with a test) is that there may be path/to/filename.js and otherpath/to/filename.js on the same page and I thought perhaps the devtools would get confused mapping them back from the sourcemap if we just used filename.js\n. Yup :)\n. I'll take your rephrase.\n. Meeeee too.\n. I'll update this to http://fb.me/react-warning-polyfills\n. Looks better, thanks! Just a couple small things.\nLet's drop the \"which might be valuable to state\".\nAnd then \"will go away\" -> \"may go away\" (I'm hopeful but don't want to make promises we can't keep)\n. \"a.k.a.\" -> \"in other words\",\n\"provide this...\", \"you can use this ...\"\n. We might also want to include a note that since this uses shouldComponentUpdate, it will result in skipping updates for the whole subtree. That's implied by the \"pure\" part, but isn't immediately obvious. I'm concerned we might attract people who stop reading at \"considerable performance boost\" above and don't actually consider the repercussions.\n. I left this one out intentionally, at least until after 0.11 and we change our line about transferPropsTo\n. And I missed this one completely. Should we throw it in there for 0.11?\n. So is the regression we want to ensure doesn't happen actually about proptypes? What if proptypes implementation changed? Should we make this test about the general case instead?\n. if {{ page.path }} is right for everything, then let's do it.\n. Best to keep it defined IMO. I actually think we should default to cssFloat always since that's spec supported way and only fallback to styleFloat if we have to. Webkit/Blink supporting style.float is non-standard behavior much like supporting style['margin-left'].\n. defaulting to cssFloat has the other advantage of getting rid of this ternary abomination :)\n. I actually just removed this, can you as well.\n. Good catch. Could you also update the final release (I just copy+pasted this so it has the same typo)\n. Good point. Can you use the blockquote formatting we have for notes\n``` md\n\nNote:\nblah blah blah\n``\n. We should probably also mention this doesn't transferrefeither.\n.var allUnmounted = dirtyComponents.some((dC) => dc.isMounted())` (that should break out early).\n\nLet's not do that this second so we can move fast, but it's so pretty and short :)\n. ~~Will keyProp ever be undefined?~~\nIt was pointed out that this was not a very good question...\nreturn keyProp ? !!nativeEvent[keyProp] : false reads a bit better, lets do that. (This comment stolen from @spicyj)\n. It just gets encoded in, metadata looks like https://gist.github.com/zpao/19882b110201c594c716\n. semicolon!\n. > Is .removeNode universally supported? If not, node.removeChild(textNode) is definitely safe.\n\n\u2014 @benjamn \n. Looks like it's only IE (and I don't know what versions). This workaround is only IE though so that might be ok. any chance this will ever run for non-IE?\n. object properties?\n. getModifierState('alt') !== getModifierState('Alt')\n. > The development builds also provided warnings if you called functions on descriptors.\n. One day I'll remember this\u2026\n. Probably don't need css\n. This now does the same thing as line 100, increasing the surface area if we need to change how we remove styles. Can we consolidate? We could probably just reassign styleName if === 'float', then leave this whole if/else block alone. The part about checking expansion isn't great since it hits different values (though float won't be expanded so that's fine).\n. Great idea. Could you actually just call it \"Flux TodoMVC Tutorial\" to match up with the title that page actually has?\n. > as their value is fixed to on\n\nI don't understand what you're saying here.\n. Sorry for the massive delay.\nWe can drop this. According to MSDN this is set via node.classid, so we don't need the attribute map (which I think we'll actually ignore since we didn't specify MUST_USE_ATTRIBUTE above.\nEDIT: If it's only accessible on the node as node.classid and not node.classID then we do need to add it to DOMPropertyNames right below this.\n. Can we try to avoid this shorthand? explicit key value is better :)\n. Nit: var for each.\n. Nah, we don't like this style. It shouldn't exist in any of the other code we have up here (maybe some build scripts or tests but we're a bit lax there)\n. Is this going to match and bail if a documentation change is in the same PR/commit as a change to code?\n. Yea, I was thinking that. It's pretty noisy otherwise.\n. Sometime :)\n. Let's make this multiple={true} (I don't particularly like the implicit true when props are valueless and would rather not encourage it) and this looks good.\n. The type info here should be * since the point is to determine if it's valid :)\n. This should be \"React descriptor\" these days.\n. Component isn't right though (it's more wrong than descriptor). We might want to just say descriptor until we align all of our messaging.\n. This was the only place using ReactComponentEnvironment.unmountIDFromEnvironment - can we probably get rid of that now.\n. abc order please\n. \n. Just inline these.\nEdit: nevermind\n. Let's go ahead and add a couple more test cases, include some of the builtins (eg render) but also make sure the right thing happens for merged/chained functions.\n. I think this is going to have interesting results for chained / merged functions since we create a new function and then reuse the existing one which already has its name specified.\n. I'll let @chenglou handle comments about content, but just a nit that this link will be broken in the website. It should be /react/docs/animation.html#getting-started or even more simply #getting-started since it's on the same page\n. Nit: Let's use newlines and make it a bit easier to read.\nBug: Your JSX shouldn't be in quotes here.\n. Style nit - break function call onto its own line, splitting the arg like this is awkward.\njs\n    var containerHasNonRootReactChild =\n      ReactMount.hasNonRootReactChild(container);\n. This one gets even more awkward. I tend to like a style here that we don't really do in FB, so here's what we should probably do:\njs\n    var shouldReuseMarkup =\n      containerHasReactMarkup &&\n      !prevComponent &&\n      !containerHasNonRootReactChild;\n. Just put this all on 1 line (or if you're going to span,\njs\nreturn (\n  <div>\n    <div />\n  </div>\n);\n. Since we don't have to fight against ASI here, we instead prefer to drop the parens (and otherwise leave it as is)\n. this assignment is really tough to read, and I think is better written with a ternary\njs\n        var eventHandlerName = listener.__reactBoundContext ?\n          listener.__reactBoundContext.constructor.displayName :\n          '<<anonymous>>';\n. Though I suppose that capture the case where listener.__reactBoundContext.constructor.displayName is undefined...\njs\n        var eventHandlerName =\n          (listener.__reactBoundContext &&\n           listener.__reactBoundContext.constructor.displayName) ||\n          '<<anonymous>>';\nis slightly better I suppose...\n. Don't need this, btn-primary gets added by buttons if they specify it.\n. Nits:\n- ABC order in this groups\n- Let's make it autoSave like we've done for the other auto* properties. You'll need to then add the uppercase to lowercase mapping farther down as well.\n. Updates are going to get slow until this cache is populated, which I think might be a showstopper. One thing we can do is hold onto our testElement for each node type so we aren't recreating each time we call the function. That's still going to be slower than what we have now though. The tradeoff is a bit more correctness and not having to special case things (as much).\n. If it's null above, I don't think we look here (we default to property setting I think). Presumably aaceptCharset needs to be MUST_USE_ATTRIBUTE.\n. Also, do a renderComponentToString and make sure the markup is right.\n. I'm suspicious of any call to document.*, especially in a tight loop. I'd like to see perf in a real-life pathological case with lots of different types of elements and properties that all need to be looked up.\nalso, cc @yungsters\n. Hmm, I think it will be confusing in the React context since everything else is auto[A-Z] so for consistency, autoSave\n. Failing lint because these names (nextName, nextIndex) are used above. Perhaps just define above the whole conditional.\n. Can you remove the require of ReactTextComponent at the top? We aren't using it anymore.\n. At a glance the whole thing seems pretty reasonable, but I haven't looked closely.\nThe first things that jumps out at me here is that we should pull these regexs out to constants to dedupe (and to only create them once).\n. We do mention it super briefly in the npm readme, but it's not obvious. So let's do it. I'd like to tweak the wording though (you have to use require in Node, so there's no if about it).\nMaybe something along the lines of this?\n\nWhen using the react package in from npm, you can simply require('react/addons') instead of require('react') to get React with all of the addons.\n. Excellent. Want to update this PR or would you prefer I just add it in? (no need for me to steal credit, it was your idea!)\n. nit: dispatcher typo here\n. Let's just remove the mention entirely.\n. Lint complains that textNode is already defined, want to fix that?\n. Doesn't optimist take care of outputting options/usage?\n. I'm guessing this was a bit more RFC than final product, but let's make sure if we do this we get parity, namely --strip-types and --source-map-inline\n. optimist is actually dead. Maybe we should use yargs (successor to optimist), commander (probably the most popular argv parser), or nomnom (one of my faves).\n. lgtm. Want to put a space after the ellipses?\n. Nit: all of these are usually the first thing in a block, indicating the filename. We might want to just get rid of them (cc @petehunt)\n\nBut also, when adding lines you need to update the highlights we have set (that the {6-8} in the opening of the code fence)\n. That would make sense\u2026 I might have been thinking of making it useful for calling multiple times, though I realize that doesn't seem like a real use case. Or I might have just copied this over from before I had a function.\n. Probably don't actually need these and can just update them without deprecations here, only catching the React.* uses directly.\n. Is this all of the Dead* keys? The spec you linked to doesn't specify a list.\n. Object.assign(A, B, C, D, E)\n. \"This feature is available in v0.11 and above.\"\n.  I think a few more tests might be in order\u2026\n. navigator.vendor in Firefox === \"\"\nChrome === \"Google Inc.\"\nSafari === \"Apple Computer Inc.\"\nGoogle Inc. may (and does/did) make multiple browsers so Android Browser may show up here. There is unfortunately not any navigator.* property for actual product name so we have to do UA parsing for now.\n. Ah, I guess I misunderstood what we talked about, will restore.\nI had considered splitting this so that we had a node check being strict and a separate renderable check maintaining the current behavior.\n. Yea, I suppose. isNode is technically a misnomer, though I guess even the {}s are technically nodes as they are defined today.\n. @sebmarkbage thoughts? \"node\" might be correct but it's also pretty confusing for consumers to see. \"ReactNode\" implies some sort of typing. Maybe \"React node\" (and then I would change the element one to \"React element\", I had changed it to \"ReactElement\")\n. This file shouldn't be here. Maybe src/vendor/stubs instead? We'll have to do a bit of trickery to make this work properly.\nWe can leave it here for now and then move later.\n. Assign hasOwnProperty in the loop and use immediately? I thought I taught you better.\n. nit: space after the period.\n. I like the effort, but...\nThis section is discussing the spec, where displayName must be specified directly, not as a property of constructor. ie\njs\nReact.createClass({\n  displayName: 'MyComponent',\n  ...\n})\nnot\njs\nReact.createClass({\n  constructor: {\n    displayName: 'MyComponent'\n  },\n  ...\n})\nThe latter seems like an easy mistake to make given the way you have this presented. I would instead leave this as is and add a separate paragraph or note mentioning how it can be accessed for reading.\n. nit: titlecase\n. Or just use it directly? I'm struggling today but I don't think I'm missing something?\njs\nif (!Object.prototype.hasOwnProperty.call(nextSource, key)) {\n. Seems like this should live in our repo maybe? Or ship it to npm?\n. I didn't want to write one yet so no. First paragraph:\n\nA full changelog will accompany the final release but we've highlighted the interesting and breaking changes below.\n. Should we just say that then?\n. I hate these examples. Did you know the package.json is using React v0.10? So as is they won't work without the package.json being updated. And node-jsx.\n. No, but we should update the rest of these and test that they actually work with 0.12. We can use the RC as the dependency and github url for node-jsx to test then just set the deps right for 0.12.\n. Should we have notes here mentioning that these were available under a different name prior to 0.12?\n. If somebody Googles for renderComponent, I would prefer they end up on our site (or at least see our site) and not a bad answer to a dumb question on Stack Overflow.\n\nBut also, while an API works, we should mention it.\n. Should this be ReactClass?\n. I wouldn't be entirely surprised if somebody did rely on it. I vaguely remember seeing something somewhere, but that's fine.\n// couple things in ReactComponent.mixin\n// ReactOwner.Mixin\nattachRef\ndetachRef\n// ReactPropTransferer\ntransferPropsTo\n. You didn't, but you should! This file is autogenerated so I'm not going to add him because we'll just lose it again. He should be here though :( Make sure you actually commit as him next time and he'll make it in!\n. This is probably why the test is \"failing\"\n. Nope, we made it strict in #1827.\n. come on\n. Maybe some comments about this public/private thing mmmmmmk\n. getDOMNode\n. Todo: Same check as setState, add a unit test\n. Note to self: owner._instance is the same as getPublicInstance(owner) (with some hand waving from sema)\n. Just noting the behavior change with initial state setting at a different time and errors\n. Not a sibling\n. Note: I think you're fine to call this delete and es3ify/jstransform will fix it up for IE\n. take of your fancy pants. undefined\n. Can you add a comment about this\n. spyOn(console, 'warn') and then you can expect with it later. We have several instances of this pattern around so let's make sure we're consistent. We don't need the try/catch with that either.\n. I'd like to make sure we have the display name in here, so let's assign TestComponent = R.cC.\nAnd then we'll want to do a couple combinations to make sure we only warn when we expect to.\n. Nit: lets remove this line\n. Let's leave this out for now until it's properly deprecated.\n. Yea, we should do this. Can you actually add it last in the list and put a comment mentioning that it's for SVG?\n. This is the supported elements section, attributes are farther down :)\n. And actually, you can just leave off updating the docs. We do it a bit inconsistently but always update them right before release so we'll make sure they get updated manually then.\n. If you uses classes it actually transforms to the same thing :)\njs\nclass ReactEmptyComponentType {\n  render() {\n    ...\n  }\n}\n. Isn't lowercase ms correct?\n. :( @sebmarkbage I'm going to work on the style automation & linting as much as possible, but let's try to catch things like this (space before open paren, newlines with braces for ifs). Especially important for new contributors.\n. Our runtime typecheck transform fails here because it text and node don't match (more specifically, I think it will fail if you specify things in the docblock that aren't in the parameters, but not visa versa) \n. We have a lint rule internally about invariant's second arg being a string literal. I'm not entirely sure why but I figured it's important enough to listen to.\n. I think it works internally (basically __DEV__ gets replaced with 0 from what I can find)\n. That's what I was talking about actually, we replace before minifying.\nBut that said, we don't actually need this check and we should just wrap callsites with if (__DEV__). The only callsite is already wrapped so it's unnecessary. \n. Have this twice so could just assign first.\n. nit: else on previous line.\n. I'm a bit torn. The first two here are the React lifecycle methods so the statement that they are the \"only two places we need to integrate\" is true. The other two are really just convenience methods and you could make this work without.\nBut the other 2 methods are also using $ so it's not super clear.\nPerhaps clarifying that instead of just changing this to \"four\" would be best. Want to take what I said and make something like it work in the comment?\n. This should be a warning, not an invariant. There's no reason to stop execution flow.\n. innerHTML (and probably use ` to codeify it)\n. No capitals in the file name / permalink please. Let's just go with \"dangerously-set-innerhtml\"\n. dangerouslySetInnerHTML is a prop name, not a parameter.\nAlso, saying we force people to look up docs isn't really right. We would have written them 18 months ago if that were the case. The truth is that we really want people to opt in.\n. <div dangerouslySetInnerHTML={{'{{'}}__html: getMarkup()}} looks like it got tangled up and is missing a close />\n. I think this sounds pretty good. Just a little tweak:\n1. Let's use backticks around the event names so they use code formatting\n2. \"(for example: onClick -> onClickCapture)\" can be it's own sentence. \"Instead of using onClick, you would use onClickCapture to handle the click event in the capture phase\" ... or something like that.\n. Is this a direct quote or just a description? If the latter, please remove the quotes.\nAnd regardless, can you squash down to a single commit?\n. I'm concerned this object might be too deep. Typically we've done strings for the display name of components when monitoring these.\n. You lost an a.\nAlso the scoping of these is weird. I would prefer we define each of these with fallback values and the conditionally set them.\nAlso also, I think (but not completely sure) that prevElement._owner.getPublicInstance().displayName should work and might be preferred (I see the use of getPublicInstance().displayName elsewhere)\n. We'll want a better message here. Also, we need to use printf format (with only %s), not string concat. invariant(condition, 'some %s string %s', 1, 2)\n. Obviously need to clean this up and not mention elements here. And like we talked about, not completely sure if this is the best way to do isValidComponent checks (when we removed isValidComponent from the top level API there were some discussions about how it's a bit tricky especially moving forward as other ideas about what a component is/might be come into play)\n. We have an isNode module we should use instead of this. I can help with that tomorrow.\n. The file needs to end up in the right place with the license header (src/vendor/core/dom). Not hard, was just offering to be around since you hadn't done that before.\n. nit: false on new line\n. Type should be *\n. Probably want to put all of these in a new describe('findDOMNode') in it's own file.\n. If updating these works as properties, let's just do that.\n. Let's just use apply always, I don't think we're getting anything by limiting arguments here.\n. ... yep. I should have at least caught that in review, but definitely here. oops.\n. This isn't a UFI.\n. Spaces around operators.\n. I think this should probably be ReactClass\n. Can you explain your reasoning?\nI think the first one is now incorrect... React is not changing data, your application is reacting to some data source changing.\nThe 2nd one, I see that we have \"the\" in front of \"DOM mutation\" but I'm actually not sure we should.\n. Should we put a note at the top of this file that we are explicitly not using JSX? I would not be surprised if somebody comes along and adds some later.\n. There is no %s so these won't be inserted anywhere.\n. I think this might read a lot better if we demorganize it.\n. If I'm not careful I'm going to become one of those people who doesn't write any semicolons.\n. Unused.\n. ===\n. + at end of previous line\n. This one too.\n. Do we have tests that validate the inverse, that using valid propTypes that fail the check are handled? I think this is the first I've seen of us using proptypes with classes (though I might have just missed that in the duplication of tests)\n. nit: no space after function keyword\n. Also, 2 space indent\n. I obviously like the demorganized. Also, this is > 80 chars, can you split at the || to quiet one more lint complaint.\n. use spyOn(console, 'warn') (andCallThrough maybe), not the mocks module. That gets rid of the try/finally because we don't need to reset console.\n. style nit: space after keywords (if) also,  no parens with typeof. also also, === not ==\n. var i, otherwise it's a global.\n. Let's make this work more like toThrow where it'll set a message - https://github.com/jasmine/jasmine/blob/1_3_x/src/core/Matchers.js#L320-L346\n. Could maybe handle RegExps or just add a todo that it might be handy.\n. Nice catch, fixed.\n. We don't actually unmount in most of our tests. I think you could skip this, as well as appending container to the DOM (non of our tests do this, just having the node is good enough)\n. What if we actually use ES6 classes in our src? It gets compiled down to this and the ReactComponentBase.prototype.* = ...\nIt's not a big deal but could be nice to start doing.\n. Ah, sorry, I missed that.\n. That's fair. Not a big deal. We've gone the prototype route in the past too.\n. Lint is complaining about formatting in here. Let's fix that. It might be easier to actually just build and assign that value string outside of this, otherwise it'll get annoying to read.\nLet's also tweak this to match other cases (where we use ` to indicate a code value, like markdown):\n\nUnknown DOM property class (with value foo). Did you mean className?\n. elementInfo (is failing tests because of this)\n\nedit: also failing lint - the system works :)\n. enqueueCallback takes 2 args, the first being the instance... that no tests are failing is worrisome...\n. Also, would it make sense to just pass the callback through to enqueueReplaceProps (and family) as the last arg. We're just always checking for it in all of these cases anyway.\n. I think this is a case of where our JSDoc transform / test will fail and break hard. Please make sure these all match up.\n. I think we can leave out the parens since we're not using that matching group anywhere. But good call on making the regex a bit more robust with the space checks.\n. I know you're just copying the pattern from above, but let's make use of %s instead of doing the concats (we're going to fix the others up in #2941)\n. I think it might be better to call it something with warn in the name. assert has the connotation that an error will be thrown.\nAlso, I think you'll probably want @param {*} value (unless we're doing a validation before this). There's nothing actually stopping you from saying style={{foo: [1,2,3]}}\n. Let's indent like this instead:\njs\nvar internalKey =\n  '_reactInternal' + Math.random().toString().substr(2, 7);\nAlso, should we make it a CONSTANT (so it's a bit easier to one day switch ti using const)?\n. Should we say propType to match how it looks in code?\n. > at linked in\n. This change is actually going to throw off our line highlighting (see the things we have in the opening of the code block, should end up being {3-13, 16-19})\n. Our markdown parses uses that stuff between the curly braces to highlight lines - see http://facebook.github.io/react/docs/tutorial.html#adding-new-comments. It looks like this:\n\nSo by removing a line of code, we need to adjust the offsets, otherwise different lines will be highlighted.\n. This should be picking up Outer as the display name (the transform adds it).\n. Actually, this message doesn't make sense. You'll only ever call React.unmountComponentAtNode, never a component itself. I think we actually want to leave the beginning of this warning in place and do something like \"See the render method of %s.\" at the end.\nAlso, this isn't right in either of these cases. I believe this will refer to the global scope of the ReactMount module, not this inside of another component. I think you'll actually want to make use of ReactCurrentOwner.current.\n. Could you actually move these up so we keep ABC order in this block?\nAlternatively, we leave these two here and link to a separate doc where these 2 are mentioned.\n. Yes\n. Can you update this to be the BSD license we use now?\n. A few things.\n1. They're all components\n2. I'd really like to keep an if/else case in here just so people can see this pattern. Ternaries get super ugly beyond the simple, self-closing case. So let's talk about both in the text here, and have both examples.\n3. I don't like your formatting in the code block so I'll suggest something else (though I think this should stay an if/else and leave the other one as a ternary.\n4. cc @chenglou who might have some other thoughts on this page\njs\nvar loginInformation = isLoggedIn ?\n  <cite>Hello!</cite> :\n  <strong>Please log in</strong>;\n. Let's actually make this an fb.me link (fb.me/react-addons-classset?). That was we can update it whenever regardless of website changes. I think it'll fit on the previous line then too and we don't want more LOC :P\n. There's actually a zerowidth space at the beginning of this line which is tripping up jekyll. Can you re-save this file and make sure it goes away?\nYou can actually see this on GitHub too - the front matter here should get parsed into a table. Compare https://github.com/rickbeerendonk/react/blob/docs-conferences/docs/docs/videos.md and https://github.com/rickbeerendonk/react/blob/docs-conferences/docs/docs/conferences.md\n. No, but I had removed invariant (opened wrong file for a different error) and then forgot to revert the space too. I'll take it out so it's not distracting.\n. I know. I wasn't wild about it, but I didn't want to duplicate the same checks in enqueueCallback. I thought about adding another argument to getInternalInstanceReadyForUpdate but got \"clever\".\n. Do we want to be stricter and also warn for arrays?\n. Meh, make it as strict as you want.\n. We need some more tests here. What's the expected behavior when there is a defaultValue? What if defaultValue also changes? Should null and undefined behave differently?\nI commented in the issue for a bit more discussion before we make a final decision.\n. oops!\n. I started writing that. Grabbing all the values at once felt a little bit easier to explain (even if we wouldn't normally do that). I actually kind of like it better too, we don't create 3 more functions on every render. handle{A,B,C}Change is another option but that's gross too.\n. Can you revert these changes. This is intended (to match the formatting of the license as it appears in regular source files).\n. Hmm, can we skip specifying things specifically if we're linting everything? We can blacklist in .eslintignore\n. I actually don't like this change. What option resulted in this?\n. You use func above but leave this one inline. Any reason?\n. eslint didn't complain about not having a space before the {?\n. The below looks right as far as quotes go. Am I missing something?\n. Can we just use '.' then to pick up the root?\n. Just add global Buffer or whatever the escape is. It's dumb that node puts Buffer in the global but such is life. I'd rather the lint escape than write code that looks different from everybody else's.\n. Sure, but you created a func function and used that earlier to replace the exact same code block. Is there a reason you didn't make the above one an inline function declaration as well?\n. Please do. For the most part, the rules we have in src/.eslintrc are the ones we want everywhere (though I see we don't have that one - perhaps we should. We can do that later since this is already big).\n. Combine with above conditional? The only content in this block is the if. Do we foresee anything else coming in here?\n. These are fixable line-length warnings. Can you fix them?\n. Couple small style nits (can fixup later with anything else that might come):\n- 2 space indent (match the rest of the files)\n- spaces around operators (for (var i = 0; i < value.length; ++i))\n- use === and semicolons consistently. The line below this is missing the former. Line 28 the latter.\n. I've gotten flak for it before, but I like \"data\" as a mass noun using singular verbs\n\nThe data is made available\n\nI don't care that much, just one of those things\u2026\n. Note: you can use this fiddle to start from for latest React: http://jsfiddle.net/reactjs/ghmpo42k/ - that will use the latest builds from master instead of stable releases.\n. Yea, you're right. Also I'm going to make it a warning in DEV only so we aren't doing instanceof all the time.\n. > get closer to open source release\nget closer to the open source release\n. No need to put this in an if block :)\nEdit: No need to put the warning call inside the if block\n. It does as of #3206.\nEdit: let's not ignore all of vendor but be meaningful about what we do ignore.\n. Lint doesn't catch it but please remove this.\n. Yea, this change looks wrong. What lead you to believe this?\n. Or we can store this list of tags outside this function (like we do for omittedCloseTags)\n. ret is a bad variable name. Can we call it markup or something.\nEdit: Ah, I see we use ret above as well\u2026 I guess just leave it as is.\n. \"props object\" is singular.\n. > If this component's state update, ...\n\n\"state\" is singular, so \"updates\"\n... it won't actually get a new ReactElement\n\n\"it\" is ambiguous here. Since \"component's state\" is the last noun, it seems like you're referring to that (not the component, which is \"you\")\n. element.props\n. Might be worth mentioning that we only do this in __DEV__ and we may never actually do it in prod (or whatever your current thinking is there)\n. - Problem 1\n- Problem 2\n- Solution 1\n- Solution 2\nShould we maybe order these differently? I this one is related to the immutability bits, but it still feels weird to present things in this order.\n. > This is all adds\nLose the \"is\"\n. > It turns out that the cases where owners as part of state-semantics.\nThis isn't a sentence and I can't quite figure out what you intended to write. Double typo?\n\nIt turns out that there are cases where owners are part of state-semantics.\n\nMaybe?\n. > In React 0.12\nAnd earlier, back to launch. It might make sense to qualify that so it doesn't seem like we just never announced a feature that we're immediately deprecating.\n\nnor documented outside of Facebook\n\nThis actually isn't true, it's in the docs. http://facebook.github.io/react/docs/multiple-components.html#dynamic-children\n. Perhaps can say that we've had a warning for this for a while so you shouldn't be using numeric keys anyway.\nThere's also the fun old IE case with delete and reinsertion of an old key going to the old position in enumeration, not the end.\n. children, not x\n. > To differentiate ReactElements from one of these objects, we have to tag them with _isReactElement ~~which we wouldn\u2019t need to without this~~.\nDrop that 2nd part. If it feels too short now you can also qualify with another sentence. \"This is another issue preventing us from inlining ReactElements as object literals` or something.\n. Might not actually be worth quantifying that. You could instead say in the sentence this asterisk came from \"both for JSX and idiomatic uses of createElement/Factory\"\n. It might be good to have a lead in sentence to this list. Also, you can remove the newlines in between.\n. upgrading\n. This is actually different than what we have in the ES6 class above. Doing the string interpolation like this results in a single text child, where as what we do will result in 2.\nThe rest seems fine.\n. Can you actually make this key={index + itemText}? While what you have here silences the warning, it doesn't do anything differently so will still hit the same issue as if you excluded keys entirely.\n. childOwnerAddendum =\n. This isn't a sentence.\n. \"takes\"\n. Sebastian Markb\u00e5ge\nAlso, put the spaces outside the links (you do that twice).\n. Same note about moving the space outside the link.\n. Might be worth mentioning that this is next week\n. spaces\n. spaces\n. triple equals (time to enable lint here).\nAlso this comparison is actually wrong. The string would start with a hyphen.\n. These tests really don't belong here. We should just be testing hyphenateStyleName and the others directly. It's a weird situation because we don't have all of the existing tests for vendor/ in here though. I would still just make new test files there and we'll work it out later\u2026\n. This last bit is a bit confusing. Perhaps it's just the \"this may use an API such as\" after explaining that createFragment is the API.\n. \ud83d\udc4d I might still lose the x: in x:frag, though it doesn't really matter.\n. s/later/latter/\n. s/equivilent/equivalent/\n. Let's also reword this a little bit. I'd like the primary focus of this documentation to be on the simple object usage, since it is overwhelmingly what people will be doing. As is they sort of have equal footing.\n\nhere's the simple object usage...\n...\nIt's also possible to pass a function with the signature (...). This can be useful in some cases because of reasons and here's an example demonstrating reasons\n. Can you move the code into a block like you did above and put the body of the fn on a new line (also spaces around operators).\n\nOtherwise :thumbsup: \n. ref\nalso, don't say \"poke\". \"use\" would be fine.\n. I don't think encouraging people to put a DOM node into state is a good idea. If it exists in docs people will think it's a good pattern. Perhaps assigning to this._myElement\n. Well, step 2 is to use the return value in the function. Copy & pasting from above doesn't quite work here\n. But also, that whole bit about it not actually being a DOM node.\n(ps, the reason not to suggest setState is because doing that will cause a re-render. You don't need this ref to do the rendering)\n. Doesn't have a type, it's var args and can be an array, an element, a string, a number, a bool... which basically maps to ReactNode but that's not really a super well defined type, so meh. We already have it exactly like this for createElement\n. its optional.\nanyway, let's fix all of these as a whole. if you really want to do it now, do it and make sure it happens in all our API docs. But we won't change just this one - this fits with the rest.\n. I actually don't want any of these in here. It's pure noise and we'll forget to remove them if we change types. I do wish there was an option to eslint to ignore the long lines in comments - I would rather fork the rule and make that happen than have these in there.\n. Put the whole RHS on a single new line, that's prefereable to this (there's something similar elsewhere but it's not in src/ so I don't really care)\n. Please revert all of these. This is strictly worse IMO.\n. We don't need to do this right? (and we can remove mouseListenerNames)\n. But hgroup was dropped from the spec (which is why I never added it). But I guess if it's still supported, fine.\n. template strings yo\n. Meh, it doesn't matter too much anymore since React.createElement('hgroup') works\n. style nit: newlines between args\n. We should still test these somehow.\n. Can you move this up and maintain ABC order?\n. use-strict doesn't exist, perhaps use a real example\n. Overall this looks great!\nThe only thing I see being an issue is the locale id. Correct me if I'm wrong, but you probably want ja-JP. We already have zh-CN and #3240 adds ko-KR. Let's update and make sure the filenames, ids, and links are correct.\nI'm far from an expert here, I'd just like to make sure we're consistent.\n. 4 space indent? you monster.\n. I'm pretty sure this isn't going to work on Windows. I thought we were going to make this a js script that used node to shell out to jscodeshift?\n. style nit: 2 space indent, spaces around =, ,, after : in object literal.\n. More style:\nReact.render(\n  <JSX/>,\n  doc.gE...\n);\n. Lint is complaining because you have trailing spaces here. Otherwise this is good to go.\n. I was wondering about this step. Would it maybe make sense to just exclude these always? Then we intentionally check the right ones in when we ship a new release?\n. I don't know the difference between storing them here vs on Travis itself. I put the first few in here but this PR is mixing storage for new ones. Any reason?\n. Yea I do that (and only forgot that 1 time)\n. Bah, this probably should have stuck around internally. Oh well.\n. style: please move the || to the end of the previous line\n. style: single assignment per var\n. Might want to do {}.hasOwnProperty.bind(objB) (not that what you have is different than what we already have, but if we're here we might as well make sure we aren't hitting cases where people override hasOwnProperty)\n. Style: drop the length caching. We just removed that from everywhere else.\n. Didn't we intentionally change this to not throw to bring dev & prod behavior in line? (#2868)\n. This should be failing lint I thought (for violating theoretical \"block level\" scoping for i)\n. If you pull this out into a separate change, then I can take the rest to the stable branch.\n. Hmm, I'm not sure it'll matter too much. When I think about this, creating 1 bound function to reuse seems cheaper than making N calls using call which I assume ends up creating a new execution context on each call.\n. Hmm, this bit concerns me. We copy the properties from ReactCompositeComponent.Mixin once - won't those be the uninstrumented functions?\n. Do you know why we didn't do this in getInitialState?\n. statics\n. This should become BSD as well\n. Yea, that's allowed. Note, you can always view the rendered output on github, even in PRs.\n. Should we perhaps not say \"kriskowal's es5-shim\" (here and above)?\n. ohai, didn't make the connection to you when I was looking at the repo :) Fair enough. And of course, thanks!\n. I don't like the order of arguments here. If we're going to make this public we probably want some additional error messages (eg, if I call this method as a user without a parentComponent then we should hit an invariant).\nIf we make this an instance method it could have the same signature as React.render...\n. Can you try to reformat and fit in 80\n. You didn't address the first part of this. What about warnings when called directly without a parentComponent?\n. Note: parent is not an element\n. You forgot to call _renderSubtreeIntoContainer here\n. I don't think we shipped it to jstransform yet so no go, but\u2026 computed properties!\njs\nvar obj = { [propName]: propValue[i] };\n. You'll want to get rid of this\n. return the result\n. What happens if I call this twice in row? Or in the callback? is the inContextLifecyle flag going to be correct? My gut tells me that a nested render cycle is going to screw with that global state.\nFurther, what \"lifecycle method\" is this safe in? componentWillReceiveProps?\n. This is what's below in the comparison. I think the point of using an <li> here is to make it clear how you would do it with HTML elements before using composite components..\n. Ah true\n. It is for my branch, the last commit will be the one that bumps to 0.13.2 and then that gets tagged.\n. These are actually copy+paste from Twitter embeds, so I don't think we should make this change.\n. We should probably just make this a relative link (which is what we typically do, but can follow up later)\n. I'm fine with this change but we're not all going to remember to do this for all future posts so in all honesty it's probably a futile effort. The fact that https://www.youtube-nocookie.com/ is a (blank) 404 page. The Google results are laughable and none of them are Google mentioning their support for it.\n. At the beginning of this code block (and the others), we have some numbers in curly braces. We use this to highlight lines (which you can see on the website, and more info).\nYou're adding a line right in the middle of this range and probably outside the ranges in other code blocks. We need to make sure they're all update appropriately.\n. You da best :)\n. So\u2026 it looks like we don't have any tests that actually test using context :/\n. Please revert\n. You missed this\n. Do you need to bind this?\n. Don't make this unneccessary change. If you were making any other changes in this file, fine. But you're not.\n. And you run lint and fix all the cases in this file - you have a bunch of lines that are now going to be > 80 (it's just a warning but we'll get to a point where we're more strict and I'd rather try to catch them as they come in.\nSince we just care about this file ./node_modules/.bin/eslint  src/classic/types/ReactPropTypes.js should work.\n. I'm also not wild about parameter order now, it might be time to make these into a single object arg (though we'll break custom validators). Though this is safest for now.\n. Should we be validating ourselves on update? Seems like there's a potential for divergence where our initial render doesn't support an attribute but update does.\n. If we keep this we don't need the return value\n. Should this be in DOMPropertyOperations (where we keep the other code operating on node properties and attributes)\n. Yea, I think this probably all belongs in DOMPropertyOperations and should just be subsumed by createMarkupForProperty. It's not clear to me that we should even have an invariant here.\n. I understand the style but if we don't use it like that, there's no need to do it.\n. It's not a tradeoff of perf and code beauty. It's a tradeoff of perf and consistency. I don't like giving up perf but if we don't actually know what that cost is, I can't make a good argument for giving up consistency (if we check it ourselves and it's invalid then we probably actually saved time)\n. It's not the same. updatePropertyByID calls out to DOMPropertyOperations and doesn't touch the node itself.\n. Can you fix the whitespace changes?\n. Would it make sense to just combine this into createMarkupForProperty (and change the signature there)\n. nit: VALID_ATTRIBUTE_NAME_REGEX (use a \"space\" since it's 2 words, just like you camelCased validatedAttributeNameCache)\n. hasOwnProperty doesn't exist here\u2026\n. Fine. You win this round @sebmarkbage\u2026\n. We should make sure we support appear in the object as well.\n. We should perhaps write some tests to make sure these work :)\n. \"break down\" is actually correct here (\"breakdown\" is a noun). The rest here is fine.\n. I actually think this is pretty extraneous and awkward but wouldn't be opposed to linking to some definitive source on arrow functions.\n. I think I like this sentence as it was before. React isn't changing data (it is but that's not what is being discussed). The application is reacting to a change in the data it has (eg, props or state).\n. The perf hit can be pretty bad, especially at scale. We actually even mentioned this exact pattern for people who really want autobinding.\nNow that said, I don't think we need this example here right now. Let's keep this PR focused on grammar updates.\n. Would it make sense to move these typechecks into isValidElement? I don't know what impact that has in the long run (vaguely sounds like something we've talked about before)\n. So it is.\n. Good call.\n. Should we be expecting something?\n. Might be good to say something like \"See ___ for the list of available addons.\"\n. cc @cpojer who can probably answer this. I'm going to guess we don't want to change anything.\n. ReactWithAddons.js for the browser isn't going anywhere yet so we should probably make it clear that React.addons.{addon} exists there.\n. Not closure compiler advanced compatible :)\n. We don't have lint properly running in test files yet, but can you make sure these are converted to 2 spaces as well\n. And you make \"arrow functions\" the link, not just \"arrow\"\n. > However, there are a few cases, where it still might be necessary or beneficial.\nCan you remove the second comma (the one you added is fine)\n. > Although, in the example above, we rendered a list of items into ReactCSSTransitionGroup, the children of ReactCSSTransitionGroup can be one or zero items.\nI think this is actually worse and has way too many commas. I like this better:\n\nIn the example above we rendered a list of items into ReactCSSTransitionGroup. However, the children of ReactCSSTransitionGroup can also be one or zero items.\n. Please make links to our own docs relative from the root (/react/docs/advanced-performance.html). For the immutablejs link, please make it https and remove the #/\n. Let's revert this. Sure it's probably technically a collection of algorithms but when used together we can generally use the singular.\n. > This approach is pretty expensive, in terms of performance, and it doesn't scale as we would have to write different deep equality code for each model.\n\nI actually read this sentence much more like it was originally written, though I do pause at the \"and\". Let's lost that first comma.\n. > It's easy to see how your UI is updated and where to make changes since React's one-way data flow (also called one-way binding).\nThis isn't a complete sentence.\nLet's leave it mostly as it was but split it into 2 sentences (I just removed \"since\" and added a period):\n\nIt's easy to see how your UI is updated and where to make changes since there's nothing complicated going on. React's one-way data flow (also called one-way binding) keeps everything modular, easy to reason about, and fast.\n. It's subtle but I think this was more correct as written. The other components need the data in the hierarchy. The single component above doesn't.\n. I think this sounds better as it was.\n. > Learn more about why use React ...\n\nWe need the \"to\" in there. Please revert.\n. I don't think an object spec like this is even valid jsdoc so it probably doesn't matter.\n. Yea, let's remove it.\n. This should be functions, not function.\n. You didn't revert this part entirely. The components are the ones that need the state so it should be \"need\"\n. nit: abc sort the requires (there's no lint rule for this)\n. 2 things here.\n1. isIEInputEvent\n2. Put the && at the end of the previous lines and then let's wrap the whole return in parens\njs\nreturn (\n  'documentMode' in document &&\n  document.documentMode > 9 &&\n  etc\n)\nAnd now actually a 3rd since I'm looking. We can cache the value of 'documentMode' in document && document.documentMode > 9 so that we don't need to look it up each time (any access of DOM properties has a cost).\n. nit: remove space after opening paren\n. ... or the prop ...\n. At the initial mount,\nHowever,\nBoth of these should have commas\n. \"was added\" (less passive voice :) ).\n\"To maintain backwards compatability, the default...\"\n. We should put this whole block inside an if (__DEV__) block so that it's stripped out in prod.\nThe other thing we should consider is that we really shouldn't check this on every top level render. With the exception of iframes, once we confirm that document.body is there we don't ever need to do the expensive part of this (accessing the DOM).\n. Since you're touching this, want to also add a link to follow the \"official\" @reactjs?\n. Yea, I thought about it but couldn't find anything that actually said it was the same (without looking at src)\n. It was really useful in the early days, not so much anymore.\n. https://www.npmjs.com/package/babel is devoid of anything useful :/\n. I was just testing this and it appears that we must use get/setAttribute. With null here we'll use the property which doesn't seem to work.\nDid you test your local build?\n. Looks like it's not super well supported, might be safer to go with attributes for now. The important thing to test is that updates work. Initial render will generate the right HTML either way but updates use DOM APIs.\nI tested this a bit:\nFirefox seems to support it either way:\n\nChrome not so much:\n\n. The lint error is because you inadvertently removed a param here (propFullName)\nEdit: and that's actually why the test is failing too (not sure why it doesn't fail in jest but that's ok).\n. Old yes, sketchy no. I would clarify and just say \"engines that don't support setters\"\n. This is the wrong check. We aren't using Phantom when we run these with grunt test --debug. We shouldn't require it in any case where we're in a real browser (I think we have some other test like this but I can't find it at the moment, perhaps just checking if jest is defined would work)\n. No, that's why we're loading it in test/index.html\n. space after if\n. Can you revert the changes to this file, we only update this on official releases.\n. Unfortunately the .lock file is built from the Gemfile so this might cause issues for others. I hate nokogiri so, sorry for the troubles.\n. Nit: comment above\n. In a followup, let's stop enforcing this (and maybe do the opposite). This does get transformed correctly now.\n. We'll prefer a newline before splitting like this (except in cases where we're chaining) if it fits in 80. Let's just do that.\njs\n    var dependencies = \n      EventPluginRegistry.registrationNameDependencies[registrationName];\n. Nit: can you actually mention why it's disabled and not just link to a PR which has a lot of unrelated discussion.\n. Might be worth just saving the value of nodeName.toUpperCase() so we only call it once (same in the last 2 case below)\n. Any difference between true and false here? If not let's be consistent (I don't care what the value is if it works)\n. Eh, not sure how I feel about this. I don't have a good alternative though\n. We already don't run the tests internally. But we still lint internally and I wouldn't be surprised if we end up choking on let. Regardless though, let's not introduce the first let here.\n. I'm leaning more and more towards a custom line-length rule (ignore length on it lines and docblocks). The ideal case is what Ben said where we only show the output for \"changed\" sections of code, perhaps we'll get there.\nFor now I don't think we should go out of our way to fix line length but fixing some along the way is fine.\n. I think our style leans a bit more towards\njs\n    expect(console.error.argsForCall[0][0]).toBe(\n      'Warning: Failed propType: num must be 5!'\n    );\n. Can you revert this file (it actually does end up as double quotes because babel)\n. Ah no, I just didn't realize there was a difference. I might have known back when I first did this (I think there's a test that toggles __DEV__)\n. If we find ourselves needing the rule disabled for other cases let's do that but the single case disable is fine. I don't care how we do it - either is fine by me.\n. Our style guide actually says the opposite for these and we (usually) only wrap with parens at return statements. Might be worth forking the rule or seeing if we can get an option added upstream.\n. nit: move comment to own line above\n. Make the it something more descriptive\n. containnig\n. Can we make this just use JSX?\n. It's always returning a string\n. Combine these conditions?\n. It looks like you reverted the wrong thing. The changes in src/ are appropriate. The change in docs/ (the file we're commenting in right now) is not.\n. I think we probably want this in a __DEV__ block so we aren't doing extra startup work in prod (it might get dead code eliminated but not certain)\n. Nit: newline between args\n. Move these into a beforeEach\n. Let's return early if it's not warning or invariant instead of nesting the rest of the code in an if block.\n. Let's try to make this a little clearer and mention the substitutions in here. As is, it might be unclear about why number of arguments is wrong.\n. Let's reverse this line and the one before it (so \"no-op\" comes first)\n. A few things:\n- Let's make this a blockquote with \"Note:\" on its own line. This is the pattern we use elsewhere.\n- We should link to http://facebook.github.io/react/docs/reusable-components.html#es6-classes (but it should not include the facebook.github.io, just the /react/...)\n- I actually think it might be easier to just include a link there and not go into the details here (for now).\n- Let's try something like this:\n\nNote:\nIt is also possible to use plain JavaScript classes as component classes. These classes can implement most of the same methods, though there are some differences. For more information about these differences, please read our documentation about ES6 classes.\n. We could probably simplify this entirely and do ('' + instClassName).split(/\\s/).indexOf(className).\n. Can you please link to the documentation (I provided it in the comment in the other PR) and not the blog post?\n. Can you revert this file? We only check this in on releases.\n. Double check this. This isn't the text of the warning.\n. Can you split this differently?\n\njs\n    var renderedComponent = ReactTestUtils.renderIntoDocument(\n      <div>Hello <span className={`x\n      y`}>Jim</span></div>\n    );\n. nit: please remove this empty line\n. I was actually thinking of deleting that. It's going to warn once per method call, which I thought was too much. deprecated is also pretty inflexible.\nI could make it\njs\ndeprecated('require(\"react\")', name, 'require(\"react-dom\")', name, ReactDOMClient, ReactDOMClient[name])\nBut then we couldn't customize the message with an fb.me link (which I think we should have).\n. lint wants a trailing comma here\u2026 not really my favorite style but we did it so let's stick with it and maybe revisit that dangle rule later.\n. We should leave this with {{site.react_version}} in there. That ensures we don't need to update this page for every release.\n. Probably don't need to bind this (no this unsed in transformer)\n. Ah, sorry! I missed this comment. Let's skip the test for now. Just make sure appear works and this should be good to go.\n. 2 things here. 1 important and the other nitpicky\u2026\n1. The important piece: please copy to js, not _js. We don't want to run the file through babel afterwards :). The less important piece, it might be good to make this a separate rake task but I don't care so much as long as the release task works. I think we'll want to end up checking in the final file, we do now for React and JSXTransformer. cc @spicyj \n2.  Can we name the file babel-browser.min.js?\n. :thumbsup:\n. (No, it'll take any files as long as the token is right)\n. Bah, I caught it and fixed it but forgot to save the file :(\n. ,\n. Want to add one of these testamajiggers for the addendum?\n. so you do\n. You reviewed it :wink:\nI remember us saying that it also wasn't really harmful to call setState after unmounting. It might be indicative of a leak but that's what the warning is for for. I think the biggest argument is Promises. fetch(url).then((result) => {this.setState({data: result})})\nIf we don't want people having to check isMounted first, then we needed to make this safe.\n. Yea, please use JSX and put all the JS together instead of in 2 script tags.\nAlso, this should be index.html (lowercase).\nAlso also, I'd prefer if you squashed commits but not a huge deal if you don't know how.\n. Do we need to typecast this to make TypeScript happy?\n. Perhaps mention using spyOn explicitly?\nAlso, this isn't getting used by jest. That's not ideal but it's fine for now.\n. Please maintain ABC order here\n. The tutorial is broken into steps with file names to match (eg tutorial13.js would not actually be named that on disk, just used to indicate the step of the tutorial). Honestly we could probably get rid of those comments entirely.\n. Let's stick to using argsForCall here instead of using that and calls[].args[]. I think argsForCall[0][0] will be what you want.\n. Do we want to warn on every call? Typically we try to scope this so that we don't warn on every call to render, which could be really noisy. In some cases we scope to the parent/owner, others to a single deprecation overall.\n. Instead of special casing the /, we can just take advantage of regular expression matches in replace (also I don't think we want to add the space before /> anyway)\njs\n    return markup.replace(\n      /\\/?>/,\n      ' ' + ReactMarkupChecksum.CHECKSUM_ATTR_NAME + '=\"' + checksum + '\"$&'\n    );\n. Better, but can you turn this comment into a complete thought.\n. This isn't in a dev block and yes it should be an invariant. The message makes it pretty clear that React probably breaks when rendering to the document element with content that doesn't checksum.\nWe have a dev block lower for the warning. We could perhaps have a more concise difference there.\n. Need to bump this if you're adding a line so that the correct line stays highlighted.\n. The 7 should become an 8. We use the {7} to highlight a line in the generated markup (see it in action @ http://facebook.github.io/react/docs/tutorial.html#adding-markdown)\n. Looks like something did sneak in. I'll clean it up and merge.\n\n. style nit, match where we have &&\n. You could probably just make this expect(willUpdates.slice()).toEqual(desiredWillUpdates). That will create a new array so that emptying out the original should be ok.\n. Formatting feels off here. Can we assign owner before the invariant call and use that (can also use a template string instead of concatting the getName(), it'll fit on 1 line when we have owner)\n. 2 things:\n1. Can probably just depend on the JSX transform adding displayName\n2. Let's move the component definition out of the expect closure and just leave the part that we actually expect to throw in.\n. Please put this up with the other non-SVG properties\n. Thanks, now can you get rid of this extraneous line and squash to a single commit?\n. This should go at the top of the list (the rest are in ABC order)\n. Sounds good. The only part about this that I'm not wild about is \"updating your component's props\", which can be read to imply that you can set this.props.foo. It's almost not worth mentioning props at all for forceUpdate, we've seen very few issues as a result of props being the same reference (and that really would require further explanation). Overwhelmingly the issue comes up with modifying this.state directly so we should probably focus on that (and keep the \"other data bit too\").\n. :thumbsup: Let's go with the former.\n. Sure\n. Can we leave this as \"prop\" (makes it clear we're talking about props and not arbitrary properties)\n. Style nit: please put the /> on a new line indented to match the opening < (that's our style and should be what we've done elsewhere in the docs).\n. Again, \"prop\"\n. I think we need to add SET_MARKUP to ReactMultiChildUpdateTypes :wink:\n. \"An\" uncontrolled component \u2026\n. I think this is only needed if you're reading directly from the node anywhere (like in event handler or after), as opposed to reading from event.target.value (which is what the previous example code was assuming).\nI generally think that doing expect(something about dom node) isn't really the default case and we should instead mention that as an aside. I'd rather we kept what we had and then call out separately that Simulate does not change the DOM node, so if your event handler or other code reads directly from the DOM you need to make that change separately.\n. We have a requestAnimationFrame module which we should probably use instead (that falls back to a setTimeout though, so you might just want nativeRequestAnimationFrame)\n. queueClass calls setTimeout (I think in an attempt to make sure we group changes together) so now we're asyncing twice in a row with a non-trivial chance that this change is not batched with the previous one (which might actually be the problem). TICK is set to 17ms which is almost like \"do right after next animation frame\".\nIt might be that we just want to use requestAnimationFrame in queueClass (and do the same timeoutid tracking/clearing).\nI don't really know though, I haven't written any of this. It just feels weird to requestAnimationFrame -> setTimeout, feels like too many of the hacks done to get around mysterious issues with async code.\n. I don't think so. My ~/.babel.json doesn't get touched so I'm pretty sure that's not doing something we're not expecting.\n. :thumbsup:\n. Seems fine but can you remove the \\* bit?\n. Ohh, I see. I think it's better to leave out the footnote demarkation. The content reads well flowing into the next block without it.\n. Way ahead of you. There are reasons it's not and we'll work them out.\n. Can you just use getDeclarationErrorAddendum here. That will wrap up the _owner stuff and get the name.\n. Dev and prod should remain the same - we shouldn't throw in only 1 environment.\n. Shouold probably keep this ABC order too\n. Add %s into the string here, then pass getDecl..() as a 3rd argument.\n. This path doesn't look like what would happen for a real event.\n. This does seem to be in line with what we do in the non-path case. Let's do it.\n(tangent) I'd like to revisit some of this. I don't think the path case behaves the same as the non-path case in other ways, namely it looks like we fire events as we traverse here. The non-path case builds up the ancestors array, then fires them all (there's a comment about why, which sounds right). We can probably reduce the complexity a bit here and instead of having 2 functions that fire events, have the 2 functions collect the nodes that need to have the event fired, then fire them in the same place. Basically the bookkeeping object should be identical between browsers.\n. Nit: let's keep keys abc order\n. Don't need to use html entities, can just put the actual \u2014 in there. But to be nitpicky, I think an em dash is wrong here. You split the thought with a comma and rejoin with the dash. One or the other :)\n. s/chrome/Chrome/ (proper noun). Ditto with \"blink\" above. Also later with \"react\"\n. \"first React.js conference\" sounds like it was the first ever. Could you qualify that? \"first conference on European soil\" or even just take their title \"first React.js European conference\"\n. These are all getting cropped. When I go to youtube and select 650 as a width, it tells me 366. Let's update them so we aren't cropping anybody.\n. Let's thank all the people involved (organizers, speakers, attendees). It really wouldn't have been possible with all the people from the community who made it happen.\n. s/Youtube/YouTube/\n. Why does Elie not get any more text?\n. %s should be at the end of the string.\n. Please leave the closing paren on its own line.\n. You still have a leading space inside the text which doesn't belong. But do we really need this new sentence? I don't think it really adds anything and with the addendum we'll say to check the render method of a component.\n. Don't put a space before %s. If you look at what getDeclarationErrorAddendum is doing, it prefixes with a space.\n. s/&amp;/&/\n. Can make the above an else if and then the else stays the same (and we avoid nested conditional logic)\n. Please revert this, this file is the release version of 0.13.3 and should not get modified directly.\n. Maybe this?\n\"Performs a shallow merge of nextState into the current state.\"\n. I just did a quick test - looks like this can be set with a property or attribute, so let's make this null to retain option value (MUST_USE_* denotes that only 1 way of setting the value is possible so we can't use the other even if it's faster).\nPS, thanks for jumping on this quickly :)\n. How is this not throwing when props[propName] === null?\n. Oh right, null doesn't actually come into this check because it does the isRequired check first.\n. If the value is Object.create(null), then we'll throw here. We should guard against that.\n. \"rendered\" isn't a good term to use here. \"rendered\" typically means it's in the DOM and that's not what actually happens with functions. It has been passed down in props, so we could say something more like that (I'd prefer we use \"props\" over \"properties\" to make it clear that's how it works in React).\n. I think in the cases where we've labeled args like this, we've done it after, not before (though I could be wrong, not sure if we actually have any in React).\n. Nice cleanup\u2026\n. ReactDOMTextArea is the only thing left using ReactDOMComponent.BackendIDOperations - should we update that while we're here and remove the injection?\n. I don't think this is actually used\u2026\n. Actually, I wonder if that's true for a number of things in here now that it's not being injected.\n. Hey, you asked me for this review, just doing my job. You didn't think I'd just stamp this did you? \ud83d\ude1d\nNow if you hadn't changed this method at all, it probably would have slipped past.\n. Please just leave the beginning of this message as it was. We really just need the addendum.\n. The addendum will start with a space, you should not be adding one yourself here.\n. Please add a new test confirming that the addendum is actually added when you expect it to be.\n. That's a good idea\n. Let's leave it as 2 sentences and just change the end.\n\nIn addition, you can use the #reactjs hashtag to see what others are saying or add to the conversation.\n. Did lint really not warn about this?\n. Nit: please remove the space between ] and ( (just in case we switch to a different markdown processor that doesn't handle that)\n. Yea I saw, was just surprised. Turns out I totally missed part of the ESLint migration to 1.0 guide (where they dropped having a default config enabled). #4746 will handle that.\n. We can probably just make this fb.me/react-devtools-firefox (and then change the Chrome one to fb.me/react-devtools-chrome.\n\nMaybe eventually we'll add a dedicated devtools section of the site and we can just point everybody there.\n. We need to set up the links on our end, then they'll work :). We would make the firefox one point to AMO just like the chrome one would point continue point at the web store. The goal was to keep them short and similar and under our control so we could change the destination if we needed (same reason all of our warning links also use fb.me)\n. Should be minLength. But that's ok, we always update this list on release and we'll do it again.\n. Are you sure it's not the word we're looking for here? (ew)\n. Can you fix the code piece a bit here to remove the extraneous whitespace (around the parens) and put a space before the opening backtick?\n. What's with indenting paragraphs?\n. s/it's/it has/\n. Do we want to use h4?\n. > have been deprecated\nMaybe link to the deprecation post?\n. createFragment for better formatting\n. relative link?\n. classSet did and I thought we did for using createFragment as well\u2026\n. More code formatting\n. Oh I misread. It's quite clear on a 2nd read.\n. Oh that's a giant list\u2026 that was hard to see in the diff. I guess that's ok (and then you can ignore the h4 comment).\n. Is this supposed to work? Seems like this is the case we explicitly don't want to work (in the ideal case anyway).\nI was giving node v4 a try where Symbol exists and this fails because $$typeof gets removed when stringifying.\n. Ok, just so I know, all of these tests here are explicitly for an environment where we don't have a native Symbol. In that case we expect React.isValidElement(JSON.parse(JSON.stringify(element))) to be true.\nBUT if we do have a native Symbol (and weren't deleting it properly), then we would not expect this test to pass?\n. You can pass a regex to toThrow to match.\n. 0xeac7 sorta kinda looks like React\n. I'm fairly certain support for this was already removed in 0.13 and it's no longer \"in a future release\". I think we should just change this to 0.13 and call it a day. cc @spicyj \n. Ah yea, I still see that in 0.13. Let's just make it 0.14 then @jw-00000.\n. @cpojer Because I added it here.\nIt was unclear to me if using var in environment would be in the global scope but there was no question about using this config.\n. \ud83d\udc4d I thought I might.\n. global === window? I'm happy to do that and would prefer the explicitness. The initial reason I moved it here was that my babel dev transform was trying to transform this and the quickest fix was to just move the definition.\n. We use '' + whatever in other places. I don't think it really matters since both trigger whatever.toString() but might be good to be consistent.\n. Nothing I just wanted prettier HTML. Comparing styling now though, looks like leaving as purely pre will be better.\n. Yea, I think you're looking for #4846 (which I apparently missed that you had already accepted\u2026)\n. Uh yea, that would be a bit clearer\n. Oh I guess we were already doing this measureMethods call and now we just have more.\n. Can you add an empty line above this\n. And probably just remove these references. It's not super useful since you already explained the reason.\n. > Normally this isn't an issue, since stateless functions do not provide an imperative API, there really isn't much you could do with an instance anyway.\nThis doesn't parse as a sentence to me. Maybe split into 2 sentences at the first comma?\n. > In most cases, this is ideally unnecessary (and should be avoided) because the reactive data flow always ensures that the most recent props are sent to each child that is output from render().\nThere are a lot of words in there.\n\nIn most cases this is unnecessary because \u2026\n\nAlso, maybe put render() in backticks since you did in the previous sentence.\n. Nit: \"Not\" to be confused\nReact.render \u2192 ReactDOM.render() ? Or I guess we can do the transition to ReactDOM.render with everything else\n. js\n. Is it \"very\" special or just special?\nRead: I don't really like the use of \"very\" here.\n. > Note that\u2026 Note that\u2026\nMakes for an awkward paragraph. Maybe \"Also note\u2026\"\nAlso, should these be the blockquote Note: format?\nAlso also, you have whitespace at the beginning of this paragraph (and the one below it).\n. Yes\n. Actually this should just be ref=\"myTextInput\" since we're talking about string refs.\n. You call focus() on the DOM node directly, not the component.\n. May as well be consistent with above where you use the full API: React.findDOMNode()\n. null \u2192 null\n. Super nit (that I shouldn't actually care much about but that tiny bit of OCD in my brain decided to notice): the rest of our docs uses a single space after periods in a sentence. You used 2 (and not entirely consistently at that). I'm sure you'll ignore this and that's fine.\n. nit: leading whitespace is still here (and in the next paragraph, and the one after that\u2026 and the one after that but you didn't add that)\n. It's perfectly scrutable\u2026 you just need to be wearing your monocle.\n. super nit: can you use double quotes here (consistent with the rest of our style)\n. Why did you change these? They're currently used for line highlighting.\n. I made it up :) http://zpao.com/posts/adding-line-highlights-to-markdown-code-fences/\nAs for why\u2026 it's usually to highlight a specific change or something important - that's the main way we use it in the tutorial. Most of the uses in here\u2026 not actually that valuable. The first on the page one is probably the most valuable since it's a larger code block.\n. I guess we know here that this is \"script\" so we probably could just hard code that string. Otherwise, template strings?\n. \u2026 yea, it is. oops\n. Yea but I figured the people doing this (me and you) are smart enough to know that. This isn't meant to be a complete step by step but a gentle reminder\n. This formatting doesn't match our style, see any other warning or invariant callsite for examples.\nAlso, please remove the empty line above the condition.\nEdit: further details on formatting long strings like this: blank space should go at the end of the preceding line.\njs\n'foo bar. ' +\n'baz'\n. Is this indented 3 spaces? How is lint not catching that\u2026\n. Please use GitHub usernames as the keys here\n. [] and fix the indentation please\n. Can you revert this file, this should only get updated on releases.\n. Actually, this shouldn't have become a link. I'll fix that.\nEdit: done - https://github.com/facebook/react/commit/e12ee95e09dff09a6b205d84c4efde91cc5e6213\n. I actually prefer the whitespace - code needs to breathe. Let's leave this.\n. Can you leave this line indented please?\n. Let's change the other ones :)\n. Yes please.\n. Let's do a test here to make sure this still works. It likely wouldn't have been an issue and thrown in IE8 before since this is for HTML5 audio/video.\n. Ugh I hate nested ternaries \ud83d\ude22\n. To get past the closure compiler issue you can use var CHILDREN = keyOf({children: null}) and then use that in place of the string literal.\nThat's the safest thing, though children might actually be in the DOM externs.\n. Can we just .bind(publicInst)?\n. !== (looks like we might have relaxed that when switching to fbjs lint rules)\n@spicyj's long line length detector is slipping\u2026\n. === and use CHILDREN\n. nit: Want to put CHILDREN with STYLE. And actually if you rebase, you'll pick up the new one here also using keyof, would be good to have the group of them together\n. Let's just use class syntax. We transform our tests.\n. Can we use path APIs to do this without having to do it manually? Eg path.normalize (no idea if it works, just that it exists). Might be able to swing that for the regexp too (eg new RegExp(path.join('/', '(?:React|ReactDOM)(?:\\.d)?\\.ts$'))\n. If we switched over entirely to gulp today this would actually cause issues. It won't right now because the only place that uses it will never get used in a sequence (the major version number change here was actually important). Let's leave this.\nThe rest looks like it should be fine. We'll make other major changes as one-offs (eg, switching to babel@6)\n. Want to just delete this while you're in here. I think I missed that in a rebase a couple months ago\u2026\n. I don't think you can do this since the actual task is compare_size and the way grunt works is that it matches the config name up with the task of the same name. Does the task still work for you?\n. Let's just remove the comment or move it outside the function call.\n. Can we revert this whole file? We have the same thing in the quadratic example, both working under the assumption that you run python ... from the directory where the file is. We'll overhaul the example sometime soon so these are better and more consistent, but let's not make them more inconsistent in the meantime.\n. Please remove this and just add it to the inline instructions in index.html\n. And then we don't need this change, so please remove it as well.\n. This message isn't awesome. You're actually trying to say that the component author wrote a bad propType spec, but the way this error will show sounds like the user provided an invalid prop value. Can we tune it so that's more clear?\n. Good idea, will do.\n. 3 calls that all do the same thing\u2026 yay JS!\n. Correct.\n. Oh right, the shared bits. Yea, that's fine then.\n. However, the DOM node (which is what is getting stored) is never used in render so it doesn't really belong in state. DOM nodes in general probably don't belong in state. I would recommend doing it is already done here. In fact if you call setState you'll get stuck in an infinite loop (or do we not call the ref callback on each render?)\n. We can skip the creation of the .babelrc file to cut out a step and just put babel --presets react example.js --out-dir=build\n. I know this is a lot of lines but its our style and I think we should use it so we're consistent with the rest of our code samples.\njs\n<input\n  type=\"text\"\n  placeholder=\"Your name\"\n  value={this.state.author}\n  onChange={this.handleChange}\n/>\n. This won't work - JSXTransformer doesn't exist anymore.\n. ReactDOM\n. Small nit to match the rest of our code: single quotes and spaces around operators\n. AFter reading this again\u2026 how would you feel about using an actual attribute value instead of innerHTML? innerHTML is going to be somewhat fragile, especially in the React world with strings like you're doing - eg ReactDOM.render(<x-search>foo {someVar}</x-search>) which will end up with spans in the html.\n. also super tiny nit but it's noisy: drop the &btnI query param (and in the example) - there's zero reason to have it (sorry for not seeing it earlier)\n. Since this is the example I keep using, let's work through it.\n1. We put if (__DEV__) { warning(false, 'Some message here') }\n2. Continue returning a chainable type checker (because isRequired can still be added).\n3. We can perhaps just make it so that we pass it an empty function in or we keep it returning an error but we change that message to make it clear that this prop failure can be ignored if you are not the component author. I'm leaning towards the former right this second (because it's not terribly useful to have to work past a failure you aren't responsible for).\n. Don't try catch this. Use spyOn (we do this a bunch and already do it inside the proptypes test)\n. Can you double (triple?) check this by putting some invalid type info into jest.d.ts? I want to make sure tests still fail in that case. I remember having some issues in the past when I tried to upgrade TS to 1.5.\n. Yea, I gave up and just left it. Since our use is so minimal, I think the only real win we would get from upgrading is being able to use JSX\n. Yup, this is fine as is. We are not planning on making these properties condoned in any public use. They are subject to breaking (and I might just change them in the next release to ensure this does break)\n. Could you make this 27 (to catch the closing </form> tag (it's already messed up on the site so not your fault)\n. You don't use this anywhere\u2026 is the thinking that this would be used in RN?\n. https://developer.mozilla.org/en-US/docs/Web/API/Node/nodeName indicates that nodeName should be 'html' for XHTML docs but that doesn't appear to be true in practice (for several years, the linked article there is from 2009) so this is probably safe.\n. This change is fine but is unrelated to the rest of your description. This is for the id attribute and will never render to <span>\n. We don't use Kramdown, we use Redcarpet. The header generation is done in a custom plugin (https://github.com/facebook/react/blob/master/docs/_plugins/header_links.rb) which is pretty naive (only supports a small number of characters).\nWhen making changes like this, please run the server and ensure they work. This change won't work (as @marocchino said) without also changing how we generate the header links.\n. Nah, we have no intention of null and empty string being the same. They are very different values. In this case the empty string will create markup with <div id=\"\"> whereas null will be <div>. While it might not matter for ids, it's not a safe assumption that all attributes will treat those 2 cases the same.\nAnyway, I'll take this since the change is good. Thanks!\n. This is fine but I'd like to tweak the wording slightly to include some definite articles.\n\n... install the es2015 preset,\n\nAnd then the same for the plugin.\nWe'll make this easier though either by publishing our own preset or taking over the react preset so it includes this. In the mean time we should do this. We've just gone ahead and update our other docs for Babel 6 so I think we'll just continue down that route and not mention Babel 5 anymore.\n. No need to do this, spies are mock functions. And no need to assign to a temporary variable and back - spies are cleaned up automatically. Here's a complete & short example usage: https://github.com/facebook/react/blob/master/src/addons/tests/ReactFragment-test.js#L93-L100\n. Please move this require under getIteratorFn (style isn't totally obvious here, sorry)\n. Let's cleanup the mocking here as I described earlier.\n. A couple changes. First, let's change the 2nd sentence here.\n\nThis requires a script tag in your head (which we have already included in the React playground):\n\nLet's just make that:\n\nWe already included this library with the original markup for the page, so we can just start using it.\n\nAnd then let's get rid of this whole HTML code block below. It's just noise since the script is already there.\n. Then we can just put this sentence into the preceding paragraph since they are both super short and flow pretty well.\n. I think I threw up a little bit reading these 4 lines\n. Can we leave in the piece that says it's not available on ES6 classes to avoid potential confusion?\n\nThis method is deprecated and will be removed soon. It is not available on ES6 class components \u2026\n. Note: now that we're not using properties, can you remove the entries in the DOMPropertyNames mapping below. We do not need to add them to the DOMAttributeNames mapping.\n. We have this exact line just below here (though it's in the browserify block). Is that what you intended?\n\nAs a side note, we could definitely make this section a little clearer, adding a shared dependency section (eg installing react-dom) and then a section with specific instructions for browserify and another for browserify.\n. Super delayed response from me, sorry. I need to do better with my email management\u2026\nA couple comments here that I'll probably followup with a PR for.\n1. Being reserved words was definitely a consideration at the time (could always transform to string keys), but was not the primary reason. The main reason was that className and htmlFor aligned with the JS API. In hindsight\u2026 well it was probably a mistake but I think we're probably too far gone down this path.\n2. I'd rather link to something a bit more known, so I'm going to link to MDN - https://developer.mozilla.org/en-US/docs/Web/HTML/Element\n3. I'll probably add a tiny addendum about the fact that DOM APIs don't make sense for custom elements, so we pass all attributes along directly.\n. I don't think you meant to include this - it's part of the paragraph above.\n. This is actually a quote, which I don't think we should take license to correct.\n. This is third-party code, which I don't think we should modify (you can submit a PR to them to fix it https://github.com/codemirror/CodeMirror/blob/master/lib/codemirror.css#L168)\n. Let's apply our coding standards to our code blocks :)\njs\nif (this.isMounted) {\n  this.setState({...});\n}\nThe other thing I would do is not put that inline comment in there. You haven't really given the setup to say that this is bad. You've merely described a pattern of code.\n. What other uses are there? You say most\u2026 which uses aren't erroneous?\n. Why? Isn't this the exact same thing except now a component itself becomes responsible for maintaining what React already knows? I would call a spade a spade and say that this isn't actually any better.\n. What if I'm not using promises? Why don't we include a suggest solution for the people not using promises? Perhaps one of the most common instances of this is with Flux - maybe we should have a quick example of tracking the subscriptions and removing them.\n. The whole article is about setState and isMounted. Maybe we use that instead of setTimeout?\n. Where does s/he define this? Can we link to that and not just the user page on github?\n. This code is great at needing to be carefully read to understand. Can we write it out more explicitly? Ideally we avoid the implicit return.\nEdit: or do we need the implicit return for the promise chain\u2026\n. But why do I need to migrate? You haven't said that isMounted is getting deprecated. You've only called it an antipattern.\n. I'm not convinced this is less confusing. You're linking to a profile page. When I read that I was expecting to see his/her implementation.\n. What's the point of this post? Are you discussing why isMounted is an antipattern and some alternative ways to achieve the same result? Are you deprecating isMounted and discussing alternatives? Are you sharing a way to make promises cancelable. I see all 3 of these coming through, but no clear purpose of the post.\nIf your target audience is everybody, then I think you need a little bit more to give everybody something to relate to. We don't want people to dismiss the content because half the page is taken up by a block of code for Promises.\nYou can say \"trivial\" all you want but it's important to remember that this stuff isn't immediately obvious to everybody.\n. s/flux datastore/Flux store/\n. Don't forget to update this link too.\n. No because that would be invalid JSON and npm would not be very happy with that \ud83d\ude1b Maybe one day we'll get a better JSON and we can add them in.\n. delete newProps.valueLink (and yes, newProps)\n. Please revert this and the other change here. It looks intentional, though it's still not great formatting when rendered (I'd rather leave it and fix separately). I'm guessing this is just a result of saving in your editor. I encourage you to install a plugin that supports the editorconfig file we have which overrides that built-in behavior (http://editorconfig.org/#download)\n. This is unnecessary for the en-US pages.\n. Please either revert or ensure that when you delete the newline, you put a space in (you need one after the comma).\n. This should be \"rendr\" - it's in reference to https://github.com/rendrjs/rendr\n. nit: 2 space indent (you have a couple of this exact 2 lines doing the same thing - maybe have a helper method?)\n. fun story - at Mozilla we had tests randomly start breaking one day and it took us a while to figure out that it was because we had a test trying to load a remote image which no longer existed. I don't expect that to happen here but I wanted to call it out just in case I'm long gone and it does happen. Also, we already have a test with this exact svg image so meh.\n. Let's just make this main.js since that what we called the code above and put in the browserify example\n. Agreed with @andreypopp & @gaearon \n. We'll need to make sure we have whitespace surrounding code fences otherwise this gets dropped inline (I encourage you to run our site locally to ensure it looks right - directions are in the readme in the docs folder).\n. Ok, let's just leave it as is then \ud83d\udc4d\n. @gaearon If we go with this for this page, do you have a recommendation to address your comment about dev/prod? (https://github.com/facebook/react/pull/5685#issuecomment-166993556)\n. Clever way to achieve this.\n. I actually think this is correct and that we're referencing - \"all the components that need the state\".\n. also type=\"radio\"\n. Let's never say \"newbies\" again?\n. \"only possible solution\" isn't really fair. If you look at how Immutable works, it doesn't create a deep copy but does maintain top level === semantics. But you're right with builtin objects :)\n. \"XmlHttpRequest request\"?\n. s/inexperienced users/people/\nI'm sure plenty of people who have been using React for a while make that assumption as well. I don't see a good reason for qualifying who those people are.\n. consistent indentation please\n. Let's just say \"network request\" and not be explicit about which API gets used.\n. Let's just inline the check here.\n. Please don't reuse warnedStyleValues - it's used for tracking semicolons in values. We can just have a global boolean warnedForNaNValue (we can only warn for NaN once).\nIt's unfortunate that we don't have more context in here - once and done for this warning isn't the most helpful thing (but better than nothing)\n. We should be probably just remove this test and write a new one in CSSPropertyOperations-test (since we are now testing that unit not ReactDOMComponent - this one is just surfacing the warning that was emitted before)\n. It should be moved. We should be doing unit testing. We're already testing the other warnings from that module there.\n. Don't inline the short one then. if (typeof value === 'number' && isNaN(value))\n. This should be safe as is but this is safer, so \ud83d\udc4d\n. Well, you can use your own state to communicate to the children, which is what that's trying to say. You would only do this via the children's props. I see that this isn't clear but I don't think your edit is technically right either.\n. We shouldn't do this. It would make Simulate.* event handlers behave differently than they would in the browser where events aren't automatically persisted (eg a handler calls something with the event in a timeout would end up working in tests but fail in real life).\nWe should fix that and any other tests, something like this.\njs\nvar foo = {\n  onChange = function(e) {\n    e.persist();\n  }\n}\nspyOn(foo, 'onChange').andCallThrough();\n. We probably want to do this for currentTarget as well.\n. While you're here, could you clean up the first sentence and just remove the \"passed down from parent\" bit.\n. component's (possessive)\n. Ah yea, good call. Really target should be in that interface too but I get why it's not.\n. Yea, that looks right. Seems like we shouldn't have been setting currentTarget in the c'tor anyway.\n\nI get why it's not\n\nI just meant that it feels awkward to have to check for === 'target' every time. We could probably move it into the else case below where you have it and then drop the continue.\n. Let's do this (mostly what I said but updated for correctness):\n- Leave this test but we need to update the 1 on line 199 to a 2 (to account for the warning you're adding), and then update the argsForCall[0][0] to argsForCall[1][0]. We'll remove this test entirely when the fbjs update comes along, but that update doesn't block this PR.\n- Add a new test explicitly for the new warning in CSSPropertyOperations-test\n- Ignore what @jimfb said (it's relevant but not to you right now)\n. We actually should leave this message in tact and just update which call's arguments we look at - there will actually be 2 warnings fired, the first is your new warning and the 2nd is the one that was here. In this test we should look for the \"modified\" style object (even if it is a lie right now).\n. false\n. Assume Ben likes this, can you drop the || '' here since we already know we have it.\n. Can you put this in a separate PR?\n. Can you actually just make both of them use this?\n. Can you remove this stray character?\n. Let's just make this 'Updating context'\n. And then lets be consistent with style: just always use the full componentDidMount: function() { format instead of mixing the two. (note this applies to getInitialState as well)\n. Also, we need a render function. You can keep it simple and just render something like <ComponentThatUsesContext />\n. \"property\" :)\n. Can you keep these ABC ordered please\n. And then also ABC order these requires as well\n. ditto\n. Can we cache this node? We don't need to make a new one every time\n. Will we ever run these a second time? Shouldn't the results any of these get cached\n. I'm tempted to say we shouldn't have a returnDefault param and we should just make the return value nullable, then consumers could fall back to a default if they need to. Boolean args like this aren't awesome (and neither is returning an empty string)\n. Please use JSX\n. This won't work out of the box in our primary @providesModule world. We could make it but it's trickier and more prone to breakage.\n. You can't, unless you want to come work at FB :) Introducing a normal node require into @providesModule code requires more work and doing things in a different part of the codebase that just means we have a little bit more to keep in mind when we sync.\n. This is just a matter of having to do special configs for these things in our website code to work. Nothing else to do about it.\nIn this code base you should be able to make it work - we have to hard code that react-current-owner is normal and should not get rewritten. And you have to do that in the gulpfile (again, sorry for the crazy build system). https://github.com/facebook/react/blob/master/gulpfile.js#L42 - we should make that Object.assign({}, require('fbjs/module-map'), {'react-current-owner': 'react-current-owner'}). Basically the build assumes that if something isn't on the whitelist, then it must be a providesModule module. We dump all our modules into lib/ and rewrite the requires so they are relative. So this is currently getting rewritten to require('./react-current-owner') which is going to fail when browserifying.\n. Even better because rest & call spread:\njs\nreturn function(...args) {\n  MSApp.execUnsafeLocalFunction(function() {\n    return func(...args);\n  });\n}\nBut it'll compile to arrays and apply until that's all supported. And we've mostly opted not to use those features (except in some dev-only code) and just explicitly list out the max number of args we need (see PooledClass creators).\n. This needs to be guarded in a canUseDOM check.\n. Can you actually just add your items and not re-format the whole block. We should fix the formatting separately (and get rid of the whitespace)\n. I don't think you wanted to do this. I'm guessing this will make the test start failing internally since that won't resolve. We should be rewriting this with the fbjs-scripts plugin...\n. Oh, setMock isn't one of the methods that the transform catches \ud83d\ude22. Will fix that. \n. https://github.com/facebook/fbjs/pull/115\n. I personally would have used echo for this too but meh.\nOtherwise it seems good.\n. cc @cpojer - is there a jsdom update we need to apply to jest or can we look into fixing it?\n. Can we just add a class to these links instead? https://github.com/facebook/react/blob/de09e0acd82d2de955af4c395fd9066292adef70/docs/_plugins/sidebar_item.rb#L6-L7\n. Let's just make this 1.0.0\n. This doesn't look right. Why do we have a space separated value?\n. Might want to wrap this code so it looks good on npm.\n. We only need to set styleName to cssFloat if it isn't already cssFloat, so this doesn't actually do anything. i appreciate the thought though.\n. Worth noting that this is different than what we were doing (oTransitionEnd) but looking around the web, that should be fine.\n. Just disable that warning for the file.\n. Nah, just going to do this for now.\n. This is intentional and requested by me due to conversations had with @sebmarkbage a couple months ago, don't worry about it. We can deal with figuring out the polyfill story later.\n. This isn't right, here's what gets generated for empty items. I have another thing I want to change so going to follow up.\n``` diff\n           \n-            Web Components\n+            Web Components\n       </li>\n\n``\n.bundle exec? It shouldn't really be a bundler issue though because 0 isn't falsey in Ruby.\n. No worries :) #6151 in case you're interested\n. Note: this should be failing lint (travis is really behind though \ud83d\ude22)\n. Can you get these strings onto fewer lines? And end the second sentence with a period.\n. Just inlineundefinedhere (andnullbelow)\n. I think at this point in the cycle it's justcomponentWillReceiveProps-componentDidUpdateis called later (the next step after this is render which is mentioned below).componentWillUpdateis called before render though and I think that's what this was actually meant to be initially. Let's just use that (and get rid of the brackets entirely, just write out both method names).\n. Good call. Want to accept too? :D\n. Let's get rid of the 2 separate checks to look at the same warning and justexpect().toBe(full message). Same in the few cases below. I know it's a bit churny but ultimately better. Thanks!\n. A few things\u2026\n1. Let's just do the work in warnValidStyle as opposed to doing it twice.\n2. Let's refer to this as anowner. Owners are not necessarily Composite Components.\n3. Let's do something like https://github.com/facebook/react/blob/c52265884a5e6726c712924ce074af5a01ae016e/src/renderers/dom/client/wrappers/LinkedValueUtils.js#L90-L98 - specifically the part where we just don't put anything if we don't have an owner. Falling back to \"Component\" here isn't really right - could actually have a component named Component which would be confusing or be in a top level render situation.\n. Let's make this.test- we don't need the match results. Otherwise this looks good, thanks!\n. You call outvalueas being special here but this will apply to other things too (egselectedwhich is alsoMUST_USE_PROPERTY). Is that your intention?\n. Comment updated: 5a17a1ef1d77f0a99cb708adde283275b7eb49fd\n. Can you leave the/custombit - the API matches envify so we can keep that part the same.\n. Unfortunately no - that's the email your commit was made with so it's in the git history, which is how the authors file is generated.git shortloguses the.mailmapfile to map so that theAUTHORSfile has the right final data. ([script](https://github.com/facebook/react/blob/master/scripts/authors)).\n. It's fine. The reason it broke in a changelog is because it was copied to the docs.\n. Pretty sure these are going to get rewritten to'./fbjs/lib/invariant', might just want to make them'invariant'for now.\n.UIManagermodule doesn't exist. This will almost certainly be broken. I'm guessing there are a bunch of others in the same boat (presumably modules that aren't brought over from RN). We need to whitelist all of these in the map - https://github.com/facebook/react/blob/master/gulpfile.js#L33 (mapis a key:value mapping,map: Object.assign({}, require('fbjs/module-map'), {UIManager: 'UIManager', etc})`\n. Do we need to be generating the .flow.js files for RN to typecheck? We don't currently do that (because nothing else in React is typed).\n. This file and the entry in the nav need to be deleted now.\n. This almost certainly shouldn't be the 2nd thing on this page. Let's move it to the bottom.\nAlso, referencing build/modules doesn't feel right. People shouldn't need to know that dir exists (and we don't really want to tell them it does) - they shouldn't be referencing anything in there. Pointing to build/packages for npm installable packages or just build/ for browser packages is fine.\n. Let's not \"and/or\" this. Let's pick one (\"or\" is my preference because I hope you aren't using both together for client-side development).\n. Let's make this a bit more welcoming and say that it comes with a number of examples, maybe say those prebuilt copies of React are for the browser.\n. Capitalize these languages correctly please (eg \"javascript\" => \"JavaScript\")\n. Again, JavaScript. We are never allowed to get that one wrong :P\n. Can you fix the rest of these languages as well. FYI: It's not called closurescript.\n. I don't want to reference this even if it is labeled unofficial and unsupported. If it's in our docs that gives it weight. I especially don't want jsx-control-statements to be in something we link to. Let's instead build a real babel6 transformer that doesn't have any opinions in it (apart from supporting the basics needed for JSX & es2015, maybe __source)\n. Is it Typescript or typescript or TypeScript? Please triple check all of your uses.\n. I don't recommend Bower and neither should you \ud83d\ude09\n. > another image will animates in\nExtra 's' there. Otherwise, this looks great.\n. This one is fine either way - (it will actually be updated to console.error.calls.count() and argsForCall will become console.error.calls.argsFor() when I finally figure out the last bits I need for jasmine2). I know at one point we did change everything to use argsForCall consistently. I'll fix both so you do you :)\n. Nah, it's fine. It'll get codemodded either way.\n. Note for if we come back to this: no need for type=\"text\" on textareas.\n. Said offline but the DOM doesn't do this so while it tricks the test it's not real life.\n. Going to make this Object.assign.apply(null, arguments) (shouldn't matter but makes more sense when compiling to use object-assign. _assign.apply(null, arguments)\n. Let's not put words in my mouth. This isn't really a list in the traditional sense. This is a page full of information and Node is approximately 100000000x more important that Nashorn. Please reorder these.\n.// These files can be downloaded as a part of the starter kit from https://facebook.github.io/react. A couple things.\n1. I don't think this needs to be a \"Note:\" but if you're going to do it like that please format it correctly (this will render the entire text bold)\n2. Probably don't need to link to it twice\n3. Are there other testing libraries worth linking to?\n4. \"... released a new ...\" will get dated. Want to phrase it in a way that's a bit more timeless since we probably won't change this text for 3 years ;)\n. We can remove this.\n. Want to make it short and drop the object, just make it\"facebook/react\"?\n. It's a static method so I think we're ok.\n. We're almost definitely going to lose docs on the RN site as a result. I guess we'll figure that out later.\n. We already know thatinitialState === undefinedso this condition will never be met and we'll always warn. It's also an entirely unactionable warning as this only happens when a component is mocked.\n. Can you make this this a block and across multiple lines? Lint is only warning about it so not failing Travis but you can see it locally.\n. Let's just use JSX here. We should also make sure this test fails without your code change. I don't think it will - we'd need to do to the same mocking so isEventSupported is false.\n. I'm surprised this would warn normally since we're in jest and have a DOM, even for server rendering. I would expect isEventSupported to return true (that's why we explicitly mock it in the prior test) and in turn, we wouldn't warn. But I did run locally and saw the warning\u2026 oh well.\n. I've leaned towards putting this file insrc/` (have done that with Relay and Draft) - tends to mean less things to have to ignore and less random breakage when you miss a new addition (eg random npm module)\n. Mostly the only difference is these need to point one level higher.\n. > Ideally we should lint for Flow style guides (like no space before colon).\nI'll be the linter right now and tell you that you have a space before the colon.\n. This (and the others like it you changed) needs to be written as it was, as Jim said. It may render correctly in the GH preview but will not render correctly when using Jekyll because {{ is an opening tag for Liquid templating which is used for the actual website..\n. Not perfect since it's not a 1:1 mapping to filesystem but good enough :)\n. All of our grunt tasks are slow so probably doesn't matter.\n. Is this still applicable?\n. What does this comment mean? Maybe just do a single comment on its own line above both of these lines that's clearer (probably don't need the same comment for both)\n. Want to prep the followup PR to remove the HAS_SIDE_EFFECTS logic? Or just do it here as a 2nd commit (I think the reasoning for a followup in the other PR was that it was a non-core contributor).\n. This would definitely be a ReactDOM API (nothing in isomorphic/ should require anything in renderers/)\n. Please don't add a space before the colon (we'll get linting setup at some point but until then\u2026)\n. \ud83d\udc4d\n. Let's not forget to fix this permalink :)\n. Can we just simplify this whole thing since you're changing to an object anyway?\njs\nvar moduleMap = Object.assign(\n  {},\n  require('fbjs/module-map'),\n  {\n    deepDiffer: 'react-native/lib/deepDiffer',\n    ...\n    'object-assign': 'object-assign',\n  }\n)\nOtherwise, this seems fine. If you say the module resolution works then I believe you :) I'm a little concerned about the framework & peerDep and that screwing up the resolution, but we can tackle that later. I think the only clear solution to that is shipping the renderer in its own package, which we'll get to.\n. Cool. We'll land after you update and ship 15.1.0-alpha.2 so RN can pull this in officially\n. I think this is probably fine. Hacky but fine :). Should we make this fail if both specs are empty?\n. Since we didn't ship ReactART 15 yet\u2026 we could just make it depend on 15.1 and not support 15.0.\n. Should be fine. We can also exclude this dir when syncing to avoid the clash.\n. I think we can safely break away from the renderIntoDocument misnomer for something new. Might make sense to rename renderIntoDocument (with forwarding) at the same time.\nrenderDetached? Or if we want a mouthful renderIntoDetachedNode. And then the Promise version\u2026 I guess ...Async is ok. I still think of \"async\" functions as taking a callback but I guess Promises are a thing and that's how async/await works.\n. Can you add a test ensuring the exact expected behavior around refs is defined. eg, right now string refs are still a thing but you'll get runtime errors if you use them here.\n. Could always just not copy this whole directory to lib/ (which we probably want to do for the noop renderer from #6690 too)\ndiff\n--- a/gulpfile.js\n+++ b/gulpfile.js\n@@ -20,6 +20,7 @@ var paths = {\n   react: {\n     src: [\n       'src/**/*.js',\n+      '!src/renders/art/**/*.js',\n       '!src/**/__benchmarks__/**/*.js',\n       '!src/**/__tests__/**/*.js',\n       '!src/**/__mocks__/**/*.js',\n. This should still take a props object, not name as a standalone argument.\n. Let's put a pin in this for the time being to prevent over-churn. I don't know that we will be encouraging the use of property initializers yet. We'll want to make sure we have some guidelines for code in documentation before we finalize this.\n. oooooops, this is how I try to debug to see if the transform did something weird. This would obviously go away.\n. @jimfb can you followup and add a comment in the code about this? This inline discussion will be lost in the sands of time.\n. I'm going to merge and then follow up to use the redirect layout we have set up for this.\n. PS .htm? I think that extension lost the war \ud83d\ude1b\n. No weirder\u2026 you would probably never realistically set left to a unitless 16 either.\n. Can we make these match up with what we have in the commonjs example? build would just run webpack and start would run the devserver.\n. Let's add a private: true in here so nobody accidentally publishes.\n. I think we probably actually want to just use '\\n' so we generate the same file on Windows. Or even just leave off the newline.\n. Just go all the way and use interpolation.\nruby\ncodes_js = \"var errorMap = #{codes_json};\"\n. Can use the same shorthand that you have for read.\nruby\nFile.write('js/errorMap.js', codes_js)\n. Let's revert this so the diff stays clean.\n. Do we need the wrapper div?\n. How is fb.me involved here? I think I'm probably just missing a step here. Ultimately I'd like to not use fb.me for any of this since we have to register the links and I don't think it supports query params.\n. Ah, gotcha. That's cool. I wonder if we should do a pass and make all of our messages markdown-compatible, then we could just convert the message. We already have a bunch of things in backticks with that pattern in mind, so it might \"just work\" (and we already have a markdown converter that we're using for the home page example).\n. I think we'd be ok if we did go that route. Maybe v2 :).\nFWIW, test your concerns on the example on the home page. It already turns http://website.com into a clickable link (though not with target=_blank) and converts markupy things to be escaped with &lt;. Then it renders with dangerouslySetInnerHTML.\n. This and the readme should be updated as well to reflect the changes to scripts. Sorry I didn't call that out before as well (thanks for the update, btw).\n. Also, this is meant to be the same example as the others, which are admittedly not the best examples you could ever write.\nsetState is also not an antipattern. There's a big enough perception in the community that it is and we need to not add support to that sentiment.\n. I think we should consider doing this differently. Right now we don't have a guarantee that this identifier doesn't already exist (practically it probably won't matter but just in case\u2026). We can use babel helpers to generate a unique identifier to use though and it'll be tracked on a per-file basis. This is how I did it for the object-assign transform: https://github.com/facebook/fbjs/blob/7c77c3c2ebcf0f1174512a66a08998dcff3d4cc5/babel-preset/plugins/object-assign.js#L15-L27\n. Why are we putting everything in quotes? This is a query string so we don't need them (then we also don't have to remove them on the other end). We can also just build up and use encodeURIComponent directly here instead of building the %s and replacing immediately (which btw, you aren't current encoding the value of args which we do need to do).\nTypically also for query params with the same name to be handled by a server side program you would do args[]=. It doesn't really matter since we're doing the parsing on the other end but might be a nice touch in case we did decide to do something different later.\n. Note if we do change this we'd want to just do format += [].slice.call(arguments, 1).reduce((arg) => '&args[]=' + encodeURIComponent(arg)', '') (or something less 1-liney)\n. I guess slice could be less performant and you could just use [a, b, c, d, e, f]. Same idea though.\nAnd no. You definitely don't want to encode & (it won't be separating params at that point since it would be encoded as %26). [] should be fine as well.\n. Can you fix the first link so it has a protocol? Also, looks like your docs use https, want to point to that for all of these links?\n. The pattern is actually this:\n- export an object or class? Upper case\n- export a function? lower case\nThe only other one we have of the latter that starts with react is reactComponentExpect\n. @gabelevi - Not sure if you or somebody else would want to make this multi-line format work. I would have expected this to work but apparently it doesn't just apply it to the next real code line and presumably just applies it to the next line which in this case was a comment.\n. Should we leave \"jest\" out of this? There are other libraries that people use that do mocking. For example, even you didn't use jest mocking in your test.\n. Actually I guess this is a minor-version change as it allows objects as element types. Should we maybe do a backport of this and exclude this change? We might also be able to get away with not cherry-picking this at all\u2026\n. We could add and Object.keys(type).length check.\nRegardless we probably don't want this part in 15 since it will change the warning behavior (at least before if you had the case you talk about you know something is about to go wrong).\n. Can you followup on this now?\n. So I just came back here due to a merge conflict and perhaps I'm missing something but doesn't this change mean we'll stop autofocusing inputs and textareas?\n. How does this work? Does this always create a new clone of the latest version of the tutorial repo?\n. So, not the latest version of the repo but the latest version of that hyperdev project (which is a snapshot of the repo and is another thing to maintain when we make changes\u2026). To that point, it's already out of date with changes we made last week :/\nBased on http://support.hyperweb.space/t/keep-github-repo-from-packages-json-in-sync-with-code/221, it looks like the ability to push to a repo directly and have a project updated is in the works. Let's hold off until that feature is available. We've heard very few comments about having to run a local server to do the tutorial so it doesn't seem like it's a pain point (but I would love to lower the barrier even further)\n. The original commit removed it so reverting that re-added it.\n. > miss-spell\nIronically, this is misspelled. You want \"misspell\".\n. > upper-case\nWe use \"uppercase\" elsewhere so let's do the same here.\n. ReactDOMFactories isn't really comprehensive and may go away in the near future, so I don't really trust this as a reliable source of information.\n. I actually think I want to keep this so it ends up consistently at the top of all dist files.\nBut then we would want to add it to the files in packages/react* so that npm-bundled files also have it.\n. Meh, it'll future proof for when those aren't a part of the react package.\n. Historically we ran these tests in regular phantom in the browser, before jest really existed. We did that for a while before turning off last year. We wanted to maintain that option value moving forward and tying too closely to jest would make it harder (unless jest starts supporting that use case).\n. TDZ already has meaning in JS. While it's sort of true that we're warning against a sort of \"React TDZ\", I think I'd prefer if we didn't overload that terminology.\n. > HTML child\nThat's also pretty wrong and confusingly worded. Want to try to clean the rest of this up as well?\n. Do you think we'll ever ship our own standalone package? Should we mention that we might do that alongside the major version change?\n. 2 things:\n1. This value should be 'xmlns:xlink' right?\n2. Can you move these up so they're with the other xml* attributes? Doesn't have to be perfect, we have a few others minorly out of order so we'll do a :sort sometime later.\n. I thought we talked about potentially splitting the PropTypes out from the main package and shipping it as a standalone thing. But I guess that's tangential and not worth mentioning until/if we do it. Just ignore me.\n. > 15.2.0\nGoing to turn that into a link to https://github.com/facebook/react/releases/tag/v15.2.0.\n. Please put each argument on its own line indented 2 space, closing paren with bracket on last line unindented\njs\nfn(\n  arg,\n  arg\n) {\n. Same goes for calls.\n. Just match current style with the colon spacing. We can enable a different lint rule enforcing 1 way or the other later and codemod (it'll be no space before).\n. Can you move priority to a new line\n. Can you add a comment about why we're setting step as well.\n. Let's stop using this. The only reason we did it before was because we didn't lose the license header at the top of every file when bundling. But we do lose those now with rollup so we should have the full license header.\n. I fully expect this to break internally unless we check if (process && process.env && process.env.NODE_ENV = 'test').\n. Can you leave this example as is? We're not using ES6 classes broadly yet and this should match the code in the English version.\n. One of our stances is that we should have the same invariants in dev & prod. Ultimately that means you never have invariant calls inside __DEV__ blocks.\nIn ReactDOM we warn so I think that's probably the preferred thing to do here too. @vjeux, @spicyj  - could you get some RN folks to look and see what the preferred course of action is here?\n. Not react-native :P\n. I think we should make this a peerDep.\n. Ironically our code used to look a lot like this\u2026 https://github.com/facebook/react/blob/0.14-stable/src/renderers/dom/shared/DOMPropertyOperations.js#L187-L197\n@jimfb - I think this is more fallout from your changes. Can you take a look and figure out a way forward?\n. Agreed but let's do that separately.\n. I haven't read the actual proposal but assuming we move forward, 2 things:\n1. Please use a short url, we can hook that up later. Let's say fb.me/react-warning-create-element or something similar.\n2. The url should be the last thing in the message so we should have the %s before it.\n. Is there a faster way to do this check? I'm hesitant to add code that touches every DOM node we create for a warning that fires a fraction of a percentage of the time.\ncc @jimfb \n. FWIW, we're actually trying to do this ourselves (https://github.com/facebook/react/blob/master/docs/_plugins/header_links.rb). We can probably make it better!\n. Yes, though apparently it's only a warning so didn't fail CI (https://travis-ci.org/facebook/react/jobs/150690962#L285)\n. ./ReactAddonsDOMDependencies is already relative to build/modules - Do you need that in the mapping?\n. I noticed the shim part, was asking about the RHS :)\nI looked at docs though - let's make that {relative: './ReactAddonsDOMDependenciesUMDShim'} and it'll work and be a bit more future proof (tested locally, it works).\n. Can you fix that language?\n. Are we still going to break the devtools with this?\n. rm\n. We need to account for the peerDependencies field in package.json. Right now the template has react as the dep but we'll want to override with this (or even just stop having it in the template at all and always inject - just need the version info too).\n. Nit: can you indent these lines (anything starting with the .)\n. Is this going to lead to any duplicate errors? Or issues with ordering in the future?\n. Probably don't need to update this package - I think this was a once and done release. (right @jimfb?)\n. clone-with-props isn't a thing anymore, don't worry about it.\nIt's definitely a breaking change but not to a part of an API contract we've published. There will almost certainly be some packages that stop working.\nI guess we could update this package in good faith, so we can leave this.\n. Let's drop style & className from this completely - we can use name as the only prop and keep HelloMessage identical & short. We just would remove the passing of the prop at the render call.\n. Let's add a newline above this so it starts a new paragraph and then change the period at the end of the sentence to a colon so it's clearer that the code we're writing is connected to some introduction text.\n. This needs to get added to peerDeps too now right?\n. Can you move this up with the other line where we reference examples, and then precede this with examples/**/ so we don't ignore anything else.\n. Can you actually revert the docs change? You have the right idea, we just try to do it in batches around releases (we can update all translations all at once more easily that way)\n. Do you know if we need to use the property here? I see that we currently have muted requiring the property (node.muted = true). Automated testing these things is tricky and I don't have a iOS10 preview to check myself - can you make a small component & run in a seed build that works, testing that toggling between true and false values when rendering actually works as expected?\n. Lowercase \"internet\" is fine now, let's leave that.\n. I'm on board with the others changes but can we revert this one? It may have helped you but I think it might be more confusing for the broader audience (remarkable is the library - remarkable.min.js is a file).\nI could probably be on board with something a little more generic and correct.\n\nWe already included this library via a <script> tag with the original markup for the page [\u2026]\n. Let's format to match our JSX multi-line style:\n\njsx\n<ReactCSSTransitionGroup\n  transitionName=\"example\" \n  transitionEnterTimeout={500}\n  transitionLeaveTimeout={300}>\nSame goes for all of the other instances in this PR.\n. Please match our style in regards to spacing around brackets and parents.\n. Please don't use .bind(this) here. map() takes an extra argument for scope, or you can pass an arrow function to map()\n. This whole line really goes away with the new code. We can replace this first sentence with something discussing the same topic - that we're passing a bound function through, even though we don't use bind.\n. Sounds good, just a couple additions to make it flow a little better (but not actually emphasized).\n\nthis inside the map() call refers to the GroceryList component.\n. Couple other things\u2026 We never pass a b arg, we could probably drop that entirely and make things even simpler.\n\nfunc is an event handler most times but we also call it once with a pre-bound componentWillUnmount. I was guessing that was the problem (perhaps other flowified app code runs through that path which triggered the failure internally?)\n. As @jp7837 pointed out in https://github.com/facebook/react/issues/7358#issuecomment-243289105 - this is going to get every other child - childNodes is a live NodeList. This should be a while loop. I can confirm this is what is happening in IE11.\n. (elem: ?HTMLElement) => void isn't right - you can get a component instance passed in (in the case of refs on composite components).\nI think we probably want to define this correctly as much as possible and not leave partially correct types on fields (probably fine to leave any on to-be type fields).\n. It might make sense to flowify from the other angle then if we can't figure this out.\nBased on the comment above, it seems like potentially the case where we're swapping refs from something that was rendered to something that isn't, so the instance doesn't have a prevElement (or something).\n. FWIW These files were copied directly from another repo (where they are mostly copied from www). I don't think we can remove that line internally so we'll have to have it in some copies.\nIt's ok to diverge a tiny bit in this part but if we ever make changes to the actual tests, let's make sure those propagate.\n. \\s? Or even just a space character without the brackets.\n. What's the non-quick fix? Can we just do that? (I know how this works and we'll never come back to that)\n. Can you lose the spaces? They'll get wiped away when something like npm install -S happens anyway so let's avoid the future noise.\n. Actually, this will get reprinted too (I think it's justJSON.stringify(data, null, 2)). Let's change this and the one above to have newlines, like it currently is.\n. What about putting it where we have other jasmine-related setups: root/scripts/jest? We're already making the assumption that path.resolve is going to work from our repo root so it just means we change __dirname to scripts/jest).\n. I don't think that's true. We want to exclude some files for sure, eg https://github.com/facebook/react/tree/355c49065386cbe33c026ba573c88c4e459ea328/src/shared/vendor/third_party (that file is showing up in the coverage report for this build). I'm also seeing coverage results for scripts/jest/test-framework-setup.js in the report.\n. null | Type is how @sebmarkbage has been writing it too. I think it sort of follows from the use of ?Type. It's also more readable in cases where you might have a function (eg here)\nI agree that it feels more natural to have null as the last thing since it seems least important but I'm on board with the pattern we have here.\n. DUUUUDE\n. Not sure if we've been doing it consistently, but it would be good to give a bit of whitespace between types and actual JS - can you just put a newline under here (and in the other class too)\n. Let's branch this type type checking and include a flow one, then put this fact checking there since it's for flow.\n. I don't think we should even risk logging this\n. Can you make sure we have these setup first. We already have a user we're using for the docs updates and it shows as \"Travis CI\" - I'd like this too as well.\nI don't care about the fallback value you have here but I'm pretty sure we don't have these set right now. When you add the values we have for the docs, we might as well update the docs command to use the env var as well.\n. as written right now, this might fail (we modify working state in the tests to run another pass with an alt config).\nWhat about doing a shallow clone directly to the facts branch outside the working directory instead? That ensures that if anything is running after this script, the working directory won't have changed underneath.\n. You probably don't want to exit with non-zero exit codes. Or if you want your script to still exit like that you need either not run your script at all in that case or handle it gracefully. Otherwise Travis will report it as a failure (like it is right now).\n. Let's rm this so Flow doesn't try to typecheck it \ud83d\ude1b\n. I'm pretty sure this isn't safe - disabled only has meaning on specific elements. eg <div disabled><button onClick=... /></div> should still fire as the button is not disabled in the DOM.\nThis is also going to be super expensive. I don't think we can do this like this, even if we managed to just stop at form boundaries.\n. nit: https :)\n. Nit: this should be an h3, so only ###. I think that should help make the rendered output a bit more readable.\nformatting nit: space after the opening hashes (gets stripped, makes the markdown more readable). And remove the trailing ones.\n. Formatting is broken here (Space in the wrong place)\n. Formatting on these is pretty awkward. Maybe we can use a verb? Do we get a ton of value out of the location name? I get that it's nice promotion for the host but it kind of clutters this up.\n\nTuesday, October 18, 2016 in London at Facebook.\n. \"Check out this event\" is a weird call to action. Probably want to say \"Email us\" or something.\n. I'm generally not a huge fan of just using the URL as the link. Can we do anything about that (here and for a few things below too)?\n. >  lets you build a game in React\n\nLets you build games\n. > simple physic engine\nphysics\n. > allows you produce music in JSX\nallows you to produce music in React with JSX\n. Oh I see what's happening. I guess it's fine but I probably wouldn't insert the env vars when running the command and would just inherit the existing shell env, then commands can be (at least on unix) exec('git remote add origin https://$GITHUB_TOKEN@github.com/$TRAVIS_REPO_SLUG); (probably, haven't actually confirmed that)\n. I agree - no facts matrix (that would defeat the purpose of the matrix anyway as we'd end up running tests & flow twice)\n. Let's drop the \"may be removed\" bit for now. I don't think we've ever talked about that. In a sense if we remove createClass then yes it would have to be removed but for the other methods we have that caveat (replaceState, isMounted), there is an alternative. There is no alternative to getInitialState for createClass.\n. echo \"$ALL_FILES\" should work. I'd prefer that over ls as it's clearer intent.\n. We can revert this and just remove the dead require I added. I bet that's why lint is unhappy too\u2026\n. Moving this URL but none of the rest that are going into the section?\nShould we just go ahead and rename files to fit now as well?\n. This isn't a SyntheticEvent. The type we have flowing from where this is called in extractEvents says this should be ReactInstance\n. Too late! I pressed merge.\nIt became really \"hard\". Or maybe I wrote \"annoying\"? I'm going to leave the mystery in there for now :)\n. I think what I have is right. define is used to define the exports, which isn't what we get back from calling f. require just makes sure the module is available and runs code without exports. Same reason we don't do module.exports = f(require('react') for the CommonJS case. It would be define in a UMD wrapper and that is what browserify will build and that we call inside f.\n. Yea, pretty sure that's racing. FWIW, you can probably just gulp.src([array of paths]).pipe(...) (can't test though right now so could be wrong).\n. Small request but it's important. We use a non-standard markdown syntax for the opening of code fences. You can see it at the top of this block. That's used to highlight specific lines when rendered on the website. In this case you're adding a line before the last highlight, we w'll end up highlighting the wrong line (I think just need to change this one 23 -> 24, the other ones will likely need a change too, only if the lines changed in the block are above or within the ranges). You can see this in action: https://facebook.github.io/react/docs/forms.html#controlled-components\nSorry it's not obvious. We've broken these a number of times and the only way you'd know was if you loaded the rendered website locally, which most people don't do.\nIf you could update with that, then this will be good to go. Thanks!\n. They're the line numbers in the code fence as if the code fence was in a standalone file, not the line numbers in the markdown file, sorry I wasn't clear. So in the current case we have line 4 highlighted (this.state=), the definition of handleChange (10-12) and the <input ...> line (23). You're change moves the input to line 24 because of the <label> addition, so in order to keep the input highlighted, the javascript{4,10-12,23} would need to become javascript{4,10-12,24}\nI won't ever claim it's the best thing, but it suits our needs.\n. wanna?\n. \ud83d\udc4d done.. I don't think this is safe... doesn't it result in React getting packaged into the ReactDOM bundle? I would expect build/react-dom.js just exploded in size.. Ah yea, that get's rewritten to the ReactUMDShim. Sorry, just experiencing some light PTSD thinking about making AMD again. Carry on then :). Probably not a huge deal in the grand scheme, but could potentially memoize this so we don't have to enter require on every call.. ",
    "jeffmo": "Hmm, I'm having a hard time reproing this issue... I made repro.js:\n```\n/*\n * @jsx React.DOM\n /\nvar CommentBox = React.createClass({render: function() {}}),\n    CommentList = React.createClass({render: function() {}});\n\n```\nand when I run ./bin/jsx repro.js I get this:\n```\n/*\n * @jsx React.DOM\n /\nvar CommentBox = React.createClass({displayName: 'CommentBox',render: function() {}}),\n    CommentList = React.createClass({displayName: 'CommentList',render: function() {}});\n\n```\nDid you include the \"@jsx\" tag in the docblock at the top? Or maybe I'm missing something?\n. Aha you're right! It's because we move past the contents of the object literal in the displayName transform step before the react.js transform has a chance to run on the declaration node.\nOk, do you mind filling out our CLA and then I can merge this in for you:\nhttps://developers.facebook.com/opensource/cla\n. This looks good to after we clear up line 39 -- thanks a ton for the fix!\n. Just an update: I've got a change to the parser queued up that allows for <div>{/* this is a comment*/}</div>.\nI'll probably send it out tomorrow after I've had some time to do a little more extensive testing first...but it should do the trick\n. I wonder if you could hack your jshint plugin to run jsx first before passing off to jshint? #dogscience...\n. I think this is mostly fine, but I would like for us to continue using xml semantics if we want to go down this road. So instead of <Namespace.Component /> I'd rather see us use : a la <Namespace:Component />\n. Going with : (as opposed to .) would allow us to separate the meaning of the syntax from the output of the compilation pipeline and leave the \"what does this mean?\" decision to the compiler. This is nice because it would be pretty reasonable to parameterize the compiler (with some reasonable default) in terms of deciding what something like <MyStuff:MyThing /> should de-sugar to.\ni.e. Does it compile to MyStuff.MyThing? Or maybe MyStuff__MyThing? Or hell maybe even require(\"MyStuff/MyThing\")\nIf we go with ., we're making a fairly hard-to-reverse decision that we want JSX namespacing to always be tied to a MemberExpression (because what else would <MyStuff.MyThing /> mean?)\n. Ok, I'm going to be on vacation for the next two weeks and don't know if I'll have time to tackle this just before then -- so this will have to wait a bit. But I'll be coming back to it when I get back if not before then\n. I'd really like to see this parameter passed in at the transformer level eventually (and not specified in the docblock altogether).\nHowever, this particular transform (transforms/react.js) is very much react-specific though...so I can't think of any issues with it assuming that it needs to use 'React.DOM' as the default case.\nLet me patch this locally and play with it to see if I can come up with any edge-cases though before I accept.\n. Would you mind rebasing on top of the following commit so it's a little easier for me to patch this and play with it?\nhttps://github.com/facebook/react/commit/a4f8ad1bb0ef6bd7dff3483471fbfb9815538a5d\n. It looks like\n<div>\n  stuff\n</div>\ntransforms to\nReact.DOM.div(null,\n  \" stuff \"\n)\nNote the spaces around \"stuff\". Don't the rules that we've settled on suggest that there shouldn't be spaces here? (At least thats what the conversion tool's output suggests...)\n. I think we need a solution to span-wrapping of {' '} (since the codemod script puts that in place to stub-out where whitespace would have been before...but is no longer after this diff).\nAdding spans can break styling and externally-expected DOM structures -- so we need some kind of workaround for the transition (or maybe we bite the bullet). @syranide: Were you planning to talk to @petehunt and @sebmarkbage about fixing the spans issue at a deeper level?\n. (other than that, I think this is good to go)\n. This is a great summary, thanks.\n\none idea is to keep a legacy version of JSX(Transform) in the repository for the time being\n\nThat's not a bad idea -- but I'd be a little worried about maintenance and having to support the old + the new transform. I say we just bite the bullet and move forward\n\nAlso, what is your thoughts for the \"codemod\" tool?\n\nI have a little CLI npm module I've packaged up (not published or checked in anywhere yet) that I've been using to codemod whole directories. We can probably just publish that and reference it in the CHANGELOG (as well as in the announcements for the next major rev cut)\nAnyway, you've convinced me it's worth moving forward despite the spans problem, so let's land this damn thing already!\n. The changes here lgtm. I'll hold off on merging until you guys decide if you want to include quasi-literals.\nI'm always in favor of not adding code until you need it...but I guess that's what this is anyway really\n. sgtm, but the flag kinda seems unnecessary...just always include the transforms or don't. It's not going to run the es6 visitors unless it sees es6 syntax either way\n. @spicyj: Wouldn't your linter yell at them (probably by blowing up)? What about people using ES6 syntax when it starts shipping in browsers?\n. I'm not strictly opposed to a flag I guess -- but I would just make it opt-out rather than opt-in I guess. ES6 is just javascript. If you have a tooling need to skip over it, that seems legit. But I'd venture to guess that in most cases it either doesn't hurt or only helps to leave it on.\n\"should/shouldn't\" use classes (or any particular feature of javascript) is also a valid concern -- but I just think it's a style concern that doesn't belong in the transformer.\nAnyway -- life will probably go on either way. If we do opt-in, I'll probably just grumble about how we've decided that some javascript isn't actually \"javascript\" and bring it up every so often as a non-sequiter fallacy of some kind :p\n. @jordwalke: This uses arguments under-the-hood anyway, it's mostly just sugar for doing so at this point...\n. We really need a higher-level metric to shoot for here. Gut-feeling on whether \"another allocation\" is ok or not is only going to lead to more subjective debate and potential for mis-guided optimization effort. I think perf questions are valid (including here) -- as long as we have a concrete way to answer them. I'm a little worried that we're heading towards a tangential meta-discussion right now.\n@cpojer asked earlier what the best way to perf-test this would be -- do we have an answer for this? If not, we're not doing ourselves any favors in speculating here and leaving red-tape around \"sensitive\" core functions.\n. Code looks good -- I'll leave it to @jordwalke to merge in case he has any further concerns\n. Code looks good -- I'll leave it to @jordwalke to merge in case he has any further concerns\n. Looks like there are merge conflicts, wanna rebase and then we can pull this in?\n. I'm slowly caving on my opinionated thoughts on people using object nesting for namespacing. I still think this approach is wrong though (in spite of the fact that we're doing this with React.DOM...I think we set a bad example there) -- and I think the utility of this will decrease once es6 modules become more widespread. I agree with the point that allowing full expressions as tag names becomes prohibitively cumbersome when you consider that you must have matching opening/closing tags.\nSo that said, if we must just accept the notion of object-nesting as a means of namespacing, I guess I like @petehunt's proposal the most since it also helps solve the built-in whitelist issue we've had for ages. It would be nice to use = in the docblock instead of : though...seems like = would be a little less cryptic:\n/**\n * @jsx HTML = React.DOM\n * @jsx MyStuff = MyComponentLibrary\n */\nOn the built-in whitelists, one option is to just move existence checks to runtime rather than having a whitelist in the compiler that should really be specific to a particular \"magic\" namespace:\n/**\n * @jsx React.DOM // default\n * @jsx MyStuff = MyComponentLibrary // explicit\n */\n<div />\n<Foo />\n<MyStuff:MyComponent />\ndesugars to\n/**\n * @jsx React.DOM // default\n * @jsx MyStuff = MyComponentLibrary // explicit\n */\n(React.DOM.div || div)(null);\n(React.DOM.Foo || Foo)(null);\nMyComponentLibrary.MyComponent(null);\nOn the other hand I would even be ok with dropping any kind of default namespacing altogether and just requiring namespaces for every directive. Then we don't need a whitelist OR an existence check.\n/**\n* @jsx HTML = React.DOM \n */\n<HTML:div />;\n<div />;\ndesugars to\n/** \n * @jsx HTML = React.DOM\n */\nReact.DOM.div(null);\ndiv(null);\n. @spicyj : In what way does @petehunt 's proposal not solve the original issue?\n. Yea, I used html:, but I imagine most people would probably knock it down to something short like h: as you suggest.\nI have no problem with supporting a default namespace + runtime disambiguation though\n. I like it, but can we not call it 'experimental'? How about just --es6?\n. No transform will ever support all es6 features -- some can't be implemented in es5.\nBut I'm mostly just opposed to saying \"experimental\" though as it implies the features that come with it aren't fully baked.\nIf you really don't like plain old --es6 though, maybe something less ambiguous like --partial-es6 or having a flag for each feature like --es6-classes and --es6-arrow-funcs.\n. I'd be ok with --harmony too if you'd like.\nOn toggling the option without changing the files -- I'm ashamedly not familiar with how this works. How hard would it be to include the option set in whatever hash/means of dirty-checking is used to decide when to re-run the transform? It could be a bit of a problem if someone added some es6 stuff, forgot to add the cli option, then wanted to run again to fix their mistake...\n. Awesome. We really need to get our transform tests out in the open so tests can be added for stuff like this (cc @zpao)\n. Oops, I found a bug after patching this locally:\nThis:\n/**\n * @jsx React.DOM\n */\n<div>\n  {/* A comment! */}\n</div>;\nNow seems to transform to this:\n/**\n * @jsx React.DOM\n */\nReact.DOM.div(null\n  {/* A comment! */}\n);\n(note the braces around the comment now)\n. This first conditional is no longer necessary since it's checked in visitReactDisplayName.test() -- mind killing it?\n. This should be fine to do upstream -- it should be equivalent/redundant with automocking.\nYou might just add a comment so someone knows why you did it if they don't understand the redundancy\n. Out of sync with what?\n. We should still check for the '@jsx' flag in the docblock here and pass the test only if the attribute value is empty or if the attribute value is 'React.DOM'\n. same\n. Sorry -- that should have said \"if the attribute value is empty or 'React.DOM'\" (i.e. not null)\n. 80char line width plz\n. Hmm, looks like something funky happened in your rebase maybe? This file was removed in 0dc011c40c5929023e59daafbd94c0d17b0b7d9b\n. I'm finding it a little difficult to follow what's going on in here, but I think this is the source of failure when transforming something like:\n/**\n * @jsx React.DOM\n */\n<img alt=\"\" src=\"\" />\nwhich, after these changes, now transforms to\n/**\n * @jsx React.DOM\n */\nReact.DOM.img( {alt:\"\" src:\"\"} )\nIn that scenario, line here is \"\" -- and thus falsey.\nOn a side note (for future ref): I believe our style guide asks that you always use curly braces and to put conditional bodies on a new line\n. Amdahl's law, etc\n. Can we add a getES6VisitorsList() function to the visitors module to keep this consistent?\n. Can we split this out into several visitors rather than one-to-rule-them-all?\n. I think you only moved this, but while you're at it: Syntax.Identifier\n. Yea renaming to getAllVisitors() at the same time seems reasonable too\n. This code is not that unclear right now, I just find that it usually works out better to organize visitors such that there is one node-structure per visitor (this is why \"transforms\" are really just \"groups of visitors\").\nFor example, splitting into smaller visitors keeps your .test() logic for each syntax structure from having to be duplicated (once in the test function, once in the visitor to disambiguate all the possible scenarios that would pass the test function).\nAlso if/when transformations grow bigger, being able to think of the \"transform\" in terms of smaller parts is really useful when trying to read+understand it (see the es6-class transform for example).\nAnyway -- just a general best practice that I like to shoot for. This function is pretty small right now so I guess its ok and we can worry about things in the future if this ever starts growing again.\n. oh, nice\n. +1\n. ",
    "seiffert": "@jeffmo Could you please try to make render return a DOM component? The transformation of this JSX code to javascript is what doesn't work for me... The transformation should happen in browser-transforms.js on line 39. However, after executing this line, the variable functionBody holds the string contained in this gist: https://gist.github.com/seiffert/5681370.\nWhat is happening is that the reactDisplayName visitor iterates over all declarations included in the var. As far as I understand, it should only add the component's displayName property to its initializer's first argument. What it actually does is the following: For every declaration, it copies the script from the current pointer to the first argument of the declaration's initializer into the script buffer. However, this step copies all contents from the last declaration's initializer's first argument's position (stored in state.g.position) to the current declaration's initializer's first argument into the buffer. This effectively copies the whole untransformed initializer into the script buffer.\nAfter this, the normal transformation takes place which leads to the correct but somehow ~duplicate output at the bottom...  \nYes, I do have a @jsx React.DOM tag in the docblock at the top of my <script> tag - see the whole HTML document here. \n. I tried to reproduce the problem with the jsx binary - it does not occur! WIth the version of JSXTransformer.js installed via bower install react, the problem can be reproduced...\n. I already signed the CLA!\n. True, if we can rely on test() being called before visitReactDisplayName(), we can remove that first condition! \n. ",
    "alvaromuir": "Thanks guys. A single 'React' would be sweet imho.\nOn Thu, May 30, 2013 at 4:58 PM, Paul O\u2019Shannessy\nnotifications@github.comwrote:\n\nWhat @petehunt https://github.com/petehunt said should work, though it\nexposes more than you need and might lead to information overload (just\nlook at React.js if you do this! this is what gets exposed by the shipping\nfile).\nI was hoping the UMD wrapper we have around react.js would just work if\nyou decided to require('React'); (or maybe it's require('react'); If\nneither of those work then we should definitely try to make this work out\nof the box without having to do a custom build.\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/facebook/react/issues/28#issuecomment-18707918\n.\n. \n",
    "philix": "Check https://github.com/philix/jsx-requirejs-plugin\n. Anyone still interested? :)\nhttps://github.com/philix/jsx-requirejs-plugin/\n. ",
    "jeffreylin": "FWIW, I think the selector is fragile - In the languages selector on the left in jsfiddle, you can pick between JS, JS1.7, and Coffeescript - I think this script only works for the JS1.7 option...\nI wouldn't merge this unless we're sure this works on al \"language\" options or at least the one out of the box w/ a message - tbh I think the one out of the box is regular JS and not JS1.7.\n. @petehunt sure thing\n. Okay cool - I guess as long we tell people to fork off that JSFiddle, it should be good. =D\nMaybe add an alert(\"Requires the Javascript 1.7 language in JSFiddle.\") to the script if it can't find the script tag - just incase people copy pasta the script src.\n. @hojberg @hieu - I was having issues w/ vim file writes not being caught so I hacked together https://github.com/jeffreylin/jsx_transformer_fun - Feel free to try it and let me know if it works (Haven't had the time to test on Ubuntu yet...) - We might use the file watcher in that repo in Commoner / JSX in the future.\n. Nit:\nYou can also play around using this base JSFiddle.\nEver so slightly like this wording more =P...\nIt might also be good to put this right after the \"fastest way to get started\" section:\nInstallation\nThe fastest way to get started is to serve JavaScript from the CDN:\nhtml\n<!-- The core React library -->\n<script src=\"http://fb.me/react-0.3.0.min.js\"></script>\n<!-- In-browser JSX transformer, remove when pre-compiling JSX. -->\n<script src=\"http://fb.me/JSXTransformer-0.3.0.js\"></script>\nOr you can play around using this base JSFiddle.\n...\n. Either way's fine with me =]\n. so we're not breaking separation of concerns, but rather unifying the presentation layer.\n. I feel like most people won't make the connection between WYSIWYG editors and splitting markup from code. I think something like:\n\nBreaking apart markup from code is largely a historical problem. Historically, WYSIWYG editors like Dreamweaver would statically rebuild your markup each time your template changed. As a result, people would split their JS and CSS from their markup so that they could update them without rebuilding. Given that large projects don't generally use WYSIWYG editors for production code anymore, we've chosen to reduce friction by integrating rendering logic with markup.\nWe feel that each component should be a self contained atomic unit. In many other languages/syntaxes, you don't have separate completely disconnected files for describing presentation and behavior (think of Objective-C ViewControllers for instance).\n\nis a bit closer to what I'd like (meh, I still hate the wording though - def. feel free to edit).\nAlso, fwiw, Marshall's original comment is here\n. \"You can render React components on the server...\"\n. ",
    "sophiebits": "Indeed -- just rebased.\n. Indeed -- just rebased.\n. @jordow Sorry, I'm not. (Happy to talk on IRC or something though!)\n. @jordow Sorry, I'm not. (Happy to talk on IRC or something though!)\n. Here's a stab at using the synthetic event system to simulate onInput in all browsers, including IE8.\nUnlike the real input event, this one can get triggered multiple times for the same change and sometimes in cases where there wasn't any input. The only way I can think of to handle this is to store the old value on the DOM element so that we can compare and trigger the event only if there's been a change, but that feels sort of gross to me.\nI'm also unsure of the setTimeout I used, since it seems that setTimeout isn't used anywhere else in the codebase but I don't know of any other way to get the desired effect here since we need to wait for the browser to process the keydown event before the value attribute is updated. I did verify that when deferring, the AbstractEvent is still released after the event handlers are run.\nLet me know what you think.\n. Done.\n. Done.\n. I can't tell from your answer whether that means that es5-sham should be used and its presence can be relied upon, or if it should go away completely once the code sync happens.\nHaving the shims on the site might help. How have you been testing in IE8? (Also in general \u2013 I've been repeatedly running grunt build then using the examples to test but maybe there's some good way of loading React that doesn't require the explicit build step?)\n. I made a quick attempt to use React with the only the necessary parts of es5-shim and it appears that Function.prototype.bind, Array.isArray, and Array.prototype.indexOf are the only needed functions. I wonder if it's worth including just those ~50 lines of code in React directly and claiming native IE8 support?\nedit: Also Date.now(), but that can be replaced with +new Date without hurting anyone.\n. I'd like to change the default file extension to .jsx and then transform JSX regardless of if the docblock is present; see #832.\n. I just found https://github.com/jsdf/coffee-react-transform which appears to be a JSX transformer for CoffeeScript. I haven't tried it but it looks promising -- if anyone here tries it out, it would be great if you could report back with your results.\n. Done.\n. Done.\n. I was considering getting rid of NormalizedEventListener but opted to leave it and wait for a reviewer to tell me to remove it. :) Looking forward to seeing your change; this seemed like the easiest way to get this to work in IE but I'm happy to see better solutions.\nFor style, I was just trying to follow what was already there (and keep it under 80 chars).\n. I prefer color too! However, I just now looked at my tabs and these logo shapes and color schemes were close enough to be confusing.\n\n. I agree that those all seem pretty reasonable except the last one. I wouldn't personally find keeping newlines between two tags helpful, though it's at least worth considering because removing it is inconsistent with HTML.\n. Fixed by #480.\n. Fixed by #480.\n. (This was already committed in c9ecbaccb365ba39bd8839f61ae245cdc295317b and should be in 0.4 when it comes out.)\n. Thanks, I was wondering about the empty-block warnings when I ran grunt lint.\n. Maybe add lint to the Travis build?\n. We had a brief discussion on IRC about this. @yungsters suggested that putting it in a single component is cleaner because it allows us to easily isolate all of the weird per-tag behavior, and I agree. (IRC log: https://gist.github.com/spicyj/cfc8b1a4c66d7f80db0e)\n. We had a brief discussion on IRC about this. @yungsters suggested that putting it in a single component is cleaner because it allows us to easily isolate all of the weird per-tag behavior, and I agree. (IRC log: https://gist.github.com/spicyj/cfc8b1a4c66d7f80db0e)\n. :+1: Updated.\n. :+1: Updated.\n. Hmm, the tests fail now because I guess phantomjs isn't a fan of overriding .textContent. (Works fine in Chrome though!) I removed that part of the test in ac5320e but let me know if you have a better idea.\n. Hmm, the tests fail now because I guess phantomjs isn't a fan of overriding .textContent. (Works fine in Chrome though!) I removed that part of the test in ac5320e but let me know if you have a better idea.\n. Hello, {name} was already broken so I didn't feel too bad about it. :) Can fix.\n. Hello, {name} was already broken so I didn't feel too bad about it. :) Can fix.\n. Sure, feel free. All this new forms stuff sounds really cool.\n. Sure, feel free. All this new forms stuff sounds really cool.\n. Even ignoring the sidebar and the name of the document, this feels like a very off-putting document \u2013 the first three things comprise essentially a list of bugs in JSX. (Though some entities actually seem to work? Try &bull;.)\n. Even ignoring the sidebar and the name of the document, this feels like a very off-putting document \u2013 the first three things comprise essentially a list of bugs in JSX. (Though some entities actually seem to work? Try &bull;.)\n. In #81, the version of commoner was upgraded so that jsx no longer relativizes imports by default. I don't think this is in a released version yet but if you use install from the latest master then things should work.\n. In #81, the version of commoner was upgraded so that jsx no longer relativizes imports by default. I don't think this is in a released version yet but if you use install from the latest master then things should work.\n. (Inline elements are allowed inside a <p>; other <p> tags and block-level elements are not.)\n. (Inline elements are allowed inside a <p>; other <p> tags and block-level elements are not.)\n. React also does badly in this case with things like text nodes inside <table> elements (outside of a cell). It ends up throwing the error:\n\nUncaught Error: The framework has attempted to either insert zero or multiple markup roots into a single location when it should not. This is a serious error - a fault of the framework - please report immediately.\n\nwhich is confusing and doesn't help anyone. This happens because in dangerouslyReplaceNodeWithMarkup, setting innerHTML to <table>oops!</table> gives two child nodes: oops! and <table></table>.\nDemo: http://jsfiddle.net/spicyj/ENxaB/\nWe should work on better messaging here.\n. React also gets confused by <tbody>. :(\nWhen you click on the table at http://jsfiddle.net/Gzm5N/1/, it should produce output of:\n\nRow 0\nRow 1\nRow 2\n...\nRow 2\nRow 1\nRow 0\n\nbut doesn't because\ndangerouslyInsertMarkupAt(table, \"<tr>...</tr>\", i)\ninserts a <tbody><tr>...</tr></tbody> instead. :(\njQuery has a hardcoded list of places where it does stuff differently https://github.com/jquery/jquery/blob/master/src/manipulation.js#L12-L30 so maybe we need the same.\n. React also gets confused by <tbody>. :(\nWhen you click on the table at http://jsfiddle.net/Gzm5N/1/, it should produce output of:\n\nRow 0\nRow 1\nRow 2\n...\nRow 2\nRow 1\nRow 0\n\nbut doesn't because\ndangerouslyInsertMarkupAt(table, \"<tr>...</tr>\", i)\ninserts a <tbody><tr>...</tr></tbody> instead. :(\njQuery has a hardcoded list of places where it does stuff differently https://github.com/jquery/jquery/blob/master/src/manipulation.js#L12-L30 so maybe we need the same.\n. (Tables still broken in React 0.4: http://jsfiddle.net/spicyj/Gzm5N/2/)\n. Related to #832.\n. @fyyyyy You can continue to use react-tools 0.11 or make your own custom transformer, like https://github.com/Raynos/mercury-jsx.\n. Going to leave mounting as synchronous for now I think but I need to add a callback to renderComponent because that calls setProps half the time.\n. @petehunt @yungsters @jordwalke Took another pass at it \u2013 I like this version a lot better. For now, I'm only batching things together when they're in a block like this:\nReactUpdates.batchedUpdates(function() {\n  component.setState(...);\n  component.setState(...);\n});\nThis means that the event handlers have batched updates but nothing else does yet. I wrote ReactUpdates such that it should be easy to make this defer using rAF in the future.\n. @petehunt @yungsters @jordwalke Took another pass at it \u2013 I like this version a lot better. For now, I'm only batching things together when they're in a block like this:\nReactUpdates.batchedUpdates(function() {\n  component.setState(...);\n  component.setState(...);\n});\nThis means that the event handlers have batched updates but nothing else does yet. I wrote ReactUpdates such that it should be easy to make this defer using rAF in the future.\n. (fixed spacing nits)\n. (fixed spacing nits)\n. This is standard behavior for JavaScript (unrelated to React), and is expected.\n\nFloating-point numbers such as 0.1 and 0.2 can't be represented exactly in binary, so an approximation is used. It's as if you (in base 10) added 0.333 + 0.333 + 0.333 and got 0.999 instead of 1 -- just an artifact of the rounding that happens. Here's a Stack Overflow question explaining this phenomenon: http://stackoverflow.com/q/588004/49485\n. :) Figured that might be the case. (I'm just creating merge conflicts for myself with my textarea pull request anyway. Ah well.)\n. (simplified invariant check, added link to jsperf for emptying a node)\n. (simplified invariant check, added link to jsperf for emptying a node)\n. As you can see in the earlier comments, it's recommended to just run jshint after doing the JSX transform. I implemented this for the Khan Academy linting tools this weekend, so if you download https://github.com/Khan/khan-linter and do runlint.py file.jsx, then everything should Just Work. (Not really designed for external use, but useful if you're looking for something to copy.) Maybe I'll make a jsxhint npm package that calls jsx then jshint in turn.\n. Gotcha. Maybe it makes sense for someone to write a JSXHint plugin. :) I have my vim configuration set up to use khan-linter; there's no reason I know of that IntelliJ can't do the same.\n. Gotcha. Maybe it makes sense for someone to write a JSXHint plugin. :) I have my vim configuration set up to use khan-linter; there's no reason I know of that IntelliJ can't do the same.\n. Agree that isolating mutations to one place is good, but it sounds like you're suggesting making state-setting more awkward just to discourage it, which doesn't make sense to me.\nWill continue to think about this as I finish up the setState batching. My gut feeling right now is that updating this.state immediately may simplify our code as well as being less confusing to the user \u2013 I'll see if that turns out to be the case.\n. Unfortunately this looks hard to change due to the arguments that the component lifecycle methods take.\n. Unfortunately this looks hard to change due to the arguments that the component lifecycle methods take.\n. Until we hear more, I think it's fine to close this out. I haven't heard of anyone actually getting confused.\n. > What we wanted to do was change the state and fire off the async call in the same turn\nIs there a reason this is effectively different from doing them separately?\n. Closing this out because we're not going to change anything, at least with our current component syntax. The recommended way to do transactional updates is:\njs\n    this.setState((state) => ({x: state.x + 1}));\n    this.setState((state) => ({x: state.x + 1}));\n. @syranide Sorry, not sure I understand?\n. Doesn't seem so. With ES6 template literals you can do\ntitle={`Hello ${name}`}\nwhich isn't too bad, so I'll close this out. (Maybe we can drop the outer curlies there someday.)\n. Closing in favor of #255 and #267.\n. Closing in favor of #255 and #267.\n. Sorry about that -- we have #1169 open now.\n. It's fixed in 0.14 beta and will be in the final 0.14 as well.\n. As I said, this is fixed in 0.14 which will be released soon.\n. @uzarubin Haven't heard of this. I just tested with http://react.jsbin.com/vovuzexiza/edit?html,js (http://react.jsbin.com/vovuzexiza) and it seems to work fine.\n. This issue has been fixed. If you're seeing the wrong behavior from React still, please open a new issue with a minimal repro case.\n. I guess so. :) Figured putting them together would improve the former's chances of getting accepted. ;)\n. Done. I'm personally in favor of not using Object.create because\n1. the description of es5-sham on https://github.com/kriskowal/es5-shim doesn't instill confidence in its correctness\n2. the alternative code is super simple and is pretty standard for doing inheritance in JS, and\n3. (I don't want to include es5-sham if I don't have to)\n. @Aaronius It's something we want to do. Until then, I'm happy to take a PR adding \"is\".\n. @jsfb Do we? I know we talked about it but that's not what the code looks like:\nhttps://github.com/facebook/react/blob/0183f70797183ae5371f61a40c1c13991cd7b104/src/browser/ui/ReactDOMComponent.js#L435-L441\n. Oh, I assumed this was for the browser extension that adds \"Pin It\" buttons to everything.\n. data-pin-nopin=\"true\": https://github.com/pinterest/widgets/issues/29\n. @Gozala Yes, we understand. That's why this issue is still open.\n. @ajfarkas xlinkHref={...} works already in 0.14.\n. <use> tags (and all SVG tags and attributes) should work in master and will work in v15.\nWhat do you mean about changing your code?\n. Well, they're mentioned now at http://facebook.github.io/react/docs/events.html.\n. All uses of global were removed in #376.\n. Interpolating the module name seems hard since you don't know whether it's in React.DOM or not and local variables can't be accessed by string name anyway.\nAlso related to #129.\n. Right, this is fixed.\nOn Thu, Sep 5, 2013 at 10:29 PM, Paul O\u2019Shannessy\nnotifications@github.com wrote:\n\nI think 61b38b9f053a5cf32ff868974357884c1bcb5d3a fixes this, right @sebmarkbage?\nReply to this email directly or view it on GitHub:\nhttps://github.com/facebook/react/issues/180#issuecomment-23919661\n. @zpao @jeffmo  how soon? ;)\n. @syranide Still broken for me, but looks like your #480 PR fixes it.\n. Danger was refactored, don't think this is useful any more.\n. Fixed by 1ffe2d0.\n. Just updated based on IRC:\nzpao: balpert: i'm going to make an executive decision and do your version diff, but a little differently. i think we should have a separate block which sets React.version = __VERSION__ (outside of the React= { ... })\n\n@zpao I left the jsx config refactoring because in #200 you said \"I wanted to get rid of those json files anyway.\" but I can get rid of it or split it out if you prefer.\n. Made better by a06de4bc4f5735aba767740d243b270e272ac6fa but not entirely. In particular, the lifecycle state doesn't get changed back which gives you the confusing\nError: Invariant Violation: replaceState(...): Cannot update while unmounting component or during an existing state transition (such as within `render`).\nif you make another state update. Anyone have good ideas for what the behavior should be in this case?\n. I'm guessing it makes this possible to filter the tests again in --debug mode, so thank you.\n. :+1: from me.\n. I'm not sure I understand. The code in master says:\n```\n    var nextProps = this.props;\n    if (this._pendingProps != null) {\n      nextProps = this._pendingProps;\n...\n\nvar nextState = this._pendingState || this.state;\n\n```\nAfter nextProps is set to this._pendingProps, it's mutated only by _performComponentUpdate (if shouldComponentUpdate returns true) or directly in the _performUpdateIfNecessary function (if shouldComponentUpdate returns false).\n. (See #74.)\n. Actually I think this is pretty reasonable with TransitionGroup.\n. In the future when we have x:frag it'll be Even Better\u2122.\n. @zpao rebased.\n. That's not good! I did some testing myself before submitting; let me know if you find anything useful.\n. Yes, I think that makes sense.\n. This happens because the change event never triggers on A, only on B -- React doesn't get a chance to restore the checked state.\n. Yeah, haven't heard any more complaints of this. The form docs aren't clear enough though; we always have people asking why their things are read-only (cf. #825).\n. Sure, I can.\n. Yup, @vjeux updated them yesterday evening, unless you're looking at different links than I am.\n. Looks good to me.\n. Looks good to me.\n. It is indeed defaultValue that is causing the strange behavior here. It used to be (before controlled form components) that changing value on an input's props would change the actual value, but the user could still change the value and React wouldn't reset it as long as the value prop didn't change. The implementation of defaultValue is different in that changing defaultValue won't cause the input's value to ever change; it's read only on component instantiation. There's no easy way to get the old behavior, but I assumed this was intentional because the old behavior was kind of confusing. (I guess the new one is too, given this issue!) I think the proper solution is to say that defaultValue is sort of a hack and that using controlled components should be preferred whenever possible.\n. It is indeed defaultValue that is causing the strange behavior here. It used to be (before controlled form components) that changing value on an input's props would change the actual value, but the user could still change the value and React wouldn't reset it as long as the value prop didn't change. The implementation of defaultValue is different in that changing defaultValue won't cause the input's value to ever change; it's read only on component instantiation. There's no easy way to get the old behavior, but I assumed this was intentional because the old behavior was kind of confusing. (I guess the new one is too, given this issue!) I think the proper solution is to say that defaultValue is sort of a hack and that using controlled components should be preferred whenever possible.\n. I don't think there's much we can improve here so I'm closing this.\n. #267 will warn for uppercase data attributes.\nOn Wed, Aug 14, 2013 at 1:23 PM, Cheng Lou notifications@github.com\nwrote:\n\nHah, didn't know that. Do you want me to drop a note in the docs on this in \"JSX Gotchas\" and \"Reference\"?\n(btw, really think DOM differences should be placed somewhere else, took me a while to find it)\nReply to this email directly or view it on GitHub:\nhttps://github.com/facebook/react/issues/260#issuecomment-22664129\n. If you do rowSpan it'll work -- we use the camelcase version for attributes for consistency with the DOM interface where you'd do el.rowSpan = 2;. I've already opened #255 to warn when using the wrong case since lots of people get confused by this.\n. If you do rowSpan it'll work -- we use the camelcase version for attributes for consistency with the DOM interface where you'd do el.rowSpan = 2;. I've already opened #255 to warn when using the wrong case since lots of people get confused by this.\n. Oops! I saw colSpan and naively assumed that rowSpan would be there too\u2026 :)\n. In the KA codebase we have two uses of this.forceUpdate.bind and none of setState.bind. Here's one of the uses of forceUpdate:\n\nhttps://github.com/Khan/react-components/blob/master/js/timeago.jsx\nThe other is similar.\n. cc @petehunt \n. I guess there's no reason to take undefined? Updated the commit.\n. As far as I know, the only thing broken about class and for as property names in old IE is that you need to do ['class'] rather than .for, which doesn't seem like that terrible. Maybe we don't need to change the name at all.\n. +1 for storing it as class and for in the props object.\n. +1 for storing it as class and for in the props object.\n. From IRC last night it sounds like we want to turn booleans and all other non-string/number things into ''. Not sure off the top of my head how this compares to what is currently being done in DOMPropertyOperations in general or for children in ReactNativeComponent\u2026\n. Forgot about textareas -- done.\n. Didn't notice that; adding it to componentWillUpdate would make sense to me for symmetry.\n. Added componentWillUpdate \u2013 before we were passing the ReactReconcileTransaction but it wasn't documented anywhere; not sure if anyone in FB relies on that.\nAs I add all of these I'm becoming less convinced that it's a good idea to pass the root node at all\u2026 makes it harder to add arguments in the future if we ever wanted to.\n. Maybe, I don't know anything about contenteditable.\n. @joshduck React's onChange intentionally deviates from the spec; see http://facebook.github.io/react/docs/forms.html.\n. @joshduck React's onChange intentionally deviates from the spec; see http://facebook.github.io/react/docs/forms.html.\n. For mousemove and mouseup, I think @jordwalke was suggesting using ResponderEventPlugin\u2026\n. For mousemove and mouseup, I think @jordwalke was suggesting using ResponderEventPlugin\u2026\n. I'll also add that a way to bind to onbeforeunload declaratively could be helpful.\n. I'll also add that a way to bind to onbeforeunload declaratively could be helpful.\n. No near-term plans for this, sorry.\n. No problem, just rebased and updated.\n. Is there any way to accidentally pass document as the second argument? Seems weird that you need to enable it if it's not an easy mistake to make.\n. Is there any way to accidentally pass document as the second argument? Seems weird that you need to enable it if it's not an easy mistake to make.\n. Well, they're not duplicates at all; this is an issue, #360 is a pull request. #360 does fix this so this should be closed after that's merged though.\n. Well, they're not duplicates at all; this is an issue, #360 is a pull request. #360 does fix this so this should be closed after that's merged though.\n. #101 is an issue for both nested ps and tables with a fiddle attached already.\n. I can't tell quite what you mean by this issue. Are you proposing that {false} turns into the string false and everything to string that isn't null? That goes against the practice of doing {flag && ...} which people currently seem to like.\nAnother solution that could work is doing:\nstrings: leave alone\nnumbers: cast to string\nbooleans, null, undefined: empty value\nother objects: throw an error\nWith the exception of throwing an error for objects, this matches our current behavior for children, I think.\n. from four days ago:\n\nbalpert: I think it is consistent if we say, for HTML attributes (except style, etc) strings and numbers are strings, bools and null/undef are ignored, objects are errors\nbalpert: for things with boolean values, truthy things are true\nbalpert: for children, strings and numbers are strings, bools and null/undef are ignored, components are components, other objects are errors\nzpao: well, objects are errors except when they have special meaning\nbalpert: right\nbalpert: that seems pretty reasonable\nzpao: we can't have other objects be errors as children\nbalpert: I dunno what to do about String objects\nzpao: we use key/value maps\nbalpert: ahh right, because the keys thing\nbalpert: yes\nzpao: arrays also need to be allowed\nbalpert: so children can be more lenient and allow objects?\nbalpert: but objects for attributes seem bad\nzpao: well, if you make a mistake hopefully it's fairly obvious\nzpao: but by having the rule that we'll toString everything except where we have special meaning for objects, we can set some expected behavior\nbalpert: right, but is there any reason you would want to toString an object?\nzpao: when if you accidentally assigned a bool to a variable and you just don't see if anything, it's harder to track down\nzpao: my example was a \"computed\" property like full name, though i don't know how realistic that is\nzpao: err, i guess i didn't actually write that down... that must have been in my lost draft\nbalpert: you mean like [firstName, ' ', lastName]?\nbalpert: you said:\nbalpert: FWIW, Objects as props allow a (admittedly poor) way of doing computed properties ;)\nbalpert: but didn't elaborate\nzpao: you could have a Person class (model?) which has first, last name properties and it's toString returns first + ' ' + last\nbalpert: oh I see\nbalpert: yes\nbalpert: I have never overridden toString as far as I can remember\nbalpert: sounds like something that wouldn't work in IE :)\nzpao: me neither...\nzpao: i said admittedly poor :P\nbalpert: I mean, the other alternative is to just stringify everything\nbalpert: and say not to do flag && ...\nzpao: that's what i'm saying\nbalpert: I see\nzpao: oh you mean for children too\nzpao: ?\nbalpert: hmm\nbalpert: I guess so, yes\n. classSet is now available as React.addons.classSet (not inlined at transform time, but is otherwise good).\n. It works properly if you call it htmlFor; #269 is a pull request to make it possible to say for directly.\n. React definitely allows you to specify an element's id.\n. Sorry, constants.js. See my comment at https://github.com/facebook/react/pull/267?source=cc#discussion_r6225881 (sorry for making you copy/paste; github doesn't preserve the hash otherwise).\n. :+1: lgtm\n. Okay, now with only one array for each wrapper type, including the HTML ones that were there before. I couldn't decide what the clearest way to organize them was (alphabetical looked a little messy); let me know if you have a nicer suggestion.\n\n(The patch seems to work in both Chrome and IE9 so I figured that it would probably work everywhere SVG is supported\u2026)\n. Just started to look a little bit into the allocations here. Redefining trapBubbledEvent in ReactEventEmitter with:\nfunction trapBubbledEvent(topLevelType, handlerBaseName, element) {\n  EventListener.listen(\n    element,\n    handlerBaseName,\n    function() {}\n  );\n}\nstill shows allocations in the Chrome memory timeline view, so I'm not convinced that there's anything we can do here? (Replacing trapBubbledEvent itself with a noop makes the allocations go away. EventListener.listen simply calls addEventListener.)\n. (I didn't verify that we don't have more allocations than the empty-function case; I don't know of a good way to do so.)\n. Did you want to make a new release of recast containing https://github.com/benjamn/recast/commit/e5fc90bafcae94af59f34ddd13c30a85641b2986?\n. Yup, seems reasonable enough.\n. Do you have the latest version of master? The todo example should work after 2b9c34b5c7fa88c0a67fd0b1c8639e6fa128a02c.\n. It's hard to give good errors here. Best idea I can think of is treating an unbalanced } as an error so that you at least catch it at the end of the render function. @jeffmo what do you think?\n. The diff looks pretty straightforward.\nI think for this to really work and be sustainable there needs to be an alternative platform implementation that can be maintained in parallel to the DOM one. When refactoring or adding features it's difficult to imagine use cases beyond what's already in front of you, so it will be continually tempting to accidentally reintroduce DOM-specific functionality into the core code.\n. Making onChange work with contenteditable is on the list of things to do\u2026 #278\n. 2b7a7599bb06f5cbcf01803fe1ae264b2b07d425 added support for onSelect.\n. Great ideas.\n. Also we're trying to make rendering into iframes work, so document is probably usually/always the wrong thing to use?\n. Okay, I split the test out to a separate file and made it use global instead of define.\n. @adewes @cdujeu @LeZuse If any of you can post a simple repro case showing the broken behavior here, I'd be happy to take a look at fixing it.\n. @LeZuse Thanks. This is the same issue as #1232. No fix currently, but using the key as a workaround is fine and I'll see if we can fix this sometime.\n. If anyone is still seeing issues on 0.14, please make a new issue with a simple repro case.\n. Reading .innerHTML out will rarely give you what you put in because the browser does various kinds of normalization on it. If you can repro with a standalone example though I'm happy to take a look.\n. In addition to feeling hacky, that won't properly clean up the old children when switching from children to HTML.\n. In addition to feeling hacky, that won't properly clean up the old children when switching from children to HTML.\n. I'm only doing this.updateTextContent(''); if !nextHasContentOrHtml. I am running this.updateChildren(null, transaction); when replacing with text content or HTML, but that's necessary to properly unmount all of the child components.\n. I'm only doing this.updateTextContent(''); if !nextHasContentOrHtml. I am running this.updateChildren(null, transaction); when replacing with text content or HTML, but that's necessary to properly unmount all of the child components.\n. I believe this will be fixed if we change the SVG attributes to MUST_USE_ATTRIBUTE. Not sure why they're marked as MUST_USE_PROPERTY right now\u2026\n. I believe this will be fixed if we change the SVG attributes to MUST_USE_ATTRIBUTE. Not sure why they're marked as MUST_USE_PROPERTY right now\u2026\n. Fixed by benjamn/commoner#44.\n. Fixed by benjamn/commoner#44.\n. Can't reproduce with Windows line endings on my OS X machine or in Windows 7, so closing.\n. I can't repro with mixed endings either.\n. See https://github.com/reactjs/react-future/issues/19#issuecomment-64921792; after that change it should be easy.\n. We don't have a solution for adding a ref to an element with a string ref, but otherwise yes.\n. Mavericks comes with 2.0.0p247 now.\n. Somehow I assumed it was intentional that the polyfills weren't included, now I feel silly.\n. This should be easy now that #484 has landed.\n. Probably on the supported tags/attributes page as well as a mention on DOM differences.\n. +1. Also makes it more annoying to add new useful arguments if there ever are any.\n. Perhaps we should write 'a': false and change the transform to output React.DOM['a'] instead of React.DOM.a\u2026\n. Why aren't externs appropriate for this case?\n. #333 \n. @Contra Correct, unless you count <div dangerouslySetInnerHTML={{__html: ... }} /> which sidesteps almost all of React.\n. We could try to break after sentences; I've heard some people like doing that and it produces reasonable diffs.\n. +1 @zpao.\n. +1 @zpao.\n. This makes sense to me. Should be a pretty simple fix -- just change\ncheckProp(props, propName, componentName);\nto\ncheckProp.call(this, props, propName, componentName);\nin src/core/ReactCompositeComponent.js:681.\n. (My #849 includes this change.)\n. What's a use case for this?\n. We don't have any supported solution for this. In general we don't support defining custom event types for the same reason we don't have any global configuration: because it makes interoperability difficult (if you develop a component that requires TapEventPlugin, it won't work for someone who doesn't load it).\nMy best recommendation if you need this is to build a <Tappable onTap={}> component or similar completely in user space without depending on React internals. It should also be possible to fix up react-tap-event-plugin for v15, but we don't support that and can't guarantee that it will still work in a future release.\n. Could you make a fiddle using http://jsfiddle.net/spicyj/BrU6B/ as a starting point? Thanks.\n. Looks like SelectEventPlugin's getSelection accesses .selectionStart on the range input which throws an exception because it isn't a text input (as specified in the DOM spec: http://www.w3.org/TR/2009/WD-html5-20090423/editing.html#textFieldSelection). (cc @joshduck)\n. http://jsfiddle.net/vjeux/25Rhk/ and http://jsfiddle.net/zpao/uaKdV/ are both older versions.\n. Shouldn't we just use createElement for those elements instead?\n. Alternatively, I suppose setInnerHTMLUnsafe would do the trick too in this case\u2026\nhttp://msdn.microsoft.com/en-us/library/windows/apps/br211696.aspx\n. Alternatively, I suppose setInnerHTMLUnsafe would do the trick too in this case\u2026\nhttp://msdn.microsoft.com/en-us/library/windows/apps/br211696.aspx\n. I didn't confirm myself but the EnterLeaveEventPlugin code certainly doesn't set a type; it just calls SyntheticMouseEvent.getPooled with the native mouseout event. (I believe the Chrome inspector is also fine if you see the properties immediately as in the above screenshot; confusion only results when expanding the object later.)\n. There are companies who enforce double quoted strings too, you know. :) Maybe it could be an option though.\n. Not sure exactly what you mean since there is no original quoting in this case?\n. foo='bar' doesn't even parse right now I think.\n. Yeah, also a little weird how <HelloMessage name=\"John\" /> turns into HelloMessage( {name:\"John\"} ) with the spaces.\n. Yeah, also a little weird how <HelloMessage name=\"John\" /> turns into HelloMessage( {name:\"John\"} ) with the spaces.\n. Yeah, this has been bothering me too. Pull request incoming\u2026\n. Yeah, this has been bothering me too. Pull request incoming\u2026\n. Okay, done.\n. Okay, done.\n. TestUtils has been exposed in addons since 0.9.\n. Looks pretty good overall. Let me know if you have any questions.\n. Looks pretty good overall. Let me know if you have any questions.\n. okay, I think that's all! I think this is just about ready now.\n. Okay, I approve! (With the exception of things I know nothing about, which includes AnalyticsEventPlugin \u2013 in particular, events won't be tracked if no one has event handlers attached for that event\u2026)\n. Well fine then. :)\n. (Merged in b8cf7068c4055ded0e23b612caa2fbd22c023628.)\n. lgtm.\n. lgtm.\n. The implication being that you're expected to use browserify?\n. Think we should do Submit always for consistency or just the browser default?\n. Think we should do Submit always for consistency or just the browser default?\n. Ooh good point.\n. I guess it's not obvious what the API should be here. I suppose the most obvious way is to do valueLink={...} but keep checked={...} as-is (and value={...} should still not work). Any opinions?\n. Not sure there's any English involved! This diff:\ndiff\ndiff --git a/docs/_js/examples/hello.js b/docs/_js/examples/hello.js\nindex 019281b..040a04a 100644\n--- a/docs/_js/examples/hello.js\n+++ b/docs/_js/examples/hello.js\n@@ -6,7 +6,7 @@ var HELLO_COMPONENT = \"\\\n /** @jsx React.DOM */\\n\\\n var HelloMessage = React.createClass({\\n\\\n   render: function() {\\n\\\n-    return <div>{'Hello ' + this.props.name}</div>;\\n\\\n+    return <div>Hello {this.props.name}</div>;\\n\\\n   }\\n\\\n });\\n\\\n \\n\\\ndiff --git a/docs/_js/examples/timer.js b/docs/_js/examples/timer.js\nindex eb1fed0..685e57e 100644\n--- a/docs/_js/examples/timer.js\n+++ b/docs/_js/examples/timer.js\n@@ -18,7 +18,7 @@ var Timer = React.createClass({\\n\\\n   },\\n\\\n   render: function() {\\n\\\n     return React.DOM.div({},\\n\\\n-      'Seconds Elapsed: ' + this.state.secondsElapsed\\n\\\n+      'Seconds Elapsed: ', this.state.secondsElapsed\\n\\\n     );\\n\\\n   }\\n\\\n });\\n\\\ndiff --git a/docs/_js/examples/todo.js b/docs/_js/examples/todo.js\nindex ebc08d5..8fbaa0a 100644\n--- a/docs/_js/examples/todo.js\n+++ b/docs/_js/examples/todo.js\n@@ -32,7 +32,7 @@ var TodoApp = React.createClass({\\n\\\n         <TodoList items={this.state.items} />\\n\\\n         <form onSubmit={this.handleSubmit}>\\n\\\n           <input onChange={this.onChange} value={this.state.text} />\\n\\\n-          <button>{'Add #' + (this.state.items.length + 1)}</button>\\n\\\n+          <button>Add #{this.state.items.length + 1}</button>\\n\\\n         </form>\\n\\\n       </div>\\n\\\n     );\\n\\\ndiff --git a/docs/_js/jsx-compiler.js b/docs/_js/jsx-compiler.js\nindex 0273464..4e5d036 100644\n--- a/docs/_js/jsx-compiler.js\n+++ b/docs/_js/jsx-compiler.js\n@@ -6,7 +6,7 @@ var HELLO_COMPONENT = \"\\\n /** @jsx React.DOM */\\n\\\n var HelloMessage = React.createClass({\\n\\\n   render: function() {\\n\\\n-    return <div>{'Hello ' + this.props.name}</div>;\\n\\\n+    return <div>Hello {this.props.name}</div>;\\n\\\n   }\\n\\\n });\\n\\\n \\n\\\nmakes it better, though CodeMirror isn't a fan of the <button>Add #{this.state.items.length + 1}</button> line.\n. I had a similar reaction.\n. The code is here:\nhttps://github.com/facebook/react/blob/master/vendor/constants.js#L31-L35\n. (Right now some of the tests test dev-only warnings\u2026)\n. Closing in favor of #1555, which I think covers the spirit of this issue.\n. These examples:\nhttps://github.com/facebook/react/tree/master/examples\n. Would probably be part of a site redesign. I don't feel strongly about keeping this open though if you'd like to close it.\n. The homepage hasn't changed in two years. :)\n. Maybe we should polyfill pointer events always, like in http://blogs.msdn.com/b/eternalcoding/archive/2013/01/16/hand-js-a-polyfill-for-supporting-pointer-events-on-every-browser.aspx. Having pointer events always available seems way better than having to manage touch and ouse events by hand.\n. I think we can get rid of initializeTouchEvents if we attach the listeners to the elements which have handlers attached instead of at the document level.\n. @chenglou Doesn't work in IE10 right now though, I believe.\n. @chenglou Doesn't work in IE10 right now though, I believe.\n. I think this mostly looks good though it sort of feels like overkill. I'm having trouble imagining practical situations where we'll run into trouble here\u2026\n. > What about smooth scrolling trackpads, do they trigger mouse wheel events?\nI believe they do.\nOne other use for mouse wheel events is to create Google Maps-style zooming. The more I hear, the more it sounds like mouse wheel normalization isn't worth it because it's hard and has limited uses.\n. > What about smooth scrolling trackpads, do they trigger mouse wheel events?\nI believe they do.\nOne other use for mouse wheel events is to create Google Maps-style zooming. The more I hear, the more it sounds like mouse wheel normalization isn't worth it because it's hard and has limited uses.\n. +1 from me. It would be nice to also have helper methods for manipulating the CSS classes and waiting for the transitionend events in case you want to do a CSS animation as well as something else.\n. +1 from me. It would be nice to also have helper methods for manipulating the CSS classes and waiting for the transitionend events in case you want to do a CSS animation as well as something else.\n. I think the commit message there isn't quite right -- looks like there's only a onTransition.\n. I think the commit message there isn't quite right -- looks like there's only a onTransition.\n. grunt webdriver-jasmine:saucelabs_android passes routinely on Travis now, so I'm closing this out.\n. This fails because we simulate the input event instead of the key events which the change plugin listens for.\n. Fixed by #1658.\n. @benjamn In what situation would you want to clean but not remove .module-cache?\n. I assume @zpao would then encounter a conflict when syncing\u2026\n. I assume @zpao would then encounter a conflict when syncing\u2026\n. \n. \n. In ReactCSSTransitionGroup now I believe the transition happens only for new elements, so I'm going to close this out. (And ReactTransitionGroup should be flexible enough to do any custom logic you might want.)\n. In ReactCSSTransitionGroup now I believe the transition happens only for new elements, so I'm going to close this out. (And ReactTransitionGroup should be flexible enough to do any custom logic you might want.)\n. I believe this won't properly do the transitions when transitioning away from undefined children. You instead want to treat undefined effectively the same as an empty list -- perhaps just make the change where the Object.keys call is?\n. This looks fine to me. The codepath is already O(n^2) so I suspect allocations aren't a huge deal.\n. Dupe of #527.\n. No, #493 made content above the headers clickable but broke the ability to click the headers themselves. This fixes it.\n. Perhaps. This solution is more obviously correct to me as the only element being moved around takes up no space so it won't interfere with anything else.\n. @zpao Mmkay, now a # appears on hover and looks like this:\n\n. Is it possible to reprint the failing test lines at the end? Otherwise I'm happy with the current output.\n. Related to #478.\n. Chrome doesn't fire the input event when a range is modified using arrow keys, but Firefox does.\n. In Chrome beta and Firefox, 'change' doesn't fire when dragging until mouseup so we should listen to input here too.\n. @syranide I think we should attempt to support all the built-in inputs at least mostly-reasonably.\n. @dancoates I'm sorry that this is a lower priority for us than for you. Feel free to send a pull request though! ChangeEventPlugin is a little hairy but my blog post at http://benalpert.com/2013/06/18/a-near-perfect-oninput-shim-for-ie-8-and-9.html should give you an idea of the general strategy. For range elements, we should listen to both input and change events and fire events when either happens (but only once even if both happen).\n. Why isn't this right?\n. Well, if you had specified a ref on the auxiliary component\njs\n<Tooltip ref=\"tooltip\" tooltip={<div ref=\"tip\">{this.props.tooltipText}</div>}>\n  {this.props.text}\n</Tooltip>\nthen you'd still want the tooltip and tip refs to be attached to the same component, so I decided that __owner__ is correct as-is.\n. If it helps, note that mountDepth === 0 only if the component was rendered with mountComponentIntoNode which is called only by ReactMount._renderNewRootComponent.\n. Dupe of #416.\n. The fact that keys are optional has nothing to do with this. React should have the same behavior in dev and prod but it's perfectly reasonable to throw (as now) or warn.\n. Since we already have the object in getDefaultProps, why not copy items onto that object instead of the other way around? (i.e., this.props = copyProperties(defaultProps, props); (what's the difference between copyProperties and mergeInto?)).\nWe also need to stop putting __owner__ on props. Maybe I can open a diff for that -- IIRC it's pretty easy now that we use receiveComponent.\n. @Daniel15 No problem, easy mistake to make. It's not even really a fault of the test at all.\n. Yep, if you do\nvar defaults = {banana: 17};\nvar Component = React.createClass({\n    getDefaultProps: function() { return defaults; },\n    // ...\n});\nthen all components would share a .props object. Seems unlikely though.\n. Right now I think this isn't practical because there's no way to get a list of all components that have the event handler attached, so currently the only way to create the plugin would be to have it dispatch the event to literally every element on the page.\n. You can use React.addons.batchedUpdates to get the same functionality.\n. Ah, yes. #3570 \n. As for this issue generally, see #1608. We're not planning to add this event. For many cases with popups and modals, you can add a backdrop element (either transparent or not) to capture clicks. For others, you can add a top-level listener to the document and catch clicks. #285 tracks adding a more complete solution to that, though for now manually calling addEventListener for that case is probably best.\n. @polkovnikov-ph That's not necessarily true \u2013 it depends when the other listeners are added.\n. > it would essentially be impossible\nIs that a bad thing? ;)\n. In those cases, you probably already have a bind() for each child component (either in the parent when passing the callback to the child component or in the child when attaching the handler). (If there's currently a way to avoid this, I haven't seen it.) With this change, you can avoid binding for each comment and instead pass a shared listener created using fn.curry(this) (or _.partial(fn, this)) which incurs only one function allocation for the entire feed:\njs\nvar Feed = React.createClass({\n  render: function() {\n    var onCommentDelete = this.onCommentDelete.curry(this);\n    return this.props.comments.map(function(comment) {\n      return <Comment\n        key={comment.id}\n        comment={comment}\n        onDelete={onCommentDelete} ... />;\n    }, this);\n  },\n  onCommentDelete: function(feed) { ... }\n});\nThen, the onCommentDelete handler can access the feed component as feed and the comment component as this.\n. Even if this were a better place to end up (which I'm not totally sure on), I think the switching costs here are too high to be ever feasible so I'll close this out. :(\n:)\n. I think the docs here are good enough now; haven't heard much confusion.\n. The tutorial shouldn't be the canonical reference that other things point to; I think the reference section should be self-contained.\nMaybe a new \"Special Attributes\" or \"Special Props\" section of the reference is in order that talks about children, dangerouslySetInnerHTML, key, and ref.\n. @sebmarkbage Seems reasonable, done.\n. I'm not so sure. I think we need ViewportMetrics for each window object.\n. I'm not so sure. I think we need ViewportMetrics for each window object.\n. This method doesn't exist any more.\n. Can we get a line number for the error? Highlighting the problematic line would be nice.\n. Can we get a line number for the error? Highlighting the problematic line would be nice.\n. Always copying would fix these issues:\nhttps://groups.google.com/forum/#!topic/reactjs/bo_cdp4Fxgw\nhttp://jsbin.com/oYoFUxa/1/edit\nAlso another issue I saw today where someone wanted to reuse a header row for a table in multiple places.\n. This is done now.\n. This looks great to me, thanks.\n. I guess this looks good, but maybe we should just remove the method as it seems no one is using it currently.\n. I guess this looks good, but maybe we should just remove the method as it seems no one is using it currently.\n. grunt test already builds the files necessary to run the unit tests. The explicit build is necessary only so that the packaged files can be POSTed to zpao's server from the Travis scrip.\n. I mean, you could do that but I don't see the advantage over having the logic contained to .travis.yml.\n. Maybe the best solution here is to have three test types: build, test, lint. Then we can run grunt $TEST_TYPE always, and after_script can check for build, which makes more sense anyway.\n. This change isn't useful to me personally.\nRight now we have\njs\nvar ReactComponentWithPureRenderMixin = {\n  shouldComponentUpdate: function(nextProps, nextState) {\n    return !shallowEqual(this.props, nextProps) ||\n           !shallowEqual(this.state, nextState);\n  }\n};\nThis would have to change to\njs\nvar ReactComponentWithPureRenderMixin = {\n  shouldComponentUpdate: function(nextProps, nextState) {\n    return !shallowEqual(this.props, nextProps) ||\n           !shallowEqual(this.currentState, nextState);\n  }\n};\nor more likely,\njs\nvar ReactComponentWithPureRenderMixin = {\n  shouldComponentUpdate: function(prevProps, prevState, nextProps, nextState) {\n    return !shallowEqual(prevProps, nextProps) ||\n           !shallowEqual(prevState, nextState);\n  }\n};\nif we change the signature.\n. My initial reaction is that stateTransition is too much line noise. Now whenever we want to do\njs\nthis.setState({count: this.state.count + 1});\nwe need to write this?\njs\nthis.stateTransition(function(state) {\n  return {count: state.count + 1};\n});\nFeels painful to me.\n. Yeah, I'll close this out.\n. That's odd, I wouldn't expect that code to run at all when using server rendering.\n. I think I'd rather have it as an option\u2026 or else eager people might start using ES6 syntax in their JSX code before we've decided as a team that that's okay. :)\n. I think I'd rather have it as an option\u2026 or else eager people might start using ES6 syntax in their JSX code before we've decided as a team that that's okay. :)\n. @jeffmo True.\n. @jeffmo True.\n. If I remember right, part of the motivation for this would be that external users could do require('React') matching FB's internal style exactly. However, npm package names are required to be lowercase and require is case-sensitive on Linux so that means people will need to do require('react') instead\u2026\n. If I remember right, part of the motivation for this would be that external users could do require('React') matching FB's internal style exactly. However, npm package names are required to be lowercase and require is case-sensitive on Linux so that means people will need to do require('react') instead\u2026\n. Can you send to paulshen and petehunt?\n. Perhaps yungsters or you could do a blame on getUnboundedScrollPosition.js internally.\n. Perhaps yungsters or you could do a blame on getUnboundedScrollPosition.js internally.\n. I ran react-bench and there was no significant perf difference relative to master.\n. I ran react-bench and there was no significant perf difference relative to master.\n. Yeah, that makes sense and is simpler for sure. I considered it before I implemented it.  This seemed cleaner before I implemented it; but it turns out that this way is a lot of code! I was sort of hoping that  the MountImage class could store more info in the future so you could check descendant nesting (for nested <a> tags) and things like that but it's overkill for now.\n. I'll close it for now.\n. I'll close it for now.\n. (probably you want div?)\n. This seems like a bug. At the very least, React should give you an error at render time, but this is probably completely fixable.\n. Looks good to me, thank you.\n. Thanks, I was going to point you to #642 but I see that you're the author of it!\n. Just to check -- in what situation are you currently using props to initialize state?\n. What should it even mean to include a <script> tag? If you change the contents, does it get rerun? This seems fairly react-page-specific.\n. We're getting rid of full-page rendering anyway (see #515, #585). I don't think it's worth doing anything special here.\n. We're getting rid of full-page rendering anyway (see #515, #585). I don't think it's worth doing anything special here.\n. @matthewwithanm Can you say a little more about your use case? I think we'd like to do the least surprising thing here but it's hard to know what that is; my guess is any behavior we have would be surprising in some way.\n. There are docs here: http://facebook.github.io/react/docs/multiple-components.html#dynamic-children\n. > Another I've run into is Each child in an array should have a unique \"key\" prop. Check the render method of undefined. (console.warn'd) Which happened when I had passed in an undefined function as an onClick prop.\nThis doesn't sound right. Can you provide a jsfiddle that shows this? You can also read more about they key prop at http://facebook.github.io/react/docs/multiple-components.html#dynamic-children but that' should be totally unrelated to event handling.\n. Also this doesn't make sense to me. When two functions are combined using DEFINE_MANY the return value is ignored.\n. Dupe of #580.\n. I can confirm that I saw it broken before and this fixes it.\n. I can confirm that I saw it broken before and this fixes it.\n. #1301 should have fixed this.\n. I think you forgot to save your jsfiddle, but as the console warning you get says,\nUse the `defaultValue` or `value` props on <select> instead of setting `selected` on <option>.\nIn this case, you want <select multiple value={['1', '2', '3']}> or with defaultValue if you want an uncontrolled component. For more info, see the docs on forms.\n. @sompylasar Good idea, reopening so we remember to add info about this.\n. If only someone told me I just needed to add .fast to make my code faster! This is awesome.\n. In #1089, @petehunt also lists these as good to have:\n- Routing\n- Model objects\n- Integration with a jQuery plugin (sortable?)\n. If you run git rebase -i HEAD~2 then you'll be given an editor with the last two commits -- in this case you probably want to replace the second \"pick\" with \"fixup\" or just \"f\" to combine them.\n. Known; see #183.\n. No problem. :)\n. @colingourlay I can't reproduce in IE9 on your site. You're still seeing the problem?\n. Did you forget to save your jsfiddle?\n. @sydcanem Ah, I see your problem now! You need to handle the text input events in an onChange handler and handle the enter key in a separate one. See this example: http://jsfiddle.net/spicyj/HdR6E/.\n. There isn't a single event that handles both. Why? Because there are ways to input text that don't involve the keyboard and so onChange and onKeyDown are conceptually separate.\n. Your mixin can define a componentDidMount method.\n. #776 makes it so keypress isn't triggered in any browser for special keys.\n. #776 makes it so keypress isn't triggered in any browser for special keys.\n. See #756 -- I think the ReactTransitionGroup API is flexible enough now that we don't need to do anything here.\n. See #591.\n. Benchmarks?\n. You'll want to rebase over my change merged last night which introduces a wrapUserProvidedKey function.\n. You'll want to rebase over my change merged last night which introduces a wrapUserProvidedKey function.\n. We could hash the keys but I assume that's slower.\n. Math.random() on my Chrome gives 32 bits. a double only has at most 53 anyway.\n. Sorry, no progress on this. It's hard to make this happen automatically with our current architecture.\n. I believe this was intentional -- I guess the spec says they should be lowercase. See also #482.\n. I believe this was intentional -- I guess the spec says they should be lowercase. See also #482.\n. Probably yungsters or whoever wrote fb6381fb35c8af868b5134c3d7a91699a7d01090 (I can't remember who).\n. Probably yungsters or whoever wrote fb6381fb35c8af868b5134c3d7a91699a7d01090 (I can't remember who).\n. Thanks for the test case, this pull request should fix it.\n. Thanks for the test case, this pull request should fix it.\n. Looks much better, thank you. Since (I believe) the common case will be lines of length \u2264 80, can we just show the entire line if it fits?\n. Looks much better, thank you. Since (I believe) the common case will be lines of length \u2264 80, can we just show the entire line if it fits?\n. @sebmarkbage Just updated with a pretty complete validateNodeNesting function.\n. Yeah, this will warn when putting a <tr> directly in a <table>.\n. Yeah, this will warn when putting a <tr> directly in a <table>.\n. Agree, will look at doing that when I have time.\n. @thSoft Good catch. I still want to get rid of the spans completely and think that we can do it.\n. @thSoft Good catch. I still want to get rid of the spans completely and think that we can do it.\n. (What @facebook-github-bot? No I didn't.)\n@natew I'd like to fix this sometime but it hasn't been a priority.\n. Dupe of #682.\n. Yes, I think so. It is not hard to build your own component with the same behavior and we'll be sure to explain how to ease the migration.\n. Thank you. Rebased.\n. Sorry, to clarify \u2013 onlyChild is the internal name; React.Children.only is the public one.\n. EnterLeaveEventPlugin already uses the over/out events underneath, and onMouseMove is fired way more frequently so I don't think it's a concern.\n. I don't think we're going to merge this, at least not in its current form. I also think the current ReactTransitionGroup API makes it easy enough to implement this outside of React itself if necessary.\n. No, it dates back to the public release of React. I suspect perhaps some FB internal thing uses it? No idea though.\n. Done, sorry.\n. Done, sorry.\n. Contrived example:\n<input value={this.props.text + \"}\"} />\nThe value shouldn't end at the first }; you need at least some JS parsing logic to understand that.\n. Note that (<foo>x)</foo>) is valid JSX.\n. Note that (<foo>x)</foo>) is valid JSX.\n. Sorry, I thought you were implying that you could stop parsing at the close paren. You may be right that regexes are the only tricky part; perhaps we can solve that by requiring people to wrap regex literals in parens? I think JSLint might already warn about that. Still, it does sound like we may need arbitrary lookahead to disambiguate which sounds like a recipe for confusion.\n(One other idea I mentioned to @syranide in IRC was requiring people to wrap each JSX expression in backticks, sort of like how we recommend JSX in CoffeeScript now. Obviously that's a bit of a pain but it easily removes any ambiguity.)\n. Sorry, I thought you were implying that you could stop parsing at the close paren. You may be right that regexes are the only tricky part; perhaps we can solve that by requiring people to wrap regex literals in parens? I think JSLint might already warn about that. Still, it does sound like we may need arbitrary lookahead to disambiguate which sounds like a recipe for confusion.\n(One other idea I mentioned to @syranide in IRC was requiring people to wrap each JSX expression in backticks, sort of like how we recommend JSX in CoffeeScript now. Obviously that's a bit of a pain but it easily removes any ambiguity.)\n. @QuantumInformation Probably a better question for the reflux folks.\n. TypeScript may start supporting JSX per https://github.com/Microsoft/TypeScript/issues/3203. We don't have plans to develop JSX support separately from that, so I'm going to close out this issue \u2013 but feel free to continue discussing here or on https://discuss.reactjs.org/ if helpful.\n. See http://www.jbrantly.com/typescript-and-jsx/ for an update from @jbrantly on the current state of affairs.\n. Though I agree that one component per file is probably better, I don't think it's React's job to force a particular way of organizing files.\n. Though I agree that one component per file is probably better, I don't think it's React's job to force a particular way of organizing files.\n. For what it's worth, including only some of the tags from React.DOM wouldn't give an appreciable size savings.\n. I am in favor of the idea of this new proposal, but I am a little unsure on the details. If /** @jsx React.DOM */ behaves the same way as it does now, then we again need a whitelist of HTML tags that it recognizes, and if we keep the whitelist then it seems less generalizable than would be ideal.\n. So no-namespace is good only for HTML or is will there be a configurable list somewhere?\n(My original impression from reading the docs on JSX many months ago was that it would transform <x> to React.DOM.x iff there was no variable in scope called x, which seemed very sensible to me. Someone mentioned that this mostly gets you into trouble around <i>, but it's perhaps something to consider.)\n. Hey, my suggestion could be deterministically helpful.\nI just want to make sure that if we try to make it environment-agnostic, then we actually do so, which isn't possible if we keep the hardcoded HTML tag list.\n. A little bit. I'm in favor of @petehunt's proposal but I think it solves a slightly different problem, not the original issue of #74. (For example, I don't think I could in good conscience award John's money here https://www.bountysource.com/issues/645981-allow-namespacing-in-component-names-in-jsx to someone who implemented this idea.)\n. A little bit. I'm in favor of @petehunt's proposal but I think it solves a slightly different problem, not the original issue of #74. (For example, I don't think I could in good conscience award John's money here https://www.bountysource.com/issues/645981-allow-namespacing-in-component-names-in-jsx to someone who implemented this idea.)\n. Related to #719.\n. (@simenbrekken Your workaround is the best I know of.)\n. Can you give an example of a confusing error message you're seeing and the code that caused it?\nHappy new year!\n. Ah, you must be using the prod (minified) build of React -- if you use the unminified version then you'll get useful error messages.\n. We only have one build of the transformer since it's not recommended for use in production.\n. We only have one build of the transformer since it's not recommended for use in production.\n. #833 is still open, hasn't been merged yet.\n. Probably not, sorry. Looks like there are still several unaddressed comments.\n. That one has an option to produce source map files which is a bit more complicated because it needs to integrate properly with the file watching system which currently doesn't expect multiple outputs for a single input. fc5bb9c9b254e3646b90f6b6ce37bfaf64f1129f only added support for returning the source map when react-tools is used as a node library; it didn't change the command line tool.\n. I'm not familiar with gulp-react in particular but it should be possible for it to support source maps in this new version.\n. That would probably make sense as a separate PR because we probably don't want the react-tools transform API to do the actual file writing \u2013 instead it'll need to return the source map somehow, perhaps in an object containing the transformed source and the source map since it wouldn't be able to return a single string any more.\n. __DEV__ is compiled into 'production' === process.env.NODE_ENV during the build process: https://github.com/facebook/react/blob/master/vendor/constants.js#L58-L60. The latter syntax is used by hand in the npm-react directory which doesn't go through the build process right now.\n. It's moved to a transform in the facebook/fbjs repo.. Fixed, thanks.\n. @caseywebdev Mind posting a jsfiddle showing the problem you're having?\n. No, for img load events we specifically listen on the img element itself. Your example should work.\n. Mind editing the docs to include getModifierState?\n. I can't reproduce this. With this diff https://gist.github.com/spicyj/747c79473b86bbefae0c applied, I loaded http://127.0.0.1:8000/examples/ballmer-peak/ in the console and checked React.__internals.Mount._nodeCache -- it was empty.\nAm I misunderstanding?\n. Thanks, fixed in #786.\n. This is pretty much a worst case for React because you're mutating the entire DOM on every tick so you don't gain anything from the diffing. I personally find the React example easier to reason about even in a simple example like this, but with hundreds of nodes updating on each frame you may find that it's better to do the dom manipulations by hand.\n. See #772. :)\n. @plievone Just changed it to spy on ReactMount.purgeID which should be a little more resilient.\n. @plievone Just changed it to spy on ReactMount.purgeID which should be a little more resilient.\n. Never mind, e.target isn't changed; the loop is only for determining which element to dispatch the event to.\n. Ah, this is because onMouseOver and onMouseOut aren't supported by React right now. React does support onMouseEnter and onMouseLeave which is usually what you want and works for your fiddle. #754 makes over and out work too.\n. Yes, sorry.\n. Yes, sorry.\n. There was some conversation on IRC about it being confusing -- @zpao said that it wasn't intended to be copied to all the examples.\n. Sorry for being misleading. All UI events support the detail property, but it should be 0 for all non-mouse events. You can see the W3C event docs here which indicate that .detail should be 0 for a scroll event:\nhttp://www.w3.org/TR/DOM-Level-3-Events/#event-type-scroll\n. My PR isn't merged in, but the original bug of \"detail isn't useful on scroll events\" was invalid.\n. My PR isn't merged in, but the original bug of \"detail isn't useful on scroll events\" was invalid.\n. Sorry, just in that detail isn't supposed to be a useful value on scroll events, per the W3C spec. If anything, your issue indicates a necessary docs change but not really a code change as seemed to be initially suggested.\n. Sorry, just in that detail isn't supposed to be a useful value on scroll events, per the W3C spec. If anything, your issue indicates a necessary docs change but not really a code change as seemed to be initially suggested.\n. My first attempt was to just add var __DEV__ = process.env.NODE_ENV !== 'production'; to the top of every file, but unfortunately uglify isn't smart enough to do dead code removal then. I wonder if we should have vendor/constants.js essentially make two copies of the code -- one for dev, one for prod, so\njs\nfunction x() { return __DEV__; }\nmodule.exports = x();\ntransforms into\njs\nif (process.env.NODE_ENV !== 'production') {\n  var x = function x() { return true; };\n  module.exports = x();\n} else {\n  var x = function x() { return false; };\n  module.exports = x();\n}\nso we only pay the getter cost once (per module) at require time.\n@benjamn Is doing this easy with recast? It's not obvious to me if this.replace interacts well with cloning the AST.\n. I don't think we're going to do anything specifically for server rendering other than bundling the builds in dist like @zpao mentioned, but we might change the npm package eventually to be prebuilt using closure or similar.\n. It was just an example. If that was the actual code I'd do the direct assignment like you suggested.\n. No movement, though you can already require the builds from react/dist as @zpao mentioned above.\n. @STRML The catch here is that people use envify to do dead-code elimination to remove non-__DEV__ blocks so changing our pattern here will force downstream changes.\n. var React = require('react/dist/react.min.js');\nvar ReactDOM = require('react-dom/dist/react.min.js');\nshould work, no?\n. Oh wait, you're right that react-dom does require react directly\u2026\n. @mhart I would be happy to do that, but it is important that we have a way to eliminate dev-only code in prod builds and that users of React from npm have a way to do the same. Obviously we can use whatever tools we want for our stack easily but for npm currently we suggest envify/webpack.DefinePlugin. Not inherently opposed to changing that but we'd need a good proposal and reason.\n. I mean: if you use webpack or browserify in conjunction with react from npm, you should be able to eliminate React dev-only code from your prod builds. envify lets us do that easily in browserify as it copies the NODE_ENV from when you make your build, and webpack.DefinePlugin lets you configure your build to replace production.env.NODE_ENV with a constant which then can get constant-folded and minified out. This use case is important.\n\nIf there were a way such that __DEV__ was required, or declared, per module \u2013 and code elimination still worked as it does now for the dist builds \u2013 would you be amenable to a PR along those lines?\n\nYes, if it works for the case of React devs using browserify/webpack too, not just our premade builds.\n. @STRML We'd still need everyone using React to upgrade to that version of UglifyJS so I can't promise that we'll take it\u2026\n. 2 and 3 are the most natural for many people. If you are using browserify then envify gets used automatically because of our config in package.json. Almost everyone minifies their code in prod.\nIt is true that we could recommend #4 instead for many cases, but it does fall apart in the case of requiring submodules. We don't support this for external users because we consider the modules private but the addons packages use this pattern. Various third-party projects (unsupported by us) also make use of this.\n. > I guess it's just a pity that users are encouraged to \"reach in\" to react/lib/ for various addons.\nTo clarify: we recommend users require react-addons-transition-group or similar, which (currently) reaches into react but that's an implementation detail.\n\nSo it's those doing 3 who are expecting their current UglifyJS setup to eliminate any code using __DEV__ that you're concerned about?\n\nYes.\n. @yungsters Rebased with the same check that target.ownerDocument exists.\n. Doesn't this work already? In my testing, it seems to.\n. I don't think this is the proper fix. Instead, we should change ReactTransitionKeySet.getChildMapping to not return null children.\n. I don't think this is the proper fix. Instead, we should change ReactTransitionKeySet.getChildMapping to not return null children.\n. Superseded by #829.\n. Superseded by #829.\n. @vjeux I'm actually going to leave this open for now so we remember to do the version update.\n. @vjeux I'm actually going to leave this open for now so we remember to do the version update.\n. +1.\n. I agree it is nice to have flexibility but GitHub likely needs the React site more than it needs them so I don't think the rate limit issue is pressing.\n    . +1, we can then get rid of the docblock.\n. +1, we can then get rid of the docblock.\n. I don't think we need to do anything special for shorthand properties except for the list shorthandPropertyExpansions needed only for IE8.\n. While we're at it, widows is also unitless. The counter properties mentioned in the above link don't actually take a single number.\n. Fixed by #861 -- we can discuss units more on a separate issue if needed.\n. Fixed by #861 -- we can discuss units more on a separate issue if needed.\n. Vendor prefixes are like .style.webkitAnimation from the JS side.\n. Fixed by 5abcce5.\n. Fixed by 5abcce5.\n. selected, you mean.\n. React.PropTypes.isRequired doesn't read properly to me. I'm okay with .any.isRequired.\n. React.PropTypes.isRequired doesn't read properly to me. I'm okay with .any.isRequired.\n. Does React.isValidClass or React.isValidComponent do what you want?\n. Does React.isValidClass or React.isValidComponent do what you want?\n. This isn't super actionable so I'm going to close it out. Thanks for your thoughts though! CSS transitions seem to be surprisingly tricky.\n. Isn't that how invariant works already? We can just define toString.\n. Isn't that how invariant works already? We can just define toString.\n. @zpao Rebased, sorry for the delay.\n. I believe 40b522c498a138d3ee5e7729e8e9f330feef88aa fixes this.\n. I noticed this a little while ago. I'm not sure why we need to store it on the child instance in the first place -- PR incoming.\n. I noticed this a little while ago. I'm not sure why we need to store it on the child instance in the first place -- PR incoming.\n. I don't know how this could be slower but let me figure out how to run the benchmarks we just added\u2026\n. I don't know how this could be slower but let me figure out how to run the benchmarks we just added\u2026\n. Looks about the same:\n\nIn this run it looks a little faster for some of them; I ran it again and it was the other way around for the first couple. Not a significant difference.\n(That's react-bench; I couldn't get grunt perf to work. @subtleGradient I'm getting:\n```\nRunning \"webdriver-perf:local\" (webdriver-perf) task\n\n\nError: Condition wasn't satisfied!\nFatal error: Condition wasn't satisfied!\n```\n\n\nAny ideas?)\n. Looks about the same:\n\nIn this run it looks a little faster for some of them; I ran it again and it was the other way around for the first couple. Not a significant difference.\n(That's react-bench; I couldn't get grunt perf to work. @subtleGradient I'm getting:\n```\nRunning \"webdriver-perf:local\" (webdriver-perf) task\n\n\nError: Condition wasn't satisfied!\nFatal error: Condition wasn't satisfied!\n```\n\n\nAny ideas?)\n. When you use dangerouslySetInnerHTML, React simply passes the HTML to the browser untouched and you don't get any benefit from using React. Why do you need to use dangerouslySetInnerHTML here?\n. True, just annoying when switching between branches.\n. True, just annoying when switching between branches.\n. Curious. I'll take a look later.\n. You might think that you could just call insertBefore or appendChild without ever removing the elements from the DOM but at least in Chrome, that still makes one of the iframes reload. Maybe that means we can't fix this.\n. @vjeux Your last fiddle doesn't repro the problem for me; the componentDidMount is significant.\n. I believe this was fixed by e73900dad48438c2e613c320220f495f27e99c53.\n. I believe this was fixed by e73900dad48438c2e613c320220f495f27e99c53.\n. Well, http://jsfiddle.net/E8gCL/4/ works for me now.\n. Well, http://jsfiddle.net/E8gCL/4/ works for me now.\n. (Filed #1079 which is probably the underlying cause even though the symptoms here changed.)\n. (Filed #1079 which is probably the underlying cause even though the symptoms here changed.)\n. @swannodette This works for you?\n(.renderComponentToString js/React (dom/input nil))\n. I agree that line-height should be counted as unitless (as it is now). Most of the time you don't want px.\n. (richness, stress, volume too -- all properties described here: http://www.w3.org/TR/CSS2/aural.html.)\n. All CSS properties that take only lengths are automatically pixels. lineHeight can take a length or a ratio so it is treated differently. I agree this can be confusing but don't know of a better alternative.\n. @appsforartists I guess you did propose an alternative. :) Isn't the current failure case equally prominent?\n. More importantly, why would you want weak?\n. No, oneOfType still needs to skip the warning.\n. As I understand it, Closure has default lists of externs, the names of which it will not munge. Here's the one for CSS:\nhttps://code.google.com/p/closure-compiler/source/browse/externs/w3c_css.js\nhttps://code.google.com/p/closure-compiler/source/browse/externs/ie_css.js\nLooks like everything is covered except fillOpacity. We might need to add quotes because of that.\n. :+1: \n. @radebrecht Can you test whether changing the href (without unmounting the component) works properly? My guess is it won't.\n. @radebrecht Can you test whether changing the href (without unmounting the component) works properly? My guess is it won't.\n. Going to close this out due to lack of activity, but let me know if you get a chance to test the changing href.\n. Yeah, renderIntoDocument was changed to not attach things to the document any more to make cleanup easier.\n. Yeah, renderIntoDocument was changed to not attach things to the document any more to make cleanup easier.\n. I don't think so, just remove it when you're done. See ce95c3d042309d8aced894cc6be43d7e4cf96455.\n. I don't think so, just remove it when you're done. See ce95c3d042309d8aced894cc6be43d7e4cf96455.\n. There hasn't been much interest in it and it makes the core more complicated. Do you need it?\n. Thanks, looks like this is a bug. It should be callback.call(component); like it is earlier in that file:\nhttps://github.com/facebook/react/blob/master/src/core/ReactUpdates.js#L67\n. Fixed in #876.\n. @vjeux said it needs to be there for some internal FB tests. I'd think those should be changed too; otherwise we should add tagName to all the wrappers for consistency.\n. Well, isDOMComponent should probably be false if it's a composite component.\n. I mean, they behave essentially like the composite component wrappers that they are, so that sounds sketchy to me. I can look a little more in depth later.\n. I don't see how this makes the onError situation any better.\nIt would be nice to be able to transfer a className onto a DOM component going through a few layers of composite components -- ReactTransitionableChild would certainly use it.\n. See https://github.com/reactjs/react-future/blob/master/01%20-%20Core/08%20-%20Transferring%20Props.js for the current proposal here.\n. Line endings change maybe?\n. @syranide Can you rebase this and also add tagName to createFullPageComponent? It'll fix #1185.\n. Looks like this won't work if you rebase to a commit after descriptors. We can either do like tagName: button.type.prototype.tagName to copy the tag name over or we can add in ReactDOM.js:\n``` diff\ndiff --git a/src/browser/ReactDOM.js b/src/browser/ReactDOM.js\nindex 5cd3b35..2d6d9b7 100644\n--- a/src/browser/ReactDOM.js\n+++ b/src/browser/ReactDOM.js\n@@ -47,6 +47,7 @@ function createDOMComponentClass(omitClose, tag) {\n   Constructor.prototype = new ReactDOMComponent(tag, omitClose);\n   Constructor.prototype.constructor = Constructor;\n   Constructor.displayName = tag;\n+  Constructor.tagName = tag;\nvar ConvenienceConstructor = ReactDescriptor.createFactory(Constructor);\n```\nand then do button.type.tagName. \n@sebmarkbage Do you have a preference between these?\n. value is the form value sent to the server when checked so we can't overwrite it.\n. The tests pass on a fresh clone for me, though in my usual directory I get:\n```\n\n\nnot ok 258 - core/tests/ReactRenderDocument-test rendering React components at document should be able to get root component id for document node.\n\n\nExpected 'Hello world ' to be ' Hello world '.\n\n\nnot ok 259 - core/tests/ReactRenderDocument-test rendering React components at document should not be able to unmount component from document node.\n\n\nExpected 'Hello world ' to be ' Hello world '.\nExpected 'Hello world ' to be ' Hello world '.\n\n\nnot ok 260 - core/tests/ReactRenderDocument-test rendering React components at document should not be able to switch root constructors.\n\n\nExpected 'Hello world ' to be ' Hello world '.\nExpected 'Hello world ' to be ' Hello world '.\n```\nand I haven't taken the time to figure out why.\n. The tests pass on a fresh clone for me, though in my usual directory I get:\n```\n\n\nnot ok 258 - core/tests/ReactRenderDocument-test rendering React components at document should be able to get root component id for document node.\n\n\nExpected 'Hello world ' to be ' Hello world '.\n\n\nnot ok 259 - core/tests/ReactRenderDocument-test rendering React components at document should not be able to unmount component from document node.\n\n\nExpected 'Hello world ' to be ' Hello world '.\nExpected 'Hello world ' to be ' Hello world '.\n\n\nnot ok 260 - core/tests/ReactRenderDocument-test rendering React components at document should not be able to switch root constructors.\n\n\nExpected 'Hello world ' to be ' Hello world '.\nExpected 'Hello world ' to be ' Hello world '.\n```\nand I haven't taken the time to figure out why.\n. Here's a spreadsheet:\nhttps://docs.google.com/spreadsheet/ccc?key=0AiiHBePwQn13dHBYSVBVT0VlNFhqN3JUOHFxdlBpMEE\n. Doesn't sound like we're doing this, so closing.\n. Doesn't sound like we're doing this, so closing.\n. I was wondering about exactly this just the other day.\n. This generally makes sense to me, though some people have complained when doing unit testing that React relies on document being available at require time.\n. I wouldn't know to use a .debug.js version. Ember names the prod one .prod.js which might be a little more obvious. I added https://github.com/facebook/react/commit/c877451887d1fc531e7c2637681f47cf50d6a5de to the download page but it looks like it never got cherry-picked to the stable branch.\n. Since the change in invariant error message and some tweaks I did to the website I haven't heard much confusion around this so I'm going to close this out.\n. Not sure I really see the motivation. Our current solution compresses better. :)\n. We did this.\n. We did this.\n. @syranide which presentation was this?\n. Cool. @steveluscher can you see if this commit helps your demo at all?\n. @steveluscher Really glad to hear it.\n. @steveluscher Really glad to hear it.\n. I feel that for attributes we should maintain the original spacing exactly. Line breaks are a small pain but otherwise there's no issue.\n. With react-bench, not measurably.\n. This happened.\n. Indeed we did, unless the original markup was generated by React (and has an unchanged <head>). See https://groups.google.com/d/msg/reactjs/4jI5xe7TXzQ/3sjSBbpDpEwJ.\n. Even in old IE?\n. We could also interpolate in the todo example:\n<button>Add #{this.state.items.length + 1}</button>\nbut it makes CodeMirror unhappy.\n. Want to also update the one in docs/_js/jsx-compiler.js?\n. Good find. Bisect gives 80d7d2d0f8ec0f4f1f3c2dbe613f36bda572ce11. In modern browsers, we're now handling submit events twice -- once at the form, once at document. I'll send a PR.\n. @slorber If you paste your code into http://facebook.github.io/react/jsx-compiler.html, do you still get that error? I seem to get 'Unexpected token app' which is better though obviously not great.\n. Probably also want to change the homepage to not say that the second example uses JSX?\n. Fixed by 4764585.\n. Cool. Any idea why JSXTransformer shrunk?\n. We don't have any tests that look at docs, right? I'm not sure if travis has any mechanism for running different things depending on the diff \u2013 looks like each run is independent.\n. Perhaps relevant: http://jsperf.com/style-vs-csstext-vs-setattribute/8. Not sure if I screwed something up there because when running the first snippet the boxes don't seem to appear but for the other three they do.\n. Replacing setValueForStyles with\nsetValueForStyles: function(node, styles) {\n    node.style.top = styles.top + 'px';\n    node.style.left = styles.left + 'px';\n    node.style.background = styles.background;\n  }\ndoesn't give a noticeable bump on that benchmark (possibly 5%, but hard to tell), so it's hard for me to believe there's much we can do here. Closing\u2026\n. Some browsers support assigning with hyphenated keys, but probably not all do.\n. Some browsers support assigning with hyphenated keys, but probably not all do.\n. @gaearon Perhaps another one for you!\n. No problem, whenever you have time.\n. Yes, this matches our existing practice of requiring camel-cased attributes in general, which makes it easier to make warpper components that modify props in some way because you only need to look in one place to find the original value. In addition, you don't need to worry about what happens if someone were to specify both marginLeft and margin-left in the same style block. (One last advantage: if the warnings happen only in the dev version, then there's no runtime cost in the production build.)\n. Cool, would love to see benchmarks.\n. I was thinking about 2 recently. If building the IDs is really a significant cost then I think it should help significantly.\n. Fixed by e60a893d2fe9df1181ca76f98b7e93225d2a69d2.\n. As I understand it, modern browsers ignore assignments to undefined.\n. This got merged in #939.\n. Going to close this out as it's broken in its current form. Happy to look at new PRs, though we'll need a good answer to what to do with namespaced attributes.\n. /cc @chenglou @yungsters. Looks like we should probably be recreating ReactTestUtils.Simulate whenever a new event plugin is injected. Ideas for a clean API for doing so?\n. My guess is few or none of the existing callsites should be using SimulateNative; simulating native events is useful when testing React itself or event plugins but otherwise I don't think it should be needed. If you send me more info about any failing tests, that would be helpful -- it seems likely that there are changes that could be made to this code.\n. @benjamn We don't care about people adding things to Object.prototype?\n. @benjamn We don't care about people adding things to Object.prototype?\n. The dev tools doesn't give you the ability to do anything you can't do (clumsily) by hand already.\n. The dev tools doesn't give you the ability to do anything you can't do (clumsily) by hand already.\n. Closing in favor of facebook/react-devtools#28.\n. We use phantomjs for the React unit tests and polyfill .bind here:\nhttps://github.com/facebook/react/blob/0.13-stable/src/test/phantomjs-shims.js\nClosing this out; let me know if anything else is unclear.\n. Edited my comment to work again.\n. Replaced by 5abcce534382d85887f3d33475e8e54e3b5d8457.\n. Replaced by 5abcce534382d85887f3d33475e8e54e3b5d8457.\n. We're going to do this a different way.\n. Your problem is that you're not rerendering with the new value. If you have React rerender with the new input value, then it'll know not to revert the value. (As it is, it will revert to the old value until it gets the new value after 50 ms. Changing 50 to a larger number like 1000 will make this much more apparent.) The following code should work:\njs\nvar ExampleApplication = React.createClass({\n  render: function() {\n    var model = this.props.model;\n    return <input onChange={this.nameChange} value={model.name} />;\n  },\n  nameChange: function(evt) {\n    this.props.model.name = evt.target.value;\n    rerender();\n  }\n});\nvar myModel = {\n  name: 'Input is funky'\n};\nfunction rerender() {\n  React.renderComponent(\n    <ExampleApplication model={myModel} />,\n    document.getElementById('container')\n  );\n}\nsetInterval(rerender, 50);\n(The normal way to do this when making a reusable component is to pass down a callback in props to ask the parent component to rerender.)\n. Great -- that should work too.\n. @tsheaff @mikeljames The problem is that React doesn't have enough information to do something intelligent. Assuming ^ represents the cursor, suppose the input looks like\n401^8 8888 8881 881\n(that is, between \"1\" and \"8\" in \"4018\"). Then I type a \"2\". Momentarily, the input looks like\n4012^8 8888 8881 881\nbut immediately, creditcard.parse(*).formatted returns\n4012 8888 8888 1881\nWhere should the cursor go? Even as a human looking at this, it's unclear: it could go before or after the space:\n4012^ 8888 8888 1881\n4012 ^8888 8888 1881\nFiguring this out programmatically seems impossible to me in the general case. Even if we were content to return either of those, it's hard for me to imagine an algorithm that might work reliably. Let me know if I'm missing something.\nBecause this is impossible and requires more knowledge about the specific problem space, React doesn't attempt to do anything intelligent with the cursor; you can set .selectionStart/.selectionEnd manually as appropriate for your domain. In the case of filtering out some characters it would be possible to write a more general solution but I think that may still be better left to a third-party component.\n. Actually: Stripe's jQuery.payment library preserves cursor position except if your cursor is already at the end, in which case it keeps your cursor at the end of the input. This generally feels pretty reasonable; try:\nhttp://stripe.github.io/jquery.payment/example/\nThat example flickers but that's not inherent to the strategy so we could do better. This might be more predictable in the common case, at the expense of introducing edge-case bugs because you now don't need to think about what should happen. For example, this strategy does feel broken in the case that you're typing before a space. If you have:\n4018^ 8888 8881 881\nand type a 7 you have\n40187^ 8888 8881 881\nwhich gets changed to\n4018 ^7888 8888 1881\nwhich feels wrong because your cursor should be after the 7, not before. But maybe this behavior is still better.\ncc @zpao for a second opinion.\n. That is: I'm entertaining the idea of React's <input> doing this by default.\n. Wait: this wouldn't work at all for filtering out chars because your cursor would move over whenever you type an invalid character. Maintaining the distance from the end might work though?\n. Here you can try it:\nhttp://jsbin.com/dunutajuqo/edit?js,output\nThe numbers input works great. For the CC input: If you type \"1234 5678\" and then try to type a character after the space, your cursor is in the wrong place. Similarly, typing \"1234 567\" and then typing a character before the space does the wrong thing.\n. @tsheaff That's a good opportunity for a third-party plugin but we won't put it in the core. Maybe a \"React mask component\". :)\n. My last example posted on Nov 30 keeps the cursor in the same place if you reject a change, at least.\n. @Guria Thanks for pointing that out.\n. @tibbus That is a good point. I normally think of filtering out invalid chars to make a string valid rather than rejecting a change, but I think you're right that that is a common pattern. If there is a simple way to implement this I'd be interested.. If you haven't already, can you sign the CLA? Thanks!\n. Agree that we should go with disabled=\"disabled\" or just disabled. The former is XHTML-compatible, which may be desirable. Want to take a crack at a PR for this? :)\n. @syranide Bare attributes were the standard way to do things before XHTML came along and told everyone to do disabled=\"disabled\", so it should be supported everywhere (except in XHTML documents, of course).\n. I think so.\n. (The lifecycle methods are actually documented on the \"Working with the Browser\" page, but perhaps the reference page is a better place to link to.)\n. What version of node and npm are you on?\n. Closing this out as every instance of this that I've seen has been fixed by upgrading npm.\n. We do want to support async server rendering, but I'm going to close this issue out as the original docs it asked for are done now and I think we have other issues open to track async server rendering.\n. We'll revisit this when we next redesign the website.\n. I believe if you add .done() at the end of your promise chain then Q will re-throw the exception that it previously caught (and recorded as a promise failure). Closing as I don't believe there's anything actionable for React here.\n. @sebmarkbage Any particular reason why? Currently the reconcile transactions nest without any issue that I can see.\n. @sebmarkbage Any particular reason why? Currently the reconcile transactions nest without any issue that I can see.\n. Fixes by #1363.\n. No, I suppose I assumed it would treat arrays as terminals. Underscore doesn't implement a deep _.extend because of hard decisions like this.\n. @nuragic We're not planning to add this, sorry.\n. Fixed by https://github.com/facebook/esprima/pull/8. I'm waiting for a transform sync and then we can bump the esprima version and bring it in.\n. This should have been fixed in master by https://github.com/facebook/react/commit/f0fdabae7bbeadde9245d00893b194e0310c8d9b.\n. @johnthethird Even though the generated markup changes each time, I don't think you should have any problem from caching it.\n. Nifty! Is spec.displayName always defined at this time? (If not JSX, presumably it's undefined; also it might not be defined yet if it's at the end of the spec?)\n. My inclination would be to ignore only text nodes comprised solely of whitespace.\n. @syranide I thought your PR only modified jsx -- this is about adopting server-rendered markup.\n. (petehunt says: \"We just need to change our use of firstChild in src/browser/getReactRootElementInContainer.js to be children[0].\")\n. (petehunt says: \"We just need to change our use of firstChild in src/browser/getReactRootElementInContainer.js to be children[0].\")\n. We'll hopefully have an explicit warning for this soon.\n. No, this one is actually different.\n. Thanks! If you haven't already, can you sign the CLA?\n. Thanks!\n. Thanks!\n. This should already work properly on master \u2013 __owner__ was moved off of props -- in addition, props are always copied so React should now never mutate what's passed in.\n. Before, but 0.8.0 didn't include all changes in master at the time. The two changes you'd be interested in are 61abc645e50314187850d4e04ed6d257652f1a59 and 657602135ce8a661aa1d60b338b3483d3ab505ff.\n. @sebmarkbage What would you suggest for this use case? https://groups.google.com/d/msg/reactjs/7XCeBSlO4nM/5M-LdjSm9kkJ\n. @sebmarkbage What would you suggest for this use case? https://groups.google.com/d/msg/reactjs/7XCeBSlO4nM/5M-LdjSm9kkJ\n. Sounds like a bug to me.\n. Sounds like a bug to me.\n. Thanks for reporting -- this is a dupe of #916.\n. Fixed by 7eb33ef176a458679b032f40540ae466a8a03efe.\n(cc @jnetterf)\n. Thanks! Could you please sign the CLA?\n. Looks good.\n. Thanks! If you haven't already, could you sign the CLA?\n. Looks good to me.\n. Currently, React requires a tbody to work properly, as you found. I have a pull request open (#735) to warn about this common error.\n. See #1046.\n. Ah yes; closing this one.\n. @thechriswalker So sorry, wasn't sure if you were planning to!\n. Can you update the transitions example too?\n. Like state, contexts are explicitly designed to be used with plain JS objects that get merged \u2013 contextTypes and childContextTypes are similarly expected to be plain objects. I'm inclined to wontfix this, but I'll leave it to others who've used contexts more than me. (Of course, you can use whatever objects you want as values within the context object.)\nAlso note that the API for contexts is experimental and may change any any time.\n. Wait I'm silly. You have this in #1059.\n. @zpao Not sure what you mean.\n. Objects don't have a map function. You can iterate through an object like so:\njs\nvar mapped = {};\nfor (var key in obj) {\n  if (!obj.hasOwnProperty(key)) {\n    continue;\n  }\n  var val = obj[key];\n  mapped[key] = ...;\n}\n. React doesn't provide a .map function; it's part of the JavaScript standard and is provided by the browser.\n. Done.\n. Err, wait.\n. Actually done.\n. Actually not sure why I made this a separate issue\u2026 just going to comment on that PR.\n. If we're going to use the attribute, perhaps we can just mark it MUST_USE_ATTRIBUTE and get rid of the custom mutation method; DOMPropertyOperations.setValueForProperty will call removeAttribute for a null value.\n. Hmm, looks like this will break things in IE actually:\nhttp://stackoverflow.com/questions/2490627/how-can-i-reliably-set-the-class-attr-w-javascript-on-ie-ff-chrome-etc\n. Good find.\n. Can you add a comment saying why we need to use Object.keys?\n. I'm not even sure we should run componentWillMount.\n. Not a new problem.\n. We switched to use textContent but it broke some contentEditable stuff internal to FB. @zpao knows more.\n. Right, we should also do the right thing in IE8.\n. jQuery empties then adds a text node. Relevant commits:\nhttps://github.com/jquery/jquery/commit/866187fff66ef50b9c4b4c47f332f742c7546cc5\nhttps://github.com/jquery/jquery/commit/74a132d944886379456d562990c8fb217ab332e3 (http://bugs.jquery.com/ticket/1264)\n. @jbonta I have a patch almost ready.\n. No, this doesn't fix SVG. We should do both in a way such that things still work in IE8.\n. This should have been fixed by 7a9e5443b7184986e08e411d9e9ad2d7228c7827. If you're still having trouble on master, let me know.\n. That guard immediately precedes the only call to getSelection. In the debugger, can you see what node is?\n. 31bc18d39e1c194fcd451e48964c9813b9993d27\n. @dlindahl Can you post a minimal jsbin or jsfiddle showing the problem in a new issue?\n. @syranide I'm concerned that would result in subtly broken updates for many of the attributes.\n. Is it a problem if I specify rowSpan on an input?\n. Agree that HTML and SVG attributes should be separate.\n. See also #1079.\n. @syranide _rootNodeID can be shared by multiple composite components, correct?\nThis seems like something that's fragile -- for cases where you only need a unique ID on one client but don't need it to be consistent across clients, you can make your own autoincrementing counter. For cases where you want the IDs to be consistent across clients, I don't think you can rely on this._rootNodeID because rendering components in a different order (or with server rendering, on different servers) will cause the node IDs to be different -- when you need this I think you really just want to force the person using a mixin to specify a unique key.\n. @syranide I mean if you have two composite components nested with no DOM node in between then they share a rootNodeID:\nhttps://github.com/facebook/react/blob/95edc396dfd07ed064240b5e2e1a1d5528d2d747/src/core/ReactCompositeComponent.js#L839-L843\n. @syranide I mean if you have two composite components nested with no DOM node in between then they share a rootNodeID:\nhttps://github.com/facebook/react/blob/95edc396dfd07ed064240b5e2e1a1d5528d2d747/src/core/ReactCompositeComponent.js#L839-L843\n. @laser Yeah, if all you need is a unique ID for each component then you can make a counter yourself and increment it for each new component. (We try to avoid adding functionality to React if it can be easily replicated in component code.)\n. You could use a WeakMap and store an ID for each instance. _rootNodeID was never public API and we no longer needed a unique ID on composite components so we got rid of it. Depending on your use case, perhaps you can refactor your API so that the third-party components are wrapped and your wrapper can generate an ID.\n. We should probably agree on whether we want this and how it should behave before considering implementations (unless it's just for a proof of concept).. I think we didn't want the bytes.\n. I think we didn't want the bytes.\n. @syranide No, it won't be included in the build without the require here.\n. @syranide No, it won't be included in the build without the require here.\n. Maybe just \"this.context is now overridden on component instances\"? @shauntrennery can you add this to the final blog post too (which is in the repo, just not pushed to the site yet)?\n. Maybe just \"this.context is now overridden on component instances\"? @shauntrennery can you add this to the final blog post too (which is in the repo, just not pushed to the site yet)?\n. Or maybe \"this.context on components is now reserved for internal use by React\"? @zpao also suggested maybe using the word \"reserved\".\n. Or maybe \"this.context on components is now reserved for internal use by React\"? @zpao also suggested maybe using the word \"reserved\".\n. @shauntrennery Looks like you only updated the wording on one of the files -- can you make sure to get both?\n. @shauntrennery Looks like you only updated the wording on one of the files -- can you make sure to get both?\n. @michael-jarosik Sorry, @zpao meant https://github.com/benjamn/commoner which is a library that the jsx executable uses.\n. @michael-jarosik Sorry, @zpao meant https://github.com/benjamn/commoner which is a library that the jsx executable uses.\n. Looks like you forgot to save the fiddle.\n. @eelkeh I believe this was fixed by 5545887a48468ccc8b16c88713a8eb870ba209e6 earlier today. Can you check if the build you were using was after that? (You can also use the builds from http://react.zpao.com/builds/master/latest/ if that's easier.)\n. My uninformed instinct would be to include neither but I don't have a great handle of when these are used.\n. Let's kill it.\n. Correct, this mirrors how events are fired outside of React and is expected. Having value changes trigger a change event is a good way to make an infinite loop -- if you want to call the change handler you should do so manually, as you mentioned.\n. Opinions here @jordwalke @yungsters @sebmarkbage?\n. @syranide @jordwalke Batching innerHTML setting across multiple trees like we do now could be useful for things like petehunt's sortable component (https://gist.github.com/petehunt/7882164) where each child makes a separate component root. We're only running into trouble right now when combining that with multiple updates to the same component at one time. I agree though that there is code complexity and this might not be super common.\n. @sebmarkbage Currently, when the reconcile transaction is closed, the mount-ready callbacks are executed, meaning that all DOM operations should have been flushed by that point. Like you suggest, perhaps we should change setState so that the transaction is executed later, but the current behavior is wrong.\n. Sorry, the description here is a bit out of date. The referenced issue was actually fixed by #1363 and I already added a test case for it.\nI believe that this PR should actually cause no observable differences; it just cleans up the code.\nWhen does this increase memory usage?\nWe can probably forbid componentWillUpdate from calling setState. It's already disallowed when calling setState on the component whose componentWillUpdate is running. I can do that as a separate diff.\n. It seems unlikely to me that the list of queued updates would be significant in comparison to the cost of the actual DOM nodes and component instances. Do you disagree that the queueing that ReactMultiChild does is odd and belongs in ReactReconcileTransaction?\n. @yungsters Not sure if you saw #1358 and #1363; now I believe we share a reconcile transaction in at least every case where MultiChild batched before, so we're still batching innerHTML after this diff.\n. Assuming by \"live reconciler\" you mean not pre-flattening children (cf. #942), I don't believe this makes that any harder.\nI think this is the first I've heard of \"that weird reconciling bug\"; if it's still happening let me know how to repro and I'll take a look.\n. @yungsters Today @sebmarkbage concluded it might be #1593.\n. I still think this should be merged. Last I remember, @sebmarkbage thought it was probably fine but didn't want to merge it while you were all out on vacation.\n. @yaycmyk Might happen as part of some other upcoming work. Any reason it's important to you?\n. This is just an internal refactoring, should have no user-facing changes.\n. Superseded by #5547.\nDo I get a prize for closing an old PR?\n. Unfortunately we don't hide the error even if you have the devtools installed right now. See #953.\n. (@visionscaper tip: press \"Subscribe\" on the right column.)\n. This happened in a8fc3b940dbe20c0c7decd19b028215b236c50a6.\n. lgtm. I didn't realize this file even existed.\n. @flockonus If you're using the development (unminified) version of React, you should have seen a warning in your console specifically about this.\n. @flockonus If you're using the development (unminified) version of React, you should have seen a warning in your console specifically about this.\n. @flockonus I'm going to close this out as I don't think we're going to support selected instead of value, but feel free to open a PR to the docs to make this clearer.\n. @brigand Thanks!\n. Right -- with the current code, isValidComponent returns true when passed a component class, which is wrong.\n. I was adding a warning for passing a component class to renderComponent because of this Stack Overflow question: http://stackoverflow.com/questions/21948048/react-cant-get-past-no-method-mountcomponentintonode.\n. I was adding a warning for passing a component class to renderComponent because of this Stack Overflow question: http://stackoverflow.com/questions/21948048/react-cant-get-past-no-method-mountcomponentintonode.\n. React doesn't actually look at .outerHTML but instead compares the checksum of the server-generated markup (computed before it's sent to the browser) to the client-generated markup.\nYou could try running React.renderComponentToString on server and client to compare the outputs -- make sure you're passing the same props in both cases and that each render function looks only at props and state (no Date, Math.random, etc).\n. This looks stale.\n. The exception is wrapped in a try/catch block so the exception shouldn't be bubbling up. If this is causing you trouble, please file an issue on the browserify buffer module which this code comes from.\n. Yes, we have https://github.com/facebook/react/blob/master/src/browser/eventPlugins/MobileSafariClickEventPlugin.js to fix this exact problem but it sounds like perhaps it's not working.\n. Yes, we have https://github.com/facebook/react/blob/master/src/browser/eventPlugins/MobileSafariClickEventPlugin.js to fix this exact problem but it sounds like perhaps it's not working.\n. Ever since on-demand event listening was added, MobileSafariClickEventPlugin has been broken because touchstart isn't always listened to. cursor: pointer; is an okay workaround but we'll have to fix this for real somehow, probably by having onclick handlers turn into onclick=\"\" markup.\n. This was reverted in 431155d2e231cfb65e236f9289fddf8cea291185.\n. My original PR #1536 should have fixed this but it was reverted because it was causing some problems internally at FB. I'll look into bringing it back so we can fix this for good.\n. Yes, it landed in master and will be in 0.14.\nThis diff adds an empty onclick listener so that Mobile Safari knows your div is clickable. This mirrors what would happen if you wrote onclick=\"...\" directly in your HTML or called addEventListener without using React. I'm not sure how this interacts with hover.\nWe could probably do this only on iOS but I don't know if other browsers use similar heuristics. Hopefully this has minimal performance impact but we're planning to do some benchmarking soon and if this is significant we'll figure out a way to speed it up.\n. It's fixed in 0.14 beta and will be in the final 0.14 as well.\n. As my earlier comment in this thread already says.\n. @ustun Not on this specifically, but we have no evidence that it's a hotspot.\n. I don't know of any changes in 15.0 that would have affected this.\n. @brunogarcia Can you post a jsfiddle or jsbin with this?\n. @easga @tiaaaa123 If one of you can find a simple repro case (jsbin or jsfiddle), please post it and we can dig in.\n. Try adding React.initializeTouchEvents(true) before any of your app code, if you don't have it already.\n. Let's go with #436.\n. Closing in favor of #1657.\n. a6c1b91\n. a6c1b91\n. I believe this works correctly in 0.9 -- can you confirm? You can also try at http://facebook.github.io/react/jsx-compiler.html.\n. I believe this works correctly in 0.9 -- can you confirm? You can also try at http://facebook.github.io/react/jsx-compiler.html.\n. No problem, glad you figured it out!\n. No problem, glad you figured it out!\n. We'll keep doing perf work but this doesn't need to stay open as a separate issue.\n. Looks good to me. I had the same change in #735.\n. lgtm\n. lgtm\n. @lrowe Do you mind rebasing this?\n. Seems unlikely that it would make a difference, but we may as well. Updated.\n. Related, perhaps: http://stackoverflow.com/questions/22062663/how-to-use-react-test-utilities\n. Related, perhaps: http://stackoverflow.com/questions/22062663/how-to-use-react-test-utilities\n. Interesting; it should work on the DOM component.\n. @brigand Thanks, that's a huge help. @syranide's #877 should fix this.\n. No, I don't think this has changed. setState is sync normally, async in a batched updates context (including any event handler).\n. componentWillReceiveProps is special, sorry. An outer setState like this shows the sync behavior: http://jsfiddle.net/nbyjp9Lc/2/.\n. Most (all?) of these things aren't supposed to have real prototype chains, so it's just a question of whether the property comes from Object.prototype. 'constructor' in {} is true while {}.hasOwnProperty('constructor') is false, so using hasOwnProperty should be more correct for these cases.\n. No, this test does not pass without this change. setValueForProperty isn't ordinarily called with null like I did in the test.\n. At the very least, ReactServerRenderingTransaction shouldn't need to be in ui. I haven't looked through everything.\n. Oops, yes. The PR title tricked me. :)\n. a8fc3b940dbe20c0c7decd19b028215b236c50a6\n. Are we replacing className with classList? If not, transferring props manually gets hairy because you don't know which property actually holds the classes (and what if you specify both?).\nHonestly, these don't feel that different to me:\n<div classList={['a'].concat(this.props.classList)} />\n<div classList={['a', this.props.classList]} />\n<div className={'a ' + this.props.className} />\nso I'm in favor of leaving things as-is.\n. @zpao @sebmarkbage What's happening here?\n. We're not planning to do this for now so I'm going to close it out \u2013 we can always reopen later if we do want it.\n. We could potentially also ignore everything after the first child with a given key, so\n<div>\n  <div key={1}>A</div>\n  <div key={1}>B</div>\n  <div key={3}>C</div>\n</div>\nrenders A C only.\n. 8855d6153e252c735de0e6cc373787d22c1a467b fixed this, I believe.\n. After a component is unmounted, it's possible its instance will still be accessible if a reference was saved to it, in which case isMounted() will return false.\n. I downloaded the starter kit once because the page told me to and then didn't know what to do with it. I don't think we lose anything by removing it.\n. Sounds like you got react-tools by mistake. By the way, 0.9.0 final is out so you can drop the -rc1.\n. This got done. :)\n. lgtm\n. Want to move cloneWithProps into the beforeEach too for consistency?\n. This should already work fine on master.\n. Unfortunately this won't work with object destructuring, like\njs\nvar {class, color} = this.props;\n. @zpao Why not? Surely you guys don't want to worry about quoting your reserved keys for IE8.\n. Yeah.\n. I wonder if we should just have a separate page talking about debugging and the dev tools. We could talk more about the prod vs. dev builds there too.\n. Yeah, this is definitely better than what's there.\n@LilyJ Thanks for sending this in!\n. Yeah, this is definitely better than what's there.\n@LilyJ Thanks for sending this in!\n. Yeah, we're going to do that once we figure out how pending state works. I believe we still want to flush any updates within the same event loop though, so this change will still be helpful.\n. Fixed in 9ffd70c6.\n. No, it doesn't. Still a good idea though.\n. No, it doesn't. Still a good idea though.\n. Thanks for reporting. I verified that #1157 doesn't fix this (even though it fixes another bug that produces the same error message).\n. Thanks for reporting. I verified that #1157 doesn't fix this (even though it fixes another bug that produces the same error message).\n. This happens because we enqueue a removal of the children, then set the HTML before the queued removal happens. When the queue is processed, the element is missing which confuses React. If we queue the innerHTML set as well then this will be fixed.\n@kcarnold As a workaround for this bug, you can assign a different key prop to each div and React will create a new element instead of reusing the existing one.\n. This happens because we enqueue a removal of the children, then set the HTML before the queued removal happens. When the queue is processed, the element is missing which confuses React. If we queue the innerHTML set as well then this will be fixed.\n@kcarnold As a workaround for this bug, you can assign a different key prop to each div and React will create a new element instead of reusing the existing one.\n. No, it's still broken (but it throws a slightly different error).\n. (#1280 got rid of the tools page on the site.)\n. Should be better now due to #5753.\n. Would be nice to share logic with quoteAttrName in xjs.js.\n. Would be nice to share logic with quoteAttrName in xjs.js.\n. Looks pretty reasonable. I'll let @jeffmo review and merge.\n. Closing in favor of #1539 which does the same thing and is a little cleaner -- thanks for sending this in though!\n. @syranide Was this fixed?\n. Sorry to hear that!\n. Doesn't setState throw too on an unmounted instance?\n. Doesn't setState throw too on an unmounted instance?\n. (Tangentially related to #1240.)\n. Going to close this in favor of #1539, which is a little cleaner. Thanks for sending this in!\n. We should just make noscript do this automatically, sort of like our existing wrappers for input, select, and textarea. Want to take a crack at it?\n. We should just make noscript do this automatically, sort of like our existing wrappers for input, select, and textarea. Want to take a crack at it?\n. @matthewwithanm I'm guessing the IE8 problems you saw in #1327 won't be a problem here -- want to try the same renderToStaticMarkup approach?\n. Correct me if I'm wrong, but the contents will be used only if the browser doesn't support iframes, which basically all browsers that support JS should?\n. React shouldn't look inside the iframe unless you change the contents later.\n. This would also definitely fix our initializeTouchEvents problem. I don't know the perf impacts of not bubbling to document though.\n. It's really a function of the topLevelType topTouchMove, not the event that you wrote there. For naming, delegate: false might be clearer.\nRight now I don't believe we ever remove listeners.\n. It's really a function of the topLevelType topTouchMove, not the event that you wrote there. For naming, delegate: false might be clearer.\nRight now I don't believe we ever remove listeners.\n. Are you sure it's before the DOM nodes are created? Regardless, probably you want to tie it to the transaction -- you can see how ReactReconcileTransaction stores a queue of componentDidMount callbacks (ON_DOM_READY_QUEUEING/ReactMountReady) and a queue of listeners to put (PUT_LISTENER_QUEUEING/ReactPutListenerQueue). If the put listener queue can't easily be modified to do what you want (though I'm guessing it can), you can make a new transaction wrapper and add it to the list there.\n. > No, createElement: false is only used for validating server markup on the client. Its result is thrown away.\nWait, I don't think that's true. We use it only when rendering on top of server markup, but when called on the client it does need to attach event handlers! Like Seb said though, server rendering attaching code needs to get rewritten soon for Fiber so we're not sure what will happen.. Sorry, I haven't been following this whole thread \u2013 I just saw the one comment and it seemed wrong. In the div > tr example, why are we doing anything with event listeners? I must be missing something because I would have assumed we skip all the events code for that test.\nWe do have a public Messenger room at https://m.me/g/Abas8IcWxIvjVxHN which everyone is welcome to participate in. I'm usually responsive in close to real time and happy to answer questions.. I'm afraid this behavior is intentional so that you can write things like onChange={isEnabled && this.handleChange}, and I don't think we're going to change this.\n. I'm afraid this behavior is intentional so that you can write things like onChange={isEnabled && this.handleChange}, and I don't think we're going to change this.\n. Similarly, you could write onChange={isEnabled ? this.handleChange : null} or something along those lines. We've felt like that is the most helpful behavior; it's convenient to have falsey handlers be ignored, just like null and false don't render anything when included in an element's children.\n. Similarly, you could write onChange={isEnabled ? this.handleChange : null} or something along those lines. We've felt like that is the most helpful behavior; it's convenient to have falsey handlers be ignored, just like null and false don't render anything when included in an element's children.\n. I personally find it much weirder that false is ignored; it doesn't surprise me that null is. With props, we consistently assume that undefined is equivalent to not specifying the prop at all (like when merging in the result of getDefaultProps) so it would definitely be a change to treat undefined as invalid here. \n. I personally find it much weirder that false is ignored; it doesn't surprise me that null is. With props, we consistently assume that undefined is equivalent to not specifying the prop at all (like when merging in the result of getDefaultProps) so it would definitely be a change to treat undefined as invalid here. \n. See #1255.\n. See #1255.\n. This docs page will soon be replaced by the wiki; feel free to add it here:\nhttps://github.com/facebook/react/wiki/Complementary-Tools\n. Thanks! Do you think you could add a couple tests and comments explaining the purpose and to make sure this works?\n. Thanks! Do you think you could add a couple tests and comments explaining the purpose and to make sure this works?\n. You should be able to render an SVG node then set its className and verify that the class was changed properly. See DOMPropertyOperations-test.js for our existing tests.\n. You should be able to render an SVG node then set its className and verify that the class was changed properly. See DOMPropertyOperations-test.js for our existing tests.\n. Did you run the tests? I would think expect(svgNode.className).toBe('foo'); would fail because .className should be an object, not a string -- right?\n. Did you run the tests? I would think expect(svgNode.className).toBe('foo'); would fail because .className should be an object, not a string -- right?\n. I understand. I guess it's not practical to test this in phantomjs, so I'm fine landing without tests.\n. I think that's best unless you have a better idea.\n. phantomjs is actually using a really old version of webkit so I'm not that hopeful. We do have a way to run tests in real browsers via saucelabs but right now all the tests are meant to pass in phantom.\n. I think we might be best just leaving off the tests here.\n. Looks good to me, thanks.\n. Just put up #1590 which is an alternative approach.\n. Not quite sure what you mean. If you don't attach any events to your elements then there shouldn't be any overhead from the events system.\n. Not quite sure what you mean. If you don't attach any events to your elements then there shouldn't be any overhead from the events system.\n. @jaredly You're seeing lag that goes away when you use native event handling? I'd be interested in seeing a test case that shows that.\n. @jaredly You're seeing lag that goes away when you use native event handling? I'd be interested in seeing a test case that shows that.\n. No plans to do this.\n. This docs page will soon be replaced by the wiki; feel free to add it here:\nhttps://github.com/facebook/react/wiki/Complementary-Tools\n. Thanks!\n. Thanks!\n. @frikille Is TransitionEvent defined or undefined on that browser? When the unprefixed version exists it's better to use that in general because it's more forwards-compatible.\n. I like it.\n. Looks good to me, thanks.\n. If you require React after defining window and document (i.e., in your beforeEach function) I believe the error will go away. Can you confirm?\n. Can you confirm you put this line in the beforeEach as well?\nvar utils = React.addons.TestUtils;\nReact doesn't use any variables called utils in its source, so I assume missing that is the problem.\n. Sorry, can you make sure:\n- global.navigator is defined\n- the React and utils variables are declared (but not set to any value) in the top-level scope\n- React is required in beforeEach\n- utils is set in beforeEach based on the result of the React require\nWith all of those, does it work? If not, what error do you get?\n. If they're declared in the beforeEach block, then the variables are scoped to that function and no one else can access them. This way, the variables are shared across the file but they're initialized at the start of each test.\n. @bkonkle What if you also require CastawayApp in the beforeEach section? Since it depends on React you want to require it at the same time. This test https://gist.github.com/spicyj/8b1bb6485321be906370 passes for me when run with mocha.\n. If you're requiring all of your code at the top of your file instead of in a beforeEach, it's fine to require React there too, but the window and document globals should be present at the time React is required.\n. No, you shouldn't have any problem using renderComponentToString.\n. You can also re-require all the libraries in a beforeEach call in your tests, to make sure that each test is completely separate. See this example of how to do it in jest:\nhttp://facebook.github.io/jest/docs/tutorial-react.html#content\n. Going to close this out for now, but if you get a chance to update it, let us know!\n. It seems that you might instead want a function that gets called on the next tick regardless, in which you could check whether or not the component has updated. I'm not sure which is more useful.\n. It seems that you might instead want a function that gets called on the next tick regardless, in which you could check whether or not the component has updated. I'm not sure which is more useful.\n. I'm not actually sure this makes sense. I think we want something that resolves immediately if no state updates are pending. I might have a slightly better handle on this after #1373.\n. Currently, updates are only batched inside a React event handler so when writing tests you shouldn't have any problem with asynchronicity. That is, this test should consistently pass:\n``` js\nit('updates the value of input.foo with the current state.value', function(done) {\n  expect(1);\nsetTimeout(function() {\n    component.setState({value: expected});\n    expect(component.getDOMNode().querySelector('input.foo').value).to.be(expected);\n    done();  // (mocha-style async callback)\n  }, 10);\n});\n```\nMaybe I'm missing something but I am having trouble imagining cases where this helper would be necessary and thus find it hard to reason about potential APIs.\n. Going to close this out for now until we hear more concrete use cases \u2013 let me know if that's a problem for anyone.\n. Sounds like this was merged internally.\n. Yeah, unfortunately mouseEnter/mouseLeave don't get simulated properly at the moment due to their unique bubbling situation. The biggest blocker here is picking a good API, I think.\nMaybe just Simulate.mouseEnterLeave(from, to)?\n. Yeah, unfortunately mouseEnter/mouseLeave don't get simulated properly at the moment due to their unique bubbling situation. The biggest blocker here is picking a good API, I think.\nMaybe just Simulate.mouseEnterLeave(from, to)?\n. Yes, it's due to bubbling. If you have the DOM structure\n<A>\n  <B><C /></B>\n  <D />\n</A>\nand your mouse moves from C to D, then C and B receive mouseleave events, D receives a mouseenter event, and A receives nothing. All other events bubble up to the root.\nPerhaps it's good enough to just make simulated mouseEnter and mouseLeave events not bubble at all.\n. (As a workaround for now, you can use SimulateNative.mouseOver and SimulateNative.mouseOut (making sure to specify relatedTarget appropriately on each) and together they will cause React to fire onMouseEnter and onMouseLeave events.)\n. @Kureev This was fixed in #1366 in April as you can see a few messages up; it'll be in the 0.14 release. If you search \"workaround\" on this page you'll see that I also posted a workaround over a year ago.\n. Closing in favor of #1657.\n. We're going to replace that page with the wiki; feel free to edit it directly:\nhttps://github.com/facebook/react/wiki/Complementary-Tools\n. ViewportMetrics is used to normalize pageX and pageY on mouse events: SyntheticMouseEvent.js#L63-L73. Perhaps ironically, it was created to prevent synchronous layouts during mouse event handlers.\n. I agree that we shouldn't be tracking it in other browsers if we don't need it. I don't know if there's a way to predict whether we'll have .pageX and .pageY before mouse events actually come in.\n. @lo1tuma Is that your site? If so, you can try commenting out the logic in refreshScrollValues to see if it makes a difference. If it does, I'm happy to prioritize @syranide's #2271 and try to get it in.\n. This agrees with what @ide suggested in #699 (edit: #669). \n. @markijbema Can you add the missing e argument and make sure the code works as intended? Guessing this didn't get tested properly because it should have thrown a ReferenceError as it is now.\n. I believe this is still correct.\n. I believe this should be fixed at a higher level; we're passing operations to DOMChildrenOperations in a way that isn't expected.\nMy #1157 fixes one of these causes. Can you try applying it to see if your problem is fixed? You might also be running into #1232 which I haven't had a chance to fix yet.\n. I believe this should be fixed at a higher level; we're passing operations to DOMChildrenOperations in a way that isn't expected.\nMy #1157 fixes one of these causes. Can you try applying it to see if your problem is fixed? You might also be running into #1232 which I haven't had a chance to fix yet.\n. Well I'd be interested in seeing a repro if you can produce one. Ideally an isolated one but if you can't reduce it I'd be interested in looking at a live app showing the problem if you'd be able to send me the link. (You can see that the reduced repro case in #1147 was fairly complicated!)\n. Well I'd be interested in seeing a repro if you can produce one. Ideally an isolated one but if you can't reduce it I'd be interested in looking at a live app showing the problem if you'd be able to send me the link. (You can see that the reduced repro case in #1147 was fairly complicated!)\n. Is there a reason you can't perform your animation on componentDidMount?\n. You can already use ReactTransitionGroup for a single child, correct?\n. Can you give an example of something that doesn't work? You can transition from 0 children to 1 child and vice versa; the animation hooks will be executed at the proper time.\n. Closing -- let me know if you're still having problems.\n. @sebmarkbage Anything we can do here? #2687 is another request for this.\n. @andreypopp Mind rebasing? This has since moved to src/class/ReactClass.js.\n. Closing due to lack of activity, and mixins are now a legacy feature that we'd like to avoid changing unnecessarily.\n. I'm confused. Disregarding the static typing argument, this shouldn't break any existing code and only interacts badly with object maps as children, where you still need to pass null. (And I'm assuming from the monitorCodeUse that you're looking at getting rid of that?) Individual props can be strings, but the props object shouldn't be a string. String children will still work here.\n. Makes sense. (Sorry, I misunderstood what you said about ReactTextComponent.)\n. Maybe call it just PureRenderMixin?\n. Maybe call it just PureRenderMixin?\n. Might make sense to wait to do this until after @sebmarkbage's inverted-control stuff.\n. Might make sense to wait to do this until after @sebmarkbage's inverted-control stuff.\n. Closing in favor of #1711 which solves this problem and actually has a concrete API proposal attached.\n. I'm not quite sure what you mean. Could you provide a code sample?\n. I'm not quite sure what you mean. Could you provide a code sample?\n. I see, you want to traverse the output of the render function, which is quite different from this.props.children, which is an input that you could do anything with (it's no different from other props except for the little bit of sugar when creating components).\nIt's hard to say for sure without a more specific example, but you may want to use refs which allow you to grab a reference to a mounted child component if you need it. This mailing list thread might also be interesting to you: https://groups.google.com/forum/#!topic/reactjs/z7xzqcIwOUg.\n. I see, you want to traverse the output of the render function, which is quite different from this.props.children, which is an input that you could do anything with (it's no different from other props except for the little bit of sugar when creating components).\nIt's hard to say for sure without a more specific example, but you may want to use refs which allow you to grab a reference to a mounted child component if you need it. This mailing list thread might also be interesting to you: https://groups.google.com/forum/#!topic/reactjs/z7xzqcIwOUg.\n. We're planning to add a warning for this (#932).\n. Thanks!\n. Hey, thanks for submitting this. I looked into it and though this error is confusing, it's actually due to your use of tr elements nested directly in table elements -- the browser adds a tbody which confuses React and eventually results in this error. If you add a <tbody> around the rows, the error goes away. (In addition, you shouldn't be nesting a <span> directly within a <table>.) I expect we'll be able to fix this error eventually but it won't happen immediately since there's an easy workaround.\nI'm going to close this out because your proposed fix still isn't quite what we want but I just filed #1323 to keep track of this bug.\n. I improved this error message a while ago in 945d041160cb2fca3bde2c2422c46e6fe99af4dd and there's no immediate action we can take here now.\n. Makes sense. We might also put it in SyntheticEvent.destructor, which is perhaps what you meant.\n. Closing as a duplicate of #669.\n. Oops, not a dupe of #669.\n. From the small amount of research I've done, it's not trivial to detect the end reliably. Perhaps just waiting the length of the transition duration is the best approach here \u2013 though I'm unsure if you run into lots of problems with that being out of sync with the actual animation.\n. Yeah, this is unfortunate and something we don't have a great solution for. Khan Academy's TimeoutTransitionGroup has worked for several people in the linked issue #1707:\nhttp://khan.github.io/react-components/#timeout-transition-group\n. TimeoutTransitionGroup, like CSSTransitionGroup, uses TransitionGroup to do CSS animations. If you're triggering them by hand there's no reason to use TimeoutTransitionGroup.\n. Going to go with #4561 I think.\n. @oozaa That was a separate issue which should also be fixed.\n. In 0.14 RC you're asked to specify durations, so this is fixed.\n. ReactTransitionGroup itself shouldn't have any issues since it doesn't have anything to do with transition events.\n. I think this looks good, though I'd probably call it ReactDOMNoScript.\n. Yeah... maybe you could argue that textarea is one word though. I don't feel strongly.\n. Going to close this out for now because there's not much improvement we can make here immediately. Thanks for sending this in though! I think we may be able to make this really work in the future after some upcoming refactors of the core.\n. As a workaround, you can write\n<div dangerouslySetInnerHTML={{__html: '<noscript>...</noscript>'}} />\nand React shouldn't get confused even if the noscript disappears.\n. See #1314.\n. No problem; it's easy to see that only the immutable tests are failing. Also we'll try to keep the tree green. :)\n. It looks to me like all of these tests are comparing against an object literal.\n. My guess is you essentially need a Map in order to deep clone or compare equality with cycles supported. (Presumably it's possible to polyfill by just storing an array of the keys but it wouldn't be fast.)\n. This is a pain to do as it's currently set up because the warning happens when the descriptor is created, not when it's mounted. It seems to me that we want to check sometime during mounting anyway; you could imagine a composite component (like @andreypopp's Router) that doesn't care about the order of the children because they're never mounted.\n. Example:\n``` js\n/* @jsx React.DOM /\nReact.renderComponent(\n  {[, ]},\n  document.body\n);\n```\nThis actually happens because we don't provide key warnings on top-level components right now. Seems like we may as well; they'll just be less useful without owner info.\n. (Fixed by af3c04b43ba1c6c9d72f53618a5d34601e653848.)\n. I'd actually lean towards not having trailing slashes in any of the tags, in an \"it's not XHTML\" argument.\n. Makes sense. I didn't realize there were attributes like this.\n. This has gotten stale (sorry for the long delay). You can now use any tag names, and we'll hopefully be rid of the attribute whitelist soon.\n. I don't love the name CAN_BE_MINIMIZED. I'm leaning towards either HAS_OPTIONAL_BOOLEAN_VALUE or CAN_HAVE_BOOLEAN_VALUE, though both of those are longer\u2026\n. Thanks!\n. (I assume you mean #1058.)\n. > I agree a random key is the worst key one can use, but it's still better than no key at all.\nIf no keys are provided, React uses the index in the array which is almost always better than a random key.\n. Are you sure you're on 0.10? #1193 should've fixed that and appears to be in the release for me.\n. Make sure you're using 0.10.0 of JSX as well, whether that's JSXTransformer.js or react-tools.\n. I believe this can be an automated conversion of the TextMate grammar?\n. It's likely that in the future we'll have this case not crash at all, but just give a warning; see #566. We'd also like to be able to show problems like this in context in the dev tools.\n. Is that not two keystrokes? I'm not sure off the top of my head why it would be called twice\u2026\n. Well, you can see that Mixin.initializeAll appears separately below the two \"get selectionStart\" calls so there are two separate updates occurring; I'm not sure exactly how you're triggering updates but perhaps you can combine them into one, which should make things faster.\nIt sounds like we used to maintain selection state by avoiding moving the <input> during reconciliation -- @jordwalke @vjeux do you know about this?\n. Right -- the problem is that we don't know to save the selection until we're removing the element (or something along those lines), so we're currently proactive about it.\nIf you're in a React event handler, things should be magically batched for you already. If you're not, try requiring react/lib/ReactUpdates and then doing like\nReactUpdates = require 'react/lib/ReactUpdates'\nx.onkeydown = ->\n  ReactUpdates.batchedUpdates ->\n    # all your handling inside this callback\nand React should combine all setState calls into one.\n. That's great to hear. Sorry it's not a part of the public/documented/supported API yet; we're working on making automatic rAF batching work well and I also have #1060 open to expose the batchedUpdates function.\n. (I'll also remind you that if you run with NODE_ENV === \"production\" your code will be faster. :))\n. Also, it still looks like you're running two updates? Are you triggering an update from componentDidUpdate or similar?\n. accept\nI was going to do this but didn't get around to it. Fixes #1333.\nclowncopterize\n. I think the only thing here that might be sketchy about perf is the creation of the displayNames object?\n. Is this supposed to be faster? My guess is it makes no difference.\n. I don't think this adds much so I'm going to close it out -- let me know if I'm missing something.\n. Interesting. Summary: When mounting something like:\n<div>\n  <A />\n  <B />\n</div>\nIf B calls setState on A in B's componentWillMount, then the DOM won't be populated with A's HTML yet. I suppose the setState call should be queued until A's componentDidMount is called.\ncc @sebmarkbage \n. #1363 fixed this.\n. Sorry, what's strange? Unlike mousemove, touchmove always fires on the element that received touchstart. In my limited testing, browsers happily send events to that removed element.\n. You can test http://jsbin.com/gocuhifa/1 on device or in Chrome/Firefox with touch events enabled (touch down on \"monkey\"; it'll disappear; move your finger and you'll get an alert).\n. Hmmmm maybe this isn't supposed to work:\nhttps://docs.google.com/document/d/12-HPlSIF7-ISY8TQHtuQ3IqDi-isZVI0Yzv5zwl90VU/edit#heading=h.q2zqz8v0mja7\nI sort of feel like it should still work in React just as well as it does in the browser though.\n. See also the W3C public-webevents list where I asked about this behavior.\n. This question is likely related: http://stackoverflow.com/q/24537000/49485.\n. https://plus.google.com/+RickByers/posts/GHwpqnAFATf also.\n. @aweary Too late for breaking changes for 16, let's look at doing it in 17. Can probably land soon after the release behind a flag.. (Depends on #1362.)\n. I'm sure you figured this out weeks ago but along with this change, ReactART needs to reference ReactUpdates.ReactReconcileTransaction instead of ReactComponent.ReactReconcileTransaction.\n. I think I'd be okay with this. Want to send a PR?\n. No. The \"component\" you pass to renderComponent is a descriptor containing little more than a JSON object specifying the type and props of the component you want to render. renderComponent will simply update the props (and run React's entire diffing algorithm to only update the DOM with necessary changes). You'll see that the componentWillUnmount/componentWillMount methods are not called (at least at the top level) when you change the props in this way.\nIn fact, React.renderComponent just ends up calling replaceProps (in ReactMount.js#L251), but this is an implementation detail. Using renderComponent instead of setProps is generally preferred because declarative APIs make your app easier to reason about.\n. Yeah. I can change it back if you like but this order is used everywhere else. The existing order would be especially weird if we were to add the ability to provide an argument too.\n. cc @cpojer \n. Yeah, I saw. Enter/leave are now in the spec and I think they work the same way you did?\nI didn't have great ideas for a simulation API for that though -- see #1297. I figured direct dispatch is simple and is 99% of the time what you need in a test.\n. @ryanzec Thanks for the nudge \u2013 we had some concern over whether this is the exact final API that we want, but this is an improvement so I agree we should probably merge it.\n@zpao r?\n. @ryanzec Thanks for the nudge. :)\n. Yes.\n. See #1255; it's intentional that you can have a sometimes-null event handler.\n. ReactCSSTransitionGroup is a higher-level API; if you want to do something more complicated then you can do something using the lower-level ReactTransitionGroup API. It's more or less an implementation detail of ReactCSSTransitionGroup that it uses ReactTransitionGroup under the hood.\n. I don't think we're going to do this, sorry -- see #1307.\n. In addition, the point of the cumbersome name is to make you think each time you use it. Setting a global config option once won't have that effect.\n. I don't see any advantage to adding innerHTML; people will invariably use it to introduce XSS holes. \n. What's wrong with dangerouslySetInnerHTML? It sounds scary and it is.\n. Sorry, can you clarify what the behavior is before and after this change? The usual way to get rid of the warning is to assign array indices as keys in cases where using them is reasonable.\n. Going to wontfix this as I don't think there's a real use case, let me know if you disagree.\n. This makes a lot of sense to me, though I guess I'm not totally convinced of the need for it to be async. I'd expect most uses to be in mount-ready handlers though I suppose it's possible for a DOM event handler to be called when an update is pending.\n. Do you have a plan for what to do with descriptors that are mounted in more than one place?\n. Does this mean that if a child never mounts its argument, the ref will \"hang\" and never resolve? That sounds odd to me.\n. Presumably the same thing should happen if a ref isn't used at all? I guess that would make a reasonable API, but unless I'm missing something, each ref object won't know which component it belongs to (alternatively, a component won't have a list of all of its refs) and thus can't know when to mark itself as rejected.\n. With this API you wrote out, there's no way to get a component instance, only a DOM node; this means you can't call methods, etc. on child components. Intentional?\n. Well sometimes you want a ref to a composite, right? I haven't thought about it much but that sounds like an odd plan to me. The uniform .getDOMNode() across all types of browser components right now is pretty nice.\n. In any case, we need to figure out what to do with these wrapper components -- if DOM node instances diverge from composites, it's going to be odd when you write <input ref={this.myInput} /> expecting a DOM node and you get a composite in return.\n. I think I like it. It looks a little mutative because of the explicit assignment, but I guess it's not actually any worse than the other APIs we've written out.\n. @sebmarkbage When updating, do refs get called on every rerender? (Or maybe even if shouldComponentUpdate returns false?)\n. So if I render <Foo /> then render <Foo ref={(f) => this.foo = c} /> on top of it, the ref is never called?\n. In conventional usage though it'll be a different function each time, yeah?\n. HTML entities are interpreted within JSX attribute values. You can use &amp; or enclose the string in curly braces to use ordinary JS string parsing:\n<Hello name=\"Jhon &amp; Mary\" />\n<Hello name={\"Jhon & Mary\"} />\n. Ah, this is because React doesn't let you unmount the HTML <title> element. I don't believe there's a workaround right now, sorry.\ncc @petehunt \n. Fixed by #1559.\n. Either of these can work.\n. I'm don't think that'll completely work; React will still assume that you won't remove its root element. If you add another <div> wrapper around div.g-page there it should be fine.\n. @pspeter3 0.12 doesn't support classes in this way yet, but once we support ES6 classes then type will be the class, not the factory.\n. @jedwards1211 Unlikely. We'll probably recommend using a ES-future syntax feature when it lands: https://facebook.github.io/react/blog/2015/01/27/react-v0.13.0-beta-1.html#autobinding.\n. Do you mind signing the CLA?\n. So on a fresh clone or if the web worker test is failing you need to run grunt build:basic build:test? I guess I'm okay with that.\nMaybe call the option --filter? I also feel like maybe it would make more sense to take a full filename instead of part of a glob, but I suppose it's okay as-is too.\nMerge at will.\n. Had this idea in the shower half an hour ago, let me know if I'm crazy.\n. I believe so.\n. Correct.\n. Just fixed by #1410. :)\n. lol\n. Good catch. If #1358 and #1363 don't fix this (guessing they won't) then I'll fix this afterwards.\n. Fixed by #1363.\n. I would believe that we are supposed to use the right document when creating nodes.\n. +1 from me.\n. e9c00b1\n. I'm guessing this is a dupe of #1169 -- can you try adding React.initializeTouchEvents(true); before rendering anything to confirm that this is the case?\n. Ahh, I believe this is because the touchstart listener in our MobileSafariClickEventPlugin doesn't ever get attached. I'll add a note on that issue and close this one though -- as a workaround you can set the CSS style cursor: pointer; on the element and iOS Safari will trigger the click event.\n. (cc @joelburget @jacktoole1)\n. Well, we could do type=\"text/jsx;harmony\" or similar; that's used to specify JS language versions in Firefox.\n. Feel free especially since this isn't a regression.\nOn Sat, Dec 3, 2016 at 10:44 AM -0800, \"Brandon Dail\" notifications@github.com wrote:\n@spicyj IE8 support was dropped, can we close this?\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly, view it on GitHub, or mute the thread.\n. Yeah, this is unfortunately the case right now. We could look at finding the actual minimal set of mutations for reordering a list; I think it reduces to longest increasing subsequence.\n. There is a componentWillMount method and it's called when doing server rendering. Let me know if I'm missing something here.\n. The linked SO question has an accepted answer, so closing.\n. It's possible to have a composite component that returns an <option>, in which case this solution unfortunately won't work. I believe @sebmarkbage is working on refactoring the core in a way that will make things like this more feasible.\n. Going to close this out for now as it won't work in the case I described and it's not easy to fix currently -- we can revisit after the upcoming refactors. Thanks for sending this in!\n. I think it's clearer if you just pass a lambda to createTransferStrategy that calls merge with the arguments flipped; that way in the code, the descriptor's props are always on the left and the owner's props on the right.\n. Want to submit a PR? Will close this in favor of #1400.\n. We should be able to make value work always without making a new progressValue prop.\nThe two important things is that we don't set value to the current value if it matches (that causes weird things with the cursor sometimes) and that null turns into an empty input box, not the string \"null\" (which I think it does in old IE if you do .value = null). If just doing MUST_USE_ATTRIBUTE doesn't work cross-browser, then we can probably make a custom mutation method -- perhaps checking node.tagName but perhaps we could do something craftier like checking if defaultValue is present (and using the property accessor if it is, the attribute otherwise).\n. We might be able to do a variant of @syranide's #870 to prevent detaching inputs from the DOM unnecessarily, which I believe alleviates the need for this transaction wrapper.\n. No objections.\n. (Does jest help here?)\n. Agree that fixing DOMPropertyConfig is preferable to a wrapper.\n@syranide Not quite sure what you mean about shouldIgnoreValue, sorry?\n. I don't think we're going to do it this way, so I'm closing this out. Hopefully one of the other solutions will make it in soon.\n. Why?\n. I think we can move it to dependencies, though it's a little silly in either case to require people who might not be using browserify to install it. @petehunt Any objections?\n. It's used as a browserify transform when building a bundle so needs to be required then. It's not used before npm so doesn't belong in devDependencies.\n. No, that's for the non-npm (browser) builds. envify is referenced in the browserify transform array here:\nhttps://github.com/facebook/react/blob/master/npm-react/package.json\n. I see process.env.NODE_ENV many times in the resulting file, but presumably this means envify is indeed not working properly.\n. Ahh you're right. Any objection to moving it from peerDependencies to dependencies then? Seems to still work in my testing.\n. Okay, will do. I don't think it's any different from what we have now except that it won't share a preexisting envify dependency. (That is, people who don't want envify get it now already.)\n. If you want more control over an input's value, you probably want to use a controlled component (with value= instead of defaultValue=) as described in this page:\nhttp://facebook.github.io/react/docs/forms.html\nYou'll need to set an onChange handler and handle changes appropriately.\n. If you're using an uncontrolled component, you can also put a ref on the input and manipulate its value directly. React just gives you a base <input> component which you can build higher-level abstractions over if you need them, but controlled components are applicable as-is to many scenarios. See also:\nhttp://facebook.github.io/react/docs/two-way-binding-helpers.html\n. defaultValue is read only on initial render, not afterwards. This is because the desired behavior is unclear if the user has changed the field -- do you want to blow away their changes? Usually not.\n. What if someone types into the input field before your ajax call returns? It's unclear to me why you seem to claim that neither controlled components nor manual DOM manipulation work for your use case.\n. Your problem is that you were also animating the width at the same time as -webkit-transform, so the last <li> would wrap to the next line until the width reached its final value (which would happen as the transition ends). If I change the CSS to:\n-webkit-transition: -webkit-transform 300ms;\n-webkit-transition-timing-function: ease-in-out;\nthen it works properly. Here's an example:\nhttp://jsfiddle.net/9RrAN/2/\n(This is not related to React in any way.)\n. Can you provide a jsfiddle/jsbin example of what you mean?\n. In addition to the CLA, the gh-pages branch is auto-generated -- do you mind creating a new PR to master changing the markdown in the docs folder?\n. I can't immediately repro this. You can see from the source of traverseAllChildren.js that the intent is certainly to treat a single child as the same as an array:\nhttps://github.com/facebook/react/blob/master/src/utils/traverseAllChildren.js#L121-L124\nIf you could post a jsfiddle or jsbin that would be helpful. In either case, it shouldn't be hard to use 0.10.0 or a nightly from http://react.zpao.com/builds/master/latest/.\n. Closing, but @gaearon if you can repro let me know.\n. Would be nice if we could fail if tests actually fail but not when they time out like they seem to do often.\n. Yes, this is intended -- if you want more control you can use ReactTransitionGroup directly.\n. I'm not sure when I would ever click a Like button on docs or a tip.\n. Maybe? I am not a big Social Person either.\n. #1363 should fix.\n. Guessing that #1363 fixed this.\n. This is actually autogenerated from markdown in the master branch (docs folder) -- can you sign the CLA and reopen as a separate PR there?\n. Thanks!\n. Can you be more specific and post the exact error message you encountered?\n. Nothing planned; I'll close.\n. I can't repro this:\nhttp://jsbin.com/ditulapo/1/edit\n. Sorry, what's wrong with DOMAttributeNames as it is now?\n. Sorry, what's this MUST_DELETE_PROPERTY for?\n. I see. It doesn't make sense to me to use removeAttribute for MUST_USE_PROPERTY ones; shouldn't we only use removeAttribute if we set it with an attribute?\n. Yes, thanks @zpao. That is approximately the comment I would have written after getting a chance to inspect the list more carefully. Maybe in MUST_USE_PROPERTY cases we can set it to the original value (getDefaultValueForProperty) and then also call removeAttribute?\n. @danielschonfeld Any chance you can make these updates? No problem if you don't have time but if not I'll close this out.\n. @danielschonfeld No problem. I'll close this out for now so it's not sitting around but if you do have time please push an update and let me know; I'm happy to reopen it.\n. With the JSX transformer, scripts are already not loaded at onload I think. We were using setTimeout 0 in a few places in our code at KA because of this (now integrated properly with our build process so it's not necessary).\n. Fixes by #1558.\n. @sebmarkbage Let me know if this is crazy. Currently if you have two copies of React and do:\nvar descriptor = React1.DOM.div();\nvar component = React2.renderComponent(descriptor, el);\ncomponent.getDOMNode();\nthen component believes it's in the React1 universe, so component.getDOMNode() calls ReactMount1.findReactNodeByID, which can't find the element because ReactMount2 is the one keeping track of the container.\nI know you're planning to make descriptors not depend on React itself but in the current system, this seems to be a problem. I assume some methods other than getDOMNode have the same problem.\n. (Someone ran into this today when trying out Jest and I've seen it a couple times in the past with tests too.)\n. @sebmarkbage Can you review? Adding ?w=1 to ignore whitespace may help.\n. What if the two versions of React are different and incompatible? In general it's unsafe to rely on globals like that. It should be safe to load multiple copies of React on a page, provided you don't mix components between them (imagine an ad or other embedded widget using React). \n. A coworker just ran into a similar problem when mixing React versions with the error:\n\nUncaught TypeError: Can't add property _mountIndex, object is not extensible\n. It's expected that this doesn't work currently; closing as a dupe of #1445.\n. Good idea, done in c913c95.\n. This happens because React.DOM.input is secretly a composite component instead of a pure DOM component like div and span is. I'm unsure what the correct behavior here is.\n\n@benjamn @sebmarkbage opinions?\n. Thanks -- closing as a dupe of #1376.\n. No problem, thanks for reporting.\n. Closing in favor of #1657.\n. Didn't your analysis conclude that walking the tree is already fast and so this should be fine as is?\n. Yeah, we should merge this for now -- if we decide to change how event handlers are done in general later then we can do that.\n. I believe that the reason this is required is simply so that Safari can show the active style on the right element; you want each \"distinct\" clickable element to highlight separately, but you don't want subelements to get highlighted by themselves if they go to the same place as their siblings.\nI can only assume that cursor: pointer would have the same overhead and I prefer this solution as it doesn't require browser sniffing or otherwise messing with CSS.\n. No, you only want to add onclick=\"\" to the element that has the handler.\n. If you upgrade npm, this error should go away.\n. Closing as a dupe of #1326.\n. No problem, thanks for reporting!\n. .push() can take multiple arguments, which might be faster.\n. @jordwalke What do you think of this?\n. You can use JavaScript comments if you wrap the comment itself in curly braces:\n<div>\n   {/* In JSX you can escape with the { and } characters. */}\n   {this.state.value}\n</div>\n. Yeah, quoting as a plain JS string is the way to do it. Let us know if this poses a problem for you somehow.\n. We agreed today that we'll do this; I'll rebase when I get a chance.\n. @sebmarkbage did this in c4658c1728b39c452a86f371ecb1c51874456107.\n. Thanks!\n. I think so. You also wanted some test cases around cloneWithProps and transferPropsTo. Do you want to support having more than one ref? Right now cloneWithProps just warns you if you clone a component with a (string) ref.\n. This doesn't work on initial render because of how the batching currently works and also doesn't work if you access it outside of a lifecycle method, like in an event handler. Not sure how serious a problem that is for you @jordwalke.\n. I'm not sure this works correctly with chained dependencies. See my test case in #1540 -- I wrote an implementation similar to this and it didn't pass.\n. There aren't any tests for this, no. It would be cool to load the scripts in parallel but run them in order, but this is fine too.\n. @syranide tick is executed in the onreadystatechange callback.\n. @nhunzaker Thanks!\n. @nhunzaker Looks pretty reasonable at a first glance. It might be nice to run scripts as soon as they're loaded if all the scripts before them have also loaded (but not if it'd add a lot of code complexity). Either way, could you open a PR with this when you're ready so I remember to look at it?\nThanks!\n. @fleaflicker Not currently, though it's possible we could add something for that if you open a separate issue, but if you load your second (pure-JS) file with JSXTransformer as well (using type=\"text/jsx\") then it'll be run after the first one loads.\n. I believe this breaks the onChange event on <input type=\"text\">. Did you test it?\n. @eddhannay It's intentional that onChange fires on every change; this is one place React intentionally deviates from the DOM spec.\n. @eddhannay (That is, it's basically a polyfilled onInput that works for non-text inputs as well like checkboxes. See http://benalpert.com/2013/06/18/a-near-perfect-oninput-shim-for-ie-8-and-9.html for some more info about the implementation.)\n. Going to close this out for now, but if you could change the plugin to listen to both input and change on range inputs (but leave events for other inputs the same), please do open a new pull request!\n. I believe this is intended; context follows the \"owner\" hierarchy, meaning that B does not get A's context because A didn't create B.\n. \"A custom data attribute is an attribute in no namespace whose name starts with the string \"data-\", has at least one character after the hyphen, is XML-compatible, and contains no uppercase ASCII letters.\"\nhttp://www.w3.org/html/wg/drafts/html/master/dom.html#custom-data-attribute\n. I wasn't contradicting this PR.\n. Can you log the this.type.displayName too and something to distinguish the two renderComponent calls?\n. Looks good to me.\n. Or perhaps add it to ReactBrowserComponentMixin? Not sure.\n. react-art also uses it: https://github.com/facebook/react-art/blob/c719f03/src/ReactART.js#L184-L189.\n. Yeah, I rewrote all of this.\n. I'm pretty sure I want to solve this higher up. At any rate, it should be a separate diff.\n. @callmevlad Curious: Why do you care?\n. Cool, thanks for the context. Webflow looks sweet. :)\n. cc @plievone @petehunt @benjamn \n. (Looks like the tests don't pass yet, will fix.)\n. Unfortunately uglifyjs isn't smart enough to strip out the DEV-only code then.\n. :+1: \n. It's available on npm:\nhttps://www.npmjs.org/package/jsx_whitespace_transformer\n. promiseIndexes is a list of indexes into _promises, so I believe this is correct as-is.\n. I think #1575 makes this logic clearer.\n. @fisherwebdev Can you review?\n. Before #1480, it looks like waitFor([7, 3]) would return [_promises[0], _promises[1]]. With the current committed code it returns [_promises[3], _promises[7]] and with my change here it should just return [_promises[7], _promises[3]].\n. I'll take that as approval and just merge it myself. :)\n. Wouldn't existingChecksum be \"0\" and thus be truthy? I don't know that there's any advantage to removing the attribute.\n. The spacing here looks a little wonky.\n\n. Thanks!\n. #1363 fixes this.\n. It was merged! This should work now in master.\n. Sorry, how does this differ from merge? A code example would be helpful.\n. If I understand correctly, you want something like:\njavascript\nReact.addons.update(coolObj, {idToObjMap: $mergeDeep: {1: {someVal: false}}});\nIs that right?\n. Haven't heard other complaints of this so I'll close. Would consider a PR though.\n. facebook/esprima#20 was merged; we can close this after a version bump.\n. Because you're applying a function? I can see how $map would make sense though.\n(Closing since this now exists!)\n. I'm not 100% convinced that we can't use invariant() for prop types in dev only, especially given that the implementation here of warning() is not very aggressive.\n. I believe this already happens; let me know if it doesn't.\n. Doing mixins first is more intuitive to me because that's normally how people write the specs (in my experience, at least).\n. @gaearon Go for it! Let me know if you have any questions; I'm happy to help.\n. cc @zpao @yungsters @sebmarkbage @syranide\n. Not sure what the deal with that is -- if you run into more problems, please report back.\n. Why does it return null if mounted by ReactTestUtils? That doesn't make sense to me.\n. It would be nice if one misbehaving component doesn't break the whole page. My guess is if we're careful about it we can make it happen. Not sure if any added try/finally calls would be a significant cost \u2013 hopefully not!\n(Though in the general case where DOM manipulation can throw and can throw asynchronously (think web workers!), error recovery might not always be possible.)\n. Dupe of #2461.\n. For range inputs, we need to listen to both the input event and change event because as your research in #554 showed, not all browsers fire change. (We should not fire two events for a single change though even if we get both native events.)\n. This patch isn't quite what we want \u2013 we'd instead like onChange to fire whenever the value changes (which probably means listening to both native events). If you want to take this on feel free to open a new PR \u2013 it'll probably take a bit of refactoring to ChangeEventPlugin.\n. Note that after my change was made, @sebmarkbage made a change to cache the result of getDefaultProps across instances so now you can't refer to the current instance as this there. The proper solution is to do:\n``` js\n...\nhandleMouseOver: function(e) {\n  if (this.props.onMouseOver) {\n    return this.props.onMouseOver(e);\n  }\n  // default behavior here\n}\n``\n. In getDefaultProps you can't accessthis` any more; it is called only once and refers to the class instead of the new instance being created. That is, if you have\nvar A = React.createClass({\n  getDefaultProps: function() {\n    console.log(\"getting default props!\");\n    return {width: 120};\n  }\n});\nReact.renderComponent(<A />, node1);\nReact.renderComponent(<A />, node2);\nthen the default props will be looked up only once and shared, instead of twice as they were before. There's no way to do what your original example is aiming for using only transferPropsTo. You have to specify the handler explicitly when rendering.\n. It is a breaking change. That's why I'm telling you here and why it'll be mentioned prominently in the release notes. Mixins are generally not the preferred way to share functionality. I don't know you exact use case but you might be able to do something similar with composition like this:\n``` js\nvar Highlight = React.createClass({\n  highlight: function() {\n  },\n  unhighlight: function() {\n  },\n  render: function() {\n    return (\n      \n        {this.props.children}\n      \n    );\n  }\n});\nvar Paragraph = React.createClass({\n  render: function() {\n    return (\n      \nHello\n\n    );\n  }\n});\n```\n. If you haven't already, can you sign the CLA at https://code.facebook.com/cla? Thanks!\n. I don't think so; getDefaultProps definitely runs before componentWillUpdate and this is basically the start of the mounting process.\n. There's no way to write arbitrary HTML (well, you can with the dangerouslySetInnerHTML property but then you're on your own); React builds all the HTML itself. Source code looks something like\nrender: function() {\n  return <a href=\"hello\">click me</a>;\n}\nwhich is statically transformed into\nrender: function() {\n  return React.DOM.a({href: \"hello\"}, \"click me\");\n}\nwhich React then produces markup for using this code, so there's never an opportunity for an unquoted attribute value to be made.\n. @thaggie Oops -- can you sign the CLA at https://code.facebook.com/cla?\n. I would have said it's clearer to take it out of RESERVED_SPEC_KEYS but then you still need to special-case skipping it in the loop, so I think it's fine as you have it.\nYeah, unfortunately lint is a little too picky on some things and doesn't pass right now.\n. Yup! This looks good to me now. :+1: \n. As the underscore in front of its name suggests, _lifeCycleState is private to React and you should not use it in your own code.\nThere's no current way to get a reference to the mounted children instance, but you can use a ref if you wrap them in another div:\njavascript\nvar Wrapper = React.createClass({\n  showPopup: function() { alert(this.refs.childWrapper.getDOMNode()); },\n  render: function() {\n    return <div>\n      <div ref=\"childWrapper\">\n        {this.props.children}\n      </div>\n      <button onClick={this.props.onUpdate}>update</button>\n      <button onClick={this.showPopup}>show popup</button>\n    </div>;\n  }\n});\nHope that helps.\n. Sorry, there's no way right now to get a ref to children that are passed in. After #1373 it may be possible to do so using cloneWithProps.\n. Ah yes, you're right on both counts.\n. I haven't heard anything like this, and I can't really help you debug without more information. Things to consider are: When the clicks fail to register, do other events on the page work? Do the clicks fail to work for an entire page load or do they work intermittently for a single page load?\nClosing as this isn't really actionable. The email group or Stack Overflow would probably be a better place to get help unless you can make a small, reproducible test case showing a bug in React.\n. This is a known bug; a few PRs are open with possible fixes, like #1590.\n. This was a bug fixed in #1363 so a docs update shouldn't be necessary.\n. cc @yungsters \n. Yes, this can make sense for most events, which is why I'm a little bit reluctant. setCapture isn't really the same thing but I suppose I see the parallel.\n. Yeah, I don't have real ideas here so I'll just close this out.\n. Well, perhaps we could still check against React's node cache. I've seen a few people get confused when trying to integrate React with an external sortable plugin because the plugin moves the nodes around and then React can't find the right ones.\n. We also wanted this at KA two weeks ago.\nFor naming, I was thinking perhaps map or dict. Using map is nice in that it matches the ES6 Map, but perhaps also confusing for the same reason.\n. Sorry for the extreme delay on this. We haven't heard much confusion around RequireJS, it feels anecdotally to me that people are moving away from it in favor of Browserify and Webpack, and this is a little outdated (our fault, not yours) and inconsistent with the other examples (file extension, actual example contents) so I'm going to close this out, but thanks for sending this in!\n. My first instinct would be to say that you can use exactly one directive or do nested updates, not both.\n. We're not planning to add more utils like this to TestUtils. You can always implement this locally in your project as a helper if you want to, but we're planning to move towards shallow testing (i.e., TestUtils. createRenderer) in the future.\n. #1511 fixes this.\n. fixedit\n. (After #1254 is fixed we shouldn't need initializeTouchEvents at all\u2026)\n. Also note that this appears 5 times in the tutorial and the line highlights are messed up by adding a line.\n. I think @andreypopp has reported this before, not sure if we have another issue open.\n. No, that made it in; this is a slightly different issue.\n. You can't do setState in conjunction with server rendering; your componentInstance variable merely describes what component instance to mount; it is not an instance itself so setState doesn't work on it. There isn't any way to get a component instance when using server rendering.\nIf you want to \"change the state\" and get a new HTML string, you should probably instead refactor your logic so that props determine what the component shows (rather than state). Then you can pass a new \"descriptor\" to renderComponentToString.\n. Thanks! This is actually autogenerated from the source in docs/ on the master branch:\nhttps://github.com/facebook/react/blob/master/docs/_posts/2013-06-05-why-react.md\nMind making a new PR to master?\n. Do you mind signing the CLA? Thanks!\n. Closing in favor of #1657.\n. This is intentional; context is determined by where a component is created (in your mount() function), not where it is rendered (in your App component). Also note that context is experimental and likely to change in future versions.\n. Want to send in a pull request? I don't think any of us are very familiar with component but we'd be willing to consider a PR if it doesn't add much complexity.\n. Our browser builds have a UMD wrapper so should set module.exports when appropriate, but we don't store prebuilt versions in the repo and right now we need a build step to run the files. I don't see how to instruct component to run any sort of build script or to use a pre-built version that doesn't get committed so it might be hard to make this work with our current setup.\n. For npm we can (and do) run the build script before packaging. I don't see a way to do the same thing with component.\n. Oh, perhaps we can even use the same repo.\n. @akre54 Can you be more specific about what doesn't work with webpack?\n. Can you explain the error you get or what specifically doesn't work? An exact configuration (and command line arguments) to reproduce the problem would be helpful too so I don't have to guess.\n. No problem, thanks.\n. @akre54 The UMD wrapper is provided by browserify; we don't do anything special there.\n. Thanks!\n. lgtm otherwise!\n. Yay. :+1:\n. @ToucheSir The main purpose of keyMirror is to deal with the fact that Closure Compiler advanced mode crushes keys, which allows you to write code like\nkeyMirror({monkey: null, gorilla: null})\nand have it become something like\nk({m:null,g:null})\nwhich evaluates to\n{m:\"m\",g:\"g\"}\nat runtime. If it was specified as a list of strings, they wouldn't get crushed matching the property names.\n. You can't.\n. See my comment on June 5 for the answer to your question.\nkeyMirror isn't and has never been a supported API of React. I'm going to lock this conversation to reduce noise.. You can already achieve a similar effect using transferPropsTo:\n``` js\nvar PostLineItem = React.createClass({\n  getDefaultProps: function() {\n    return {\n        typeImage: '/imgs/post-default.jpg'\n    };\n  },\n  render: function(){\n    return (\n      \n\n        {this.props.title}\n      \n    );\n  }\n});\nvar NewsPostLI = React.createClass({\n  render: function() {\n    return this.transferPropsTo(\n      \n    );\n  }\n});\nvar MemePostLI = React.createClass({\n  render: function() {\n    return this.transferPropsTo(\n      \n    );\n  }\n});\n```\n. If you want to take the passed-in prop value, you can do something like this:\nvar EmailLoginBox = React.createClass({\n    render: function() {\n        return this.transferPropsTo(\n            <LoginBox usernameLabel={this.props.usernameLabel || \"Email\"} />\n        );\n    }\n});\nYou can also do more complex things like combining the passed-in label with your default if you want to.\nBecause this is the recommended way to write this code, I'm going to close this out but let me know if I'm missing something else.\n. Isn't it in the spec? http://www.w3.org/TR/DOM-Level-3-Events/\nIE and jQuery have both supported it for many years.\n. (I'd personally prefer that we go the other way and not add px to strings that look like numbers, as I mentioned in #1357.)\n. @syranide I'm not sure what value that would give over just writing the strings verbatim?\n. This is an intentional deviation from HTML because usually you don't want extra whitespace between tags. See here for a summary of the current rules:\nhttp://facebook.github.io/react/blog/2014/02/20/react-v0.9.html#jsx-whitespace\n. You can already use map and return null or undefined for the elements you don't want to display.\n. This won't work for updates; the code will need to use setAttributeNS.\n. Closing in favor of #1657.\n. I am pretty sure this is an oversight in src/core/ReactPropTypes.js. Want to submit a pull request to fix?\n. Strings, numbers, and arrays are already considered renderable even though you can't render them standalone.\n. It would be nice to be able to wrap attributes in general though to do things like autoprefixing.\n. You should have seen a warning in your console about this if you're using the dev build of React.\n. This happens when an image loads that React has unmounted from the DOM. This should be fixed in master \u2013 sorry for the trouble.\n. cf. https://github.com/facebook/react/pull/1473#issuecomment-41952920\n. :+1:\n. Maybe we should have a version of this that works properly in prod mode.\n. @petehunt \n. Oh, so it does. Closing this issue \u2013 @drscre let me know if I'm missing something.\n. Yes; the last couple of releases have had transitional code to warn if you're relying on the mutation of the descriptor that we did in previous versions; in master (and the next release) we don't mutate descriptors and it's safe to reuse them.\n. @matthewwithanm I might be misunderstanding what you're saying, but React will reuse the component instance (doing an update instead of unmount/remount) as long as the props match, regardless of if the actual descriptor object is reused.\n. Not that I know of. This isn't really the right forum for a question like this; you might have better luck on the mailing list but I can't promise anything.\n. It's impractical for us to add JSX support to every editor out there; you may have more luck making a feature request for NetBeans. We use issues on this repository are used for keeping track of bugs in React itself.\n. #2069 requests support for image.\n. @jeffkole Be careful when doing that \u2013 React will still call setAttribute (not setAttributeNS) if the attribute changes, and the update probably won't work properly.\n. We haven't figured out how namespaced attributes will work and don't support it right now, sorry.\n. Sorry, no.\n. cc @xymostech @MichelleTodd\n. Not on this specifically, but #3718, #3763 are both SVG things being worked on and #3067 is also related to this attributes change.\n. Like @zpao said, we're going to fix this for good soon so any attributes can be used.\nLocking this issue until then.\n. Looks pretty good to me. After getting camelize synced out let's do camelizeStyleName instead of unhyphenateStyleName.\n. What do you think about also warning if someone writes Ms instead of ms (and possibly wrong casing of the other vendor prefixes as well)?\n. This is intended; see #1484. Because the user could have an option after the initial render, React won't blow away their selection when updating.\n. @syranide It's only set in the destructor which isn't called if .persist() is. I've intentionally created the property even in prod; we try hard to avoid any observable behavioral differences between dev and prod and you could perhaps loop through the properties of an event and somehow get confused.\n. Tips for reducing the hidden class impact here? I made an attempt to set it as soon as possible \u2013 does it need to be in the constructor instead?\n. Reverted in 92d2dcc.\n. If you call node.focus() then focus handlers are triggered immediately, so I believe you can have two focus events in flight at the same time.\n. You should see the full error message, and I do when going to that page:\n\nI recall a Chrome bug that causes the error message not to be shown, though I thought it was fixed in the current builds. We'll do a better job of warning you exactly what the problem is when #101 gets properly implemented.\n. Chrome bug here: https://code.google.com/p/chromium/issues/detail?id=331971\n. This was fixed in Chrome. Also I added a better warning for this particular problem.\n. To be clear: the root ID and checksum differ each time, but the same root ID is used on the client when generating the markup, so the checksums generated on the client should match if nothing else is wrong, even though the server produces a different checksum each time.\n. If you add a breakpoint at the console.warn call (in ReactComponentBrowserEnvironment.js), you can inspect markup and compare it to the server-rendered version.\n. I'm confused; you shouldn't see data-react-checksum in the client-side generated markup \u2013 addChecksumToMarkup is called only from renderComponentToString.\n. Instead of adding whitespace, can you paste the two versions exactly?\n. Odd, I'm not sure. You could also try adding debugging to ReactMarkupChecksum.addChecksumToMarkup on the server to see what markup looks like and compare what you get from running adler32 on it. Your guess is as good as mine now though.\n. Sorry \u2013 to be clear, that's not a workaround; you should have to write &amp;. I opened this issue so we can provide a better error message.\n. @sebmarkbage We should at least make [<a />, <b />, undefined] pass the renderable check, no?\n. @sebmarkbage Isn't this a reasonable piece of code to write in render?\n```\nvar left;\nif (showLeft) {\n  left = ;\n}\nreturn (\n  \n    {left}\n    \n\n);\n```\nI guess that's not 100% the same as what we're talking about here, but it's close.\n. I sort of have a plan to rewrite and reorganize the docs\u2026 we'll see if I get the energy to execute on it.\n. The main reason (I believe) that this doesn't exist already is that on the client side, you basically always want to show some sort of loading indicator instead of deferring rendering. (It would also make the code significantly more complex, but we can probably deal with that.)\n. @NickStefan We don't currently support per-component async fetching. We'd like to add it. This issue tracks our progress, though no one is actively working on it and it will take major restructuring so it will be a while.\n. In master the callback isn't called immediately but it looks like we have a bug where it's not called at all (which you can repro by using http://react.zpao.com/builds/master/latest/react-with-addons.js on JSFiddle).\n. #4171 should have fixed this. The callback fires on the client but not the server.\n. Can you post a jsfiddle with a minimal repro case? (What browser?)\n. No, events are all handled synchronously right now.\n. @chenglou No, the logic is inverted.\n. displayName is part of the supported API; see http://facebook.github.io/react/docs/component-specs.html#displayname.\nNormally I lean towards just always doing it as in the first example, though it might be nice to special-case exports.\n. I think it's likely that we'll do this, possibly as the default behavior.\n. After my #2540, React will warn you automatically if you mutate this.props.\n. As with #1682, we're not likely to change the behavior of cx due to the unique way that it's used at Facebook internally. You can of course just use your own version if you prefer to have the fallback though \u2013 it's simple enough that it shouldn't be a maintenance cost at all.\n. At some point, checking argument types for all the functions feels like extreme overkill, but I probably wouldn't be opposed to asserting that the second argument is a function, especially because forEach(fn) silently does nothing instead of throwing an error.\n. Haven't heard much desire for this so I'm going to close. It sounds like a likely antipattern to me to have a component that sometimes receives context from a parent and sometimes doesn't.\n. A couple more comments but I think this should be good to go afterwards.\n. @sebmarkbage Curious \u2013 do you have a benchmark for this or are you assuming it's slower?\n. Here's a build of this version, hopefully it works for you:\nhttps://s3.amazonaws.com/uploads.hipchat.com/6574/26709/yXvD7Jm5JM0NBjs/react-pull-1759.zip\n. @Tvaroh No, it will not be in 0.11. It might be in 0.12 or it might not be. I haven't even tested to see if this fixes the rAF batching problem. rAF batching is not ready for use in production.\n. @Tvaroh Sorry, I see. Controlled components won't work as-is for you as they assume you'll update the state value immediately. My best suggestion is to make your own wrapper around <input/> like Om does.\n. Using controlled components with requestAnimationFrame batching is not currently supported and this PR doesn't attempt to fix it.\n. This makes the tutorial harder to understand and as far as I can tell, doesn't fix anything.\n. (Republished.)\n. Note that this same error message is hardcoded in another place \u2013 can you update both?\n. @petehunt Want to expose ReactPerf in addons this time?\n. Oh hey, it's there. We should document it.\n. Static functions are now autobound to the class instance, which breaks code we had which did:\n``` js\nvar Buttons = React.createClass({\n  statics: {\n    buttonSetsType: React.PropTypes.arrayOf([\"basic\", \"trig\", \"prealgebra\"])\n  },\n  ...\n});\n// ...\npropTypes: {\n  buttonSets: Buttons.buttonSetsType.isRequired\n}\n```\nbecause .isRequired is no longer defined on the function. @sebmarkbage Should we suck it up and just rearrange the code? I can do Buttons.buttonSetsType = ... instead.\n. #1840 \n. Shipped!\n. Perhaps you can install jsx on a machine that has internet then tar up the node_modules folder and send it over?\n. Something like:\n```\nmkdir throwaway\ncd throwaway\nnpm install react-tools\ntar czvf node_modules.tgz node_modules\n...\ntar xzvf node_modules\nnode_modules/.bin/jsx ...\n```\nshould work.\n. Are you talking about this page?\nhttp://facebook.github.io/react/docs/component-specs.html\nEasy to change \"Invoked once when\" to \"Invoked once before\" \u2013 is there something else you were hoping for? It already says \"This method is invoked before getInitialState and therefore cannot rely on this.state or use this.setState.\".\n. Thoughts? Haven't benchmarked or tested in IE8 yet.\n. b tag was just a change in the source when testing, not a bug.\n. That's why I use .children instead of .childNodes. I believe this works fine.\n. Yup \u2013 script tags don't get styled and you won't ever get them as the target of a mouse event. I think it's a minor improvement but am willing to drop it in favor of fixing this properly later.\n. I'll close this out but we can bring it back if we later decide we want it in.\n. I'll think on it.\n. wfm already in chrome 36.0.1985.125, chrome 37.0.2062.20 beta, firefox aurora? this seems like a fine change regardless though\u2026\n. Yup, in e6134c307e2bb7765aaa747eb5d2136fc18abbd7.\n. This probably isn't actually very necessary. I upgraded all of KA's transferPropsTo by hand and it wasn't hard.\n. @chenglou I think it's valuable to mention it here too.\n. Yes, the docs are correct in this case. Thanks for looking into this though!\n. if (__IE8__)\n. Yeah, unfortunately this is hard right now. Some of the changes we're making with ES6 classes will make this simpler.\n. Sorry, I don't have anything to point you to right now but I'll come back and update this issue when we do have something.\n. For components that are implemented as ES6 classes, you should be able to mock the class methods using jest's (or any other framework's) standard mocking mechanisms; there's nothing React-specific necessary to do any more. If that's not the case let me know and I'll reopen.\n. Was the old one broken w/r/t whitespace handling, and this one works properly?\n. Closing this as a dupe of my #1366 which is a little more robust and contains a test. (Still not completely sure if we're going to merge it though, sorry.)\n. We don't plan to do this, but with ES6 class support you can make your classes however you like.\n. We're doing our best to simplify the React core as much as possible, which in this case includes slowly moving away from React.createClass and towards ES6 classes, so we're not planning to add more helpers for making classes. As you say, you can easily reimplement the same functionality yourself if you need it.\n. I don't think this is React's job. We do make sure that React works properly when html5shiv is included (see #1030) but just like React doesn't ship with polyfills, it shouldn't ship with this. You also don't need this code unless your app uses the new elements.\n. This will likely be more possible after #1373.\n. This is probably something we should fix in React.\n. In jsdom, window isn't the global, right?\n. Can everyone who's interested in this list the specific modules/functions you're interested in? We intentionally ship a small public API so that we can feel free to make internal changes.\n. cx is public as React.addons.classSet so that falls into almost the same category as cloneWithProps. What are you using EventListener for?\n. Okay, going to count that feature request as a vote for #285.\n. It's unlikely we'll ever expose ReactTransitionEvents as a public API as it's just a thin wrapper around browser events and is used only in ReactCSSTransitionGroup, not more widely. (Essentially, we don't want to commit to supporting that module.)\n. :+1: I suppose.\n. Yeah, I believe we run propTypes validation silently upon descriptor creation in 0.11 but only emit the error when mounting. In master we only run it on descriptor creation. Returning an Error object is indeed the correct API now; if that was a change new to 0.11 then that's an oversight in the release notes and we should fix them, sorry.\n. Sorry about this -- you should have gotten warnings for this in the 0.10 development build, probably 0.9 too.\n. This throws if you have any existing markup in the element, regardless of if it was produced using React's server rendering? Seems a little aggressive.\n. Can you add a test for that?\n. If you need this, I believe you can add\n<script type=\"text/jsx\">\nMyApp.init();\n</script>\nor similar after the external script tags and that will queue it correctly.\n. Need to document the change to custom prop types API too.\n. We should mention it in the blog post.\n. I can't repro but that should have been fixed in e8efa2a1e915da7aab90f6ad2ffcb226b7016293 and might be in 0.11.1 which is being released soon.\n. Sounds like we're not 100% sure what our wording here should be (see #1918) so I'll hold off on merging this for now.\n. You wanted oneOfType. :) We can probably make the message better though\u2026\n. See #1898 \u2013 for the enter key you should be using the keydown event. If you still can't get it to work with onKeyDown, can you post a jsfiddle showing the problem? Note also that you can now write e.key === 'Enter' instead of e.keyCode === 13 if you want.\n. Are you using DefinePlugin with webpack? You'd need to do something like\nplugins: [\n  new webpack.DefinePlugin({\n    'process.env': {'NODE_ENV: JSON.stringify(process.env.NODE_ENV)}\n  })\n]\nto make webpack inline NODE_ENV properly (and I believe then it's smart enough to not require the test utils). You can also write JSON.stringify('production') explicitly there if you don't want to specify it on the command line.\n. Currently I see:\n\nWith the font-weight: 300 removed, I see:\n\nMaybe we can make the text darker, though probably we don't want to go all the way to #000. Right now it's #484848 and looks noticeably non-black (presumably intentionally). #333 is definitely higher-contrast but looks almost black to my eyes. (You'll note that almost no one uses black text \u2013 for example, Google's search results are #545454 on white.)\n. My second screenshot shows non-thin fonts; do you disagree?\n. Probably @joshduck. :)\n. Curiously, this seems inconsistent if I leave the (third) page open and just watch it update:\n\n. We haven't had a chance to look, no. Improving perf tooling is on our goals for 2015 but it won't happen before 0.14.\n. Fixed by #4683.\n. It's better to create the nodes with the correct namespace initially \u2013 we'll likely go with #3808 or a variant thereof. Sorry for the long delay.\n. I believe webpack is smart enough to strip out unneeded requires even before uglification so that might be faster than what we're doing\u2026\n. I meant if you do if (false) { require('dev-only-stuff'); } then webpack won't include that module.\n. That object spread syntax isn't supported yet \u2013 it'll probably be in 0.12 but until then you should use React.DOM.div(attrs). Note that 0.11.1 is 0.11 with a few commits cherry-picked, not a direct cut of master, which we're not quite ready to release yet.\n. Takes ~6 seconds on my machine to build all five files when everything's cached, but you can use webpack --watch when developing React and it's basically instant.\n. Pretty sure I can make the dev builds smaller if we care\u2026\n. Oh, you lost all the license and @providesModule comments.\n. @nathansobo Atom plugins was what prompted this issue. :) We're not going to support using multiple versions of React seamlessly together in the near term, though it's possible it'll work in the far future. Until then, your best approach may be to have plugins populate iframes with plugin contents so that the scripts run in an isolated window.\n. I understand this is a problem. Are your DOM trees nested within each other or completely separate?\n. Off the top of my head I'm not sure how that causes problems. Do you know when that error is triggered? (In response to some event handler or something else?)\n. See also #1439.\n. Thanks!\n. I guess so.\n. This is incorrect. When componentDidMount is called, React has attached (\"mounted\") the elements returned from render into the document.\n. What setTimeout? The docs (intend to) say that if you want to set a timer, you should do it in componentDidMount but it's certainly not necessary to wrap all DOM manipulations in a setTimeout.\n. This is not because the DOM is not ready at the point when componentDidMount is called but because browsers won't start a CSS transition if the className is assigned immediately when an element is added to the DOM. (This is not React-specific.)\n. Not always \u2013 you can occasionally force it to do a layout by reading from one of the size properties:\nhttp://stackoverflow.com/a/19907889/49485\nbut doing a setTimeout seems to be the most foolproof method.\nClosing, but let me know if there's something in the docs that we should add that would have made this clearer for you.\n. (That was me merging, GitHub seemed a little confused.)\n. I think so.\n. I've got my eye on #1510 though\u2026\n. (I approve making getChildMapping skip nulls, though I'm a little iffy on the test case\u2026)\n. @chenglou Do we still want this?\n. Fixed by #2549.\n. FWIW the .editorconfig says not to wrap *.md: https://github.com/facebook/react/blob/master/.editorconfig. Let's update the contributing docs?\n. Thanks!\n. React should only attach top-level handlers for events that you're using in your components \u2013 are you seeing otherwise?\n. Pretty sure we don't need to attach the event handlers for uncontrolled components. I'll check and let you know.\n. Just made #1968 with a possible fix, though I'm unsure how well I like it.\n. (Probably a pain to review, sorry; basically everything is just moving code around.)\n. @sebmarkbage If it wasn't clear, this is separate from the batching changes; it should be safe.\n. say what?\n. I like it.\n. Thanks, this is a dupe of #1691.\n. This certainly makes the code more complex, not sure if it's worth it. (Refactoring ReactDOMSelect to not always read in handleChange probably seems good regardless though\u2026)\n. Not sure what you mean, that call is in _handleChange only?\n. This complicates the code a bit and I haven't heard that this actually helps, so closing.\n. It's a little tricky because (for example) what if Editor doesn't render a div but instead renders a span or some other tag? If editorRoot is in the DOM then React can do a replaceChild but if it's not you're out of luck. Maybe it just throws an error.\nWe are planning to do something similar though where you can render and call toElement in order to get a DOM node that you can put wherever you want: #1711. I'm guessing that would solve your problem? It requires some changes to the events system though so it's not likely to happen immediately. I'll close this issue in favor of that one but let me know if I'm missing something.\nI don't think I can help get rid of the extra wrapper div but perhaps you could do it consistently if you render some EditorWrapper component when rendering from React but with the shim layer, render Editor inside a div you make. Sorry I don't have a better suggestion.\n. Thank you!\n. My guess is descriptor.type === 'img' will be the recommended way in the future?\n. If we want to support this, it would probably be by having React be configurable in some way, sort of like #1648.\n. It's unclear to me what you're proposing. We already have ReactServerRenderingTransaction internally which makes a few things behave differently when doing server rendering. What else were you thinking might differ?\n. You should be able to do this with context fairly easily in 0.14.\n. I know @sebmarkbage was considering having a method that takes a children object/array and flattens it, returning a new list with properly-keyed descriptors\u2026\n. It can at least share the props object, right?\n. Sorry this is so confusing, but you should actually send a PR to the master branch (or else it'll be lost when we make the next release).\n. Thanks! Sorry this was so tricky.\n. You should always treat state like private instance variables and should never call setState except on this \u2013 if you want to allow other components to set your state, you can expose specific setter methods. In this case, you should simply set the value in the DOM directly by setting this.refs.textf1.getDOMNode().value. You can also of course use controlled components and take advantage of React's data flow, which is recommended \u2013 it takes a little more work initially but tends to be much easier to reason about down the road.\n. instance.state.value = 'something new';\ninstance.forceUpdate();\nThis is better as instance.setState({value: 'something new'}).\n. I added validateDOMNesting so I don't think this is as useful any more.\n. AFAIK all the current errors that mention data-reactid are completely unactionable for someone unfamiliar with React's internals.\n. See #742.\n. I like this. Can we add assertions for what the empty string renders to?\n. It's hard for me to follow what's going on now. I prefer the simple O(n^2) solution which will be plenty fast as long as we don't have thousands of different tests here, which we won't.\n. Well, I am fine with combining them into one test if that helps\u2026\n. I think this looks good to me now, thanks.\n. It was always true that <div><div key={x} /></div> would cause a remount when x changed; it was just the case that at the root the key was ignored. The behavior here now isn't any different from the previous key behavior.\n. The solution we're doing for this is #3398.\n. Maaybe.\n. Aren't we killing the pragma in the 0.12 release?\n. Yup \u2013 good catch! Just fixed in the docs source.\n. Well the prop types will warn\u2026\n. @bloodyowl If your IE8 polyfill is forwards-compatible, can we use that here instead?\n. Never mind, I see #2023.\n. For something like Object.assign it's possible that we could pull out all the calls at build time but for things that modify built-in prototypes (like Function.prototype.bind) it's not.\n. I'm pretty sure this is actually correct as-is. In fact, your suggestion\n\nmake sure to never access as a property that was specified as a string\n\nisn't quite right, although\n\nmake sure to never access a property that was specified as a string\n\nwould be too. Here, \"what\" is like a pronoun that means roughly \"something that\".\n. @RReverser This issue is specifically about the key check in ReactDescriptorValidator; you should be able to specify a dom node as props.children to a custom component that does something intelligent with it (like your ReactDOMWrapper).\n. @syranide It would, except by doing it at descriptor creation time you get a call stack that includes the actual render method.\n. Haven't heard any more of this \u2013 @zpao please reopen if you have.\n. Yes, that's why the error tells you to add tbody. :) The current solution works in some cases and I'd rather not make things more strict until we can make them better (i.e., error consistently at an earlier time \u00e0 la #101).\n. I agree in principle but am also wary of causing unnecessary churn, especially if it turns out we can add the tbody automatically in the future, which I would like to do. I am fine with adding a dev-only warning() call now telling you to add a tbody though.\n. You could start with a dev-only warning() if you're concerned about breaking stuff.\n. @syranide Is it really invalid? I often write something like\nborder: 1px solid #000;\nborder-style: solid none;\nto get borders on only top and bottom.\n. The sentence isn't redundant; the first group refers to es5-shim; the second, to es5-sham.\n. :+1: otherwise I think.\n. Does this work properly if you have non-React children in a React root (perhaps from dangerouslySetInnerHTML)?\n. We're not doing the other change.\n. Our bubbling matches mouseenter and mouseleave, right? Those were in old IE and are in modern browsers too now. https://developer.mozilla.org/en-US/docs/Web/Events/mouseenter\n. Merging into #1032.\n. It's not implemented yet. #1032 is a issue for tracking any SVG tags or attributes that we're missing so I added your request there instead.\n. This is intentional; if you don't want the attribute you can use null or undefined. See #302 for more info.\n. Closing in favor of #1448.\n. Can you give an example of when you want this? The idea is that shouldComponentUpdate should be able to look at the state to determine whether to update.\n. Timeout IDs should be stored outside of state. State is for things that (might) affect render. Presumably the state change needs to be triggered by something, and currently doing a state change in response to a props change is supported. If you can make state changes in componentWillUpdate after shouldComponentUpdate returns true, is there no way to skip the render at that point or are you proposing running shouldComponentUpdate again?\nMore specific use cases would help me understand you here.\n. We were considering disallowing setState in componentWillMount in favor of just having people use getInitialState.\n. If the data isn't easily available synchronously, you can just use componentDidMount.\n. As I understand it, requests should be sent and timers set in componentDidMount.\n. > I've been slightly annoyed in the past with silent failures coming from this method.\nNext time, file the feature request yourself. :) Whenever possible we go for clear errors.\n. Nope, sorry! No one gets notified when you push commits so it's best to comment back so we know.\n. Let's make it autoSave. Sorry for the long delay \u2013 needs a rebase.\n. Thank you!\n. Did you test on non-retina? (Not sure what retina-image compiles into.)\n. :+1: lgtm \u2013 thanks!\n. Maybe we can call it text or message or something along those lines?\n. Little-known fact: the <button> tag defaults to type=\"submit\". If you change it to type=\"button\", your fiddle works as intended.\n. This is part of how HTML works, not specific to React at all.\n. > Does react automatically lowercase attribute names?\nIt doesn't, but I believe HTML attributes (unlike SVG, for example) are always case-insensitive so the mapping isn't necessary.\n. We can't take this as-is so I'm closing this out \u2013 if you do want to remove the non-attribute property names and rebase, I think we can take this though.\n. Just a few small things \u2013 otherwise looks great, thanks!\n. Running this indicates to me that the value attribute is kept properly:\nReact.renderComponentToStaticMarkup(React.DOM.option({value: ''}, 'x'))\n// '<option value=\"\">x</option>'\nPerhaps something is wrong elsewhere in your code \u2013 if you make a minimal repro perhaps I can take another look.\n. @taarimalta This was a bug in the RCs; will be fixed in 15 final when it comes out this week.\n. Perhaps a dupe of #1931.\n. In ReactCompositeComponent mixSpecIntoComponent, we join them by underscores \u2013 which I assume we would have done only if there were a problem with using a dot? :+1: otherwise though.\n. lgtm :+1: \n. FWIW I also forgot that there was a defaultValue DOM property and I think initialValue is a better name.\n. Yeah, a CSSTransitionGroup turns into a <span> by default; see http://facebook.github.io/react/docs/animation.html#rendering-a-different-component. I expect this will work if you use a <g> instead, as so:\n<CSSTransitionGroup component='g'>\nSorry for the slow response.\n. I'm having enough trouble convincing myself that your fix is correct that I don't think I want to take this. If we ever support rAF batching in core, perhaps we will want a fix for this. I'm curious though \u2013 what problems does rAF batching solve for you? Does React.addons.batchedUpdates fix the same problems?\n. The idea sounds good but the code is still tricky, especially for the re-entry case.\nThat makes sense. Have you looked at all at throttling the scroll events instead? That's the typical way to deal with this. You could do something like this if you still want to do it on rAF boundaries:\n```\nfunction throttleAF(fn) {\n  var interval = null;\nfunction onFrame() {\n    interval = null;\n    fn();\n  }\nreturn function throttled() {\n    if (interval == null) {\n      interval = requestAnimationFrame(onFrame);\n    }\n  };\n}\n// ...\nthis.throttledScroll = throttleAF(this.handleScroll)\nonScroll={this.throttledScroll}\n```\nBasically, rAF batching introduces complexity and makes things harder to reason about (like necessitating your fix here) so we've so far tried to avoid using it.\n. No problem. Let me know how it goes!\n. It's not \"scary\", but \"scry\", which is a fantasy word that means to search for something:\nhttp://en.wikipedia.org/wiki/Scrying\n. Do you want to delete merge, mergeInto, copyProperties? It'll break people who require('react/lib/merge') but maybe we should do that anyway to emphasize that it's not a public API.\n. Someday we'll get lint working\u2026\n. We've been GitHub-first for a few months now.\n@zpao Are there more things here or can we close this issue?\n. Looks like list should be MUST_USE_ATTRIBUTE in HTMLDOMPropertyConfig.js.\n. Any reason we can't add a deprecation warning on import?\n. This is a dupe of #2045, I think.\n. Remove the require too, otherwise lgtm.\n. You're using the same ref name multiple times and overwriting the same spot. You can instead get a reference to the erroring image from the event object:\nhttp://jsfiddle.net/1zebf4cf/2/\nNote though that it's not generally safe to modify attributes in the DOM directly, especially if you plan to update them with React later. It would be better to store in JS info about each image including whether it has errored, then update the src property just by rerendering based on the new data.\n(This is also the wrong forum for help requests like this \u2013 in the future, the mailing list, IRC channel, or Stack Overflow would be more appropriate.)\n. Correct \u2013 we don't support updating anything outside of body; see Pete's comment here:\nhttps://groups.google.com/d/msg/reactjs/4jI5xe7TXzQ/3sjSBbpDpEwJ\n. (Closing in favor of #2127.)\n. Somewhere else we use .textContent = '' to clear\u2026 maybe that's faster?\n. Yeah, I guess that's what I was thinking of.\n. We're moving away from HTML except for server rendering so this is moot.\n. @duro That unfortunately won't work in this case because ReactTransitionGroup needs a ref to the element too (so you can't just keep the old one). @syranide's suggestion of creating a wrapper should work though.\n. I believe this still is broken (using cloneElement now instead of cloneWithProps).\n. React binds functions defined on the component automatically:\nhttp://facebook.github.io/react/blog/2013/07/02/react-v0-4-autobind-by-default.html\nWe realize this can be confusing to newcomers and might make it more explicit with arrow functions in the future, not sure yet.\n. meh.\n. Have a diff of the old/new built files?\n. Is this IE8-compatible?\n. I guess merge wasn't before anyway. Okay.\n. createElement isn't only an internal API, we use arrays vs. varargs to distinguish child keys, and I believe these have been benchmarked to be comparable (or even faster with varargs?) so I'm going to close this.\n. Hey \u2013 I ended up including this fix in a larger PR (#2503) so this didn't make it in directly. This was a great catch though; we'd love to have you contribute more in the future.\n. We'll need to set up a redirect from the old URL if we want to rename the post. Can't remember if we've done that before.\n. > Move React Elements post to write place\n\u0ca0_\u0ca0\n. Prefer using immutable.js. We don't want to turn this into a crazy DSL.\n. The nested links thing is due to invalid HTML and we have a new warning for that in 0.14.\n. @Diokuz Can you say what symptom you experienced?\nAlso, if you are using the prebuilt react.js I would recommend using the prebuilt react-dom.js as well and using 'ReactDOM' in your webpack config since the secret property is unstable and will change in the next version (hence its name).\n. @mnquintana No, that should work now if both are on a recent version of React.\n. Old versions of React are probably only tripped up by data-reactid IDs in the DOM that it didn't generate. If you're doing only client-side rendering with your widget, it should only have a data-reactroot attribute and no data-reactid so there shouldn't be any conflict. \n. There should already be a warning for this in the 0.12 RC and it'll be in 0.12. Please shout if you see differently.\n. Sounds like it fires but doesn't bubble?\n. The issue here is that we only unset background image, position, repeat, and color and not attachment, clip, origin, or size. Not sure where I came up with that original list. I think the best course of action here is to make sure we unset all the properties that IE8 supports, then take your #1953. These shorthand properties are kind of a pain. :)\n. @m4tthumphrey Can you build a simple repro case for this on jsbin or jsfiddle? This does sound like a bug but without a way for me to reproduce it it'll be hard to fix.\n. 0.12.1 just had changes to JSX so if you were on 0.12 before you shouldn't see any difference.\n. @m4tthumphrey Do you have a repro case for this? Are you sure you're calling getDOMNode at a time that the node is still in the DOM?\n. @aaronjensen Any chance you can post a simple repro case for us?\n. @m4tthumphrey Yes, but it's terribly difficult for me us to debug without a repro case, which your original issue also didn't provide.\n. @aaronjensen Thanks for the repro case. I'll try to look into this.\n@m4tthumphrey No worries.\n. Okay, I tracked down the root cause.\nIf updates to a parent and child component are both enqueued during a batch and while the parent is updating another update to the child is enqueued, we end up reconciling the child twice which breaks other assumptions and interleaves lifecycle methods incorrectly. In both 0.13.2 and master (if you fix the batchedUpdates reference), this code\n``` js\nvar Parent = React.createClass({\n  getChild: function() {\n    return this.refs.child;\n  },\n  render: function() {\n    return ;\n  }\n});\nvar once = false;\nvar Child = React.createClass({\n  getInitialState: function() {\n    return {updated: false};\n  },\n  componentWillUpdate: function() {\n    if (!once) {\n      once = true;\n      this.setState({updated: true});\n    }\n  },\n  componentDidUpdate: function() {\n    console.log('child update');\n  },\n  render: function() {\n    console.log('child render');\n    return ;\n  }\n});\nvar parent = React.render(, document.getElementById('container'));\nvar child = parent.getChild();\nconsole.log('--- start of batch');\nReact.addons.batchedUpdates(function() {\n  parent.forceUpdate();\n  child.forceUpdate();\n});\nconsole.log('-- end of batch');\n```\nproduces the output\nchild render\n--- start of batch\nchild render\nchild render\nchild update\nchild update\n-- end of batch\nwhere the render and update lines should be interleaved.\n. I thought we had a warning for setState in componentWillUpdate but I guess not.\n. @m4tthumphrey That message means the same as \"Invariant Violation: getDOMNode(): A component must be mounted to have a DOM node.\" In #4727 I improved the message to make it a bit clearer.\nI wouldn't expect this issue to be fixed until we make a specific attempt to fix it at which time you'll see stuff happening on this issue.\n. No, it isn't fixed. The test case I posted still has the problem.\n. #3762 has a nice repro from @scarletsky; should verify that it gets fixed too.\n. In general, there's no way to statically identify what might be a valid component. Consider the last example here:\nhttp://facebook.github.io/react/blog/2015/01/27/react-v0.13.0-beta-1.html\nAny function or string might be valid; there's no more specific type we have.\n. Sorry that this bit a few of you, but it's too late to do anything now so I'm closing this.\n. See this blog post \u2013 library authors should export unwrapped classes:\nhttp://facebook.github.io/react/blog/2014/10/14/introducing-react-elements.html#anti-pattern-exporting-factories\n. I don't think there's anything actionable here so I'm closing \u2013 please correct me if I'm wrong.\n. @TrySpace It looks like you're using both createFactory and JSX \u2013 is that right? If you're using JSX to specify the elements you shouldn't ever need to call createFactory.\n. @sebmarkbage Do you want to do an explicit warning when using the output of createFactory with JSX instead of the generic \"don't use functions with JSX\" warning? Doesn't look like there's a real way to identify them at present but we could always add a ._isReactFactory or something\u2026\n. @irvinebroque Unfortunately it's not possible for us to print out a better error but you should be able to set a breakpoint at the warning and then inspect the call stack to see what part of your code is causing the problem.\n. +1 for less magic. Using ES7 property initializers with arrow functions is very appealing to me, though I understand the reluctance to introduce more syntax or a dependence on unstandardized features. \nHaven't had a chance to read through the diff yet.\n. This sounds vaguely reasonable, but I think we're going to do #3211 instead so I'll close this.\n. Closing this as a dupe of #2127.\n. Closing until it's in the standard.\n. Our plan here is to make onChange consistently fire on every change in all browsers; see #554. You can use onBlur or maybe onMouseUp if that's the behavior you're looking for, but the native onChange event varies widely across browsers even if we don't do anything special in React so that's probably not what you want.\n. Definitely not by design. I can't think of why this would happen; it doesn't even sound like something we can control because the files should end up referencing the same module and browserify shouldn't run (or bundle) it twice.\n. Going to close this out but if you can make a minimal repro case, please post it here and I'll reopen.\n. Yeah, you may hear conversation about \"error boundaries\" which means making a way to handle this sort of thing more gracefully and something we want to find a good solution to. I don't think we have a tracking issue for it though so let's use this one.\n. @skiano If that's working for you, no reason to stop. Our eventual solution should be a little more flexible than this and more efficient but will be similar in spirit.\n. I'm willing to but it doesn't require much discussion, it just needs to get done.\n. Let's leave this open until the new feature is complete.\n. An error bubbles up to the nearest error boundary (that is, a component with unstable_handleError defined). If that component errors when trying to handle the error, the error will keep rising.\n. #5602 has the first code for this which catches errors only on initial render but not at any other time. When we have more I am sure that this issue number will be mentioned in the description so you will see them in the comment history here.\n. @bitmage That's true; if you implement unstable_handleError then React doesn't log anything or rethrow the error; it is up to you to do so. It is like a try/catch. In a future version of React we will log an error regardless though (see #8756 for a preview).. Where is your error thrown? I don't see it in your code.. Yes, the docs are correct already for 0.12 and up.\n. > This changes ReactCompositeComponent to instead create a new object. In return for allocating a new object, I've replaced mapObject with forEachObject so that we are no longer allocating an unused object.\n(No longer quite accurate.)\n. Add ?w=1 to the URL.\n. The original is correct. The word \"react\" is the English verb; it doesn't refer to the React library in this case.\n. Thank you!\n. Yes, currently you have to replace the entire contents of a container. After #1711 this won't be true any more, but the best workaround is probably to add an extra wrapping element around the <ul>.\n. Trying to clean up issues so I'll close this out but I'd take a PR to clarify.\n. Closing this out as it's not super actionable, but #2512 added an \"appear\" phase.\n. Me too. :) Just going through issues today.\n. Maybe we can warn for this.\n. That syntax isn't currently documented. If we decide to encourage/document it, we'll be sure to mention any required polyfills at that time as well.\n. Thanks, didn't realize we wrote that in the docs.\n. You can use write something like\n<div {...this.props} className={(this.props.className || '') + ' table table-bordered'}>\n    <span>a box</span>\n</div>\nor, using the joinClasses helper (not available in the built React or via npm, sorry):\n<div {...this.props} className={joinClasses(this.props.className, 'table table-bordered')}>\n    <span>a box</span>\n</div>\n. This is a bit separate from #2353.\n. @schotime Glad to hear it!\n. Keep in mind that\n``` js\nvar Wrapper = React.createClass({\n  render: function() {\n    return \n      {this.props.children}\n      \n;\n  }\n});\nReact.render(\n  \n\n\n,\n  document.body\n);\n```\nshouldn't warn.\n. If you make a window bigger past the end of a page, those values will change, right?\n. Probably. Going to land this as is then work on doing that separately.\n. I seem to recall us saying that we weren't going to add new calls to monitorCodeUse directly, preferring to stub warning to call monitorCodeUse if appropriate? Maybe I made that up though.\n. ReactTransitionEvents isn't a public module so we're not particularly concerned about its API. This doesn't sound like a bug per se, so I'll close this out. Let me know if I'm misunderstanding. (Also willing to consider a pull request if you feel so inclined.)\n. lgtm otherwise\n. This isn't actionable as-is; if you're still having trouble please post a minimal repro.\n. Yeah, @chenglou has it mostly done in #2027 already. I think I had a couple more comments that I wanted to post there but then we can get that in.\n. @uptownhr As far as I know the behavior is the same across input/textarea. Am I misunderstanding?\n. @rymohr Our intention was that a prop value of undefined is always equivalent to not providing it. This is how defaultProps, etc. works. In most cases, null is what people end up passing and so we could make that mean the empty string, as discussed above.\n. Closing in favor of #1657.\n. Is this slower? It would be nicer to hide the composite wrappers entirely. I know that some people are using .state.value on ReactDOMInput instances instead of going through the DOM and ideally, that wouldn't be possible. For these new wrappers, setState presumably has no meaning but it would be nice to hide it anyway.\n. Okay, accepted.\n. What happens now if you call setProps or replaceProps after unmounting?\n. Already has a warning for what, sorry?\n. Ready as far as I know. Just rebased.\n. @sebmarkbage review?\n. We might make warnings louder in general, but we're moving more towards warnings so that the prod build can skip unnecessary checks, so I'm closing this.\n. Sorry, I actually misunderstood this and thought from the description that there already was a warning. I actually just checked and there was an error added at about the same time this issue was filed, so this is actually fixed:\nhttps://github.com/facebook/react/commit/aef7c4d1a16133f2f6d3ae3bfd18f01f8fc1403b\n. Nice.\n(nit: fold the unused-variables commit into the first commit, which removed the references?)\n. Thanks guys for the confirmation. I'll try to take a closer look at this patch soon and get it (or something similar) in for 0.14.\n. Thank you! Sorry it took me so long to get to this. Just merged with a couple small fixes in 08e4420019f74b7c93e64f59c443970359102530.\n. Did you want to keep or remove the invariant in mountComponent?\n. This is close enough to #1753 that I'll close this one.\n. Going to mark this a duplicate of #984 \u2013 please comment if you disagree with the reasoning there.\n. Thanks.\n. (Though #2566 has this and more.)\n. Your proposed alternative with the CustomButton as a wrapper is good. In general we don't want to do deep merges because your props could look like anything \u2013 they're not necessarily plain JS objects that can be automatically merged. As such, I'm closing this out.\n. Thanks for tracking this down \u2013 going to close this as a dupe of #1302.\n. Yeah, we're not planning to change this now.\n. > I just meant that I don't like the replaceState API and I wish we only had setState.\nWhy?\n. This sounds like a dupe of #2533.\n. Yeah, we're moving to static properties for these so I'm going to close this out.\n. Your unit test fails now because you changed the message. Also fburl.com doesn't work externally -- the others have been like http://fb.me/react-context-by-parent.\n. I think this looks good now. (Also, if you edit your gist to be \"Language: Markdown\" then it'll display more nicely, like this: https://gist.github.com/sebmarkbage/fcb1b6ab493b0c77d589.)\n. Done, thanks.\n. Good point. Better?\n. @syranide No, it's unfortunately always been this way. On my infinite to-do list to fix.\n. Okay.\n. No review needed for docs pushes -- you should be able to just add yourself to repo on intern and then push the docs update directly (after pushing the source to master, and cherry-picking to 0.12-stable).\n. Oh, I just have jest globally installed and run jest.\n. Okay.\n. The goal of the keyMirror function is to be compatible with the advanced mode of Google's Closure Compiler, which means that the keys have to appear as unquoted property keys in the JS source, so we can't use arrays and strings as you're suggesting. Since this is only an internal API anyway, I think we're going to leave it as is \u2013 but thank you for sending in the idea!\n. okay!\n. Why?\n. @sebmarkbage what do you want to do here?\nhttps://github.com/facebook/react/blob/bb9748272966ca41d6e44c5d964eeb9c5f81fb96/src/utils/traverseAllChildren.js#L112\n. \u2026are we killing cloneWithProps?\n. Will do, thanks.\n. This would be clearer to me as\nif (nextType === 'object' &&\n    prevElement.type === nextElement.type &&\n    prevElement.key === nextElement.key) {\n  var ownersMatch = (prevElement._owner !== nextElement._owner);\n  if (!ownersMatch) {\n    monitorCodeUse();\n  }\n  return ownersMatch;\n}\n. This was probably fixed by #2503.\n. Yes, the fix is in 0.14.\n. Sorry \u2013 not released yet, but hopefully in the next few weeks. 0.14-beta is on npm (see the React blog).\n. This can be fixed by using ReactChildren.forEach in ReactDOMOption to flatten the children before passing it to the raw HTML component. Strings and numbers get concatted together; other elements should be skipped and log a warning for invalid children.\n. Closing, but if you have a repro case please post it.\n. ES7 was actually not a typo here \u2013 but we removed other references to this syntax in #2636 so maybe we want to change how this page is written.\n. Sure.\n. @sebmarkbage What should React.render(\"foo\", el) return? (That doesn't work at all yet.)\n. That still shouldn't happen. @jsfb Do you have a repro case now? It might be worth fixing and doing a point release sometime.\n. The intention here is to let all errors bubble up without explicitly rethrowing them, as that tends to cut off the stack trace and make it harder to find the original bug. As far as I know, the current code should work correctly in all browsers except old IE, which still throws the exception but doesn't provide a good stack trace .\n. I believe this should already work in master after #2376 (not in a release yet).\n. Thanks!\n. Seems like we may as well; it should be a simple check. A few percent of users are still on old Firefox.. Probably not worth it if all current browsers are fine.. 6379342b717feed7ebf1e5abcbe512b92e25b3d8 landed in master already and we'll be sure to cherry-pick it when we do 0.12.2. The official builds should already have trailing commas stripped, and you shouldn't have a problem if you minify your code or run something like https://github.com/spicyj/es3ify over it.\n. I understand. The official unminified build has trailing commas stripped using es3ify; you can do the same if you're getting React from npm.\n. Sorry, we don't support quirks mode and don't have plans to as it's sort of like supporting IE 5.5.\n(Note that jQuery also doesn't support quirks mode: http://contribute.jquery.org/wont-fix/#quirks-mode) \n. I would sooner have a REACT_ENV or something that takes precedence over NODE_ENV, but changing how this works will cause a lot of pain since everyone would need to update their build processes so I don't want to do it lightly.\n. @syranide Yeah, I do want to do this. It's probably the best solution here.\n. > I also use GetSentry and once React starts to throw an error in a render method is generates a lot of errors afterward and make a lot of error reportings in GetSentry.\n\nI guess it is related to catching errors in render() too, and some existing issues like #5528\n\nYes, this is #2461 which is a large project but obviously important.\n. We don't use the major version in the URLs because the page doesn't need it. We don't have plans to support React 0.12 in the official error decoder page but you could make your own page and error code map if you were very motivated. If you are doing a custom build it may be easier for you to just delete the build code that minifies the error messages.\n. See #1302 and #1305 \u2013 we'd like to do this but last time it wasn't possible due to some mocking problems.\n. Yup, closing this in favor of that issue.\n. Yuck. This is due to autobinding, I guess. In 0.13 RC it gives an error:\n\n. It sounded like we instead wanted to implement getPublicInstance and have it return null?\n. Also can't repro this in Chrome.\n. Thanks for following up.\n. :+1: \n. This is close enough to #2680 that I'll close this one and track there.\n. :+1: \n. This is indeed intentional. The first syntax isn't really supported yet, and as it isn't related to React, we chose to avoid the React runtime dependency for it. If/when we want to promote that syntax more broadly, we'll be sure to note the need for a polyfill in the docs.\n. Curious \u2013 can you give a real-world example of when this would make sense?\n. Fixed by #4559.\n. Probably another consequence of #1326. \n. No, the plan is for React.withContext to go away.\n. I'm not sure what you're seeing. If you write\n```\n\nHello World\n<p>Hello world!</p>\n\n\n```\nthen this.props.children[0] will be the h1 element from within MainComponent. If you're seeing otherwise, please post a simple repro case and I'll take a look.\n. This sounds like a dupe of #1326; merging.\n. Yeah, this should be fixed now. Thank you!\n. Did you mean to merge this @jsfb? Doesn't look like it went in\u2026\n. On the other hand, getting http-server requires installing another tool over the internet whereas if you have Python 2 installed, SimpleHTTPServer is built-in and just works.\n. #2824 landed, so I'm closing this.\n. Sure.\n. Odd \u2013 I was under the impression that fastclick works properly with React.\n. The preferred way is to use onChange, which is polyfilled to behave like onInput in all browsers, including ones that don't support it natively. Is there a reason that doesn't work for you?\n. @jimfb No, our onChange is special, as @syranide said, and fires on every keystroke. You usually should not use onInput because browsers have a plethora of different bugs with it and onChange (for the most part) normalizes them away.\n. Thanks for reporting -- we should either work seamlessly with uppercase tags or warn when you use them.\n. Probably the same place where we check for dangerous tag names (https://github.com/facebook/react/blob/master/src/renderers/dom/shared/ReactDOMComponent.js#L287) would be a reasonable place \u2013 you can rename that function and add a __DEV__-only warning for this there. ReactDOMComponent-test is probably a reasonable place for a test but if you find somewhere else, that's probably fine too.\n. Can you make a minimal repro case, like in a jsfiddle? It's not obvious to me what the issue here is but it's hard for me to set up and run your example so I can't test.\n. lgtm\n. Might be the same as #3005? (I realize this was filed first.)\n. Why it's unmounting: When comparing the old null to the new null in _updateRenderedComponent, prevComponentInstance._currentElement is actually <ReactEmptyComponentType /> whereas nextRenderedElement is null, so shouldUpdateReactComponent returns false.\n. Why it's throwing: the three componentDidMount calls get queued in the order they were rendered (Child 0's null, Child 1, Child 2's null), but because batching doesn't happen on an initial render (something I've been meaning to make happen\u2026), the forceUpdate happens synchronously and causes the unmount/remount of both child components, after which the old enqueued Child 2 null did-mount callback runs and throws, because that component isn't mounted any more.\n. (Two issues; we should fix both.)\n. Not sure, but I think so. I added a test recently to ensure that text components don't get remounted on update; we should add one for empty components too.\n. Right -- that's what we do already for new mounts of child components within a larger update.\n. The second issue should be fixed now because we batch on initial render. Not sure about the first; it's probably still a problem.\n. @sebmarkbage Maybe you can fix this.\n. (Accept.)\n. Closing due to inactivity, but we can discuss more if you still have an issue.\n. @mridgway Does the child component unsubscribe from the store on unmount? If so, it shouldn't get event callbacks after unmount unless I'm missing something.\n. I think I'm in favor of this, though it's not obvious what order all the update methods should be called in when the mixins are interdependent.\n. See discussion on #3290 \u2013 mixins are effectively a legacy feature now and so I'm not going to merge my (breaking) change to their behavior even though I agree that it makes more sense that way. Closing as wontfix -- in most cases you can use higher-order components to get the behavior you want.\n. We're not planning to change their semantics, instead preferring to recommend an official ES7 mixin solution if any appears.\n. And no, we still discourage mixins for most use cases.\n. Not sure what formset is. Perhaps you meant fieldset? If I'm being stupid let me know and I'll reopen.\n. componentDidUpdate (and componentDidMount) is always called after the DOM has been updated \u2013 we can update the docs. Want to send a pull request?\n. This happened.\n. @jsfb shipit\n. Yeah \u2013 if anything, we're going to warn when you add new properties to state that getInitialState didn't return.\n. lgtm\n. Deprecate keyed objects as children sometime?\n. Not currently.\n. Yeah, these are all gone now except _reactInternalInstance which will be gone if #2958 merges and isn't a likely name to conflict with anyway.\n. :+1: \n. Looking at the code I can't figure out why it doesn't always throw in batchedUpdates when a callback isn't specified. I'm probably just too tired right now.\n. Seems reasonable. Did you test that loading the first parts from a file: URL works properly in Firefox and Chrome and Safari? I imagine it would since we're not doing anything fancy but it can't hurt to check.\n. Yeah, enter/leave have special bubbling and don't have the capture phase. I'll update the docs.\n. We can probably switch our warning module to use console.error instead, which gives a stack trace in most browsers I think.\n. Fixed by #3022. \n. This happened.\n. Expected. The former is equivalent to\nvar handler = localStorage.removeItem(\"localData\");\n<button onClick={handler}>Clear Local Storage</button>\nNote that the removeItem call runs immediately upon render, not when you click the button. You want to pass a function that gets called instead. You can do this with an arrow function (as you saw), a regular function like onClick={function() { localStorage.removeItem(\"localData\"); }}, or a method like onClick={this._removeData}.\n. Hmm, not sure what to do about the <!----> comment \u2013 I'm worried that that will confuse reconciliation later.\n. Also, it doesn't look like <!----> works to force the newline? In my tests in Chrome it makes that literal text show up in the textarea.\n. I think the best option for now may be to double an initial newline if it's present (so that it continues to work properly on HTML5) and otherwise leave it alone. This means that you will get two newlines instead of one when parsing pre/textarea/listing markup as XML, but I don't know if there's anything better to do.\nDoes that sound sensible? (If we then figure out later how to make it work consistently I'm happy to take an update.)\n. @Acubed In my tests, <!----> shows up verbatim in a textarea:\n\nhttp://jsbin.com/tizolesasu/1/edit\nLet me know if I'm missing something. Also, this PR needs to be rebased for a clean merge regardless.\n. Closing in favor of #2843, I guess. \n. Er, #3236. \n. Thanks!\n. @sebmck Not sure what you mean, but React itself already requires some ES5 polyfills itself:\nhttp://facebook.github.io/react/docs/working-with-the-browser.html#browser-support-and-polyfills\n. Yeah, we could \u2013 generally we try to keep things as consistent as possible across environments so that you don't get bitten by a bug that surfaces only in IE8 due to nonenumerability.\n. It's true that the spec doesn't guarantee this, but virtually all browsers and engines do, so we're planning to leave it as-is for now. Alternate solutions with manual bookkeeping tend to be significantly slower.\n. currentTarget changes as the event bubbles up \u2013 if you had a event handler on the element receiving the event and others on its ancestors, they'd see different values for currentTarget. IIRC nulling it out is consistent with what happens on native events; if not, let me know and we'll reconsider our behavior here.\n. http://jsbin.com/pirayosura/1/edit?html,js,output seems to disagree if you open the console and click the inner div.\n. We won't always follow the DOM but we will unless there's a good reason to deviate \u2013 in this case, it really is the same event that both handlers are getting notified of, and the naming of currentTarget indicates that it's the handler that's currently being executed so I think it makes sense to leave it like this and have it change as the event bubbles. (Making multiple event objects would also be worse for performance.)\n. See https://github.com/facebook/react/pull/1473#issuecomment-41952920. These helpers are easy to implement outside of React itself so you can always add them in your own code though.\n. map now always returns an array in 0.14.\n. I'm confused. You do want to allow using FluxMixin as a mixin or you just want your own error to fire instead of React's (admittedly somewhat-confusing one)?\n. I'm not familiar with the validation setup here.\n. FWIW I agree that the lowercase and consistent fb.me/react-warning- prefix is nice for aesthetics.\n. lgtm\n. You could also maybe try calling _bindAutoBindMethods twice to see what that adds?\n. @jsfb Not too hard to justify it when everyone uses it\u2026 but I don't know how to make autobinding faster.\n. @mridgway Can you try requiring 'react/dist/react.min.js' instead of the main React module as you're currently doing and compare?\n. (Wondering if this is #812.)\n. Here's a build from #3615: https://s3.amazonaws.com/uploads.hipchat.com/6574/26709/Ojl4jYZgCmwTdo1/react.min.js\nAnd one with the call to bindAutoBindMethods removed:\nhttps://s3.amazonaws.com/uploads.hipchat.com/6574/26709/iVzAHdzNHgEGOMh/react-nobind.min.js\n. Okay. I'm having trouble getting that running locally \u2013 it complains it can't find fluxible-router and I haven't figured out the right incantation of install/link/etc to make it work.\n. Still failing to require fluxible-router here: https://github.com/mridgway/react-perf/blob/e8e0048d5153b3c2acd834b44ff9fb88c17b0cfd/chat/components/ThreadSection.jsx#L23\n. Got it. Not seeing 25%, but definitely some difference \u2013 like 10% with NODE_ENV=production:\nbalpert@balpert-mbp:/t/react-perf master$ node bench-chat.js\nReact x 348 ops/sec \u00b13.63% (70 runs sampled)\nReactOpt x 379 ops/sec \u00b13.52% (70 runs sampled)\nFastest is ReactOpt\nbalpert@balpert-mbp:/t/react-perf master$ node bench-chat.js\nReact x 346 ops/sec \u00b14.07% (71 runs sampled)\nReactOpt x 356 ops/sec \u00b13.63% (73 runs sampled)\nFastest is ReactOpt,React\nbalpert@balpert-mbp:/t/react-perf master$ NODE_ENV=production node bench-chat.js\nReact x 996 ops/sec \u00b12.73% (83 runs sampled)\nReactOpt x 1,141 ops/sec \u00b12.62% (80 runs sampled)\nFastest is ReactOpt\nbalpert@balpert-mbp:/t/react-perf master$ NODE_ENV=production node bench-chat.js\nReact x 1,002 ops/sec \u00b13.05% (76 runs sampled)\nReactOpt x 1,096 ops/sec \u00b12.66% (78 runs sampled)\nFastest is ReactOpt\n. Looks like 0.13 started autobinding getDOMNode where we didn't previously, which is almost certainly unintentional on our part. :(\n. @jordwalke This isn't with a profiler; this is with normal React and with autobinding commented out.\n. I think so. Let's do the plain ES3 \"class\" syntax for now until we figure out whether we want to use loose mode, etc. in babel.\n. This is the sort of thing that parent-based context should work for in 0.14.\n. Thanks Sophia!\n. Thanks for sending this in!\ngh-pages is actually generated automatically from the markdown files in the main branch \u2013 and #2874 a few days ago actually made just this change; we just haven't had the chance to rebuild the docs yet.\n. If you select an element in the Elements tab (using the magnifying glass or with the right-click \"Inspect Element\") then switch to the React tab, the corresponding component should be selected. I don't think we can do any better than this with the API Chrome gives us.\n. Closing due to no response, though this might also be #1326.\n. try/finally without a catch shouldn't suppress exceptions \u2013 are you able to reproduce the error in a standalone jsfiddle?\n. In my Chrome 40, I see this:\n\nThe Promise created in your fetch module is swallowing the exception. You'll notice that if you put a breakpoint on the catch on the GitHubAPI.fetchIssues promise, that code is called with the error object corresponding to the this.v() call.\n. As I understand it, the native implementation of promises turns exceptions into promise rejections automatically \u2013 you can't see the code in the call stack since it's not written in JS.\n. I'll repeat myself again:\nReact does not eat your exceptions. If some part of your code is throwing an exception but it's not bubbling to the top level, something (not React) is catching them. Promises do this by default and are a common cause if you don't terminate every promise chain with a .done() call, but other libraries could also catch exceptions.\n. Here's a post about the promises issue:\nhttp://blog.taylormcgann.com/2014/08/21/catch-errors-javascript-promise-chains/\n. @sebmarkbage Thoughts? I'm not sure on this but I don't know how else to make ref resolution happen after componentDidMount.\n. No, this has the same behavior as before.\n. @sebmarkbage Done.\n. As singular it felt like the function should take the ref as the first arg, whereas it takes the instance. Also to distinguish it from the attachRef/detachRef helper functions which I couldn't come up with better names for.\n. lgtm\n. Thanks.\n. Closing this out as this doesn't sound like a React issue. If you can post a full code sample then maybe someone can help you debug your problem, but Stack Overflow is probably a better place for code-level debugging questions.\n. lgtm\n. I think the current plan is that we're going to push a tag each week so you can npm install react@latest. Hopefully this will be more stable than master but still up-to-date enough to test the latest changes. @zpao can elaborate.\nThere's also automatic builds here triggered by Travis which should always be up to date:\nhttp://react.zpao.com/builds/master/latest/\nYou can npm install http://react.zpao.com/builds/master/latest/react.tgz for that.\n. (@brigand sorry, I did mean next.)\n. cc @jeffmo @DmitrySoshnikov \u2013 () => <this.foo /> doesn't bind this properly because the this is a XJSIdentifier instead of a ThisExpression.\ncc @sebmck too \u2013 6to5 seems to have the same issue.\n. It's not obvious to me that this is a JSX spec bug \u2013 for example, you could imagine that <this /> could compile into something that doesn't use a this in the result, and conversely, <div /> could compile into something that does use this. Seems like the transforms need to cooperate somehow. I guess that's hard when the transforms output strings.\n. @RReverser I mean that different transforms may want to do different things with the characters this. In some cases it might mean the JS concept but I could imagine others where it doesn't.\n. Dupe of #1169, essentially. Should be fixed in 0.14 by my PR.\n. lgtm\n. Yeah, we use a feature test for addEventListener. Are there common polyfills that set it in old IE?\n. @blainekasten Your fiddle works for me with IE11 in IE8 mode. You can still repro the problem with that?\n. You can also write className={'my-component ' + (this.props.className || '')}. See #1198 though \u2013 we're unlikely to do this due to perf.\n. Why does adding a transaction prevent the blur event from firing?\n. I guess this is related to #3790. I'm not in love with this PR because it feels like a bit of a monkey patch to me instead of fixing the true issue that unmounted components can receive events.\n. #4983 should fix the rest.\n. This happened in #3761.\n. Not sure that every page has a green lock now, but at least most do so I'm closing this. Feel free to send PRs if you run into any that are straggling.\n. Thanks @vsiao! :)\n. I might leave the talks in chronological order instead of bumping GraphQL/Relay up, but lgtm either way.\n. Thanks!\n. cf. #1167 \n. Note that although fb.me is available over HTTPS, the URLs it redirects to are not.\n. Yeah:\nhttps://github.com/facebook/react/blob/f6920ba377b5f93cc8f02571fa16856839752428/src/classic/class/ReactClass.js#L530\n. We're not making changes to createClass any more.\n. uh, accepted.\n. input elements are implemented under the hood with a wrapper that deals with the events and making it a \"controlled component\":\nhttps://github.com/facebook/react/blob/1c697ab1413f0db7e79de8f1a685c071128807fe/src/browser/ui/dom/components/ReactDOMInput.js\nClosing this out as we're already aware that this sort of problem can manifest with multiple copies of React and we already have #2402, etc. to track.\n. I can't repro this on Safari 8.0.3, but if you can put together a smaller demo that repros reliably I'm happy to take a look.\n. @binarykitchen Event handlers receive an event object, not just the new value, so you want event.target.checked or similar. I've fixed it here:\nhttp://jsbin.com/huranakovi/2/edit\nI also added a .slice() which clones the array so you're creating a new copy instead of modifying the old one in place, which tends to be easier to reason about (though isn't strictly necessary).\n. Would be nice to figure out how event bubbling works as well (cf. #1696).\n. Probably sometime, but no new proposal at the moment.\n. Looks good, thanks \u2013 will merge after we release 0.13.\n. Merging into #2104.\n. 1) Yeah, refs to components you define yourself will still work the same way \u2013 #3223 talks just about what happens if you take a ref to a node directly, like <img ref=\"photo\" />. We're looking at making this.refs.photo be the img node directly in that case.\n2) Yeah, re-calling React.render at the top level is the preferred solution. No plans to change how the instance is returned, though you should treat state as private to a component and only call setState on yourself (i.e., this.setState) and never on another instance you have a handle to. You can expose a custom setter method, but in most cases it's better to just pass the new values via props.\n. Well, React supports winged birds, wingless birds, and (soon) wingless dogs. I'll change the name in the checklist above though.\n. @jimfb Can I pass \"Object.freeze props in createElement in DEV, remove old props mutation warnings.\" to you since you're handling the deprecation internally?\n. @chicoxyzzy 0.13 didn't have a runtime warning for it.\n. Just re-call React.render (or renderSubtreeIntoContainer) with the same container and your component will update. This has always been our recommended way to update a top-level component.\n. @jsfb Not what I read from\n\nas it's not immediately clear how to call React.render on a component that's already been mounted\n\nbut let's get the blog post out too. :)\n. Stateless component functions are as if you had no shouldComponentUpdate, or a shouldComponentUpdate that always returns true.\n. Thanks!\n. We do want some way to pass the context down. See \"#3210 Nested Render Trees\".\n. Thanks!\n. The new test case seems wrong (as @jsfb says, it doesn't repro the bug) but the original one is solid.\n. I would be happy to take a PR that sets ReactOwner.current back to its old value in all the places we mutate it.\n. Weird, looks like we never did this right.\n. Closing for now.\n. We could use context for this:\n``` diff\ndiff --git a/src/browser/ui/ReactDOMComponent.js b/src/browser/ui/ReactDOMComponent.js\nindex 4df78e8..7f4fd9e 100644\n--- a/src/browser/ui/ReactDOMComponent.js\n+++ b/src/browser/ui/ReactDOMComponent.js\n@@ -301,7 +301,7 @@ ReactDOMComponent.Mixin = {\n         var mountImages = this.mountChildren(\n           childrenToUse,\n           transaction,\n-          context\n+          assign({}, context, {svgTextChild: this._tag === 'text'})\n         );\n         ret = mountImages.join('');\n       }\n@@ -342,7 +342,11 @@ ReactDOMComponent.Mixin = {\n   updateComponent: function(transaction, prevElement, nextElement, context) {\n     assertValidProps(this, this._currentElement.props);\n     this._updateDOMProperties(prevElement.props, transaction);\n-    this._updateDOMChildren(prevElement.props, transaction, context);\n+    this._updateDOMChildren(\n+      prevElement.props,\n+      transaction,\n+      assign({}, context, {svgTextChild: this._tag === 'text'})\n+    );\n   },\n/**\ndiff --git a/src/browser/ui/ReactDOMTextComponent.js b/src/browser/ui/ReactDOMTextComponent.js\nindex d561646..46f8817 100644\n--- a/src/browser/ui/ReactDOMTextComponent.js\n+++ b/src/browser/ui/ReactDOMTextComponent.js\n@@ -75,10 +75,12 @@ assign(ReactDOMTextComponent.prototype, {\n       return escapedText;\n     }\n\nvar tag = context.svgTextChild ? 'tspan' : 'span';\n+\n     return (\n'' +\n'<' + tag + ' ' + DOMPropertyOperations.createMarkupForID(rootID) + '>' +\n         escapedText +\n''\n'' + tag + ''\n     );\n   },\n```\n\nthough we'd need to make the name not clash with user-defined context keys and change the code to be smarter about not copying. Works as a proof of concept though.\n. Yeah, I ended up solving this a different way. Thanks for sending this in though \u2013 though we didn't merge it, I appreciate the discussion and we may not have fixed this in 15.0 otherwise.\n. Sorry, me.\n. Thanks!\n. replaceProps too?\n. Simple fix: just use Child instead of 'Child' \u2013 you want to pass an actual reference to the JS variable:\nhttp://jsfiddle.net/dhjxu5oL/1/\n. React.createElement(ChildName, null) and <ChildName /> are equivalent.\n. As you probably know, it's best practice not to use eval or look up globals on window by string name as it tends to make code hard to reason about, but you can use those patterns with React too:\nvar name = 'Component' + this.props.componentID;\nvar Component = window[name];  // or eval(name)\nreturn <Component />;\nThe key is to use a capitalized variable name (Component) or else React will treat it as a built-in DOM element.\n. Maybe you can do something like\n```\nvar allMyComponents = {};\nvar Child = React.createClass(...);\nallMyComponents['Child'] = Child;\n// ...\nvar Component = allMyComponents[name];\n```\nwhich isn't a large overhead but is more reasonable than using globals. React tries to be simple and get out of your way instead of adding a lot of magic \u2013 you can then build whatever you want on top, just as you can in JS without React.\n. What @syranide said. Then in render you can do:\njs\n// Needs to start with a capital letter\nvar Type = myComponentsList[this.props.componentId];\n...\n<Type />\n. Let's warn for a release. :)\n. No, I just merged it for 0.14.\n. This seems kind of fragile. I think I'd be more inclined to hardcode a list of propType-generating functions and make sure that prop types aren't specified as any of those. That way, you also get it at class definition time instead of mount time (though of course that's impossible with ES6 classes and we do warnings on first mount anyway in that case).\n. Yeah, hence my hesitancy.\n. Yeah, this seems odd. Probably on the challenging side for a first bug, but it would be good to figure out why this is happening and how we can prevent it, while still making it possible to type the placeholder text in directly as @captray says.\n. cc @jeffmo \u2013 know what's up?\n. I specifically noted this in the docs:\n\nNote also that we're relying on the JavaScript engine preserving object enumeration order here, which is not guaranteed by the spec but is implemented by all major browsers and VMs for objects with non-numeric keys.\n\nFor now we're planning to keep it as-is (and the React internals currently rely on this property as it allows faster performance than other options) but we'll keep your suggestion in mind for the future.\n. lgtm otherwise, thank you!\n. Thank you!\n. Sure \u2013 thanks.\n. You can use the split function with a regex and then replace the captured parts, like so:\njs\nvar parts = \"I am a cow; cows say moo. MOOOOO.\".split(/(\\bmoo+\\b)/gi);\nfor (var i = 1; i < parts.length; i += 2) {\n  parts[i] = <span className=\"match\" key={i}>{parts[i]}</span>;\n}\nreturn <div>{parts}</div>;\nLet me know if that's unclear.\n. Parsing JSX at runtime is error-prone and slow, and can easily have security implications \u2013 it wouldn't inherently be any safer than dangerouslySetInnerHTML is.\n. Let's check to see if we can have a better warning for this.\n. @ivanflorentin You should have seen a warning in the console too pointing this out.\n. @ivanflorentin Your code works fine for me here:\nhttp://jsbin.com/venaqozebi/1/edit\nIf you can make a repro case in jsbin for me to look at, I'm happy to investigate.\n. Yes, you need to pass an element (either React.createElement(CommentBox) or <CommentBox />) to React.render.\n. Yes, this was a deprecation introduced in 0.12 and completely removed in 0.13. See http://facebook.github.io/react/blog/2014/10/14/introducing-react-elements.html for more details. You should have received console warnings for these when running under 0.12.\n. No, the same markup is still rendered on client and server.\n. Probably safer not to, but there's nothing in particular that ties this to 0.14.\n. I was thinking we could warn if the rendered element is an HTMLUnknownElement:\nhttp://ryanmorr.com/determine-html5-element-support-in-javascript/\n. Hm that's a good point. :(\n. Sounds like it. Happy to take PRs to fix this \u2013 though I'm surprised that 678/817 fail; I thought they all passed at one point in the past.\n. As you can see in the ReactElement source:\nhttps://github.com/vgpena/react/blob/v0.13.1/src/classic/element/ReactElement.js#L111\n_store is always initialized with originalProps, so if you're seeing otherwise it's probably due to mixing different copies of React together, which we don't currently support.\n(As a side note, your fix would be a little off in any case because you need to check element._store.originalProps, not just originalProps.)\n. Wrong repo? :)\n. We're not planning to add more to the existing helpers in test utils right now but you can always make your own helpers in your own util library and use those.\n. When you call setState on a component, its componentWillReceiveProps is not called (e.g., Application in your example does not have componentWillReceiveProps re-called). React doesn't make an attempt to diff props for user-defined components so it doesn't know whether you've changed them. In your case where the props object is empty it's pretty clear but oftentimes a prop is a complex object or function that's hard or impossible to diff, so we call it always (and rerender always) when a parent component rerenders.\nNote also that the behavior here may change slightly after #3226 \u2013 if you have a JSX object that doesn't depend on the parent's props at all, it'll be hoisted outside the React.createClass definition by a smart compiler. If you were to write React.createElement(Button, {test: this.props.test}) then it would always rerender though, even if this.props.test is always the same (because it's hard to determine that statically).\n. Updates happen asynchronously when calling React.render with a new React element on the same container. We might start batching initial renders too.\n. The result of React.createElement or any JSX expression.\n. For the second and third renders there, I believe it's async.\n. Yup, agreed.\n. Yeah, ReactDOMInput, ReactDOMSelect, ReactDOMTextarea, and maybe LinkedValueUtils too (just off the top of my head).\n. It looks like I accidentally fixed this in 52a229f168ea10c342d0e69e1ddc63d425579656. Want to send a pull request with your test to make sure we don't regress? (You don't need the findDOMNode call at all.)\n. The bug here was that inputs weren't firing with this as undefined. ES6 classes do not autobind, nor will they. Your options are to bind manually in render, add this.foo = this.foo.bind(this); to the constructor, or use the experimental ES7 property initializer syntax which you need to enable manually in Babel:\n``` js\nclass Foo extends React.Component {\n  handleClick = (event) => {\n  }\nrender() {}\n}\n``\n. Can we add a new test that would have failed with owner-based context?\n. Having all the cleanup in one commit is preferable to me.\n. 0.13.3 only includes 0.13 plus individually cherry-picked commits; 0.14 will include everything that's currently in master.\n. After the things in #3220 get done.\n. In this case, I think \"Factory\" is already the component class name? But if you add a breakpoint on the warning line and look at the stack, you should see the exact code path that caused it.\n. If you look up through the stack trace, one of the frames should be your application code which is accessing.type.\n. @sebmarkbage Can you be more specific?\n. @ericclemmons Yes, this is still a React issue.\n. Hm, it's possible 40b7c19a890b04e5d7bd1273e4f90bb78769ae5b fixed it.\n. Perhaps you mixed upid=\"container\"withclassName=\"container\"? This works for me: http://jsfiddle.net/xzqwjhhL/\n. I see. The (subtle!) difference here is that your HTML has whitespace in between each of the adjacent elements, but in JSX whitespace is removed between two tags on different lines because that's usually what you want. You can add it back explicitly by writing{' '}in between them: http://jsfiddle.net/fu1fs8ez/\n.andaren't HTML tags. If you wanted to be more precise you could writeand.\n. What's the use case?\n. Justvar View = 'div';is all you need, assuming you then use it with JSX or createElement.\n. Can you help me understand what this change does? Sorry if I'm being dense but I don't know how` is related to JSX.\n. Tests are failing:\n```\n\n\nnot ok 88 - browser/eventPlugins/tests/SelectEventPlugin-test SelectEventPlugin should extract if an onSelect listener is present.\n\n\nExpected null not to be null.\nTypeError: 'null' is not an object (evaluating 'mouseup.type') in http://127.0.0.1:9999/test/index.html (line 79)\n```\nThey're also super noisy because of a recent PR \u2013 I'll see if we can fix that separately.\n. lgtm \u2013 merge at will.\n. This seems very unlikely to me. Can you post a repro case?\n. Oops, never mind \u2013 this is because this inside the iterator function isn't your component. Passing this as the third argument to _.map or using an arrow function instead will solve your problem.\n. Yeah, we've talked some about this: #1255. This is unfortunate but I don't think we're going to change anything here. This is the sort of the thing that a static type system like Flow should be able to catch though. \n. No, we're not ready to recommend ES6 classes to all newcomers. See #3375 for more details.\n. I don't have any objection to bumping the limit to some number in the millions \u2013 or we could probably get rid of the check too.\n. Curious: what's preventing you from upgrading?\n. Can you be more specific? What did you expect to happen? What happened instead?\n. Updated, now skipping nulls per https://github.com/facebook/react/issues/2393#issuecomment-100573767.\n@sebmarkbage?\n. If it's a single child, this.props.children already works. If it's an array containing one element and you want to extract it, your best bet is probably to use forEach and store away the first child that comes out, something like:\nvar child;\nReact.Children.forEach(this.props.children, function(c) {\n  child = c;\n});\n. (Hi from Venice!)\nI think we want this for 0.14. We wanted to make it so switching from this.props.children to React.Children.toArray(this.props.children) when rerendering does not change the keys of all children, which is currently hard.\n. It does remove undefined. See the test case labeled null/undefined/bool are all omitted. I'd expect every element in the return value of this function to be a string, number, or React element.. We have a test case checking that it is excluded so I am pretty sure it is. :)\nIn particular it is treated the same as null here: https://github.com/facebook/react/blob/1f667fd37fab433d77df291e852e1c8c712e7c1e/src/isomorphic/children/traverseAllChildren.js#L79. So maybe you have an issue somewhere else in your code.. Are you sure it was undefined? Perhaps it was a string or number. If you were reading child.props.foo then that would then give you a \"undefined has no property .foo\" error.. You mean write different variants of traverseAllChildren with the different callbacks inlined?\n. To be clear, you can do this instead:\n``` js\nvar Template = React.createClass({\n    render: function() {\n        return {this.props.data};\n    }\n});\nvar App = React.createClass({\n    render: function() {\n        return ;\n    }\n});\n``\n. IfTemplateis'div', thenwill render a div. You can also passsome content} />and returnthis.props.elementinsideMyComponent.\n. We'll go with #3723 \u2013 @koba04 thanks for bringing this up!\n. I think you should have also seen a runtime warning for this?\n. @tjwudi Thanks, looks like an oversight. Fix incoming\u2026\n. ^ Also broken on Chrome per #4733.\n. @nhunzaker Mind bisecting to figure out which commit fixes it and needs to be cherry-picked?\n. @syranide In master we now have a warning, at least.\n. @RudmanMario That's what I meant by my comment, sorry for being unclear \u2013 in the next release we'll warn you explicitly and suggest adding a tbody tag.\n. ![image](https://cloud.githubusercontent.com/assets/6820/7127213/98d81cc8-e1f5-11e4-874d-00917961f5bc.png)\n. Let's get #3675 in too.\n. lgtm\n. (y)\n. We haven't used Object.keys in part due to worries about GC overhead. ReactDOMComponent.js has the other places that are likely to matter for perf.\n. (I guess there are a few in ReactMultiChild.js too.)\n. Thanks!\n. Thanks!\n. Yeah, this isn't React \u2013 not sure where you got \"code\". If you search https://fb.me/react-0.13.1.js for \"key = config\" you'll see that our built copy haskey` as well.\n. They're supposed to be, but we're checking for setState here:\nhttps://github.com/facebook/react/blob/v0.13.1/src/test/ReactTestUtils.js#L77-L80\nNot sure what the best fix is \u2013 @sebmarkbage? Seems like we could look to see if the internal instance is an instance of ReactCompositeComponent.\n. In 0.14 we'll have a warning for this. :)\n. Let's call it React\u2026\n. testing\n. testing 2\n. testing 3 (sorry folks, testing emails)\n. Merged in e3cf48cd7fd4fa543134a289d12783cce828b048 -- thanks!\n. Yeah, this is that issue. Works correctly on master as long as you keep the tab focused \u2013 if you background the tab you run into #1326 though.\n. <3. Closing this out as we need something more sophisticated for this to work. #3718 may solve this problem \u2013 haven't looked at it in detail yet.\n. In any event, they're not using it:\nhttps://github.com/omcljs/om/blob/0.8.8/src/om/core.cljs#L1180\n. Going to leave this open in case we want to do a patch release for 0.13.\n. Yes, sorry for being unclear \u2013 the random() call was just to demonstrate; the original case here instantiated a value-like object each time with the same arguments.\n. Fix is in 0.13.3.\n. Yeah. For now, let's also link to the createClass docs in the tutorial and intro docs after showing React.Component as an alternative for people who don't want to use ES6 classes.\n. No, the merge happened before too; here I split _processChildContext into _getValidatedChildContext and _mergeChildContext.\n. _processChildContext previously called getChildContext, then merged the result on top of its argument (which was either owner-based this._currentElement._context or parent-based context). mountComponent called _processChildContext directly as well as indirectly via _renderValidatedComponent, causing getChildContext to be called twice. Here, I call it once and use it when determining owner-based and parent-based context to pass down. Same for updates in _updateRenderedComponent.\n. Dupe of #2770, I think.\n. Also \u2013 it's very unlikely that ReactPerf is causing you perf problems if it's disabled. When measurement is disabled, it just calls the wrapped function directly so there should be barely any overhead. If you're seeing it as a hot spot, it may be an artifact of your profiling tools.\n. For reference, this separation was introduced intentionally in this PR: https://github.com/facebook/react/pull/2567\ncc @sebmarkbage \n. Nice find. Maybe we can take advantage of ReactChildren.map here? We may want a version which skips the ReactFragment.create call for these internals but otherwise I think it should give the right effect.\n. Do we want to keep renderSubtreeIntoContainer?\n. I don't think this is quite right \u2013 since you're storing the timeout ID as a global now, you're mixing timers from different components together. You'll probably want to store it as this.noEventTimout or similar.\nHow did you test this?\n. It doesn't necessarily need to be a programmatic test, though that would be great. Would be good to know that it worked in manual testing at least.\n. I'll take this for consistency with the other functions here, but I'd really discourage you from mutating Object.prototype. Most libraries break if you do. For example, jQuery doesn't support it.\n. Should be props.is != null. Can we extract the logic to a helper function? (Side note: when is this._tag null?)\nIdeally we would do something intelligent when the value of the is attribute changes since I assume we need to remount the element to have things work properly. (That sounds harder though and certainly doesn't need to be done in this PR.)\n. Yeah. It was more convincing when I thought it could just take this as an argument, but tag and props seems good.\n. We're not planning to add more utils like this to TestUtils. You can always implement this locally in your project as a helper if you want to, but we're planning to move towards shallow testing (i.e., TestUtils. createRenderer) in the future.\n. Yes, thank you.\n. Can you explain in more detail why the old code didn't work and why the new code does?\n. @meatballhat I see that this now finds grunt successfully, but the tests still don't pass. They haven't passed on master for a few commits now due to this grunt problem, but they should pass if grunt is found, so something else is wrong here.\n. @meatballhat I've never seen them before. With a fresh clone of this repo, running npm install then ./node_modules/grunt-cli/bin/grunt test works for me with no problems locally. This Travis build from a couple of days ago passed with no errors and we haven't changed the dependencies since then:\nhttps://travis-ci.org/facebook/react/builds/60015425\n. My theory is something with npm versions. I went with my #3722.\n. Yeah, unfortunately there's no way for you to manage only the tbody in React for the reasons already mentioned.\n. @StoneCypher That's true but it doesn't help here.\n. @scarletsky If you can post a simple jsbin that shows the problem (in a new GitHub issue, ideally), I'll be happy to take a look.\n. Thanks for the solid test case.\nI have not confirmed, but I believe this is also a manifestation of #2410. I believe it would be fixed if you instead added and removed rows in the stores in response to CHANGE_TABLE_ROWS directly (and drop ADD_ROW and REMOVE_ROW completely) instead of chaining actions together in componentWillReceiveProps. What you're doing here is generally considered a Flux antipattern and also ties your code to your views more, which makes it harder to refactor your code later. I'll leave this open until I can confirm that this is in fact a dupe of #2410.\n. Yeah, I'm 95% sure this is #2410.\n. @scarletsky I am not a flux expert, sorry \u2013 but my understanding is that chaining actions is always discouraged.\n. getMarkupWrap is already meant to handle these cases:\nhttps://github.com/facebook/react/blob/master/src/vendor/core/getMarkupWrap.js\nUnfortunately it looks like image isn't in the list. Since we don't want to add these all one at a time we'll need some alternative way to deal with this.\n. As @gaearon said, React never reads from the DOM and mutating React-rendered DOM from outside of React isn't supported.\n. I'd rather we not do this here. Can we set up a redirect somewhere else like we have for reactjs.org and reactjs.com?\n. There's only browser compatibility differences, but jQuery 2 is probably fine for this.\n. This example works fine for me:\nhttp://jsbin.com/vupagekuvi/2/edit?html,js\n@mikecardwell Any chance you can get a repro in jsbin?\n. Thanks for the example. Looks like this happens with full-page rendering when you try to re-run the React.render in the head tag because the body hasn't been parsed yet and so React can't find it when it goes to do an update. I think it's best for us to not support this pattern (and recommend you call React.render in a script tag at the end of your body or on DOM ready) but maybe we can give a warning for this.\n. You can do\n<i data-icon={String.fromCharCode(0xf00f)} />\nor if you have it as a string for some reason,\n<i data-icon={String.fromCharCode(parseInt('f00f', 16))} />\nOnly the JSX compiler parses HTML entities; React doesn't so you should use the Unicode character instead.\n. This is expected; see #3610.\n. Thanks for the report.\nThis keeps coming up. I know @sebmarkbage was reluctant but we should probably just add a hard error for this in createElement.\n. @danschumann You should have seen a console warning for this though. Did you?\n. @agnosticdev Thanks \u2013 it looks like Babel gives a better error here which is reassuring. We're probably not going to end up improving react-tools's parser here but we'll start to recommend Babel more and hopefully that will help for transform-related errors.\n. @jsfb No, we haven't added the error for non-string/function types that I said I wanted to add.\n. Thanks!\n. Thanks for the bump. I'll try to make some more progress on SVG in the next couple of weeks and figure out if we want to take this.\n. SVG tags work correctly in master.\n. If you're going for unsupported workarounds, you can also call DOMProperty.injection.injectDOMPropertyConfig anytime before or after React is required.\n. Can you try with the master version of React? You can do this by changing your package.json to have\n\"react\": \"http://react.zpao.com/builds/master/latest/react.tgz\"\nand running npm install again. You may see a more informative warning.\n. Sorry, it's a current limitation that you can't return more than one component from a React render method. Something we want to fix (#2127).\nYou'll have to refactor your components to make this work right now. If it helps, you can have a plain function (not a React component) return an array of elements but that doesn't necessarily help if you need component-local state like you have in GeneExonRow.\n. (This conflicts with #3788\u2026)\ncc @sebmck \u2013 if you could take a look and let me know if this looks sane, I'd appreciate it.\n. (it gets the @sebmck seal of approval!)\n\n. > NOTE: It's not recommended to use this API unless you're dealing with dynamic source strings\n;)\n. This logic would actually be better in ReactDOMOption especially since we already have that wrapper, not in ReactDOMComponent.\n. @yiminghe I understand. I'd prefer to have the logic in ReactDOMOption because I don't anticipate us adding it for other tags. If we choose to do that in the future, we can look at abstracting it out \u2013 but ReactDOMComponent is already very complicated and so we'd like to avoid complicating it unnecessarily. Can you move the code to ReactDOMOption's render function?\n. Actually, #3847 looks closer so I'll follow up with that one instead. Thanks for sending this in.\n. I don't think this works if the element has a data-reactid attribute, which it would in the case you're trying to catch?\n. Checking for HTMLUnknownElement is preferable because we might not have all the HTML tags in that list and definitely don't have all the SVG tags.\nYou can probably mock out document.createElement in the test (or temporarily set HTMLUnknownElement to HTMLParagraphElement, and verify you get the warning when creating a p), but if that doesn't work we can take it without a test.\n. This is fixed in master and will be in the next release.\n. ReactTestUtils.renderIntoDocument plz\n. As you can see from the implementation, renderIntoDocument simply calls React.render:\nhttps://github.com/facebook/react/blob/v0.13.3/src/test/ReactTestUtils.js#L45-L53\nIf you're having trouble passing functions, it's an artifact of your test environment and not something specific to React.\n. > workaround\n(To be clear, using setState is the recommended pattern whenever you want to update state. Mutating the state object directly works in some cases as you saw but does not work consistently with all of the lifecycle methods so is not recommended.)\n. I actually ended up fixing this in #5016 so we don't need to take this. Thanks for looking into it.\n. Bonus! This test passes when picked onto 0.12-stable.\n. @sebmarkbage What element would you be rendering into before the <body> open tag?\n. Let's just warn if it's DOC_NODE_TYPE without a body then and not warn if you pass an element or doc fragment.\n@bloodyowl When you're done, can you squash your commits together?\n. @bloodyowl What case are you trying to warn against with such a check?\n. @vicapow (and @askmatey probably) I assume you're talking about #3207. It's true that it is more work to create and render into a div but you will tend to get unreproducible issues if you don't from browser extensions and the like that manipulate the body directly. This issue is unrelated.\n. \n. It is surprising to me that setting the attribute doesn't work. So writing <a href=\"...\"> in the HTML works but calling .setAttribute does not?\n. Okay, thanks for the followup. xlinkHref in React does that.\n. Just a few inlines \u2013 otherwise looks great. If you could make those updates and squash your commits I'll merge.\n. Thanks!\n. babel-eslint lints the original source, not the transformed code. See this post for info about how to set it up:\nhttps://medium.com/@dan_abramov/lint-like-it-s-2015-6987d44c5b48\n. No, #1398 didn't make the release; we decided it was a little too risky. (The \"Did it.\" comment there refers to the release itself, not that PR.)\n. We'll stick with the original unless it's causing problems.\n. Thanks!\n. The W3 docs you link are outdated; the latest version makes no mention of the syntax: http://www.w3.org/TR/css-style-attr/.\nRight now we're not planning to add more support for complicated \"inline\" styles like this into React core.\n. @zpao r? Need this for sync.\n. Am I? We can make this say \"expected a single ReactElement\".\n. The code you posted sounds fine \u2013 if you can reduce this to a simple test case I'd be happy to reopen and take a look.\n. (Please note that you should not use NODE_ENV=production during development as it silences many helpful warnings.)\n. @silvenon If you were using node, wouldn't the user-agent check prevent the message? We can add a check for console.debug if that would be helpful.\n. @mvasilkov What browser do you use?\n. We could also add react-devtools to the Opera catalog (https://github.com/facebook/react-devtools/issues/178).\n. @Sieabah Do you know if that library is using React to render things or only loading React without rendering anything? If it's the latter, we could change React to do this log on the first render (instead of on app startup) but if it's the former that won't help.. I think if auth0 doesn't expect you to care that it is built in React, it should probably use the production React build which doesn't have this warning. I wonder if it is currently always using the dev build or if it switches depending on if your app is in prod mode.. Can you move it down so the list is in alphabetical order and squash your commits? After that I'll merge this \u2013 thanks!\n. Sorry \u2013 to be clear, it should be between min and multiple.\n. Thanks!\n. It's in 0.14 RC, will be in 0.14. You can generally tell this by looking at the tags on the commit page (35e67a793e0899328696bb8a776f101503fb7612).\n. Let's also add required as @camsong says. Instead of listing the JS output, what do you think of just writing that disabled and disabled={true} are equivalent with an example?\n. Yup, this is fine now. Thank you @glenjamin!\n. topLevelTypes is the wrong thing to look at here. It doesn't include custom React events like onMouseEnter and onMouseLeave. Instead, you want to look at the \"registration names\" gathered at the top of each event \"plugin\":\nhttps://github.com/facebook/react/blob/8f9643485d767e44af8a9c388601414a4dadf67e/src/renderers/dom/client/eventPlugins/SimpleEventPlugin.js#L37-L43\nThese are collected in EventPluginRegistry:\nhttps://github.com/facebook/react/blob/8f9643485d767e44af8a9c388601414a4dadf67e/src/renderers/shared/event/EventPluginRegistry.js\nHopefully that gives you some clues to go on. I also don't love that the warning logic for DOM properties\nhttps://github.com/facebook/react/blob/71afd5a465880d87e7acbcf4f91ee23b716a87d5/src/renderers/dom/shared/DOMPropertyOperations.js#L84\nis in a totally different place. We should at least make the error messages a little more similar.\n. I think we're going to go with #5361.\n. A ReactElement doesn't correspond to a DOM node until you mount it in the DOM using React.render.\nvar element = <ScrollView><Text>hello</Text></ScrollView>;\nvar component = React.render(element, container);\nvar node = React.findDOMNode(component);\n. Not sure what your proposed API is? Can you unmount and then remount?\n. I don't think we'll do this since providing a new key is easy and we're trying to reduce API surface area, not increase it. Thanks for the idea.\n. buttons are type=\"submit\" by default in HTML, and pressing enter simulates a click on the button. This is standard HTML behavior, not specific to React.\n. Leaving as-is.\n. We've gone back and forth on this; there are benefits to both. This would solve the case where you're setting your state based on your current this.state value, but not if you also read from props. See this comment:\nhttps://github.com/facebook/react/issues/122#issuecomment-81856416\nInstead, our recommendation is to use the function form of setState so instead of\nthis.setState({\n  alarmSet: this.state.alarmTime > 0 && this.props.elapsedTime < this.state.alarmTime\n});\nyou write\nthis.setState((state, props) => ({\n  alarmSet: state.alarmTime > 0 && props.elapsedTime < state.alarmTime\n}));\nWe're not planning to change this anytime soon; any improvements will probably be along the lines of making the APIs more functional to support this better.\n. Code looks fine. Will try to replicate your perf-test results and if it looks positive I'll merge.\n. @jimfb Assigning to you.\n. @mridgway Sorry for dropping the ball on this one. Got caught up in preparing for the conference and then I was out on vacation for a couple weeks. I could've passed this to @jimfb when he started focusing on perf work but didn't think of it at the time. Please do let us know if you find more improvements and hopefully we can get them merged sooner next time.\n. Closing in favor of #2127.\n. You listed basically all the options. In the future we might support a syntax like\n{this.props.condition && <frag>\n    <p>Foo</p>\n    <p>Bar</p>\n</frag>}\nwhich wouldn't result in an added HTML element, but there's nothing else to do here now.\n. Aesthetically I prefer .toLowerCase()\u2026 :) Fine either way I guess.\n. @neojski Let's do lower case. I was always bothered by the fact that it was uppercase in these tests. (Yes, .nodeName is uppercase, but conventional HTML markup (including XHTML) writes the tags in lowercase.)\n. Looks great. In src/renderers/dom/client/ReactMount.js we have a .tagName check \u2013 can you change that one too?\n. Thank you!\n. This looks pretty good overall.\n. lgtm \u2013 can you fix those two things? Then feel free to squash and merge.\n. Please post support questions somewhere else, such as Stack Overflow, in the future.\n. See #2517.\n. Thanks!\n. Thanks!\n. For anyone following along on this issue, an alternate variant of this was merged in #4587 but we might take this implementation or a similar one in a future release.\n. Maybe we should add a warning for this too. :)\n. shipit\n. Good question. I don't know the answer.\n. :+1: if we're good internally.\n. Those words meant, \"do not mutate this.state\", not that React will make a copy.\n. https://github.com/facebook/react/commit/40b7c19a890b04e5d7bd1273e4f90bb78769ae5b may have fixed this. Not sure it actually rerenders though?\n. Yeah maybe. \n. Yeah, let's at least have a test.\n. Can we move this runtime check into a lint rule?\nhttps://github.com/facebook/react/blob/6b79977c310a1f8e396f88d36703fc97c9fa4bd2/src/shared/vendor/core/warning.js#L34\n. \u2026how on earth did this pass lint. \n. @ysmood We're not ready to deprecate mixins because we don't have good replacements for all of their use cases. When we do, we'll probably move towards deprecating mixins and React.createClass, but that is at least months away.\n. @zpao This one's pretty easy.\n. lgtm\n. @sebmarkbage \n. @sebmarkbage Last ones!\n. @mridgway Yup, going away soon. Will require a bunch more changes though.\n. (@mridgway Done in #4139.)\n. We don't want to add DOM-specific logic into the JSX transform. It's more likely that we'd split out ControlledInput and UncontrolledInput into separate components which would also solve the problem, but honestly this probably isn't tripping up enough people for it to be worth making that change for us now.\n. Landing to unblock.\n. If you really want to control the children of UIPane imperatively in that way, you can add a setChildren method to the instance that can be called from outside which updates its state. (Or you could do the same on a wrapper component.) Something like:\nclass UIPane extends React.Component {\n  setChildren(children) {\n    this.setState({children: children});\n  }\n  render() {\n    return <div>{this.state.children}</div>;\n  }\n}\n(setProps in particular can be confusing because now you have multiple places in your app disagreeing about what they think the current props are.)\n@jimfb also has a ReactComponentRenderer wrapper class that might be helpful. Like #1711.\n. You can also do\n<UIPane ref=\"pane\" />\nand then this.refs.pane.setChildren().\n. I knew about this and thought we were planning to take this out after fixing prop mutations internally.\n. Right, but it's harder ergonomically to deeply mutate an element that's created within render, no? I figured it's a little safer to wait but maybe I'm missing something. lgtm either way.\n. :+1: \n. Closing since this isn't actionable for us as-is without a code sample, but @zpao's suggestion sounds the most likely.\n. Try accessKey: http://react.jsbin.com/bucuxiguli/1/edit. You should have seen a warning in your console for this.\n. The answer you got on Stack Overflow is correct. defaultValue only specifies the value when the input is initially created; if you want it to remain updated you need to use value and handle onChange events correctly.\nWe don't update when defaultValue changes because otherwise you have two sources (the user's input and your component props) trying to control the value, and it wouldn't be clear what should happen when they conflict. Instead, we force you to think about and write out the actual behavior you want.\n. > The whole point is that state is not stored in the DOM...\nWith defaultValue, the state is stored in the DOM. That's why we don't recommend it. We recommend using controlled components instead. The docs say:\n\nIf you wanted to update the value in response to user input, you could use the onChange event.\n(http://facebook.github.io/react/docs/forms.html#controlled-components)\n\nLet me know if that's still confusing.\n. Is the plan that ReactUpdateQueue gets passed in somehow when mounting to break that dep?\n. Dupe of #1587.\n. @sebmarkbage \n. They're not public outside the component. We should figure out a solution here though. https://github.com/facebook/react-native/issues/1521 is also related.\n. Not quite right, but you can use an ES2015 template string, which can contain newlines:\n`` js\nrender: function () {\n  return (\n     <Markdown>\n       {# Hi whitespace is important in this tag\n   Please add an option to keep all my spaces!`}\n </Markdown>\n\n)\n}\n```\nWe're unlikely to do anything beyond this.\n. Whitespace also matters with white-space: pre;.\n. @matthewmueller No, you need the backticks. (@mathieumg was saying that whitespace is collapsed (by the browser) in most HTML tags with the notable exception of textarea so I just pointed out that changing the white-space CSS on other tags will also preserve space.)\n. Thanks!\n. React will warn for invalid nesting like this in the next release.\n. @jimfb Yes it will; you can't have two nested anchor tags in HTML.\n@mdcsfk You will need to restructure your markup. You can't have that kind of nesting in HTML, whether or not you're using React. Usually you'll want to change one of the links to not be an actual link and you can add a click handler to it.\n. @bryanbraun Seems reasonable, though let's just inline the logic instead of pulling in a third-party library (and let's make sure the regex is equivalent in order to preserve existing links). Should only be a few lines of JS.\n. We've suggested in the past binding to onBlur if that's the semantics you want. Does that work for you?\n. This doesn't work because after one shallow render, the rendered output is\n<Double value={50}>{doubled => <div>{doubled}</div>}</Double>\nand if that were rendered, you'd get\n<div>{100}</div>\n(At no point would you have <Double value={50}><div>{100}</div></Double>.)\nYou could try\nvar double =TestUtils.createRenderer().render(<App input={50}/>).getRenderOutput();\nand verify that double.type is Double and that double.props.children(50) is <div>{100}</div> or something along those lines.\nLet me know if that doesn't make sense.\n. @activatedgeek See this blog post from last week: http://facebook.github.io/react/blog/2015/06/12/deprecating-jstransform-and-react-tools.html.\n. I don't think this is really a React issue. The discuss thread is a good place to keep talking about this.\n. @scottcheng My understanding: @threepointone has shouldComponentUpdate always return true so that it does properly rerender but would prefer a more restrictive shouldComponentUpdate method such as by following one of the methods in the original bulleted list (but can't due to the inability to introspect closures). . Damn it. :)\n. We generate <input disabled=\"\"> currently which works in both HTML5 and XHTML. Does that work or does the value need to be 'true'?\nRight now React probably won't be usable without forking the property stuff (sorry!) but hopefully there's not too much else. I want to support SVG better soon and maybe improved XUL support can come with that too.\n. Hm, I thought it should work: https://github.com/facebook/react/blob/d67f23fb0e1813aae26ff09d36eea9e32d8e3dae/src/renderers/dom/shared/DOMPropertyOperations.js#L123-L126\n. Oh, I guess that's not in a release yet. http://react.zpao.com/builds/master/latest/ has builds from master if you're feeling adventurous, or you can wait for 0.14 in about a month.\n. Neat technique.\n. Test failures are just due to missing warnings/getDOMNode. Been working on today, almost done.\n. @sebmarkbage Yeah, just pushed the last commit. Want to look? Maybe there's a better way to do setProps (cf. _topLevelWrapper) but this works.\n(One failing test, investigating now.)\n. yolo\n. :+1: \n. I would find this more useful as\nsh\ngit diff -z --name-only --diff-filter=ACMRTUB master... | xargs -0 eslint --\n(which also excludes deleted files to avoid errors) so that I can also run it after committing if I forgot. What do you think?\n. master... does merge-base for you but I guess it does master...HEAD which indeed doesn't count the index. Your way seems good.\n. Curious: does acorn support all the latest ES6 syntax or are there many constructs that only acorn-babel supports?\n. Sweet, thank you.\n. Oh, good point @zpao. Somehow I forgot that.\n. Wow, somehow I didn't know we had the translation actually available online. Will cherry-pick now.\n@jimfb It's easy if you ever want to do it.\n. This time I just picked all of the ones that had the label. We don't put on that label for 0.14-related changes but otherwise we generally take everything. I do git cherry-pick -x so it links back to the original commit.\n. Sure.\n. @abhilashsajeev If you need it urgently, you can always patch your local copy of React to include this change. 0.14 final will probably be released sometime in July.\n. No, not July first week. Sometime in July.\n. :+1: \n. I don't think you can reliably get charCode for non-keypress events. For keyboard shortcuts, you probably have to use keyCode. @salier might be able to say more, but I'm going to close this out because unfortunately, I don't think React can help you.\n. You can always do\nvar node = React.findDOMNode(this);\nnode.addEventListener(...);\nin a componentDidMount (and remove it in componentWillUnmount). I am fairly sure that charCode won't work across browsers though, so be sure to test.\n. key is roughly equivalent to keyCode; it doesn't depend on keyboard layout like charCode does. If key would work for you, keyCode will too.\n. I'd listen to keydown and do\ne.keyCode === 'C'.charCodeAt(0) && e.ctrlKey\nwhich should also work in React.\n. Yes, this works.\n. \n. Dupe of #3814 (fixed in master already).\n. @jimfb? \n. I guess so, but I'm curious how you ended up in a situation where this wasn't obvious. In most cases I'd imagine that you would have just written the code seconds earlier so it would be pretty obvious? \n. It's not super obvious what should happen with events if a component switches away from null during the would-be transition time or if it switches to null while transitioning, but I guess this is an improvement either way.\nCan you squash your commits together?\n. No worries. On your patch-1 branch, you'll want to run an interactive rebase by doing\ngit rebase -i master\nmeaning you want to edit the changes you've made since the top of the master branch. You'll get a text editor, hopefully with two lines corresponding to your two commits. If you change the second \"pick\" to a \"f\" or \"fixup\" then save the file, git will amend the second commit to the first (and throw away its message). You'll then want to do a git push -f to overwrite the branch you currently have on GitHub with the new, altered commit.\n. Thanks @johanneslumpe!\n. Can you add a test for what happens when you call setState on an unmounted composite, and can you add a test to make sure that a composite that returns null still gives true for .isMounted()?\nOtherwise good.\n. Can you make sure it doesn't re-call render?\n. tl;dr\n<div a={(2)} b={3} />\ncompiles to\nReact.createElement(\"div\", {a: (2, )b: 3})\nin jstransform, which is wrong. \n@Huxpro You can work around this by removing the parentheses around the function. Please note that react-tools is now deprecated per http://facebook.github.io/react/blog/2015/06/12/deprecating-jstransform-and-react-tools.html (and Babel already works correctly for this case), but maybe we can fix this anyway.\n. I think this rule (#examples p) ends up affecting more elements than you intended. I'm not actually sure what issue you're trying to fix. #4177? In any event, this also doesn't match the style of the surrounding code and that would also need to be fixed. I'm going to close this but if you feel strongly let me know and we can reopen.\n. Thanks\n. Oops \u2013 in the future, please change the source markdown files in docs/ on the master branch.\n. Maybe that's why it has an underscore? :)\n. #examples contains not only the rendered examples, but also the code editors and preceding descriptions. Thanks for your attempt to contribute, but we're not willing to take such a broad change, and the actual problem you're trying to fix is so minor that it's not causing any problems.\n. 1. This should use the warning module, not a call to console.error.\n2. This shouldn't warn more than once per tag. Probably easiest to combine with validateDangerousTag (rename to just validateTagName) and take advantage of validatedTagCache.\n3. SVG tags like fontFace start with a lowercase letter and are valid. Let's only warn when the first letter is uppercase. Let's use the message: \"DOM tag names should be lowercase but got: %s.\". \nWhen you're done, can you squash your commits?\n. No objections here.\n. @sebmarkbage doesn't always win!\n. All the switch statements too for custom form components (incl. this._tag === 'select').\n. And a bunch that look like this: https://github.com/facebook/react/blob/c5fb3ff9870cc09a6ec82672e854ab54a412cef1/src/renderers/dom/shared/ReactDOMComponent.js#L677\n. We at least need to preserve case for SVG tags.\n. > They should be insensitive according to spec.\nTIL. I guess we might want to support XHTML though. Sigh. Browsers.\n. Can you post a simple jsbin (or similar) repro?\n. Looks like Firefox re-initializes the input completely when you change the type, which makes intuitive sense to me. If you want to maintain the cursor position it's probably best to manage selectionStart/selectionEnd yourself. Maybe one day we'll have a better API to manage this from React (https://github.com/reactjs/react-future/issues/4) but not right now, sorry.\n(As a side note, your component isn't actually controlled like you might believe it is \u2013 starting value as an empty string and handling the change is maybe what you meant to do: http://jsbin.com/bedadoxada/1/edit?js,output. Doesn't affect this issue though.)\n. Yes, if you feel that changing type should not move the cursor then opening a Firefox issue sounds reasonable. I'm fairly sure you'll find that the same problem exists without React.\n(Personally, I'm not convinced that \"preserving cursor position\" can even make sense. Sure, text and password look mostly similar, but for other types of inputs there's no cursor to preserve. Or for a date picker you might have multiple cursors for each part of the date.)\n. Freeze here seems reasonable-ish but if we want to avoid the create sham I'd just inline the minimal logic like in https://github.com/facebook/react/pull/139.\nNot my fight though. :) @sebmarkbage or @zpao can care.\n. I thought @sebmarkbage says you should use a transform in your app code, that it shouldn't be in the React repo at all.\n. Instead of checking el.type === Foo.type, check el.type === Foo. For isElementOfType, pass Foo not Foo.type. Let me know if that doesn't make sense.\n. Just 'thead' not React.DOM.thead.\n. Glad you figured it out.\n. If it's not a standard we're not going to polyfill it for you.\n. See #2912. Happy to reopen if a simple case shows React is doing something wrong.\n. Why would we remove this? The dev tools aren't deprecated.\n. @iamdustan Just a brief mention in our meeting notes for now: https://discuss.reactjs.org/t/meeting-notes-2015-06-19/697?u=spicyj. Probably @jaredly will put up a pull request to the devtools repo in the next few weeks and then you can try it out.\n. What is other in your code?\n. cloneElement's params beyond the props arg specifies children, much like createElement (unlike Object.assign/_.extend). Sounds like you probably want\nReact.cloneElement(child, { style:style, ...other })\ninstead.\n. Er, make that something like\n_.extend({ style:style }, other)\nsince you probably don't have that ES7 experimental transform.\n. The former.\n. You should be requiring babel/polyfill I think? https://babeljs.io/docs/usage/polyfill/ Are you requiring it before both immutable and react? That might be necessary.\n. babel/register is used in Node applications:\nhttps://babeljs.io/docs/setup/#babel_register\nThose docs mean that you don't need to also require the polyfill in that case. babel/register is not the correct thing to require in a browser environment though.\n. Immutable and React both fall back to the @@iterator property if Symbol.iterator doesn't exist in the environment.\n. (Closing since this doesn't sound like a React issue.)\n. Thanks @zpao, I hadn't gotten a chance to look.\n. No, it's fine to just add it to the list of supported properties and not add a unit test, but you should test manually:\nAre you able to make a local build and test that this property works correctly? It's important that both the initial render and updating the property work as those exercise different codepaths.\n. If both work for updates, null is best.\n. Thanks!\n. Unfortunately, this just works around the problem. For #4019 at least, we definitely do want the component to rerender, we (probably) just want to skip the selection preservation behavior. The fix for these will probably be nontrivial, but I'm going to close this PR out as it isn't the right fix.\n. Yes, just put a new key on the container and React will render that subtree from scratch.\n. This behavior is correct. If you want to find one of your children's DOM nodes, you have to add a ref first (using React.cloneElement) and then use that ref. (An element is little more than the type and props of what you want to render; it doesn't have identity and doesn't correspond to a DOM node directly.)\n. (The next commend in the thread you linked contradicts that. We do guarantee that children have their componentDidMount/DidUpdate called before the parent gets it.)\n. We're moving all the requires around for 0.14. I don't recall what we landed on for this. (@zpao if you're there?)\n. There is not. Why would you want such a thing?\n. > I would happily bypass React's event system entirely, but I have been unable to do that without working around the ways in which React's components are tied to it's event system.\nThe only way (that I can think of right now) that DOM components are tied to the event system is in value/checked handling. If you use defaultValue/defaultChecked then React won't do anything special.\n. No, I'm not sure. I would be inclined to think that both mouseenter and mouseleave should fire. It's a little weird to me that click doesn't but I can kind of justify that one in my mind.\n. @attilaaronnagy I believe this is expected and matches the HTML/DOM spec. @gaearon Did we miss this in the changelog?\n. @attilaaronnagy Browsers don't support click events on inputs. We don't do anything that would affect how addEventListener works.\n. @attilaaronnagy This jsbin using React 0.13.3 doesn't work for me:\nhttp://react.jsbin.com/qesulefepu/edit?html,js,output\nLet me know if you're seeing otherwise.\n. https://jsfiddle.net/qfLzkz5x/ doesn't have a disabled input; if you disable it then you see the behavior I posted. That is the browser's doing, not React's.\nIf you want to capture the onClick event on a disabled input, you have to put a wrapper node around it (or listen to it at the top level, if you prefer). This matches the standard DOM behavior. I personally think this behavior is surprising and not desirable, but we find it valuable to match the DOM spec for this so we're planning to leave it this way.\n. Dupe of #3548. :)\n. Thanks!\n. React adds one top level listener for each event but doesn't stop listening if the components are unmounted. We've never seen this to be a performance problem.\n. It could be that removing listeners is better in some cases, but in other cases you'll soon mount a new component which needs the same events in which case we'd be wasting effort by removing and readding them.\n. Dupe of #1297. mouseEnter/mouseLeave should work in the 0.14 beta already and in 0.14 when it comes out.\n. I guess I'm okay with that, though in reality what charset you use for your HTML files is your own business and React doesn't really care. 99% of people probably do want utf-8 though so we can add it.\n. @jimfb This looks fine for 0.15, but we need to keep it with a runtime warning for 0.14 so I reverted this before the beta and added warnings in 41aa3496aa632634f650edbe10d617799922d265.\n. Also negative feelings on this. The whole point of object spread is that it works the same as not spreading.\n. I don't think it's a big issue that we'll pass down props too much in some cases. I'd expect at most one or two things to break in FB code and maybe another one or two for external users. More importantly, it doesn't seem like we'd have any other good path to weed those out before a switch (unless we can figure out which attributes have meaning but are currently not passed so that they can be logged), so I think we may as well switch all at once.\n. Merging this one without review too. yolo?\n. Okay, I guess this is fine. Can you shorten the remove message too? (Not sure I've ever seen it though since you'd always hit the add invariant first in practice.)\n. Seems much less sketchy to merge without an accept than to accept your own diff. :)\n. If you are trying to submit a PR, clone the repo into a separate folder and follow the instructions in the README for building. You should probably never clone this repo into your node_modules folder.\n. We only support npm for this beta. The blog post explains how to install it from npm:\nhttp://facebook.github.io/react/blog/2015/07/03/react-v0.14-beta-1.html\nFor the final release we'll have a browser build, as with all our releases.\n. I think you can put the new Function() call in a try/catch.\n. Let's move it to statics and we can get it merged.\n. Bah. It's a little weird when mixins get involved since it's not actually a class-wide property though. Let's just take it like this. Sorry for the indecision.\n. And thanks for this, great work especially on the test cases.\n. This should work better in 0.14 when it's released.\n. Didn't you write React?\n. Best guess: the top-level onMouseOut doesn't fire on the removed node (which is basically what you said, sorry).\n. Well that's just lovely. Time to file a Chrome bug?\n. I think this change is good. @sebmarkbage said that e.g., <lineargradient> in your HTML is valid.\n. This is intentional; validating props at element creation time produces more useful errors. It also more closely matches the behavior of static type systems like Flow. Best for now is to simply mark those props optional. We also may introduce a feature in the future called context that will give another supported way to pass props from a parent like A to a child like B.\n. That's key={c.key}.\n. (y)\n. Should either of these be called dom?\n. The current ordering is deliberate. This way, when a ref to a component is resolved, you know that it is fully initialized (i.e., its componentDidMount has executed). Is it possible in your case for the child component to ask the parent to send it a signal once the parent is mounted? (Though executing callbacks on a parent component during the mount phase is tricky to reason about and is not recommended due to this timing issue.)\nLong-term we'd like to support layout using a solution such as this:\nhttps://github.com/reactjs/react-future/blob/master/04%20-%20Layout/02%20-%20Layout%20Components.js\nUnclear yet whether we'll adopt that solution though.\n. I think it's a dupe.\n. Can you explain why this is? Maybe I'm tired but this isn't immediately obvious.\n. Not sure I understand yet but I will reread the code tomorrow. Can you add a test?\n. Yes, this is in the HTML spec and not an IE bug. Buttons default to type=\"submit\". I recommend you create your own <Button /> component that has the behavior you want and use it instead. Though I agree that the spec is a little stupid here, this isn't really React's place to change it.\n. The warning wasn't in 0.13; it will be in 0.14.\n. Yes, this seems wrong. refs should only be called when a component is mounted or unmounted.\n. Never mind, this is actually right after all (and the same as 0.13). The function instance is different so we pass null to the old one and the component to the new one.\n. topEncrypted please.\n. @jimfb Where do you get that?\n. Thanks! Can you link to http://babeljs.io/docs/usage/browser/ instead of JSXTransformer.js too?\n. Awesome work. Do you mind squashing your commits together?\n. Thank you @rgbkrk!\n. \\o/\n. FB internal tests all pass with this too.\n. This was an intentional change in c419cce5c9eeaf4d41f226016c852500bdcb4f71. At the time, @sebmarkbage said (in an internal FB group):\n\nMore importantly, this change will mean that defaultProps can in the future get a perf boost. It will have similar performance characteristics as not using it (it used to be slow). Once we know that it works, it gives the option to use optimized descriptor construction. This is the missing piece: https://github.com/reactjs/react-future/blob/5874879a02ac0f0f81c2ea81a1f6dcaaf7ef7be7/01%20-%20Core/05%20-%20Elements.js#L58-L85\n\nYou'll have to find another way to do what you want. The upcoming \"context\" feature will provide another way for parents to pass data to children but we still haven't settled on an API and semantics we're happy with so we don't recommend using it widely.\n. That's weird, I would expect both to use the enumeration order.\n. Yeah, that should just use this for/in loop: https://github.com/facebook/react/blob/master/src/shared/stubs/Object.assign.js#L37. \n. Good sleuthing.\n. Can anyone seeing wrong attribute orders re-install and make sure you have object-assign@4.1.0? That should fix the issue.\n. @DylanPiercey You can also grab the native DOM node and set .checked on it manually if you prefer. Honestly, I'm confused what API you're proposing though. How would React know when to reset the value and know when to keep it as what the user entered?\n. Maybe we can make defaultValue update the DOM too. Few people use reset buttons so this hasn't come up.\n. I'm happy to take a pull request that passes defaultValue through to the DOM. It looks like that is linked directly to the value attribute. Probably the best way to do this is to change our code so that value is treated as an attribute (using .setAttribute('value', x) instead of .value = x) in the property config which is equivalent to setting .defaultValue, then ReactDOMInput can manually set .value instead of going through DOMPropertyOperations. Open to other suggestions.\n\n. (Marking as good first bug \u2013 instructions are in my earlier comment; feel free to ask for clarification.)\n. Thanks.\n. @gaearon Can you say more about which revamp you mean? I know @joecritch is interested in helping out with docs updates.\n. Dupe of #3131, more or less. I don't know yet whether we want to support this.\n. React doesn't swallow exceptions, I promise you. Probably promises are getting you. See http://blog.taylormcgann.com/2014/08/21/catch-errors-javascript-promise-chains/.\nRelated issue reports: #2626, #2912, #4199, #2665, #4368.\n. Seems fixed.\n. The issue is that $.getJSON does an indirect eval via JSONP. Probably.\n. May as well just delete it and set up a redirect? That's what we did for Thinking in React.\n. This is intended \u2013 when the component is unmounted or the ref changes, the old ref gets called with null before it's called with the new value (or the same component instance again). If you store the instance on your component, this effect should be unobservable as long as your component is mounted, but it prevents memory leaks. If you want to do something with c in the ref handler, you should check if it's null.\n. @sebmarkbage \n. B is correct. See also #4433, particularly my reply.\n. Didn't try. (Filing a jest issue as we type.)\n. (Would like to land this to save myself minutes every day, despite my half-joking title.)\n. printf debugging in HasteModuleLoader.\n. k\n. I don't really want to make ReactErrorUtils behave differently with jest\u2026\n. lgtm with the cache key changes.\n. For a second run, \"time npm test\" claims 27.5s before, 17.4s now on my machine.\n. Thanks!\n. We won't take this as-is since setting all of the styles regardless of if they've changed will be bad for perf. It would probably be okay if we do this only in the case that the keys change, though it might be even better to do it only for shorthand properties (though I'm unsure if there's a way to do that without hardcoding them all). Maybe we could do something sneaky like looking for a prefix match.\n. (Could've sworn we had an issue for this but I can't find it.)\n. I was probably thinking of #2013.\n. This almost works, except MockedComponent here doesn't end up with the flag:\nhttps://github.com/facebook/react/blob/2f96d70087494dd1b8e725abc4a0609d3985dbe6/src/renderers/shared/reconciler/tests/ReactMockedComponent-test.js#L53\n@sebmarkbage ideas?\n. Fixed by changing isReactClass to not have an underscore\u2026\nhttps://github.com/facebook/jest/blob/9d726ed478ecff19acc5bf04a2600e559818cfb6/src/lib/moduleMocker.js#L311\n. I thought the whole point (one of the whole points) of 0.14 (0.15 maybe) was that you can use more than one React. \n. Ideas for other things to check? I think this will catch at least 90% of the catastrophic mistakes we could make.\n. Well it was just \"moo\" but we have a lint rule against short invariant messages.\n. It's the semicolon in })}; that you don't want.\n. #1939 is closed so we shouldn't need this any more. If more issues pop up we can address them separately.\n. I fixed this.\n. Does it work equally well if you call _recordWrite(rootNodeID, 'mount', 0, [])? If so, I think that's a little cleaner since you don't need to introduce a separate list to track. If not, this way is okay too.\nI can merge this if you squash your commits.\n. I agree that that is pretty noisy. Let's keep it how you have it \u2013 mind squashing your commits into one?\n. Try: git rebase -i upstream/master, then change all but the first line to read \"squash\" instead of \"pick\". After rebasing you'll need to force-push to your fork.\n. Looks like you figured it out.\n. (Thank you!)\n. This is extremely unlikely to be a React issue. If you can reproduce a problem using just React, please file an issue with a repro case that we can run easily.\n. React.isValidElement.\n. Can you update the tutorial repo instead to match the website? There's no reason this needs to be in a callback.\n. Yes, this is a breaking change and you'll need to change your tests to be different, sorry. See 4070c4ca20b1d08a00fe278d561642e87373c09f. detachedCoponent is actually a DOM node now so the test utils can't look into it to find the React component tree any more. This rarely comes up because you'll almost always be testing your own components (it's our job to test that the DOM components work, not yours :)).\n. @benhughes Can you paste a sample test so I can see what you mean?\n. @sheepsteak That sounds like a different warning, but I'm glad you got it to work.\n. I have not tried https://github.com/airbnb/enzyme but it looks promising.\n. @giantelk Want to send a PR to make the docs clearer?\n. We can probably warn if you have a lowercase displayName\u2026\n. @jimbolla That's true. We recommend doing\n```\nvar UserDashboard = ...;\nmodule.exports = UserDashboard;\n```\nthough.\n. Eventually we may be able to support this by letting you implement a custom renderer. It's difficult right now, sorry.\n. > like can you decorate a component with something like react-redux in the middle of the react-art tree\nYes. There is a restriction right now that you can't swap the type of element that a composite returns (ex: making render return <A /> then return <B /> after a state update breaks) but otherwise it works fully.\n\nMore generically, do React, since it separated to multiple implementations, now implements something to allow this use-case more easily or is it still a complex topic? (like some new internal helpers provided?)\n\nStill unsupported, sorry. I have not reviewed it but https://github.com/iamdustan/tiny-react-renderer claims to walk through building your own React rendering backend.\n. I should add: the react-art restriction is only because it embeds a new type inside a DOM tree and React doesn't really have the logic to support that. Standalone environments like DOM, Native, etc. don't have that problem.\n. JSX collapses whitespace which is almost always what you want but is obviously inconvenient in this case (sorry). If you're using an ES6 compiler like Babel (just swap out JSXTransformer.js for https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.min.js and use text/babel instead of text/jsx) then you can use an ES6 template string\n<code>{`\n  +--------+   +-------+    +-------+\n  |        |   + ditaa +    |       |\n  |  Text  |   +-------+    |diagram|\n  |Document|   |!magic!|    |       |\n  |        |   |       |    |       |\n  +---+----+   +-------+    +-------+\n`}</code>\nwhich may be more palatable.\n. @sebmarkbage \n. @trusktr Stack Overflow is also a good choice for questions that have a simple answer, like this one.\n. You can return the element, like you said. renderToString doesn't include the event handlers and there's no real way for us to make that happen. If you give more details maybe I can be more helpful.\n. This is hard to do without support from the markdown engine. You can try using https://github.com/Khan/simple-markdown or https://github.com/spicyj/marked-react.\n. .type on a React element still works. It does not work on React classes. It sounds like you're doing .render(Foo) instead of .render(<Foo />).\n. Okay.\n. Thanks. Dupe of #3659 probably.\n. cc @tako-black \n. It's in fbjs: https://github.com/facebook/fbjs/blob/master/src/core/shallowEqual.js.\n. Thanks!\n. Please read the error message.\n. Try setting global.document and global.window from jsdom before requiring React. This report is similar:\nhttp://stackoverflow.com/questions/26867535/calling-setstate-in-jsdom-based-tests-causing-cannot-render-markup-in-a-worker\n. I'll leave this open until we figure out our longer-term plan for test utils, but we're unlikely to get to this.\n. @jimfb (from #4635)\n. Can you post a small reproducible example in https://react.jsbin.com/ or jsfiddle? I can't help you unless you give more information.\n. It looks like a bug that this is undefined, but after we fix it it'll be the span element which probably isn't what you want. You want e.currentTarget.value to get the button, which already works correctly.\n. Wait, what? e.target is correctly the button or the span in my testing. If you want the button, you do definitely want e.currentTarget.value.\n. Would be nice to get this in 0.14. I don't think it should change behavior if you're using a single React renderer.\n. @sebmarkbage Updated to avoid n^2 loop and removed isRenderedByReact in favor of just using getFirstReactDOM which takes about the same amount of work.\n. This is known. More or less a dupe of #2517.\n. Sure.\n. This is intentional. componentDidMount of a parent gets called after componentDidMount of its children, so you know your children are fully initialized before using them. Likewise, componentWillUnmount is called before children (the reverse of componentDidMount) so that you have a chance to reverse anything that you might have done in componentDidMount.\nFor react-famous, probably an alternate rendering backend is more appropriate, more like react-art or react-canvas or react-native but we don't yet have a good supported way to do that. (Unlike the lifecycle method, that would allow you to do the actual unmounting in the order you prefer.) Your solution of removing the children from the parent sounds pretty reasonable though.\n. Fixed by #4814.\n. Thank you!\n. We'll follow up there.\n. @amasad Will this work? We have \"main\": \"react.js\" in package.json.\n. Thanks.\n. Were we going to have the version on the other files?\n. TestUtils.Simulate only uses React's internal event system; it does not touch the actual DOM at all so it can't use any of the DOM event handlers. I'd be happy to take a pull request improving the docs to make this clearer.\n. Yes, the listeners are at the document level.\n. Why are you using Number objects instead of numbers?\n. I don't think we're going to support this, sorry. You can use <span>{+item.get('unbilled_value')}</span> which hopefully isn't too inconvenient.\n\nNote that there is actually no problem rendering the value, but the warning is raised.\n\nWe usually warn for things that will break in future versions. This particular pattern will break hard in 0.14.\n. Can you give more information about what you mean?\n. What do you mean by \"destroyed\"? All JavaScript objects are garbage collected when there are no more references.\n. Yes, React never reuses an instance after it's been unmounted.\n. Uh, what? Wrong title.\n. \"good news\"\n. #4797 \n. Works on master.\n. Yes, hopefully. Not sure what metrics we'll be able to share but I would like to test it.\n. @zpao But key isn't a prop!\n. String. And iunno.\n. Let's just use https://fb.me/react-devtools and have one message. I'll make it point to the blog post. Think it's worth doing a version check for Firefox?\n. Thank you!\n. This is not a React issue.\n. This is probably fixed on master. If you can still repro this on 0.14.0-beta3, let me know and I'll reopen.\n. @milesj No, sorry. We'll release 0.14 soon (RC this week, probably) but before then you can simply access the DOM node with a ref and set the attribute manually.\n. No harm. (@syranide's pending DOM removeAttribute pull request should change everything to use attributes.)\n. Can you rebase/squash so there's only one commit here?\n. Thanks!\n. Going to go with #4786 which was submitted earlier.\n. The warning and error is already clearer in master.\n. It'll be in 0.14, hopefully out soon.\n. @abritinthebay Can you elaborate more on the sorts of things you like to introspect?\n. FWIW we use https://github.com/reactjs/react-docgen at Facebook.\nWe're not going to build this as part of React but perhaps something like Flow will have optional runtime typechecks eventually which could incorporate some or all of this functionality.\n. wtf hub.\n. I don't really care but I'll update the docblock anyway.\n. @zpao r?\n. Thank you, good catch.\n. @alexeyraspopov It's not in beta3. Please wait for the RC.\n. @alexeyraspopov That landed after beta3 was cut. It'll be in the RC that goes out sometime soon.\n. Changed both.\n. For comparison, Angular's ng-model directive uses input on modern browsers and IE10+ and a combination of the keydown change paste cut events on IE8 and IE9.\nhttps://github.com/angular/angular.js/blob/master/src/ng/directive/input.js#L411-L444\n(Note that they have hasEvent('input') return false in IE9: https://github.com/IgorMinar/angular.js/blob/master/src/ng/sniffer.js#L53-L56.)\n. My gut feeling is that there will be some weird ways of doing input that we won't be able to detect in IE. We can probably get 99% consistency though if we compare the values on each potential event. Where would you suggest that we store the previous value?\n. Yep -- if you remove the input element on keydown then my event still gets triggered with the current code.\nWhat do you think of this?\nif (document.getElementById(abstractTargetID)) {\n  EventPluginHub.enqueueAbstractEvents(abstractEvent);\n  EventPluginHub.processAbstractEventQueue();\n} else {\n  // Don't send the event if the element has been detached\n  AbstractEvent.release(abstractEvent);\n}\nFeels sort of hacky but it seems to work (for the node removal case, at least) and I think it's better than not doing the check.\n. Perhaps onValueChange? (Change seems better than Changed for consistency with existing DOM event naming.)\n. Do we? If you have\n```\n\nhandleValueChange: React.autoBind(function() {\n  var value = this.refs.input.getDOMNode().value;\n  // ...\n}),\n```\nthen the event handler will fail (because this.refs.input is undefined) when the input gets removed from the DOM.\n. @petehunt Yes, sorry \u2013 I'm still trying to get a handle (pun intended?) on how these IDs are assigned and what happens during reconciliation. Perhaps:\nif (nativeEvent.target === document.getElementById(abstractTargetID)) {\n?\n. If we bind to change (which we supposedly need for some events in IE) then that will always get triggered on blur if there's been input so I don't think we can do a pure setTimeout solution. I think there are also events that we want to bind to (looks like selectionchange is necessary for context-menu Delete in IE) that don't trigger until after an update so it seems that we need to store the initial value sometime around DOM insertion.\n. Yes, I guess so. I'm not thrilled about missing non-keydown events but it's at least a decent way to start. If we're going to not forward all the \"input\" events then I'd want to restore the native onInput event forwarding that I had in the first commit for people can rely on modern browsers.\n. Sorry if I was unclear -- happy to just do the keydown + setTimeout handler for the onValueChange (or whatever) synthetic event but onInput should work too in browsers that support it.\n. Okay, I've reverted the latest changeset so the plain onInput can be merged in now.\nGood idea about keyup. (Although, one of the reasons I like using oninput instead of onkeyup in general is that it fires on every key press when you hold down a key\u2026)\n. Done, sorry.\n. Done. (I had canUseDOM originally but lost it somewhere along the way.)\n. Without this check, the tests still pass, but this method ends up calling updatePropertyByID with {owner} and children.\n. Oops, this was a copy pasta thing. (Was editing in build/ accidentally then copied it over.)\n. See https://github.com/facebook/react/pull/84/files#r4648120. I guess it's fine to call DOMPropertyOperations.setValueForProperty on invalid attributes and just have them be ignored? I can get rid of this check if you like.\n. Looks like DOMProperty.isStandardName[propKey] || DOMProperty.isCustomAttribute(name).\n. IE9 does weird things with the textarea cursor if you change .textContent (or .value) during a selectionchange event. (It turns out that I didn't actually properly prevent the change with this diff yet; I have a fix locally that I haven't pushed yet.)\n. FWIW, at KA we mostly follow the jQuery style guide which says to always use ===, with the exception of == null: http://contribute.jquery.org/style-guide/js/ (see \"4. Equality\"). I haven't found this confusing at all (though I'm sure it's a little confusing if you're not expecting it).\n. Yep, I have this already in an unpushed changeset.\n. In IE9 if you set the value during a selectionchange event then the cursor jumps to the start of the textarea and attempts to move it (via createTextRange) are ignored. Curiously, doing textarea.select() does select the contents, but changing the selection using createTextRange after calling .select() moves the cursor back to the start.\n. Supposedly setTimeout exists in a web worker, but I just realized that this reference to window will probably fail. Happy to use a polyfill if one exists.\n. Before, receiveProps was skipped and only _receivePropsAndState was called (by setState, etc). My intent here was to catch when this code:\n```\n    var props = this._pendingProps || this.props;\n    this._pendingProps = null;\nvar transaction = ReactComponent.ReactReconcileTransaction.getPooled();\n// `receiveProps` will unset `_hasPendingUpdate`\ntransaction.perform(this.receiveProps, this, props, transaction);\nReactComponent.ReactReconcileTransaction.release(transaction);\n\n```\nuses this.props because there aren't any pending props.\n. Yes, replaceProps and friends are called only by user code and ReactMount._updateRootComponent.\n. Okay, will clear the pending setTimeout after adding @benjamn's polyfill.\nNot really related to this discussion, but having ajax support in React might be nice -- right now that's the only thing I've really been using jQuery for and it would be nice to not need any other libs.\n. Oops, you're right. I meant to add the callback always but perhaps not to mark _hasPendingUpdate if MOUNTING or RECEIVING_PROPS.\n. Assuming React(Composite)Component continues to manage _pendingProps and _pendingState, I think this can only work if ReactUpdates is aware of where the parent/child relationships lie or else it's not possible to easily determine when an update can be skipped due to a parent having been rerendered.\nI'm actually unsure of how to find parent/child relationships when given a few ReactComponents -- ReactInstanceHandles doesn't help since there might not be separate DOM nodes.\nLet me know if that comment made sense, not 100% sure I understand what I just wrote.\n. What fits in an animation frame? (How do you tell when running whether to keep going?)\nI was under the impression that it's \"okay\" to take a long time in rAF but you'll skip a frame. The alternative presumably would be to split state updates into two callbacks, but my gut feeling is that that would look worse because the UI won't update atomically and it won't really be updating any faster, just maybe pretending.\n. Not sure how you mean. The purpose of the while loop here is to immediately catch any newly-enqueued updates in the current tick rather than waiting for the rAF callback.\n. Sure, I don't usually optimize my own code to the extent of worrying about individual allocations so I'll take your word for it that it's better to keep the array around.\n. Sure.\n. I guess so. If we sort the array so that parent components get updated first (which we should do if that's practical) then it won't have the same behavior but I'll switch to the simpler loop for now.\n. Actually, I don't think we can share the array because any callbacks enqueued during these updates need to go into a separate array so we don't run them right here.\n. :+1: \n. I did a quick perf test earlier and it looked like updateTextContentByID was faster. I'll check again.\n. Do you mean, get rid of the named vars?\n. fixed.\n. I might expect a function called this to remove previous siblings too\u2026\n. lgtm but I would do this.props.defaultValue != null ? this.props.defaultValue : '' for consistency with other parts in this file.\n. Done, sorry. Still haven't figured out exactly what your indentation rules are. :)\n. The proper fix for this is probably to move {owner} out of props -- its presence is sometimes confusing already, especially when implementing shouldComponentUpdate.\n. Oops, I totally misread this function. Sorry, will put it back (and add a test!).\n. I just copied ReactDOMInput here.\n. Obviously the old code here differs from textarea already, but perhaps this was intentional so that false becomes ''; generally in React you can write flag && <Component /> where nothing is inserted if flag is false so here perhaps we want to support <input value={flag && val} /> here too.\n. Make this heading bigger? Right now it looks like it's under JSX.\n. Oh, I guess so. Never mind!\n. \"30-minute presentation\" (or \"30 minute presentation\", but not \"minutes\")\n. Did it for consistency with containersByReactRootID -- plural sounded better to my ear but I can switch both to singular if you prefer.\n. @zpao and I decided on IRC to stick with the plural; I just rebased.\n. Just switched to that and rebased.\n. Yes, defaultValue was giving warnings.\n. Right, I figured that the constructor will allocate the same object so it doesn't make a difference.\n. Thanks, fixed.\nP.S. #252? ;)\n. Done. I even went back and ran grunt lint to be extra sure on this one after I screwed up the other branch but I guess that didn't help. :)\n. I think this is a bug in recast -- calling this.remove() on the alternate ends up removing the entire if statement because removeRequests is looked at only in visitArray which is called on each BlockStatement but since no new block is created, the request is processed at the next level up and the entire if statement is removed.\n. Done.\n. True. I seem to remember this getting changed somewhere but this is what master says right now.\n. (I didn't change this.)\n. I'm not sure the if makes sense at all -- if jsxScripts is empty then you're just loading JSXTransformer.js unnecessarily which should be avoided anyway.\n. The worker loads react.js; I first tried to make it use react-test but the populist loader isn't designed to run in a web worker right now.\n. I guess that's fine since lint checks for uses of global.\n. Naming suggestions? ;)\n. Done.\n. (Updating already checked isCustomAttribute, I just made deleting do it too.)\n. Done.\n. Done.\n. Right, perhaps we can fix it. I think the best way here when in a web worker may be to just run importScripts which (synchronously) loads a list of scripts so that document isn't referenced at all.\n. The old docstring was similarly discongruous; it said \"An HTML object with the __html property.\" but had the fallback. Happy to remove it if {__html: null} is unsupported (which seems reasonable to me).\nBy the way, should that regex be /^ +/g and should it be extracted out of this function so it can be compiled once?\n. Oops, I totally misread that and imagined that it was stripping the spaces. Never mind on the +. :)\n. These were alphabetical before\u2026\n. It's a controlled component with no onChange handler\u2026 (note I'm changing the actual value, not the value prop).\n. Yeah, the input event triggers the onChange handler in ReactDOMInput which sets value on state to the current node value giraffe, causing a rerender after which componentDidUpdate sets node.value to match props.value. Something not working for you?\n. nit: most new JS development\n. you probably also want to change next on 08 to point to addons.\n. Fixed.\n. nit: you can just write #484848 here.\n. Probably :hover is the same as *:hover?\n. Maybe we should specifically use the phrase \"server-side rendering\" here?\n. No strong feelings, I was expecting someone to want to change the generic path earlier than now. Can we not just use a relative path here though? I think I'm actually just missing context on the purpose of this PR.\n. well you don't want to write the full path every time\u2026\n. How about, \"two-way binding\"?\n. Not going to encourage calling it cx? If we do it here it'll probably catch on\u2026\n. Yeah, React.addons.cx seems silly but var cx = React.addons.classSet; seems sensible!\n. I'd personally be up for cx without any explanation but I don't have a hugely strong opinion here.\n. > But it's the only one that emphasizes building components out of other components above all else.\nThis sounds to me like we're sacrificing other things to make components easier (which I don't think is true?). Maybe:\n\nBut with a focus on composability, React makes it simple to keep each part of your app self-contained.\n\n(also rsquo not apos?)\n. I don't even know what \"traditional data binding\" is.\n. Well, I think it's okay to be super aggressive in claims like this if it's true\u2026 but I'm not sure that the advantage you claim is even concrete enough to understand. What do you think of:\n\"By making it easy to compose components, React let you to make your views more modular, making them easier to maintain.\"\n. Oh, are you trying to say that a declarative render() function is easier than mutating the DOM by hand in response to changes?\n. Yeah, I know what you mean but I don't think it'll be as obvious to most visitors.\n. Yeah, two-space works pretty well because then if you double-indent the condition (which is nice to distinguish it from the code beneath) it lines up with if (.\n. I imagine they should be consistent. The only use currently of createMarkupForProperty is in ReactDOMComponent._createOpenTagMarkup which already checks.\n. You can just do event.which != null, which is a bit shorter than the typeof check (and is what jQuery does, fwiw). Also I think that code would be clearer if the third branch were in an else.\n. nit: no period after the exclamation point.\nI'd personally put this section first as it's more likely to affect the people reading this?\n. I would just skip this altogether.\n. Can you make the value and text not the same?\n. nit: can we say\nTo make an uncontrolled component, use `defaultValue` instead.\n. Yep, thanks -- fixed.\n. style nit: requires should always be alphabetized.\n. I liked the old name better here. :)\n. In the future I'd like listenTo to take the rootNodeID or the component itself so that it might be possible for certain events (in particular, touch events) to bind only on the specific element that needs it. I believe this will make it possible to get rid of initializeTouchEvents without any ill effects due to muted click events.\nThis seems fine for now though.\n. style nit: can you move all of these var declarations to their first use?\n. Also, listenTo takes a contentDocument but you're passing it the container element instead. Did you mean to have a .ownerDocument here?\n. Due to our support for closure compiler's advanced setting, it won't work to do string manipulation on unquoted object keys (which these are) because they won't have the same structure after minification.\nInstead, you'll want to modify SimpleEventPlugin to explicitly list the top-level events which need to be listened to, something along the lines of this:\nvar eventTypes = {\n  blur: {\n    phasedRegistrationNames: {\n      bubbled: keyOf({onBlur: true}),\n      captured: keyOf({onBlurCapture: true})\n    },\n    dependencies: [keyOf({topBlur: null})]\n  },\nHere I'm mixing keys like topBlur with ones like onInput in the dependencies array, but this shouldn't be a problem; simply check topLevelTypes[event] to determine if it's a top-level event. Alternatively, you could create a topLevelDependencies property if you prefer.\n. It's not clear to me when camelCasedEventNameAlt is used, but it too needs to be gotten rid of because we can't rely on string manipulation to work in a useful way.\n. nit: React style is to write this as\njs\ndependencies = (\n  registration.eventTypes[camelCasedEventNameAlt].dependencies\n);\n. style nit: put else on the previous line next to the closing brace.\n. style nit: in addition to joining this to the previous line, there should be a space after if\n. style nit: the second line here should be indented four spaces, so it lines up with the se if( in  } else if ( and is indented two spaces more than the following line\n. might as well keep these on the same line\n. when getting rid of the string manipulation, you'll need to list all out explicitly. sorry! :) you could make a map like\nvar topLevelEventNames = {\n  topDoubleClick: \"dblclick\",\n  // ...\n};\nand then call trapBubbledEvent(topLevelType, topLevelEventNames[topLevelType], mountAt);.\n. paging @jordwalke to make sure these changes to the ReactEventEmitterMixin API are okay. (tl;dr: instead of ReactMount calling ReactEventEmitter.ensureListening once, ReactEventEmitter.listenTo now needs to be called when each event handler is attached.)\n. if you look at ReactMount.ensureListening before, you'll note that the listeners need to be attached separately for each document. (this is so that rendering into iframes can work.) you'll likely need to store some unique identifier per document and have a separate map for each.\n. style nit: this line and the line above should be moved two spaces to the left\n. right now, ViewportMetrics is needed only for mouse and touch events, so it would be cool to only attach these listeners if those events are bound. definitely fine if we do that in another diff though.\n. not sure this test is very helpful. :) I'd just leave it out for now.\n. not 100% sure setEventListeners is really helping you here, might be simpler to just look at the calls lists directly later in the function. or not!\n. does mocking ReactEventEmitter out entirely not work properly now? why not?\n. I just realized that this is probably due to you applying my changeset! if you merge from master then these changes are no longer required because I fixed the test runner.\n. can't tell if topChange will get listened to here, but I guess it does? would be good to list that as a dependency.\nwould also be cool to only listen to the necessary events for the current browser, though that can certainly come later.\n. just dependencies.push(keyOf(...), ...); will work here.\n. none of these plugin tests seem particularly useful in their current state -- I'd just skip them for now.\n. Actually, all of the dependencies can be top-level events for now I think.\n. This feels dangerous enough to me that it may be worth using a real JS parser (or lexer) since you don't want to change the word \"require\" if it appears in a string or as an object key.\n'DOMProperty: Cannot use muffin using both attribute and property: %s'\n. maybe _lib or internal is a better name for now? /me shrugs.\n. (this isn't quite true; would be development not dev but you're actually checking !== 'production' anyway.)\n. Might want to include a link to the React site here as I believe this is what shows up on npmjs.org.\n. I think this will also change foo.require into foo.muffin, which is probably not what we want? Not sure how requirejs, etc. look for require identifiers though; maybe they'd be confused by foo.require too?.\n. (packagers)\n. I think this can just be isNaN(value), no need for +. also you probably want +value <= 0, no?\nstyle nit: this line is indented too much.\nI think this would be clearer if you have a boolean shouldRemove variable up here and then switch on attribute/property below. in particular, you can combine the hasSideEffects logic for properties.\n. actually, is there a reason to not just have this call deleteValueForProperty directly?\n. not sure it's necessary to leave these comments -- we can move stuff over from the failing matrix when they pass\n. nit: trailing comma\n. what's the third argument here?\n. what's the default? why set the other intervals differently?\n. You may also want to benchmark just storing this as children always. The original motivation was to avoid the array allocation but if you're going to always have it it might not make sense to bother with the unwrapping.\n. wow, arrow functions are so pretty.\n. Ahh right, forgot about composite components looking at children.\n. In my original PR comment: \"Now we'll be in trouble if someone tries to share objects between calls to getDefaultProps but that was already true of getInitialState and I haven't heard any complaints there.\"\nBut we can copy if that's a problem?\n. Ahh, you're right.\n. fixed\n. Instead of adding this to the repo .gitignore, you can make your own that isn't committed. You can either make a global .gitignore file for all repos or edit .git/info/exclude in this repo if you only want to ignore .idea within the react dir: https://help.github.com/articles/ignoring-files\n. why the cast to a string? if it's because 0 is falsey, probably best to just check mountAt._reactTopListenersID == null.\n. did you mean {}?\n. for consistency, can you do delete document._reactTopListenersID;? (it seems unlikely to happen, this would make a difference if the tests were minified with closure advanced)\n. delete document._reactTopListenersID; here too.\n. Having to do all these deletes is unfortunate. Why weren't they necessary with the old _reactIsListening?\n. domEventMapping is a bit of a misnomer here -- this is actually a map from registrationName to eventName. also you're not recording the registration names for capture events, unless I'm misunderstanding something. what I'd do here is rename EventPluginRegistry.registrationNames to registrationNameModules and rename domEventMapping to registrationNameEventNames or something like that. your code will also be cleaner if you modify publishEventForPlugin to take PluginModule and eventName and have publishRegistrationName take PluginModule, eventName, registrationName and add the mapping there instead of directly in recomputePluginOrdering.\n. I don't think domEventMapping is quite the right thing to use here. instead, just make topEventMapping a map like {topClick: 'click'} and use that. this is essentially what the old code did (wrote out the mapping explicitly).\n. I'm thinking that maybe it makes sense to randomize this key to ensure that different copies of React don't conflict. this should also solve your test problem requiring the deletion of document._reactTopListenersID on every test. something like\nvar topListenersIDKey = \"_reactTopListenersID\" + String(Math.random()).slice(2);\nwhich is essentially what jQuery does for a similar problem: https://github.com/jquery/jquery/blob/master/src/core.js#L193-L194\n. registrationNameEventNameMapping is kind of long, maybe just registrationNameEventNames?\n. React style is to do\ntrapBubbledEvent(\n  topLevelTypes.topWheel,\n  'DOMMouseScroll',\n  mountAt\n);\n. this totally fits on one line :)\n. not sure what the right style here is. (@zpao?) probably best to just break into two separate statements (var module = ...).\n. just realized that instead of writing these all out you should be able to derive them programmatically from topLevelEventsToDispatchConfig. something like:\nfor (var topLevelType in topLevelEventsToDispatchConfig) {\n   eventTypes[topLevelEventsToDispatchConfig[topLevelType]].dependencies = [topLevelType];\n}\nin the top level of SimpleEventPlugin.\n. I'd feel a little better with this as _reactListenersID instead of just _react.\n. Oops, should just be\ntopLevelEventsToDispatchConfig[topLevelType].dependencies = [topLevelType];\ntopLevelEventsToDispatchConfig really does give everything you need! it's a shame to write everything out twice.\n. Just updated, sorry for being silly.\n. Ahh damn it.\n. 80 char lines? ;)\n. if you import topLevelTypes you could also just do\ndependencies: [\n  topLevelTypes.topBlur,\n  ...\n]\n. Mind adding a comment that this is for OG <meta> tags?\n. not exactly new. :)\n. the \"450% slower\" might worry people\u2026 we should investigate and explain why it's slower.\n. Looks like you have an unbalanced paren here.\n. Er, now you have an extra closing paren? :) The message for removing looks okay.\n. (fixed in #722.)\n. Could you show the erroneous line too? People often seem to get confused by line numbers when using inline script blocks (because lines count from the start of the script, not from the top of the file).\n. No, I meant literally showing the problematic line of the file. (code.split('\\n')[e.lineNumber] or something, maybe off by one, maybe also something needs to be done with \\r.)\n. As I said in my original message, people tend to get confused when using inline script blocks, because the line numbers won't match the file. Firefox and Chrome won't show the right line either in these cases.\n. If you have an HTML page like:\nhtml\n  1 <!DOCTYPE html>\n  2 <html>\n  3 <head><title>monkey</title></head>\n  4 <body>\n  5     <script src=\"JSXTransformer.js\"></script>\n  6     <script type=\"text/jsx\">\n  7     /** @jsx React.DOM */\n  8     var link = <a href={} />;\n  9     </script>\n 10 </body>\n 11 </html>\nthen esprima will report an error on line 2 of the script, but that's line 8 of the original file. Since it's seemingly impractical to report the real line number, the next best alternative is to show the message along with the problematic line of code, along the lines of:\n```\nUncaught Error: Parse Error: Line 2: XJS attributes must only be assigned a non-empty expression\n  at test.html, line 2\nvar link = <a href={} />;\n                    ^\n\n. because I didn't know about it!\n. (I put it in the commit message already.)\n. Looks the same as before since there's an extra bottom margin on the last `p` now.\n.\n'[' + JSON.stringify(name) + ']'\n```\nwould make me feel a bit better. hyphens seem a bit weird to support though.\n. Fixed, thanks.\n. Thought I got all of those, thanks.\n. Will .key be '' ever here? \n. In that case, your ending return '' doesn't make sense to me. But perhaps that's never reached? If not, I'd just do invariant(false); there.\n. you need an error message. :) probably just invariant(false, \"Unexpected keyboard event type %s.\", event.type); will do.\n. these keys need to be quoted for closure compiler compatibility.\n. I'd make index the outer variable (the argument to handleClick) and i the inner one. Looks good otherwise.\n. Well, it's not quite true that they're not allowed. If you wanted to make a custom component that took props called class and for, you could.\n. Can you alphabetize these? Also please wrap to 80 chars.\n. resort this list?\n. Done, thanks.\n. I think it's important to indicate where we'd talk to the server. Perhaps add an addComment method to CommentsService?\n. Sorry, can you also use it here? It can just do a this.data.push(comment).\n. Sorry, yes. Essentially, putting back the tutorial19.js section which you deleted but still replacing $.ajax with just the reference to CommentsService.\n. Come to think of it, it may be good to put a setTimeout and callback in addComment to simulate network latency so we can talk about the optimistic updates again.\n. I suppose so -- it'll be a bit more code. What's the motivation? (Do you find this unclear?)\n. Sure, we can do that.\n. If you're mutating the data, shouldComponentUpdate is helpless. I think we should disallow null and tell people to use forceUpdate() if they ask. (Or setState({}) if for some reason shouldComponentUpdate needs to be called.)\n. nit: period.\n. why not just invariant(typeof partialState === 'object' && partialState != null)?\n. Fixed.\n. Oops, I meant to change the other one. I can make a separate module if you prefer.\n. (Could also make a getEventView module used here and there.)\n. I don't think the warning made it into 0.8.0.\n. not parentNode.insertBefore?\n. looks like combination is misspelled here.\n. know if [0] is any faster than .length?\n. Can you just do if (this.state.code !== nextState.code)?\n. Since keypress is deprecated, not sure it's worth worrying too much about what key is for it.\n. I believe this old regex test was more necessary when we were using the id attribute; whether this function returns anything is used by ReactMount.registerContainer in places to test if a React component is mounted into a container. Shouldn't be a big problem, just wanted to call it out explicitly. Maybe best to make sure this function returns null if the ID doesn't start with a dot.\n. If things ever break, this would be easier to debug (and at least for me, to understand!) if it were written as\njs\nvar match = (/^\\.\\$(.+)\\.0$/).exec(childName);\nexpect(match).not.toBeNull();\nreturn match[1];\nObviously no worse than before though.\n. Might simplify your code to have traverseAllChildren call traverseAllChildrenImpl with nameSoFar of SEPARATOR (and check isOnlyChild = nameSoFar === SEPARATOR here). Might not be that much better though.\n. I think FB style is:\njs\nvar nextName = (\n  nameSoFar +\n  (nameSoFar ? SUBSEPARATOR : SEPARATOR) +\n  getComponentKey(child, i)\n);\n. I thought the mozilla prefix was Moz? also probably opera. no idea about ms.\n. maybe just:\nNote that for performance reasons `propTypes` is only checked in development mode.\n?\n. warning isn't accessible from outside of the React code, so it's probably better to keep the if and just do a console.warn.\n. Do you mind changing this to [JSX](/react/docs/jsx-in-depth.html) for consistency with our other links?\n. My bad. At KA we use double quotes so I get mixed up when switching.\nMy guess is users of other browsers would find that annoying.\n. In the case of dangerouslySetInnerHTML it's a string. I can get rid of that and make it an array always if you prefer.\n. It's important that if method throws, then its exception is bubbled up rather than the one from closeAll. Similarly, the first exception from initializeAll or closeAll should be the one thrown.\n. Yeah, the errors are significantly more confusing if the closeAll error bubbles up. I wasted a few hours debugging something because I'd removed the catches locally and did the wrong thing.\n. (See #975!)\n. (@sebmarkbage Just checking in on this.)\n. I'm not sure what this sentence means.\n. Do you also want to skip this setSelection call for a disabled input? I'd expect so.\n. Can you focus a readonly element? Worth checking.\n. What happens? Nothing?\n. Either way, I guess. Perhaps just have hasSelectionCapabilities check disabled too.\n. lool. what use case did you add this for?\n. I don't care.\n. Are we worried that this will transform to React.DOM.null and that won't work in IE8? I feel like this will read to confusing errors for some people.\n. Maybe:\n\nThis is called after the callback function that was passed to componentWillEnter is called.\n. Honestly, this is very confusing so I'd try not documenting it for now. If people ask questions that this will solve then we can try to explain it better then. Until then, I think having it listed here will confuse more people than it'll help.\n. Vendor\n. http://jsperf.com/clear-dom-node/6 suggests that this is faster.\n. Sure, done.\n. Copy pasta, now removed.\n. Sure, done.\n. (add lineClamp)\n. Fixed, thanks.\n. Oops, no.\n. In master this doesn't actually attach the component to the DOM.\n. > All functions except for renderIntoDocument() work without a browser DOM.\n\nThis sounds a little misleading to me. You can't render a component without the DOM, meaning you can't using find, scry, or Simulate either.\n. I think our usual capitalization scheme would be domNode here but you could also just call it node.\n. (keep this alphabetized?)\n. Tests here could be a little stronger -- check tagName twice?\n. This is so React.renderComponent(null, el) works? Seems like an odd case.\n. Added under bug fixes.\n. IIRC you can just write grunt test here and node will set the path properly.\n. I'm not sure the \"both of which are fully TodoMVC-compliant\" really adds much here.\n. react-art overrides it: https://github.com/facebook/react-art/blob/master/src/ReactART.js#L147-L158. I should update the comment though.\n. can you put the comma on the previous line?\n. If you have it here you don't need it in receiveComponent.\n. You can't rely on traverseContext being an object holding the children. In ReactChildren.mapChildren, traverseContext is a MapBookKeeping object.\n. Times's\n. The best approach may be to put the logic in flattenChildren, though there you only have the full key, not the parts. (Also your code here is wrong because you want to be checking for nameSoFar + (nameSoFar ? SUBSEPARATOR : SEPARATOR) + key, not just key.)\n. (A bug that no one noticed before.)\n. I suppose so. #1225 \n. Maybe '[' + JSON.stringify(nameObject.name) + ']' here?\n. These parens are unnecessary?\n. Do you want a\ninvariant(childNode.previousSibling === beforeNode);\nhere?\n. Perhaps it makes sense to just move this to componentDidMount.\n. missing a {\n. Can you make sure that this passes in all browsers? You can run grunt test --debug then go to http://127.0.0.1:9999/test/ to run the tests. (Because of #1314 some of the Immutable tests may be failing already, but you can ignore those.)\n. (If it isn't consistent, I'm not super concerned and I think we could probably drop this test.)\n. You mean modifying an existing noscript gives problems in IE8? If so, you could cache the rendered HTML in componentWillMount, store it in state, and just use that on subsequent renders.\n. For consistency with our handling for other DOM properties, this should be value != null ? value : ''.\n. Similarly, value != null here.\n. Does it make sense to have canBeMinimized in conjunction with hasPositiveValue? If not, maybe add up 1 or 0 for each flag and make sure it's at most 1 so we don't need n^2 invariants here.\n. I don't think this comment is clear to someone who doesn't already know what's going on.\n. Not sure. I'm not convinced that mentioning it is necessary, but if you do maybe it's best to just provide a concrete example. We don't really use statics in our code so I don't have good examples.\n. Do you mean you can access descriptor.type.myMethod?\n. Yeah, they're only available on the class itself.\n. Google Closure Compiler in advanced mode does.\n. <3 quasis\n. I think some people do like React.renderComponent(<div>...</div>, ...) in which case this is a little painful, but this does seem better than nothing.\n. maybe displayNameInfo? shrug.\n. Done.\n. Since this isn't a great landing page, maybe link to the docs homepage or the github repo instead?\n. If you indent these three lines by two spaces, it'll appear inside the list item. It looked a tiny bit funky so I just committed ed0ef16 which makes it look mostly normal.\n. nit: add a colon or period?\n. since the other list items are multiple sentences, add a period here too for consistency?\n. a cursory Google search makes it look like \"Microsoft.NET\" should have a space?\n. s/I/we/ maybe?\n. nit: OS X or Mac OS X\n. Now I'm having trouble making sense of what I meant but I'm happy if you understand. :)\n. docstring wrong here\n. Yeah, I guess let's just have protection against the case that childNode somehow comes after index already, which will cause an infinite loop the way you have it written.\n(Side note: I found beforeNode to be a confusing name; I interpreted it as \"insert childNode before beforeNode\", not \"beforeNode should appear before childNode\". Not sure what would be clearer though.)\n. I think beforeIndex has the same naming problem.\n. Maybe moveChildBefore and referenceElement (or referenceNode).\n. Let's not actually change this one, as it's for perf testing where the minified version is going to be significantly better.\n. Thanks, fixed.\n. Good points, fixed.\n. Very little time is spent in this function; everything that was in subfunctions before, still is.\n. maybe clarify extra-much: It should return (not throw) an Error\n. if you move isOverEvent and isOutEvent up, I think this can just be if (isOverEvent || isOutEvent)\n. no trailing comma plz\n. Add a comment explaining why?\n. https://whereswalden.com/2011/03/06/javascript-change-in-firefox-5-not-4-and-in-other-browsers-regular-expressions-cant-be-called-like-functions/\nhttps://bugs.webkit.org/show_bug.cgi?id=28285\nNot sure how to translate the webkit bug into browser versions.\n. Yeah.\n. Good idea, done.\n. For what it's worth, I agree with @yungsters here that the string-or-object-with-a-useable-method pattern is pretty weird.\nAlso, any check involving window should be guarded in a ExecutionEnvironment.canUseDOM check.\n. Sounds like a good plan to me.\n. our the\n. (fixed in f1096c6)\n. might not?\n. 95% sure yes.\n. That wording makes sense but it seems quite strange to me.\n. That's because we don't have anything to put in a finally block. Here _compositeLifeCycleState will be left at RECEIVING_STATE if shouldComponentUpdate throws which is bad.\n. I'd like it to be in the try/finally.\n. Thanks. :)\n. can you add a if (__DEV__ && here?\n. I think this is a little clearer:\n'method returned undefined. Make sure to return true or false.'\n. nit: space after colon\n. space after colon\n. Actually, saying \"MyComponent shouldComponentUpdate() method\" sounds a little awkward to me in terms of wording. Maybe just match this format?\ninvariant(\n        typeof this.state === 'object' && !Array.isArray(this.state),\n        '%s.getInitialState(): must return an object or null',\n        this.constructor.displayName || 'ReactCompositeComponent'\n      );\n. All warnings are shown only in DEV. The warning() helper checks __DEV__ for you but when using console.warn directly you need to check it by hand.\nSide note: someone else will probably come along and ask you to change this to typeof shouldUpdate === \"undefined\" because in theory you could redefine undefined.\n. Ah, I didn't mean to get rid of the mention of undefined in the message -- sorry! What do you think of:\n(this.constructor.displayName || 'ReactCompositeComponent') +\n'.shouldComponentUpdate(): Returned undefined instead of a ' +\n'boolean value. Make sure to return true or false.'\n(And FB style guide says single quotes.)\nOtherwise I think this looks great now. Do you mind squashing your commits into one (using git rebase -i)? You'll need to force-push to your branch but GitHub will update the PR automatically. After that I'll let @zpao double-check and merge.\n. Either way; usually I just amend and push unless the incremental changeset is particularly useful to look at on its own.\n. Fine with me; I was feeling uncreative. :)\n. I meant that the if statement should be unnecessary; just delete bankForRegistrationName[id]; should work.\n. Renamed to didPutListener and willDeleteListener.\n. Yeah, but the only caller (ReactDOMComponent) only calls if it's a valid name that was in prevProps (and so was presumably put already).\n. I can get rid of the TODO or the if statement if you want. (All the tests pass with the check removed.)\n. Fixed.\n. This is actually a list of tags, not attributes -- so patternUnits shouldn't need to be here.\n. nit: no spaces within brackets, please\n. nit: semicolon is unnecessary here\n. Oops, can you update this comment too?\n. Sure, that sounds good.\n. nit: can you move this above the super call?\n. fix this comment?\n. Updated the diagram, though I'm not sure it's exactly what you wanted. To be honest, I am not sure exactly what the diagram is trying to demonstrate.\n. Good idea, done.\n. As far as I can tell, yes.\n. The original comment, \"Components that are mounted and receiving new state are guarded against additional state changes.\", corroborates this story.\n. Agree, ES6 classes will make this feel a lot nicer.\n. Sure, done.\n. Fixed.\n. I'm okay with attach. I was thinking of resolve in terms of promises. Maybe attachRef here but ReactRef.resolveRef?\n. Added one.\n. Can't you pass around the result of this.ref(this.innerRef) just as easily? (Or store the instance that you're called with and pass it along to someone else?) I haven't thought about this enough to know whether this will get misused.\n. Switched to attach/detach in both files.\n. I am not quite sure what you mean with your first point. If the referenced component isn't mounted, calling .then() fails (i.e., invokes the second callback).\nMaybe we should support an array of refs? cloneWithProps could use accumulate. Presumably transferPropsTo would work the same way.\n. No idea, this is what art checks and it seems to work fine in IE9, at least. (@sebmarkbage?)\n. We try to be compatible with Google Closure Compiler advanced mode, which crushes object keys. (So spec.mixins becomes spec.zb or something like that.) In order to make sure that the key we're checking here is the same as the crushed version, you should do\nvar MIXINS_KEY = keyOf({mixins: null});\nat the top of the file and then use MIXINS_KEY here instead of 'mixins' directly.\n. This is over 80 chars. If you do it('chains ... then you save a bit but you might still need to be creative to squish it a bit more. \n. Not sure you need propTypes or statics here?\n. (On this line it's fine to write .mixins because it'll get crushed -- it's only when using it as a string explicitly that you need to use the constant.)\n. (spec.mixins too!)\n. Oops, fixed. We have really got to get linting properly working here\u2026\n. (ClojureScript with a capital S)\n. I believe these should stay as strings for closure compiler advanced-mode compatibility.\n. I think this is clearer left as nativeEvent.\n. nit: no space after function\n. I believe FB already has a module for this called camelize \u2013 perhaps @chenglou or someone can sync it out?\n. (2014)\n. No need to update the changelog here; we'll do it when we do a release (and organize it in a way that hopefully makes more sense than the individual commit bullets points).\n. We've been trying to keep React compatible with CSP restrictions preventing eval. Can we do global || window || self or something?\n. Right, that would be a good place to put it. Pete already had a version here:\nhttps://github.com/facebook/react/pull/1434/files#diff-61\n. Can you instead set this to null like for defaultValue? Deleting properties causes slowdowns sometimes.\n. Why check propValue != null? If propValue is null or undefined, neither of the other two conditions will pass, right?\n. Ahh yes, you're right. Sorry, this looks good to me. One small thing: can you wrap the line like this so it fits in 80 chars?\n*        if (propValue != null && typeof propValue !== 'string' &&\n *            !(propValue instanceof URI)) {\nThanks!\n. I think this is supposed to be 4-10,13.\n. Maybe just 'Expected a callback function, got ', since the name forEachFunc doesn't mean anything to the caller? \n. can you move this into the beforeEach like the React and ReactChildren requires?\n. FB style is:\n}).toThrow(\n      'Invariant Violation: Expected `forEachFunc` to be a function, ' +\n      'got undefined.'\n    );\n. I believe we normally try to require everything except mocks inside the beforeEach, but perhaps @zpao can shed more light.\n. ah, one more thing (sorry!): can you actually write ReactChildren.forEach: Expected ... to give people a clue where to look even without the stack trace?\n. ReactChildren is fine and matches a lot of our other invariant messages (like in ReactMount).\n. @zpao No, the point is that if you accidentally pass the callback as the first argument (and forget to pass this.props.children), it now errors instead of silently failing.\n. (Perhaps the name of the test could be clearer.)\n. (nit: do you mind adding a comma after <p>?)\n. one more tiny nit: can you move the space between \"parent.\" and \"Try\" to the previous line for consistency with the other line breaks?\n. I don't understand this sentence.\n. > Things seem to work fine if we just use filename.js instead of path/to/filename.js\nThis sounds to me like \"I want to use just filename.js but I can't\". I guess it seems obvious enough to me that having the path is better if it works \u2013 will anyone see .pathname.substr(1) and ask, \"why isn't that just the filename?\"? At any rate, maybe:\n\nWe could use just the filename, but hopefully using the full path will prevent potential issues where the same filename exists in multiple directories.\n. Did you check if these inline scripts work fine?\n. (I still want to get rid of the docblock for non-FB stuff and just use the .jsx extension and transform always if type=\"text/jsx\"\u2026)\n. (I am not a huge fan generally of non-homogeneous arrays\u2026)\n. maybe include either a or b in the new object to show how it gets overwritten?\n. move this comment above the hasAttribute line?\n. This is sort of opaque \u2013 can we instead have the object be content: null, error: false and run if script.content != null and skip if script.error?\n. I was imagining that it's loaded if content != null or if error, but you could also store loaded (maybe instead of error)?\n. double quotes for use strict\n. can we call updateFunc with undefined instead of deleteFunc?\n\ndocstring would be clearer as \"Compare two objects, calling deleteFunc for each key in prevObj missing from nextObj and updateFunc for each key with a different value in nextObj.\", assuming that's correct.\n. this isn't really dom-specific, right?\n. the old code had nextProp = here too; does it matter?\n. Any reason not to include it now and just not promote it? The transform for spread inside JSX tags is there already.\n. I'd like to.\n. No, but this is one obvious case where it should work. The fact that this test should pass is more obvious than if I made my own random function and set properties on it.\n. Yeah.\n. I thought of it and figured that might be slower.\n. This is correct as-is, but keyProp ? !!nativeEvent[keyProp] : false might be clearer.\n. nit: comma splice; should be ;\n. defaultValue is probably always a string here, right?\n. (unminified build only)\n. (This logic is wrong but is right in #1908/#1758/#1759 now.)\n. doesn't not\n. Does the gemspec get bundled into the gem or does it just run and upload the settings? Seems weird to reference package.json like this to me.\n. aha!\n\nFeel free to use dynamic code in here. When your gem is built, Rubygems will run that code and create a static representation. This means it\u2019s fine to pull your gem\u2019s version or other shared details out of your library itself. Do not, however, use other libraries or dependencies.\nhttp://yehudakatz.com/2010/04/02/using-gemspecs-as-intended/\n. this should really be a warning since it's dev-only.\n. What file does dev-only invariants?\n. This was correct before.\n. maybe add \"instead of logging directly\"\n. correctly case sensitive?\n. Mention that 0.10 dev build warns about everything that breaks here?\n. No, setState in componentWillMount always has and still does affect the initial render.\n. JSXTransformer? this is okay too.\n. Sorry, I was complaining that it wasn't a sentence but I guess the other bullets aren't consistently sentences either\u2026\n. element?\n. excited\n. are stripped?\n. maybe just do var mapping = {}; and then\n\nfunction(child, key) { if (child != null) mapping[key] = child; }\nif that works?\n. add the issue number?\n. I don't know what this means.\n. Do you mean, \"If mutable objects\"?\n. we're killing these from open source sometime riight?\n. nit: apply(this, arguments)?\n. maybe warn only once per method?\n. I thought @sebmarkbage wanted to avoid saying \"descriptor\" in the docs?\n. Changed to lowercase for consistency.\n. will be? ;)\n. won't bother what?\n. is this supposed to be {}?\n. I think we want to do this check regardless? like if I do\nvar style = {background: 'red'};\nReact.render(<div style={style} />, el);\nstyle.background = 'green';\n// no rerender with `style`\nReact.render(<div style={{background: 'green'}} />, el);\nthen we probably currently update to green correctly but will not in the future when we stop cloning.\n. (any reason for two underscores instead of one?)\n. Just leave this alone \u2013 docs are built from the 0.11-stable branch and we just won't cherry-pick this in.\n. Instead of removing this completely now, we should make a release where this still works but it gives a warning (in __DEV__) using console.warn \u2013 if you search around you should see other examples of this. It's also good to add a monitorCodeUse call which does nothing in the open-source build by default but makes a log internally at Facebook (and theoretically outside as well for sophisticated clients \u2013 I've been meaning to set it up at KA but haven't had a chance yet).\nAfter people have had a chance to upgrade, we can drop it completely.\n. the indentation here looks messed up?\n. nit: can we say \"e.stopPropagation() or e.preventDefault(), as appropriate.\"? usually people only need one and I'd like to encourage them to use the correct one instead of both like a sledgehammer. :)\n. one more tweak (sorry): let's say \"is deprecated and will be ignored in a future release.\"\n. FWIW we already have these in the code:\nmonitorCodeUse('react_object_map_children');\nmonitorCodeUse('react_no_scroll_event');\nI guess the call stack isn't particularly useful though in this case.\n. What does this comment mean?\n. nit: \"ECMAScript 6\", not \"ECMAScript6\"\n. (when do and don't you need an AppDispatcher?)\n. typo: browser console\n. If we want to support an API like this, it should be paused to mirror the DOM API \u2013 but this is tricky because when the media reaches the end, it'll stop playing causing the element to get out of sync with the specified prop.\n. I like ES6 as much as the next guy, but we're sticking to \"var\" in our docs for now. ;)\n. nit: no spaces inside {} please\n. FB style is to have no space between function and ()\n. This looks rather slow. Perhaps we can generate XHTML-compatible markup from the start instead.\n. \"\u2026as `stripTypes\" maybe?\n. nit: TypeScript\n. explain what Flow is? lots of people will see this without having heard of it.\nnit: TypeScript\n. Why not just have var warned = false; get captured by the closure here?\n. nit: no spaces within braces\n. nit: this can just all be on one line\n. do we even need to rerender here? if we do, forceUpdate() would make the intention clearer since the state isn't actually changing.\n. (same style comments here)\n. I think @petehunt's plan was that we'd only access the DOM in files in src/browser/ui/ \u2013 but maybe ReactBrowserEventEmitter should be moved there?\n. I need to test though it sounds like @sebmarkbage is moving some stuff around here anyway now that #2287 is in. We decided that tags with - and : are always treated as native tags (i.e., strings) and member expressions (with .) are always JS references, regardless of capitalization.\n. 80 chars?\n. Can we use Object.assign here instead of a manual loop?\n. mergeInto\n. The transform actually throws an error now so I don't think it's so bad; maybe we don't need my script.\n. > because the DOM allows this\nmost browsers do, but IIRC the spec doesn't mandate it\n. s/custom-elements/custom elements/\n. instead of what!\n. none of these bullet points actually mention that you can't use jsx for plain functions or that you need createFactory for non-jsx, so people who don't click through won't see it. add a section with a code example also linking to the blog post?\n. missing period\n. the header says it, but the text doesn't actually say here that transferPropsTo is now deprecated (or that it'll be removed in 0.13, which I think is important to write).\n. is there a detailed changelog in addition to these big bullets?\n. (y)\n. such trailing whitespace lines though.\n. Fine with me.\n. removed in v0.13\n. s/PropsTypes/PropTypes/\n. Maybe? I don't think it's very necessary.\n. well we don't really want to encourage people to leave off keys\u2026 but I can say that. :)\n. done.\n. Can you switch these? I'm making a small effort to consolidate on my benalpert.com address.\n. > undefined deopts v8\nthat's crazy!\n. Presumably the validation doesn't happen at all for iterables? Probably something we should fix.\n. We already have fillOpacity in the list.\n. How about:\n\nThis experimental syntax compiles into an ES6 Object.assign call not yet supported by most browsers, so you will likely need to include [a polyfill] if you want to use it.\n\nThanks for sending in this PR!\n. Why does this throw? All the info online I can find indicate that it silently does the wrong thing.\n. No \u2013 previously, nextChildren would have ReactTextComponent('') and now it has just ''. Null children are already stripped out from flattenChildren.\n. Yeah, it's confusing. I can do that if we pull getElementForNode out of instantiateReactComponent.\n. (My first bare class! Am I doing it right?)\n. Or should I add a toBeEmptyComponent() instead? I don't have a great handle on how this is used.\n. Maybe just do expansion = hasShorthandPropertyBug && ...; to avoid the duplication in style[styleName] = '';? Otherwise looks good to me.\n. This will throw an error if you call it. ;) I'm not particularly concerned because you can grep for isTextComponent easily.\n. Hah, I meant my first bare React component class. I can use class if that's preferred.\n. uhhhhh yeah. good catch.\n. Fixed.\n. Does anyone try to do this? I've never heard of anyone trying to\u2026\n. FB style is to have operators before the line break\n. We probably want to have this as a warning call wrapped in if (__DEV__) \u2013 we're trying to avoid adding calls to invariant() that might slow things down.\n. Instead of \"must be an object with key __html.\", it might be clearer to say, \"must be in the form {__html: ...}.\"?\n. I don't think saying \"look at the docs\" is particularly helpful \u2013 isn't that the natural response to any error you don't understand? Might be nice to provide a direct link to the docs or a gist explaining (fb.me/something) though. (also nit: period at the end of the sentence.)\n. (single quotes please)\n. Weird, I thought the FB linter complained about double quotes.\n. Done.\n. Previously, the construction of this error message threw in __DEV__ if a null element was passed.\n. Is this related?\n. Do you want a displayName here?\n. You're suggesting keeping checkAndWarnForMutatedProps as I have it here but getting rid of all the defineProperty stuff?\n. My bad, sorry.\n. Its :)\n. I'm confused why this is the right check.\n. Never mind, I see how it's assigned in ReactChildReconciler if shouldUpdateReactComponent returns true.\n. Okay, done.\n. === is better than == except sometimes when comparing with null.\n. Actually looks like this and two lines down are both over 80 chars \u2013 can you break them up? Sorry for the back and forth.\n. (Someday we'll get a good linter in open-source that'll tell you these things\u2026)\n. typo in react-prisim\n. > React Rocks recently breached one-hundred listed components, and counting.\n\"breached\" feels like an odd word choice to me \u2013 maybe \"reached\"? Also no comma before \"and\" here, please.\n. https://blog.carousel.com/2014/11/introducing-carousel-for-web-ipad-and-android-tablet/ might be a better link.\n. Not sure if the code gets properly stripped out for the minified build if you don't do if (__DEV__) { ... }.\n. (It does in open-source, not sure for www though.)\n. Sorry, I meant the minifier specifically \u2013 I'm sure the runtime behavior is correct.\n. Sorry, I think I'm still talking past you \u2013 my understanding is that your minifier is smart enough to turn if (0) { foo(); } into nothing but isn't smart enough to turn if (1) { return; } foo(); into nothing.\n. nit: join this line with the previous?\n. Maybe rename this to not key since it's actually the value?\n. Wait jk it's not.\n. This should be a numerical for loop?\n. ;\n. Is state is already set to null here from the constructor?\n. Er\u2026 never mind; the constructor calls getInitialState. This comment seems wrong then.\n. Why stop calling replaceState?\n. Is this.state undefined before this or is it null already? Worth adding a test for?\n. Missing semicolon. Can we make this assertion more specific? Why not just return this from handleClick and verify it's correct?\n. :+1: \n. Is this link broken now?\n. innerHTML not innerHtml\n. I think the NOT is a little extreme given that it's how most people use this attribute anyway \u2013 maybe instead say \"For this reason, we recommend against writing code of the form\"? I'm okay with this as-is too if you feel strongly.\n. nit: (i.e., pass\n. Are you sure? I don't see the change. Still lgtm otherwise though.\n. Add a comment here explaining that this can be null if a React component elsewhere in the tree fatals?\n. Ideas here?\n. This is kind of weird. If we do keep this, maybe it makes more sense to null out the ref before componentWillReceiveProps/shouldComponentUpdate/componentWillUpdate.\n. How so? Isn't componentClass.propTypes dependent on what ReactNativeComponent has injected?\n. Should this use getComponentClassForElement?\n. nit: no space before ? please\n. extra ? here now\n. Can you make this into a %s too?\n. cannot? should not?\n. Just checking \u2013 adding new keys after creating a fragment will silently fail in non-strict mode?\n. Is this change related?\n. Not sure what this test is testing, but perhaps it makes sense to skip the null completely?\n. nit: any reason for inconsistency between this assignment and (in other tests) this:\nfunction frag(obj) {\n  return ReactFragment.create(obj);\n}\n?\n. Sorry, can you explain this change?\n. \"Accessing its properties directly is deprecated and will not work in the next release.\"\nperhaps. fine as-is too.\n. Well the null is implicitly keyed now so it's already changing some but sure.\n. xss?\n. Yeah \u2013 even if that's not likely to be idiomatic code, it's surprising if an odd attribute name results in a security hole. You can see that we already check the tag name when generating markup.\n. Was this a lint error?\n. These arguments look a little mixed up. Shouldn't the format string be the second arg?\n. needs more KaTeX ;)\n. why no parseFloat here?\n. I thought we were claiming\n```\n\nsetState: function(key, e) {\n  var state = {};\n  state[key] = parseFloat(e.target.value);\n  this.setState(state);\n}\n```\nwas more idiomatic? this is okay with me too though.\n. maybe \"internally at Facebook\"\n. Sorry, I meant instead of \"we've been using internally for quite some time\".\n. In non-strict mode, won't this be window? Maybe check this instanceof Constructor instead?\n. Formatting here doesn't quite match our typical code style. Maybe this is closest:\nif (\n      (\n        this._tag === 'listing' ||\n        this._tag === 'pre' ||\n        this._tag === 'textarea'\n      ) && ret.charAt(0) === '\\n'\n    ) {\n. You mean, if bankForRegistrationName[id]? I had that originally but it seemed like willDeleteListener should also be called if you switch from a function to null, which means that EventPluginHub.putListener probably needs to delegate to EventPluginHub.deleteListener if the listener is null\u2026 but the putListener function in ReactDOMComponent also does some enqueueing so now we're having listener deletion happen at a different time depending on whether it's gone completely from props or if it's just falsy\u2026\nIt seemed easier to make ReactDOMComponent call putListener/deleteListener only when an actual listener is present and have EventPluginHub not worry about falsy values.\n. Maybe. I didn't really change this though, just added the TODO. Will probably merge as-is and then maybe add the warning later.\n. curly quotes?\n. curly quotes?\n. I think \"with\" should be lowercase here \u2013 my bad. Otherwise lgtm.\n. @syranide This is the lint error making Travis fail:\nsrc/browser/ui/dom/DOMPropertyOperations.js\n  174:12  error  propName is already defined  no-redeclare\n. Can we add a \"If you intended to update the children of this node, you should instead have the component that rendered the existing children update its state and render the new components instead of calling the top-level React.render to update a subtree.\"\nAlso, s/renderComponent/render/. :)\n. style nit: this should be\nvar containerHasNonRootReactChild =\n  ReactMount.hasNonRootReactChild(container);\nor\nvar containerHasNonRootReactChild = ReactMount.hasNonRootReactChild(\n  container\n);\n(twice in this file)\n. Maybe \"was rendered by React and cannot be unmounted using unmountComponentAtNode.\"? In the case that it's not a root, we could also add a \"Instead, have the parent component update its state and rerender to remove this component.\" or similar.\n. This function looks good, but can you move it to just be a free function at the top of this file? no reason it needs to be on the ReactMount object.\n. can you wrap this in an if (__DEV__)? otherwise lgtm.\n. Let's kill this note completely.\n. missing a space after \"reconciliation\"\n. nit: third-party\n. This actually blows away the test runner UI in debug mode (grunt test --debug, then open http://127.0.0.1:9999/test/). Maybe we can make an iframe to render into and then instead check the tag name of the container instead of for raw equality to document.body?\n. Yeah, the browser mode is a little bit of a hidden feature. We haven't been great at keeping it up, but we may as well try to avoid breaking it more. :)\n. Should we warn when clobbering an existing ref?\n. Do you want to kill the special case for null in createElement in this release so that these are consistent?\n. It's a little weird to me how this warns, but this seems to match the behavior of key warnings on element creation where it warns if any of the object values is an element.\n. Maybe I'm missing something. In createElement, passing a key of null is currently interpreted as no key specified but it warns since you wanted to change that to be interpreted as string 'null' in the future. Here, we already treat key: null as string null. Is that right?\n. Never mind, I guess I killed it in 903db8bd14e0aaa8a2db3527f60102f9341dbd42 and forgot.\n. add these two lines up there ^^ too in the frag() call\n. Can you just copy the text from here? http://facebook.github.io/react/docs/component-api.html#getdomnode\nMaybe worth adding a note there too saying that React.findDOMNode is preferred.\n. (ping)\n. We compile the code down to ES3 before shipping it, so this syntax is fine.\n. In the future, createFragment may be replaced by an API such as\n. Good catch, thanks.\n. with the exception of\n. nit: call the prop something other than prop so we can distinguish these two arguments?\n. Maybe \"type checker \u2026 is invalid\" or \"type specification \u2026 is invalid\"? I could see misinterpreting this to mean that an invalid value was passed.\n. support\n. ;\n. nit: double-counting\n. Any reason this uses findDOMNode but the previous call uses React.findDOMNode?\n. The plan is to deprecate cloneWithProps. We'll probably kill it in the next version or the version after \u2013 if you want to just add a note at the top of the page saying to use cloneElement always, that would probably be best.\n. (You need to check memberExpression.computed here or else you'll catch foo[bar].)\n. Should we be doing this already? My warning didn't work without it.\n. Oh! Okay, will kill.\n. Guess I'll leave it then.\n. (Copied from ReactElementValidator, but changed.)\n. Okay, done.\n. Done.\n. FB style is to have a newline after ( here\n. I figured we'd put ones here by default but REACT_WEBSITE_BRANCH we want to be able to change and have it affect all branches (so if we push new commits to an old -stable branch) so I did it in the web UI.\n. Yeah, that might be better.\n. My guess/understanding is that this gets run from the -stable branch then cherry-picked to master so should work correctly? At least all the .zip files end up on master somehow:\nhttps://github.com/facebook/react/tree/master/docs/downloads\n. Good catch. I'll revert this bit.\n. I wish that's how the linter worked but I don't think it is.\n. This message is so much better though.\n. hmmmmmmmmmmm. maaybe.\n. No, I can move it.\n. True. I don't have a particular preference.\n. Normally we'd just write (mapResult[name] === undefined) \u2013 I assume that's no slower?\n. This was if you did style={null}, right? Not if you rendered null.\n. IE-specific\n. Maybe \"Immutability Helpers\" or \"React.addons.update\" for clarity?\n. Is this supposed to be -alpha?\n. Can you keep this list alphabetized?\n. In the test here, can you assign this.component = <Component /> in render so it gets owner-based context, then make sure there's no context warning? (And that there is a warning if the context doesn't match?)\n. Thanks.\n. childInstance is unused -- grandchildInstance is fine I guess but you could also use React.findDOMNode on the returned component and check the element from that instead of what you did here.\n. Seems like this HAS_NAMESPACE is redundant with the NamespaceProperties dict below -- is that right? If so, better to have only one of them.\n. Would be nice if people didn't need to specify this by hand. I guess you need to when writing svg outside of React though?\n. Based on this table, it sounds like it should be optional:\nhttps://html.spec.whatwg.org/multipage/syntax.html#attributes-2:ascii-case-insensitive-2\nThis example seems to agree:\nhttps://css-tricks.com/svg-use-external-source/\n. If I'm understanding right, the name that you pass to setAttributeNS should actually be just 'actuate' here. When generating the markup, we do want to write xlink:actuate though\u2026\n. { on previous line\n. I'm confused, why does this throw? It looks like validateDangerousAttributeName is called only on initial render.\n. I think I'd feel more comfortable if the validateDangerousAttributeName logic lived inside DOMPropertyOperations -- that way the code generating the HTML strings is the one to do the validation.\n. line break after ( and before )\n. what is INVALID_PROPERTY_ERRORS?\n. Never mind -- looks like this probably throws because there's no INVALID_PROPERTY_ERRORS defined? I prefer including the exception message here so that we make sure the right error is thrown.\n. My mistake.\n. What am I missing? It looks to me like validateDangerousAttributeName isn't called before updateAttributeByID (which seems reasonable \u2013 I'm just confused at how this error happens then).\n. Let's not add xmlnsXlink then.\n. Okay, then this is fine as-is.\n. This overrides getAttributeNamespace each time injectDOMPropertyConfig is called, which means the HTML and SVG configs won't be merged properly. If you assign this in the loop below like the other lookup tables do then it should do the right thing.\n. nit: space after comma here and for all of these\n. (semicolon)\n. Well, they're valid nodes, but so are arrays and fragments. Maybe we could have isScalarNode or something but this is the logic we currently have in traverseAllChildren.\n. Missing paren here. Otherwise looks good to me \u2013 mind squashing your commits?\n. \") not )\" :)\n. target?\n. Ehh, okay.\n. This code is generated by https://github.com/facebook/react/blob/master/npm-react-codemod/transforms/pure-render-mixin.js. If you're going to change these, can you change that source too and make sure the tests pass?\n. Not var React =.\n. Not sure that's true, but fixed.\n. (These were necessary because babel compiles everything in strict mode.)\n. http://benalpert.com/ please\n. Let's skip over booleans and null/undefined too without a warning, so you can do <option>hello{test && ' there'}</option> or similar.\n. Sorry, forgot that React.Children.forEach used traverseAllChildren. I believe c shows up as null in those cases though, so you still need to make a change here? Ideally we can add a unit test for this.\n. These should be in a beforeEach so that the container is reinitialized before each spec.\n. nit: supports number update, so that \"it supports number update\" reads correctly (same for all of these).\nalso, please add a space between , and function\n. This if statement would be clearer with the branches swapped.\n. Can you put the warning in an if (__DEV__) and just skip over object children silently in production mode?\n. Can you put this in alpha order?\n. Can you make sure this skips over null/undefined children without a warning and add a test for that?\n. unused\n. You shouldn't need the boolean check here; forEach should map bools to null for you. Can you try removing this? I think your test will still pass.\n. TIL this exists\n. So these don't get out of sync, want to just replace our uses of require('babel-core') with require('babel') and remove the babel-core dep? Their node API is identical.\n. Sure.\n. http://babeljs.io/docs/usage/api/#require-babel-core-\n. This should be readOnly for React.\n. (instantiateChildren)\n. Can you keep the , null here?\n. This particular warning can easily be fixed by adding a key to the span a few lines up, which is preferable because the warning isn't otherwise related to this test at all.\n. What is this change for?\n. What is this change for?\n. Same here \u2013 you can add a key to the span.\n. Never mind, I see that the key here is significant in the .0. This is fine as-is then.\n. Oh, right. This is good, thanks.\n. I see. Can you change that to\n// If container is null here, we'll throw when _registerComponent is called\nwarning(\n  !container || container.tagName !== 'BODY',\nand leave the test as-is?\n. Can you change this one and squash your commits together? Then I can merge this.\n. There are a bunch of objects right above this using the same pattern.\n. Do you mean\nswitch (this._tag) {\ncase \"input\":\n  ReactDOMInput.mountWrapper(this, props, context);\n  props = ReactDOMInput.getNativeProps(this, props);\n  break;\ncase \"select\":\n  ReactDOMSelect.mountWrapper(this, props, context);\n  props = ReactDOMSelect.getNativeProps(this, props);\n  break;\n}\nor something else? If so, that seems like a lot of boilerplate. All the wrappers should have the same shape so I don't think it's polymorphic in this case?\n. k\n. Why is this necessary?\n. I'd rather just turn off the no trailing commas rule.\n. What was the warning here?\n. We should either change this to var next; below or just turn off this rule everywhere if we don't care.\n. We don't support let internally at FB yet so this can't go in like this.\n. (Why this change?)\n. Instead of disabling this rule, maybe we chould use the void operator on each place that triggers it (which this rule's docs claim doesn't warn). Like void frag[key];.\n. (Why?)\n. For this one, we could just do displayName: 'NamedComponent', inside the class spec and drop the var assignment.\n. Let's do avoid-escape http://eslint.org/docs/rules/quotes.html and then leave things like these as double quotes.\n. Neat, I'm surprised this warns.\n. Did this warn? Why?\n. Maybe we should just keep it on one line and ignore the line length.\n. What was wrong with the old code here?\n. (Can't use const.)\n. Let's just turn this off globally.\n. I don't think you need this?\n. Why the change?\n. Did you mean to delete this?\n. I guess let's keep it as single quotes in the require but use double quotes for the outer string so we don't need the escapes.\n. In this commit can we turn off the rule and not remove all the trailing commas (just to add them again a little later)? Also happy for us to add them everywhere before landing this PR if you'd rather do that.\n. Does (x) => x * 2 work here? If so, let's do that \u2013 but otherwise this is okay.\n. Let's just turn it off globally.\n. :+1: \n. Sure.\n. Ah, I missed the declaration below. :+1: \n. I dunno. I think it would be best if you'd get a lint warning on new lines that are too long but that we could still commit long lines if we wanted to. That's hard to make work with our current setup though.\nI like the line length limit for reading actual code but it doesn't feel useful to me on lines like this.\n. Hm, okay.\n. Ahh, I keep looking above but not below. This is fine then; you could also just inline them.\n. I find it hard to completely convince myself that complete inlining is guaranteed or even desirable in this case (due to ~~branch prediction~~ cache locality in the non-wrapper case), but it seems plausible.\nMaybe a case for macros? I just tried Sweet.js for the first time\u2026\n\n. It does parse the code, though I think it supports ES6 fine (or at least claims to). Pretty sure you can run sweet.js then babel, though of course this would be more tooling and could hinder adoption of things like Flow later.\n. I don't think you need this now?\n. We use container in a bunch of other places which sounds nicer here, I think.\n. Can we keep it in __DEV__ for debugging purposes?\n. The two callers of this function have different warning configs internally (static_upstream/core/createWarning.js) so we can't sync it like this without changing behavior. We should just split this out into two separate warning calls probably \u2013 this code is a little overabstracted.\n. Just inlining it since it's the same for input/textarea/select and we don't have anything else like this anyway.\n. No longer true?\n. https://books.google.com/ngrams/graph?content=addenda%2C+addendums&year_start=1800&year_end=2000&corpus=15&smoothing=3&share=&direct_url=t1%3B%2Caddenda%3B%2Cc0%3B.t1%3B%2Caddendums%3B%2Cc0\n. Wonder if it's better to merge them into one string first. I guess this is better for analyzing later.\n. can you add childOwner: null, here for consistency?\n. nit: {value: 1} like you had in getInitialState\n. @PiPeep I don't understand what you mean.\n. Small preference for calling this linc which is shorter and also what I've had it called in previous projects.\n. (Do you need to update your server?)\n. I have a secret test already in src/isomorphic/classic/element/__tests__/ReactElementValidator-test.js\u2026\n. For whatever reason, this seems to be the standard check for a UMD wrapper:\nhttps://github.com/umdjs/umd/blob/81c95124cbdcb3fce883418ba2882d9cd7d9b2c4/returnExports.js#L21\n. I think the intention is probably to crash if exports exists but module doesn't because the wrapper doesn't know how to deal with that. I'll leave as-is because I think either should work fine and this seems standard.\n. Extra space after || here (grunt lint complained about this).\n. We also need to check the values when iteratorFn === propValue.entries.\n. I know. It's easy to copy/paste this to the jest config but I figured it's better to just have it in one place for now, so I opted for here so Travis gets it.\n. Yeah.\n. Thanks.\n. Done.\n. I think l & ~0x3 is equivalent and much clearer.\n. remove\n. remove\n. Does this cache somehow? Seems to take ~3s on my computer which feels weirdly fast.\n. Can this be node_modules/gulp/bin/gulp.js? I don't have gulp installed globally.\n. Status code handling plz. This failed silently on my machine due to the above. ^\n. React Native, not React-Native\n. GitHub\n. README\n. Hm, this fails lint because of http://eslint.org/docs/rules/no-fallthrough but adding // fall through here doesn't seem to silence it even though it looks like it should. @bgw any ideas?\n. Got it, that worked.\n. Can you assert that \"Foo\" is also in the message?\n. Why instance methods instead of free functions?\n. Got it, okay.\n. https, period at the end of the sentence\n. Let's just do !!spec.autobind here.\n. Oh, you're so right.\n. My mistake, thanks.\n. (#4609)\n. I had != null but we should make sure returning <Foo /> from render when Foo is null/undefined/etc has a good error message, which it wouldn't if we changed only this since it would fail the invalid element check.\n. If the language actually had labeled args, the labels would certainly go before\u2026\n. (.type is always 'textarea'; setting it throws in jsdom.)\n. Guess so.\n. shh it could have been! but yeah, I'll remove the ones that aren't.\n. You can just skip this paragraph.\n. (Or else we'll forget to clean it up and find it again in 2 years.)\n. This name seems confusing now? Just a simple timeout would be fine.\n. Let's just drop the last sentence here \u2013 no one will remember react-tools in a few months anyway.\n. Should we just redirect this to the Babel REPL?\n. Minor behavior change: though ReactChildren.map() still calls the callback with null values, the result of map() omits them, so count(map([1, <two />, null], id)) returns 2 now instead of 3.\n. Yes (well, flattenChildren does; traverseAllChildren doesn't).\n. Yes?\n\n. Yeah, that's true. You can return a collection from your mapper which means we need to refactor the logic in order to prefix those keys correctly\u2026\n. Now that it's its own file, you could just require it\u2026\n. Looks the same. I'm fine with either if you have a preference.\n. Makes it part of the same bullet point.\n. ack\n. Yes, thanks.\n. This refers to the following list (initializeTouchEvents, findAllInRenderedTree). Is that unclear?\n. ack (twice in this file)\n. ack\n. changed \"These\" to \"And these\"\n. nit: 0xeac7 looks more like React ;)\n. Why react.element not ReactElement as we normally style it?\nEdit: I guess before the dot is our npm package name which helps avoid collisions?\n. I guess this is configurable?\n. Sorry:\nI was under the impression that lots of globals aren't configurable and can't be deleted, but maybe that's not true at all. Evidently this one can be, at least.\n. Well Symbol isn't from jsdom, right? Could add an expect(typeof Symbol).toBe('undefined'); right after to be safe.\nAlso: we should probably restore the old Symbol global after this test.\n. That's right. See the next test case \"identifies elements, but not JSON, if Symbols are supported\" which tests this.\n. I think we didn't actually remove it until 0.14 but it is gone now.\n. \u2026what happened to the d?\n. Normally we put the mock calls at the top level \u2013 does that work?\n. Oh, right.\n. Please do so that we're consistent.\n. String() doesn't throw on symbols, '' + does.\n. (Of course you wouldn't get type === 'object' but\u2026)\n. What was wrong with this? Your way gives extra whitespace.\n. Can you instead give a ref to the div and then not use findDOMNode?\n. .every?\n. ahh yes. oops. thank you for catching that.\n. #4977\n. Can we call it \"Refs to Components\" here (and in the sidebar, if that's specified somewhere else)?\n. We're using arrow functions for all our stateless component examples.\n. props not this.props\n. lowercase \"reactive\" (or just don't use the term at all)\n. I don't think this section is very useful (or matches our usual best practices). I think we'd probably be better off dropping it.\n. We should move http://facebook.github.io/react/docs/working-with-the-browser.html#refs-and-finddomnode into this page instead.\n. My bad, I missed that.\n. \n. in in\n. Yeah sure. I was mostly keeping it how it was.\n. This first sentence is inscrutable.\n. Two sentence fragments. I would probably just replace the whole paragraph with just\n\nIn object-oriented programming, all state lives on each object instance and you apply changes incrementally by mutating that state, one piece at a time.\n. This wording is probably a little too harsh. The intention of this is to suggest that you should build an application-specific wrapper that knows when to call unmountComponentAtNode.\n. can we just write \"container\"?\n. I have no idea what this first sentence means.\n. single-page app\n. Web Component\n. nit: can we not have dots before all of these?\n\nnit: checkedLink too?\nnit: might be simpler to put this logic in LinkedValueUtils instead of in each wrapper.\n. Mind fixing this to say componentWillUnmount while you're at it?\n. '' is. Though now I forget why I wrote it this way.  I think it can just be a typeof check.\n. Yeah maybe that should use this.\n. Sure.\n. Not on the root.\n. Yeah. Jekyll turns this into {{.\n. The top-level wrapper is hacky but that's sort of solving a different problem. We need to store this stuff because we need it for updates. I guess for the root case we could trigger updates in a different way that passes this down again.\n. Maybe we should remove these links?\n. This should be onCompositionEnd etc?\n. I did this for consistency with the other HTML generation (it could be capitalized differently). Also the token </script> would make browsers sad if someone tries to put the entire source of React within a script tag. I can do template strings except it doesn't fit on one line anyway\u2026\n. Isn't this part still important?\n. I realized this isn't necessary only at the root. Your way doesn't work if we don't store this here because _nativeParent is also a ReactDOMComponent. We could crawl up the tree every time but that feels more wasteful. Essentially, this is where we store the info that doesn't change within the tree but that we need at every level.\n. I didn't realize this is ReactCompositeComponent. You're right.\n. Could you use the name \"component\" instead? \"Context\" often means something else (http://facebook.github.io/react/docs/context.html).\n. You also need to commit, right?\n. Thanks, fixed.\n. @jimfb recently merged a PR that adds a warning for this case but it only checked the create case, not the update case which we use for createElement. I fixed that so the test for the warning passes with useCreateElement and fixed this test to not warn.\n. The mountWrapper calls in input, select, and textarea should include the listeners property in their _wrapperState to avoid changing the hidden class when the assignment is made. This would also be better just as a free function \u2013 we're trying to get away from OO in the core anyway.\n. I know it's merged. I was hoping that one of you would want to post a PR to fix it but I did it myself in #5213.\n. Okay, updated with documentMode.\n. Works in Chrome.\n. nit: lowercase \"mode\" is how https://developers.google.com/closure/compiler/docs/limitations?hl=en does it\n. nit: Can you write \"ReactElement\" without a space? That's consistent with our prop types message.\n. TIL that space has higher precedence than comma in my brain so I parse this wrong when skimming.\n. I would've just included it, but this is also good.\n. nit: Instead of \"shallowRender\" (which isn't actually spelled like that anywhere) can we just say \"if you are using shallow rendering\"?\n. style nit: Can you break after the equals sign instead of before the dot and indent only two spaces?\n. nit: can we format this as\nvar registrationName =\n      EventPluginRegistry.getPossibleRegistrationName.hasOwnProperty(\n        lowerCasedName\n      ) ?\n      EventPluginRegistry.getPossibleRegistrationName[lowerCasedName] :\n      null;\nwhich is closer to standard FB style.\n. possibleRegistrationNames is a little shorter and aligns better with the naming of the surrounding code \u2013 can we go with that?\n. props.value != null please \u2013 we treat null and undefined the same as omitted props for all DOM components.\n. (Your parens here are actually unnecessary but this is fine too.)\n. Eh, I suppose either would be fine. I merged it already though. :)\n. Do you need Foo at all? Why can't Bar extend React.Component directly?\nAlso, can you use ES6 class syntax here? It's simpler.\n. This error message is difficult to understand. How about:\n%s(...): When calling super() in `%s`, make sure to pass up the same props that your component's constructor was passed.\n. This should use === not shallowEqual for performance (and better semantics, IMO) and this check should be dev-only.\n. nit: slice is easier to understand and you can't mix it up with substring. I hate substr/substring. You can also ignore this.\n. nit: can we change this to react-addon-template or something? I always think it's a real thing.\n. Can you leave the newline after the paren as it was before to match the surrounding code? Also please squash your commits together.\n. boolean not void\n. s/stateless component/functional component/\n. This isn't the right place to air that complaint.\n. I'm fine with either \"stateless functional component\" or \"functional component\". We don't want to say \"stateless component\" because class-based components can be stateless (whereas they are imperative and necessarily have a backing instance; they are not functional so \"functional\" is the distinguishing adjective here).\n. DOMProperty is fine. DOMPropertyOperations shouldn't depend on HTMLDOMPropertyConfig directly.\n. This must use ===, not shallowEqual.\n. Can you break after the = (and indent the second line only 2 spaces) instead?\n. inst.props === undefined is simpler \u2013 but why not do this check in the React.Component constructor instead?\n. Yes, but we still shouldn't make things slower than necessary.\n. Can you add a comment saying that this id is temporary and will be replaced by the server as soon as the server returns a response?\n. Only if the line doesn't fit on 80 chars, but yes.\n. === just checks if they are the same reference; it is less expensive than shallowEqual.\n. Yes, we prefer\nvar componentName =\n        Component.displayName || Component.name || 'Component';\nto\nvar componentName = Component.displayName || Component.name ||\n            'Component';\n(since it doesn't fit all on one line).\n. The point is that the react-dom-server.js package we provide uses this secret key, but you're meant to never type it in your own code.\n. > use cases are not common, and there other ways\nCan you remove the comma?\n\nbower\n\nBower\n. Yeah. (I even mentioned that in my PR description. ;))\n. Does setState work here? If not, can we make it work?\n. Yeah, we should probably do that \u2013 though I don't like making the stack deeper unnecessarily because it hampers debugging, and performance in the case that an exception is thrown is probably not a huge concern. Would be nice if the common path was broken up intelligently though.\n. Previously, the string cast happened before this comparison, so value of 3 and node.value of '3' would not trigger a set. We should keep that.\n. If we keep this, it should be 0x80.\n. Did you mean for this to be above the previous case? I think it works out the same either way, so I guess it doesn't really matter.\n. Weird that these tests you copied don't use JSX. Mind changing the new ones to use JSX?\n. Weird, I would've thought this would fail lint.\n. > I believe that there is currently no allocation for leaves.\nI'm not sure what you mean here? Components that have no children don't use ReactMultiChild at all right now. And reconciling an unchanged child does already allocate in flattenChildren. This does add one more though in the case of no changes.\n. Do you mean that ReactChildReconciler would take some sort of callback to the renderer (or parent) and call it before unmounting? Would it do the same for mounting? I wasn't sure what temporal ordering you envisioned here.\n. Right. ReactDOMComponent (in _updateDOMChildren) only calls into ReactMultiChild (as this.updateChildren) if this.props.children != null.\n. Can you remove these and just reference the components directly? Shouldn't make any practical difference but it's a bit simpler.\n. nit: to match our usual style, can you add a linebreak after ( and indent the next line two spaces? similarly, it should end\n</Parent>,\n  div\n);\n. Perhaps getNativeNode can return some other object, perhaps with the pair of opening and closing nodes? You shouldn't need to change the API of ReactReconciler or ReactMultiChild, I think. It doesn't need to be the actual DOM node. The only things that use the output of getNativeNode are DOMChildrenOperations and replaceNodeWithMarkup I think.\n(Though it would be nice if getNativeNode doesn't have to allocate because it's called on every reconciliation. I was thinking that perhaps we can just return the closing or opening comment here and traverse to find the other one when we need it but if you really do need both, we should at least cache whatever object to be returned on the text component instance so that we don't allocate each time getNativeNode is called.)\n. This seems fine I think.\n. Though it might be nice to avoid appending in the case that DOMLazyTree is in its lazy mode (in IE) since then we'll be reparenting these nodes twice (see the comments in that file explaining if you haven't already). It's not a huge issue because they don't have children but fewer DOM operations is still usually better.\n. Having no text node seems reasonable.\n. @patrickkettner @csuwildcat Here in React, I added a user-agent test that catches all versions of Edge (and IE) because the DOM implementation in Edge is much slower when reparenting large trees than other browsers. That is, to create the structure\n<body>\n  <article>\n    <section>\n      <div></div>\n    </section>\n  </article>\n</body>\nthe operations\nvar article = document.createElement('article');\nvar section = document.createElement('section');\nvar div = document.createElement('div');\nsection.appendChild(div);\narticle.appendChild(section);\nbody.appendChild(article);\nare most natural for us, but we are forced to reorder the operations in Edge to be\nvar article = document.createElement('article');\nvar section = document.createElement('section');\nvar div = document.createElement('div');\nbody.appendChild(article);\narticle.appendChild(section);\nsection.appendChild(div);\nin order to get reasonable performance. See the link in the comment above for more details. This has not shipped in a React release yet. I heard that there is a chance this may be fixed soon in Edge \u2013 obviously I would prefer to not ship a React with this feature test and would much prefer to put an upper bound on the versions of Edge where we use this workaround. Anything I can do to help get this fixed in Edge soon?\n. Hmm this is a behavior change i hadn't anticipated. I was thinking that this PR would be unobservable if you don't have a reset button (or CSS selectors based on the value attribute, etc) but not if this is the behavior. We'll have to think on this probably. Even if this is desirable overall it could break people who expect the other behavior so we need to be cautious.\ncc @zpao \u2013 what do you think? In order to make <input type=\"reset\" /> work reasonably, this PR changes the value attribute whenever defaultValue is set (equivalent to the .defaultValue property), but if there hasn't been any user interaction then doing so also changes the actual value.\n. Haven't thought about this in super detail yet but why not mappedChild.key !== child.key as I suggested in chat?\n. This should definitely not run in prod. This is a pretty weird condition to begin with though. I don't have anything better off the top of my head but it is weird that all getters here will behave differently.\nAlso, this is a behavior change if config.ref is set to undefined (null before, now undefined).\n. space after if\n. space before and after { and }\n. 80 chars\n. Can we have more consistent wording here and in _renderValidatedComponent? (Looks like that one's currently wrong because it says component instead of element.) Maybe:\n\nA valid React element (or null) must be returned. You may have returned undefined, an array or some other invalid object.\n. Should we include the component name?\n. Right, but if we are logging these errors then naming the guard with a string would be helpful. I don't think concatenating is a big deal -- string operations are done lazily anyway.\n. I don't understand. Symbol isn't a valid child?\n. this.getName()?\n. Right, I was describing what is valid as a native child (i.e., in traverseAllChildren). I understand that my language here was imprecise and could be misunderstood.\n. What is target such that it doesn't have a nodeType?\n. I think it is better for the docs (especially in the reference section) to be precise about this if possible.\n. You shouldn't need to explicitly unmount the nodes in unmountComponent here; when we unmount a whole tree we only remove the root node, not every descendant individually. (DOMChildrenOperations would do the removal in the multi-child case.) See ReactDOMComponent.unmountComponent for comparison.\n. That is, I think it's better if DOMChildrenOperations is aware of this comment/text-node structure instead of only removing the closing node.\n. I think line 147 is fine here but (per my comment a couple lines down) we shouldn't need it here except to set to null.\n. Can you add a \n\n// Using Maps as children gives a single warning\nexpect(console.error.calls.length).toBe(1);\nto make sure new warnings don't pop up unexpectedly?\n. What do you think of returning from getNativeNode an two-element array with the [open, close] comments? Then you would have both nodes already and wouldn't need to walk backwards in DOMChildrenOperations. (Let me know if this wouldn't work for some reason \u2013 what you have currently also seems reasonable, albeit a little clunky.)\n. I think you might only need to change getNodeAfter.\n. I think that should be fine.\n. Yeah, I forgot about it too. Ah well.\n. I don't think you can escape stuff (newlines) inside echo reliably cross-platform.\n. Hmm, this might not actually be a bug. Chrome seems to do the same.\n. I am not certain but it didn't seem likely to make a difference. That is, parent.appendChild(newChild) seems to take time proportional to the number of nodes in the newChild subtree, whereas every other browser seems to make it constant time.\n. No need for keyMirror since we're not using the values.\n. Sorry if it was unclear: this is how doc fragments work in all browsers. But we insert things in a different order in IE11 and Edge which is why they exhibit this bug.\n. Yeah, we should run jest tests with enableLazy on. :\\\n. We do (and we've had that warning for a while now so removing it should be easy), but this has the same problem with <textarea defaultValue=\"gorilla\" /> I think.\n. Can we say \"Properties defined\u2026\"? Otherwise I like @gaearon's wording a lot.\n. nit: add trailing period\n. Commit message says you added a shim for isomorphic but I don't see it here.\n. Why here?\n. rm\n. rm\n. I was going commit by commit.\n. Otherwise there's no way to distinguish the copying from what you did AFAIK.\n. I don't think we have a policy on this; either is fine in my book.\n. Any reason not to pass stage as a prop to App?\n. Yeah. :( setState calls enqueueSetState and enqueueCallback which each create a separate batch. That is almost certainly unintended but I left it as-is for now.\n. That is, enqueueCallback marks the component dirty which is harmless when done in conjunction with enqueueSetState but kinda silly when it can get split into a separate batch.\n. We should cast to string here before comparing like we do for value.\n. != null I think; empty string is significant.\n. This loses selection state.\n. Can you explain the bug in words in case jsfiddle disappears?\n. Also link to a Chrome bug report.\n. Is there a reason this needs to go in a separate function rather than just in updateWrapper? (Not actually sure offhand which is preferable, but this seems to be a change.)\n. select needs it in post because it relies on children having reconciled.\n. Although I'm not sure why it can't just happen after recursing and needs to be queued.\n. Can you give them a repro case that doesn't use React? It's courteous to not pull in unnecessary deps.\n. Thanks.\n. Why doesn't this error when we call it?\n. Will people run this interactively and get confused that it's slow?\n. Can we do tree.node.nodeType === 1 && tree.node.nodeName === 'OBJECT' && (tree.node.namespaceURI == null || tree.node.namespaceURI === DOMNamespaces.html)? Otherwise I suppose I'm good with this.\n. Why was this necessary?\n. Wait, did this change make it so it does warn on non-SSR?\n. Adding this devtool I mean.\n. Your grammar here is also a bit off, maybe you a word?\n. It's only relevant for textareas, isn't it?\n. Yes.\n. Based on the patch that fixes it, it sounds like the issue is that setting .checked to its current value doesn't detach it. Maybe we can just do\nnode.checked = !node.checked;\nnode.checked = !node.checked;\nin postMountWrapper with a link to the bug and/or commit?\n. backtick in the wrong place\n. unnecessary parens\n. The issue is that no matter how you might update the children, IE loses cursor position in textareas only. Elements with contenteditable should be handled by our ReactInputSelection wrapper on the transaction. I'd like this logic to be maintained as it was, where the children are always passed down as the same value.\n. Capitalize please.\n. To make this clearer, can you do\nvar value = ...;\nvar initialValue = value;\nif (initialValue == null) {\n  var defaultValue = ...;\n  ...\n  initialValue = defaultValue;\n}\nand then use '' + initialValue below?\n. rm\n. Do you want to assert that node.defaultValue is '1' here too?\n. markup would be clearer than image.\n. wrong comment?\n. Why is this necessary?\n. should keep value, right?\n. Do we have a SSR test where we render with value (not defaultValue)? If not, can you add one?\n. no (unmocked) logs in tests please\n. Can you pick different names for createFiber and createFiber here? It's confusing.\n. These would be clearer if element was a prop.\n. Why did these need to change?\n. Can this start at 1? Since this doesn't reset for each shallow renderer it seems prudent to make all of them have non-0 IDs.\n. Got it, I missed the warning you added.\n. Could you add another devtool in the test that checks the state at an appropriate time? If not or if that's too clunky, I think this seems fine too.\n. I thought the whole point was that we wanted to detach on mount? We originally did the tmp thing and @sebmarkbage said detaching on mount was preferable. This is gross though. We could\u2026 unset name so radio buttons don't get screwed up and then set it back?\n. Oops, this was just for debugging. We can keep it though; it seems useful.\n. I figured we would probably expose both \u2013 though maybe it makes more sense to only expose each platform-specific one. Open to other suggestions on how to set ReactDOMUnknownPropertyDevtool up so that we can listen to both kinds of events though.\n. I think storing element seems reasonable enough, but I believe React Devtools is set up to store its own tree so I'm not actually sure this would help it. Maybe I'm misremembering.\n. Yeah.\n. Yup, done.\n. Note that this only checks the list of tests\n\u2713 it preserves the name of the class for use in error messages\n  \u2713 it throws if no render function is defined\n  \u2713 it renders a simple stateless component with prop\n  \u2713 it renders based on state using initial values in this.props\n  \u2713 it renders based on state using props in the constructor\n  \u2713 it renders based on context in the constructor\n  \u2713 it renders only once when setting state in componentWillMount\n  \u2713 it should throw with non-object in the initial state property\n  \u2713 it should render with null in the initial state property\n  \u2713 it setState through an event handler\n  \u2713 it should not implicitly bind event handlers\n  \u2713 it renders using forceUpdate even when there is no state\n  \u2713 it will call all the normal life cycle methods\n  \u2713 it warns when classic properties are defined on the instance, but does not invoke them.\n  \u2713 it should warn when misspelling shouldComponentUpdate\n  \u2713 it should warn when misspelling componentWillReceiveProps\n  \u2713 it should throw AND warn when trying to access classic APIs\n  \u2713 it supports this.context passed via getChildContext\n  \u2713 it supports classic refs\n  \u2713 it supports drilling through to the DOM using findDOMNode\nwhereas the old one made sure the number of assertions matched. So this is significantly less strict than before.\n. Yeah, I was more worried about npm clients.\n. We should do this unconditionally but set node.defaultValue not node.value. Then the tests pass.\n. That sounds good to me, can you do that?\n. I think we can merge after that's fixed.\n. :( yeah I've gotten this sort of thing a few times. Maybe something about circular references? If it's easy to repro we should file a jest bug.\n. We shouldn't need these other addenda now since the stack should cover it. Can you remove the code for them? We still will want to dedupe the warnings based on owner though as we're currently doing.\n. Instead of changing these to not use JSX, can you just make the tests like I have in other files, replacing the filename and line number with (**)?\n. ReactTestUtils.renderIntoDocument shouldn't affect display names; why does it here?\n. I'm pretty sure this is unrelated to ReactTestUtils.renderIntoDocument; commenting above.\n. This is not a React element; it is an internal React component instance. This is why you got the useless \"in Unknown\" stack frame. I think childInstances[name]._currentElement is pretty close to what you want here, but that will actually not give you a useful stack if childInstances[name] is a text component. This error message could also be misleading if the duplicate keys are on components of different types since you'd only see one of them.\nInstead, I think it probably makes sense to only show the stack to the parent component \u2013 but it is actually going to be a bit complicated to thread that information through. getCurrentStackAddendum always looks at the current owner (hence its name), but during reconciliation here we shouldn't rely on the owner being set. I'm actually surprised that it even is in your test case. Let's add a new function ReactComponentTreeDevtool.getStackAddendum(id) that takes a debug ID and prints the parents of that instance. We'll want to reuse some of the code from getCurrentStackAddendum but nothing about topElement or ReactCurrentOwner.\nYou'll probably want to add a parameter to ReactChildReconciler.instantiateChildren that takes the debug ID of the parent component, then pass that from ReactMultiChild.\n. Again, let's use JSX and do a regex replace to normalize it so we can check equality.\n. Likewise, you'll want to thread through a debug ID for the parent component here. It looks like there are several places that use flattenChildren so let's add a test for each one to make sure that the stack makes it through correctly.\n. suppressContentEditableWarning seems okay, but what is innerHTML here for? and onFocusIn and onFocusOut? I also don't love that the form props are here but I guess it's not terrible.\n. Yeah, this seems fine to me. (I think calling it parentDebugID might be a little clearer, but this is also oaky.)\n. var internalInstance = ReactInstanceMap.get(this);\ninternalInstance._debugID\nshould work. Maybe someday we'll have a public API to get this that anyone could use but for now I think it's okay for us to get the internal instance for this here.\n. It would be nice if this had both the parent component (Anonymous, or \"Unknown\" as we'll know it as in the devtools) and the child (div) here. Is that possible? I guess we would probably have to make getCurrentStackAddendum take both elements as arguments.\n. Nice.\n. nit: \"non\u2013spec compliant\" with an en dash or maybe \"non-spec-compliant\"\n. nit: React DOM\n. Can you simplify this to\nnextProps = nextParentElement.props;\nif (prevParentElement !== nextParentElement) {\n  willReceive = true;\n}\nnow?\n. Update this sentence?\n. Do you mind switching this to use getStackAddendumByID to show the stack? That can be a separate PR if you prefer.\n. Can you please keep these all as toBe and check the full error message so we can be confident the message looks right and that it doesn't change accidentally? There are other examples in tests where we do this with stacks.\n. Don't need \"source\" any more, right?\n. We should at least move this to be in the same place as the is check. Ideally, we wouldn't have this duplicated with ReactDOMComponent but if there's no good place for it I guess we can leave this.\n. nit: don't need a space before the addendum \u2013 can you remove it (from all three)?\n. Can we call this checkPropTypes or something else more descriptive? (I know you don't really like calling the context types prop types.) This name needs to be unique across the whole Facebook codebase.\n. k, done.\n. nit: add a comma after \"twice\" or else it sounds like it's called twice before and twice after\n. This works for me.\n. It might be simpler to just store a reference to currentTimer here instead of leaving them split up.\n. Yes. :) Doubly so because it's dev-only.\n. I think this may be slower (in prod mode). We should avoid passing around object keys as strings whenever possible because engines can't optimize it as well.\n. So in prod mode these would have different behavior, right? :(\n. (Not new, of course.)\n. Oh you fixed this.\n. What are the freezes for? (I guess they were here already too\u2026)\n. Should this check shouldConstruct?\n. Oh, I see. value is an object only if fn is module-pattern-y (like Relay containers currently are).\n. How can fiber.input be set here? It looks like this comes directly from createFiber so it would always be null.\n. Can you help me understand the difference between the input and output types for beginWork? They are Fiber and ?Fiber, but it seems that only the return type makes sense to pass to completeUnitOfWork. If we can't distinguish these at the actual type level, can we add a (dev-only) field in the fiber for its current state and assert what state the unit of work is in? I think that would make this easier to understand.\n. This makes it look like completeUnitOfWork would not get called on yield and coroutine components, but the logs I see suggest that's not true. How do the components complete when this branch is taken?\n. Why not leave it as a list?\n. Is this traversal the final state or will it be replaced with something else?\n. Actually, I initially misinterpreted this and didn't realize this is only the direct children (combining fragments). In that case, does this require that a yield always goes to the nearest coroutine (and there's no way to yield to a coroutine with a differing \"handler tag\" \u2013 there can't even be a host component in between)?\n. Will the yields be memoized separately?\n. It's confusing how the coroutine gets completed twice due to the execution structure and you need this flag. Any plans to improve/simplify this?\n. Should this have a $$typeof? It gets exposed to user code in the coroutine handler.\n. What is this case for?\n. Never mind, I get it now. element.type comes in as object, so fiber is just element.type, and we apply the props to the continuation type.\n. Why change the property names?\n. nit: space around +\nAlso, where'd the Hack comment come from?\n. = CoroutineComponent\n. pretty sure this won't pass\n. I was actually interested in where you got Hack here. :) Is this true?\n. Sure.\n. Let's just add all of scripts here in case we want to add more later.\n. Can we share this list with what's in the gulpfile already?\n. (I don't think you need the invariant here; (${source}); would probably be enough.)\n. @zpao Where in the folder structure do you want to put this info?\n. (By the way, this doesn't need to be called \"React...\"; only our actual runtime modules do because of providesModule. If you look at our other build scripts lots of them are just called \"glob-patterns.js\" or similar.)\n. Can you put this in the other file? It doesn't need to be by itself, especially since it's only called once.\n. I still think this doesn't need to be its own module. This is all the code you need, right?\nvar errorToCode = {};\nfor (var code in codeToError) {\n  errorToCode[codeToError[code]] = code;\n}\n. Instead of having this code at the top level, can you extract this into functions and then just call the entry point at the end of the file? That makes it easier to reuse the code later if we want to use this logic for something else. The I/O can also probably be in a different function than the logic to populate the map.\n. nit: +str is all you need here; I tend to avoid parseInt because rarely do you want the behavior that parseInt('2a') gives 2. You could also use Number(str). Also, Math.max casts to number so you probably don't even need this at all. Maybe all you need is\nvar currentID = Math.max.apply(null, [-1].concat(Object.keys(existingErrorMap)));\nthough the -1 thing is admittedly a little cryptic and your if statement is probably clearer.\n. This complexity probably isn't necessary, especially because in most cases it won't matter since we're just adding one or two new errors (after the initial generation). How about we just .sort() with the full file path? Then you don't need a comparator.\n. This would also be more understandable if it was just in the error extractor file or maybe even inlined in the one place you call it. Jumping between many files makes it harder to understand code.\n. nit: no space needed inside {} (just like we don't put spaces in [1, 2, 3])\n. nit: I think it's idiomatic to just call this path.\n. I also think the separate file here is adding more overhead than it removes.\n. Can we call this scripts/error-codes/extract-errors.js? Then we can put code related to substituting the error codes here too later. And we can leave the codes in scripts/error-codes/codes.json or something.\n. (Just wanted to note that this could catch all sorts of errors, like invalid JSON or permissions errors in addition to the file not existing. We probably want to fail silently for the last case and it would be a little better to let the error be thrown in the other cases \u2013 but it also doesn't matter that much so we can leave this as-is.)\n. I thought these were commented out. :)\n. As discussed in person, let's move this back inline \u2013 but move all the logic in this file into top-level functions and then just call it at the end of the file.\n. Yes, if A renders B renders div, I want the div and that div doesn't have _renderedComponent.\n. codes_js = 'var errorMap = ' + codes_json + ';'\n. Actually, can we inline if (typeof text === 'boolean' || typeof text === 'number')? V8, at least, inlines typeof foo === <string> in the bytecode.\n. I'm not sure we want to assume that every link uses fb.me but I suppose it's true currently and we can always change it later so this is fine for now.\n. You shouldn't need to run a separate match; with the split regex you have the URLs will always be in odd positions and the text in even positions.\n. Is it ever possible that this is already set to a different node?\n. I suggested \"Error Decoder\" and still like that (I think it's cute) but if you prefer this let's just do \"Error Codes\" without the \"React\".\n. Instead of these two paragraphs, can we do:\n\nIn the minified production build of React, we avoid sending down full error messages in order to reduce the number of bytes sent over the wire. We highly recommend using the development build locally when debugging your app since it tracks additional debug info and provides helpful warnings about potential problems in your apps, but if you encounter an exception while using the production build, this page will reassemble the original text of the error.\n. Let's get rid of this hr.\n. Showing the actual code here isn't that useful; let's just drop it. Instead, let's have\n\n<p>The full text of the error you just encountered is:</p>\n. For this, I'm not sure the example is adding much. Can we just do:\n<p>When you encounter an error, you'll receive a link to this page for that specific error and we'll show you the full error text.</p>\n. This only changes the warning behavior, but it would be nice if we could be a little more strict here. Forgetting to export anything from a CommonJS module lands you an empty object here.\n. That's what it looks like to me. @jimfb?\n. Yeah let's do\u2026\nif (node.namespaceURI === DOMNamespaces.svg && !('innerHTML' in node)) {\n  // workaround\n} else {\n  node.innerHTML = html;\n}\nThen I think this looks good if you have done manual testing that reproduces the original issue and confirms this fixes it.\n. Do you know if this actually does anything? I'd guess that .innerHTML lives on the prototype and so this does nothing.\n. Let's just drop the a, b, c, d, e, f here. (Esoteric fact: This actually affects reactProdInvariant.length.) Though you could probably also do code, ...args which might read a little nicer.\n. (Oh, I see invariant does the a, b, c, d, e, f thing. I still think we should change it here.)\n. Can we do:\n\nMinified exception occurred; visit [URL] for the full message or use the non-minified dev environment for full errors and additional helpful warnings.\n\nOr if you think it's important to have the code in their (so people can group their errors better, maybe?) then we could do \"Minified React error #123: visit [URL]...\".\n. Can we do Symbol('dev-expression-with-codes.seen') to make debugging a little easier?\n. Can you use a more descriptive name for .id? Like .prodInvariantIdentifier or similar.\n. Currently, do type and key match whenever nextReusable is set?\n. \"single\"\n. (grammar: \"It always throws.\")\n. Probably okay like this.\n. Is there some dev-only (or test-only, even) assertions we could make to ensure that we're not somehow clobbering over other work and this truly acts like a fresh clone? Without that I feel like we are likely to mess something up.\n. That means that it'll be shared in a global registry and will always give the same Symbol instance when called. I don't think that's necessary; the name is just useful for debugging.\n. Yeah, I meant in this (incomplete) version.\n. I don't believe SVG elements work with an incorrect namespace, and the parser should assign it automatically in most cases.\n. Either would be fine. Namespace works better in jsdom but if you prefer instanceof SVGElement that seems fine too.\n. I guess we actually already fail silently here (unset in the same place as ._instance). So we don't need this check.\n. Yeah, I dunno. Let's go with the fake node and store what appendChild is called with and make sure .outerHTML on that child matches what we expected to add.\n. If this is null, we create a new fiber? How does it get attached?\n. The check is worse now because it forces innerHTML to be computed just to check if it is undefined. That's too slow.\n. This spacing isn't FB style and this would be clearer anyway; can you change it?\nfunction isControlled(props) {\n  var usesChecked = props.type === 'checkbox' || props.type === 'radio';\n  return usesChecked ? props.checked !== undefined : props.value !== undefined;\n}\n. En dash with spaces (which I have here) and em dash with no spaces are both generally considered correct in this context. I've also wanted to write an em dash with spaces in the past but I've rarely, if ever, found style guides that encourage it.\n. @nsfmc Suggestions? @keyanzhang wanted a bit more of the old \"Virtual DOM\" point so might also add something about \"determines what changed and efficiently handles the updates\" or similar\u2026\n. @gaearon The Stack Exchange link you used also mentions \" \u2013 \" as the last bullet point for en dashes and the Wikipedia page it links to uses the same construction multiple times in its prose.\n. Can you reorder so requires come first with a blank line after?\n. !==\n. It still doesn't look like Flow supports this yet, but one day it should be able to give an error about nonexhaustiveness if we remove this \"default\" case and miss a case.\n. If Flow had opaque type aliases and we used them here (which I'd like to do), this wouldn't typecheck. Use ReactPriorityLevel.NoWork instead?\n. \"merge pendingProps and memoizedProps\"?\n. This updates one of the Bar divs so we would have \"bar foo\" displayed? (Or at least the change to \"bar\" would be queued and then later cleared?)\n. I haven't gotten to those yet. :) Could expose a function to do the comparison maybe. Maybe only if we can ensure it gets inlined.\n. Preventing accidental mix-ups of priorities with other numbers (like tags) seems valuable.\n. I'm fine either way for now since Flow doesn't help us currently.\n. I was going to ask how .pendingProps gets set on the alternate but it looks like maybe it's not and you fixed that in 8d58701b? I'll continue reading with that assumption\u2026\n. Why isn't Synchronous the highest and largest number? priorityA <= priorityB sounds to me like B is more important but you have the opposite. Switching it would solve your 0 problem.\n. So this is where the priority gets cleared usually (edit: for the leaf components)? I would have expected it to happen in CompleteWork or something like that. Is there an advantage to putting it here?\n. Non-leaf components get their priority cleared here?\n. This won't ever wrongly lower the queued priority of a node, right?\n. Are these props the same as the DOM props we have now? This lookup might be slow because of all the different shapes. Not sure if that is a concern but everything else I've seen so far looks monomorphic.\n. What is the primary way of resetting priority?\n. I guess this is okay since we will bump the priority of all ancestors when enqueueing an update?\n. I see, it looks like in a future commit you do reset it in BeginWork sorta like I expected.\n. This name reminds me of Objective-C. :)\n. For most tags, can we throw away pendingProps after BeginWork? Is that better for the GC?\n. (Does the suppression comment mean maybe you lose typechecking on parent for the rest of this function? I don't see how Flow could know what type it should be. Maybe const parent : Fiber = workInProgress.parent : $FlowFixMe; would be better?)\n. Does this ever happen? It looks like a logic error to me if this is hit.\n. Why []?\n. Very cool.\n. I was looking and performUnitOfWork is only called with nextUnitOfWork, which always comes from findNextUnitOfWork which only returns things with pendingProps.\nBut I guess it can be null if the reconciliation is interrupted and we perform a hi-pri update while nextUnitOfWork is set, clearing out its pending props? Let me know if I'm misunderstanding something. I don't see how traversing upwards leads to this case.\n. (past?)\n. Why is not returning the root a prerequisite of in-tree containers?\n. Okay, that makes sense. I was confused since you currently are creating the root here.\n. Why does Middle update while Tester does not? They look the same to me.\n. Can you change this to ReactInstanceMap.get(parentComponent)? Only that file should have _reactInternalInstance hardcoded.\n. Technically we should probably queue context here too (_pendingContext or something) but it looks like the difference is probably unobservable right now? So I guess this is fine. Can you add a TODO here though?\n. Would this not have been caught by the code directly above?\n. Why 52? I thought all time was in multiples of 5?\n. Do we need the firstEffect field on every node? It seems like we could make lastEffect point to the root or a placeholder instead of being null and then save a field.\n. Not \"if\", right?\n. Are there cases where we have a state node but no alternate?\n. No, no reason to use the root.\nWhat do you mean, \"Any node can end up being reused and then you need the start of that slice of the list.\"?\n. Does this annotation do anything?\n. Stale.\n. Might be a little easier to read as an early return case before the main logic.\n. This will break the devtools. Sorry.\nhttps://github.com/facebook/react-devtools/blob/96fcb41fea91c3a03219851512e3e305af9fa7f0/backend/getData.js#L74-L78\n. It could be but I prefer parallel structure in my if/else-if cases so I left it like this.\n. For now. There's a bunch of our internal components that rely on it so probably externally too. (FB-only link: https://fburl.com/373836543.)\n. Doesn't really matter since our constructor doesn't return anything.\n. All right.\n. All right.\n. Can we break it out into a blockquote to aid skimming?\n\nthis is why you might have seen this message in production:\n\nError: Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.\n. Let's break out a blockquote here too:\n\n\nNow you'll see an error like this:\n\nMinified React error #109; visit https://facebook.github.io/react/docs/error-decoder.html?invariant=109&args[]=Foo for the full message or use the non-minified dev environment for full errors and additional helpful warnings.\n. Maybe mention how codes keep the bundle size small? Not sure if that's implicit.\n. None yet, sorry.\n. nit: can you make this \"React\" or \"React JS\" with a space?\n. I think warning here seems reasonable. cc @mkonicek\n. this babel-plugin- is killing me\n. Can we do\n\nThe ${locationName} `${propFullName}` is required in ${componentName}, but its value is null.\nand replace the other message with \"\u2026its value is undefined.\"?\nlgtm. Can you send me a diff internally to html/shared/core/createWarning.js adding the new wording so we don't forget?\n. This depends on a later commit. :\\\n. Can you say \"iOS Safari and Android Chrome\" and capitalize the sentence?\n. Can you add 'color'? Broken in Android 4.4.4 browser.\n. It fixes a bug where iOS Safari and Android Chrome do not show the value. The one on line 249 detaches .value from .defaultValue (by default, changing .defaultValue affects .value but they work independently as soon as .value is ever set, including to its existing value).\n. Sorry, do you have a specific question? The correct browser behavior is:\n.value always reflects the current displayed value of a field and what would be used if the form is submitted.\n.defaultValue is always the same as the HTML value attribute (and get/setAttribute 'value'). When a form \"reset\" button is clicked, .value reverts to .defaultValue.\nInitially, they are linked so that changing the value attribute or setting .defaultValue also changes value. Once value changes (either due to .value = or the user interacting), they function independently.\n. See, we definitely should've reversed the priorities.\n. How do we know the first Bar has already completed?\n. Before this fix, the resulting children were \"Hi, World\"?\n. nit: in ReactCompositeComponent we do if (inst.shouldComponentUpdate) which fails on non-functions whereas yours silently ignores them\n. What is the difference between these two if statements? Are they exhaustive? Is it that the second case (starting on this line) is for if a child has already reconciled but its effects haven't been applied?\n. Do we verify this somewhere? What happens if it doesn't?\n. Same question here. How do we know the memoized props are right?\n. Yeah, my concern is that the timings could change such that this test no longer tests the correct thing. If there is a parallel test that covers it then I guess it is okay.\n. Sure, this seems fine then.\n. > Initially I only did this with the cheaper equality check.\nSorry, did what with which cheaper equality check?\n. I meant exhaustive for the updates case I guess. My initial thought would be that current && current.memoizedProps would always be set when doing an update.\nIn this code, how do we distinguish the ping-pong case from other kinds of updates? I am having trouble thinking about this code because I would have probably expected some sort of === check on the props.\n. Actually, can we just delete this test now if we don't have any guarantee that it will continue to test the right thing? I'd rather not have a test that looks like it works but actually doesn't.\n. var\n. Can you remind me why this logic should be so different from the other branch?\n. Yes, that's what I meant by \"internal\".\n. Can you add a semicolon here?\n(@zpao don't we lint for semicolons?)\n. Oh, I didn't realize we had warnings.\n. A little unfortunate that we re-call componentWillUnmount on the component that already failed to unmount.\n. Can you add log.length = 0; before this line so that the next expect is clearer?\n. Call this BrokenUnmount here or GuiltyComponent everywhere for consistency?\n. Could we test that refs/componentDidMount are not called on any of the mounting children but that they are called for the displayed error message?\n. Which were those?\n. Hmm. I didn't think we should hit this on unmounted components. setState should bail out before we get to this point. Is there a test that fails without this?\n. (y)\n. Can we drop these __DEV__ blocks?\n. Hm, when is this._currentElement not set? Not even sure why we have that check.\n. Can you rename it to getRootIDsSlow?\n. Can we do something that's not O(n^2) to unmount n roots? If getRootIDs is only used in tests than the slow implementation you had would be better.\n. Thanks, I agree.\n. If we stored the id as the value then this could be Object.values(rootByKey). I suppose we don't know that's polyfilled though.\n. Can we make a small tweak and do:\n\nReact.Children.toArray() changes keys to preserve the semantics of nested arrays when flattening lists of children. That is, toArray prefixes each key in the returned array so that each element's key is scoped to the input array containing it.\n\nThanks!\n. We don't officially support IE8 any more so I'm not that worried. People can polyfill if they want.\n. It's easier here since we don't want the stack so we don't need to call the Error constructor.\n. Can we call this isValidContainer?\n. createElement('div') please\n. nit: let's do \"another copy of React\"\n. Whitespace between tags on a single line matters, and I believe that's the most common cause of extra whitespace. See \"Foo\" in the test case below.\n. @iamdustan I think that would probably be overly noisy.\n. Yes, this is only used interactively and that's an error case.\n. The code have here is fine for what I use it for.\n. I'll rename it.\n. Surprisingly, it does:\n$ echo 'if (__DEV__ && debugID !== 0) alert(1);' | jsxmin --replace __DEV__:1\nif(debugID!==0)alert(1);\n$ echo 'if (__DEV__ && debugID !== 0) alert(1);' | jsxmin --replace __DEV__:0\n$\n. It's probable that .bind is actually slower than closures but I'm in favor of leaving what's here for now.\n. Not sure why this even uses renderToString. Mind changing it to use ReactDOM.render so that we test the queueing behavior better? (See, I didn't even notice that the old test was testing the wrong thing but now that componentDidMount is completely absent here it's much more obvious. Thanks.)\n. Yes, that's right.\n. prevElement/nextElement should never be undefined here. Can we change the types so that is enforced? ReactElement | null | false or something.\n. In most cases it's fine to just test client rendering since the server codepath is mostly a subset of the client one. \n. Must be outdated. We used to not have onMouseOver/onMouseOut but now we do.\n. rawr. okay.\n. Previously, the exported type seemed to be \"object literal\" and I couldn't index into it with a ReactPropTypeLocations.\n. I don't understand what this change is for. Can you explain?\n. Why did you move this?\n. Never mind, I guess I see.\n. I believe the current behavior of setting the attribute is intentional though I could be misremembering. I know we definitely need to set value on the <progress> element. You can look at the history of ReactDOMInput to see when jimfb last made changes.\n. Note: this is a little sketchy because component might not be a ReactCompositeComponent (and thus wouldn't have _compositeType), but I suppose it is fine.\n. Can this be mixed?\n. I tend to think mixed is a safer default \u2013 either it will work forever or you will notice when you get a type error because it is not specific enough. You will already find new type errors when adding more Flow files that depend on inaccurate/incomplete types in existing files so using mixed isn't that different in this respect.\n. Right, it would. I avoid polymorphic accesses like this whenever possible because they're slower but I'm not sure there's a better option here.\n. component._currentElement is still polymorphic. We'd probably need to pass the component type along with the component instance if we wanted to avoid this.\n. I think this is fine as-is, just wanted to note it.\n. Yeah.\n. return (\n  tag === 'button' || tag === 'input' ||\n  tag === 'select' || tag === 'textarea'\n);\nFB style doesn't do large indents to line up with previous lines \u2013 we just move the previous line down instead.\n. It would be nice if there was an easier way to run against a release build without manually recreating the build folder.\n. Can we swap the conditionals? fn.shouldComponentUpdate is probably slower than workInProgress.memoizedProps. Also, maybe use a crazy name like shouldComponentUpdateForFiberTestingOnly so no one gets confused?\n. > nativeContainerInfo was either null or undefined\nhaha, sounds about right.\n. Maybe we should change reconcileChildrenAtPriority to take this as an argument so we don't need to temporarily set it like this.\n. I don't know what this means (yet?).\n. React Stack does the same for numbers.\n. It looks like this change doesn't do anything currently because reconcileChildFibersInPlace and mountChildFibersInPlace are the same right now. Is that right?\n. Yeah this breaks React ART. We shouldn't release a patch or minor version with this change.\n. I'm probably missing something obvious, but why would it? That doesn't touch ReactART or ReactMultiChild.\n. Oh. I don't think that's terrible if we're confident that there are no bugs. But we should definitely find a way to fix flow errors before v16 since that isn't immediately coming. Maybe we can just remove flow from ReactTestRenderer or add some suppression comments for now if ReactMultiChild needs to be a class like this?\n. Let's do that for now please. Thanks for following up. :)\n. This email doesn't work, right? We don't have MX records on reactjs.org as far as I can tell.\n. Why the change?\n. Works for me\u2026\n\n. 1. If a debug ID for a mounted/mounting component is available, use that and the stack will be generated by the parent hierarchy.\n2. If no debug ID is available (ex: a key/proptypes warning during element creation), we have to rely on the current owner for stack info. We look up the current owner (which is mounted/mounting) and then crawl its parents.\n3. The current owner is generally the parent of what we think of as the \"current\" component/element. So we can also pass the current element (generally the one being constructed) and that gets printed on top.\nI think in my ideal world here, we would display in [unknown] (at file.js:123) when we have the location info (based on the element being constructed \u2013 this code can probably be reordered to call ReactElement.createElement first) and leave that line off and just show the parent if we don't (since in [unknown] is useless and we won't have any better display name since it isn't a string/function type).\n. Can we call it container?\n. Let's be clear that this is React DOM that makes this choice, not JSX or React. Maybe also link to the attribute reference page.\nnit: It isn't true that we use the DOM names in all cases; sometimes we camelcase them where the DOM prop is lowercase.\n. Might be clearer to return here?\n. React DOM\n. We could just do \"If you use Bower, React is available via the react package.\" as the last sentence in the previous section and drop the Bower section. I don't think it deserves it. Side note: not your change, but can we not link to @latest? People will copy-paste and then it will break their code in a year when we release new changes.\n. I'm fine with 15 or 15.3.2.\n. It's a little weird to me that this uses {} since people don't ever do that in practice.\n. Can we do something closer to:\n\nWhen an element type starts with a lowercase letter, it refers to a built-in component like <div> or <span> and results in a string 'div' or 'span' passed to React.createElement. Types that start with a capital letter like <Foo /> compile to React.createElement(Foo) and correspond to a component defined or imported in your JavaScript file.\nWe recommend naming components with a capital letter. If you do have a component that starts with a lowercase letter, assign it to a capitalized variable before using it in JSX.\n\nI don't want to over-pivot on HTML/DOM in the JSX docs.\n. A more realistic example here would be\n```\nconst storyComponents = {\n  photo: ,\n  video: ,\n};\n\n```\nThis is where I most frequently see people actually having problems.\n. Can we use an example where the branches each make a component? Maybe just <strong>even</strong>.\n. In general, we don't recommend using this form because it can be confused with the ES6 object shorthand {autocomplete} which is short for {autocomplete: autocomplete} rather than {autocomplete: true}.\n. Not quite true when two pieces of text adjoin:\n<div>\nHello\nWorld\n</div>\ngives \"Hello World\".\n. more JSX elements as\n. Can we swap these two functions? Easier to understand with ListOfTenThings I think.\n. This is hard to understand. Why not a for loop?\n. It would be helpful to explain why this is useful <div>{showHeader && <Header />}<Content /></div>.\nP.S. true also is ignored. This is not JSX but is React DOM and might not belong here.\n. I know you show it right below, but can we do const e = in every example except when we're specifically discussing what JSX compiles to? It's the recommended way to use createElement.\n. fb style, please\nReactDOM.render(\n  <Hello ... />,\n  document...\n);\n. ditto\n. intentional?\n. Oh. Can we just put a download attribute on the link to this file instead?\n. I meant all of true/false/null being ignored is a React DOM thing, not a JSX thing.\n. fb indentation\n. nit: can we do 'Hello ', this.props.toWorld) so it's a faithful compilation?\n. fb style. (I think this example might also be clearer if it defined a class since ReactDOM.render is comparatively rare.)\n. The format is\nin Button (at DangerButton.js:123)\nIn this case, we would not have the component name because the source would say <Foo /> but Foo is just an empty object {} or something else invalid. If the jsx source babel transform is used then we will have the file/line but otherwise we won't. Theoretically we could make another babel transform that also makes the variable name \"Foo\" introspectable but it would probably be useful for only this warning so it's hard to justify it.\n. Programmer style is usually period outside quotes.\n. \"call\" in the sense you are using it here always takes an object. So \"called its prop something more generic\" could also work. But Andrew's suggestions are clearer.\n. I think it is important to explain that this works (and that it's as efficient as setState \u2013 something people often don't know). But probably best to indicate clearly this is when you're not in a component.\n. Would be neat if we could generate these links automatically somehow\u2026\n. Using State Correctly\n. Should we do () => this.tick() in early examples instead of introducing binding immediately?\n. I think it is important to clarify that merging is shallow but maybe it's best done with an example.\n```\n{\n  currentUser: 'tom',\n  lastMessage: {\n    text: 'Hello friends!',\n    isPending: true,\n  },\n}\n+\n{\n  lastMessage: {\n    text: 'Hello friends!',\n    messageID: 12,\n  },\n}\n```\nor something.\n. Remove the first \"other\", not the second one: \"to any component other than\" (or \"to any component except for\") is clearest.\n. \"Each Clock will\" avoids the weird code-pluralization thing.\n. Let's do something like:\n\nReact provides a declarative API so that you don't have to worry about exactly what changes on every update. This makes writing applications a lot easier but it might not be obvious how this is implemented within React. This article explains the choices we made in React's \"diffing\" algorithm so that component updates are both predictable while being fast enough for high-performance apps.\n\nOtherwise this file looks good, thanks.\n. Can we add a paragraph?\n\nMost people who use React don't use Web Components at all. Unless you are using or creating third-party UI components, Web Components are likely not useful for building an app.\n. Let's just do contentToUse !== '' here (and move the comment you have above down here to explain). No need to check for textarea/placeholder.\n. Sorry, when is this not true?\n. I don't know of any. :)\n. typo\n. Does this mean if you render two host components as a fragment then this method will return the first?\n. Sorta unfortunate if we need to check this every time. @sebmarkbage is there a place we could store this flag on the fiber?\n. line length\n. formatting please:\n\nif (\n  oldProps === null ||\n  (workInProgress.updateQueue && workInProgress.updateQueue.isForced)\n) {\n(Also, may as well pull updateQueue out to a var like before?)\n. or meh, you can leave it if you like the other way. we're inconsistent.\n. textarea\n. Yeah but it requires changing ReactDOMFeatureFlags.js which feels safe on Travis and not as safe if you might have local changes.\n. jest seemingly just delegates to jest-cli but it does have the same exports so (y).\n. That was my intention. I figured it was good to know whether your new test passes in Fiber. Not good?\n. Did this test fail before? Why?\n. Is it better to swap these so that the more restrictive condition comes first?\n. This is RN so I don't think we can right now.\n. Yeah but the module is called ReactDOMFeatureFlags. Want me to do it anyway?\n. Actually I will just change this to make sure it is the same as a ref on the View.\n. copy pasta, will fix\n. Why not leave it in ChangeEventPlugin only for consistency with the non-test env?\n. Ah got it, I was thinking this was SimulateNative. I'm good with this.\n. lint made me do it\n. They all throw now except toMatchSnapshot. Also the matchers don't even come from jasmine any more \u2013 they're from \"jest-matchers\".\n. I was trying to have the test run to completion and record whether all the expectDev assertions pass independent of whether the other assertions in the tests pass. That way we can distinguish \"passing\" from \"passing except dev\" from \"failing\" with a single run.\nYou're right that I'm not testing that warnings don't happen in prod. This is mostly designed for fiber tests where we'll incrementally match dev behavior but can focus on tests that have prod behavior differences, rather than long-term prod testing to make sure we don't warn in prod, but we can probably adapt this infra for that later.\n. We have accumulateInto, forEachAccumulated if you want.\n. Does switching away from dangerouslySetInnerHTML work?\n. why does this fail? sounds like something that should pass\n. Won't updateWrapper fail if inst is unmounted, like if you remove the target node during an event handler? Or does something else prevent restoreControlledState from being called in that case?\n. DOMLazyTree probably needs to stay around in some form\n. Is this on a task list somewhere? If it isn't working properly I know we'll get weird bugs in www.\n. Can we keep this invariant somewhere?\n. Can we do {[key: string]: mixed} instead of Object (which is unsafe)?\n. We should probably change all of these to show the full stack sometime.\n. package managers, the Yarn documentation\n. maybe s/work with/download packages from/? and maybe link to https://www.npmjs.com/ here?\n. don't you want to check the namespace?\n. Can we remove this?\n. maybe, but we never have special-cased logic for particular custom elements so the code was correct as written \u2013 can you add the lowercasing back?\n. weird we don't have a warning if these don't match\n. can you make it Element? even if Element doesn't have onclick, nice to check that the caller is passing in the right type\n. so we are planning to consistently set owner during reconciliation instead of looking things up by internal debug ID?\n. inconsistent with your methods vs. functions :p \n. so we need to thread this through somehow?\n. <3\n. why not getTracker? seems like this would fail on fiber?\n. nit: inconsistent style between value/defaultValue\n. never mind\n. We agreed at lunch that this check is wrong and that we can't currently distinguish when a new child is inserted at the start of a fragment with this strategy. . I wish we didn't need to duplicate all this code.. This would infinitely recurse rather than return null, right?. This was added in ddf53f97f09a652f173bc509b903ead920d92b52 and is just a perf thing. We could probably just delete it.. If this happens, it means that we should throw away the event, right? I don't see that in the code.. Is this equivalent? This code is hard for me to understand.\n`\ndo {\n  bookKeeping.ancestors.push(ancestor);\n  var root = ancestor && findContainerNode(ancestor);\n  ancestor = root && ReactDOMComponentTree.getClosestInstanceFromNode(root);\n} while (ancestor);. nit: \" doesn't need . Mm, I read it as an analog of this check:\nhttps://github.com/facebook/react/blob/9da0bf53f78d06c65274fc039a6cfc3bd9d8b424/src/renderers/shared/fiber/ReactFiberTreeReflection.js#L100. Can you change stack for consistency here?. Pretty sure it does. performTaskWorkUnsafe just runs a loop.. Sorry, I turned off my precommit hook yesterday and forgot to reenable it.. https://github.com/facebook/react/pull/8403. Oh I figured the invariant was useful.. This fails but if restoreStateOfTarget gets the right props (in this case, from the alternate) then it passes.. Need to be really careful when rebasing this onto master. It didn't give any merge conflicts but magically moved this into commitInsertion instead of unmountHostComponents when I rebased locally because I guess the code looks the same.. (Fails flow due to nullability.)\n. Before the updates weren't getting batched so the setState calls had different behavior. The test fails because the props here aren't correct and there is a TODO to fix it:\nhttps://github.com/facebook/react/blob/13cb540bda0a120de87b3cc73230d7b04e0013cc/src/renderers/shared/shared/event/ReactControlledComponent.js#L39\nIt looks like luck that the test passed before.. Weird, I've never seen this. Maybe some test is leaking.. From a skim of the jest source it looks like it should be okay, and if I add a log in the ReactDOMFeatureFlags mock factory in test-framework-setup, then it does log many times when I run a test that resets the registry using REACT_DOM_JEST_USE_FIBER=1.. Just affects the one test because of mucking with process.env. #8451. other's (alternates of each other). I'm having trouble convincing myself why this is true.. In that case, shouldSetTextContent(prevProps) would be true right?. You verified this failed before?. Oh actually, the change here is unneeded since it's already in an if (nextHtml). I'll remove this and just keep your original change.. Lint fails for indentation here. \u00af\\_(\u30c4)_/\u00af . Yeah, let's change this so we have fewer views created.. +1. Even if we don't have owner and source, we still want the name of this fiber, right?. If you annotate the variable declaration as Fiber, can you remove this cast?. It seems like this .return can be wrong (can be the parent's alternate rather than the parent). The type will never differ and the owner rarely will, but the source could. You can imagine something like this:\nif (!isFancy) {\n  return <div>{props.children}</div>;\n}\nreturn <div className={...} ref={...} style={...}>{props.children}</div>;\nIn that case, it would be best if we could show the correct source. Perhaps you could use ReactFiberTreeReflection to find the correct one. If you're not going to tackle this now, can you at least add a TODO?. Thanks, I knew this failed in Fiber but didn't think of doing this.. This should also have the $$typeof check. The logic here feels pretty brittle.. Owner could also be a Stack instance. https://github.com/facebook/react/pull/8458. In the future we should change this warning to include the stack.. Oh you're right, I missed it.. If we wanted to avoid the extra Fiber then Fiber itself could have this logic to call createTextInstance directly. I don't think it would need to live in the renderer.. Don't you always know at the caller whether this is stack or Fiber? If you're using this function still, let's split it up into two.. Can you add a real type here and try to get rid of uses of any?. This is unsound if it ever is the container. Can we at least throw intentionally so it's clearly unimplemented?. Yes, this corresponds to the wrappers in ReactNativeReconcileTransaction and should be a noop.. extra blank line?. inaccurate comment (you don't require it first, you don't require any module with that name even, and requiring it is no longer side-effectful because of the explicit .inject()). yeah we should figure out what we actually want to do here. I think this can land first though.. For now let's commit this as always exporting Stack so we can sync to RN and not bundle Fiber accidentally. You can make a mock for it like src/renderers/dom/mocks/ReactDOM.js and switch on it in scripts/jest/test-framework-setup.js so we get jest tests for it though.. These casts smell funny to me. .create() returns ?Object, while updateView returns Object. Can you figure out if one of them is wrong or if we should call .updateView only conditionally? Same with createView elsewhere.. It sort of is but we read event handlers from the original props now. All the custom logic is in ChangeEventPlugin and restoreControlledState.. I'm not sure if there is a better place, sorry.. +1 from me for replacing with an assertion.. Can this just live in createTextInstance?. fit. What happened here?. Why did this rerender immediately before? I thought this change would only move some setState callbacks earlier.. We should figure out why there was a change before we can make a meaningful decision on that point. We've made other breaking changes for Fiber so we'll need to do a 16 regardless before releasing Fiber (or maybe at the same time).. Why did you choose to split these out rather than adding callback as an argument to scheduleSetState etc? This feels like it's asking for someone to accidentally introduce the problem this PR is fixing.. Can you use normalizeCodeLocInfo like the other tests?. I'd rather remove them. I don't think we've ever described these as public at all. Google doesn't show anyone talking about them. I'll leave it up to you though.. Just keeping what was already there\u2026. :(. This seems gross. If I always set pendingContext instead, this test fails, because hasContextChanged() returns true and we rerender Middle despite element equality:\nhttps://github.com/facebook/react/blob/c79af45f1e1bb9fc0ef9af27b586523832c5f6b8/src/renderers/shared/fiber/tests/ReactIncremental-test.js#L338\nThis is because the root hasn't completed when we do the update and so .pendingContext hasn't been moved to .context yet. (?) I think I'm missing something here.. Is this right? Not sure on this.. How about current.child === null?\nI will also move this above the scheduleTopLevelUpdate because that sounds closer to how it works with non-synchronous priority and if we don't then onUpdateContainer is called before onMountContainer due to the reentrancy (the update is called from the mount and finishes before the mount does). Oh, the alternate works as you suggested.. I can't figure out how to do this. Will let you do it if you want.. @acdlite is going to add a flag for the old behavior which should throw this same error.. I'm fine leaving this as before too \u2013 either way.. Can you make sure null/false works? And we might as well use the old error message:\ninvariant(\n        inst === null ||\n        inst === false ||\n        React.isValidElement(inst),\n        '%s(...): A valid React element (or null) must be returned. You may have ' +\n        'returned undefined, an array or some other invalid object.',\n        Component.displayName || Component.name || 'Component'\n      );. +1, though we don't fail tests on console.error at FB, just in this repo.. Ahh yes sorry.. Occasionally we do that intentionally too if the warning gives a better stack.. Can we console.error once here too?. I'd prefer if we update the tests to assert on the logs, thanks for checking.. Actually, not all our tooling works with ES6 imports yet so we can't. require() works fine for us for now.. (errorBoundaryFound && errorBoundaryName might be a little cleaner if you like). This would need to be escaped in case it includes regex metachars. How about just:\nif (stack.slice(0, errorSummary.length) === errorSummary) {\n  stack = stack.slice(errorSummary.length);\n}\nif (stack.charAt(0) === '\\n') {\n  stack = stack.slice(1);\n}. I think you could also get away with just showing the call stack without any intro line before it.. Yes.. (y) I'm good with this or just \"Call stack:\" then.. We don't need this check any more; it's legacy. You can delete it and the test if you want.. Can you verify the logic here? This means if you call render on a container with existing React children created by another React, we don't warn? I guess that is consistent with before. . Why the change here?. It's allowed to render into an empty element. This test intentionally tests that so your change messes that up.. This isn't a behavior change in your PR, but we shouldn't have any DEV-only exceptions. Can we make this a warning (either here in a new PR)?. Well, we (necessarily) call the iterator twice right? We tried to avoid that before and the code was super super messy.. Me too, let's inline please.. @gaearon: It does; this is a %s param so you can put whatever you want there.. I guess all our functions that take props should probably take type as well since you may well want to have different props per type.. You don't like my original suggestion shouldDeprioritizeChildren?. I'm less worried about those since the source is obviously devtools-related, unlike the name _instancesByReactRootID which I deleted at least once accidentally when I thought it was unused.. Any reason these three are split from the other one?. This should be conditional on whether we are going to do client or server rendering, correct?. nit: can we rename this function or the tests so that \"it renders should render a blank div\" is an actual sentence/phrase?. (I think tagName is guaranteed to be uppercase so this could just be expect(e.tagName).toBe('BR')?). Can we do .match(/\\/__tests__\\//)?. nit: fb style is to have this closing ); on the next line, unindented. These look good to me. (@gaearon, I heard from @trueadm that you advised against any but it seems safe in this case.). I believe this is actually not safe in the case that you use an unminified react-dom.js with react.min.js. Can you check?. It would not have failed before because we check if (purgeUnmountedComponents), etc, each time.. Oh wait I'm looking at the wrong commit.. @gaearon @bvaughn It seems like we do want to check for each function before calling it so that react-dom.js works with react.min.js, unless you don't think that's valuable.. Was there an issue with Promise.resolve?. (This test is probably unnecessary since it's seen the same by React as href: true and I'm sure we'll be careful about compat if we ever change JSX.). TIL!. Hey @acdlite \u2013 this project uses prettier to format all JavaScript code. Mind running yarn prettier and amending the changes to this PR?. This should not use shell escaping; can you change it to one of the methods that lets you pass args as an array?. I find this barely more helpful without the .join but if you like this then we can keep it.. was this meant to be here?. Can you change this to have a single child [<span />] instead?. Not sure if I'm missing something obvious, but how does this test the codepath in question? It seems to me that the simulated touches you have both hit mounted views.. This is actually surprising to me! I thought we collapsed spaces in the JSX transform.. Can you rm this test since you're just testing JSX in this one?. Let's just drop this test (createClass will be gone soon and just outputs a regular JS class anyway).. Is this different from, ex: the ES6 vs Pure test above?. I'm also okay with that, thanks for checking!. Proof it isn't NoContextT.. Flow doesn't know NO_CONTEXT is the only possible inhabitant.. It used to be emptyObject if missing which seems wrong.. This is public-ish renderer API. I'd rather have a test just for this so we don't change it later accidentally.. Fixed.. At the very least, it was inconsistent with our declared type signatures for the host config (but emptyObject isn't typed so).. Do you want to check e.getAttribute('value') too?. I suppose it's not clear to me whether we should try to keep all the warnings in sync between the renderers. It seems not-super-valuable if you always revive on the client side, though I suppose if we want to support server-only rendering then we should have all the warnings there too. In any event, this seems good for now.. I think just .reset() and CSS input[value=foo] selectors. TBH the latter was a pretty common feature request so I'd be sad to see it go.. Yes, please send a follow-up to consolidate these! Would be nice to have 'Browser' or 'DOM' in the name too.. Can we add a 'Doc' somewhere in this name for clarity?. Why did you move these? I think dev should be fine. This package.json is only used for development; we have others for the npm packages that get released.. Does only isomorphic use checkPropTypes like this? I guess I would have thought that context type checking does too.. nit: inconsistent naming with this and warnedForCreateClass. Why does Rollup break? (This seems brittle.). I've been mostly moving away from the \"Check the render method of\" in favor of just showing the component stack.. We have a different ReactChildren test. :). Sloppy editing on my part, I'll fix.. Won't we get terrible merge conflicts soon once everyone has a different base here? :). Do you know why this is a nested object and constructed dynamically? I don't understand the intention of the original source. Maybe worth simplifying.. Do you mind changing this to a toBe to make sure we have the full error message captured? You might need a normalizeCodeLocInfo (copy it from another file) if it contains the file and line.. Why are there two here?. \ud83d\udc4f. typo. more fiber fields \ud83d\ude2d. can you revert this file?. unnecessary?. Let's just move it to that file.. I don't think I fully understand what's happening here. Does this actually check something out? The docs http://www.nodegit.org/api/repository/#mergeBranches make it sound to me like this creates a new merge commit but doesn't change the working copy.\nCan we also change the logic so that we use the merge base of the current commit and master? That is, if the remote has commits newer than what your branch is based on, those should not be included in the comparison \u2013 in most cases we want the two alternatives to be as similar as possible and to differ by just the single commit you are testing.. TBD: add CIs here. Why is this one 15.5.2 and Test Utils has 15.5.1? (Can't tell if either is significant, honestly.). Can we put \"Linear\" or \"Array\" or something in the name to remind people of perf characteristics?. If we're not gonna support this properly (by overwriting the value), can we throw?. Sorry for not catching this earlier \u2013 I believe these need to stay here. In particular, if you do\n<div onLoad={fn}>\n<img />\n</div>\nthen the div should receive the onLoad event (at least, that's what we currently do, whether or not that makes sense) even though the img itself doesn't have a listener. Listening at the div doesn't work since in the DOM, load doesn't bubble. I'm actually surprised we don't have a test for this.\nAny chance you can try to add one (maybe just render that structure, then dispatch a load event to the img node) and then fix this? I think we will just have to leave the old structure unless you have ideas. . Meaning the variance was higher?. Can you keep this after the requires?. This is Fiber-specific maybe.. I'm sure @aickin is thrilled to see this check.. Can we leave these two (and one in ReactCompositeComponent) as hi-pri? They should be relatively rare anyway and are also more important than the others (IMO) since the breakage would be subtle.. Can we keep this logic?\ntry {\n      // --- Welcome to debugging React ---\n      // This error was thrown as a convenience so that you can use this stack\n      // to find the callsite that caused this warning to fire.\n      throw new Error(message);\n    } catch (x) {}\nIt might be helpful to people trying to fix warnings. It may also be worth just keeping the other same checks that we had in the original warning.js.. I guess I can change it.. intentional that this is in parens?. ahhhh yes good catch. sorry I missed that. should say like:\n\nAccessing PropTypes via the main React package is deprecated. In React v16.0, it will be removed completely. Use the \u2026\n\nedit: or dan's wording. Can this be called more than once for a single node? It seems like it would since ensureListeningTo is called on updates. Let me know if I'm missing something.. SimulateNative actually wouldn't cover it because that hooks in right at the top level listener of the event system, whereas I'm claiming that that listener would be called twice. Can you point me to where you're saying the old listener gets removed?. I can't remember us ever removing listeners actually. Might be misremembering.. sooo I'm concerned about this circular dependency (this imports react-dom-factories imports react which is this) -- I think it's okay if we put it in a getter that requires it asynchronously which we'd need anyway in order to warn for it.. ReactDOMFactories. nit: why is this fully expanded while the previous one is in one line? a little easier to compare them if they match style. rm. Maybe you ran prettier over all of this? The quotes here changed. It is not a big deal but would be better to keep the original version in case there are slight semantic differences (closure compiler advanced probably doesn't work properly on this code anyway, but it does treat these differently).. ok ok fine, I wanted to be lazy but I can do that too. I think I need it this way because I need the stack of indices. Since I only need the index if node is one of [anchorNode, focusNode] I could technically do it in constant space but it would be a huge pain. Can we leave it like this?. It's in a describe tho! Not my fault that it doesn't show up nicely in the file. (Okay, yes it is\u2026). This tests deletes and moves (that's why I used keys above).. sorry, my bad -- this shouldn't have \"in\". How about:\n\nrender(...): It looks like the React-rendered content of this container was removed without using React. This is not supported and will cause errors. Instead, call ReactDOM.unmountComponentAtNode to empty a container.\n\nsince it's not likely that it is simple for people to switch to using React to render things \u2013 we just want them to use React to clean things up properly.. this variable doesn't do anything? I think it's fine to deduplicate but also fine not to. (did you mean to render quotes into the string? it doesn't much matter but maybe you just wanted <div>foo</div> here). (indentation). can you assert on the error text here to make sure the right error is thrown? I think passing a string to toThrow will work.. Can we leave the .trim() in the callers as before? You might not want to trim it always.. Can we store invalidFiles in a local var and read it in the catch block instead of throwing a generic exception? It's not great that we'd end up swallowing arbitrary exceptions and/or putting error messages where the filenames would go in the error message printed. (Making a new exception class specifically for this that you check for could also work, but I don't think it's necessary here.). Say, if you wanted to re-output the a command's stdout and that stdout starts with an indent. . (y). I think it would be nice to do /^on[A-Z]/.test(name) here -- that is, only counting properties with a capital letter after \"on\". Then onions={true} is caught. Since this is SSR only I guess it isn't a big deal.\nlgtm otherwise, thanks!. do we need to set NODE_ENV to 'production' too for fbjs to work? (caution that in the past this made the transforms fail for me because the transforms read NODE_ENV and expect it to be 'test'. might need to set it to 'test' and back before/after the babel transform in the jest preprocessor.). Regex shouldn't be that much slower in practice.\n\n. I think Jest has been changed since I wrote this so that instead of defining the two matchers you can just do\nif (console[methodName] !== newMethod && !isSpy(console[methodName]) {\n  throw ...\n}\nif (newMethod.__callCount !== 0) {\n  throw ...\n}\nhere.\nMight be simpler.. Add a comment? :p\n// Make sure console.* wasn't manually overwritten. (spyOn is OK since it'll be torn down automatically.). Yea it's a little subtle. It's \"if a component and its descendants both match, do we return both or just the parent?\" You'd think you'd always want all of them but spreading props is common enough that the pattern is painful otherwise unfortunately.. Can the warnAboutInvalidUpdates above cause an error? . Why don't we want to throw here any more? My suggestion:\n```diff\ndiff --git a/src/renderers/shared/fiber/ReactFiberScheduler.js b/src/renderers/shared/fiber/ReactFiberScheduler.js\n--- a/src/renderers/shared/fiber/ReactFiberScheduler.js\n+++ b/src/renderers/shared/fiber/ReactFiberScheduler.js\n@@ -753,7 +753,7 @@\nfunction handleCommitPhaseErrors() {\n     // This is a special work loop for handling commit phase errors. It's\n-    // similar to the syncrhonous work loop, but does an additional check on\n+    // similar to the synchronous work loop, but does an additional check on\n     // each fiber to see if it's an error boundary with an unhandled error. If\n     // so, it uses a forked version of performUnitOfWork that unmounts the\n     // failed subtree.\n@@ -761,41 +761,40 @@\n     // The loop stops once the children have unmounted and error lifecycles are\n     // called. Then we return to the regular flow.\n\nif (capturedErrors !== null && capturedErrors.size > 0) {\nwhile (nextUnitOfWork !== null) {\nif (hasCapturedError(nextUnitOfWork)) {\n// Use a forked version of performUnitOfWork\nnextUnitOfWork = performFailedUnitOfWork(nextUnitOfWork);\n} else {\nnextUnitOfWork = performUnitOfWork(nextUnitOfWork);\n}\nif (nextUnitOfWork === null) {\ninvariant(\npendingCommit !== null,\n'Should have a pending commit. This error is likely caused by ' +\n'a bug in React. Please file an issue.',\n);\n// We just completed a root. Commit it now.\npriorityContext = TaskPriority;\ncommitAllWork(pendingCommit);\n\npriorityContext = nextPriorityLevel;\n\nif (capturedErrors === null || capturedErrors.size === 0) {\n// There are no more unhandled errors. We can exit this special\n// work loop. If there's still additional work, we'll perform it\n// using one of the normal work loops.\nbreak;\n}\n// The commit phase produced additional errors. Continue working.\ninvariant(\nnextPriorityLevel === TaskPriority,\n'Commit phase errors should be scheduled to recover with task ' +\n'priority. This error is likely caused by a bug in React. ' +\n'Please file an issue.',\n);\n}\nwhile (capturedErrors !== null && capturedErrors.size > 0) {\ninvariant(\nnextUnitOfWork !== null,\n'Expected work to have been scheduled for commit phase error ' +\n'recovery. This error is likely caused by a bug in React. Please ' +\n'file an issue.',\n);\ninvariant(\nnextPriorityLevel === TaskPriority,\n'Commit phase errors should be scheduled to recover with task ' +\n'priority. This error is likely caused by a bug in React. ' +\n'Please file an issue.',\n);\nif (hasCapturedError(nextUnitOfWork)) {\n// Use a forked version of performUnitOfWork\nnextUnitOfWork = performFailedUnitOfWork(nextUnitOfWork);\n} else {\nnextUnitOfWork = performUnitOfWork(nextUnitOfWork);\n}\nif (nextUnitOfWork === null) {\ninvariant(\npendingCommit !== null,\n'Should have a pending commit. This error is likely caused by ' +\n'a bug in React. Please file an issue.',\n);\n// We just completed a root. Commit it now.\npriorityContext = TaskPriority;\ncommitAllWork(pendingCommit);\npriorityContext = nextPriorityLevel;\n       }\n     }\n// There are no more unhandled errors. We can exit this special\n// work loop. If there's still additional work, we'll perform it\n// using one of the normal work loops.\n   }\n\nfunction workLoop(\n```\nseemed clearer about intent to me.. A\n  B {testId: 'foo'}\n    div {testId: 'foo'}\n  section\n    C {testId: 'foo'}\n      span {testId: 'foo'}\nFinding by props {testId: 'foo'} returns B and C if deep is false but returns B, C, div, and span if deep is true.\nAnyway, I didn't write this code \u2013 copy/pasted this bit from the internal prototype of this.. Oh weird. Why? Can amend if that's really intentional.. Should I make this DEV-only? Seems safer to have it be in prod too. :(. This is what I meant. :). Looks like this is still missing in the latest version here, unless I'm missing something?. Sorry, missed this before you put up the PR: You should always trust the scripts you're running. :) This isn't actually the relevant characteristic here I think. (More strictly, it's \"if the scripts you're running trust you\" but I don't think that's clearer.)\nCan this be \"If your server is set up to deliver scripts with the proper headers\" or something like that? . Is this a Chrome bug? Or intentional behavior?. Oh I see it moved down.. Needs to be added to createFiberRoot below to prevent deopting.\n(Maybe we should add a preventExtensions here like we have in createFiber https://github.com/facebook/react/blob/5ee72dcd821e1706a26a24d27feb9bbb9bde3b90/src/renderers/shared/fiber/ReactFiber.js#L205.). Any reason this isn't .delete? Either way.. :+1:. I think EventListener gets shimmed in www?. @gaearon: see https://fburl.com/8jv38orh. nit: replace \"specified\" with \"dispatched\" or \"triggered\" or similar. -rc.1 is a different number of chars than -beta.5 :). Can we keep this and add a link to the Babel repl instead?. We could link to\nhttp://babeljs.io/repl#?babili=false&browsers=&build=&builtIns=false&code_lz=MYGwhgzhAEASCmIQHsCy8pgOb2vAHgC7wB2AJjAErxjCEB0AwsgLYAOyJph0A3gFABIAE6ky8YQAoAlHyEj4hAK7CS0ADxkAlgDcAfAiTI-hABZaI9NsORtLJMC3gBfdQHpt-gNxDn_P_zUtIQAIgDyqPSi5BKS6oYo6Jg40A5OALwARCHwOlokmdBuegA00CzISiSEAHLI4tJeQA&debug=false&circleciRepo=&evaluate=false&lineWrap=false&presets=react&prettier=true&targets=&version=6.26.0. JSX is optional and not required to use React. Try the Babel REPL to see the raw JavaScript code produced by the JSX compilation step.. Can we declare a real type for this function? (hex : string, alpha? : number) => string I think.. actually can we say \"testing the RC\"?. Change link to https://sophiebits.com/ and fix pronouns and other links?. Can you fix the alphabetization here and in AUTHORS?. pronouns. https://sophiebits.com/. I think this basically counts as zeugma. My code is poetry.. no space before the paren please (same for render below). nit: can you also change \"e\" to \"event\" for clarity?. Can we do:\n\nYou can also use the `bind` method to pass arguments to your event handlers, which is particularly useful for knowing which item in a list was clicked.  As shown above, the first argument. This can be just key={i}.. k. No, only null or an actual Node.. After reading this over a few times, I think this is a little too complicated for this section. It's not a common pattern in my experience and also is something that someone familiar with JS functions should be able to figure out themselves if they want. Can we remove it?. please remove the space before the paren here and in render () { . nit: dispatched. Is it the .receiveTouches that you expect to throw? If so, can we move the other calls out? An expect() failure also throws an exception \u2013 so for example, if RCTEventEmitter.register was never called, or the snapshot didn't match, this test would pass. Even better if you can include the full exception message to ensure it's the error you think it is and not a different bug in receiveTouches.. I would expect that you'd need to call publishEventForPlugin in order for the event system to work properly. I guess we might only use the fields that populates (ex: EventPluginRegistry.possibleRegistrationNames) for DOM \u2013 but can we call publishEventForPlugin from this function too to make sure these are (mostly) going through the same paths as before and the same paths as if the event types are available on startup? Mostly in case we change how event registration works later and forget to update this.\n\nIt will validate that you don't supply the same event name twice but since you have the customBubblingEventTypes[topLevelType] == null check it should be OK I think.. is this redundant?. function why?. Not sure if I'm being dense but I don't understand why the reconciler needs to be a special case here. Isn't ReactFiberReconciler's export already the function we want?. Can you put the annotation on the function getOwnerDocumentFromRootContainer's definition? It's necessary to \"cancel out\" the : any cast.. nit: remove. Can we add an assertion on the number of calls for iframeContainer.appendChild here?. Right, we don't need this one any more.. Thanks, fixed.. I think \"could potentially\" is redundant \u2013 just \"could put\"?. Can we clarify that we don't recommend intentional mismatches? . Yes. Also just that it's faster 'cause we rewrote it. This is more interesting to most people than that it uses a different hydration strategy.. Can we just have an opening sentence like:\n\nReact 16 also includes a number of small breaking changes. These only affect uncommon use cases and we don't expect these to break most apps.. Can we say explicitly somewhere that this is particularly useful for implementing modal dialogs, hovercards, and tooltips? Helps understand what it's for. Maybe worth noting the a11y requirements too though so people don't think it's too easy.. Thank you. Will fix in the morning.. I was under the impression that you can't change the type of an input after it's created in at least some versions of IE. Do you mind double checking which to be sure we don't break something?. Thanks! I think this should be OK then.\n\nLong-term I suppose someone could make an IE8-compatible renderer using the react-reconciler package if they wanted to.. I think @nhunzaker is looking at this.. It's always newly constructed in non-persistent mode.. At least, in sync mode it is?. Likely depends on the engine and how it implements hidden class optimizations. In theory it helps provide a better layout for the fields.. nit: pass props to super. Why not 32? (changedBits | 0) === changedBits. Fine that the bit field is \"negative\".. Or we could do a linked list. How deep will these be?. ahh good catch, I noticed this in the original code and forgot to match it.. \ud83d\udc4d . queue and replace were problematic; I moved the rest too for clarity.. isValidElement would return false and the loop would break. returning from the function here is equivalent to continue before, since there's nothing in the loop body after this function call.. @acdlite Is this valid? Or sacrilege? Is there any way I can get the former stack? I assume not because the parent pointers get detached. But I still feel like the stack is probably better than just the component name.. yes it is. because the problematic code practically always lies inside that component. :). > This is an inherent limitation of subscriptions\u2014storing state outside of React's managed state queue and rendering in response to a change event\u2014within React's async rendering model.\nthis sentence doesn't parse right to me. change to \"Incompatibilities with async mode\"? :p . s/, if possible//. Can't call %s on a component before mounting it. This is a no-op, but it likely indicates a bug in your application. Instead, assign to `this.state` directly or define a `state = {};` class property with the desired state.\n^ Maybe? It looks a little wordy.. let inst =?. Do these not overwrite each other if called twice?. lol. brb going to add a function to Number.prototype.render . In short, mouseover and scroll are ones that don't suffer from being debounced and usually don't signify a discrete state update \u2013 in these cases, lagging behind in order to keep things responsive is usually the right call. (Compare to a state update resulting from a click, where the user is likely waiting for a rerender to occur and we want to do that ASAP even if it means making other things stutter.). Couldn't figure out any way to run something once before any tests are run, so I settled for making it think there's just one test.. rm?. Why this way vs what you had before?. Isn't Text > View > Text valid while Text > View > (plain text) isn't?. Wait why? What do you do when you need to put a view inline in some text?. :o Should we upgrade Flow?. oh hm. for functional and indeterminate components it looks DEV-only:\nhttps://github.com/facebook/react/blob/e8394daaba08518f6aea2fc127fe505982a493ba/packages/react-reconciler/src/ReactFiberBeginWork.js#L260-L344\nI guess that's an oversight?. Object.values(require('ReactSymbols')) in a jest test maybe?. Might be nice to have a bubbles-false test for this too if we don't.. This failed before, right?. Maybe add:\n// Media events don't bubble so adding the listener wouldn't do anything.. IMO this would be easier to read as\nisMediaEvent\n!== -1\nif (!isMediaEvent). Old browsers I think. That's why we listen on the element at all.. otp?. This code dispatches a change event; it doesn't do anything by itself. Can we figure out why this was breaking?. I don't really feel comfortable removing this logic until we understand why it's buggy.. I\u2019m not sure if we have a team account now but if it would be helpful to y\u2019all we can get one. @gaearon?. What's the significance of this change?\n. Why is this here? Did prettier change?. I don't understand the significance of these changes either.. Unit tests for the warnings pls?. this duplication kills me a little bit :). sorry I could have also done this. fit. The timing of these yields is unchanged; the old test was misleading.. The way this test changed is a little interesting. Our \"hi-pri update\" causes us to re-call AsyncText which means that in a sense, the update now is blocked on the suspended component before it fully resolves. I can see the argument either way for how to account for this. The good news is that if we only scheduled an update on the sibling then they would stay independent.. ok whatever, ANdrew. Looks like we do already:\nhttps://github.com/facebook/react/blob/0af81997095dfa3db67a0c5d287b144797742e99/packages/react-reconciler/src/ReactFiberBeginWork.js#L187-L208\nthough I'm not sure we need to check legacy context there?. Ironically had to figure out how to compose these for the sole purpose of testing this change.. should we be consistent?. does this make two segments in the flame chart?. Rendering was suspended? . How about this:\n\n%s was passed an instance of %s which is inside StrictMode. Instead, add a ref directly to the element you want to reference.\n\nAlso, do we even need \"which is inside StrictMode\"? It or ConcurrentMode should always appear in the stack unless they're using createRoot.. \"The nearest child is in StrictMode.\" feels redundant. Should we pass hostFiber here too? Since you'll need to find it in order to change your code.. I know these are the same, but dev-only invariants feel risky. . Other way around, right? They have the same ancestors, but the hostFiber stack is longer/deeper.. I don't know that this is any clearer than the previous line though.. Prior art for our APIs (particularly defaultProps) is that undefined is treated as absent. Otherwise it is a pain to wrap Placeholder in your own component that passes a fallback through.. At this point we could even go so far as to do\nnewChildExpirationTime = Math.max(\n  newChildExpirationTime,\n  child.expirationTime,\n  child.childExpirationTime,\n);\nso simple\u2026 wow\n\n. \ud83c\udf33. seemsreasonable. Thanks for the catch, I intended to remove the conditional from the next line.. , and it . copy pasta?. lastIndexOf?. Can\u2019t ForwardRef have hooks?. Maybe we can change this to only check for undefined?. is this to handle dots? you could also do\njs\nlet basename = functionName.split('.').pop();\nreturn basename === primitiveName;\nkinda hard to tell what names this is trying to catch. add a custom hook integration test?. @bvaughn We only set primitiveStackCache if it doesn't throw.. if you do\n<Text><Suspense>{string}</Suspense></Text>\nI think so. it seems weird, I don't know if this is complicated, and we never do this right now so I opted to skip it. Object.assign({}, props, { style: [props.style, { display: \"none\" }] }),\nwhich is polyfilled https://github.com/facebook/react-native/blob/cc90c20bf60c72fc1b42f3306636847ce7f478e5/Libraries/polyfills/Object.es6.js#L15. This looks reachable to me. The break takes us to exactly this line.. nit: if (suspended). rm. I thought about it but I don't think this will be very common, it is a bad bug, and it is pretty easy to fix \u2013 so I think it's OK not to.. this is easier to read for me:\n`js\nwhile (context._threadCount < threadID) {\n  context[context._threadCount++] = context.currentValue2;\n}\n. why even keep these any more instead of using \"threads\" on the client too? only the lack of global coordination?. nit: (2 << 16) probably easier to read. Could return nextID - 1 (then +1 in free) so they appear to start at 0.. is this breaking?. \u250f\u2513\n\u2503\u2503\u2571\u2572 in this\n\u2503\u2571\u2571\u2572\u2572  house\n\u2571\u2571\u256d\u256e\u2572\u2572  we \n\u2594\u258f\u2517\u251b\u2595\u2594    use\n\u2571\u2594\u2594\u2594\u2594\u2594\u2594\u2594\u2594\u2594\u2594\u2572\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0invariant\n\u2571\u2571\u250f\u2533\u2513\u256d\u256e\u250f\u2533\u2513 \u2572\u2572 \n\u2594\u258f\u2517\u253b\u251b\u2503\u2503\u2517\u253b\u251b\u2595\u2594\nalso can we tweak:\n\nEnsure that you call .destroy() on it when you are finished reading from it.\n\ncurrent wording sounds a bit like a special case. what is it fixing?. .,. Shouldn\u2019t this intersect if there are two checkers for the same key?. @trueadm This is meant to read the default value.. (originally set here). @trueadm did you copy over the new react package? this line is important.. no comma after separately please. Do you want the latest completed+successful build instead of just the latest? Failed and incomplete both seem subpar.. It is to avoid this class of bug when inlining the full React source into a <script> tag: https://sophiebits.com/2012/08/03/preventing-xss-json.html.\nReally the fix should not be made here though, this was really a hack.. I guess it would be enumerable in prod but not in dev? prolly ok tho. do we warn against propTypes on the inner fn?. feels like a bit of a waste we need to do this and throw it away, I guess. Can we throw if we encounter .isHidden in any other context?. If I understand right, today we only use .isHidden for the two children of a Suspense component. If we ever change that we may want to update this logic in the test renderer code. So I thought it might be smart to assert that !isHidden except in this specific case. (For example, if arbitrary user code could make host components hidden today, then this logic would incorrectly catch those if there's ever two children with the first child hidden.). I'm trying to catch the case where we change React and forget about the test renderer.. I guess that does sound complicated. That's probably better. I had copied the truthy check from the old code.. I believe the logic should have really been !parentA && !parentB. Then we should enter the next if if either is null. But it is impossible for parentA to be null and parentB to be non-null. Hence the asymmetry. I could write it in a more symmetric way but it would have dead branches.. this reads as very jargony to me\u2026 my suggestion:\n'useLayoutEffect is not supported during server rendering. This call ' +\n        'is a no-op, but it likely indicates a bug because the effect will ' +\n        'not run until your component is hydrated on the client. If this ' +\n        'effect can be safely run after the component appears, replace ' +\n        'useLayoutEffect with useEffect. If not, you can change this ' +\n        'component to only render on the client. See ' +\n        'https://fb.me/react-warning-server-uselayouteffect',. I think this is supposed to be if (!isBatchingUpdates && !isRendering) but, this seems generally correct. I would guess that this demonstrates it, but I didn't verify:\n```js\nlet _set;\nfunction Foo() {\n  _set = useState(0)[1];\n  useEffect(() => {\n    ReactDOM.render(update1, otherContainer);\n  });\n  return null;\n}\nrender();\nReactDOM.unstable_batchedUpdates(() => {\n  _set(0);  // forces effects to be flushed\n  ReactDOM.render(update2, otherContainer);\n});\n```\n(I would expect the two updates to be batched but I don't think your code does.). Can't use async arrow functions without this.. I'm not 100% sure about removing the string special case. I understand people could be confused by the normal message? But I'm worried that it's confusing in the case that it doesn't correspond to an actual variable. (Maybe we could check that it looks like a valid identifier/member expression?). ",
    "jordwalke": "You read my mind!\n. @spicyj Are you at jsconf this week? It would be great to talk about some cool things we can do with this across browsers. \n. You can find out a little bit more from Lee's post here:\nhttp://www.quora.com/React-JS-Library/How-is-Facebooks-React-JavaScript-library\nWe'll get some deeper explanations in the official docs. Thank you for your interest and patience!\n. Thanks for doing this. Also, small jsfiddles like that are great to demonstrate issues/ideas (much thanks to @vjeux for jsfiddle know-how).\nDon't you just love that the DOM uses innerHTML to determine the initial value, and the .value property to determine updated values? :) Who comes up with this stuff!\nRegarding the approach: What if our DOMProperty module was smart enough to model the fact that one property name may be aliased to another on updates/mutation, on a per tag name basis?\nFor example, in this case children could be aliased to value on updates. However, I'm not opposed to your proposed approach - just wondering if there's a way to model this that can handle a bunch of future DOM inconsistencies that we encounter.\n. That sounds fine - especially since there's likely some other things we want to do to text inputs to make their API more reactive - this is probably just the start. Nice stuff.\n. BTW: There's two images superimposed - one from the background-image and one from the image. \n. Thanks @vjeux and good point @zpao!\n. You could have the nav text be: \"JSX: Not HTML\". Also you could replace \"debated\" with \"discussed\". But does anyone have a strong objection to having this doc in general? If not, we should fix the small nits and get it in. Iterate.\nI like the idea of an appendix, in general. A place to put the information for people who are getting serious.\n. :+1: \n. Great intuition. Several of us have thought about this opportunity and are thinking about approaches very similar to what you suggest. One of the benefits of defining style rules and css class specifications in JavaScript, is that you can use the full power of JavaScript to define styles, which we already have ways to model dependencies for. We wouldn't need another language like SASS or Less. Also, as you mention, since we also own the rendering/abstraction framework, we can ensure that we don't polute the CSS namespace. We can also ensure that components don't target nodes/class names that should be considered an implementation detail (concern) of a deeper component.\n. :+1:\nWhat are you thinking as a substitute? We should cover in-browser transforms as well as something like require.js (with or without in-browser transforms). Have you thought of using the Module.react.js convention? If we went with that, all the editors will not break.\n. @danielmiladinov: How do they handle things like coffeescript linting? I'd really seriously recommend doing it right, and not avoiding certain regions. The reason is that you're actually missing some seriously awesome linting action by ignoring regions.\n<Typeahead\n    userName={\"user:\" + theUserName}\n/>\nIs just sugar for\nTypeahead({\n    userName:\"user:\" + theUserName\n});\nIn my Vim linter, it tells me if Typeahead is not defined, or if I've mispelled theUserName or if theUserName variable is not in scope etc. Are there any webstorm linting plugins that you could fork? I'm sure people around here would help you integrate jsx + jshint into it.\n. @petehunt: It's hard to tell. JS+JSX is a superset of JavaScript, and syntactically compliant with E4X, which is another variant of JS - the trouble is that JSHint would need to assume the particular transformation that we apply (simple function calls) in order to extract value from the linting process. Then again, would anyone want to transform JSX into anything other than function calls (or something congruent with respect to linting)? Likely not.\n. That would be great!\n. To work well with batching, I suggested:\nthis.props.onEdit(function() {\n   var node = this.refs.editField.getDOMNode();\n   ...\n});\nWhere onEdit would have been defined as:\nonEdit: function(whenDone) {\n      this.setState(things, whenDone);\n}\n. Does it sound like addressing this at the rendering layer is a reasonable approach? Whenever a React instance has an onClick handler, we can render its markup as <div onclick=\"function(){}\" />.\n. @epeli: Couldn't you use a general purpose memoizer? It doesn't necessarily need to be baked into the framework, right?\n. Great suggestion. We could just warn in __DEV__ if any attribute is not recognized. You could imagine how that might lead to a bunch of errors when you do this.transferPropsTo(<div .. />).\n. I'm curious what you mean by \"passed over\". Could you please construct a very simple JSFiddle which reproduces the confusing behavior? Thanks!\n. :)\nYeah, in general React won't do anything you didn't tell it to do. I remember the conversation now - the outcome was \"React is practical, not magical\".\n. My thinking is that accidentally rendering over the entire page would be devestating. \n. I was thinking that someone could try to \"find a node to render into\" by continually doing while(something && node.parentNode) node = node.parentNode and test each node to see if it matches some characteristics. A bad algorithm here would result in the node being the document. The probability is very small, but imagine if we got accidentally passed the document for a site like facebook, when someone just wanted to render a react component on a small part of the page. So even though the probability is so small, the expected cost is high unless we add additional checks.\n. I've seen the same problem as well.\n@lorefnon: can you please let me know if github.com/facebook/react-page works on windows?\n. Pretty cool. I'll let @petehunt /Tom/@zpao merge it - it has to be pushed to the main site anyways once merged. Really wishing that clicking it actually starred it.\n. I would test the performance of adding a mutation observers to the top level of the document. I've heard they can be very slow, and I suspect adding them to the top level may be even worse than adding them to specific nodes.\n. I think it's odd to return things in the render() output that don't exist in the physical render tree. A component that has layers has the ability to have multiple distinct render tree roots. The ReactLayermixin in FB reflects that - but if the return value is too confusing, we can constrain it a bit - that should be very easy to do - we would just require that a single component be returned and modify existing code use. If we did allow them to be returned within frags, it would make sense that they are required to be at the top of the render tree - nothing deeper, and I'd probably be interested in making use of a more general abstraction that solves not only Layers but also other cases when you want a DOM subtree to actually exist on another part of the page, yet be controlled by your component. Think of it as a \"Portal\" to another part of the page:\nBut even just something as simple as our current ReactLayerMixin would be quite awesome. If released as a separate project, I wouldn't even mind bringing in a ton of extra JS resources. Pete, we could also just open source the Insta one quickly too, but I'd rather make it conform to ReactLayerMixin until we get frags, thoughts?\n. Good points @zpao. Another place where namespacing has been requested is in props:\n<div style.backgroundColor=\"black\" style.width={10} />\nWhich would transform into:\ndiv({style:{backgroundColor:'black', width: 10}});\nThat sounds like a good idea at first as well, but may also suffer from the same problems @zpao mentioned.\n. Before we do this, let's settle on a good router that we can use in react-page and encourage others to use the same. @andreypopp: Maybe we can settle on something like https://github.com/andreypopp/react-app-controller or a backbone router, and land it into contrib first. I don't have any strong opinions about the details of the router. I'm sure that if we found it lacking features, you'd be glad to implement missing features, correct? There's a couple of small blockers completely unrelated to the actual details of the router.\n- react-app-controller uses npm's react-tools. react-page has figured out a way to allow us to require('React') - not require('react-tools').React. The solution there, is to make a sub-project package.json file, possibly in the React core code-base and simply point your package.json at that. We should not be writing require('react-tools').React in any code base. All this because we don't have the npm name registered for React :/ but if we ever do acquire that npm name, we can just switch the package.json and touch any code.\n. I'd like the ability to access both state and pending state. But the question is, which should be the default? The primary benefit to treating this.state as the default, authoritative state that you base all of your state transition logic upon, is that it is guaranteed to be consistent with all your subcomponents' props.\nFor example:\nvar App = React.createClass({\n  getInitialState: function() {\n    return {name: 'joe'};\n  },\n  handleClick: function() {\n    alert('My name ' + this.state.name + 'should equal ' + this.refs.sayer.sayName());\n    this.setState({\n      name: this.state.name + Math.random()\n    });\n  },\n  render: function() {\n    return (\n      <div onClick={this.handleClick}>\n        <NameSayer name={this.state.name}>\n        </NameSayer>\n      </div>\n    );\n  }\n});\n. @spicyj Thoughts?\n. Could you throw in the quasi-literals transform if it's not already in here?\n. Could you run performance tests on this (especially since the actual use of arguments is out of our control)?\n. @sebmarkbage: Certain uses of arguments are problematic, (not all) but I'm not as much concerned with that here - I'm more concerned about the fact that this is a diff that touches the most critical path. I have no other basis for concern :)\n. > it is really just Array.prototype.slice.call(arguments, offsetA, offsetB).\nSo we create an additional array every time the method is invoked? Regardless of what the benchmarks say, maybe we should hold off on rest args for ReactComponent's constructor. That little function is likely invoked more than any other function in React. Also, a large portion of instances have only one child, and therefore would avoid the array allocation.\n. like-stamp\n. ```\n\n\n\n```\n\n@syranide I believe that was even part of the E4X spec that JSX was modeled after.\n. One issue with our mergeDeep utility is that it requires that you specify the array resolution up front - which will apply to all arrays in the graph. You may want to resolve different array conflicts differently. It's tough to think of an API for this that makes sense - but if you do, you can use mergeDeep/mergeDeepInto as a starting point - it's pretty comprehensible and we have a very thorough test case for it.\n. Incremental refactors like that are almost always better, so I'm glad you've thought about it that way. But it might be nice to get them all staged up stacked on top of each other just to prove that the final outcome actually does what we want, and so we can get a sense of the performance improvements/harms. There could be something we're overlooking in the implementation as well.\n. I had a comment a long time ago (it might still be relevant). We shouldn't be reading from the DOM in order to reconcile because that's kind of the point of reconciling - to be able to detect changes without having to resort to touching the DOM. Not sure if it's possible to do the types of things we want without resorting to DOM touching.\n. @jaredly, are you seeing issues? The Synthetic event system may actually help you get responsiveness out of underpowered machines. Attaching event listeners to actual DOM nodes is expensive.\n. Is this just an input related problem? Or do you see issues with click handlers (I suspect you don't)?\n. I think what we need is to manage our own event loop, so that we never yield control back to the browser until we're done doing all of our own system's deferred work. I was hoping some of the work you (@ide) were doing would help out there. We can follow up later about that and stick with the setTimeout for now.\n. No precedent for this yet, but I had a strong feeling this would be coming. There are some really interesting edge cases that can occur if you're not careful. One thing to keep in mind: If in a single event loop, there is every the possibility of several events being extracted (across a set of plugins) - they all must be enqueued together and processed together in the same batch. There are very nuanced reasons for why this is the case (one event dispatch can destroy DOM nodes for which other dispatches are intended for). I'm only explaining this for the sake of discussion - in this example, there's clearly nothing harmful happening in this event loop. Look, the event loop is only two lines of code!)\n. Because we're bound to not be able to replicate the onInput behavior exactly as it occurs in IE, we should name these events something that makes it clear that this is a synthetic event. Maybe onTextChanged or onInputChanged?\n. I wish it were clear from this function name that the resources will be released after processing.\n. How would you feel about the following: Making sure that the same number of synthetic events are fired in every browser, every version. That way our apps behave the same in every browser.\nThe only way I can see doing this, is by doing something similar to what you suggested. On any keyDown (maybe others too) store the previous value (but not on a DOM node), and do a setTimeout to see if the value ended up being changed. Only then would you dispatch the event, but you would never need to rely on the topInput event at all because we wanted all browsers to behave identically.\n. I actually think we want to still dispatch the event even if another previous event removes the input. So what you already have is closer to that, correct?\n. Sounds good to me!\n. That sounds like a fine plan as long as we can ensure that an onValueChange event is never fired more than once per change, in every browser. There are a couple of different ways you could store the value to compare against before the setTimeout. You could either bind it in the closure that you pass to setTimeout as an argument (which would be slower and happen on every keyDown), or you could create a privately scoped bank (javascript object) in this plugin that keys pending values by renderedTargetID. I think the first option is dirt simple and less error prone. We can start there and make it faster later once this proves itself. Sound good?\n. If you collect two event handler dispatches HA, HB, on DOM nodes A and B respectively, and HA causes B to be destroyed, HB should still fire, even though B is destroyed.\nThe reasoning is that the event still occurred on B so any handlers should be notified of it. If HB relies on B being in the DOM, then there's nothing we can do because your app doesn't understand itself. But if your app follows the reactive pattern closely, it would be unlikely that HB actually does rely on B being in the DOM. (BTW: You can still obtain the DOM node related to the event via e.target.\nWhat's even better about first aggregating all the dispatches HA, HB, is that if B is destroyed, but replaced with B' that has its own registered handler HB', we will not mistakenly fire HB'. In other words, I feel like this pattern works nicely with reactivity, and adds no additional nuances to your app that weren't already there.\n. Is there a way to cover all the cases with a combination of keyDown + setTimeout(handleTimeout.bind(null, previousValue), 0)? That could get us started. The paste issue could be handled separately.\n. @spicyj: Did this make sense? I feel like we can get a consistent change event happening without even using the change event at first. We simply listen to keyDown events, and on setTimeout see if the value has changed. The benefit of having a uniform process across all browsers, is that you won't get some onValueChange events being dispatched in some event loop iteration, and in other event loop iterations in other browsers - it will be predictable.\n. That sounds like a fine start. There should be nothing wrong with starting with the native onInput and working our way up to the perfect synthetic event. I'm glad you got a chance to work with the synthetic event system because you may want to create other plugins, and/or revive this one.\n. Yes that's fine, I'm only pointing out that you can feel free to have a couple of diffs, so that we don't block that simpler onInput support on our more complicated discussion on setTimeout etc.\nBTW: @petehunt had an interesting thought. You might be able to do this without the setTimeout on keyUP, as long as you remember the value on keyDown. That would probably require that you store a bank of last remembered input values on keyDown so that you can compare them for changes on keyUp.\n. Great point! The keyDown + setTimeout should work.\n. Without looking too carefully, I believe we need a general purpose event queue from which we can throttle updates to whatever can fit within the animation frame instead of \"running them immediately\". What do you think?\n. I believe we should not rely on identity of the information containers in order to make decisions. What's the intent you are trying to infer here? It's kind of lost on me without knowing what you're trying to do, but maybe there's another way we can accomplish the goal? Maybe you could accomplish the same by only invoking receiveProps if there were pending props.\n. One good thing (please verify) is that this setNeedsUpdate will not be called at every level of the flush, only the first level. If it occurred at every level, setNeedsUpdate could register a setTimeout(0) for every single DOM node on the page in the worst case.\n. BTW: In the implementation that I started, I did the same thing, in the same place, so we're probably on to something.\n. Really Good: Most state updates are triggered by DOM events. That means that we won't end up needing the setTimeout.\nOptimization: We can clear the pending setTimeout that was set up in setNeedsUpdate, as soon as we performPendingUpdates. I hear those setTimeouts can really clog the pipes.\nConcerns: Not all state updates happen in the same event tick. Browser events that trigger state updates are flushed in the same event tick, but other preemptive events that trigger state updates are not (like ajax responses, setInterval etc). There's not much we can do about that though - unless we create React.setInterval/setTimeout/ajax, which would merely be (optional) wrappers around the native implementations wherein we flush pending updates within the same event tick that pending updates are marked. (todo)\n. Recall how we talked about determining the optimal way to flush updates (from the rootmost points downward)? We don't really need to solve that problem now, but by factoring out the pending updates into a separate queue module, we could accomplish the following:\n1. Make it possible to optimize the processing of flushing according to our plan - at a later point in time. In order to flush optimally, there must be global knowledge of which instances need updating and that cannot be tracked on individual instances.\n2. Keep this module relatively tight and organized. You may also be able to eliminate the need to track _hasPendingUpdate here, and won't have to deal with tracking the list of callbacks here.\n```\n    ensureNeedsUpdate: function(callback) {\n      ReactUpdates.ensureNeedsUpdate(this, callback);  // Anything passed must implement {performPendingUpdate: func}\n    },\n// Only invoked when ReactUpdates knows we need to update.\n   // We invoke onComplete when we're done updating.\n   // ReactUpdates provides onComplete which cycles through the list of callbacks and invokes them.\n   // ReactUpdates automatically marks us as not needing update before invoking performPendingUpdate so that...\n   // if any of the callbacks in the list mark us dirty again, ReactUpdates keeps repeating the process in the same\n   // tick. We should detect anything over say 4 repetitions and throw (probably some kind of an infinite update loop).\n   performPendingUpdate(onComplete) {\n}\n``\n. Then you can remove it from the diagram as well. (Also noticed there's a duplicate column in the diagram!)\nTangent: (Why doesn't github let me comment on the line by the diagram and I am forced to comment here?)\n. Minor suggestion: It would be nice if right on this line 997 we reset the_compositeLifeCycleStatetonullso that no one comes and adds a bunch of code between lines 997 and 1000 while we're left incorrectly inRECEIVING_PROPSstate.\n. I totally agree thatRECEIVING_STATEwas a strange name. And to confirm my understanding, it was only used for validation purposes, correct? It's been a while since I looked at this code, but this looks good to me as far as I can tell. @sebmarkbage: Sound good to you?\n. One cool feature of the async refs, is that it makes it impossible (or at least difficult/fragile) for anyone to access a ref inside of a render method.\n. @sebmarkbage's property descriptor API idea will make declaring refs really elegant. For now, we have thiscomponentWillMountmethod which is as close to a constructor as we'll get until ES6.\n. Suggestion: For readability, can you rename thisinnerRef` - when reading for the first time, it threw me off.\n. The main place where I've really needed first class refs, is when building components that accept callbacks that generate components. Currently, the owner of any component (and therefore what the ref is attached to) is the \"currently rendering owner\". This is incorrect in the case of callbacks that render components.\nvar TrueOwner = R.cc({\n     componentDidMount: () {\n          this.refs.myDiv...           // Undefined!\n     },\n     renderContent: () {\n          return <div ref=\"myDiv\" />\n     }\n     render: () {\n         return <Wrapper getContent={this.renderContent} />\n     }\n });\nCan you create a test case or two that makes sure we now have the ability to do this?\n. var outer = (\n       <Wrapper object={outerObj} ref={this.outer}>\n           ...\n    );\n. It might be a little confusing that this has the same name as ReactRef.resolveRef. Also, when we've discussed \"resolving\" a component, it's usually to describe the process of finding the component. So we might reconsider the term \"resolve\" here and in the name ReactRef.resolveRef. Is \"attach\" the right term?\nEdit: Maybe your thinking was \"oh, eventually this function will go away when we migrate everything to the new refs\". That makes sense in that case. Could we use a different word then instead of resolve?\nI'm fine with either - it's just hijacking @sebmarkbage's terminology for something else within the same framework.\n. How can we prevent people from handing off this ref to various parts of the application. Do you feel that the only instance should be allowed to access the ref? There could be powerful use cases for allowing this first class ref to escape out to the entire system, but it also seems like a recipe for misuse/overuse. An API like:\nthis.ref(this.innerRef).then(...)\nCould ensure that you are only ever accessing a ref that you should be accessing.\nFor example, if you were to create a ref, and hand it to your owner via this.props.onSomething, and your owner hands it to your sibling, now your sibling has a reference to you. If you are unmounted/destroyed, your sibling still has a dangling reference to you. For this reason, if we start simple with the restriction that you can only reference things that you yourself rendered - and no two people can reference the same instance, then we avoid these types of issues. We might come up with other really cool use cases for \"multi-refs\" (where multiple instances can reference the same component through a shared ref but that might take a little more thought).\n. Yes, you are correct. But it does make it so easy.\nvar Comp = R.cc({\n    // in constructor, create this..myDivRef\n    render: () {\n        <div ref={this.myDivRef}>\n              <Typeahead theDivYourAreContainedIn={this.myDivRef} />\n        </div>\n    }\n});\nPrior to this diff, that wouldn't have worked easily because on the first render, this.refs.myDivRef would have been undefined. But now that they're first class, we easily expose refs in more cases. I imagine it's a nice time to think about a more defensive API that limits how people use them so we can make core changes more easily later.\n. It's just demonstrating that there are two lifecycles (Component and Composite) that are almost independent of each other - they overlap and but only certain combinations are even valid.\n. It would be nice to limit the ability to refer to something that isn't mounted. (Or maybe if a ref leaks out and that component that it refers to become unmounted, the promise failure can be invoked?\nOne other issue that this diff (as is) might solve (let's confirm/discuss):\nIf you pass a child to a component that calls cloneWithProps on it, your refs are currently removed. That's because only one component (the true owner) can reference a particular component. But when you cloneWithProps, the cloned descriptor is \"re-owned\". But with first class refs, we have the opportunity to allow multiple components to refer to that particular component.\nWe should decide on the behavior for cloneWithProps and add a test case.\n. I didn't see that. You are correct. We should test/confirm our expectations with how this plays with trasnferPropsTo and cloneWithProps. A ref should only ever point to one instance and that should probably never \"switch\" to another instance if it is cloned/transferred props.\n. I'm glad we only do this in __DEV__!\n. ",
    "mateusmaso": "just wondering how reconciliation really works.. like what conditions are made to merge the dom efficiently and what is the logic behind the .reactRoot[n] tracking... I think this is the part where React.js really shines for me and I even would use it as part of a separate library for people who just want that functionality.\n. ",
    "homleen": "Meet this problem too. Maybe it should be warned in the documentation.\n. ",
    "holmsand": "@chenglou Just to add another datapoint:\nIt turns out that the idea of @edc works quite well in practice, at least for me (i.e. escaping JSX in Coffeescript, and then compiling the resulting .js file using React's compiler). I've just rewritten something like 1500 lines of code using that method, and so far it's been an absolute pleasure. I.e. using code like this\ncoffeescript\nDropdown = React.createClass\n  render: ->\n    @transferPropsTo `\n      <div class=\"btn-group\">\n        <button tabIndex='-1' type='button' class=\"btn dropdown-toggle\"\n            data-toggle=\"dropdown\">\n          <span class=\"caret\"></span>\n        </button>\n        <ul class=\"dropdown-menu\">\n          {this.props.children}\n        </ul>\n      </div>`\nI actually like the 'look' of JSX in Coffeescript better than in JS, since the escaping clearly demarks what is JSX and what is not. \n. ",
    "subtleGradient": "The XJS project hasn't gotten any code since it was created in 2011 http://code.google.com/p/xjs/source/list\n. It's not passing every browser in testling-ci yet. I'm investigating.\nCf. https://ci.testling.com/subtleGradient/react\n. It's not passing every browser in testling-ci yet. I'm investigating.\nCf. https://ci.testling.com/subtleGradient/react\n. I don't know how to get testling-ci to run grunt.\nI do know that if you include a path in the \"tests\" section of the \"testling\" package.json thing it'll get run through browserify first. So maybe there's some way to piggyback on that somehow.\n. @benjamn looking into it now\u2026\n. Got testling-ci working with IE10 and probably more.\nReact apparently fails a few tests.\n. Switching to SauceLabs\u2026\n. The grunt-saucelabs implementation of jasmineRunner seems to be broken.\nI'll have to fix it.\n. I decided to remove testling and sauce labs as dependencies for this PR. I'll add sauce labs support in a separate PR.\n. You can run tests in a local browser by opening the test/index.html file, no server necessary.\nIf you need to keep the localhost:9999 server running for some reason you can use grunt connect:server:keepalive.\nI'm not sure how to make it so that grunt test --debug runs something similar to grunt connect:server:keepalive, but I'm sure it's possible.\n. This is what I've been doing to test changes really quickly\u2026\n1. Run chromedriver in one terminal window.[1]\n2. Turn on the localhost:9999 server using grunt connect:server:keepalive in another terminal window.\n3. Run grunt webdriver-jasmine:local in yet another terminal window.[2]\nIf you also want to test changes to any of the generated files you'll need to rebuild them as necessary with grunt build or whatever more specific task. This part could be made a little faster.\n[1] Any webdriver server running on localhost:9515 will be used by the webdriver-jasmine:local task. You can use chromedriver or phantomjs --webdriver=9515 or whatever else you like. The webdriver-phantomjs task is essentially the same as phantomjs --webdriver=9515 except it kills it once its done.\n[2] To keep the browser window open, pass the --webdriver-keep-open flag to grunt. e.g., grunt webdriver-jasmine:local --webdriver-keep-open. You can then refresh this page occasionally to manually test changes after rebuilding.\n. Relies on benjamn/populist#4 & benjamn/populist#5\n. Can't run the tests in IE until #496 is fixed\n. Tests run in IE8 now.\n. This https://github.com/benjamn/populist/pull/8 made it a lot easier to find this problem.\n. Still happening\n. That worked.\nWe should add that to the grunt clean task.\n. Rebased against master\n. grunt --verbose --debug 9 --stack webdriver-jasmine:saucelabs_ie11\n. http://saucelabs.com/tests/4203eb348bb34849a41b9817bd584f8b\n. This keeps the test runner from running.\nI plan to post a fix to the test runner for this soon.\n. https://gist.github.com/subtleGradient/3363f1dc1a4f31a700b5\n. 20 failing specs\n. \n. Should break these up into separate issues\n. ```\nmutateHTMLNodeWithMarkup should mutate the document html.\nError: Invalid target element for this operation.\nmutateHTMLNodeWithMarkup should change attributes.\nError: Invalid target element for this operation.\n``\n. #oldestBugEvar\nThis is how MooTools handles theinnerHTMLproblem. It also effects Firefox < 4 in some cases.\nhttps://github.com/mootools/mootools-core/blob/master/Source/Element/Element.js#L1021-L1049\n. :+1: \n. Sounds like an encapsulation leak. Perhaps the input component should provide some sort ofvaluegetter instead of encouraging us to reach in and noodle with its DOM node. cc @sebmarkbage \n. https://github.com/benjamn/recast/issues/46\n. oops\n. :+1: \n. :+1: \n. willfix\n. Is the new cleaner output good enough? No more raw JSON.\n. Also fixes #541 \n. eep, I've got a bug in myfinalize-coverage-stream`, brb\n. Nits picked. ICANHAZMERGE?\n. Rebased.\n. I don't know what's up with these\u2026\n```\n\n\nnot ok 342 - AnalyticsEventPlugin should count events correctly.\n\n\nError: Invariant Violation: createAnalyticsPlugin(...): The DOM is not supported in the execution environment. in http://127.0.0.1:9999/test/index.html (line 48)\n\n\nnot ok 344 - AnalyticsEventPlugin error on invalid analytics events.\n\n\nError: Invariant Violation: createAnalyticsPlugin(...): The DOM is not supported in the execution environment. in http://127.0.0.1:9999/test/index.html (line 48)\n``\n. Tests are failing on master. https://travis-ci.org/facebook/react/builds/14155444\n. The Travis CI build is failing because of 7df127d, b91396b and d853c85.\n. This is in the webdriver test runner\n. The current workaround is to manually wrap stuff in afunction(){}` like so\u2026\nHTML\n<foo><bar /></foo><baz />\n<reactishTextareaOrSomethingLikeThat isHip={true}>{function(wrapper){<wrapper>\n    <foo><bar /></foo><baz />\n</wrapper>}}</reactishTextareaOrSomethingLikeThat>\nBut that's super ugly\n. It's more than not wanting to render its children immediately. It's the ability to easily render them later, maybe multiple times in various places like you can with an HTML <template> element's documentFragment and various other meta programming stuff.\nI want this ability in completely vanilla JSX code that has no dependency on React.\n. :+1: \n. We could add https://github.com/facebook/react/pull/617 and the sauce labs tests to the matrix also. Good idea!\n. We could add https://github.com/facebook/react/pull/617 and the sauce labs tests to the matrix also. Good idea!\n. :+1: \n. :+1: \n. Oops, didn't notice https://github.com/facebook/react/pull/596 before I sent this.\n. Everything checks out in jst. All the src/core/__tests__/ReactRenderDocument-test.js tests actually run in JSDOM now.\n. Everything checks out in jst. All the src/core/__tests__/ReactRenderDocument-test.js tests actually run in JSDOM now.\n. Cf. http://jscomplexity.org/complexity\n. Removed the xml files. We don't need them for anything yet.\n. Curious, why is this script in python?\n. Perhaps unit should be renamed to travis:unit or something then?\nEither way the same stuff is happening in the same order.\n. The reason I want to change this is so that I can add more matrix entries without complicating the travis script.\n. Currently I have each version of IE separated out as a separate matrix and they are setup to be allowed to fail. Once we fix all the broken tests for each browser we can remove it from being allowed to fail and move it to the unit phase. That way the we won't regress browser support.\n. The problem with travis matrix is that nothing is kept between builds. Ideally we wouldn't go through npm install more than once, for example. For now this works though.\n. cc @zpao \u2014 As you wish.\n. cc @zpao \u2014 As you wish.\n. I'll just leave this here: #633 \n. I'll just leave this here: #633 \n. Blargh, flaky tests: #634 \n. Blargh, flaky tests: #634 \n. #635 should help the webdriver tests be less flaky\n. #635 should help the webdriver tests be less flaky\n. Rebased with master\n. Rebased with master\n. #635 should be merged before this one\n. #635 should be merged before this one\n. #635 should be merged before this one\n. https://travis-ci.org/facebook/react/jobs/14945946#L1493\n. https://travis-ci.org/facebook/react/jobs/14945946#L1493\n. https://travis-ci.org/facebook/react/jobs/14945513#L2440\n. https://travis-ci.org/facebook/react/jobs/14945513#L2440\n. The poll interval doesn't really matter, we can always tweak it later if we want.\n. The poll interval doesn't really matter, we can always tweak it later if we want.\n. Perf comparison of this diff to previous master in IE8.\n\n. IE11 on a Windows Surface Pro 1 running Windows 8.1\n\n. IE9 running on a crappy Windows 7 Starter Edition netbook.\n\n. Yes. I plan to add some memory profiling stuff soon. That'll be a bit tricky though since it requires passing command line flags to chrome. I'm not sure if sauce labs supports that yet.\n. Current output example: https://travis-ci.org/facebook/react/jobs/16476932\nSauceLabs example: https://saucelabs.com/tests/3161fd82969e422a9e05c6f0bd2dd9ee\n. Current output example: https://travis-ci.org/facebook/react/jobs/16476932\nSauceLabs example: https://saucelabs.com/tests/3161fd82969e422a9e05c6f0bd2dd9ee\n. The unit tests are currently failing on master, this diff contains no changes to any React source.\n. You must never begin a line with ( or [. It's the law.\n. Yeah, I'm not 100% sure about this change. I did it so that I could get the tests running in a browser normally without having to rely on the phantomjs web server contortions.\n. I wasn't sure if this script would be included in the head or the body. I guess I could have used @imports but I didn't think of it at the time.\ndone > perfect?\n. I did the easiest thing that would work. It doesn't really matter. document.write is safer for things that rely on the timing of load and domready so I default to that for unknown code.\ndone > perfect?\n. testling-ci can load scripts like this, but it won't load an html file.\n. This is a 1pxl gif. Instead of loading it from the filesystem I just embedded it.\n. Yeah, I just pasted this from somewhere. Dang my slackerly ways!\n. Could be. I'll enable the test and see if travis has a problem with it. I suspect they run this stuff on VMs, but you never know.\n:hamburger: \u2190 for no reason\n. That would only work if we indented by 4 spaces. That is the #1 reason why I used to indent by 4 space back in the day. Technically I indented with tabs and then set them to look 4 spaces wide in my editor, but I digress.\n. Yup, just tried it and everything seems to work.\n. Done.\n. http://gruntjs.com/api/grunt.log#grunt.log.writeln-grunt.verbose.writeln\n. So, in order for this to work we'll need to remember to modify this value when one of those files changes?\nHow will we remember to do that?\nSeems like the sort of thing that will happen a few times and then we'll forget about it.\n. Good point.\n. YAGNI. As soon as we need that, absolutely.\n. forEach(foo, bar) does the equivalent of foo.call(bar, \u2026).\nThis was failing because its this wasn't what it expected.\n. I implemented it a few lines up.\n. right here\n. exactly\n. Sublime Text can be made to support txmt:// urls. I don't know about any others.\n. Done.\n. Done.\n. /me almost fails to completely suppress the desire to discuss code formatting style\nYou're welcome.\n. Done.\n. I tried making it work against src but it broke on jsx syntax in js files.\nI tried to filter out the tests but I couldn't figure out a glob pattern that would work.\nI plan to create a high level task that you'd use on a fresh checkout in a separate PR.\n. We don't really have a need for them right now.\n. == null matches null and undefined and nothing else. What's supposed to happen when this._pendingProps === undefined?\n. grunt lint isn't bothered though \nI do not intend to run this Gruntfile in IE8.\n. I like that it makes me feel uneasy. We shouldn't feel comfortable with leaving it this way.\n. poll interval\n. 50ms because I want to start the tests asap\n. 100ms because the tests can take a few seconds to run, but then I don't want to unnecessarily delay everything more than necessary.\n. 500ms because if this isn't already 0 that means you're probably in debug mode and there are going to be a bunch of things to send.\n. Have you done any perf comparisons?\nI'm not completely sure, but it looks like you're creating a new function here and then creating an unnecessary array just so that you can turn it into a string. Pretty? sure. But I don't think that's really worth the cost\n. Not loaded yet.\n. #willfix\n. will do\n. ",
    "rnd174": "@zpao : How to create an infinite scroll using react.js? currently I have implemented infinite scroll using jquery. But now m trying to move my attention towards react.js.\n. @zpao Thanks for the guidance. I have posted my question on stack overflow. You can answer it there.\n. ",
    "hojberg": "There is a file in src which builds when not using a subdir in the public dir.\nnode version is 0.8.23 and im on OS X Mountain Lion\n. The same file builds fine if I use jsx -w src/ public (note the lack of public/js).\nDeleting that directory didn't work for me.\n. :heart: \n. :heart: \n. Ok. I think I now know what the issue is.\njsx created a .lock.pid file in the output directory. If that file is still there when running jsx again it will quick silently.\n. Ok. I think I now know what the issue is.\njsx created a .lock.pid file in the output directory. If that file is still there when running jsx again it will quick silently.\n. +1\n. +1\n. I can jump on this. I'm familiar with yuidoc.\n. @zpao yea - i'll give it a shot :)\n. @spicyj @petehunt changed to handle undefined children closer to the exception, in mergeKeySets.\nLet me know if you'd like this handled elsewhere.\n. @spicyj @petehunt any changes needed here or good to merge?\n. @spicyj @petehunt any update on merging this?\n. Definitely felt that pain. Could be solved by a summary at the end of the test output and the ability to run 1 test at a time.\n. grunt-contrib-jasmine takes a --filter param - Not sure if that is what you guys are using?\n. That is pretty much how I do that now as well. \nThe suggestion here is to create sugar around a common ui pattern. This could be done with a listener on document instead of a transparent div (which would need styling).\n. yea i've definitely run into issues with this on occasion. Would love to see this addressed soon.\n. Thank you!!\n. :+1: \n. All functions on a component are automatically bound to the component instance\n. This is a dupe of https://github.com/facebook/react/issues/4279. Closing\n. Object.keys(undefined) throws (which is the exception i'm trying to avoid).\nReactChildren.map(undefined, fn) will return undefined, which will bubble up, until it meets mergeKeySets which uses Object.keys. \nWe could let mergeKeySets handle the undefined inputs?\n. ",
    "hieu": "I had same problem on ubuntu. Yesterday \"jsx --watch\" worked just fine for me. Today when I ssh-ed again and ran \"jsx --watch reactjs/ js/\" it just silently does nothing.\n. @jeffreylin :+1: Work like a charm. Thank you very much!\n. ",
    "yungsters": "@spicyj, can you rebase this? There are conflicts.\n. What's the consensus? This seems fine to me.\nHowever, there are merge conflicts.\n. > Does it make sense to pass on the native event? Since it could be one of seven different types, I'm not sure that application code would be able to do anything useful with it.\nYes, keep passing it along. It's up to the end user to do what they will with it, but I have a new set of \"synthetic events\" that will allow us to normalize the API for both DOM and custom events like the one you're adding.\n. Okay, let's update this bad boy and get it in. :+1: \n. Sweet, sorry for the delay in reviewing this (was out sick last week).\nMy only remaining concern is how we deal with arrays. I think joining arrays will reduce developer friction while still having reasonable behavior in the worse case:\n``` javascript\n// It would make this work...\nHello, {name}\n// Hello, Tim\n// While still having non-horrible fallback behavior...\nHello, {name}\n// Hello, [object Object]\n```\nAs for supporting content, well... I didn't realize you were the author of that one, too... :+1: \n. @spicyj Don't worry about it.\nI have a diff that builds on top of this (internally) already. I'm going to make children behave as defaultValue and recommend that people use defaultValue and value instead (which is less ambiguous and less prone to wrong usage).\nWould you be comfortable with me merging this as is?\n. The revised version makes a ton of sense. I love the direction and agree with the TODO comments. :+1: \n. > :) Figured that might be the case. (I'm just creating merge conflicts for myself with my textarea pull request anyway. Ah well.)\nJust saw this, haha. Bravo @spicyj.\n. Is this only an issue with iOS4 and below? Can we just generate markup for every node with onclick=\"\" on the affected browsers?\n. Although this may be confusing, I think it is relatively straightforward to realize what is going wrong. Changes that allow keyup to access the attempted value would cause the text input's value to flicker since keyup fires later.\nLet's just clarify documentation.\n. Based on the W3C's documentation for the click event and interactive content, my understanding is that the click event should fire whenever the cursor is clicked on the <select> (which arguably includes the contained menu of <option> elements).\nUsing this interpretation, Firefox has the most correct behavior.\n. To be honest, I don't know if I would have done anything that differently. The Layer abstraction has held up really well \u2014 we have been able to extend it and make improvements over time without much code decay.\n. I guess I'm not sure what you mean by using composition to hook Layers up to React. Are you asking why we use renderLayers instead of returning the <Layer> components in render?\n. Layers are not inherently anchored to any position in the DOM. For example:\nrender: function() {\n  return <div><button>Show Dialog</button><Dialog /></div>;\n}\nIt does not make sense for <Dialog /> to exist in the returned tree. What we actually want is for render to return the subtree as well as a list of Layer components.\n. When I designed renderLayers, I debated whether or not to allow returning a single Layer component. However, I did not want engineers to have to learn something new just because their use case requires more than one Layer component.\nAlso, I felt like it was not too painful to have to return a map with one key. Keep in mind that at the time, this was the standard way of passing in children with keys into a React component.\n. I would not be strongly opposed to that, but I don't think it makes the code easier to read. It makes the following questions harder to answer:\n- Does this component render any Layers?\n- Is any given component returned by rendera Layer component?\n- Does this component render into any non-Layer?\n. Just spoke with @petehunt. Instead, we will publish a blog post with a rudimentary layer implementation and ReactLayersMixin that demonstrates how such a system would be built.\n. Looks like this might have been required before because Chrome only updated the DOM selection after the event. Going to test on all browsers before merging this: http://jsfiddle.net/33n5J/1/\n. Looks good, tested in Chrome, Firefox, Safari, and IE8-11.\n. > As getEventKey is now external there might not be as much of a point in having getEventCharCode, getEventKeyCode, etc as functions rather than inline in the interface, your opinion?\nHah, I was thinking the same thing. Most of the other events have these functions inline. In my personal opinion, seeing a line reading var KeyboardEventInterface = { gives context about where those functions will be used. Maybe this is being nitty, but once again, my personal opinion.\n\nPS. FYI when getEventKey was moved out require('invariant') apparently went missing, not that it really matters in practice, but good to know, it's fixed in my PR.\n\nI think your PR adds the only caller to invariant to the getEventKey module.\n. I am such a GitHub n00b.\n. Fixed by 977b60c1ed941869d121e9f44a4019d649ed73c5.\n. Since the console methods already support string formatting, why do we have to re-implement it?\n. No, I don't know what I was thinking. Thanks!\n. Can you remove these filename-looking comments? It's confusing because they do not exist anywhere in the codebase.\n. > A class can use multiple mixins, but no two mixins can define the same method. Two mixins can, however, implement the same lifecycle method. In this case, each implementation will be invoked one after another.\n\nThe only exception is the shouldComponentUpdate lifecycle method. This method may only be implemented once (either by a mixin or by the component).\n. Nit, avoid contractions in documentation (i.e. \"They are\" instead of \"They're\"). Also, breaking at 80-characters makes reviewing easier.\n. > When MyComponent is mounted into the page, the following text will print to the console:\n. The old one didn't make sense because it's saying \"no one has done what we're doing because this requires building from the ground up without being coupled with the DOM\". Anyone could have done this, but no one has.\n\nI think what we want to say is that \"no one has done what we're doing, which is building from the ground up without being coupled with the DOM\", and I felt that by this line, we already hammered into the reader what we're doing. I can bring it back, though.\n. Can you explain why these are necessary? ReactNativeComponent should only operate on properties that exist in DOMProperty.isStandardName.\n. Let's fix that separately as a performance optimization. We can simply change the last else here with DOMProperty.isStandardName[propKey], right?\n. Probably not worthwhile. It's probably not worth looking too deeply into this and what you've got here is fine, but if we wanted to we could also pre-compute all DOMProperty properties per element so we don't ever have to instantiate the same element more than once. But once again, this is going to take O(1) and isn't worth over-optimizing.\n. Nit: Unnecessary check because for (key in falsey) { will implicitly do that.\n. This probably gzips well anyway, but would be even better to generate this and all the directions with code.\n. This check looks good to me.\n. Add a comment about how propertychange does not bubble so we cannot listen to this using top-level event delegation and have to enqueue and process manually. (By the way, @jordow, can you explain why we need two steps for enqueuing and processing instead of one?)\n. Change topLevelTarget.attachEvent to activeElement.attachEvent so it's easier for readers to find the detachEvent call below.\n. I've always had the impression that focus and blur events are flakey (e.g. if the OS steals focus from the browser, etc.). Is it ever possible for the blur event to not get fired before another focus? If activeElement, maybe we should do the cleanup below.\n. The conditionals are correct, but a little hard to follow. Do you think this would be any better?\njavascript\nif (isInputSupported) {\n  if (topLevelType !== topLevelTypes.topInput) {\n    return;\n  }\n  // ...\n} else {\n  if (topLevelType === topLevelTypes.topFocus) {\n    // ...\n    return;\n  }\n  if (topLevelType === topLevelTypes.topBlur) {\n    // ...\n    return;\n  }\n  if (topLevelType !== topLevelTypes.topSelectionChange &&\n      topLevelType !== topLevelTypes.topKeyUp &&\n      topLevelType !== topLevelTypes.topKeyDown) {\n    return;\n  }\n  // ...\n}\nOr better yet...\njavascript\nvar extractEvents;\nif (isInputSupported) {\n  extractEvents = function() {\n    // Modern browsers...\n  };\n} else {\n  extractEvents = function() {\n    // IE<10...\n  };\n}\n. No, I think this is right. If the owner specifies props.content to be an empty string, an empty string should be used.\n. Besides extra mutations, is there any harm in updating the textContent as well? If there are no other negative side effects, I think we should still keep the textContent up-to-date (i.e. transfer this.props.content and this.props.children).\n. X == null is better here because if the user specifies an empty string, we should still throw.\n. Ditto.\n. We do this for input values in hopes of avoiding mutations unnecessarily, do you think we should do this here, too?\njavascript\nif (oldContent !== newContent && rootNode.value !== newContent) {\n. De-dupe this with the preceding comment paragraph? Could just delete the first sentence and smash them together.\n. Delete unnecessary comment.\n. When this gets executed, there is no guarantee that the state has been executed. In particular, setState/replaceState will not synchronously update state if invoked during getInitialState, componentWillMount, or componentWillReceiveProps (see the conditional block right above this line).\n. We do X == null all over React core as an idiom for X === null || typeof X === 'undefined'.\n. Can you detail what kind of weird things happen in IE9?\n. I see. In some ways, IE9 is even worse than IE8.\n. :+1: \n. What about:\njavascript\nif (Array.isArray(props.children)) {\n  content = props.children.join('');\n} // ...\n. We will not be supporting content anymore. Yay, fewer special cases.\n. Super nit, how do you feel about making all the error messages refer to this as <textarea>?\nAlso, if you take up on my suggestion about joining arrays, this error message would need to be updated.\n. @petehunt It will only screw it up if it would screw it up today since he does rootNode.value !== newContent (i.e. avoids unnecessary mutations).\n. Nit.\njavascript\nif (A &&\n    B &&\n    C) {\n. Nit.\njavascript\nA: function(\n    a,\n    b,\n    c) {\n. Also, forceUpdate.\n. You need a space after update.\n. Why did you delete this method?\nIf you have a <select multiple={true}> with multiple values selected, switching to multiple={false} should retain the first selected value.\n. This should either be private this._getValue or just inlined in updateOptions (the only caller).\n. Yeah, that was my bad. I realized recently that these should be private when someone tried to use getValue as a public method.\n. Heh, look at the condition surrounding this update. I think you want to do what ReactDOMInput does:\njavascript\n'' + this.props.value || ''\n. Extra trailing comma.\n. Is html nullable? If so, can you change the docblock's type to {?string}? If it is not nullable, you can just do html.replace(...).\n. Yeah, seems fine.\n. Hm... yeah, let's require it to be a string. And yes, let's pull it out of the function so it can be precompiled.\nI think /^ /g is correct. We want to replace the leading space with &nbsp; so that the remaining whitespace characters are preserved. For example:\nhtml\n<pre>  2-space indentation</pre>\nReplacing the first whitespace with &nbsp; should give us similar behavior in IE8- as what we'd expect. If we replace all of the leading whitespace characters, we would lose the second character.\n. This was confusing until I read the other comment. Maybe change this to say, \"[...] because it's possible for a component to have a null owner. If this._owner === this._pendingOwner, that means there's no owner change pending.\"\n. Is this a mistake? I thought we explicitly decided not to do this.\n. Could the logic here to find the container and execute listenTo be put into ReactEventEmitter.putListener? Then it doesn't even have to be exposed on ReactEventEmitter and could be re-used below.\n. Instead, can you make this:\nvar isListening = getListeningForDocument(contentDocument);\nAnd implement getListeningForDocument next to where you declare alreadyListeningTo and reactTopListenersCounter.\n. For consistency:\n* @param {string} registrationName Name of listener (e.g. `onClick`).\n. This is not a registration name.\nvar eventPlugin = ...;\n. Currently, eventName is only used as an internal name by each event plugin module. What if instead, we published a mapping from registrationName to dependencies? Then we don't have to do the crazy \"registrationName > eventName > eventPlugin > dispatchConfig > dependencies\".\n. The formatting here is weird and hard to read.\nIf you take all my other suggestions, this should be as simple as:\nvar dependencies = EventPluginHub.registrationNameDependencies[registrationName];\n. Although correct, I've gotta say this is pretty clunky. Would it be so bad to simply use keyMirror?\n. Revert.\n. This exceeds 80 characters per line. Can you wrap \"monitoring\" and put back that period? :+1: \n. Nit: Add a space after for here and below.\n. Hm... why did you allow null / undefined?\n. Prefer instead got %s. I like when the dynamic value is at the end by itself (in case it's really long).\n. You should be able to delete useSelectionChange earlier in this file, yeah?\n. Hmm... I don't think this works. If React tries to change the values, it would have to use setAttributeNS, right?\nelement.setAttributeNS(namespace,name,value)\nSupport for namespaced attributes in general has not really been tested.\n. One side effect is that the existence of getDefaultProps will now affect whether or not this.props is the same as the props passed in. Is this a concern at all? Components are not supposed to mutate this.props, but this seems like a hard-to-debug case waiting to happen.\nWhat if we always merge(newProps)?\n. Can you rebase on 182a237fa77185ebb823e0f97ae3fa13abe4421a? In particular, move some of this logic into getEventKey.\n. Any reason for doing target instanceof window.constructor instead of target.window === window like you did in #803?\nIf they can be the same, what do you think about making a isDOMWindow module?\n. Reading http://stackoverflow.com/questions/6229301/, it looks like instanceof window.constructor could fail if we want this to work for other actual windows (where the constructor is a different instance).\nInternally, we've used (X.window === X && X.self === X). Thoughts?\n. @zpao Can we just delete the warning now?\n. Check to make sure doc exists. I have a feeling this might raise the same issues that it did for EnterLeaveEventPlugin for IE8.\n. Nit: Add a colon after type.\n. This can be non-display characters, so shouldn't this be something like:\nreturn translateToKey[charCode] || String.fromCharCode(charCode);\n...or something? Listening to onKeyPress and checking event.key === 'Enter' should work. Currently, this will just return an empty string:\n```\n\nString.fromCharCode(13)\n\"\"\n``\n. Hmm... I'm seeing thatkeyCodeandcharCodeare both set for \"Enter\" in Chrome onkeypress. Are you seeing something different?\n. I think your normalization of ofcharCodeandkeyCodeare fine. However, my understanding of the spec is thatkeyshould be\"Enter\"when pressing **Enter** on allkeydown,keyup, andkeypressevents. The code here will never setkeyto\"Enter\"`.\n\nBy the way, I've been using this to see what browsers do: http://jsfiddle.net/yungsters/D9LjL/\n. This should be a docblock.\n. This is a pretty terrible pattern :\\\n. This would be simpler with something like:\n```\nvar eventNameMap = {\n  transitionend: {\n    'transition': 'transitionend',\n    'WebkitTransition': 'webkitTransitionEnd',\n    'MozTransition': 'mozTransitionEnd',\n    'OTransition': 'oTransitionEnd',\n    'msTransition': 'MSTransitionEnd'\n  },\nanimationend: {\n  'animation': 'animationend' \n  }\n} \nif {!('AnimationEvent' in window) {\n  delete eventNameMap['animation']\n}\n``\n. What do you think about naming thisdidPutListener? Haha, lifecycle methods for everyone.\n. Do you mean that this should instead be aninvariant?\n. If you invokedeleteListenerwith an invalidregistrationName(or one that has never been passed toputListener), thenbankForRegistrationNamewould beundefined, right?\n. Delete trailing comma. :smile: \n. This is not used.\n. Maybe briefly mention thatcharCodereturns thekeyCodeof printable characters (excluding Tab, including Enter).\n. Hmm... shouldn't this be!(key in one)? Keys with the value ofundefinedhave feelings, too.\n. Looks like the type ofpropValueshould be{*}` because we should never get null or undefined with the new code, right?\nAlso, maybe s/string/stringable/g.\n. Just to confirm my understanding, this is the main behavioral change caused by this pull request, right?\n. Why isn't this also in componentdidMount?\n. Maybe worth a comment, // Revert the node back to its initial state..\n. Is it safe here to assume that this is going to be a ReactCompositeComponent?\nEdit: Otherwise, preventExtension will complain. :-1:\n. Okay, thanks!\n. Can you revert the indentation changes here and below?\n. Thanks for adding this!\n. @zpao, should this just be require('escapeTextContentForBrowser')?\n. > This should never be null -- when is it?\nHmm... when onClick={null} like you're trying to guard against in ReactDOMComponent.js?\nWhat if instead of checking lastProps[propKey] in ReactDOMComponent.js, you only invoked PluginModule.willDeleteListener if !!bankForRegistrationName?\n. Ahh, I see. Agreed. Do you think we should add a warning to deleteListener, then?\nEither way, this looks good to me.\n. :+1: \n. Oh yeah, will remove.\n. Sounds good. Any objections to exporting it as ReactNative.Component?. I'll change ReactNativeComponent to use NativeMethodsMixinType like you did in ReactNativeFiberHostComponent, but disclaimer... the same trick does not actually work for ReactNativeComponent:\n(ReactNativeComponent.prototype: NativeMethodsMixinType);\nUnlike for ReactNativeFiberHostComponent, Flow does not complain if any of the methods are missing. I suspect this is because ReactBaseClasses (and therefore React.Component) is not Flow-typed. Getting rid of extends React.Component fixes this, but we obviously cannot do that.. In React Native, we've started adopting a common practice to use:\ntype HostContext = $ReadOnly<{|\n  isInAParentText: boolean,\n|}>;\nThis makes it so you cannot write to isInAParentText and disallows access of properties other than the ones supplied. But I'd rather you use what is common in the React repository.. I'm surprised that emptyObject fulfills the type definition for HostContext. I would've expected isInAParentText to need to be optional (isInAParentText?: boolean), but maybe emptyObject is typed with something lossy like Object?. Only debugRenderPhaseSideEffects is currently dynamically configured internally.\nWe always set debugRenderPhaseSideEffectsForStrictMode to true.. ",
    "bankyadam": "Ugly, but I use the following until a fix:\nvar SPACE = ' ';\nvar MyComponent = React.createClass({\n    render: function() {\n        return (\n            <div>\n                {this.props.foo}\n                {SPACE}\n                {this.props.bar}\n            </div>\n        );\n    }\n});\n. ",
    "ngavalas": "Will add unit tests.\nAbout putting it _performComponentUpdate(), that's where I originally was trying to put it, but I see a small problem with replaceState in particular.  Perhaps I'm misunderstanding the component lifecycle (strongly possible), but it appears that once in a while, the \"new\" state is just dumped into _pendingState, in which case _performComponentUpdate() isn't called in that particular call to replaceState.\n. Lovin' this.\n. What happens to the callback if we currently mounting and our new gets dumped into _pendingState?  This is the same problem I was running into.\n. ",
    "remixz": "@spicyj & @zpao Thanks to both of you! :+1: Eagerly awaiting 0.3.3, and will checkout from master for now. :smile: \n. ",
    "brianr": "@spicyj The tables issue appears to be fixed, at least partially, in master. See this jsfiddle: http://jsfiddle.net/6pBnK/2/\nIt looks like commit fixed it: https://github.com/facebook/react/commit/adffa9b0f4128ca4832ddd03fdeca2c9fe434689\nThere's still some weirdness because the original <tr>s are inside a <tbody> and the rest are directly in the <table>, but the order is correct.\n. @vjeux I'm not able to reproduce that particular behavior given this small repro case. The original code had several more layers... will keep trying.\n. Ah, beat me to it -- I was just about to suggest the following as a fix:\n``` diff\n--- a/src/core/ReactNativeComponent.js\n+++ b/src/core/ReactNativeComponent.js\n@@ -320,6 +320,12 @@ ReactNativeComponent.Mixin = {\n       CONTENT_TYPES[typeof lastProps.children] ? lastProps.children : null;\n     var contentToUse =\n       CONTENT_TYPES[typeof nextProps.children] ? nextProps.children : null;\n+  \n+    if (nextProps.dangerouslySetInnerHTML && nextProps.dangerouslySetInnerHTML.__html) {\n+      // DOM node will have already been modified in _updateDomProperties\n+      // return so we avoid treating it as removed.\n+      return;\n+    }\n // Note the use of `!=` which checks for null or undefined.\n\n```\nTests pass, but seems like a hack. I don't feel in any way qualified to compare this vs @spicyj's fix.\n. @spicyj Makes sense, thanks for the explanation.\n. @chenglou Nice, I hadn't seen that page before. It might be a good idea to move it into the \"Guides\" section, where newcomers are more likely to find it, rather than the end of the Reference section. \n. Technically it's React itself, not the JSX transform, that requires the style property to be an object. See for example: http://jsfiddle.net/hqV8Y/4/\nIn any case, I got tripped up by this same issue when first getting started with React...\n. ",
    "danielmiladinov": "@spicyj, I understand the recommendation, and that's fine for doing something like running jshint as part of a CI build step or what have you.\nMy particular flow is that I use IntelliJ/Webstorm's JSHint plugin to automatically highlight linter errors before I've even checked my code in, let alone kicked off a build. I have found it very handy to have that immediate feedback. Since switching to react, my only regret was seeing the linter barf on the first line of JSX in my javascript files.\nHaving to comment out my JSX to see if the rest of my code lints was enough of a drag that it motivated me to work on this patch.\n. It's not my plugin, it's built into intellij/webstorm/phpstorm. \nNot a separate plugin, but actually integrated into the javascript editor.\nIn the settings here's nothing to tweak on it except a version drop-down, which apparently just reads package.json from the jshint site, and you can specify a path to your .jshintrc file, if you have one.\nEdit:\nSo, the sooner my patch gets accepted and a new version released, the sooner I can start using my new feature right inside my IDE. :)\n. @CircleCode, I agree, that would be an awesome feature! However, it's orthogonal to the question of linting in general, and their JSHint plugin in particular.\nAll their JSHint plugin does is \"shell out\", (not to make too much light of it; I'm so grateful for it) to whatever version of JSHint you've downloaded (it's configurable in the options), and puts the relevant error messages with red squigglies on the relevant line numbers in your editor. (You see what the error was when you mouse over the squigglies, very handy)\nTheir editor is already pretty good at inferring that you're using some kind of xml literal right in the middle of your javascript. It doesn't understand the notion of \"valid-for-jsx\" xml, but it already goes a long way to ensuring your jsx is at least well-formed xml: that is, unless you put your jsx expression inside parentheses, with a single root tag, and every starting tag is either self-closing or has a corresponding close tag, the rest of your javascript syntax coloring just goes completely crazy, indicating that you're doing something very wrong ;)\nAll it's missing is the convention of valid jsx, i.e., that tag names correspond either to \"global\" React.DOM components or your own custom components (which must then be visible in the current scope) and that attribute names correspond to component prop names and that attribute values correspond to expressions containing variables from the current scope. But I'm beginning to describe how the JSX Transform works, aren't I?\n. ",
    "CircleCode": "@danielmiladinov as far as I understand it, the better approach for jetBrains would be to have a plugin specifically targetting jsx syntax. Since their ide allows the use of \"language injections\".\nsee feature request: http://youtrack.jetbrains.com/issue/WI-21217\n. ",
    "mathieumg": "@zpao Done! :)\n. Basically you want me to wrap it with if (propValue.hasOwnProperty(key)) for each iteration?\n. My editor was wrapping lines and I wanted to make sure I was below 80 cols. Will fix it!\n. I don't mind adding it to be on the \"safe side\", especially if it's already the approach. Prop validation is dev-only anyway so that's negligible overhead.\n. passes in the current value?\n. GitHub seems to choke on the ', perhaps avoid it by using Name of the giraffe?\n. Good point, it didn't occur to me this would be on the website in the end.\n. ",
    "leebyron": "I think it affects modern iOS browsers as well.\n. style=\"cursor:pointer\" also fixes this :)\n. this should probably be flowed through as a 2nd arg to this.replaceState, another function accessible by client code and where the ultimate work of generalizing this will go.\n. Only in VMs supporting the ES6 feature, which are pretty limited right now, but will grow soon. (Chrome canary has it turned on by default). In all other VMs, it's Undefined. \n. This is really just a defensive safety check for bad iterators. By the spec, entry should always be a [k, v] tuple unless done is true, however I don't want React reconciliation to die if someone passes in a shitty non compliant entries iterator. \nSince this check is cheap, I figured it was better to err on defensive. \n. Fair enough. I'll do that. \n. Yep, will do\n. No, because if the iterable is not returning entries then its returning any value, and traverseAllChildren will do the right thing with it. The value iteration below should mirror the Array loop above. \n. A couple reasons I think this is safe.\n1) The Array.isArray() happens before this, so I'm not sure Array.prototype.entries is a concern here.\n2) ES6 does add Array.prototype.entries and it would behave correctly if for whatever reason we removed the Array.isArray check above for ES6 browsers.\n```\n\na = [1,2,3]\n[1, 2, 3]\na[Symbol.iterator] === a.entries\nfalse\naSymbol.iterator.next()\nObject {value: 1, done: false}\n```\n\n3) I have no other ideas for differentiating entry iterators of [k,v] tuples from iterators where the values happen to be arrays.\nExample:\n```\n\na = [[div,div],[div,div]]\n[Array[2], Array[2]]\naSymbol.iterator.next()\nObject {value: Array[2], done: false}\n```\n\nvs Map:\n```\n\nm = new Map([['foo', div], ['bar', div]])\nMap {\"foo\" => \"div\", \"bar\" => \"div\"}\nm[Symbol.iterator] === m.entries\ntrue\nmSymbol.iterator.next()\nObject {value: Array[2], done: false}\n``\n. I'm wrong below. No warning because it doesn't hit that code path. This is a unit test oftraverseAllChildren` which is self-contained. The warning is in ReactElementValidator, not a dependency here.\n. Note that this may break some use cases people have when using Map / OrderedMap with v13-beta/master. Nothing wrong with that, but something people need to be aware of.\n\nSince Maps are iterable, and they yield [key, value] tuples, you'll start to see your Map keys showing up in the UI.\nNo clear fix with ES6 Map, unfortunately (not that anyone is using them in this way), but for Immutable.js Map you'll need to call .toIndexedSeq().map() instead of just .map() with the current behavior.\n. I foresee more of this pattern in the future since ReactFragment.create() is a little verbose. Maybe package this as React.addons.frag?\n. This test fails with:\n<header>Amy</header><footer>Bob</footer>\n. Any reason why these aren't just return renderer.read(Infinity)?. could also replace these two lines with this.destroy(). ",
    "rboyce": "* {cursor: pointer;} is the least offensive way to do this, IMO\n. * {cursor: pointer;} is the least offensive way to do this, IMO\n. ",
    "kirbysayshi": "Sorry to bump an old issue, but is there any chance this will be exposed? I'd like to use a jsx template like:\nhtml\n<div dataCustomUri=\"{this.props.uri}\"></div>\nAnd then use it for event delegation later:\njs\ndelegate(document, '[data-custom-uri]', function(e) { ... });\nBut right now react ignores all data-*, which would be pretty easily fixed with the ability to add in a custom DOMPropertyConfig.\n. You are correct! It looks like I had extra \" around the value...\ndata-custom-uri=\"{this.props.uri}\"\nvs\ndata-custom-uri={this.props.uri}\nSorry to bother.\n. ",
    "fabiomcosta": "I agree this should be available and documented.\n. @SanderSpies it seems like this PR is outdated and is causing some simple merge conflicts (getDocblock is now utils. getDocblock).\nAlso please use ' instead of \" as React's styleguide points out: https://github.com/facebook/react/blob/master/CONTRIBUTING.md#coding-style\n. Seems like this is ready to be merged\n. lgtm :+1:\n. Please don't merge this yet, I'm thinking about improving this patch. I'll let you know when its fine.\n. We can't show a very long line (80 chars) because the bottom arrow (^) could be pointing to the wrong place since the line will be wrapped if the console width isn't long enough.\nFor example:\n<div id={} style={{overflow: 'scroll', width: '100px'}} onScroll={this.scroll}\nclass=\"some class\">\n            ^\n. @jeffmo merged it.\nThx for helping.\n. this could be simplified to return object.type === Syntax.XJSElement && (jsx == null || jsx === 'React.DOM');\n. this could be simplified to return object.type === Syntax.VariableDeclarator && (!jsx || jsx === 'React.DOM');\n. Sorry, I believe that from this comment of @jeffmo https://github.com/facebook/react/pull/364#issuecomment-25477516 he actually meant return object.type === Syntax.XJSElement && (!jsx || jsx === 'React.DOM');\n. This is already pointing the line number with e.lineNumber. Is this what you are asking for?\n. Oh I see... but I'm not sure if we wanna do that... pointing to the file's erroneous line is good enough.\nAlso, as you can see from my screenshots, on Firefox and Chrome when you click on the file link it opens the file highlighting the erroneous line. Haven't tested on the other browsers but this should be good enough for development.\n. No line number will be shown for inline code, just when it comes from a file.\nOn inline code there is no source and it will just say that its coming from the current document (location.href).\nI'm talking about the updated code, so lets try to discuss on the the new code.\nThank you for reviewing!\n. @spicyj are we in sync or am I missing something?\n. @spicyj I'll improve the error message for inline code, thank you.\nJust to be clear, I already understood what you just said, the current patch doesn't show an incorrect line number. For inline code source will be undefined and the message will only say that the error is in the current document.\nRight now it shows:\nUncaught Error: Parse Error: Line 2: XJS attributes must only be assigned a non-empty expression\n  at test.html\nI'll improve it, thank you for pushing the improvement.\n. It gets a fixed number of characters, with the addition of the minus sign it got removed from the output\n. I'll try moving it up.\n. ",
    "sverrejoh": "@zpao I'm sure the custom DOM nodes can be imported into the local scope, so when JSX converts them (like it does with React components), it will just work.\nIn addition to SVG tags (which can all be supported by React eventually) there is also custom tags needed by legacy code, or proprietary systems.  This is tags that will never be a part of React, and the only obvious alternative now (beside patching React) is to use dangerouslySetInnerHTML, which is a little tedious.\nSo I'd be all for having a clean way to expand the supported DOM nodes with something like createDOMComponent.\n. Yes! I missed that and just updated it. Thank you!\n. ",
    "piranha": "I would like to see setState accept both variants (either an object or a key with a value), it could look like that then:\n```\n  setState: function(key, value, callback) {\n    var partialState;\n    if (typeof key === 'string') { // {string, anything, fn}\n        partialState = {};\n        partialState[key] = value;\n    } else { // {object, fn}\n        partialState = key;\n        callback = value;\n    }\n// Merge with `_pendingState` if it exists, otherwise with existing state.\nthis.replaceState(\n  merge(this._pendingState || this.state, partialState),\n  callback\n);\n\n},\n```\nI don't know if that (having two sets of arguments in a function) is acceptable style for React, but it is definitely used quite a bit in JS world. If that's acceptable, then another problem arises - how do I document that so that it renders nicely in documentation?\n. I would like to see setState accept both variants (either an object or a key with a value), it could look like that then:\n```\n  setState: function(key, value, callback) {\n    var partialState;\n    if (typeof key === 'string') { // {string, anything, fn}\n        partialState = {};\n        partialState[key] = value;\n    } else { // {object, fn}\n        partialState = key;\n        callback = value;\n    }\n// Merge with `_pendingState` if it exists, otherwise with existing state.\nthis.replaceState(\n  merge(this._pendingState || this.state, partialState),\n  callback\n);\n\n},\n```\nI don't know if that (having two sets of arguments in a function) is acceptable style for React, but it is definitely used quite a bit in JS world. If that's acceptable, then another problem arises - how do I document that so that it renders nicely in documentation?\n. Well for me main concern was discoverability of those special cases. Right now compiler just silently eats 'for' and says nothing at all. And while this is more or less acceptable for other properties, React declares that it passes all HTML attributes. This note about className and htmlFor is not exactly easy to discover, so I think having warnings for them is very important for first-time users.\n. a = {for: 1}; a.for also works absolutely fine. So I also vote for not renaming stuff at all.\n. a = {for: 1}; a.for also works absolutely fine. So I also vote for not renaming stuff at all.\n. @zpao @jeffmo @jordwalke @petehunt  so what's the decision? Will we have 'class' or is it going to be a className? :-)\n. @zpao @jeffmo @jordwalke @petehunt  so what's the decision? Will we have 'class' or is it going to be a className? :-)\n. Thank you for reminding me about this pull request, I remembered that I promised to write tests for it and got distracted. :-) I'm not sure about API, but this looks like Backbone's Model.set function right now.\n. Thank you for reminding me about this pull request, I remembered that I promised to write tests for it and got distracted. :-) I'm not sure about API, but this looks like Backbone's Model.set function right now.\n. I use it in FormMixin:\nexports.FormMixin =\n    inputChange: (e) ->\n        obj = {}\n        obj[e.target.name] = e.target.value\n        @setState(obj)\nJust thought that in Backbone that was easier. But you are right, that would break compatibility with closure compiler; even in my case it would be better to have a mapping or something...\n. As I think about it more it's better not to have this. :-) linkState from new react removes my need, and I would love to see React working with Closure Compiler advanced mode.\n. As I think about it more it's better not to have this. :-) linkState from new react removes my need, and I would love to see React working with Closure Compiler advanced mode.\n. I agree with @andreypopp, class could accept either a string or an object in that format, that would be useful. Just for the reference, Angular's ng-class does exactly that.\n. :+1: please do this :)\n. I'm not really sure how to reproduce this - it certainly is happening on a bigger app (~900 lines of clojurescript), but on small example from piranha/pump minified React works flawlessly. Any ideas how can I trigger this part of functionality?\n. Yeah, that's it, namesToPlugins contains full names and EventPluginOrder contains minified names. But what's the best way to go around this problem? I have never written code for advanced mode by hand. :)\n. Yes, thanks, just figured this one 3 minutes ago and now testing. :)\n. Ok, thanks, you were right, but I've hit more problems, fighting with them now. :)\n. Oh damn it's hard to research what's failing. Somehow .createClass (which is renamed to something like .ra) is not assigned to React (which was renamed to mg, but who cares)...\n. Please check http://piranha.github.io/pump/ for an example of how it fails - it was compiled with extern, so it's a bit easier to read (at least some names are saved). Not sure why it's being assigned properly... :\\\n. Ok, to me the problems seems to be a conflict between browserify and gcc advanced mode. Not sure how to fix that. :\\\n. I've combined React in a single file using Closure Compiler CommonJS support, and now there is another problem. It initially runs but fails then on first action, which you can check here. Not sure how to proceed... :\\\n. You need to install leinigen - easiest way is to download lein script in ~/bin, and then just run it, it will download jar file with leiningen and you're good to go. You need JRE (java on command line should work) for this to work.\nAfter that clone pump and run make js there, it should start autocompiling server - after a few (5-15) seconds it should be done (after that it should be much faster). Recompilation is triggered only by cljs files, so if you've changed gcc-react.js, for example, just touch src/pump.cljs and it will recompile.\nIf you want to build gcc-react.js, you will need to fix paths and install few apps - check inside of a Makefile.\nI hope I have not missed anything. :)\nThanks!\n. Ah damn, that's my fault (I did wrong thing in Makefile), I've fixed that and updated it.\n. I haven't tried with react-page yet...\n. Ah no, that was only my mistake in demonstration, please open http://piranha.github.io/pump/ and try sending anything, it gives an error which is hard to understand.\nBtw, is there any better way to getting to source of errors in React except for commenting out all try/catches?\n. Yes, I'm not using GCC advanced right now. I've updated code and now error is more understandable. Problem is that in Danger.js there is a check invariant(resultList.length === markupList.length); and they are different. I don't understand from code how can they be the same if markupList.length is not 0? I mean I don't see where resultList is populated. But it somehow works if browserify is used to gather modules and does not if GCC is used.\n. Just to get this issue up to date from IRC: I somehow ended up with broken build/modules/Danger.js, removing everything and building from scratch helped. I don't have advancely-minified version working yet, but that's something to do with how cljsbuild gets their :foreign-libs plus how Closure modules work. I'll do a bit of research and post an update here.\n. @jordwalke nope, one of ClojureScript's main guarantees is that JS code it emits is compatible with advanced mode - in other case it would be just too big to be usable (my ~1k lines app is around 900k without react). \nBut then things are still moving. I found out that CLJS compiler, when you point it to external Closure-compatible library (and you can convert commonjs to that format) expects you to have one file per module, while I had complete React in a single file. So I plan to have it separated and then see what's wrong there. \nThere is an issue that .createClass et al do not get assigned to React variable (or whatever it gets renamed to), but I hope it is a small problem and can be fixed easily.\n. It's actually absolutely empty right now. :) But anyway, to understand something, I need to set up source maps and stuff, and I won't have time until evening.\n. Well, the only one I had was that tags were renamed, but this is possible to mitigate with externs. I need to somehow package that and publish it or even contribute a 'gcc build' step to React (not sure if you want it and if so then how to do it).\n. Externs are for the case when you're compiling library for external consumer, but when you're compiling it together with application you want to live without them. Plus they didn't work for me when I compiled them together, haha. :)\n. But then you'll have to require that people which are not using JSX to write in the same way... I was planning to use React from ClojureScript and import functions just as functions. I could have a simple wrappers for them, of course, not a big deal, but I think that having method name and tag name separately is not bad. :) Plus it's not making code that much bigger it seems to me...\nThough yeah, I shivered a bit because of non-DRYness of code, but managed to convince myself it's ok by using method name/tag name argument. :)\n. Thanks, I know about them and used them, but that is something I would love to live without. :)\n. Well yeah, it's called 'externs', I guess it could be used, I'm just not sure if that is a good solution to a problem.\n. Well biggest problem with externs is that they will have to be specified in every project which depends on React. I wonder if it's possible to annotate code somehow so that Closure Compiler won't rename keys of this particular object...\n. Do you use externs?\n. That's exactly what I would like to not do. Externs serve for libraries included from elsewhere and I would like to compile React together with my application so that Closure Compiler can perform proper dead code elimination.\n. It surely emits quite a bit of warnings, but nothing serious and it works, if compiled like that:\nhttps://github.com/piranha/pump/blob/master/Makefile#L32\nIt's not only about size for me, but also a bit about convenience...\n. Anyway, this pull request is not relevant anymore, plus pump needs to be changed to leverage advanced-compiled React (and focus shifts to om anyway, which works with React a bit differently).\n. Oh, I'm sorry. :\\\n. Just in case - I gave both talks, so I thought it would be ok for me to ask about replacing one with another. :)\n. It's more or less \"use React or somebody will come for your soul\". :)\n. Yeah, I can return false, but that's more or less the same as calling .preventDefault(). What if I don't want to prevent an event? Should I get two calls of the same handler?\n. Ok, so I fixed it for myself the hard way - if taps are enabled then don't react to clicks.\nAnd I check for taps like that:\nReact.initializeTouchEvents(('ontouchstart' in window) ||\n         window.DocumentTouch && document instanceof DocumentTouch);\nThat of course rules out laptops with touch screens, and is not working very good on IE10, but I can live with it for now.\n. Yeah, we're doing onTap={...} everywhere.\n. Wow, that's certainly much better, I just needed a really quick fix and couldn't come up with better idea. Your patch seems a good one, though I think it makes sense decreasing threshold to, say, 350ms. IIRC 300ms is a delay between a tap and an emulated click event.\n. ",
    "hugo": "Sorry for the delay in getting around to this - now signed.\n. ",
    "jlfwong": "Sure thing - done.\n. ",
    "hrach": "I have experienced this too :) So keep digging :-) :+1: \n. ",
    "jtmalinowski": "Yeah, I signed the CLA.\nI would go for how it's done in ember, so react-source could be left as it is, and we could nearly just copy ember-rails and rename a few things. \nI'm not sure what you mean by discrepancies, you probably meant main.js instead of bin/jsx right? Because bin/jsx does not export anything. And you're right here, load and run should not be exported when window/document is not available. If I understand it right here, I'll fix it. Anything beside this?\nIn case of trying to fit react-rails into here, we would need to the whole vendor/, I'm not sure if it makes sense. Any reason not to go the Ember way?\n. @vjeux  @zpao what do you think about https://github.com/jakubmal/esprima/tree/namespaced-jsx-tags I based it on commit a3e0ea3979eb8d54d8bfade220c272903f928b1e in facebook/esprima, because there is a lot of new commits in a3e0eea...master, so we either need to make a branch in facebook/esprima, or update version of esprima used in react.\n@vjeux  as you said on irc, the fix is really a one-liner, maybe guys from facebook/esprima will want to have more tests on this, but apart from that, really easy.\n. Alright! I started watching your repo @zpao !\n. Awesome! Really looking forward, soon I'll be ready to use it in my own apps :+1: , as I said, I would be happy to start helping this weekend.\nSo if anything will still be on todo, count me in.\n. I'm not sure this is the right branch, we would love to see this as 0.4.2 possibly.\nAnd BTW, how come there are phantom tests and they have never shown this as a failure? \n. I'm still confused, I reproduced this using latest release (1.9.2) from http://phantomjs.org/download.html, but in package.json at 0.4-stable I have:\n\"devDependencies\": {\n    ...\n    \"phantomjs\": \">= 1.9.0\",\n    ...\n  },\nLiberal as it is, I think this would allow any latest version, including even major releases, perhaps there is another file, not package.json in the root of the project? I also couldn't find package.js, but I think that's a typo.\n. ",
    "chenglou": "Update: I'll be porting the todomvc example submitted to the actual project to 0.4. Once that's done, we can use that version instead, unless you guys find the example too heavy.\n. Thanks for the mention @vjeux! By the way, it's noResultsText, typo was in the old version from me.\n. @jordwalke also suggested setStateSync, similar to node.\n. it's just one line I think, I'm on it\n. #258 \nfixed\n. (Confirmed for second case)\nIn my case I'm fine with assigning keys. In fact, that's what I did as a temporary/permanent solution.\nBut I'm not so sure if we should shove that into fixing with key, conceptually speaking. I think most people's impression (including mine) is that assigning keys fixes that natural problem of keeping components around when it's obvious that a change of children count/order in the next render squashes them (e.g. search results, as mentioned in the docs).\n~~In this case, the behavior across similar components on the same render differs, It's unpredictable and leaves the impression that it's a quirk of the framework (that just happens to be solvable elegantly using another concept). Overriding an input text but not an input checkbox can never be an intended behavior.~~ Never mind, let's just say it's nice to have better consistent behavior =).\n. Argh you're right for defaultChecked, sorry. I didn't bother looking into it further because (ahem #250) select has a bug that neglects defaultValue in the second case.\n. here are the tests. I combined two checks into one (checking nothing changes, and checking for the specific bug in this issue). Not sure if it's a good idea.\n. The argument for this is that this fits well into the way lots of other libraries work (e.g. backbone), and frankly I did make the mistake several time at the beginning of using the above format. the argument (more or less) against this is that we could simply put a check and a warning message.\n. This one came first though. \n. Fixed with #360 \n. Firefox doesn't fire it upon clicking the select itself (not the options) to dismiss though.\nJust tested on windows and at least IE and chrome have the totally correct behavior. The thing is, select is an OS thing. Firefox got it mostly right because they implemented their own select, while Chrome uses whatever dropdown the OS uses.\nI tried onMouseUp to patch some behaviors but some stuff just can't be achieved for the reason above.\nso @zpao: not sure if this will ever work consistently.\n. Saw people mention wiki in IRC. How valid is it to put cookbook entries in wiki and then parse it into jekyll?\n. The wiki's already in markdown, how about checking in that page?\n. Result of discussion on IRC: wiki is a temp place to organize stuff and claim cookbook entries to write. Actual entries are checked in as md for offline reading and such. @mcsheffrey the Jekyll entries can be taken from these mds. \n. @cbrake the use of class is now deprecated, check #328. There's a discussion on google groups also: https://groups.google.com/forum/#!topic/reactjs/xovHWHGHPCA\n. Crazy suggestion: https://github.com/erichocean/blossom\nPage rendering using canvas.\n. 1. If we settled on calling it \"tips\" I'm fine with that.\n2. Fixed in a new PR!\n3. Ehh... ellipsis? Maybe not the greatest idea. Changing the spacing would be fine.\n4. The numbers do indeed help us for keeping tips in order, but I'm not sure how much they help beside that.\n5. Whatever we do now is a temp solution; collapsing still won't be enough in the future. I'll discuss more with @mcsheffrey.\n. It's already documented in the Dom Differences section.\n. If this helps, this is will be an entry to the upcoming cookbook we're making:\nhttps://github.com/mcsheffrey/react/tree/feat-documentation-cookbook/docs/cookbook\nThose are small snippets of React tips that you can browse through in a few minutes. Small documentations that might be missed. Roadmap (here)[https://github.com/facebook/react/wiki/Cookbooks].\n. ^ Done.\nBtw, just noticed that Custom HTML Attributes is in JSX gotchas as well. Shouldn't they be in DOM Differences also?\n. Will do the block quote. How's this? \"For DOM differences, such as the inline style attribute, check here.\"\nAnything else?\n. #461 \n. @thauburger edit: there's an internal diff coming up for making onClick work without the delay.\n. In!\n. @zpao do you need the docs soon? Exams over next week only.\n. @zpao added the Note. Screwed up the other commit so submitting a new one here.\n. Gimme a little bit longer, I really don't like some phrasing right now (and the title doesn't make sense anymore)\n. @steida can you specify what's broken?\n. Yeah, that's the intended behavior. See here.\nThe thing is that the array format is often used in this situation:\n// in `render`\nvar items = this.props.items.map(function(item) {return <li>{item}</li>});\nreturn <ul>{items}</ul>;\nwhere you often want to pass a key to persist li across renders.\n. Scratch what I said! I meant legit as in \"it works\".\n. Yeah the px addition is funny. It's been pretty handy though.\nWould your problem be solved with something like margin: interpolate('%spx %spx', 10, 20);?\n. To continue the discussion: personally I'm more for returning the array. Right now it returns the first level of components (i.e. the parent's direct children) and I've found it useful in the past to retrieve the length for some computation. flattenChildren returns every child in a flat array; I feel that how the children organize themselves internally should be an implementation detail and shouldn't be leaked to parent through flattenChildren; plus, accessing props.children avoids the speed and conceptual overhead of a new API, since all wrapper components already use {this.props.children}. Though there might be a use for retrieving flattened components that I might not have thought of. @vjeux might have more to say on this.\n. Eh, I guess... personally I dont feel API like onlyChild solve the problem. Sure, now we have an explicit way of retrieving the child, if we know that there's only one. But the point is we often don't.\nI'm more or less ok with the API but I'll close this if @swannodette is fine with it. \n. ok, just updated it setState so that it warns on undefined/null/empty object passed. How's that?\n. thanks!\n. \"align\" is deprecated and React's policy is not to support deprecated attributes. Not sure about bgColor though\n. :+1: \n. 71b585325ce7abc149fe848bb3fe119488ad8c3e\n. Right. I think @zpao wants to delay this a bit though?\n. 4f53f587544a290dd20926700eba87e375ff06c6\n. Will submit another one with a better fix.\n. Thanks, can you also add them to ReactMultiChild-test and Danger-test? Dunno if there are others.\n. =D\n. @syranide ah, true. Updated. Thanks!\n. Seems like you misunderstood how unmountComponentAtNode works. First, this._rootNodeID is an internal identifier used for data-reactid. unmountComponentAtNode asks for a DOM element so giving it a string doesn't do anything. Second, just as the docs stated, you pass the container node on which you mounted the React component. So if I did\nReact.renderComponent(<App />, document.getElementById('abc'));\nthen I'd do, on the container\nReact.unmountComponentAtNode(document.getElementById('abc'));\nSo really simple (and don't play with this._rootNodeID). Either re-select that element or keep a reference to it.\n. this.getDOMNode() gives you the DOM node that is the component, but like I said, you need to call unmount on the wrapper, not on the element component itself.\nThat aside, like plievone said, generally you shouldn't be unmounting stuff this way. Here's an example that might be better suited for your situation:\n```\n/*\n * @jsx React.DOM\n /\nvar App = React.createClass({\n  getInitialState: function() {\n    return {displayMessage: true};\n  },\nhandleClick: function () {\n    this.setState({displayMessage: false});\n  },\nrender: function() {\n    var message;\n    if (this.state.displayMessage) {\n      message = Hi;\n    }\n    return {message};\n  }\n});\nReact.renderComponent(, whateverWrapper);\n```\nUse unmountComponentAtNode sparingly. The \"React way\" of doing this is to render whatever you have based on a component's props and state at each render, and not arbitrary modify them, since everything's harder to track otherwise.\n. Make the parent hide you, instead of trying to hide yourself. this.getDOMNode() gives you the DOM object.\n. @plievone yeah that's right. I think the rationale is that animations are not desired during the first render, as you might want to directly display all the items. This way is more flexible as you can just manually call whatever animation api if you want on mount.\n. Yeah. I put it back.\n. @cpojer right, done #1087.\n. ^ Agreed. I think these are far more common.\n(You guys want at least a tip entry? lol)\n. The internal diff fixes this.\n. @petehunt \n. It won't be too drastic, as the example-apps page was added this month only.\n. @cpojer \nEdit: nvm.\n. @akre54 that's what #1224 is for\n. Should this be in TodoMVC or in the React example folder? Because we just removed those 2 todos.\n. Done. Also, ReactCSSTransitionGroup was included twice, lol.\n. I like Give It Five Minute too, except it's repeated in the header and in the sentence. I thought about directly putting the link in the header but I wasn't sure how that'd look, what do you think?\nAs for the rest, I'll change it right away.\n. sorry, careless copy paste\n. ew lol, sorry about that\n. I'll take it integrally.\n. Although it's been an extremely interesting read for me, I also agree with zpao that it's maybe a bit too much and kills the magic. It's super good code doc though and it'd be nice to keep it, somewhere.\n. The reference section is still a reading section for React users though. This might not fit well.\n. isn't name deprecated? https://developer.mozilla.org/en-US/docs/Web/HTML/Element/a\n. the current version generates\ncss\n.documentationContent a :hover {\n  text-decoration: underline;\n}\nYours is:\ncss\n.documentationContent a:hover {\n  text-decoration: underline;\n}\nWhich means for & to work I need to add color: $darkTextColor; to the &:hover too. Which one do you prefer?\nEdit: I think @spicyj is right, in that case I'll change it.\n. Fixed in a new PR.\n. Fixed in a new PR.\n. Fixed in a new PR.\n. Fixed in a new PR.\n. Fixed in a new PR.\n. Fixed in a new PR.\n. I based this on var ReactTransitionGroup = React.addons.TransitionGroup from Animation. The other excuse is that using React.addons.classSet({ directly exceeds 80 chars so I'd have to break it into lines.\n. At the beginning it was just \"ReactLink\" but I found it wasn't too descriptive. Then \"Two-way Binding\" but seeing the popularity of the concept I felt it was extremely misleading, especially on an \"Add-ons\" category, as if it didn't work well with React and was added as an afterthought for the sake of.\n. There are subsections on the left nav though?\n. That sounds way better, will do.\n. Seeing that there needs to be an explanation for cx to make sense Im not so sure...\nDoes var classString = React.addons.classSet({... work then? We can leave the shortcutting to the dev.\n. How about just \"For an uncontrolled component...\"?\n. right, thx.\n. done!\n. I'll just take your wording sentence lol\n. done\n. Yeah, though my preference is to keep the entry simple and not make newcomers wonder about too many things at the time. But I guess this isn't too much of an overhead.\n. right, thanks \n. for empty setState() after you mutate the state. Not the best practice ever though\n. ah, right about Moz and O. ms is still ms.\n. K. What about the other places in this test?\n. Yeah, I'm only doing this because https://github.com/facebook/react/pull/994/files#diff-0ed61a23c3a177ab0a374053a0d7821eR169\nI have the ReactServerRenderingTransaction locally. It's the same as this file. Just wanted to see if this makes sense before amending.\n. Might be a useless concern, but what if renderComponentToStringBla is called from client-side for whatever reason?\n. yep!\n. Doesn't make sense. Will remove.\n. Tested and it doesn't error for IE8. Should I still add it?\n. Yep.\n. I think mine? The fact that you can't operate on the old set of children anymore... not sure how I feel about childFactory though\n. Good point! Fixed, thanks.\n. :+1: \n. Done.\n. done.\n. Yeah. For the parallel with render. Also I need newcomers using renderComponent a lot so doesn't hurt to make it work. \n. Deleted.\n. Ugh sry, done.\n. _checkPropTypes is only used in DEV if you check the call sites\n. :+1:\n. How's it now?\n. @spicyj \nI actually don't know. Every browser returns 'object' (even ie8). Except ~~phantom~~ android.\n. Done!\n. Used to be a single update callback, but then you'd have to put if (... === undefined) in some places, so I made the differ do it instead, which makes sense imo.\nAnd yeah, that's a better formulation. Thanks\n. It doesn't. At least, tests pass fine without that assignment.\n. :+1: \n. Nope, the key being passed would be the index, not the final key assigned to the child. @sebmarkbage \n. I changed that to \"for some reason\" so that I at least don't mislead people. There are at least two bugs involved here, one from TransitionGroup (related: #1959) and one from phantom/jasmine/whatever.\n. I think we prefer having it inside beforeEach to avoid some caching problems that I forgot.\n. Good point.\n. Should it also include === true? For handler() {return bla.shouldReturnFalse;}\n. Sorry, missed this: internally, this is a different function that logs the message. You'd pass a second parameter, which is an object that contains all you need to know to trace back to this function so that people can act upon it:\nmonitorCodeUse('react_event_return_false', {eventHandlerName: listener.__reactBoundMethod.displayName});\nAnd maybe some other info, dunno. See #2052\n. Right, and we don't actually bother tracking these two down. These are only to give an idea of the usage pattern internally.\n. @crm416 ugh sorry, I derped. This is better as (listener.__reactBoundContext && listener.__reactBoundContext.constructor.displayName) || '<<anonymous>>'. It makes more sense to go find the displayName this way, than to look for it on the handler, since the handler can come from a mixin (in which case the method's displayName is kinda useless no matter how we do it).\nSo if you change this line to that, it won't depend on the other PR anymore, and I can pull this in.\n. Two spaces please!\n. }, this);\n. My bad. Also, would a component name be enough? I guess it is?\n. There's a warning module (similar to invariant. Use that one instead.\n. This seems a bit arbitrary though?\n. It was, because that was the only use-case (neglecting html-jsx). I'm saying that I don't think we should have a (albeit convenient) default here; rather, isRequired, then pass either \"Live JSX Editor\" or \"Live HTML Editor\". But this is really insignificant lol. I'll let someone merge this =)\n. I'll wait til you publish the new version on npm then?\n. Can you change this to onClick?\n. Fixed.\n. Agree with @zpao. Not sure about the new ternary below. I feel like an if is fine.\n. Sure. Ping me.\n. Done.\n. Done!\n. Nice catch, corrected, thanks.\n. ",
    "gasi": "@zpao Thanks. Opened a new pull request: #241.\n. @zpao Cool, I knew about git commit --amend and git push -f but wasn\u2019t sure if GitHub would pick it up. Now I know ;)\n. :+1: Removed CHANGELOG entry.\n. :+1: Will do.\n. I thought about that but then saw that other files did it like this: https://github.com/facebook/react/blob/94fd726f86a36cb682d9680a67df544a0a889e53/src/browser/ui/dom/components/tests/ReactDOMInput-test.js#L24-L36\nSeems like only the modules/functions under test are put in beforeEach. Either way, let me know which one you prefer.\n. Same here: https://github.com/gasi/react/blob/e75de68c029bacadacba6b8e14a4eb141bfcb3ea/src/browser/ui/dom/components/tests/ReactDOMTextarea-test.js#L22-L35\n. :+1: to better message. Should I use ReactChildren (internal) or React.Children (external) name?\n. As a dev, I\u2019d expect the external name. Just double checking.\n. And\u2026 no need to apologize :wink: I am glad you\u2019re keeping a high bar for the quality of this project :+1: \n. @spicyj Correct, this test reflects the edge case I ran into when forgetting to pass in children. Suggestions for a better test name?\n. How about should ensure callback argument is a function?\n. Frankly, I would like to also check that the first argument (children) is not a function, but then we\u2019d get into overzealous argument checking.\n. :+1: for Array.some :smile: \n. :+1: Will revisit the code then.\n. ",
    "andreypopp": "I use regular functions for this with dependencies from props or state\n```\nfullName: function() {\n    var firstName = this.props.firstName;\n    var lastName = this.props.lastName;\nreturn firstName + ' ' + lastName;\n\n}\n```\nwhen props or state changes fullName reevaluated if it's called from render() and UI is updated.\n. > Is your thinking that add/removeEventListener would work on the top level component returned from render? Or all events of that type that occur for any component inside this one? \nI expect the same behaviour as if you attached event handler via a corresponding property \u2014 in this specific case via onClick property. If event bubbles then I'll be able to observe events of this types which occur for any component inside the specified component.\n\nYou're jQuery code targets specific <a>s. Would you want the machinery to do that in React as well?\n\nThat's interesting question. I guess I'll need to go through event bubbling path with my code and check if it contains an anchor \u2014 I think that's how jQuery implements it, am I right? Not sure though if React should do that for me.\n. +1 on that, just encountered a case for that\n\nWe talked once about adding maybe a onWindowResize event that fires on every component, but how would it bubble?\n\nIf it fires on every component does it makes sense for it to bubble?\n. it seems GC works for me in Chrome 30\n\n. > Feel free to depend on http://petehunt.net/react/react-0.5.1.tar.gz and require('react'). The advantage of this package is that if you build with NODE_ENV='production' you'll get runtime checks stripped.\ndone\n. first time browserifying is somehow slow for me \u2014 around 3500ms, probably due to envify :-(\n. ignore my previous comment, I included both react and react-tools by mistake\n. +1 for es6 transforms w/o flag but undocumented for some time\nThough some blog posts could note about the possibility of this so people will start using jsx utility just to get es6 goodies and then they are just a one step from using JSX syntax :-)\n. @petehunt that sounds like a limitation of wzrd.in which I think one can request them to fix.\n@zpao I wish npm has the ability to host just a single js file as a package with inline metadata (like @author and so on)\n. @zpao remove it!\n. I think code above works without the patch?\n. Style property names must be cameCased \u2014 {backgroundImage: gradient}.\n. Ok, fixed that.\n. Maybe there's a better way to test if we can get a reference to a component by a DOM node?\n. That wil introduce circular dependeny between new module and ReactMount. I think I can factor out getID, setID and purgeID functions into a separate module to mitigate that... what would be the best name for this module? ReactNodeCache?\n. Nope, it's not so easy as I thought \u2014 too much coupling with ReactMount internals. Can we export getReactRootID for use in tests?\n. I mean export via ReactMount.getReactRootID.\n. Can we use Node.DOCUMENT_NODE for that or it's not standardised?\n. return classes.filter(Boolean).join(' ') ?\n. I hope escape analysis (does it already work in modern js engines?) would help to eliminate array allocation...\n. I think opts is default to {}.\n. I see, forEach breaks it by passing index as second arg.\n. There's Element.shadowRoot per spec http://www.w3.org/TR/shadow-dom/#api-partial-element-shadow-root, can it be used instead?\n. Why not just use Node.ELEMENT_NODE and the likes? Probably all the places where you want to check for nodeType already access DOM so it should be safe? See https://github.com/facebook/react/pull/423/files#r7112182 for the previous discussion on the matter\n. @syranide right... IE8...\n. Moved.\n. Constructor is missing props arg\n. @jimfb I tried your patch on my app which has huge precomputed static tree of React elements and without this line uncommented my components are not re-rendered on context changes.\n. Sure, see https://github.com/facebook/react/compare/pull/4221/head...andreypopp:pr/4221\npr/4221 is a branch on top of this PR and the test case I added fails while I expect it to succeed.\n. Actually cheap-module-eval-source-map as eval doesn't work with transforms which don't preserve line numbers (Babel). Also cheap-module-eval-source-map should be the default in Webpack 2 according to docs.\n. Can the babel config be specified in webpack.config.js (in loader config)? I think having that is simpler. People could learn about .babelrc later on.\n. Maybe having a single webpack.config.js is better as it allows to get started with development quickly:\n- For dev we can ask to run webpack with --devtool option\n- For prod we can ask to run webpack -p option (which activates Uglify plugin).\n. Having client in modulesDirectories seems like arbitrary convention to me.\n. ... which complicates configuration by the way. The same for .jsx actually but I'm less opinionated about this.\n. My understanding that after reading docs people could start developing apps with React and Webpack immediately. Docs shouldn't be comprehensive but minimal, provide essential and sane dev and prod setup. Devtool is really an essential things as we use Babel/JSX.\n. What I mean is \"here's the config\", for dev run \"webpack --devtool ...\", when ready to build for prod run \"webpack -p ...\".\n. flow coverage --color\nOn Mon, 29 Aug 2016 at 19:04, Christopher Chedeau notifications@github.com\nwrote:\n\nIn src/isomorphic/classic/element/ReactElementType.js\nhttps://github.com/facebook/react/pull/7600#discussion_r76634323:\n\n@@ -23,7 +23,7 @@ export type ReactElement = {\n   $$typeof: any,\n   type: any,\n   key: any,\n-  ref: any,\n-  ref: string | (elem: ?HTMLElement) => void,\n\ncc @thejameskyle https://github.com/thejameskyle\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/facebook/react/pull/7600/files/6a1166f44d77d267879a9e39b6cde9241a569043#r76634323,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AAB3gk_ZuNizzgRHP7SeOrxVSKUMDotlks5qkwMFgaJpZM4JvD5_\n.\n. \n",
    "epeli": "I feel that there would be real use cases for this when doing data visualizations. Computations can get too heavy when datasets are large. API (or even convention) to cache those computations would be nice. I've also asked about this on Stackoverflow.\n. ",
    "bennidhamma": "Hey Jordaan, thanks, we resolved this one. The issue was that I was setting my initial state to a prop, but then never subsequently updating that initial state. Thanks for the help!\n. ",
    "ericclemmons": "Oh, that's it.  Thanks :)  I'll await #255's resolution for long term, but adjust my code in the short term...\n. Oh, it totally looks like rowSpan (camelCased!) is missing.  I'll submit a PR...\n. ",
    "joshduck": "I don't believe 'change' should fire for contentEditable fields but 'input' should be. See https://developer.mozilla.org/en-US/docs/Web/Reference/Events/input and https://developer.mozilla.org/en-US/docs/Web/Reference/Events/change\n. @spicyj Sure. It might make sense to a) polyfill onInput for old browsers b) make onChange depend on onInput rather than directly on modification events. That way we get both events.\n. A little experimentation shows that the slowdowns happen even when the mutations are happening on nodes with no listeners. They also persist after the listener has been removed. One fun discovery is that in IE the slow downs persist across page refreshes. \nThankfully, it looks like DOMCharacterDataModified doesn't have as much of a negative effect as DOMNode* listeners.\n. Space before the curly brace. \n. Web Tracing Framework uses tokens that are returned from the start call (see WTF.trace.leaveScope for example). This circumvents a whole host of synchronization issues with nested events, and might be a nice convention to follow.\n. Ah, I hadn't realised that we were completely removing nested calls. \nThere is a lot of value in representing a heirarchy in profiling output. For example if you take a look at the image here you immediately get a sense of which parts of the application need improvement. If you rely on aggregation then you lose that big picture view. This is the biggest problem with the current ReactDefaultPerf implementation. \nWould the work stack be completely divorced from the parent hierarchy? If it is still somewhat recognizable then there would be value in surfacing that information. Chrome profiler flame charts are still immensely valuable even though they can't follow asynchronous boundaries.\n. ",
    "masklinn": "\nThat way we get both events.\n\nAre both really needed though? Whenever a difference could exist, React's changes to change basically match the spec's input.\n. > Basically match the spec's is a world of difference when it comes to practical usefulness though.\nYes. A positive one, as input's behaviour (and react's onchange) are much more useful than the DOM's change event.\n. ",
    "syranide": "@masklinn Basically match the spec's is a world of difference when it comes to practical usefulness though.\n. @Aetet Sadly though, all of them operate on the assumption of US/Western keyboard layouts, unless you're willing to avoid support for ctrl and alt. Also, you could easily make this as a Mixin yourself.\n@spicyj @petehunt As for this specific PR, what about simply exposing it as React.addEventListener(node, event, callback) (could be useful for when leaving the confines of React, like innerHTML) or as a mixin ReactEventsMixin + listenToEvents: [{event: callback}] which could then take care of the cleaning up itself.\nDepending on the use-cases, I guess you could even do ReactWindowResizeMixin + handleWindowResize:, although you might end up with a lot of mixins. Again, depending on the size of the problem, you could even just have a single mixin that attaches to the events that have defined handlers/methods, handleWindowResize, etc.\nThe mixins could even be implemented as an addon, although it kind of feels like a \"native\" implementation would be nice.\n. Just to be on the safe side, you guys having issues, make doubly sure that your git is not set to the wrong line-endings. My settings got messed up once and used \\r\\n instead of \\n which basically broke everything in extremely weird ways, including errors like above.\n. Redid the example for a much more understandable view of the problem, and my solution to it.\n@jeffmo code has been cleaned up slightly and the rules clarified more thoroughly.\n. @jeffmo Commits rebased (shout if I messed it up)\n. @jeffmo \nRebased so it properly uses utils.*\nFixed some minor style issues in https://github.com/facebook/react/pull/489\nI compared the output of old JSX with that of new JSX after refactoring on a large test-file I have, it produced identical whitespace\nI also separated https://github.com/syranide/react/compare/jsx-legacy-whitespace-tool into its own tool, so it no longer replaces the real JSXTransformer. So I added bin/jsx-refactor and vendor/jsxrefactor/, feel free to call them whatever you want (I honestly don't know what to call them)? (If you want to \"ship it\" with React)\nMore thoroughly documented the refactoring tool, but I'm not sure how useful/understandable it really is. I doubt anyone would be able to make an informed decision on which transformations to disable (I would keep all of them enabled). In my opinion the annotated space {'\\x20'} is also the best choice for the spaces we insert, especially if my jsxconcat PR is merged so that it is recognized as a fixed string and thus concatenated.\nIt's also worth pointing out that running jsx-refactor multiple times on the same source has no effect, due to the way the rules work. So it's a safe operation.\nFrom my perspective I feel good about the current code and as far as I can tell, it follows your code style. Obviously, feel free to object :) and like I said on IRC, I'll be available until friday, but after that I won't be back until next sunday.\nAlthough it is not required I do recommend considering https://github.com/facebook/react/pull/489 as well, without it the explicit whitespace injected by the refactoring tool will cause quite a lot of additional DOM spans to be rendered, as well as when explicitly inserting whitespace as you're aware can be quite common.\n. @jeffmo \nRebased so it properly uses utils.*\nFixed some minor style issues in https://github.com/facebook/react/pull/489\nI compared the output of old JSX with that of new JSX after refactoring on a large test-file I have, it produced identical whitespace\nI also separated https://github.com/syranide/react/compare/jsx-legacy-whitespace-tool into its own tool, so it no longer replaces the real JSXTransformer. So I added bin/jsx-refactor and vendor/jsxrefactor/, feel free to call them whatever you want (I honestly don't know what to call them)? (If you want to \"ship it\" with React)\nMore thoroughly documented the refactoring tool, but I'm not sure how useful/understandable it really is. I doubt anyone would be able to make an informed decision on which transformations to disable (I would keep all of them enabled). In my opinion the annotated space {'\\x20'} is also the best choice for the spaces we insert, especially if my jsxconcat PR is merged so that it is recognized as a fixed string and thus concatenated.\nIt's also worth pointing out that running jsx-refactor multiple times on the same source has no effect, due to the way the rules work. So it's a safe operation.\nFrom my perspective I feel good about the current code and as far as I can tell, it follows your code style. Obviously, feel free to object :) and like I said on IRC, I'll be available until friday, but after that I won't be back until next sunday.\nAlthough it is not required I do recommend considering https://github.com/facebook/react/pull/489 as well, without it the explicit whitespace injected by the refactoring tool will cause quite a lot of additional DOM spans to be rendered, as well as when explicitly inserting whitespace as you're aware can be quite common.\n. @jeffmo Correct, and it produces the correct output (without spaces) for me.\nReact.DOM.div(null,\n  \"stuff\"\n)\nIs it perhaps a repeat of yesterday?\n[22:29] lbljeffmo: syranide: ok I'm a clown -- I was accidentally using the old transformer when I though I was using yours\nHehe\n(Just to be on the safe-side, note that JSXTranformer in my refactoring tool branch does NOT have the whitespace patch applied, they are separate branches)\n. @jeffmo https://github.com/facebook/react/pull/489 solves that specific case, that PR previously made sense by itself as {' '} was a common occurence. Now, it serves to prevent the whitespace inserted by the \"codemod\" script from creating spans. It's also still generally useful (but not as useful) as it concatenates all fixed strings (so basically, wherever you explicitly insert any whitespace). It's simply an optimization of the JSX output and should have no practical disadvantages (other than possibly \"philosophical\", and code complexity). The only possible difference it can have is that fewer spans may be generated and possibly that no spans at all will be generated in certain cases (as a string appearing as the only child creates no spans).\nHowever, it seems to me like React generating spans is simply the way it is currently. In my opinion, in this context, using spans without a className is asking for trouble, and assuming that React does create spans is pure stupidity. So as https://github.com/facebook/react/pull/489 has the possibility of reducing the amount of generated spans and thus altering the DOM structure, anyone applying any common sense for React should not be at all affected.\nThat being said, I did look into it. There are basically two possible solutions that I considered:\n1. Use a fragment for innerHTML instead of doing it directly on the DOM. Then, traverse all the nodes (this can be solved using getElementById if absolute performance is necessary), replacing any implicitly generated spans with the TextNode inside and transfer the reactid from the span to the TextNode. Finally simply insert the fragment into the DOM. However, there is no way to attach a reactid to a TextNode other than adding a custom property to it (which may not be optimal, but it works), however this seemingly cannot be solved at all in IE8 using the reactid-approach (you can't add a property or defineProperty on TextNodes in IE8).\n2. (I didn't really research this to any greater extent) Do not generate any implicitly generated spans and insert into the DOM as usual. When re-rendering, treat any consecutive TextNodes as being concatenated and refer to them as the \"previousSibling of this DOM-node\". This would be the cleanest/fastest approach, but it appears to me (and I'm definitely no authority on this) that this would require significant effort to solve currently, and if TextNodes do split it automatically (certain not so old versions of FF do this) would break Reacts _mountIndex used for reordering elements (and possibly would regardless because of the concatenation).\n3. (Not really a solution) Another thing to consider is to use a custom element in-place of the implicitly generated spans, such as reacttext, which would prevent any non-* CSS-rules from interfering at least. The HTML-standard discourages custom elements (which is sensible), but they are supported by all browsers to my knowledge.\nSo, given the current state of React of reactid (which will be changing in the near future it seems), it currently seems to me like there exist no tractable solution for solving the span-issue, unless someone finds a workaround for the IE8-issue.\nSo https://github.com/facebook/react/pull/489 should suffice for any \"issues\" introduced by JSX and the \"codemod\", and should bring parity and possibly even improvements to any projects as compared to before this PR is introduced. That is, nothing can get worse, it may only change for the better in certain cases (and if you rely on such specific behavior, you're going to be in trouble anyway sooner or later).\n. @jeffmo Not saying we should do it, but one idea is to keep a legacy version of JSX(Transform) in the repository for the time being. So that anyone who feel they can't switch to the newer right away can stay behind a short while.\nAlso, what is your thoughts for the \"codemod\" tool? Bundle it with React for now? Point people towards my repository? (Just checking, I honestly have no preference)\n. The simplified (technical) explanation for the current whitespace rules would be:\nAll lines having leading or trailing whitespace are trimmed, all newlines are \nremoved, adjacent text separated by newlines become separated by a single \nspace. Any whitespace tabs are replaced with spaces. Strings inside \nexpressions are unaffected.\n. @jeffmo Sounds great!\n. @jeffmo PS. I have not yet thoroughly vetted my jsxconcat PR, so I may need to look it over once more if you're considering it.\n. @zpao Reminder, I kind of hackishly fixed the failing testcase, it was broken before too, it simply passed because of \"chance\".\n. @vjeux So I researched the root of this issue, and here are my tragic findings FYI:\nThe actual distance scrolled in all browsers depend on the OS mouse settings, except for IE8 because it only reports the raw wheel delta. In windows this can be toggled between X lines (3 is default) and 1 screen (supposedly cannot be set to pixels), and the actual values are as follows (can test OSX at work, but no access to Linux):\n```\nWindows IE8-11:\nLINE = 5% of browser height\nSCREEN = 87.5% of browser height\nWindows Chrome:\nLINE = 33.3px\nSCREEN = 87.5% of browser height\nWindows FireFox:\nLINE = 19px (but 38px if the default \"3 lines\" is selected)\nSCREEN = 87.5% of browser height\n```\nHowever, the following values are reported as delta:\n```\nWindows IE8:\nALL: deltaMode = N/A\nALL: wheelDelta = ticks * +/-120\nWindows IE9-11:\nLINE: deltaMode = PIXELS\nLINE: deltaY = ticks * 5% of browser height\nSCREEN: deltaMode = PIXELS\nSCREEN: deltaY = ticks * 87.5% of browser height\nWindows Chrome:\nLINE: deltaMode = PIXELS\nLINE: deltaY = ticks * 33.3px\nSCREEN: deltaMode = SCREENS\nSCREEN: deltaY = ticks * 87.5% of browser height\nWindows FireFox:\nLINE: deltaMode = LINES\nLINE: deltaY = ticks * 19px (but 38px if the default \"3 lines\" is selected)\nSCREEN: deltaMode = SCREENS\nSCREEN: deltaY = ticks * 87.5% of browser height\n```\nSo clearly it's all over the place. FireFox does not consider zoom in LINE mode, it is affected by zoom but seemingly arbitrarily so, however in SCREEN it does consider zoom. Through a non-standard event FireFox allows us to read detail which exposes the exact number of lines or 1 or more screens (but not the exact count), depending on OS setting. Through yet another non-standard event we can read another detail value which gives us the amount of pixels scrolled (except that it assumes that each line is 19px which is wrong for the default setting). Keeping it classy FireFox!\nDue to the way IE8 works, we can only approximate, but we can approximate any result we want, so that's positive at least... that lets us forget about IE8 as a problem. The real problem is, what result do we actually want?\n\nIf we go by the standard, then we should report the distance to be scrolled (without considering zoom) which is reasonable enough (also note that determining zoom level is non-trivial), except that it may be in pixels/lines/screens, which is nice but what most developers want is likely always pixels (and the others as optional).\nAlso, there exists no simple cross-browser formula for determining pixels from lines/screens... and quite honestly, I'm not sure what I would ever do with that information even if I had it, as it's unlikely that the user made a conscious decision about pixels/lines/screens in the first place.\nSo it seems like to me, if we're gonna follow the standard, we normalize everything to pixels (as closely as possible). It allows developers to rely on a single understandable implementation (different mice, trackpads, etc).\nLets return to reality for a second. Let's say we have deltaX/Y and they are normalized to pixels. What could we do with it?\n- Re-implementing scrolling is a bad bad idea, common sense says that you should rely on native browser scrolling whenever possible.\n- For interactive scrolling you have two realistic options; either it's some kind of stepped interaction so relying on deltaY is useless, 1 line, 3 lines or 1 screen should all advance by just a single step (but multiple separate events may advance multiple steps). However, a reliable raw wheel delta would be useful, but not required.\n- Or it's a very long page where you use a mix of position fixed and absolute elements, so you should rely on the native browser scroll behavior and interpolate animation from the scroll position.\nSeeing as none of those should find anything but possibly sign(deltaY) useful... have I missed some practical use-case or what other use-cases are there?\nThere are uses for the scroll wheel as a kind of button (which again should just use individual events and the sign, rather than the values themselves), for basically flipping pages style behavior. What about smooth scrolling trackpads, do they trigger mouse wheel events?\nSo given all this, it seems like the most useful (even if not so useful) solution is to normalize everything to pixels as far as possible, and just leave it at that, because as it is right now, it's basically fundamentally broken. But it is compatible with the standard.\nAnd instead delegate to plugins for dealing with more advanced uses, like converting it back to raw wheel delta, since it seems kind of iffy to add that to the event unless there's some universal use-case for it.\n. @spicyj Hmm, but if they do emulate mouse wheel events, I would assume they use the old \"line by line\" stepping? (Eh, perhaps it doesn't matter, if following the advice below)\nYeah, from briefly testing Google Maps, it would seem like they use my above recommended method of basically just listening for individual events and having a minimum delay between each event. Quickly scrolling, no matter of much, always zooms one level, doing a long slow scroll zooms many levels.\nSo there's merit to at least normalizing -wheelDelta into deltaY (like we already do). But yes, normalizing deltaMode may not seem worth it unless someone can present a reasonable use-case for it. I'm assuming that providing the above Google Maps-style behavior is best done as an addon as there would are no clear best practices for it, and it would be easily solved by an addon, API-wise.\n. @vjeux @zpao \nI could look into fixing this... from what I understand, what needs to be done is to create a ReactDOMScript-component that should have an invariant that checks that it's either empty or has only 1 string as child (or possibly many strings?) and of course works like it should.\nWhat should happen if the string changes? Simply update the script-element and defer to the browser (I'm assuming they all do nothing) or recreate the script-element?\nSeems about right?\n. @spicyj It stills seems like being able to render into body will be supported, and even head. Even if only rendering into body was supported, this could still be useful. But yeah, perhaps not worth the extra bytes.\n. @zpao https://github.com/facebook/react/pull/970\n. @spicyj Ah great, it got merged! I'll do that.\n. @spicyj @sebmarkbage Commit has been rebased, I'm unsure of your code style preferences here, inline escapeUserProvidedKey, inline userProvidedKeyEscaper as well perhaps? What about the naming?\nAccording to this http://jsperf.com/aefsefsefsf/5 there doesn't seem to be a good reason to use any pre-escaping tests, the only reason would be because of the \u00ecndexOf` one is about 15% faster in IE8 (which is slow), but it would be at the cost of be slightly slower in some other browsers (and larger filesize). But I still think caching the key on the component is a better approach if that is necessary.\nAlso, I changed it to only escape .^} because those are the only 3 that must be escaped. So it's possible to construct weird looking reactids, but they're not meant to be humanly readable in the worst of cases.\n. @benjamn I think it's fixed now, I haven't checked. But, previously the NPM-version of React and one of it's depedencies had conflicting version dependencies for envify.\n. @zpao Oh wait, you're right. The actual issue I think was that I couldn't install npm-react and browserify because their dependencies conflicted.\n. @brainkim Is this actually useful for anything besides cursor: grab? I don't know of any other CSS property that has vendor prefixes inside of them. If that's the case, then this specific issue could be solved by just defining a custom CSS class and use that instead.\nHowever, it seems like vendor prefixes overall may need considering for React.\nEdit: Hmm, this is actually useful for CSS3 backgrounds too.\n. Problem with vendor-prefixes is also that some of the time they are just that because they aren't 100% compatible. Given proper CSS.supports-shims of which it seems they exist (https://github.com/termi/CSS.supports/, and it's also light-weight), as well as vendor-prefixing-utility-functions, that sounds like the best route, as the application can then intelligently decide what to do when certain things aren't supported. It's not like style should replace stylesheets.\n. @zpao typeof null === 'object' (however stupid that is)\n. @sebmarkbage Part of the discussion was about whether undefined show be considered an error or not. I would argue that all valid paths inside getInitialState should return something (and null or {} if you want it stateless) and that undefined (no return) should be considered a mistake/error.\n. @sebmarkbage I can't come up with any real scenario that would need it (and obviously none would require it). Theoretically you may want to only have a state sometimes, but again, it wouldn't require it and if you absolutely must optimize that specific case, just swap the entire function for null based on the condition.\nSo yeah, I'm inclined to agree with you.\n. Got notified by locks in the IRC-channel, https://www.irccloud.com/pastebin/16CNdpLZ\nSomeone else came across it (and I think this PR is the fix?).\n. @petehunt Would it not make more sense to use this.linkState(['a', 'b', 'c']) then? Or just this.linkState('a', 'b', 'c').\nAgain, I'm not up-to-speed on the \"issues\" with Closure Compiler, but it's the same syntax we already use, so it should work right?\n. @petehunt Ah right, right, forgot that it's how it's \"supposed\" to be used.\nAnother possibility is to get rid of linkState all-together and using just valueLink={keyPath({a: {b: this}})}. Much more compact and no arbitrary use of null, but it would require core-support and I think it only would make sense if it basically deprecates the use of linkState, which it doesn't.\nHowever, as a helper function it could make sense as valueLink={linkState({a: this})} and valueLink={linkState({a: {b: this}})}, one solution for any depth, no redundancy, everyone gets Closure Compiler support for linkState. Additionally, you could now get rid of the \"weird\" Mixin.\nIt would still be an addon, I could even cook it up or if you prefer to do it yourself (if it isn't a bad bad idea ofc :)).\n. @petehunt Just curious, does my idea above sound OK or is it fundamentally broken in some way? I think it would makes sense for simpler uses as an alternative to the current LinkStateMixin. I could easily cook it up and npm it, if it isn't a bad idea.\nOr is your IG-update() a better solution for \"everyone\"? (Write the blog posts already! :D)\n. @petehunt I'll wait for you to release setStateDeep then and I'll npm it.\n. @sebmarkbage We cannot reliably disambiguate (<foo>x)+(<foo></foo>) (in a real context). Sure with an infinite look-ahead we could possibly make it reliable enough to actually be useful, but any error messages would be complete dog poo as we would never be able to identify intent. Which in my eyes makes it useless.\nI agree with backticks, while it would be a solution, it would remove an ES6 feature and it would be quite error-prone when dealing with nested conditionals. Although realistically one could likely just assume that any <> inside an expression is JSX and not a type-cast.\nHowever, <aaa> is the only issue, the two other cases can be disambiguated, quite easily. So reasonably, we only need to introduce an (optional) syntax for <aaa>, but it is not trivial what it would look like and possibly not very neat either. The simplest being <aaa >. However, for all the different optional syntaxes I can come up with, none really feels natural or not weird to me.\n. @sebmarkbage The only thing I worry about effectively overriding TypeScript syntax is that this would be a solution only for TypeScript, and it would effectively mean that either you end up with two different type-cast syntaxes depending on whether the current file is run through the parser or not, or you risk breaking existing code if all files are run through it.\nAlso, depending on the replacement syntax for type-casts, you potentially have to extend the actual TypeScript parser as opposed to just having a language agnostic transform which a special-case for TypeScript-style type-casts. What are the current thoughts on extending the language parsers vs a language agnostic transform? It seems like having an agnostic transform would be preferable, and if people really are invested in TypeScript (or whatever) then nothing prevents them/us from implementing a \"language native\" solution down the road.\nOne potential idea, if my JSX namespaces PR is accepted and merged, would be to simply have the syntax be something like <.tag> or <:tag> and thus <.React.DOM.div> or <:React:DOM:div>, not the neatest syntax, but there's some logic to it at least. Perhaps an acceptable trade-off for languages where it conflicts?\n\n```\n\n\nvs\n<.tag>\n\n``\n. @fdecampredon It seems like React intends to move to ES6 classes _soonish_, I'm assuming that would improve the situation?\n. A reason not to use:and to use.instead is that:collides with potential XML use. I seem to remember someone mentioning about having to namespace some of the attributes for SVG. I think logically it makes sense to use.unless we actually _lose_ something by not using:.\n. @jeffmo @petehunt @spicyj Have you guys thought any more about this?\n. @spicyj Definitely agree there, I would even go as far as saying that it explicitly shouldn't be used to solve that problem. I'm personally half in-favor of still adding support for.` simply to cater to those who absolutely want it or don't use CommonJS, but personally don't see that I would ever use it.\n. @jeffmo I think it makes sense to support a default namespace simply because you're overwhelmingly likely to mostly rely on a single namespace, and having to type it out would make it significantly more tedious and cluttered. Practically I also think it's acceptable as camel-case could be the recommendation for namespaced components and upper-case for locally defined, thus still making it quite readable.\nBut I do have to say, removing \"ambiguity\" or rather \"personal preference\" out of the equation is appealing. But then again, we cannot really do more than recommend html:, people could still use h:, so not sure what it's worth in the end.\n. @zpao <Foo.Bar.Baz /> is basically already covered by this PR (namespacing syntax, not a member expression), just need to change : to . and restore XML-NS, or if @jeffmo has any preference when it comes to the implementation itself.\nWhat about <Foo[\"Bar\"].Baz />? Intuitively I don't see why we feel the need to support it other than for edge-case Google Closure Compiler support (I assume?). If that's the case, not saying it's a good idea but <Foo.\"Bar\".Baz /> could be a possibility, but really, it would be better for people to just export it correctly.\n. @yungsters Done. Also, you're right, I added that, I must've confused myself when I rebased.\n. @salier Was a bit involved too I think? (or rather, was working on his own implementation before he saw this)\n. @plievone Could easily extend it with output = output.replace(/(<[^ ]+) data-react[^=]*=\"[^\"]*\"/g, '$1') and it should be safe.\n. @petehunt Rebased.\n. Thanks to @pieter-vanderwerff for noticing that object and embed also reload if they are detached/moved. Which means that Flash/SWF is also affected by this issue.\n. @benjamn I've added 4 tests now, all based on the same strategy, mutating a randomly generated set of items based on keys and indices, X number of times and verifying the output at each step. Each test represent a progressively more complex scenario.\nThe last one also tests that the environment behaves as it should (i.e. that immovable objects reload when detached), although it's possible that some browser doesn't have this behavior (test is still useful by itself, but will need to disable the check then).\nIt passes travis-ci which you guys have hooked up to saucelabs right? So seems fine then.\n. Thanks to @pieter-vanderwerff for pointing out that audio and video are also affected. This was a bigger issue than I initiall thought.\nIf anyone can benchmark this PR as-is and with immovableTagNames set to only one tag (while including that tag as a node in the markup), that would be greatly appreciated. It currently always tests all 5 tag names, I'm pondering whether it is worth to make it smarter so that it narrows down the list to only the tags that the parent was found to have, or if it's so ridiculously fast that it doesn't really matter.\n. @benjamn I rebased it, but my tests now fails because iframe.contentWindow is no longer defined. Has something changed for the grunt test fake browser environment?\n. @spicyj Ah, that makes sense, best solution for this is perhaps just for me to attach it in my tests I guess? As it apparently was an issue before, is there something I should be \"aware\" of?\n. @spicyj Many thanks, so the issue was way simpler than I thought. :)\nI've hacked a ReactTestUtils.renderAttachedIntoDocument which has the old behavior, and my tests also clean up after themselves. Input on how to do this properly is welcome.\n. @zpao I will be needing this fix for our service very soon, I have no problem at all proceeding with a custom branch. But I just want to make sure I don't head down a conflicting path/end up with the custom branch indefinitely. Is this fix something you are considering taking (for some future milestone) or are you looking towards an alternative solution/no solution?\n. @jbaiter Yep, it's not just you.\n. @steveluscher Cool, and well done @spicyj !\n. @zpao I have intentionally fixed a few in my whitespace PR (including your example I believe) and I have intentionally not addressed some of them and there are probably a bunch of them that I haven't even come across (didn't look for them).\nI think we need to decide on what we actually want in the output, should we try to be as faithful to the source as possible or should we always generate the \"correct minimal syntax\" loosely speaking?\n. Yep, document != <html>, document.documentElement == <html>\nBut it does seem quite happy to crash a lot.\n. The recommended use of es5-shim and es5-sham is to always include them, for all browsers. For hasty downloaders that may not be obvious, so may be good to point it out yes :)\n. @zpao Or at least bunch it up with the download-page, because that's where I would naturally look for that information at least (i.e. what other things do I need to make this work).\n. When we're on the subject:\ncellSpacing is entirely replaced by border-spacing + border-collapse.\ncellPadding is the same as setting padding on each td, so not entirely replaced, but identical behavior is possible with CSS.\nAlso, isn't wmode a Flash-exclusive attribute? Isn't it better to always use object for Flash instead of supporting an arbitrary selection of its attributes for embed?\n. - cellPadding is replaced by padding, while it is per cell, any decent CSS reset will zero it by default\n- cellSpacing is replaced by border-spacing\n- bgColor is just lazy, use background-color\n- align is replaced by margin: 0 auto 0 auto\n-  valign is replaced by vertical-align\n@zpao wmode is currently in the config but to my knowledge is a Flash exclusive attribute for embed, you can achieve the same and much more using object + param instead. The only reason I see for keeping it is that it makes the perhaps the simplest use of Flash possible via embed. But it is no way required.\nAlso, do you know what scrollLeft and scrollTop is for? I can find no reference of it being useable as a HTML attribute.\n. :+1: \n. It was reverted because it broke their internal use of contentEditable in some weird way, so it really should be changed to use it, just need to figure the solution to all the problems first I assume.\n. @petehunt Cool!\n@vjeux Of course! https://gist.github.com/syranide/aa3ebeb7e235d8c5e5fd\nI just copy-pasted my crappy code, and it benchmarks it by continuously printing to the console. So it's probably not super usable as-is. If there's something specific you have in-mind, just shout and I can probably have it fixed.\nAlso PS, I noticed that I had accidentally benchmarked with the unminified React, so the performance improvements may even be slightly higher.\n. @zpao FYI, personally I find in more descriptive, but it's considerably slower. I didn't really look for cold/hot paths, so this was just in general where it seemed to make sense, and doesn't necessarily have an actual impact.\n. @zpao I guess, if we still require the docblock, it would perhaps make sense to just make it svg: true or similar. Having it as a cli-option would be bad I feel (if anything using SVG, all files must be using it, and you would have to know it).\n. @petehunt I don't know the specifics right now, but being able to easily edit internals of components would be a bit bad, if they aren't already given that (which I don't think?). Being able to view it shouldn't matter, people should not expect that kind of information to be hidden anyway.\n. Cool!\n. @zpao Did you merge my gist? The PRed code was broken, https://gist.github.com/syranide/aa66e8508a9e2532bc73\n. @petehunt If it's truly an addon, how do you solve multiple uses of setStateDeep for the same key?\n. cc @sebmarkbage @jordwalke \n. @sebmarkbage It became a little longer than I hoped, but I think it all makes sense :)\nI don't consider key synonymous with identity because it is a solution for efficiently reconciling children, key really is a mapping between keys in a collection and rendered components. A rendered list is the visual mirror of a map of objects, when a key is removed its' component should be removed to, same when one is moved, same when one is added. The component key identifies a specific key in the collection, not the data associated with the key, the key being a function of the data is simply an often very convenient solution, not a guarantee. Just consider any collection of non unique database objects (that should be rendered as such).\nReconciling of key-less component is an optimization heuristic, it's not guaranteed to be correct. If we take the example of rendering a single component. The user selects an image to be rendered first, then selects a video, the component have been remounted because of different component classes. However, if the user picks two different files but of the same type, the component is now explicitly required to support changing content.\nThey have to explicitly support internally resetting state, focus and any uncontrolled DOM nodes (or break, although likely in non-problematic ways), rather than allow them to simply exclaim \"That image/video is not me!\" to overrule the implicit heuristic. Sure, the parent can provide the key, but I don't believe that it's its concern, it's the child that really knows what it supports and not, it's also not guaranteed to be as simple as key equals filename, it could potentially be an opaque object as far as the parent is concerned.\nSo to me, it really boils down to the fact that ComponentA === ComponentA is a heuristic and not fact. Just as ComponentA === ComponentB is false, I would expect ComponentA(car) === ComponentA(airplane) to also be allowed to be false and not true simply because they're of the same class, thus ignoring the effect of all properties.\nAs far as real use-cases go, I still haven't put React into production yet, but this currently breaks my SWF-plugin unless I explicitly add support for it. I think it also makes sense theoretically, especially for third-party integration and reusable components, it just happens that due to the one-to-many-unique data objects of most applications you very rarely run into an issue (and if you do, the effects may be negligible, such as focus remaining in a field or a previous animation still playing). But it doesn't make it right, and I could see a lot of reusable components falling into this trap and having to explicitly support resetting itself to avoid taking any chances.\nPS shouldComponentReceiveProps makes sense perhaps? Clear association with componentWillReceiveProps and only props are relevant.\n. @spicyj Just incrementing an ID should be fine no? Or anything else that uniquely identifies the switch. I guess it boils down to, if you need to explicitly manage the life cycle, then you need to give it a key that identifies the instance.\n. @spicyj That \"bug\" was new to me, adding them to document fragments come at a slight cost, but it's probably not significant in this context.\n. @zpao I've only been \"experimenting\" so far and I'm honestly not sure what react-tools is, so I have no opinion. :)\n. @zpao I definitely think this is meaningful, but in-terms of naming, etc, then yes. :)\n. Object.keys is not universally defined and it's not currently specified as required in the docs.\n. @petehunt But how would you then deal with information relative to current time? I.e, \"blog post is X hours old\", \"person is X years and Y days old\", \"message received X seconds ago\".\n. @petehunt Yah, looked at it twice and they looked the same, must've been cross-eyes.\n. @spicyj I'm curious if https://github.com/facebook/react/blob/master/src/browser/ReactDOMIDOperations.js#L144 is a simpler solution to the newline problem (for IE8), or if that only works for innerHTML.\n. @zpao I'm starting to feel like the current system is starting to show its limits, is there a good reason why we simply don't accept all unknown names as attributes, null? (and also follow the DOMPropertyConfig) Most of the attributes are really only allowed for one or two of the tags, perhaps it's time to introduce a tag-specific list of \"properties\" as well so we can be more fine-grained?\n. @spicyj Definitely true, it was mostly based on the pattern of most of the \"properties\" being just regular \"attributes\" with no additional checks. I think the real solution would be to maintain a list per \"category of tags\", that way an input cannot have rowSpan, etc, etc.\n. @spicyj Nope, but once DOMPropertyConfig is injectable I see it becoming quite a mess. Attributes and properties for HTML, SVG, etc could potentially conflict even. It's also possible that properties meant for specific components can start being applied to everything. It's starting to feel rather in-elegant at that point.\nI see your point, but it seems kind of weird to me to maintain a huge list of all possible properties for all \"technologies\", it seems like the current solution was intended for only HTML (and not SVG, etc). As opposed to keeping it to a per-technology per-component basis. Intuitively, done right the size cost of maintaining it per component should be minimal.\nPerhaps I'm overthinking it, but it seems really unwieldy.\n. @darthapo Two-way binding (valueLink) may be something you want to use instead, you can even implement your own this.linkState if the one provided (addon) isn't ideal for your case.\nPS. Also, it's just a helpful warning, it's quite (OCD-)annoying that they can't be turned off though...\n. @sgrove That's definitely something React should do, but the attributes/properties are not listed in DefaultDOMPropertyConfig at this time and that's why you're not getting any result. If you're up to it, you could submit a PR for it. :)\nHowever, I must warn you that audio-tags are barely practically functional in React today, if any of its ancestors siblings are reordered at all, the audio will likely pause. I have a pending PR for it, but it's not landing for 0.9.0, https://github.com/facebook/react/pull/870\n. @spicyj _rootNodeID must be unique at any point in time, but it only describes the hiearchy of indices and keys, so once a component is removed, the _rootNodeID is likely to be immediately assumed by another component taking it's place.\nAnyway, @andreypopp messages me in the chat and it seemed like the Mixin approach was a good solution.\n. @spicyj Ah right, right, _rootNodeID emphasis on Node as in DOMNode. Excellent point, they're only unique in the DOM (loosely speaking).\n. @spicyj But everything is already there, it's just the injection that isn't?\n. @totty90 It's not allowed (right now), there's just no check to enforce it. So yes :)\n. @spicyj Sounds like it should be upgraded to an error as there's no reason why you would ever want to ignore it, but perhaps it leaves React in an unstable state?\n. @petehunt Ah, that makes sense. Thanks.\n. @MattKunze We do try to fix things that can be fixed and it wouldn't surprise me if you can temporarily add a click-handler on touch and solve it like that.\n. That should definitely not be happening, but it seems like you're asking a question rather than having an actual issue. Quick testing on my side shows no issues, if you're having an issue it would be great if you could provide some code that reproduces the error.\n. Ah yes, React does not actually render it as straight HTML, so you cannot have HTML-entities in the strings. Is this an issue for you somehow or are you just curious?\n. @onion-soup Ah, it's also worth knowing that you can do <script charset=\"utf-8\">, if you're unable to use utf-8 as document charset.\nPS. Correct is <meta charset=\"utf-8\">, also unless you're using XHTML you should (technically) not be using the self-closing slash.\n. Shouldn't we allow objects as well then?\nAlso, :+1: \nKind of a side-note, wouldn't the same thing be useful for style as well? padding: [0, 0, 0, 10]\n. Spoke with @chenglou in chat a bit, and he seemed to agree. I feel like supporting only arrays and strings, but not objects ({A: true, B: true, C: false}), is really arbitrary. Especially as I understand it, you use the object-approach exclusively internally at FB to allow minifying of class names (that's my impression from seeing previous discussions on the subject at least).\nSure, the classSet addon exists, but it's cumbersome and as far as I understand it, the primary reason why it's an addon is because you use cx to identify class name objects basically. So to me it seems like add another addon classArray (or whatever) or support strings, arrays and objects. Because this middle-ground seems really really arbitrary to me.\ncc @zpao\n. Are you sure? It really seems like it should break on duplicate keys, if not immediately then possibly later when the wrong node is removed, and it really ought to, you f-ed up.\nHowever, if both nodes have identical sub-hierarchy it could probably \"adopt\" the wrong one without breaking, but in other cases it should break.\n. var comp = <comp />; comp.isMounted()\nIf that's what you are doing then \"you're doing it wrong\", React promoting \"virtual components\" to \"instances\" is an implementation detail in my opinion, don't rely on it because it may change.\nAlso, what that gist refers to is that methods defined on a component will no longer be available on the class, you need to use statics for that.\n. <child /> and this.refs.child (or this inside a component) are two very different things.\n<child /> creates a \"virtual component\", if you will, basically a shell containing only the class and its props. This tells React what you want the DOM look like after the rendering it done. That is, you return a verbal description of the expected output, not the physical instances.\nthis.refs.child and this are instances to components that React has created, that physically exist, basically.\nSo think of <child /> as {type: 'child', props: ...} and not as doing new Child().\n. :+1:\nI'm not sure if it really makes sense, but $delete?\n. This is currently a flaw of sorts in React that is used to get around the issue of not being able to create separate textnodes with innerHMTL nor being able to provide them with any kind of identification.\nThere are a number of different levels at which this could be attacked, @spicyj sumitted PR https://github.com/facebook/react/pull/742 that I believe concatenated adjancent string children but was rejected because it broke the determinism of the children array, or something like that. So it seems to me that if someone finds this important enough to fix now, that the solution would be to concatenate adjacent strings during rendering, but it likely isn't as easy as it sounds.\nIn your case, you simply have to put everything inside the braces for now.\n. @petehunt Is that actually valid \"today\"? Are you allowed to actually keep the reference to a \"virtual component\" and reuse it?\n. @petehunt IIRC I think it works, but you'll run into issues if the \"virtual component\" unmounts and then mounts again. But if that's true, I'd say that's a bug rather than a blocker to this optimization.\nHmm, also, I guess this optimization theoretically assumes that the user has immutable props, since the component reference could remain, but an object inside one of its props could have changed.\n. @sebmarkbage Yeah, but what I mean, AFAIK React prefers immutable props/data but is implemented to work perfectly well with mutable data (i.e, it doesn't check prevProps === nextProps for that reason I believe). nextComponent === this goes against that right? If using mutable data then nextComponent === this can be true while the data has changed.\nAs for the unmount scenario, I remember someone having an issue with reusing component descriptors, it kind of actually worked correctly, but when the same component descriptor got remounted the life cycle methods would behave weirdly. I.e, it seemed to me like this was an optimization for a case that doesn't actually work right now (also, no it shouldn't be a problem when they are true descriptors).\n. Here's a working link for now (if you wanted to read it).\nhttp://facebook.github.io/react/blog/2013/11/05/thinking-in-react.html\n. @nschaubeck My point of view (I'm not an official dev) would be that it might make sense for component-name to translate to componentName. The style-object supports that notation (I think?), but then again, HTML5 which would be the best guide to follow, the new data- attributes do not support it, data-key-name is accessed as keyName in JS. They even explicitly disallow ambiguity as data-keyName is accessed as keyname.\nPersonally I see two big issues:\n1. component-name and ComponentName are identical, it introduces a stylistic preference to something that doesn't need it/shouldn't have it.\n2. It's very weird that component becomes component, but component-name become ComponentName.\nIs it weird to separate from the standard? Kind of, but we already have and JSX is not HTML, it's JavaScript and it's just sugar. So in many ways it makes sense (to me) for the notation to be JS-style (nodeName) as opposed to HTML-style (node-name), and not to deviate from that and open up the possibility to choose.\nSide-note, the data--attribute in React does expect data-key-name right? (@zpao, @spicyj) Although that is not necessarily a concious decision.\n. cc @jeffmo \n. @spicyj Yeah you're right, I distinctly remember that not being the case, but apparently it is. However, forceUpdate cannot be called during mounting while setState can.\n. It seems like a very weird convention for custom => custom but custom-element => CustomElement. I.e, the hyphen not only capitalizes the word after the hyphen (kind of makes sense), but also the capitalization of the entire name (does not make sense to me).\nIt also introduces amgibuity into JSX as <CustomElement /> and <custom-element /> are now identical, but neither is intuitively the right way.\n. createMarkupForProperty has a generic value == null, shouldn't the same exists in setValueForProperty as well?\n. IE8 actually throws an error on non-positive values, add a MUST_BE_POSITIVE after all or simply make it default behavior for HAS_NUMERIC_VALUE for now? Or do we even separate the two and rename the current behavior to HAS_POSITIVE_INTEGER_VALUE instead, it also allows us to floor the values for internal consistency.\nCould not set the rows property. Invalid property value. Enter a value greater than zero.\n. Any good reason why hasBooleanValue isn't checked here as well for falsey values? Is that native behavior of properties perhaps.\n. Should force deltaMode to always return 0 then.\n. @petehunt Certainly, and I don't disagree stylistically, but I did copy the style from https://github.com/facebook/react/blob/master/src/event/synthetic/SyntheticWheelEvent.js and https://github.com/facebook/react/blob/master/src/event/synthetic/SyntheticMouseEvent.js\nStill want me to change? (It would be a quick fix to change the others)\nI tinkered a bit with key and only non-character keys are possible to implement consistently and cross-browser. Even IE11 and FF that are the only to currently implement key-support at this time are broken implementations (although non-character key support is working in both, so that's that). Perhaps there's some merit to actually identifying non-character keys and always supplying them as key as fallback, as that is by far the most common use I would say.\nI whipped up a simple implementation and it ends up at ~650B before uglify and gzip, sounds interesting?\n. @benjamn Unless I misunderstand you, there's no point in doing this, this function does nothing unless it's IE8, and these tests don't run on IE8 right?\n. @benjamn But \"strict\" prevents that I believe right? Also, this kind of test is done elsewhere in React (and sometimes the more robust is used), someone commented on this for another PR I did I think, and people said to just use this simpler form I think.\n. @benjamn Yeah, my theory and I kind of found it hard to express it briefly...  (fact, so to speak) is that innerHTML behaves better when it's used on an element that is just created (i.e, it's not updating existing DOM), so it's works well when creating nodes, but not when updating nodes.\nHowever, from my testing it seems that in fact has to do with the node being added to the DOM and not with just having been created... and this virtually no-op statement, makes the DOM behave as if it was just added to the DOM (I guess, it's as if it was removed and then added).\nI can try to improve the comment with this, but as I said, this is only a theory, I only know from experimenting that it works when re-adding a node like this, as to why that is technically, I can only speculate at this point.\n. @benjamn The only reason why I chose zwnbs is because it has zero-width and unicode specifies that it should always be invisible, hoping that it might possibly be ever so slightly cheaper (but it probably isn't). But really it could be any non-whitespace character as it is just temporarily prepended to prevent the whitespace from being removed, it is removed immediately afterwards.\nWorth commenting?\n. \\s is supposedly sugar for [ \\f\\n\\r\\t\\v\u200b\\u00a0\\u1680\u200b\\u180e\\u2000\u200b\\u2001\\u2002\u200b\\u2003\\u2004\u200b\\u2005\\u2006\u200b\\u2007\\u2008\u200b\\u2009\\u200a\u200b\\u2028\\u2029\u200b\u200b\\u202f\\u205f\u200b\\u3000] so it matches a lot of other whitespace as well which does IE8 not collapse. However, your comment prompted me to do a more thorough test and it apparently also treats \\f as whitespace. So I should add that, but in practice, \\s could be used, it's not invasive, the regex is simply used to prevent the more costly branch from being run unnecessarily (and the other ones are very much extremely unlikely special cases).\nPrefer that I add \\f or switch to \\s?\nhttps://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions\n. @benjamn That magic code only has to be run during the same execution as innerHTML for it to work, before/after doesn't matter (surprisingly). So supposedly this triggers some kind of this node was just created/added-flag to be set on the node, which stops IE8 from collapsing the whitespace later (when updating/rendering/whatever I suppose).\nI would assume that IE8 tries to be smart and differentiates between creating nodes and updating nodes (or not yet rendered node and rendered node), and this tricks IE8 into thinking it was just created (or not yet rendered) rather than being updated (that would be my (un-)educated guess as to what is going).\n. @benjamn Have updated the comment, will hold off on pushing to prevent the other comments from being outdated.\n// Recover leading whitespace by temporarily prepending any character.\n// \\uFEFF has the potential advantage of being zero-width/invisible.\nReasonable?\n. Also fixed, will hold of on pushing to prevent outdated comments.\n. @benjamn Something like this?\n// Magic theory: IE8 supposedly differentiates between added and updated\n// nodes when processing innerHTML, innerHTML on updated nodes suffers\n// from worse whitespace behavior. Re-adding a node like this triggers the\n// initial and more favorable whitespace behavior.\n. @benjamn Also changed the top comment to this:\n// IE8: When updating a just created node with innerHTML only leading\n// whitespace is removed. When updating an existing node with innerHTML\n// whitespace in root TextNodes is also collapsed.\n// @see quirksmode.org/bugreports/archives/2004/11/innerhtml_and_t.html\nWhich might explain the context a bit better.\n. @spicyj It's either undefined because it isn't supported, or it may be (according to the standard) initialized to '', which I take would be equivalent to unsupported (but recognized). '' is NOT a valid key, it's either recognized or 'Unindentified'.\n. @spicyj Correct, invariant(false) is better too!\n. @spicyj Eagle eyed, thank you!\n. @spicyj Wups, too fast copy-paste!\n. @spicyj I had tested for 0 in which apparently is slower (but tested now, and apparently it isn't?)... anyway, it depends on the browser, but [0] is faster in the slower browsers it seems, so that's the way to go (not that it really matters anyway with 250k call per second on IE8 even). Good call!\nhttp://jsperf.com/queryselectorall-vs-getelementsbytagname/83\n. Fixed\n. @yungsters That's keyPress so charCode is actually the actual character code, and not virtual key code. keyup and keydown are for virtual key codes. Also, while FireFox does generate keypress for some non-printable keys, only it seems to do it, that's why I've added an exception to the SimpleEventPlugin to discard non-printable keys for keypress, to normalize the behavior.\n. @yungsters Yep, but they both contain the same value, I have a comment a bit further down in which about it. Basically, charCode is correct for keypress and keyCode is correct for keydown and keyup, but depending on browser, either of them can be null or the same as the other. This PR also normalizes this behavior so that only one of them is set.\nAlso, enter is special because it actually produces a character.\n. @yungsters Yeah I've been using something similar, but neat! Anyway, I pushed a new change, using translateToKey is broken, as it would actually translate actual characters into arbitrary keys (charCode != keyCode). Proper fix should be to treat enter as a special-case.\n. I did experiment with that, it didn't really make any difference, but as it is currently implemented makes more sense to me at least, as you get nameSoFar ? SUBSEPARATOR : SEPARATOR rather than nameSoFar ? SUBSEPARATOR  : '', so it's more apparent that it chooses one over the other.\n. Oh right, ofc.\n. Fixed.\n. I submit under the influence of extra win!\nBut you're completely right (it's not second nature for me yet to add tests :)).\nPS: It's added.\n. PS2. Technically .. is valid now, but I'm not sure if it's worth guarding against? Or perhaps it actually is.\n. Super nit-picky, but I believe we use single quotes for 'undefined' everywhere else.\nOn another note, would it not make sense to always display the message (appended with for Chrome unless the global is defined), unless __react_devtools__ is defined, that way, people who prefer IE or FF are still made aware of it.\n. @petehunt I'm not sure if it makes sense in this context, but what about something like \"less than 10% of the largest value\"? That way it's relative, and you're unlikely to care about something that is insignificant in the context of significantly larger issues.\n. @plievone Oh wups, I was too fast there, that shouldn't be gone.\n. Or wait no, that is correct, it simply throws it later.\n. I could even greatly simplify it I noticed.\n. @spicyj Aha, then the comment is wrong.\n. @plievone Technically it can be removed, but it would change the behavior, and it seems like @spicyj had a good reason to think it's important to keep it this way.\n. Shouldn't that just be:\nif (value && DOMProperty.hasBooleanValue[name]) {\nIf it's a boolean, then it's a boolean.\n. @jjt The issue I see with only strictly true values is that most things people use as booleans are often not strictly true or false, I mean even Var1 || Var2 could be anything.\nAs for XHTML, I'm not sure if React is even compatible with it anyway (and who even uses it, hehe), if that is something we strive to support (do we?) then I would argue that it's better to detect it and always mirror the key in the value, rather than this weird in-between.\n. @zpao Work computer bugged out so I can't access it from home, they're OK I think, it's just that the ID they set is (basically) irrelevant.\n. You've changed it to always request the DOM node for all autoFocusable-components, I would recommend:\nif (this.props.autoFocus) {\n  var node = this.getDOMNode();\n  if (!node.disabled) {\n    node.focus();\n  }\n}\n. @petehunt batchUpdates? Although... I do like your suggestion.\n. Just a curious thought, couldn't we render nothing with renderComponent(null, or is the root element required for proper functioning perhaps?\n. @andreypopp Not all browsers we support has Node.ELEMENT_NODE, etc.\n. @spicyj Not sure if I follow, seeing as that is the exact condition for the while-loop, it could not possibly be false and trigger the invariant?\nEDIT: Nevermind, I see your point, yeah that sounds reasonable.\n. I actually take it back, haha. It temporarily made sense to me in that it would validate that the result of the move was as intended, but if it isn't then it never leaves the loop anyway. So my original reaction stands it seems, if the invariant is reached it would be guaranteed to be true. Unless you had something else in-mind (other than putting it last in the function).\n. Yeah that makes sense, invariant(childNode.nextSibling != null) should be sufficient and simple I think. As for the variable, tricky yes, my current naming was intended to reflect the idea that it's just a different implementation of the same behavior as insertBefore (insert X before node Y), perhaps index should rather be renamed to beforeIndex which could add some sense to beforeNode (which is just locally caching the value), possibly?\n. Yeah it kind of does, insertBeforeIndex would be the spontaneous solution. But to me that eludes to it being a function and not an index. https://developer.mozilla.org/en-US/docs/Web/API/Node.insertBefore refers to it as referenceElement, which kind of makes sense and points to my function being badly named, moveChildToBefore moveChildBefore moveBefore ... ?\nPS. It's also kind of weird that the arguments refers to elements but the descriptions refers to nodes in that URL.\n. Sounds fine to me and I think we've been using node everywhere else, but perhaps I've just assumed that. I'll take a look and settle on the naming based on what we use elsewhere.\n. Perhaps a bit anal; to me it's not super obvious if it refers to all children, after the given key or or all subsequent children with the given key. Could perhaps benefit from a rewording, \"Child keys must be unique; only the first child for each conflicting key is rendered, the rest are ignored.\", must to emphasize that you should not rely on it as a feature (which seems like a bad thing)... or something along those lines perhaps?\nPS. Children keys is not gramatically correct I think? Child keys sounds better to me, but I'm not 100% sure.\n. @spicyj It can be, but I still need to be able to separate isMouseEvent from isPointerEvent further down below. I guess we technically can save one unnecessary evaluation if we exit early at line 105. But other than that it should be identical, doesn't hurt though I guess :)\n. @petehunt Yes it is, even IE8 has it. While it is possible that some browser does not have it, it will still produce an appropriate error message (console.error not available) and we explicitly mention it next to the shims that the console.*-shim might be necessary. I could do (console.error || console.log) I guess to be on the really safe side, if you prefer (and add appropriate console.* methods to the list).\n. selectNode.removeAttribute('multiple') is apparently not guaranteed to correctly update \"option.selected\"\nMakes more sense?\nI found this while running the tests, removing the attribute for some reason does not update selected for the affected options, causing multiple to still be selected (even though it should not be allowed at that point).\n. @petehunt PS, you probably want to fb.me that link.\n. An oopsie! :)\n. @zpao Considering it calls this.shouldComponentUpdate(nextProps, nextState, nextContext)); it's probably not a good idea to leave it outside.\n. Makes sense, will do.\n. @spicyj @zpao I think we settled on using hasOwnProperty() in the rest of the React code base right?\n. Nit, should be indented like below I believe.\ntypeCheckPass(\n  PropTypes.objectOf(PropTypes.string), \n  {a: 'a', b: 'b', c: 'c'}\n);\n. I know you \"lifted\" this from arrayOf:\n@devs wouldn't simply if (error) be the correct approach, anything can be an error value and I don't see why we need to explicitly test for instanceof Error if it only returns something when it's an error.\n. Yep. The issue #1385 I was thinking of is still open it seems, but I believe we're mostly using hasOwnProperty elsewhere, I personally don't really mind either. Can wait for @zpao @spicyj or whoever to weigh in if you want.\n. This is not correct, \"\\\\\" for instance becomes '\\\\\" if I'm reading it correctly. I could recommend having a look at my previous #1517 which has a very simple and inherently robust implementation (but lacked the CLI option), although it's not as efficient as this could be with the right regexp (but I doubt it's measurable).\n. You can't just replace the first and last character since the string value '\" escapes to '\\\" (the single quote is not escaped). Your algorithm produces the following when I test it in the browser (string literal quotes are included):\n\"'\\\"\"  =>  ''\\\"'\n\"\\\\\"   =>  '\\\\\"\nBoth are invalid JS.\nIt's possible to add manual escaping etc, but I think that in the end it will not be measurably faster than the solution in #1517 and since \" will remain escaped ('\" would become \\'\\\") it in a way actually yields sub-optimal JS. Whereas #1517 is always guaranteed to generate correct and optimal output, as single and double quotes are treated equally by JS.\n(Btw, if you and devs agree, feel free to copy it)\n. Wouldn't it make more sense to introduce a helper (like quoteAttr) for all stringifying (should be used by quoteAttr as well), rather than implement a slight variation of it for each use.\n. They maintain an 80 char limit\nutils.append(\n  'displayName: ' + doubleOrSingleQuotes(displayName, state) + \",\",\n  state\n);\nAlso, inconsistent use of ' and \", we use ' everywhere it makes sense (IIRC the JSX source is a bit inconsistent at the moment). It may make sense to use \" instead if there's a ' that would otherwise have to be escaped.\n. Line 92, remove value: defaultValue, it is no longer referenced anywhere.\n. I'd like to bring up the question again here, shouldn't all input events be in the list? Such as onTap, etc?\nPS. Could probably also benefit from putting this in a separate file and reusing for both locations (including the filter logic).\n. Ah, excellent. Perhaps it should be explained in a comment then.\n. Unrelated optimization\n. Unrelated fix, failing to load a script no longer halts subsequent scripts.\n. Should add script.loaded too then, since that's what contentLoaded really is.\n. !props.disabled should probably be moved to the top and return the original props if it isn't disabled?\n. Haven't checked the code, but I assume onTap should be included here as well?\n. performX / applyX perhaps? diffObjects sounds like it should return the difference. ~~prevObj is not at all the previous object, but rather the current object and what's really going on is that we want the current object to apply the difference between itself and nextObj, so that it becomes value-wise identical to nextObj.~~ IMHO.\n. Is this necessary?\n. It is done :)\n. Seems correct, I tested number/range and both always output strings. :+1:\n. We should be able to replace\ntypeof window !== 'undefined' &&\nwindow.document &&\nWIth just\ntypeof document !== 'undefined' &&\n. Not that it would ever matter, but perhaps this should be typeof document === 'object' &&.\n. Well no, the next would error if document isn't an object (which isn't necessarily wrong though, but perhaps not our \"problem\" to reveal).\n. Can do, I was a bit unsure and did a quick search, found a file using invariant in dev and didn't think more about it. We really should allow people to turn some warnings into errors though, because this is a clear case of \"you really don't want to do/miss this\".\n. Fixed (wups, gotta fix test too, EDIT: fixed).\n. https://github.com/facebook/react/blob/master/src/browser/eventPlugins/AnalyticsEventPluginFactory.js#L183\n. @zpao My intention here was that this only targets IE8, which does support it. As I mentioned somewhere else, we could change the feature test to just document.documentMode === 8, because if some other old browser flunks the test, I really doubt that this trickery would fix it.\n. Change pushed.\n. Correct, fixed.\n. Updated, better? We could use a map instead, which could also do double-duty for discarding valid but invalid style names (cssFloat, styleFloat, etc). Hmm, I guess those are the only two though, as listing all properties with a hyphen doesn't seem very efficient.\nAlso, would you mind sticking the shorthandPropertyExpansions behind document.documentMode < 9 ? AFAIK this only targets IE8, so it would make sense as we could squeeze \"quite alot\" more performance out of it for all other browsers. (Separate PR though, ofc)\n. Note to self, remove this.\n. Hmm? I'm not sure if I fully understand,charCodeis \"character code\" (which is why we can useString.fromCharCode) andkeyCodeis \"virtual key code\". All similarities between the two are circumstancial and (theoretically) implementation-defined AFAIK, but for our purposes it's rather safe to assume thatkeyCode = 13representscharCode = 13` (since keyboards at least agree on enter key being 13 and we \"must\" assume that it's a keyboard typing).\nI should however explain some of that there I agree :)\n. Added doc comment.\n. I thought \"we\" preferred this style, I hate it though so I'm all too happy to change it :)\nFixed.\n. JS\n      } else if (type === 'string' || type === 'number' ||\n                 children.type && children.type.prototype &&\n                 children.type.prototype.mountComponentIntoNode) {\nIs a lot more logical perhaps, otherwise a bit more dramatic (but not as fast, not that it should be measurable):\nJS\n      } else {\n        var isComponent = (\n          children.type && children.type.prototype &&\n          children.type.prototype.mountComponentIntoNode\n        );\n        if (type === 'string' || type === 'number' || isComponent) {\n          ..\n        } else if (type === 'object') {\n          ..\nAny preference? (I've updated according to the first code as it's a lot better at least)\n. @zpao Hmm? That's exactly what's going on here? :) (I find no occurences of unmountIDFromEnvironment) \n. This is actually \"correct\", very sneaky.\n. I'm curious why there is a need to store an object on the DOM node, why not use an internal object indexed by the React ID instead?\n. Ahem? :)\n. @zpao autosave is generally considered a single word it seems (https://www.google.se/#q=define%20autosave, http://en.wikipedia.org/wiki/Autosave) so it probably shouldn't be capitalized like that.\n. Haven't tested actually rendering it, but the property exists even on IE8 and the attribute is correctly updated via manual testing.\n. @zpao Last I checked, document.createElement is crazy fast, even on IE8, we're talking 100K/s+ unless my memory fails me. We talked about caching nodes for getDefaultForProperty but cancelled that because it seemed pointless.\nI don't mind caching, but I really really doubt the cost of this can be measured at all unless there is thrashing involved. If that is, then it could probably be avoided by simply keeping a reference to the last element which should provide sufficient caching. Your call :)\nAdditionally, the cost of this should be immeasurable when compared to the cost of actually figuring out what to update.\n. @mtsyganov Why does it target IE8-10 also though?\n. JS\nf = document.createElement('form');\nf.acceptCharset = 'a';\nconsole.log(f.getAttribute('accept-charset'));\nf.setAttribute('accept-charset', 'b');\nconsole.log(f.acceptCharset);\nPrints A & B correctly for all browsers I have access to.\nAlso:\n```\n\nReact.renderComponentToString(React.DOM.form({acceptCharset: 'utf-8'}));\n< \"\"\n. @spicyj I imagine it should be quite simple, but perhaps SVG could be an obstacle?\n. No... but I fixed it anyway ;)\n. As I assume this is a supported attribute (or else it should be removed), not using `DOMMutationMethods` at all and setting the attribute (as implemented by the standard) instead seems favorable.\n. http://www.w3.org/TR/html-markup/video.html says it doesn't exist, so it shouldn't in React either.\n. `!!checked` ... but that shouldn't be needed either, I'm pretty sure `checked` is enough.\n. While not technically wrong, setting only `radioB.checked = true;` is enough.  \n. Radios only emit `change` when checked, not when unchecked. So this should be removed I believe.\n. This shouldn't actually be needed I think. It should be safe to just put `null` instead of `this.handleChange` for ReactLink (applies to all of them).\n. I think `var node = stub.getDOMNode();` could make sense as it's used repeatedly.\n.\n    var RadioInput = React.createClass({\n      render: function () {\n        return (\n          \n        );\n      }\n    });\n```\n\nShould be enough I think.\nTechnically this should even be enough:\nvar stub = ReactTestUtils.renderIntoDocument(\n  <input type=\"radio\" checkedLink={new ReactLink(false, null)} /> \n);\nBut perhaps we don't want to do that? @zpao @spicyj \n. Those were all the keys I had on my keyboard, but you're definitely right it seems, I found that the URL I initially used to create most of that list (in the comment) has been moved and substancially updated:\nhttps://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent.key\nIt doesn't actually list them for Windows which is odd, but it does list quite a few more of them. Anyway, I updated the list with all 16 of them:\nraw     gz Compared to master @ 35764c5ffb14ac80dc05f64d9b1b234660784775\n   +469   +156 build/react-with-addons.js\n  +310   +116 build/react-with-addons.min.js\n  +469   +152 build/react.js\n  +310   +108 build/react.min.js\nProbably not worth it, but...\nif (key.substr(0, 4) === 'Dead') {\n        return 'Dead';\n      } else {\n        return key;\n      }\nraw     gz Compared to master @ 35764c5ffb14ac80dc05f64d9b1b234660784775\n  +152    +59 build/react-with-addons.js\n   +29    +22 build/react-with-addons.min.js\n  +152    +52 build/react.js\n   +29    +20 build/react.min.js\n... what's your opinion?\n. Huh?\n. This still being an object seems fairly useless, why not an array?\n. I'm not a fan (I think) of createDescriptor having two distinct behaviors depending on whether it was a passed an object or a string. It seems to me that createDOMDescriptor seems preferable (for strings) and would then play nice with other non-DOM React frontends. But I also suspect you have a rather good reason for doing this :)\n. PS. I also imagine we have some potential for improving compression here by mapping to say createDOMDescriptor.div(...), etc instead, which I imagine could be further improved by also using mangled the names. But it would certainly not be mind-blowing.\n. @sebmarkbage Huh? mapObject({a: 'a', ...}, createDOMFactory); function createDOMFactory(tag) { ... as far as I can make out the key is discarded and never used... ?\n. Oh ofc. :+1: \n. Ah, makes sense in that context.\n. Doesn't this also apply it for member expressions?\n. Sound :+1:\nPS. Although I'd check for member expression and not for ..\n. Is this something we want to start doing in other places too? It could mess with certain polyfills unless they're run first (which they obviously should be).\n. Sanity check, could <:abc... or <_abc... be used to \"break out of the tag\"? EDIT: Cursory testing seems to confirm that they are not interpreted as tags, this could be dangerous if we intend to start using the relaxed HTML encoding rules as attributes could then contain valid tags which would be parsed.\n. Even though NameStartChar includes _, it does not actually appear to be parsed as a tag by any browser: document.body.innerHTML = 'a<_A id=\"<b>b</b>\">c';\n. Not specific to this PR, but couldn't we check navigator.vendor instead of this UA hacking?\n. Makes sense, realistically we should probably do navigator.userAgent.indexOf('Chrome/') or a regexp to avoid false-positives, but not really a big deal as it's dev only.\n. This should be renamed to isNode as well right?\n. Commenting here for simplicity, expected a node prop. right?\n. Or why not nextSource.hasOwnProperty(key)? (but perhaps that is a spec detail, to avoid invoking user functions?)\n. developped\n. Nit, but shouldn't bullets end with a dot?\n. ~~value: 0 is ignored.~~ NVM, this is the entry, but why do we need this test? .done should be all that is needed.\n. Why not use entry instead?\n. Symbol should always be a function I think?\n. I know I pointed you in this direction, but it should actually be preferable to just use ReactMount.getID instead. PS. Also you can't use the id argument because it's for the old node, not the new.\n. @ThomasCrvsr node is a DOM node. ReactMount.getID(node) reads the ID from the node and if it isn't in the cache, puts it in the cache, we don't need the return value. So it fulfills all the criteria for making sure the node is in the cache.\nPS. Technically, I would like the component instance to be an argument to ReactDOMIDOperations.* instead and read the ID from that, but it's probably not something we should do now.\n. Right, what I meant is, why check for undefined (which tests true for booleans, numbers, strings, etc) instead of function?\n. Sounds sane, but then the same safety check should be applied for the \"set iterables\" below right? PS. Or perhaps it just doesn't matter because it will be undefined anyway... so yeah, ignore me :)\n. Yeah I realized that just after I wrote it :+1: \n. One last thing :)\nA comment briefly explaining that getID puts the node in the cache and that we do this to avoid holes in the cache (which can otherwise cause all siblings to be unnecessarily re-cached). It would be great info for anyone else stumbling upon this code.\n. Grammar is a little off, something like this perhaps:\n// `getNode` populates ReactMount's node cache with all siblings, but the\n// replaced node creates a hole. `getID` fills the hole with the new node.\n. Don't need to repeat it here.\n. Yes, it should be the only behavioral change.\n. Because that is the \"default state\" of a select, nothing selected.\n. Correct and sounds good. Fixed.\n. Hmm, when did we start doing this?\n. Why not make it conditional? There is a perf benefit. (But do verify that the implementation is native if you do, there are some O(n) out there)\n. Hmm interesting, I actually got marginal but measurably improved results in my PRs from using Map rather than storing directly on nodes. But yeah, tests and all that is a big issue for now.\n. ```\n\n\ndocument.createElement('div').style.font = '';\n  \"Invalid argument.\" (error)\ndocument.createElement('div').style.fontSize = '';\n  \"\"\n``\n. But you exposeremoveStatehere...\n. Oooh, it looked like it was exposed in the component. Then it's all good :)\n. Aaaah shit, ofc it should be.\n. It's the old license even :)\n. My vote goes toifinstead of this nestedswitchnightmare.\n. You have 3 else-branches with the samecommaPos = i+1;, it should be possible to reduce and flatten this unless there's a very good reason for this verbosity.\n. I'm suuuuuuuuuper weary of this, there are tons of O(n) polyfills out there and it would be a bad day if you were using one. One solution is to check for[native code]inMap.toString().\n. Really shouldn't modify the browser environment. Also not sure why you do that_Map = Map\u00b4 thing.\n. O(n) remove sounds like a bad idea. PS. cloneWithoutKey? Why not delete the key?\n. I'm not entirely sure what you're trying to achieve, you can't do a cross-browser O(1) Map without modifying the key object and then you're better off just doing what ReactInstanceMap already does.\n. State-machine type of deal and all that... but this could be reduced to value.substr(i, 2) === '//', etc. @zpao?\n. :+1: done\n. Both React.createFragment and React.addons.createFragment mentioned here.\n. Should use assign({}, props.style) I think? Ok, that wasn't actually part of the PR :) nvm\n. Ah thanks.\n. Feature test instead of try/catch.\n. Just check if the method exists instead?\n. if (parentNode.childNodes.item) is an exact feature test, no need to pin-point a specific browser with a generic test. ~~Although you might want to make it document.childNodes.item (if id=\"item\" would interfere?).~~ Anyway, I just tested in IE8 and childNodes.item is there, so I'm not sure if this fallback is even necessary?\n. As far as I can tell, you simply can't index outside the size of the list, so something like index < parentNodes.childNodes.length ? parentNodes.childNodes[index] : null should be enough.\n. This seems fragile considering there's lots of code beneath this that may or may not need to be executed, when all this really wants to do is discard the call to onChange right?\n. Intuitively it seems like a bad idea to apply different logic depending on whether or not the component is controlled, tracking the last value and always comparing that seems like the simplest and safest approach?\n. Urgh, there's also a question of what constitutes the \"last value\" from which to determine if the change event should fire I guess, the last one provided to the component or the last one in the DOM input. There's a problem in that the value of DOM inputs can and will change outside of our control/knowledge and unless I'm mistaken there is no 100% robust mechanism that allows us to know the actual last value of the DOM input.\n\n\nPerhaps I'm overthinking it, but it seems that either we need to know the last value of the DOM input (which isn't robust AFAIK) or we need to know the last value of the input component but that is only a partial solution (and only for controlled inputs at that).\n. > I want to say in those cases the \"right\" thing to do is use the  value  prop as the last value\nThat can only be applied to controlled components, not uncontrolled. Uncontrolled components are frequently updated through directly setting the value property.\nAs for controlled components, don't quote me on this, but it's probably a no-go to look at the value-prop for controlled components. Batching/deferring means that the value-prop might not actually be the last value, only a previous value.\n. @spicyj Could it not make sense to toString them instead of skipping, making it even more prominent that some invalid data has been passed to something that only accepts text.\n. boolean too I assume?\nhttps://github.com/facebook/react/blob/cf4bef8bd7e62e96775992417db436ac6f5809b7/src/utils/traverseAllChildren.js#L102-L109 for reference\n. true didn't get any love?\n. It's safer and faster to store the result as a property on the function (and use WeakMap when it becomes widely supported). It's not super sanitary, but pretty common JS-practice.\n. This seems superfluous to me at least. Object.create should be enough, a broken environment is not our problem I would think...\n. This is really a micro optimization and seems like overkill (to me at least), if this is something we want to do I'd probably leave it at just if (end == null) end = 0x7FFFFFFF; (or w/e) and avoid the end-test inside the loop.\n. Please keep all lists sorted.\n. I'm not entirely sure about this, but this is superfluent I believe. This is only for events that explicitly can emit events the instant the node is mounted into the DOM (and otherwise risk getting lost). Perhaps it applies to some of these onLoadStart (etc) perhaps, but I'm sure it does not apply to all of them.\n@jimfb @zpao correct me if I'm wrong.\n. Oooh, yeah that too. All good then :)\n. This shouldn't be inline (to avoid unnecessary overhead).\n. Ah, no I meant to put it outside the function since it's a static object, so it isn't recreated every time it's called.\n. Perhaps this logic should be shared for guaranteed consistency? (instantiateReactComponent has it too)\n. Can this actually be reached? It's kind of hard to tell at first glance, but this only targets IE8 right? So it shouldn't be.\n. We should prefer to use addEventListener when it's available, or is there a specific reason not to?\n. There is no documentMode greater than 11 (and probably never will).\n. documentMode does not exist in MS Edge. Also, it seems weird to assume this would somehow be fixed in this theoretical version 12, it doesn't seem right to have a special-case for a browser we know nothing about.\nPS. So yeah, doesn't really matter to me and probably won't ever matter, but it seems weird.\n. @jimfb But... \njs\n  doesChangeEventBubble = isEventSupported('change') && (\n    !('documentMode' in document) || document.documentMode > 8\n  );\njs\n      if (doesChangeEventBubble) {\n        getTargetIDFunc = getTargetIDForChangeEvent;\n      } else {\n        handleEventFunc = handleEventsForChangeEventIE8;\n      }\ndoesChangeEventBubble should only be false for IE8 and thus it shouldn't go down that path for any other browser as far as I can tell. Or am I reading this wrong.\n. @jquense I have access to IE8-11, but yeah, if this works and was this way before, let's just keep it that way. No point messing with legacy browsers over a nit.\n. Seems safer to test for document.documentMode rather than MSIE I would say.\n. Like this please: https://github.com/facebook/react/blob/401e6f10587b09d4e725763984957cf309dfdc30/src/isomorphic/deprecated/cloneWithProps.js#L21\n. Made a comment here for now, but unless I'm mistaken this is a bug elsewhere that we should probably look at separately.\n. We can't really do this, updating the value of inputs via script is allowed for uncontrolled inputs and these updates would not update [LAST_VALUE_KEY]. Also, as far as I can tell, this implementation does not update [LAST_VALUE_KEY] when the value an input is updated for controlled inputs either, but that is fixable (although slightly hacky perhaps).\n. > Missing an update should be fine since the next raised event will update the cached value\nBut it's not fine if something reverts what the user typed and he types it again, it will then think the value hasn't changed, while uncommon that would be a severe bug.\nI'm also skeptical of something like this if there are edge-cases where we are still triggering when the value hasn't actually changed (which can happen if the cache is wrong). If it's not 100% then the end benefit of this seems little more than a performance optimization, IMHO a good thing but perhaps not in relation to there being a fragile element to the implementation.\nAlso consider that we still don't know when auto-filling occurs in some browsers, this is a troublesome area.\n. @jimfb The shallow-equal check should really use Object.is, then this problem should go away naturally.\n. This seems unrelated?\n. I don't know enough about testing and how this is used, but if it affects behavior for the event received by the callbacks then this seems wrong.\n. This can't be right I think? false || undefined => undefined and then later controlledValue !== undefined. Why not compute controlled instead of value? The value isn't used anywhere.\n. js\n    return function() {\n      var args = arguments;\n      MSApp.execUnsafeLocalFunction(function() {\n        return func.apply(null, args);\n      });\n    };\nMaybe?\n. I tried that too back then, made no difference that I could tell.\n. This should move to a separate file at https://github.com/facebook/react/tree/master/src/shared/stubs\n. Not saying it shouldn't be changed, but it only applies to HAS_SIDE_EFFECTS which is only used by value.\n. If HAS_SIDE_EFFECTS is now unused then the corresponding logic should be removed from DOMPropertyOperations as well? (PS. Also, this is outdated and needs to be rebased)\n. Sure thing, that seems like a better test (and no toLowerCase() :+1:). I'm just curious though, elsewhere we use the test I implemented above, is that just a transitional thing and to be replaced?\n. Oh right, I don't think this will work for true XHTML-documents? nodeName is reported with the case as-is there IIRC? (hence toLowerCase())\n. Am I missing something, why not create the svg directly and drop the div? EDIT: It seems to have innerHTML, but perhaps it doesn't actually work?\n. @spicyj Perhaps it makes sense to check for the SVG namespace as well?\n. Hmm... is it possible that this could break due to improper namespaces or does HTML enforce the SVG namespace on descendants of an SVG-element? I think not? But perhaps the element does not work correctly either without a proper namespace?\n. What purpose does parseInt have here?\n. null surely and not the string 'undefined'?\n. This entire thing would probably make a lot more sense as if-statements.\n. O(n^2) performance seems far from ideal.\n. They can also be nested inside arrays/maps/sets etc, so this does not work reliably.\n. Also not to forget that <optgroup> is a thing.\n. Duplicate values is valid for uncontrolled components, so we probably shouldn't warn in that case?\n. != null I would assume? Or?\n. Children are not required to be only elements. This needs to check the type (also related to composite components as mentioned by @jimfb, shouldn't check the value of those).\n. Also, children can be null or an element (not wrapped in an array). I'm not sure whether it is supported or not yet, but IIRC the idea is also to support anything that is iterable as valid value for children, so we can't assume this to be an array in that case?\n. We only care about this in DEV right?\n. toLowerCase() is necessary, XML documents report the original case.\n. @git-richard The value is stringified (inspect the DOM) so in your case they are actually the same.\n. If we can avoid O(n^2) definitely seems favorable I'd say. EDIT: For most it probably doesn't matter, but consider it's just a warning, ensuring it never balloons seems like a good idea.\n. Needs to use hasOwnProperty. I'm not sure if it really matters, but it may make sense to explicitly stringify value as well?\n. can be non-elements too, have to make sure it's a JSX element first.\n. as above, but also check that it's an option. Should try to reuse the duplicated logic below.\n. check for value instead, that's what determines controlledness.\n. can also be recursive structures, i.e. arrays inside arrays, etc.\n. It can be any primitive value, especially null/undefined, additionally whitespace strings will not cause warnings in next React, but that's kind of besides the point. You need to explicitly check that it's an element before working on it or the code will throw in some cases.\n. IE8 does not have it, and it seems like a bad heuristic which internally checks every node for the attribute. Wouldn't it make more sense to just keep a counter?\n. > The problem i was trying to avoid by counting is that only works if code unmounts each and every component helping the counter stay accurate.\nYou must explicitly unmount any nodes via React, simply removing them from DOM is a bug and can have some very nasty side-effects. So if someone has forgotten to unmount via React then they have far bigger issues than listeners not being cleaned up.\n. Quickly reading this I'm having a little trouble understanding the exact flow, if I understand this correctly, this seems like a wasteful way of doing it. Allocating a new callback which holds an array of callbacks, instead of keeping a single global array of callbacks? Or am I missing something.\n. Just curious, since this might be somewhat of a hot path. Have you benchmarked this against REGEX.test(text)? With REGEX being a constant and not inline.\n. Perhaps clarify that this is because of \"propertychange\" and not because of actual change events.\n. I'm assuming this fails the lint line length rule?\n. I'm care-face on this (not my decision). If it's a problem just leave it as is and they'll complain if need be.\n. .keys() is not yet supported in all implementations, IE supposedly does not support this. EDIT: Array.from is even less widely supported.\n. My bad I missed it. It should sufficiently cover the case of .keys() I imagine :+1:  EDIT: Yep, .keys() is not part of \"basic support\".\n. @zpao muted is only MUST_USE_PROPERTY because user interaction affects its actual value (like input value).\n. Has been discussed before and rejected. I don't think anyone feels super strongly about the current implementation, but changing it means breaking a lot of code.\n. value is shared by <progress> (and some other tag?), so this seems like a no-go. A progress with null value must remove the attribute.\n. Nit, but this wasn't really necessary :)\n. Maybe a bit nitpicky for setState callbacks, but wouldn't it make more sense to save the first error instead? (or possibly all errors even) There may be cases where one error puts some module into an invalid state and all subsequent calls will fail with some meaningless error, this makes it hard to identify the initial problem.\n. If we're concerned with performance then IIRC setting textContent or innerHTML is unintuitively significantly slower than simply clearing the children one by one.\n. \"on every value change\" if you want to be truthful, it's not just about keystrokes ;). @aweary True, it's tough to be precise for that one. Could add \"by user\" or something, but perhaps \"every keystroke\" is good enough, I assume most will correctly interpret the intent (or simply not consciously think about there being other ways to mutate the value and not question it).. This should be one line up, outside the namespace-check.. Need to trim trailing spaces in your file.. I don't believe React actually supports IE8 in DEV anymore so this should be redundant then. Devs?. It's not apparent to me why checking against voidElementTags makes sense here.. Intuitively you either have a whitelist of all the currently known elements and the warning is then used to raise awareness that you have made a typo. Or you don't have a whitelist and the warning is used to indicate that you're rendering an element that isn't understood by the current browser.\nThere are many tags not supported by every browser, whitelisting just menuitem (and self-closing tags) seems like an arbitrary in-between. IMHO you should pick one or the other (@aweary?).. E.g. spellcheck is not a boolean attribute and expects the value 'true' or 'false', if anyone relies on boolean being stringified today it will break for them (I assume? or is that another codepath). Also note that neither 'true' nor 'false' is the default value for it.. #9806 seems relevant to this as well.. Not quite sure what you're asking. The key thing is that multiple individual options will still have selected set to true in the DOM when removing multiple as an attribute in some browsers. So you need to render with multiple and multiple options selected, then remove multiple and verify that only one option is set in the DOM. The logical way would probably be using an uncontrolled select (because that also avoids controlled behavior potentially fixing it).. @gaearon Doesn't that mean the current implementation is broken then? (EDIT: if we care about fixing it). The new test seems wrong to me, the second render should be <input ... value=\"\" /> to be truthful to the original test-case (it's about preserving the initial attribute value). But AFAIK this changed way back when you made the attribute always reflect the property for input value? So this should fail.. Can rootContainerInstance even be a document node?. Why test for doc.ownerDocument? I don't know why it would ever be falsy and if it is then your code would break anyway, you would be trying to call createTextNode on some random element.. PS. rootContainerInstance should be changed to doc for consistency.. Also, is it really guaranteed that rootContainerInstance belongs to the same document you're trying to render the TextNode into? I would think that rendering an iframe and into it would break this assumption... or has this changed?. js\na = document.createElement('noscript');\na.innerHTML = '<b>foobar</b>';\nconsole.log(a.childNodes);\nOutputs a single TextNode for me in both Chrome and Edge (it does not parse the b-tag), which seems to contradict the comment and the whole reason for this existing... right? Is there more to it than that?. ",
    "clayallsopp": "What do you think about: \"Learn more about why to use React, or dive into the API reference and start hacking!\"\n(btw I dig the CLA process :+1:)\n. Sweet, I went ahead and saved you the trouble of squashing it.\n. (for anyone wondering, it's completely plausible and maybe even likely that fbcdn.net is blocked on some firewalls)\n. ",
    "sebmarkbage": "@tomocchino has been thinking about a declarative way to do component level event listeners. You could imagine declaring your events on the component class or in mixins. Something like:\njavascript\n// warning: Not real API\neventHandlers: {\n  root: {\n    onClick: function() { ... }\n  },\n  someRef: {\n    onClick: function() { ... }\n  }\n}\nThat would allow you to separate the event handlers into a mixin and also use more explicit event delegation. It can also avoid allocation during reconciliation. So I think that would solve your use case. This is not currently on the short term road map though.\nPersonally, I'm looking to get away from using mixins as much as possible. There's a lot of problems composing mixins that you don't get with composable components, which after all is one of the things that makes React great.\nFor example, to trap clicks on links you could wrap your components instead of using a mixin:\nrender: function() {\n  return <LinkTrapper usePushState={true}><div><a /><a /></div><div><a /></div></LinkTrapper>;\n}\nSince the events bubble, link trapper can catch them with it's DOM node. Currently LinkTrapper must define an extra, unnecessary DOM node to attach it's event listeners to. We could potentially create a fake component that can retrieve event listeners without actually rendering to the DOM. Then the implementation of LinkTrapper would look something like this:\nhandleClick: function(e) {\n  // check if event's target is an anchor and invoke pushState API\n},\nrender: function() {\n  return <FakeDOMNode onClick={this.handleClick}>{this.props.children}</FakeDOMNode>;\n}\nI don't see us exposing a public imperative API since that goes against the declarative/functional approach that gives us a lot of benefits. However, we may expose access to the ReactEventEmitter or something for special low-level components that needs to reach under the hood.\n. I wanted this for mousemove and mouseup as well. :) We're thinking about a larger declarative event system that could do conflict resolution but we should probably get this in the mean time. Not sure about the API though.\n. OT: HTML5 compatible browsers will allow this, while others require the XML namespacing. I'm not sure if there's any one of those alive anymore. Usually Android is the problem but they don't even support SVG at all in older versions.\nNit: We could reuse a single array for the SVG definitions. That SVG list is going to grow since there are a lot more SVG tags than that.\n. CSS's .style gives you the provided value and not the actually rendered value. You get that from computed style. This seems to be pretty idiomatic. That when you provide a value that will later be flush, the default is to read back the last provided value, not the latest flush.\nPeople have this intuition of setter/getter semantics anyway because of the naming of this.setState.\nInside the render phase, this.state currently changes meaning. It's the rendered state outside of render and then the pending state inside of render because it hasn't flushed yet and it's inconsistent with what has been shown on the screen and inconsistent with the current value of the children.\nIt's very inconvenient to do counters and anything that relies on sequence of actions without easy access to pending state. It's also a very common use case.\nIMO, the case that @jordwalke states is a special case use case. You should avoid refs as much as you can, and do top-down flushes.\nFor these reasons I feel strongly that this is an awesome change. I'll test it out a bit and see if something breaks.\n. Believe me the performance of that was well contested when people trusted micro-benchmarks more than real world usage. I'd be very hesitant to mess with that optimization. The next bottleneck is getting the multi-var arguments from the convenience constructor into here. Potentially through another constructor function. Thankfully modern engines will help us there.\n. @cpojer What's the perf results in IE8?\nI agree that we don't have enough good tests and tools to do perf testing reliably right now. That means that we're often best suited to use our own intuition atm. That means we shouldn't block on potentially misguided optimization efforts.\nHowever, this code has been through a lot of testing in individual products which have been fine tuned. This was not found to be a bottle neck. Changing this code path may or may not cause a regression in those products. Something we may not discover much later.\nIMO, it needs to be a clear win for this refactoring to take the place of the tested code. I.e. a new API surface or clear readability win. IMHO, this is mostly subjective and unnecessary risk.\n. If this was new code I wouldn't have a problem with it. Since neither had been tested and we'd just be speculating.\n@cpojer that would've been good to have in the initial description. If this is something we imminently need for static analysis. Let's continue that offline.\n. It's a heuristic. The typical use case for variable number of arguments is that you always provide the same set with the same number of items. E.g.\njavascript\nreturn React.DOM.div({}, Foo(), this.state.x ? Bar() : Baz());\nThat doesn't need keys because there will typically be two slots for children and it's predictable where update occur. The keys are inferred.\nHowever, if you're providing a dynamic data set which grows/shrinks. E.g. based on data, then there's no way for React determine how to do updates without keys. It is never legitimate to provide a dynamic set without keys (even if they're always in order):\njavascript\nvar list = this.props.data.map(item => item.x ? Foo({ item }) : Bar());\nreturn React.DOM.div({}, list);\nInstead of waiting for a race condition to screw you over, we issue this warning based on a heuristic. Dynamically we can't tell a dynamic array from a static set that is always the same one.\njavascript\nreturn React.DOM.div({}, [Foo(), this.state.x ? Bar() : Baz()]); // static or not?\nIt's never legitimate to ignore the warning. You should always provide keys by default. The heuristic is only a helpful way to avoid keys in a common case when we can fairly safely infer it.\njavascript\nvar list = [Foo({ key: '0' }), this.state.x ? Bar({ key: '1' }) : Baz({ key: '1'})];\nreturn React.DOM.div({}, list);\nThere is also a convenient way to provide keys based on property names of an object:\njavascript\nvar a = Foo();\nvar b = this.state.x ? Bar() : Baz();\nreturn React.DOM.div({}, { a, b });\n. Note that even if your dynamic set is always in order, you should still provide the index as the key:\njavascript\nvar list = this.props.data.map((item, idx) => Foo({ item: item, key: idx }));\nreturn React.DOM.div({}, list);\nThat explicitly declares that you're fine with the interpretation that state gets preserved based on the order of the list rather than some persistent identity of the item. That keeps you safe if the heuristic would ever need to change. It almost communicates that you've considered the problem of tracking changes in a set.\n. I think the key (no pun intended) to debugging warnings is to highlight them in the React Developer Tools. We could add that feature. That way you have enough context to backtrack to the component that ultimately caused the problem. Unfortunately, if you're lacking the displayName property, you'll likely have less context in the React Developer Tools too.\nI'd highly recommend manually adding displayName to your components, if you don't use JSX, to help with debugging.\n. Right, but perhaps we should also forbid null while we're at it?\n. If you use ReactChildren it won't coalesce later since it turns them into ReactTextComponent first. It would be nice to keep them as strings until they're mounted I guess.\nI'm not sure if it's worth while thrashing on these edge cases until we can get a consistent experience where we're never wrapping with spans and can clean up all the ReactTextComponent weirdness.\n. The solution is to use onMouseEnter. This is why we had onMouseOver disabled before because it gives confusing effects in certain circumstances.\n. I like rAF batching and I like add-ons but I wish we didn't have a React with add-ons build. It seems so final and official. It should be easy to expose these. They're really all candidates to be in the core. It's more of a alpha extensions build.\nWe should take a page out of the old MooTools playbook and allow custom downloads: http://mootools.net/core/\nWant even more? Get some more plugins: http://mootools.net/more/\n. onlyChild should only be used on Components (soon to become Component Descriptors).\nYou can still set the children prop to a function and just assume that it's a function, and call it as a function.\nI wouldn't do that with the second argument to the component constructors though (that translates to the children property). I.e. the \"children\" position in JSX.\n@swannodette Do you need to use the second argument or can you use an explicit property named children?\n. @vjeux I can't think of any case where generics are ambiguous with JSX. Because they're always preceded by an identifier which is not valid JSX. They're ambiguous with JavaScript though!\nType casting is a big issue though. The parenthesis doesn't help.\nMost cases are actually not ambiguous:\n(<foo>x) // cast\n(<foo />x) // error, x is invalid after a component\n(<foo />) // jsx\n(<foo attr=\"\">x) // error, missing closing tag\n(<foo attr=\"\">x</foo>) // jsx can be early determined by the attributes\nThe parsing code and error messages becomes really weird when you have an opening tag without attributes. You have to optimistically parse ahead a long way to find the matching closing tag which breaks the ambiguity.\n(<foo>x + (y) + </foo>)\nEven then it's ambiguous with regexps.\n(<foo>x</foo>/+5)\n// could mean:\n(<foo>(x < new RegExp('foo>') + 5))\n// or\n(foo(null, x) / 5)\nSo, yea. The type cast syntax screws us up. I really want to make this work though.\n. @spicyj It's not valid TypeScript though. Need to make it into a RegExp to make it ambiguous I think. Maybe you can think of another case?\n. Ideally we would use\njsx`<foo>${x}</foo>`\nTo make it fully executable ES6. I think that JSX is always close to being more of a pain than it's worth. Compared to just invoking functions. Back ticks, as small as they seem, might be the final straw.\n. I guess back ticks would actually remove an ES6 feature unless we prefix with something. So it doesn't work without a prefix anyway.\n. Yes. I agree that infinite lookahead is not an ok solution. It's more of a thought experiment to see where it leads us.\nI think that you're right that an alternative syntax for cast is the right way to go here. Particularly since this syntax is not really intuitive or common for the current use in TypeScript anyway. It would seem that making that change is possible.\nSome ideas without really thinking it through... The simplest most intuitive to me is that you type the expression:\nvar x = { } : foo;\nAnother alternative would be to add a contextual keyword somehow:\nvar x = cast<foo> { };\nvar x = cast { } as foo;\n...\n. How about we make warning tool just like invariant that takes multiple arguments?\nThen we make toString of Components output \"ComponentName [OwnerName]\".\nThat way you can just pass a component to warnings:\nwarn(\"This component is screwing up: %s\", component);\nand you always have the context in a consistent way.\n. invariant throws. this should just warn but it looks like it's coming here: https://github.com/facebook/react/pull/912\n. Follow up pull request for react-art? (I think that's the reason)\n. This should use console.warn and probably be called something like warn. I spent a day once trying to figure out why an error wasn't interrupting code flow because it looks like it's thrown.\nA rename to a short stand-alone name would be good. It's really nice to be able to statically analyze these.\n. @cpojer we don't need to do the string parsing since console.warn supports %s in the same way.\nconsole.warn(format, ...args);\n. shim it :)\nIt's cool because it uses toString so we get custom formatting. But the inspector could turn that part of the string into a link to an object that can be inspected.\n. We could also make it non-enumerable since this is browser specific. How bad would it be to make it always on in prod too? If you have a conflict it would be there in DEV too.\n. @ehd Don't worry. It won't impact performance unless you have the inspector with the React tab open.\nI could see this being a problem if you have some environment that validates that you're only running in your sandbox. Such as Caja.\nTo create a new global, we'd either have to assume that window is the global or create a non-strict function that returns \"this\". The former is probably the safest bet.\n. @jordwalke sure? I don't think so.\nI like this proposal because it discourages mutation after initialization as a way to build up props. That should ideally be disallowed so that prop warnings can be issued earlier.\nThe only downside is that it prevents us from moving towards a named arguments or exploded arguments model instead of passing a props object.\n. Could you expand a bit on the rationale for why you don't consider key synonymous with identity? As I see it, key encapsulates the identity of the child. However, since you could have multiple instances of the same user, it may also encapsulate some positional information in addition to that.\nI rarely, if ever, see a use case where the identity should not be part of the child. Could you expand on a use case for this?\nNote that the key hack can also be used at the top level. So this feature can be hacked by simply wrapping once.\nI'm concerned about having two ways of doing this, and in the general future direction we're moving even more responsibility of updates to the parent. E.g. the parent needs to reason about how an update to a child gets handled, where it gets placed and how it may affect other siblings.\nYou also bring up an interesting point. Should the state of the inner child be able to cause the child itself to unmount? I don't think it should be able to. That may break the assumptions of the parent. I'd love to see a real use case for this.\n. For a set (unique values) the identity of each value should be favored as the key, since that clearly identifies reorders.\nFor a map (e.g. a dictionary) the key of the map should be used as the key of the list item. Often though, that list item is a generic item wrapper around a value. The value is represented by a different component and therefore gets it's own key based on the identity of the value.\nComponentA === ComponentA and ComponentA(car) === ComponentA(airplane) are both checks that are currently available, except that they're based on keys and they live in the parent. This makes the strong contract that a parent decides if something gets places, where something gets placed (even if a component travels though multiple intermediates) and when it's removed.\nIt would for example be very strange to have a child allowed to unmount itself. Therefore I think the concept of unmount/remount is the wrong abstraction here.\nI see the problem that you have though. It's true that you wouldn't want to leak details about the internals of a value to the parent. That possibly breaks encapsulation.\nCurrently a component should be able to handle any change. Major changes to the props can also affect state through componentWillReceiveProps, allowing the internal state of a component to reset. Albeit, not necessarily the entire component tree. However, ideally the entire tree should be resilient, but if it's not, you can use a key where you wish to reset part of your tree.\nI would be much more comfortable with an API that helps you reset your internal state and flush all your children, rather than telling your parent to remount you. The child should never be responsible for it's own life-cycle, but can be responsible for it's children's life-cycle.\nSomething like shouldRetainChildState or something would be nicer but affords less control than keys since it can't be applied to a subtree. This could be accompanied with an easier way to handle operations that you want to do on both mounts and updates. For example: componentWillMountOrUpdate.\n. As a side-note, I really wish Components didn't have so much boilerplate and stigma associated with them. If Components felt more lightweight, this wouldn't be as much of a problem, since you would just wrap it in a function call.\njavascript\nreturn <ul>{items.map((value, key) => <Component key={key} value={value} />)}</ul>;\njavascript\nlet Component = props => <InnerComponent key={props.value.id} value={props.value} />;\n. @syranide Putting it in traverseAllChildren would require a lookup map within traverseAllChildren which is otherwise not necessary.\n@spicyj Ignoring would work too. Simpler to implement. As long as we have warning hook.\n. I think this diverged upstream. I'll let @zpao figure this one out.\n. @syranide if you pass a component descriptor as props, then the thing you pass it to may rerenders without you rerendering.\nI'm not sure what you mean by the unmount scenario but I think this won't be a problem once we stop mounting the same instance and have true descriptors.\n. Remounting the same descriptor again only breaks if you switch back and forth between two of them and we're fixing that with the 0.11 release anyway.\nThe typical pattern for mutable objects in state is that you rerender the component which expects updates. If you rerender the component that pass props, then you should be recreating the descriptor.\n``` javascript\nvar Outer = React.createClass({\nrender: function() {\n    var child = ;\n    return ;\n  }\n});\nvar Inner = React.createClass({\ngetInitialState: function() {\n    return { clicked: false };\n  },\nhandeClick: function() {\n    this.setState({ clicked: true });\n  },\nrender: function() {\n    return {this.props.child};\n  }\n});\n```\nYou could modify the props of the outer component for this to break:\njavascript\n  handleClick: function() {\n    this.props.child.style.color = 'white';\n    this.setState({ clicked: true });\n  }\nThis is already a terrible pattern that is broken for many other cases. If you mutate objects, it should at least be your own. transferPropsTo already explicitly isn't allowed on components owned by someone else for this reason.\nAnother way to break it would be by creating the instance outside the render flow.\n``` javascript\nvar child = ;\nvar Outer = React.createClass({\nhandleSomething: function() {\n    child.props.style.color = 'black';\n  },\nrender: function() {\n    return ;\n  }\n});\n```\nThe original proposal was to do this optimization using the owner level as a reference. That would solve the last case where the child doesn't have an owner and therefore isn't recreated.\nEnforcing strict recreation also allow us to reason better about pooling since we know for sure that old instances are no longer needed.\nSo in short. I think that we can still allow mutation of state objects in most cases but you need to recreate component descriptors in the thing that is rerendering.\n. oh this is not in ReactCompositeComponent. Then this PR makes sense as is.\n. Yes. This needs to get out of props at some point. Definitely. I think it's fine to do that separately.\n. We actually have quite a bit of code that depends on it being a single child. :/\n. Not sure how this is cleaner? The prototype access + call is one of the ugliest parts of JS and very esoteric looking.\nPlease perf test this too. @jordwalke found that this key validation step was actually a huge performance bottle neck at one point in DEV and unfortunately people perf test DEV builds too. Makes us look bad.\n. This is always an array, right? You can just use .forEach and .join. No need for the added dependencies and extra helper module\n. This is kind of difficult to follow and under-parenthesized. Can we break this apart a bit so that it's easier to read? \nLooks logically correct but it would be interesting to see if the order matters for performance here. I.e. if the type string/number/object check matters on real code.\n. This is an unnecessary abstraction. Use Object.keys(object).forEach or just inline the for...in. It makes it easier to read the code without learning all our utilities.\n. It should be hasOwnProperty, I guess.\n. You could bail out earlier here if key.length !== 1.\n. Helps with closure compiler advanced mode minification. Since we need both identifier symbol and the string symbol. If identifiers are renamed, then we lose the string. Also helps type systems to figure out the signature of the resulting object.\n. createDescriptor (I'm going to rename to createElement) doesn't really care about the type of the type field that you're passing in. Whatever is passed in is what gets out. It's not overloaded. It's just a way to create these descriptor objects. They could also be inlined.\nThe overloaded part is when these are returned as child element. They will either instantiate the class or create an internal native component. The native representation should never be exposed outside the engine, because that allows people to touch implementation details. It also requires web components (and other tags) to be registered. By allowing a string to be past, we avoid the need for a whitelist.\nWe could potentially use numbers or placeholder objects, but these would not be real classes anyway. It seemed simple to use strings since these don't require anything to be in scope, which means that we can get rid of @jsx React.DOM.\n. The key is used on the resulting object:\nhttps://github.com/facebook/react/blob/aae31ae24c67216894ae42b8481a599206d18690/src/vendor/core/mapObject.js#L52\nMeaning that React.DOM.div is the identifier name that can be mungled to a.b.c. \n. meh. this file is getting deleted in the next rev anyway.\n. Also, this shouldn't have been renamed.\n. I was trying to cheat to safe some micro-perf but you're right. We could stick to a subset but never allow invalid tag characters. (such as starting with : or <)\nThanks for the sanity check.\n. This is a special case since a dynamic value of hasOwnProperty should be valid here. Ideally this would just use a Map at some point.\nTypically, hasOwnProperty polyfills hide certain properties (e.g. for Map polyfills) which wouldn't be needed here. (It's also not a valid polyfill in ES7 because spread properties syntax exposes them. So you need a different technique there.)\n. Should this be renamed createNodeTypeChecker?\n. This pattern is not deprecated in this release. It should still be valid until we introduce a warning for it.\n. ReactNode would be better, yea.\n. Fiiine. I put it there in the actual polyfill since it executes in global scope and I didn't want to add another closure. But I guess I can move it out just for this.\n. yea, and it's also not unheard of to use this as a prop name or something else that needs to be transferred.\n. \"...or undefined\"?\n. Add a console.warn mock and assert that it's being called. We could fail on all warnings (we do internally) by default.\n. You just made it impossible for future specs to use the name .entries on Array.prototype ever. Hm... Actually this might be a good feature test... Not sure...\n. This is a hack to restore internal methods to their unmocked state. In a follow up PR, these internals will be moved off the class instances and therefore they won't get mocked.\n. This now does ReactCompositeComponent.Base.hasOwnProperty(name) which has some more names of internals on it than the other one. This is a bit more restrictive but hopefully nobody relied on being able to override internal names that wasn't on this particular mixin.\n. I'm leaving these tests in this file. I want to make a separate pass of moving unit tests into the right location once things stablize. Some will be replicated for ES6 classes etc.\n. Fixed. CI now passes.\n. undefined deopts v8 but we're going to start applying a transform that automatically converts to void 0 so I'll change this.\n. It's incorrect that Maps are faster. They're O(1) lookup on average but large Maps will be slower than a direct property access.\nMore importantly, this has a behavior difference if you're using multiple React instances which would probably break some of our tests.\nThe Map is nice because it is impossible to reach into internals without going through the Map and it works on non-extensible class instances. However, I think we might instead move to some injection into the class instance so that the base class can be completely decoupled from the React core without a middle man.\nNot sure yet. This is just incremental.\n. This should've triggered a warning about missing keys. Why isn't it?\n. The JSX should call createElement which does the validation.\n\nOn Nov 3, 2014, at 6:41 PM, Lee Byron notifications@github.com wrote:\nIn src/utils/tests/traverseAllChildren-test.js:\n\n\n}\n}\n};\n}\n};\n  +\nvar traverseContext = [];\nvar traverseFn =\njasmine.createSpy().andCallFake(function(context, kid, key, index) {\ncontext.push(kid);\n});\n  +\nvar instance = (\n\n{threeDivIterable}\n\n  I'm wrong below. No warning because it doesn't hit that code path. This is a unit test of traverseAllChildren which is self-contained. The warning is in ReactElementValidator, not a dependency here.\n\n\n\u2014\nReply to this email directly or view it on GitHub.\n. This seems unrelated. Separate PR maybe? Helps us track potentially breaking changes.\n. This is super confusing. At construction time, it's an element and at update time, it's a string.\n\nCan we make it create an element in the update stage too?\nIf you do that before shouldUpdateReactComponent, that should be simplified too.\n. I see.\n. You're not really using any logic in this file. It's mostly just validation logic and figuring out what to do about native components. Since you won't test native components using this strategy, you won't shallow render native components.\nOnce you remove all the stuff you're not using, this will simply just be constructing a new instance of the ShallowMixin. You can probably just move all that stuff into the ReactTestUtils so we don't have to deal with this intermediate.\n. Refs need to be attached before this fires, which means that my proposed APIs for attachRef probably isn't the best API. Maybe it's better to provide the refs ahead of time so that you can fire this immediately.\n. Actually, now I remember why I didn't do that. Because first class refs can't be mapped to a string. They're created by the component. So there's no way to define the mapping to individual refs ahead of time.\nWe could potentially provide a mapping from the \"type\" of component and the mock function that it will resolve to. E.g. if you're rendering a <div /> it's ref will resolve to the \"DivMock\", and if it's rendering a <CustomComponent /> it's ref will resolve to a \"CustomComponentMock\". Let's chat more about this today.\n. I think we can kill this API and special case it in reactComponentExpect. You can't get a reference to a text component so this can't be true unless you're using a private API.\n. Maybe we should keep a warning here, or throw an error - just in case someone tried to use this for something? It might have been possible back when this was still resolved by ReactChildren.\n. This can actually be an invariant since it doesn't add any runtime cost.\n. Yea, because the div is wrapped in a composite, this actually causes a bunch of extra calls to guards for things that are on the composite (such as getDOMNode).\nThis is only testing the auto-binding/guarding (which will likely be killed anyway) so we can do that by just constructing an instance of the class. No need to render anything. This is part of the class contract now and not the composite, will move all tests to more appropriate files later.\n. Wasn't really sure what it should be since it can be any arbitrary tag. Not sure how to best to capitalization etc. The devtools will just use the tagName anyway.\n. This logic will likely not be sufficient in the long term since some environments may want to handle arbitrary tags without wrapping them. It should be enough for now though.\n. I'm not sure if it's worth the perf and complexity hit on every property in the entire app. Especially since this pattern is often used to add properties rather than to mutate existing props.\nTemporarily enabling Object.freeze (and strict mode) is a pretty good way to help debugging once you hit this issue.\nWe can probably remove the .props mutation check too.\n. Yes.\n. Yea, it's because the callback is used with a \"context\". Annoying OO pattern.\nEdit: This will probably change but it's currently true.\n. @zpao No time. We needed to avoid another merge-hell.\nHowever, I missed that renderToString still accepts a context. It shouldn't. https://github.com/facebook/react/blob/89aaf73ae8802af3c83651a1b1db92bd48c2c156/src/browser/server/ReactServerRendering.js#L29\n. We never throw strings because the stack is attached to the Error object. We also compress invariant error messages. So we should use the invariant module even if the first argument is false, although in this case it should be props == null.\n. I'll move it to outside the block so that it's clear that it's always assigned. I would like to merge ReactChildReconciler and flattenChildren so that the type signature of the set doesn't change.\nEdit: Actually, I can't move it out. But yea, I'm reusing the object because of flattenChildren.\n. Double space at the end here. One is enough. :)\nThere should also be a period. You can use the backticks it indicate what is code and what is period.\n. Warnings should move into the __DEV__ block so that they never execute in prod.\nWe don't do that automatically, partially because we don't have good dead-code elimination but mostly because we don't know if there is extra work that can be removed in production rather than just this statement.\n. Yea, we should not add more to this base class. I'm moving everything out of this file. There is no such thing as \"ReactComponent\" base class. They can have fairly arbitrary signatures. As when using the module pattern.\nThe thing that determines whether something is a \"ReactComponent\" is the fact that the object is mounted. Therefore this is the right check but it's breaking encapsulation by reaching into the details of another module (ReactInstanceMap).\nIf it's not already a node (using isNode), check ReactInstanceMap.has(component) to see if it's mounted.\nIt's true that a component may not be fully mounted yet, even though it's in the ReactInstanceMap but I would like to remove that divergence so it might be ok to avoid calling isMounted and let it error later instead. I'd like to get rid of isMounted too.\nAn object that is not mounted is just an arbitrary object. It's not technically a ReactComponent, however, it might still be valuable to use some heuristic to change the error message depending some duck typing. E.g. if it is has a render function. It should not change any other behavior though.\n. rm\n. I think you meant to check typeof componentOrElement.render === 'function', not the componentOrElement itself. Please add a unit test that covers this error message case.\n. Sure\n. ugh. This one breaks 80 chars which is why I moved this. I guess I can break before \"from\".\n. It's the test directly above this one. (I wish I could comment on unchanged lines. GitHub sucks. Where is my phabricator?)\n. I kind of agree that I used to think of it as \"if...then...throw\". However, the invariant model has a long standing tradition at Facebook since the early PHP days. It's also similar to assert statements in several other languages.\nIt's nice an declarative in a TDD kind of way. It has grown on me. At the end of the day, it doesn't really matter which inversion you chose. Different people will have different mental models here.\nThat said, the worst kind is the double negative. To think this one through, you might have to do two conversions! Demorganizing is hard enough already. People (me) screw this up all the time. I'd go as far as to say that it's objectively worse to have double negatives like this.\n. description should that \"should not throw\"\n. Nit: Speaking of code formatting. Personally I tend to prefer to have an extra new line between these. Otherwise it seems like everything from render to the end of contextTypes belong together. Subjectively I look for spaces as separators.\n. This is expecting two warnings. What is the second one? It should either try to avoid the warning (so it only tests one thing) or assert both if it's related.\n. You're using withContext to test these but withContext can be easily deprecated and quickly removed from the code path.\nWe should test the scenario where only getChildContext is used.\nE.g. just add something like:\n``` javascript\nvar Wrapper = React.createClass({\ngetChildContext: function() {\n    return { foo: 'noise' };\n  },\nrender: function() { return ; }\n});\n```\n. This only tests that it works when it's mounted. Not when it's mounted with the same context and then updated to a new context.\nCan you add a test case that covers the updating code path?\n. This test is testing componentWillUnmount so I need to unmount it to trigger the expect in the test case.\n. I don't fully trust the transpilers that we use to be efficient since classes have to deal with other edge cases. For example, we might start including a runtime in the transpiler.\nThey may also not always be spec compliant. It might not be equivalent since class methods are probably going to become non-enumerable which we can't do in IE8. But that has gone back and forth.\n. well it gets reset during mount. this can be simplified later. if it's undefined, it gets set to null.\n. Because I aim to deprecate it and make a separate queue for all this stuff. Also, it doesn't make sense to have an error message called replaceState when there is no replaceState method on React.Component.\n. It's undefined. It can't be anything else unless we call super. That's just ES6 initialization procedure. No need to test ES6.\n. I want to reuse the same exact tests for multiple class implementations (module pattern etc). In those cases, the handler may not be on this.\nAlso, just because this !== instance doesn't mean that there isn't a wrapper around this that still allows this to be called. \nIdeally it should be more precise but not quite sure how to design it in a general way. (The error message may vary by engine.)\n. There's no functional change to these tests, right? Did I read this correctly? It's just reorganized.\nProtip: If there is no functional change and just refactoring, it's good to mention that in the commit message. Makes it easier to review since I otherwise have to look through to find the change.\n. Yes, but it's problematic if there are multiple output environments. E.g. if an ART subtree was defined in terms of string based target nodes. Then we don't know which of the multiple environments this particular string will end up at.\nAnother case is HTML/SVG where the <title /> element means different things depending on which parent it ends up in. So they should have different propTypes depending on the parent. We don't really have a good way to solve this issue.\n. This is kind of a perf optimization since this lookup happens in production right now. We never need contextTypes for wrappers right now so this allows us to by-pass the class lookup. Not really a solid solution. I could add a TODO.\n. Missing var.\n. hm... wtf\n. No. They're two different queues.\n. Spaces around operators. This is failing lint.\n. These are all unused as far as I can tell. Probably an artifact of when we wanted to use these internals for ART.\n. hm... Well technically you can because it is an upgrade path but we'll immediately break this next release so then you can't. Not sure how to phrase it to make it clear: Don't do that.\n. Yea, which will be different in prod. It's the best we can do without real proxies. Let's just hope people use strict mode. (They don't)\n. Kind of. Without this change, a Map object would be iterated over as if it was a keyed object.\nI fixed it so that plain objects are silently ignored by detecting if they have an element child. A heuristic. So I think that this should work again. However, we might as well ignore Maps since they're likely not fragments.\n. Other tests require in beforeEach, so we're already inconsistent in that regard.\n. I use the ReactChildren helpers to iterate over the result of another helper. I.e. checking consistency between helpers. Since an object is not terminal, yet, I can't use that to test. Once we fix this fragment thing, we can revert to just use the object here.\n. Didn't want to change what the test does really, but yes in my first attempt I excluded it.\n. It is a placeholder as an upgrade path, not a permanent API, which is why it is in addons. We're thinking something like:\n<frag><Component /><Component /></frag>\nor E4X's\n<><Component /><Component /></>\nOr when you want to key an unknown set:\n<div><frag key=\"a\">{childrenA}</frag><frag key=\"b\">{childrenB}</frag></div>\nWhatever API we settle on, createFragment is just a way to accept legacy object literals as an easy upgrade path. It is an unusual pattern but nice to have a quite upgrade path as an escape.\n. No, this is fixing that behavior. Note the next line that ignores validation of Maps. Previously it would try to validate the Map as if it was an object, which depending on the type of Map might fail.\n(I'm not sure Maps (iterables of [key, value]) should be a supported way to key children. I think it makes more sense to turn Map data into iterables of ReactElement which is effectively a [key, value] tuple where key is type + key. But that is unrelated to this PR.)\n. This is leaking unnecessarily much information to DOMPropertyOperations. All the tag name logic is already in this file.\nI'd rather see the switching done in this file where we already have a regexp for tag names. We might as well use that first check to cache if we're a custom element or not. That way you don't have to recheck for every attribute and every update.\n. This is weird, but ok.\n. Nice catch. Probably merge issue. I had the conditional inline first and then needed to return early for this conditional so I broke it out.\n. What about iterables? Maps?\n. This will be slow since our transpiler isn't quite optimal here. :/\n. I mostly just care about the linting.\n. Arguably this is a perfect example of why you should avoid statement nesting. :)\n\nOn Feb 13, 2015, at 6:00 PM, Jim notifications@github.com wrote:\nIn src/core/shouldUpdateReactComponent.js:\n\n\n(nextElement._owner != null &&\nnextElement._owner._isOwnerNecessary === false)) {\nif (prevElement._owner != null) {\nprevElement._owner._isOwnerNecessary = true;\n}\nif (nextElement._owner != null) {\nnextElement._owner._isOwnerNecessary = true;\n}\nwarning(\nfalse,\n'<%s /> is being rendered by both %s and %s using the same key ' +\n'(%s) in the same place. Currently, this means that they ' +\n'don\\'t preserve state. This behavior should be very rare ' +\n'so we\\'re considering deprecating it. Please contact the ' +\n'React team and explain your use case so that we can take that ' +\n'into consideration.',\n  Rrrarw, yeah, ok. This is a perfect example of why the line length warning SUCKS and should be removed.\n\n\n\u2014\nReply to this email directly or view it on GitHub.\n. Can you move the hasOwnProperty check before the valueChanged check? That avoids problems with possible getters on the prototype chain.\n. I'll just do it myself in a follow up. :)\n. They're equal if b is also NaN.\n. Thanks MSWord\n. These tests are derived from ReactElement-test and ReactElementValidator-test.\n. No, I thought about that, but since this is very explicitly an override I don't think it is necessary. Just like any other prop overrides silently. We used to have a warning because it was implicitly deleting the ref even if you didn't provide a new one.\n. hm... Nah. Maybe next one. I think that this is still consistent with key/ref having a default value of null.\n\nImagine these ES6 signatures:\ncreateElement(type, { ref = null, key = null, ...props }, ...children);\ncloneElement(element, { ref = element.ref, key = element.key, ...props }, ...children);\n. Yup. This is what happens when DRY gets out of hand and we try to unify everything.\n. Remind me again, where do we do that key: null warning? Did we remove it already?\n. This should be typeof console !== 'undefined' to avoid a use strict violation in the case that it is not defined on the global at all.\n. You can probably just use this._currentElement._owner.getName().\n. Can you move this to ReactClass-test? It is a part of the \"classic\" API. Thx.\n. We have a transpiler that can turn === undefined into === void 0 which is faster yet but ugly.\n. We use the constant (string literal) on the right hand side. Which is triggering a lint warning which is failing the unit tests.\n. This copying should be avoidable now that we don't have to adhere to a common pretty API but fine as a first step.\n. Avoid this. It's not OO anymore. Pass it explicitly.\n. I would prefer a bunch of switch statements. Avoids the GCC problem, should be faster than a lookup in a map, and avoids the lookup on the wrapper object every time to figure out what mountWrapper means. Might be fast but fragile since it relies on the VM's polymorphic optimizations.\n. This pattern won't work if we want to support two passes of GCC advanced mode. Such as precompiling an npm package that someone else then compiles again.\nIn that scenario string properties means public API that someone else might provide. It does not mean that it will remain a string at runtime.\n. Yea, I wanted to fix all of these callsites. We have a bunch all over the code.\nIt should be new Set([ key, key, key... ]) or new Map([[ key, value ], ...]) but since we can't rely on ES6 Maps/polyfills just yet, we can make our own helpers. Like ConstantSet and ConstantMap that just creates a frozen keyed object for example. (Freezing in prod might actually be beneficial for this case since it is not called in a hot path.)\nAn alternative pattern is ofc a function with a big switch statement which I would prefer for code paths. I don't care as much for raw data if it is things like DOM strings that have to be around at runtime anyway.\nHowever, if it is internal enums etc. we should probably not use maps/sets to manage them.\n. Yea, that's what I meant.\nThey have the same shape so the function probably does not need to be compiled in a polymorphic way. However, you still have to guard the type coming out + do a lookup on the object of which code path to take. You can't inline it without knowing all the objects that might be here. Which is possible but at the very least you'll end up with a guard.\nIn my proposal it would be inlined and so you would just immediately know which code path to take.\nI'd like to change to use this everywhere. In fact, I would like to change the mountComponent/receiveComponent API between components to do the same. So that it can switch code paths based on typeof type === 'string' alone. That's the purpose of the ReactReconciler module - to do the switching.\nIf the switch cases are very uniform I would recommend just breaking out the switch in a common module.\nfunction mountWrapper(inst, props, context) {\n  switch (inst._tag) {\n    case 'input': ReactDOMInput.mountWrapper(inst, props, context); break;\n    ...\n  }\n}\nThen just call it:\njs\nmountWrapper(inst);\nThis boilerplate actually ends up being smaller than the alternative when you compile it.\nSince they're only used in one place, the switch statement and the content of the other modules will just inline right here. As opposed to having an object per module + compressed identifiers to identify each property + the extra function() { } etc.\nI'm definitely playing human compiler here but the tools aren't doing it for us... yet.\nIMO it also makes it easier to follow since every code path is guaranteed. You know that no foreign objects can be introduced. Just follow the stack.\n. I should document all this in a style guide...\n. This won't work since we allow module pattern components that may not have a visible prototype. E.g:\njs\nfunction Foo() {\n  return {\n    render() {\n      return <div />;\n    }\n  };\n}\nI'm surprised this wasn't covered by a unit test.\n. Context here is supposed to be removed. Owner is only used for refs and it is not possible for one of these to have refs so this can be removed.\n. There is no public instance associated with this so therefore there is no way to attach a ref this way. This code path can be removed and associated paths too.\n. This is always null.\n. Drop the block, this is constant.\n. This is not needed.\n. This is only used for sorting updates, and since this can't get any updates, it is not needed.\n. The context is always available to you as an argument. No need to store it on this instance.\n. This can be merged in. Lets you get access to context directly.\n. hm... Maybe. How about we add it back later? I think it might require a different code path since this should avoid as many internal instances as possible in prod.\n. This should not be necessary because the wrappers are getting removed in another PR. Also, no wrapper should need to use child context.\n. Shouldn't we just use the deprecated module for this stuff?\n. It was explicitly added in 0.13 because we don't want to be opinionated about how to structure classes. That is especially important for integration with compile-to-js languages.\n. How about some that shows the from->to transformation directly? Easier to understand \"you did this but you should be doing that\".\njs\n'require('react').%s` is deprecated, use `require('%s').%s` instead.'\n. Can we split these branches into two functions? That avoids some nesting hell and also allows us to put a name to this code which is built-in documentation! (Also avoids the need to call the iterator variable j instead of i.)\n. Can we name path[j] to something in the local variable? Some of the lines below doesn't read very nicely because you think \"wtf is path[j] again?\"\n. Can currentNativeTarget ever be undefined in real cases? It seems like it should always be defined from a type system perspective and therefore we can ensure that we write the code in a way that it is. E.g. by initializing it to var currentNativeTarget = path[0]; and then currentNativeTarget = path[j +1] once we hit a document fragment. That way we ensure that we don't make a mistake in our type logic.\n. This is a relatively expensive lookup to do for every item and could be worse if we use a different ID strategy that doesn't concat. Another strategy would be to create an inner loop, after this, that keeps going until the node ID equals this root ID. That way you don't have to extract the root ID from every intermediate node.\n. This makes ReactNativeComponent unused. rm the require.\n. Note: We'll have to remember to deal with this in devtools etc.\n. Do we need to patch in all of these? Only setProps/replaceProps was available before 0.13 and setState/replaceState is a complete noop so nobody is likely to use them.\n. I found this surprising that we removed this. For my own memory... I recall the rationale being that calling it during componentWillUnmount is silly but it is not harmful, unlike calling it AFTER unmount which is indicative of a leak.\n. Why was this hack needed again? There are no examples here so it shouldn't be needed.\n. There is a slight difference in behavior here since this will cause all listeners to be thrown to the top level, instead of just the first one.\nThat's only really Observable from the debugger though. Potentially you could have an onerror handler that behaves differently but I don't see this as a problem.\n. We need this to line up with https://github.com/facebook/react/blob/master/src/renderers/dom/shared/ReactDOMComponent.js#L536\n. Looking to hear from @spicyj on this branch\n. We have the old context stored if it is a composite so we should just be able to do an object comparison. This check is too slow to do for every hot path, but more importantly it means that you never get this optimization if you use context anywhere in your tree. Which is like everywhere.\n. Looks like this is mostly an optimization so it should be ok. https://github.com/facebook/react/commit/bfcad9614ad6bebe6bbfbaa75fb121e1bad20f64#diff-c807d0f5ebbc12c44d9479dea693bef6R568\nHowever, since you're just duplicating the line, just move it outside the block.\n. Try my test https://github.com/facebook/react/pull/4220/files#diff-29737245cf015f47f56bfe99556b82db\n. If the provider of the context rerenders, then there is a new instance of the context created. Same principal as why this element bailout works even though a prop might contain mutable values.\n. Let's move this to a module level function so that it is not exported. Ensures that it can't be overridden, minimizes better etc.\n. If we're no longer doing type checks, you can presumably delete these files too.\nHowever, I think that we probably DO want to do TypeChecks because the idea was that we could start expanding and maintaining this .d.ts file for React and we'd want to test those. Better that it lives in our repo than somewhere else and people are already doing this work, so they can do it in the React repo.\n. I think this is the wrong one since it is walking the parentNode pointers.\n. It is actually not in the message. We are pulling it off the stateful module in our internal logs.\n. They need this so it was a neat trick. No reason.\n. This won't work because the construct trap will intercept any non-object and turn it into this. :(\n. should we do typeof checks instead? they're really fast in JIT:ed code and more specific. E.g. undefined is not valid.\n. Just noting that this behavior should be unchanged because both flattenChildren and toArray excludes null.\n. I don't think that this is quite equivalent for nested fragments, is it?\njs\nvar foo = React.createFragment({ foo: <Foo /> });\nvar bar1 = React.createFragment({\n  hi: <div />,\n  bar: foo\n});\nvar bar2 = React.createFragment({\n  bar: foo,\n  bye: <span />\n});\nDoes swapping between bar1 and bar2 preserve state of <Foo />?\nMaybe we should copy/paste a custom traverseAllChildren here to preserve legacy behavior? (and also removing the dependency on React internals)\n. That's what I meant. Edited. :)\n. Actually nevermind. I can't think of a case that would break because we don't add anything to the first array.\n. @spicyj mapChildren (above) returns ReactFragment.create. We should probably optimize it to just create an array immediately. This is probably a perf regression.\n. Fixed this bug in older browsers.\n. These weren't intended for production use, and definitely not public. So I'm moving this to an underscore, __DEV__ and making them non-enumerable. Otherwise jest's equality helpers won't work on elements created in two different source locations.\n. I used a single underscore here for consistency with _owner and _store while the properties in config use the double underscore.\n. Just because MDN recommended it: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol/for\nWe could also do react/element to make it npm-like.\n. What do you mean?\n. Ah, yes. I was also not sure so I tested. I think it is generally just window and document and a few more that can't be deleted.\n. See the description in the PR summary. I don't know if it's the right tradeoff. This is a secondary layer of security so just because this hole doesn't exist doesn't mean it's exploitable. E.g. it has been in React since 0.13.\n. We have evaluated requiring various ES6 polyfills but decided against it in the past. It was too much of a hassle for people and didn't work well with node especially.\n. That's why we try to delete global.Symbol to test the case where it doesn't exist but perhaps we need to shadow it rather than delete it. Didn't try Node 4.\n. Won't work between multiple instances of React and across realms. \n\nOn Sep 16, 2015, at 8:08 AM, yiminghe notifications@github.com wrote:\nIn src/isomorphic/classic/element/ReactElement.js:\n\n@@ -15,6 +15,11 @@ var ReactCurrentOwner = require('ReactCurrentOwner');\nvar assign = require('Object.assign');\n+// The Symbol used to tag the ReactElement type. If there is no native Symbol\n+// nor polyfill, then a plain number is used for performance.\n+var TYPE_SYMBOL = (typeof Symbol === 'function' && Symbol.for &&\n-                  Symbol.for('react.element')) || 0xeac7;\n  why not use Math.random()\n\n\u2014\nReply to this email directly or view it on GitHub.\n. I like that. Maybe add \"everywhere\" at the end to clarify that it is centralization that's important?\n\nRather than calling ReactDOM.render() directly everywhere\n. I think it is actually quite important that we're consistent because people follow our lead and avoid internal discussions by pointing to things like our blog posts.\n. I like the longer descriptive name here unless we have a rationale. (Maybe we should also rename the argument in the function signature.)\n. It's a little academic/philosophical. It doesn't add anything. We can just remove it.\nThe last sentence is a bit of a tease since this article doesn't say anything about that part. It's just frustrating. Seems like it's better to remove that and use it as the lead in for a follow up article.\n. Just inline the IE8 path in SyntheticEvent.augmentClass.\nNo need for a fancy module and no need to check for Object.create if the IE8 path is equivalent anyway.\n. This whole warning should be within a __DEV__ block so that it doesn't need to be evaluated in the production builds.\n. Nit: Can we make this return a plain (prototype-less) object instead of being a constructor?\nPrototypes encourages us to put methods on it that are not statically resolvable.\n. This is always available on this._nativeParent._nativeContainerInfo, right? So we don't need to store this here.\n. Seems like a waste to store it on everything just to solve the root case. Maybe we need to refactor the root? The top level wrapper seems a little hacky too. That could be a follow up though.\n. I don't understand why it wouldn't work unless I misunderstood what _nativeParent does. nativeContainerInfo would still be on the ReactDOMComponent.\nI actually think that we could walk back to the nativeParent and reconcile from there so that we can support frags/nulls. Which is what sparked this line of thinking.\nAre you saying we would have to crawl back all the way to the root?\n\nOn Oct 12, 2015, at 8:50 PM, Ben Alpert notifications@github.com wrote:\nIn src/renderers/shared/reconciler/ReactCompositeComponent.js:\n\nthis._context = context;\n this._mountOrder = nextMountID++;\n this._rootNodeID = rootID;\n-    this._nativeParent = nativeParent;\n-    this._nativeContainerInfo = nativeContainerInfo;\n  I realized this isn't necessary only at the root. Your way doesn't work if we don't store this here because _nativeParent is also a ReactDOMComponent. We could crawl up the tree every time but that feels more wasteful. Essentially, this is where we store the info that doesn't change within the tree but that we need at every level.\n\n\u2014\nReply to this email directly or view it on GitHub.\n. @STRML That's a good point. I was hoping to avoid boxing. NaN or something like that would work too. [I wish this came last week because now multiple versions of React/Babel will break if we change it. :disappointed: Probably should find a way to change it anyway.]\n. It doesn't cover postMessage though.\n. We don't want it to work cross domain by default. That's still a security risk.\n\nHowever, we do want it to work if you're able to coordinate the Symbol across the worker boundaries.\n. See #3473 for more context.\nIt is too easy to expect a string and not realize it might be an object:\njs\nloadString(function(stringData) {\n  React.render(<div>Content: {stringData}</div>, container);\n});\n. What's this about? Behavior change?\n. Plain string comparison is not closure compiler compatible.\nWe should ignore it even if it's a string/number.\nOtherwise this won't work:\njs\n<custom-element>My Text Content</custom-element>\nAlso, could you add some tests that actually involve children like the issue that you're fixing.\n. You can think of this as an immediate rerender, because that's exactly what happens when this component rerenders.\n. Why is this change needed?\n. We don't need another thing to hold the identity of a component. We explicitly want to get rid of it completely. It would be better if this was just true/false if something is currently rendering since that should be all we need for warnings. This is important step forward because this file can live in the renderer package.\nReactCurrentOwner needs to live in some shared global package with a fixed version number so that it can be shared with ReactElement.\nFor now, we can use owner for the error message itself but we shouldn't track the instance here.\nI understand that you need the instance to disambiguate.\n. This only adds a single stack frame to the boundary, not every component so I think it is probably fine. We should do it.\n. rm\n. Why move? Is there anything else that shares this hidden class?\n. unstable_handleError\n. These should be on the __REACT_DEVTOOLS_GLOBAL_HOOK__ somehow because there is no reliable way to get to a single instance of a renderer from a global debugger protocol.\n. This one is interesting. Can this actually happen? Doesn't matter if we do it as a precaution since we're already in a slow path. Just curious.\n. no thx\n. This is an unfortunate required allocation for every component. I believe that there is currently no allocation for leaves. (The way RN creates the \"update payload\" lazily might help. Although that pattern is really annoying to work with.)\n. I think the general idea I had for ReactChildReconciler would be that the delete hooks of the renderer could be called directly here. That way the \"enqueue delete\" call could be called before the unmount without a queue.\n. Text components is the only thing that doesn't have children. I mean divs/Views that still implement ReactMultiChild but don't currently have any children.\nIn that case, flattenChildren returns null. Well, unless it is an empty array I guess.\n. Ideally this should be DEV only.\n. I think it makes sense if you think about what making a refactor would mean for the normal algorithm. These methods are required to exist. If we add an event to isomorphic code, then that would break every other renderer (as in ART, DOM, RN) out there until they get added. If they're part of isomorphic code then it doesn't break. It will just emit unknown events to the handlers.\n. Doesn't this mean that we always render null? Regardless if the component updated state.\nCan you add something to your tests that checks that the error message is actually shown in the DOM, not just executed?\n. Oh I see, this is where it gets shown.\n. Rendering null means something. It means inserting a placeholder.\nIdeally this would be unmounting safely first. Then try to mount the new child as defined by the state change and if that fails, bubble up the error one more level.\n. Personally, I'm not a fan of explicit runtime enums. I like the Flow version better where the type can be validated but you don't have import a third party module to do it.\nIt's worse for perf than a regular string. These short strings should be interned and inlined anyway. This just makes it harder for a VM or compiler to do that inlining since these objects are mutable. It's not safe to inline.\nkeyMirror is also tricky in regard to property name mangling. E.g. if we want to mangle property names inside a React compilation, rather than whole program. (Two separate compile steps.)\nWe should get rid of this pattern completely.\nMore importantly, this is the first time the value leaks into a public API. If we change convention or something internally, it would affect the public API.\nInstead I'd rather just put a string inline at each callsite. Like an event.\nGiven that, what should the event convention be? Does a camel-case \"componentDidMount\" make more sense given that is what the component method is called?\n. This isn't feature detected. Note:\nhttps://developer.mozilla.org/en-US/docs/Web/Events/focusin\nFirefox (Gecko): Not supported.\nThis would need to be normalized, but if we do then it works exactly like focus/blur. So I think we should revert.\n. This is an old note. It's just copied over. I actually don't think this external API point will hold up.\n. good call. This was actually long before fbjs was in RN. I should update this. @zpao Your warning didn't catch this. :)\n. hehe. I should've pushed last night. Fixed this locally.\n. Also fixed this locally last night.\n. hm. Good point. Either that or leave them untransformed for now, since RN will transform them anyway.\n. Maybe this should be called \"shouldConstruct\" or something like that? Functional components can be \"newable\" in the ECMAScript sense but shouldn't be called with new.\n. This is gone now since we have the transform doing this. I guess I didn't push that change.\n. This is on an outdated version. Not sure how you got to it.\n. Ah, sorry. This got removed when I rebased on top of latest 15.0 changes in which React.js is already isomorphic. It wasn't before.\n. Remind me again why this needs to be here and not in a DevTool that listens to the event below?\nIf it was attached conditionally by a devtool, then we wouldn't take on a dependency on WeakMap. Only in environments that needs that tool.\nWe definitely can't take on a dependency on WeakMap for all environments. Would make it impossible debug many IE versions.\n. ^ @gaearon \n. Why is this passed here? Is this part of a new public API change?\n. This argument isn't accepted by receiveComponent.\n. This is dangerous. The API contract allows setTopLevelWrapper to be mutated and doesn't say anything about the order of execution. This assumes that it is set before the children. To do this correctly, you'd have to empty the children if setTopLevelWrapper ever gets set after I guess.\nI think we can avoid this whole problem though... [see next comment]\n. This information is an implementation detail that I'm trying to get rid of ASAP. It shouldn't be of interest to a debug tool to know this.\nCan you just bypass it and emit the child of this as the conceptual root?\n. This is also an implementation detail. You can render a full React app with no native nodes and just using life-cycle methods. We could implement DOM as just a series of composites. Also, the notion of composite is overloaded because there are stateless function, functional and classes.\nI don't think we need to expose this. Do you have use case?\n. TANGENT:\nWe shouldn't do this now but as an FYI, I been thinking that the notion of a \"child\" component isn't limited to children. It's not in React components so why should it be in native.\nAirBnB wanted to do this <input placeholder={<CustomComponent />} /> for example which would have one of the attributes expand into a series of \"children\".\nSimilar things can happen with layout I think. Anyway, let's fix that later when we know when it happens.\n. Use underscore for consistency.\n. Can you move this check to where you call .onSetChildren(...)?\nThe reason I want these gone is that my new reconciler won't have any of these limitations but it still wants to target this same ReactDebugTool.\n. Same here. I'd prefer if we could get rid of exposing this limitation because my reconciler just won't output any nodes for something that is empty. So I won't have this concept nor this limitation.\nSo it is exposing an implementation detail.\n\nThe tree devtool becomes unaware of parent-child association between composite and empty component so it can't clean it up on unmount easily\n\nYou can also just not expose it at all to the debug tool. That way it won't need to be cleaned up. Empty components doesn't have children or anything at all that is exposed.\nSo all you have to do is ignore any call to the debug tool that passes an instance of something \"empty\".\n. It should be ReactFunctionalComponent. Our internal naming is wrong.\n. Can you explain a bit on why the flush batch is important? Does it matter if the implementation batches or just does the work whenever?\n. InteractionManager and merge are already removed dependencies so I'll just clean this up while I'm in here.\n. That means you can't run flow at the top level which kind of sucks. It also means you have to ../ up to things like the custom flow definition files and make special cases for node_modules that you do want to bring in flow for. I think the idea is to ignore random node_modules automatically soon.\n. Because that particular line is FlowFixMe anyway for other reasons. I'm not too worried since I have a follow up for decoupling or moving these anyway. https://gist.github.com/sebmarkbage/b6f7a9c4bdec1c41cb64e7ee77254551\n. This wasn't really flowified but marked as such.\n. This is a private method which shouldn't really need any annotations. Not sure if this is a particular config we need to have.\n. Edit: nvm. I should read the whole thing before I comment.\n. This is in the wrong place. It should just avoid updating textContent.\n. I originally tried to make it a flattened linked list but figured it'd be simpler with a nested set. I suppose I could leave it as a nested linked list. That's very interesting. Good observation.\n. That is correct. I abandoned the \"algebraic effects\" model because I couldn't figure out how to make the cache invalidation work in all cases.\nI think this is sufficient for layout, menu items etc. There can be a host component or other coroutines in the final tree due to continuations returning something to the outside, but they can't arbitrarily execute back and forth.\nFor example, this places a <div /> between <Foo /> and <Bar /> in the tree.\nconst Foo = props => \n  createCoroutine(\n    <Bar />,\n    (props, yields) => <div>{yields[0]}</div>\n  );\n. Yea, this needs to change. It's terrible. That's what I was thinking about and wanted to discuss yesterday. I wanted to avoid overloading the structure too much but also avoid too many unnecessary nodes.\n. I'm not exactly sure what you mean so I'll throw out some words.\nThe yields have their fiber resolved at the location they're yielded. Meaning that their state identity is determined by where it is created, not where it ends up.\nThe memoization of the continuation will be stored on that fiber. If you render the continuation in multiple places, this breaks down but I don't plan on supporting that initially. It'd need to be cloned or immutable.\n. I'm not sure there is a current state because you can start a unit of work and then start the same thing again because of a higher priority operation or because you had to restart higher up before completing the first set.\nThe input is the next fiber that has work that needs to be done. The output is null if it completely immediately. If doing work on this fiber created children, more work is needed before we can complete the first one so we get that one as the next thing to begin work on.\nThink of it this way:\njs\nx = () => y(1 + 2) + 3;\nThe stack frame for executing x must first begin some initial work 1 + 2. Then it jumps to y. Then it completes by finally performing + 3. The stack frame of x is used twice.\n. This won't have the security implications and it won't be used as a terminal that we have to test for.\nI guess the key is that this never returns back into React. I think of it as the key/value pair exposed by Map. I think we should probably just make this an array tuple to optimize property access too.\n. The next will return a child of the previous one. Once the child is completed, it will use its parent pointer to find this and complete the work.\n. Completion is currently synchronous which means that the fiber doesn't need to be in two states. I guess that's an important part of this.\nCompletion is expected to be fast. The only user code fired would be a coroutine handler. The handler would then return another fiber so it would be at most one coroutine handler. The worst case scenario would be if all the coroutine handlers returned null. In that case we might execute many of them synchronously.\n. This is how completion works by walking up the parent.\nI was, however, considering using an explicit stack object that contains the path to the parent currently executing since that can be recreated whenever you start back from the top. That saves us having to store the parent pointer on the fiber itself.\nI figured we might need the parent point for other things like finding effects, or dispatching events, but we could also do that using something like \"host parent\" or \"event parent\" like we do in the stack reconciler.\n. Good catch. This isn't covered by tests yet.\n. This is going to be throwing later on if you tried to render this anywhere before. It is also going to be throwing through out version 15 so even if you try a later version and then downgrades, it'll still not warn. So I think this is pretty safe.\nWe can be more specific once we know a bit more about the data structures that will be allowed here. I suspect \"module components\" might end up here if we do those. As well as yields.\n. No, only if they line up exactly. This logic is broken though. It is not a complete impl yet.\n. If we build a test where this happens, I think we're likely to fail the test anyway.\nIt is true that this is super difficult to reason about and I think there might even be a problem in the code right now because of the use of \"alternate\" in ReactChildFiber. To make this work without the pooling, I'd have to fix those callsites. I've been looking at it last night but it is harder than it seems because the return value for \"next\" becomes a tuple if you want to code completely without the use of it.\nThat means that alternate is also acting as \"current\" version.\nIt would be nice to assert dev only but not sure how to do that efficiently. Do you have any ideas?\n. In the unit tests this is currently true but not necessarily. nextReusable lines up with the index in the array but the key and type might not.\n. That means that this child is new. We don't need an alternate until we try to update it. Remember that we only have one copy until we update. If later we try to update it, this get created through cloneFiber.\n. To put it another way: current is what already rendered on screen. workInProgress is what is about to be rendered. If a child is new, it has no current.\n. Define this in the non canDefineProperty case too.\n. If it was, then all the <= comparisons I do all over wouldn't work neither.\n. Over-abstraction warning. That will read like Jordan's code. :P\n. The fact that NoWork is a \"higher priority\" than anything else rather than lower, is kind of lame though. Requires double checks, but maybe those double checks are faster anyway due to comparison to zero is fast.\nI'm not even sure any of this will remain anyway. Jordan had an idea of putting priorities in term of time stamps so that trees get automatically higher priority over time to avoid starvation.\n. No and Yes. This side-effect be queued and discarded. This is what my post in React Core Contributors today was about.\n. If so, then it is probably the tags that needs to be more restrictive. E.g. not allowing ordinal comparison. Symbols could be an option but I'd prefer to not get too fancy for no reason. This code is super complicated and this is probably the last of the issues we'll screw up.\n. I mean I'll update this to use NoWork for clarity. Just skeptical about going too far on the opaqueness / abstractions here.\n. I suspect that we'll want to let this list grow - maybe even indefinitely. So that very low priority things can be internally prioritized. Such as individual list items.\nNoWork could be Infinity but that's a float number so I don't want that. It could also be a very high number, but that means comparison is slower (marginally). It is also nice that it is falsy. Here and in C.\n. To be honest, I didn't really understand this well enough when I wrote it to structure it well from the beginning. The current organization of beginWork/completeWork/pendingWork/scheduler could use some restructuring for clarity but there are still unsolved problems so I'll do that when those are solved.\nThis isn't actually needed right now. Probably just something I left behind. I suspect that with setState and more edge cases it might be come needed.\nIt's not the primary way of resetting priority.\n. In the future commit it basically resets everything. The alternate here is effectively a dead node so whatever is on it should be reset. Except in the case where it might have some useful data on it. See the last commits for reusing partial work.\n. Yea. This is temporarily hacked in place, it will defer to the hostConfig to figure this out in the future. E.g. the DOM can look for props.style.display === 'none'.\nI was just lazy and avoided instantiating BeginWork so it can be passed the host config.\nWe could also have a public API to down prioritize subtrees. Basically, I just needed some way to get divergent priorities into the system to test the algorithm.\n. I'm not sure about the GC, because once you write the reference once it is scheduled for promotion. I'm not sure if it gets unscheduled for free. Regardless, we could probably find a clever way to do that on the stack if needed.\nCurrently it all gets moved to memoizedProps by the time completeWork is called so for anything memoized we need to store it until the tree is complete and indefinitely.\n. Hehe.\n. I'm going to upgrade the parent pointer to just be \"Fiber\" since I settled on actually using it instead of a temporary stack side-table.\n. There is a known problem if you traverse back out of the root of an update. The root of the work found by the findNextUnitOfWork. Then the next siblings won't have any work to do so they just get ignored here. However, they may also have work for the wrong priority!\nI'm also not sure if you could potentially get here if there is a deeper update below. Presumably that only happens in the bail out case which is already covered.\nBut yea, this should be an error if the other things are fixed.\n. The props here are the \"children\" of the container, however, null means \"nothing to do\" so we need a different way to render an empty set of children. :)\nNot actually tested yet. Could also wrap it in an object like { children: null } but seems unnecessary.\nEdit: Actually I wanted to use a new field pendingWork which is essentially just pendingState instead.\n. #esl\n. It allows mountContainer or at least updateContainer to remain agnostic to whether they're updating a container that is a root or part of the tree. A call to renderSubtreeIntoContainer wouldn't have a root. The container's parent would be another fiber.\nNot sure if that is the API we're going for or maybe an explicit API like renderSubtreeIntoContainer. If it is explicit, then I guess these could be different functions anyway.\nMeh.\n. Middle doesn't actually update. It is the initial mount. Note that it has been down-prioritized in the initial mount. The initial mount finished but for anything with the default low priority but didn't finish the offscreen priority.\nSo this last piece is actually just finishing up existing work that didn't already finish. It's not an update. Where as Tester already finished earlier.\n. I suppose, yes. I'll get rid of it.\n. I don't know if it is multiple of 5 or 6. I just randomly try some numbers until I get the effect I want. :) \n. Any node can end up being reused and then you need the start of that slice of the list.\nWe could potentially make them non-nullable for type purposes. I'll have to think about that some more. Would pointing to the root by you anything more than pointing to any random placeholder fiber?\nFor context, a parent can schedule itself before or after its children. That's a feature I take advantage of in subsequent diffs.\n. Ah yes. copypasta. This whole comment is wrong.\n. No, this is just to please Flow. We do have two fields to play with though. Could just use output potentially.\n. If the work on a bunch of parents was aborted, because a higher priority update touched them, we can still reuse the work done on a child that wasn't touched. But we need to know which side-effects it had - separately from the aborted work.\n. No. I had trouble with Flow here so I probably just left it more explicit.\n. I'm not really happy with this model of determining terminalness by testing the host environment's type. I'd like to structure the output so that I always know if the next value is terminal or not.\nOne thing I could do is skip the propagation of single values up the tree and just output the child for those cases. More to traverse but you have to do it at some point I guess. Then I'd just check if the tag is a host node and if so, then I know the output is terminal.\n@spicyj Any ideas?\n. Should we extend ReactComponent? What about people doing instanceof React.Component even though they shouldn't?\n. @spicyj If this is good enough here, then it's probably good enough for the devtools? Maybe we need a flag on the top level class?\n. You might want to consider just inlining ReactComponent's constructor code here since it is a hot path and an inliner (AOT nor JIT) probably won't cover this case.\n. Yea, that's why this will need to become a queue of state transitions for those cases.\nYou may also need to be able to schedule different priority level state transitions on the same component. In that case the queue can be reordered. We can wait on that though. Not sure it is worth the trouble.\nCan pendingState just use the partial state and that way you can do the merge at the time you apply it?\n. Yea, that's the only correct way to do it, because .return is not guaranteed to point to two different nodes even for two children.\nThese are not two entirely parallel trees. They can overlap. Two parent fibers can point to the same exact child fiber when the child gets reused.\n. The parent path is guaranteed to be the same conceptual component path. However, you can't rely on any particular node being the current one along the path.\nSo this is safe:\njs\nwhile (node) {\n  addState(node);\n  addState(node.alternate);\n  node = node.return;\n}\nBut this is not safe, because it is not guaranteed to cover every node:\njs\nnode = start;\nwhile (node) {\n  addState(node);\n  node = node.return;\n}\nnode = start.alternate;\nwhile (node) {\n  addState(node);\n  node = node.return;\n}\nAn example when this happens:\njs\n// Assume the cycles are resolved\na1 = { child: b1, return: null, alternate: a2 };\na2 = { child: b2, return: null, alternate: a1 };\nb1 = { child: c1, return: a1, alternate: b2 };\nb2 = { child: c1, return: a2, alternate: b1 };\nc1 = { child: null, return: b1, alternate: c2 };\nc2 = { child: null, return: b1, alternate: c1 }; // Note that the return is the same b1.\nSince two versions of a fiber can point to the same child, it is not possible for a parent pointer alone to point to every parent since there can be multiple.\nConceptually this pointer is used for two purposes. A pointer to the parent \"Instance\" which I've merged into the Fiber. See the type definition.\nHowever, it is also used as a temporary pointer for knowing which fiber to step back through after processing.\nIf I wasn't so unnecessarily clever about allocations the structure would like this:\njs\ntype Instance = { parent: ?Instance };\ntype Fiber = { inst: Instance, return: ?Fiber };\nand you would just walk the parent pointer. However, I'm being clever to see how far we can get but it adds some complexity.\n. This will pass the node to user code, leaking this info. Pick off the function before invoking it so that this will be undefined (or global depending on strict mode).\njs\nconst stateUpdater = node.partialState;\nconst partialState = stateUpdater(state, props);\n. This let me get rid of the wasDeprioritized flag. We only do work when stepping backup instead of when we're completing a node that was deprioritized (with a \"hidden\" attribute).\n. The problem is that without this technique we don't have a way to go to arbitrary lower priorities. What number do we choose that is a fast path since Infinity is a slow path in some platforms?\n. Hm. Seems like Flow wouldn't be happy with that. Should we make it a warning along with the other validators if we care about that?\n. What do you mean by exhaustive? They're not covering all cases since they don't cover the initial mount case.\nThe above case is basically what we already have in the stack based React. If the props are on the thing that we last rendered onto the screen we can just bail out.\nThe second statement is a new thing.\nThe work in progress can be in one of three states. a) Its children were previously in the progress of reconciling, but were interrupted. If that's the case, we can't safely reuse the work because this subtree is in an inconsistent state. b) This work was already started earlier AND completed all its children but then something else was aborted. We eventually came back here but we can reuse the work. c) This workInProgress is not actually a new clone, but a reused object. That object happens to have the state of the props in the state before the current one on it. So we might as well reuse that for free. This is the ping-pong case. If you alternate between two different props.\nThe second statement covers b and c.\n. Yea, we verify this at the callsite of this function. The \"most likely\" part is just saying that we should we check for that first before doing anything else.\n. Callsite.\n. Just because of the fixed time elapsed in the unit test. The unit tests rely on implementation details taking a certain time. This is verified in the parallel test in ReactIncremental-test. I was thinking about testing this here too but the test became so complicated. I guess it is not ideal that the timing aspect here is a bit of a fragile test.\n. Correct.\n. Initially I only did this with the cheaper equality check. However, I realize now that when applied to shouldComponentUpdate, and later PureComponent, doing this twice could be potentially expensive when this is simple rerender. It would be better to do this twice only if this is a restart of already processed work, ignoring the ping-pong case which is rare.\n. The fibers in this set are \"work in progress\" fibers already so we don't need to clone them.\nSince this algorithm searches \"current\" fibers, we can't use it search for work. Instead we do the search for work inline here.\nUnfortunately there is an edge case further down that makes this a bit more complicated that I'm working on fixing now. When searching through completed work within one of these children we don't know if those children are \"current\" or \"work in progress\" so mutations could be on the wrong one... maybe. Searching for a solution now.\n. This change was reverted but still in your commit history due to the rebase not being able to ignore. You can exclude it when doing your rebase.\n. This looks scary. This whole work in progress tree can still be aborted so it is not safe to reset this yet. Wouldn't that drop work if that happens?\n. Same issue here. We should be able to drop the whole work in progress tree without any side-effects being retained.\n. I tend to prefer extract such lists off the object, into a variable, and reset it to null on the object before calling it. Makes it easier to reason about reentry that happen inside of the callbacks, such as new callbacks being scheduled onto this list or errors being thrown.\n. It is mapping to ReactAddonsDOMDependencies UMDShim , the shim file.\nFor some reason this is how aliasify works. :) I think it is just mapping the original require path to whatever you give it which is then resolved relative to the package I think.\n. ah. neat.\n. It doesn't break devtools but it does start showing the top level wrapper.\nI switched this to an explicit flag on the wrapper type and updated devtools to support this new flag:\nhttps://github.com/facebook/react-devtools/pull/407\n. I guess that means that this is a breaking change by any standard then. If we're not planning on updating these.\nAlso curious about clone-with-props et al. that are out there requiring deeply.\n. I don't think this is order dependent.\nI suppose this would give duplicate errors for the files in src/shared/**/*.js if they had any.\nNot sure how to safely merge gulp sources since those are order dependent.\n. This turns out to be a bad idea, because it throws away progressed work all the time on the way up. This is what is causing the triangle demo to starve at slower speeds now. Needs a unit test to cover this case. However, not resetting this but resetting the child is also not correct and leads to incorrect results.\n. This shouldn't be in the test renderer according to @spicyj because this currently uses the ReactDOM dependency.\n. This looks good to me. Although after thinking a bit more about it, freezing the entire .type object might be too restrictive.\nWe only really need to freeze the default props themselves and the property itself to make this inlineable.\nMaybe we can just drop this line?\n. I refactored this already so this special case for Fiber is no longer needed.\n@zpao \n. We got rid of the need to polyfill Object.create in other places I believe. Should we do the same here?\n. ugh. Haha. I moved this down below instead of finishing this comment.\n. Is this going to result in a global definition of getItem or is it local to this module? I thought these weren't supposed to be used in local code.\n. If we want to start using let/const consistently instead of var. We would have to hoist the let statements upwards.\nCan you do something like this?\n``` js\nlet foo : (x : number) => string;\nif (window.bar) {\n  foo = (x : number) => x + 'bar';\n} else {\n  foo = (x : number) => x + '';\n}\nlet bar : string = foo(10);\n```\nFlow is smart enough to know that it is not possible for foo to be undefined here.\n. So is Item truly unused now?\n. Would it make sense to just rename this to Transaction and then just do module.exports = { below? I always found the variable and then immediately reexporting pattern annoying anyway.\nBesides, when we switch to ES modules the default export won't be an object anyway. Probably just named exports like:\njs\nexport Mixin;\nexport let OBSERVED_ERROR = {};\nIn Fiber everything is a type with the name of the module and an explicit create function.\nhttps://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactFiberReconciler.js#L54-L63\nhttps://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactFiber.js#L59-L111\nhttps://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactPriorityLevel.js#L15-L24 (This should be named exports too.)\n. My suggestion is that you change from:\n``` js\nexport type TransactionType = typeof Transaction.Mixin;\nvar Transaction = {\n  Mixin: Mixin,\n  OBSERVED_ERROR: {},\n};\nmodule.exports = Transaction;\n```\nto\n``` js\nexport type Transaction = typeof Mixin;\nmodule.exports = {\n  Mixin: Mixin,\n  OBSERVED_ERROR: {},\n};\n```\nFor now.\nThat way we can keep calling the type Transaction.\n. Because I'm now going through the normal phase I'm now asking timeRemaining() more often instead of skipping straight through. That's why these tests now \"takes longer\" in simulated time.\n. Ah yes. This changed at some point during the past few weeks.\nI believe this is always the same as current.child according to the condition above so it is the same as the alternate. Not sure why I structured it this way. Memory locality, some legacy branch or Flow? I'll get rid of the extra branch. \n. Normally I pass these in. I should just pass it in as an argument instead of relying on the alternate field.\n. In the demo I intentionally avoid this Object.assign. This operation is slow enough that you'll drop frames. 731 updates x 0.02ms for this operation is enough. That's on a powerful MacBook desktop. Let alone mobile.\nIt is absolutely critical that the commit path is super optimized and any slow work have to be done in the prepare step.\n. I'm not sure we want to expose this full granularity in the API we expose to renderers. I've been thinking about a different API for scheduling that would be based on expiration date buckets. If we don't expose it to users, maybe we also shouldn't expose it to renderers?\n. I screwed this up in the rebase. If pendingProps === null the updateQueue also needs to be === null. I'll fix it.\n. This should actually be defaultPriority >= HighPriority.\nWe ended up overloading the term which needs to be undone. We should rename scheduleHighPriWork to scheduleAnimationWork because HighPriority is the highest priority that goes in to requestIdleCallback. We should only do AnimationPriority work during requestAnimationFrame.\nAdditionally, SynchronousPriority should not use scheduleHighPriWork so it should throw in that case. At least until we fix it.\n. Yea, I think the deprioritization case needs to be handled by the renderer somehow. However, I don't see a good way to expose it as an API to schedule a specific priority.\nI think possibly that prepareUpdate could return the priority level. However, currently that happens after the children has already rendered. Would need to split children update from props update - which I want to do anyway.\nIt could also be an explicit API like isOffscreen(...) or something.\nI'm not sure if the deprioritization use case make much sense for a renderer to do in another case than Offscreen so it probably isn't granular anyway.\n. @acdlite This example doesn't actually work properly right now with the rebased setState. Something doesn't update properly.\n. I believe that if anything, this is probably easier for VMs to optimize than the other other one. Simple typeofs like this can be very fast.\n. I don't think anything other than ReactElement is valid for render right now. Possibly null. I.e. the same things that are valid to return from render.\nI don't think we can use the internal ReactElement type for the public API since the public API built into Flow doesn't have the extra hidden fields that we use internally.\nSo anyone passing Flow's ReactElement into this function would get an error since it is missing the extra fields.\nAdditionally, we'd lose the extra information Flow keeps using the generic parameterization.\n. FWIW we have a ReactNode type definition here: https://github.com/facebook/react/blob/master/src/renderers/shared/fiber/isomorphic/ReactTypes.js#L17 (which seems a bit incorrect) However, as I said, I don't believe this render function accepts a ReactNode, only a ReactElement.\n. This is the warning that fires if you try to use it.\n. It causes the props to revert to their initial value when they were first rendered. Something must be screwing up the reuse since the original props shouldn't be around for that long.\n. This conditional should swap too then, I guess. I suspect I'll have to break this out when we add more composite life-cycle stuff here.\n. An alternative approach would overload the existing createInstance and commitUpdate to accept a string and return a Text node. This might seem like it causes unnecessary branching trouble there, but if you think about it, all other instances tend to be more specific types than \"View\" or \"Element\". They're all subclasses so you need to branch on them sooner or later anyway.\nThere isn't necessarily any need to special case Text components here.\nIt is needed in the internals for reconciliation purposes since string children are special. However, they're not needed here.\nYou could argue that since they're already special cased by having their own fiber, it allows early branching instead of branching in the switch statement and then branching again inside the host environment adapter.\n. This function doesn't recurse down nested arrays by itself. It yields to the outer work loop by returning a fragment for nested arrays.\n. That's right. This is going to fork soon once I start tracking the side-effects.\n. Actually I can't be cause when it errors that stalls jest trying to print the error presumably. I spent some time trying to figure out why but the debugger doesn't work on it. My best bet is that a message simply gets dropped which stalls the process waiting for a response that never arrives. cc @cpojer\n. Not sure yet if the return should move closer to the iteration branch yet. So should sibling ideally. I'm not yet sure where I need to add things to the return fiber such as adding side-effects.\n. It is not all children. oldFiber is the last fiber that wasn't consumed above.\n. Could probably use some renames in here at some point.\n. FWIW, @cpojer was planning to try to fix this and make them match. fingers crossed\n. Fixed\n. Yea that could work.\n. This is not correct. This breaks the demo. Need to think about this some more.\n. Correction. This is correct but I believe the problem is the TODO comment above in bailoutOnLowPriority. Needs to be fixed.\n. It is a Map and the only other alternative is using the iterator which allocates an object tuple for each item in the iteration.\nI think this can be done more efficient than relying on the Map for this but I couldn't come up with something simple enough.\n. Yes, I forgot we had that. :)\n. I'll fix this in #7941\n. You should just move this out of the try/catch so you can avoid the argument bloat and runtime check. It would help with my understanding as well because this one is not recursive where as the componentWillUnmount equivalent flag is recursive.\n. I'm suggesting moving the content of this block (calling the life-cycle) to mountComponent (line 335).\nThis would also move it out of the try/catch in performInitialMountWithErrorHandling but I believe that is currently a bug. If an error happens in this life-cycle, then we should propagate the error up to the outer error boundary. Not handle it in this failed one.\n. I guess, the question is, what priority should the error have?\nA) If no other priority can beat it, then we should just do this in a synchronous loop in place of performDeferredWork. If that's the case, then you can just have a separate try/catch around that one.\nB) If another priority can render higher than the error set state, then this flag can be invalidated before we get around to rendering the error. Since we can still update the state of the tree before it errored.\nSo, I think A is probably the easiest option.\n. Could you explain what's going on here? Why does this matter?\n. This is the hack. The rest are just regular updates.\n. It is always safe to set nextUnitOfWork to null because it will just find its place again.\n. If we naively just clear everything here, we'll lose the ability to unmount them. I don't think we need to clear anything here.\nWe normally we reset everything to whatever the \"current\" tree represents on the way down the tree. The simplest way might be to restart from the root.\nIn theory the error boundary will already be a clone, it might be fine to just restart from it. However, unstable_handleError may be calling setState on a component above (or even a sibling) and that will start screwing everything up. If you restart from the root, that case will be covered.\n. oops. left over.\n. Fixed. https://github.com/facebook/react/pull/8010/commits/23857e8fb7b8303632357f216181c99bc066caed\n. I like the idea of just importing ReactDOM and wrapping it all in a if (ReactDOMFeatureFlags.useFiber).\n. Can you add this if outside the it? That way this test isn't counted into the total.\n. Like discussed in chat, this is intended. It's a bit confusing but it's the most likely semantics that will work with current code.\nThe primary goal is to have a nicer upgrade path from existing code. Ease of understanding the semantics of the life-cycles can be achieved by redesigning a new API for them.\n. I don't think the debug tool should be part of the host environment since we can use this with any host environment.\nAdding things to this API should come with a very high bar since it makes it difficult to implement new renderers and it create a permanent type that we have to support.\nIt would be better if you passed this as a separate argument, separate from HostConfig.\nE.g. just pass it as debugTool parallel to config in the places you need it.\n. We should wrap all of these in __DEV__ before we have the infrastructure in place to statically DCE them.\n. Or should it be /react/docs/installation.html?\n. yea. This is copypaste.\n. Yea\n. Clearing the \"placement\" part of it.\n. newFiber.index will be 0 if this is a clone. The index we actually matched on is oldFiber.index which also happens to be the same as newIdx which is what we just looked up in the map.\n. @iamdustan This file might be of interest to you. It is the remainder of the injection system. At least in the first version of Fiber, but we can probably get rid of these completely at some point.\n. Ah. Thanks. Updated. But I guess I don't technically need it to pass this test. Will revisit when we try to make this test work with Fiber.\n. Can you explain how this happens? When we commit, we've already swapped the tree so as far as Fiber is concerned, it is deleted in the \"current\" state. So any rerender should presumably not try to unmount again.\n. In ReactChildFiber, I used a flag in a closure. The idea is that it makes it easy to just clone this to two separate paths. That way, in the normal case, we don't have to copy this boolean between stack frames and check its value at every stop.\n. It does look like you're tracking the currently unmounting Fiber anywhere so how do you know which error boundary to invoke if componentWillUnmount throws during a normal unmount?\nIn theory, since you need to track the currently unmounting Fiber you should be able to know which one failed. Since only one can fail, you can continue walking the tree from that point on. You'd know that anything after the failing node hasn't yet unmounted and anything before it has unmounted.\n. This probably makes the most sense but I'm worried about how this recovery works.\nI make a lot of assumptions about how this works and if something is partially committed I'm not sure if it is safe to continue from the \"current\" tree. Will it try to do deletions and insertions again? We might be able to reset those flags so that we can skip them.\nIn React Native we rely on things like indices so that we don't have to read from the native tree. Once we have already sent off a mutation, it's too late to go back on it.\nWe might need to guarantee that at least all host mutations are committed.\n. Would it be possible to reuse the nextEffect pointer here since you probably don't need it anymore? In that case, it's just a \"reversing a singly linked list\" problem.\n. Just an observation that this is the only thing in the first pass that might throw.\n. We should store the ref string in a separate variable so that we don't capture the entire element and all its props in the closure.\n. I'm not sure if it is faster or not actually. But we could try attaching string/owner as properties on the function. We only pay for it if you use it.\n. I thought we decided that we didn't need this for functional components? EDIT: Oh, it is DEV only. nvm.\n. This is not guaranteed to be a Fiber and it is not guaranteed to be a ClassComponent since you attach owners to functional components too.\n. If this is a string and there is no owner, we should probably not set the fiber.ref to a string. Maybe move the second condition inside.\n. This is doesn't reset it if the render throws. We should probably just move ReactCurrentOwner.current = null; out to @gaearon's top level try-block in #8095. So that we just reset it when we're completely done reconciling.\n. Or you can just add it at the end of performWork without the try/finally so that we can land this and get some test scores up! :)\n. I'm actually about to try to make this file work with Fiber but this is fine too.\n. This needs to move in behind the effectTag check. Because we don't want to invoke this unless the root updates. This can happen if a render is scheduled, but we do a deep setState update at a higher priority first.\nThis isn't actually possible right now without #7457 but it will be.\n. This tag will be checked inside of commitLifeCycles so there is no need to do it here. You can just remove the conditional.\n. Yes. I figured that it would be unnecessary to keep searching for the second one to force an error. The last commit adds a test for this. https://github.com/facebook/react/pull/8083/commits/8e2d7f8d2705159ca354294018bb98db1e0f4a71#diff-7556f354e68e9c4454dbd21aedf610dfR87\n. I figured we start off with all of these being detected on demand and then we can create optimized paths for common patterns. E.g. for things that have shouldComponentUpdate, and things that are pure components and things that have no update life-cycles etc. by storing that in the tag like @acdlite said.\n. Ideally the element itself could already have this information in its tag so that we don't even have to detect this during mount.\n. However, this can explode number of code paths so I figured we might want to optimize for collections of common patterns. For example: isPureComponent + no life-cycles. isPureComponent + only componentDidUpdate/componentWillUnmount but no other life-cycles. That way we can branch early and not do any of the checks. Never schedule update effects etc. EDIT: Although I guess it could also be a bitmask that allows this check to be optimized regardless of other early branches.\n. Maybe let's wait on the bitmap thing for now until we know the layout we want for it.\n. FWIW, the fact that commit happens here is an unfortunate artifact. When the last child completes, it have to backtrack quite a bit. Then finally it have to commit all work. All without checking remainingTime(). So we're actually quite likely to push into the next frame here. Ideally commitAllWork should move out so that the commit can happen in the beginning of the next requestIdleCallback instead of at the end of this one. That would make it so we don't have to pass this flag along.\n. I believe there is a way we can rewrite the commit phase so that we don't have to do nested try catches deep in it but this is fine as the first version.\n. This is the only place we have recursion. Kind of unfortunate.\n. A plausible strategy: When an error happens you can keep walking through the unmounting children and the effect list until you hit the lastEffect edge of the boundary. Then you can handle the error right there without keeping an array of them. Then you continue committing the rest.\nHowever, then the tree wouldn't be fully committed in unstable_handleError which is probably bad. So the array strategy might be needed after all.\n. Can we just make this low pri by default in ReactNoop and synchronous in ReactDOMFiber? So we don't have to expose this as an API?\n. Maybe @acdlite can look at this.\n. Meh. It's local enough and not slow.\n. Can we make this DEV only so that we are guaranteed to only use it in DEV?\n. Can you add that comment about coroutines that input everywhere? Just so I can find it later. Coroutines have children on stateNode atm. \n. We don't need to look up the updater dynamically. We know which updater it is here. Because there is exactly one single associated with ReactDOMFiber. However, we shouldn't drill through the abstraction layers here. We should expose something more specific if we need to.\nHowever, there is already an isMounted check (which is not free), happening inside findHostInstance so we shouldn't need to redo it.\n. This is a different duck typing than we currently have. We check for render to determine this error.\n. We should not be using optional arguments but I'd rather restructure this to not use runtime flags.\n. Actually, this is not sufficient since the state may depend on props so it can yield different results during the rerender. This would then only throw an error during race conditions.\njs\nclass Foo extends React.Component {\n  state = this.props.bar ? {} : [];\n}\nI'd rather check it every time.\nFor warnings, we should probably ideally dedupe though.\n. Can you move isArray to the module scope like this? https://github.com/facebook/react/blob/d5eff3b0eb714679d41d39edc160b45d0e5c48af/src/renderers/shared/fiber/ReactChildFiber.js#L48\n. Can you add a comment like // TODO: Change this to be a warning.?\nI don't think this needs to be an error but might as well do this for compatibility for now.\n. This is not guaranteed to be a host node. It can be any other type of work. Therefore, this assignment isn't type safe. You'd need to recurse upwards quite a bit to find the parent but we wouldn't want to do that for any text update since this is only needed in an edge case.\n. This would always insert it at the end but there could be a bunch of siblings in between.\n. Ideally we should avoid first-class functions because I'd like everything to be able to take advantage of inline expansion - and be easily portable to C. It also helps newcomers to follow code that you don't have to jump back and forth. Not sure if we'll even use first-class functions for scheduling in React Native because we're not tied to rAF/rIC. Might just move that part to the DOM renderer.\nIt'd probably be better to go in the opposite direction and unify deferred/animation work and simply branch in performWork before the loop.\n. Can you explain why Fiber needs to be special here and take a callback argument instead of a separate enqueueCallback call?\nIf we're going down that route, we should just do the same for the stack reconciler instead.\n. Can we localize this branch to the two places that differ? ...(ReactDOMFeatureFlags.useFiber ? ['foo'] : []) and ...(!ReactDOMFeatureFlags.useFiber ? ['foo'] : [])\nIt is hard to follow what the difference is here.\n. I think the way stack works is that enqueueCallback enqueues a second synchronous flush, which doesn't really do anything except calling the callback.\n. Don't we somehow have a flag already?\n. Does this mean that any time anyone adds a passing test, unrelated to Fiber, in a PR we will get a Travis error on the PR?\n. It's good for the team but might be noisy for third-party PR. Not too worried about it though. Let's see how it works out.\n. Why does this strategy that Stack uses (two separate synchronous reconciliations) work for Fiber? My worry would be that this is covering up another bug.\n. I split them out in Stack because they look like they are conceptually linked but they're actually not since the callback isn't fired after a particular state update but after all the state updates. It's an API designed without consideration for batching.\nAt some point I considered making the enqueueCallback API public instead of the argument to setState.\nWe only have to do an extra flush now because they're synchronous but as soon as we get rid of that it won't cause an extra flush. They'all always be batched.\nWe shouldn't even need to traverse the parents in schedule update since we've already scheduled this node's priority.\n. what does this comment mean? Isn't that what you're doing above?\n. We should never test for absence of a particular error message since that might cover up errors when messages change.\n. Yes. Before it scanned the tree the change event callback, but container2 isn't in the shared parent yet because this setState is batched. In the new version it doesn't scan the tree until after componentDidUpdate so it has time to add itself to the tree.\n. It looks like we're not really scheduling updates with any priorityLevel so we can just remove this argument completely to simply things.\n. Does this need to be reset if there is only a callback but no update? Or is it already null in that case?\n. Can we make this null | Deadline? Not a fan of the last argument accepting undefined since the type system won't catch accidental missing args.\n. We should ideally not use undefined since this doesn't let us track accidental missing argument. null | PriorityLevel would be better.\nIdeally we shouldn't have an nullable numbers. This causes them to be boxed (in more optimized compilers than JS VMs).\nMaybe there's a way to restructure this into two methods where the other calls this with priorityContent?\n. Should this be performed if an error is thrown? Currently it would be since it is in finally. cc @gaearon \n. These should no longer accept a callback argument, right?\n. It would be nice to have a unit test that covers the case you fixed with the new side-effect type. I.e. setState({}, cb); where shouldComponentUpdate bails out so there is no componentDidUpdate.\n. I'd argue that maybe we shouldn't expose flushAnimationPri(), flushDeferredPri() neither.\nIt seems natural now but look at all the other tests we have to clean up now that seemed to expose natural implementation details in the past.\n. IMO ReactNoop served as a good example of a minimal renderer for documentation purposes but also because there is minimal logic in the renderer so it creates a nice unit of work.\nThe more logic the renderer has or exposes, the less we're testing only the renderer code and we might rely on things in the ReactNoop renderer that we forget to replicate in other renderers.\n. I don't think we'll have deferred/animation callbacks in React Native so we might drop this from the API and make that an implementation detail of the React DOM renderer.\n. Hm. This is strange that this was passing before. This is probably a behavior change that we want to allow.\n. Don't think it matters.\n. Can we check x.props.foo if this is fiber while we're at it?\n. It will fail regardless now but once we fix RN this could pass. Otherwise we later have to go through this test. 15 minutes saved later.\n. Oh I see what you're saying. Just land it as is NBD.\n. We have a module that lets you do this now. getComponentName.\n. I guess that module doesn't use inst.constructor as a fallback. Hm. Maybe it should? Don't know. I'll land this for now while we figure that out.\n. this name is duplicated. a bit confusing.\n. This bypasses the ChangeEventPlugin and creates its own synthetic event. So it doesn't go through that logic.\nHow would you suggest that I leave it in ChangeEvent? Expose something only for testing?\n. It used to be the case that expects didn't throw. Instead it just marked the test as failed and continued on. Has this changed with newer Jasmine versions? Does expecting a throw always work?\n. Could this just be return expectation.not;?\nIf we do PROD testing, don't we want to explicitly test that a warning doesn't fire?\n. It seems to me that we still want a test that schedules animation work and deferred work in componentDidMount. These should not be synchronous since they've explicitly opted in to being async.\n. I don't think that this is correct. Let's say we had a very low-priority render that had started deleting one child but it never completed. Instead it did some other higher priority updates to it. \nThen suddenly something in a boundary fails (or get another Task priority update). Then the child would be remounted instead of reused.\nI don't have a better solution atm but I'll think about it some more. I don't fully understand how the failure case happens now.\nWould always force unmounting children in an error boundary help with this case?\n. I think that this is already a problem with the current style of batching. If a controlled event happens within another batch, we won't flush completely down until after the controlled event is already done.\n. I find that indirection hard to read and not sure how inlinable that is.\n. I think we can find a way to not use these flags.\nA normal unmount won't schedule a removeChild anywhere but the top root where it was deleted. All we have to do is special case the root and then the rest of the traversal can be exactly the same.\nSimilarly, ignoreTop wouldn't be needed if instead we did the root work outside this function instead of inside it. That way we don't have to branch inside the loop.\n. I was hoping that we would be able to put push/pop inside ReactFiberBeginWork/ReactFiberCompleteWork. The reason is that I'd like to be able to reuse the tag check inside the switch statement so that we only even check for this if we hit the ClassComponent branch. That way when we build optimized paths, they can completely skip this check.\nI realize that this might be currently broken because we bail out before the switch statement in certain cases right now. We might have to move those around.\n. Can we use spread with our Object.assign rewrite?\n. In this case it'll (probably) be more efficient to use an array since we won't need to reorder anything and we won't need to reallocate anything when it grows and shrinks.\n. We already have the getComponentName module that you could use:\nhttps://github.com/facebook/react/blob/master/src/shared/utils/getComponentName.js#L18-L38\n. If we unwind to catch an error, we need to unwind the context as well so that we can continue with the next sibling after the error boundary.\n. Yea that could work.\n. No this is broken in more than one way. We have an issue on it in the Umbrella.\n. I think the error happens now because the event fires, so the expect does, but not yet sure why it isn't dispatched correctly.\n. @gaearon Shouldn't we be checking for the ReactDOMFeatureFlag instead? We shouldn't track implementation details like this in the tests.\n. js\nconst NotCallbackOrError = ~(Callback | Err);\nlet primaryEffectTag = effectfulFiber.effectTag & NotCallbackOrError;\n. When I call into this I'll make sure to only call restoreControlledState if TreeReflection.isMounted passes.\n. It's this task/PR I guess. :)\n. It is covered by tests so we can get back to it. I'm not sure how to do this since there is no unmount phase for each node. There is only a delete at the top. We could possible check if the tag of every removeChild is either of these or if it is html or head then check a few levels deeper.\n. It would be more palatable as a warning.\n. We're making assumptions about the types all over. Would require more work to fix up.\n. We probably don't want to do this in the commit phase regardless because the native insertion will be faster than doing it in JS. I'd rather do it twice where the first step is time-sliced and the second is native than interrupt.\nWe could possibly build up new subtrees top-down in the time sliced phase but it would require some significant work. I'm fine just making IE slower for now. They agreed to fix it.\n. We can probably use the same technique regardless.\n. I'll do that in a follow up. I might need to do lower casing somewhere else because I don't have anywhere to store it. I figured we could do it when creating the fiber itself maybe.\n. Currently there is no way to render a namespace where svg and foreignObject is valid tags (other than HTML and SVG respectively). I'll add a comment about it.\n. Only for Fiber, but I actually changed this in a later commit. The real issue is that it can't handle Fiber internal instances atm.\n. I think this is for the case where you switch from <button is=\"my-custom-button\" /> to <button />.\n. Although we should probably not allow that neither.\n. Yea, I was going to keep a stack like owner is implemented and look up the top of it, then pass that into the \"host config\".\n. I think findStack would throw if this is a fiber because it would find it in the instance map and then trigger this invariant: https://github.com/facebook/react/blob/master/src/renderers/dom/stack/client/findDOMNode.js#L53-L60\n. If we just put this in ReactDOMFiber we don't have to do any splits.\n. This commit actually fixes some issues so some tests get further but not enough to complete them so it looks like a pure regression.\nWe need to fix findAllInRenderedChildren and findDOMNode with a different strategy somehow asap. I don't know how yet. Any ideas?. This is not sufficient because we can use ReactDOM and ReactDOMFiber at the same time when the flag is not on.. Can we fork performUnitOfWork into a separate function then call it synchronous in a while loop while there is still capturedErrors? That way we don't have to check this condition thousands of times per frame (and whatever else optimizations can be done as a result).. That's not true because dangerouslySetInnerHTML can have multiple children.. Can you place ReactPortal before ReactText and ReactFragment? It used to matter. I'm not sure it still does but there was something weird with ReactEmpty before. I think I had a similar comment in another PR.. If we let Portal always have a null output we don't need to do this.. Let's make this always leave output as null and just use this fiber as is in commit work instead.. We can just do const children = finishedWork; for now since the host config will just traverse the tree deeply right now.. No, why would it? This is just if we screw up something so that there are placement flags on both trees.. Maybe we won't have to when we finally fix it for good. :). I think this happens if we call load on a deleted child. I guess we should ignore that event maybe? There's a todo to follow up on that.. Type wise it's not. So Flow will probably complain.. I found the other one harder to follow.. Any reason we need to allocate instead of just mutating something in the closure here?. It realized that this is not actually the correct behavior because if a life-cycle focuses a different thing we don't want to restore it back again.\nSince these transaction wrappers are before the DOM ready queue and they execute in order it seems to me that the restore should actually happen before the life-cycles get invoked. So this whole block needs to move up to line 214.\n. Ideally we'd have a DOM specific test for this that tests the observable intent.. These should both be imported as constants like these https://github.com/facebook/react/blob/e3131c1d55d6695c2f0966379535f88b813f912b/src/renderers/shared/fiber/ReactFiberCommitWork.js#L35-L41. Fiber validates this by the pure existence of getChildContext where as stack only validates this if getChildContext returns truthy.. Noop.. Fixed.. If more work gets scheduled during performTaskWork, e.g. in componentDidMount, does that still get performed before returning here?. I guess we can remove this now since we're not testing this.. This caused a lint error.. You should probably just remove the the variable too.. Yea I think it is. Updated.. This only happens to work because HostContainer always end up with two Fibers but that seems unnecessary.. So if we fix that, then this same logic will need to be applied for HostContainer too. I don't quite understand this. Why is this failing now? Are we waiting for another fix?. We no coverage of time slicing or bailouts for coroutines at all yet.. This is a bit of a WIP still. It might be correctness related. I'm not even sure.. Because the first time the coroutine completes, it adds itself to the effect list. Then it does its child, and completes again.\nNot sure what happens if there are no children in the first phase. It probably breaks anyway.. Actually, it's because the new test uses classes which have \"update effects\" scheduled on them to invoke the life-cycles. Those effects gets scheduled twice.. This is likely going to be an issue to do for every update. We might want to consider just banning non-lowercase uses instead.. Why are all these taking more cycles?. Why is this failing now? It doesn't seem to test any error boundaries.. Why do this here instead of inside reconcileChildrenIterator? Flow?. We should fix this in Fiber. This should not be ok. We should error since it catches missing return branches. I have noticed that this sometimes gets a false positive when I run the record-tests script with the ReactDOMFeatureFlag turned on locally. cc @spicyj . I think what is probably happening is that the override in the script isn't being applied. So we get the real ReactDOMFeatureFlags. So the script isn't testing Fiber. Only when we turn it on in the real file does Fiber get tested and it correctly fails.. Maybe the call to jest.resetModuleRegistry kills the mock set up by test-framework-setup? If so then more tests could be incorrectly passing.. I believe the foreignObject itself should be the SVG namespace but then get next namespace underneath it should be HTML.. Can you add an assertion that the <svg /> tag itself has the SVG namespace?. These try blocks should be outside the while loop. That way we can hoist them out of this function and avoid going in and out of an deopt path for each iteration.. So this is part of the follow up?. When does this happen? If a callback to render throws?. If so, I'm not sure if we need to bother with this special case much since it happens at the end after all other work so there's no interleaving issue. Maybe for batching across roots but I'm not sure if this solution is sufficient in that case yet anyway.. Should we pass props too? We have cases like props.is where props determine the type. I could imagine this being useful.. Here's the goal: This whole thing needs to be inlinable so that this check doesn't cause extra cost for non-context changing components. Currently this function is called multiple times which makes this a tradeoff a compiler might not do. Also getHostContext is similar. And regardless this needs at least two checks, one to compare the type string and one to compare the object pointers.. If you have a separate variable for the top value, it becomes faster to read since we do a lot more reads than we do push/pop. Same for the context.. Since it's a numeric property it's not as bad as property access but at least it's two more indirections to figure out where the array object is and then where the content allocation is. Assuming the optimization is good. More with less optimization which is our common case.. Nit: This should've been cached in a local variable above instead of using the object form.. I'd rather get rid of this pattern. People have a lot of trouble reading this and has almost no value over just const callbackList = finishedWork.callbackList;\nThe exception being at the top level scope but they're intended to just be analogous to module imports. As they should be with better build tooling.. This is what the second paragraph refers to. :) I meant the top level scope or the \"config\" scope.\nIdeally config should just be import { shouldSetTextContent } from \"HostConfig\"; and then \"HostConfig\" is injectable by the build tooling.. cc @gaearon for context. We should probably finish this comment.. This seems wrong to me. I can't really reason about where this will break down. We should probably just move this to the updateQueue instead.. We can do that in a follow up though.. This seems odd. Why are we returning the same work to be processed again? This seems like a smell. Seems like we should be able to terminate here. E.g. returning null, and then just fall back up the stack somehow instead of having to check pendingCommit everywhere.. We shouldn't need to read this field at all in a normal cycle (let alone three times). Seems like a smell.. It's unclear to me why these timings changed in this commit. Can you explain?. We should revert this and do this separately everywhere if we want to, but until then nothing should rely on this to work.. We'll need to replicate this to the separate repo. cc @bvaughn . We should make these optional so that they don't have to be added to every renderer. That way we can also do things like:\njs\nconst { getChildHostContext } = config;\nif (getChildHostContext) {\n  var data = getSomeData();\n  return getChildHostContext(data);\n}\nThat way if the compiler knows that it is always undefined, it can dead-code eliminate everything in the if statement. That's part of the reason I'd like to compile the renderer and host config together into one unit instead of making them share code.. Heads up: I renamed this to usePortal. This was non-obvious to me. Could use a comment.. Why is this not covered by https://github.com/gaearon/react/blob/c69be1c5f499e24dd08878df612321edc6a8135f/src/renderers/shared/fiber/ReactFiberCommitWork.js#L274 ?. It can. <div>{c ? portal : null}</div> does.\nBut my question is why calling unmountHostComponents(parent, current); below doesn't just work? Since current will be the portal and that will be the first node and then unmountHostComponents will do exactly this.. Tagging children for placement or deletion is beneficial because we avoid traversing the tree twice but it's a little tricky to do. Need to put some stuff a stack.. My theory is that we shouldn't need this extra tag check because we're going to need one inside unmountHostComponents anyway. We unnecessarily call getHostParent but that's not the common case.. If the portal gets the unmount, then we should hit this https://github.com/gaearon/react/blob/c69be1c5f499e24dd08878df612321edc6a8135f/src/renderers/shared/fiber/ReactFiberCommitWork.js#L274 before we reach the <p />. So we override the parent to be the portal before we do that.. An alternate solution could be portal.children || [].\nThis is also a problem with HostRoot so we should choose a consistent strategy.\nhttps://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactFiberReconciler.js#L163\nHowever, I'm also considering using an effect tag to indicate the lack or existence of pendingProps instead.. For the new Context API I was thinking that we should require a default value so that the type is always guaranteed to be satisfied and the user doesn't have to add extra null checks. Maybe we should do the same for host context?. Hm. Well that seems to be the problem then.. Why does context arrays have to be stored separately here? Can't you just push another context onto the stack of contexts? Even if that is null. Then pop it on the way back up.. How can you ever pop a host container with a context deeper than one null? Wouldn't this always be exactly one null?\nBecause any new context provider will be below the portal in the tree and pop on the way up to the portal.\nThink of this problem in terms of a normal execution stack. You wouldn't need multiple arrays and these special cases for unwinding in a normal execution stack other than when you unwind for errors so you shouldn't need it here.. Ideally getHotsContext could just return a value from the closure instead of going through the array just like getRootHostContainer does.. Having two types is not sustainable with all the different variants we need and it has little benefit since you have to coerce it anyway. The coercion is worse than just assuming it is always available since it will drop information about which specific Fiber it is if we overload it.\nIn #8545 I simply added this field to all Fibers.\nSo I'd suggest just doing the same. Add it to the Fiber.. Btw, I had to fix this pattern when I did that: https://github.com/facebook/react/pull/8545/files#diff-5842acf7560d3c499ac59f2652b3918dR328. I think we should actually expose the roots in the debug tools since we might want to expose info about the container. Additionally, since roots can contain fragments there can actually be multiple roots if we were to ignore the container. At least add a TODO here.. Yea. I think we'll want to change the constructor logic there at some point to pass everything that can be non-nullable to satisfy the use case in #8545 but we probably need to trick Flow to follow it regardless. Perhaps we can use declare __DEV__ : true; somewhere to trick Flow into always taking that path (although that might trigger unused paths and miss errors in those paths).. cc @bvaughn For ART changes.. Seems like dead code.. It would actually be nice to use to use something from props here since that shows that we're able to reuse previous props for a new condition. Maybe '\"' + props.text + '\"' or something?. We shouldn't rely on object iteration order. This has failed us in the past, and in fact, we have talked about enforcing that all keys are always defined to enforce that the state object has a consistent hidden class.\nCan you rewrite this to test that there are actually two renders and that the first one only have part of the state and the second one has all three?\nThis same goes for all the other tests in this file that use the same hack.. Can we fine a way to move all of these out of the scheduler? These are super specific to the class API and as we add new APIs we don't want to bloat the scheduler which already has too many unrelated concepts.. This is in the hot path. Any reason this can't be outside the while loop?. While you're at it, this also doesn't belong in the hot path for the same reason.. Maybe add a comment that we usually expect this to be null so this shouldn't be a perf issue.. This doesn't affect CWU. Will need to come back to this to ensure I understand it.. It is possible for a single Fiber to have been rendered by two different parents. E.g. in your example the props.children may have bailed out when the parent switched. So at any given point it can be both.\nI think it may just depend on context. In some context you may want the \"current\" Fiber path but in the case of the key warning you probably want the path you took to get to the update which will have the correct .return pointers in that case.. Yea, is there anyway you can just avoid adding it by doing the check below this condition instead?. This whole validation is going to be pretty expensive with all these extra temporary allocations anyway. I would suggest that we just do two loops over the array or iterable so that the whole logic can be isolated to a separate function and not bloat the already complex diffing which is about to be even more complex with further optimizations.\nIt might even be faster due to better memory locality.. If it is meant to only be used during reconciliation and not at random times or commit phase, then we should name it to reflect that. We could even enforce it by making it getStackAddendumByCurrentFiber() reading the currently executing Fiber.\nBut I'm not sure what you're plan is for things outside of reconciliation since these example are all during reconciliation as far as I can tell.. We should stick to integer numbers instead of floats (Infinity is a floating point value) if possible so that we can optimize it as such.. just use 255 :P. MAX_SAFE_INTEGER will also trigger the float type in the VM because it's higher than 32 or 31 bit representations which ever is the one used.. I suppose we should ideally have all our warnings replicated on the server and therefore have test for each one in a server-environment. Unless it's for updates etc.. Why don't we just set ReactDebugCurrentFiber during the commit phase too so that it's easy for any renderer to get to this debug information during whatever validation they want?. Can we make this it's own if block? The console.errors should also use the warning module.\nIt used to be that our dead code elimination didn't work on more conditionals. It might now.\nRegardless, I'd like to know for sure that this gets stripped and that's easier to determine with a single block. If the parenthesis are wrong somewhere, and you get a || in the condition then the whole thing and all its dependencies won't be stripped.. I find the intention of this loop really confusing since it is meant to terminate after only two iterations. Seems it would be easier to just explode it but I'll try to read it as is first.. insertAfter.next = update is the thing to worry about here. I think that either it is the same and we only set it twice or they're always different and copies but in different queue or one of them is null. It would be nice to colocate this logic somehow so that this assumption can be reasoned about locally. Right now you have to ensure that both of these functions line up and understand that this assumption exists.. It's not great that we have different method signatures for dev and prod and we also don't want to pass this in prod. If we're luck it just gets inlined and dropped. I don't have a better proposal. Just flagging it.. I suppose you could move the error out of this function. It's a pretty simple conditional to replicate to the methods (setState / replaceState / forceUpdate). That would be nicer.. Why is any previous state needed? Why is prevState better than state? Seems arbitrary.. I have concerned because we don't set memoizedProps here. If we abort and then resume we might end up relying on the wrong memoizedState but I don't see any bugs yet and we probably want to move to a model where memoizedProps is also set in begin.. Let's move this back to the update queue.. Nit: We don't really use else with DEV blocks because it didn't use to work in our transforms but I actually prefer that pattern because it enforces the notion that __DEV__ is only additional and doesn't change behavior. For this case I tend to prefer to use an early return instead. Although in this case I guess it severely changes the whole return type.. I don't like these forwarding things. We have so much of these in the event system that just adds bloat, add risk for cyclic dependencies and confusion.\nDo you have a plan with these or can you just move this to ReactDOMFiber?. Btw, the only reason for a separate ReactDOMFiberComponent file is to keep parity with Stack so that we can easier replicate changes. Should get rid of this file later.. Does the child nesting validation not case about the namespace?. If this throws an error during unmount (deeply), what happens? Do callbacks still get fired?. Are you going to do this?. @gaearon This doesn't seem right. If I'm rendering SVG into an SVG tree, then the current namespace isn't HTML and the tag name isn't enough to determine it since I could be rendering into any SVG root. It seems to me that we should be reading the namespace of the root instead of the tagName.. This is part of TODO 2 because if we have no event listeners, then we don't update the fiber pointer. If we don't update the Fiber pointer, then the new one becomes work in progress. If we try to read from work in progress, this might be null. If it completes, it might have event listeners on it that are not yet committed.\nTherefore this isn't a great solution.. Why emptyObject instead of null on both of these? We could use ES2015 .fill() here if available.\nAnother thing we could do if we're worried about leakage is to store the max index of the previous run and then only clear the delta between the previous two runs. That way if we end up refilling the stack every time we rerender we don't have to fill it twice.. We should make this generic type StackCursor<T> = {| current: T |}.\nYou will have to make some unsound things when you pop here but then everywhere else is fine.. If you add an initial default value, Flow will let you make this generic.\nfunction<T>(defaultValue : T) : StackCursor<T> {\nWhen you can invoke it with createCursor((null : ?string)) to get a typed version of the stack cursor.. This wasn't always pushed before such as when props.hidden. Now it should always push.. We could but I suspect that with #8611 these will be unified to a single call to an external module which is why I grouped them inside of just inlining them.. Ah yes. Good catch.. \u00af_(\u30c4)_/\u00af. Yea. Fixed.. It seems to me that mountClassInstance disappeared from this path now. Should be easy to cover this in the test by reading from props and context as well as using componentWillMount.. \njs\nindex++;\nvalueStack[index] = cursor.current;\ncursor.current = value;. If you set the default here to (false : boolean) you can get rid of the nullable type.. By avoiding the nullable type above, you don't need coerce this. You can just return didPerformWorkStackCursor.current.. Passing a cursor here seems like an odd API since it's invalid to only reset one cursor. You have to reset all at once. It also causes the unsound assignment below.\nCurrently this only works because index is already at -1 at the second call to reset so the loop is unnecessary.\nI'd recommend just dropping the cursor argument and reset them separately if you think it's necessary to reset them.. This can be value : T for a bit stronger guarantees that ensures that we don't push unexpected values.. This is unsound since it doesn't reset to the defaultValue. However, I don't think this should ever be possible since the first value that goes into the value stack is the defaultValue. So you shouldn't be able to pop further than that.. This should just be:\njs\ncursor.current = valueStack[index];\nOtherwise you're never reading index 0.. It won't have asymmetric behavior if you fix the reset below. :) . We now have two calls to reset in a row because the only thing that calls this is:\nhttps://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactFiberScheduler.js#L157-L160\nSo we could just call reset(); at the top of that function instead.. Should this be a WeakMap?. @acdlite Keeping pendingContext on the root fiber seems fragile and doesn't work correctly with incremental. Can we move it to the update queue of the host root now?\nOn the other hand, this is all just a temporary hack until we can switch to portals.. This is always true. If you wanted to check if this was a HostRoot, you'd check the tag, but even if you did this would always be true.\nInstead you could probably check if there is an .alternate before calling scheduleTopLevelUpdate. That's usually how we determine if something is initial mount or not.. It begs the question though... What if element === null and it was the initial mount? E.g. if you unmount in componentDidMount. I suppose we pretend it never happened?. What if you do a reentrant update from within a synchronous mount?. Should you be asserting that what you expected happened? Otherwise you can merge the call below into this one.. These could have been called with null if there was a bug. I tend to prefer pushing to an array since that covers that and tests execution order.. You've changed this behavior so you had to update but you didn't replace it with an equivalent test anywhere. This is just less test coverage instead of testing the new behavior.. I don't like that this is a duplicate runtime type check with the branch check that is done in ReactChildFiber.\nIMO we should move this validation into the ReactChildFiber since you can just throw if you fall out into the last branch.. I think a good guideline is that we shouldn't have any production invariants unless the branch is already covered regardless.. We had trouble keeping things in sync when we split these. It might be helpful to move this inside of updateClassComponent and similarly for the others so that it is easier to tell when this needs to happen relative to other things. I'm not 100% sure this should definitely be at the very end in all cases.. Are we doing this on every instance? That's probably not great.. Since nested interleaved commits are broken anyway, can we revert this?. Why is this necessary? We don't do this elsewhere do we?. Is @spicyj ok with this divergence? Seems like it would be pretty easy to start relying on this, even accidentally.. We could consider returning an constant enum number tag here. Like other tags. It's not less efficient as long as it gets inlined and the constants make it a bit more readable. It's also more extensible if we want to add more tags here.. We should expand the Props type to include this as optional instead of relying on any here.. You can cast this to something more specific that has the focus method on it.\nSuch as ((domElement : any) : HTMLInputElement). That way we know what it should be if we properly typed this.. You are no longer using the focusNode helper which means that this will start throwing in IE8 for hidden elements which is a breaking change. Do we really want that?. Is this extra shouldAutoFocusHostComponent really necessary? Won't this only be scheduled if the first one is true? At least after #8685.. This is unfortunate that this was passed before but not accepted. How can we have caught that?. This used to use a linked list like all the other structures. That requires dynamic reallocation as it grows. It also requires us to take on a dependency on such an implementation. This might matter if we make a WASM port.\nWould it make sense to just use a simple linked list here too, just for consistency?. In context it is a fixed general stack. In normal use it never gets reallocated or expanded. The wasm implementation can be as easy as a fixed one time linear allocation. Where as this is dynamically allocated and growing.. This is not type safe for the case finishedWork.tag === ClassComponent.. Hm. It's strange that you're allowed to avoid the type annotation here. It probably leads to some overly optimistic analysis by Flow. We should add a type annotation here. It's important to do in the renderers since otherwise the generic arguments can be inferred to be very weak.. finishedWork.stateNode on a a class component will be the instance of the class. That doesn't match the generic types I | TI. I think it only accidentally works on runtime now because you assume they won't have a .tag field with the string INSTANCE so they fallback.\nYou can make separate branches by switching on finishedWork.tag and only use getPublicInstance on the branch on HostComponent.. It would be nice to have the return value here too to guarantee that the inference is correct. Otherwise, if it gets passed somewhere else, it might be inferred to be something very simple (like an empty object) and passes everywhere.. The purpose of this method is the same as for refs except for the return value on the very top level. var inst = ReactDOM.render(...)\nIt should never be possible to get a handle on an instance of I or TI since those are internal instances to the renderer. The point of getPublicInstance is to ensure that.\nTherefore this should only return ReactComponent<any, any, any> | PI | null.\nTo ensure that you must call getPublicInstance on the stateNode for the appropriate tag.. Ah, I see. Just put getPublicInstance(inst : Instance | TextInstance) : * then for \"inferred\". That way if createNodeMock gets a proper type in the future, it'll get caught.. Making it generic is explicitly a non-goal. If all we need is something super generic. Maybe we can just stick to arrays.. This function still needs to pass stateNode to getPublicInstance for the relevant tags.. Interestingly RN did this by packing all fields into one payload object. Caused a bunch of weird artifacts that made diffing harder to optimize.\nWe should reevaluate the actual algorithms here but for now I just wanted compatibility with CSSPropertyOperations since it is shared with Stack.. One of the things this fixes is that getRootHostContainer is no longer needed in the commit phase if we do it here. As we know, getRootHostContainer is not safe to use during commits since we may not have the right context.\nThere's also no need to do this in the commit phase so might as well do it during the time sliced parts.. Also note that there is an open TODO items related to this.. That assumes that you can iterate both interleaved which for...in doesn't let you do. It would require something like Object.keys or a generator with for...in to be really fast. Not too worried about this though. Something we can micro-optimize easily if needed.. Nice catch. I wish Flow would warn about this.. The code in this branch is also wrong since it'll push a null. I'll delete.. Donno. I just did a line-by-line translation.. If I don't put it here, I need it in all the places where I could create styleUpdates. Because there may not be a STYLE field in the nextProps but might be one in lastProps or vice versa. I also don't want to end up pushing it twice. I'm not sure that's better.. Why is this needed? Wouldn't this already have been memoized if a child threw?. Is this an abstraction worthy the pain of passing around? :). I still don't understand why this needs to be done in beginFailedWork specifically.\nIf anything, this should set the memoized values to null since this component is now in an invalid state. The children output doesn't correspond to the input.. Let's put this way. Why are these lines in this PR at all? What happens if you just exclude them like it was before?. I think that something is broken here with this error handling logic but I understand now that you're only preserving existing behavior by moving it in here. I think that's fine for the first iteration.. js\nvar instA;\nvar instB = MyRenderer.render(<div ref={n => instA = n} />);\nexpect(instA).toBe(instB);\nIs that always true with the test renderer?. But #8685 added a special tag for refs so it shouldn't be necessary for it to call commitMount in that case anymore, right?. ^ @acdlite  . I guess this could be HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement.. What you're really saying here is that they're allowed to return anything (including strings, arrays etc.). Why is this now failing? It seems like you didn't do anything to disable existing behavior.. This is unfortunate because it removes a neat GC clean up opportunity (although many subscriptions will hold onto the tree regardless). At least if a whole subtree can be GC:ed, right now we get the clean up automatically (if someone forgets unmountComponentAtNode).\nThe __REACT_DEVTOOLS_GLOBAL_HOOK__ is always available regardless if the tool is available or not. That gives us an opportunity to react to its existence. We know that we'll never need to drop any roots because we can just pass them along to the __REACT_DEVTOOLS_GLOBAL_HOOK__ and it can decide whether we need to keep them around for when the devtools starts.. In practice, since this only attaches to __REACT_DEVTOOLS_GLOBAL_HOOK__ there will only ever need to be one listener, which is the __REACT_DEVTOOLS_GLOBAL_HOOK__ itself. It might be simpler just do track it as const listener = __REACT_DEVTOOLS_GLOBAL_HOOK__ and call on it.\nThat way this source can be smaller for when we put it in prod.. This still suffers from this problem: https://github.com/facebook/react/pull/8628/files/9a9276b3fbcec4cfb6d5c69e891c5feafe0195f2#r95653360 Which remains a problem in commitWork.\nYou need to check whether containerFiber.child.tag === HostComponent before passing it to getPublicInstance.\nOtherwise, in the case of render(<Foo />) you will pass an instance of Foo to getPublicInstance which is neither an I nor TI so the function doesn't know what to do with it.. This will become more clear after https://github.com/facebook/react/pull/8545 because then the stateNode will have a proper type and Flow would've disallowed passing it to getPublicInstance.. This will need to be replicated in ReactDOMFiberComponent which is a fork.. cc @gaearon for docs. Seems unnecessary to fork this whole function now. Can't you just add this conditional down below behind a smaller if (ReactFeatureFlags.disableNewFiberFeatures) { instead of forking the whole function?. Ah yes. I missed this too. This is probably either a bug or behavior change regarding event timing.. Fixed: https://github.com/facebook/react/pull/8839. This is the only change. The rest is renames.. If iOS 8.4 supports requestAnimationFrame but not performance.now my hypothesis is that the value passed to requestAnimationFrame is the old Date.now version of requestAnimationFrame.\nYes, it is very possible that there is a browser that implements the new requestAnimationFrame without implementing performance.now. Seems unlikely though.\nHowever, even more likely is that there are browsers out there that implement the old requestAnimationFrame while already implementing performance.now. That's very possible.\nWe could probably do a guess based on the value passed to requestAnimationFrame which one it is (if it is a very low number) and then switch dynamically between the two. For the case where the new rAF is implemented but no performance.now we could use a Date.now time stamp instead. I'd rather not complicate it unless we know of at least one browser where either of this happens though. Perhaps we can call on the community to help out identifying issues here?. Hm. Actually I wonder if performance.now might be implemented behind performance.webkitNow in some cases which would trigger the bad case.. Yes but only in V8. Others use NaN tagging. It's likely already unlike that you'd use it this way. We can warn if it becomes an issue.. I tend to prefer putting exports outside the conditional at the top level so that we can easily convert this to ES modules. Also guarantees that all names are always exported and constant bindings.. Aren't all warnings supposed to be __DEV__ only so we can strip the warning module and its entire system in PROD? This is available in PROD.. I wonder if we should capture __REACT_DEVTOOLS_GLOBAL_HOOK__.inject et all in constant closure variables to make it type safe and easily inlinable by the VM. Currently, it's not since both the global and the object itself could've been mutated.. I think the module itself is disabled in PROD and we should probably ensure that it gets fully stripped with a transform like we do for invariant messages.\nIt was just unclear what was intended here.. I'm not sure it makes sense to put the version here. 1) It adds runtime Object.assign cost and more code. Probably resulting in an unoptimized object atm. 2) The version indicates what API is exposed, but that API is defined by the DOM renderer here. If you bump this you have to make sure that all consumers and downstream renderers bump theirs too. So isn't the current version more associated with the DOM renderer rather than this shared helper?\nI'm also skeptical about version numbers being super useful here anyway. Often we'll want to add features to the devtools that work with minor already released versions without the ability to bump this so we would and those features might not work with the whole range of the version.\nSo I think we'll probably just end up with feature detection anyway.. In your work enum case, it's similarly not obvious that you need to bump the version number when you make this change. Effectively, we'd just have to bump the version number all the time, meaning we also have to make devtools opt in all the time for every change even though most of them keeps working just fine.\nAnd if we add features to devtools after the fact, we'd end up with things relying on internals anyway.. Hm. This looks wrong. This changes the behavior we're testing. Why doesn't it work?. Specifically we want to test that we can render into the node we already rendered.. I still think this should be unconditional, here and move the conditional into the other module, so that it can be inlined AOT and we don't have to think about this possibly being null.. That might be a bug either in Fiber or the test renderer. You should definitely not use progressedChild.. Since this only gets called once, it should be fine to just check typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== 'undefined' && __REACT_DEVTOOLS_GLOBAL_HOOK__.supportsFiber at inside of it. That way that code can be moved inline at this callsite by a compiler and avoid some packing overhead.. The problem is that you're looking at the wrong root. There's two. We might also want to switch which one createContainer returns.\nFor now, use stateNode to store the \"root\".\njs\nvar root = TestRenderer.createContainer(container).stateNode;\nThis will not be a Fiber object so every time you use it you need to use root.current to get the current Fiber.\nThere are two Fibers per root and this will ensure that you get the right one.. Same thing for that one.. After https://github.com/facebook/react/pull/8934 this doesn't need .stateNode anymore.. Yes plz.. Maybe we should still warn in the case iteratorFn !== children.entries in case we want to have this back? People shouldn't use maps where the key is implicitly another child. Could create strange bugs.. That check doesn't check the type of the iterator.. Do these strings get compressed? Would it be better if we split them into separate invariants?. Never safe to rely on unmount.. I'll move these up to src/renderers/__tests__/ instead of the unnecessary extra level. . I'm not a fan of this pattern since they don't get stripped in prod. Can we reword it to be setState, replaceState or forceUpdate in the message instead of complicating the code?. yea. yea but I'm not sure we need this feature from ErrorUtils neither. Maybe for event handlers I guess it is pretty useful.. I see changes to this test but no changes to how stack works. So how did this pass before vs. now? EDIT: Oh nvm. I get it. This used to be dependent on module state between resets.. Unrelated: There's some slow paths here that we should look into optimizing.. Can you confirm that this works in the npm build? I.e. grunt build puts this file in the npm package. I've had trouble in RN when this isn't reachable from within the npm build?. Can you remove the return here?\nCan you confirm that this never returns a value and never throws? That is important because that is what lets us strip it out safely in production.. This closure is going to be created for every element on the entire page, and every update. That's an awful lot of allocation. Even for DEV.. When do we ever want warnOnRepeat to be true? Seems like this doesn't have to be optional and simplifies the API a bit. Tests can be written by resetting the module cache.. It seems like all we really need format message for is to get the stack. That seems like something very specific that would be a common use case. Maybe we should make it getStack instead?\njs\nvar stack = getStack ? getStack() : '';\nvar message = error.message + (stack ? '\\n' + stack : '');\nThat way, if browser devtools let us actually mess around with the stack that console.error produces, or if we can attach custom stacks to new Error, then we have an ability to do that separately.. I think this could be designed with global context. In Fiber we went with an approach that picked up the current context from a global mutable.\nhttps://github.com/facebook/react/blob/e36b38c1cad22f7dff557736cf4b0280106e937e/src/renderers/dom/fiber/wrappers/ReactDOMFiberTextarea.js#L72\nThat way we don't have to pass it along as an additional argument everywhere.\nIf it did it that way this function could just be a global instead of creating a closure.\nIt seems natural for things like ReactElementValidator anyway since we read the owner from ReactCurrentOwner anyway. We just pass it in a very round about way.. Not if the error logger can do something special with it in the future.\nImagine if console.error was enhanced to do something like this:\njs\nconsole.error({ message, stack });\nThen the message was shown in the console and then the stack expanded when you click the little nub. With links to the source code.\nThe data structure of Error has a separate message and stack.\nSimilarly, if you log the warnings to a database, like we do, you likely want to put the stack in a separate column so that you can group on the error messages. If you wanted to do that with a single message, you'd have to write a manual parser that splits them back up. If every user of this API does it slightly differently, it is a pain to find a parser that can figure it out for all.. At FB we actually split each of these into a separate column in the database logs. So if we can preserve that, that'd be great.. This should be typeof inst.tag !== 'number'. To feature test whether this is fiber or not.. This was always a bad pattern before because it assumed something about the \"owner\" pattern being a complete way to track this. It is also unnecessarily a deep dependency into an isomorphic library that can't be deduped. I believe that it is also not completely safe because ReactCurrentOwner.current doesn't get immediately reset to null like it does in Stack.\nIt would be better to track a DEV only specific flag that is designed for exactly this use case.. onBeginProcessingChildContext/onEndProcessingChildContext is over/early abstracted. Just set the flag to true and false like we do with ReactCurrentOwner. Seems like you can unify this with the render warning flag though.. This extra tag check here is an indication that you're over using the ReactCurrentOwner concept. Should be fixed if you just do a render specific dev only flag for this specific use case.. Seems like this whole thing should be wrapper in __DEV__.. The content of this needs to be wrapped in __DEV__ so that it can be filtered out. It won't be DCE since it's exported as a public API.. Maybe default could be new Error().stack if you don't provide one? EDIT: I guess in Chrome you get that anyway.. Can we move this into the try/catch and only do the if (ref !== null) for the __DEV__ case?. How is this different than ReactDebugCurrentFiber?. I think the test is wrong. It doesn't make sense to both warn for childContextTypes being defined and also warn for that you should provide a getChildContext which you cannot do. It's not actionable.\nIMO we should either fix this in Stack and remove it or gate the test on ReactDOMFeatureFlags.useFiber and change the assertion for the Fiber case.. Yea. Let's add it in the constructor in DEV.. But expandos on the class isn't really better neither.. I guess this could be relevant to top level ReactDOM.render too?. I guess you have a separate one for that. Makes sense.. Can we avoid exposing this since we're not using it? Waste of bytes.. Maybe we should pass the type also? Sometimes that's useful. Maybe we need that for shouldSetTextContent too.\nareChildrenOffscreen is also present tense but this is really referring to if something should become offscreen.. shouldChildrenBeOffscreen doesn't say anything about priorities and just refers to the offscreenness which could imply invisibility or many other things.\nIt's also unclear to me what will happen to the Offscreen priority level when we have expiration times. Maybe it's just a very long expiration but not actually anything magically later than anything else. Avoids the problem of starving the offscreen content and running out of memory adding things to the queue.\nI like shouldDeprioritizeChildren since it refers to priorities. Maybe shouldDeprioritizeSubtree because it is not just direct children but also grand children?. @gaearon  I wonder if we should have a test that mocks__REACT_DEVTOOLS_GLOBAL_HOOK__ and then runs a copy of https://github.com/facebook/react-devtools/blob/master/backend/attachRenderer.js#L24 against it?\nThe purpose of this test is to ensure that we don't accidentally remove these hooks because they look unused.. Why are we casting this to a string anyway?\nIt would be better to let the warning printer cast it to a string, so that it can choose how to visualize it. E.g. imagine console.error('warning', obj) in devtools prints this nicer with an option to expand etc.. Same here.. And here.. Seems like this isn't even used when this is a plain Object.. Shouldn't need to cast to string neither.. It's weird that we do this here but nowhere else.\nIf this is Object.create(null) this will throw so probably can't do this. Could do Object.prototype.toString.call(newChild).. This is interesting. Opts to switch to double quote instead of using escapes.. I can see how the over-parenthesization is providing value here. Indicates that I know what I'm doing.. This seems to indicate to me that labels are available anywhere on their own but they're not actually valid in front of anything - although almost.. This helps a lot. Nice.. We don't do this anywhere else in the codebase though. I'll need to take a minute to process this before I come to terms with it. :P . This is a bit unfortunate since often grep for require('x') and I never would thought to include the trailing comma. I suppose this changes with ES modules anyway.. This might break www internally actually. :/ (Not this file since it is RN only but this pattern.). The nice thing is that prettier always seem to put from and the module name of an ES import on the same line so at least you can grep from 'x' easily.. I don't know how I feel about this one. It seems odd to read it when so many functions will never have any more arguments. Especially for all the ones that only accept one argument. If I expected it to grow I'd use a \"config\" object instead.\nThis formatting seems odd:\n```js\nfunction foo(\n  {\n    x,\n    y,\n  },\n) {}\nfoo({\n  x,\n  y,\n});\n```. Not quite sure I understand the rules of this one. Lots going on in this reformatting, but it's fine.\nAll the trailing commas are a bit confusing/noisy though.. Ah. String formatting. :). This feels odd. I wonder if there's a pattern to this.. Same thing as previous comment here.. I'll squash and rerun from original source.. Yea. This is correct. When we switch to lerna or yarn workspaces, this will be generated by tooling but since we don't have the tooling in place yet, I just checked in forwarding modules.. Forwarding modules is so much better than config aliases because it covers all tooling at once. E.g. webpack aliases are the worst because you have to replicate it in node, jest, flow, and anything else that need the module graph.. It should not.. This part is the piece I'm skeptical about.\nWe only needed this export because the debug ids are shared. We didn't need to export this in prod before Fiber.\nStacks through getStackAddendumByWorkInProgressFiber doesn't use the debug ids. I.e. it doesn't rely on global mutable state and therefore can be completely decoupled.\nWe only need prod stacks in Fiber through getStackAddendumByWorkInProgressFiber if I understand it correctly.\nTherefore, why don't we just put getStackAddendumByWorkInProgressFiber in the renderer so we don't need this connection between the packages in prod?. It seems to me that if you just split up the ReactComponentTreeHook module into smaller pieces in the shared folder that both ReactComponentTreeHook and the Fiber prod stack thing can depend on the rest will fall naturally from there. ReactComponentTreeHook gets disabled in prod and so the dependencies fall off. Only the small dependencies that you split out (getStackAddendumByWorkInProgressFiber) and its dependencies get embedded in the renderer production package.. Everywhere you call this, you already have the instance in scope (probably a register) and know whether it is an update or a mount. I'd recommend just inlining this stuff. It will be less abstractions to read when you follow the code and easier to optimize because all these field reads and checks disappear.. We should not be exposing the Fiber data structure to renderers. I have some refactoring ideas where this will break. Instead, pass the individual pieces as arguments.. We should never mutate the Fiber here. We should instead return the mock and let the algorithm initialize it in the appropriate place.. This indicates to me that we're not overriding it soon enough. Maybe we need to do the override earlier?\nThis also doesn't allow you to mock it to a string to render a host node for example.. Can we make this faster? This is super inefficient atm. We have plenty of examples in the codebase of linked list tree traversal without the intermediate arrays.\nBut why are only host components flattened and not other types?. Sorry, I'm not caught up on the entire history here.\nWhy is this special case needed? extractEvents should not have side-effects in it.\nCan this be handled by the normal controlledness flow in updateWrapper?. Would it be enough to flag this with enqueueStateRestore so that the normal updateWrapper kicks in at the end of the blur event?. It was only used for warnings. We intentionally want to minimize state and memory usage associated with controlled components. The goal is to get rid of the entire wrapper object. Making this a prod dependency makes that harder.. IMO we should just not set the value attribute. People writing manual DOM operations don't do that and it works fine for them, so not sure why we do.\nWould just avoiding setting the attribute all together fix the problem?. We already set defaultValue which helps form.reset(), right?\nI agree that form reset could enqueue updateWrapper. It's kind of a weird use case with any controlled component though.\n. Honestly, I'd rather just disable form reset support in React (either hard failure or just a warning) until we have a simpler fix specific to resets. What do you think about that?. There are other attributes that matter. Such as all of those that don't have corresponding properties (generally things outside the HTML spec). There are edge cases that need removing attributes (like progress). However, for value (or checked) I don't believe there were any cases that needed it outside of intuition. E.g. the attribute shows up in DOM dev tools in Chrome etc.\nHowever, there is nothing that relies on it being there because all those thousands of websites that do manual DOM management. Nobody manually calls setAttribute in those cases. However, as we've seen, there are cases where setting it all the time is unusual such as in this case. So it leads to undiscovered browser deviations.\nThat's why I think our design should be to model what a user would write manually - even if that seems unintuitive of how people think React works.. Shouldn't this require ReactGlobalSharedState?. The opposite is now true. :)\nMaybe we can keep a comment that this should still be hidden behind the createFiber function so that we can change it in reverse if we need to?. It's a bit unfortunate that we can't use the Fiber name because it conflicts with the type. However we could if we switched this to use the class syntax. We just have to ensure that our class syntax transform doesn't add the extra checks that babel does by default.. @flarnie The return pointer is not just a parent pointer because there can be more than one parent. It's also the pointer to the fiber to work on next so that we don't have to also keep a separate stack. Therefore we need to update it when we traverse down the tree.\nWe don't need to do that with the contextTag. So I'd be careful about coupling these into a single concept. We might want to decouple the return pointer to just use a stack instead and maybe even drop the parent pointer. That's why we try to err on the side of less abstraction because it can be subtle.. It probably makes sense to pass more arguments to the createFiber call though so that we can initialize everything as the correct value from the start.. How do you expect to use the flag? I assumed that it would be used as a kill switch if we forgot to gate unstable_asyncRender somewhere, but if we invoked the kill switch, then that callsite (and others would just throw because we don't have the API.\nSeems like this should just be a sync render by default, no?. We motivated it by thinking it would be temporary :D . Instead of introducing a boolean flag that changes behavior, can you just override the priority level on the outside? Seems like a lot of cases need to care about forceAsync and it leaks. When you really could just do if (forceAsync && priorityLevel < LowPriority) { priorityLevel = LowPriority; } right here.. Or maybe priorityLevel < LowPriority I guess is more accurate if you want to allow HighPriority updates to override?. I see. So you don't want to down-prioritize life-cycles. That's interesting.. If newProps === null && current === null this would avoid creating a new instance. This is a good optimization in the resume scenario. However if appendInitialChild has already been called, it would be called again when the resumed node completes.\nI'm not sure if it is actually possible to get into that scenario now. I'm try to produce a test case.. Should we still keep this but put it behind some other NODE_ENV? E.g. for npm publish builds.. @acdlite This any cast is surfacing a flaw. This tests for unstable_asyncUpdates on strings. Which theoretically could exist (although very unlikely). More likely is that it will mess with some plausible optimization and type safety.\nThis should at the very least move into each block below.\nAlthough it would be even better if it moved all the way into the updateClassComponent so that it is only available on true classes.\nWe have an unfortunate polymorphic check to enter classes but once we're in the class path everything is slow and polymorphic anyway. I'd prefer to keep all these weird flags in that path so that we can leave functional components and new types of components in the fast path.. I realize that you'll have to mutate the flag to make that happen. That's fine because the children of this fiber won't be created until after that.. That's a non-goal. We might start warning about server-rendering controlled components.\nWe could potentially always fire a change event after reviving with the new value.\nHowever, maybe it's better to model it as uncontrolled first and then switch to controlled as you're reviving with the knowledge that you'll have to pick up the current value and do something useful with it.\nThe first solution is certainly more convenient, but is that a good user experience? It seems to me that most use cases for this would suffer in some way unless you designed both experiences.. Although I guess doing both wouldn't hurt.. This comment is in the wrong place. Do you mean componentWillReceiveProps? If so, shouldn't this be gated on the existence of a componentWillReceiveProps?. If I do componentWillMount() { this.state = {}; } What should it do?. Let's put this into another file so that we can get the roll out. ReactDOMStreamServer?. Let's take this chance to duplicate the entry above to a new flat bundle entry for the new ReactDOMStreamServer module.. I was thinking that it would be good if console.stack indicated the root stack frame.\nThat way the host is welcome to add more stack frames on top of it. Essentially the same as storing new Error().stack and stripping off the location of the next new Error() before appending the custom stack.\nThis is useful for things like custom Promise, Algebraic Effects or call/cc implementations. E.g. Where you can to begin doing the \"thenable\" work you would call console.stack with the stack that caused the Promise to be created.\nThis makes sense if the console.stack frame is collocated with console.warning but that might be too limited.\nSo perhaps the semantics should be that any common stack frame is considered the root until the console.endStack frame? That seems doable.\nEffectively that would mean in our case that the host environment can visualize the warning() and console.warn() call frames on top of the custom one.. Let's call this just name. It could be a class constructor, method, native method, a \"message\" or whatever else you might call this thing.. This is not guaranteed to yield the current props. This could've been the previous or next props if the fiber we're getting is not the current one.. This yields a stack of Fibers, right? What do you do with them on the other side? Can we expose something less leaky, like an object such as the one returned by this function.. getFiberCurrentPropsFromNode is also not guaranteed to have the current props, because it should only be used for event listeners (atm) and therefore only updated if event listeners change.. These tests fail because currently I'm going through the setInitialProperties path which tries to set all the properties. This doesn't affect text inputs because there we use setAttribute('value', ...) but ideally we should always set properties so that this gets properly reset to what we think it is. But we should be explicit about we think the value should be. Either the current value or the defaultValue. I'd like to follow up on that in the next separate PR.. I'm not sure. :) The way we solved it in the devtools is that we track everything that could've been updated but it seems like overkill to do here.\nWe could use ReactFiberTreeReflection.findCurrentFiberUsingSlowPath. That one will guarantee to yield the current Fiber and therefore the correct props for this particular Fiber but won't yield the correct props for every Fiber on the way up to the root owner.\nWe could call it repeatedly for every Fiber on the way to the root. Maybe that's not too bad for this use case?. Oops. These changes are actually pretty bad. We're building all of isomorphic into these packages now.. Once my other PR gets approved by reviewers I can start removing some of the differences (like comment tags). :) . This doesn't block the event if something down below the tree is already mounted since we're not doing this at every level of handleTopLevelImpl's ancestor algorithm. There are mostly theoretical cases where this could matter:\n1) A non-Fiber tree is nested and shares the event system. Not going to happen with our current set up and we'll probably delete Stack by then.\n2) A React subtree node gets manually inserted inside of a not-yet mounted tree. This probably doesn't happen other than for SSR hydration since you can't get access to the newly created nodes. Maybe a custom element.\nAnother case that can happen is that we block something further up the tree that shouldn't be. I think that can actually happen with hydration:\njs\n// sync\nReactDOM.render(<div onClick={handleClick}><div ref={n => leaf = n} dangerouslySetInnerHTML={ssr} /></div>, container);\n// async, hydration\nReactDOM.render(<Foo />, leaf);\nIt'll block all events to the parent while the sub-tree is hydrating.. We shouldn't even expose stateNode of HostComponent. That data structure will need to change and likely turn into something native. In fact, it may just be a number.. I think the value added by this UI is that you can inspect a quick breadcrumb - on the device. Otherwise you can just use the full DevTools.\nThere's nothing inherently ReactNative specific about this type of UI. Mobile web could use the same. We should build the same thing for web if it is useful to have a UI that just quickly shows the breadcrumb.\nAs a start, can we move this to \"shared\" and call it something more generic like ReactFiberBreadCrumbInspector.. This is not guaranteed to have the current props. It's misnamed. It's only guaranteed to have the current event handlers. ReactFiberTreeReflection.findCurrentHostFiber(fiber).memoizedProps is better for inspection.. @tomocchino Just change this to if (process.env.NODE_ENV === 'publish') {. There's no spec for this. Only convention. I just made up this one. We don't actually have to start using it yet because our publishing strategy/tooling is in flux.. createFiber is not exposed at all. Makes it easier to add or change the default inputs here.\nstateNode is not passed when other HostComponent Fibers are created so I figured we'd be consistent there.. This case should match on ClassComponent only. It won't type check if we use proper disjoint unions on Fibers.\nThat type error would be correct since this can be other types such as fragments, coroutines etc. Those should do something reasonable like throw, drill down (like findDOMNode does) or return null.. It'll have to be a massive rebase. We could try it again though. There are some new features in Flow that can make that palatable now.. This is the check I was worried about. I wonder if we should have a different set of helpers that only apply when parentInstance is Container, i.e. the parent host fiber is a HostRoot so that this check only needs to apply on the very top level.\nThis check probably isn't that slow but it is for every insertion and we want that to be super fast if we for example go through this path for optimized paths that creates DOM nodes from server rendered markup.. Hm. Maybe it's not so bad since markup generators would likely use the appendInitialChild path instead and not this one.\nStill, seems cleaner if the Container had its own helpers so that hosts don't need to have to build pattern matching into their data structures when we already have the HostRoot tag for that.. \ud83c\udf89. innerHTML would be difficult to compare to the string since it will contain escape characters etc. instead of the raw original text encoding representation.\nThis is interesting though. Since the goal here isn't to preserve the correct document structure and attributes etc, but actually only to preserve text content in terms of how they might line up to critical event handlers this still satisfies that requirement. Even if the text content doesn't fully line up.\nI'll add a comment.. There is already other tests in other places in the test suite that covers this so I think it's mostly fine. What we don't have is a test that ensures that the text node is preserved (which I missed in the original PR). However, I think that's more of an optimization than correctness.. That will go through another pass in Fiber that deals with HostText. This particular pass is only an \"optimization\" that avoids extra Fibers etc.\nhydrateTextInstance will return true if it diffs in those cases. That will schedule a commitTextUpdate to patch it up. (I'm going to move this into a helper in ReactDOMFiberComponent in a follow up diff that deals with warnings.). I'd prefer to specifically check the rootElement.nodeType === 1 here instead of relying on duck typing the method which may exist but do something else and even accept other arguments. EDIT: Hehe. I didn't read @spicyj's comment before.. I didn't want to be too prescriptive but if it is a completely good tree that's probably pretty inherent to the whole model. So, yes, that would be great.. It turns out I can't put junk text in there because <div dangerouslySetInnerHTML={...} /> won't actually hit the patch up path so it fails on bad markup. However, I think we're fine not patching up the tree in that case since comparing would be difficult and expensive.. Ah. I see in this case you're actually adding both.\nThat means that if we're doing a simple two pass reconciliation where the second one is able to reuse the work from the first render, there will be no highlighting even though the component did in fact render?. This could just be null I guess. But doesn't matter since after Stack is deleted we can probably just inline this?. Yea I've used xit for other things such as the node.normalize() case. There's a number of these. I hope we can get a way to detect if xit passes in the future.\nPlease name this something better tho.. We have to download two of these questionable deps? Great.. This is too vague. scheduleDeferredCallback?\nWe could call it requestIdleCallback but I suspect we don't actually want to be forced to pass the concept of a deadline to this but rather ask it \"shouldIContinue()? To allow for environments that are not timer based but input based.. typo. What's the intention here with all the possible states (9) these can be in? I have trouble following the extra flags. The flags are indicative of a code smell. Can you refactor this in terms of control flow?. Did this return get lost? The TODO above seems wrong to me.. Isn't this still a valuable test but forHighPriorityinstead ofAnimationPriority?. Why delete this from the assertion? It has nothing to do with theReactNoop.yield` stuff so you've lost a part of the test, no?. Remember that this is a public API for renderers to use. It should first and foremost describe what kind of function they're supposed to provide here.\nAsync isn't quite enough since that could be a micro-task tick (like the Promise queue).. We realized that this is necessary but missing a unit test.. This would schedule an unnecessary deferred callback if you call setState in componentDidMount inside a sync render.\nWould be nice to have a test for that like Dan's ReactIncrementalPerf-test.js.snap that spawned these other changes.. Why is this set if isPerformingWork and then the consequence is ignored if isPerformingWork?. Why is this branch needed? Why aren't we just scheduling with TaskPriority if it is supposed to be Task priority?. New allocation per update? \ud83d\ude32. Seems like this could be rewritten without a closure and non-recursive by utilizing parentNode. Like the Fiber traversals.. You could have two index variables. On for anchor and one for focus. You only increment the index if you're currently traversing anchor or focus parent.\nWe could leave the recursion but can we at least avoid the closure by passing anchorNode/focusNode/anchorOffset/focusOffset as arguments? There are two return values but we're already allocating for that so just return the object from the recursive function.\nAlso, isn't text in selection something we should know the optimal solution for? :). Is there any where we can read someone arguing against depending on the readable-stream package? This would make it easier to evaluate the counter-arguments for someone not too involved in the details. Seems non-obvious to me.. E.g. how does it integrate with other code that assumes the native Node stream?. We currently apparently removing the text node from the textarea even though we really just manage the value property. Need to fix that by not trying to hydrate textarea content. Might be related to dangerouslySetInnerHTML.. These might need to be updated. This is issuing a warning because the rendered content of an error boundary is not the same content as the server rendered content.. This file should live in the DOM folder. The only reason the other one wasn't is that we expect that most of the logic can be extracted as separate renderer and then move some parts out to DOM.. Let's call this just \"ReactPartialRenderer\" for reasons mentioned above.. Let's call this ReactMarkupReadableStream. It's not just HTML.. I guess all of these should test these particular values can issue warnings, but in reality they all just test that the tag name didn't match. Which is why this fixes all of them.. Could we just do error.message = errorMessage instead of cloning?. This is not fully equivalent because debug tooling and such can read the internal slot of this instead of the property name.. Like mention above, this constructor may have different signatures than accepting a message for some error types.. It might be an error from a different realm but in RN that's unusual or not available at all so this is probably fine. Besides this isn't critical if it gives a false negative.. If this is a frozen object (or non-writable) this will throw. Leaving the error unhandled.\nWe could use Object.defineProperty(errorToHandle, 'message', { value:${summary}\\n\\nThis error is located at:${componentStack}}) but even that might throw for a non-configurable property.\nMaybe we should just wrap this in try/catch?. Even if hoisted, this assignment would get stripped, so it'd still get DCE.\nWe have had a few warnOnce solutions but the context of \"once\" varies a lot so hasn't been worth the abstraction cost. A few:\n\nOnce per React module instance.\nOnce per component class.\nOnce per component instance.\nOnce per subtree.\n\nThese can then combine with:\n\nOnce per each type of warning.\nOnce for any of multiple types of warnings.\nEtc.\n\nIn this case, we should ideally gather all of these warnings up into one actionable \"diff view\" of all the differences. That's on my todo. To avoid spam, right now I just want to show the first diff among any type of diff.. We have a lint rule against fall through.. Using the variable to avoid reading it twice yields slightly larger code in prod. :)\nFixed the nit. Forgot prettier.. Oh wait. I figured out another way to write it.. Better test description plz.. @spicyj Should we check for a previous sibling that is a container too? To support this warning properly for comment mount points.. This doesn't work when these nodes are rendered into another iframe. It's not a super common use case but a bigger discussion if we should stop supporting that.. This branch is now always dead. Might be better to just comment it out so we know what it is supposed to do.. I'm having a hard time convincing myself this isn't needed anymore.. So this is re-reading the updateQueue, is that the purpose? Why this change?. Can we re-enable this?. This one is similar. We might be able to just change the test a bit?. This isn't a perf hot path at all. It only exist in development mode and only fires if something already went wrong.. This is never reset. That makes me suspicious.. So, we can still infinite loop with async updates?. This adds an additional check. Let's revert back to the control flow style.. Let's add a test that this fixes. Context provider -> Error boundary -> Context reader -> Context provider -> Error throwing component.. I had to add this. It was causing the build to fail because I now depend on shared code (describeComponentFrame) instead of shared global state.. This stack doesn't have the top frame (the next element rather than the component stack we're currently in), which the real warnings do, which is why the tests below can't be tested this way.. These tests should probably be rewritten in terms of public API.. I realized that this is not handling reentrancy. This means that we can lose stack information once we call another React. Such as in this unit test.. I need this null check because this reset isn't reentrant so it might be reset. See follow up in https://github.com/facebook/react/issues/10188. These can move out of the try/catch.. If expected is null, and the attribute is the string \"null\" then this should not match.. See the use of shouldIgnoreValue before the equivalent use case below.. I'm not sure. I think it's probably jest.mock, maybe?. I do that, then this is no longer a complete project file on its own though, right?. This is just copied from setupMocks. I don't know exactly why. It seems to me that what it solves is silencing console.error in some case.. How does this work? We'll try to run tests in prod mode too even in jest so JSDOM needs to handle it. Also, we don't run jest in browsers so how does this get run in a browser?. This is in renderer agnostic code but the warning is only in the DOM. This would mutate any portal that's not a DOM node which is not great. EDIT: This can be fixed by moving it out here: https://github.com/facebook/react/blob/357925a84e34d17b96568e67d30baeb2a399da11/src/renderers/dom/fiber/ReactDOMFiberEntry.js#L718. As suggested by @spicyj we could expose another method here that doesn't drill through portals. The problem with that is dead code elimination. It's a bit awkward that we expose a new method on the public Reconciler API that is only ever needed for a specific DEV warning.\n. No because the portal is between the container and the hostInstance.\nHostRoot -> ... -> HostPortal -> ... -> HostComponent\nYou'd have to traverse the Fibers to figure that out.. This is in shared renderer code but this expando is DOM specific. We shouldn't assume that all renderers are able to handle expandos. It should also be DEV only since it has perf considerations.. In a situation like this: render([<Portal />,<div />], container) we'd find the portal node and then ignore checking the second one. So no warning if we mutated container. If we did @spicyj's suggestion, we could find all the direct children or at least the first one.. Can we reuse the dummy function from above? Not sure if that is worth from an optimization perspective or not.. Might be worth adding a variable here. var ReactAsyncComponentPrototype = here so that you can use that instead of rereading the prototype below. Save a few bytes.. Should we do = {} just like isReactComponent does?. Interesting. It might not be noticeable for PureComponent because nobody relies on shouldComponentUpdate for behavior.\nHowever, worst case, I guess this just triggers sync mode.. Should we kill syncUpdates and replace the calls with this flushSync?. What's this about?. I don't think so. Another problem is that this means that React cannot work in frozen Realms.. If the onerror event doesn't happen (e.g. because browser flakiness, or monkey patched DOM) then error will be undefined and that will be the error that we catch.\nI think that's a fine value for that case but maybe we should explicitly set that here so that we know that it's intentional and that it can have that value.\nE.g.\njs\nlet error = undefined;. This won't warn for hasOwnProperty and toString etc. Could happen if you loop over objects to create components.. Ah, that's clever! Let's do that.. Next step is to update this to remove this branch, yes?. If we remove the event listener, the first thing we do in the callback, instead of waiting for it to complete, then we don't need to track the depth. Avoids this problem. I'll send a PR.. We should also move the var didWarnValueDefaultValue = ... declaration behind the DEV block.. It needs to be in this DEV block so that it is reused among the closures.. There is also a sCU on functional components but since that's a new thing I guess we could ignore that.. That means that we have to push/pop every functional component though, right? That seems like we're severely punishing perf of functional components for this edge case.. The difference is whether functional components can terminate rendering. They can't with this PR if the context provider rerendered above them. Basically sCU on a functional component becomes useless in many cases.. Actually I'm not sure what happens... They don't get priority and pending props, so maybe things don't rerender?. If we remove this then we break existing usage of ReactDOM.render and have no way of showing the warning, no?. I'm not sure those cross-browser quirks are still in modern browsers. I didn't find any issues (that aren't also issues for SSR).\nI'm not sure how restrictive we want to be?. I think this changes the behavior if you try to ReactDOM.render into a non-container. But maybe that's fine?. A child of the container. The React root is the first child of the container. It also has children. You're not supported to render into those.. IMO we should revert this warning since it's valid to have an empty container if your server rendered \"\", null, false or [] at the root. You'll get a warning about hydration being a non-match later anyway, if it's not. We can potentially special case the bulk error message in #10085 if the only diff was that the container was empty.. In some test I've instead tested that parent.textContent === '' since that's what really matters. That there's no significant text content. More resilient to algorithm changes.\nYou could do:\njs\nexpect((await render(<div>{''}</div>)).textContent).toBe('');\n. This is now unused. rm to fix lint.. I think we should mention something about CORS headers and how to set them up on a script tag. CORS will always be required for modules so people might as well start getting familiar with configuring it for cross-origin. https://github.com/whatwg/html/issues/2440#issuecomment-318791840\nThe issue isn't that it is cross-origin but that it is cross-origin + CORS not being set up. CDNs should support it and users that rely on CDNs should configure their script tags accordingly. Or CRA and Webpack should do it automatically.. setImmediate isn't sync in an async-by-default world. Why no ReactDOM.flushSync instead?. Do you have to change your script tag to set the crossorigin attribute to anonymous for this to be respected by the browser though?\nhtml\n<script src=\"https://example.com/example-framework.js\"\n        crossorigin=\"anonymous\"></script>\nI think that could be the issue.\nEDIT: Or maybe it's enough to set it to anything? E.g.:\nhtml\n<script src=\"https://example.com/example-framework.js\"\n        crossorigin></script>. It might be nicer to do this with a more public browser entry point instead of the internal package details (personally I'd prefer not exposing those as separate files at all and just inline them).\nWith a public entry point it's at least possible to manually require the browser version if you need to. This encourages require to the internal implementation details instead.. Yes that would be nice.. I think it's only if the error is thrown from a script other than the origin of the page...?\nLook how @acdlite used the external expect library here. https://github.com/facebook/react/pull/10353/files#diff-f2b0545941b151d6a1f95ada1639d6f2R147\nTriggering an \"invariant\" inside React, if React is hosted on unpkg, should probably also work similarly.. -f. This is not enough to cause the ensureListeningTo to be called twice because it will bail out on function object equality here. https://github.com/facebook/react/blob/master/src/renderers/dom/fiber/ReactDOMFiberComponent.js#L672\nYou need to change the callback instance. For example by doing onTouchMove={() => spy()}.\n. Intentional because it accepts a DOM node as an argument. Could make one shared around DOM client renderers or SSR compatible that accepts a different argument such as a string query.. Why not now = performance.now and now = Date.now?. It's fine. Maybe we should colocate it with ReactDOMFrameScheduling to have all these in one place?\nIt is also performance.now aware: https://github.com/facebook/react/blob/master/src/renderers/shared/ReactDOMFrameScheduling.js#L73. DEV only plz. We stick random stuff on classes all over.. _reactInternalFiber?. If it's DEV only we at least know that we can remove it at some point. E.g. a minor.. -.only. You can move this typeof nextProp !== 'function' assertion into the warnForInvalidEventListener function. E.g. as the first argument to warning(). Makes it easier to keep in sync and update. E.g. if we want to support other type of listeners like {handleEvent() { }}.. Should we allow these but just warn? What's the rationale for hard-blocking them?. We came to the conclusion that the heuristic is worse than always tostringing. So we can remove this whole thing. It'll always return true.. Pretty much every property we have is enumerable and configurable since that's the default for assignment and object literal construction. So why should this property be different? The reason configurable is useful is that it allows for patching, polyfilling and backward compatibility fixes. The downside is that it might allow for bad patching, polyfilling etc. :). Is there any observable way these wouldn't already be the same?\nOther than the user setting them themselves? (I suppose if they do, then this is a breaking change now.). Same for didUpdate.. What about async mode? I can't even think of them there.. These types are not sound. This will be undefined in PROD. All these accesses should be wrapped in DEV blocks.. Ah, never mind, you explicitly set them below.. rendererType: 'react-dom'?. rendererPackageName? As in the npm name.. The categorization of \"known\" has subgroups. Whitelist is one of them. Things that used to be on the whitelist but that we'd like to remove is another. If we remove them from the known, then that changes the behavior.\nHowever, we can probably still warn for booleans in unknown. warn + stringify.. Seems like passing Element was a mistake that has lead to some inelegant code such as on the server where we don't have one. Don't pass around more than needed to complex functions.\nLet's refactor this to pass what you need instead. Also if you need to check isCustomComponent in a bunch of places, just pass that as a Boolean instead of calling it multiple times. Nicer inverted control flow.. js\n<div />; // false \n<div bool-attr=\"\" />; // true. We shouldn't. It makes a lot of things harder such as server rendering and moving around object creation and hydration.\nIn this pr I don't understand what these functions do in the server renderer.. I don't think custom elements should accept booleans coerced to strings neither.. That's when we add them to the whitelist.\nThere's no consistent pattern for what booleans should do (clear attribute vs \"off\" vs \"false\" vs \"no\"). So we'll always need some whitelist.\nIn theory we could make the default behavior be whatever has the most attributes following that rule. Do we know for sure which that is?. Shouldn't we special case these so that they work? It's odd when the form <x yyy /> doesn't work like the serialized HTML form.. I realize this isn't part of this change but this seems problematic to me. This is a non-trivial case insensitive look up (as opposed to say a super quick interned string comparison).\nWe should make reserved props case sensitive and pass other ones through but warn just like we do for any other \"possible standard name\".. Where is data?\nWe might not need to reserve these. A warning is probably enough.. I can't comment on the unchanged line but onfocusin and onfocusout can be removed since they're now covered by the on prefix rule.. rm. You need to canonicalize as early as possible because some of these (like SVG) are objects that get mutated so the result could've changed.. As much as I like the flushSync(batch) naming convention, this might be a bit too overloaded and vague.\nunstable_createRoot?. Isn't this suppose to be namespace ?: string?. Why do we allow this to not be minimized at all?\nThe other concern was that if shipping works because of this bail out. Then if byte code reversing gets deployed, then it'll skip this and start failing. Without the site doing anything differently.. This doesn't hit the server entry point. I guess you could still have a require on this for findDOMNode.\nIf you run unit tests with react-dom in production, I guess you'd hit this too.. I think V8 (at least the old one) deopts in some cases when it thinks it might be an infinite loop. We have more of these though so we can probably do a pass over all of them and work around it, if that's the case.. -1 might help these be monomorphic in type-driven optimizations.. This was intentional so that you would compare and display it in the case that it was received. For things like SVG where case matters.. I don't think this is right because on SVG we do want things like <svg foobar=\"\" /> vs. <svg fooBar=\"\" /> to show up as an extra attribute.\nIt might make sense to deal with this at the same time as the \"all attributes should be lower-case\" warning though.. @nhunzaker Can we special case the known ones since they will also have the warning about invalid case of the prop?. My concern is that just ignoring case doesn't take the core of the problem in to consideration because it's not the case that browsers completely ignore case. There are specific rules for it.\nSpecifically, the rules (other than bugs/quirks like the IE thing) is that the HTML parser of a server response makes them lower-case except for a whitelist. https://www.w3.org/TR/html5/syntax.html#adjust-svg-attributes\nHowever, this whitelist doesn't apply to client code. Specifically cases like this is what I'm concerned about:\n```js\nvar svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\nsvg.setAttribute('viewbox', '0 0 1 1');\nconsole.log(svg.viewBox);\nvar container = document.createElement('div');\ncontainer.innerHTML = '';\nconsole.log(container.firstChild.viewBox);\n```\nRendering the \"viewbox\" attribute on the server and the client behaves differently because it is case-sensitive on the client but not on the server.\nSo simple saying that they're not case-sensitive is not the full story. It might be the case that this is the best compromise anyway but I want to make sure we've considered all the aspects because \"DOM is case-insensitive\" is an oversimplification so we might be missing something.. This made me realize that we probably don't validate that two components with the same name but different namespaces line up in the hydration. I'm not sure there's a way to get that wrong in another way than innerHTML SVG content in a HTML root.. I love that we finally got a nice warning on these for free.. Although I guess this will just make people try selectedindex instead. \ud83d\ude15. Wasting bytes.. throw 0;? :)\nor\nthrow null;. Stop selling.. Drop the subjective sales talk.. yes. We don't have any view config and no structural info at this point. We could maybe do a shallow clone. We probably need to do a pass anyway since the props will contain function pointers that are not serializable. Not sure what we'll do here yet.. That is updating the internal cache slot that keeps the \"current event listeners\". Really should only need to update when event listeners change but it's cheaper to just update it than checking. During initial mount we just reuse the same method since it does exactly the same.. Me neither. I think it's because 0 is the default or something.. Right. We also do that with any other props since it's better to start work during the render phase if we can do as much work as possible prepared before we commit so that the commit is fast. During the initial mount phase nothing is in the \"tree\" yet so we won't get any events. Just like we can update props on newly created nodes without waiting for the commit phase.\nThe only quirk here is that this set will leak if it doesn't commit, which is a more general problem.. This return value is meant to indicate that it should patch it up. So this says that we will patch up the DOM if it differs, which is not what your comment says.. Given that this bypasses the event system it won't use the topChange mechanism. So not sure if it's confusing if you never new about the previous event system.. Right. This name is basically only here so that they can name the event name the same as the handler, so that we don't need any mapping logic on our side.\nThis is just one possible approach though.. I rationalized this with that require('InitializeJavaScriptCore') sets itself up. The only other injection for RT is the batching injection.\nI think ultimately we'll probably just want to merge this all into a single file and avoid the funny abstractions and indirections.\nEven for RN proper we can probably remove a few layers of indirections.. I'm not sure this trick is always safe cross-browser. Built-ins have all kinds of quirky behavior.\n. Are we sure this one works without a bind? Might be better to error on the safe side and just call it with the context instead of being clever.. This call is very time sensitive since we call it in a hot loop. We should do everything we can to make it inlinable. Calling a bound function might just be the thing that breaks that. I'd prefer code duplication and simple code here.. Since scheduleDeferredCallback is required it seems reasonable that this would be too since they kind of pair together.. How about keeping the NoWork name here? I also wonder if the value should be named something that has something that indicates that it is really a dirty flag and that this essentially means false. Done stood out to me as not indicating that well unless you already know how it works.. This number is way too high. Since VMs (really mostly just V8) tries to optimize for integer types when they can, sometimes they want them to fit into a single 32bit word on 32-bit systems. This number might cause them to deopt that assumption and have to expand the slot.\nIt should be 2^30 or whatever is the highest we can fit in 31-bit.. Why round? (Faster to do (ms / UNIT_SIZE) | 0.). Maybe ... | 0 + 1 would be faster and good enough?. Is this unused? I was kind of expecting that we'd completely remove the concept of PriorityLevel and delete the associated files.. Why is this not needed anymore?. Why is this expected to work if SVG is case sensitive? I see that there is a warning, but how does it actually get set?. We try to avoid while (true) since (at least in older versions) it has been known to deopt.\nI appreciate the rewrite for the temp variable and easy of read. But arguably this just make the condition seem a lot more complicated than it really is.. So is this unnecessary now? Seems like the fix was the second commit, not this, no?. There doesn't seem to be a difference between the wrapper and not in this test:\nhttp://jsbin.com/mofexaxaya/2/edit?js,console\nWhat is different?. Why not just firstChild (since it goes back longer in browser support and seems sufficient)?. Let's make this a warning instead, so that we can strip this out in production.\njs\nif (__DEV__) {\n  warning(workInProgress.type.prototype &&\n +      workInProgress.type.prototype.render, '...');\n}. Why is this 10 and not 3?. Should we just hardcode the value so we don't have to hope compilers do it for us?. If we get rid of coalescing we can get rid of this.. Why can this return null now?. If you expand the if (queue.last === null) { block to include the else condition instead of doing an early return, we can reuse this logic for both branches instead of duplicating.. This needs a better name. I was really confused what this does.\ngetExpirationTimeForUpdatesOn(...)?\nI don't know.... Seems like it's time to fork that file then.. I really don't like that we have this extra special case here. :/ Mostly because I hope we can simplify this whole thing and special cases might hang around.\nWe could instead special case it on the server to minimize code. But I'm not sure that's any better for the maintainability. At least with this it's clear that it is probably the client that needs to  change in the future.. This is coupling too much into the scheduler. It seems nice now that we only have two types of updates but it'll come back to bite us later when we add more types. That's why as much as possible was carefully hoisted out into the class component.\nIn a WASM world this also mixes a bunch of JS-only objects that we couldn't pass into this module so we'd have to do it anyway.\nCan we move this back into UpdateQueue and only keep the scheduleWork part here?. This logic is very top level specific. We should invert this so that it lives in the entry point. Think that we're probably going to have many different things that schedule updates as we iterate on new APIs and in different language runtimes.. I never really liked this name. :/ I keep forgetting what it does.\nWhat does it mean to begin an update queue?. Same thing here. I'd like to keep as the JS object dependent stuff out of the core modules.. If you made the callback list an array, we wouldn't need this field and we'd also save one field on the UpdateQueue.\nWe use a lot of linked lists elsewhere for legit reasons but we probably shouldn't have that leak to everything.. Unrelated for possible follow up: This, and similar code in the insert path, could probably be hoisted out into something that knows about Fibers so that the update queue can be decoupled from the fiber containing it.. What does it mean for an update to have an expiration time of NoWork? That should never happen, right?. So this is not a destroy method now? It's possible to render again after an unmount. With deterministic updates, is the motivation for the new API as strong?. I wonder if this new API really should return a Thenable since that's what people have been asking for with these callback APIs. I noticed because the prerender API doesn't have it.. We need to be stricter with naming of these things. I'm not sure what makes most sense here since Root is otherwise just an internal concept. I think this still make sense to refer to Container here. From the outside perspective there is no root. . Especially since the comment eve says that this might not even be a root.. If this is an new API we don't have to support legacy apis like renderSubtreeIntoContainer.. Why do we need these to be separate? This is inherent complexity to support where as the current API only lets you do both at once.\nI think we should try again to simply defer all commits until explicitly called since we have so many cases where that seems to matter. And the legacy mode is simply a wrapper that does that eagerly. In that case that's the normal mode so the concept of being blocked doesn't make sense and unblocking doesn't as well.. We have the createRoot for persistent updates, HostRoot fiber and createRoot in the ReactDOM renderer. Neither of which are the same and neither is this.. @gaearon This is a breaking change. If you create a portal with a different container in the same slot, with the same key, you'll probably start seeing errors in mutable mode.\nI'm not really sure what's best here.. In this design, persistent containers don't have permanent identity. They get replaced all the time. Practically that means that probably means the container most often has a reference to its own \"atom\" like we do with HostRoot fibers.\nSo I don't actually really know what you would pass in to createPortal in this world. I guess any container would work as long as it has the same internal slot that represents the same atom pointer.\nMaybe this whole thing is a poor design and really you need container to be a permanent identity and a new concept that gets swapped out.. This comment has too much jargon in it. :) . Even async mode resumes happen on a single tree. No \"current\" until after commit.. @gaearon Interestingly this still adds a bit. I wonder what it is.. yea, depending on how you see it. :) It will drill down one way or another.. Either it will either have already drilled down in commitUnmount or it will let it drill further here.. Fixed.. This one is smaller after error codes updates! I'll take it.. For elements we picked 0xeac7 because it kind of looks like React. What does this look like? :)\nThe other ones have used increasing numbers since.\nhttps://github.com/facebook/react/blob/d9c1dbd61772f8f8ab0cdf389e70463d704c480b/packages/react-reconciler/src/isomorphic/ReactCoroutine.js#L23-L24\nhttps://github.com/facebook/react/blob/d9c1dbd61772f8f8ab0cdf389e70463d704c480b/packages/react-reconciler/src/isomorphic/ReactPortal.js#L19\nThe next one would be 0xeacb. We should move this into the __DEV__ block because I don't think it gets DCE otherwise since Symbol.for() could be a stateful function.. This should probably just allow any symbol and numbers so that we can use this space for other built-in fun things. E.g. passing it to host configs.. What if it is <>{new Set()}</>? That is an iterable item. In all other cases arrays and iterables are treated the same. I believe this changes the semantics because you nest it one extra time.\nWho do you need to do this at all? If the children set of a fragment is a single item, it should fall into the branch that optimizes for reconciling a single child. The is same as passing a single child to a Host component.\nSo I don't think you should need to wrapper at all.. Same thing.. Same thing.. Unlike the other branches, this doesn't do the wrapper thing? (It's good that it doesn't but inconsistent. Probably indicates that there is a missing test.). Same thing.. This unifies both behind child.type === element.type. This is neat but it also means that we're sometimes comparing strings to numbers/symbols. That could potentially deopt the type hints in this function. It might actually be better to check the child.tag to ensure that it is a HostComponent or Fragment and compare the type in separate branches.\nIn fact, that might already be a bug incase we ever add strings to fiber.type on other fibers than HostComponent.. Same thing.. If you always compare against .tag instead of .type you can get rid of this assignment. We shouldn't unnecessarily use fields we don't really need and for the fragment tag this field is unnecessary.. Nope.. yea.. Not used.. Can we keep the linked list around since we're still privileged to the internal data structure here? I suspect that we'll want to make most of FiberRoot external anyway.. Let's move this back up to the scheduler part somehow.. Isn't this more like \"currentlyProcessingRoot\"? The \"next\" part is confusing here. Although for most of the life time of nextUnitOfWork it is also confusingly named.. Why is this needed now but wasn't before?. I wonder if isReadyForCommit should be a pointer to finishedWork instead. That way we can have the previous error and we don't have to rely on the alternate model.. You check this twice. Just unify these branches.. We should never mix numbers and pointer types. Seems like we still need the NoWork value?. What happens if you get this wrong? It seems like a big burden to put on the renderer to avoid reentrancy.. Copypasta from https://github.com/facebook/react/blob/master/packages/react/package.json#L20-L22\nI guess we don't include that in other packages..?. You can't recurse on reconcileChildFibers because that will flatten a nested set of single element fragments which is not what we want.\nYou can however fork it and if it's another fragment go for the multi-child case.\nThen you can try to unify them and share code. . ?. Seems fine.. Let's use NoWork and rename to remainingExpirationTime.. Let's call this something other than flush since it might not commit side-effects. E.g. perform.. Hm. I wonder if we can just pass the root specifically to \"flush\" since we know which one we're invoking render/unmount on. What do you think?. Let's do the back pointer instead so we can remove it immediately, or use a cyclic linked list where null means not part of the list.. js\n(current.tag === Fragment ? element.type === REACT_FRAGMENT_TYPE : current.type === element.type)\nThat way you don't need to compare the unused type field on fragments.. Same thing.\njs\n(current.tag === Fragment ? element.type === REACT_FRAGMENT_TYPE : current.type === element.type). Doesn't this mean that return <>{[...]}</> is treated the same as return <>{...}</>. That's not the same as return [[...]] vs return [...]. It flattens an extra level because reconcileChildrenArray avoids the extra fragment but in this case there should always be a fragment.\nWe should probably have a test for this.. I think I gave you bad advice. The function you wanted to fork was updateSlot.. I actually think you don't even need to fork anything. You just need to call updateSlot here instead.. How do we know that this actually does anything at all? I'm not sure this actually tests the behavior we're trying to test. Since this is a no-change test.. If the value is true then this is very unlikely to happen because the problematic pattern is condition && value specifically. I can't think of a way where you'd end up with true for the same reason. Maybe we should have two separate error messages for true and false where this recommendation is only for the false case?\nMaybe also call out that the problematic pattern is condition && value specifically, so that people know what's wrong and what to look for along with your proposed recommendation.\nAlso, the recommendation should be to pass undefined, not null. It doesn't really matter for DOM components, but if it is a custom component that is the difference between defaultProps working and not working. So it's better to have consistent advice.. I was just reloading to comment. :) Thanks!. Now go watch some Netflix. You've earned it!. Hm. What happens if you use the native event dispatching like it was before? Does the test still pass? If so, we should ideally use that mechanism instead since it doesn't rely on by-passing the document event listeners. \nReactTestUtils.SimulateNative is reaching into internals in a way. That's exactly what we'd like to avoid with these changes.. For these purposes, I'd like to treat SimulateNative (and all the ReactTestUtils really as an internal API. The reason for that is that they also reach into internals indirectly. They actually bypass some of the implementation details that would make this example not work with normal React.\nIn normal React this wouldn't work because the container div is not in the document and therefore mouse moves would never be dispatched on top of it. React can't pick it up because it uses event listeners on the document to do it.\nInstead, we should insert the container div into the document, dispatch a native event and then remove the div from the document. Like this:\nhttps://github.com/facebook/react/blob/master/packages/react-dom/src/tests/ReactDOMInput-test.js#L55-L59. We should probably call this something other than \"FrameScheduling\" since the plan is no longer to attempt to line up with Frames per se.. Can you explain conceptually what this is and why we need it? Why isn't this just part of the normal update queue? What is it about this that requires a separate data structure?\nI was expecting these to go on the update queue of the root and just not committed.. I don't see how this follows. There's something off in the model here. Both the deferred flag and this separate list models something much more powerful (arbitrary updates being deferred and placed in separate order) than what can actually happen. Makes it hard to think about and track bugs. @acdlite This is basically a hack around the fact that we can't just call performWork on a per root basis manually.. updateFragment assumes that key equality has already been checked. I suspect that removing this check means that if there was a previous key (e.g. because it was a keyed fragment) it'll try to reuse that Fiber. We should probably have a test for that.\n<div>{<Fragment key=\"foo\"><Stateful /></Fragment>}<span /></div>\n->\n<div>{[<Stateful />]}<span /></div>. This should split based on tag, not typeof. It doesn't really matter if you're going to check the type anyway. Some of the other duplicates of this comment is confusing since in those cases you already do that branching.. I wonder if we should have a warning for ref on a fragment, either in ReactChildFiber or in ReactElementValidator?. This is just an optimization right? Not semantic meaning. I wonder if this is just slowing down the normal case where this is true since the check will happen again then.. I think other ref warnings are in the reconciler. The benefit of that is that we (or others) can create changes to the reconciler (such as adding ref support on fragments) without changing the isomorphic package. Another issue is that people can create elements in other ways (e.g. by inlining) and not get the warning.\nBut as you said, it's nice to get it earlier for stack traces.\nI don't really have a preference.. Could be in some strange environment or if this isn't a real element some how. Probably shouldn't happen but since this is the logic we're currently shipping in 16.x, it's safer to keep it.. This is pretty unfortunate but we have to make these lazy. I also don't want to keep wrapping each individual call to rIC because this wrapper is pretty heavy.. @gaearon I built this the same way as the other injection since they're related. Feel free to split them out when we move to static injection. At the very least it seems like we could move to something like what fbjs/lib/EventListener used to be.. Ugh. Waste of bytes just so someone can try to run ReactDOM in an environment where it doesn't work.\nAlso uses browser detection instead of feature detection.\nAlso uses fbjs.\nSo many things to dislike about this branch but it's existing so whatevs.. We also assume something about options being passed so you won't really need to test for it. Since this will be a required argument.. Will you actually use this flag? You'll know based on time at the point you get called.. So when is pendingProps null?. \ud83d\ude03\nThis comment doesn't really make sense now does it?. For this to be wasm compatible, all of the instance access need to be separated. Including setting up props, state, and testing for existence of a life-cycle.. We should put these type checks first before the switch. Always make sure that the common path is first.. These are pretty generic. Let's call them ContextProvider and ContextConsumer.. Add a type annotation here so that we get this right when this is no longer any.\nWe can force it to be a 32bit int by calling fiber.stateNode | 0. It'll let Flow know what it is but also potentially a browser (although JITs are likely to just check the type info in type collection steps anyway).\nMaybe call it observedBits?\n. Let's call | 0 on the changedBits to force it to be a 32 bit. In DEV, if the new value is not equal, we should warn, because then it wasn't a 32 bit return value.. Why should we ever bail out here? Can't we just let this be handled by the next level? Seems like you'd normally always rerender here if you get here. Can simplify this and avoid the extra working managing and storing previous props.. This is a hot path and we want these to be able to be sprinkled all over the app so they must be cheap. We also expect the one to many ratio to be big. So whatever work we can do in the provider is worth it.\nThis whole things could just be:\njs\nlet newValue = context.currentValue;\nlet changedBits = context.changedBits;\nAll we need is two new fields on the context type and to set them in the provider (and to reset them when we clear).. I think we might actually want this to be one bit less since V8 stores signed 31-bit integers as a special path.. Inline or drop?. One of the tests revealed that we don't unwrap this instance when we call the callback passed to root render.. Yes. Both are intentional. The canonical one is just so that the user only sees a single ref and a single reactTag. The two clones are only an implementation detail like fibers.\nThe currentProps needs to be out of sync here because it is not committed yet so the new event handlers are not current yet. See the other todo for it.. #12073. Yea, this stuff is a pain to decouple.. We should put some work into removing them instead. It is becoming really hard to do these experiments. Most of them are probably broken with this mode anyway.. #12073 will be used to read current event listeners somehow. Probably using a work in ReactNativeComponentTree.. This wrapper object is completely unnecessary for any other purpose than ensuring that we have two pointers and play well with the rest of the architecture.\nI wonder if we should reuse the update queue field or something like that for the \"node\" instead in the persistent mode.\nWe'll figure out a more optimized way to do this later.. We are using a Map in here anyway so why don't we just use a Set for this? (To ensure that it is safe on frozen objects.). Are we sure this matters these days in any significant way? Maybe we can just kill this.. Let's call it the same thing as what we export: react.strict_mode\nuse strict is JavaScript.. This seems like it is not necessary anymore.. We can remove this now.. Maybe explain why?. As always we should revisit when things change. V8 also tracks numeric types in the type system including objects so that it is plausible that we can hit that path.. We should figure out if this deopts V8 since it tracks types and this might change the type of the fiber.. Can you also explain what's going on here? I take it we need to remember this for later but why? Does this have something to do with resuming?. These should have the type C. The return data type needs some new generic type argument.. Lower case unstable?. Should we warn if the second argument is passed? Just in case.\nAlso, should we reserve the space of the return value to be a thennable?. This comment doesn't make sense. There is no other event that will fire, and it is weird that needsStateRestore determines this.\nWe need to flush this before restoring state since we need to know if we should restore it or not.\nWhich also happens to accidentally give us the ability to flush changes before the browser event.. Seems like a good candidate for a Flow exhaustiveness check. . You'll have to make the case for this addition.. Does it matter having this enabled? We will definitely not enable this if we ever do again. :)\n(Which might be this diff instead of the extra field.). I think it makes sense to start dealing with this because it is less confusing than sometimes getting different errors depending on which sibling got furthest.. I don't think this is quite ok for a breaking change. The cross-realm issue and the fact that throwing strings, while not good practice, is still common.\nThenables are a lot more restrictive since they will essentially always unwrap through any async boundary, they're pretty useless for anything other than as promises. So limiting this to thenable would be a lot safer.\nI understand that our general strategy is to attempt to limit componentDidCatch to errors only but not quite sure about the mechanism here.. What is this for?. Why did this move? We should be careful not to add things to things that happen in the hottest paths unless they always need to happen. If they sometimes need to happen, it should only happen in those paths. . Like discussed offline. Let's call the reconciler twice instead of using boolean flag, first with nextChildren = null, then with current.child = null.. You're not using the instance. Let's inline it back in place. It avoids reading the stateNode property here when current is not null.. rm until we need it. Should we just remove all these branches that do nothing?. Slow. This is a suuuuper hot path. Make it a __DEV__ only warning (and therefore the whole $$typeof can be dev only).. Impossible.. Currently you have the invariant above that guarantees that isCache(cache) is always true.. Could add a DEV warning if this is not typeof loadResource === 'function'.. Do we trust Babel to do the default efficiently?. Flow is right.\nThe return value of the hash should be limited to string | number | boolean | undefined | null (i.e. a primitive).\nSo therefore, if K is not a primitive, it is invalid to not pass a hash function. That's not modeled right now.. You could possibly model this as overloaded functions.\njs\ntype primitive = string | number | boolean | void | null;\ndeclare createResource<V>(loadResource: primitive => Promise<V>, hash?: primitive => primitive : V;\ndeclare createResource<V>(loadResource: object => Promise<V>, hash: object => primitive) : V;\ndeclare createResource<V>(loadResource: Function => Promise<V>, hash: Function => primitive) : V;. That's quite a slow path.\nThere are several things like that seem to indicate that the internal cache API should change to be lower level. There's no reason to stick with the first idea now that we have a wrapper around it anyway.. This may limit adoption and someone might publish one that just has the one. The prod/dev build thing is still somewhat controversial.\nThe whole point of this is that we would like this particular implementation to be canonical and gain adoption so a complex build works against that.. Polyfills are not always part of the same build system neither since they can often just be concatenated or loaded from a polyfill CDN service. Even if you're using React you'd hit this.\nI just don't see a reason for it.\nThe scenario you're describing is just a warning about two polyfills existing which you shouldn't do anyway. Even if we warn, there might be another one after that overrides.\nWe can still warn for a non-native global requestIdleCallback implementation in React itself. That's where it matters.. Let's inverse this check to look for thenables instead.. Can we move this out of the hot loop and instead be around workLoop?. renderExpirationTime === Offscreen?. As a general style guide we should invert this logic and remove the dead block because it is not always possible for the compiler to invert these conditionals and strip the extra code. Due to things like !(NaN > NaN) isn't the same as NaN <= NaN. I mean it is always possible to wrap in !() but those three extra bytes can't be reclaimed.. This condition should be first because it is the fastest one. No property access.. Ignoring legacy context you\u2019re going to check this twice. Use a temp variable here.. These extra args are all unused.. Relay accepts the component first and config after. IMO, it reads nicer since the export and component name ends up on the same line. Otherwise you kind of have to scroll down and towards the end to see what component this is referring to.. I'm concerned about the inheritance pattern. I assume that this is for refs? Another issue with HoC might be devtools/tree size but minor.\nRef forwarding has come up a number of times. We should probably just bite the bullet and fix that.\n. Let's make these warnings instead. So bloated to have this at runtime/startup time.. How bad would it be to just hard code a name? So much nicer for VMs/analysis.. The definition of a React class component is prototype.isReactComponent not render.\nhttps://github.com/facebook/react/blob/049fe7d6fd7984c4a7205103d3aafc46bceca1f6/packages/react-reconciler/src/ReactFiber.js#L240. technically the prototype is allowed to be a function. you can extend a function.. if (__DEV__) around it, right?. This is not really a render prop since it's not passed at render time nor a prop. It's more like, just renderFn or render maybe?. The element.type won't line up on line 1125 which means that it'll kill the state of the subtree every time this rerenders.. We've tried pretty hard to avoid recursive algorithms so that we could try to inline these into hot loops instead. Would prefer a while loop.. If we want to fix it, it seems that we should remove this whole bailout branch.. Loops are scary. Are we sure we need this?. Props nullability have had other meanings in the past and doesn't have a defined meaning now but might get one. \nWhat is this meant to test? If it is to test that this is first mount, it should check for current === null, but since this is really just testing whether stateNode is null you might as well just make that explicit (Flow will want you to anyway once we properly type stateNode).. This will mutate both the current and the workInProgress since they'd share the same object. Generally, that's a big nono because many things can go wrong. We'd have to prove that this can't have those issues and won't get them later somehow.. This is what lets us avoid exposing ReactNativeBridgeEventPlugin.. If we at some point switch this to be the only ReactNative export, then we might need to add a noop with a warning here just for legacy purposes.. This is always falsy according to the branch above. So never can pass. This must throw?. I think we wanted to get rid of that at some point. I should probably use a ref though.. They're in separate bundles but I'm going to do a follow up that doesn't use injection and uses instantiation instead.. Seems like we should be injecting into devtools from inside the reconciler. Or at least expose something opaque to inject into devtools.. ah. I see. Also, spread in production. Sad panda. :(. We really should get rid of that. We don't want it in the reconciler so the devtools dep should go away. If it really need it, it can traverse the tree itself, since it is already Fiber aware. (If it even needs it since it has its own shadow tree anyway.). Patched it for now.. Hoisting this out isn't free. Property access can be expensive in JS so it matter when we do it.\nWhat is worse is that it can eat registers so we should avoid local variables if they're not in an immediate local place where they can be inlined.. Good catch on the shim. I'll delete it.. Would be good to document the rationale here. It's because relying on expiration is an indicator that you could've been doing better and you should see that opportunity during dev.\nIn prod, it's better to opt for slightly better UX if you fail.. A global dedupe is probably fine. We don't really expect anyone to hit this.. Does set fall back to empty object which is frozen? And therefore errors.. What is this change? You didn't replicate the other assignment so something is new.. DRY for DRYness sake? Makes it harder to read this inline IMO. It also encourages reading the getDerivedStateFromProps property in multiple places if they're also needed at the callsite. Only abstract if it is chunk of work. (On the flip side, this PR successfully unabstract memoizeProps and memoizeState in places.). There was a reason we had to apply these effects in the complete phase. Why are we able to move them to the begin phase now?. What are theses? They're not described in terms of side-effects. Either this needs to change, or the whole thing renamed.. I really had the term \"Shared\". This has been sneaking into RN too.\nIt doesn't describe anything about the concept other than DRYness which indicates that maybe you should repeat yourself. If it is real concept, name it.. This is clearly not going to be how we describe \"redacted\" so seems like a too early abstraction. Even just assuming that it is a single argument is a big assumption. Just use Fiber until you have something else.. You are forking into a first class concept with typeOfUpdateQueue then you're picking separate code paths again in commitEffect. The only thing gain by doing that instead of specializing each function is that you can reuse the code above here. Just break this out into a reusable function and instead specialize each code path without making typeOfUpdateQueue a first class thing.. This needs to be wrapped in DEV.. This too.. Typically we just use current owner or debug frame or some global state to determine if we\u2019re in a pure callback.\nCan\u2019t we do that with isProcessing too? We should keep state as broad as possible so we don\u2019t have to repeat the storage n time. . It\u2019s also easy to mess up and try to access it in prod or define it in prod.. Looks like our internal feature flag override isn't DEV aware, so it would happen in prod.. This doesn't need to be in /shared/. Let's move it to the reconciler. That it's a type def similar to the others isn't a reason that shared exists.\nIt's a hack. In fact, we should probably move many things out of shared and stop adding to it.\n. This can just be called Thenable. It has nothing about suspense on the type and as far as I can tell, there's nothing conceptually different neither.. Is the updateQueue the right data structure then? Just because it's on the field called updateQueue, doesn't mean we need to use this data structure.. We're trying to make everything post-commit phase. Does everything in here work if moved to post-commit?. These probably needs some comments.. Is this an indicator that this is just global state that are shared by both modules? It could probably move out to a module that can be accessed by both. What is contextual here? Is it just reading some global state that accidentally got put in this module?. Is this every going to be contextual? It seems to me that it will always be read from some global. If so, use a third party module to let everyone have access to this global state instead of passing it through.\nThe thing you're trying to change is not whether this is contextual. It is when it is recalculated. We can recalculate it as a mutable operation that updates the global value. That way we don't have to pass it.. These are checked three times here. Let's consolidate. Use the control flow, padawan.. Same thing here. Can't this just read it from global state? Besides, looks like you're not even using this anyway so this argument can be dropped.. Everything above here needs comments.. Global state?. Inline this fn. It's small and only used once. Found it hard to read.. I think we might want this to use .bind or a \"closure factory\".\nClosures are tricky because they can hold on to all the scopes above them so you want them to be very shallow. When you close over something like this that you know is immutable, but the VM doesn't know is immutable it gets even trickier.. Is this only exists because we built tooling on top of invariant instead of new Error?\nCan we just do return new Error() like normal people instead and then we'll deal with the consequences by fixing our broken infra instead? That's where the real problem is and we need to prevent it from leaking.. This should also use .bind or a closure factory function.. Not needed because you won't use a closure that captures this, and if you do you risk it pulling in a bunch of data from this scope that you didn't expect.. You only have one case. Make it an if instead? That way you can drop the label on the loop.. This is a pretty leaky use of alternate and assumes that the return pointer is always the work in progress. Probably is right now but seems fragile.\nWe also don't rely on anything like this anywhere else. Is there another way we can solve this?. It seems sketchy to rely on pending props here. It used to be null. Maybe it will be again. That should be something we can throw away once we're done. Isn't this more like memoizedProps or even state?. palceholder -> placeholder. Don't let this be captured here. Use a closure factory or bind instead.. Is it really necessary to wait until the commit phase to do this? Seems like we could simplify this a lot by just immediately subscribe to the thenable.. The terms \"add\" and \"work\" is an implementation detail. schedule or inform might be better verbs. \"Priority\" is better than work.\nWe're not scheduling any \"Work\" which in other places refers to some computation.. void return type.. It's a bit confusing that it refers to \"Work\" which is not really work like beginWork but levels. ReactFiberPendingWorkPriority?\nI don't like this file as expected. I don't think this is needed and that we can just infer this but let's come back to that.\nWhat I like the least is that this slows down everything whether you use this feature or if it's even enabled. That's the kind of thing that makes me not want to land it even temporarily.. Why do we reset all these when we're just going to set them right after here anyway?. thenable not used?. Inline?. I feel like the update queue is the wrong data structure here. It's too complex for what it is being used for.\nTo the point where I don't really know what this is doing or if it is really doing anything.. Why not in this frame?\nThis will mess with debugging since it'll be a caught exception so you can't break point on it. Suspense will destroy the use of \"pause on caught exception\".\nAnother technique is to call this recursively with a try/finally and you don't need the catch.. This is not necessary. Just reset the list before you start working.. js\nlet onRender = finishedWork.memoizedProps.onRender;\nonRender(...);\nI think we should use memoizedProps.\nhttps://github.com/bvaughn/react/blob/08a9b10328fdb243c3421f9e100acb8e0310f555/packages/react-reconciler/src/ReactFiberCommitWork.js#L244. It\u2019s two issues. We should use memoizedProps and avoid .call. Use current === null instead. We shouldn\u2019t use alternate in most places. We tend to pass it so that we\u2019re free to switch to a non-alternate based model in the future.. We have this in the host config. Can we reuse that?\nWe should ideally avoid platform specific code in shared code like this. Some renderers will have different implementations.. In wasm this wouldn\u2019t work. Some VMs may want to use a specific representation for numbers based on type info.\nWe shouldn\u2019t mix null and numbers. Null is meant for missing objects, not missing numbers.\nLet\u2019s use 0 or -1 instead of null.. Let\u2019s use a temp variable here so we don\u2019t have to read the property again below.. Does this include both renders in the time spent? Similarly for the double render flag, does it include both?. Does this just check that the stack is empty? Aren\u2019t we already doing that? If we need an extra safety check, shouldn\u2019t this just be a generic check of the stack, not specifically to the profiler?. Let\u2019s do the expiration time bubbling in here too. You can duplicate that code.\nLet\u2019s only do the existing path if we are not on profile mode.\nThat lets us reuse the same iteration instead of two iterations.. If we did finish, can we always just call pause so we don\u2019t need the check? Simplifies things a bit. pauseActualRenderTimerIfRunning is fast anyway.. This is a clever way to model the bailout problem. Nice.. Because performance.now is throttled in browsers and many components are pretty fast, I wouldn't be surprised if this is actually zero or one most of the time. Either way, when we add them up, it'll be misleading. :(\nNot sure how to solve that. Maybe eventually performance.now will be accurate again. At least it'll be better on RN.. Can you move the user timing block above findHighestPriorityRoot so that it is next to this one? Since they do the same thing, it's nice to have them colocated.. Same question as the other spot. Is this check needed or can we just always call pauseActualRenderTimerIfRunning?. We should never create new fiber stacks anywhere except once.\nWe should reuse the one from here:\nhttps://github.com/facebook/react/blob/b548b3cd640dbd515f5d67dafc0216bb7ee0d796/packages/react-reconciler/src/ReactFiberScheduler.js#L161-L164. This seems like very odd types. I'm not sure how Flow lets you do this.\nYou're passing a default argument for null which is not compatible with the type Fiber which you're assigning to the StackCursor.\nThen later you actually pass a number to it. So it's three way inconsistent.\nI think it's not noticed because you never actually use the values stored in this stack.. Should this be wrapped in if (enableProfileModeMetrics)?. If enableProfileModeMetrics is enabled, we should still bailout on equality, right? Seems odd to disable that optimization.. Running the base timer for everything in the tree regardless of if this fiber is part of a profiled tree or not makes this a cost paid by everyone, whether you use the feature or not. This is probably fine for now since it's off by default.\nIf we want to turn it on my default, then we should probably move the startBaseRenderTimer here. That way we can start a work loop that doesn't have a startBaseRenderTimer call in it, unless the first fiber is already in a profiled tree. Then when we hit a Profiler fiber, we can start another work loop that has the startBaseRenderTimer call in it.\nWe can do that later though. No need to do it in this PR.. In this particular case it doesn\u2019t matter I guess because it won\u2019t update the base time since it errored?\nIn the normal case of double render I suppose we have to include it in the render time because otherwise the relative time to actual time will be misleading.\nDEV is already slower than prod so the absolute numbers probably isn\u2019t actionable regardless.. Same thing as the other thing. We should keep this as number only. Use a number like 0 or -1 if you need to indicate missing value.. This baseStartTime === -1 is an error anyway we don\u2019t have to do this check at runtime. If this was all inlined in the same function the compiler could maybe know that but it is broken apart so it might not.\nThat\u2019s a perfect example why I prefer to avoid abstractions like these functions, and moving to other modules, because it makes it harder to see that you\u2019re actually doing the same comparison twice.\nIf they were together in the same function it would be obvious.\nYou could refactor this to pass the fiber instead and do the condition and update in the same function. Like updateBaseTime(workInProgress).. This only increases but never gets reset. That seems odd. At some point we need to reset it right?. _nativeTag is a private implementation detail of the stateNode in this particular renderer. I want to change it in Fabric. I also wanted it to be lazy and this forces it to be eager. You're better off storing the actual ref and then call findNodeHandle on it like before, but on the ref instead of this.. We should pass this when we initial the module instead of an argument, so that it can be statically known which function is called. This will be a lot easier when we move to static injection instead of dynamic.. If you change this to enableProfileModeMetrics && (workInProgress.mode & ProfileMode) you only need one else block.. This whole module needs to be wrapped in a closure and initialized because it is stateful. Otherwise these timers will be shared with other renderers that could be rendering interleaved with this one.\nThat will also let you get a static reference to now instead of passing it as an argument.\nDoing that might however mess up closure compiler and lead everything in here to not be inlined which would be bad for file size, compile perf and possibly runtime perf. Who knows?\nWe need to move to static host configs.. Destructure these at the top like we do with everything else so that we don't have to look up this property dynamically every time. Hopefully this also lets us inline this call. (We should confirm whether it does.). This is wrong. We should always assign them and they should always a consistent type value. E.g. 0.\nMaking them optional is a huge no, no since it might break the hidden class of the fiber.. Sorry didn't see that you wrapped this in a later commit. This needs to also include the base time to be safe.\nYou can pass now to this instead of each function.. Hm. I see. I suppose we do that with DEV only too. Seems odd that Flow doesn't force you to check for their existence everywhere then? We shouldn't need to check if they're undefined/null but seems like Flow would want us to.. Let's always pass it the module and assume that the compiler will strip it all out. We do assume that everywhere else, whether it does or not.. This is providing a new context object for every node in the tree. We should only do this in DEV and even in DEV we should only do this when we are switching between useful context differences (e.g. from non-text to text). In DOM we change the context only when we switch between HTML and SVG, not every node along the way.. A new parent can never be a RCTVirtualText. Because of this:\nhttps://github.com/facebook/react-native/blob/master/Libraries/Text/Text.js#L218-L222\nWhich highlights that this is in fact not just a DEV only contextual thing.. We're only going in one direction. If oldIsInAParentText is true, you can bail out early.. That was in reference to using a linked list entry instead, not if we're going to use a Map algorithm.. The linked list would return the link to user space. Not a number.\nRemoving the link is:\njs\nlink.next.prev = link.prev;\nlink.prev.next = link.next;\nRemoving from a Map is O(n) worst case. The O(1) big O notation is misleading for maps. Accessing a few pointers is always much faster than scanning a tree no matter how clever your search is.\nThe linked list can add more GC work in theory but they'll mostly be young generation.. Why this change? What happens if you move this to a follow up?. What is this? It doesn't seem to be on your follow up list.. Comments plz. What are these for?. Flush means something else in the scheduler context. This is more like update something based on something else flushing. This is not the flush.. So this is the thing you're going to fix in the follow up?. palceholder -> placeholder. I don't get why we need to keep track of these two pending times.\nWhy isn't earliestPendingTime just root.current.expirationTime and latestPendingTime just earliestSuspendedTime - 1? Effectively.. Not used?. _changedBits2? every byte counts.. Are you going to swap this out or keep the instantiation mechanism?. For some reason I'm not a big fan of \"Shared\" as a name. It's like utils. Doesn't say anything. Don't really know where this is going yet so hard to find a better name.. This doesn't look right. We shouldn't set current owner, which is runtime behavior, only in DEV. This could mess up certain new features in prod for example.. We were supposed to use the debug frame thing for DEV warnings instead of owner so that we didn't have to do this. Perhaps the fix is to change how the context warning works so that it doesn't rely on current owner? @acdlite . We just have to be better at following through when we change strategies like introducing debug frame.. How is the first case ever true?. Does anything rely on the type of work number? Just delete and collapse? (If something does rely on it, it should hurt so that a solution is encouraged. Even if it is us.). Why do you need to conditionally stop it? Stopping something already stopped is as cheap as checking the flag, probably cheaper, right?. @gaearon Hope this is ok.. This is not the place for it. This is inside a hot loop and gets called thousands of time. This would be a better place: https://github.com/bvaughn/react/blob/7f027607b516d3cb3d58feeb07074813f6f8bfb4/packages/react-reconciler/src/ReactFiberScheduler.js#L632 That way we also ensure that the render time doesn't overlap with the commit time frame.. It doesn't matter for sync mode but will be important eventually.\nI'm considering using the memoizedProps solution to avoid having to add a commit phase in JS. Currently the commit phase is entire in native.. You\u2019re messing with the hidden classes here so there can still be a cost.\nI\u2019m not sure this is worth it.. Why go from a descript explicit identity to a non-descript, easy to accidentally share object?. Checking for a nonexistent property is one of the most expensive things you can do if it is not cached. Because it has traverse the prototype chain.. I don\u2019t see how the problems you mentioned trying to fix are still problems after this change even without this.\nEven before I\u2019m not sure how that could happen before but since it is now inline here, how would this happen? Somehow try to reuse the instance in the same renderer?. The Devtools are going to use a private api to access this data in a way that we support only because we can push new versions of it so mitigates maintainance burden.\nYou can use the private api to test this behavior since the private api is the \u201cinternally public\u201d api, the one actually used.\nEven if we wanted to expose this in the future I don\u2019t think we are ready to do that yet.. I didn\u2019t realize we limit it to the top most frame. Seems hacky and unfortunate limitation.. These comments are not helpful. Obviously you're clearing the root based on the next line. Say why, not what you're doing.. E.g. \"By clearing the root, we force React to start over by rendering the root from scratch instead of continuing in the middle of the tree. We have to do that because we've added new work to the tree and that might otherwise be inconsistent depending on where we are in the current render.\". It's never not a Fiber, hence the case below, but the caller cannot guarantee it right now.. Ultimately it is because the \"internalInstanceHandle\" is supposed to be an opaque object as far as the host configs are concerned. So it should really be using opaque types instead.\nhttps://github.com/facebook/react/blob/aeda7b745d9c080150704feb20ea576238a1b9a1/packages/react-native-renderer/src/ReactFabricHostConfig.js#L168. It is very likely that we're going to do a breaking change and actually turn these into just functions.. We should avoid exporting everything. Make it explicit what you want this object to contain. Too easy to accidentally bring in too much. For example, I think the resulting object that rollup produces for this is not what you expect. (Let me know if you see this pattern elsewhere so we can fix it.). This function is way too slow to iterate through these every time we rerender even if we're about to just rerender anyway. We'll need a different approach. \nThis should already have been known by the context propagation so we just need some way of storing that.. You do this in finishReadingContext also. Only it do it once per loop iteration. Either before the loop and in finishReadingContext or in prepareToReadContext. If you keep prepareToReadContext, we should inline all callsites. I don't trust tooling to make this fast.. We could do that part only if any of the contexts matched/changed. The point is to optimize for the case when zero context changed.. ContextDependent?. contextDep?. Let's use current === null because we don't want to fire componentWillUnmount unless we fired componentDidMount.. Not all the fiber used this bailout protocol. What makes you sure that it is safe to assume that this hasn't changed for all types of fibers?. This is a very sensitive protocol since version mismatches are not uncommon. So we should think a bit more about what we want this protocol to be before the next release.. lastContextDependency.context should be stored separately in the execution environment so that it doesn't need to be accessed through a property. It can be null by default.\nThis check should be moved to the top so that we can bail as early as possible. You know that it currentlyRenderingFiber.firstContextDependency === null is not null if it matches.. Let's move this after the cached lastContextDependencyContext check so that multiple reads is as fast as possible.\nlastContextDependencyContext should always be reset to null outside React rendering so it'll never match.\n. This should probably do a typeof function check since this is essentially external and hostile.. Note how both these checks let us do nothing at all, including more checks. It's also included in the other checks when we do have to do something so it's not an additional cost.\nSo by hoisting them we don't have to do any of the other checks except in the other branch.. We no longer have this optimization. To add it back, we would have to track an additional field globally. (We need to save on these since it adds cost to each thread in a multi-threaded renderer). We also have to check that additional field when we add it - i.e. add another branch here. For that to be worth it, this pattern have to be somewhat common to justify the optimization. I'd argue that it's not.. Maybe you should submit a PR to that repo.. It would be better to store this number on the Interaction object itself. . How are you going to use this? I suspect it'll be expensive to store. We could just use the expiration time.. Underscore! :) . I see. I was confused because this ID won\u2019t be directly passed to the observer. Maybe it should be called getBaseThreadID or something?. This is super hot. This means that when we reconcile in a long list, we have to do several comparisons and a missing property lookup (which can't be optimized in this function since it's a new hidden class for each one, and traverses the prototype chain all the way up to Object.prototype).\nWe also don't typically ensure that wrappers get unwrapped to reconcile their inner value so I don't think that we need to semantically support the case where you switch from an instance of the component to the promise of that same component.\nI'd say that its worth the complexity elsewhere to allow for fiber.type to be the thennable.. I think there's a subtle issue with this approach. Since this throws when the parent reconciles, there is no way to continue siblings of the component that is lazy even if they're available. By making it throw in the beginWork of the individual component, we avoid that problem.. Even though we don't use the return value, others might want to. So it might be worth returning the result of this.. I think it's probably best practice to wrap this in a block because this variable name is in scope of the whole function. If you need the same name in a different branch.. There are a number of little fixes and refactoring in this commit that isn't directly related to the hiding of children. Such as moving this section and the extra arguments and move of retrySuspendedRoot.\nIt would be nice to have a separate PR for those since they seem like useful clean up regardless.. It's probably worth just forking this function between the two modes.. This is probably unnecessary since it's always hidden already then.. What if the stateNode was null when it is not timed out. We store normalChildren on firstChild. Then when we timeout, we swap the normalChildren and store the normalChildren on the stateNode while it is timed out and the fallbackChildren on firstChild.\nWhenever we retry to see if we're unblocked we try to restore the normalChildren to firstChild first and then render down. If we don't succeed, we restore them to the placeholder again.. DevTools needs to get its act together. This is important to ensure that VMs don't decide to avoid the jump table by thinking there are too many gaps.. unstable_write?. I think that hardcoding this in devtools based on version is probably the way to go. It doesn't require us to include extra strings and object initialization in the production builds.\nI suspect that even the fiber fields might be mangled in the future so it'll need the same parity.\nIf we move to another language in the future, that language likely don't let us define our own indices. It'll be a header file or something that determines this based on compiler settings resulting in a reified contract. To make that work you typically have to compile both sides from the same source with the same settings. E.g. the devtools would have one header file per version.\nThat's the equivalent of the devtools just keeping a copy of this file per version. Maybe we should do that?. It seems like this should throw if it is not resolved. If it's not resolved, we can't reason about whether something will be one thing or another so we don't want to make assumptions that might be persisted.\nWhen we do reason about it, we must throw a promise and terminate regardless. \nIn cases where we know it'll always be resolved, we want the return type to be specific so that we don't have to add unnecessary checks.. We should never deep link in renderers. This must go onto reflection if you want it. However, better yet is probably to duplicate the logic here. \"But then it'll be inconsistent if we change something!\" Yea, but that's only because this whole renderer is already a fork of a bunch of internal logic that will be inconsistent all the time.. Let's put the .then comparison last since it is the least common one.. Calling this, I would expect this to return baseProps if there are no default props.. You already pass the resolved type as an argument. I think it would be better to do the same thing with props.\njs\nconst props = workInProgress.pendingProps;\nreturn updateClassComponent(\n        current,\n        workInProgress,\n        Component,\n        props,\n        renderExpirationTime,\n      );\nThen in the lazy form you do \njs\nconst props = resolveDefaultProps(Component, workInProgress.pendingProps);\nThat way you don't need any special casing for null and separate updateClassComponentLazy helper and such.. Maybe we should check typeof Component === 'object'? Seems like a function with a .then is ambiguous at best.. ok, that's fair.. We shouldn't wrap them in try/catch but maybe it's an indication that something else is problematic in those cases. Which ones are they? The issue now is that I can't be sure if something is expected to need a fallback or not.. It doesn't make sense that other files import this function from ReactFiber. It doesn't have anything to do with the Fiber.\nHowever, the way it is used, is to upgrade the tag. Maybe we could instead export a function like export function reassignTag(fiber: Fiber, Component: Function): TypeOfWork that does the work of figuring out which tag should've been used.\nThen in mountIndeterminateComponent you use the resulting tag to figure out which branch to take.\nThat way, the logic about picking tag is fully encapsulated in ReactFiber.. Why not const? You're not reassigning.. I think that we shouldn't need to check these. Given that this function is called ...FromObjectType, I think we've already assumed that it is indeed an object. If not, should we? At least we can return early at the top of this function instead of checking this twice.. Your commit states that you removed some calls to isContextProvider but you never actually removed it from pushContextProvider.. I'm not a fan of the double checking. I don't understand where this is going. Is push/pop going to assume that whether it is a provider or not has been asserted or not? Might be worth while doing in this.. I still don't like this. I don't understand what assumptions you're doing here. At the very least we should never refer to the result without first referring to the status so that the result has a defined type.\nWhen is this called without this being resolved?. Does this mean that we actually want to keep the concept of IndeterminateComponent even if we deprecate the \"module pattern\" components?. Block plz.. Although I think passing in the Component might be better than checking it on the outside. Every time we check things on classes, or promises, is a deopt since they don't have consistent hidden classes. We should try to minimize the effect of deopts by moving them to a shared function like what we had.. No, you just do it in the switch statement like how you resolve the constructor.. Array.isArray(...) might be better. More specific.. I wonder if we should move out this for the non-lazy form too so that it isn't embedded in there. We can do that in a follow up though.. Why doesn't this get a variable name but Component does? . Can we wrap all reads of _reactResult in a helper. Like ReactFiberLazyComponent.readResolvedType(workInProgress). Normally I wouldn't recommend that but in this case it is a user space object. We might want to add assertions or warnings in the future. It is also a indicator that we can use that this is external to Fiber and will have inconsistent hidden classes. It might just be a a few hidden classes and it's good that those optimizations get to use the same inline cache if possible rather than redoing that work at every callsite.\nIt also allows us to return a more specific type than any.\n. Why is this needed?. That doesn't make sense because memoizedProps on other paths stores the unresolved props. I think it needs to store the unresolved props because if you store the resolved ones, you'll never get reference equality.. Test renderer doesn't need to.. You can turn all of these into early returns now.. It would be good to set the closed over variable (ctor) to null so that it can be GC:ed since it won't be used anymore.. Slight preference for returning the tag and assigning it in the outer function to avoid an unnecessary Get since this will be inlined.. This is claiming the .default property name on Function.prototype etc. I wonder if we should be more specific and check for typeof object on the resolvedValue.. oldVvalue -> oldValue.. This seems to be unused.. I'm not sure we need this Map when the data is already in the update queue but do we need to eagerly initialize this whole thing?. If we pass the GlobalRoot as an argument to setContext we don't have to bind this function and create a new one for each root. We can share one function per renderer. We can get the fiber from arg.current.. Come to think of it, we already do pass it to this. So you won't need to bind this function.. This will provide a hint to the VM that we only want 3 inline fields but they you add an expando later.\nWe should always provide the four fields in initialization. If you want to exclude on when the feature flag is not used you can initialize the object in a conditional.\nIn the three field case you can cast it to any and then back to Interaction.. This should be required.\nI realize it won\u2019t be there in one of the feature flags but we can assume it always is. That way you don\u2019t need all the any casts whenever you access this which might cover up other issues.. You can cast the null to any so that this can be non-nullable. That way the fact that this is dependent on feature flags is hidden in one place instead of spread throughout the code.\nEvery use of any could be a typo/miscast. . Same here. If you throw null in the first one, and this also throws, it\u2019ll override with the second error. Not sure if that\u2019s desireable. We can make this if (!didCatch) { didCatch = true; caughtError = error; }. That way we don\u2019t have to rely on the sketchy falsey check. It will always rethrow the first throw value just like try finally.. If you just use nested try/finally where each next level is in the finally, I don\u2019t think you need to use these temporary variables or any catch blocks. That\u2019d probably be better perf wise too.. Same thing here. You can just use nested try/finally.. Since there is nothing else in here that deals with timestamps, it seems better that this is passed in instead. That way the time mechanism doesn\u2019t have to be built in. Eg we are considering a custom measurer at FB and RN might need something else.\nIn fact for certain tracking I believe that is required. Eg for a click you want the time at the time the user released. Not towards the end of the processing of the click event. The mouseup event could\u2019ve spent time too. For requestAnimationFrame you want the time stamp passed into the callback (beginning of the frame), not the current time.\nAdditionally we don\u2019t even know which scale is appropriate to use. Date.now and performance.now use different time scales and whatever they\u2019re going to be compared to (eg) commit time needs to line up.\nIf we\u2019re going to automatically track time here, then we should also pass time to the complete callbacks so that the external system gets consistent time. But I see no reason for that.\nWe can just have the user of the track api pass the current time in as an argument. That makes this package a bit lighter too.. Why pay the cost of cloning this data? Why not just pass the set and let the consumer decide?. Good VM field hints. Nice.. Hm. Unfortunate to pass another arg just for this. @acdlite does this look right to you? Can we get this from somewhere else?. Use try/finally instead. This is what it is for.. try/finally . Unconditionally allocating an array for every commit seems unfortunate.. All these any casts are too fragile. Let\u2019s make sure that we cast this at the export type in one place.. This is not obvious to me. Wouldn\u2019t there already be an interaction tracked for this expiration time? And these callbacks can\u2019t do arbitrary things. They just schedule work on something that is already scheduled. So seems to me that this shouldn\u2019t need to be wrapped.\n@acdlite . While everything below here makes sense. This is it the right place for it.\nThis gets called for every scheduled work (requestIdleCallback).\nWe only want to call this when we\u2019re restarting work on a root. Not when we\u2019re resuming.\n@acdlite Can probably point to the right place to do this.. try/finally will just rethrow the error by default. You can remove the catch and this line.. Both cases has the danger of us using a field while not in the feature flag branch.\nIn the previous approach, every time you use it  risk typing (interactionsRef: any) instead of ((interactionsRef: any): InteractionsRef) which would cover up additional errors.\nYou also risk typing ((subscriberRef: any): InteractionsRef) which is just the wrong type.\nThe number of times you have to use any increases the risk of any of these types of additional mistakes.\nWhen it is in a single location you only risk making this mistake once, but that's easy to review, and since you're using null as the initial value the risk of typing subscriberRef instead of null seems pretty small.. Hm. You're right. It might be worth it though. Just for smaller code and doesn't require the VM to set up registers and initialize these values. It becomes a noop. We don't expect the handlers to ever throw so optimizing for that seems valuable.. I think @acdlite's misunderstanding is a good opportunity to rename this function to something that makes it clearer. I could see how if I see track and wrap I would think that wrap is just a convenience for wrapTracked since it is highlighting the wrapping mechanism and nothing else.\nIn reality the purpose of wrap isn't to wrap a function. The primary purpose is to continue where you left off.\nwrapContinuation? Too long. This is can be used a lot if you don't have auto-wrapping.\n. I suppose there's precedence for calling it wrap in Zones.. You can actually just return here. The finally will still execute before returning.. Probably need to flush this package.json out a bit.. I kind of agree with @acdlite here.\nWe could have a separate module. interaction-tracker/observer that attaches itself to __subscriberRef directly but provides multi-listener support.\nThat could be the safe API. That way the minimal module remains even tinier by excluding the overhead of exposing these methods and this error message.\nIt's never really safe to listen to a single listener protocol directly regardless. The safe form is the multi-listener form.. Be careful with those early returns. I think you\u2019re skipping the ref changing.. In theory we can have a different element with the same props object.. Shouldn't these be noops if enableInteractionTracking is false?. This shouldn't bother subscribing if enableInteractionTracking is false, right?. Some functions get inlined so those variables don't matter much.\nExtra variables can be much worse than closures or property reads. Because if we tip over the number of variables used then the VM will try to guess which ones to pop out of the register and back to main memory.\nThe key here is that this variable isn't used by the mainline path here. Just the special case path of the profiler.. read is not going to be a public API anyway so we can rename it to something more random. Or even remove it.\npushDefault or writeDefault could work too.. The idea is to only enable this flag in the FB build for now since we're already using placeholders.. Normally we would export const enableSuspenseServerRenderer = true; instead of this line. That way it should be enabled in www client but I don't know how we plan on using this file on the server in www. Perhaps we should configure the server build to just inline the feature flags in the build instead? Since this one is most meant for experiments based on GKs.. Why arrow functions? I figured this would just become an ES file eventually?. I mean ES5 file so that it can be published to npm directly.. Do we need this extra check? Seems like we can just throw.. :'( We compared mode to effect? Should've been !== NoContext.. This should never have been landed. (I must have skipped all the loose mode hacks when reviewing.). So this was bad enough when it was loose mode only but we shouldn't promote this hack to strict mode.. We can now unify these checks so we can get rid of this flag and just use scheduledCallback as the flag.. If we use this field for something other than the UpdateQueue, we must never use this field in any generic branches. I.e. we can't have any code that checks .updateQueue for a bunch of different or all tag types.\nWhat's your motivation though? This doesn't make sense to me. It is a signal that stores a stateful value over time and never is allowed to be reset when fully processed. Sounds like state to me. Either stateNode or memoizedState.. Whatever we read/write from/to most. I\u2019m actually not sure which one that is.. It should always be one the same stack since fiber is a child of hostFiber.. Yea, it is but I'm not confident people understand what that means so clarifying the mechanism might help.. I changed to \"StrictMode children\". I think that's clearer and fits in one line.. Ah. You mean for the instance case. I figured that you'd want to look at refactoring the top component and then work downwards. But I guess we could use the same stack for both.. yea see what you're saying but refactoring this function is a pita and makes it worse.\nOnce we fix RN to not use the special NativeMixin/NativeComponent, we can remove this special case and always warn with the same function.. This is not correct. It is passing the element.ref second argument. It shouldn't get the second argument in the pure case.. I didn't see that one. I'm not sure I approve. Let me think about it.. If you need arguments that are only used in one mode, then that's probably a good time to fork this function between the modes. Or better yet, create a separate function for when needsVisibilityToggle is true and only call that from the persistent mode. That way we don't slow down the loop for the normal case.. Why do we need this check? Did you find something? Document? It probably should be an error if we can\u2019t right?. Do we usually use hasOwnProperty from the object itself? We probably shouldn\u2019t.  . What's the difference between DidCapture effect and alreadyCaptured?. Instead of assigning this, we should just pass null in all places below. So the compiler knows.. suggestion\n        if (!didTimeout && workInProgress.memoizedProps.fallback !== undefined) {. Bonus fix. Better feature test.. This one is interesting because it doesn't memoize its props. Only its children. This is a bug since it won't bail out ever.. So that I can do early returns in the other one. Compiler can restructure and get rid of it in prod.. \ud83d\ude22. Any reason this is here instead of beginWork like the others?. Good catch. Don\u2019t know if any conditions report multiple levels but there is at least one.. I figured it would be unlikely for a custom hook to be called useAbuseState or something like that.\nNot too happy about this heuristic but not sure what\u2019s better.. We probably need a Flow type for this. There's not only one real one. There are at least three (Fiber, old SSR, new SSR).. The type should do that https://github.com/facebook/react/blob/master/packages/react/src/ReactCurrentOwner.js#L25. We don't swallow errors. This is a finally call.. The contextMap stores the shadowed value, not the current one.\nIt's nice to use the same mechanism as Fiber because it allows the inspectHook thing to be called in a context where it context has already been set up with some other mechanism.. I think this is not just used for lazy.. Even if it was this would be the wrong place for it.. I don\u2019t like shared. I prefer copying to putting things in shared. Makes it impossible to special case and encourages abstracting.. Can this happen? E.g. returning a string from render?. I believe these are just like any other shadow node inside text from the native's perspective so I think we could send the display: none property here too.\ncc @shergin . What does spread compile to?. I believe in the DOM version we actually just set the string to empty string \"\" while hidden and then reset it to its current value.\nSeems like we could do the same for RN without needing to fix the native side.. @gaearon I named this ReactFizzRenderer but I don't think it makes sense since we use the term \"renderer\" to refer to the compiled output or the HostConfig. But Reconciler doesn't make sense since that's exactly what it doesn't do. It does everything but reconcile. Ideas?. https://github.com/facebook/react/blob/master/packages/react-dom/index.js#L15-L16\nhttps://github.com/facebook/react/blob/master/packages/react-reconciler/index.js#L25-L26\n. hm. Why doesn't this break ReactDOMFizzServer-test.js in build tests? I'll need to look into that.. To the file name or the method names?. I'd love to fix this though. This is probably really bad for inlining/DCE.. You mean the release? We still want it in the sync so we can try it out at FB.. @gaearon I put this in react-stream/src/ which is a bit weird because it's not part of the core algorithm. It's part of a possible host config. I'm not sure this makes sense to put it here but it's not really shared and we really shouldn't make shared a dumping ground.\nHowever, I guess in the future we could have react-stream export preconfigured environments and all you fill in is the format config. E.g. react-stream/index.node.js, react-stream/index.browser.js.\nSo maybe that makes sense.. I think what we're going to do is use this same strategy on the client but primary renders like React DOM and React Native will use index 0 hard coded so they can skip any allocation and resizing logic. Then secondary renderers can use index 1 and above.. We'll probably just do this on the client too. See my other comment about primary renderers could skip the global coordination.. Interestingly, we do need the defaultValue somewhere, so at least one field will remain.. Maybe? Or is it a fix?. I wonder if this will mess with SMI optimizations. SMI - 1 might no longer be a SMI maybe?\nAlso just doing a bit of extra math is annoying. I think I'll use the primary renderer optimization as an excuse for why we shouldn't. :P . Drop this line.. The overhead of this is no longer necessary in this mechanism since it's a unique channel.. Do we need this fallback? IE9? Do we even support that anyway?. I\u2019m not sure how the proxing works with this. Is it DEV only or both?. @gaearon We accidentally bumped peer deps anyway.. Either if a) there's more than one with the same name, b) I'm scared of overlap from a local variable or something.\nBut I think we should probably rename these on a case-by-case basis to something designed for being used with named imports.. If shadowing is reasonable, why not the whole set? It should probably be a warning that the type sets are ambiguous and only one should be provided. Seems like an error.. Not sure about this.. I don\u2019t think the logic is designed to make assumptions about which side is which. That\u2019s why it\u2019s a and b instead of say current and workInProgress.\nThis seems to think that A has some different property than B. Why is this?. For removed event listeners, it is a bit easier since we have one before hand and in it we can check if we should just ignore it.\nThis case is trickier because we go from not having a listener to later having one. So to implement this we need to have a listener attached before we need it.. Now that I think about it, we probably have a small bug here today since we lazily attach certain event listeners to the root the first time they're used. If a different discrete event happens, then we attach a new discrete event for the first time, then we'd see this bug today. I think the only fix is to add all of them to the document eagerly.. Why is this after setting the pendingProps? What if these effects synchronously renderers an update to this tree?. The rest of these, are they still relevant to be dynamic or can we just turn them on or off?. Why disable these?. I thought we wanted to do this work in the passive effect? Is there a reason not to?. I'm guessing that the only reason we have this dependency because we fork this file at FB. The only reason we do that is because we attach listeners at the window/document level and we need predictable order relative to other events. If we attached them locally at the root, we don't need this fork anymore.. Can we wrap this in if (__DEV__) {? That would make this function a noop which can be trivially eliminated by a bundler. At least with ES modules. So that would let us remove the callsite itself in prod bundles.. Maybe we should tag these nodes with something more unique to the built-in one so that it doesn't happen with custom hooks that happen to share the same name. E.g. You could also check that this is the terminal node. children.length === 0. Maybe just make this into a for-loop. Like Dan, I find it confusing if something is both functional style and imperative. I assume this to be pure if it's using filter.. If you go from having deps to null then this warning will not fire.. Somewhere around here I'm betting the VM will insert a type check anyway. I bet we can get away with just doing a proper null check on the one we're not sure about. That way you don't have to cheat the type system.. This property access should move within the null check branch so we only do it if we need it.. Same thing here. This should be only if nextDeps !== null.. Why are all these tests commented out?. unrelated. plz send a separate PR and tag the whole team.. Structuring it this way gets tricky and will make resuming harder. If any pass performed work, we need it to remain as marked as performed work. This risks clearing it if a second pass bails out.. Why this change of pattern?. Let's loop over the same variable that you're checking for null. That way the same type check can be used for both.. It might be worth doing the i < nextDeps.length && i < prevDeps.length check. I'm not sure but maybe the VM can be smart about avoiding the check to see if it's going to be out of bounds that way.. Why do you need a per-fiber bit? Can't you just use a global flag?. You can restore this comment.. These names don\u2019t really make sense anymore.\nHow about enter/exitDisallowedContextRead?\n. Let's just duplicate this function and inline it to the two callsites. They each have a branch that differs anyway and I suspect you can optimize basicStateReducer by not just binding it as if it was a dispatcher. . Can we move this out to updateReducer and mountReducer and pass it in? That way the rest of updateReducerImpl can only return state. That way the thing returning the tuple is close to edge so we can try to optimize the tuple+destructuring pattern. It also saves some bytes and code that needs to be optimized by avoiding repeated array literals.. Two lines below this we handle the case where we append hooks to the end. This is going to throw later anyway. Might as well do it early.. We can also just throw for the empty queue case since for the case where we append hooks to the end, we'll probably just want to detect that we've hit the end and then switching the dispatcher.. Let's move all of these mountWorkInProgressHook() calls into mountEffectImpl(). That way this is just one function call indirections instead of two.. Same thing as in the mount case. Let's put it in updateEffectImpl() so it's just one function call in here. (Later we can play around with bound functions.). Alternatively, inline mountEffectImpl since it's so small.. One of the motivations for this refactor in the first place was to get rid of additional flags like this that is difficult to keep track of whether they're all assigned together in the same place and how the relate to assignments of the dispatcher. By adding this in again, I've now lost confidence that I understand these pairs again.\nCan we make it just part of the dispatcher again? I.e. make another dispatcher that has this property on all the time instead of keeping track of an additional state.. Is this what you meant with the remaining Flow issue? That's fine to leave since you're changing it anyway and even then you might end up needing it.. This wasn't addressed. What is the action item here? Put the inlining in the useReducer change PR?. The top comment is not addressed. The array tuple should be in the outer most function.. Ugh. GitHub showed me an old commit. Looks fixed it.. Ugh. GitHub showed me an old commit. Looking again.... This function gets exposed to always be called with three args in the case where it's not wrapped. I'm not sure how much it matters in practice but just to be safe, we should try to ensure that the arg count is consistent so let's add the unused args here and pass them in to ensure type consistency. Same thing with useState.... I don't like that we're adding the progressive enhancement constraint before we need it. Isn't the simple fix here to just disable that feature and not reset it?\nIt seems like a problematic pattern in general if we can't use try/finally in that way since we're now deviating from the \"algebraic effects\" approach.. Once we have released the first version, we have plenty of time to figure out how we could structure the progressive enhancement case in a clever optimal way.. For real progressive enhancement we probably need a way to validate that it is a legit usage of expanding properties, e.g. by inserting a special primitive that when called creates a new tree. But we might also need the nested case. So I'm not sure this solution works anyway.. I believe there has been times where V8 has treated undefined as effectively a missing property in the hidden class rather than a reified value. So setting to undefined might mess with the hidden class. Not sure though.. Are there other common examples we can include here? So it doesn't sounds like a jargon/technical error message.. This function should move to ReactTestUtils and instead using the ReactDOM.render(null...) trick to flush the passive effects. That way we don't have to add any unnecessary invasive APIs to the production ReactDOM. We can add private APIs once we have the new bundle that is exclusively for testing.. Drop the inter. Just call it act. It's cleaner.. Can we reuse a single node? Maybe put an inline React element instead so we don't bail out.. Let\u2019s add two act() calls with expects between them to test that flushing works repeatedly. . We have the mechanism that auto-bails out on equivalent elements. We might accidentally start bailing out before we flush effects.\nEg we just added that optimization to useState that if the same value is set we bail out of even setting the update priority.\nTo avoid that, let\u2019s inline the actElement here so that it\u2019s a new one each time.. Needs some way to flush passive effects.. Can't this just be {current: null}? Why does it need to forward to the owner object?. @acdlite I'm not sure exactly what I need to do here if anything. The timeout doesn't really come into play since failure to hydrate a suspended boundary doesn't timeout until it gets upgraded.. No. What happens is that only the first path schedules remaining work at \"Never\" expiration time. Then if it throws, it doesn't suspend but it also doesn't leave any work on it. Instead it commits. Then it waits for the retry. The retry gets scheduled at normal priority. If that update also throws a promise, then it commits in the dehydrated state again and waits for the retry.. We really should support useReducer if we support useState since that\u2019s the recommended one. Don\u2019t want people choosing useState over useReducer based on DevTools.. We used to pretend that native host instances were ReactNativeComponent. That\u2019s not technically true because they\u2019re not instanceof.\nWith forwardRef, we get the inner type. I would\u2019ve expected that you have to supply the ref type to Flow. What does Flow think the type of a ref is?\nIdeally it would be an opaque type which will help catch anyone trying to call something else on it.. Since you\u2019re going to add more of these, can we name it something more general so we don\u2019t need a file per method?. Let's call this something specific to state since there are many other hooks. E.g. might want to override changed bits etc. for debugging context not updating. For Focal we might want to flip the booleans which are not state.\noverrideHookState?\n. I guess the isEditable just indicates that the \"value\" can be edited as is in whatever form it is. Maybe overrideHookDebugValue whatever the representation of debug tools' value is?. We already have a definition for how to test a thenable:\nhttps://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberUnwindWork.js#L203-L205\n. better name. https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberUnwindWork.js#L203-L205. Hm. Is this the canonical one?. I think we should actually remove it from the dynamic one if possible. Whenever possible we should always use static flags and drive to remove the dynamic ones.. How is this not just the same as below? Can you get rid of this special case?. This seems fragile. We typically don't have to assume that a context needs to be passed in. How should I know when I can use context and not?\nWhat prevents you from popping it later?\n. I'm not interested in the bugs but why we can't restructure the code to also fix it.. Do we need both these identical files? setupPersistent and setupTests.persistent. What's the difference?. #carmackno We need fewer deps. This is unnecessarily complicated and slow.. This was a bit of a last minute Friday drive-by review. The dependency is just one issue. The other issue is its reliance on file system information in general. We should leave that to jest since it's something that does a lot of complex work around invalidation, file watching, module resolution etc. It also fairly frequently changes.\nSo without this diff, it just runs more than it needs to on CI wasting cycles but should be equivalent otherwise?. This should be guaranteed to be a string because we only call these after we've toStringed. That's intentional. To avoid toString returning different values to the first execution and the second. However, if you have a toString like that, you're probably p0wned anyway. So in the future we might only want to call this on things that are already strings to allow raw objects (like Trusted Types) to be passed through and validated by the DOM runtime.. Meh. This whole file is the worst. Let's fix it in Fire.. I was thinking about that. I don't think it's a vector by itself. I guess you could use it to detect that navigation doesn't happen somehow.\nIf we allow it then reformatting it could start throwing in production so seems like a hazard.\nI believe it is generally bad practice to rely on this pattern anyway (e.g. open in new tab and stuff) so this might be a good opportunity to teach alternative patterns.\nAlso, there are are Trusted Types and CSP rules that would have to mirror what we do, otherwise they'd fail too. Better off strictly enforcing it across the community.. I think it's a breaking change. It breaks continuity in logs.. This block should be wrapped in the feature flag check so that it can remove everything including the property access etc. That'll also ensure DCE of the function itself once it has more content.. Same here. Wrap in feature flag check here.. Here too.. This doesn't seem right. The internal EventListener module doesn't accept a 4th argument (and Event.listen accepts a forth argument which is a priority and won't work with this). What's your plan here?. What if setImmediate is mocked? jest mocks it\nCode like this would pick up the mocked version:\njs\njest.useFakeTimers();\nlet ReactDOM = require('react-dom');\nIn that setup we wouldn't flush any work at the end of act until timers are ran. This is bad. We should make this just work.\nIs this the reason you have to do weird things like call useRealTimers and call runAllTimers at random places?\n. If we can somehow instead require('timers').setImmediate from the Node environment, we can get to the unmocked version.\nlet setImmediate;\ntry {\n  let r = require; // trick packagers not to bundle this stuff.\n  setImmediate = r('timers').setImmediate;\n} catch (x) {\n  // try one of the other choices\n}. This won\u2019t warn if the node is nested in a function component for example. We could use the host context for this instead. We don\u2019t have to do that in this PR but can you add a test for the warning and maybe a commented out test for the nested case? That way it\u2019s easy to do that change later.. Why exclude the stack here? Seems useful to have the stack in the warning. . This should be a warning if it\u2019s behind a DEV flag. Let\u2019s also add a test that covers this.\nNot only does it let us test the warning but also make sure the rest of the basic stuff here works too.. This is fine as a start but longer term it would be good if we could avoid doing this in the commit phase for initial renders.\nFor host components we add events and stuff during render phase during initial mount (current === null). We only do stuff in the commit phase for updates.. It is very hard to see if you cover all case for both environments. By default I expect there to be one file for each environment and every test mirrored in each file so that I can see that you've covered all cases in each environment and how you expect any case to be ported.\nIf some test needs to test something specific that is only relevant in one environment sure, but I expect code to mostly work the same in either environment.\nTherefore splitting these into two separate files with a clear name in the file name which environment you're testing would be good.. > act is barely (never?) used, and peeps use runAllTimers() to 'advance' time. of note, the above codepath is never used\nI'm confused about the expectation here. I think this is what we explicitly don't want to have happen.\nBest practice is to not call runAllTimers inside act because act only means that the event turns have happened, not that time has elapsed. An event turn can execute infinitely quickly.\nFor example I often want do:\njs\nawait act(() => {\n  setState();\n});\n// expect on the first commit\nawait act(() => {\n  runAllTimers();\n});\n// expect on subsequent commits that happened after timers set up in effects fired\nSimilarly sometimes you want to call timers without actually flushing any rendering work.\njs\nawait act(() => {\n  setState();\n  runAllTimers();\n  // the set state above is still not flushed because it might have taken awhile to render\n});\n// expect on the commit\nIs this also your expectation?. Maybe point to a test that fails if you use a thenable?. I don't get this part. How are you supposed to do the nesting thing if you can't do <EventA><EventB><EventTarget /></EventB></EventA>?. It would be better to have a getChildHostContextForEvent function in the HostConfig. That way there can be a default noop version that just returns the parent context that will be inlined into beginWork.\nWe also don't have to consider the complexities of events when dealing with just simple host components.. If you create a separate pushHostContextForEvent function then for renderers where we call getChildHostContextForEvent and that's an identity function that just returns the same context, then this should be able to be DCE since it will know that the context is always the same.. This can't happen at all right now since nothing uses the Symbol. Can we get a test of how you expect this to be used even if it's a light version of some internal implementation details of the plugin?. Can you add a feature flag in ReactFeatureFlags for this and then only conditionally add these if the flag is on? Like enableStableConcurrentModeAPIs is doing below.\nIt allows us to release from master once it lands.\nYou might have to find other ReactFeatureFlags forked files and it there too. E.g. you can turn it on in the ReactFeatureFlags.www.js. Sometimes it is nice to be able to conditionally set it:\njs\nclass Foo {\n  static contextType = isServerEnvironment ? null : Context;\n}\nThis provides no way to do that while also ensuring you stay declarative.\nIs null really a common mistake? I'm guessing not since it's the only one you don't have a descriptive message for.. This is already in a __DEV__ block so no need for the extra check here.. This is now back to only allowing strings, right? So you should be able to remove the special case below.. The DEV check for pushing is in the host config but this in the reconciler. So if one of the host configs define a context override in prod, then this will break.\nJust remove the DEV check here. In prod, it'll bailout on the fiber equality check inside popHostContext.\nThis probably indicates that something is not covered by a prod test since the whole test is .internal.js.. rm the DEV check.. These should all be required (and probably an exact object).\nThis will require us to specify this in getHostContext.\nRight now, all three of these will be reset if there is a host node in between them that changes namespace or one of the other ancestor configs. I'm not sure if that's intended or just an oversight. By putting it explicitly in getHostContext, you'll make it clear what you want here.\nOne suggestion would be to make this a nested object for simplicity (like ancestorInfo is)\neventInfo: null | {| isEventComponent: boolean, isEventTarget: boolean, hostNodeCount: number  |}. Let's explicitly list out the props you want to copy here so it's clear what overrides are expected and what is expected to reset.. It might be nicer to pass a flag or the symbol as an argument and whatever else you need as an argument. That way the various host configs aren't so tied to the implementation details of the VDOM and the structure of this object. E.g. for createInstance we pass type and props as explicit arguments instead of passing the whole React Element.. Hm. This won't work. Mutation in here is not safe because we could do multiple passes over the parent or render them out of order in a Suspense case.\nIt might be better to place this warning in the place where you actually attach the event listeners and the error happens. I'm not sure where you're planning to attach the listeners but if you do it in the commit phase and plan on traversing the Fibers to find the DOM node, then you can do the warning there too. Another possible place is in the complete phase for the EventTarget, because that's when all children are guaranteed to have been completed.. ",
    "SanderSpies": "Duplicate of #360 \n. Apologies for adding noise, I'm still getting used to GitHub's issue\ntracking. Thanks for telling.\nOn Saturday, September 21, 2013, Ben Alpert wrote:\n\nWell, they're not duplicates at all; this is an issue, #360https://github.com/facebook/react/pull/360is a pull request.\n360 https://github.com/facebook/react/pull/360 does fix this so this\nshould be closed after that's merged though.\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/facebook/react/issues/290#issuecomment-24870963\n.\n. From what I can see onChange is not working with contenteditable, only onDOMCharacterDataModified seems to work. I would prefer to drop onDOMCharacterDataModified completely as it's deprecated and support onChange and onInput with mutation observer using sane defaults.\n\nIt would be nice to have something like  set of elements to be observed , however implementing this for non MutationObserver browsers seems painful. Especially IE8 which doesn't event have the onDOMsomething event listeners. \n. @zpao, thanks for the feedback. I just added the unit tests as requested - is this the intended behaviour? What else/more do we want here? \n. Picking this one up.\n. Close please.\nIt would be mainly for consistency with the DOM, which we aren't anyway.\nAlso, most use cases could be solved with normal React code.\nOn Monday, October 28, 2013, Paul O\u2019Shannessy wrote:\n\nAfter talking with @yungsters https://github.com/yungsters, I'm not\nconvinced yet that this is a good idea. I think it could be useful if\ndata is used widely, but it still has a pretty minimal usage across the\nweb. If we do decide we want this, there are a number of things about the\nimplementation we'll want to change (this should ultimately work much more\nlike the style prop).\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/facebook/react/pull/435#issuecomment-27263413\n.\n. This is expected behaviour. Please use prop={number} instead\nof prop=number.\n\nOn Monday, November 4, 2013, John Wu wrote:\n\n<!DOCTYPE html>\n\n\nHello React\n\n\n\n\n\n        /<em>* @jsx React.DOM </em>/\n        var MyComponent = React.createClass({\n            render: function(){\n                return (\n                    <div><p>{this.props.firstAdder}+{this.props.secondAdder}={this.props.firstAdder+this.props.secondAdder}</p></div>\n                );\n            }\n        });\n        var app = <MyComponent firstAdder=1 secondAdder=2/>;\n        React.renderComponent(app, document.body);\n    \n\n\nTwo numbers were passed to props, but with exception raised Uncaught\nError: Parse Error: Line 10: XJS value should be either an expression or a\nquoted XJS text.\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/facebook/react/issues/468\n.\n. I believe it's indeed the same issue.\n. Would also look into using \n\nvar styleNames = Object.keys(styles);\nfor (var i = 0, l = styleNames.length; i < l; i++) {\n   var styleName = styleNames[i];\ninstead of:\nfor (var styleName in styles) {\n      if (!styles.hasOwnProperty(styleName)) {\n        continue;\n      }\n. Tnx :-)\nOp 10 mrt. 2014 16:51 schreef \"Andreas Svensson\" notifications@github.com:\n\nhttp://facebook.github.io/react/blog/2013/11/05/thinking-in-react.html\nHere's the real link for now (if you wanted to read it).\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/facebook/react/issues/1238#issuecomment-37197707\n.\n. Anyone picking this one up? Otherwise, I would like to give it a go :-).\n. petehunt: great :)\n\nPotential scenario's I'm seeing:\n- elements with listeners at the same level. \nSo for these event types there will be more then one event listener\n- child element listens to same event as parent element.\nI guess we always want to use the parent element\n- during lifetime the dom changes, and therefore also the element which needs to listen.\nWhich would imply we would also need to remove/add event listeners on the fly, not sure if we already do that\nI'm thinking of adding something like 'bindLocally' at the event plugins level like:\nonTouchMove: {\n    bindLocally: true,\n    phasedRegistrationNames: {\n      bubbled: keyOf({onDragOver: true}),\n      captured: keyOf({onDragOverCapture: true})\n    }\n  }\nGood idea? Bad idea? Missing stuff here?\n. @spicyj I wrote that code a bit too hastily I guess. Should have been touchMove, also notice the onDragOver + onDragOverCapture that I forgot to correct... \n. Change to value only\n. crap!\n. Move ] to next line\n. to what...?\n. Needs a better name\n. Needs to go to topCompositionEnd\n. Ordering\n. Looks fishy as the function above doesn't need this. Will need to look into this.\n. [event] should have been [dependency].\n. Thanks for the tip  :)\n. It seems I was just keeping myself busy due to bugs in my code, the delete's will be removed with next commit.\n. Line probably too long.\n. If I would do this I would need to add an extra mapping (topDoubleClick: 'doubleClick' etc.) which makes this a lot less interesting. Therefore I will pass on this one.\n. Done.\n. @plievone: why not do a PR to fix these 80chars issues?\nOn Thu, Jan 9, 2014 at 2:22 PM, plievone notifications@github.com wrote:\n\nIn src/event/EventPluginRegistry.js:\n\n}\n }\n return true;\n} else if (dispatchConfig.registrationName) {\n-    publishRegistrationName(dispatchConfig.registrationName, PluginModule);\n-    publishRegistrationName(dispatchConfig.registrationName, PluginModule, eventName);\n\nThis one is over 80 chars now too\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/facebook/react/pull/462/files#r8756787\n.\n. What's with the ; in this case? (just curious). \n. Not used anywhere.\n. Spacing before and after -\n. Yeah, I know my impl is crap - but was also asking more for guidance here. See description :-).\n. Just trying to implement a todo :-). I would expect es6 maps (and sets also) to be useful in more places, so that's why the extra file is involved. For the crappy polyfill, well that's because I was experimenting a bit - and thought it would be better to throw in the open. Very much aware it was crap though (sorry though :P). So yeah, therefore my questions - could we use the ReactInstanceMap 'map polyfill'? Or, also possible: no it's better to duplicate code in this case. \n. \n",
    "mcsheffrey": "Really like the idea of a cookbook the way Ember implemented it. I have experience with Jekyll and can pitch in with setting up a cookbook section.\n. Awesome. There's some React.js questions on Stack Overflow that might make for some good cookbook recipes. http://stackoverflow.com/search?q=react.js\nAlso, I like @chenglou 's idea for live code samples (such as the samples on the React homepage). Or maybe just doing an embedded jsbin/jsfiddle the way that Ember JS does it. http://emberjs.com/guides/cookbook/user_interface_and_interaction/adding_css_classes_to_your_components/\n. Sounds good. So the Wiki will act as a working copy/rough draft for recipes and then the final recipes will get added to the Cookbook section of the Jekyll docs. \n@zpao I submitted this PR for us to build off of. Lmk if that copy works for the intro section. https://github.com/facebook/react/pull/362\n. Thanks for the great feedback Paul.\n1. Yeah, Tips aligns much better with the content of this section. Want me to go through and update those?\n2. Agreed.\n3. Yeah, we could change the spacing to better support multiple lines or since it's only two entry names that run over 1 line reword those. Thoughts? @chenglou \n   \n4. I felt like the leading numbers in the filenames were helpful for keeping order. Easier to keep track of prev/next posts.  Thoughts? @chenglou \n5. Agreed, left nav has gotten pretty long. I think the plan was to start grouping similiar entries under categories similiar to what Ember does. Or like you mentioned we could collapse each Docs category that isn't in use (see screenshot for example).\n\n\nI'm excited to get this merged in! Again, appreciate of all your help and review.\n. c@conr.me is the one connected to my github account, so probably stick with that one. Thanks Paul!\n. Got it.\n. Yeah, that was there for live samples. I'll take it out for now.\n. Removed file\n. Removed file\n. @vjeux which line?\n. Holding of on this one for now. @chenglou made note of this need in the wiki https://github.com/facebook/react/wiki/Cookbooks\n. Removed\n. ",
    "lorefnon": "I have been facing this problem as well.\nNode : v0.10.12\nnpm: 1.2.32\nOS: Windows 7, 64 bit\nCommand used : jsx src app both src and app exist and compilation works without errors on linux but fails on windows.\n. ",
    "TroyWorks": "This happens on windows 8.1 64 bit as well.\nI tried @wolverex 's suggestion of installing MinGW and added C:\\MinGW\\bin and C:\\MinGW\\msys\\1.0\\bin to PATH, restarted but still no luck on a basic command.\nMy fallback is using it in a Virtual Machine, but that's pretty heavy weight\n. It installs via npm but jsxc isn't a recognized command\nHere's the last snippet of output.\njsxc@0.9.0 node_modules\\jsxc\n\u251c\u2500\u2500 mkdirp@0.3.5\n\u251c\u2500\u2500 chokidar@0.8.1\n\u251c\u2500\u2500 optimist@0.6.1 (wordwrap@0.0.2, minimist@0.0.8)\n\u251c\u2500\u2500 glob@3.2.9 (inherits@2.0.1, minimatch@0.2.14)\n\u2514\u2500\u2500 react-tools@0.9.0 (esprima-fb@3001.1.0-dev-harmony-fb, jstransform@3.0.0, co\nmmoner@0.9.1)\ntried just jsxc didn't recognize it, as well this full path.\nC:\\Users\\dev1\\node_modules\\jsxc\\bin\\jsxc' is not recognized as an inte\nrnal or external command, operable program or batch file.\n. @petehunt thanks\nnpm install -g jsxc\nthat worked like a charm ..yip!\n. ",
    "cbrake": "@chenglou thanks for the explanation.\n. ",
    "tomelm": "I'm also running 1.9.2 when I'm seeing this error\n. ",
    "toddself": "@petehunt thanks for the help with the CLA!\n. oh hey i just saw this.  let me make these changes\n. So odd.  I don't remember putting that line there at all...\nThis has been resolved and history cleaned.\n. The original author says you shouldn't use that at all since it's totally abandoned and the npm module name has been passed off!  CC @STRML who has a fork/similar project and owns the npm module name now.\n. ",
    "brettahale": "I couldn't get this work without autobind. As @spicyj pointed out, it's automatically bound in .4. With that said, this pull request doesn't make sense to me anymore either.\n. ",
    "jonathanj": "This seems to be a problem in the jstransform library, the problem begins with the docblockRe expression. Catering for \\r\\n in this expression allows the parse to find the JSX docblock and continue with the rest of the parse (which seems to trim strings, presumably removing the trailing \\r.)\n. ",
    "bywo": "Not sure if this is the best place, but I'd love to see a blog post about this or some sample code!\n. ",
    "nilliams": "I also failed to find that page and came here after a lot of head-scratching. I too expected to find how to deal with style on the JSX Gotchas page (even though I now understand it's not technically a JSX issue). Perhaps on the JSX Gotchas page a specific mention of the style attribute and a link to DOM Differences would do it, as I think it's one of the first WTF moments people are likely to have with JSX, certainly was for me.\n. Those cookbook tips look great, would certainly have helped me, thanks!\n. ",
    "yazaddaruvala": "Interesting. I agree the issue should remain closed, componentWillRecieveProps works. Thanks. However, I do have a few thoughts and questions.\nIts interesting that React's notion of a component's identity is based entirely off name and position. I would have imaged and would like to argue that a components assigned properties are as much a part of its identity as its name or position. Are there current technical limitations or fundamental ideologies of React that make this so?\n. Thanks for the additional info, all of that is very good to know. I do get exactly what you mean about using a callback to \"tell\" Content it needs to expand. Being new to React its hard to know what the best practices are. I thought given the idea of immutability that \"telling\" a component to change would be wrong. But given \"refs\" I guess its not. I prefer the idea of setting a \"key\" prop. It seems more declarative than using the componentWillRecieveProps hook.\nAnother thing that I assumed, which I guess I assumed wrong was that the \"diff process\" between the currentMockDOM and the nextMockDOM. I thought it was more intelligent (but now I get why its not). That since I was just changing a style in my Content React wouldn't throw away the whole node and would just change its style after calculating the minimal changes required. From what you both said above, about \"throwing away\" components if a prop changes it seems that assumption is wrong. However, I seem to remember a video about React saying something similar to \"we only apply the minimal set of DOM changes required\". However, it now occurs to me that perhaps that process is only used when React interacts with the real DOM not when transitioning from the currentMockDOM to the nextMockDOM. Unless I missed a lot of the docs this may also need some clarification.\nIt would be cool to read a blog post about how the DOM, MockDOM and nextMockDOM (I don't even know if this is a real concept) interact. What is stored in each, and when.\n- Basic example: Updating through internal state. I think I understand this well but a more indepth understanding would be beneficial.\n- Complicated example: A rendered and re-rendered list of components. When a list/app's state changes say perhaps to select one component and mark it as highlighted: Are all the components re-rendered? If not, what is the criteria for re-rendering? And regardless, if those components render to a identical MockDOM as before but one class has been added, how does that affect the real DOM, ie what are the minimal set of DOM changes that will be applied?\nActually having written all of that, I realize that I'd be able to answer a lot of my questions if React would console.log the minimal set of DOM commands that are being applied. Do you guys have a flag I can use, that you use during development/debugging?\n. Good to know. Thank you.\n. Good call. Thanks.\n. ",
    "matnel": "Working on it :)\n. ",
    "plievone": "Fixed in pull request #465\n. ReactComponent.isValidComponent() deoptimization is mostly due to validateChildKeys() which is DEV only, so it has not affected prod builds. Also it seems that Firefox etc deal with undefined member access very gracefully, so generally this may not be as important as seems to be from node/V8 point of view.\n. fixed in commit 1783e54\n. A brief look at the mounting procedure (https://github.com/facebook/react/blob/23ab30f/src/core/ReactCompositeComponent.js#L688-L720) suggests that to prevent races, transitions should use componentWillMount and setState there, so that the class could be set already on initial render.\n. @chenglou Fixed by 945f788 and #1019 ?\n. Possibly in need of a rebase to ReactTransitionGroup rewrite 9ac27cb\n. @yungsters IE8 now failing with \n```\neventPlugins/tests/EnterLeaveEventPlugin-test EnterLeaveEventPlugin should set relatedTarget properly in iframe.\nError: Invariant Violation: _registerComponent(...): Target container is not a DOM element.\n```\nwhen run with grunt connect sauce-tunnel:keepalive and grunt build:test build:basic webdriver-jasmine:saucelabs_ie8 ?\n. The fix was reverted in 23ab30f, so this issue is still open. Hopefully the fix can be applied later, it is the right thing to do? innerText seems to return only visible text and may insert formatting, such as \\n between stacked divs and \\n\\n after headings, but as it is not even present in Firefox any internal IE-test that relies on that behavior should just be fixed...? For example, this SVG example works ok in Firefox because innerText is not available, so it uses textContent. \n. Fixed in esprima-fb (https://github.com/facebook/esprima/pull/8) when package.jsons for esprima-fb, jstransform and react are sorted out.\n. Hi! A few of those tests still fail in IE8 due to innerHTML not returning initial whitespace. Maybe best to not use initial whitespace in test markup. (See workarounds in https://github.com/facebook/react/commit/1f2d57d, may not be possible for those body, etc. elements)\nThere is also one Error: Permission denied happening here in IE8, found out in #608\n. As a workaround for now one can strip them out after rendering to string, as suggested on forums:\noutput = output.replace(/ data-react[^=]*=\"[^\"]*\"/g, '')\n(may strip false positives on docs, however)\n. > And event handlers aren't automatically attached, I had to do them manually in componentDidMount.\nNote also that global event listeners are normally attached to node.ownerDocument (from where events are propagated to event handlers internally), and as document fragments are not recognized, global event listeners may be bound directly to document fragments (as documents, even though they have ownerDocument) and lost. https://github.com/facebook/react/blob/e3e3b47/src/core/ReactDOMComponent.js#L70-L73\n. Thanks! Fixed in #844. You can close this.\n. > (That's react-bench; I couldn't get grunt perf to work.)\n@spicyj For me it prints a bunch of JSONs and exits with \"Done, without errors.\". Have you tried npm update just in case phantomjs or wd have been updated since? It doesn't print a summary yet, though.\n. Related: #830 \n. Perhaps those few failing tests in IE8 that are not related to unused ImmutableObject should be fixed before release, seen with:\ngrunt connect sauce-tunnel:keepalive\ngrunt build:test build:basic webdriver-jasmine:saucelabs_ie8\n. Just found out that querySelectorAll and JSON.stringify are also used in react codebase, but they are well supported in modern mobile browsers. (http://quirksmode.org/dom/core/mobile.html, http://caniuse.com/json)\n. Link to related issue #552\n. As hasOwnProperty is mostly used to prevent prototype chain enumeration in for...in loops rather than filtering undefined keys, you could remove many of those undefined checks completely. But note also that your quick benchmark accessed just defined keys, not undefined keys, so if some part has mostly undefined accesses it may perform a bit worse depending on engine.\n. If somebody adds things to Object.prototype without setting them non-enumerable via Object.defineProperty, that kind of environment should be considered broken...\nIf React goes towards not using hasOwnProperty checks then one could visit all those merge functions too, that ignore prototypes at the moment.\n. > Have you seen any really great implementations that allow resolving arrays arbitrarily?\nThere are some quite smart array diff algos in JsonDiffPatch.\n. > So it looks like the name require() never appears in the output bundles, right?\n@petehunt Browserify --standalone since v3.24.0 does this too with derequire.\n. Merged as 71c10b9\n. Merged in 9ae0025\n. It seems that IE's node.innerHTML= (as in your example) clears all DOM nodes in the whole subtree, so that their .childElementCount is zero and also their .parentNode is null. As the \"old\" component instance is still attached as a child to the container element when you replace the whole tree with that innerHTML call, all of its DOM elements, including the rootNode, are now detached from each other (so they won't be anymore in the detached old container DOM node, as is usual in other browsers) and traversal to root node is impossible. This causes containsNode() to return false in isValid() used by getNode(), when processing old component DOM node in old container (now all elements detached from each other), and that is when behavior starts to differ and error happens.\nIn other browsers perhaps the \"old\" component instance runs happily in its detached container DOM element, without knowing about the problem. There might be something one could do to get a better view of the problem there too and enable that helpful warning.\n. Related #938. SVG tag additions touch quite many files, see for example diff #868\n. And if it's not really the root container you are after, but rather you are trying to remove this.getDOMNode() manually, you should simply modify the owner component's render method to not render the node anymore.\n. Related: #996\n. Excuse my ignorance, but where is componentDidMount used, I only see componentWillReceiveProps and componentDidUpdate in ReactTransitionGroup? Those test cases seem to imply componentWillEnter and componentDidEnter are not called until second render?\n. Ok I see -- I just mixed up the lifecycle methods in group vs child when skimming the code. This will be very handy!\n. There have been moves to not use hasOwnProperty, see #941. So perhaps a separate set of merge functions could be used, which would look at all enumerable properties, and could even have pooled variants for heavy use.\n. And there's also clarification plea #968\n. extra word 'fetches'?\n. I guess you noticed it, but you mutate this.state here. Perhaps one could prefer filtering instead.\n. Small typo: 'could have achieved' or just \"could achieve\" (depending on the rest or the sentence) \n. Comment still refers to ReactDOM.form, so perhaps remove the whole comment?\n. Do you need to support older Firefox MozMousePixelScroll thingie? https://developer.mozilla.org/en-US/docs/Web/Reference/Events/wheel#Listening_to_this_event_across_browser\n. You need to start the href with '/' here, see #841 \n. There are a few lines over 80 chars, this is one\n. This is over 80 chars now.\n. Just over 80 chars\n. This one is over 80 chars now too\n. Should these by default be without isRequired, for example if a component takes many sub components conditionally in different props (so some can be undefined or null?) \n. While you are at it, the onScroll warning could be moved (and isEventSupported removed) to https://github.com/facebook/react/blob/338ce60/src/core/ReactEventEmitter.js#L265 I guess\n. Should image be also in shouldWrap with other svg elements?\n. Alphabetical ordering?\n. @ericflo Any update on namespaced attributes, did they work?\n. @SanderSpies I couldn't sign CLA previously as I don't have a facebook account, but worked around it now at last, sorry...\n. It is quite tricky to see how the behavior still stays identical (not masking it in finally, see comment on later lines), so could this be simplified somehow.\n. @syranide It is possible, perhaps preferred(?) to remove that catch, but the behavior stays the same because the last if (errorToThrow) is not reached if thrown without catch so some variable renaming would help perhaps.\n. @spicyj @syranide If it is important to avoid rethrowing, one can remove this catch and it will work ok. \n. Perhaps one should note that as the component is already mounted on DOM, it may become visible before componentWillEnter -- for example if a browser repaint occurs due to some other 'componentDidMount()measuring the DOM. In such case one can prepare the state by adding a proper className already in initial render, for example.\n. Would it be cleaner to just do Object.keys(isUnitlessNumber).forEach(fn), it is just initialization.\n. There'sonError` too\n. url is missing?\n. @spicyj Could mention that boolean attributes now render as bare attributes (#1005)\n. @spicyj If you like, also jsbin now supporting JSX too could be mentioned in this post already, it is a nice development.\nIt would also ease reading the changelog if there would be links to docs for new features, addons, etc, but it is quite tedious to link them and they may be broken when docs are restructured.\n. No try-finally here anymore so could bring the function inline again?\n. If you grep nodeType through React codebase, there are a couple of other places where for example TEXT_NODE is hardcoded as 3, don't know if those should be included too (some of those may be vendored in) or perhaps in another pull request.\n. @andreypopp Related: #893\n. Perhaps you meant todo.complete here.\n. Currently areAllComplete is quite redundant, as you loop through allTodos in any case in render and could build it there? Or is this for pagination etc?\n. Just an idea that sometimes \"controller-views\" are called \"presenters\", perhaps those component filenames could reflect the distinction too.\n. It would be nice to hear why and how promises are usually used here, perhaps in comments?\n. I guess this _areAllComplete is not used.\n. Not a big deal, but now the store will emit change even if the action is not handled by this store but perhaps some other store. One could use a default case to return early, or something.\n. First I thought that as areAllComplete is just a derived state (the ground truth is in allTodos which is carried along in any case) it would be more functional to get rid of that variable, but I see your point that in a way it goes against separation of concerns even if the computation is quite simple, if the computation is then done in multiple places. I was not thinking so much about perf optimization but just simplifying the state that needs to be managed and relayed to components.\n. > we would be needing to call setState somewhere so that _onToggleCompleteAll() would know which way to toggle\nAlso as an idea, you could avoid toggling and just split it to two separate functions, rendering different buttons/behaviors based on state. Usually I have found it better to have idempotent functions instead of a toggle, as there usually needs to be separate text strings in ui etc in any case.\n. @Raynos Perhaps strings are used so that actions are easily serialized to wire etc? It's also nice when V8 uses string interning so that they are actually just references to same strings.\n. What is your approach to server rendering in flux? I guess this works quite nicely like this (isomorphic), but this componentWillMount will be run also when using renderComponentToString, so this could check whether we are on server, or perhaps TodoStore server implementation could have empty functions when trying to register event listeners.\n. edit: nevermind :)\n. Missing e argument here?\n. Minor nit: you have a double space here.\n. Do you know if there is already something in open source to minify keyMirror constants?\n. It would be very helpful to have any comments on server actions, how they are usually handled in flux.\n. Any comments regarding interaction with server in flux would be helpful here. Also how do you usually handle bootstrapping of store data on page load? \n. Thanks for this explanation, and perhaps one may also need batching of some updates, such as server actions, together to only trigger consistent UI updates from stores? This could be handled in many ways. \n. Small typo in \"registerd\".\n. constants/TodoConstants.js could be added here for consistency.\n. Could use single quotes and %s here for consistency?\n. Should some of these hasOwnProperty checks inside for-in loops be early continue instead of wrapping in a conditional? Now it is quite easy to still run some code after the conditional but still inside the for in loop, perhaps unintentionally? But I don't know those few places in this diff so well.\n. You have a double space here.\n. I guess one could simplify to just prevDescriptor.key === nextDescriptor.key now.\n. This line change is unintentional I guess.\n. React style uses function() (same below)\n. Double space here..\n. (By the way, what should the behavior be if there is only one option, or no options?)\n. The same change could benefit the suspense demo readme too. And is there an interaction-package or was that an earlier name of schedule?. Drive-by-comment: This seems to be the suggested scheduler usage code, so could you clarify these terms more? 1) Perhaps deadline.didTimeout is rather didExpire (as you have called these elsewhere), but is it a deadline that expires or is there a way to express this without negation. 2) Also what happens if one forgets to check expiration, I would guess the scheduler calls us immediately again so it works, just slower, or is the problem more drastic. 3) Also timeRemaining is about the current frame (or how do you call it) which might confuse the user as it reads now, just after the didTimeout.. ",
    "kevbook": "I am converting my project to use React. I dont want to change my workflow for front end engineers. \nSo they write Jade -> JSX -> Reactified (used in front end). I'll code it up if it doesnt exist. \n. ",
    "jiku": "Haven't tried it yet, but this could be of interest. \n. ",
    "krsmedlund": "there is a typo in the text at <i>virtual DOM</li>\n. ",
    "pgherveou": "btw one option to remove trailing white spaces left by jsx would be nice to have too :)\n. Thks for the feedback @petehunt I don't have much time this week, but I'll try to work on this asap\n. weird I did some tests and it looks like I have to do the binding...\n. Somehow this wasn't bound in my test, when does this autobinding take place?\n. ",
    "leoasis": "It could be a separate script for testing, as angular does with angular-mocks.js. It could be react-test.js or something similar\n. ",
    "tjwudi": "sorry for my ignorance. Thanks for help! :)\n. ",
    "ide": "I think the right thing is for me to update my fork i.e. go ahead and break this.\n. pusheen_party\n. Raw setTimeout and rAF also introduce race conditions (consider the case where a component is unmounted before the callback fires. @jordow, did you have a solution for this that scopes async callbacks to the lifetimes of their contextual components?\n. Trimmed the className in the latest update, but before that I wasn't able to repro this issue by running grunt test locally.\n. ",
    "jaredly": "Is this still \"undocumented on purpose\"?\n. oh! I thought we were supposed to pass in an array. Now I know.\nOn 12/27/13, Michael Hart notifications@github.com wrote:\n\nI just ran into this - after a bit of hair-pulling tracked it down to using\nan array for children instead of just an argument list.\njs\nReact.renderComponentToString(React.createClass({\n  render: function() {\n    return React.DOM.div(null, [ // <-- emits warning\n      React.DOM.div(),\n      React.DOM.div()\n    ])\n  }\n})(), console.log)\nRemoving the square brackets works fine and does not emit this warning.\n\nReply to this email directly or view it on GitHub:\nhttps://github.com/facebook/react/issues/663#issuecomment-31291200\n. sounds good. Any way I can extend react such that there's a createRouter function, that's just like a component except:\n- componentWillUpdate is called with (nextProps, nextState, nextRoute)\n- componentDidUpdate is called with (prevProps, prevState, prevRoute)\n\n? I mean, it's not super necessary, but it would be cool.\n. it can -- or rather as a state. b/c who would set the prop?\nLike I said, not critical to success. but it would be cool.\n. it can -- or rather as a state. b/c who would set the prop?\nLike I said, not critical to success. but it would be cool.\n. I would like this as well. My use case is generally constructing the object beforehand.\n. cool, didn't realize that. Sounds great.\n. :( hmm. Is there a way to just use setattribute for svg elements?\nOn Feb 13, 2014 7:22 PM, \"Ben Alpert\" notifications@github.com wrote:\n\nHmm, looks like this will break things in IE actually:\nhttp://stackoverflow.com/questions/2490627/how-can-i-reliably-set-the-class-attr-w-javascript-on-ie-ff-chrome-etc\n\nReply to this email directly or view it on GitHubhttps://github.com/facebook/react/pull/1072#issuecomment-35049774\n.\n. Yeah, I'm seeing a lag with my <input>s. I know I can just hack around it with componentDidMount, but I wondered if it would be possible to just switch to native event handling.\n. step 1) use a really underpowered netbook :)\nyeah, I'll put together a test page\n. The problem is probably exacerbated by the \"keydown -> change state -> re-render -> update dom\" loop for bound input elements.\n. I've only noticed it on the inputs\n. I don't have any onMouseMove handlers at the moment, but I wouldn't be surprised if it had issues as well\n. click handlers don't generate enough events to bottleneck\n. \n",
    "Daniel15": "I was thinking about this more and using a static list would probably be better than AJAX (given the tutorial just AJAX loads a static file). Updated the description to reflect this.\n. :+1: I like this.\n. Thanks, I can work on this. It might be worth utilising DefaultDOMPropertyConfig.js in html-jsx-lib so that its checks are consistent with React itself. I'm actually surprised how well the HTML to JSX converter is working at the moment, it seems like the only issues are little ones that should have easy fixes.\n-t-e-x-t-a-l-i-g-n is pretty amusing. :P\n. :+1: I like this.\n. :+1: This could probably replace over most usages of  onlyChild :)\n. Good idea :+1:\nI wanted to get this version merged in, and do the work to get it fully working with both Node.js and the website in a separate commit / pull request.\n. Good to know! I'm currently on vacation but I'll look at adding a simple\ncommand-line version to react-tools once I'm back and get some free time.\nSent from my mobile.\nOn Dec 29, 2013 4:03 PM, \"jhiswin\" notifications@github.com wrote:\n\nIn docs/_js/html-jsx-lib.js:\n\n\nreset: function() {\nthis.output = '';\nthis.level = 0;\n},\n/**\n* Main entry point to the converter. Given the specified HTML, returns a\n* JSX object representing it.\n* @param {string} html HTML to convert\n* @return {string} JSX\n*/\nconvert: function(html) {\nthis.reset();\n  +\n// It turns out browsers have good HTML parsers (imagine that).\n// Let's take advantage of it.\nvar containerEl = document.createElement('div');\n\n\nJust want to mention it works with jsdom as is:\nvar fs = require(\"fs\");\nvar jsdom = require(\"jsdom\");\nvar htmljsx = fs.readFileSync(\"./html-jsx-lib.js\",\"utf-8\");\njsdom.env({\nurl:\"http://sip1.idiil.org/\",\nsrc: [htmljsx],\ndone: function(errors,window){\n      HTMLtoJSX = window.HTMLtoJSX;\n      var converter = new HTMLtoJSX({\n        outputClassName: \"MyClass\",\n        createClass: true\n      });\n      console.log(converter.convert(\"<!doctype html>\"));\n}\n});\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/facebook/react/pull/667/files#r8579909\n.\n. Hmm that's a good point. I thought they were totally disallowed.\n. I'm planning on creating a better landing page tonight. I think this one serves its purpose for now. I'd rather use the website as the landing page since that allows the most flexibility. I can just redirect it to the Github repo instead.\n. \"Live JSX Editor\" used to be hard-coded in the component (see line 153), I just pulled it out into a prop.\n. I like how it says \"Facebook engineers\" and then links to both of their Twitter profiles :)\n. You need to update this link too (https://www.npmjs.org/package/react-dispatcher to /package/flux)\n. http://dan.cx/ please\n. Do the anchors actually work, since you're setting the ID after it's rendered? Does the browser correctly scroll down to the anchor when you open a fresh tab and go to a URL with an anchor?\n. This is really inefficient as it needs to serialize the HTML (the read of innerHTML), then append text, then deserialize the text back into DOM nodes. I'd suggest creating a DOM node directly instead, something like this (untested):\n\nvar anchor = document.createElement('a');\nanchor.className = 'anchor';\nanchor.href = '#' + elementID;\nelements[i].appendChild(anchor);\n. This is not correct; it can be an object (see line 56). The correct propType is the type for transitionName in ReactCSSTransitionGroup.\n. Yeah it should work with VB.NET for example, I've only tested with C# though.  I wanted to mention C# in case people skim the page for it. Perhaps I should say \".NET Framework (C#)\" or something like that?\n. Ahh, I didn't even notice there was a redirect layout.\nI like .htm... It's one less character, and consistent with pretty much everything else having a three-letter file extension (well, apart from .js). The extra l doesn't provide any extra value  :smile:  haha\n. I dream of a world where Github Pages supports server-side redirects... Maybe one day. Missing functionality is the main reason I'm not really using Github Pages for anything much.\n. The old text used \"ES6 class syntax\", so I kept that the same for consistency. I can change it though.\n. Babel-standalone is on CDNJS and I've seen better perf with CDNJS compared to unpkg (also it has more users so it's more likely to hit the cache). Maybe use CDNJS instead?\n. In this one, you might want to use babel-standalone from Bower for consistency. Updating the install command to bower install --save react babel-standalone should work.\n. Hmm, this changed when I ran bundle install... I'll revert these changes.. I wonder if this should have an exclamation mark (like /**!) as that signals to most minifiers that it should not be removed when minifying the code. I think currently this header would be stripped if someone manually minifies the code.. @donavon - Since it's only used once and it's only a single field, there's not really any advantage of destructuring here.. Prefix with underscore since it's private (_handleMouseMove)? Or is that not really common in open-source?. Rather than inlining a lambda, it might be worth making it a method since that's what you'd be more likely to see in a larger app:\n<Mouse render={this._renderMouse} />. Spell out \"higher-order component (HOC)\" the first time you mention it. This sentence just mentions \"HOC\" without saying what it means. \ud83d\ude03 . This is useful, thanks for adding it.. >  inline labmda function handlers in render) are just a bad idea from a memory management/garbage collection perspective.\nI agree with this, and actually wrote a lint rule for it (https://github.com/yannickcr/eslint-plugin-react/commit/19faaac2f78c6568635165e26d9a05edabcc01fc#diff-3bb8bcac6ca99e0bf2c936111e93256e). It can have nontrivial effect on performance if it's done on a hot code path in a large app. My benchmarking was done a few years ago though, so perhaps newer browsers are better?\nHaving said that, you can usually fix it by just using a method on the class instead of inlining the function.. It's pretty common internally at Facebook as we have a custom Babel transform to make them \"actually private\" (the names get mangled such that code outside of the class would need to try very hard to touch anything private).. The old version was open sourced as part of jstransform (https://github.com/facebookarchive/jstransform/blob/aa574cfbf2088e9206b88d700f21794d17f32212/visitors/es6-class-visitors.js#L185-L187), I don't think the Babel version was ever open sourced though :(\nHaving said that, there's a proposal for private properties so maybe we'll actually have it for realz in JavaScript eventually. https://github.com/tc39/proposal-private-fields. Could this be automated using WebDriver? Definitely a separate thing, but might be worth considering adding to the script in the future.. An idiomatic JS way of doing this that I've seen is .filter(Boolean), but maybe that's not clear to beginners? owner => owner isn't clear either though. I'd suggest doing .filter(owner => !!owner) if you want to go that way.. Are you planning on automating the GitHub release creation in the future too? We did this for Yarn \ud83d\ude04 . ",
    "arr-ee": "Correct me if I\u2019m wrong, but 80d7d2d0f8ec0f4f1f3c2dbe613f36bda572ce11 seems to fix that.\n. ",
    "panesofglass": ":+1: since this will help work with other compile-to-javascript languages and frameworks such as typescript and F# (FunScript and WebSharper).\n. ",
    "fdecampredon": ":+1: \n. There is other problems with typescript + React than just the JSX syntax. \nTypeScript currently does not support mixins at all, (and won't before at least some months I would say). \nSo it's basically very hard to make it understand what is the result of React.createClass  (and I doubt it will be ever possible to make it understand React mixins).\nI've tried to work with React + typescript, and ended up wrapping a lot of React mechanism to be able to make TypeScript fully understand type of what I worked with.\nPerhaps the real solution here would be to create a JSX to Typescript definition file compiler to integrate with typescript, and keep JSX for creating React components.\n. ",
    "thSoft": "+1\n. This would be great also because the superfluous spans interfere badly with onMouseOver events: they \"steal\" these from their parent elements, which is very counterintuitive for the user. :(\n. But hovering the topmost element can be only done with onMouseOver/Out\nAFAIK. My workaround is to explicitly create spans with style\npointerEvents: \"none\" for these text nodes.\n2014.02.02. 6:31 ezt \u00edrta (\"Sebastian Markb\u00e5ge\" notifications@github.com):\n\nThe solution is to use onMouseEnter. This is why we had onMouseOver\ndisabled before because it gives confusing effects in certain circumstances.\n\nReply to this email directly or view it on GitHubhttps://github.com/facebook/react/pull/742#issuecomment-33892832\n.\n. +1 Totally agree with @andreaferretti.\n. \n",
    "thomasboyt": "One way to handle non-method properties of classes (mixins, propTypes, etc.) would be to use the speculative annotations that Angular is planning to use: https://docs.google.com/a/venmo.com/document/d/1uhs-a41dp2z0NLs-QiXYY-rqLGhgjmTf4iwBad2myzY/edit#heading=h.ambwele793xv\nYou then might end up w/ something like:\n``` js\nimport {ReactComponent} from \"react/ReactComponent\";\nimport {WithMixins, PropValidate} from \"react/util\";\nimport props from \"react/props\";\nimport MyMixin from \"app/components/MyMixin\";\nvar props = {\n  myProp: props.fn.isRequired\n};\n@WithMixins(MyMixin)\n@PropValidate(props)\nclass Component extends ReactComponent {\n  // ...\n}\n```\nOf course, these won't actually be in ES6 (but are on the table for ES7), so you'd be introducing a required build step for this syntax (whether with Traceur's version or a sweetjs macro, etc). Devs who would like to opt-out of that step could either stick to React.createClass(), or maybe use the syntax the original snippet showed, e.g.:\n``` js\nclass Component extends ReactComponent {\n  // ...\n}\nComponent.addMixins(MyMixin);\nComponent.propValidate(props);\n``\n. @benjamn Ah, sorry, that's from an example test using mocha/QUnit-style [done callbacks](http://visionmedia.github.io/mocha/#asynchronous-code) (done` is a cb in mocha that you call to indicate a test has completed).\n. updated the example test to be a complete mocha test, hopefully should make it a bit clearer\n. @benjamn just updated to v0.9.0, and yep:\n``` js\n$ grunt requirejs\nRunning \"requirejs:app\" (requirejs) task\n\n\nTracing dependencies for: lib/requirejs/require\nTypeError: undefined is not a function File: js/components/forms/user_add.js:\nIn module tree:\n    js/app\n      js/router\n        js/flows/claim/app_view\n          js/flows/claim/bank_first\n            jsx\n{ [Error: TypeError: undefined is not a function File: js/components/forms/user_add.js:\nIn module tree:\n    js/app\n      js/router\n        js/flows/claim/app_view\n          js/flows/claim/bank_first\n            jsx\n\n\nat Object../array-set (eval at <anonymous> (/Users/thomasboyt/venmo-devops/venmo-web-views-base/node_modules/grunt-contrib-requirejs/node_modules/requirejs/bin/r.js:25178:38), <anonymous>:8747:1)\n\n]\n  originalError:\n   { [TypeError: undefined is not a function File: js/components/forms/user_add.js: ]\n     requireModules: [ 'jsx!js/components/forms/user_add' ],\n     moduleTree:\n      [ 'jsx',\n        'js/flows/claim/bank_first',\n        'js/flows/claim/app_view',\n        'js/router',\n        'js/app' ],\n     fileName: '/Users/thomasboyt/venmo-devops/venmo-web-views-base/public/lib/jsx-requirejs-plugin/js/jsx.js' } }\n```\nUnfortunately still having to maintain my own branch :(\n. @spicyj I agree that that would be more useful in many cases, but I don't know how you would insert an arbitrary function into React's run loop (presumedly, that is the \"tick\" that you would want to wait on).\n. sure, I'll move it to utils\n. ",
    "magalhas": ":+1: \n. :+1:  One of the first things that I struggled to do when I started experimenting with React was on how to pass an object to a sub component using JSX.\n. Is there any any issue describing the reasons behind this decisions so I can take a better grasp on it?\n. Thank you for the clarification, it was kind of what I was assuming, but for instance if I can only use the isMounted method inside the component, I can conclude it'll only be used inside the component's life cycle (between componentDidMount and componentWillUnmount) which means that isMounted() will always return true. What's the point on having the method then?\n. ",
    "davidhellsing": "It\u2019s actually a very important part of integrating backbone with react, because without this fix all models will be hanged loose on each render.\n. ~~@petehunt sorry, signed the what?~~ Nevermind, I found and signed it as David Hellsing.\n. ",
    "msemenistyi": "Found the issue within commoner module\nhttps://github.com/benjamn/commoner/pull/46\n. ",
    "cpojer": "Sure, I just didn't think we would need them right now (do we have a reason to use them atm?)\n. Are we ok with shipping it like this to all the React users? :)\n. Added template transforms to jsx-internal. Will make the changes to jsx in a separate commit.\n. jsx: I'll make it opt-in for now and when it is time we can agree to make it opt-out. Let's give other people some time to warm up to it.\n. The first commit should go away after it was pulled, right?\n. Yes but how? :)\n. it is really just Array.prototype.slice.call(arguments, offsetA, offsetB).\n. - Reverted the changes to the base constructor (I did however clean it up just a little for DEV)\n- Made joinClasses and ex smaller and easier to understand\n- Added esnext option to to .jshintrc Note that this will fail for now until https://github.com/jshint/jshint/pull/1386 gets pull, @zpao agreed that this is ok\n- I benchmarked this using @paulshen's tool. I didn't get any significant difference between master and this diff (I re-ran a couple of times, sometimes master was faster and sometimes this diff was faster)\nPull away!\n. One important reason is that arguments are not really inferable statically, while rest params are. @jeffmo will fill you in. Ideally after ES6 becomes a standard, arguments will just cease to exist.\n. Added a test that ensures getInitialState can return null.\n. Personally I'd like to be explicit. If you define a function called 'getInitialState' I think it must always return something and 'undefined' is a bad initial state. However, if this breaks a lot of code we should consider allowing it.\n. @jeffmo I don't feel confident naming this just --es6 if we don't support everything. I think experimental-es6 perfectly describes what it does - a subset of useful es6 features.\n. Alright, I guess --es6 is better than --partial-es6 at least. I understand what you mean by experimental though.\n. Changed to --es6, updated commoner.\nOnly open problem is that if toggle the option without changing the files it will not pick up the transforms. Do we care about this?\n. --harmony!\n. I'm having an issue with commoner and jsx-internal; going to figure out what's happening\n. Doesn't change anything; also doesn't explain why travis would fail.\n. wow I'm a n00b. Should be fine now.\n. Just realized ReactErrorUtils is not a good place for this, how about an 'error' module that lives next to invariant?\n. I had this as 'warn' before but decided error is better. Warnings in the console don't really cry for much attention and if something goes wrong with your PropTypes I think it is better to tell you about it in RED.\n. Changed to an error module.\n. @yungsters we wan't to be able to analyze this module and maybe strip it out in prod.\nif (condition) console.warn(\u2026); is harder to analyze than warning(condition, \u2026)\n. discussed with @sebmarkbage in person, we decided to call this module warning.\n. Hah, I never knew about this.\n. @chenglou please add Object.keys to http://facebook.github.io/react/docs/working-with-the-browser.html since we are requiring other parts of the ES5-shim, this should be totally fine to use.\n. @syranide The collision case should be treated just like missing keys, in which we continue rendering just fine. There is no reason the whole app has to break (assuming your whole app is built using react).\n. I think it is fine.\nAs said, I ran react-perf and it didn't become slower than before.\n. I'm super unhappy but I perf-tested this and it was about 94 times slower. Not awesome. JS engines, get your shit together. Anyway, I just reverted the change here for until 2020 when at least one browser will have ES6 natively.\n. getVisitorsList() returns all visitors; I am open to renaming it to getAllVisitors since it also returns the jsx visitor.\n. This makes sense for normal props. I included it because if you use it for children you most likely always require that the child is present and if you forget isRequired there it sucks. But you are right in that I should probably remove it and leave it up to the developer.\n. cc @fabiomcosta\n. Can you change this to setTimeout(() => callback(markup), 0) ? Add FB we disallow to use the third argument for setTimeout like this.\n. why are you not just using \"joinClasses\"?\n. Right, my initial version used a separate map to keep track of collisions but @sebmarkbage was heavily opposed because of perf implications - would it be reasonable to force contexts to provide a getResultMap function or something like that?\n. In flattenChildren I have no way to reassign the key.\n. you need syntheticEvent.nativeEvent\n. please pass keyArg.\n. done!\n. no, other than that I opened this file twice and updated one call at a time and honestly didn't realize that it was the same file :)\n. meh, that's no fun. Let me see what I can do.\n. yeah, this actually requires changing the codemod script as well to output the proper require statement.\nThen in npm-react-codemod you can run npm test to check if everything still works.\n. Fixing up the tests; must have been the jscodeshift update by @fkling that made things a little more strict.\nThe code in these tests is not run. It verifies whether the transform works correctly. The purpose of this is to transform React.createClass calls to ES6 classes and this transform is one part of it. If we are suggesting people to use a different way to require react-addons we should update this codemod to also spit out code like this.\n. Fixed here: https://github.com/facebook/react/pull/3821\n. wait, I thought this was a joke? In German, Sekret means secretion, so not exactly the word you are looking for here. Use \"Geheimnis\" instead.\n. jsdom is a little weird. Most fields are defined using Object.defineProperty with a getter only. In order to safely overwrite it, you need to use Object.defineProperty and set it's value to null. For forward compatibility with future jsdom updates I recommend doing that here.\n. ohhh.. right, it is from the engine. Let's see if this test will fail with newer versions of node! Don't you still use node 0.10 for jest right now? If yes, that doesn't have Symbol, does it?\n. this should also include babel's package.json and the path to the two babel plugins from above.\n. yeah I saw and removed my comment. Didn't know we had this config, this kinda sucks because the config is not very useful. The env setup script exposes both global and window to which you can attach globals.\n. yeah it should be the same.\n. if you turn fbjs into a haste package on www it'll work?\n. I don't see a problem with this? You guys should upgrade to jasmine2 so you can use the done feature of jasmine2 for async testing. Otherwise waitsFor is fine, just ugly API. You can also do jest.runAllTimers() to advance them manually \u2013 that way you can get rid of the waitsFor.\n@zpao \n. what kind of async? You can also do jest.runAllImmediates.\n. cc @zpao @gaearon I'm gonna ship this with --runInBand \u2013 it should avoid the failures on travis you guys have been seeing. Let me know if you have any trouble with this.\n. can you make it jest?\n. art is unmocked by default on www, so this should be fine.\n. Append ?w=1 to the pull request and it should hide them from the diff, at least :)\n. Is coveralls better than codecov? For Jest we now use Codecov and it comments on every PR with the coverage difference. It is nice.\n. That's not good. Would you mind opening an issue about this on Jest's bugtracker?\n. All I care about is the distinction that enzyme != Jest. Do you have a suggestion on how to improve the sentence? :)\n. Yes. It is gonna happen EOY or early H1 2017.\n. ",
    "marten": "@spicyj If I may answer for @matthewwithanm, since I just ran into the same issue, we still have some server-side rendered pages that we would like to open inside a modal dialog.\nI made a Dialog component that gets a URL via props, and on componentDidMount fetches HTML from the server, and renders it inside the dialog using dangerouslySetInnerHTML. I was quite surprised when I found out that the code inside the script tag that was also in the fetched HTML was not executed.\n. @syranide I guess I was just spoiled by jQuery and never realized that. I've already implemented this same behaviour myself, and it's for a layer that should be converted to actual React components anyway, so the workaround should disappear from our code at some point. It's not a big deal, just surprised me, but I guess it's just a lack of knowledge on my part.\n. ",
    "mhart": "I just ran into this - after a bit of hair-pulling tracked it down to using an array for children instead of just an argument list.\n``` js\nvar React = require('react')\nReact.renderComponentToString(React.createClass({\n  render: function() {\n    return React.DOM.div(null, [ // <-- emits warning\n      React.DOM.div(),\n      React.DOM.div()\n    ])\n  }\n})(), console.log)\n```\nRemoving the square brackets works fine and does not emit this warning.\nEdit: Sorry, should've clarified, I was specifically talking about: Each child in an array should have a unique \"key\" prop. Check the render method of undefined.\n. So @chenglou are you saying that you can only pass an array if each element has a key property?\nI would've thought it would be good if it still worked without this (ie, if passing an array had the same effect as passing a variable number of arguments)\n. Hmmm, a \"friendly\" warning? :-) Seems very extreme for a completely legitimate use case. Is there any way to turn it off? It appears in the node console as well, so completely spams server logs.\n. OK, so just clarifying, what @chenglou said was incorrect then? It's not legit at all.\nIn any case, I think the general point of this issue that the error messages could be a bit nicer probably stands. \"Check the render method of undefined\" is not all that helpful :-)\n. Looks like a likely culprit...\n. ",
    "steida": "@mhart Same here. If I pass array, something is broken. As I remember, it worked with old React.\n. If I pass array of children as second arg, I see \"Each child in an array should have a unique \"key\" prop.\" If I pass array of children as var params, I don't see that error message.\nTake a look at this line. https://github.com/steida/este-library/blob/master/este/react/react.coffee#L97\nNow it works. But I had to chang it from: factory.call @, [props].concat children ? []\nSo apply instead of call helped me.\n. Oh, so not a bug but feature. I know key property, thank you.\n. The heuristic pattern seems to be too heuristic for my case. This code\nshould be perfect valid, but I still see  \"Each child in an array should\nhave a unique \"key\" prop. Check the render method of undefined.\". It's\nbecause I am using arrays for all childrens.\nrender: function() {\n  return this.header([this.p('Some content')]);\n}\nOn Sun, Feb 9, 2014 at 5:04 PM, Sebastian Markb\u00e5ge <notifications@github.com\n\nwrote:\nI think the key (no pun intended) to debugging warnings is to highlight\nthem in the React Developer Tools. We could add that feature. That way you\nhave enough context to backtrack to the component that ultimately caused\nthe problem. Unfortunately, if you're lacking the displayName property,\nyou'll likely have less context in the React Developer Tools too.\nI'd highly recommend manually adding displayName to your components, if\nyou don't use JSX, to help with debugging.\n\nReply to this email directly or view it on GitHubhttps://github.com/facebook/react/issues/663#issuecomment-34593910\n.\n. I think this is tricky. https://github.com/JsCommunity/make-error/blob/master/index.js#L12\n\nMaybe I wrong, not sure.\n. ",
    "jhiswin": "May be related to this:\nhttps://github.com/facebook/react/pull/739\n. Hi, I've signed the CLA\n. I'm working with some HTML from the Dreamweaver MX days (yes, I know), and happened upon these attributes.  It is unfortunately littered throughout the HTML I have to work with, and even some recent HTML I've been handed.\nI noticed some other deprecated attributes were included in DefaultDomProperties, so I figured this would be good for inclusion too.\n(in the HTML4 spec, deprecated entirely in HTML5)\n\"align\" is technically not entirely deprecated* for:\nCOL, COLGROUP, TBODY, TD, TFOOT, TH, THEAD, TR\n\"bgColor\" is entirely deprecated, but is unfortunately used pretty often even now\n\"valign\" is another one that isn't quite so trivial to replace in many places and isn't deprecated*\n. ---\n*embed: Twice-cooked (object+embed) flash is used in a lot of places, including YouTube and Facebook video embedding examples/scripts.\nembed tag has been included in HTML5 and I suspect it was intentionally to allow usage of embed with Flash.  Most probably included due to the nuances of Flash video embedding and compatibility; it's easier to just use embed tags for video content.  Going forward, I think embed will continue to see usage until Flash is dropped entirely for video content.\nbgColor: Also notice all the major Flash embeds have bgcolor attached.\n*wmode helps get around some subtle problems with Flash.  If embed is to be included, I don't think it's a good idea not to include wmode\nThough honestly, it seems the best way to deal with Flash is to wrap it up in a magical black box and only allow the wizards to touch the box.  So really, you'd probably better off using dangerouslySetInnerHTML or SWFObject, rather than pushing it through React anyways.\n\nscrollTop/scrollLeft\nhttps://developer.mozilla.org/en-US/docs/Web/API/Element.scrollTop\nhttps://developer.mozilla.org/en-US/docs/Web/API/Element.scrollLeft\nIt's not usable as an attribute, which I guess explains why it is set to MUST_USE_PROPERTY in DefaultDomPropertyConfig\nIt looks like you guys have plans to add \"scroll-awareness\" to React?  I'm guessing scrollTop/scrollLeft are in preparation for that?\n\nsidenote:\nIs it possible to expose DefaultDomPropertyConfig to public injection?\nIt'd be nice to be able to create a shim that doesn't require recompiling/redistributing React.\n. JSX is not HTML.  You'll want to look at the HTML to JSX compiler.  http://facebook.github.io/react/html-jsx.html\nYou won't be able to generate doctypes or conditional comments with React.  This is technically impossible by design.  If you want functionality like this, you might consider creating a script or addon to html-jsx to generate a javascript (JSX) equivalent.\n. I guess you could use React.DOM.injection and modify the JSX transform to read <!doctype.\nPlain conditional comments could probably be done similarly.\n. @natew\nHow do you deal with void tags like <img> and <meta> right now?  Do you self-close them before embedding them?\nWould you use a tool like html-jsx to transform the html to syntax that the jsx transformer understands?\n. On second thought, I think I may have missed the point above.  Adding something like React.DOM._doctype would be useful, and would have very little impact on React's code.\nSame could probably be done with conditional comments (React.DOM._ConditionalCommentHide ,React.DOM._ConditionalCommentShow).  Inserting conditional comments using innerHTML might work?  I'm not sure how updating them will work though.\nI don't think there's a document for it (@Daniel15 )\nA few issues I've seen with the html-jsx transformer:\nstrips script  tags\nstrips html head body tags\n<style> tag content isn't transformed\nnamespaced attributes (xmlns:fb or data:myattr) don't work\nThere's a few issues with css styles and attribute case-sensitivity in another github issue.\nSince it uses the browser dom (you can use jsdom so you don't have to use a browser), all tags supported by browsers should work.  Has worked pretty well for me.\nhtml-jsx transformer does things like turn class -> className and style strings into objects and turn void tags (<img>) into self-closing tags (<img/>).\nI'm creating tools that transform user-provided html/data (as-is) into components, so I've had to make use it.\n. Just want to mention it works with jsdom as is:\n``` javascript\nvar fs = require(\"fs\");\nvar jsdom = require(\"jsdom\");\nvar htmljsx = fs.readFileSync(\"docs/js/html-jsx-lib.js\",\"utf-8\");\njsdom.env({\nurl:\"http://facebook.com/\",\nsrc: [htmljsx],\ndone: function(errors,window){\n      HTMLtoJSX = window.HTMLtoJSX;\n      var converter = new HTMLtoJSX({\n        outputClassName: \"MyClass\",\n        createClass: true\n      });\n      console.log(converter.convert(\"<!doctype html>\"));\n}\n});\n```\n. Hey while you're at it, I'd love to see the Handlebars-JSX converter and that nifty \"Reactify\" bookmarklet you were talking about ;)\nDefinitely a lot of possibilities with that code.\n. ",
    "newtriks": "Look forward to the PR and thanks, any docs on testing is welcomed.\n. ",
    "STRML": "I've separated out the addon JS into react-addons for easy inclusion into browserify projects. I was previously getting invariant violations when using react/addons in some parts of the app and react in others - this appears to fix it in a lightweight fashion. The version corresponds to React version the files were pulled from. \n. Am I missing something here? It appears execution still continues after the markup is created to this call, even on the server-side. \n. Wouldn't Infinity be a better magicnum? It can't be JSON-encoded, so we still get the XSS protection on browsers that don't support Symbols.\nIn fact, it would be a lot simpler in general, because we're running into a lot of issues with the use of Symbol here, such as #5138, and the above jsdom issues.\n. We want postMessage to work, right? In my testing, it actually does, since structured cloning supports much more advanced serialization than JSON.stringify().\nThis is confirmed in the w3c tests: https://github.com/w3c/web-platform-tests/blob/master/workers/interfaces/DedicatedWorkerGlobalScope/postMessage/structured-clone-message.html#L32\n. I would argue that if you're deliberately catching cross-origin postMessage and inserting objects directly into your views without validation, you're asking for it.\nThis would be nice for webworkers though, as Symbols don't transfer via structured cloning (so you'd have to explicitly catch elements and re-tag them).\n. ",
    "wincent": "It's signed.\n. Will update.\n. Will update.\n. Grammar nit: no comma before the \"and\".\n. \"built an\" \u2192 \"built a\"\n. s/PostgresQL/PostgreSQL/ here too.\n. \"schema building\" \u2192 \"schema-building\"\nAnd I think you want an \"and\" instead of a comma between the graphql-ruby and graphql-relay-ruby links.\n. \"auto-schema-regenerating\" perhaps?\n. ",
    "brainkim": "Off the top of my head there's also background: linear-gradient and fallback CSS3 colors (hex, rgb, rgba).\nOn Dec 27, 2013 4:27 AM, \"syranide\" notifications@github.com wrote:\n\n@brainkim Is this actually useful for anything besides cursor: grab? I\ndon't know of any other CSS property that has vendor prefixes inside of\nthem. If that's the case, then this specific issue could be solved by just\ndefining a custom CSS class and use that instead.\nHowever, it seems like vendor prefixes overall may need looking over in\nReact.\n\u2014\nReply to this email directly or view it on GitHub.\n. @benjamn Grah! I hadn't thought of that. That could be surprising behavior. As it currently stands though, you would do var style = { margin: '10px 20px' };, right? One thought I had while looking through the css source code was that it doesn't really make sense why React automatically appends 'px' to some numbers in the first place. I think it adds a lot of complexity for little payoff (I didn't even know React did this). The larger concern for me is that we are currently unable to specify a rule multiple times with the style object despite the fact that it's a common thing to do in css to provide greater cross-browser support.\n\nOn Fri, Dec 27, 2013 at 9:18 AM, Ben Newman notifications@github.comwrote:\n\nWhat about things like var style = { margin: [10, 20] }? This would\nexpand those to margin:10px;margin:20px, when the intent was probably to\nproduce margin:10px 20px;.\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/facebook/react/pull/723#issuecomment-31261719\n.\n. @vjeux I like this suggestion. I just looked it up and CSS.supports is a thing (not supported in IE/Safari but shimmable). But at the same time I feel like using an array to specify fallbacks conveys intent much more clearly than delegating to a function, especially considering the fact that the style object maps perfectly to a style string otherwise. I know there's always css classes, but sometimes I feel like a css rule is essential to a component, as in the cursor: grab case. I dunno. You're the judge, jury, and executioner. :muscle:\n\n@petehunt I agree. Who actually wants to keep track of vendor prefixes?\n. You know what? Go for it. I just love that you guys are full-on adopting commonjs.\n. ",
    "martinffx": "Eish! Silly error. I had /** @jsx React.Dom */ instead of /** @jsx React.DOM */\nChanging that sorted out the error.\n. ",
    "ivan": "Already signed as ivan@ludios.org, github username ivan\n. Thanks, fixed\n. ",
    "prabirshrestha": "Bumped into nested two way bindings when try to deal with forms. Found one implementation at stackoverflow. http://stackoverflow.com/questions/21057219/react-js-2-way-bindings-two-levels-deep-path-in-valuelink/21058282#21058282\n. ",
    "andreaferretti": "+1 for returning the array in each case. A rather insignificant performance optimization should not be the basis for making an inconsistent API. It is just confusing and will byte every beginner user of the library (and even some more expert ones) for no good reason\n. ",
    "swannodette": "Just to clarify, so the idea is that we can still set children to a function and then call onlyChild to get it?\n. Currently we are using the 2nd argument to component constructors, however we can easily switch to doing this via props.children. If this works, then I'm fine with closing this one. Thanks all!\n. I haven't had a chance to verify myself but according to an Om user this issue is still not fixed. https://github.com/swannodette/om/issues/47, they tested with a recent React commit https://github.com/facebook/react/commit/49747347fb4329184371f93756437ac664633b76\n. ",
    "pspeter3": "@fdecampredon Thanks for the work that you did on that!\n. ",
    "martynsmith": "This would be a very cool feature to have added (I'm experiencing exactly this problem at the moment).\n. ",
    "percyhanna": "If adding support for <Foo[\"Bar\"].Baz />, will it indirectly add support for any valid JS identifier/expression? e.g. <Foo[myVar] />?\n. Closing in favour of proposed fix in #760.\n. ",
    "nullobject": "Nice work :+1: \n. Anybody working on this? I'd be keen to implement the filter tag.\n. @zpao Sure thing, I'll switch it to the patternContentUnits property only.\n. @zpao You mentioned to \"also not[e] in that other PR that there are 2 places that need to be updated\".\nPerhaps my understanding of how DOMAttributeNames is used is totally wrong :wink: but the patternContentUnits attribute is not valid on the <svg> element, so why would I need to define it in the DOMAttributeNames? This could also be incorrect in #1548.\n. @zpao Thanks for the explanation.\nI did indeed try my build in Safari, so I assume it mustn't be too fussy about case on the <pattern> attributes. Anyhow, I've updated my PR to include contentPatternUnits in the DOMAttributeNames. Yay!\n. @zpao My pleasure, thanks for the awesome framework :wink:\n. ",
    "dhruvbhatia": "The above links are helpful, thanks for sharing.\nIt would be great to see a full blown example of React + D3 + D3 events (such as tooltips on hover), as all current examples I've found appear to just be for static outputs (no event handlers).\n. ",
    "sudodoki": "\nthe original bug of \"detail isn't useful on scroll events\" was invalid.\n\nSorry, in what way was it invalid?\n. ",
    "xixixao": "@zpao It's sauce-tunnel. It's a wrapped jar (WAT). I can only think of removing it from package.json and adding npm install before the task where its actually used. But it's not a great solution.\n. That's probably true. For inline styles, I have actually went with a simpler solution that fit my particular use case (I didn't care about the finishing of the transition). ~~That said, I can imagine the transition part could be abstracted away from the CSS class handling (now mixed inside the ReactTransitionChild)~~ I take that back, the event is probably enough.\n``` coffee\nhyper class TransitionContainer\ncomponentWillReceiveProps: (nextProps) ->\n    if !nextProps.children && @props.children\n      @savedChildren = @props.children\n      @savedStyle = @props.on\nrender: ->\n    style =\n      if @props.children\n        @props.on\n      else\n        Object.merge @savedStyle, @props.off\ncomponent = @props.component || _span\n\ncomponent style: style,\n  @props.children || this.savedChildren\n\n``\n. No idea, this was just an example implementation.\n.'Tried to merge an object, got %s instead.',`\nSo that it is clear what the got means? Same above.\n. Unfortunately I don't see a way to trigger a possible update without doing this (forceUpdate won't call shouldUpdateComponent), but it would be better if there was, as passing null into setState can often be an error.\n. ",
    "tomocchino": "Yep, Superseded by #829. Thanks @spicyj and @xixixao!\n. Nit: can you store these as local variables at the top to make this code pretty again? :)\nallowFullScreen: MustUseAttribute | HasBooleanValue,\n. nit: Worker is capitalized here but not below \n. Can you put the command in back ticks like the others?. Skip this section if you've done this before.*. I'd be happy to. Should we set a NODE_ENV = 'build' when we're building or something?. Ah, damn.. sorry about that. I just alpha sorted the block without realizing it wasn't a require. I'll put it back and add a newline.. Oh, duh.. @spicyj, what happens when child is passed in as an array (in a post-fiber world). Was this before we thought about fragments, since your original diff was from over a year ago? :P . cc @spicyj again. We don't have the stacks in the server renderer so Ben told me to just remove these, but I'd be fine with trying to figure out how to add them back.. ",
    "mtharrison": "Sorry, I should've grep'd the project for all these instances. Updated now.\n. ",
    "andrewdavey": "The above commit generates inline source maps instead of files. So it should work well with Browserify.\n. I think browserify only works with inline source maps.\n. ",
    "wereHamster": "React has bigger issues than that when its combined with Polymer. One seems to be because Polymer wraps all DOM elements and events in a wrapper (to polyfill deficiencies of the underlying browser), and that seems to throw React off. I had to explicitly unwrap the DOM element which is passed to React.renderComponent(). And event handlers aren't automatically attached, I had to do them manually in componentDidMount. See https://gist.github.com/wereHamster/b5f36db9e15558ada718.\n. I figured out the problem with wrapped nodes. React creates a dummy node when the script is loaded. Because that did happen before polymer has been able to fully initialize itself, the dummy node was a browser native element. Later when react created DOM nodes through that dummy node, those elements were browser native as well, and polymer didn't like that. Now I load the reactjs script after 'WebComponentsReady' has been fired.\nHowever, that only fixed one problem, the events still don't bind properly. I'll have a look where the handler is being registered. Thanks for the pointer.\n. Unfortunately no. The shadowRoot property is the ShadowRoot that is being rendered inside of the element, not the one the element is inside of.\nI'm not aware of any more efficient way to determine in which ShadowRoot (if any) a given element is. But I also haven't investigated deeply.\n. ",
    "hariharan-uno": "Done :)\n. ",
    "matthewwithanm": "Alright, I dug into the source today to see what was going on. This isn't a bug with TransitionGroup (all of the classes are being applied correctly) but a bug in the CSS. (In other words, my fault!)\nHowever, I do think it highlights a problem with the current animation approach. Let me back up a little to explain why:\nThe reason that my fiddle doesn't work as I (incorrectly) expected is because the starting value of my transform-origin doesn't match the default value of the element. In addition, the transition specifies that that property should be animated (since it uses \"all\"). So when the \"-leave\" class is added, the origin is animated to the \"starting\" value (right center).\nIn other words, it's not currently possible to specify a starting point for a leave animation that doesn't match the default value. Of course, I could set the transform-origin for every element that uses the transition but that's clearly brittle and difficult to maintain.\nOne possible solution would be for React to add an idle class when the transition is idle. Alternatively, users could put the transition property in the \"-active\" classes instead, but I think that has the potential to screw up switching from enter to leave before enter has completed (or vise versa). (Then again, I'm not sure that's working anyway.)\nI realize that this behavior is all taken from ngAnimate, so maybe this isn't the best place to discuss the issue. On the other hand, the React project is much younger and there's probably more of an opportunity to correct it here without worrying about legacy. Let me know!\n. Now that we have renderComponentToStaticMarkup, maybe the best solution for this is just to do:\n<noscript dangerouslySetInnerHTML={{__html: React.renderComponentToStaticMarkup(c)}} />\nwhere c is the component you want to render for people without JS.\n. Sure. I'll try to get a PR in soon.\n. Hm\u2026it seems like <noscript> is a different beast in IE8. For example, trying to set its innerHTML just causes an error. This is a problem: if you write a component that uses <noscript> (in order to leverage server side rendering), it will error when React tries to mount it.\nI'm not exactly sure how best to get around this. I supposed we could sidestep the issue by telling it not to render any contents when mounting into the DOM, but I'm not sure how best to recognize that. Thoughts?\n. Wait, what am I saying? Then it wouldn't match what the server sent down!\n. No, unfortunately. It doesn't seem like the problem is just modifying a noscript but even creating one in the first place. It doesn't seem to be possible to create a noscript element with contents in that browser.\njavascript\nvar div = document.createElement('div');\ndiv.innerHTML = '<noscript>hi</noscript>';\nconsole.log(div.innerHTML); // undefined\nAlso, modification via appendChild\njavascript\nvar noscript = document.createElement('noscript');\nvar span = document.createElement('span');\nspan.innerHTML = 'hi';\nnoscript.appendChild(span);\n// Error: \"Unexpected call to method or property access.\"\n. I guess it technically makes sense for a postive-value attribute to be minimizable, but AFAIK there aren't any attributes that actually behave this way, so I think your suggestion makes the most sense. I made the change in b58e69a.\n. Hahaha np\nNew commit pushed.\n. ",
    "carlmw": "Would love to see this land :+1: \n. ",
    "radebrecht": "re: the-kenny\nI agree, full svg support would be even better. Unfortunately I haven't got the time. \nxlink:href works well in the example below. I'm not too clear on the whole namespace thing, do you have an example where my patch fails?\n``` js\nvar Symbols=React.createClass({\n    render: function(){\n        return \n\n\n\n;\n    }\n});\nvar SvgArea=React.createClass({\n    render: function() {\n        return (\n Symbol Test \n\n\n\n               );\n    }\n});\n```\n. ",
    "steveluscher": "I haven't put a ton of thought into this, but the other day I did find myself wondering how I could specify a whitelist/blacklist of props:\nthis.transferPropsTo(<a href=\"\u2026\">\u2026</a>, { only: ['onClick', 'onHover'] })\nthis.transferPropsTo(<a href=\"\u2026\">\u2026</a>, { except: [ \u2026 ] })\n. Oh yeah, @spicyj. This speeds up first-render enormously. :+1:\n. Do you mean to clarify that it was physically at Facebook? I'll change it to \u201cFacebook HQ\u201d\u00a0\u2013 that should do it.\n. For a while, I thought that this function was supposed to be getInitialValue until I read the implementation. Now I understand that you're handling this case.\n\nGet the initial value for state\nWait to mount\nValue changed while you were waiting to mount\nSubscribe\nThe subscription isn't going to vend you the changed value, so you getValue while subscribing.\n\nI'm worried people might do this, though I don't know what to do about it.\n```\nconst Subscription = createSubscription({\n  getValue(source) {\n    return SomeConfig.initialValue;\n  },\n  subscribe(source, callback) {\n    const {dispose} = source.listen(value => callback(value));\n    return dispose;\n  },\n});\n\n  ...\n\n```\n\u2026where the source isn't something that offers a way to read the value synchronously.. Maybe move this above the part where you make the subscription? That way, in the rare case that a subscription resolves synchronously the first time, you get this behavior:\n\ngetValue which might potentially be related to a stale/clowny implementation like the one I mentioned above.\nPerform the subscription, which might resolve sync and clobber the value in step 1.. \n",
    "jbaiter": "\nCan you also sign the CLA? We'll need that before we can merge.\n\nDone\n. Do the tests fail for you as well? All of the suites pass just fine on my local machine, even with a clean clone of the branch. Looks like the one test only fails on Travis....\n. > It looks like if you use both checkedLink and valueLink you're gonna have a bad time. Can we invariant() that if a checkedLink is present you cannot provide a valueLink?\nOf course :+1: \n\nAlso, does this mean that onChange() is ambiguous? What's changing, checked or value?\n\nKind of, it depends on the type of the input, checked for \"checkbox\", value for everything else.\nIs that a problem? If I read the HTML spec for checkboxes correctly, value is not intended to be changed and all other inputs[1]  do not make use of the checked attribute, so it would be unambiguous.\nAlso, changing a checkboxes 'checked' attribute fires a change event in the browser, so keeping the name onChange would be in line with the spec.\n[1] except radiobox, but everything that applies to checkboxes should apply to them as well\n. ",
    "rtfeldman": "@zpao You're probably right. I missed the call-out when I read the docs the first time because es5-shim and es5-sham are only one character off, so I mistook that separate note as a second mention of es5-shim.js. Based on my Googling after I got IE8 errors, I'm not the first one to mistakenly think only es5-shim was needed.\nThoughts on my just adding a sentence making it clear that in order for React to work with IE8, you need both es5-shim and es5-sham? That's the real pain point I'm trying to prevent others from encountering.\n. Love it! Anyone else have thoughts on this?\n. Done and done!\n. @zpao Thanks! Looks good to me.\n. Nice catch! Fixed in https://github.com/rtfeldman/react/commit/f62ec225e09944d9e2c04cf1bfe97ded1f41c90d\n. ",
    "maxhauser": "Thanks!\n. ",
    "martin-g": "It works fine with: React.renderComponent(<Stuff />, document.documentElement);\n. ",
    "andrezsanchez": "I'm pretty sure you have to use document.  React-page looks like it's doing it on document as well.\nAs an analogy, when you mount a <div> inside of <body>, you use document.body, which mounts it inside of body, not on top of <body>.  So unless it's a sort of quirk that I'm not familiar with, it makes sense to me to mount on document if I want to replace <html>.\nIf you use document.documentElement in the fiddle and look at the html element, you'll notice it doesn't have a data-reactid.\nWhat I'm trying to do is render the whole thing server-side and then hook in on the client side, but I'm having trouble because of this issue.  I think that since it doesn't actually replace <html> if I use document.documentElement, the checksum is different and React gives me the differing checksum warning.\n. ",
    "svnlto": ":+1: for shutting down comments\n. ",
    "Frozenlock": "I don't know if this PR still has a future, but I would really like a complete support of SVG!\n. ",
    "brycekahle": "@ericflo If you want to help with the tasks outlined in this PR, I would welcome patches to my fork to finish this off.\n. Properties preserve the name, but attributes will get lowercased. SVG attributes are case-sensitive.\n. I created a branch that uses flags for naming rules instead of a static map, since that gets built anyways when the config is parsed. Check it out here https://github.com/brycekahle/react/commit/eaa28c9868cc773edf47838b959f24a347ea031b\n. ",
    "seidtgeist": "\nI wonder if some people don't want their stuff inspectable in prod.\n\nProbably not if it potentially impacts performance or breaks sites in any way. I remember angular's batarang extension in Chrome Stable crashing our own production website reproducibly (it still happens). That should not happen, ever.\n. ",
    "bobeagan": "I've done that already\n. ",
    "yanns": "Is there any workaround at the moment?\n. @MattKunze which version do you use?\nStill no improvement for me, quite a blocker...\n. @zpao I cannot modify my installed react package, as I cannot install react at all.\n. ",
    "MattKunze": "The chance of an official 0.8.1 version or similar that does this is... greater than zero? :)\n. nm - this has started working for me at least, the upstream version issue with esprima must have changed\n. My guess is that is an issue that has been around for quite a while (interesting timing that I ran into the same thing for a different context this morning):\nhttp://www.quirksmode.org/blog/archives/2010/10/click_event_del_1.html\nhttp://stackoverflow.com/questions/7358781/tapping-on-label-in-mobile-safari\nYou'll see a bunch of workarounds that add empty handlers when the page loads to address this ($('label').click(function() {});)\nDoesn't seem like React's problem to fix - either add 'cursor: pointer' or empty event handlers where it causes an issue.\n. Is that plug-in registered automatically, or do you have to do something to enable it?\nI can confirm that the original jsfiddle posted above isn't working for me on iOS\n. Adding\njavascript\n    componentDidMount: function() {\n      this.getDOMNode().onclick = function() {}\n    }\nto the component is a workaround. It seems like the plugin is not working at the moment\n. ",
    "ying22": "I have the same issue. \n. ",
    "bripkens": "Would you like me to update my PR accordingly, i.e. change the API to synchronous, or do you wish to wait with this (breaking) change? Would love to help you out here.\n. @petehunt PR updated. API is no synchronous and provides some guidance for migrations.\n. Sure thing, here you go. The word \"internal\" might imply that it is not, but is this typechecker available somewhere? You made me curious ;-).\n. Ah, just noticed that you are not linting your tests (which is why I didn't see these warnings). Added use strict for these two files.\n. Got it. Also added the new lines ;-).\n. I didn't mean to restrict the server side rendering to node.js. For instance, I am currently trying to make this work on the JVM where process.nextTick is not available.\n. The semantic difference between process.nextTick and setTimeout seems negligible in this case (while it might not be for edge cases). I would therefore argue that compatibility is more important than Node conventions (especially considering that renderComponentToString is part of React's default distribution and not part of some server side add-on).\nAnyhow, let's wait until the core team has made up their mind w.r.t. asynchronous rendering in general :-).\n. ",
    "bronson": "This is the rendered version: https://facebook.github.io/react/docs/update.html\nNot as easy as setStateDeep might have been but I guess it's the best we can get.\n. ",
    "johnthethird": "+1 \nI am working on server-rendering code for Rails and caching the resulting markup is not really possible with the current random IDs polluting things.\n. ",
    "RReverser": "@petehunt, could you open the link? Any thoughts on this?\n. Yeah, I didn't rename files since it wasn't the most interesting important part so you could firstly have look and make decision before I make final cosmetic changes like this.\n. Ok, let me know when you want to merge this again, so we could resolve merge issues if any.\n. Right, gonna fix that.\n. Common practice for handling UTF-8. decodeURIComponent + encodeURIComponent composed would give identity function:\n```\n\nbtoa(decodeURIComponent(encodeURIComponent('\u044b')))\n[Exception... \"String contains an invalid character\"  code: \"5\" nsresult: \"0x80530005 (InvalidCharacterError)\"  location: \"\"]\nbtoa(unescape(encodeURIComponent('\u044b')))\n\"0Ys=\"\n```\n\nMore details are here: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Base64_encoding_and_decoding#The_.22Unicode_Problem.22\n. Yep, that's actually what we want and with config as before this change we could get some errors as _.merge by default works with array as with object replacing items by indexes so _.merge([1,2], [4]) => [4,2]. In commonjs config, we rather want handling array of parameters (i.e. files) to override previous one, just like with primitive values.\n. Maybe, I don't see much difference.\n. Ok, I can change that easily.\n. Done in 3f3187c.\n. Done in 3f3187c.\n. Done in 3f3187c.\n. Changed in 3f3187c.\n. I use globalObj = (function () { return this })() as cross-platform variant, returns global object in Node.js modules and window object in the browser.\n. You're right. In that case, since bundled file is usually already wrapped into kind of wrapper function (UMD or other; you're not setting strict mode globally anyway, right?), you can set this function to strict mode and pass global object from outside for any internal use:\njavascript\n(function (global) {\n    'use strict';\n    // ... all the real code goes here ...\n})((function () { return this })());\nor\njavascript\n(function (factory) {\n    // your UMD or other wrapper\n    factory(this);\n}(function (global) {\n    'use strict';\n    // ... all the real code goes here ...\n});\n. What it basically says is \"if there're no other changed files but docs/examples, immediately exit\".\n. @zpao Does this answer your question?\n. @gaearon o is not valid hex char :P\n. You need to use ModuleKind, not a string now: https://github.com/Microsoft/TypeScript/blob/master/src/compiler/types.ts#L2456 + https://github.com/Microsoft/TypeScript/blob/master/src/compiler/types.ts#L2535-L2543\n. ",
    "nadeesha": "Done. Thanks!\n. ",
    "natew": "I can see a good reason for leaving out these portions of the HTML spec.  I ended up adding on to this branch of react-app-middleware some changes to allow pulling in a static HTML template initially and then rendering components results into it.\nSee an example of it being used in this repo (see server.js).\n. I think a good reason against is that React is used by many as a client side library, and therefore should be kept as light as possible.\nPerhaps there could be an extension made that implements the \"rest\" of the HTML5 spec, but could be mixed in only on the server side as client's shouldn't need to render stuff like doctype once the server has.\n. I have images working like this: <img src={this.imagePath + image.thumb} /> with no problems.\nI have played with the html to jsx transformer thats on React's site currently, but haven't needed it yet personally. Is there a document that outlines all the supported tags? I haven't checked, but I also haven't gotten too deep into things yet.\nEdit: As for the self-closing, yea I've always felt more accustomed to using them anyway.\n. Comments will be interesting because the typical setup is to have a number of them all in a row, without a closing tag. Not sure the syntax or tricks you'd have to do to build a root level component that has all the opening tags in conditionals.\n. ",
    "zackify": "@petehunt I agree with you but I also think it's not really that practical to render full pages inside of react. \n. Oh, you have to capitalize the T in type though, which is a little annoying.\n. It would help if react's map function converted it for you the way that underscore does it, because this way, it doesn't convert nested elements.\n. Ah, okay I thought that may have been the case. Would be useful though. Thanks for the info.\n. ",
    "skv-headless": "awesome\n. ",
    "gassorr": "Ok, but when I target event.target, it selects the clicked element, but it wont remove it with the React.unmountComponentAtNode(event.target)\nHowever it works when I put a reference to an element before rendering it, so, I'm reusing the initial variable that stored the element, which I used for renderComponent.\nAlso, unmountComponentAtNode(this.getDOMNode()) returns false, while it consoles out the same as the one selected through document.getElementById\nOr is it because of the VM?\n. Ok, that might be a better solution for my situation, however, I'm still curious as to when a selector will work, not necessarily to remove them, but to have a reference to its own DOM object (note that these different selectors might point to different elements, but as far as I know are of the same type?)\nhttp://jsfiddle.net/TrySpace/JRy7W/7/\nAnd in your last example, how would I hide (or reference) the whole div, instead of just the {message}\n. ",
    "thechriswalker": "Beat me to it... Thanks!\n. ",
    "jbonta": "I'm switching it back (D1174395), but regardless, this is an innerText issue. Browsers that don't have textcontent (ie8) suffer\n. looks like this was brought up in #923\n. okay interesting. I'll do this for ie8\n. hmm interesting. We definitely want to preserve whitespace though. (because of <pre > and white-space:pre and <textarea>)\n. why not set innerHTML to '' ?\n. let's use getTextContentAccessor here. Then only do this createTextNode business for the innerText case. It'll perform better.\n. hmm yeah, I intentionally avoided saying this.props because I was afraid of that too. But I was hoping to mention props because I wanted to hammer home those two things making your component pure. How about \"By default, when your component's state or props change, your component will re-render.\"?\nOr would you prefer to kill that first sentence and s/these/state?\n. ",
    "fattenap": "Hi spicyj,\nYes, this is still an issue, as I have been using master. The code you show doesn't cause the issue.\nThanks\n. Sorry spicyj. I thought I was using master but I am mistaken. I'll get master and re test.\nThanks\n. Yep that fixes it. Thanks.\n. ",
    "dlindahl": "I am still seeing this error even on 0.9 with select and checkbox inputs. The catch is that the component is rendered inside an unwrapped Polymer element (unwrap(el))\nI am not sure if this is a bug with React or not, but it is entirely unclear to me how to resolve the problem.\nCan anyone help nudge me in the right direction?\n. @spicyj Done: #1263\n. After some additional toying with Polymer + React, I ran into the same bug with a more straightforward example: http://jsbin.com/xoxip/2/\nIn this JSBin, the React component simply toggles a CSS class when the state changes due to a mouse click.\nThe CSS class is added properly on the first click, but when toggled off, removing the CSS class throws the same Two valid but unequal error.\n. Let me rephrase, I am sure that the error is as explicit as it can be. But for someone that is not intimately familiar with what React is trying to do, its like running into a brick wall. :smile:\nBut that is besides the point, the issue isn't with the error messaging. \nIt sounds like this may be an issue with Polymer's ShadowDOM polyfill. I tried playing with it a bit more and I believe I was able to get it to work by not unwrap-ing the Light DOM node that the React component is rendered into:\nhttp://jsbin.com/xoxip/3/\nIt sounds like Polymer's wrap function wraps the DOM Api with its own methods for interacting with the Shadow- and LightDOM. Since React is using appendChild somewhere, and I was unwrap-ing the root element, it sounds like Polymer and React disagreed about what the tree should look like. Removing the explicit unwrap exposes Polymer's version of appendChild to React and then it starts playing nicely again.\nThe curious thing is why I felt it necessary to add the unwrap in the first place... I am pretty sure that React was complaining about the Light DOM node not being of the right NODE_TYPE, but I made a couple changes to my rendering loop in the meantime which may have eliminated that issue...\nThank you to both of you for looking into this. Since the JSBin seems to be working now as well as my application, I am going to go ahead and close this and hope that we've all learned something new.\n. @arv I was indeed getting wrapped nodes, but I ran into an issue when rendering a React component inside one of them. My solution at the time was to unwrap the polyfilled node reference and use that with React. That seemed to fix the problem initially, but then I ran into this issue.\nTurns out that passing the unwrapped node to React was a bad idea and it works fine without doing that. I think the root cause of my initial issue was due to a misuse of the React rendering API. I believe I was calling renderComponent for each upstream update instead of using setProps. \nSo all in all, everything actually works just fine :smile:\nNow if I can only figure out if its possible to use React to render Polymer elements...\n. @arv Since the errors caused by not including platform.js first can be dramatic and confusing, could you make the note in the Polymer docs a bit more assertive?\nSince this is no longer an issue, I'm closing this issue.\n. ",
    "mattmccray": "On a related note, I'm wondering... When making a custom control that needs to properly support onChange event bubbling, is there any good reason not to use:\njavascript\nvar node= this.refs.control.getDOMNode(),\n    fakeEvent= { target:node }\nReact.addons.TestUtils.Simulate.change( node, fakeEvent )\nOr if there's no actual input element to propagate as the target, maybe:\njavascript\nvar node= this.getDOMNode(),\n    fakeEvent= { target:{ name:this.props.name, value:\"NEWVALUE\" } }\nReact.addons.TestUtils.Simulate.change( node, fakeEvent )\n. ",
    "stevoland": "Forget it, Ive moved them to https://github.com/react-bootstrap and I don't want to have to ask Bower to redirect the repo again. Cheers\n. ",
    "sgrove": "That's great, happy to send the PR later this week. Thanks @syranide, appreciate the speedy response!\n. ",
    "forresto": "In Firefox, this bug also makes a TypeError: setting a property that has only a getter error, which can crash things and be hard to find.\nHere's a reduced case, with bug: http://jsbin.com/vudab/1/edit\nwith hack fix: http://jsbin.com/vudab/2/edit\n. ",
    "shauntrennery": "Just signed the CLA, thank you.\n. Thanks @spicyj, I've updated it to:\nthis.context on components is now reserved for internal use by React\n. Done. Sorry for the obvious omission. \n. ",
    "totty90": "Yes, that was it.\nThe component was rendered when added the first time and when was replaced and added again messed up all the stuff. Maybe react.js shouldn't allow to do it?\nthanks for your time ;)\n. No problem, thanks for support and your time (:\nOn Thu, Feb 20, 2014 at 5:02 PM, Paul O\u2019Shannessy\nnotifications@github.comwrote:\n\nClosed #1142 https://github.com/facebook/react/issues/1142.\n\u2014\nReply to this email directly or view it on GitHubhttps://github.com/facebook/react/issues/1142\n.\n\n\nMelhores cumprimentos,\nWebDesignPorto.com\n. ",
    "preflight": "Commoner here. :-) Happy to scale back as you advise, but other than wrapping my components with AMD I can't think of anything I'm doing that's outside the playbook.\n. Ahh thanks for clarifying; was probably accurate the way I read it too, relatively speaking at least. BTW thanks for answering all my recent questions on Stack -- helped a ton with my first React app.\n. Here's the content of my question on Stack Overflow. Since it's (possibly) a bug I've flagged the question for removal.\n\nI'm trying to precompile my React JSX files with:\njsx --watch dev/js/ public/js/\nI have the non-minified react.js file (0.9.0) in the subdirectory dev/js/lib. When it compiles, the React source becomes public/AutoFocusMixin.js. Along with being renamed, the source is \"moved\" to the parent directory.\nThis only happens when I use the non-minified version of React. The compiled file is not minified. I'm using the non-minified source for debugging.\nI had a similar problem with version 0.8.0 -- but instead of being named AutoFocusMixin, the resulting file was named $.js and was also in the parent directory.\nMy solution was to manually copy the non-minified source to the correct location.\nHas anyone come up with a better solution for this or see what I'm doing wrong?\n\nI assume this is the offending code in the React source (below). I see what it does but am unclear of its purpose. I confirmed the file I'm using is the React core without add-ons.\n```\nvar AutoFocusMixin = {\n  componentDidMount: function() {\n    if (this.props.autoFocus) {\n      this.getDOMNode().focus();\n    }\n  }\n};\nmodule.exports = AutoFocusMixin;\n```\n. ",
    "ghost": "Here an extract of my solution for this issue:\n```javascript\nexport default class Input extends Component {\n  static propTypes = {\n    value: PropTypes.string,\n    onFieldChange: PropTypes.func,\n  };\nstatic defaultProps = {\n    value: '',\n  }\ncomponentDidMount() {\n    this._listener = setInterval(() => {\n      if (!this.input || this._previousValue === this.input.value) {\n        return;\n      }\n  this._previousValue = this.input.value;\n\n  const evt = document.createEvent('HTMLEvents');\n  evt.initEvent('input', true, true);\n  this.input.dispatchEvent(evt);\n}, 20);\n\n}\ncomponentWillUnmount() {\n    clearInterval(this._listener);\n  }\nrefInput = (input) => this.input = input;\nrender() {\n    const { label,\n      value,\n      onFieldChange,\n    } = this.props;\nthis.input = this.input || { value };\n\nreturn (\n    <input\n        value={this.input.value}\n        onChange={onFieldChange}\n        ref={this.refInput}\n    />\n);\n\n}\n}\n``\nNOTE:valuecomes from the state andonFieldChange` updates the state with the new value\nThe setInterval code is from the https://github.com/Pephers/react-autofill. Hi, would love a status update on this, any targeted fix version or date?\n. KhanAcademy Then FB? WOAH\n. Just bringing in the reason it's a problem from my closed duplicate - when a link has an empty href it still takes focus. I can kind of sort out the style problems with extra css but it'll still get focus as you tab the focus through the controls on the page.\n. This has been solved its called stream check out react stream.\nOn Thursday, November 3, 2016, Florian Krauthan notifications@github.com\nwrote:\n\nI also think it would be very important to be able to load data within\ncomponents and have some sort of lazy render method. Maybe to make both\nsides happy create a new method called asyncRenderToString and add a new\n\"lifecycle\" event called asyncOnLoad or something like that. This will\nonly be called if you call a asyncRender method. In terms of code\nduplication between server and client side this can be fixed by developers\nof just moving common loading code into a separate method and call that\nmethod from asyncOnLoad and componentMount. Detecting if asyncOnLoad is\ndone should probably use a returned Promise (if undefined is\nreturned/method not defined it should directly call the applicable\nlifecycle events and then render) otherwise it waits until the promise\nresolves.\nI think a solution like that would solve all the hacky ways we have to use\nat the moment for proper server side rendering. Including for example allow\neasy server side rendering of react applications with react router v4\n(which not longer uses a centralized route config which is right now the\nonly way to get isomorphic applications working)\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/facebook/react/issues/1739#issuecomment-258198533,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/ATnWLUIEJw4m1Y3A4oGDOBzP6_ajDcqIks5q6g4_gaJpZM4CHAWq\n.\n. So when will be introduced es6 classes support? Thx for the answer.\n. Ok, thx)\n. Ok. Thx!\n. You are correct. But I'm wondering if it is possible to reconcile the difference in behavior between IE8 and modern browsers.\n. It is worth noting that I'm able to capture the event like this:\n\njs\ncomponentDidMount: function () {\n    var input = this.refs.input.getDOMNode();\n    input.attachEvent('onchange', function () {\n        alert('input changed');\n    });\n},\nhttp://jsfiddle.net/5f0ujc8m/1/\n. Apparently the onchange doesn't trigger until the file input loses focus in IE<9. There's nothing react can/should do to fix this. Closing\n. I'm using contexts as a way of managing store references. I like this because I can explicitly define what stores are required, so \n 1) I can mock out sample data in just the stores I need to test a component, avoiding having to instantiate my larger framework, and\n 2) pass in simple read-only stores with the known data for server-side rendering, which simplifies the server-side case as the bulk of the application code is not used.\nSo, looking at an example,\nWith my implementation, store data is accessed only through getters. My elements do not cache store data. I want a single version of the truth. As a simple non-async example, my render() would typically have something like\njavascript\nvar peopleStore = this.context.peopleStore;\nvar person = peopleStore.get(this.props.personId);\nreturn <div>person.fullName</div>;\nComponents attach listeners to stores. I haven't fully decided on the granularity. Stores all have an onChange event. However, I haven't decided on two other things,\n1) listeners for individual property changes\n2) if stores should contain stores\nIn this example, if \"people\" was \"fb users\", it's a large complex async store. Should I reuse the store structure for a PersonStore? One for general collection (getFriends, getPerson, etc) but many unique instances of the Person store type for an individual person.\nSo in my example, my Component requires the People store as a context param. Then it uses the personId prop to identify and subscribe to a specific Person store.\nNow, to introduce some dynamic changes. Let's say the currently logged in user logs out and someone else logs in. Ignoring the fact that you'd probably redirect/refresh the page in a real application, how would this element update? Let's also assume that this element is still on the page and isn't just destroyed.\nI would expect the application logic to first remove/destroy the existing People store. For that, my component needs to stop listening for updates. For this, I would recommend a ReactClass API. Eg,\nonContextChange(prev, new)\nThe element can then compare the two peopleStore instances. Let's ignore public data and assume the new PeopleStore is null. The element would unsubscribe from the previous Store and trigger a render(). The render would then show some 'user unknown' type message.\nWhen the user logs in as another user, a new Store is created, the element reattaches, and render() does its thing with new data.\nBehind the scenes, \"this.render()\" couldn't be synchronous. For any of my design/example to make any sense at all, the render() calls need to be collected by the framework and batched together.\nUnlike props, listening to stores is outside of the core React role of managing the rendering. That's why I don't think a context change should be involved in shouldComponentUpdate(). And despite my example including changing context values (a new store object), I don't think stores are going to be immutable in their high-level nature. I think that a typical flux application design will operate with a subscriber model, callbacks for async, etc. The base store object will usually live for the life of the application.\n. I also want to add one more question. I have something like this.\n```\nvar BlogPosts = React.createClass({\n  getChildContext: function() {\n    return {\n      currentBlogPost: this.props.currentBlogPost,\n      currentUser: this.props.currentUser\n    };\n  },\nchildContextTypes: {\n    currentBlogPost: React.PropTypes.object,\n    currentUser: React.PropTypes.object\n  },\nrender: function() {\n    return \n  }\n});\nfunction select(state) {\n  const { blogPosts, currentUser, currentBlogId } = state;\n  console.log( state.blogs[currentBlogId]); \n  // first time the above is undefined and then blogs get populated and I have the object;\n  return { blogPosts, currentUser, currentBlogPost: state.blogs[currentBlogId] };\n};\nexport default connect(select)(BlogPosts);\n```\nnow in the BlogPosts component there is BlogPostText , BlogPostImage, PodCast ...depending on whether blogPosts[index].type is text, image, or audio.\nin one of the components I have checked for the owner like this,\nvar BlogPostText = React.createClass({\n  canDeleteMemory: function(post, blog, user) {\n    return user && (blog.userId == user.id || post.userId == user.id)\n  },\n  render: function() {\n    let isOwner = this.canDeleteMemory(this.context.currentBlogPost, post, this.context.currentUser);\n    return isOwner ? <a>Delete</a> : null;\n  }\n});\nthen I always get an error at blog.userId because blog is undefined ... so I change the condition like this let isOwner = this.context.currentBlogPost && this.canDeleteMemory(this.context.currentBlogPost, post, this.context.currentUser);\nbut then the delete icon never shows... but instead of using the contextType if I wrap the BlogPostText component with redux select and use this.props.currentBlogPost then it works fine..\nso change in context doesn't trigger a re-render or something like that ... or am I using it wrong.\n. @jimfb ok, I will recheck my code, see if I missed something and create a new thread if I can't resolve.. I just started with react.. and its actually hard to find quality help. so, thanks for the feedback.. appreciate it.\n. @jimfb well, the issue was resolved ... there was some error in code and the people who wrote the code didn't use catch to resolve any errors from promises, so reducer state wasn't getting updated properly and hence the change wasn't getting reflected. \nSo, if the props in the parent changes, the contextType in the children do get reflected ... Thanks.\n. It's not really behavior you'd want to control when calling createElement(), it's behavior that should be defined by the element (React.createClass) itself. I could see a useful PropType such as \"Map\" having this behavior baked in. I don't think I'd want elements to have too much flexibility though. Either a new PropType with defined behavior or keep it simple.\nYou can also use a state var and do this yourself.\n. This worries me. I don't think React applications should be required to know about each other on the server side. For example, two react applications could be served from two separate services and both injected into the same page. I would expect that if the root nodes didn't conflict, the attach point node would be sufficient enough of an identifier. Numbering the applications in the DOM seems like a bad idea.\n. Seems like the easiest workaround is to patch the server-generated string with a random Id.\nhttp://jsfiddle.net/gvtm0q2h/4/\nSeems to work okay.\n. My problem with using times is that they can just as easily be duplicates in a fast system with low precision. For example,\nfor (var i = 0; i < 10; i++) {console.log ((new Date()).getTime().toString());}\nI get mostly dupes with that.\nI'd rather just increase the 100 buffer and 10000 range if you're worried about collisions. Or have a getUniqueId() request-scoped (or whatever you need) singleton to manually increment on the server as the multiple react strings are patched.\n. thanks for fixing for the child nodes though :)\n. I just had another idea on how to fix this in the framework.\nRather than a random Id, could renderToString() either use a placeholder Id or take an optional Id as input? If it started off looking like data-reactid=\".x\", the string would remain deterministic for the same inputs. I'm not sure if you have any hardcoded test strings but staying deterministic would be nice, particularly for affirming compatibility between different implementations down the road.\nrender() would replace the placeholder Ids when it's mounted. I'm not sure if that would trigger a repaint in the browser. If not, it might be worth it to keep things deterministic and simple for the developer.\n. As far as somewhere to put your globals, have you looked into the context variable? It hasn't been finalized but it seems to cover some of what you're asking for. There isn't really a proper add-ons framework right now. So I'd expect you'd need to rely on the consumer to wrap things up with React.withContext(). It is hardly a perfect solution but it's something you can do right now that may transition reasonably well into a supported mechanism down the road.\n. Also clicky.com \n. @ToucheSir mistakes like that you described, could be done with spread objects, but it was included in core..\n. @ToucheSir like this -> <div {...this.props}>..</div>\n. strange, when you change the <p /> to <div />, it suddenly worked as expected :|\n. I see, so in way, an invalid markup halts reactjs in a way, thanks for the explanation @syranide.\n. Yes, it is, my bad, sorry\n. This is actually quite a good idea. I would love to see this in React, with or without Clojurescript. Offers considerably improved styles of working in the React environment.\n. +1\n. Can we polyfill Nashorn with a module loader? Something like jvm-npm?\n. Is there anything actionable left? It sounds like this is by design. Is there debug code to detect bad environments that could be updated to check for the existence of required globals?\n. I just mean a guard to make this misconfigure easier to debug.\nif (DEBUG && !require) { throw new Error(\"You need a module loader.\"); }\nThanks Ben.\n. @Download I don't have the knowledge to address everything you said directly. But two things do jump out at me.\n- You shouldn't be using a CDN for server-side code. At worst, it should be downloaded from the CDN when you deploy your application/service. Relying on caching would be a poor way to justify this. You really do want to put React through webpack along with everything else for the server-side bundle. In the browser, it's absolutely fine to use the CDN. I'd be a little surprised if this caused issues with dev builds. Nashorn doesn't have hot reloading (as you'd get with webpack-dev-server) but a watch-build should still be pretty quick. Even if you had to write an extra MB of js, a watch build keeps that in memory. It takes a fraction of a second to write a MB to disk. Also, even if you don't include React in a bundle, you still want it available to the bundler to perform as much static analysis as it can. \n- This really isn't a Java/Nashorn dev vs browser/Node dev issue. There is a lot of long-term thinking that goes into how these modules are being broken down. A lot of code gets included for backwards compatibility but will be removed in the future. I don't think ReactDOM will contain everything required for ReactDOMServer in the future. I'm a huge fan of the Nashorn project. It has a long way to go but I'm also invested in seeing it succeed. It's also great to see a new JS engine built with such a unique perspective. There's a lot of potential there that doesn't exist in Node. That said, it's very new and lightly supported. The Nashorn community needs to accept that to a certain extent, there are a lot of existing patterns that still need to be followed if they want to support Node modules.\n.  I'll have a PR submitted for this tonight actually. \n. I don't understand this crap\nOn Feb 12, 2016 11:36 AM, \"Lucas Wiener\" notifications@github.com wrote:\n\nThis is a bug that we are experiencing in our team as well. I have\nverified that your solution works. I hope that this will be merged asap.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/facebook/react/pull/5720#issuecomment-183399953.\n. I can't read it\n\nOn February 17, 2016, at 12:37 PM, Jim notifications@github.com wrote:\n@shastings86 care to elaborate? Also, please watch your attitude; at first glance, your comment appears to be very negative and not constructive - which is not the type of community we want to foster.\n\u2014\nReply to this email directly or view it on GitHub.\ufffc\n. @alunyov updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. @jimfb I implemented and ran the test you described and here's what happened: the warning was output twice. Once with React.createElement and then again with ReactDOM.render. However, if the chainable type checker returned a new Error as opposed to using the devtool to output a warning, it is output only once. How do you suggest I proceed?\n. @jimfb I found the two places from which it gets called. Once from ReactElementValidator.checkPropTypes at element creation and again from ReactCompositeComponentMixin._checkPropTypes at rendering. There's actually a \"TODO: Stop validating prop types here and only use the element validation\" written in the second function.\nI've updated my code with a cache of miscapitalized propNames, is this okay, or should I cache the (componentName, propName) combination?\n. Hmm. Clone the elements?\n. @jimfb Not sure I follow. Are you meaning in regards to external event handlers and references to the DOM node? I was thinking of this concept more as a way to create a template node that's never attached to the document. Cloning can be faster in some cases I believe.\nRather than creating a new element in the render() itself, include a ref (the js object) to an unattached element in the return. That element gets cloned rather than attached.\nWouldn't be so hot for updates though. Well, I guess returning the same object means you don't need to clone it again.\n. Just use console.log on the isUnitlessNumber and take a look at the output in the console. All properties are listed there, and if you scroll you will see the properties I mentioned plus some other weird props\n. @troydemonbreun updated the pull request.\n. @troydemonbreun updated the pull request.\n. @troydemonbreun updated the pull request.\n. @troydemonbreun updated the pull request.\n. @troydemonbreun updated the pull request.\n. @troydemonbreun updated the pull request.\n. @troydemonbreun updated the pull request.\n. @gaearon updated the pull request.\n. @jimfb updated the pull request.\n. @jimfb updated the pull request.\n. @jimfb updated the pull request.\n. @jimfb updated the pull request.\n. @jimfb updated the pull request.\n. @jimfb updated the pull request.\n. @jimfb updated the pull request.\n. @yiminghe updated the pull request.\n. @apaatsio updated the pull request.\n. @dmnd updated the pull request.\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @SimenB updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @aickin updated the pull request.\n. @aickin updated the pull request.\n. @aickin updated the pull request.\n. @cpojer updated the pull request.\n. @cpojer updated the pull request.\n. @cpojer updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @sheerun updated the pull request.\n. @sheerun updated the pull request.\n. @sheerun updated the pull request.\n. @sheerun updated the pull request.\n. @gaearon updated the pull request.\n. @zpao updated the pull request.\n. @zpao updated the pull request.\n. @zpao updated the pull request.\n. @javache updated the pull request.\n. @javache updated the pull request.\n. @javache updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. @spicyj updated the pull request.\n. @jakeboone02 updated the pull request.\n. @jakeboone02 updated the pull request.\n. @dotu updated the pull request.\n. @dotu updated the pull request.\n. @tony99nyr updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @Yaxian updated the pull request.\n. @Yaxian updated the pull request.\n. @Yaxian updated the pull request.\n. @Yaxian updated the pull request.\n. @Yaxian updated the pull request.\n. \u042f \u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e \u043f\u0440\u043e\u0447\u0438\u0442\u0430\u044e \u0441\u0442\u0430\u0442\u044c\u044e \u0438 \u0438\u0441\u043f\u0440\u0430\u0432\u043b\u044e \u043e\u0448\u0438\u0431\u043a\u0438, \u043d\u0430 \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u0442\u044b \u0443\u043a\u0430\u0437\u0430\u043b. \u0421\u043a\u0430\u0436\u0438, \u043c\u043e\u0433\u0443 \u043b\u0438 \u044f \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0442\u044c \u0432 \u043f\u0435\u0440\u0435\u0432\u043e\u0434 \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u044f, \u043a\u043e\u0442\u043e\u0440\u044b\u0445 \u043d\u0435\u0442 \u0432 \u043e\u0440\u0438\u0433\u0438\u043d\u0430\u043b\u044c\u043d\u043e\u043c \u0442\u0435\u043a\u0441\u0442\u0435, \u043d\u043e  \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u043f\u043e\u043c\u043e\u0433\u0443\u0442 \u043c\u043d\u0435 \u0431\u043e\u043b\u0435\u0435 \u044f\u0441\u043d\u043e \u0432\u044b\u0440\u0430\u0437\u0438\u0442\u044c \u0441\u0432\u043e\u044e \u043c\u044b\u0441\u043b\u044c? \n\u0418 \u0435\u0449\u0451, \u043c\u043d\u043e\u0433\u0438\u0435 \u0442\u0435\u0440\u043c\u0438\u043d\u044b, \u0442\u0430\u043a\u0438\u0435 \u043a\u0430\u043a \u0440\u0435\u043d\u0434\u0435\u0440\u0438\u043d\u0433, \u043c\u044d\u043f\u0438\u043d\u0433, \u043a\u043e\u043b\u0431\u044d\u043a, \u0431\u0438\u043d\u0434\u0438\u043d\u0433 \u0438 \u0434\u0440. \u0443\u0436\u0435 \u0443\u0441\u0442\u043e\u044f\u043b\u0438\u0441\u044c \u0432 \u044f\u0437\u044b\u043a\u0435 \u0440\u0430\u0437\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a\u043e\u0432, \u043d\u043e \u0438\u0445 \u0440\u0430\u0437\u044a\u044f\u0441\u043d\u0435\u043d\u0438\u044f \u043d\u0435\u0442 \u0432 \u0432\u0438\u043a\u0438\u043f\u0435\u0434\u0438\u0438. \u041c\u043e\u0436\u043d\u043e \u043b\u0438 \u0438\u0445 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u0432 \u043f\u0435\u0440\u0435\u0432\u043e\u0434\u0435 \u0438\u043b\u0438 \u0437\u0430\u043c\u0435\u043d\u044f\u0442\u044c \u0438\u0445 \u0434\u0440\u0443\u0433\u0438\u043c\u0438, \u0431\u043e\u043b\u0435\u0435 \u043f\u043e\u043d\u044f\u0442\u043d\u044b\u043c\u0438 \u0441\u043b\u043e\u0432\u0430\u043c\u0438?\nPS \u041f\u0440\u043e\u0447\u0438\u0442\u0430\u043b \u0433\u043b\u0430\u0432\u0443 \"\u0411\u0435\u0440\u0435\u0433\u0438\u0441\u044c \u043a\u0430\u043d\u0446\u0435\u043b\u044f\u0440\u0438\u0442\u0430!\", \u043f\u0440\u0438\u0437\u043d\u0430\u044e\u0441\u044c \u0441\u0430\u043c \u0437\u0430\u0440\u0430\u0436\u0435\u043d \u044d\u0442\u0438\u043c \u043d\u0435\u0434\u0443\u0433\u043e\u043c. \u0417\u0430 \u043a\u043d\u0438\u0433\u0443 \u0433\u043e\u0432\u043e\u0440\u044e \u043e\u0441\u043e\u0431\u043e\u0435 \u0441\u043f\u0430\u0441\u0438\u0431\u043e.\n. @dotu updated the pull request.\n. @dotu updated the pull request.\n. @dotu updated the pull request.\n. @zpao updated the pull request.\n. @Aweary updated the pull request.\n. @Aweary updated the pull request.\n. @sebmarkbage updated the pull request.\n. @sebmarkbage updated the pull request.\n. @sebmarkbage updated the pull request.\n. @zpao updated the pull request.\n. @zpao updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @TanaseHagi updated the pull request.\n. @chicoxyzzy updated the pull request.\n. @chicoxyzzy updated the pull request.\n. @chicoxyzzy updated the pull request.\n. @chicoxyzzy updated the pull request.\n. @chicoxyzzy updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @sebmarkbage updated the pull request.\n. @sebmarkbage updated the pull request.\n. @sebmarkbage updated the pull request.\n. @sebmarkbage updated the pull request.\n. @dotu updated the pull request.\n. @dotu updated the pull request.\n. @jimfb updated the pull request.\n. @jimfb updated the pull request.\n. @dotu updated the pull request.\n. up to date\n. @spicyj updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @spicyj updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @davidaurelio updated the pull request.\n. @davidaurelio updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. @Aweary updated the pull request.\n. @elas7 updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @wub updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. @gaearon updated the pull request.\n. @jimfb updated the pull request.\n. @jimfb updated the pull request.\n. @jimfb updated the pull request.\n. @nfcampos updated the pull request.\n. @nfcampos updated the pull request.\n. @spicyj updated the pull request.\n. @spicyj updated the pull request.\n. @dmitriiabramov updated the pull request.\n. @dmitriiabramov updated the pull request.\n. @dmitriiabramov updated the pull request.\n. @dmitriiabramov updated the pull request.\n. @dmitriiabramov updated the pull request.\n. @dmitriiabramov updated the pull request.\n. @dmitriiabramov updated the pull request.\n. @dmitriiabramov updated the pull request.\n. @spicyj updated the pull request.\n. @spicyj updated the pull request.\n. @jimfb, I mean, that i want to render component styles in jsx syntax: css in js, like html in js.\nBut { brakcets not allowed to render style tag in component.\nI know about https://github.com/krasimir/cssx, it is good idea, but there is not good realisation.\nMay be in reactjs will realised this feature, render css in js. I think it is not hard on current jsx core.\nexample:\n.myClass {\n    color: [colorVariable]\n}\n. @spicyj updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @darobin updated the pull request.\n. @jimfb updated the pull request.\n. @jimfb updated the pull request.\n. @jimfb updated the pull request.\n. @sebmarkbage updated the pull request.\n. @sebmarkbage updated the pull request.\n. @jimfb updated the pull request.\n. @lexjacobs updated the pull request.\n. @lexjacobs updated the pull request.\n. @spicyj updated the pull request.\n. @hjmoss updated the pull request.\n. @koba04 updated the pull request.\n. @koba04 updated the pull request.\n. @zarkoselak updated the pull request.\n. @zarkoselak updated the pull request.\n. @Aweary updated the pull request.\n. @Aweary updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @wali-s updated the pull request.\n. @wali-s updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. @brad-decker updated the pull request.\n. @wadahiro updated the pull request.\n. @keyanzhang updated the pull request.\n. @keyanzhang updated the pull request.\n. @keyanzhang updated the pull request.\n. @keyanzhang updated the pull request.\n. @trueadm updated the pull request.\n. @trueadm updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @sotojuan updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. @cpojer updated the pull request.\n. @cpojer updated the pull request.\n. @cpojer updated the pull request.\n. @cpojer updated the pull request.\n. @jimfb updated the pull request.\n. @zpao updated the pull request.\n. @cbrandolino updated the pull request.\n. @vjeux updated the pull request.\n. @vjeux updated the pull request.\n. @git-richard updated the pull request.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Hey Keyan,\nI had adapted the svg from http://tympanus.net/Tutorials/SVGLoaderGSAP/index6.html\nLooks like I was missing the CSS animations. Good spot. Thanks.\n. Actually @keyanzhang ,\nDo keyframe animations work in React?\nI have added the following to my sass file:\n```\noutline {\nstroke-dasharray: $len0.01, $len;\n  stroke-dashoffset: 0;\n  animation: anim $time linear infinite;\n}\n@keyframes anim {\n  12.5% {\n    stroke-dasharray: $len0.14, $len;\n    stroke-dashoffset: -$len0.11;\n  }\n  43.75% {\n    stroke-dasharray: $len0.35, $len;\n    stroke-dashoffset: -$len0.35;\n  }\n  100% {\n    stroke-dasharray: $len0.01, $len;\n    stroke-dashoffset: -$len*0.99;\n  }\n}\n```\nBut it still doesn't seem to be animating.\n. Hey @keyanzhang \nI got it working!\nIt was actually just a total user error on my part. I had changed the opacity attribute to fillOpacity for some bizarre reason lol.\nThanks for you help!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request.  As you may know, we require contributors to sign our Contributor License Agreement, and we don't seem to have you on file and listed as active anymore.  In order for us to review and merge your code, please email cla@fb.com with your details so we can update your status.\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. sure, but this might add confusion about what the \"true\" env var is. \n. The problem is, that now every dev must learn that env === production doesnt mean production, but might as well be staging. and that just because env === production, that doesn't necessarily mean we can use production APIs. \nThis might appear small, but those kind of things add up. It's another, small leap to complexity madness, imho\n. @gaearon alright, thanks for the update. . Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!\n. Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!\n. hey what to do now?\n17.01.2017 21:47 \"Dan Abramov\" notifications@github.com napisa\u0142(a):\n\nClosed #8807 https://github.com/facebook/react/pull/8807.\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/facebook/react/pull/8807#event-926459251, or mute\nthe thread\nhttps://github.com/notifications/unsubscribe-auth/AXwKLkHwu4JuHoQLdpXxRmP6rEbaI-_vks5rTSjwgaJpZM4LlGc_\n.\n. Great respond I  will know how to get do it 1hr faster. This time maybe it\nwas better to do it manually and understand more. I'm not sure when it will\nbe ready - safe. Anybody can write to my  to this mail for priv. Need small\nadvice/Help?\n\n\nPriv data will beat least less .. huge :) I will do my best to do it\nright + will use Your advices. (Straight to this upper mail will be easier\nto read directions)\n\nHave a good night\nAndrew\n18.01.2017 22:21 \"Andrew Clark\" notifications@github.com napisa\u0142(a):\n\nWe're unlikely to make this configurable. The mental model for how error\nboundaries work is a try-catch block:\ntry {\n  renderChildren();\n} catch (errorInChildren) {\n  handleError();\n  renderChildren();\n}\nThe retry happens inside the catch block, so if it throws again, the\nerror bubbles up to the next catch in the stack.\nMaking error boundaries configurable in the way you're asking would be\nlike making catch blocks in JavaScript configurable. It's better to\nimplement this feature in userland, rather than in the framework/language\nitself (React, in this case).\nOne way to implement this would be to remount the error boundary whenever\nit catches an error. Because the remounted component is a different\ninstance from the one that caught the error, it will not be skipped on\nretry.\nHere's an example using a withRemounting higher-order component. (You\ndon't have to use an HOC but it's a good fit for this use case. See this\ndoc for more information\nhttps://facebook.github.io/react/docs/higher-order-components.html, in\ncase you're unfamiliar.)\nfunction withRemounting(WrappedComponent) {\n  return class WithRemounting extends React.Component {\n    state = { boundaryKey: 1 };\n    remount = () => {\n      this.setState(state => ({\n        boundaryKey: state.boundaryKey + 1\n      }));\n    }\n    render() {\n      return (\n        \n      );\n    }\n  }\n}\nclass ErrorBoundary extends React.Component {\n  unstable_handleError() {\n    this.props.remount();\n  }\n  render() {\n    // ...\n  }\n}\nconst ErrorBoundaryWithRemounting = withRemounting(ErrorBoundary);\nDisclaimer: I haven't actually run this code\nHope that helps!\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/facebook/react/issues/8821#issuecomment-273604720,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AXwKLtPOuVXK-y4jnDbLazbq8r1wSSAtks5rToJKgaJpZM4LnVyn\n.\n. JJ.uj@interia.pl will be reopen in 15 min. Ty\n\n18.01.2017 23:33 \"J\u0119drzej Wrzesi\u0144ski\" jedrzejwrzesinski@gmail.com\nnapisa\u0142(a):\n\nGreat respond I  will know how to get do it 1hr faster. This time maybe it\nwas better to do it manually and understand more. I'm not sure when it will\nbe ready - safe. Anybody can write to my  to this mail for priv. Need small\nadvice/Help?\n\nPriv data will beat least less .. huge :) I will do my best to do it\nright + will use Your advices. (Straight to this upper mail will be easier\nto read directions)\n\nHave a good night\nAndrew\n18.01.2017 22:21 \"Andrew Clark\" notifications@github.com napisa\u0142(a):\n\nWe're unlikely to make this configurable. The mental model for how error\nboundaries work is a try-catch block:\ntry {\n  renderChildren();\n} catch (errorInChildren) {\n  handleError();\n  renderChildren();\n}\nThe retry happens inside the catch block, so if it throws again, the\nerror bubbles up to the next catch in the stack.\nMaking error boundaries configurable in the way you're asking would be\nlike making catch blocks in JavaScript configurable. It's better to\nimplement this feature in userland, rather than in the framework/language\nitself (React, in this case).\nOne way to implement this would be to remount the error boundary whenever\nit catches an error. Because the remounted component is a different\ninstance from the one that caught the error, it will not be skipped on\nretry.\nHere's an example using a withRemounting higher-order component. (You\ndon't have to use an HOC but it's a good fit for this use case. See this\ndoc for more information\nhttps://facebook.github.io/react/docs/higher-order-components.html, in\ncase you're unfamiliar.)\nfunction withRemounting(WrappedComponent) {\n  return class WithRemounting extends React.Component {\n    state = { boundaryKey: 1 };\n    remount = () => {\n      this.setState(state => ({\n        boundaryKey: state.boundaryKey + 1\n      }));\n    }\n    render() {\n      return (\n        \n      );\n    }\n  }\n}\nclass ErrorBoundary extends React.Component {\n  unstable_handleError() {\n    this.props.remount();\n  }\n  render() {\n    // ...\n  }\n}\nconst ErrorBoundaryWithRemounting = withRemounting(ErrorBoundary);\nDisclaimer: I haven't actually run this code\nHope that helps!\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/facebook/react/issues/8821#issuecomment-273604720,\nor mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AXwKLtPOuVXK-y4jnDbLazbq8r1wSSAtks5rToJKgaJpZM4LnVyn\n.\n\n\n. Sure will (try ) DO :) I see long start but for now it can be any start\nwithout master admin - console.\n\n18.01.2017 22:18 \"Johann Hubert Sonntagbauer\" notifications@github.com\nnapisa\u0142(a):\n\nPropTypes type checking: Add additional check to UnionType checker to\nensure only functions are used as argument of oneOfType.\nThis is especially handy to catch typos during PropType definition like\nfor example:\nGreeting.propTypes = {\n  name: React.PropTypes.oneOfType([React.PropTypes.sting, React.PropTypes.func])\n};\nThe pull request will print a warning\nInvalid argument supplied to oneOfType, expected an array containing check\nfunctions.\n\nYou can view, comment on, or merge this pull request online at:\nhttps://github.com/facebook/react/pull/8823\nCommit Summary\n\nPropTypes type checking: Add additional check to UnionType checker\n   to ensure only functions are used as argument of oneOfType.\n\nFile Changes\n\nM src/isomorphic/classic/types/ReactPropTypes.js\n   https://github.com/facebook/react/pull/8823/files#diff-0 (7)\nM src/isomorphic/classic/types/tests/ReactPropTypes-test.js\n   https://github.com/facebook/react/pull/8823/files#diff-1 (10)\n\nPatch Links:\n\nhttps://github.com/facebook/react/pull/8823.patch\nhttps://github.com/facebook/react/pull/8823.diff\n\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\nhttps://github.com/facebook/react/pull/8823, or mute the thread\nhttps://github.com/notifications/unsubscribe-auth/AXwKLkmIdrRw785SWS9Etz0OXQMO6zBGks5rToGzgaJpZM4LnZwn\n.\n. Hi gaeron, thanks.\n\nSo you say React will use index as keys. This is important information since in this case, indeed one may get corrupt data.\nOne could naively think that if he/she ignores keys this is only performance issue.\nI think doc has to mention it explicitly.\nPS. What is \"PR\"?. I used to have a question on that, http://stackoverflow.com/questions/43028765/what-happens-if-i-dont-use-keys-in-react-at-all/.\nYou can see in one of the comments a person also thought it was only a performance thing.. @gaearon Actually I can't reproduce the issue I thought would happen by using indexes as keys. The new array elements are still correctly being rendered here: http://codepad.org/KYwD3WuM. I expected no updates would happen on UI, since the new array had same indexes. Did I miss something?. Actually I can't reproduce the example I stated in commit, http://codepad.org/KYwD3WuM, maybe someone can intervene? (the UI is still correctly being updated). @Adligithub2 . @gaearon Dear Dan please feel free to add that improvement yourself. Indeed docs should make it clear, what path to take - and not undertake steps which aren't necessary.\n@gaearon Also I didn't send a PR with previous issue with not using Keys in react if you remember, I also invite you (or someone else) to improve that. \nIt's fine for me to know that these \"opened\" issues have helped somehow. I will delegate rest to people who know more about subject matter.. @spicyj , you could self-assign this issue to you, and then make it a habit to check https://github.com/issues/assigned for things you've forgotten. Just a suggestion.. @gaearon Yup, nice, I thought so, but since it is docs, just saying \"it will lead to bugs\", is not enough IMO. PS. Hope someone is working on my previous two issues :) . @hanumanthan So if I want to ensure I always keep track of the latest value in state, each setState should be followed by a read operation like: setState(function(prevState){...log(prevState.val...})?\nAlso maybe it is time react puts a doc explaining all the pitfalls one can encounter with managing state.. @gaearon Thanks I will think about it. Btw. asynchronicity of setState I have seen has confused many developers, was making setState async worth it? maybe it is better if it is synchronous? For example this:http://stackoverflow.com/questions/43428456/how-to-correctly-handle-state-in-this-case, I would be grateful if you can respond on that question.. @gaearon Dan, how can many cells set inProcess flag, in the beginning of function you can see I am checking it and quiting the function if it is set.. @gaearon So now you think this is OKAY? PS. this is code from my project: https://github.com/giorgim/MatchingGame. the timeout there I need for UI effect.. @gaearon Thanks I will think about your suggestion. I think since my code works (it doesn't have any obvious bugs, does it?) at least I may leave as it is and incorporate your suggestion maybe in future projects. . @gaearon \"before you started using the updater form of setState\" what do you mean here Dan? I got confused in your last message at which times to which part of my code you refer to :) \nPS.I think it is time Facebook puts out official doc named smth like \"state management in react\" where it explains all the pitfalls and best practices about state management, given so much confusion about it on the net. @gaearon If you look at my SO question, there are two versions, so you say 1st makes more sense? But in that case can't I theoretically run into case that where I clone the state (third or fourth statement) in clickHandler, I can get old state? (because some previous setState-s were pending?). > \"Now, if you call setState after that, this.state won't get updated immediately.\"\n-- where could be that \"after that\"?\nPS. So you endorse first version of code which was included in my SO question, if you give an answer on Stack Overflow about that I will accept that - it may also help others.. @gaearon Dan how you explain that here: http://stackoverflow.com/a/42994068/3963067, in the first code snippet (click first \"show code snippet\") by the author, inside increment, when he reads state, it reads old state (because value gets incremented only once)? even though increment is an eventHandler. \nBecause this seems to contradict with what you put on SO answer\n\nAt least in React 16 (or earlier), reading this.state before the first setState() call in the event handler will give you the current state. But don\u2019t expect it to be updated immediately after setState().\n. @hanumanthan , @gaearon Not really. Citing\nNo. At the time of this reply (React 16 and any earlier versions), this.state in the event handler is safe to read\n\nThe second time the event handler is called, we are entering a brand new event handler, so what Dan said above should hold.\nOf course after I read state in event handler at some point I will modify it, and if when event handler is called again, what dan said above doesn't hold, then the question and answer also doesn't make much sense. because in that case it appears that is is safe to read from event handler only once. Isn't it?. @hanumanthan @gaearon Here is another citation form dan which makes us doubt what he meant in above quote:\n\nYou only call setState() once in your event handler (timeout happens later), so the pitfall about multiple consecutive calls doesn\u2019t apply.\n\nHowever as we saw with that code snippet, where you clicked + button, despite two independent event handlers were called, the state went out of sync (e.g. they weren't called consecutively as dan says above in the same event handler - and still went out of sync).\nWould be nice if dan can clear all this up.. @gaearon Dan, say I am inside some function, how can I get current version of state? Assume I just want to get current version of state - just to read it, not modify. . @gaearon Dan can you say why below code prints: 0, 2, 4 on the console (see console.log in render) if I click button twice, instead of 0,1,2,3,4? \nclass GoodCounter extends React.Component{\n  constructor(props){\n    super(props);\n    this.state = {count : 0} \n    this.incrementCount = this.incrementCount.bind(this)\n  }\n  incrementCount(){\n   this.setState((prevState, props) => ({\n      count: prevState.count + 1\n    }));\n   this.setState((prevState, props) => ({\n      count: prevState.count + 1\n    }));\n  }\n  render(){\n    console.log(this.state.count)\n    return <div>\n              <button onClick={this.incrementCount}>Increment</button>\n          </div>\n  }\n}\nIt seems in this case the prevState you receive in the functional setState is not always the state rendered on the UI\n. @InternetExplorer7 \n\nReact doesn't actually re-render until event-handling is completed, which is why setState can be called twice in your function before re-rendering.\n\nYeah for a moment one could think react would call render, after first call to functional set state. apparently it doesn't.. @TrySound Well maybe but if the example in the official doc is flawed maybe someone want to correct it?\n@TrySound So you say also that functional form immediately applies changes to state?. @gaearon It helps so my point was correct just your answer is that in practice the delay won't be so long, correct?\n\nIn other cases there is absolutely no difference between functional and object form. Using functional form has no implications on when React updates the DOM.\n\nDoes not this contradict with the statement that functional form gives you fresh copy of state? If there is a pending setState and it has not been applied yet - which state do you get, the pending one? or the old one.\nFinally, I think you still didn't address my concerns here:\nhttp://stackoverflow.com/questions/43428456/do-i-need-to-use-setstatefunction-overload-in-this-case\n(see last three comments)\n. @gaearon You mean SO answer? it shows last edit 16 april.\nI understood your answer to this thread (about 3 second delay). But following still not:\n\nIn other cases there is absolutely no difference between functional and object form. Using functional form has no implications on when React updates the DOM.\n\nDoes not this contradict with the statement that functional form gives you fresh copy of state? If there is a pending setState and it has not been applied yet - which state do you get as previousState when calling functional setState, the pending one? or the old one?. @gaearon Thanks for all responses, I think things are more clear especially about SO question, but it would do no harm IMO if someone could comprehensively address how setState in functional form works, and put it somewhere on blog maybe etc :). . @gaearon OK nice but then this is such a fundamental aspect that it would be nice that it is covered in most details possible, so that people are not confused about it anymore. . Thank you \ud83d\udc12\u2764\ufe0f. Thank you!. Thank you, you made web development fun again. I used jQuery in the past and it was a nightmare to synchronize the UI with my app's internal state. With React and Redux, the UI is automatically synchronized with the state, so my code is less cluttered with \"synchronization code\". Before using React, I had all my code in a single JS file. When I was introduced to React, I learned to split my code into smart components, dumb components, actions, reducers and vendor files, it made my code easier to search because I can hit Ctrl + P and jump to the part I need to work on. I sincerely appreciate all the work you did to make web development enjoyable and easy for human brains.. @gaearon ah so it means with functional setState you can really get the latest state (including if there is a pending one coming from non functional setState). the doc don't say that explicitly though.\n  . I use shape because of the \"forbidden\" propTypes.\nThanks a lot, I didn't remember that .any behavior.. Thanks!. @TrySound thanks, but even if I use Route instead of IndexRoute, I have the same error.. @TrySound thanks for help, it seems I've used old react-router tutorial, and the Link is not exported as well.. Following @apoorvtomar2222 's statement, the logo should be under MIT license.. all fixed. looking forward. fixed. @whs-dot-hk Which browser do you use? In Chrome / Electron I get this issue. Surprisingly Edge does not cause the issue.. I just tried it again on Windows and macOS. On my Mac it didn't work with Chrome 66.0.3359.181 but it worked with 67.0.3396.79. On Windows though it still does not work at all.\n@whs-dot-hk Which OS are you using? And have you payed attention to not move the mouse out of the carousel area?. @whs-dot-hk Ah there is the misunderstanding. In fact my carousel scrolling works, but my issue is that the content of the \"Breaking News\" card cannot be scrolled after scrolling the carousel back and forth. That is why I am shaking around my mouse in the gif because I try to scroll inside the card after moving the carousel back.. Yeah, I know in Android for instance you can do something like WebView.android.getSettings().setUserAgentString(\u201cyour-custom-user-agent\u201d); to manipulate the User-Agent directly, so I assume that is doable in almost every scenario (non-Android ofc). So that is a good point!. +1. > I think it's an issue with Webkit/Safari on iOS rather than React. I've tested it and from what I can see plain html input behaves the same as above.\n\nIn native apps on iOS after selecting Chinese quotes the cursor goes between those chars automatically so I'd recommend to address this issue here\n\nThanks for test, I've added a plain html element to the demo above.  You're right, it must be an issue with Webkit/Safari on iOS.. ",
    "flockonus": "+1 that the way HTML selected work isn't pretty.\n+1 that the  is a very nice helper on React\nMy expectation as a very noob user of React is that it doesn't remove a valid attribute from my HTML (or deny to apply it) in the case I didn't specify a value for .\nIf it doesn't work like that it's fine, but I can see a number of people being frustrated on it\n. ",
    "Simek": "Digging through repository I found event plugin which seems to be related to similar bug:\nhttps://github.com/facebook/react/blob/master/src/browser/eventPlugins/MobileSafariClickEventPlugin.js\nBut problem seems to be little wider because Chrome on iOS is also affected so this is an mobile webkit issue.\n. Sure, it's so obvious now, thank you!. One more code piece (span case) which could be replaced with isValidHtmlInSvg.. ",
    "brigand": "hold on, need to make some more changes and test this\n. value is defined here, so it's perfectly valid.  This is most likely done for formatting reasons here.\n. If you're going to call it atomic you might as well use the atomic setState.\njs\nthis.setState(function(state){\n    return {clickCount: state.clickCount + 1};\n});\n. Spelling: \"conter\" -> \"counter\"\nAnd maybe change it to \"Basic Example with Click Counter\" to match the others.\n. Fixed, thanks.\n. I agree with inlining this.state.value because the relationship between the virtual dom and state becomes a tiny bit clearer, but I think you should make it like this while you're at it; to put value and onChange lined up.\njs\nreturn (\n  <input\n    type=\"text\"\n    value={this.state.value}\n    onChange={this.handleChange} />\n);\n. Setting up a .babelrc isn't trivial to people that haven't used it before, especially in babel 6. A basic config should be included here.\n. Isn't the convention to put it in src (or src/client)? Also I don't think most people use .jsx extensions.\n. webpack.config.js is the default --config.\n. Maybe mention that 'eval' is a good devtool\n. Interesting, well time to update my webpack configs, thanks for the tip :-)\n. @DerNivel jekyll (the blog compiler) interprets {{ specially, so this is escaping it for jekyll.\n. The two main exceptions to shallow compare working should be mentioned here: functions defined in render, and children elements created in render.\nYou don't need to avoid deep objects if you only do immutable updates to them. Could add an \"unless\" clause.\nEdit: I guess you don't need to mention the \"unless\" since it's explained later on.\n. React \"creates\"?\n. \"categories\" or maybe \"phases\"\n. s/avoid to write/omit\ncall `super()` before using `this` in the constructor\n. binding\n. indentation. There was inconsistent use of backticks in component names. Removing them reduces some noise.. Just saving some vertical space by putting these on one line.. Fixed.. Should be inputRef={this.props.inputRef}. Fixed.. Fixed, went with the multiple lines. I'll update the codepens next.. Fixed.. I put a lot of thought into this piece, but I don't think it's quite right. My thoughts:\nI think \"alternatively\" is a clear enough indicator that this isn't required.\n\"standard development environment\" is presumptuous, but I think it's important to emphasize that this reflects the way React apps are developed.\nUnderstanding modules is an important part of normal React app development, but maybe we shouldn't send readers off in that direction at this point.. And remove the debug page links?. Fixed.. Might change to {`The text field's value should not update.`} to make syntax highlighters happy.. ",
    "digitalicarus": "Indeed, you are right. I was using 0.9.0 in the browser but my copy of gulp-react was stale. Sorry about that Ben. \n. ",
    "username99987": "Well, I am using gulp-react that uses react-tools.\nFor example, I have this in .jsx\nvar Card = React.createClass({\n    render: function() {\n        return (\n            <div className=\"star\">\n                &#9733;\n            </div>\n        );\n    }\n});\nAs the result of transformation I get this\nvar Card = React.createClass({displayName: 'Card',\n    render: function() {\n        return (\n            React.DOM.div( {className:\"star\"}, \n                \" \u2605 \"\n            )\n        );\n    }\n});\n. Yes, the issue was that my browser somehow set the encoding to 'ISO'.\nI believe forcing the encoding with <meta charset=\"utf8\"../> will solve the issue.\nThanks!\n. ",
    "tichris0": "Yah: I've seen that file before.  To be clear; are you suggesting that I use that strategy to handle multiple browsers or to use that component directly?\n. ",
    "herrstucki": "Oh right, I missed the \"existing\" part. Sorry!\n. ",
    "hllau": "@vjeux : Sure. I want to try and contribute. Let me do it!\n. ",
    "fson": "@petehunt done.\n. I believe this should say \"Keep in sync with the development version above.\"\n. ",
    "jmingov": "All done :page_facing_up: :+1: .\nThanks. \n. ",
    "joecritch": "+1\n. @zpao Sure, Updated. If the plugin sees an href attribute, it'll add an \"external\" class.\n. Hmm, I'm getting a different output locally (ruby 2.2)\n. Ah shoot, didn't realise I needed to re-boot bundle exec jekyll after each plugin change. Hence the false positive. Sorry for the mess.\n. aXe was picking it up that it was a duplicate of the title; which is apparently an anti-pattern. Empty alt tags are used for presentational img tags, so I think we're good \ud83d\udc4d . Due to the lack of alt attribute (see the other comment), we still want the site title to be read if the crawler is using mobile . See my latest commit. I've not removed them entirely, as I think it's good to have all width constraints in one central place, but I've made it more obvious about what they're actually doing. And was able to remove belowSidebarFixed due to the new \"excludeLarge\" on the between function \ud83d\udc4d . Removed :). this was actually an artefact, so now removed :). I think subtleOnDark is nicely verbose in this instance, showing it's for use on dark backgrounds. Would you agree?. Good shout, feels nicer to compose. Changed :). I think it was logically correct, but it wasn't nice to read. excludeLarge is an exception because you're not concerned about the max property. So I've refactored it \u2014 https://github.com/facebook/react/pull/10735/commits/5e4dda9c0ef4317b624c3a4ccee57992131d1845. @bvaughn @flarnie Any ideas how to achieve this?. this doesn't fire when you resize the window (above xsmall). Because Gatsby's layout can't re-render its children, this instead uses context to notify the layout to \"sync\" the header and footer visibility, based on whether than menu is open, but keep the \"open\" state inside of MarkdownPage.. Yeah, I feel like this is most idiomatic with Glamor (as opposed to using global class names, etc.) . Good catch, I'll do that now. Good spot. Even though it'd be hard for the user to exit the <Docs /> page without closing the menu (I think?), this is definitely good to have anyway.. To be honest, the docs haven't been tested in IE9. I was assuming IE11+ \ud83d\udc4d Do let me know if that's an issue.. I'd be keen on using props instead of context, for sure. I'm just not sure how this would be implemented? Would we pass arguments to children()?\nAlso, here's some notes about this setState callback architecture:\nAt the minute, Gatsby has its own sCU implementation in its route-level components. This means that, if we set some layout-level state, the route-level components (i.e. <Docs>) wouldn't re-render. So we have to work around this by keeping the state inside of <Docs>, and communicating back to the layout with context. (Which in turn has it's own \"synced\" state). Not ideal, but the best way I can think of atm. I feel ya! But it's unfortunately the only fix I've found for the drastic Safari scrolling bugs.\n\nIt doesn't catch touch events from the menu, because of the corresponding evt.stopPropagation() I've added.\nI don't see how the user would see the menu overlay, as that's controlled by the open prop, which is derived from the state itself. Can you elaborate? :) . Sure, and drop the a (React-based!) static site generator?. Doh, fixed :). Good spot, thanks. Good idea. Split these out into different procedures. Oh yeah! Never noticed that before \ud83d\udc4d . \n",
    "akre54": "Don't the reserved words (class and for) still need to be quoted for pre-ES5 environments?\n. Oh sweet. Good stuff.\n. Good call.\n. maybe node[value ? 'pause' : 'play']() or value ? node.pause() : node.play()\n. The docs aren't great but as far as I'm aware the only way to set the play state is through the play and pause methods. There's no attributes for it. [1] [2] [3]\n. Backone\n. frameowork, frameoworks\n. ",
    "lrowe": "Finding a way to make HTML attribute names work would definitely make React with JSX more approachable for new developers. But it has to be consistent - non-camelCased attribute names need to work as would attribute names with hyphens.\n. This would be great. I currently use this.transferPropsTo(...) through most of my app to avoid explicitly passing down my core application objects.\n. ",
    "LilyMGoh": "@zpao I signed the CLA.\n. ",
    "steadicat": "Just spent a few hours chasing this bug down in our codebase. Would be good to fix this soon, before someone else runs into this. I can repro in all versions of React from 0.9 to 0.12. (This is what I ended up btw: http://jsfiddle.net/yw2t9hcm/)\n. Yup! I\u2019m also running the very latest version of IE8.\n. I like the idea of special-casing common operations, like moving the first/last element to last/first position. Will probably take care of 95% of the use cases without having to introduce complex algorithms or extra APIs.\n. #870 will not solve this problem for me BTW. Special-casing certain tags is not going to take care of the case when these special tags occur inside all (or most) of the children being reordered. For example:  <video key=\"a\" /><video key=\"b\" /><video key=\"c\" /> changing to <video key=\"c\" /><video key=\"a\" /><video key=\"b\" /> should move c, and only c, even though c is a video like all the other children.\n. Hmm I got \"media\" and \"type\" mixed up. \"media\" exists but it doesn't do what I thought it did. I guess I don't need it.\n. Typically the whole point of deprecating something is to give people time to transition away from it. If you break the semantics as you're deprecating it you might as well remove it entirely. At least that way you're avoiding potentially insidious bugs that come from the breaking change, and making it clear to people what they have to do to upgrade to 0.12 without their code breaking.\n. Sorry for the delay. Here\u2019s a simple repo that repros: https://github.com/steadicat/react-useeffect-test\nThe code is pretty straightforward. The bug seems to be caused by the latest version of uglifyjs-webpack-plugin (2.0.1).. Sure thing: https://github.com/webpack-contrib/uglifyjs-webpack-plugin/issues/374.. ",
    "fforw": "In this case it wasn't so much that I really wanted my output to be padded with space, I just got to the second case by trying to make the code more pretty :\\ and promptly fell into that trap.\n. How would I go about to prove above code does indeed work on SVG nodes with your test system?\n. Ok?\n. Yes, I ran the tests :\\\nIn a real browser, svgNode.className is of course not the string foo. \nThe tests seem rather superflous here. Removing the original patch, but keepin the tests executes, too :\\\nIn short: we're testing a wrong browser emulation..\n. Both my firefox and my chrome agree to not do anything if I set the className property. Firefox will only give out the warning in strict mode (!). \nsetAttribute works in both. ( http://fforw.de/static/files/svgcls.html )\n. Better?\n. ",
    "actionnick": "@spicyj How does this look?\n. @syranide So are you saying that JSX shouldn't support hyphenated tags? Or are you saying that it should supper camelCased version of hyphenated tags? Do those have to be mutually exclusive? JSX isn't a standard JS HTML API, it's an intermediary markup of sorts, so it makes sense to have this support to me.\n. ",
    "fxxkscript": "@chenglou \nI'm new to this project, some words may not be accurate.I will fix these bugs later.\nMaybe you can also help me translate these doc better.\n. @zpao \nIn my spare time, I will translate more docs these days.\nMaybe it need a system to notify me when the documents changes.Can Github's hooks do that?\n. ",
    "markijbema": "I can see why setting something before mounting can always be considered an error. I think after unmounting should be considered a warning though (though I can imagine that in implementing it might be easier to consider both as warning)\n. ",
    "possibilities": "It would also fix the problem I'm having here:\nhttp://jsfiddle.net/BSJPd/1/\nArguably not a bug but unexpected and undesirable for me.\n. ",
    "amasad": "this explains the falsey part but not why failing silently for null value. Passing null values as event listeners should at least be warned.\n. Right. Have you thought about standardizing on boolean false instead? onChange={isEnabled ? this.handleChange : false} onChange={isEnabled && this.handleChange} works fine with that.\nMaybe not worth breaking change, but we tripped over this a couple of times where someone changes a method name or a typo etc.\n. ",
    "arnihermann": "Awesome work.\nI immediately started thinking how I'd integrate xhr into the store. Maybe adding a sentence on it in a comment will give people a head start in the right direction?\n. Fixed in 816b011.\n. I thought about it too. Seems like it will work in most cases. I use it in the invariant which is not wrapped in if (__DEV__) though which might be an unlikely edgecase cause of problem?\n. How hard is the 80 column rule? It's 81 now.\n. ",
    "kmeht": "Cool, I'll take a look at this this week.\n. This was foreshadowing the idea of descriptors before they were called descriptors. This was the best explanation I could come up with at the time. Now that descriptors are a real thing, this should probably be rewritten.\n. Okay, any ideas on making it more clear? I'm trying to convey that there may be cases where you want to \"instantiate\" a component before calling renderComponent. I expect this would mostly have to do with statics.\n. Alright, I can remove it altogether and leave it to the reader's imagination.\n. I was under the impression that the methods would also be available on the descriptor itself. I can remove this too if that's incorrect.\n. Okay, thanks for the clarification. Removed the line.\n. ",
    "arv": "When using polymer's shadow dom polyfill you should never see any raw DOM nodes. If you do it is either a bug or one of the known limitations. It would be useful to know how you got a reference to your node?\n. We do wrap innerHTML. Accessors and the buggy implementation of them in WebKit and Blink is the reason why we need to wrap everything.\nKnown limitations are the accessors of\n. ...of window and document since these are non configurable in webkit.\n. ",
    "stephenhandley": "Any possibility / interest in factoring out the virtual dom into a separate package so it can be used independently? \n. ",
    "jeffbski": "I completed the CLA today as well. \n. Excellent. Thanks for the update!\n. +1\n. +1\n. ok, that makes sense.\n. I believe that I may understand the issue.\nApparently when rendering on the server it uses random id's and the checksum will be different since it uses these id's in the calculations. However apparently the browser mounting code can determine somehow that the tree matches and just mount with event listeners. \nIf I make the props not match, then I do see the expected warning in the console log that \"Warning: React attempted to reuse markup in a container but the checksum was invalid.\", so I guess you can't manually look at things and know whether they will work or not. If you see the warning then it isn't working.\nIf anyone wants to elaborate on this more, that would be great, otherwise we can probably close this issue.\n. @jsfb I am using react@0.13.0-rc1 \nThanks for the clarifications, though.\n. @jimfb @syranide agreed.\n. @sebmarkbage @gaearon How would observe work on the server in v0.14? \nWould it be able to properly wait for all the observers to resolve before rendering to string similar to how react-nexus does (but built in to react)?\n. +1 for observe(props)\nThe less we deal with state the better IMO.\n. I don't find Zalgo to be a problem either. However with Observables you can use a scheduler to ensure async if desired, the default scheduler is now async so you can use that as needed.\n. I agree, if we have a way to render to get the tree then we can walk it and find all the data needs and pass them down. \n. This should probably be considered along with ReactDOM.renderToString and ReactDOM.renderToStaticMarkup. Would those necessarily not be able to synchronously return the string markup too (assuming an async render is allowed)?\nIf that is true, then would they return a promise, observable, or use a new cb parameter to obtain the html?\nSo whatever is decided for those, maybe a similar mechanism should be allowed for ReactDOM.render for symmetry. Meaning if renderToString and renderToStaticMarkup both return a promise which eventually resolves to the html, maybe render should return a promise which eventually resolves to the component. Likewise if observable or cb mechanism is chosen. This is an alternative to using the ref cb.\nIt is nice to have symmetry as much as possible in these api's. Developers have enough other things to worry about.\n. ok, thanks. That answers my question.\n. I dislike refs myself, but currently it is the recommended way of obtaining the root component from render  since render will no longer be synchronously returning the component. https://github.com/facebook/react/issues/6397\nSo if we are able to discourage use of refs, then we need an alternate way of getting the root component from render, maybe either:\n- a special ReactTestUtils render that does return a component synchronously OR\n- allow render to take a callback which will be called with the component once it is available\n. ",
    "marcins": "See this patch for the Dojo toolkit: https://bugs.dojotoolkit.org/attachment/ticket/17164/t17164.patch - basically on some Android versions style.transition is not undefined.  \nCould this be fixed by changing the order the properties are checked, so that webkitTransition is checked for before transition?\n. @yungsters  - personally your approach doesn't seem as flexible for any similar potential future issues - you'd end up with a bunch of if/deletes, but if there's consensus amongst your team that that's how the issue should be fixed then I can update the code.\nI just don't want to make the changes and have someone else at FB look at them another week later and come back with more conflicting feedback and still not have this small bug fixed in React.\n. The call to detectEvents is already guarded by that check, and I'd put the delete of unusable events at the start of detectEvents to ensure it's also covered by the DOM check.\n. No problem, I can imagine the logistics involved in managing contributions to a large, rapidly growing in popularity, OSS project, so apologise for any passive aggressiveness :)  I will update the code and push a fresh, clean, commit sometime on the weekend.\n. ",
    "Shadowfaxenator": "Does it mean that now we do not need to inject params as JSON on a server side?\n. ",
    "sirzxj": "\u6211\u4eca\u5929\u4e5f\u9047\u5230\u8fd9\u4e2a\u95ee\u9898\u4e86\uff0c\u6211\u4e00\u5f00\u59cb\u8fd8\u4ee5\u4e3a\u662f\u6211\u7528\u7684mysql\u6a21\u5757\u7684\u95ee\u9898\nI aslo encounter this problem today \u3002\u3002\u3002\n. ",
    "jamesmacaulay": "Just saw #1280, I'll edit the wiki instead.\n. ",
    "MarkNijhof": "I just pulled your queue-mc branch and did a grunt build. The error remains. I haven't been able to make a proper isolated repro of the issue yet. But I am pretty sure it has to do with altering child nodes from a React class while this class itself is being removed as well. And this decision is based upon the same data (displayError = false will both remove the class from the error list and the child node showing the error)\n. I'll try to create a proper repro in the next few days\n. ",
    "nathansobo": "I'm experimenting with using React to render our editor views in Atom. We're trying to make Atom as agnostic as possible when it comes to view frameworks, and I'm shooting for a simple standard in which views assume that other views expose an .element property which is the top-level DOM element for that view.\nI could be missing important details here, but it would be great to be able to create a detached component instance and just request its root element, then attach that element wherever. Then a React component would look pretty much like any other view from the perspective of the rest of the system. It would just be an object with an .element property.\n. I'm experimenting with using React to render our editor views in Atom. We're trying to make Atom as agnostic as possible when it comes to view frameworks, and I'm shooting for a simple standard in which views assume that other views expose an .element property which is the top-level DOM element for that view.\nI could be missing important details here, but it would be great to be able to create a detached component instance and just request its root element, then attach that element wherever. Then a React component would look pretty much like any other view from the perspective of the rest of the system. It would just be an object with an .element property.\n. 99% sure it's 1 keystroke. A stack depth limit in the flame graph is creating confusion in the center, but that's a single call pyramid. I could be wrong, but I think the first segment is reading the selection information and the second is restoring the previous selection:\nFrom ReactReconcileTransaction.js\njs\n/**\n * Ensures that, when possible, the selection range (currently selected text\n * input) is not disturbed by performing the transaction.\n */\nvar SELECTION_RESTORATION = {\n  /**\n   * @return {Selection} Selection information.\n   */\n  initialize: ReactInputSelection.getSelectionInformation,\n  /**\n   * @param {Selection} sel Selection information returned from `initialize`.\n   */\n  close: ReactInputSelection.restoreSelection\n};\n. Yeah, it's very likely that I'm triggering too many updates, so I'll try to reduce that. When typing, several things can change in the underlying model: the cursor moves, screen lines change, etc. I tried using setImmediate to delay update but it seemed to impact responsiveness negatively. I'll try some other way of batching all updates together without relying on the event loop.\nAnyway, point taken. There's probably a lot of room on our end to improve things. That said, we're trying to make editor performance as fast as possible. It would be great to be able to opt out of selection restoration in this specific case because I know we don't need it. Or maybe it could only restore the selection when you know the input has been removed and re-added to the DOM?\n. :boom: Really appreciate that tip. That really cleaned up the flame graph and things are looking much more sane. I've again annotated the portion associated with the selection restoration. Now it's much clearer where the time is going and I feel better about the potential to optimize other areas as well.\n\n. @zpao When I say \"hidden\", what I mean is that I have the opacity set to 0, not that it's a password field. Since I'm implementing a text editor, I'm just using the input element to receive events but doing all the rendering in HTML with React.\n. I'm probably going to need to publish an Atom-specific fork of React until we can resolve this in the official framework. That's no big deal, but I thought I'd let you know. Enjoying the framework!\n. We're planning to implement the Atom workspace views in React, so that packages can provide React components as panels and pane items.\nIdeally, different packages could rely on their own independent versions of Atom so packages wouldn't break if we upgraded React in core. Am I correct in thinking that might be a little unrealistic? I don't imagine you guys plan on supporting interoperation between components written in different versions of React (thought that would be awesome).\nSo instead our plan is to export the instance of React we use in core for use by package authors in building their own views, so everything interoperates. The downside of this is that upgrading React in core could break packages. So we may need to supply a shim to old packages when that happens to ease the transition. Hopefully that won't be too difficult.\nJust thought I'd share our use case, in case it shapes any design decisions as you change the API moving forward.\n. I think we'll just give everyone a reference to the same React instance. The iframe approach is unfortunately too isolated for the kinds of things people are doing in packages. Hopefully we can shim API changes. Are you guys planning on a bunch for 1.0?\n. @syranide Interesting. Do you mean multiple numeric versions of React or multiple instances? I'm talking about a component from version 0.10 being embedded in a component tree from version 0.11. If that's something that could be possible, that would be amazing.\n. Sorry, one more clarifying question. What you're saying makes sense with regard to multiple root components coexisting, but I'm still not clear on the scenario in which a parent composite component from one version of React owns a child component from another version.\nSay for example I have implemented Atom's workspace in React and I also want to implement Atom's tree-view package in React. I was imagining that the tree-view component would be referred to directly in the workspace's render method and end up getting owned by the workspace. Isn't the contract between these components a bit more involved than just the React id's? What am I missing here?\n. I'm as sure as I can be that we're not attaching event handlers for keydown and textInput events via React properties anywhere in our code. Are they perhaps attached by the input DOM component?\nHere's a flame chart of a keystroke, with keydown and textInput events being processed by React.\n\n\n\nUpon consideration we should probably just stopPropagation of these events and they'll never reach the handler. But for some reason they are indeed being handled in a non-trivial amount of time.\nI'm quite intrigued by your idea of just using native APIs directly and skipping the global handling. I'm assuming that would require some more logic in our fork to interpret the event handler properties of DOM components?\n. Thanks for your thoughtful explanation here. Yeah, this input definitely uncontrolled. It's not even visible, but just exists to receive input which we render ourselves in the editor. For now, stopping propagation of keydown and textInput events seems to eliminate the expensive handling from the flame graph.\nI'm hesitant to remove controlled inputs entirely in case users want to use them elsewhere. For now we're exporting our copy of React to users until the multiple-instance issue is addressed, so I'd like inputs to work as expected for them.\nNot sure disabling the synthetic event system is warranted yet, but if we see it costing us time elsewhere I'll definitely take a crack at it.\nI'm going to close this now. Thanks for the conversation!\n. @spicyj I love everything about the proposed API. I think it will really streamline integration of React into more heterogenous environments and also make it easier to support packages written in different versions of React by allowing the parent component to integrate manually through the DOM.\n@syranide I would be totally fine with that workaround. The only component we'd currently need it for is the editor, and that's always a div.\n. And we don't even need synthetic event support. We currently bind everything manually.\n. @chenglou That would help our situation with the editor a bit, yes. But what's more important for Atom I think is the ability to integrate React with HTML custom elements without requiring the use of the shadow DOM. Seems like #1711 would help that, and it seems like this idea might be necessary to achieve that as well?\n. Great to see this happening!\n. @chenglou Avoiding event handling for the input field on a per component basis sounds great, but it's \"playing nice with other frameworks\" that we're interested in more than anything. Performance problems can always be hacked around with manual DOM manipulation if needed, but it would be great to implement individual elements with React without the need for a container.\n. We're still really looking forward to this on the Atom team so we can feel more confident recommending React for packages. As it stands, the potential for unexpected event bubbling order when multiple instances of React are in play makes us pretty nervous.. ",
    "jhudson8": "Sorry about that.  Here is a small example to demonstrate the point (although it doesn't really fully demonstrate the use case).  I'd be happy to create a more appropriate example if you require it.\nvar Test = React.createClass({\n    render: function() {\n        return <div>{a bunch of components to traverse}<button onClick={this.onClick}>click me</button></div>;\n    },\n    onClick: function() {\n        // this.props.children is undefined here because they were not passed to the constructor\n    }\n});\n...\nReact.renderComponent(new Test(), document.body);\n. Thanks @spicyj that was very helpful - I wasn't aware of refs.\n. ",
    "martintietz": "Thank you! :) Kind of confusing that this is not required in Chromium.\n. ",
    "robertknight": "React v0.13's shallow rendering allows you to render one level deep and test output but attempting to dispatch events in tests currently results in an error due to the DOM not being available:\n``` js\nimport React from 'react/addons';\nclass Button extends React.Component {\n    constructor(props) {\n        super(props);\n        this.state = { pressed: false };\n    }\nrender() {\n    return <div className={this.state.pressed ? 'button-pressed' : 'button'}\n      onMouseDown={this.setState({pressed: true})}\n      onMouseUp={this.setState({pressed: false})} />\n}\n\n}\nlet shallowRenderer = React.addons.TestUtils.createRenderer();\nlet component = shallowRenderer.render();\nlet button = shallowRenderer.getRenderOutput();\n// fails due to missing 'window' global\nReact.addons.TestUtils.Simulate.mouseDown(button);\n```\n/home/robert/projects/test/react-shallow-render/node_modules/react/lib/getEventTarget.js:23\n  var target = nativeEvent.target || nativeEvent.srcElement || window;\n                                                               ^\nReferenceError: window is not defined\n    at getEventTarget (/home/robert/projects/test/react-shallow-render/node_modules/react/lib/getEventTarget.js:23:64)\n    at new SyntheticEvent (/home/robert/projects/test/react-shallow-render/node_modules/react/lib/SyntheticEvent.js:69:24)\n    at Object.mouseDown (/home/robert/projects/test/react-shallow-render/node_modules/react/lib/ReactTestUtils.js:416:17)\n    at Object.<anonymous> (/home/robert/projects/test/react-shallow-render/index.js:21:33)\n    at Module._compile (module.js:456:26)\n    at normalLoader (/usr/local/lib/node_modules/babel/lib/babel/api/register/node.js:119:5)\n    at Object.require.extensions.(anonymous function) [as .js] (/usr/local/lib/node_modules/babel/lib/babel/api/register/node.js:132:7)\n    at Module.load (module.js:356:32)\n    at Function.Module._load (module.js:312:12)\n    at Function.Module.runMain (module.js:497:10)\n. Is React.addons.TestUtils.Simulate.* already implemented for React Native? That would presumably have the same issues.\n. > I guess the cases here are when nesting elements from different versions inside each other?\n@spicyj when using browserify it can happen just when requiring two different versions of React because of the way it handles deduplication. Requires with the same path and code between the two versions can end up getting de-duped. Modules where the code/require path was changed between versions get deduplicated and others don't.\nSo I encountered this:\n1. ReactDOMSelect (from React v1) is evaluated and it mixes in ReactBrowserComponentMixin as part of its spec\n2. ReactInjection.Class.injectMixin(ReactBrowserComponentMixin) is evaluated and it adds ReactBrowserComponentMixin to all classes subsequently created by ReactClass.createClass (shared between React v1 and v2 because it didn't change between the two versions of React)\n3. ReactDOMSelect (from React v2) is evaluated and it tries to mix in ReactBrowserComponentMixin twice, once from ReactDOMSelect's own spec and once from the global injected mixin list.\nAs long as modules can be stateful, this approach to deduplication seems horrifically unsafe. I'll file an issue with Browserify itself, I haven't yet verified if Webpack would have the same issue. Either way - I think it would make sense to handle it specifically in React given how it can trip newcomers up.\n. ",
    "jed": "Ah, sorry. Didn't see it come up when searching for renderComponentToString. Can I assume for now it's safe to ignore the warnings?\n. ",
    "wvl": "cc @zpao -- Not a blocker for 0.11, but it would be nice if #1784 could be merged. \n. Would it be possible to add a prepublish hook to package.json so that build/react*.js get added to the package on npm?\nRight now you have the downloadable zip file for people using the built file directly. And the npm package for server side react and browserify. However, if one wants to avoid using browserify, then one must use both the npm package and either generate or add the packaged version to the app as well.\n. ",
    "duncanmak": "I'm using https://github.com/component/ in a project and I would love to be able to include react that way. The last conversation about this ended in https://github.com/reactjs/react-bower/issues/1.\n. ",
    "henrik": "Just saw the same issue. React (with addons) v0.12.2.\nI have a form that adds things and a table that should list the last 5 things (with animation). If I add many things quickly it will sometimes list more than 5, with the foo-enter and foo-enter-active classes remaining on the surplus elements.\n. In Chrome, I could work around this with $(\".my-submit-button\").click(), but in Firefox that didn't cause the form to submit.\nAnd as described above, simulating the click with React doesn't cause the form to submit in either browser.\n. Signed.\n. ",
    "dmnd": ":+1: \n. A new engineer just started. He was trying to discover what this very generally named \"update\" function was doing. He hyperclicked the function, then the import, and eventually ended up at the declaration here, but there's no pointer to the docs. I figured others might find a link to the docs to be useful.\n. Ok @jimfb, I added links for all addons and all functions in the top-level API.\nI skipped the component API because I don't think it's possible to hyperclick to those functions.\n. Oh, I didn't notice 16.6.1 was out. I just updated the sandbox above and it works great. Thanks!. ",
    "DAddYE": "It affects also css selectors in the very same way @AdamKyle posted before.\n. ",
    "alanhogan": "It does make sense to rename this property to something that doesn\u2019t sound like a function.\n\u2042\nIt does not make sense to drop the \u201cscary\u201d part of the name.\n\u201cIt\u2019s not dangerous if\u2026\u201d\nIf something can be dangerous depending on how it\u2019s used, then\u2026 it\u2019s dangerous. Matches are dangerous, even though they can be used safely. Knives. Ovens. My motorcycle.\nListen, I have a shameful and distant past as a PHP developer. PHP is absolutely chock-full of danger, and was even more dangerous in the past. Start with the fact that it outputs unescaped HTML by default, and the most standard-looking database library encourages users to naively interpolate strings into queries (hello, Bobby Tables). Now, concatenating strings into a query is not dangerous if you have escaped or safely generated those strings, but that doesn\u2019t mean it isn\u2019t dangerous, and it doesn\u2019t mean that everyone writing that code knows that. When I taught myself PHP+MySQL from a printed book in early high school, I didn\u2019t know about email header injection,\u00a0and I was furious to find out that the code I wrote by following the book left my contact form open to be used for sending spam to arbitrary recipients!\nNow, don\u2019t think that I have conflated making the right thing easy (read: escape by default & well-designed APIs) with taking the additional precaution of warning users of dangerous code.\nI am aware you are only debating the latter in this thread, and so am I. I think both are the right thing to do.\nI think you may be exhibiting a common programmer belief  that I think is dangerous: The idea that since every developer should know X, Y, and Z before hacking in language/library/system A, that every developer working with A does know X, Y, and Z. I assure you that assumption is not true, and there are astounding numbers of people \u2014\u00a0some call themselves developers, others don\u2019t \u2014 who simply google for a solution and paste code into their app, tweaking it until it \u201cworks\u201d. And for those people, they should see the word \u201cdanger\u201d in their code when they are pasting something that can open the only XSS hole in React. Any other attitude is setting those less experienced than us up for failure. \nReact team did a smart thing with this name, and deserve applause. Congrats \u2014\u00a0you are writing ethical software.\n. Looks like #2257 is the latest iteration of this issue\n. ",
    "przeor": "Isn't:\nReact.addons.TestUtils.Simulate.mouseDown(button.getDOMNode());\nReact.addons.TestUtils.Simulate.focus(button.getDOMNode());\nthe answer that may help you?\nOutput:\nhandle mouse down\nhandle focus\n. @spicyj @roman01la I am just curious if you have the same problem (or you know the solution) with the silent exceptions in reactjs:\nI have a hard time with silent breaking my react time while debugging. I understand that it's useful that when my app is on production to not throw exceptions.\nI am talking about a situation when my app's component will break silently if the JSON endpoint change (just example). Is there any way to turn it off (the silent breaking the reactapp)? It would save a lot of time for many people (I believe that more reactjs devs have similar problem). \n. @spicyj thanks for your patience. Do you know any good blog post/more reference of cases how someone has handled this kind of unwanted behavior ?\n. @spicyj thank you very much!!!\n. ",
    "Peeja": "Hey, sorry for the delay. CLA is signed. :)\n. Ah, got it. Yeah, knowing how it works now, I can do that. Thanks!\n. ",
    "benvinegar": "I just want to point out that, without this change, we will be forced to build our React app in development mode anyways \u2013\u00a0thereby stripping all the benefits you're discussing above. And we're going to have to make this recommendation to all our customers running React as well, all of whom rely on us (@getsentry) to report errors in their applications.\nIf you're going to make me choose between 1) small performance improvements or 2) fundamental successful bug-free operation of my application, I'm going to go with option 2 every time. I don't know anyone who would prefer to choose option 1.\nPlease, please consider either a) restoring error messages (but keep stripping warnings, e.g. propType validation), or b) give us an additional configuration option that lets us preserve error messages.\nIf either of those approaches are amenable, we'd be glad to contribute a patch on this.\n. > I would not recommend this as dev builds can be 5x slower. This is hardly a small performance improvement.\nI understand this. It sucks. Which is why we want error messages re-enabled (or a way to configure their availability).\n\nCan you please help me understand how React invariant error messages relate to bug-free operation of the apps? The errors thrown by React are rare and are generally not very helpful anyway because they usually indicate bugs in React itself. These get reported to us regularly from dev builds, and we try our best to fix them. Are there many scenarios where getting an exact internal error message would be helpful to you?\n\nLet me give you a real world scenario occurring right now.\nWe have a fundamental view in @getsentry that is broken for a particular customer. The stack trace is basically useless, but at least it tells me what the error message should have been: \njavascript\ninvariant(\n  false,\n  'Objects are not valid as a React child (found: %s).%s',\n  childrenString === '[object Object]' ?\n    'object with keys {' + Object.keys(children).join(', ') + '}' :\n    childrenString,\n  addendum\n);\nBut, because the error is stripped, I cannot see what the component name of the object is, or what the keys of the object might be. With that information, I'd be way closer to figuring out what the problematic child is.\nOur solution right now is to amend our staging server (which uses our production database) to put out \"development\" React code, so that we can see the original error message as it pertains to this customer. But that's not awesome either \u2013\u00a0the purpose of our staging server is to mimic our production environment as much as possible \u2013\u00a0and not everybody has access to additional servers to do this kind of verification.\n. > I think the key point to remember is that React is stripping internal errors and not obfuscating errors thrown by user-implemented components.\nThat may be have been the intention, but the reality is that you can construct views / trees of views that trigger invariant errors and fail to render. See my example above.\n. @gaearon \u2013\u00a0will __PROFILE__ additionally keep error messages intact? And can we realistically recommend to React + Sentry users that they can safely/confidently use __PROFILE__ in production?\n. > So maybe I've been lucky, but I haven't seen any production runtime errors from React in our sentry setup\nSo, I want to step back and make this clear \u2013\u00a0this isn't just for us. This is to improve the experience of our customers/users using Sentry to monitor their own React applications (e.g. the original submitter of this issue). And even for the benefit of users of competing crash reporting products.\nI am merely drawing on examples from our own Sentry account to help illustrate the problem.\n. So, to expand on my example issue from earlier ...\nThe problematic code ended up being the following:\njavascript\n<span style={{marginRight: 10}}>{metadata.type}</span>\nIt was expected that metadata.type is always a string. But in this particularly rare case, it ended up being an object with a single sub-property, message.\nSince it was an object, the error message would have been (were it not stripped): \nObjects are not valid as a React child (found object with keys: {message}).[object Object]\n. As a follow-up to this, we've modified @getsentry to fetch the original message and display it in our crash reporting UI. Pull request is getsentry/sentry#3632, announcement on our blog here.\n. ",
    "konklone": ":+1: Yep, no downside, and it prepares the site for eventually being served at an HTTPS connection itself.\n. fb.me is Facebook's, and the URLs it redirects to are on FB's Akamai-fronted CDN. They have an invalid Akamai cert:\nhttps://dragon.ak.fbcdn.net/hphotos-ak-xpf1/t39.3284-6/10574688_1565081647062540_1607884640_n.js\nI think only Facebook can fix that. In the meantime, it's still good practice to provide HTTPS links in the tutorial, and Facebook can fix the fb.me redirects on their own servers without having to update the tutorial code (or the websites of people who have copy/pasted the tutorial code).\n(Just saw @jsfb's comment above, sorry for repeating what he said.)\n. ",
    "lukebayes": "Another +1 on this request. React is extremely difficult to test in headless environments because of this issue.\n. This request represents a superset of Issue #3557 (Teardown TestUtils method).\n. Even if there is a concrete issue with unmount not purging, I would still very much appreciate a single point of entry that reliably destroys/resets all global caches that React modules introduce and hold.\nThis would certainly benefit test environments immediately, but would also allow server-side rendering to be supported with more confidence.\nIdeally, the framework wouldn't create hidden, global state at all, but if it does, it should either provide hooks to clear it, or initialization parameters for clients to provide it.\nJust a shot in the dark, but as for the potential purge issue, I would take a look at any cache management implementation that relies on timers as these don't perform reliably in the test environment (due to fakes/mocks).\n. ",
    "mikew": "So, the issue was fixed in replaceState, but what about components using class Foo extends React.Component {}?\nI'm seeing this when I use setState\n. One thing I'm noticing is that the newer React APIs don't play well with class-based components.\nReact.forwardRef needs to be passed a function and a HOC must be used to workaround. Granted this doesn't affect application code that much, more library based stuff.\nReact.createContext can't be use in class-based lifecycle methods, unless you create a yet another HOC to workaround.\nUntil SFCs can be treated as pure, I'm wary of using them.. ",
    "chollier": "I've been experiencing the same issues recently\n. ",
    "joshfrench": "All makes sense, I just needed a nudge in the obvious direction :) My question was less about props being mutated after the fact and more about implementing stricter validation than just a warning, e.g. rendering null if we know ahead of time the component was passed invalid props from some upstream data source. Thanks!\n. ",
    "francoislaberge": "To be clear, we're building views for our plugin. Which is why we don't have control over the runtime development mode.\n. @zpao I'm installing my own react. Is there one that I can access within react, how do I get access to that?\n. @zpao Hmmm, yeah that's going to get messy quickly as we will be reusing third-party components much. Thanks for the info though!\n. ",
    "blowmage": ":+1:\n. ",
    "drd": "Man. I definitely checked that at one point ;) Let me see what happened.\n. There we go. &nbsp; is treated differently than other entities. \n. I'd prefer not to, but unfortunately iframes only get a valid contentDocument when in the DOM. I've addressed this by immediately removing it from the DOM.\n. I'd prefer to just perform this check in dev mode, that was certainly something I was anticipating :)\n. the devmode block ends on line 901.\n. ",
    "maxlapshin": "Should I try to make pull request?\n. iPad safari.\nWill reproduce it and give you better info about it.\n. ",
    "chadwpry": "Is this related only to anchor tags, or other elements as well? I've seen this when applying onClick to div elements as well as anchors in IE10 and IE11.\n. ",
    "phss": "This is a bit of a newbie question but why not validate for ContextType as well? As far as I understand, they are defined in the same way as PropTypes. Shouldn't they also raise a warning if defined in an invalid way?\n. ",
    "zachhale": "Thanks so much for your responses. Well this is a tricky one then now isn't it. I am completely stumped if there's anything I can do about this.\n. ",
    "zeke": "@zpao is it customary to put [ci skip] on a commit like this? If so, let me know and I can repush if needed.\n. :squashed:\n. :cake: \n. Done!\n. ",
    "qerub": "CLA Signed BTW.\n. (First of all, thanks for the involvement and sorry for creating a pull request instead of an issue even though I knew this wouldn't be a drive-by pull request.)\nI'm claiming the package is usable without the fbjs dependency because the distribution files (in dist/) have a bundled/inlined copy of the library. It seems a bit strange to me to bundle one copy and then force installation of a second copy through the dependency list.\nRegarding envify, would it be possible to split out Browserify-specific functionality into another package (e.g. react-browserify)? I'm not using Browserify and am not too happy with having envify and it's transitive dependencies {jstransform, base62, esprima-fb, source-map, amdefine, through} lying around doing nothing but complicating future application maintenance (think patch/vulnerability management).\n. Thanks for the thorough explanation of your reasoning. I have now submitted a pull request (#6303) for the loose-envify suggestion.\n. ",
    "pvande": "@gaearon Wasn't sure if you wanted separate issues for different causes or if you just wanted a single issue tracking the symptom.  Cheers!\n. ",
    "vlucas": "Is there also going to be a React.createClass({ ... }) way to do this?\n. ",
    "FND": "I agree that maintaining duck typing here is valuable - in fact, I was rather uncomfortable with that typeof check in the first place.\n@spicyj's suggestion sounds like a good one. Alternatively one might check whether the value stringifies to \"[object Object]\", though that seems less elegant and I can't think of a realistic scenario where that'd be more flexible.\nSince I'm not very familiar with React's code base, I'll let you folks handle the implementation (and learn from the diff). So feel free to close this PR.\nThanks for the quick responses.\n. I've rebased and amended my branch accordingly.\nFeel free to suggest a better commit description; my brain's run out of steam for today, so I struggled to summarize the intent.\n. Sorry for dropping off the map here: I'd stopped paying attention, in part because I'm no longer doing React stuff these days.\nConsequently, I'm probably not the right person to see this through - though it appears @aweary has already started picking up the slack, which is much appreciated.. Embarrassingly\u00b9, I did not succeed in combining this check with the one in the warning invocation below.\nWhile the following passed the tests, I wasn't sure it's actually correct, plus it didn't read well:\njavascript\nwarning(\n  !props.dangerouslySetInnerHTML[HTML] ||\n  props.dangerouslySetInnerHTML[HTML].toString !== Object.prototype.toString,\n  '`props.dangerouslySetInnerHTML` should be a string.'\n);\nBoolean logic can be surprisingly tricky.\n\u00b9 cf. comment above: I'm currently very tired - but figured I better get this done right away rather than risk procrastination.\n. ",
    "eoin": "git bisect indicates that this was introduced in https://github.com/facebook/react/commit/e974383cbace7589501f7c5586c02a9a33124f20.\nThe change itself isn't problematic, but it does seem to have triggered an IE9 script engine bug of some sort, resulting in the crash. I've found that a small refactor of precacheChildNodes 'fixes' the issue, but I'm not entirely sure why. \ud83d\ude1e\n. @Aweary yep! I work with @ccoffey \ud83d\ude04, and we've verified that this resolves the issue, with our app, and with the repro-case.\n. @Aweary resolved.\n. ",
    "jdalton": "@spicyj \n\n\nIs that code really setting value? \n\nYeah, I believe so. I'll create a screencast to walk through it tomorrow though.\n\nBased on the repro from #7328 using the latest master branch with and without this PR.\n\n\n\n\n\nI know there's discussion about reworking bits here. On the up side this also reduces unnecessary DOM mutations for attributes \ud83d\ude04 \n. This seems to be resolved in Edge 15.. The linter wanted a trailing comma on collectCoverageOnlyFrom: data so I added it. :confused:\nI noticed other places have trailing commas for arrays. ~~Should I change the package.json addtions in this PR to align to that too and create a separate PR to tackle the other arrays in the package.json?~~\n. async is still doable as a var name even with ES7 async await.\n. Creates a temp jest-config.json in the react/build path so that it's ignored by git.\n. Please tweak the ignore field above to taste.\n. This globs each pattern of config.collectCoverageOnlyFrom with any glob options applied and adds the matches to the new collectCoverageOnlyFrom result.\n. Ah yep, that would have corrected itself pretty quickly.\nI'm guessing the linting rule is only for multiline objects/arrays as it didn't flag single line ones.\n. ",
    "rgrove": "I also have a use case in which I intentionally have the server render something slightly different than the client will render, and it's affected by this change in React 16 as well.\nI have a component that renders a feed of items. On the server I render one page of items at a time, with conventional \"Prev\" and \"Next\" pagination links. On the client I render an infinitely scrollable virtualized list.\nRendering a conventional paginated list on the server helps improve SEO by giving search bots actual links to follow to subsequent pages and also ensures that clients with JS disabled can still paginate through the list.\nThere's no visible flash when a JS-capable client hydrates the list because the only visible difference (pagination links) will typically be below the fold, so this should work out well. However, React 16 reuses certain server-rendered elements without removing their classNames even though the client-rendered state doesn't use those classNames, and this breaks the design in weird and unexpected ways.\nI understand that it's generally not advisable for server-rendered content to differ from client-rendered content, but this was a conscious choice made with full awareness of the disadvantages. I expected a slight performance penalty, but didn't expect broken output.\nIf this scenario really is considered unsupported in React 16 and there are no plans to allow developers to opt into full validation when hydrating server HTML, then it seems like the dev mode warning should be an outright error in order to prevent subtle breakage from slipping into production. This change should probably also be called out prominently in the release notes, since it could unexpectedly break existing code that relies on the old behavior.. > What's your mechanism for silencing the warning in 15? Maybe we can target that as a way to inform you?\nBasically I close my eyes and put my fingers in my ears and yell \"you're not my supervisor!\" \ud83d\ude48 \nI took another pass at my list component using the two-phase render approach you recommended above and it works well, so I think that'll be good enough to cover my use case. Thanks!\nMy guess is I'm not the only one who's gotten used to ignoring that warning, so I'll try to help get the word out about the change.\n. ",
    "evmar": "I work in this space (spent a lot of time fighting with Closure Compiler over the last few years) so if you have any questions feel free to ask.\nOne big piece to be aware of: there are two main ways for property renaming to work in advanced mode, controlled by the \"use_types_for_optimization\" flag.  When it's on, it relies on correct type annotations to know what to rename, which I think is maybe a non-starter for you.  (To be honest I don't know what it does when it's on but you don't have type annotations; it might fall back to the 'off' state.)\nIf you turn the flag off, renaming works globally, in that if a given property name is known to be one to not mangle (e.g. 'getElementById', because it's a DOM API), then Closure will never mangle any instance of getElementById anywhere in the app.  Because of this, one approach that might work for you (rather than adding all the quotes as done in #9293) is to make a single externs.js that just references all known properties off of some fake object.\nYou can see an example of this in this file (forgive the wacky code, it's in the test suite for a code generator), where it stuffs a 'foo' property on a long namespace that will never occur in the real code.  This causes all 'foo' properties to be preserved.\nOf course, the best thing is to be careful to never treat properties as strings, and otherwise use quotes when indexing into string-keyed maps, which then makes it safe to rename everything.  But sometimes that is not possible; depends on your code style.. @appsforartists Within Google we do generate externs for React from the DefinitelyTyped React d.ts files.  The API surface is a bit larger than you'd expect due to including all the CSS properties etc.\nBut it's also probably more complicated than what you want because:\n1) the d.ts files include lots of type definitions (including fancy generics to model setState() etc)\n2) they ended up needing some fixing by hand at the end due to various bugs (in how we handle said fancy generics -- Closure can't model some of them)\n3) if you're just worrying about the untyped Closure optimizations you don't need the types.\nOh, and now that I think harder about it, these d.ts files are for clients of React to use the minified bundle, while here you are concerned about preventing bits of React's internal API from getting renamed.  (You might find this section of the docs useful in that respect.). ",
    "paulbjensen": "I too have stumbled into this issue. We've got an internal project to generate Powerpoint decks with code. Powerpoint files (pptx) are just zip files containing some folders, XML files and any embedded assets. We wanted to use React as a way to generate the XML files, but we can't as there isn't support for XML.   . ",
    "megalithic": "Just recently updated react-dom and am having this same issue, too. @RamIdeas you have any eureka moments you're able to share? :) My project, specifically, is a react-native app via expo; not sure if that helps any.. ",
    "PeterBell": "Hey all - sorry - GitHub demo for students - closing. Loving on the JavaScript. ",
    "jashkenas": "I was just about to write up a different issue for this \u2014 but instead, I'll just pile on to this one. Here it is, pasted over:\nDo you want to request a feature or report a bug?\nA bug, I'm sorry to say. (But it's not exactly your bug ... as will soon become apparent.)\nWhat is the current behavior?\nTo the best of my understanding, during DOM updates, ReactDOM looks at document.activeElement to try and determine the element that currently has focus on the page. Unfortunately, in new versions of Safari, calling document.activeElement, when the active element belongs to an iframe with a different origin than the parent page, appears to throw an uncatchable error:\n\nHere is a minimal reproduction in a JSFiddle: https://jsfiddle.net/Luktwrdm/1484/\nIn Safari, open your console, then click on the \"Click to play\" button (which will call setState() periodically), and then click into the embedded iframe.\nYou'll see the setState calls triggering the error above.\nBut it's really Safari's bug, not yours. If you then switch into JSFiddle's results frame, with text in the iframe selected, any attempt at reading document.activeElement will trigger the error ... and also return the frame:\n\nAnd the error cannot be caught (getActiveElement is already doing this):\n\nWhich versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?\nSafari 12 and React 16 trigger this error. I'm not certain about previous versions of React or Safari.\nSuggested fix?\nIdeally, Safari would quickly release a new version that fixes this error for activeElement. But if that doesn't happen \u2014 I'm not sure if there's any way to safely use document.activeElement in Safari currently.\n. ",
    "joelmoss": "I'm using react-redux, so when passing down an action creator in the props from mapDispatchToProps, and using that action creator in a hook, I get a exhaustive-deps warning.\nSo I can obviously add the redux action to the dependency array, but because the redux action is a  function and never changes, this is unneccessary right?. I totally understand, and I would normally do all that for you, but in my specific case, none of the code is unique to me. It's simply a question about whether the use of a function that is defined outside of the hook (ie. a redux action creator) and used within a hook should require that function to be added as a hook dep.\nHappy to create a codesandbox if you still need more info. thx. Trying again... but simpler this time ;)\nWhen passing down a function in the props, or indeed from anywhere, and using that function inside a hook, I get a exhaustive-deps warning.\nSo I can obviously add the function to the dependency array, but because it is a function and never changes, this is unneccessary right?\n-> Sandbox\nHope that is everything you need, but I simply forked @siddharthkp's sandbox as that demonstrated what I meant.\nthx.. > functions can change all the time when the parent re-renders.\nSure, but if the function were defined elsewhere and not from a parent component, it wouldn't ever change.. thx @gaearon . ",
    "lguzzon": "It's really necessary to do this? or just set the variable in \ncomponentWillMount()\nand use it in \ncomponentWillMount()\n. ",
    "martinbean": "I see :disappointed: \n. I\u2019m not particularly attached to RegExp; in fact JavaScript isn\u2019t my main proficiency as you may see above! That class toggle function was just something I cobbled together without the comfort of jQuery.\nI\u2019ve pushed the style changes mentioned, and will look at improving the JavaScript for the responsive menu.\n. ",
    "paulshen": "nit: put the last sentence before the sentence on event handlers?\n. did you mean to clone this._defaultProps here? this mutates the default prop object which gets reused on each pass.\n. ``` javascript\nMyComponent = React.createClass({\n  getDefaultProps: function() { return {}; },\n  render: function() { ... }\n};\n// render \n// update with \n```\nwe'll see that disabled is true for the second pass because this._defaultProps has been modified.\n. ",
    "slevithan": "You can't use word boundaries (\\b) for this since hyphens are valid in class names. You need something like new RegExp('(?:^|\\\\s)' + tclass + '(?:\\\\s|$)').\n. ",
    "futuredarrell": "Hey there - as someone who isn't using React and is evaluating it for an upcoming project I would say the top two changes are quite effective but this last point could probably be made better.  Personally, \"one-way data binding\" sounds like repurposed jargon from other projects.  Also - why is the \"one-way data binding\" simpler, faster, and easier to scale?\n\"Data Flow\" is a great point though.  Why not something along the lines of:\n\nReact flows data in one direction through your component and into the DOM as efficiently as possible.  This keeps your app lean by reducing boilerplate view code and easy to reason about by eliminating side effects that come with syncing state in both directions.\n. This feels a bit weird at the end.  Would chop it or at least make it gender-neutral.\nBy giving the users the choice to chose the key, they have the ability to shoot themselves in the foot.\n\nCheers!\n. ",
    "jessep": "I believe I am your intended audience (read the docs, familiar with basic mechanisms, haven't built much in it yet, want to see big picture). I really like the post, it's super helpful.\nI had a question here you might want to address: how to handle changes to the product list coming in from the server, assuming they happen. Most apps with any realtime component are going to have this issue. Maybe this is beyond the scope of the article, but it stuck out to me.\nMy assumption is that I handle the product list changes outside of react, in my own data layer, and pass the whole dataset it in as a prop to the root component, re-rendering whenever the product list changes? Is that right?\n. Yeah, that makes sense, except I'd assume the api would return incremental updates to items like {'operation':'edit', 'id':'basketball121', , 'price':539}. But your example is still illustrative, the callback for the interval would just merge that change into the currentProducts and set state returning the whole thing. \nIf I had a product list of 50K items, say they're nested (which is what my actual product is often like), would I still  setSate on the entire list, or would I want to come up with a strategy where I can setState on individual products somehow?\n. Ha, yeah, that's why I was asking. Anyway, I'll stop hijacking the thread :) \nIt's a great post. Like @chenglou I'd recommend inlining a few pieces of code. \n. ",
    "bitshadow": "Oops..\n. ",
    "mdebbar": "s/bubbles/bubble\n. ",
    "joeyyang": "Makes sense -- please see updated PR. Thanks!\n. Sorry -- do you mean including this.data.push(comment) inside addComment, and including a call to CommentsService.addComment inside handleCommentSubmit?\n. ",
    "ericflo": "Hmm you may be right, I only tested that it properly creates the image in the first place -- didn't try changing the value once it was rendered.\n. Happy to change it to xmlnsXlink if that's better.\n. I haven't gotten a chance to work on it.  In fact, I ran into enough issues with SVGs that I had to actually just bypass React for now for this part of the project I'm working on.\n. ",
    "martinklepsch": ":thumbsup: \n. ",
    "dazld": "process.nextTick would be more useful on the server...? why zero timeout?\n. I think a lot more people use node than other server side js environments, and even then, could shim this to use node conventions as default, falling back to setTimeout for other platforms. (very personal bias though!)\n. true that, anything that runs on client would need to avoid nodeisms. I think I saw somewhere a comment about using setImmediate..? there's a nice discussion of the problem with setTimeout's clamped minimum values vs real nextTick deferral here: http://jphpsf.github.io/setImmediate-shim-demo/ \n. ",
    "jjt": "I think it has to be if a value is strictly true, and not just truey. Otherwise a value of \"myAttrValue\" would emit a bare attribute. I guess that might be favourable to force HTML5 compliance. But it takes away the ability to target XHTML with disabled=\"disabled\" (if that matters).\n. What? People play it fast and loose with js types?!!?\nI tend to agree with you though inre: no XHTML support. It would fit with the current system of passing a falsey value to omit an attribute.\n. Right, good call.\n. @zpao Right, that makes sense. Fixed.\n. ",
    "BinaryMuse": "A minor note as I was glancing through this: \"npm\" is not capitalized :) https://www.npmjs.org/doc/faq.html#Is-it-npm-or-NPM-or-Npm\n. ",
    "jgebhardt": "Thanks! Will update that.\n. ",
    "brandonbloom": "I'm not a TDD sort of guy.\n. ",
    "fisherwebdev": "I can add simple localStorage for sure, but that only tells a fraction of the tale.  How far down that road do you want to go?  Optimistic rendering?  Error states?  I left all this out to keep it simple, but yes I can certainly add some code to maintain localStorage data.\n. I see what you mean about the redundancy of the two loops.  \nHowever, the store should manage and report on its own state, and the render function should just handle rendering, with as little data massaging as possible for the sake of the child components.  This is the ideal separation of concerns.  \nWhen I first read your comment, I thought that perhaps we could allow this component to manage that state for the sake of optimization.  But then I realized we would be needing to call setState somewhere so that _onToggleCompleteAll() would know which way to toggle, and I started to wonder if any optimization was really going to be possible.\nBeyond the issue of setState, generally speaking, when developing a large and evolving app, I think it's often better to stick with the separation of concerns and only optimize when you really need it.\n. I would not equate the controller-views here with presenters.  I think much of what a presenter does is actually going on in the dispatcher.  I'm looking at definitions of MVP like Fowler's GUI Architectures -- if you have a differing definition, please point me to it.  \nBut I agree that a naming convention could be a good idea, especially as an application grows.  I have seen the word \"Section\" appended to the name of these controller-views to show that they are in charge of a section of the page.  In fact, this is why MainSection.react.js is named like this -- I originally had the controller logic there, but had to move it up.  Since the controller-views also often serve an important layout role, I think the naming should reflect that role.  But this naming seems like something that could be specific to a particular application's or development team's needs.\n. Yes, part of the problem here is that Facebook has not yet open sourced it's own Dispatcher.  This will probably happen soon.  One missing method here that explains the use of promises is waitFor(). This method allows a store to wait for other stores to get updated first.  I had done this in an earlier draft of the application.  I could add that in, commented out as a block, as part of an explanation of what is happening here.  The only problem with that implementation is that if A waits for B and B waits for A, you have a circular dependency.  And a robust Dispatcher would throw an exception with a human readable error message in that scenario.  This is not possible with promises as far as I know.\n. Great catch here.  Thanks for all your comments.  Lots of great stuff.  Expect a new commit soon.\n. Yes, normally one would have something like a TodoConstants.js module and store things like this there.  I pulled that out in an effort toward reducing the number of files a newcomer would need to look through, but I can put that back in if you think it's important.\n. Thanks for catching this.  \nStyle nits: please expand the anonymous function to three lines instead of putting it all on one line.  Also please add the semicolon at the end.\njavascript\nvar selectedPromises = _promises.filter(function(/*object*/ _, /*number*/ j) {\n  return promiseIndexes.indexOf(j) !== -1;\n});\n. Note that it returns\n. style nit: Local variables should not have the underscore.  Underscores are used throughout this code to denote private variables in the module's closure.\n. No way to get offsite links into the nav?  This is a bit of a bummer.  I'd rather be making more connections between React, Flux, Jest, etc rather than less.\n. sweet solution here!  much cleaner.\n. awesome.  thanks!\n. The conference was called ForwardJS.  http://forwardjs.com/\nNew Circle is the video production/hosting team they hired.\n. ",
    "Raynos": "Is communication between actions & stores through strings necessary ?\nIt should be possible to preserve uni directional behaviour and communicate through value references.\n. I didnt mean placing the strings in one location. I meant not using strings at all. \nFor example the different between emitter.emit('some_string', value) vs emitter.some_string.emit(value)\nThe latter would allow you to pass the values directly from file A to file B instead of having the two files communicate through shared strings\n. I would recommend that dom-property-config contains two files html.js and svg.js\nThen you can require('dom-property-config/html') and require('dom-property-config/svg')\n. We need to export Constants somewhere.\nAn alternative to exporting it is require('dom-property-config/constants').\nConstants contains the numbers you need to | and & against.\n. good idea.\n. Oh I see. good point. \n. ",
    "zichun": "gah my bad. fixed \n. ",
    "georgesisco": "Ok. I completely missed that. Let me fix that up and push the file again. Thanks for the help!\n. @zpao, I've updated the file. Would you take a look? I spent a while trying to figure out how to preview it in it's final form, but I finally just copied each snippet into my editor and grabbed the line numbers from there.\n. ",
    "volkanunsal": "Done and done done! \n. ",
    "danielschonfeld": "so are we good leaving it outside the try/catch? I'll remove the parens.\n. Let me know what you want to use after you are done referencing fb code.\nIf it's just warn or more than just console.warn.\nI'll take care of that displayName issue\n. will do\n. I thought it was referenced before that we want to remove the DEV question...?\n. Sounds good to me and no problem on the rebase... I wasn't sure how you guys work this and if you guys wanted to do the rebase a moment before merging.  Will do both \n. ",
    "nhunzaker": "Ah, I should not have been such a copy cat. I've addressed this in 81cf316\n. Nixed, (amended to commit)\n. javascript\n// async, however scripts will be executed in the order they are in the\n// DOM to mirror normal script loading.\nsufficient?\n. Done\n. That's a fair question -- I'd need to hunt down the specification for disabled elements to speak with any confidence. As for placing this in a separate file... yes -- but is there an existing location it should go?\n. Pure joy...\n\n. Yes.\n. Huge :+1: \n. Yes please\n. See reply below\n. Done\n. Though we still need to clone the props. A couple of tests actually fail if we don't.\n. This comment does feel superfluous, with the comment at:\nhttps://github.com/facebook/react/pull/3349/files#diff-7697f9038a7012efcea5287199198866R30\n. Correct. I missed this when I transposed over from my dead fork :-/. Good catch!\n. Good point. Looking at this again, I've got a new thought regarding assign. I'll post that in a second.\n. I don't need the {} here - DisabledInputUtils returns a new object. @gaearon should the name of getNativeProps be changed to make that clearer - or do you think it is not necessary?\n. Ah. We can't get rid of the {}, because getNativeProps might return the original object.\n. I'm playing around with an idea to try to save that object allocation, but to directly reply to your comment. It should be consistent with the other components. I'll do that now.\n. Okay. I believe I've addressed the original desire with 2eeebf9. I've also rebased from upstream.\n. \n. There's a small optimization here. No need to check hasOwnProperty if the key is a disabled event handler.\n. @gaearon I know you just tested this everywhere, but do you mind if I change this to:\njavascript\n    for (var key in props) {\n      if (!disableableMouseListenerNames[key] && props.hasOwnProperty(key)) {\n        nativeProps[key] = props[key];\n      }\n    }\nIt'll cut hasOwnProperty checks.\n. Oh it might save a few microseconds. I'll go ahead and do it, since I've got everything open still.\n. Done it 6a1b3cc\n. I updated the warning copy here to make it clearer what's going on. Happy to change this.\n. Looks like this is no longer a problem with https://github.com/facebook/react/pull/2532\n. Ack. Okay. \n. Got it:\n// The ChangeEventPlugin registers a \"propertychange\" event for\n      // IE. This event does not support bubbling or cancelling, and\n      // any references to cancelBubble throw \"Member not found\".  A\n      // typeof check of \"unknown\" circumvents this issue (and is also\n      // IE specific).\n. Ack! I crossed the streams!\nThis PR was supposed to be solely for fixing defaultValue, but it looks I got my branches mixed up and pushed the more general fix for both inputs. I actually just replied here:\nhttps://github.com/facebook/react/issues/7253#issuecomment-235602919\nAgain, pushing to this branch was a total accident. A bunch of tests fail now. I'll work on getting those to pass in the mean time, but could definitely use some advice.\n. Type coercion solved my problems, however it makes the initial case hard. Empty inputs are always equal to 0. \nI think this could be better. Any suggestions?\n. Technically no, though it's against the React style guide all the same. \nESLint seems to struggle with else if. The only other valid option I can manage is:\n``` javascript\nif (event.stopPropagation) {\n  event.stopPropagation();\n/ eslint-disable valid-typeof /\n} else if (typeof event.cancelBubble !== 'unknown') {\n  / eslint-enable valid-typeof /\n}\n```\nOr we could flip the if to place typeof event.cancelBubble before the event.stopPropagation check.\nI know this is annoying and silly. Thank you for your patience on this.\n. One thing I'm not clear on yet: Why assign the value attribute at all?. \nReactDOMInput will assign the value property in updateWrapper. We could do that in mountWrapper as well. Is it important that the attribute be assigned?\n. Hmm. Neat. I need to check to see if this influences my Chrome backspace issue PR (#7359)\n. Looks like no. At least from my test case:\nhttps://gist.github.com/nhunzaker/d31817ffd48279b4bf1f7513dd84f400\nI don't want to make you all linger too much on this. I wish I understood how the detachment works better. Is it possible that this case is display-only?\n. Yes, though you've just now answered it. I am sorry to have forced a quick lecture on the DOM :).\nI wanted to figure out if the delinking here eliminated the need for the fix I added to #7359 where defaultValue is only reassigned if it is different. \nFrom a quick test outside of React, I thought this PR would make it unnecessary. However it isn't, and I became confused. It looks like, no matter what, value and checked get assigned in ReactDOMInput.getHostProps, and subsequently get sent out as DOM mutations. Even for uncontrolled inputs.\nSo that's what I'm working through now. No need to continue talking about it here, but I'd like to avoid being able to do the comparison check  and wanted to better understand the solution in this PR. \n. I'll run a benchmark. In an earlier version of this PR I stored the properties in an array and an object to eliminate indexOf calls, but I removed it because it added extra parts and primitive benchmarks of indexOf weren't compelling (especially with the general performance improvement by eliminating work in ReactDOMInput).\nSo let's find out!\n. Formalized my original benchmark and put it on the internet:\nhttps://github.com/nhunzaker/react-ordered-props-bench\nI'm happy to accept any profiling tips here. I'm a heavy user of React and benefit from accuracy. I want to get this right.\nFor your specific question, I added a bunch of properties (custom attributes, if that matters) to some controlled inputs:\n```\nhttp://natehunzaker.com/react-ordered-props-bench/heavy-props.html\nCONTROL 1628 (+= 2.299877893626147)\nEXPERIMENT 1750 (+= 1.870748777520246)\nFastest is EXPERIMENT\n```\nThough the noise makes it hard to say it's faster, I do not think it is slower.\n\nUnfortunately, I noticed that there seems to be a performance regression with uncontrolled inputs:\n```\nhttp://natehunzaker.com/react-ordered-props-bench/uncontrolled.html\nCONTROL 5307 (+= 3.5737538615198474)\nEXPERIMENT 4475 (+= 2.2288121746511043)\nFastest is CONTROL\n```\nUnclear why I didn't catch this before. I'm also not sure specifically why there's a regression. This PR includes fixes to \"decontrol\" uncontrolled inputs (so that they don't reassign themselves and screw up number inputs). I do not know yet if the performance degradation relates to that, or the ordered properties approach generally. I'm looking in to that now.\n\nOne other interesting secondary finding is that the _handleChange binding always gets applied to uncontrolled inputs, even if there is no change handler:\nhttps://github.com/facebook/react/blob/master/src/renderers/dom/client/wrappers/ReactDOMInput.js#L79\nBest I can tell this is waste. Is there a good reason for _handleChange to fire on uncontrolled inputs? If not, we could kill some overhead here.\n. True. Would it be unreasonable to extend this to text inputs?\n. Oof... Yes. Looks like there's also no test coverage here. I'll add that as well.\n. Done. I inverted the check and added test cases.\n. I had it reversed (sorry). It now reads: \nif (registrationName === 'onClick' && !isInteractive(inst._tag)) {\nInverting the isInteractive check.\nBasically, iOS safari only exhibits the event bubbling issue for\nnon-interactive elements (like divs). Extra event handlers can be\neliminated by only attaching this event listener on those non-interactive\nelements. Since the check was already created for the mouse events filter,\nI went ahead and added it here.\nThis trades an event listener attachment for function invocation (that'll\nprobably get inlined), when I ran the numbers it seemed much faster\nhttps://gist.github.com/nhunzaker/020335ee8ec0f1d487f97c7ddcfbd4a2.\n. Hmm. So actually: should the value attribute update for anything other than checkbox and radio?\nFollowing browser behavior, editing the text inside of a text input doesn't update the value attribute. \nPossible my current code doesn't do this, but to me that's the correct functionality.\n. There is an extra complication here... Assigning the value attribute forces validation for number inputs. Check this out:\n\nNotice how the decimal gets stripped? My fix focuses on avoiding touching the input as much as possible to avoid unexpected behavior like this. Fortunately, I believe this also conforms to the standard way inputs work. \n. Looks like this is taken care of, because node.value on progress is never assigned, so it's out of sync with props.value, and it reassigns the attribute.\n\n. \ud83d\udc4d \n. Sorry, for whatever reason I totally caught your comment wrong before. Just a sec. \n. [null, null] returns for just about every single event plugin test that executes the EventPluginHub.extractEvents code path. \nQuickly scanning (throwing on [null, null]), this is 22 of 24 SimpleEventPlugin tests, 7 of 9 ChangeEvent plugin tests, and a handful of other event system tests.\n. Actually, if I'm interpreting the coverage correctly, BeforeInputEventPlugin has pretty weak coverage:\n\n\nIt's possible this is just really hard to test (keyboard stuff). Looks like neither event types (composition or beforeInput) ever instantiate. \n. Ya. Took care of that in #7359. \nHmm.. This PR is creating some extra noise for the input issue. Should I close this for now and resubmit after that settles?\n. Ah heck, I'll just bring it over while I'm thinking about it. That way things are at least up to date. Thanks for the prod!\n. Added, and I brought over the <progress> test case from #7359 too. Though it re-introduces the input[type=\"number\"] decimal place loss issue. Either way both PRs are synced.\nI don't feel awesome about this value mutation method, but with all of the mutations in one place, it's way easier to reason about  the [type=\"number\"] issues on this branch. Curious if I'll get any inspiration shifting back here.\n. Did some furniture moving of the factory tests, which failed CI. So I updated the test recording using:\nscripts/fiber/record-tests --track-facts\nDid I do this correctly?\n. Yeah, I figured that out later, when I hit a permissions issue not having write access to the repo. Everything else worked perfectly.. Hmm. ReactTreeTraversal uses this check: \nhttps://github.com/facebook/react/blob/master/src/renderers/shared/shared/ReactTreeTraversal.js#L20\nif (typeof inst.tag === 'number') {\nIs that the preferred route? Would it be worth making that a more established convention?\n. Sorry... tunnel vision. There's also the condition above it:\nhttps://github.com/facebook/react/blob/master/src/renderers/shared/shared/ReactTreeTraversal.js#L17\njavascript\n  if (inst._hostParent !== undefined) {\n    return inst._hostParent;\n  }\nWhich could be subbed out for inst._currentElement in this case.. This won't get called anymore. Though I'm unclear why. I had thought this function was a filter/transform step for props before they entered the component. When I follow the stack trace for the blur event, this doesn't seem to be the case. . Thanks for the insight! Change soon.... Basically, onBlur just sets the target node's value attribute to it's current value, but only if it's a number input. I don't know that this is the best place to put this. Any suggestions? \ncc @spicyj ?. Does this sufficiently cover this feature? \n\nCoverage of non-text inputs\nCoverage of focused number inputs\nCoverage of focused number inputs that get blurred\n\nAny edge cases I'm not thinking of?. One. Uncontrolled inputs... Writing a test case for that now.. Okay. Covered. Though I had to expose controlled as a wrapper state value.. I've only done it for the basic example, but I could imagine doing this everywhere. We could also add an extra flag to pull in Babel.. Totally arbitrary and temporary list. What's a good way to pull in all of the version data?. @vinnymac Very cool. I think tags is precisely what I want.. Added. We'll pull from the Github API, though this fails in IE9 because of silliness with CORS and XDomainRequest. Something to figure out later... \nOtherwise, this page looks good and works down to IE9.. Curiously, I couldn't find anything about base line browser support for React. Would it be the same as Facebook? Either way, do you know what this support matrix looks like?\nOtherwise, drawing from the list of ES5 compliant browsers makes the most sense to me:\nhttp://caniuse.com/#search=ES5. Ah... neat. Thank you!. Hmm. Yes. I'll through a conditional around this that does a comparison of the value property. \nCould the input value tracker help us out here to avoid DOM access? cc @jquense . Fine by me. create-react-app comes with it already too.. A prestart command that copies everything over is fine by me.. \ud83d\udc4d. . Should this value be in initial state?. no need to bind onChange if we're using createClass. Probably my mistake :). Reply via email didn't match up:\n\nNaw, we don't need to reload, but I don't know how much we want to mess\nwith history API support. Worth it, you think?. It sure does.. Oh, herm... I'll check. Be back shortly.. Checks out for me down to IE9 and all major browsers. Thanks, \ud83d\udc4d . Huh... was there a recent fix for inputs in Chrome? I can assign node.value = \"0.0000\" and it totally just works... I don't believe that was ever the case before.. I threw a TODO in here. This gets called later down the road. I'm unclear why, in IE9/10 only, it's getting called with a nully instance.. Sure can.. Done, though it feels a bit cumbersome. Do you know of a better way to make this check?. Ya. I went with createClass for backward compatibility reasons, but that might cause forward compatibility issues I'm the future.\n\nHow far back do we want to support?. That would be really cool. How fancy a fixture tool we are making.. I'd be happy to pick up some of the work here. @jquense if you are busy on other things, I've got time to work on this bit. Would a PR to your branch be fine?\nOr if you wanna jam on it, that's fine too. I just wanted to pick up some of the load.. Double spaces here? . Is this always going to be the current version you have loaded? So if you load 0.13.0, will it say local 0.13.0?. Do we want to hold on to this log?. Should this be 2 space indentation?. WINDOW_HANDLE could actually be removed too.. I can verify. As for history:\nReact controlled inputs sync up the value attribute with the value property. This prevents state mismatches with form.reset() and browser plugins (though i never got a reply on which ones). Unfortunately, on number inputs in Chrome and Safari, this forces a check on the input, removing trailing decimal places, invalid characters, etc. \nThe only way i could get around this (i tried for months, off and on) was to defer setting the value attribute on blur.\nI haven't done much with enqueueStateRestore. I'll give it a go.. That would be lovely. The only edge case is form.reset(). Honestly, I'd be in favor of just adding a warning about this, or enqueing updateWrapper on the reset form event if it can be done.. Assigning defaultValue has the effect of updating the value attribute. Which puts us in the same boat. the only trick with supporting form reset would be the execution order. Last I checked, reset emits before the input actually changes. We'd have to do some sort of next tick behavior. I'm curious what the order of execution would look like to a user in the browser. Would it be transparent?\nSomething I can figure out.. I have an issue out for this, but we never finished the discussion:\nhttps://github.com/facebook/react/issues/8011. In most cases I can think of with manual manipulation it's actually undesirable to set the value attribute because you want to rely on form.reset. at least, this has always been the case for me. Being able to style text inputs based on a dynamic value attribute is a privilege react provides, one I would be comfortable with no longer having. \nReact doing Dom manipulation, the correct way, is the abstraction I've always had. I think this is a very strong metaphor that makes it easier to reason about what react is doing. We deviate from that with controlled inputs. I'm in favor of this change, which moves closer towards that idea.\nSo I agree, armchair theory aside \ud83d\ude02. I can start scaffolding out what that would look like, but I won't be able to pick it up until Monday, if someone else wants to give it a shot.. This object is the exact same as EventConstants, sans the values. Has there been any thought on consolidating them into EventConstants?. I'm going to kill some of this whitespace noise.. Yep!. :+1:. @spicyj I've added touch cancel and touch end to the list here \u261d\ufe0f. They'll get attached locally now.. I like this, \ud83d\udc4d . I think I read somewhere that React is getting into the habit of wrapping keys that shouldn't get modified with quotes. I went ahead and did it.. Rollover from EventConstants. Happy to remove though.. Sure thing.. Ah right, it gets referenced here: https://github.com/facebook/react/pull/9512/files#diff-1ca53ffa4da75a64f7c3b2f131f62da7R21. Done!. Done in caccf43. Cool. Done!. Good question. I'll write up test case.. Could you use jest.fn()? You could run an assertion like:\n```\nconst onError = jest.fn()\nconst onLoad = jest.fn()\nReactDOM.render(, container)\nexpect(onError).toHaveBeenCalled()\nexpect(onLoad).toHaveBeenCalled()\n``. Nitpick: what aboutcontainer.querySelector('svg')`. Nit pick: Should there be 2 space indentation here? It may not be necessary after the comment below.. Nitpick:\n\"Profiling Components with Chrome Performance\" reads funny to me. What about something like: \"Profiling Components with the Chrome Performance Tab\". This is vendor code. Could you revert this change?. For other reviewers, the change here is from \"behaviour\" to \"behavior\". Hey! This typo is me! Thanks!. Ironic. Reads well to me. \ud83d\udc4d . I don't think so, because the old listener gets torn down when the property changes, and does not get reattached if it is the same. I'm adding some tests to verify.. I added two new tests to check for this in: 29a888a. Do you think this sufficiently covers it?. Ah okay. Also I'm wrong. It looks like this code went away:\nhttps://github.com/facebook/react/blob/master/src/renderers/dom/stack/client/ReactDOMComponent.js#L916-L918. Either way we can't re-attach listeners. I'll use dispatchEvent and see what I find.. Good catch. Yes. I'll send out a PR shortly.. Done! https://github.com/facebook/react/pull/9806. Is this true? No matter how I assign data attributes, they always appear, regardless of boolean values:\nhttps://codepen.io/nhunzaker/pen/YVoYMV?editors=1010. I don't know if there is any cross over with #9806, but I'm curious, if we move forward with this, how value should be treated. \nWe have a special mutation method for value that might need to be synced up with this new logic, but as far as I see it, value={true} should stringify to \"true\", which is what would happen if you mutated the input directly.. Nitpick: Could you capitalize \"Decimal\"?. \ud83e\udd26\u200d\u2642\ufe0f. What do you think of:\n\nWhen extending a class component in React, always call the base constructor with props.\n\n. Ah, that's true. It may not be necessary, but excluding props also might still be outside of the intended contract for the React.Component constructor. Other docs do state that props should always be passed to super.\nSo there's inconsistency here. It might not matter, but I'm curious for @gaearon's take here. Is calling super() without passing props problematic for present or future versions of React? \nIf a hard fast rule of \"always all React.Component.constructor with props\" isn't true, we should take a pass to clear up the ambiguity.\n. Sorry to be pedantic, but this shows up again in the API documentation for React.Component.prototype.constructor:\nhttps://facebook.github.io/react/docs/react-component.html#constructor\n\nWhen implementing the constructor for a React.Component subclass, you should call super(props) before any other statement. Otherwise, this.props will be undefined in the constructor, which can lead to bugs.. Shouldn't yarn.lock take care of this?. Ah, fair point. \n\n\ud83d\udc4d I'm in favor of this. I can see it being annoying to randomly write a bunch of changes. . The cert failed for me here, does this website support SSL?. I find having a lot of operators in a tight space can be hard to parse. I like it as a ternary.. I could go either way, but I'd like to lean on the side of simple for a tutorial. . Sort of beside the point, but I'm curious if this warning gets lifted out with uglify. Has there been any consideration to a warnOnce?. Could these be collapsed into a single break;, like:\ncase 'data-reactroot':\ncase 'data-reactid':\n  // etc\n  break;\n?. Awesome, that's great to know. Very cool.. :+1:. I was also drawing from:\nhttps://github.com/facebook/react/blob/master/src/renderers/dom/shared/eventPlugins/SimpleEventPlugin.js#L156-L186. Woah:\njavascript\niframe.contentWindow.window.HTMLInputElement instanceof HTMLInputElement // false\nToday I learned..... Seems like we could at least get some test coverage for this. I'll dig into that too. Though, if we don't have any coverage for it presently, I wonder if it's just a can of worms in JSDOM.. How much slower would it be to do something like:\ngetInstanceForNode(elem)._tag === 'input'\nThat gets us around working with the DOM.. Oof. I finally did it. Please see:\nhttps://github.com/facebook/react/pull/10150. Nit: what about as of instead of on?. Ah man - you know what? Prettier/Lint doesn't run on the fixtures!\nOtherwise I use prettier on every single project :). Wow. Nice. \ud83d\udc4d . Good call. I've done this in d819828. Doing some local testing, looks like this causes a failure on line 103:\nhttps://github.com/jquense/react/blob/15228e8b5f9d056d475955a54723cd906ffa5619/fixtures/dom/src/components/TestCase.js#L103. Oof. jeez that's a difference.. @gaearon how's this sound? too direct?. Also, I've just added quotes around class and className for consistency.. Was there an alpha, beta, and gamma? \ud83d\udc31 . Hey look, I fixed the final Fiber warning. \ud83d\ude44 . This file is misleading. I've skipped some tests related to the unknown attribute list and ARIA rules. I think we could enable these again by moving the attributes we eliminate from the whitelist over to the attribute warning hooks.. Curious about the performance difference with this gone.. As small as this list is now: I can't help but wonder if we could manually write out the property info listings instead of enumerating over them on boot. In particular: \n\n[ ] What does this look like post gzip?\n\n[ ] How does this improve initial bootup?. I can give it a shot! I'm curious if we can even approach this code path externally. I only discovered it after I removed the custom attributes checks for data and aria attributes.. What would we lose?. This is a frustrating constraint, but it sounds we can't do anything about it. \ud83d\udc4d. . Sorry if this was asked before: why the switch from click to change?. Ah, cool.. Where does requestAnimationFrame come in?. Cool. I like this better too, but I wasn't sure on the legacy. \ud83d\udc4d . \ud83d\udc4d . I think this is fine.. I think having them here plus a todo for further investigation sounds good to me. . Why 10?. Yep. I'm doing that now.. @jquense I think this should take care of attribute warning helpers. Though I'm going to work on ways to make this more concise :). What about using Element.TEXT_NODE instead of 3? Is that possible?. This just checks a complex component structure of no-render values? Pretty neat that this can just be data.. I wonder what happens if you pass onChange to a web component. Hmmm. I'll investigate.. \u26a0\ufe0f \u26a0\ufe0f \u26a0\ufe0f  This typeof value === 'function' prevents properties with a function value type from being written to markup. Chances are that this isn't great. I'm working through how we might better track allowed event handlers and omit them for server renders (this could probably be PR'ed separately to master if someone else doesn't get to it first). @gaearon Should I revert any updates to fiber tests?. @gaearon Just to confirm: I'll remove this flag?. @gaearon Just to make sure I interpreted your comment correctly, custom attribute logic follows:\n\n\nReserved words are not allowed\n\nnully values are allowed for property removal\nAttributes we know about are allowed\nData and ARIA attributes are allowed\nFor anything else, if the value passed for the attribute is a string let it be assigned\n\nA nice side-effect of this is that it gets around needing to know about event registration names for server side rendering. However I would love to allow numbers, strings, and boolean values for this check. If we did that, we could remove the isCustomAttribute check all together, cutting a bit of code and eliminating the overhead of the regex matching for every attribute assignment. Maybe that has to happen later.\n. Just got your comment about numbers and booleans. I'll update the code.. \ud83d\udc4d. 0d9347d. What. What. \nThe learning never ends. Do you know where I can learn more about why this checks document.all?. Fine by me. 8d775f8. Good call. I don't know what to believe anymore now that document.all is in my life. Does this update (be4c9328cd5ec54bf9f132dc92214b47227ebf5f) make sense?. Sounds like a great idea to me. I've also taken a quick pass at the intro of the related documentation (07af3db).. Good question. This goes back a really long time, and I can't remember. I'll just remove them.. Sure thing. \nHow should server-side rendering render an object attribute?. Here's my (failing) test case:\n```javascript\n  describe.only('dynamic injection', () => {\n    beforeEach(() => {\n      // HACK: we reset modules several times during the test which breaks\n      // dynamic injection. So we resort to telling resetModules() to run\n      // our custom init code every time after resetting. We could have a nicer\n      // way to do this, but this is the only test that needs it, and it will\n      // be removed anyway when we switch to static injection.\n      onAfterResetModules = () => {\n        const DOMProperty = require('DOMProperty');\n        DOMProperty.injection.injectDOMPropertyConfig({\n          Properties: {foobar: DOMProperty.injection.MUST_USE_PROPERTY},\n        });\n      };\n      resetModules();\n    });\nafterEach(() => {\n  onAfterResetModules = null;\n});\n\nitRenders('injected attributes', async render => {\n  const test = {}\n  const e = await render(<div foobar={test} />, 0);\n\n  expect(e.foobar).toEqual(test)\n});\n\n});\n```\nWhat is the best injection to test with minimal friction, or should I start thinking about this case (server rendering an object attribute).. Or am I just over thinking this, and should I keep the test case the same?. Done in 0f54e82. I wasn't able to figure out SSR rendering for objects, but I've added back coverage with c45985b. I added a custom attribute name alias to ensure it's covering custom attribute behavior.. That works for me. \nFor the future, do you know if injections are being used anywhere else? I think it might be possible to remove the injection code all-together and just maintain a static list of \"special\" attributes (at some point).. Done in e2160c9. I've left the injection test, but i've also added a specific ajaxify test to ReactDOMComponent-tests. Let me know if this is overkill.. Should the whole describe block just go?. Cool. Got it.. Looks like this thread is still alive, but we've dropped this test block now that we have coverage in ReactDOMComponent-test.js and ajaxify is a protected attribute in HTMLPropertyConfig.. Got it.. Yikes! Yes.. Fixed in 3a50c07. Got it.. Ack! This is a mistake \ud83d\ude22 . Excellent questions. I will verify. . Added back in a218130. > I imagine we don't get into style branch on the client because there\u2019s a hardcoded one earlier.\nWe don't get to the style branch, but we validate all properties here:\nhttps://github.com/facebook/react/blob/master/src/renderers/dom/fiber/ReactDOMFiberComponent.js#L406\nThe UnknownPropertyHook calls DOMProperty.shouldSetAttribute and sees that the style property is using an object, so it warns. This check doesn't happen if the style property is in the attribute config.\nSo keeping style: 0 here prevents the warning.\n\nWhat about custom elements? Does style still work correctly on those? (And did it at all in the past?)\n\nWhat is the intended behavior of passing style to custom elements? Should it pass the value \"as is\", or provide style pre-processing? Right now it looks like it's sending down a style string.. Updated this to check the value in a871d55. Sure. \nLines 234-237 (setInitialDOMProperties)\nI replaced all instances of DOMProperty.properties[propKey] || DOMProperty.isCustomAttribute(propKey) with a new check: DOMProperty.shouldSetAttribute. This provides a similar assertion: should the attribute be written to this DOM element? This function checks DOMProperty.properties[propKey], but adds additional rules for what are allowed as writeable attributes if property information isn't otherwise specified: \n\nIs the property a reserved word (skip)? \nElse is the property an alias of another attribute (skip)?\nElse is the property null, undefined, or within the properties we pre-approve (keep)?\nElse is the property value a boolean, number, or string (keep)?\n\nLines 278-281 (updateDOMProperties)\nMore or less the same thing as setInitialDOMProperties. We only want to operate on properties that we know can be written to the element. This is after a series of checks for reserved properties like dangerouslySetInnerHTML and style. \nLines 1022-1024 (diffHydratedProperties)\nI removed this condition because, before this change, only custom elements were allowed to have custom attributes. Now both custom and regular attributes can have custom attributes, so they can share the same logic. This logic follows:\n1.Lines 1019-1026: If the element is not custom, and there is property info (we have a property injection rule for it), get the value for the property, using an aliased attribute name if need be.\n2. Lines 1028-1034: Otherwise, this is a custom element, or a custom attribute. We know that custom attributes are never assigned as properties, so we can use the same getValueForAttribute logic for both (as was the case before this change)\n. Thanks for the prod... This logic is flawed for the case when you assign class on a custom element.. @gaearon Added these two tests. Most of the integration tests check for value, not just the presence of the attribute. I'm trying to figure out any holes we might be missing... It looks like there was mostly a blindspot in class. \ud83d\ude48 Removed. 16dd18a. Good call. Done in e68bf4d.. Yep: e68bf4d. I tried to match up to other tests, but I might have missed the mark. Looks like clumps of work with a line between that block and the assertion?. Great question. It looks like data attributes are not case sensitive. What is the expected behavior? \n\nShould data-MyAttribute be written to the DOM? \nShould we do this validation (lowercase only names) for all custom attributes?\n. It looks like, on master, React actually doesn't warn on cased data attributes. I believe this is because they get picked up by the custom attribute logic at the top:\n\nhttps://github.com/facebook/react/blob/master/src/renderers/dom/shared/hooks/ReactDOMUnknownPropertyHook.js#L57-L58\nIs it possible that this comment is out of date?. Interestingly, it looks there's a related todo a earlier in the document:\nhttps://github.com/facebook/react/blob/master/src/renderers/dom/fiber/ReactDOMFiberComponent.js#L931\nAccessing the attribute name from the DOM is always going to return a lower cased name, so we need to do this for regular DOM elements too. For consistency, and until we close the thread on this, I've added an adjustment and test in 83e46aa.\nI think we really just need to decide if we care about allowing custom attributes to have custom casing. If not, we should add that logic to shouldSetAttribute and probably make a separate warning along the lines of \"Custom attributes must be lowercase\".. I'd be in favor if just warning when custom attributes use casing. . \ud83d\udc4d. Long term, I believe we can remove mutation method all together if we circle back to https://github.com/facebook/react/pull/10150. Line 1031 properly removes attributes from the extraAttributeNames list because React assigns a lower cased version of the property name as attributeName. That doesn't happen for properties outside of this configuration, so we need to downcase them here (just like on custom attributes).. TLDR: I don't love this. I think we should just allow any casing for attributes outside the whitelist so that we can remove most of the white list and gracefully handle SVG's case sensitivity (if that's really a thing).\nThis is necessary if we don't want to allow things like data-fooBar or myCustomAttribute to show up in the DOM. \nMDN suggests that SVG attributes are case sensitive. That's a huge bummer.... maybe we really can't remove SVG attributes from a special list. \nSince HTML attributes aren't case sensitive, I'd rather just set attributes with the casing they are provided as props, and let the DOM downcase them for us (which it will do anyway). We'd allow custom casing (what if there's a new SVG property that comes out that we don't support?)\n. Backticks around attributes was inconsistent across the warnings. They are now consistent.. I reworded Unknown to invalid since we will technically allow any attribute, and class is the invalid form of className.. This is new. Since we allow any attribute, and now care about casing, the unknown property hook was picking up on incorrectly cased aria attributes, so we need to skip them. It kind of makes me wonder if we should just go ahead and remove the aria hook and do the ARIA checks in here.. > The key thing is that multiple individual options will still have selected set to true in the DOM when removing multiple as an attribute in some browsers. \nIf this behavior is inconsistent, and JSDOM does not exhibit it, do we need to make this a DOM Test Fixture and explore the surface area of browsers that demonstrate it?. What is the advantage to using ReactDOM.render over TestUtils.renderIntoDocument?. Just thinking: I didn't see a test that covers attributes that require property assignment. I think it would be covered by a test that uses multiple with a select, but the behavior is probably covered by ReactDOMSelect-test.. Should this test cover null too? Is that overkill?. Yeah, this doesn't happen for any prop that must be assigned as a DOM property. The only thing we alias are a few HTML attribute names and a bunch of SVG attribute names. . This is existing test behavior, so take it or leave it, but I think line 143 is essentially testing that JSDOM syncs up the title property with the title attribute. Could line 143 go away?. Same deal with line 146.. I think this test might be a victim of changes in how value is assigned over the churn trying to fix bugs in controlled inputs. Your change is a good one, but I wonder it is covered by the round of tests starting at:\nhttps://github.com/facebook/react/blob/master/src/renderers/dom/shared/wrappers/tests/ReactDOMInput-test.js#L873. If this test is giving us trouble via unit testing, I think we should drop it and consider writing a DOM fixture.. Ah, please lump this into the chat above about selects. . is this providing any additional coverage over the uncontrolled/controlled switch tests in ReactDOMInput?. I left a bit of a text book at the bottom of the PR \ud83d\ude30. The only alternative I can think of is to let case insensitive attributes fall through and  warn about them. If an attribute has an alias, likeclassandclassName, we should prevent cases likeclassname` from falling through. \nIn the long term, this would allow something like allowtransparency in the DOM just like allowTransparency, but React would warn about it. Otherwise, we're stuck with the whitelist forever because we need to check for proper casing.. We could also add a progressive warning system so that if you provide the same string with different casing, like two casings of the same attribute, we'd warn on that too.. Man I need a git commit hook for impliments. Every. Single. Time. Fixed in aaafa7f. Just a final word here. In this scenario, all attributes are referenced as their lowercase form internally. I've hidden that within getPropertyInfo to avoid needing to know about lowercasing attributes outside of DOMProperty.js.. I feel like there's another step here where we could string manipulate xml:lang or vert-origin-y into camel-case, that might cut the overall gzip size.. Ah I want to try it. I'll take 5.. DOMPropertyNames is not used by any injection.. I can't figure out if this is a boolean attribute or not.. This one either.. This is a value for dominantBaseline, and I can't find a description of it anywhere.. I just discovered this page. True life saver.. Number.\nhttps://www.w3.org/TR/SVG/fonts.html#FontFaceElementIdeographicAttribute\nJeez Nate. Why don't you read the spec?. This is not in the spec.. Oooh fun.. After I wrote the regex match, I did a microbench:\nhttps://jsbench.github.io/#75e098a3100abf2c235ac7b8c3a56d2d\nI'm not really sure if this is faster or not. The regex bench has to compile the regex every time. \nI'm also curious if there are issues with a long-lived regex like this.\n. Ah.... Wonderful. Thank you! e091f08. Good catch. I these from possibleStandardNames to prevent the UnknownDOMPropertyHook from picking it up in addition to the dev warning about onfocusin.\nI think we just need to make the onFocusIn warning case insensitive. What do you think?. This is always a boolean. That name change is fine with me.. We need a good name for the \"React way\" attribute names.... We call them \"special React properties\", \"javascript form\", etc..... I'll get this.. I'm working on making the warning for onFocusIn and onFocusOut case insensitive. I can do that for innerHTML too.\nThese show up in assertValidProps:\nhttps://github.com/facebook/react/blob/master/src/renderers/dom/shared/utils/assertValidProps.js\nThe easiest thing to do is move them to ReactDOMUnknownPropertyHook.\n. Done: 9b547aa. @sebmarkbage Follow up from https://github.com/facebook/react/pull/10416 regarding valueOf.\nIs it safe to evaluate stringification through valueOf or toString, and fallback to null if we don't like the value?\nLike:\njavascript\nvar stringified = '' + value\nreturn stringified !== '[object Object]' ? stringified : null\nI imagine just checking for [object Object] isn't the way to go, but something similar.\nWe could change this function to be more of a \"getAttributeValue\" function, which would return null in the case where an attribute should be assigned. That way if a valueOf or toString, heaven forbid, have side-effects, we only call it once.\n. \ud83d\udc4d. Good catch. I'll update this test.\nIf I remember, the old listener is definitely getting called. I need to work on that next.. @sebmarkbage this is the only downside I see to calling the nodeName getter. Occasionally this value is the window. That's because the target instance falls back to the window when it can't find a target instance:\nhttps://github.com/facebook/react/blob/master/src/renderers/dom/shared/eventPlugins/ChangeEventPlugin.js#L149\nI can't help but wonder if this could be document.body instead of window.\n. A good example of this is if you throw a breakpoint in this function and click anywhere on the page other than the target input.. Sorry. To clarify: calling nodeNameGetter on window raises an exception.. \ud83d\ude48. I wonder who did this.. I think it was to heavily steer users towards the alias. Dan wanted to avoid confusion where you pass class, or stroke-dasharray, it's technical valid and the HTML/SVG writes the way you expect, but it's not \"The React Way\", so you see a warning.. Personally, I think we should allow both. For 16 we would warn, but we could explore lifting the warnings in 17/18, only warning when the alias and the standard form are included in the same prop object.\nFor that to work, we might want to figure out which key gets priority: the alias or the native attribute name?\n. @sebmarkbage I'd like to figure out how much HAS_BOOLEAN_VALUE, HAS_NUMERIC_VALUE, and HAS_POSITIVE_NUMERIC_VALUE are developer convenience vs ensuring correctness. I still don't understand why all of the attribute names we have to include for booleans aren't flagged with HAS_BOOLEAN_VALUE. \nLikewise for numeric fields (which we've dropped from the whitelist, except for things like cols, rows, start, etc. \nI think this might have mattered back when they were assigned as properties. I'd have to do some archeology. \nDan and I made the call to keep their property info the same as 15.x, but I still can't help but wonder.. Thanks for taking care of this, @spicyj!. I wish I knew what wasn't consistent -- and where? Like was it IE8?. I'll write up an issue to do some archaeology here. \nTotally unrelated to this PR \ud83d\ude1b. . Controlling for process.env.NODE_ENV is new here. Otherwise, I was unable to get the invariant to minify the warning.. It will be done.. \ud83d\ude48 Thank you.. Got it in da62f42. Yes. It's a combination of the HTML Property Config and SVG Property Config, which where ultimately just blended into the same list inside of DOMProperty.properties\nWrestled with some editor-fu, but I've alphabetized these while still clumping together aliases.. This is curious because we check for NaN. Is it possible that the UnknownPropertyHook is caching a warning for the unknown prop?. I didn't realize Symbol('foo') + '' raised an exception. Huh...\nI think this is correct. At least, assigning an attribute with a Symbol manually raises an exception:\n\n. This should cause the attribute to be removed and raise a warning. Is it possible that the unknown prop is already in the warning cache at this point?. Same question here. This should warn and not assign an attribute.. Hmm. I'm not 100% sure how jest.resetModules works with common js. What if we exposed a method on the UnknownDOMPropertyHook to reset the cache? . Should this warn? I thought we decided to allow toString methods to support libraries like glamor that use custom toString methods, and the ajaxify property found commonly in FB's codebase.. Cool. Sounds good!. Just for clarity: we used to only allow booleans for non-flagged attributes on data and aria attributes. Now all attributes can accept booleans, cast to strings.. This function cleaned up really well :). I think right here:\nhttps://github.com/facebook/react/blob/efa71484b334153958d8a0f35310c3c4ee72c731/src/renderers/shared/fiber/ReactChildFiber.js#L203-L211. Removed autoComplete. It is actually on/off, not true/false. Thanks @syranide!. Same deal with autoSave, autoCorrect, and autoCapitalize. I pulled this over from: https://github.com/facebook/react/pull/10531. Ah, darn it. Yes. We need a new flag.. Fixing this up shortly.. This must be in here for backwards compatibility. . I'd love to just lean on DOMProperty.shouldSetAttribute, but reserved props pass through here, and style is in there. Maybe we could remove style from reserved props.. Didn't see the namespace work. Cool. This is inferior, I'll rework this.. @gaearon I moved the namespace check into this module. Stack validates properties before the namespace is assigned to the element, so we don't know if the element is SVG or HTML during initial validations. namespace == null can go away when stack is removed. This also preserves the custom element behavior for 15.x, if that matters.. Ah man.. I hear that. Is this structurally fragile, or do we just need to change a name?. This is only the case when the development hooks fire. UnknownDOMPropertyHook fires before mount; before a namespace is assigned to an element. Same deal with InvalidARIAPropertyHook.. *For stack. Lol. I honestly thought that was an edge case test. \ud83d\ude28 . It is curious that these must be here. This is for correct casing? I wonder if we really need to down case attributes:\nhttps://github.com/facebook/react/blob/master/src/renderers/dom/shared/DOMProperty.js#L90. This would be good follow-up work anyway.. I believe this will be easier to refactor once Stack is removed. Part of the complexity is that ReactDOMUnknownProperty hooks are fired before a component is mounted. Stack doesn't assign a namespaceURI at that point. The current solution is a work around that, conveniently leans on the DOM element not being created yet in Stack to preserve the old custom element behavior.\n. Just for context, \"on\" and \"off\" were deprecated for autocapitalize in iOS5. Acceptable values 1 are \"none\", \"sentences\", \"words\", and\"characters\". When no value is given, it defaults to \"sentence\" for form tags and \"none\" for password input elements, but otherwise uses the attribute on the related form. \nThis default value appears to be an empty string, at least when I log out input.outerHTML in Safari. It also enables capitalization, at least in a very quick check in the ios simulator.\nHmm. It is frustrating that true is the assignment type for implicit attributes (like <input autocapitalize />). Maybe in a breaking release of JSX there could be a symbol for it, or use an empty string.\nIn the mean time, should we want to parse true as an empty string for cases like this? Maybe false should warn. Is this behavior safe to generalize on all attributes that don't have the HAS_STRING_BOOLEAN_VALUE flag?\n@aweary is this in line what what you were thinking for boolean attributes?\n\n\nhttps://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariHTMLRef/Articles/Attributes.html#//apple_ref/doc/uid/TP40008058-autocapitalize\n\nRandom fun aside: This is my first time using a footnote in a reply on Github. What a time to be alive.. I'd vote do a production build and run at as a static for serve, if possible.. * that way you have direct control of setup and teardown without any ipc. I'm curious about when element is null here too and would +1 an invariant or an action item to investigate this.. At some point I need to circle back about this on #9333. We need local listeners and I'm trying to figure out the best way to clean them up.. Okay, I've done that in 26722ce and added a TODO to follow up with a similar change on master.. I am not sure that we can, unless we can control for browsers that report casing from attribute.name inconsistently. For example, IE Edge reports SVG fill and `stroke in all caps:\nTest: https://codepen.io/nhunzaker/pen/qXRPvY\nScreenshot of IE Edge 15:\n\nScreenshot of Chrome:\n. I can start to compile a list of special cases. I'm sort of worried that this will be tedious and it'll end up being most of SVG, but I don't know that yet. I know of differences in casing of SVG in IE Edge. I didn't know about the cases alluded to in Chrome. \nShould I just open up the attribute table in every browser using BrowserStack? How many versions back should I go? \nKind of makes me wonder if it could be automated using their remote API.\n\nI have a few questions, and I apologize in advance if they sound cynical, but I don't want to assume anything so I can better understand the problem:\n1: What is the advantage to case-sensitive hydration? Casing warnings for known attributes will raise server-side during markup generation (is this correct?), and then and on update client-side. \n2: Wouldn't the same components consistently misspell attribute names server and client side?\n3: Even if the casing is produced differently server/client-side, browsers don't appear to care about casing. I'm curious if this is generally true, or if my tests are flawed. They certainly aren't exhaustive.. Ah got it. So there are attributes that care about casing. That's frustrating... \nThank you for spelling this out for me. Prior to this point, I was not aware of the differences between HTML/SVG parsing and the DOM attribute manipulation. What a mess! . Why rename parentNamespace to ownNamespace here instead of using parentNamespace directly or setting ownNamespace as the argument?. Disregard. Sorry I didn't catch the code below.. I wonder if it's worth adding a comment for why we need to downcase the propKey (because HTML reports lowercase, right?). The react prop name can still have casing, as long as it's passed as lowercase to the HTML element. This doesn't allow spreading of attributes, but you can do it at least.\nI think it's important to communicate what this is protecting against. I don't know that this should live in the warning, but I do agree that a developer not familiar with the problem-space could see this as an arbitrary restriction. \nWe could turn it into a \"React's got your back\" kind of thing if we effectively communicate it.. Agreed. I played around with getting \"attribute whitelist\" in there somewhere, but \ud83d\udc4d to this change.. Off topic, but I wonder if it's possible to add a developer warning for this recommendation. . If anything, I already appreciate the reduction in branching.. I'd really like to get rid of this distinction if we can. It always felt a like to much indirection. At the very least, it would be nice if the property and attribute paths either had clearer separation, or we consolidated them and made sure the isAttributeNameSafe validation is applied.. Semi-unrelated, but method that this gets called for is value, which has this null guard:\nif (value == null) {\n  return node.removeAttribute('value');\n}\nI'm not sure if there is a big distinction between null and undefined in other parts of the code, but passing null here, like mutationMethod(node, null) feels better to me. What do you think?. Really, I think if we stop syncing the value attribute with the value property, we can just drop mutation methods all together.. Maybe I didn't understand your comment, but should this be (on <iframe>)?. I really like the change from prop to value. Invalid is my fault. I changed it to Invalid because we do know the attribute, and we know that it is being used incorrectly. Having said that, I have no real preference.. Yeah. I'd even throw out that something like Unsupported event listener is more appropriate. I don't think the warning is made better by the inconsistency, let's just go with unknown.. Should this be a heading?. Huh. Good question. I don't know. I made this file by exporting it from the browser. I'll see what's up.. Should this happen once, when the properties are injected?. But line 93 ensures that this code only runs when we have property info (which I believe is always from the whitelist). Wait. Why is this necessary? This already gets lower cased in the injection here:\nhttps://github.com/facebook/react/blob/master/src/renderers/dom/shared/DOMProperty.js#L83. Looks like tests pass when I remove this statement! (98-100). Totally need the toLowerCase below though.. Does this drop support for clicking inputs to change them? Is this possibly breaking?. The linter was fussing at me about no curlies after the if, so I threw em in.. It might differ in another browser, but a quick check in Chrome shows that it works, and it gets assigned as tabindex:\nhttps://codepen.io/anon/pen/PJeoeE\n\n. This whole block might be able to go away, it looks like IE9 supports event.view:\n\nI'll do some testing. MDN isn't comprehensive on support here:\n\nMaybe we can fix that :). Yep! UIEvent.view is supported in:\nIE9-11\nSafari Desktop 4, 5.1, 6.2, 7.1, 10.1, 11.0\nSafari iOS 3, 4\nFF 47\nWindows Phone 8.1\nHere's my test case:\nhttps://codepen.io/nhunzaker/pen/BwVwqo\nAnd I've submitted a revision to this page on MDN:\nhttps://developer.mozilla.org/en-US/docs/Web/API/UIEvent/view. I believe, unless I'm mistaken, this can be:\nvar UIEventInterface = {\n  view: null,\n  detail: null\n}. I made a quick test:\nhttps://codepen.io/nhunzaker/full/BwPbRK/\nThis works in:\n\nIE 9, 10, 11\nFirefox 47\nChrome 41\nSafari Desktop 7.0\nSafari iOS 9\n\nIs this a reasonable test case? This page is over HTTPs. I wonder if it would be different otherwise. \nIn any case, this only applies to date/time/color inputs, and only when they are mounted for the first time. . Ahh, sorry. Key detail! This fails in IE8, but not IE9 or higher:\n\n. I think this is wrong (not your doing). Could you change this to this.state.filter? It looks like this dropdown isn't working.. I agree. I would hate for a webdriver test to block a release. I think we'd be more successful sending out edge releases so that issue filers can quickly verify their fixes.\nI hadn't thought of using webdriver for the packages, only specifically for the manual DOM test fixtures. . For my own understanding of Flow, does : Object distinguish ReactDOM's type over what Flow can infer?. Does it make sense to share the typeof Symbol === 'function' && Symbol.for here? in a supportsSymbolFor variable, or something?. When is ownerDocument ever undefined?. Why a try/catch? Could you just do:\nif (!element.contentDocument) {\n  return element\n}\n?. I'm trying to figure out why this is necessary (but it is definitely effective).\nupdateNamedCousins in ReactDOMInput should take care of this, but it looks like it doesn't run in the test case you've provided.\n@jquense updateNamedCousins gets called in restoreControlledState, but for what ever reason it only fires on the button, which I guess is clicked and responsible for the last trigger. The radio input never gets targeted by restoreControlledState.\nIt feels like there's something deeper here that we need to fix.. Kind of a bummer that we have to || false here. It can't hurt, but I wonder if this is necessary (just with a quick test via https://codepen.io/nhunzaker/pen/qVadLo).. Do you mind rephrasing this to should check the correct radio when the selected name moves?. Huh. Cool that loose equality works out this way!. This needs to get into standard library already..... Am I correct to assume this is breaking change? Is this a change we are comfortable sending out in a minor release?. Dropping decimal places on blur seems to no longer be an issue in modern safari \ud83c\udf89 .. I had to update these two tests because overriding the value property was done such that you couldn't check the current value.. value no longer gets assigned to inputs using DOMPropertyOperations. This means that value always gets set after every normal property is set. We don't have to mess with property assignment order here anymore.. This might fix #8395 and invalidate https://github.com/facebook/react/pull/11202. I need to verify.. Basically we just need defaultValue to always get set after value. This won't happen if an empty value is provided. That might avoid initial validation issues in Firefox.. Assigning defaultValue sets the value attribute, but doesn't have the side-effect of removing the password icon in IE. I'm not sure how I discovered this. I wish I had that kind of intuition for more useful things \ud83d\ude38.\n\n. In updateNamedCousins, we check for radio buttons like:\njavascript\nfunction updateNamedCousins(rootNode, props) {\n  var name = props.name;\n  if (props.type === 'radio' && name != null) {\n    // ...\n  }\n  // ...\n}\nCan you use that check here? That would allow us to remove the targetType argument and reading from the DOM.. That is not optimized. Fixing...\nI stole this from the website. I suppose I should send out a PR for that too.. For the DOM test fixtures, we use the following format:\n\nWhat do you think about including instructions and expected behavior as a part of these fixtures? Is that appropriate for these types of tests?. Following up about sections vs tabs in #9866. The DOM test fixtures started this way too. Eventually we added navigation via separate URLs, but I don't think it's necessary for the first pass. It can be really helpful when testing to work from a long sheet of tests.. I think we all tested this. The fixture in it's current state on 15.6.1 is completely broken on older builds of the fixtures (http://react-dom-test-fixtures.surge.sh/). Can we attribute this to a mixup pulling this code on to 15.x?. As far as I can tell, this is just a pre-emptive attachment because ensureListeningTo attaches on the owner document, not the DOM element. We need these here because they don't bubble, so there must be a listener on the element for the synthetic event system to know about it.\nI think there is a change we could send to master here. We can attach reset, submit, load, etc... directly on the element. I do not think the savings is substantial because these events are almost only ever added to these elements (when was the last time you attached onError on a div or button?)\nI'm going to check to see if we still need onChange to attach here.. \u261d\ufe0f edited with some clarification.. We need this so that the EnterLeavePlugin event plugin works with elements React isn't watching.. \ud83d\ude48. I'll look into this :). Made it consistent in 68b42c2. Fixed in 68b42c2. I am comfortable with this, but it should go out in a minor. I'd hate for tests to fail on a patch.. When is button not 0? Does this account for right clicks? Is that even a problem?. These feel like they could be separate tests. \nAlso: Why do email, password, and number return false? Is this because they don't support the text selection api?. Huh. I didn't know you could do this.. \nHow fun.. Cool. Thank you. That was extremely helpful!. Possible to recycle this value from the check on line 147?. Could you explain what nativeEventTarget can be? When would an element be missing an owner document, but have a document? What are the usual values ofnativeEventTarget?. What does clipboard data have to do with selection?. Ah still, do you think it's worth landing? What do you think about sending this out in a separate PR?. Did some quick checks. We have DOMMouseScroll for Firefox, but MDN claims that wheel is supported as of Firefox 17.0. We support the Firefox Extended Support Release (ESR), which is presently at 52.5.0. I think this is a safe change that will not affect any user. \nAlso it also looks like IE9 supports wheel (though it's not on the window according to MDN, the event is still supported).\nSo we can drop this check all-together. That would mean we'd revert the changes to this file and just keep the code removal in ReactBrowserEventEmitter.\n@aweary, @jquense, or @gaearon any concerns with sending this out in a patch release?. \u2764\ufe0f . Yeah. Still I can't help but wonder if there's work that could be done here to do the attachment local to the event plugin. It's a bummer that ReactBrowserEventEmitter and EnterLeavePlugin are coupled like this.. This is a similar problem for change events on inputs. We have to attach change events to controlled inputs even if there isn't an event listener. This is so that controlled inputs that don't have readOnly prevent value changes on user input.\nIMO, we should warn users when they don't have a change event and tell them to use readOnly, but we might already do that. Or, at the very least, we should attach the event listeners inside of the input wrappers (input, select, and textarea).. > also did we end up some place on using the native event vs continuing to polyfill this forever?\nLet's give it a look. It looks like we might be able to use the native event now, but the support matrix for mouseleave on MDN is incomplete.\nWe should do this research, kill the event plugin if we can, which I think would also let us get rid of some tree traversal methods specific to this event. \nAt the very least we should update all of those question marks on\u00a0MDN.. :+1:. What is .node? I don't see it anywhere (other than .node.js). Good catch. These aren't necessary, but I needed them mid-way through making the change. I'll remove these.\nI added these tests when I removed the value mutation method and removed value from the property object in getHostProps. Without the addition of assigning value in the post mount hook, inputs never received an initial value.\nBut it looks like these aren't necessary any more. I've also since removed specific checks for reset and submit input types too. Checking again, half the ReactDOMInput test suite fails when the value assignment code in postMountWrapper goes away. . Removed in fde83b2. Ah this is confusing. node.value is different from node._wrapperState.initialValue.hasUserInput tracks if a user has started typing into an input before JS evaluates (in the case of server-side rendering).\nWhen a component mounts, we don't want to initial set value or defaultValue if they aren't provided in props, and we don't want to set value to the initial React-provide value if a user has already entered text.\nI'm going to rename the value variable to initialValue. I think I can also change this check to avoid type comparison and just check for presence of the value or defaultValue in props.\n. Done in 90ed488. Huh. Flow was yelling at me, but not anymore. Thanks!\nd8925a2\n. Done in 5e194d1. Woah. I've never seen await in a loop before. \ud83d\ude3b . Roughly. This was for elements that use the value attribute, like <progress /> and <meter />. I am not sure inputs can actually ever have a null value prop because:\n\nAn input sets an \"initial value\" on creation\nIf that value is null, it falls back to defaultValue\nIf defaultValue is null, it falls back to an empty string\n\nAdditionally, React yells at you for switching between a controlled and uncontrolled input, and if the value is ever null.. Yes. You get the following warnings when switching to and from undefined:\n\nWarning: A component is changing an uncontrolled input of type undefined to be controlled. Input elements should not switch from uncontrolled to controlled (or vice versa). Decide between using a controlled or uncontrolled input element for the lifetime of the component. More info: https://fb.me/react-controlled-components. Good catch. It does not remove the attribute, but the behavior is inconsistent with master. In the absence of a value attribute, an input reverts back to the initial value it was created with. For example:\n\nReact 16.2.0:\n\nHowever, with this change, the attribute is never reverted to that initial value:\n\nI'll add test coverage for this case. Sorry to neglect the distinction between null and undefined \ud83d\ude26 \n. I think we needed this back when Stack was still around. I wonder if we could get rid of it. Probably good follow-up work.. I remember when we hit this adding custom attributes, and it didn't feel great. It would be awesome to get to the bottom of this.. I think this is probably fine, but why the change?. Is this true in IE9?\n\n. Also valueOf:\n. Totally. It's just nice to look at this code again with a fresh set of eyes. I'll file an issue.. Got it. Thank you!. https://github.com/facebook/react/issues/11735. :+1: :100:. We must only compare the stringified value property/attribute after we've confirmed that it isn't a symbol. Otherwise you get a run time exception:\n\nMaybe a safer way to do this would be to wrap the value in a string constructor?\n\n\n. Sure enough:\n\n. I believe the unknown property hook will still raise a warning.. Left a note to follow up here.. Left a note to follow up here.. @gaearon new here: I forgot about the number behavior on blur when we change inputs. This is so that chrome doesn't validate number inputs when we assign the default value. The DOM Operations are now consistent.. @gaearon assigning defaultValue does not raise a warning. This is because defaultValue is considered a reserved prop:\nhttps://github.com/facebook/react/blob/master/packages/react-dom/src/shared/DOMProperty.js#L12-L21\nRemoving it from the reserved props list addresses the issue, but then a ton of server integration tests fail. The current 16.2.0 behavior also does not raise a warning:\n\nDo we want to address the lack of a warning for defaultValue in this PR?. Yeah. I had an assignProperty method earlier, but we thought it was too much indirection. I'd be happy to revisit this though.. I don't think so. Though the controlled input guard triggers above this line. It is not apart of this specific block.. But you asked! So we could probably improve it. Something like:\n// Focused number inputs do not update their defaultValue on change. This\n// avoids unexpected value changes in Chrome while the user is typing. On blur,\n// we need to synchronize the defaultValue to match standard input behavior.. Is the overhead of the switch greater than the double lookup of has and get?. I know microbenchmarks are dangerous, but would indexOf or object property membership be faster?\nhttps://esbench.com/bench/5a21e22199634800a03494ec\n\n. Ya. I hesitated to say anything. Dan just mentioned the extra look-ups were slowing things down a bit.\nFeel free to disregard.. Actually I wonder if I even need to check valueAsNumber. Everything works as expected in IE9, which does not support this API.. This seems to be too good to be true, but this checks out in every browser. Unit tests also confirm it. Have I missed something?. Looks like we didn't cover \"\" to 0 in our unit tests. Added.. Not from my ability to test. The strict equality check covers it. . Got it in 2ba3fe8e57f3d9c1cfd486d9c2e61a61c23404fb. Great idea. I also moved the loose check after the value === 0 guard to avoid some extra DOM access. 3cdde77325a3f372298ac9084ff49041e817715f. Any reason not to use a Set?. Fair enough, haha. Could you just return '' inside of the shouldTreatAttributeValueAsNull block? When does shouldTreatAttributeValueAsNull return false but the value is null?. \ud83d\udc4d . Why not just return isBadlyTypedAttributeValue(name, value)?. This code relates to the WeakMap idea I mentioned earlier. Instead of storing data on the node itself, we could track it using a WeakMap. We'd still have to fallback to the node for older browsers, but I'm still curious about it.. Can you use jest.fn() instead of console.log? I know other tests use console, but it avoids needing the __DEV__ flag. More or less:\n```javascript\nconst onLoad = jest.fn();\nReactDOM.render()\n// ... dispatch\nexpect(onLoad).toHaveBeenCalledTimes(1)\n```\nAlso, could you make the load and error event separate tests?\n. For some background:\nI imagine we'll hit this again in the future as new HTML elements support onLoad/onError (though that's probably rare). As far as I understand it, we need to do this eager attachment because error and load to not bubble, so you could technically do:\njavascript\n<div onLoad={() => alert('load!')>\n  <img src=\"image.jpg\" />\n</div>\nI sort of wonder if we should just respect the existing DOM behavior and avoid needing to eagerly attach these listeners. I'll write up an RFC for it!. As far as I can tell, type: null are all of the null values from extractEvents, which could be a permutation of:\n[null, null] // (neither a composition or beforeinput event)\n[composition, beforeInput]\n[null, beforeInput]\n[composition, null]\nSo my change makes this change one of:\nnull\ncomposition\nbeforeinput\n[composition, beforeinput]\nnull gets filtered out by the EventPluginHub.extractEvents. It just does a basic null check, so [null, null] gets through.. I hesitate to bring it up, but should we move this to reactjs.org?\nNot that, like, @zpao will hold our build ransom or anything :). Yeah, no worries. We need to figure out static hosting for the fixtures too. Maybe we can figure this out when/if we deal with that.. I am sorry for two final nits, but do you mind updating this to read:\nit('should receive an error event on <link> elements')\nLikewise for load. I'm also happy to make this change if you'd like.. Why stringify here and not line 295?. Likewise, should we stringify?. Got it. In any case, this looks consistent with the old behavior. \ud83d\udc4d . Just thinking about moving carefully, is this change related to the text content change? Could we send this out separately?\nI know that's tip toeing quite a bit. Just trying to figure out how to move forward with confidence :). When does line 50 trigger?. Sorry, I mean like what code path causes closest to be assigned to the instance? And what codepath even lets this function get past return inst on line 47?. Cool. I'd love to drop this if the code path no longer fires after Stack's removal. I'm afraid to ping anyone to bug them on holiday, but I think it's worth investigating.. Semi related:\nhttps://github.com/facebook/react/issues/11609\ncommitTextUpdate throws in some cases in IE9. I wonder if using this method there would fix it.\n. Agreed. It's more like \"attach this event locally to emulate bubbling\". Why glob this instead of import { runEventsInBatch } from 'events/EventPluginHub'?. I think it's fine, and much clearer.. Huh. Nice!. Purely for discussion but...\nIt's really a bummer we need top level event name constants period. There's nothing special about them. We could probably just use the event name that comes from the DOM.\nIf we dropped top level event name constants, we could avoid binding all events, eliminating overhead for local listeners:\nhttps://github.com/facebook/react/blob/master/packages/react-dom/src/events/ReactDOMEventListener.js#L126\nMaybe that's too aggressive. \ud83e\udd37\u200d\u2642\ufe0f . Registration!. The formatting is perfect here, but it doesn't look like this attaches to a Shadow DOM. What is the best way to do that?. Should this be added?. Correct. It does not ~fire~ bubble for images, iframes, videos, or audio tags.\nBut it does capture. We might be able to attach them at the top level using capture to avoid eagerly attaching a listener to each element.. Could you drop the extra new line here?. Ah man. I think you're right. Darn.. We could use EventPluginRegistry.eventNameDispatchConfigs for SimulateNative, but it:\n\nDoes not include invalid, mouseEnter, mouseLeave, reset, select, or submit.\nAdds selectionChange, textInput\n\nCuriously, this is the case for ReactTestUtils.Simulate. Is this correct? . It looks like this injects<input type=\"number\" value={this.state.value} onChange={this.onChange} />, which is the form React requires, however this won't wire on onChange, just set an HTML string uncontrolled by React. This will create a false positive for the bug because React doesn't interact with this injected markup.\nWe need to render a React component inside of a shadow dom sub-tree. It looks like https://github.com/facebook/react/issues/11827 includes a reproduction that does just this:\nhttps://jsfiddle.net/69z2wepo/94566/\nDrawing from that example, you could do:\n```javascript\nimport NumberTestCase from './NumberTestCase';\nexport default class NumberTestCaseShadowDOM extends React.Component {\n  componentWillMount() {\n    // I tucked the definition in here because I wasn't sure what extending HTMLElement\n    // would do in IE9. Maybe this isn't necessary.\n    class ShadowNumberInput extends HTMLElement {\n      connectedCallback(){\n        ReactDOM.render(, this.attachShadow({ mode: 'open' }));\n      }\n    }\ncustomElements.define('with-shadow-dom', ShadowNumberInput);\n\n}\nrender() {\n    return ();\n  }\n}\n```\nHere's a working example: https://jsfiddle.net/2n77ootd/2/\n. Are these equivalent? What was happening before, when the loop continued to another iteration?. Minor thing, but what do you think about adding a section like update below:\n```\nDocumentation:\nhttps://reactjs.org/docs/test-renderer.html\n``. \ud83d\udc4d, thanks! . What aboutObject.assign(event, data)?. Since you have a class field forinputRef`, what do you think about assigning state this way too? Like:\nstate = {\n  value: 0,\n}. Could you remove the wrapping <div> and <h1> tags? That way it's clearer what this component is trying to test.. event.target was always the window in IE9. That seems like a bug too. I'm planning to investigate.. Filed here: https://github.com/facebook/react/issues/12506. Pretty strange, I can't reproduce this outside of the test fixtures.. > Microsoft Connect has been retired\nsigh. I'll try to find it again.... It just stops it from throwing. I haven't been able to determine if react is incorrectly updating stale nodes and IE9 is just less lenient, or if this is specific to IE9.\nI can dig in a bit more.. Why is email not in this list?. Sorry. That was very blunt! Should email be in here? I found a neat table from a spec:\nhttps://html.spec.whatwg.org/multipage/input.html#concept-input-apply\nSo this matches up with the setSelectionRange column? Dang. I really want to know the reasoning behind not supporting this for all text based input. \nWould it be possible to add a comment at the top of this block that references this table for future contributors?\n. Back to the link issue. I'm having trouble digging up more information. For now, I've removed the link. I think the remaining comment is still sufficient.. Side note. Input here, as a React component, through me off for a bit. I wonder if we should rename this TestInput or ControlledInput. . I had to split these out. Markup straight from the server never assigns the value attribute, so the related input won't have a value. It is eventually assigned during hydration, as illustrated in the itClientRenders tests.\nAlso, this should still respect value property modifications by a user in cases where hydration stalls and executes after a user has given input... This is pretty blown out, but I wanted to make it painfully obvious that number inputs and passwords are unique.. I don't feel great about this, is there an earlier place I can sift out the value attribute for password inputs?\nI think we need to filter out the value attribute on password inputs anyway, even if we eliminate value attribute syncing altogether. The value attribute for most input will still be sent down.. Worried this might be a breaking change, but the events only appear to capture with JSDOM if the element is attached to the document. Any ideas?. Not at all. Done.. Woah nice. You added the isHydrating part! Very cool. I have a few questions:\n\nCan you use isHydrating as the condition on line 129, like if (!isHydrating)?\nAre the lines between (218-225) necessary? I think the bug was that range inputs never reported \"\", as required by the old code on line 229, that prevented the value assignment from happening. \n\nBasically, I think the only change we need to make is on line 229:\nif (!isHydrating) {\n  // ....\n}\n. Should we have an internal unit test for this? . We need this until https://github.com/facebook/react/pull/12976 lands. @jquense As far as I can test, this behavior is no longer necessary. Do you know what conditions onpropertychange is covering?. Interesting... I actually remove that listener in #12505. I'll hunt!. Totally, \ud83d\udc4d . As far as I can tell, this code executes correctly. I believe the issue is a difference in browser behavior when using attachEvent vs addEventListener. The following code snippet seems to demonstrate what is happening:\nTry this in IE9:\nhttps://s.codepen.io/nhunzaker/debug/Lrpqov/ZoABaKanBoKr\nBrowse the code:\nhttps://codepen.io/nhunzaker/pen/Lrpqov\nIt looks like IE9, when using attachEvent for text input, causes previously referenced text nodes to be replaced with a copy. This behavior doesn't present itself if you use addEventListener.\nI think we were able to get away with this before (but I'm not super familiar) because we identified text via an embedded span, and then eventually relative to a comment.\n. This is... probably the strangest DOM thing I have seen. I would love a second/third opinion here.. Dang. Here is what I am seeing...\nOn every onpropertychange call, IE9 seems to be marking all text nodes changed within the callback as \"dirty\". On undo, it replaces those text nodes with copies (though it doesn't seem to revert them)\nAdditionally, undoing doesn't appear to trigger onpropertychange. We just see that in React because it triggers a keyup event.\n\n. > without needing IE8 support we can craft a leaner polyfill that uses the selectionchange stuff as well as the native onInput event.\nI think this is already happening. If we remove onpropertychange, the combination of keyboard events and selection change, so far, appears to cover this use case.. I'm seeing a combination of input, keyup, keydown, and selection change:\n\nAll of the extra calls get filtered out via inputValueTracking.\n. Looks like I'm wrong. I was looking directly what what was getting dispatched out of ReactDOMEventListener.\nI did find one edge case that propertychange catches:\n\nChange text\nRight click\nPress undo\n\nIn the past, propertychange would have caught this. \n. Possibly chasing ghosts, but I'm worried about the side-effects of always assigning selectedIndex to -1. Do you think it makes sense to only apply this for the multiple input case?\n```javascript\nconst multiple =  !!props.multiple;\nif (multiple) {\n  node.selectedIndex = -1\n  node.multiple = true\n}\n```. I wonder if we could catch some of these edge cases by comparing the value on focus:\nhttps://github.com/facebook/react/blob/master/packages/react-dom/src/events/ChangeEventPlugin.js#L135-L139\nI'm not sure what to do about \"Cut\", though I can't help but wonder if it triggers a selection change (you have text selected, you cut, and thus, the words disappear and selection changes).\n. Should this be event.screenX?. I believe Dan is right, and we need to correct this.. Yep, screenX/Y are very well supported.. ~Why 100?~ Sorry. I'll keep reading :). Cool. I didn't know about the scheduling fixtures! This is really neat!. I wonder if lines 245-250 could be replaced with:\njavascript\nnode.defaultChecked = node._wrapperState.initialChecked. What do you think about reversing these lines? I have a hard time tracking lots of boolean flipping. Do you think this would work?\njavascript\nnode.defaultChecked = !node.defaultChecked;\nnode.defaultChecked = node._wrapperState.initialChecked;. @aweary Actually I don't know either, but I aired on the side of avoiding speculation, haha. I can do some testing to see if we really need this. \nA lot of the value detachment stuff was added when defaultValue was assigned as an attribute through DOMPropertyOperations. I think those edge cases went away when we moved everything into ReactDOMInput. \nThe thing to figure out is if assignment detaches, or if the value truly must be different. It would be easy to run a few tests.. That is a good enough answer for me, \ud83d\udc4d . Still, just to keep the boolean flipping in check, is it possible to do this:\nnode.defaultChecked = !node.defaultChecked;\nnode.defaultChecked = node._wrapperState.initialChecked;\n?. In what cases is target not a Fiber? Like could this type be null | Fiber?. Sorry, I think one last change. This looks good overall. \nCan you change this test to use hasAttribute instead of doing a value check on getAttribute? Like:\njavascript\nexpect(aNode.hasAttribute('checked')).toBe(true);. Just trying to think through all of the cases here:\nchecked or defaultChecked are true\njavascript\nnode.defaultChecked = true // node.defaultChecked = !node.defaultChecked\nnode.defaultChecked = true // node.defaultChecked = !!false\nchecked or defaultChecked are false\njavascript\nnode.defaultChecked = true  // node.defaultChecked = !node.defaultChecked\nnode.defaultChecked = false // node.defaultChecked = !!false\nchecked and defaultChecked are undefined\nThis can happen if you just declare a regular text input, ex: <input value=\"test\" />\nIn this case, value detachment still needs to occur. An input might switch from text to radio later, and React doesn't fire the post mount hook behavior when that happens.\njavascript\nnode.defaultChecked = true  // node.defaultChecked = !node.defaultChecked\nnode.defaultChecked = false // node.defaultChecked = !!undefined\nSo I think this is good to go. Are there any other cases you can think of?. Separately, part of me wonders if node._wrapperState.initialChecked should always be a boolean. Like we should do the !!node._wrapperState.initialChecked part when initialChecked is assigned. \nHowever I don't think that's related to this issue, and I'm not sure what existing code relies on that value to be loosely null.. Just so I can better understand this change, is the reduction of this setAttribute call due to the following case?\nchecked or defaultChecked are true\n```javascript\n// \nnode.defaultChecked = true // node.defaultChecked = !node.defaultChecked\nnode.defaultChecked = true // node.defaultChecked = !!true\n```\n. I stumbled a bit trying to remember what an updater function was. What do you think of:\n\nsetState was called with an updater function that returned undefined\n\nDo you think it would be worth adding an example, like this.setState(() => undefined), or would that just be confusing?\n. Is it worth calling out Symbol in some way?. Sorry. Didn't catch your comment earlier. This makes sense!. Yeah. One thing at a time. I think this is a great follow-up, but I'd love to get this check attribute fix in first.. @sw-yx I'm a fan of simply dropping updater. I think in the past, we've linked out to reference material to break down a problem more clearly. Is there a page that walks through setState's updater function usage that we could reference?\n@gaearon do you know if this is still accurate, and applicable in this case?. Ah... right! Returning false as a default is probably sufficient.. Cool. This makes sense.. Minor, but other warnings use more direct language like:\n\n\"ReactTestUtils.mockComponent() is deprecated. Use shallow rendering or jest.mock() instead.\"`.\n\nThis isn't a hard recommendation, so I think softening it a bit makes sense, but it just crossed my mind.. I know this code was just moved, but I'm curious why assign is imported above, but Object.assign is used here. Are they equivalent? . I didn't realize Object.assign compiled down to the assign module, \ud83d\udc4d . I'm not really sure what's better, and I can go either way. I don't consider it a blocker for getting this change in.. \ud83d\udc4d . \ud83d\udc4d . Just doing some poking around:\n\nIn what cases does win not have getSelection, and would it be good to document this?. I want to lean towards the first, but I keep reasoning out of it in favor of the second. Body could be null, and it really it should never happen. But I've been surprised too much before :).\nWith the second example, do you need a try/catch?\nAlso: do you anticipate any problems with code downstream working with a document body that isn't attached?. Could you add a comment to this line describing such a scenario?. Likewise, when is getSelection absent?. Cool. That is fine by me. Sound good, @aweary?. > The second option has grown on me; I suggested it thinking it was silly, but now feel like it\u2019s pretty reasonable. If we go with that one, should we add a comment explaining that document.body can be null?\nLet's go with it \ud83d\udc4d . I think this is okay. Particularly since the problem is still identified in the message (even if the nest doesn't show up).. @aweary or @gaearon Do you anticipate any problems with changing this warning text?. Nit: Could you reformat this like:\n// We do not have HostContext here, but we can at least\n    // put some parent information. Definitely. TIL you can use emoji as class names. I guess they're just characters.. That would be a joke if the emoji movie were in here.. This isn't perfect, but could you update this comment to read like:\njavascript\n// Normally attributes are assigned in `setInitialDOMProperties`, however the `multiple`\n// attribute on `select`s needs to be added before `option`s are inserted. This prevents \n// a bug where the `select` does not scroll to the correct option because singular \n// `select` elements automatically pick the first item.\n// See https://github.com/facebook/react/issues/13222\n@gaearon Could this be clearer?. We use property assignment in the postMountWrapper, could you do the same here?. \ud83d\udc4d . For other onlookers, I thought this meant that React extended the Error prototype. This only happens in the React test suite:\nhttps://github.com/facebook/react/blob/f762b3abb1d951b366f3c8a2354aeedb7fbc32ff/scripts/jest/setupEnvironment.js#L10-L16. Nit: what do you think about dropping the period after this link so that it's easier to copy/paste from Github?. What do you think about using expect.assertions(2), instead of assigning a didCatch variable? Or expect().toThrow, like:\njavascript\nexpect(() => {\n  ReactDOM.render(<Bad />, div);\n  ReactDOM.render(<Bad />, div);\n}).toThrow('Maximum update depth exceeded') // maybe this needs to be a regex?. Actually looks like this raises a warning on CI:\n\n24:1  warning  Error prototype is read only, properties should not be added  no-extend-native\n\nCan you add: // eslint-disable-next-line no-extend-native?. Since you set suppressReactErrorLogging to false, will this execute after the test above? Should you use jest.useFakeTimers() and force it to run with something like jest.runAllTimers()?. Cool, my primary concern was just confusion in test reporting if the error showed up randomly in the test suite because Node or Jest saw an uncaught error.\nNo need to chase this down too much.. Ah cool. Posted too late! I didn't realize that fake timers were already setup, so this wouldn't have run anyway.. Just for consistence with ReactDOMFiberSelect, can you assign this as a property, like:\njavascript\ndomElement.multiple = true. Can this be reverted?. This too?. Could you nix this space?. Looks like this doesn't need to map either Could you make this a forEach?. For other reviewers: I was curious about this removal, but it's a part of a general test that asserts how listeners are attached:\nhttps://github.com/facebook/react/blob/425738ee9dfe59db3245e2e67db03d05a280ab99/packages/react-dom/src/tests/ReactDOMEventListener-test.js#L355-L378\n\ud83d\udc4d . My first recollection is that we don't need to convert these to string values, but we didn't update all of the locations because it wasn't specific to the PR. \nInputs went through a lot of fixes as we ironed out all of the edge cases for special input types on Chrome/Safari, so to some degree, touching more than we needed to felt scary \ud83d\ude48. \nI think it would be good to take a second look at this.. I know I'm the first offender here (what is // TODO: we should warn here. even? \ud83d\ude3f ), but could you change this comment to something like:\n// TODO: defaultValue is a reserved prop and is not validated. Check warnings when they are. . Ah right. We need the new value to be a string for comparison (edit) because the value always reports as a string.. \ud83d\udc4d . Those are all great ideas! I'll update this section with these recommendations.. Haha, yeah... Though we still need to support React 14/15 for this page (but maybe only 15, we should talk about that).. Got it, 69b89ca8d\n\n. I debated back and forth with including the stack trace too, but it felt noisy when this is more or less a 404 every time. Really, I think description shouldn't be a required PropType on FixtureSet. Do you mind changing that instead?. I wonder if ping is widely understood. Changing this too.. Great idea. Done.. Hmmm. 'Warning: ' + is redundant with ${ args }. Fixing real quick.. @gaearon Ended up just moving this line up a bit so the string replacement is consistent between the two blocks. Feel okay? . Okay. No worries :). Sure. Style nit: but I think the implicit return with an assignment distracts from the test. Could you remove them, like:\n``javascript\nexpect(() => {\n  node = ReactTestUtils.renderIntoDocument(\n    <select onChange={noop} value={Symbol('foobar')}>\n      <option value={Symbol('foobar')}>A Symbol!</option>\n      <option value=\"monkey\">A monkey!</option>\n      <option value=\"giraffe\">A giraffe!</option>\n    </select>\n  )\n}).toWarnDev('Invalid value for propvalue');. It's curious that this is nullable and it's not clear to me whereinitialValue` is even used. \nNot important for this PR, but I can't help but wonder if initialValue can go away.. Yeah, I'm curious about that too. Writing a test for it now.. I had to move this before props updates, otherwise warnings never fire for Symbols server-side. I still need to figure out the ramifications of this change. Looks like defaultValue loses some SSR warnings, even though all tests pass.. I don't like how both of these functions are essential to safely cast values to strings. I'd like to also export a function that just calls both of these.. This should line up, adding unit test.. This appears to produce the effect I want, but it's gross. Now that it works as I think it should, I'll work on making the code better.. I'm not sure if I'm interpreting this correctly. I'm working off of:\n\nIn any case, this appears to fix a behavior where functions were stringified into textareas instead of converting into empty strings. There is no longer a mismatch.\nStill I can't figure out why ssr warning went away, even though I can confirm the warning in unit tests.. Took care of quite a few mismatches :). Trying to figure this one out. Unit tests suggest that a warning is firing using SSR. Does this mean that the attribute table didn't see a SSR warning?. Definitely. Thanks!. Great catch. Working through some changes now that actually eliminate all of our todos about warning on defaultValue.. Yikes, this should be OVERLOADED_BOOLEAN. With this addition, I think this set of operations is exactly the same for hydration and client-rendering. Also I think they need to be the same for SSR to align warning behavior. Maybe these should be in a shared function.. These are fixed in https://github.com/facebook/react/pull/13394. Since defaultValue is no longer a reserved word, it prevents it from being assigned as an attribute.. I'll double check. I removed a lot of string conversion to avoid stringifying symbols.. (really, I replaced it with ToStringValue method, but then stripped them away to see if they were actually necessary and it didn't seem so). Good catch. It did. I've added test coverage and fixed this by adding a safe string comparison method. I like this approach over eagerly coercing to strings because it makes it clearer when it's necessary.. (this was in 7619d04c516cb40eab31362164c320f7f057dd89). As long as I can remember. All reserved props get passed through without any validation from UnknownDOMPropertyHook. \nHow often do people pass true and false? It seems like it would rarely come up for inputs, but often enough for selects. What do you think?\nAlso I can work on making the comment better :). Hope this is clearer.. But I do wonder about this one. Since defaultChecked was reserved, I believe there was actually a mismatch between checked and defaultChecked. checked is a BOOLEAN value, whereas (I believe) defaultValue was effectively an OVERLOADED_BOOLEAN.\nI think they should be consistent, but just wanted to give a heads up that this could raise new warnings for consumers.. Man... this takes me back. I think they were added as an exception to the rules when the warning was first created:\nhttps://github.com/facebook/react/commit/de1de9e18f8faf153ad673c8206a2918e3e81035#diff-24dece27bd4b2d550d6d7cf69604586cR27\nMan. We've been doing this a long time \ud83d\ude28 \n. Looks like React 15.1.0. Doing a quick local test with the fixtures, I can confirm this behavior as far back as 0.14.0 (the fixtures break any time before that). Will this override the reporter on line 13?. Same question here. Do these need to generate unique reports?. Could you leave a comment in this script about what these arguments are?. As far as I know, the only differences in behavior are for replacing Symbols and Functions with empty strings when we added custom attributes in 16.\nAs long as I can remember, defaultValue and value were \"anything goes\". Any value gets stringified or turned into an empty string on null/undefined.\nLater today, I'll be able to do some archaeology.. Is this just way more efficient now?. #teamwork. This one should be removed.. Mmm. Nevermind. the camel casing below is for the React property name. It looks as though the capture argument is no longer necessary.. I used to include touch events, but I've reduced the event list for this fix down to wheel and scroll to reduce the testing surface area. If this approach goes well, we could follow up with a PR that evaluates those events too.. This is the new logic: do not dispatch the same native event to React more than once. This prevents the following case:\n<div onScroll={...}>\n  <div onScroll={...}>\n</div>\nIf a scroll event on the child triggers:\n\nThe child's internal React event handler dispatches to the synthetic event system\nThe child callback fires\nThe parent callback fires\nThe native event bubbles to the parent\nThe parent's internal React event handler dispatches to the synthetic event system\nThe parent callback fires\n\nThe expected behavior is that the child and parent callback are only triggered once, however the parent will trigger twice.\nBy tracking if an event has already dispatched, we can bail early and preserve the expected behavior. It wouldn't dispatch the second time. I wonder if you could get around that by removing the event from the set when it hits the root element (or some other indicator that the event was \"done\" dispatching).. > Also let's keep in mind that the end game is that we attach event listeners at the root rather than document. If that would also solve this problem maybe it's a better fix to focus on?\nI gave that a shot, but I wasn't able to prevent scroll jank. Attaching listeners locally was the only way that I could prevent it. I can do some more testing just to be sure, though.. Also, if this is only for scroll/wheel events, I wonder if we need to synthetically bubble/capture at all. For events that don't have synthetic dispatch phases (like mouse and composition events), maybe DOM bubbling/capture is simply sufficient.. > Doesn't implement portal bubbling.\nAh shoot \ud83d\ude22. \n\nFor which events? Did you include wheel, scroll, and touch events?\n\nWheel and scroll. But I'll give it another shot.. Portal bubbling is curious to me. Portals can exist in a different tree than the parent DOM elements, but still accept bubbled events, like clicks? . @gaearon you mentioned that touch events were essential (https://github.com/facebook/react/pull/9333#discussion_r212005901), would you like me to add them to the list here?. I sent out an alternative PR that attaches to the root here:\nhttps://github.com/facebook/react/pull/13460\nThis might work, I wrote the idea off because of some issues with mouse input on BrowserStack (I think, anyway). This definitely needs testing, but the approach in #13460 definitely feels ideal if I can figure out issues in Safari.. I'm going to revert this change. It isn't related to this work and should be done in a separate PR.. \ud83d\udc4d . This listener might actually deopt scroll events in Safari. Need to check.. I'm really curious why this causes Flow to fail:\n```\nError \u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508\u2508 ../../../packages/react-dom/src/client/ReactDOM.js:699:34\nCannot get container.parentNode._reactRootContainer because:\n \u2022 property _reactRootContainer is missing in null or undefined [1].\n \u2022 property _reactRootContainer is missing in Node [2].\n    ../../../packages/react-dom/src/client/ReactDOM.js\n    696\u2502         const isContainerReactRoot =\n    697\u2502           container.nodeType === ELEMENT_NODE &&\n    698\u2502           isValidContainer(container.parentNode) &&\n    699\u2502           !!container.parentNode._reactRootContainer;\n    700\u2502\n    701\u2502         warningWithoutStack(\n    702\u2502           !hasNonRootReactChild,\n\n    /tmp/flow/flowlib_302e1c24/dom.js\n\n[1][2] 440\u2502   parentNode: ?Node;\n```. Would this do the trick?\njavascript\n!!(container.parentNode: any)._reactRootContainer;. @iamdustan that was it. Thanks!. I removed the WeakSet part of this when it became clear that I really needed to assign a value (and use a WeakMap). I've removed that from this module so that the intent is clearer. If there is a concern with assigning attributes to events, we can use a WeakMap to make the association, which should be supported in most browsers.. Buble is the best!. Reverting this. This fixture caught this bug while I was working on it. I sent out a PR here:\nhttps://github.com/facebook/react/pull/13385. I think this is intentional, to catch bad casing of defaultValue.. It's always been this way, but I don't like how React stores an initial value:\nhttps://github.com/facebook/react/blob/master/packages/react-dom/src/client/ReactDOMFiberInput.js#L25\nI think the value should just be blank when it becomes null, or revert to the defaultValue prop (which could be null).. Should the name of this function be called stripUnusedImports instead of sizes?. Actually... spoke too soon (buble is still great) it turns out I needed Babel. Buble uses some __proto__ tricks that break in IE9/10. \nTo get IE9 support, I ended up pulling in babel/standalone with a few polyfills.. I'm curious about this line. createElement might always return a ReactElement in React code, but what code is mocking this in a way that would return null?. Didn't catch this in the rebase, patching up.. @philipp-spiess great call here. I was evaluating this in the context of the window, but I'm pretty sure we can keep it local just using a Function constructor.. Totally. I updated this doc-header to include the information:\nhttps://github.com/facebook/react/pull/13521/files#diff-b9d951f33318d5b9ee19bff3b7ad625eR4. Yup. See d5a4acd99. Great idea! See 437c45ba4. This should probably go straight to master. As far as I can tell, this is a bug, but I don't know if Touch is defined somewhere else or is actually correctly referencing the Touch DOM constructor. This possibly affects other renders \ud83d\ude28 . RestTestUtils.SimulateNative:\nhttps://github.com/facebook/react/blob/f6fb03edffcc5918ad2f37ed45bdc7c0c3b3d199/packages/react-dom/src/test-utils/ReactTestUtils.js#L479-L498. I think it's safe here because we know the nativeEvent type is always a DOMTopLevelType. \nThis is otherwise only used to cast the top level types themselves when they are created, like:\nhttps://github.com/facebook/react/blob/f6fb03edffcc5918ad2f37ed45bdc7c0c3b3d199/packages/react-dom/src/events/DOMTopLevelEventTypes.js#L25-L31\nI wonder if there is an existing concept of a DOM event's type string. We don't really have top level types in anymore: just the browser standard event names.\n. Commented! Part of me wonders if these could be annotated using the actual event type declarations here:\nhttps://github.com/facebook/flow/blob/08f854876cc72165f1f7a2e023bd8e79e8a7fa02/lib/dom.js#L144-L153\nIf that were the case, we could remove the concept of a top level type and just make it an DOM event type. Done in 60de292f6. This should not affect other renders. ReactGenericBatching.interactiveUpdates is only used inside of ReactDOMEventListener. . @gaearon this was the false positive case mentioned earlier. JSDOM doesn't update the active element on blur, only after blur() + a blur event. \nI have also walked through the number fixtures to verify that things continue to work as expected manually.. getToStringValue is called when assigning initialValue in the wrapper state: \nhttps://github.com/facebook/react/blob/7204b636ee2b46608811b11111a6cb4e544a8276/packages/react-dom/src/client/ReactDOMInput.js#L120-L122. Removed in 14dab5339. Ah, I'm being silly. I'll revert this too. Something can be done here. Working on it.\n. I was! I did this in addffb81f. I inlined this value because it is only needed in one place in both feature flag branches.. You are correct. This should call toString(). There were two places in postMount where it could stringify null or undefined. Otherwise this can stay the same. Updating now.. It's possible that this happens because value isn't present, so no operation occurs on value, so value tracking is never triggered. A solution could be to set the value from defaultValue or manually call tracking.. Totally. I've done this in e4f68fee7c8b5824c713b65198fab6415c70381d. Hard. We only need to call toString for value comparison so that we do not reassign the existing default value and trigger validation. null and undefined are already skipped. This also happens on the post mount step, and not during hydration. I'm not sure how to write a test for it.\nWe have a manual test fixture for this reason (sorry, I know the formatting isn't ideal):\nhttps://github.com/facebook/react/blob/a7bd7c3c0480c96e32d9518bb707172dfc72db58/fixtures/dom/src/components/fixtures/text-inputs/index.js#L65-L99\n. Could you eliminate this extra span by adding the class name to the label?. Could you add a style to center this vertically with the label? maybe:\ncss\n.header__checkbox {\n  vertical-align: middle;\n}\n. This is a four year old comment, I wonder if it is still relevant.. I'm curious if this was here for a reason. @gaearon do you know of any reason why this can't be relative?. Okay. Reason enough to revert this? There's still the de-duplication stuff in here. We could revise this PR to remove the relative import changes.. This is curious! I'm not sure what this was for. I'm guessing that this was just an artifact copy/pasting a snippet from ReactDOMRoot-test. It's quite a bit more sophisticated:\nhttps://github.com/facebook/react/blob/c84b9bf828c38e0b24042ebb9cd859292146a6fb/packages/react-dom/src/tests/ReactDOMRoot-test.js#L23-L45\nI think this is safe to remove.. I kind of wish this could be re-used, but it's unclear where something like that could go. .. Naw, I think this is fine.. Separate from all of this, it's a bummer this code path runs for all inputs on every update. I think we could really cut down on DOM modifications if we gave it some thought.. Small thing, but could you add a comment indicating that assigning size early is only necessary when multiple is false?. It sounds like, this does essentially the same thing as setting multiple=true before options are appended because they visually become similar:\nhttps://codepen.io/nhunzaker/pen/VgRQEy. Could we just capture all events?\nEdit: we've talked about this in the past, and I believe some of the sticking points boil down to event execution order. @philipp-spiess would be able to speak to this more, but I think React handles things in an inconsistent order too. I wonder if we could fix this up as a part of this work. . Here we go:\nhttps://github.com/facebook/react/pull/12919\n@philipp-spiess has a nice summary of the problems with my original attempt here:\nhttps://github.com/facebook/react/pull/12919#issuecomment-395224674. Ahh, :fire:. This is a great update!. I've been thinking about something similar for wrapper state meta data that is attached to inputs, like here:\nhttps://github.com/facebook/react/blob/d0289c7e3a2dfc349dcce7f9eb3dee22464e97bd/packages/react-dom/src/client/ReactDOMInput.js#L118-L126. Back to the capture thing. If we could ensure execution order is maintained, we could just capture all the media events and get rid of this block.\nThat's out of the context of this PR, but still I wonder.. Yes, sorry; I didn't give a very helpful comment either. \nAt the time, I stopped work on this because it wasn't clear if there was a way forward. However I was curious if you had any ideas.\nIt might just be a dead end.. I'm curious how this flag relates to interactive updates and if this will end up being a more general \"noPassive\" flag or something.. Ya. Thanks!. ",
    "jmcriffey": "Ah I see what you are saying. I'll go ahead and swap quotes, stringify, then swap back like you proposed unless anyone has any better ideas.\n. Yep, will do for this and quoteAttr. I am uncertain if it makes sense to introduce JSON.stringify for these values, so these two cases will be kept separate from xjs.js line 193-195 unless we decide all 3 values should be passed through JSON.stringify. \n. I'll match the closest code to whatever I'm working in. Looks like ' in all cases. If only there was a magical way to enforce quoting.\n. ",
    "jonathan-beebe": "Done\n. ",
    "gaearon": "Ah right. I only found spyOn later and tried using mocks at first. Will remove.\n. I think if most of the times in the source we see invariant(condition), it's better to have it that way without negations. I think demorganized version reads more easily.\n. \"The provide\" typo\n. There's a missing space after if\n. Maybe it's better to avoid bind here? After all it causes a function allocation, and this is a very tight spot so not good for GC.\nInstead you can write it as \njs\n  // Test for A's keys different from B.\n  var hasOwnProperty = Object.prototype.hasOwnProperty;\n  for (var i = 0; i < keysA.length; i++) {\n    if (!hasOwnProperty.call(objB, keysA[i]) || objA[keysA[i]] !== objB[keysA[i]]) {\n      return false;\n    }\n. Also note lodash does it this way\n. I don't think versions matter that much. The real issue is, they won't work together well, IMO it's worth explicitly stating that. Also a link to an official fb.me gist would be nice but that's up to maintainers.\n. Maybe use ReactUpdateQueue.enqueueForceUpdate(this)? This seems like it wouldn't work with components with strict shouldComponentUpdate, and will throw on non-Component-descending components.\n. A bit confused, why is .only there?\n. 0xeac7 0x0cc5!\n(edited for hexiness, thanks @RReverser for the tip)\n. I agree at least showing ES5 example once is good. People often have all sorts of misconceptions about ES6. If the docs only show lambdas some people will assume they have to use lambdas.\n. Oh, that's smart.\n. it.only\n. I agree with @andreypopp, it seems more magic than it actually is. I'd just leave ['node_modules'] there so it's clear how to add more folders though.\n. Rather than using exclude it's better to use include: path.join(__dirname__, 'src') or equivalent because this doesn't break for npm link'd modules.\n. I was trying to follow the existing style in this file.\nHere are a few places I haven't touched where indentation is the same as mine, and they also don't bother to extract the helper function:\nhttps://github.com/gaearon/react/blob/013340a44dbf99e5855962e68688453eab324f5f/src/renderers/dom/shared/DOMPropertyOperations.js#L159-L160\nhttps://github.com/gaearon/react/blob/013340a44dbf99e5855962e68688453eab324f5f/src/renderers/dom/shared/DOMPropertyOperations.js#L229-L230\nhttps://github.com/gaearon/react/blob/013340a44dbf99e5855962e68688453eab324f5f/src/renderers/dom/shared/DOMPropertyOperations.js#L302-L303\nI'm happy to re-indent all of them at once and add a helper for getting the property, if you'd like! Just wanted to avoid introducing inconsistencies. Also I didn't want to overgeneralize because this code will later be likely removed when we kill the deprecation path and just start treating SVG pretty much like custom components.\n. I think it shouldn't be an issue here because this fragment is not a complete config, and it has enough context around it. \n. Yeah it failed locally for me so I had to fix it. But somehow it didn't fail in the PR that added this file.\n. Is this still relevant? The PR just got merged.\n. Perhaps you're supposed to use %s there. Check out other warnings in the codebase.\n. I'd add a note about persist() just before the link so the user doesn't overlook the solution they likely need.\n. dispatchConfig and _targetInst are both implementation details and are considered private fields.\nI think we don't have to warn on accessing those.\nThis leaves us with nativeEvent which can be hardcoded as a special case below.\n. As far as I know, in production, this will become an empty branch:\njs\nif (this._destructored) {\n}\nThis is why it seems better to wrap the whole thing in __DEV__ rather than the other way around.\n. Placing return inside __DEV__ means the library can behave differently in development and production, depending on the code below. This can lead to hard-to-reproduce bugs. It\u2019s fine to only log a warning in dev, but all other behavior, including early exits, should be identical.\n. Can you please help me understand why it is necessary to move this block up and wrap it in if (this._destructored)? It seems to me like existence of nativeEvent was enough and still should be enough to tell whether the object was \u201ccleared\u201d, which is how the old code worked.\n. I don't think we want to introduce a function (and bind it) in such a hot path such as event destructor. I think it would be better to hoist this code outside destructor and make sure that when __DEV__ is false, all code and overhead related to this warning is removed.\nCurrently, in production, this would compile to \njs\ndestructor: function() {\n  // ...\n  function setToNullOrWarning(propName) { // <-- function allocation\n    this[propName] = null\n  }\n}\nAs you can see it\u2019s a performance regression from just placing this code inline, which we want to avoid.\n. I can't speak for React maintainers but even a function call seems like more indirection compared to a direct assignment. It might be better to do something like\n``` js\nif (DEV) {\n  function getPooledWarningPropertyDefinition() {\n    // ...\n  }\n}\n// ...\nvar Interface = this.constructor.Interface;\nfor (var interfacePropName in Interface) {\n  if (DEV) {\n    Object.defineProperty(this, interfacePropName, getPooledWarningPropertyDefinition(interfacePropName))\n  } else {\n    this[interfacePropName] = null;\n  }\n}\nif (DEV) {\n  Object.defineProperty(this, 'nativeEvent', getPooledWarningPropertyDefinition('nativeEvent'));\n} else {\n  this.nativeEvent = null;\n}\n```\nThis way the impact on prod is minimal. \nHowever this is just my opinion. What I would do is to grep the code for more warning calls inside getters, and see how their codepaths differ from production codepaths. It is very likely that this particular pattern (\u201cassign a descriptor proxy in dev and a value in prod\u201d) already exists elsewhere in the codebase, and check how it\u2019s usually done.\n. I think you can do the opposite:\n- Remove the warnings from method implementations\n- In the destructor, use Object.defineProperty to put functions-that-just-emit-warnings (and noop in production) instead of the real implementations\n. I think we have emptyFunction somewhere in the codebase. Can you grep for it? Better than allocating it here. \n. Nit: I don't think this comment is necessary. Do we use similar comments in the codebase?\n. I still think it's worth adding a sentence about persist() just before the link. If you add it, please do this for every message to keep them consistent. \n. Also it might be good to hoist the almost identical warning message from getter/setter into the function definition, and pass the different part as %s. In addition, it might be best to preserve the old wording (calling a method rather than accessing the property) for methods.\n. Ah, good point. Maybe something like \"accessing a method\" is neutral enough?\n. Typo: Parnet -> Parent\n. This comment looks like a copy paste artifact. Is it?\n. I put these behind __DEV__ for now but we\u2019ll reconsider before merging #6046.\n. The return value in all cases seemed to be undefined so I\u2019m not passing it back.\n. What is the difference between \u201cdebug tool\u201d and a \u201cdev tool\u201d? I got tripped by this a couple of times because I write a Devtool but I\u2019m then adding it to a DebugTool which I refer to as ReactDOMInstrumentation.debugTool. Why is there more than one layer of indirection?\n. Thank you for explaining. I\u2019m curious because I wonder how something like Chrome extension would work once we port it to use this API. Currently Chrome extension works with production builds. Would that no longer be the case (presumably because production builds would use a noop debug tool)?\n. To add more context, I am adding some events that will be useful both to React DevTools and new ReactPerf in https://github.com/facebook/react/pull/6068. If those are DEV-only, the new ReactPerf would also be DEV-only which would defeat the purpose of ReactPerf. How would debug tool / devtool distinction handle this problem?\n. I was acting on @sebmarkbage\u2019s comment in https://github.com/facebook/react/pull/6046#issuecomment-185379962.\n\nReactDOMInstrumentation is only for DOM specific operations so you'd want to replicate it with a ReactInstrumentation file that does the same thing.\n\nWe can definitely do it per renderer (especially considering that for now, we\u2019ll have to do profiling calls in #6046 per renderer anyway). However even for profiling calls the longer term is to have shared reconciliation logic and do them in generic way, per https://github.com/facebook/react/pull/6046#issuecomment-186119193:\n\nHowever, note that I also want to unify the way native components are rendered so that a lot of that wouldn't vary by renderer eventually. The recursion will move into shared code. That way we could put these measurements in a generic way.\n\nThe tools that rely on ReactInstrumentation will have to make some assumptions. I think that \u201ccomponents get mounted, updated, and unmounted\u201d is a good one. Yes, it means that these hooks never fire on the server, but what practical difference does it make? On the other hand, as a benefit React DevTools extension can work with any renderer out of the box (pretty much like it does now, but without the monkey patching).\n. Hi Josh,\nThank you very much for looking through it! I used this approach at first but felt it introduces some undesired bookkeeping in the consuming code. I don\u2019t mind adding it given enough interest but in this case I think we\u2019re covered well by the guarantee that the scopes are never nested.\nOne of the goals of this refactoring is to stop relying on stacked calls, and explicitly forcing stop() calls to match exactly the preceding start() call without keeping track of the stack. I feel that this gives even an even stronger guarantee than a scope token unless I am missing something.\nIf we desire to add limited support for nesting profiler calls then we will definitely need a token system. However it seems that nesting invites assumptions about work stack matching parent hierarchy which are true today but will be broken by the incremental reconciler. So I would rather avoid nesting at all.\n. > Would the work stack be completely divorced from the parent hierarchy?\nNot completely but moving towards divorcing it is the plan, especially in perf-critical situations like infinite lists. We want to reconcile what\u2019s on the screen with a priority so visible children will receive updates faster than other children and/or parents.\nIn addition we already do some pretty important work asynchronously\u2014for example, we run componentDidMount outside the mounting work stack. Current ReactPerf completely misses it for this reason, but this version doesn\u2019t.\nI think we can still draw flame charts with the new approach. They could use the parent hierarchy for the stack levels, and reflect the situation more precisely by separating the actionable parts from the parts imposed by React itself.\nThat said I don\u2019t have a vast experience building profiler tools so I may be off here.\n. > Would I be writing my own devtool function or do I use something like ReactDOMInstrumentation.debugTool.onSetValueForProperty(inst, 'processingChildContext', true)\nI think both. Here\u2019s another example of adding a devtool for warnings: https://github.com/facebook/react/commit/251d6c30b51c6aa9a406f9076c0f895570a710b3\nonSetValueForProperty() will not be relevant here, it\u2019s only called this way because it is called when React sets a value for DOM property.\nIn your case, you can add onBeginProcessingChildContext() and onEndProcessingChildContext(), and a new ReactInvalidSetStateWarningDevTool (or something like this) that would set the flag.\nAlso, since it\u2019s related to React and not ReactDOM in particular, perhaps it makes sense to use ReactInstrumentation introduced in #6068 instead of ReactDOMInstrumentation.\n. It might be more compact to write\njs\nwarning(\n  !processingChildContext,\n  'setState(...): Cannot call setState inside getChildContext()'\n);\n. I don\u2019t think it really matters here. This is temporary code and the style is up to React team. It will probably change 20 times before this is ready to merge :-)\n. I was not sure what is the point of setting nextProp to null here. It caused removeAttribute() call but it\u2019s not like this attribute existed in the first place? Since this didn\u2019t break any tests (:wink::wink:), I just put it behind an if.\n. Made this a separate test because can\u2019t check children and dangerouslySetInnerHTML at the same time.\n. I do actually have it just below: I wanted to check that both having two elements and having two renders produces a unique result per attribute name.\n. Might as well change the test title to skip semi :smile: \n. Nitpicking: let\u2019s add () for consistency? As in Cannot call setState() inside getChildContext().\n. Would running a separate test with a mocked \"is IE\" flag help prevent the issue?\n. Sounds good to me, I\u2019ll change to use verbatim lifecycle hook names.\n. I changed lifecycle timers to use the method name (render, componentDidMount, etc, except for updateRefs which isn\u2019t a real name\u2014couldn\u2019t figure out a better way to phrase this), and the reconciler timers to use the internal method name (e.g. mountComponent).\n. Nit: they were never supported in the first place.\n. Should we assert its return value here too?\n. I removed this one because it\u2019s not enough for ReactDOM.render() code path. ReactMount calls the callback synchronously on the initial render so we would fail to print the error if we only checked here.\nCurrently ReactMount is the only thing using enqueueCallbackInternal. I could put an additional validateCallback call here too but then it would run twice on every initial render.\n. This comment is outdated now, is it not? Should be //versionwill be added here by React module. or something.\n. I think we want to use the \u201cdevtool\u201d API for the new warnings. You can check how ReactDOMUnknownPropertyDevtool currently works for the context\u2014it just needs to be called during the element creation.\n. Before this PR, this comparison used to break due to _owner. See https://github.com/bmullan91/react-shallow-renderer-bug for a repro case.\n. Note: this is actually not the case. If there is only a single child passed from JSX explicitly, you will get this child as a single element instead. The only correct way to manipulate children is to treat it as opaque data structure and use React.Children. In this case, to enforce a single child:\njs\nfunction renderFirstChildOnly(children) {\n  return React.Children.toArray(children)[0];\n}\nIdeally just React.Children.onlyChild should work but unfortunately it doesn\u2019t flatten arrays right now. It\u2019s a separate valid issue and we might need to implement this.. I think.\n. We should always avoid binding in render().\n. I don\u2019t like that we are leaking this to the consumer. If consumer passes the props, they already have information about the props, so there is no need to pass them or the instance back.. I think.\nMaybe, rather than make this a default prop, let\u2019s make it optional and instead branch inside render() method? \njs\nvar render = this.props.render || this._renderWrapper;\nreturn render(children);\n. shouldConstruct sounds good. A little misleading that we still call _constructComponent even though shouldConstruct can be false but I\u2019m out of good function names at this point. (instantiate* is taken for another purpose :smile: )\n. Ideally we'd want something like\njs\nvar OnlyChild = React.createClass({\n  render: function() {\n    var children = this.props.children;\n    return children ? React.Children.only(children) : null;\n  }\n});\nbut Children.only doesn\u2019t currently handle arrays correctly, and transition group uses arrays even if you pass a single element.\n. Why is DisabledInputUtils.getNativeProps called last here unlike ReactDOMSelect and all other components where it is called inline in the assign call?\n. Yeah I think we should really try hard to save allocations here.\n. \n. Sure if you feel this makes a difference. I wouldn\u2019t worry too much about optimizing this code path because usually you only have a handful of disabled inputs on the page.\n. Don\u2019t we want to remove support for <textarea>{children}</textarea> anyway? Might as well do that together with this. (Obv in 16 earliest.)\n. Let\u2019s avoid double negations. You want to specify the \u201cnormal\u201d condition in the warning call. The normal condition is when the __proto__ ain\u2019t there or it is Object.prototype. So let\u2019s write it like\njs\n warning(\n  config.__proto__ == null || config.__proto__ === Object.prototype,\ninstead.\n. I find this warning message a little bit confusing. Maybe we could write something like \n\nReact.createElement(...): Expected props argument to be a plain object. Props defined in its prototype chain will be ignored.\n\nWhat do you think?\n. Oh, I see. Even if people migrated to defaultValue they\u2019d still rely on the old behavior?\n. Nits:\n- double space before It is\n- every render => on every render (IMO that reads better)\n. Tiny nit: let\u2019s remove line breaks where there are just two lines in the test.\nThanks!\n. Let\u2019s use a link from the root, i.e. [shallow comparison](/react/docs/...)\n. Let\u2019s add some backticks for this.tick\n. Let\u2019s make shouldComponentUpdate() a link to /react/docs/component-specs.html#updating-shouldcomponentupdate.\n. This is still not enough to compile the module in question.\nI only got it working after changing the command to include the react preset:\nwebpack main.js bundle.js --module-bind 'js=babel-loader?presets=react'\nWould you like to amend this please?\n. Thanks, your version is better!\n. .only\n. Yeah, I just noticed the rest of the checks in this file used argsForCall so I changed it for consistency. Should I change it back?\n. Nit: Can we make a linebreak before the first The so it starts on the next line?\nAnother nit: on each time => for each item.\nYet another nit: please change , The to . and start The on the next line it doesn\u2019t \u201chang\u201d here either.\nThank you!\n. Let\u2019s remove location and propFullName here unless we consistently use it both in this example and in the customProp above.\n. Nit: let\u2019s remove Further and just start the sentence with You can ....\n. While we started using ES6 in the docs, I think we try to call it out explicitly when we do this (e.g. when we use classes and arrows). In this particular case I think we\u2019re better off concatenating strings the traditional way so people who aren\u2019t entirely comfortable with ES6 don\u2019t get distracted by this.\n. Let\u2019s change element to item. We call the result of React.createElement() elements, and it may be a tiny bit confusing here.\n. Please add a space between if and (\n. The lint fails here because of the indentation: https://travis-ci.org/facebook/react/jobs/120646658#L241-L273\n. Nit: missing spaces before and after +\n. Let\u2019s put ReactComponent in backticks. I would also rephrase to clarify: \"currently returns a reference to the root ReactComponent instance that was mounted as a result of this call.\"\n. I think it\u2019s good to explain why we ask people to change their code. I would change \"using this return value is legacy\" to \"we are deprecating this way of accessing the root component instance because in the future React might render components asynchronously in some cases.\"\n. We should add a small example here. Like this:\n``` js\n// Before:\nvar instance = ReactDOM.render(, rootEl);\ndoSomethingWithInstance(instance);\n// After:\nReactDOM.render(, rootEl);\n``\n. Nit: let\u2019s use single character spaces instead of two spaces between sentences for consistency.\n. Yeah. We\u2019ve been doing that in other posts so I followed the same pattern. Obviously not very happy with it but hey, at least this doesn\u2019t break Jekyll!\n. Any specific reason why you're changing comparisons to be looser here? They used to be true for null but are now false. \n. Two small nits:\n- Please putin backticks () so it appears as code\n- Please change React's to React\u2019s (correct apostrophe that\u2019s used throughout the post)\nThanks!\n. Alternatively I can put these into getName() of ReactDOMEmptyComponent and ReactDOMTextComponent. I\u2019m not sure which way would be preferable. This seems like a better catch-all for other renders but maybe this doesn\u2019t matter?\n. Is this necessary? Doesn\u2019t appear to be used.\n. ... which in an alternative universe might have prevented the spreadgate. :smile: \n. Let\u2019s remove hyphens on these two lines? Technically these could be dashes but I think it reads just fine if we completely remove them.\n. I would change\n\nLanguage Tooling provides information on using transpilers (most notably Babel to transform JSX) as configured for use with React.\n\nto \n\nLanguage Tooling describes how to set up Babel to transpile JSX and ES2015 for a better development experience.\n. Nit: two spaces between sentences but should be one.\n. Repetition: \"help you build great applications\".\nCan probably rephrase as\nThere are many tools to help you build great applications. In these sections we introduce some of them that are most commonly used together with React.\n. Let\u2019s change to ES2015 for consistency.\n. > will inject a React global \n\nlet\u2019s change to\n\nwill inject a React and ReactDOM globals\n. prev here should point to language-tooling.html instead?\n. Nit: two spaces between sentences, should be one\n. Nit: two spaces between sentences, should be one\n. It\u2019s a bit confusing we create .babelrc above but then specify presets manually below. Can we just remove the presets here?\n. This webpack command doesn\u2019t actually work as is, please see #6137.\n. Since we are using .babelrc looks like we need to change this to just use --module-bind 'js=babel-loader'.\n. ES2015\n. npm is officially lowercase (and is so elsewhere in the guide).\nLet\u2019 change this to Using React with npm or Bower\n. As far as I can see, this will print Expected object but got object. for arrays.\n. I mean that we should avoid confusing warnings even if turn up in edge cases.\nWe could do something like\n\njs\nvar type;\nif (spec == null) {\n  type = '' + spec;\n} else if (Array.isArray(spec)) {\n  type = 'array';\n} else {\n  type = typeof spec;\n}\n. I want to make sure this happens before any devtool receives the event. (Since devtools are actually going to get IDs\u2014I will implement this separately later but #6046 shows how it could work).\nI also want to have the opposite guarantee for unmounting: that ID gets unregistered after all the other devtools have run. This is why putting such a devtool as first in list wouldn\u2019t work.\n. Ah, I see. Never mind then, I retract my previous comment :+1: \n. As noted below, you\u2019re right\u2014we\u2019ll never get into this block with arrays anyway so it doesn\u2019t matter. I was wrong!\n. \", or want\" <-- missing \"you\"\n. Let\u2019s remove the caps and the additional indentation here?\n\nNote: Using Babel [...]\n. Let\u2019s put Node first?\n. I would split this into several lines.\n. missing var\n. Nit: Java8+ => Java 8+.\n. Let\u2019s backtick-quote Object.assign?\n. Can you please move this declaration right after shouldAutoBind? It seems a little fishy to declare a local variable inside a __DEV__ block inside if and then use it in other if branches outside that particular __DEV__ block. Uglify will remove it from production builds anyway.\n. These 5 lines seem identical in three different places. Can we move this __DEV__ block outside the conditions and write this once?\n. Can this indirection (passing 'ref' instead of directly reading config.ref) cause any performance regressions in the production path? I\u2019m not well versed in optimizations like this but it\u2019s a super hot code path so we better make sure we don\u2019t regress on it in prod.\n. The main use case so far is ReactPerf only shows composites in the stats. Now that I think of it it probably doesn't matter because we gather their stats independently now. I'll see if I can remove it!\n. One problem I had is it\u2019s hard to know whether something is a top level wrapper until it\u2019s mounted and we can do the instance._renderedComponent._currentElement === instance._currentElement.props duck typing check.\n\nI can add a special static field to its type so we can know to _debugID to 0 in instantiateReactComponent for it. Then ReactDebugTool can easily ignore any events about it as if they never happened.\n. I added this so the tree devtool would filter them out in getChildIDs. Alternatively I can go back to the old approach:\n- Make composite check for whether the rendered component is empty, and ignore it in onSetChildren\n- The tree devtool becomes unaware of parent-child association between composite and empty component so it can't clean it up on unmount easily\n- We have to add the native container IDs back so it's cleaned up on native container unmount instead\nIt feels like what I have now is simpler in terms of logic (all cleanup paths are the same and are caused by unmounting) but I can bring back native container tracking if it is more desirable.\n. Should this be .NET? I would expect this to work with any other .NET language but I might be wrong.\n. Now that #6549 landed, the argument is debugID rather than internalInstance.\nWould you mind rebasing on that?\n. Typo, should be Instead\n. I wonder if we want to call this ReactStatelessFunctionalComponent or ReactFunctionalComponent instead. It\u2019s stateless alright, but class components can also be stateless. Not sure.\n. The internal naming can sometimes differ from what we want to expose publicly (e.g. we call shared modules isomorphic in the source but we never use this word in the docs). So maybe this is one of those cases.\ncc @sebmarkbage for terminology clarification\n. Let\u2019s change this to Submitting a Form\n. The links here should be relative to the website. Here it should be something like /react/docs/more-about-refs.html#the-ref-callback-attribute.\n. I don\u2019t think it would ever be null here. If the ref is null, the component was unmounted, so you can\u2019t possibly get into the event handler.\n. Let\u2019s change this to ref={form => this.form = form} to be more consistent with some of our other examples.\n. I would break earlier so that ref is more visible. Right now the important part is easy to miss. Maybe do it this way:\njs\n<form\n  href=\"...\"\n  method=\"..\"\n  ref={...}>\n  ...\n</form>\n?\n. This ref is no longer necessary here, as you are not using it.\n. I would be wary of making it appear that React is concerned with things being \u201csemantic\u201d.\nMaybe change it to be the easiest.\nThis advice isn\u2019t just applicable to React but since we\u2019re adding this section, might as well include it!\n. Missed this: we need the link to start with /react/... in case we ever change the domain and for local dev. \n. I think this comes down to the way printWasted() heuristic works. It says \u201ccount a render as wasted if no DOM operations below were made during the same batch\u201d. I was trying to replicate the existing behavior so this is the main reason.\nI think we may want to reconsider this as part of #6632. I\u2019d leave it as is for now though.\n. This block has moved to ReactDebugTool.\n. \u0414\u0430\u0432\u0430\u0439\u0442\u0435 \u043f\u043e\u043f\u0440\u043e\u0431\u0443\u0435\u043c \u0431\u0435\u0437 \u043f\u0440\u0438\u043c\u0435\u0447\u0430\u043d\u0438\u0439 \u043f\u0435\u0440\u0435\u0432\u043e\u0434\u0447\u0438\u043a\u0430, \u0432\u0441\u0451-\u0442\u0430\u043a\u0438 \u044d\u0442\u043e \u043d\u0435 \u043d\u0430\u0443\u0447\u043d\u0430\u044f \u0441\u0442\u0430\u0442\u044c\u044f \ud83d\ude09 .\n. \u0417\u0434\u0435\u0441\u044c \u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u0435\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u0442\u0438\u0440\u0435 (\u2014), \u0430 \u043d\u0435 \u0434\u0435\u0444\u0438\u0441 (-). \u0412\u043c\u0435\u0441\u0442\u043e \u00abJS-\u0431\u0438\u0431\u043b\u0438\u043e\u0442\u0435\u043a\u0430\u00bb \u043b\u0443\u0447\u0448\u0435 \u043d\u0430\u043f\u0438\u0441\u0430\u0442\u044c \u00ab\u0431\u0438\u0431\u043b\u0438\u043e\u0442\u0435\u043a\u0430 JavaScript\u00bb, \u043a\u0430\u043a \u044d\u0442\u043e \u0434\u0435\u043b\u0430\u0435\u0442, \u043a \u043f\u0440\u0438\u043c\u0435\u0440\u0443, \u0432\u0438\u043a\u0438\u043f\u0435\u0434\u0438\u044f.\n. \u042f \u0434\u0443\u043c\u0430\u044e, \u0447\u0442\u043e \u043c\u044b \u043d\u0435 \u0445\u043e\u0442\u0438\u043c \u0442\u0440\u0430\u043d\u0441\u043b\u0438\u0442\u0435\u0440\u043e\u0432\u0430\u0442\u044c \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435. \u0414\u0430\u0432\u0430\u0439\u0442\u0435 \u0432\u0435\u0437\u0434\u0435 \u043f\u043e\u043c\u0435\u043d\u044f\u0435\u043c \u0441 \u0420\u0435\u0430\u043a\u0442 \u043d\u0430 React.\n. \u041f\u0440\u0438\u043c\u0435\u0447\u0430\u043d\u0438\u0435 \u043b\u0443\u0447\u0448\u0435 \u0443\u0431\u0440\u0430\u0442\u044c.\n. \u0414\u0430\u0432\u0430\u0439\u0442\u0435 \u043f\u043e\u043f\u0440\u043e\u0431\u0443\u0435\u043c \u0438\u0437\u0431\u0435\u0436\u0430\u0442\u044c \u0430\u043d\u0433\u043b\u0438\u0439\u0441\u043a\u0438\u0445 \u0441\u043b\u043e\u0432 \u0432 \u0441\u043a\u043e\u0431\u043a\u0430\u0445 \u0438 \u043a\u0430\u0432\u044b\u0447\u0435\u043a.\n. \u043f\u0438\u0448\u0438\u0442\u0435 => \u043f\u0438\u0448\u0435\u0442\u0435\n. \"\u0423\u0434\u0435\u043b\u0438 \u044d\u0442\u043e\u043c\u0443 5 \u043c\u0438\u043d\u0443\u0442\" \u043f\u0440\u043e\u0447\u0438\u0442\u0430\u0439\u0442\u0435 \u044d\u0442\u043e\u0442 \u0433\u0430\u0439\u0434 <- \u0441\u043b\u0438\u043f\u043b\u0438\u0441\u044c \u0433\u043b\u0430\u0433\u043e\u043b\u044b. \u041a\u0441\u0442\u0430\u0442\u0438, \u0434\u0430\u0432\u0430\u0439\u0442\u0435 \u043f\u043e\u043f\u0440\u043e\u0431\u0443\u0435\u043c \u0438\u0437\u0431\u0435\u0436\u0430\u0442\u044c \u0441\u043b\u043e\u0432\u0430 \"\u0433\u0430\u0439\u0434\".\n. \"\u0427\u0442\u043e\u0431\u044b \u043e\u043d \u043f\u043e\u0437\u0432\u043e\u043b\u0438\u043b \u043d\u0430\u043c \u0440\u0435\u0448\u0438\u0442\u044c\" -> \"\u0447\u0442\u043e\u0431\u044b \u0440\u0435\u0448\u0438\u0442\u044c\" :-)\n. \u041e\u043f\u0435\u0447\u0430\u0442\u043a\u0430 (\u0432\u0432\u044b\u0432\u043e\u0434). \u041d\u0430\u0432\u0435\u0440\u043d\u043e\u0435 \u043b\u0443\u0447\u0448\u0435 \"\u043e\u0442\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435\" \u0432 \u044d\u0442\u043e\u043c \u043a\u043e\u043d\u0442\u0435\u043a\u0441\u0442\u0435. \n. \u041d\u0435 \u0441\u0442\u043e\u0438\u0442 \u0433\u043e\u0432\u043e\u0440\u0438\u0442\u044c \"\u043d\u0430 \u0442\u044b\" \u0432 \u0434\u043e\u043a\u0443\u043c\u0435\u043d\u0442\u0430\u0446\u0438\u0438. \u041d\u0435 \u0441\u0442\u043e\u0438\u0442 \u0431\u0443\u043a\u0432\u0430\u043b\u044c\u043d\u043e \u043f\u0435\u0440\u0435\u0432\u043e\u0434\u0438\u0442\u044c \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u044f, \u043a\u043e\u0433\u0434\u0430 \u0442\u043e \u0436\u0435 \u0441\u0430\u043c\u043e\u0435 \u043c\u043e\u0436\u043d\u043e \u0433\u043e\u0440\u0430\u0437\u0434\u043e \u0431\u043e\u043b\u0435\u0435 \u0435\u0441\u0442\u0435\u0441\u0442\u0432\u0435\u043d\u043d\u043e \u0441\u043a\u0430\u0437\u0430\u0442\u044c \u043f\u043e-\u0440\u0443\u0441\u0441\u043a\u0438. \u041f\u0440\u0438 \u0447\u0442\u0435\u043d\u0438\u0438 \u043d\u0435 \u0434\u043e\u043b\u0436\u043d\u043e \u0432\u043e\u0437\u043d\u0438\u043a\u0430\u0442\u044c \u043e\u0449\u0443\u0449\u0435\u043d\u0438\u044f, \u0447\u0442\u043e \u044d\u0442\u043e \u043a\u0430\u043b\u044c\u043a\u0430. \n\u041d\u0430\u043f\u0440\u0438\u043c\u0435\u0440, \u0432\u043c\u0435\u0441\u0442\u043e\n\n\u0421\u0430\u043c\u043e\u0435 \u043e\u0441\u043d\u043e\u0432\u043d\u043e\u0435, \u0447\u0442\u043e \u0442\u044b \u043c\u043e\u0436\u0435\u0448\u044c \u0441\u0434\u0430\u0442\u044c \u0441 \u043f\u043e\u043c\u043e\u0449\u044c\u044e \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430 \u2014 \u044d\u0442\u043e \u043f\u043e\u043a\u0430\u0437\u0430\u0442\u044c \u0434\u0430\u043d\u043d\u044b\u0435.\n\n\u041c\u043e\u0436\u043d\u043e \u043f\u0435\u0440\u0435\u0432\u0435\u0441\u0442\u0438 \u0431\u043e\u043b\u0435\u0435 \u0435\u0441\u0442\u0435\u0441\u0442\u0432\u0435\u043d\u043d\u043e:\n\n\u0413\u043b\u0430\u0432\u043d\u0430\u044f \u0437\u0430\u0434\u0430\u0447\u0430 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430 \u2014 \u044d\u0442\u043e \u043e\u0442\u043e\u0431\u0440\u0430\u0436\u0430\u0442\u044c \u0434\u0430\u043d\u043d\u044b\u0435.\n. \u0412\u0442\u043e\u0440\u043e\u0435 \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u0435 \u0432 \u044d\u0442\u043e\u043c \u0430\u0431\u0437\u0430\u0446\u0435 \u043e\u0447\u0435\u043d\u044c \u0442\u044f\u0436\u0435\u043b\u043e \u0447\u0438\u0442\u0430\u0435\u0442\u0441\u044f. \u041f\u043e\u0436\u0430\u043b\u0443\u0439\u0441\u0442\u0430 \u0437\u0430\u043c\u0435\u043d\u0438\u0442\u0435 \u0435\u0433\u043e \u043d\u0430 \u0435\u0441\u0442\u0435\u0441\u0442\u0432\u0435\u043d\u043d\u044b\u0439 \u0440\u0443\u0441\u0441\u043a\u0438\u0439 \u044d\u043a\u0432\u0438\u0432\u0430\u043b\u0435\u043d\u0442. \n. \"\u043d\u0438\u043a\u043e\u0433\u0434\u0430 \u043d\u0435 \u043f\u0438\u0448\u0438\u0442\u0435\" \u043d\u0435\u043f\u043e\u043d\u044f\u0442\u043d\u043e. \u0421\u043c\u044b\u0441\u043b \u0437\u0434\u0435\u0441\u044c \"\u043d\u0438\u043a\u043e\u0433\u0434\u0430 \u043d\u0435 \u043f\u0435\u0440\u0435\u0437\u0430\u043f\u0438\u0441\u044b\u0432\u0430\u0439\u0442\u0435 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u044f \u0432\u043d\u0443\u0442\u0440\u0438 this.props\".\n. \u041d\u0430 \"\u043e\u0442\u0440\u0438\u0441\u043e\u0432\u044b\u0432\u0430\u044e\u0442\" \u0432 \u0434\u0430\u043d\u043d\u043e\u043c \u0441\u043b\u0443\u0447\u0430\u0435, \u043b\u0443\u0447\u0448\u0435 \u0431\u0443\u0434\u0435\u0442 \"\u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u044e\u0442\". \n. \u041f\u0440\u043e\u043f\u0443\u0449\u0435\u043d\u0430 \u0437\u0430\u043f\u044f\u0442\u0430\u044f \u0432 \u0441\u043b\u043e\u0436\u043d\u043e\u043c \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u0438. \u0412\u0440\u043e\u0434\u0435 \u0431\u044b \u0435\u0441\u0442\u044c \u0435\u0449\u0451 \u043f\u0430\u0440\u0443 \u043c\u0435\u0441\u0442 \u0441 \u044d\u0442\u043e\u0439 \u0436\u0435 \u043f\u0440\u043e\u0431\u043b\u0435\u043c\u043e\u0439. \u0420\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0443\u044e \u043f\u0440\u043e\u0433\u043d\u0430\u0442\u044c \u0447\u0435\u0440\u0435\u0437 \u043a\u0430\u043a\u043e\u0439-\u043d\u0438\u0431\u0443\u0434\u044c \u0433\u0440\u0430\u043c\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0439 \u0432\u0430\u043b\u0438\u0434\u0430\u0442\u043e\u0440. \n. \u0422\u0438\u0440\u0435 \u043d\u0435 \u043d\u0443\u0436\u043d\u043e. \n. \"\u043f\u043e\u043b\u0441\u0435\u043a\u0443\u043d\u0434\u044b\" \u0441\u043b\u0438\u0442\u043d\u043e\n. > \u0412\u043e\u0442 \u0442\u0430\u043a, \u043d\u0435 \u043d\u0430\u043f\u0438\u0441\u0430\u0432 \u043d\u0438 \u0441\u0442\u0440\u043e\u0447\u043a\u0438 \u043a\u043e\u0434\u0430, \u043d\u0430\u0448\u0430 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0430 \u0443\u0436\u0435 \u043e\u0431\u043b\u0430\u0434\u0430\u0435\u0442 \u0441\u0432\u043e\u0438\u043c \u043f\u043e\u0432\u0435\u0434\u0435\u043d\u0438\u0435\u043c.\n\n\u041d\u0435\u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u043e\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0435 \u0434\u0435\u0435\u043f\u0440\u0438\u0447\u0430\u0441\u0442\u043d\u043e\u0433\u043e \u043e\u0431\u043e\u0440\u043e\u0442\u0430: http://rus.1september.ru/article.php?ID=200403608\n\u041c\u043e\u0436\u043d\u043e \u0442\u0430\u043a:\n\n\u041e\u0431\u0440\u0430\u0442\u0438\u0442\u0435 \u0432\u043d\u0438\u043c\u0430\u043d\u0438\u0435, \u0447\u0442\u043e \u043c\u044b \u043d\u0435 \u043d\u0430\u043f\u0438\u0441\u0430\u043b\u0438 \u043d\u0438 \u0441\u0442\u0440\u043e\u0447\u043a\u0438 \u043a\u043e\u0434\u0430, \u0447\u0442\u043e\u0431\u044b \u0443\u043f\u0440\u0430\u0432\u043b\u044f\u0442\u044c \u044d\u0442\u0438\u043c \u043f\u043e\u0432\u0435\u0434\u0435\u043d\u0438\u0435\u043c.\n. \u0421\u043b\u043e\u0436\u043d\u043e\u0435 \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u0435, \u043f\u043e\u0441\u043b\u0435 \"\u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f\" \u043d\u0443\u0436\u043d\u0430 \u0437\u0430\u043f\u044f\u0442\u0430\u044f\n. \"\u0438 \u043c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u043e \u044d\u0444\u0444\u0435\u043a\u0442\u0438\u0432\u043d\u043e \u043f\u0440\u043e\u0441\u0447\u0438\u0442\u044b\u0432\u0430\u0435\u0442 \u043a\u0430\u043a \u044d\u0442\u043e \u0441\u0434\u0435\u043b\u0430\u0442\u044c\" => \"\u0438 \u043f\u0440\u043e\u0441\u0447\u0438\u0442\u044b\u0432\u0430\u0435\u0442 \u043a\u0430\u043a \u0435\u0433\u043e \u0438\u0437\u043c\u0435\u043d\u0438\u0442\u044c \u043d\u0430\u0438\u0431\u043e\u043b\u0435\u0435 \u044d\u0444\u0444\u0435\u043a\u0442\u0438\u0432\u043d\u043e\"\n. \u0412\u043c\u0435\u0441\u0442\u043e\n\u041c\u043e\u0436\u043d\u043e \u0441\u0447\u0438\u0442\u0430\u0442\u044c props \u043d\u0435\u0438\u0437\u043c\u0435\u043d\u044f\u0435\u043c\u044b\u043c\u0438 \u0432\u043d\u0443\u0442\u0440\u0438 \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u0430, \u043d\u043e \u043d\u0438\u043a\u043e\u0433\u0434\u0430 \u0441\u0430\u043c\u0438 \u043d\u0435 \u043c\u0435\u043d\u044f\u0439\u0442\u0435 \u0438\u0445 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u044f.\n\n\u041b\u0443\u0447\u0448\u0435\n\n\u0421\u0447\u0438\u0442\u0430\u0439\u0442\u0435, \u0447\u0442\u043e \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442 props \u0442\u043e\u043b\u044c\u043a\u043e \u0434\u043b\u044f \u0447\u0442\u0435\u043d\u0438\u044f. \u041d\u0438\u043a\u043e\u0433\u0434\u0430 \u043d\u0435 \u043f\u0435\u0440\u0435\u0437\u0430\u043f\u0438\u0441\u044b\u0432\u0430\u0439\u0442\u0435 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u044f this.props \u0432\u043d\u0443\u0442\u0440\u0438 \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u0430.\n. \u041f\u0440\u043e\u043f\u0443\u0449\u0435\u043d\u043e \u0442\u0438\u0440\u0435 \u0432 \u043f\u0435\u0440\u0432\u043e\u043c \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u0438\n. \"React \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b\" -> \"React-\u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b\" \u0438\u043b\u0438 \"\u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b React\"\n. \u0434\u0435\u0444\u0438\u0441 \u043f\u0435\u0440\u0435\u0434 \"\u043e\u043d\u0438\" \u043d\u0430 \u0437\u0430\u043f\u044f\u0442\u0443\u044e \u043d\u0430\u0434\u043e \u0431\u044b \u043f\u043e\u043c\u0435\u043d\u044f\u0442\u044c\n. \u0421\u0438\u043d\u0442\u0430\u043a\u0441\u0438\u0441 JSX\n. \"\u0438 \u0434\u0438\u0437\u0430\u0439\u043d\u0435\u0440\u043e\u0432\" \u2014 \u043f\u0440\u043e\u043f\u0443\u0449\u0435\u043d\u0430 \u0437\u0430\u043f\u044f\u0442\u0430\u044f \u043f\u0435\u0440\u0435\u0434\n. \"\u041d\u043e \u0443 \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u0441\u0432\u043e\u0438 \u043f\u0440\u0438\u0432\u044b\u0447\u043a\u0438 \u0432 \u0440\u0430\u0431\u043e\u0442\u0435\" -> \"\u041d\u043e \u0443 \u0440\u0430\u0437\u043d\u044b\u0445 \u043b\u044e\u0434\u0435\u0439 \u0440\u0430\u0437\u043d\u044b\u0435 \u043f\u0440\u0435\u0434\u043f\u043e\u0447\u0442\u0435\u043d\u0438\u044f\"\n.  \"\u043e\u0447\u0435\u043d\u044c \u043c\u0430\u043b\" -> \"\u043e\u0447\u0435\u043d\u044c \u043f\u0440\u043e\u0441\u0442\"\n\"\u043f\u043e\u0441\u043c\u043e\u0442\u0440\u0438\u0442\u0435 \u043d\u0430 JSX \u0432 \u0434\u0435\u0442\u0435\u043b\u044f\u0445\" -> \"\u043f\u043e\u0447\u0438\u0442\u0430\u0439\u0442\u0435 \u043f\u043e\u0434\u0440\u043e\u0431\u043d\u043e \u043f\u0440\u043e JSX \"\n\"\u043c\u043e\u0436\u0435\u0442\u0435 \u0438\u0441\u043f\u044b\u0442\u0430\u0442\u044c \u0435\u0433\u043e \u0447\u0435\u0440\u0435\u0437\" -> \"\u043c\u043e\u0436\u0435\u0442\u0435 \u043f\u043e\u043f\u0440\u043e\u0431\u043e\u0432\u0430\u0442\u044c \u0435\u0433\u043e \u0432\"\n. \"\u043d\u043e \u043d\u0435 \u043f\u043e\u0432\u0442\u043e\u0440\u044f\u0435\u0442 \u0435\u0433\u043e\" -> \"\u043d\u043e \u0438\u043c\u0435\u0435\u0442 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0435\u043d\u043d\u044b\u0435 \u043e\u0442\u043b\u0438\u0447\u0438\u044f\"\n\"\u041f\u043e\u0441\u043c\u043e\u0442\u0440\u0438\u0442\u0435\" -> \"\u041f\u043e\u0447\u0438\u0442\u0430\u0439\u0442\u0435 \u043f\u0440\u043e\"\n\u043f\u0435\u0440\u0435\u0434 \"\u0447\u0442\u043e\u0431\u044b\" \u0437\u0430\u043f\u044f\u0442\u0430\u044f \u0434\u043e\u043b\u0436\u043d\u0430 \u0431\u044b\u0442\u044c\n. \u0432\u044b\u0431\u0435\u0440\u0418\u0442\u0435\n. \u0425\u043e\u0442\u0435\u043b\u043e\u0441\u044c \u0431\u044b \u0438\u0437\u0431\u0430\u0432\u0438\u0442\u044c\u0441\u044f \u043e\u0442 \u0434\u0432\u0443\u0445 \"\u043e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u0435\u043d\" \u0432 \u043e\u0434\u043d\u043e\u043c \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u0438, \u043e\u0441\u043e\u0431\u0435\u043d\u043d\u043e \u0435\u0441\u043b\u0438 \u0443\u0447\u0435\u0441\u0442\u044c \u0447\u0442\u043e \u043c\u044b \u0443\u0436\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u043c \u0440\u0443\u0441\u0441\u043a\u043e\u0435 \"\u043d\u0435\u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e\" \u0432 \u043d\u0435\u043c \u0436\u0435\n. \u0422\u0443\u0442 \u0442\u043e\u0447\u043a\u0430 \u0432 \u043a\u043e\u043d\u0446\u0435 \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u044f \u043f\u043e\u0442\u0435\u0440\u044f\u043b\u0430\u0441\u044c.\n. \u0442\u0430\u043a\u0436\u0435 -> \u0442\u0430\u043a \u0436\u0435\n. \u041c\u043e\u0436\u0435\u0442 \u0431\u044b\u0442\u044c, \u0441\u0442\u043e\u0438\u0442 \u043d\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u0438\u0445 \u043f\u0440\u043e\u0441\u0442\u043e \"\u0441\u0438\u043d\u0442\u0435\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0435 \u0441\u043e\u0431\u044b\u0442\u0438\u044f\"?\n. > \u0414\u0435\u0439\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e, React \u0443\u043c\u0435\u0435\u0442 \u0440\u0430\u0431\u043e\u0442\u0430\u0442\u044c \u0441 \u0441\u043e\u0431\u044b\u0442\u0438\u044f\u043c\u0438 \u043f\u0440\u0438 \u0438\u0445 \u0432\u0441\u043f\u043b\u044b\u0442\u0438\u0438 \u0438 \u043f\u0435\u0440\u0435\u0445\u0432\u0430\u0442\u0435. \u0418 \u0432\u0441\u0435 \u0441\u043e\u0431\u044b\u0442\u0438\u044f, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u043f\u043e\u043f\u0430\u0434\u0443\u0442 \u0432 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a \u0431\u0443\u0434\u0443\u0442 \u0432\u0435\u0441\u0442\u0438 \u0441\u0435\u0431\u044f \u0432 \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0438\u0438 \u0441\u043e \u0441\u043f\u0435\u0446\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438\u0435\u0439 W3C, \u043f\u0440\u0438 \u044d\u0442\u043e\u043c \u043d\u0435\u0432\u0430\u0436\u043d\u043e \u043a\u0430\u043a\u0438\u043c \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u043e\u043c \u0432\u044b \u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0435\u0441\u044c.\n\n\u042f \u0431\u044b \u043f\u043e\u043c\u0435\u043d\u044f\u043b \u043d\u0430:\n\n\u0414\u0440\u0443\u0433\u0438\u043c\u0438 \u0441\u043b\u043e\u0432\u0430\u043c\u0438, React \u0437\u043d\u0430\u0435\u0442, \u043a\u0430\u043a \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442 \u0432\u0441\u043f\u043b\u044b\u0442\u0438\u0435 \u0438 \u043f\u0435\u0440\u0435\u0445\u0432\u0430\u0442 \u0441\u043e\u0431\u044b\u0442\u0438\u0439 \u043f\u043e \u0441\u043f\u0435\u0446\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438. \u0421\u043e\u0431\u044b\u0442\u0438\u044f, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u043e\u043d \u043f\u0435\u0440\u0435\u0434\u0430\u0435\u0442 \u0432 \u0432\u0430\u0448\u0438 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a\u0438, \u0431\u0443\u0434\u0443\u0442 \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u043e\u0432\u0430\u0442\u044c \u0441\u043f\u0435\u0446\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438 W3C, \u043d\u0435 \u0432\u0430\u0436\u043d\u043e \u043a\u0430\u043a\u0438\u043c \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u043e\u043c \u0432\u044b \u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0435\u0441\u044c.\n. typo: \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0435\u0435\n. \u0444\u0443\u043d\u043a\u0446\u0438\u0438-\u043a\u043e\u043b\u0431\u044d\u043a\u0438 => \u0444\u0443\u043d\u043a\u0446\u0438\u0438 \u043e\u0431\u0440\u0430\u0442\u043d\u043e\u0433\u043e \u0432\u044b\u0437\u043e\u0432\u0430\n. \"\u0442\u0430\u043a \u0447\u0442\u043e\u0431\u044b\" => \"\u0447\u0442\u043e\u0431\u044b\"\n. typo: \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u0442\n. \"\u043a\u043e\u043c\u0443 \u0438\u0437 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a\u043e\u0432\" => \"\u043a\u0430\u043a\u043e\u043c\u0443 \u0438\u0437 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a\u043e\u0432\"\n. \u042f \u0431\u044b \u043f\u043e\u043c\u0435\u043d\u044f\u043b \u043d\u0430\n\u041a\u043e\u0433\u0434\u0430 \u0432 \u043f\u0430\u043c\u044f\u0442\u0438 \u0431\u043e\u043b\u044c\u0448\u0435 \u043d\u0435 \u043e\u0441\u0442\u0430\u0435\u0442\u0441\u044f \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a\u043e\u0432, \u043e\u043d\u0438 \u043f\u0435\u0440\u0435\u0441\u0442\u0430\u044e\u0442 \u0440\u0430\u0431\u043e\u0442\u0430\u0442\u044c.\n\n=>\n\n\u041a\u043e\u0433\u0434\u0430 \u0432 \u043f\u0430\u043c\u044f\u0442\u0438 \u0431\u043e\u043b\u044c\u0448\u0435 \u043d\u0435 \u043e\u0441\u0442\u0430\u0435\u0442\u0441\u044f \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a\u043e\u0432, React \u043f\u0435\u0440\u0435\u0441\u0442\u0430\u0435\u0442 \u043e\u0431\u0440\u0430\u0431\u0430\u0442\u044b\u0432\u0430\u0442\u044c \u0441\u043e\u0431\u044b\u0442\u0438\u044f.\n. \u041f\u043e\u0441\u043b\u0435 \u044d\u0442\u043e\u0433\u043e <- \u0437\u0430\u043f\u044f\u0442\u0430\u044f \u043d\u0435 \u043d\u0443\u0436\u043d\u0430\n. > \u0422\u0435\u043c \u0441\u0430\u043c\u044b\u043c, \u0441\u043d\u0438\u0436\u0430\u0442\u044c\n\n=>\n\n\u0422\u0435\u043c \u0441\u0430\u043c\u044b\u043c, \u0432\u044b \u0441\u043d\u0438\u0437\u0438\u0442\u0435\n. > \u0412 \u0440\u0435\u0430\u043b\u044c\u043d\u044b\u0445 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f\u0445 \u0442\u0430\u043a\u0438\u0435 \u0434\u0430\u043d\u043d\u044b\u0435 \u043a\u0440\u0430\u0439\u043d\u0435 \u043c\u0430\u043b\u044b \u0438 \u043f\u0435\u0440\u0435\u0434\u0430\u044e\u0442\u0441\u044f, \u043e\u0431\u044b\u0447\u043d\u043e, \u0447\u0435\u0440\u0435\u0437 JSON-\u0444\u0430\u0439\u043b\u044b.\n\n\u042f \u0434\u0443\u043c\u0430\u044e \u0438\u043c\u0435\u0435\u0442\u0441\u044f \u0432 \u0432\u0438\u0434\u0443 \u0434\u0440\u0443\u0433\u043e\u0435:\n\n\u0412 \u0440\u0435\u0430\u043b\u044c\u043d\u044b\u0445 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f\u0445 \u0442\u0430\u043a\u0438\u0435 \u0434\u0430\u043d\u043d\u044b\u0435, \u043a\u0430\u043a \u043f\u0440\u0430\u0432\u0438\u043b\u043e, \u043d\u0435\u0437\u043d\u0430\u0447\u0438\u0442\u0435\u043b\u044c\u043d\u044b \u043f\u043e \u043e\u0431\u044a\u0435\u043c\u0443, \u0438 \u043c\u043e\u0433\u0443\u0442 \u0431\u044b\u0442\u044c \u0441\u0435\u0440\u0438\u0430\u043b\u0438\u0437\u043e\u0432\u0430\u043d\u044b \u0432 JSON.\n. > \u0447\u0442\u043e \u043d\u0430\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0439 \u0442\u0430\u043a\u0438\u043c \u0441\u043f\u043e\u0441\u043e\u0431\u043e\u043c \u043f\u043e\u0437\u0432\u043e\u043b\u044f\u0435\u0442 \u0441\u043e\u0437\u0434\u0430\u0432\u0430\u0442\u044c\n\n=>\n\n\u0447\u0442\u043e \u044d\u0442\u043e\u0442 \u0441\u043f\u043e\u0441\u043e\u0431 \u043f\u043e\u0437\u0432\u043e\u043b\u044f\u0435\u0442 \u0441\u043e\u0437\u0434\u0430\u0432\u0430\u0442\u044c\n. \u043b\u043e\u0436\u0438\u0442\u044c \u0442\u0443\u0434\u0430 => \u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0432 \u043d\u0435\u043c\n. > \u0412\u0430\u043c \u043d\u0435 \u043d\u0430\u0434\u043e \u0434\u0443\u043c\u0430\u0442\u044c \u043e \u0442\u0435\u0445 \u0434\u0430\u043d\u043d\u044b\u0445, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u043d\u0430\u0434\u043e \u0432\u044b\u0447\u0438\u0441\u043b\u044f\u0442\u044c \u0447\u0435\u0440\u0435\u0437 \u0434\u0430\u043d\u043d\u044b\u0435 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u044f \u2014 \u043b\u0443\u0447\u0448\u0435 \u043f\u043e\u0437\u0430\u0431\u043e\u0442\u044c\u0442\u0435\u0441\u044c \u043e\u0431 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0435, \u0430 \u0432\u0441\u0435 \u0432\u044b\u0447\u0438\u0441\u043b\u0435\u043d\u0438\u044f \u0434\u0435\u043b\u0430\u0439\u0442\u0435 \u0432 \u043c\u0435\u0442\u043e\u0434\u0435 render().\n\n=>\n\n\u041d\u0435 \u0432\u043e\u043b\u043d\u0443\u0439\u0442\u0435\u0441\u044c \u043e \u0434\u0430\u043d\u043d\u044b\u0445, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u043c\u043e\u0436\u043d\u043e \u0432\u044b\u0447\u0438\u0441\u043b\u0438\u0442\u044c \u0438\u0437 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u044f. \u0421\u043e\u0433\u043b\u0430\u0441\u043e\u0432\u0430\u043d\u043d\u043e\u0441\u0442\u044c \u0434\u0430\u043d\u043d\u044b\u0445 \u043f\u0440\u043e\u0449\u0435 \u043e\u0431\u0435\u0441\u043f\u0435\u0447\u0438\u0442\u044c, \u0435\u0441\u043b\u0438 \u043f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u044c \u0432\u0441\u0435 \u0432\u044b\u0447\u0438\u0441\u043b\u0435\u043d\u0438\u044f \u0432 \u043c\u0435\u0442\u043e\u0434\u0435 render().\n. > \u041d\u0430\u043f\u0440\u0438\u043c\u0435\u0440, \u0435\u0441\u043b\u0438 \u0432 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0438 \u0445\u0440\u0430\u043d\u0438\u0442\u0441\u044f \u0441\u043f\u0438\u0441\u043e\u043a \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432 \u0438 \u0432\u0430\u043c \u043d\u0430\u0434\u043e \u0432\u044b\u0432\u0435\u0441\u0442\u0438 \u0435\u0433\u043e \u0440\u0430\u0437\u043c\u0435\u0440 \u0432 \u0432\u0438\u0434\u0435 \u0441\u0442\u0440\u043e\u043a\u0438. \u041d\u0430\u043f\u0438\u0448\u0438\u0442\u0435 this.state.listItems.length + ' \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432' \u0432 \u043c\u0435\u0442\u043e\u0434\u0435 render(). \u042d\u0442\u043e \u0431\u0443\u0434\u0435\u0442 \u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u0435\u0435, \u0447\u0435\u043c \u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0440\u0430\u0437\u043c\u0435\u0440 \u0441\u043f\u0438\u0441\u043a\u0430 \u0432 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0438.\n\n=>\n\n\u041d\u0430\u043f\u0440\u0438\u043c\u0435\u0440, \u0435\u0441\u043b\u0438 \u0432 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0438 \u0445\u0440\u0430\u043d\u0438\u0442\u0441\u044f \u0441\u043f\u0438\u0441\u043e\u043a \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432, \u0438 \u0432\u0430\u043c \u043d\u0430\u0434\u043e \u0432\u044b\u0432\u0435\u0441\u0442\u0438 \u0435\u0433\u043e \u0440\u0430\u0437\u043c\u0435\u0440 \u0432 \u0432\u0438\u0434\u0435 \u0441\u0442\u0440\u043e\u043a\u0438,  \u043d\u0430\u043f\u0438\u0448\u0438\u0442\u0435 this.state.listItems.length + ' \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432' \u0432 \u043c\u0435\u0442\u043e\u0434\u0435 render(). \u042d\u0442\u043e \u0431\u0443\u0434\u0435\u0442 \u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u0435\u0435, \u0447\u0435\u043c \u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0440\u0430\u0437\u043c\u0435\u0440 \u0441\u043f\u0438\u0441\u043a\u0430 \u0432 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0438.\n. \u041f\u0440\u043e\u043f\u0443\u0449\u0435\u043d\u0430 \u0437\u0430\u043f\u044f\u0442\u0430\u044f \u043f\u0435\u0440\u0435\u0434 \"\u043e\u043f\u0438\u0440\u0430\u044f\u0441\u044c\". \u0415\u0449\u0435 \u043d\u0430\u0432\u0435\u0440\u043d\u043e\u0435 this. \u0442\u0443\u0442 \u043d\u0435 \u043d\u0430\u0434\u043e \u2014 \u043f\u0440\u043e\u0441\u0442\u043e props \u0438 state.\n. > \u0441\u0442\u0430\u0440\u0430\u0439\u0442\u0435\u0441\u044c \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c props \u0442\u043e\u043b\u044c\u043a\u043e \u043a\u0430\u043a \u0438\u0441\u0442\u043e\u0447\u043d\u0438\u043a \u0434\u0430\u043d\u043d\u044b\u0445 \u0434\u043b\u044f \u043e\u0442\u0440\u0438\u0441\u043e\u0432\u043a\u0438\n\n=>\n\n\u0421\u0442\u0430\u0440\u0430\u0439\u0442\u0435\u0441\u044c \u043f\u043e \u043c\u0435\u0440\u0435 \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e\u0441\u0442\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c props \u043a\u0430\u043a \u0435\u0434\u0438\u043d\u0441\u0442\u0432\u0435\u043d\u043d\u044b\u0439 \u0438\u0441\u0442\u043e\u0447\u043d\u0438\u043a \u0434\u0430\u043d\u043d\u044b\u0445.\n. typo: \u0434\u043e\u043f\u0443\u0441\u043a\u0430\u0435\u0442\u0441\u044f\n. > \u0410 \u0441 \u043f\u043e\u043c\u043e\u0449\u044c\u044e \u043c\u0435\u0445\u0430\u043d\u0438\u0437\u043c\u0430 \u0441\u0438\u043d\u0442\u0435\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0445 \u0441\u043e\u0431\u044b\u0442\u0438\u0439, React \u0433\u0430\u0440\u0430\u043d\u0442\u0438\u0440\u0443\u0435\u0442\n\n=>\n\n\u0411\u043b\u0430\u0433\u043e\u0434\u0430\u0440\u044f \u043c\u0435\u0445\u0430\u043d\u0438\u0437\u043c\u0443 \u0441\u0438\u043d\u0442\u0435\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0445 \u0441\u043e\u0431\u044b\u0442\u0438\u0439 React \u0433\u0430\u0440\u0430\u043d\u0442\u0438\u0440\u0443\u0435\u0442\n. > , \u0438 \u043d\u0435\u0432\u0430\u0436\u043d\u043e \u043a\u0430\u043a\u0438\u043c \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u043e\u043c \u0432\u044b \u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0435\u0441\u044c.\n\n\u043b\u0443\u0447\u0448\u0435 \u0431\u0443\u0434\u0435\u0442\n\n, \u043d\u0435\u0441\u043c\u043e\u0442\u0440\u044f \u043d\u0430 \u0442\u043e, \u043a\u0430\u043a\u0438\u043c \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u043e\u043c \u0432\u044b \u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0435\u0441\u044c.\n. \"\u0427\u0442\u043e \u0432\u043d\u0443\u0442\u0440\u0438:\" => \"\u041a\u0430\u043a \u044d\u0442\u043e \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442:\"\n. \u043f\u043e\u0441\u043c\u043e\u0442\u0440\u0438\u0442\u0435 => \u043f\u043e\u0447\u0438\u0442\u0430\u0439\u0442\u0435\n. \"\u041a\u043e\u0433\u0434\u0430 \u0441\u043e\u0437\u0434\u0430\u0435\u0442\u0435\" => \"\u041a\u043e\u0433\u0434\u0430 \u0432\u044b \u0441\u043e\u0437\u0434\u0430\u0435\u0442\u0435\"\n. \u041d\u0443\u0436\u043d\u0430 \u0437\u0430\u043f\u044f\u0442\u0430\u044f \u043f\u0435\u0440\u0435\u0434 \"\u0438 \u0432\u0430\u043c \u043d\u0430\u0434\u043e \u0432\u044b\u0432\u0435\u0441\u0442\u0438\"\n. \u0414\u0430\u0432\u0430\u0439\u0442\u0435 \u043f\u043e\u043f\u0440\u043e\u0431\u0443\u0435\u043c \"\u0441\u043e\u0433\u043b\u0430\u0441\u043e\u0432\u0430\u043d\u0438\u0435\", \u044d\u0442\u043e \u0431\u0443\u0434\u0435\u0442 \u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u0435\u0435\n. Isn\u2019t leaking arguments bad in general?\nhttps://github.com/petkaantonov/bluebird/wiki/Optimization-killers#32-leaking-arguments\n. Minor nit: missing space before (\n. The stub instances used to be plain {} which doesn\u2019t have debugID so it turned out to be undefined. I err on the side of specifying them where necessary rather than omitting them for convenience, so that we can have stronger warnings in ReactDebugTool.\n. Oh, it should\u2019ve been 1.\n. Ha, I should\u2019ve realized this before I wrote hundreds of tests using this pattern \ud83d\ude04 .\n. Not a big fan of these but I\u2019m not sure how else we can test the expected tree during server rendering, if ReactDebugTool cleans it up right before the batch. Alternatively we can make those integration tests instead in ReactPerf-test, but I like how comprehensive the suite for ReactComponentDebugTool is, so I don\u2019t want to replicate the same complexity in ReactPerf-test.\n. I\u2019d keep it this way for now. I\u2019m not sure about this reliance on flush events anyway (https://github.com/facebook/react/pull/6046#discussion_r61482538), so I\u2019d rather avoid relying on the order in which devtools are called for now.\n. It would be better to test this by running start() and stop().\n. Are we going to expose just one of them in the end?\n. Is it worth adding getFormattedSource() to ReactComponentTreeDevtool for convenience?\n. While we\u2019re at it, we might as well store the element itself because React DevTools will want to know it.\n. We should do this in ReactDOMDebugTool too for symmetry. You can extract it if you\u2019d like.\n. Yeah, I agree it\u2019s useful. Would you like to do it as a separate PR?\n. > maybe it makes more sense to only expose each platform-specific one\n\nLet\u2019s go with this assumption for now. In this case it makes sense to automatically setup forwarding.\n. Yes, but AFAIK we plan to kill that code and make React DevTools use this tool instead. (Or implement a similar one using the same events.) For older versions of React, we will add a shim to React DevTools that emits these events so that its core code does not rely on traversing the tree. This way it would become compatible with incremental reconciler.\n. Note: this method was renamed in #6754 which causes tests to fail now.\n. Can we add an invariant for the cases where we their parentId is not missing? It being missing is just a subset of cases, is it not? I mean something like invariant(nextChild.parentID == null || nextChild.parentID === id)\n. Starting the timer later so time spent in the devtools isn't counted.\n. Note: passing nextElement here instead of the current element\n. This was super frustrating.\n. I'll take another look at it tomorrow. \n. Let\u2019s make the warning more descriptive, similar in style to the other warnings being tested in this file?\n. > Is it okay to not call ReactInstrumentation.debugTool.onSetState() in that scenario?\nYea, I think it\u2019s fine.\n. Should be \u201cJavaScript\u201d (both capitalized)\n. I\u2019d change this to // We can define a lifecycle method\n\u201cOverride\u201d gives a wrong connotation that it\u2019s defined in the base class and you must call super, which is not true.\n. Maybe \u201cand returns a React element\u201d?\n. \u201cthey can also be optimized\u201d\u2014let\u2019s avoid setting the wrong expectation, people have been bitten by something like this where we say they will eventually get faster in theory, and people take it as if something like PureRenderMixin gets applied to them automatically, which is far from truth.\n. Missing period\n. I think it would be valuable to use the opportunity to also display how state and event handlers work here.\n. Shall we pass props always for consistency?\n. We should not be using experimental syntax such as class properties in the documentation. In general I don\u2019t think it\u2019s necessary to ES6-ify a createClass example.\n. Not super happy about this. If it\u2019s too brittle, I can probably do something nasty like call ReactDOM.render() 100 times and assert that the lifecycle own time is smaller than the inner element\u2019s render time.\n. I think we should stick with the current version of JavaScript. So no property initalizers.\n. Is it silly to worry about extra allocations here?\n. I\u2019ll probably do this, but as a separate PR.\n. Yea.\n. I have no idea \ud83d\ude04 . They were there and spread like fire. I wouldn\u2019t be surprised if the first freeze was added for a completely unrelated purpose. (Maybe from the pre-element times?)\n. Let\u2019s call it warnInProduction.\n. Let\u2019s just make it return nothing, and explicitly return in the methods.\n. So, it turns out we can\u2019t use warning here because it gets stripped in production \ud83d\ude02 .\nLet\u2019s do this instead:\njs\nif (typeof console !== 'undefined') {\n  console.error(...);\n}\n. Let\u2019s replace these with explicit blocks:\njs\nif (!__DEV__) {\n  warnInProduction();\n  return [];\n}\n. This line looks like shouldn\u2019t be here.\n. Oh, I see your point now. I propose we always warn just once. You can potentially leave start() and stop() in some hot spot and we don\u2019t want to spam the logs.\n. No, I mean we call it everywhere because we don\u2019t know which method gets called first, but I want the warning to only appear once, so let\u2019s not reset the boolean variable ever.\n. Nitpick: let\u2019s start string literal from the next line.\njs\nconsole.error(\n  'ga ga ' +\n  'o la la'\n);\n. No need to return an empty string\u2014we can just return; here.\n. Same here and in any print* method below.\n. Nit: please push ) over to the next line.\n. Nit pick: let's have two ifs, one to exit early if already warned, and another right around the if. This way it's clearer which is guarding what. \n. We should set this flag outside this if. Otherwise we check console every time.\n. Typo: becuase\nNit: let\u2019s capitalize Firefox :-)\n. We generally wrap long arg lists like this, can you tweak it?\n. Maybe isParentPure? I didn\u2019t realize it\u2019s a boolean until this far.\n. Let\u2019s remove the blank lines here, they don\u2019t help much.\n. Similarly, could call this isSelfPure for clarity.\n. Nit: since it's the main copy on the page, maybe worth using em dash.\n. I'm not an expert on this. I thought en dashes are mostly reserved for number ranges:\nhttp://english.stackexchange.com/a/2126\nhttp://www.thepunctuationguide.com/en-dash.html\nhttp://www.chicagomanualofstyle.org/qanda/data/faq/topics/HyphensEnDashesEmDashes/faq0002.html\nI haven't found a result recommending en dash to be used to delimit a sentence yet. On the contrary, all the manuals I found so far recommend em dash for this.\nThe only difference is they mostly recommend using em dash without spaces. I agree this looks a bit pretentious on the web, and this seems to confirm it's fine to surround em with spaces:\n\nMost newspapers \u2014 and all that follow AP style \u2014 insert a space before and after the em dash.\n\nWhere can I read about using en dash instead of em in this context? Maybe this is some newer usage I'm not familiar with?\n. I tried to remove \u201cpainless\u201d, \u201cjust\u201d, \u201ceasily\u201d because these are somewhat subjective.\n. I felt \u201cWith React, ...\u201d sounds a bit awkward although this may be because I\u2019m not a native speaker.\n. \u201cReturn the views\u201d sounded a little confusing because most people who know what \u201cviews\u201d are come from traditional MVC paradigm where you don\u2019t return them. So I tried to go for an alternative explanation instead.\n. Let\u2019s remove changes to this one file. Since we already have a header in the React module entry point, this causes license header to be outputted twice in the UMD build.\n. It wouldn\u2019t be super nice if every react addon added one, would it?\n. I\u2019d say let\u2019s leave this as is. This code changes super fast right now and it\u2019s not used by real React itself anyway yet. It\u2019ll be cleaned up before it\u2019s actually used. For now, not worth introducing potential merge conflicts or polluting the history.\n. We use an array for this in mountChildren so I can change it here too if necessary.\n. Note: I verified this fails on master (5 tests failing).\n. instanceof won\u2019t work correctly with nodes from an iframe because it has its own window and thus its own window.HTMLInputElement.\nhttp://stackoverflow.com/questions/26248599/instanceof-htmlelement-in-iframe-is-not-element-or-object\n. Having many tests like this seems unnecessary to me. If we extract getComponentName into a function, we can get away with one test here and a bunch of tests for specific cases in getComponentName-test. The indirection with testKeyAccess seems over-abstracted and unnecessary to me. Can we make this file simple again?\n. Let\u2019s structure it like this:\n- describe('getComponentName')\n  - describe('stateless functional component')\n    - it('should prefer displayName')\n    - it('should use name when there is no displayName')\n    - it('should fall back to ReactComponent')\n  - describe('ES class')\n    - it('should prefer displayName')\n    - it('should use name when there is no displayName')\n    - it('should fall back to ReactComponent')\n  - describe('createClass')\n    - it('should prefer displayName')\n    - it('should fall back to ReactComponent')\nor something similar.\n. onCreateChainableTypeChecker doesn\u2019t seem like a good event name here to me. \u201cCreating\u201d type checker happens above this function. When this function runs, we are checking prop types, not creating a prop type checker. (checkType lives inside of createChainableTypeChecker).\n. Please don\u2019t use for of syntax as it relies on ES6 Symbol being available, and we don\u2019t polyfill it.\n. This helper is a little bit confusing because it pretends to be similar to typeCheckPass and typeCheckFail but has a completely different purpose and signature. Let\u2019s just write this code explicitly inline in the corresponding test cases. Additionally, we can remove typeCheckFail calls from them because I think we only want the warning to appear once.\n. We\u2019d also need to change 03-interactivity-and-dynamic-uis.ru-RU.md to point to this page as its next.\n. \u043c\u044b \u0440\u0430\u0441\u0441\u043c\u043e\u0442\u0440\u0435\u043b\u0438 <...> \u0438 \u043e\u0442\u0434\u0435\u043b\u044c\u043d\u043e \u0440\u0430\u0441\u0441\u043c\u043e\u0442\u0440\u0435\u043b\u0438 \u2014 \u043d\u0430\u0434\u043e \u0443\u043f\u0440\u043e\u0441\u0442\u0438\u0442\u044c :-)\n. \u043a\u0430\u043a \u043c\u043e\u0436\u043d\u043e \u0441\u043e\u0431\u0438\u0440\u0430\u0442\u044c -> \u043a\u0430\u043a \u0441\u043e\u0431\u0440\u0430\u0442\u044c\n. \u0413\u043b\u0430\u0432\u043d\u0430\u044f \u043f\u0440\u0438\u0447\u0438\u043d\u0430 -> \u0426\u0435\u043b\u044c\n. \"\u0421\u043e\u0437\u0434\u0430\u0432\u0430\u044f \u0432\u0441\u0451 \u0431\u043e\u043b\u044c\u0448\u0435\" \u2014 \u0442\u0430\u043a\u043e\u0433\u043e \u043d\u0435\u0442 \u0432 \u043e\u0440\u0438\u0433\u0438\u043d\u0430\u043b\u044c\u043d\u043e\u043c \u0442\u0435\u043a\u0441\u0442\u0435. \"components that reuse other components with well-defined interfaces\" \u043f\u043e\u0442\u0435\u0440\u044f\u043b\u043e\u0441\u044c \u2014 \u0442\u0430\u043a\u043e\u0433\u043e \u043d\u0435\u0442 \u0432 \u043f\u0435\u0440\u0435\u0432\u043e\u0434\u0435.\n. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u0440\u043e\u0447\u0438\u0442\u0430\u0442\u044c \u044d\u0442\u043e\u0442 \u043f\u0430\u0440\u0430\u0433\u0440\u0430\u0444 \u043d\u0430 \u0440\u0443\u0441\u0441\u043a\u043e\u043c, \u043d\u0435 \u043f\u043e\u0434\u0433\u043b\u044f\u0434\u044b\u0432\u0430\u044f \u0432 \u0430\u043d\u0433\u043b\u0438\u0439\u0441\u043a\u0438\u0439. \u041e\u043d \u0441\u043e\u0432\u0435\u0440\u0448\u0435\u043d\u043d\u043e \u043d\u0435\u043f\u043e\u043d\u044f\u0442\u0435\u043d. \u041d\u0443\u0436\u043d\u043e \u0435\u0433\u043e \u043f\u043e\u043b\u043d\u043e\u0441\u0442\u044c\u044e \u043f\u0435\u0440\u0435\u043f\u0438\u0441\u0430\u0442\u044c. \"\u0421\u043e\u0437\u0434\u0430\u0432\u0430\u044f \u0432 \u0441\u0432\u043e\u0435\u043c \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0438 \u0442\u0430\u043a\u0443\u044e \u0431\u0438\u0431\u043b\u0438\u043e\u0442\u0435\u043a\u0443 \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u043e\u0432, \u0432\u044b \u0442\u0435\u043c \u0441\u0430\u043c\u044b\u043c \u0441\u043e\u0437\u0434\u0430\u0435\u0442\u0435 \u0441\u0432\u043e\u0438 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u044b \u0442\u0435\u043c \u0441\u043f\u043e\u0441\u043e\u0431\u043e\u043c, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u0432\u0430\u043c \u0431\u043e\u043b\u044c\u0448\u0435 \u043f\u043e\u0434\u0445\u043e\u0434\u0438\u0442\" \u0432 \u043f\u0440\u0438\u043d\u0446\u0438\u043f\u0435 \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u0437\u043d\u0430\u0447\u0438\u0442.\n. Composition = \u043a\u043e\u043c\u043f\u043e\u0437\u0438\u0446\u0438\u044f, \u043d\u0435 \"\u043f\u043e\u0441\u043b\u043e\u0436\u043d\u0435\u0435\"\n. Instance = \u044d\u043a\u0437\u0435\u043c\u043f\u043b\u044f\u0440, \u043d\u0435 \"\u043e\u0431\u044a\u0435\u043a\u0442\"\n. \u041d\u0430\u0432\u0435\u0440\u043d\u043e\u0435 \u043b\u0443\u0447\u0448\u0435 \u0431\u0443\u0434\u0435\u0442 \"\u043f\u0440\u0438\u043d\u0430\u0434\u043b\u0435\u0436\u043d\u043e\u0441\u0442\u044c\".\n. \"\u0411\u043e\u043b\u0435\u0435 \u0444\u043e\u0440\u043c\u0430\u043b\u044c\u043d\u043e \u044d\u0442\u043e \u0437\u0432\u0443\u0447\u0438\u0442 \u0442\u0430\u043a, \u0435\u0441\u043b\u0438 ... \u0442\u043e \u0433\u043e\u0432\u043e\u0440\u044f\u0442 ...\" \u2014 \u0442\u0430\u043a \u043d\u0435 \u043f\u0438\u0448\u0443\u0442. \u0414\u043e\u0441\u0442\u0430\u0442\u043e\u0447\u043d\u043e \"\u0434\u0440\u0443\u0433\u0438\u043c\u0438 \u0441\u043b\u043e\u0432\u0430\u043c\u0438\". \u041f\u043e\u0441\u0442\u0430\u0440\u0430\u0439\u0442\u0435\u0441\u044c \u043d\u0430\u043f\u0438\u0441\u0430\u0442\u044c \u0442\u0430\u043a, \u0447\u0442\u043e\u0431\u044b \u044d\u0442\u043e \u0447\u0438\u0442\u0430\u043b\u043e\u0441\u044c \u0435\u0441\u0442\u0435\u0441\u0442\u0432\u0435\u043d\u043d\u043e.\n. \u0422\u0443\u0442 \u044f \u043d\u0435 \u0443\u0432\u0435\u0440\u0435\u043d. \u041c\u043e\u0436\u0435\u0442 \"\u0432\u043b\u0430\u0434\u0435\u043d\u0438\u0435\" \u0438 \u043e\u043a. \u041d\u0430\u0434\u043e \u0438\u0441\u043f\u0440\u0430\u0432\u0438\u0442\u044c \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u044f \u043d\u0438\u0436\u0435 \u0438 \u043f\u043e\u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c \u0435\u0449\u0435 \u0440\u0430\u0437.\n. React Hot Loader is experimental tech, it shouldn\u2019t be here. (Additionally 1.x is deprecated.)\n. There should be two separate configs for development and production. It\u2019s a common enough misconception that you can use one config for both, and people blame React for being slow.\nPlease see a sensible Webpack configuration here: https://github.com/MsUzoAgu/ulonkaFrontend01/pull/1/files\n. There is no need to extract this function, let\u2019s inline it into _updateState.\n. Please change the indentation to be like\njs\n      ReactInstrumentation.debugTool.onStateChanged(\n        this._debugID,\n        this._instance.state\n      );\n. It seems like _updateState is not called for the initial state.\n. Could you set a flag on the bound checkType instead? This way if we change its name, this won\u2019t start creating false positives.\n. Mr. Ugly but that\u2019s exactly what we\u2019ve been doing before (see below)\n. Can you please unwind this to be simple (repetitive) code instead? IMO meta programming is not worth it here :-)\n. Do I understand correctly that the intention is to use ReactUpdateQueue during mounting so initial setState works but switch it out right after the mounting is over?\n. This should be a required method\u2014there is no need to check for its existence. It\u2019s bad when similar objects have different shapes because it makes JIT optimizations harder. \n. Wasn't there a couple more places in this file where ReactUpdateQueue is used directly? Shouldn't we take it from transaction in all those places?\n. Tests should be written against the public API. You shouldn't need to override anything just to test it. Test public behavior instead\u2014such as that calling setState, on the contrary, does not throw (or what was the original fiddle doing?)\n. We would also need a test for forceUpdate. \n. It will be more obvious after the unwinding. \n. I still think we don't want this function. It will be empty in production. Let's just inline those calls. \n. Any transactions that might end up here would need this method. IIRC that's just Reconcile and ServerRendering transactions but I might be wrong. \n. This allocates an object any time getUpdateQueue is called. Instead, it should only be initialized once. For example, you could write a class called ReactServerUpdateQueue that would take transaction as a constructor argument.\n. It is not clear from a test what the warning is. Can you please assert the warning messages as well?\n. How about we just write this as ES class? We use Babel now so I don\u2019t see why not just use the class syntax.\n. I agree (if it\u2019s not super difficult). Note that server has no concept of \u201calready mounted component\u201d. I would say \u201cThis usually means you called setState() outside componentWillMount() on the server.\u201d or something like this.\n. Let\u2019s check both error messages explicitly.\n. Oh, I see you\u2019re already checking both. What is the reason for two setState calls? I think we want to check setState, forceUpdate and replaceState separately. I\u2019d probably split this into three tests for clarity instead of nested timeouts.\n. This comment repeats exactly what the line does\u2014let\u2019s remove it.\nOr maybe change to something like \u201cWhen rendering on the server, we want updates to be no-ops after mounting\u201d.\n. Yea, I\u2019m not 100% sure (we don\u2019t seem to use classes yet) but this could be the first one \ud83d\ude09 . I think classes is in babelrc so it should be good. But check compiled output to make sure.\n. Ah, I understand now. It would be more obvious if setState actually changed the state so you could verify the correct thing gets rendered and the second setState gets ignored.\n. This can be a top-level function rather than a method.\n. This would give '' for any ES components and stateless functions, wouldn\u2019t it? You probably want something like publicInstance.constructor.displayName || publicInstance.constructor.name || 'ReactClass'.\n. Do we even want these JSDocs if we\u2019re adding Flow annotations? I don\u2019t know.\n. Presumably publicInstance.constructor check still had some merit\u2014sorry I didn\u2019t include it in my comment.\n{ render: ... } is technically a valid React component so let\u2019s make sure we don\u2019t crash for it.\n. Technically partialState can also be a transactional setState callback here, i.e. a function.\n. Nit: let\u2019s put .toBe( at the end of previous line. Same for all other occurrences.\n. I chatted with @zpao and his feedback is files shouldn\u2019t be partially flow-ified. Otherwise we\u2019ll forget to go back and flowify the rest of their code. New files can have @flow as long as they are 100% flowified.\n. Hmm, I don\u2019t know. That\u2019s what the rest of the codebase does tho.\n. We would still want to return a function for consistency\u2014it would just be a no-op.\n. Let\u2019s also check if (typeof console !== 'undefined')\n. Let\u2019s randomize it a little bit?\n. This looks misleading to me. Why are all these checks supposed to pass? Bad checks should fail, just like they fail today\u2014the only difference is we should warn when doing a check.\n. Doesn\u2019t this test run only in prod mode? Why do we check __DEV__?\n. Let\u2019s keep a cache to avoid spamming the console. I think logging this warning just once should be enough.\n. We already use that name in ReactNoopUpdateQueue so if we change it, should change both for consistency.\n. You can use emptyFunction module for consistency.\n. Let\u2019s use emptyFunction.thatReturnsNull (if I recall correctly)\n. I would just log it once at all. Logging can get expensive in production (depends on the browser).\n. Let\u2019s make an if branch and do different assertions in if and else. This would read simpler IMO.\n. I think it is unnecessary. Our tests are set up in a way that any unexpected warning would fail a test. So if it showed up anywhere, we\u2019d notice thanks to existing DEV mode tests. Let\u2019s make these tests production-only. This simplifies the logic too.\n. I think mentioning the component name and prop might still be useful\u2014you want to have at least a vague idea of where it\u2019s happening.\n. Nit: .toString().\n. Let\u2019s call it expectWarningInProduction.\n. Maybe should not warn for type checks performed by React\n. Let\u2019s also check we don\u2019t emit the unnecessary warning even if the check fails?\n. For consistency with DEV behavior, let\u2019s return emptyFunction.thatReturnsNull here as well. This way we treat bad argument as early DEV warning, and since we can\u2019t really check propTypes, we don\u2019t.\nNot that all these semantics really matter because nobody should be calling prop types in prod but it\u2019s best to have them behave the same way until we explicitly disallow it.\n. Same here. So basically both of these blocks should become\njs\nwarning(...)\nreturn emptyFunction.thatReturnsNull;\n__DEV__ check will be added automatically when you call warning.\n. I\u2019d call it warnNoop.\n. I\u2019m not sure these definitions are right. JSDoc is very vague but Flow is exact. So : ReactClass doesn\u2019t end up being correct: the ReactClass module in this repo is only relevant for React.createClass and has no relationship to ES classes, for example. Whereas this argument could refer to any public instance. Flow has its own idea of ReactClass and I\u2019m not sure it matches either. It\u2019s also generic.\nI would suggest just removing all Flow types from this module. IMO they only cause confusion until we start actually using them in the rest of the wider codebase.\n. Can you change this to spyOn(console, 'error') like the rest of the codebase does?\n. Let\u2019s additionally test that type check passes (since that\u2019s the behavior we have now).\n. Let\u2019s remove this.\n. Let\u2019s type it as ReactComponent<any, any, any>. That\u2019s what we already use in this repo.\n. Same here any everywhere below: should be ReactComponent<any, any, any>.\n. Looks like we can delete this file now and instead add a simple test against unguarded call to the DEV file?\n. I\u2019m a bit concerned about this. We\u2019re not actually testing that React is passing the secret when validating. So if React doesn\u2019t do it in some case, we\u2019ll miss this.\nCan we change these typeCheckFail and typeCheckPass to be more like integration tests? i.e. they would create a class and then make sure that calling createElement produces (or doesn\u2019t produce) the relevant warning. Or am I missing something?\n. > It's hard to miss, the test suite blows up if a warning is logged when it shouldn't be.\nYea, you\u2019re right, I just tried and existing ReactPropTypes-tests catch that.\n. Let\u2019s change this to be\njs\n'You are manually calling a React.PropTypes validation ' +\n'function for the `%s` prop on `%s`. This is deprecated ' +\n'and will not work in the next major version. You may be ' +\n'seeing this warning due to a third-party PropTypes library. ' +\n'See https://fb.me/react-warning-dont-call-proptypes for details.',\n. Updated the above message: please include the link. (It doesn\u2019t actually work yet but I\u2019ll fix it tomorrow). We need to explain that some third-party proptypes might need to be updated to pass ...rest arguments down now, or they would trigger a false positive.\n. Let\u2019s remove @flow here? This file is not fully typed right now.\n. Nit: can you please format these so space is at the end of the previous line?\n. Since we did this here, let\u2019s also do this in ReactNoopUpdateQueue and change some of the tests to use ES class so  we ensure we can see their name there.\n. We don\u2019t use this convention anywhere so let\u2019s remove it.\n. I think we can just return false right away here, server components are never mounted.\n. We can always warn it\u2019s a no-op here, forceUpdate() doesn\u2019t make sense on the server.\n. Hmm, scratch that, maybe your render is impure and something just changed. Let\u2019s leave this as is.\n. Similarly, let\u2019s remove @flow here since we\u2019re not adding complete coverage to this file.\n. Let\u2019s rename this to just constructor.\n. Nit: \njs\n * This is the update queue used for server rendering.\n * It delegates to ReactUpdateQueue while server rendering is in progress and\n * switches to ReactNoopUpdateQueue after the transaction has completed.\n. It passes but you did not type all the methods. I think you can check this with flow coverage. \nJust passing is not enough. Flow passing doesn't guarantee that it typed everything, it just means it hasn't found violations so far.\nThe constraint we are operating under is that we either type the file completely, or we don't type it at all. \n. This is not how Flow works I'm afraid. It will \"pass\" even without annotations at all\u2014because it doesn't know anything. So the key takeaway is: we either add annotations to every function in the file, or we don't do it at all. \n. The calling function already knows the name of the unknown prop\u2014it passes it as an argument. Let\u2019s just return true if there is no need for additional warning, and false if we still need to warn. We can rename handleProperty to validateProperty.\n. This would become\njs\nvar isValid = validateProperty(...);\nif (!isValid) {\n  ...\n}\n. Let\u2019s rename props to unknownPropNames to make it clear props is not a props object like everywhere else.\n. Nit: you can use arrow function here for clarity (not required but would look nicer).\n. Let\u2019s inline groupWarnings into this function. It doesn\u2019t do much else and isn\u2019t used anywhere so it gives an impression of being more generic than it actually is.\n. I don\u2019t have enough experience with this so I\u2019m just passing on what @zpao said. To avoid bikeshedding this PR, let\u2019s just remove @flow from any existing files in this PR, and get the PR itself through. You can later make an additional PR focused on Flow where we can discuss this and clarify with @zpao and others.\n. Nitpick: let\u2019s remove this newline.\n. Nitpick: let\u2019s remove this newline.\n. Nit: previous two sentences started with capital and ended with period, let\u2019s keep this one the same way?\n. Nit: can kill this newline as well.\n. Nit: can remove this newline.\n. Nit: : boolean is now unnecessary here.\n. Can we change one of those tests to use createClass, another to use ES class, and the last one to use functional component? And let\u2019s rename from Component to Foo to be sure its name actually gets picked up.\n. Ah, good catch, you\u2019re right :-)\n. Time to port devtools to new APIs \ud83d\ude08 \n. These changes are just indentation. I moved an existing test into a common describe and added two more tests based on the issue reports.\n. The actual change is here.\n. Nit: could be else if for less nesting?\n. Did you abandon the idea of comparing state by reference?\n. See last commit\u2014I replaced most of these blocks with transactions. (I can revert just that commit if you\u2019re not into this.)\n. Can we just use an arrow here? I think this would be a bit less confusing.\n. Let\u2019s make the title shorter so function() fits.\n. What is the purpose of this comment?\n. Ah okay, let's keep it then. \n. Do you mean we could delegate to that package normally but replace with throwing shims in prod?\n. It doesn't break existing behavior because there is no observable difference as to what we use for keys. We just need to store some stuff on an object for each ID.\nIt improves perf because of some weird way V8 treats numeric keys. When all keys are numeric (like IDs are), for some reason delete becomes slower. Maybe it is similar to how sparse arrays are deoptimized. However if keys are not numeric (which we force by adding a dot before the number) it appears to create hash tables for those objects which is exactly what we want.\nIn general relying on something like this is very brittle. It is just VM implementation detail and can change any day. Still, if we can easily fix it without affecting performance in other engines, I think it's worth doing like in this case. \n. This is still a \"numeric\" key as considered by V8. (I tried that and it doesn't help.)\n. Don't forget, I am as puzzled that this works as you are. \ud83d\ude04 I don't have good explanations, I'm just saying I tried other ways and they didn't help. \n. I looked for it again, and this is the only unguarded debugTool call in the codebase. I missed it the last time because I didn\u2019t realize TestUtils could be run in production mode.\n. Aah, __DEV__ \u201cworks\u201d because it\u2019s how it\u2019s called internally! :steve_jobs_fireworks:\n. Would ReactDOMDebugTool still be bundled only in development this way?\n. Fixed, thanks.\n. Nit but I guess you\u2019d want to do the instanceof check for error1 too?\n. I think it\u2019s fine to have a single variable for this. If it warns once, something\u2019s messed up already so it might warn more times.\n. You can move this inside:\njs\nwarning(\n  !currentTimerType || beginLifeCycleTimerHasWarned,\n  ...\n)\nIt only warns when the passed condition is false.\n. This sets it regardless of whether the warning has occurred. Sorry I didn't realize this at first.\nIt seems like it would indeed be easier to add an if (currentTimetType) here. The warning would just get lifeCycleTimerHasWarned as an argument. \nSame below. \nSorry I didn't see this at first!\n. No, this is still incorrect.\nLet me clarify: warning() doesn\u2019t actually produce a warning unless its first argument is false.\nThis code is not a warning path by itself.\njs\nvar isEverythingBad = false;\nwarning(!isEverythingBad, 'Everything is bad');\nwill not produce a warning. I know it\u2019s a bit confusing but if you think of warning() as of something like assert(), it will make sense. The first argument is the condition you expect to be true.\nIn the current code, you set lifeCycleTimerHasWarned in any case, regardless of whether the warning was actually printed. So it gets silenced on the first check, not on the first warning.\nThis should work instead:\njs\nif (currentTimerType) {\n  warning(\n    lifeCycleTimerHasWarned,\n    ...\n  );\n  lifeCycleTimerHasWarned = true;\n}\nAlternatively:\njs\nif (currentTimerType && !lifeCycleTimerHasWarned) {\n  warning(\n    false,\n    ...\n  );\n  lifeCycleTimerHasWarned = true;\n}\n. Thanks! Let\u2019s also make it \u201ca list of commands\u201d instead of \u201cthe list of the commands\u201d?\n. If we are trying to keep it backward compatible, we also have to allow old method names (addDevtool, removeDevtool). \n. \"We're using npmcdn here\" can lead people to believe we use it at Facebook.\nCan we reword to something like \"We're using npmcdn below\"?\n. Not relevant to the change but seems like we could add a reminder to use .min in production here.\n. Nit: not very clear why there are two tests, and how they are different (right not the name only differences is starting with \"should\")\n. These are just consistency changes. The original code is kinda odd with two checks.\n. For future reference: delete is super slow on V8 with many items when using numeric keys. Even toString() is not enough\u2014you have to prepend them with something like .\n. This might also resolve some issues we saw regarding missing elements in stacks\n. This is now the only place where we create entries. All others have been changed to vanilla get.\n. I'm thinking https://github.com/facebook/react/issues/7240#issuecomment-236403307 and further reports. But not sure if that was related or not.\n. I was surprised too. Yes, ReactCompositeComponent test about setState in componentWillUnmount fails specifically. I will be taking a closer look later this week when I'll be tracking down errant warnings. \n. Why is setTimeout here necessary?\n. Interesting that we weren\u2019t passing it before (this code path could still run in __DEV__).\n. Yea.\n. Copypasta. Not sure why it was there. Removing.\n. This is a rare operation (I currently only use it in tree hook tests) so it\u2019s fine to be slow.\n. Added this to verify both getRootDisplayNames() and getRegisteredDisplayNames() work on both code paths.\n. Ok, will do on Monday\n. I replaced early returns with branches because it makes these two paths clearer in my opinion.\n. I check for Array.from in canUseCollections.\nDo you mean that a native Map may exist without Map.prototype.keys?\n. Seems so (thanks for the tip!) I'll update to check for keys() specifically. \n. Correct me if I\u2019m wrong but I think this goes against the purpose of keyMirror.\nIt exists for Google Closure Compiler property mangling to work.\nReact is used by Om (and other libraries) from ClojureScript, which in turn relies on GCC.\nAFAIK it will break Google Closure Compiler optimizations because\njs\nkeyMirror({ hello: true })\nwill get transpiled to\njs\n{ hello: 'hello' }\nwith this plugin (correct me if I\u2019m wrong).\nGCC will then mangle this to\njs\n{ a: 'hello' }\nwhich is broken.\nThe intention of keyMirror is that\njs\nkeyMirror({ hello: true })\ngets mangled by GCC to\njs\nkeyMirror({ a: true })\nwhich will still work (because it produces { a: 'a' }).\n. Just PropTypeError.prototype = Error.prototype should work in our case right?\n. Instead of just adding a link here, I would rather add a separate condition checking specifically for undefined and add a more descriptive message for that case. This is the case with most bundlers using Babel: you get undefined when you misspell an import.\n. Is this a good place to put it? Since the function is called setContentChildForInstrumentation I wouldn\u2019t expect other logic to show up here, or maybe we can rename the function itself.\n. To a what? \ud83d\ude42\n. We would need to check that window exists here, as it may not on the server, for example. I think usually ExecutionEnvironment.canUseDOM is the check we use (you can search for it in the source).\n. I would prefer we check != null rather than !== undefined here in the case where there is a Polymer variable set to null so member access doesn't throw later. I know this is unlikely but still. \n. Should we emit the warning if Polymer.useShadow is false? I'm not sure what it means (will need to read some docs) but from the code it seems like useNativeShadow would then also become false regardless of the polyfill. \n. These actually should be before emitEvent for better precision..\n. These two are guaranteed to be composites since they have lifecycles. \n. Oh but you're right, still need to check whether profiling. \n. if (\u00af\\_(\u30c4)_/\u00af)\n. ReactTestUtils checks an instance, not an element, so that\u2019s why it\u2019s different.\nI could add a convenience method to the hook but I\u2019d wait for a little more duplication first.\n. Good catch.\n. That\u2019s callback context which is irrelevant since I use arrow anyway. I\u2019m worried saying /* context */ there will make it even more confusing because React overloads this term. Maybe I could get away with not passing it at all.\n. Just formatting.\n. Mostly consistency with other places where I pass it even in prod (as 0), see performInitialMount. Passing 0 in that case doesn\u2019t really make any difference, and is easier than to branching calls on __DEV__. I chose to pass 0 over passing undefined in production because I felt that passing different argument types depending on DEV/PROD several levels deep is potentially asking for trouble / misinterpretation.\n. It\u2019s not set in production, and accessing non-existent field is a potential perf issue because it traverses the prototypes.\n. Valid question \ud83d\ude04 \nIt's used for two weird internal kinds of components:\n- \"Top level wrappers\" which aren't real components, but things we use to handle top-level render()s as updates when the type matches. This is an ugly implementation detail that ideally should be removed eventually.\n- \"Empty components\" which also aren't real components, but that we mount as a child when you return null from render. Again, these exist only as implementation detail, and aren't exposed to user in any way.\nNeither of these two \"pseudo\" components should be exposed to ReactPerf, DevTools, or hooks, so for now I gave them debugID = 0. They wouldn't exist in Fiber, or even in current reconciler if we refactor some things.\n. Top level wrappers:\n- https://github.com/facebook/react/blob/7b11aa9450e3040199ca83faa8c191956e82e99c/src/renderers/dom/client/ReactMount.js#L269-L280\n- https://github.com/facebook/react/blob/7b11aa9450e3040199ca83faa8c191956e82e99c/src/renderers/native/ReactNativeMount.js#L32-L40\nEmpty components:\n- https://github.com/facebook/react/blob/master/src/renderers/dom/shared/ReactDOMEmptyComponent.js\n- https://github.com/facebook/react/blob/master/src/renderers/shared/stack/reconciler/ReactSimpleEmptyComponent.js\n. It's a reserved name in JS so it won't work as object key. We use lifecycle names as keys in the ReactPerf detailed output. We could prefix them but this makes output more convoluted, and constructor is the only problematic name.\n. > How bad would it be to have the debugID check inside of measureLifeCyclePerf? This way you can greatly simplify all the call sites\nOh yea, totally, can do that.\n. I didn't mean a compilation issue. I vaguely remember having some sort of runtime error due to that but I can't really recall it. Might try taking it out and seeing if something breaks.\n. Yeah, adding an extra stack frame for every component sucks \ud83d\ude1e \nI tried keeping them unrolled but it\u2019s too slow due to try/finally and too easy to mess up because many lines.\n. Yep\n. That seems like it could potentially be slower? I\u2019d like to avoid closures here in production, it\u2019s a very hot path.\n. (I\u2019d need to measure that but that makes it less trivial change for me. The existing code also has two different paths here.)\n. Will do!\n. Added this test so we don\u2019t accidentally regress in prod.\n. Yeah, I wrote this PR yesterday while waiting for the taxi so it wasn\u2019t really clean \ud83d\ude04 \n. I took a profile and it was something like 0.01% of total time so I didn\u2019t bother.\n. This is a very hot path in development. We\u2019d need to compare the runtime before and after with a benchmark that mounts thousands of elements to avoid regressions in DEV.\n. Instead of adding this method (which will end up in prod builds for no gain), let\u2019s extract the if block contents into something like:\njs\ntestEventPageXY: function() {\n  if (document.createEvent) {\n    hasEventPageXY = evt !== null && 'pageX' in evt;\n  } else {\n    hasEventPageXY = false;\n  }\n}\nThen call this method both from ensureScrollValueMonitoring when if (hasEventPageXY === undefined) and from tests after stubbing out document.createElement.\n. This would need to be != null instead of !== null. If we\u2019re protecting, let\u2019s protect fully.\nYou will also need to add a note like\njs\n// Protect against document.createEvent() returning null\n// Some popup blocker extensions appear to do this:\n// https://github.com/facebook/react/issues/6887\n. If we kill them, people who use old RN with new React will have issues. Unfortunately it seems like a lot of people still do that so I'd keep until a major.\n. I think both can be null potentially. \n. Do we need to do it in a single statement here? I\u2019m asking because usually we write module.exports = ThingWithSameNameAsFile and the inconsistency is slightly jarring.\n. Yea, I just meant in this particular codebase.\nNot feeling strongly about it.\n. Can you please use backticks here to make it render as a code span?\n. Same here, author should be in backticks, not in asterisks.\n. Is this anywhere in Flow documentation? It\u2019s a bit odd that powerful/useful features are undocumented. \n. Is there any way flow coverage could be integrated into flow CLI? Many people don't use Nuclide and when they try flow, they aren't aware flow coverage exists. \n. (I understand there's a separate command but it's easy to miss when you are learning or trying it for the first time. I didn't know it existed until someone mentioned it on Twitter a month ago.)\n. Would be nice to learn what those false positives are since we're touching this code.\n. It should be safe. If we got this far then there's no way it could be undefined, as .ref access would blow up anyway.\nI think by convention rendered nodes can only be null, false, or string|number|ReactElement. Practically you can never get an undefined here.\nIt would be nice if we could enforce this somehow but I guess making the check more relaxed should not be a big deal. We can think about it again if we find more similar checks. \n. It can be expensive to create closures in such a hot path. Can you please hoist that function outside createElement()?\n. Why isn\u2019t it the default \ud83d\ude04 \n. @vjeux \nTo be specific, the problem is on this line.\nGCC will crush lines like these:\njs\n{\n  abort: {\n    phasedRegistrationNames: {\n      bubbled: keyOf({onAbort: true}),\n      captured: keyOf({onAbortCapture: true}),\n    },\n  },\n}\ninto\njs\n{\n  a: {\n    b: {\n      c: keyOf({e: true}),\n      d: keyOf({f: true}),\n    },\n  },\n}\nHowever, phase will be a full string:\njs\nvar phase = upwards ? 'bubbled' : 'captured';\nand so\njs\n var registrationName =\n      event.dispatchConfig.phasedRegistrationNames[propagationPhase];\nwill give you undefined.\n. I think the idea is that if both prevElement == null || prevElement === false and nextElement == null || nextElement === false then the function will return true. This is a false positive because if it was empty and stays empty, there is no need to update refs. Probably not a big deal.\n. Might inline this one?\n. Can we kill all captured names and just infer them by appending Capture? Seems like we could save some bytes here.\n. Let\u2019s inline it.\n. (This might be a bigger rework and probably out of scope of this PR. I haven\u2019t checked if there are any places where we break this convention but I\u2019d be surprised.)\n. Does this mean that if we pass them through multiple levels of components, the same array could get slice(0)d many times?\n. Why was this comment here? I don\u2019t understand what it refers to because mouseOver is defined just below. Is this still relevant and should some version of this be copied to new code?\n. I\u2019m mostly worried about prod here.\nI don\u2019t think we can afford to do more allocations in prod.\n. Can be null or false here too.\n. I think these can be number | string too, can they not?\nIn case where you have <div>{1}{'2'}</div> so they each get an instance.\n. Could you please wrap expectations into try / finally so document.createEvent is always restored regardless of whether the test fails?\n. Maybe let\u2019s call it supportsEventPageXY() so it\u2019s clear what\u2019s being returned.\n. Is there any problem with doing them? In my experience of using standards, unless you check for everything explicitly, you risk running into bad/incomplete polyfills.\n. Also those checks run only once.\n. No weird behavior so far, just wanted to be extra safe.\n. Can we make a default mockConfig implementation and always assume mockConfig exists?\n. Let\u2019s also test that we receive the correct element.\n. Looks fine to me.\n. Yea, default impl is what I meant. \n. Thanks\n. I'm trying to mirror the structure above exactly so it's easy to keep them in sync. \n. Let\u2019s call it Invalid Element Type Warning for consistency with other warning\u2019s style. Same for filename, would be invalid-element-type.md.\n. Missing two space indentation here.\n. is an invalid element type would be better than invalid value for a type.\n. Let\u2019s replace ReactClass or React.Component with a component class or a function.\n. People don\u2019t know what composite means, I would just say user-defined here.\n. Don\u2019t worry about repeating the message, it doesn\u2019t matter.\nPlease could you remove this comment?\n. We already know it is undefined, no need to interpolate it. Let\u2019s just hardcode it to make it clear.\n. I want to move this sentence right after the first sentence. It\u2019s easier to miss and ignore at the end.\n. Please write http://fb.me/... instead.\n. Same tweaks as I suggested above:\n- is an invalid element type\n- a component class or a function (for user-defined components)\n. Please move getDeclarationErrorAddendum() to the next line so we don't have two arguments on the same line.\n. Let\u2019s remove this newline.\n. Fallthroughs are hard to understand. Can you please rewrite this to avoid it? Maybe replace switch with several boolean variables using each other.\n. Unnecessary extra indentation here and below. Let's keep lines aligned. \n. Same here. \n. Let's add \"a\" before \"component class\" and before \"function\". \n. This comment is useful, let's keep it. \n. The last sentence is only true if you have undefined type.\n. Let's also avoid saying ReactClass/React.Component here. \n. Which API are you referring to? It would make sense to link to createElement() specifically. You can hover over its header in docs to see the exact anchor link.\nPlease also remove domain from the URL and just start it with /react. This is useful in case docs move. \n. People reading this might not understand arrow functions. I would avoid them here. \n. It's not clear why you have if (false). Could you come up with a more realistic example please?\n. Let's avoid let here and use var so people don't think this warning is somehow related to let. \n. Also let's avoid Foo and Bar and use something more realistic like Button. \n. Why would somebody want to export an element from a file? This looks confusing. \n. People will misunderstand this and think curly braces are always necessary. \n. People might be using CommonJS so this is not always the case. \n. Can we check this._compositeType instead, and only warn for stateless functional components? It seems like this would solve the issue by making the warning more specific without hardcoding information about test renderer. Another upside is that the warning would still fire if you try to use refs with stateless components incorrectly while using test renderer for example.\n. If I'm not mistaken existing docs call it ReactNode.\n. Agree, sorry I missed this. Should we add a check for typeof component._currentElement.type === 'function'?\n. Oh, I understand this now. Different hidden class? Seems like we do this in many places anyway but thanks for explaining.\n. ReactCompositeComponent should not be aware of test renderer-specific APIs. Is there a reason why defining getPublicInstance() inside test renderer not enough?\n. Can you please make it always read the mock config from transaction? By providing a default, I meant doing it at top level. So if you don\u2019t pass { getMockRef } to ReactTestRenderer.create(), you get a default implementation at that point, and it gets passed down, so that any downstream code can just assume it exists.\n. I don't see this argument being used.\n. This is reconciler code, it also shouldn't have any knowledge about \u201cmock config\u201d (which is test renderer specific). We should always call component.getPublicInstance(). Passing an additional thing to it is fine, but that thing should also be renderer-agnostic (like transaction).\nInstead of branching here, we should branch inside getPublicInstance() implementation in the test renderer. It also shouldn\u2019t check if mockConfig exists because it should always exist\u2014as we wanted to pass down a default value when user doesn\u2019t specify any.\n. Same here\u2014argument should be renderer-agnostic, transaction seems fine.\n. > one issue is that component.getPublicInstance() will be calling ReactCompositeComponent.getPublicInstance if the component is a composite.\nI think it\u2019s reasonable to scope getMockRef effect to host instances only. You don\u2019t want to mock composite refs, I think.\n. Can we pass default here instead, as this is the first place where it appears?\n. Let\u2019s keep it without underscore for consistency.\nAlso let\u2019s move assignment just before reactMountReady assignment.\n. Since this.reactMountReady is accessed via getReactMountReady(), let\u2019s add getMockConfig() for consistency and use that instead outside.\n. Let\u2019s not leave more than one empty line.\n. Style nit: {getMockRef} to be consistent with the codebase\n. Same, extra newline\n. Per @spicyj, let\u2019s keep null the default one.\n. Probably ?TestRendererMockConfig, it\u2019s optional.\n. Nit: no need for extra spacing.\n. Nit: extra line\n. Let's add a newline before this line too for consistency now that we\u2019ve put some of them between methods.\n. Same here\n. Let\u2019s remove this newline\n. And keep this one, so the diff is smaller. In general better not to formatting changes to code you didn\u2019t directly touch unless it\u2019s horribly formatted\n. Extra newline\n. Let\u2019s also test that if you pass {} as options, getMockRef will be returning null (as opposed to throwing on options.getMockRef()).\n. The way \"options\" are generally handled in JS libraries, user-passed options are shallowly merged with defaults, and the result is passed down. So passing null, {} or {unrelatedOption:42} gives you default getMockRef implementation.\nCan we do the same here? options = Object.assign({}, options, defaultOptions)\n. Let's keep it the way it is. If we want to make this cleaner we should just use ES6 classes instead but this should be done separately. We should not mix stylistic and meaningful changes in the same PR.\n. I think we put ? before the type elsewhere, like ?Stuff. Not sure if there's two ways of doing the same thing?\n. Let's also rename \"mock config\" to \"test options\" everywhere. It's longer but more explicitly and makes it clear we can add more stuff to it if we want to that's unrelated to mocking.\nInside test renderer we can just call it options. Outside, testOptions and getTestOptions seem fine. \n. Let's make this three lines. First get the element, then get the options, then use them to get and return the ref.\n. This is important to document. Also many people will try to use it.only, it will crash, and people will think Jest doesn't support this feature.\n@cpojer\n. Flow is fine now that we have a better idea how to use it thanks to PRs from @vjeux!\n. \"\u043e\u0431\u044b\u0447\u043d\u043e \u0441\u0442\u0440\u043e\u043a\u043e\u0439\"\n. \"\u0437\u0430\u043c\u0435\u0442\u044c\u0442\u0435\" \u043a\u0430\u043a-\u0442\u043e \u0441\u0442\u0440\u0430\u043d\u043d\u043e, \u0434\u0430\u0432\u0430\u0439\u0442\u0435 \u043f\u0440\u043e\u0441\u0442\u043e \"\u043e\u0431\u0440\u0430\u0442\u0438\u0442\u0435 \u0432\u043d\u0438\u043c\u0430\u043d\u0438\u0435 \u043d\u0430 \u0437\u0430\u0433\u043b\u0430\u0432\u043d\u0443\u044e 'W'\"\n. \"\u041a\u043b\u044e\u0447\u0438 \u0441\u0442\u0438\u043b\u044f \u0432 \u0432\u0438\u0434\u0435 camelCase \u0434\u043b\u044f \u0442\u043e\u0433\u043e \u0447\u0442\u043e\u0431\u044b \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u043e\u0432\u0430\u0442\u044c \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e\u0441\u0442\u0438 \u0441\u0432\u043e\u0439\u0441\u0442\u0432 DOM \u0443\u0437\u043b\u043e\u0432 \u0438\u0437 JS\" => \"\u041a\u043b\u044e\u0447\u0438 \u0441\u0442\u0438\u043b\u044f \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u044e\u0442\u0441\u044f \u0432 camelCase, \u0432 \u043f\u0440\u044f\u043c\u043e\u043c \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0438\u0438 \u0441 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u044f\u043c\u0438 \u0441\u0432\u043e\u0439\u0441\u0442\u0432 DOM-\u0443\u0437\u043b\u043e\u0432 \u0432 JS\"\n. \u0421\u0442\u0440\u0430\u043d\u043d\u043e \u0440\u0430\u0437\u0431\u0438\u0442\u044b \u043f\u0435\u0440\u0432\u043e\u0435 \u0438 \u0432\u0442\u043e\u0440\u043e\u0435 \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u0435. \u0414\u0430\u0432\u0430\u0439 \u043f\u0435\u0440\u0435\u0444\u0440\u0430\u0437\u0438\u0440\u0443\u0435\u043c \u043a\u0430\u043a \u043c\u044b \u0431\u044b \u043f\u043e-\u0440\u0443\u0441\u0441\u043a\u0438 \u044d\u0442\u043e \u0441\u043a\u0430\u0437\u0430\u043b\u0438.\n. \u041a\u0430\u043a-\u0442\u043e \u0441\u0442\u0440\u0435\u043c\u043d\u043e. \u041c\u043e\u0436\u0435\u0442 \"\u0412\u044b \u043c\u043e\u0436\u0435\u0442\u0435 \u043f\u043e\u043f\u0440\u043e\u0431\u043e\u0432\u0430\u0442\u044c \u044d\u0442\u043e\u0442 \u0441\u0438\u043d\u0442\u0430\u043a\u0441\u0438\u0441 \u0432\u043d\u0443\u0442\u0440\u0438 Babel REPL.\"\n. \u041c\u043e\u0436\u043d\u043e \u043f\u043e\u043c\u0435\u043d\u044f\u0442\u044c \u0443\u0436\u0435 \n. \u0414\u0430\u0432\u0430\u0439 \u043f\u043e\u043f\u0440\u043e\u0431\u0443\u0435\u043c \u043d\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u043f\u0430\u0441\u0441\u0438\u0432 \u043a\u043e\u0433\u0434\u0430 \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e. \u0412\u043c\u0435\u0441\u0442\u043e \"\u043d\u0435 \u043c\u043e\u0433\u0443\u0442 \u0431\u044b\u0442\u044c \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u044b\", \"\u043d\u0435\u043b\u044c\u0437\u044f \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c\".\n. \u041f\u0430\u0441\u0441\u0438\u0432 \u0445\u043e\u0447\u0435\u0442\u0441\u044f \u0443\u0431\u0440\u0430\u0442\u044c\n. \u041d\u0435\u043c\u043d\u043e\u0436\u043a\u043e \u0441\u0442\u0440\u0430\u043d\u043d\u043e\u0435 \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u0435, \u043e\u0447\u0435\u043d\u044c \u043c\u043d\u043e\u0433\u043e \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0445. \u0414\u0430\u0432\u0430\u0439 \u0440\u0430\u0437\u0432\u0435\u0440\u043d\u0435\u043c. \u0427\u0442\u043e-\u0442\u043e \u0442\u0438\u043f\u0430: \"\u0422\u0430\u043a\u0436\u0435 \u0432\u044b \u043c\u043e\u0436\u0435\u0442\u0435 \u043e\u0431\u0435\u0440\u043d\u0443\u0442\u044c \u043a\u043e\u0434 \u0432 \u043d\u0435\u043c\u0435\u0434\u043b\u0435\u043d\u043d\u043e \u0432\u044b\u0437\u044b\u0432\u0430\u0435\u043c\u0443\u044e \u0444\u0443\u043d\u043a\u0446\u0438\u044e \u0438 \u0440\u0430\u0441\u043f\u043e\u043b\u043e\u0436\u0438\u0442\u044c \u0435\u0451 \u0432\u043d\u0443\u0442\u0440\u0438 JSX.\"\n. It's fine to just use string literals here instead.\n. Is this a breaking change for ART?\n. \u0414\u0430\u0432\u0430\u0439 \u0440\u0430\u0437\u043e\u0431\u044c\u0451\u043c \u043d\u0430 \u0434\u0432\u0430 \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u044f. \u0417\u0430\u043c\u0435\u043d\u0438\u043c ; \u043d\u0430 \u0442\u043e\u0447\u043a\u0443. \n. \u041f\u043e\u0441\u043b\u0435 \"\u0442\u0430\u043a\u0436\u0435\" \u0437\u0434\u0435\u0441\u044c \u043d\u0435 \u043d\u0443\u0436\u043d\u0430 \u0437\u0430\u043f\u044f\u0442\u0430\u044f \n. I understand but ART lives in its own repo. It's only here for running tests. (Yea I know it's confusing.) This means that if we had to change ART in a PR here, real ART will break with next version of React that contains this change. cc @spicyj @zpao\n. In other words ART relies on private APIs (MultiChild), and private APIs just changed in this PR. Same for React Native until it starts using its own renderer copy (I think this hasn't happened yet).\nMaybe I got it wrong but I think this is a breaking change for ART and RN and I'm not sure what we should do next. \n. Nit: could write this as expect(instanceC).toBe(instanceA)?\n. fixed, thx\n. Yea I learned that since I first wrote this (as a draft) but couldn't figure out how to explain it without sounding even more confusing. Left it as is because it applies in our context.\n. This is intentional, these words have different meanings\n. I think this should be define, not require.\n. @spicyj Can you help me understand in which cases we need to pass topElement here, and why it is necessary in some cases?\n. I\u2019m actually not sure what it\u2019s doing so I don\u2019t know if it\u2019s necessary.\n. But for the reference, instance._currentElement is the element.\n. Maybe a nit from a non-native speaker, but this:\n\nReminds me of this.\nI honestly wouldn\u2019t know which to choose. If I\u2019m new to React, should I \u201cGet Started\u201d or \u201cTake the Tutorial\u201d? Does taking a tutorial presume I already \u201cgot started\u201d? Does \u201cgetting started\u201d presume I already know things in the tutorial?\n. I think people get a little frustrated when we say there are multiple ways to do the same thing. Maybe approach it from a different angle? e.g.\n\nReact is flexible and accommodates a variety of projects. You can create new apps with it, but you can also gradually introduce it into an existing codebase without doing a rewrite.\n. I think this section should offer to download an index.html file that lets you play with React. That file would use react@latest and react-dom@latest from unpkg so we wouldn\u2019t need to update it. I don\u2019t think there is a need to write out this file's contents on the page though.\n. I style it as Create React App everywhere, can we keep that instead of the CLI name?\n. I would say Creating a Single Page Application because this is the specific use case CRA handles. For anything else, you should just use the bundler and do things your way.\n. I wouldn't namedrop technologies here, and instead would say something like It lets you write modular code with the latest JavaScript syntax, provides a great development experience, and optimizes your app for production.\n. Maybe link to Node and Rails tutorials?\n. Let's write the \"hello world\" App component here inline as a class?\n\nAlso let's change document.getElementById('the-element-id') to document.getElementById('root') and mention that you need:\n- <div id=\"root\"></div> in your HTML file\n- Babel with react and es2015 presets\n. Nit: npm is not a part of the build pipeline.\nMaybe \"if you use npm for package management\"?\n. Bower should come after a section about UMDs. Right here we should mention that react and react-dom npm packages provide UMD distributions in dist folders, and that we also host the same files on CDN.\n. I would completely remove this section. It conflates two different things:\n- Using React from CDN (fine for dev and prod)\n- Using in-browser Babel transform (exists only for trying React and literally nothing else)\nThis section gives a wrong impression that somehow using React from CDN is bad, which it is not.\nI think, as I mentioned above, the section on React CDN files should be merged with Adding React to an Existing Application, and the part about in-browser Babel can be fully omitted and instead added to a downloadable index.html in Trying Out React.\n. Good point. Let's add this as a separate section. It should tell people to:\n1. Either use React from npm or CDN\n2. Add Babel to their asset pipeline (there are many ways) and then ensure they enable 'es2015', 'react' as presets\nThat Babel link is really exhaustive and includes Rails.\n. You can add \"It includes preconfigured Webpack, Babel, and ESLint, so you can start working on the project right away.\"\n. I linked to the particular ones in the comment \ud83d\ude04 \nI think these are pretty good as CRA+Node and CRA+Rails intros, not as React intros though.\n. Let's add here: \"It uses Webpack, Babel and ESLint under the hood, but configures them for you.\"\n. Let's add a section called \"Enabling ES6 and JSX\" that tells people to use Babel and points to https://babeljs.io/docs/setup/. We can then say something like \"make sure you install babel-preset-react and babel-preset-es2015 and enable them in .babelrc, and you're good to go\"\n. Let's use https://unpkg.com/babel-standalone@6.15.0/babel.min.js here instead.\nLike in #7669.\n. Looked in the docs and you're right. \ud83d\ude05 \n. It used to be concat but it looked pretty crowdy and I thought this could save some space. IMO it's not hard to guess what it does even if you don't use ES6. But happy to change back to concat if you think that was better. (Many people don't know concat() exists or what it does either.) It's also not really the point of the example, and the code is more for illustrative purposes rather than for direct learning.\n\nAlso - wasn't someone talking recently about, you shouldn't use this.state.foo in setState\n\nIdeally you shouldn't but the alternative is too much syntax noise for this example so I think it's okay.\n. Yes, but this would require some further changes to how this page is set up (e.g. passing IDs as props to the code editor). Can do separately.\n. Fixed.\n. I would stress that it is not a feature of React but a pattern right in the intro\n. Maybe \"that takes a component and returns a component\"?\n. This makes it sound like we claim render callbacks are \"hard\".\nMaybe \"sometimes it is harder to figure out how to abstract some pattern into a traditional component\".\n. this.state.comments\n. Let's just use arrows here, I plan to use them in such cases throughout the docs\n. Let's avoid jargon like \"doc\"\n. - instance methods don't work\n. What is the reason for adding these back in? I intentionally removed them from docs and left them in docs-old so that we tell new and old content apart and gradually migrate it. \n. Minor not: you'd almost never want to use the id attribute in React components. Maybe className?\n. \"Of the React element\"? We don't really say \"JSX element\" elsewhere. \n. Maybe add here:\n\"If you don't use a JavaScript bundler and added React as a script tag, it is already in scope as a React global.\"\n. I feel like this is a minefield because it only works if you use default exports in that file. Maybe shift the attention from imports to demonstrating this in one file? So that we don't have to explain how modules work in this document.\n. Let's give names to all functions. \n. This sounds a bit like React will create an actual HTML node when you type JSX. It is still a \"React element\" but it describes a DOM tag. \n. Unintentional braces\n. Let's move this inside the function? That would be equivalent to your first example then. \n. Today I learned\n. I don't understand this paragraph, can you rephrase (maybe with an example)\n. This document should also include detailed information on how whitespace woks in JSX. \n. In general, \"dot notation\" for components is not popular and I think could live somewhere in the bottom of the document. We don't need to emphasize this, and other topics (such as how expressions and whitespace work) seem more valuable to me.\n. Agree, what do you think about using 15 there?\n. Now that I read @spicyj comments I think it's fine (haha sorry). Since this is a doc about JSX specifically I think it's fine to say JSX Element. \n. Can make this ...children? It accepts variadic arguments. \n. That, and let's use double quotes in JSX too since most popular styleguides do that. So it'll be prop1=\"one\".\nI would also like us to use more real-world over contrived examples. Like Button or Avatar instead of MyComponent or Foo. \n. Same here: could be Button and DangerButton.\n. Nit: \"use\" rather than \"invoke\" because you won't actually be calling it\n. I think we shouldn't emphasize exports in examples unless we specifically mention module boundaries. It's fine to leave this as a function and presume that it gets rendered by something later. \n. I'm conflicted about calling them props here.\nIf we are talking about JSX, \"attributes\" seems more correct. Attributes usually become props (for custom components). However key and ref are attributes obeying JSX rules that don't become props. \nI don't feel strongly about this though. @spicyj What do you think?\n. Nit: it is not obvious to me how this is useful for children, or what children \"content\" prop has to do with explicitly specified string literal attributes. \n. An inquisitive reader would think: when don't want to do this instead of using <Item>?\nIn general we want to encourage people to create components rather than call functions directly. But I guess this is fine.\nI don't have a good solution to this. \n. Maybe if we put map body inline as an arrow it is clearer that this pattern is mostly useful for one-liners. \n. Maybe add another post-explainer here: Children passed to a custom component can be anything as long as that component transforms them into something React can understand before rendering. \n. Added a note to mention it later, I don't think it matters in introduction though.\n. Okay, fixing\n. Fixed now\n. I mention that\n\nNote that we wrapped JSX in parens and split it over multiple lines for readability.\n\nbelow. I don\u2019t think it\u2019s worth dedicating more space to this but if you can come up with a better / more specific wording that wouldn\u2019t be distracting, feel free to tweak here or after merging.\n. Fixed\n. This is exactly what I plan to do, from simple to more complex. I didn't want to introduce too many concepts right away so I wanted to keep Hello World super short.\nIn future topics, you see how JSX interpolation works (\"JSX\"), how React preserves DOM despite re-renders (\"Elements\" section), how to encapsulate reusable parts of UI (\"components as props\"), and how to make things change on the screen (\"events, lifecyle, and state\").\nI didn't want to start with components because this brings too many unknowns at once. For people comfortable with that, there is a tutorial, but I want to also have a path that offers full gradual understanding of public API.\n. I rewrote intro section to make it more clear where we're heading. Might rewrite it again when more content is in place.\n. I feel like they're easy to miss for people who skim through the docs but those are the same people who usually want to play with examples. Don't feel strongly about it, happy to change. \n. Yea, I have a todo item for looking through all docs and cross-linking them when everything is in place\n. Getting nitpicky but I think this \"component into a component\" is pretty much repeated in the last two sentences as well. Can we just merge them into a single sentence?\n. Nit: put identifiers in backticks\n. I think it's very easy to not realize that these are \"the same\" React components. In other words, it's not obvious that you can \"create\" components by some other means than defining a class. It would be nice to stress something like \"Instead of defining them explicitly, we will let a function called withSubscription() generate them.\"\n. This comment doesn't match the similar comment a few lines above which makes it confusing. Are these two examples subtle different?\nI'm not sold on the need for inline comments here at all. Maybe better to explain that after code? I found our ``javascript{lineNo,lineStart-lineEnd,...} notation super helpful for highlighting specific snippets and drawing attention to them.\n. Better to replace that sentence with a summary of why we are writing it?\n. It waswithSubscription` in examples before?\n. An example of how this may be useful is if you change data-fetching libraries.\n=>\nThis may be useful if you change data-fetching libraries.\nLess is more :-)\n. Can we use another example? AFAIK we want to treat sCU less strictly in the future and it would be nice if we didn't give an impression it can be legitimately used for e.g. blocking UI. Maybe data fetching would work better here?\n. It also doesn't work with functional components (if we care to mention that)\n. Hmm not really. Maybe just leave it vague without going into details? Like use componentDidMount and leave /* ... */ there. Not sure if that's much better.\n. Maybe add \"Note that the returned component does not extend the wrapped component. This is not an example of inheritance. Instead, it uses the wrapped component in the render() method.\"\n. This is a case non-mutating HOC can't handle :-(\n. Maybe \"transforms components themselves\"?\n. This should be without a host I think (so we can change it if we want to). So you can remove everything except /react/blog/....\n. Okay, let's use that example.\n(Logging)\n. I'm confused by this, isn't WrappedComponent the same class as the one we're inside of?\nIn general I would prefer a more specific example here. Like how would you expose/call an imperative focus() method on a DOM node of a connected component.\njs\n<div ref={node => this.props.registerFocus(node ? () => node.focus() : null)}>\n  <Stuff />\n</div>\n``` js\n this.focusField = focus} />\n// later\nthis.focusField();\n``\n. This is part of the legacy API. It is only relevant forcreateClass()` which we\u2019re dedicating a separate page to. Can we somehow mark it as legacy here?\nClass components use this.state assignment in constructor instead. See https://facebook.github.io/react/docs/reusable-components.html#setting-the-initial-state\n. Could also mention \"This is the only lifecycle hook called on server rendering.\"\n. Can we clarify it occurs before it receives new props?\nAlso, \"should be used\" makes it sound like you need to do that but it's actually a rare (and slightly discouraged because of complexity) case.\nCan reword as:\n\"If you need to update the state in response to prop changes (for example, to reset it), you may compare this.props and nextProps and perform state transitions using this.setState() in this method. Note that React may call this method even if the props have not changed, so make sure to compare the previous and current values if you only want to handle changes.\"\n. Here too, \"Implement this as an optimization\" sounds like you'd do this often but it can lead to nasty bugs when done incorrectly, and we almost never encourage people to implement it by hand. It's good to know it exists but we need to make it clear it's an escape hatch, and even if you think you need it, you're better off using PureComponent rather than writing it by hand.\nAlso, \"warrant an update to the DOM\" is technically incorrect. This is not what shouldComponentUpdate decides. shouldComponentUpdate prevents reconciling the whole tree below, so it's not just DOM: e.g. child components won't receive new props even if those values technically have changed.\nFinally, we plan to relax shouldComponentUpdate to be a hint to React in the future. So it might not be respected. We need to make it clear so people don't rely on it to pause rendering e.g. while data is loading.\nMaybe:\n\"shouldComponentUpdate(...) is lets the component provide a hint to React whether its or its children's output is affected by the current change in state or props. It defaults to true, and in the vast majority of cases you should rely on the default behavior. If you determine a specific component is slow after profiling, you may change it to inherit from React.PureComponent which implements shouldComponentUpdate() with a shallow prop and state comparison. If you are confident you want to write it by hand, you may compare this.props with nextProps and this.state with nextState and return false to tell React the update can be skipped. Returning false does not prevent child components from re-rendering when their state changes. Also note that React treats shouldComponentUpdate() as a hint rather than a strict directive, and may update your component anyway.\"\n. @saschwarz Thanks, that's a very useful review. I incorporated your suggestions. Can you check the second article I just added too?\n. IMO British/lazy style makes sense here, if we cared about typography we also wouldn't use \" quotes \ud83d\ude04 \n. I'm worried people will think \"single element\" = \"has no children\" so wanted to make it extra clear we're talking about roots.\nI didn't close the tag because it has children. (Not sure it makes a lot of sense but the opposite is just as annoying to me.) Feel free to change this if you feel strongly about it.\n. Not sure. I know many people new to react try to write big \"screens\" because they're used to Backbone templates or similar and don't realize that e.g. a Button is \"good enough\" to be a component. Maybe need to amend this to say that it some design element comes up more than a few times in different components then it's a good idea. \n. What else could you need it for? If you don't use it render it shouldn't be in the state. (Unless I miss something)\n. Agree on scrapping it. FWIW HOC also can't change the child state. \n. Regarding render callbacks. The only real difference when using HOCs in my opinion is:\n- HOC knows some things ahead of time so more optimization opportunities \n- HOC lets wrapped component react to related prop changes in lifecycle hooks. Render callbacks don't really allow it. \n. Agree \n. I think React docs use the style with spaces around em dash. I allow myself to do my own thing in blog posts but let's be consistent in docs and put spaces there I guess\n. This will set it to true as soon as it encounters the first custom tag, regardless of whether it uses shady DOM.\nMaybe make && el.shadyRoot to the if and put didWarnShadyDom as warning argument instead?\n. You can just pass false here because you already checked for it. \n. This is not part of ES6. We should make it clear this syntax is a stage 3 proposal, and show an ES6 alternative.\nIt might also be confusing why we spread over an object with just one property which we are updating.\n. Yes. They may not be the most common names in US, but React is also used by people from other countries. \ud83d\ude09 \n. OK\n. OK\n. OK\n. @acdlite \nIsn\u2019t ReactDOM.render() an imperative API?\n. To be clear, we haven't introduced components yet. I can add a blurb explaining that in real apps you'd do this with components and state.\n. @azizj1 The pitfall is that this.props will be undefined inside constructor if you don't pass props to super. This can be confusing so we recommend always passing them for consistency.\n. I added this note. I hope it helps.\nI don't want to remove the example because people often don't realize how setState() is essentially the same thing as ReactDOM.render(), but encapsulated. This knowledge is valuable IMO, and the whole state article builds up on this specific example.\n\n. OK\n\n. OK\n. OK\n\n. Replaced this part\n\n. OK\n\n. OK\n. OK\n. OK\n. OK\n\n. I showed this in example but it wasn't clear enough. Clarified now.\n\n\n. Ah good catch. I'll remove this sentence here and add another on \"If you don't use it in render\" earlier.\n. OK\n\n. OK\n\n. I already renamed it once at @spicyj's request \ud83d\ude04 \nBut inlining sounds good.\n. Done\n. OK\n\n. Removed \"minimal\". I sort of agree because I used to give React too much credit when I was learning. \ud83d\ude1b \n. ok\n. OK\n. OK\n. \n. \ud83d\udc4d \n. Nit: these are full sentences, can end them with period?\n. I'm not confident that comparisons to HTML are necessary at all.\nPeople who know how HTML event handlers work in 2016 also probably have learned that those are \"very bad\".\nI think maybe we should reframe this section as if the person has never heard of HTML at all.\n. I might be wrong but I think <a href=\"#\"> is considered a bad practice because you can't open that URL in a new tab. I think we shouldn't promote bad practices even as simple examples. Can we use a button here instead?\n. I would put the event handler inside the component function. This way it's more obvious how to access props. Most event handlers are going to need props so it would be nice to have an example demonstrating that right away.\n. > A common pattern is for an event handler to be a method on the React component.\nMaybe \"When you define component as a class, it is common to ...\"\nIt might be confusing how a functional component could have methods.\n. Nit: unnecessary spacing\n. Nit: since on() is common API for event handling, maybe rename this to isToggled or something like this?\n. Let's call it handleClick to introduce the on*={handle*} convention early. We use and recommend it pretty much everywhere.\n. This also makes it easy to remember that everything starting with handle* needs to be bound.\n. We should highlight that this is experimental syntax proposal and not a part of ES6.\n. We haven't introduced the word \"reconciliation\" anywhere yet (and I think we shouldn't until advanced guides).\n\nwill always re-render, which is bad for performance.\n\nThis makes it sound like the DOM node is being re-created which is not the case. In fact there is almost no perceivable difference between binding in constructor and binding in render() method in this particular case.\nThis is only suboptimal for performance if you pass it to a user-defined component below, that component is expensive to render, and it is a subclass of PureComponent. In this case that component attempted to bail out with shallow comparison check, but that check always fails to bail out because of that function prop that's different every time.\nThis doesn't really matter in the majority of cases, and \"If you don't care about performance\" is a too strong way to put it. We might say that we recommend binding in constructor because if you ever encounter performance problems later on, binding in constructor makes it easier to optimize React components when needed.\n. It is worth mentioning somewhere that e is an object created by React. It's a \"synthetic event\". This is how we ensure consistency with spec, but there are pitfalls:\n- Some newer fields might be missing for some events, using e.nativeEvent.* if you must access them.\n- Synthetic events are \"pooled\" so you can't keep a reference to e and expect it to stay valid. You must call e.persist() if you want to keep it, and e.release() (AFAIK) when you're ready to get rid of it.\n. Thanks, fixed.\n. Yeah, we don't want to use experimental proposals in docs except in a few places where we specifically call out their experimental nature\n. Thanks, fixed\n. Let's say \"shady DOM\" like they do in its docs?\n. One string wouldn't be enough because we wouldn't know which of the fields contains an invalid input. I used to keep two separate strings but this was distracting from the point of this tutorial so I removed that.\nThis is kind of the edge case that the tutorial inherently has (due to lossy conversions) but most apps don't (because most apps aren't temperature calculators). I'm worried that if we care about fixing this, we'd also have to either change the example to be lossless or add quite a bit of code to achieve the exact behavior we want.\nYou can't really protect against floats by limiting input to ints because they'll be floats after conversion. And rounding them up is going to look confusing.\nI think I'll just add a note about this that explains the tradeoff.\n. Also apparently it's a bug in React \ud83d\ude22 https://github.com/facebook/react/issues/7253\n. Can this link to new doc instead? \"Components and Props\" includes a section on functional components. Also let's call them \"functional components\" since that's their defining trait here. Class components can also be stateless but this is not important here.\n. In the intro docs I call them just \"React elements\". Do we need this PascalCase notation here?\n. \"the latest React component\" sounds a little bit confusing. The thing that gets passed is an element, not a component. \n. Do we need this \"in future\" here? I don't think it adds value. \n. Do we need this ReactComponent pascal case notation here either? I would rather see us consistently use \"component instance\" instead. ReactComponent sounds like some sort of library-provided class which it is not. \n. Let's use \"functional\" here. It works with class stateless components. \n. Many people these days don't know what CommonJS is, and beginners who learned with Babel don't know what require() is because they only saw import. \n. This makes it sound like lifecycle hooks (which is what most of that doc is dedicated to) are provided on it whereas the opposite is truth. Maybe say \"related to the base ...\"?\n. The notation in JS is ...children (it's part of the language). I think we should stick to that. \n. Same\n. I'd mention you don't need createFactory in JSX code. It mostly exists for people who don't use JSX. \n. Again, I think we should stop using ReactClass. This notation is misleading (e.g. \"ReactClass\" here could also be a function). Let's just consistently say \"React component defined as a class or a function\". \n. Nit: can avoid parents? Nested sentence reads hard to me as non-native speaker. \n. Lol. Parens that is. Split it into two separate sentences. \n. Missing full stop after sentence. \n. Add a note that we recommend trying Flow instead of runtime checks?\n. Missing full stop\n. Full stop missing\n. A bit confusing that second arg doesn't end up used. Maybe say props.incrementStep?\n. Missing full stop \n. It is worth mentioning that \"If you don't use it in render() it shouldn't be in the state.\" Like you can put timer IDs on the instance. \n. I guess CustomLink makes me feel like it's supposed to represent something with a URL. No big deal though. \n. The problem with arrows is death by thousand cuts. Binding in constructor is a better default. But on small scale (tens of components) this won't matter. On large hierarchies as you begin to try optimizing your app it might start mattering in that if it will prevent your optimizations from kicking in. \n. Any specific reason for using an arrow here? Seems like would be consistent to use vanilla function like the outer one. \n. Let's update to handleClick here too \n. Mention early that constructor is not required if you don't use state and don't bind methods? \n. Maybe could link directly to their React page\n. Nit:\n\nPropTypes is only checked in development mode.\n\nMaybe say propTypes here? I'd like us to consistently use either React.PropTypes when talking about validators, or propTypes when talking about the field name, so that people don't attempt to define PropTypes pascal case property.\n. This section feels disconnected to propTypes. If it's intentional, let's specifically explain how propTypes interact with defaultTypes? (propTypes checks run on element after default props are resolved.)\n. Can we put the component name here please?\nYou should be able to do something like:\njs\nvar type = this._currentElement.type;\nvar name = type.displayName || type.name || 'A component';\nwarning(\n  false,\n  '%s is using shady DOM. (...)',\n  name\n);\n. This would need corresponding tests for a class, an old-style (React.createClass) component to make sure the message is correct.\n. Can we add this to React DOM documentation page?\n. Can we say \"all popular browsers\"? I don't think IE8 is popular at this point.\n. Maybe make this section last? Now it looks like APIs like render() are grouped under it.\n. It would be nice to have a proper reference on them.\n. owner might be missing so we should check that it's there first.\nowner && owner.getName() || 'A component should probably work, can you check other similar places?\n. It's fine to not put newline here.\n. Nit: this is not a container per se, it's just a DOM node. We call the topmost DOM node \"container\" because it contains the whole React app. Let's rename this to node. \n. Just render <div />, we are not passing any props here. \n. This should also include React.PureComponent (new in 15.3.0). It is exactly like React.Component but implements shouldComponentUpdate() with a shallow comparison. It is equivalent to a class with PureRenderMixin (as existing docs describe). \n. Maybe note the separation here too? \"If you don't use ES6 classes, you may use this helper instead\" or something. Right now they appear grouped together as if they are equally useful. \n. Can this be \"Transforming Elements\" or something? Both these APIs deal with elements and children. \n. I'd like to see typechecking at the bottom, not before createElement. While you don't use createElement in normal code it's best to understand what it is. PropTypes are the only API completely unrelated to everything else, and I think they should come last. \n. Can we add a section on importing here? We had a few sentences which you removed due to my complaint but I want them to be there, just more descriptive.\n\"If you use React as a script tag, these top-level APIs are available on the React global. If you use ES6 with npm, you can write import React from 'react'. If you use ES5 with npm, you can write var React = require('react').\"\nSame for all other top level exports like ReactDOM and ReactDOMServer. \n. \"a prop\"\n. \"a prop\"\n. \"a prop\"\n. \"a prop\"\n. Can we change here and below to \"Returns\" for consistency with \"Validates\"? \n. Please move forceUpdate() right below setState(). \n. There is a confusion here between properties available on an instance (props and state) and properties you need to set on the class (defaultProps, displayName). Can you please separate props and state together rather than have them mixed with class properties? Maybe group them as \"Instance Fields\" and group the rest as \"Class Fields\"?\n. This was fixed in #6613.\n. Fixed.\n. Done.\n. Can you please rephrase this comment? It's not clear what you mean exactly to a person new to this.\nA link to the issue would also be most helpful.\n. Done.\n. Sorry I should've been more clear. We should explain what it does (can reuse explanation from that page). We should not point people to a page about mixin because mixin are legacy, docs don't prominently mention them anymore, and people shouldn't have to know what they are to understand how and when to use PureComponent. \n. This page should be part of the addons docs. They're going to be grouped rather than top level, do I understand it right?\n. I don't think this is the case. Where is this information coming from? It was planned at some point but we backed out of implementing it.\n. Oh never mind, I get it now. Let's say \"prop updates\". It doesn't skip state changes in the tree below because it doesn't get asked about them. \n. Let's call this getElementTypeForWarning.\n. This makes it seem like these libraries offer an abstraction on top of context. However they don't: libraries you link to are independent of React.\nThere are React bindings for these libraries which happen to use context, but they are called differently (React Redux, mobx-react) and are in separate repos. \nThis paragraph also  makes it seem like passing data down is the primary responsibility of these libraries. But both Redux and MobX are much more opinionated about state handling in general. \n. In general I feel like not enough time is spent explaining that this is an experimental API and it is likely to break in the future. Unlike props it is likely you'll have to change every single component that he uses context when we change its API. \nAlso even though you describe how updates work they are just broken. The limitation in the last sentence is very severe because it is completely out of control of the components using context. So essentially you can consider updates to context broken, abd we should recommend treating it as unchanging because it's the only way to use it safely. You can still pass your own subscription system through it.\nThis is a really good article about it. I'm not sold on its conclusion (\"wrap everything with MobX\") because MobX wraps all native data structures into its own, and has its share of issues related to that, but the rest of the article highlights pitfalls of context very well:\nhttps://medium.com/@mweststrate/how-to-safely-use-react-context-b7e343eff076\n. Let's replace \"class\" with \"type\" here. \n. Can we use \"element\" instead of \"node\" here and below? While technically reconciliation also affects \"nodes\" (booleans and text), this article talks specifically about how we treat elements. It was written before modern terminology was introduced. \n. Nit: can we use className instead of id attribute? You'd almost never use id attribute in React, and one can potentially confuse it with key. \n. The first sentence in this paragraph is confusing. When did we decide that? I would try to merge some of the sentences about custom components in \"Different Node Types\" with this section, maybe by moving them and the associated example here.\n. Also I don't think {} is an operator. You can say \"You can build collections of elements and include them in JSX with curly braces, just like you normally embed values in it.\"  And you could link to \"Introducing JSX\" there. \n. We went with using const for non changing data so let's do so consistently. \n. This example, if ran as is, will print a warning about missing keys. Since this is the first section people might think that keys are optional. Can we either add keys here or mention that this example is incomplete and that they need to read the next section?\n. Yes. We should explain clearly that you must always supply keys. If items never reorder you may use their index. Otherwise use a string representing identity of the data item you are rendering. Mention that keys must only be unique among their siblings. \n. Can we just use functional components here like in earlier guides? There is no use of state or lifecycle methods so I don't quite see why classes are necessary. \n. I think this is not a very good example because people's names are not unique. Maybe could use login or account ID?\n. We shouldn't make it seem like keys are optional. React will complain loudly when you don't specify them. They are not just an optimization. \n. I feel like starting with HTML is confusing here. React users almost never have to deal with HTML. Maybe say \"DOM structure\"?\nAlso, I'm worried this looks like code the user needs to write. We previously used code snippets to show JSX, and suddenly we jump to HTML representation without a preceding JSX code example. \n. I don't understand this part. React doesn't hide DOM nodes. If they key is removed, so is the DOM node. \nThe only reason keys exist is to establish identity of the same element across renders to track re-ordering. There is no special handling of keys later. \n. I want to make separation between components and elements clear. I tried to do this in all existing guides so far.\nComponents are classes or functions you define. Elements are things like <Foo /> that describe what you want to see on the screen.\nIn this example variables store elements, not components. \n. Can you please make this a stateful component, read isLoggedIn from state, and toggle it on click? Otherwise it's not clear where that variable is coming from.\n. This should explain how to get production build in different environments. \"Downloads\" page doesn't do this now.\n- For Create React App, you need to run npm run build and follow the instructions.\n- For single-file builds, we offer .min.js\n- For Browserify, you need to run it with NODE_ENV=production, and it will envify React\n- For Webpack, you need to add this to plugins in your production config:\njs\n  new webpack.DefinePlugin({\n    'process.env': {\n      NODE_ENV: JSON.stringify('production')\n    }\n  }),\n  new webpack.optimize.UglifyJsPlugin()\n. Let's not use \"virtual DOM\" here.\nAlso let's remove some of the DOM slowness scaremongering because it's really not that bad these days. \ud83d\ude04 \nHere's an alternative:\n\nReact builds and maintains an internal representation of the rendered UI. It includes the React elements you return from your components. This representation lets React avoid creating DOM nodes and accessing existing ones beyond necessity, as that can be slower than operations on JavaScript objects. Sometimes it is referred to as \"virtual DOM\", but it works the same way on React Native.\nWhen a component's props or state change, React decides whether an actual DOM update is necessary by comparing the newly returned element with the previously rendered one. When they are not equal, React will update the DOM.\n. This is not accurate. Returning false from shouldComponentUpdate() does not just skip the DOM update. It skips the whole rendering process, including calling render() on this component and below. Let's be clear about that: DOM updates are often not the bottleneck, code in components below is.\n. This is a good place to introduce PureComponent. We should not encourage people to write their own shouldComponentUpdate implementations most of the time.\n. Can we frame it as \"One of the possible solutions\"? There are many non-trivial pitfalls associated with Immutable.js, and also many cases where you can use it incorrectly and make the performance worse.\n\nI agree we should promote immutability, but I'd rather have this section focused on treating regular JS structures (object and array) as immutable. For example, show ES6 array spread operator, and then mention object spread proposal.\nLike the content of these lessons:\n- https://egghead.io/lessons/javascript-redux-avoiding-array-mutations-with-concat-slice-and-spread?course=getting-started-with-redux\n- https://egghead.io/lessons/javascript-redux-avoiding-object-mutations-with-object-assign-and-spread?course=getting-started-with-redux\nThen we could mention Immutable.js at the bottom as a solution for making deep updates nice, and mention seamless-immutable and immutability-helper as alternative solutions if you don't want to use Immutable.js.\n. \"whether the virtual DOMs were equivalent\" -> \"whether the rendered DOM elements were equivalent\".\n. Since shouldComponentUpdate returned false for the subtree rooted at C2, React did not attempt to render C2, and thus didn't even have to invoke shouldComponentUpdate on C4 and C5.\n. For C6 shouldComponentUpdate returned true, and since the rendered DOM elements weren't equivalent React had to update the DOM.\n. React had to render this component, but since the DOM elements it returned were equal to the previously rendered ones, it didn't have to update the DOM.\n. For C8, it bailed out by comparing the rendered DOM elements, and for C2's subtree and C7, it didn't even have to compare the elements as we bailed out on shouldComponentUpdate, and render was not called.\n. and unmounted.\n. This encourages defensive programming, doesn't it? We know that it is always guaranteed to be mounted because input is rendered together with button. We'd need this check if input was conditionally rendered but it seems unnecessary here.\n. It is worth noting here that React will pass the DOM element when it mounts, and pass null when the input unmounts.\n. As an exception, let's use focus here as the method name. It's not very consistent with how we normally use events, but it will make more sense in the second example. We won't have to say anything about \"simulating\" a click, and will just suggest \"focusing\" an input by calling focus().\n. Let's say\n\nYou may not use the ref attribute on functional components because they don't have instances.\n. Can we mention this also works inside functional components?\n\n``` js\nfunction CustomTextInput(props) {\n  let textInput;\nfunction handleClick() {\n    textInput.focus();\n  }\nreturn (\n    \n textInput = input} />\n      \n\n  );\n}\n``\n. If we change method name tofocus()` it could be like\n``` js\nclass AutoFocusInput extends React.Component {\n  componentDidMount() {\n    this.textInput.focus();\n  }\nrender() {\n    return  this.textInput = input} />\n  }\n}\n``\n. Let's write this asremoveDOMNode,insertDOMNode`. That's exactly the confusion I'm talking about. We are comparing elements but result operations happen on DOM nodes.\nI'm not even sure this style of explaining it works very well. We don't use this notation of \"produced operations\" anywhere else. I would personally write it as sentences: \"For example, if we first render a <div /> but later render a <span /> at the same spot, React DOM will remove the div DOM node and replace it with a newly created span DOM node.\" Same below. \n. This is not quite what I meant. \nCan we reorder cases and merge them?\nI would like to see:\n1. DOM Elements. First explain that if type differs they are replaced. Then explain how updates are applied if type is same.\n2. Component Elements. First explain that if type differs old one is unmounted and new one is mounted. Then explain how componentWillReceiveProps is called if type is the same.\nThere is no need to mention custom components in section on DOM, and there is no need to have three sections. Two is enough and they should be symmetrical. \n. (I don't have a strong opinion about this. If you're happy with notation keep it, but please make operation names unambiguously refer to DOM nodes)\n. Do we also need to change this in nav bar?\n. Nit: please end all lines with semicolons. \n. This should also include importing from UMD bundle. I think it's available on React.addons but I'm not sure under which name. And that only works with react-with-addons.js. \n. Let's add a note that this is legacy and we recommend https://github.com/kolodny/immutability-helper instead. \n. It is not deprecated but legacy. This is an important distinction because deprecated APIs get killed in next version but legacy APIs live on, even if discouraged. \n. Current website is accurate about all deprecations so you can use that as a reference. We are adding some new legacy things (like this) in this pass but let's be careful to not add any deprecations to docs. \n. Same applies to all other files. \n. I find it somewhat dubious. This might have been true when this page was written but since then, TestUtils added shallow rendering, and it's much more widely used. Can we bring shallow rendering to the top instead?\n. It is used for testing in myriad of apps at this point and I would not call it experimental. Yes, it has some rough edges but it works fairly well. \nI would mention Enzyme here again and direct people to its shallow() doc. Enzyme provides nicer API for shallow rendering. \n. Or a function. I would avoid this list of things here and just say \"if instance is a user-defined component, such as a class or a function\". \n. Why do we call it ReactLink if addon is called LinkedStateMixin?\n. This is not the case. We support reading them from React.addons when you use react-with-addons.js. \n. PureRenderMixin is legacy, not deprecated. \n. Pitfall: this won't work because state => { ... } won't return anything.\nYou want to use state => ({ ... })  instead which produces an object expression.\n. Same here\n. Very nice update, thanks \ud83d\udc4d \n. Nit: \"The React framework\" -> React\n. > React first converts the root element, and then recurses.\nSince there is no \"conversion\" taking place, maybe say something like:\n\nWhen the root elements have the same type, React just updates component's props or DOM attributes, and then recurses.\n\nWe can be vague about where how these props are updated because we explain it in detail later.\n. Let's add a section in the beginning that React will destroy the old DOM node and create a new one if their types don't match. For example, <span> is replaced with a <button>. Any components below also get unmounted, and their state is destroyed. For example, replacing <div><Counter /></div> with <span><Counter /></span> will reset Counter's state and re-mount it.\nAfter that, we explain what happens if type is the same.\n. Similarly, let's first add a section that describes what happens when types are different. The old one receives componentWillUnmount() and the whole tree is destroyed, the next one receives componentWillMount() and componentDidMount(). The state associated with the old one gets lost.\nThen explain what happens during an update.\n\nReact takes all the attributes from the new component element and calls componentWillReceiveProps() and componentWillUpdate() on the previous one.\n\nThis is incorrect, lifecycle methods don't live on an element. Element is just a plain object description (<Foo /> or { type: Foo }), there are no methods on it. React doesn't call any methods on elements.\nIf you define component as a class, React internally maintains its instance. This is the one that has all the methods and has this.props. Functional components don't have instances.\nWhen React sees that App component returned <Foo prop={42} /> (or { type: Foo, props: { prop: 42 } }) from render() the first time, it creates an instance of Foo and assigns its this.props by reading them from the <Foo prop={42} /> element.\nIf App component returns <Foo prop={43} /> the next time, React will know that a Foo instance already exists, corresponding to the previous element \"on the same spot\". So instead of recreating the instance, it will update its this.props to point to new element's props ({ prop: 42 }), and call componentWillReceiveProps() on it.\nElements and instances are different things. Elements describe the UI. They are short-lived and immutable. Instances are things that React creates to represent \"stable\" pieces of UI and hold state associated with them. Over its lifetime, and instance can \"receive\" several elements as it gets updated. React will not destroy the instance as long as the parent component keeps returning an element with the same type (and key) at the same spot.\n(I don't ask that you write all of this, but I hope this helps figuring out how to phrase it correctly.)\n. Nit: can we use ul and li for this example?\n. It is not quite optional when you render an array because React loudly warns you about missing key.\n. Maybe add something like \"Now React knows that an element with 2014 is the newly inserted one, but elements with keys of 2015 and 2016 just moved.\"\n. Let's make keys strings so it's obvious they are supposed to be strings.\n. Maybe add \"As a last resort, you can pass item's index in the array as a key. This can work well if the items are never re-ordered, but reorders will be slow.\"\n. Nit: backtick Math.random()\n. No, cloneWithProps is deprecated.\nYou can check this on the current website:\nhttps://facebook.github.io/react/docs/clone-with-props.html\n\nSome addons are deprecated. Official website is always correct about those so please use it as a reference.\nThere are a few we are marking as \"legacy\" in this pass, but currently deprecated addons stay deprecated.\n\"Deprecated\" is more severe than \"legacy\"\n. No, this has not been supported for a while, and won't work. There is no react/addons package now.\nYou should either use react-addons-* packages from npm, or React.addons global in react-with-addons.js build. There are no other options.\n. No, it is deprecated.\nSorry I wasn't clear, but you should use the current website to tell if something is deprecated or not:\n\nhttps://facebook.github.io/react/docs/two-way-binding-helpers.html\n. Maybe add \"It provides a nicer higher-level API over the same functionality.\"\n. This is correct.\n. Actually let's remove this page completely. It has been deprecated and loudly warned for more than a year, and it's not even included in React 15. We can add a small box to React.cloneElement() doc mentioning that in the past, a similar function was called cloneWithProps(), but it was removed.\n. Please don't use apostrophes around package names. These should be backticks. You can omit backticks on the link\u2014whatever looks better to you.\n\nupdate is a legacy add-on. Use immutability-helper instead.\n. Please update all import examples to look like this:\n\njs\nimport update from 'react-addons-update'; // ES6\nvar update = require('react-addons-update'); // ES5 with npm\nvar update = React.addons.update; // ES5 with react-with-addons.js\n. It used to be simple to find all APIs related to shallow rendering:\n\n. This doesn't explain why it exists, and how it is similar or different. Even though the previous style didn't properly divide methods in the reference, it was clear that they are part of a single story, so it was more obvious that you should read on for an example. Now they appear isolated, and don't make enough sense on their own.\n. I feel like this example should actually be the first thing user sees about shallow rendering, before method-by-method reference. Then it's clearer what those methods are about.\n. Please don't use apostrophes for package titles. Please use backticks:\n\nLinkedStateMixin is a legacy add-on. The recommendation is to explicitly set the value and change handler, instead of using LinkedStateMixin.\n. js\nimport LinkedStateMixin from 'react-addons-linked-state-mixin' // ES6\nvar LinkedStateMixin = require('react-addons-linked-state-mixin') // ES5 with npm\nvar LinkedStateMixin = React.addons.LinkedStateMixin; // ES5 with react-with-addons.js\n. This line is correct.\nLet's remove the section above it about react/addons because it's wrong.\n. cloneWithProps() is not legacy but deprecated (and in fact let's remove it because it doesn't exist in API anymore)\n. LinkedStateMixin is not legacy but deprecated.\n. We need to explain this only works if you use react-with-addons.js. People don't know what React with Addons is. This can be solved by making it a link.\n. Can we sort them by increasing \"legacyness\"?\n- Performance Tools\n- Test Utilities\n- Animation\n- Shallow Compare\n- Keyed Fragments\n- Immutability Helpers\n- PureRenderMixin\n- Two-way Binding Helpers\n\nWe can completely remove Cloning Elements because it's been removed.\n. js\nimport ReactCSSTransitionGroup from 'react-addons-css-transition-group' // ES6\nvar ReactCSSTransitionGroup = require('react-addons-css-transition-group') // ES5 with npm\nvar ReactCSSTransitionGroup = React.addons.CSSTransitionGroup; // ES5 with react-with-addons.js\n. js\nimport ReactTransitionGroup from 'react-addons-transition-group' // ES6\nvar ReactTransitionGroup = require('react-addons-transition-group') // ES5 with npm\nvar ReactTransitionGroup = React.addons.TransitionGroup; // ES5 with react-with-addons.js\n. Please use two spaces for indentation everywhere.\n. Please use two spaces for indentation.\n. js\nimport createFragment from 'react-addons-create-fragment' // ES6\nvar createFragment = require('react-addons-create-fragment') // ES5 with npm\nvar createFragment = React.addons.createFragment; // ES5 with react-with-addons.js\n. js\nimport Perf from 'react-addons-perf' // ES6\nvar Perf = require('react-addons-perf') // ES5 with npm\nvar Perf = React.addons.Perf; // ES5 with react-with-addons.js\n. Please don't use apostrophes for package names. Also let's use the addon name (PureRenderMixin) rather than the package name (react-addons-pure-render-mixin) in warnings. It's the addon that is legacy, not just an npm package.\n\nPureRenderMixin is a legacy add-on. Use React.PureComponent instead.\n. js\nimport PureRenderMixin from 'react-addons-pure-render-mixin' // ES6\nvar PureRenderMixin = require('react-addons-pure-render-mixin') // ES5 with npm\nvar PureRenderMixin = React.addons.PureRenderMixin; // ES5 with react-with-addons.js\n. js\nimport shallowCompare from 'react-addons-shallow-compare' // ES6\nvar shallowCompare = require('react-addons-shallow-compare') // ES5 with npm\nvar shallowCompare = React.addons.shallowCompare; // ES5 with react-with-addons.js\n. Let's also mark this as a legacy (not deprecated) addon and tell people to use PureComponent instead.\n. js\nimport ReactTestUtils from 'react-addons-test-utils' // ES6\nvar ReactTestUtils = require('react-addons-test-utils') // ES5\nvar ReactTestUtils = React.addons.TestUtils; // ES5 with react-with-addons.js\n. Please don't put package names in apostrophes. Please use addon name rather than package name in warnings.\nLinkedStateMixin is a deprecated add-on. The recommendation is to explicitly set the value and change handler, instead of using LinkedStateMixin.\n. js\nimport LinkedStateMixin from 'react-addons-linked-state-mixin' // ES6\nvar LinkedStateMixin = require('react-addons-linked-state-mixin') // ES5 with npm\nvar LinkedStateMixin = React.addons.LinkedStateMixin; // ES5 with react-with-addons.js\n. LinkedStateMixin. There is no ReactLink in public API, it's a completely internal name (no idea how it got here \ud83d\ude04 ).\n. Sorry I wasn't clear. I didn't mean that all deprecated addons are legacy. I meant that \"deprecated\" and \"legacy\" are two different terms, and something is only \"deprecated\" when the current website says so.\n. Oops, reviewed it twice \ud83d\ude22 \n. With this change, they are mixed together with all the other top-level APIs. For example, it seems like getRenderOutput() is a top-level export rather than a method on the object returned by createRenderer().\n\nI think we should group shallow rendering APIs separately in the reference, and make it clear from the titles that render() and getRenderOutput() are parts of createRenderer() rather than independent methods.\n. No, handlers can't execute after unmounting so it should be safe.\n. It's for clearing resources. This ensures you don't have stale references to dead things, and also helps to know when to perform clean up, e.g. if you \"steal\" a ref while cloning an element to add a non-React event handler and want to know when to tear it down. It's a bit of an exotic use case though. More importantly it's just avoiding stale references to dead stuff (which prevents garbage collection). For example child may unmount but parent may still be there.\n. Nit: can unbacktick props? We normally use them as a word in sentences. We can link them to \"components and props\" guide.\n. this.focus = this.focus.bind(this);\n. ={this.focus}\n. > For example, if your render function refers to this.props.foo.bar or this.state.qux.quux, you should not use React.PureComponent.\nThis is incorrect. You can refer to this.props.foo.bar or this.state.qux.quux in render just fine and still use PureComponent as long as you treat this.props.foo and this.state.qux as immutable. (This doesn't mean you need to use Immutable.js.) We can refer here to the section below that explains immutability.\n. > If you create functions or child components in your render function, PureComponent will never short-circuit rendering, since those functions or child components will always be different. You can often avoid this by creating these once during component creation rather than on every render.\nI think this is a bit confusing and should be the other way around:\n\nIf your component accepts functions or React elements as props, PureComponent will never short-circuit rendering, since those functions or elements will usually be different on every render. You can often avoid this by creating them once rather than on every render. For example, if you bind class methods in the constructor, they will be the same on every render, so any time you pass them down to a PureComponent as props, it will be able to benefit from the optimization.\n. I can see now how \"DOM elements\" can seem confusing. Can we change it to \"React elements\" just in this section? Sorry \ud83d\ude04 \n. This is incorrect. We don't know for sure if it works or not because we haven't see the code rendering ListOfWords. If this.props.words is never mutated, it's fine. I understand you explain it later, but the user might stop reading at this section and memorize the wrong rule of thumb.\n. Let's add a second component that uses setState with mutation. This will explain why this paragraph is wrong, and then will allow us to show how to use setState without mutation in next section.\n. Let's show how this looks together with setState from a parent component.\nOtherwise people will write this.state.words = [...this.state.words, 'delta'].\n. We should probably link to https://github.com/sebmarkbage/ecmascript-rest-spread instead?\n. There is no react/addons, it doesn't exist.\n\nIf you use npm (no matter, ES5 or ES6), you have to use individual react-addons-* packages.\nThere is just no single place for all addons on npm.\nMaybe it's easier to show this on a specific example like Perf.\n. Minor nit, but // ... won' work inside a JSX tag. It will just be displayed as text.\nI think the original text used ... just to make it explicit.\nAlternatively you could use a real comment although it might look weird: {/* ... */}.\n. Let's completely remove ES6 example below because it is irrelevant now that we have PureComponent.\n. Can you please add a note here that shallowCompare is considered legacy (not deprecated), and that we also recommend PureComponent instead?\n. Maybe:\n\nBefore React.PureComponent was introduced, shallowCompare was commonly used to achieve the same functionality as PureRenderMixin while using ES6 classes with React.\n. > You can think of this as a \"place\" to render the component you're testing, where it can respond to events and update itself.\n\nAFAIK it can't. Shallow rendering doesn't use event system.\nI would just leave\n\nYou can think of this as a \"place\" to render the component you're testing, and from which you can extract the component's output.\n. Typo: shaowRenderer\n. I would write:\nshadowRenderer.render() is similar to ReactDOM.render() but it doesn't require DOM and only renders a single level deep. This means you can test components in isolated from how their children are implemented.\n. Just to double check\u2014do these links work locally? I haven't tried, but I didn't see . notation in Jekyll link IDs before. If they work locally then \ud83d\udc4d \n. Let's move shallowCompare to legacy too and suggest PureComponent instead.\n. Maybe add a note here that if you use npm, they will never be on React.addons. It only exists in the react-with-addons.js single file build.\n. This is looking good but let's be consistent in using setState() functional form when we depend on previous value.\n\njs\nthis.setState(prevState => ({\n  words: prevState.words.concat(['marklar'])\n}));\n. js\nthis.setState(prevState => ({\n  words: [...prevState.words, 'marklar']\n}));\n. The example below is unrelated to object spread. It's about arrays, and array spread is already part of ES6.\nWe'd need a separate example for object spread. Usually I do two sections, one on arrays (concat and [...]), and one on objects (Object.assign() and experimental {...}). When using Object.assign() you'd need to mention it requires a polyfill and direct people to MDN.\n. No, this is only necessary inside JSX tags. Outside JSX tags, please use regular comments.\n. Same here.\n. Please end lines with semicolons everywhere.\n. Move what out? Yeah I'd like to make this less ambiguous but I don't see what you propose yet.\nI want to \"retry mounting but without calling the hook\". Do you propose to extract everything except calling the hook in another method, and then calling that method specifically from the \"retry\" path?\n. Ooh good catch. (See what I did there?)\n. Can we use consistent link format? I'm all for using  for new tab but then we need to fix all other docs and make sure the link text is also the same. \n. Can we use consistent link format? I'm all for using  for new tab but then we need to fix all other docs and make sure the link text is also the same. \n. Sorry for duplicate comments. GitHub doesn't show my comments on older threads.\nCan we use consistent link format? I'm all for using  for new tab but then we need to fix all other docs and make sure the link text is also the same. \n. Can you please make map link to Array.map on MDN?\nhttps://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map\n. It's not obvious that this returns an array but this is crucial to understanding.\nCan we make it \nconst numbers = ...\nconst doubled = ...\nOr similar?\n. Let's make \"elements\" a link to \"rendering elements\"?\n. Oh, I see you link to map here. I would probably link in both places.\n. Can you please write this as functional component instead? It doesn't use state or lifecycle so it doesn't need to be a class. You can find examples of functional components in \"components and props\" guide. \n. I feel like this is confusing because it combines three absolutely separate changes:\n1. Add key to silence the warning\n2. Extract a component\n3. Convert a component to functional\nI think only (1) is essential to this example.\n(2) could be done but as a separate step later to show that key doesn't \"travel\" with <li> and should stay inside map. That's a common confusion.\n(3) won't be necessary if you use functional component in the first place. \n. This would really benefit from the same two-liner\nconst numbers = ...\nconst listItems = ...\n. I'm worried our very first example uses index as a key. In most apps this is not what you want to do for dynamic data. \n. People will read \"unique\" as \"use Math.random()\" or as \"globally unique throughout the application\".\nPeople also unfortunately don't know what \"identity\" is. \n. I think it's easier to explain the opposite: that it's fine to have the same keys in different arrays of elements. \n. Can we not use HTML in this document? It is irrelevant to React users and a bit confusing. \n. This is just not true, as I mentioned in earlier review. React does not do such a thing.\n. I don't understand this section at all. I'll be happy to chat about using keys and their implications but I don't think it's a correct explanation, and I also think using HTML distracts more than helps here. \n. \"We have a stateful component named LoginControl\"\nWhen we talk about component definitions let's not use tag syntax. It should only be used when we talk about elements. \n. Please use onClick as prop name. \n. Same here. \n. Please put a single newline between component definitions. \n. Please end lines with semicolons. \n. Please remove comma before }. It is not needed on single line. \n. Can you also start this section with a couple of two-liners?\nWe'd compare how we use if in JavaScript and how we use it with elements in the same way.\nOnly then jump into a bigger example. \n. Please use let here, not var.\nPlease call the variable just \"button\". \n. React actually has a feature like this (you can return null from render) but this is not what you are describing. \"Return null\" means you actually return null. This is not what you are showing in the example. There, you include null instead of one of the children in the rendered output. Can you rephrase to make it clearer?\n. toggleText should not be in state. As mentioned in \"Lifting State Up\", state should be minimal. Everything that can be computed from it in render should be. This is why showWarning is enough, and toggleText should be calculated in render from it. \n. This form is incorrect. As mentioned in \"Lifecycle and State\", if state depends on previous state, you need to use the functional form of setState.\njs\nthis.setState(prevState => ({\n  showWarning: !prevState.showWarning\n}));\n. Can you please split this into three lines for readability?\n. \"collections of elements\", not components.\n\"Rendering Multiple Components\" is fine because you get components as a result, but whenever we talk about manipulating JSX we always talk about the elements. \n. Can we skip \"using {}\" in the title? \n. This example will print React key warnings. It also gives a false impression that you would often write render this way (in practice I almost never saw push() usage in render).\nAnother confusing thing about it is it seems like a \"special case\" because it is separated from other sections but it is showing exact same technique as we used before: embedding arrays of elements.\nInstead of a separate section I would make it a first step in the \"loops\" section.\nFirst loops should show\nconst numbers = ...\nconst doubled = ...\nThe it should show \nconst numbers = ...\nconst listItems = numbers.map(...)\nReactDOM.render(<ul>{listItems}</ul>, ...)\nThen it should show component:\n```\nfunction NumberList(props) {\n  const numbers = props.numbers\n  const listItems = numbers.map(...)\n  return {listItems}\n}\nconst numbers = ...\nReactDOM.render(<NumberList numbers={...}, ...)\n```\nAnd only then show the \"inline\" notation\nfunction NumberList(props) {\n  const numbers = props.numbers\n  return (\n    <ul>\n      {numbers.map(...)}\n    </ul>\n  )\n}\nThis way we do exactly single step every time, and it's easy to keep track of what's changing and at the same time understand that it's just JavaScript.\nAs final step you could extract a Number component and use that to demonstrate key stays inside map. \n. Please remove extra parens and add whitespace before and after ? and : \n. Do we have any place in new docs where controlled vs uncontrolled is explained?\n. Gotcha: except if you use web components.\nAlso, the real reason is just historical. These days it being reserved word doesn't matter and many libraries use class for the same purpose without any issues.\nSo maybe it's fine to just punt on explaining instead of blaming JavaScript.\n. Let's also mention the result must have __html field for extra explicitness? Otherwise it's not clear what it means. \n. It's not quite optional. React loudly complains if it is missing.\nGiving it a key just means component gets reordered efficiently. It does not determine whether it \"stays\". \n. Can we group key, ref and put them at the beginning?\nThey have completely different semantics and are handled by React itself. They also work on custom components unlike any other attributes here. \n. It's confusing why warning exists then. Maybe mention \"by projects like Draft.js that manage contentEditable manually\"\n. Maybe also good to mention defaultValue and defaultChecked as their uncontrolled equivalents?\n. This is incorrect. The list below is the list of SVG elements for which we have shortcuts in discouraged React.DOM factories.\nHowever if you use JSX (of if you pass strings to createElement and avoid React.DOM factories), all SVG elements are supported out of the box. There is no whitelist for them.\n. English nit: comma before but is not necessary? (I'm not actually a native speaker so correct me if I'm wrong.)\n. https://github.com/facebook/jest/issues/1772#issuecomment-254279433\n. \"Most React elements\" is a bit weird.\nMaybe:\n\nTo specify CSS class, use the className attribute. This applies to all regular DOM and SVG elements like <div>, <a>, and others. \nIf you use React with Web Components (which is uncommon), pass class instead.\n. Missing space before \"to remind\"\n. Can we have two separate examples here? One should be simple and show basic style usage. The second can be preceded by \"Note that styles are not autoprefixed. To support older browsers, you need to supply corresponding style properties.\"\n. I don't see display: \"none\" mentioned on that page.\n\nIt says:\n\nInstead, React will reconcile the DOM by changing the text content of the first child and destroying the last child. React reconciles according to the order of the children.\n\nThis is why not specifying keys is problematic. If items 2 and 1 reorder, React will naively try to update item 1 to say \"Item 2\", and item 2 to say \"Item 1\". With keys, React knows it's a reorder and doesn't need to update either DOM node. \nRemovals are similar. Without keys, removing item 1 will cause React to update item 1 to say \"Item 2\" and remove item 2. However with keys, React will just remove item 2.\nDoes this help?\n. \"to efficiently convert the first tree into the second tree\" makes it sound like React mutates the tree you provide to it. Maybe \"how to efficiently update the UI to match the most recent tree\".\n. Maybe replace \"can be treated as...\" with \"will likely produce different trees\".\n. Mention an example? Like, from <div> to <img>, or from <Article> to <Comment>, or from <Button> to <p>. \n. Proposal: let's say \"DOM node\" in this document when we refer to browser DOM node. This will help remove some ambiguity with the \"element\" word which we'll use for React elements.\n. (This would still be \"elements\" then)\n. ... but that would be \"underlying DOM node\"\n. Can we avoid words like \"converting\"? They imply React turns one element into another. But what React does is it compares two elements, and updates the underlying DOM node to match the most recent description (element).\nSo \"By comparing these two elements, React knows to only modify the className on the underlying DOM node.\"\n. \"React updates the props of the underlying component instance to match the new element, and calls <...> on the component instance.\"\n. Somebody who doesn't read next paragraph might just remember this line. Can we make it clearer it would have worse performance if we didn't have a good solution but we actually do?\n. The notation is weird. Let's just use string attributes here (=\"\") and then add a single line example with the words like \"Most often, the key would come from your data, such as an ID:\" (and the example does something like lib key={todo.id})\n. Nit: let's consistently capitalize ID\n. Class => Type\n. \"Many elements to be\" => \"many component instances and DOM nodes to be\"\n. That's not the kind of message we want to send. Web components are a sensitive topic. We want to say \"React users don't commonly use Web Components\", not \"Web Components aren't useful\". \n. FWIW the new reconciliation doc explains keys very well so we could skip details here and link to that \n. As soon as one-liners get a little crowdy it's best to add some whitespace\nstuff = numbers.map((item) =>\n  <li stuff>\n    {moreStuff}\n  </li>\n)\n. Same here, could\nrender(\n  <Stuff />,\n  stuff\n);\n. The problem is not that it's \"directly to an HTML element\". (This could actually be a component element too and the rule would still apply.)\nMaybe say \"Keys should be given to the elements inside the array because they give the elements a stable identity. If you extract a Number component, you should keep the key on the <Number /> elements in the array rather than on the root <li> element in the Number itself.\"\n. Maybe call them handleLoginClick and handleLogoutClick to match the most common convention \n. Nit: Preventing\n. Nit: space before self closing tag slash\n. \"Keys cannot be accessed as a prop\" => \"This is why keys are not props. They serve as a hint to React but they don't get passed to your components. If you need the same value in your component, pass it explicitly as a prop with a different name.\"\nAlso this section is not essential and could be mentioned below. \n. Maybe start as \"A component may also prevent its own rendering.\" \nIt's not quite clear when you'd use each pattern so I'm not sure if it's worth diving into this here at all. But it's good to have an example somewhere so might as well be here. \nBut I think a ternary should be explained first as it's a more common pattern. Or at least you should explain {someCondition && <Stuff />} first. It is way more common that parent decides which children to render, than a component decides to not render itself. \n. This is right. (I also was the person who put that DOMComponentTree thing into DOMOperations during ReactPerf rewrite because I was too lazy to pass debugID explicitly and now it's my time to pay for this.)\n. This is public API so I needed to use the \"public\" ReactElement definition provided by Flow. Otherwise tests in www fail.\n. The only change is adding _currentElement here.\n. Flow now errors on calling non-callables.\n. Yes, those methods are shared. mountComponent/receiveComponent/unmountComponent is the \"base\" component API, DOMComponent and CompositeComponent implement it in different ways.\n. \u00af_(\u30c4)_/\u00af\n. I don't understand either \ud83d\ude04 . But at least it passes.\n. Dead code or intentional comment?\n. Missing semicolon\n. Missing semicolon\n. Missing semicolon\n. Missing semicolon\n. Missing semicolon\n. Missing semicolon\n. Can we avoid double colon in title?\n. Same here.\n. Missing semicolon (and in above example too)\n. Please indent this by two more spaces.\n. Can avoid \"you need\" twice in on paragraph?\n. Please put newlines between declarations\n. Semicolons\n. Please no var, only const or let.\n. Note that && is regular JS operator, and this works because React ignores false/null in render output.\n. Please put spaces before and after ? and :\n. \"Preventing\" for title, not \"Prevent\", as it's a noun\n. Please don't use this style:\njs\n  if(!props.warn) return null;\nInstead:\njs\n  if (!props.warn) {\n    return null;\n  }\n. This has an unfortunate downside of hiding all (even unintentional) warnings.\nAn alternative to this would be to import ReactDOM but wrap the whole test suite into if (ReactDOMFeatureFlags.useFiber). I would probably prefer that with existing test infrastructure.\nAlternatively we can suppress the warning when process.env.NODE_ENV === 'test'.\n@sebmarkbage You have an opinion on this?\n. Shouldn't these two pages point to Installation instead?\nThey were about setting up build transforms, not about createClass().\n. If/else should link to \"Conditional Rendering\" instead. I added it as a separate guide in https://github.com/lacker/react/pull/2.\n. This is unfortunate. We don't have a good place for \"Fetching Data\", and we removed the only example we had about it.\n. So is this. Maybe let's make it link to ref doc instead.\n. I'm worried this might be linked to from StackOverflow, e.g. \"here's how to do AJAX in React\". Can't prove it tho.\n. These are just indentation changes + pass options.debugTool through to the reconciler.\n. Yes. \n. @aditya1994 What is missing in this implementation? I haven't had a proper chance to review yet, been busy with other things.\n. What is this comment referring to? You throw on missing pendingProps below. Copypaste?\n. Do you mean whether we should reassign this.props and this.state despite sCU returning false? Is there any reason not to?\n. Why were these removed? Every page in the \"Basic Guides\" has this links.\nCompare Lists and Keys (has these links):\n\nand Forms after this change (doesn't have these links anymore, why?):\n\n. I intentionally removed this subheader in the past.\nIf you add it, this is how the page looks:\n\nThe double heading is unnecessary. If you look at other pages, none of the guides have double headings.\n. I intentionally changed it to \"CodePen\" the last time because this is how the service is capitalized:\n\nWhat is the reason for changing it back?\n. Why do we remove the placeholder too? It is not related to controlled-ness of the components.\n. Same here: I intentionally changed it to CodePen before.\n. Same here: I intentionally changed it to CodePen before.\n. Same here: I intentionally changed it to CodePen before.\n. Same here: I intentionally changed it to CodePen before.\n. Same here: I intentionally changed it to CodePen before.\n. Both of these can be const, not let.\n. Please put space between if and the opening brace.\nPlease don't use includes(), it's a ES2016 API that is unsupported by any other than most recent browsers.\n. Can you please add line highlighting for the relevant lines in these examples? They're pretty long, and it would help to highlight whatever parts or properties that are being explained.\n. Isn't it controlled? The example is setting value on select.\n. This is not very readable. There is also a problem: clicking on the label doesn't select the option. This is not a very good UX.\nI also don't think name attribute is relevant in this example.\nWe should use <label> instead, like this:\njs\n        <label>\n          <input type=\"radio\" value=\"A\" onChange={this.handleChange} />\n          Option A\n        </label>\n. > When we commit, we've already swapped the tree so as far as Fiber is concerned, it is deleted in the \"current\" state.\nHmm, I think this is something I changed below:\njs\n        commitAllWork(workInProgress, isHandlingError);\n        // Swap the pointer after committing all work so that if committing fails,\n        // we still treat it as a work in progress in case there is an error boundary.\n        root.current = workInProgress;\nWithout changing it, Fiber complained that\n\nCannot commit the same tree as before. This is probably a bug related to the return field.\n\nwhenever I caught an error during commit phase (e.g. DidMount) and tried to get error boundary to re-render the whole thing.\nAlternatively I could \"roll the pointer back\" on error but I didn't want a try catch there.\nWhat should I do?\n. So it's the same problem as was solved by calledCompobentWillUnmount in the old reconciler.\nWe need to recover if we committed some unmounts, one of them failed, and we need to safely unmount the rest without repeating failed ones. \n. @briandeheus \nHave you addressed this comment?\n\nI think in my ideal world here, we would display in unknown when we have the location info (based on the element being constructed \u2013 this code can probably be reordered to call ReactElement.createElement first) and leave that line off and just show the parent if we don't (since in [unknown] is useless and we won't have any better display name since it isn't a string/function type).\n. I noticed the stack reconciler also passed the public instance as this into the callback.\nI found it weird but I guess we should do it here as well for feature parity.\n\nSee the test verifying it (it will fail due to missing unstable_batchedUpdates but you can temporarily comment it to check if a future fix works).\n. Should we also have a test verifying that if you queue two callbacks without flushing, and then flush once, both get called?\n. Missing semicolon.\n. This function won't get a name. We should make any functions calling user code named for better stack traces.\n. Never mind, I misunderstood. This doesn't call into user code.\n. This comment doesn't apply to the line below anymore. It used to refer to effectTag assignment which has been moved.\n. Style nit:\njs\nconst {callbackList} = instance;\n. Yea, totally. I was just copy pasting. \n. fetch should link to MDN.\n. Please leave the domain out of the links. Keep it as /react/docs/react-component.html#componentdidmount.\n. Nit: let's write it shorter,\njs\nconstructor(props) {\n  super(props);\n  this.state = {gists: []};\n}\n. Nit: let's not put a newline here.\n. Nit: let's put the JSX on next line.\njs\n{gists.map(gist =>\n  <p>...</p>\n)}\n. We should mention that this is a browser API but it requires a polyfill. Link to the polyfill. Mention that if you use Create React App, polyfill is already included.\n. What's here? I'd rather avoid ambiguous \"old stuff\" blocks.\n. We need to explain the key concept somewhere early. We need to hammer home the idea that in React, any update means a change in the state. It doesn't have any special capabilities for handling AJAX: if you want to change the UI as a result of data arriving, you need to change the state.\n. We should have the last section that shows the same with async/await I think. Async/await is enabled in Create React App by default.\n. If we put it here, \"refs and DOM\" will need its prev link changed.\n. It's all broken now :-) I'm just pushing to make myself feel better. I'll push the final version when it's ready.\n. I just moved them and grouped together below.\n. #courage.\nI embrace not understanding things now.\n. AFAIK having a variable switch between null and a number prevents some optimizations in V8. Can we use something like -1 for this?\n. You could stil keep the distinction in type system if you don't make it a part of the PriorityContext union and explicitly say PriorityContext | NoPriorityContext. Or something like it. \n. Do we try to avoid first class functions unless we're dealing with browser or user code? I'm not sure, just curious what @sebmarkbage wants. \n. Oh nice, we are fixing this?\n. Technically promises can't be \"cancelled\" so this might read confusing. Maybe \"the result of the first promise should be ignored\".\n. Same here, you can't cancel promises. Also it isn't strictly causing memory leaks, just unnecessary requests.\nMaybe:\n\nAdditionally, a component can unmount while a promise is pending. React warns you if you call setState() on unmounted components to prevent memory leaks. Some data fetching APIs allow you to cancel requests, and this is preferable when component unmounts. For APIs such as fetch() that don't offer a cancellation mechanism, you would need to keep track of whether component is mounted to avoid seeing warnings. Here is how we could implement this:\n\nThen show how to set this.isUnmounted = true; in componentWillUnmount() and change fetch() callback to exit if this flag is set or if current username in props doesn't match the one we were fetching. This would solve both caveats.\nAs a final example you could then show a more concise way of doing the same with a library that supports cancellation like axios.\n. I added it at first but then removed because wasn't sure :P. Do couroutines appear in a fully flushed tree? I still don't quite understand how they work. \n. I think we need to avoid instanceof checks because those don't work across iframes.\n. Let's consistently check for typeof instance.tag === 'number' for Fiber-ness everywhere. It may not seem to make as much sense in individual cases but it's easier to have the same check everywhere in case we change the field names later or something like this.\n. Let's just mark branches with // Stack reconciler and // Fiber reconciler, this is descriptive enough and easier to search for.\n. Same here\n. Can we avoid checking if we are resuming work and recreating the instance? Check should only be done once. \n. You probably want to check the fiber.tag instead. It is a number identifying the fiber type. You can find the types in ReactTypesOfWork. HostComponent is the one you're interested in.\n. Okay. \ud83d\ude1e \nCan we use this._hostContainerInfo for this instead? It's a thing that DOM renderer uses, for example, for DOM nesting validation. Both composite and host instances already store it so it's always available and passed all the way down. It is the fourth argument to ReactReconciler.mountComponent(), third argument to mountComponent() implementations, and I think it's currently null in the test renderer.\n. If we're changing Component internals may be better to do this before 15.4.0 which semi-separates classic stuff from reconciler.\n. Can we please not calculate these fields in production if we're not planning to print anything?\nIt's fine to extract this to getFriendlyName(inst) and only call this in __DEV__ branch and in both-dev-and-prod if () branch below when we're sure we'll print the error.\n. Can you please use invariant module for this? Otherwise the error text won't be automatically stripped out in production builds. \n. Nitpicking but let's read inst.state once?\n. Left a note for myself to check on this in https://github.com/facebook/react/issues/8181.\n. > Seems unnecessarily dangerous.\nWhy is it dangerous? It only applies to Noop as a way to keep scheduler stricter.\n\nIf the scheduler calls scheduleAnimationCallback and a callback is already scheduled, the renderer can just treat it as a noop.\n\nIt can, but why not enforce scheduler to be explicit instead? Currently ReactDOMFiber would just schedule many idle/animation callbacks if called multiple times. We could fix it there but it seems beneficial to do it in one place (scheduler). This also helps the scheduler because it knows for sure whether it's waiting for something or not, so it can act with more confidence. Also this is already how it works now (it doesn't schedule twice).\n. Yea, AFAIK ReactNoop isn't useful for anything else. (Is it?)\n. One could say flushAnimationPri(), flushDeferredPri() and getChildren() aren't public APIs either but we use them for testing (since they're the thing being tested). This seems similar to me. I could remove assertions about what is scheduled and what is not, but I think they're valuable because this is very easy to accidentally mess up. They serve as a documentation for current behavior.\n. AFAIK we don't use HighPriority anywhere and it's likely we'll switch to a deadline-based model and rename everything anyway. I could then rename \"lo-pri\" to \"late deadline\" and \"hi-pri\" to \"early deadline\".\nI don't care how to call these but I found it easier to write tests and think about their behavior when the adjectives are comparative (e.g. high and low vs animation and deferred).\nHappy to change either way, but again, I'm just assuming they'll change soon anyway.\n. I agree. This just makes the noop renderer more restrictive so that tests fail if scheduler misbehaves. Doesn't affect public renderer API.\n. > https://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactPriorityLevel.js#L21\nSorry, I meant that it is not used anywhere in the code or tests. It wasn't clear to me that it works, I thought it's just something added for the future when priority stuff is more fleshed out.\nOK, I'll change it back to animation. But we'll need to rename all of them in the future anyway.\n. All of this would make more sense when we treat them as deadlines instead.\nThis reverse <= is super confusing.\n. Just learned about this a week ago. This is the weirdest part of React API \ud83d\ude04 \n. I'm open to suggestions! It doesn't seem as bad to me because we're testing API for renderers by writing a custom renderer. That's different from messing with internal modules from an existing renderer.\n. Careful\n. Unless you consider it ready for 15.4.0 \ud83d\ude04 \n. This was just moved into another file.\n. I moved this one into a try/finally in performTaskWorkUnsafe so that it's only set there. \n. I know but we're completely moving this code around every week. I'm worried microoptimizations just make it hard to follow right now. Let's do a pass as soon as it stabilizes a little bit?\n. I want to continue working on the other roots in the same frame even if some failed, and only throw errors after all work is done (or frame is over). If I don't unschedule failed roots, findNextUnitOfWork will find them again, and we'll get into an infinite loop handling their errors again, then finding them again, and so on.\n. I also don't want to get errors about a root I rendered once every time I schedule an update to another unrelated root. So I need it to be gone from the list until I explicitly retry it. You can see the desired behavior in the last test I added.\n. How would I know which root to work on? I only know which roots not to work on.\n. \ud83d\udc4d Could you please?\n. When we do it, we should do it consistently IMO, not in an ad hoc way. Use a tryCatch helper like Bluebird or something like this.\n. > Would always force unmounting children in an error boundary help with this case?\nI'm not sure. Maybe let's come back to this after #8227?\n. Could you please add actual logic to handle the error? You can look for how we do this in ReactFiberCommitWork.js when calling lifecycle methods.\n. To clarify, my point wasn't that you need to return the error. Take a look at where that error goes:\njs\n          const error = tryCallComponentWillUnmount(instance);\n          if (error) {\n            trapError(current, error, true);\n          }\nAgain, you are swallowing the error. It gets ignored. This is not what we want.\nWe want to \"trap\" the error (check where trapError is coming from). Then we'll handle it. This code should do the same thing. Not just ignore the error but trap it.\n. Can we remove transaction as an argument here now? As well as not pass it wherever we currently do?\n. Nit: space before />\n. Same\n. Nit: no spaces in object literals, {createNodeMock}\n. Let's call this hostContainerInfo everywhere and get rid of options.\n. Doesn't it always exist in test renderer? We probably shouldn't check for its existence below as well.\n. I don't think this branch ever runs. We always use defaultTestOptions if options didn't exist, and it returns null rather than {}. I want to completely avoid conditions here.\n. Can you throw if it is null? I think this might make it clear to Flow that it's not null.\n. I'm not sure if this is a good way to tell that we're in a current tree. Any pitfalls?\n. Could you please use regular function syntax here, as we do elsewhere in the docs?\n. There is another Normal componentWillUnmount below right before the array ends.\nDoes this means we now call it twice? Doesn't seem right.\n. Same here. There's another Normal componentWillUnmount later.\n. This one is also duplicated: see BrokenComponentWillReceiveProps componentWillUnmount later in the array.\n. Does this call (or any commitUnmount() calls it makes) also need to be guarded by !ignoreTop?\nI don't fully understand what's happening here but it offers another path to commitUnmount().\n. Please bear with me as I don't fully understand this method yet.\nCan removeChild() below run more than once?\nIf it can, ignoreHostNode should be named ignoreHostNodes?\n. Similar question here. Why are we sure this is a \"top\" node? It isn't quite clear to me.\nIs there only one \"top\" node, or can this block run more than twice in a loop?\nIs there a better name for ignoreTop? I don't understand which fiber exactly would be called a \"top\" node.\n. Maybe it would be easier to understand if the comment emphasized when this happens (e.g. \"If node and current are different, it means X. When ignoreTop is set, it means Y. Therefore we do Z to implement this [scenario described from user's point of view].\")\n. Do we need to clear progressedChild?\n. Same question about progressedChild here.\n. Do we need to update root.current.alternate here?\n. What does this commit fix? Is there a test that was failing before? Is this a performance optimization?\n. Can you add a comment where you set shouldContinue to false explaining in which circumstances it will get set to true?\n. This is a new PR I extracted from \"should filter context properly in callbacks\". It covers the componentDidUpdate with nextContext which we punted on.\n. \ud83d\ude44 I meant test, not PR\n. I should probably do this after rendering. Otherwise context provider would likely see its own context. \n. First error it is.\n. Totally, and that's what we do everywhere else.\nI even left a comment about this \ud83d\ude04 \nhttps://github.com/facebook/react/pull/8242#discussion_r87699294\n. #8287\n. I tried but it was intentionally DEV-only at the time, and I need it for an invariant.\nIf we're ok increasing non-Fiber size with Fiber code before Fiber is ready, I could remove the DEV gate there.\n. This is not relevant now though, is it?\n. I don't think there's any reason for this, putting just current owner assignment in a condition would be equivalent. \n. Oops, you're right, thanks.\n. :+1:\n. To be clear we only want to use that flag in tests. Not in the implementation. \n. Let's say just \"Props\" in the header. Same for \"Children\" and \"State\".\n. Unintentional?\n. Removing this try/finally block seems responsible for some of the test failures.\nIf I add it back I get:\n``` diff\n--- a/scripts/fiber/tests-passing.txt\n+++ b/scripts/fiber/tests-passing.txt\n@@ -470,7 +470,6 @@ src/renderers/dom/tests/ReactDOMProduction-test.js\n * should use prod React\n * should handle a simple flow\n * should call lifecycle methods\n-* should throw with an error code in production\nsrc/renderers/dom/fiber/tests/ReactDOMFiber-test.js\n * should render strings as children\n@@ -1021,8 +1020,12 @@ src/renderers/shared/shared/event/eventPlugins/tests/ResponderEventPlugin-te\nsrc/renderers/shared/stack/reconciler/tests/ReactComponent-test.js\n * should throw when supplying a ref outside of render method\n- should support refs on owned components\n+ should warn when children are mutated during update\n * should not have refs on unmounted components\n+ should support new-style refs\n+ should support new-style refs with mixed-up owners\n+ should call refs at the correct time\n+ fires the callback after a component is rendered\nsrc/renderers/shared/stack/reconciler/tests/ReactComponentLifeCycle-test.js\n * should not reuse an instance when it has been unmounted\n@@ -1185,8 +1188,9 @@ src/renderers/shared/stack/reconciler/tests/ReactStatelessComponent-test.js\n * should update stateless component\n * should unmount stateless component\n * should pass context thru stateless component\n- should provide a null ref\n+ should use correct name in key warning\n * should support default props and prop types\n+* should receive context\n * should work with arrow functions\n * should allow simple functions to return null\n * should allow simple functions to return false\n``\n. Is this only true during unwinding? Can it be null in any other place in the code? We rely onstateNodeexisting on classes in a lot of places so I'm just trying to understand if something else could fail now.\n. This doesn't match behavior ofNoopBoundaryin other test file. Can we either rename this one toRethrowBoundary, or even rename both and change the other file's tests for rethrowing? That's what they were testing previously.\n. If you changeNoopBoundaryin this file to rethrow (and maybe rename it) then you won't need this condition. I would prefer that we have separate tests for \"noop\" and \"rethrow\" behavior now that they're different. It's fine to change most cases to test \"rethrow\" behavior (since that's what they were testing originally), and add one or two new tests for noop behavior (copy & paste + replace would be fine).\n. You shouldn't need--track-facts.. What is the plan to fix this test again?. No, it's fine as is. (Typeof can only have values specified by the JS language.). Let's throw if there are no matches.. This starter kit is missing. \ncc @zpao @tomocchino. Is this the right fix?\nhttps://github.com/sebmarkbage/react/pull/1. How could this be unified?. This would be handled byappendChildif the parent is already in the DOM.\n. Shouldn't this becurrent.stateNode === workInProgress.stateNode?\nI changed it, and tests still pass.\nIs this unobservable, or are we missing a test?. I get that we can't do this now because there is no equivalent of the progressedChild for thestateNode. Does this affect correctness, or does it just mean coroutines aren't as capable of reusing work? Is this comment actionable or can it be removed?. This one is from #8406 as is. I'd appreciate a comment here mentioning that this code is pretty much the same asreconcileChildren(), but operating onstateNode`.. Why does it hang without this change?. Technically didn't have to move this one but did this for consistency.\nCan move it back too.. I can omit this change if it's better to discuss separately.. Less cycles, isn't it? I'm not sure. Should I look into this?. We'd have to either get iterator function again inside of it, or pass it along. Both seemed a bit silly.. >this sometimes gets a false positive when I run the record-tests script with the ReactDOMFeatureFlag turned on locally\nYes, I'm sure it's the reason we've been getting false positives. (Had it many times and pinpointed to the same cause.)\nWe do need it to fix it. It should be failing in Fiber so I'm surprised it doesn't... Also, we already doing this in commitUpdate() before my PR. So I don't see why doing this during mounting is worse. (We should fix both?). Fixed.. Shame on me!. Let's pass when we need them?. Note: this fails on master too so it's not a regression.. Okay. I was doing that before but wasn't sure it's important. Is it because property access can be slow?. >It seems like something better suited for async/await documentation, since it's a pretty trivial example.\nNot sure what you mean by async/await documentation. Is this something we would write? Which example is trivial?\nI think that if we don't show async/await \"works\" inside components then many people won't realize that. I've seen many surprised reactions to async componentDidMount() because people think it's something React has to \"support\" as opposed to just being a language feature. So I think it's nice to provide at least a short section giving you enough clues to get started with using it.. Route changes is the easiest case, yes. Go forward, then go back, oops, the wrong thing has arrived.. Is there a reason you're not just checking the tag?. This doesn't feel right. Can we fix the unit tests relying on this instead. (I know I might've added some.)\nIn particular @sebmarkbage suggested killing flushDeferredPri and flushAnimationPri. Instead have flushWithCycles(n) that first flushes all animation work and then flushes N of deferred work.\nWe can do this as a followup but then let's turn this into a TODO.. Nit but it's easy to make mistakes with negated variable names. I would prefer something like hasUnmountedCleanly over noErrors.. What about errors in ref callbacks? Is this a good time to start handling them?. FB style nit: const {callbackList}.\nFiber code is not doing that consistently though so I don't care.. It looks like after this change, we don't call callbacks or attach refs if we fail in lifecycle. This seems good to me\u2014just want to confirm my understanding is right.. Can you extract this pattern to a boolean variable please? Double negation is hard to understand.. Are we referring to animation as \"deferred\" work now too?\nThis makes sense to me but it's not very consistent with other places (e.g. scheduleDeferredCallback).. Why has this become necessary?. Could you put it inside into a nested if or would that change semantics in this case?. Did you push another commit? I don't see it. . Oops. done. Because of the recursive case which gets us into commitDeletion().. I could probably inline it there if we know for sure that portal can never be tagged with a deletion effect (can it not? I don\u2019t understand that part well). The \"can render nested portals\" test definitely gets a commitDeletion() call from outside CommitWork with a portal. So inlining it is not enough.\nAlternatively we could figure out how to avoid tagging portals themselves with Deletion, and tag their children instead. Not sure if there's any benefit to this?. Because getHostParent gives us closest host parent in the other tree.. <div>{usePortal(<p />)}</div> will try to remove <p /> from <div> when unmounting the portal.. Hmm you're right, I don't understand this.\nWill think about it.. Apparently something is being deleted twice in some loop.. I'd need to know how many can I pop. If I make null the sentinel then I need to somehow forbid renderers from specifying something like string | null as type argument. Is this even possible with Flow?. Oh never mind, I see how this could work.. Because I imported our internal ReactElement definition that is not generic.. Yes. We'll also want to expose portals but I want to get to parity first.. If I add it to the Fiber how can I convince Flow it exists even if I don't set it in DEV? Do the coercion when returning?. https://github.com/facebook/react/pull/8545/files#diff-2f133c2cb49f0a3a514aa19bc6ac0e45R152 I guess. Nit: I think it's just \"uppercase\" and \"lowercase\", no hyphen.. Let's put case match check first? I expect it's going to be true more often.. Same as above regarding check order and hyphens.. I'd prefer > -1 here because we already compare to -1 in a few parts of the file.. Yes, a later commit fixes this. . My tentative plan is to figure out a way to get the tree hook working but I want to get the most important warnings (propTypes and keys) working by simpler means first. It gives me a better understanding of the problem to solve these separately (and maybe unify later) than try to unify right away.. I actually didn't need it anymore because I annotated fields themselves as optional. Fixed.. Thank you for explaining. I fixed this in 572465774d2c1c2cf06240bad5cce437ec446c31.. Okay, I'm just using ReactCurrentOwner for this now. Seems to work well so far.. Oops, this is not a good change. It would be expensive to always calculate it.. Hmm, didn't earlier test exclude Stack owner? if (typeof owner.tag !== 'number') {. Yep. Aiming for parity for now but we should really revisit them all.. If we do this I think we should handle HostComponent here too for consistency.\nIt also gets popped unconditionally in complete phase.\nThis defensive check is likely why it didn't break so far but we can replace it with an assertion.. No because this is the \"single child\" case in which we don't create an instance but use setTextContent.. One benefit of this is that we should be able to mount SVG content into an svg root now.\nCan add tests for this.. I should probably check that we're moving to having a non-reified child here instead of always running the check.. It was a bit easier to keep nesting checks in ReactDOMFiber than shoving them inside ReactDOMFiberComponent. As a result I'm dealing with rawProps rather than \"host props\" and validate them earlier than in Stack. I could have fixed this but it felt like the nesting check is already generic enough that we can just remove this special case. I could also remove it in Stack if needed.. This is the Stack-specific part extracted from main function.\nIn Fiber instances are null and we use the current element stack instead.. Also ^^^ the day I started saying \"reified\". What have you done to me.. IIRC you wanted something like this anyway.. Because we now always use this for the root instance.. Right. I thought I'd need them inside but then turned out I didn't. Will remove.. Good catch. It doesn't (in Stack neither), and this is a bug. Because that should be valid: https://jsfiddle.net/q7e61jpd/.. Today I learned. I don't care though\u2014it's tests. \ud83d\ude04 . Nit: we don't use \"composite\" in docs much, maybe \"user-defined\"?. Minor nit: could you read .current once? I don't know if compiler is smart enough to know it hasn't changed.. We should always use invariants but I didn't bother because we're going to do a separate pass to replace them all anyway. (It's in the umbrella.). Ah, I think you're right. I wonder why tests didn't catch this.. Note: the separation between ReactDOMFiber and ReactDOMFiberComponent is just an artifact of how it was forked from ReactDOMComponent and that we still want to keep them in sync when possible. So feel free to abandon that convention (e.g. see ReactNoop.js). Please destructure this from config earlier. We don't want to read that value every time. I think we could also make this required to keep contract strict. . Please return the same object (emptyObject like in ReactNoop) so it doesn't push stack unnecessarily. . This fails for non-string refs, right?. This is wrong I think. return will be parent, not owner. For example in <div><Foo /></div>, Foo's return is div.\nI think you should use ReactDebugCurrentFiber.getCurrentFiberOwnerName() instead. And in fact maybe you can use ReactDebugCurrentFiber.getCurrentFiberStackAddendum() to add a nice stack instead of \"see ref\". You could change this in Stack too by using ReactComponentTreeHook.getStackAddendumByID(this._debugID).. There is no test case because we silently give you null. It's bad though.\nI'd prefer we keep warning parity for now. So if we add it to Fiber we should also backport it to Stack. See https://github.com/facebook/react/pull/8635#issuecomment-269092380 for context.. Yep.. Let's change https://github.com/facebook/react/blob/master/src/renderers/shared/shared/tests/ReactStatelessComponent-test.js#L149 to put component in a div to make sure we're printing owner rather than parent name.. https://github.com/facebook/react/pull/8638. What would the benefit be? They're not direct equivalents, just happen to be called similarly. . Maybe coroutines but we haven't implemented them fully yet. I'm aiming for parity for now. . These types are specific to DOM renderer so they shouldn\u2019t be in the reconciler.. As is this particular prop name.. Similarly this is a DOM-specific utility function and shouldn't get called in non-DOM environments.. Yeah no worries. A convention I've been using is to tag PR with [WIP] and maybe mention in the description what isn't ready yet.. I sort of am but having a lazy evening. \ud83d\ude1b . One unfortunate thing related to our warning transformation is that getCurrentFiberOwnerName() runs regardless of this condition. Since this is a hot path in dev, can you please hide it behind a check?\njs\nif (workInProgress.ref != null) {\n  ...\n  warning(false, ...)\n}\nYes, this code is funny.. If the warning wasn't intentional in this test we should fix the reason it occurs. If it was intentional we should assert on the console.error message.. Why do we have almost identical code here and in CompositeComponent? Why can't it live in one place?. Why is there not enough information? Do you have a theory explaining this?. I think you want component._debugID, not this._debugID here. Because you want the stack for the child component (the one whose ref we're trying to attach) rather than the owner (the one who's going to own the ref).. Similarly you want the component's debugID, not the owner's. I think component is guaranteed to exist since we're calling component.getPublicInstance() on the next line.. This is copy paste from CompositeComponent.. This is copy paste from warnIfInvalidElement.. FWIW this is how @spicyj wrote it originally but @sebmarkbage wanted to avoid the allocation.. This doesn't look right to me. There's nothing special about functional components from the warning message perspective as far as I know.. Why would you move them together with HostComponent? I'm not sure I'm following.. Right, but this doesn\u2019t mean functional components are special compared to class components, does it? I think this might mean we need separate methods, e.g. getCurrentFiberOwnerName and getCurrentFiberName. Or something like this. Maybe we\u2019re wrong in using getCurrentFiberOwnerName for both of these errors, and one of them needs something different.\nI haven\u2019t really thought about this much, just giving you ideas to think about. It\u2019s more likely that these errors need different Fibers in messages, than that functional components are special.. Why is this indirection useful? Can we just import it directly in the calling file instead?. Maybe let's put it as a second section right after Use the Production Build?. \"can now\" is good wording for blog post but not very good for static docs.\nMaybe instead:\n\nIn development mode, you can visualize how components mount, update, and unmount, using the performance tools in supported browsers. For example, to do this in Chrome:. Nitpick. FB style is to write it without spaces:\n\njs\n  this.state = {message: 'Hello!'};\nWe use this style in all other examples so it's best to keep it consistent.. I fixed this in a followup commit.. Non-native speakers often have no idea what RSVP means.. Please add a CodePen version.. Let's just cut this? It's annoying in the doc.. I think two inputs here means too much mental overhead. Let's just use one input for example?. I wanted to highlight that React can be used in all these scenarios right in README.. Yea, doesn't really matter for now, this is all too confusing and broken to get it in.\nI'm thinking of alternate approaches now.. I opted to just remove this dependency. Its only use is to add the stack trace in this particular case. I think we can live without it like it was in 0.14 (and it wouldn't be able to do this in userland anyway).. This was only used for that stack trace so we can remove it too now.. This is where we inject ourselves into React now.. The worst case (it doesn't exist) is the same worst case we already had before when ReactDOM wasn't available yet, but at least this works with AMD. I don't think it's realistic that people will get here though, unless they have mismatching React versions (which breaks in other subtle ways anyway).. I don't think so\u2014don't we requite React all over the place in ReactDOM? For example ReactCompositeComponent (now part of ReactDOM) uses React.isValidElement. I think @sebmarkbage made it work during the package split.. somehow. Maybe with this.. (And I'm not seeing any noticeable changes in size, it's all within 100 bytes.). This should be safe since we only use ReactAddonsDOMDependenciesUMDShim in the addons build. Again, build sizes looked normal.. In this particular case I'd rather link to 2.x doc because it contains specific actionable advice, and works identically in 1.x. . This sentence looks fine to me.. This is too much (mostly irrelevant) information for somebody who is just learning about refs for the first time.\nI would prefer we add a \"Caveats\" section below for advanced users that mentions this.. The important part is that while some readers will be new just to callback refs, for a growing number of readers over time this will be the first introduction to the concept of refs at all. And as such, throwing too many details on them will only confuse them. . Nits:\nduring each render pass => during updates\n, additionally to the mount/unmount call (it's unnecessary)\nso React needs to reset the old instance and set-up the new one => so React needs to clear the old ref and set up the new one\nThis side-effect of inline callback function can be avoided => You can avoid this\nas a property on the class => as a bound method on the class because class properties are a proposal and not universally known\nin the average ref use case => in most cases. Oops, I missed this. \ud83d\ude1e . For the context, before this PR we used to only set the hidden field on the context consumers, not on all instances. The rationale is that only components that actually use the context should pay the price for it, not intermediate components.. Yes. (But ideally we shouldn't check if something is a consumer twice either.). Ideally we also shouldn't use __reactInternal[...] fields outside of FiberContext file. Not that it matters a lot but it\u2019s hacky and I want to keep it contained.. Good catch. We\u2019ll want to add a fixture for this.. We already doing an equivalent check in getMaskedContext which is called just before cacheContext.\nCan we avoid doing it twice?. Right, but we don\u2019t need the instance to tell if it\u2019s a context consumer or not.\nOr do we?\nI thought that maybe we can make getMaskedContext return null for non-context consumers. Then we\u2019d know for sure that we don\u2019t need to call cacheContext.\nNot saying it\u2019s the best way, just a proposal.. We could but it seems a bit fishy to make one perf optimization to rely on another perf optimization being present in another file. Returning null since more explicit if we want to \"signal\" that it's not a context consumer.. Alternatively we could call isContextConsumer from outside in the first place.. >I assume that getMaskedContext returns emptyObject instead of null for a reason.\nBecause we want to pass an empty object to components. But we could do || emptyObject this here (and similar places) instead.\n\nThis all inside of ReactFiberContext. What's the other file?\n\nI am talking about these lines in ClassComponent specifically:\njs\n// This will check if it's a context consumer:\nconst context = getMaskedContext(workInProgress, unmaskedContext);\n// ...\n// This will do the same check:\ncacheContext(workInProgress, unmaskedContext, context);\nI was proposing to do something like\n```js\n// Check once:\nconst needsContext = isContextConsumer(workInProgress);\nconst context = needsContext ? getMaskedContext(workInProgress, unmaskedContext) : emptyObject;\n// ...\nif (needsContext) {\n  cacheContext(workInProgress, unmaskedContext, context);\n}\n```\nThen you could remove checks in both getMaskedContext an cacheContext.. Can we move this check in getMaskedContext instead?\nThe other caller of cacheContext always has the instance.. Can we remove this check here now, and always do it externally?. I couldn\u2019t find a better solution.\nUsing the \"current fiber\" was wrong here because the thing being created is the current fiber, but it's not created yet.. Generally I'm of the opinion that methods should be strict and either have a safety check inside (and we never do it outside) or have no safety check, and we must always do it outside.\nDoing it both ways means somebody will see the \"early check\" pattern that was made for performance reasons and scratch their head why other calls aren't behind the same check. This will look \"surprising\" if one call is different from other calls in the same file. And every difference like this is mental overhead when you have to move those pieces around. Strict contracts help avoid that, and we can always fix safety concerns with tests for regressions.. I didn't really try anything else. \n\ncreate something like getDebugFiberWorkInProgress\n\nThe problem here is that the fiber isn't created yet so you wouldn't be able to set a reference.. \ud83d\udc4d. Got it, thanks . Why are we setting isProcessing here, but didn\u2019t set before? Is this fixing a bug?. Minor nit: do you need to dereference queue.callbackList here? Can you use callbackList directly?. Was this check unnecessary? Are we validating early now?. Why do we not need to reset it now?. Got it. I think this will throw in non-jsdom environment. Can you make it setTimeout? It seems like it wouldn't be used anyway, but at least we shouldn't throw.. Please clean up the comments.. Are pushing undefined? Why?. What are we ignoring specifically? Generally I'd like to avoid adding eslint ignores.. Comments. Please do.. Nit: Could you please use a consistent style for empty methods? Either like this, or with // Noop comment as long as it's the same style everywhere.. I'm not sure this is right. For example even \"2\" would become 2. Maybe this is unobservable implementation detail and we should just always use strings? Since that's what they get coerced to anyway.. Is this comment outdated? It\u2019s not telling me much: are refs broken in Fiber? Are they broken specifically for test renderer? What is our plan to fix them? Is this within the scope of this PR?. I don't see rootID being used anywhere. Is it needed?. When is it null?. Can you just omit it? I don't think we want to expose it here.. You'd need to see why other renderers didn't need this. It probably inferred that OpaqueNode type can be null, maybe from some other method definition.. Exposing but throwing isn't much better. :-)\nLet's either make it work or remove it.. Ideally also unmount at the end and check we get another null?\n. I don't think you'd actually get a number though in createTextInstance? As far as I can see it's already coerced by Fiber code by then. I think it actually makes more sense than exposing this to the renderer, and I'm fine with divergent behavior here (always treating text as strings).. Could we just assign it here instead? We already know the element.. It is added here to the Fiber, and it is on the element from this Babel plugin (enabled by default in CRA).. Hmm, that's trickier. Probably not since nodes are supposed to be kept intact. I'm actually not sure the API is right now, maybe we should've just passed the type instead of the element. But what's done is done?. Would be nice to add, want to send a PR?. Yea. But I bet pretty hard it won't happen. :-). When would this ever be false? If I understand correctly child is also either an Instance or TextInstance which we have control over.. Wouldn't this whole block look simpler as\njs\n      json.children = this.children.length ?\n        this.children.map(child => child.toJSON()) :\n        null;\n?. What is id field for? I tried removing it everywhere and tests still pass.. Why is this a no-op? It seems like there could be bugs related to this.\n(e.g. DOM renderer implements this one.)\nI think we should actually have shouldSetTextContent always return false.\nAFAIK it only exists as an optimization to avoid creating additional Fibers for single-text-child divs.\nBut in case of test renderer it doesn't matter.. I don't see Flow errors removing this condition.. I think you shouldn't need this callback.\nSince it uses synch scheduling, everything should happen synchronously anyway.\nSo you should be able to clean up immediately after calling updateContainer.. I find these empty implementations odd.\nCan you help me understand why they're unnecessary here?\nWhat if I call top-level create with a fragment?. Yea, just saying we should clean this up a little so the next person looking isn't more confused than we were.. Maybe. I'm pretty sure them being noops is wrong (since they do get called), but I'm not sure how to write a failing test. If you succeed with making a failing test against this then you'll know how to fix it.. Try commenting its implementation out in DOM renderer and see what fails.\nBy grepping for method name, I found this:\njs\n      if (nextEffect.effectTag & ContentReset) {\n        config.resetTextContent(nextEffect.stateNode);\n      }\nBy grepping for ContentReset, I found this:\njs\n      // If we're switching from a direct text child to a normal child, or to\n      // empty, we need to schedule the text content to be reset.\n      workInProgress.effectTag |= ContentReset;\nSo it likely happens when we switch from a \"direct text child\" (with your implementation of shouldSetTextContent, it's the case with <div>Text</div> or <div>{42}</div>) to a \"normal child\" (e.g. <div><p /></div>). The purpose is to clear the text in this case.\nI think you can avoid the whole problem by making shouldSetTextContent always return false. Then this code never runs and we always create a real text instance.. Here is a failing test:\n```js\n  it('can update text nodes', () => {\n    class Component extends React.Component {\n      render() {\n        return (\n          \n            {this.props.children}\n          \n        );\n      }\n    }\nvar renderer = ReactTestRenderer.create(<Component>Hi</Component>);\nexpect(renderer.toJSON()).toEqual({\n  type: 'div',\n  children: ['Hi'],\n  props: {},\n});\nrenderer.update(<Component>{['Hi', 'Bye']}</Component>);\nexpect(renderer.toJSON()).toEqual({\n  type: 'div',\n  children: ['Hi', 'Bye'],\n  props: {},\n});\nrenderer.update(<Component>Bye</Component>);\nexpect(renderer.toJSON()).toEqual({\n  type: 'div',\n  children: ['Bye'],\n  props: {},\n});\nrenderer.update(<Component>{42}</Component>);\nexpect(renderer.toJSON()).toEqual({\n  type: 'div',\n  children: [42],\n  props: {},\n});\nrenderer.update(<Component><div /></Component>);\nexpect(renderer.toJSON()).toEqual({\n  type: 'div',\n  children: [{\n    type: 'div',\n    children: null,\n    props: {},\n  }],\n  props: {},\n});\n\n```\nSolved by returning false from shouldSetTextContent.. We should deduplicate this by component name. Otherwise it can get very noisy.. Here is an example of how we do it https://github.com/facebook/react/pull/8739.\nThis PR would be much simpler though. Since warning is specific to a class, we can use component name as the key in the warnedAboutMissingChildContext cache. . Is this related to this PR?. Normally every time you want to start working on a PR you should pull the master branch from our repo and create a new local branch from it. You are likely seeing this because you forgot to switch back to master before creating the second feature branch. . You can fix this by running\ngit reset --hard origin/master\nthen cherry picking these two commits you want, and then force pushing. . I'm confused. The test you're showing looks like my test about text nodes. But we were discussing root in this thread. . Yea, I don't really know how to trigger the failing case for containers. It's just odd to me that those methods are blank. I would expect that either they shouldn't be defined at all, or they should do something. . >expect(renderer.toJSON()).toEqual('Hi');\nI don't think this looks right. We are rendering an array. Why do we get a single item as an output? I would expect it to return an array in Fiber.. It should be an array in Fiber. We should put the whole test behind a feature flag because it is Fiber specific. I think this demonstrates that root problem but maybe I'm wrong.. Can you explain why this helps exactly? There is a comment right above:\n```js\n   // `path.normalize` and `path.join` are used to turn forward slashes in\n    // the file path into backslashes on Windows.\n\n```\nAre they not helping? Why?\nIdeally I\u2019d like to see us use one separator style, and normalize paths when necessary.\n. I think that just adding jest-cli is not enough.\nThe problem is we haven't synced package.json for a while, and we need to update it to match what we have on master. For example we already have jest-cli@18 there.\nIn general, in this PR the goal is to bring it as close as possible to master. We probably missed some commits at some point. There shouldn't be much intentional divergence between 15-stable and master. So now that you found a set of changes that work, could you also reduce it so that it matches master whenever possible?. Note sure those checks are important. They would indicate bugs in Fiber.\nThey exist in ReactNoop because it tests Fiber itself but doesn't look necessary here.. Can we use a $$typeof switch here instead?. Hmm. Shouldn't ref be guaranteed to be either Instance or Container?. Okay. Switch on $$typeof with a throwing default would look nicer than duck-typing though.. Is there any way to write a test for observable behavior instead? That is, write a test that relies on ReactDOM and React, but not on ReactErrorUtils itself. Otherwise, it's hard to tell what exactly this is fixing.. Like this?. Not really important to use symbols there (if you don't leak those objects externally), you can just use an enum. Example declaration and switch.. I think this could be just $$typeof: CONTAINER_TYPE?\nSame below.. I was going to start working on that\u2014but happy to have @acdlite fix it. I didn't do it initially because I thought we're going to introduce a flag to disable all Fiber features including frags, and do it in a single pass.. What is this.children?. This should probably be (from #8652):\njs\n        if (nextHtml != null) {\n          if (lastHtml !== nextHtml) {\n              (updatePayload = updatePayload || []).push(propKey, '' + nextHtml);\n          }\n        } else {\n          // TODO: .... ReactDOM-test might be an okay place to put it.. Could we pack style updates in the same array with special keys or would that be too complicated?. Why do we listen here instead of the commit?. Style nit: i += 2. I think @acdlite said this was solved.. This depends on precacheFiber call in ReactDOMFiber.js, right? It's a bit non-obvious that an empty array here is needed to trigger the path there even though updateProperties in this file won't do anything. I guess doesn\u2019t matter if we\u2019ll unify them soon.. I don't think lastProps can be null here. You can probably read directly now that mount and update is separate.. While unrelated to this PR, I think the most common path is lastProps and nextProps with the same prop keys in the same order. I wonder if we could optimize this as a faster case with just one loop, and only do the second loop if we find a mismatch during the first one.. Stray comment.. How can styleUpdates be truthy here? It could only get created if lastStyle existed and we wanted to delete some styles. But in this case we would get into if (lastProp) branch instead of this one. Unless I\u2019m missing something.. Is it still necessary to delay it until the end? Why? This structure makes the above style code a little hard to follow, especially the case where you have to reassign styleUpdates right after pushing it to the payload so that it doesn't get skipped when it's falsy.. Wouldn't it actually be useful to break tests? e.g. product tests.\nWe can always spyOn(console, 'error') in error boundary tests.. ReactNoop used in these tests is already Fiber-specific so this shouldn\u2019t be necessary.. Stack both warns and does an invariant with the same message. This is an artifact from some earlier refactor when this was a different warning but has since become irrelevant. See https://github.com/facebook/react/pull/8648/commits/2646272e8ac55a15bbfde0dc49b0e5294b7cd5fd and feel free to reuse my other commits in #8648.. >Occasionally we do that intentionally too if the warning gives a better stack.\nYep, but isn\u2019t the case there. (Both stacks are internal and roughly in the same place.) I\u2019m not sure what happened but I think there was some confusion during #6008 since it started as a different warning, and instead of getting removed, was changed to the same message as an invariant immediately after it.\n\nI'll rebase on top\n\nYou probably only want da3dc0354dc37af431f59ac04a29e694515511cd, 243d24542354eae55a77ce68ea556e04a13967be, 2646272e8ac55a15bbfde0dc49b0e5294b7cd5fd.\nI haven't looked at your PR yet but you might want to do 8c4b2a64dbb848bd6659821b0c3af771f283e03c and 5643a2c6272ca27cff5c4b739638cce266ee1dc6 differently.. Nit: can we name this warnedAboutMissingGetChildContext?. Maybe let\u2019s make it a bit more descriptive? We can make it similar in style to messages in ReactFiberClassComponent (and Stack equivalents in ReactCompositeComponent). For example:\n'%s.childContextTypes is specified but there is no getChildContext() method on the instance. You can either define getChildContext() on %s or remove childContextTypes from it.',. Any special reason for using createClass here? Ideally we'd like to use ES6 for testing anything other than createClass itself specifically.. It\u2019s best to make it as close to master as we can in terms of linting setup. It would make sense to me to have 32f5b034ed229d048f76ae74e18d270edc801dbf and similar changes cherry-picked.. Maybe it is specific to server rendering? I haven't actually checked.. This file is wild west. Public API must never expose fibers.. Since this exists for Stack compat I would return nothing. Stack doesn't allow rendering top-level text nodes so nothing would break if we didn't implement this.\nIf we did want to implement it (I don't see why) then it would make sense to return the TextInstance (text node), similar to how ReactDOM.render(<div />) returns the Instance (div).. This doesn't look right to me. It puts a newline before the whole message, not before the addendum.\n(There is no addendum here.)\nAlso, I would prefer if we avoided modifying invariant messages. Let\u2019s stick to warnings for now.\n. Can you avoid this change?\nIt's a bit messy because the histories diverged.\nI only changed this method here because Flow complained at domElement.textContent = newProps.children; assignment. However in 15-stable this code didn't exist in the first place so we can safely leave the old implementation here.. This is not consistent between browsers.\nFor example Firefox or Safari don\u2019t seem to put the message in stack.\nI suggest checking if the first line of the stack ends with error message. If it does, cut it out, otherwise keep it.\n. On line 29, I think you should use error.name instead of \"Error\" because it might be a TypeError or something custom.. Would be nice to include the name even if there's no message?. I think it would be safer to split the first line first. Then check the first line for matching the message.\nOtherwise this code behave in a weird way if the message was not on the first line.\nNow that I think of it, messages could also be multiline. So maybe it's best to check for a very specific pattern that Chrome does (and cut it out based on where the message ends), and not touch it in any other case.. Can you use path.normalize() for this?. Ah, you're right.. The conceptual problem here is composites (e.g. <Foo />) will never end up as children. At least not unless we let the renderer somehow override the resolved element type from function to string conditionally.. Please enclose the command in backticks.. Also, this step should probably come the last before CLA. It should be done after everything else is ready.. Why don\u2019t we switch on the event target type instead?\nI would prefer a more succinct version (since that's what the example tries to convey):\njs\nhandleInputChange(e) {\n  const value = e.target.type === 'checkbox' ? e.checked : e.value;\n  const name = e.target.name;\n  this.setState({\n    [name]: value\n  });. Codepen would need to update too?. Looks like I'll have to move this back to the renderer.\nIt will need access to the component tree for \"jump to component based on DOM node\" feature.. Yes this is what I mean.. I use Set in DEV mode earlier so the test that specifically removed global.Set now fails. We use Set in other places anyway so I think this doesn\u2019t really matter. We should fix those together (or depend on a polyfill).. >The REACT_DEVTOOLS_GLOBAL_HOOK is always available regardless if the tool is available or not.\nOh, that's neat! I didn't realize.. I missed why this is failing.. Please include CodePen links like in other docs.. Style nit: please put else on the previous line.. It's unfortunate we're reading a global from render. Generally this is a bad pattern. I would prefer if we did that once when we rendered App, and passed it as a prop.. Why is this a class? Since it doesn't use lifecycle or state, let's use a functional component.. I'd like the next paragraph to be a higher level description of how apps using History API work. It can be as simple as explaining that History API exposes methods to rewrite the URL bar without actually changing the page, and events that fire when user presses Back and Forward. Imagine someone who's never seen client-side apps and write for that person.. The reader doesn't even know the browser API at this point, so introducing \"history wrapper object\" sounds very complex. We could solve it by explaining the browser API first, and then noting its inconsistencies and introducing a library.. Maybe change to \"One popular implementation is [...]\" rather than saying most people use it.. I want to avoid \"wrapper\" terminology in this doc, it just makes everything sound more complicated than it is. I would also avoid recommending any particular filename / location suggestions. In three months you'll see a cargo cult of history wrappers being placed in this location, and pointless discussions about it being a Best Practice. \ud83d\ude04 . It sounds a bit like Link component already exists. I would rephrase to say that since most links in the app share the same logic, people often create a component for them.. We don't use experimental syntax in the docs unless they're about that syntax in particular.\nPlease use the bind-in-constructor pattern.. This also means we need to include the code rendering the root component at least once. It's fine to omit it in later snippets.. I don't think you need JSON.stringify here. This is not Webpack environment, it's setting a specific value. So you don't want to add extra quotes around it.. Let's just make \"merges a partial [...]\" itself a link.. For consistency let's put this paragraph after the link. In fact maybe after the property explanation.. Sounds good.. \"You can use your mixin\" sounds a bit aggressive, maybe \"You can use this mixin\"?. Ooh okay. Let's make sure the initial code snippet is copy-pasteable into Create React App without changes then. Like in RR4 docs. . I think it's okay since nobody actually uses History. :-P. Maybe let's just call it browserHistory since that's what history package calls it anyway. And call the file the same way. . Minor nit: technically {this.props.children} is not required if you already spread props.\nBut I guess that's clearer.. Yea, okay let's keep it there.. Oops no. Send a pr?. Fiber DOM renderer is client-only so no, it's not relevant.. Let's make another intro paragraph to explain that React itself doesn't provide any built-in routing solutions, but you can use component lifecycle and state (link it to the doc) to hook it up to the browser APIs.. Nit: please use === everywhere. We also need to make it clear that React doesn't require you to implement routing. For example, if you don't write a single page app, you can use React without these techniques.. Maybe call it window.history.pushState to make it explicit we're talking about browser API.. Maybe say \"the popstate browser event on the window object\" to make it clear how to subscribe to it.. Nit: let's put --save first like we do in other docs. Maybe add \"For example, we can create a separate file and export the object from it, so that any other modules can later import it.\". Let's add a default export?. Please use semicolons everywhere.. I think you meant \"Get the current location\". Perhaps it would be more useful to show what that object would look like.. The reader may not know what window.location is, let's just show what it is in the comment?. Let's add a comment explaining why this is important.. Maybe highlight this line? You can see how other docs highlight JS with ``javascript{A,B,C} syntax where A,B,C are comma-separated line numbers.. This comment will probably confuse many readers. Can you reword?. Minor nit: semicolons and({location}), we use this style elsewhere in the docs.. Also let's mention that in this guide, we'll build a simple routing solution from scratch, but there are popular community projects such as React Router.. Please keep the comment.. Can this break hidden classes if it's a number?. Nit: probably need to change workInProgress.childto workInProgress.stateNode` in the comment (or drop it). Maybe move to child fiber since it's duplicated between phases?. Nit: don't have keys. I enabled it in prod per Ben's feedback. . Oh, I didn't realize we are putting all warnings behind DEV though. Somehow I though Babel transform is doing it. I'll add a condition. (I think it's fine to crash DevTools silently when using DevTools in prod)\nI can also move the try-catch to the DevTools.. >If you bump this you have to make sure that all consumers and downstream renderers bump theirs too. \nWhy? The way I imagined, every time we make an incompatible change, we can fork the code in DevTools (and eventually start removing old forks). The only difference is this is now explicit. The downstream renderers would update it at the same time they update their reconciler version (which is really what version field specifies). . My main intention is for old DevTools versions to not crash when they attach to new Fiber versions that, for example, have different children data structure. In the past, data structures barely changed, but I'm not sure this will be true for Fiber (e.g. hybernating trees). So my intention is that Fiber can say \"hey, I'm the new incompatible version\" and then old DevTools just bail rather than crash.\nWe can't feature test that because we can't modify old versions of DevTools once they're out. But maybe it doesn't matter because they auto update?. Another example of incompatibility is changing types of work enum. If old tools can't just bail they might display everything incorrectly and it wouldn't be obvious they need to be updated. . We were trying to avoid saying \"transpiler\" in new docs because it confuses everyone. Let's just always say \"compiler\" and ignore the \"transpiler\" term. Even Babel docs don't use it.. > it's similarly not obvious that you need to bump the version number when you make this change\nI'll catch you in code review! \ud83d\ude04 \nBut yea, I see your point.. Maybe shorten to just say You can set a ref to a functional component:. I think this is too much detail. We can just say \"The ref will always be called with null. If you need to a ref to a component, it must be a class.\". Let's call it FunctionalComponent. That's the important part, not whether it uses state or not.\nMaybe even MyFunctionalComponent to make it clear FunctionalComponent is not some special name.. Maybe just say \"This won't work:\". The fact that it's called with null is implementation detail, we might not call it at all in the future, and we'll definitely start warning about this. So we don't people to rely on \"calling null\" as the expected behavior.. Good to add an inline comment here:\njs\n// This will not work!\nOtherwise people will just read over this and remember this example.. I don't think it's necessary to link to GH here as if it was a bug. People who are interested will find it anyway (you did).. Why have they moved to failed?. I think you want .child because .progressedChild refers to something different.. What is .node?. Do you mean always exporting those functions and checking typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== 'undefined' &&\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.supportsFiber inside of them? Or doing the check once but exporting a noop?. What about onCommitRoot? It would be a bit weird to make some of methods conditional, but not others.. This will count against the byte size, is this intentional?\nIt doesn\u2019t matter that much in the grand scheme of things, just wondering if this was intended or not.\nIf you just hardcoded it everywhere then it would get stripped out.. Not sure we can count this as an internal error? The object is supplied by the user code.. Also internal.. Maybe worth checking for undefined too here and above? != null. I'd prefer we do it now so it (or similar patterns) don't keep spreading.. Unless user specified code returns something different the second time we read @@iterator, no?. It could be a getter. . It would be nice if error code transform was throwing on anything other than static messages.. This is a built file for the current stable version, so it will get reverted the next time it's built.\nLet's omit this file.. Why?\nAlso, if it doesn't warn, do you think this could create warning noise in codebases that already rely on this pattern? It would be nice to check Power Editor and other React-heavy projects for this.. Please verify this file actually ends up in build/packages/react-test-renderer after you've run npm run build. Whether it does or not depends on where ReactTypeOfWork is located. Explanation for our folder structure: https://facebook.github.io/react/contributing/codebase-overview.html#shared-code.. In other words, after npm run build try cd-ing into build/packages/react-test-renderer and verify you can require() it without crashing.. Nice that we caught that.. This import is unused.. We don't use this style of declaring components anywhere in the docs. We used function everywhere because it's easier to understand for people new to ES6.. What does this comment represent? I don't think it makes the example more clear.. This component is named CommentBox but the component declared above is called Comment. What is the reason for the discrepancy?. The user reading this will likely miss the initial window.Perf assignment because it's in another code snippet, and will get that error about Perf being undefined.. Perf.getLastMeasurements() is an extremely low level method and gives information that has very little value to the user unless they know how to interpret it. This is definitely not what we should be suggesting to the user as an introductory example.. I think we could have better more appropriate text than praising ourselves. \ud83d\ude09 . If this is released in 15.x, it would potentially break CIs on libraries that assert about this warning in tests.\nWe have some tests like this about prop types in React Redux so I wouldn't be surprised if somebody tested a similar thing about context types.. This is incorrect, the missing value is undefined (which is what you get when you read a non-existent property on any object).. Similarly, this is incorrect because you get undefined, not false.. You forgot to close the </div>.\nI'm also not sure this section is fitting well here. This section is about the fact that statements can't be embedded in JSX. It is not about conditional rendering per se.\nMaybe instead let's write something like\n\"You can learn more from more about conditional rendering and loops in the corresponding sections.\". Minor nit: please remove https://facebook.github.io/react prefix from the links so that they work locally.. Generally we don't recommend this pattern, and instead recommend using defaultProps to keep props exact. You could use { autocomplete: false } as your defaultProps to make it explicit.\nI'm not sure this section is necessary.. I hope this doesn't stay for a couple of years like similar hacks have stayed in Stack :-). Maybe we can just make \"runs on every keystoke\" a link, and point it to https://facebook.github.io/react/docs/dom-elements.html#onchange?. What is the plan for unhacking this?. I'll just break it again later this way \ud83d\ude04 . I think we should keep this line as it is but change what ReactDOMUMDEntry exports.. Hm, could you explain how this is related to automocking?\nIf you mean resetting modules, it's a different feature from automocking.\nI don't think we have automocking enabled in React repo.. Oops. Should we preventExtensions on fibers? Like we do in Stack instantiate. . Let's flip this to be a positive condition, it's easy to misread.. Does this ensure process.env.NODE_ENV get envified?. Nit: \"renders\". Oh, we should just move the backend here. It's still on my todo list but I haven't gotten around to it.. Is there a way to tell Flow it's intentional, or do we plan to leave these here?. Isn't this already a boolean?. Same question.. I think this should just say from 'ReactComponentTreeHook'?. What do you think about two separate types, one for DEV, and another for prod? Then the consumer could cast once to whichever is appropriate depending on whether we're behind DEV or not.. I'd prefer to not do this since we already know we're in DEV. See my comment below on potential way to accomplish this.. Nit: why not call Object.assign() without using return value? Flow?. Here, too, it seems odd to add these checks.. Oh, I didn't think about this. That's a good observation, you're right.. What is this file? Looks like a build product that shouldn't be checked in.. Aah. Thanks for explaining.. (That's the same reason we don't allow absolute imports via Webpack config in CRA \ud83d\ude04 ). How would you combine them? It feels a bit messy to me to have || and && with ! in a single condition.. I tried the second one earlier but I thought it's a bit less confusing when it exits if we collapse them.. Changed. I can see this as potentially confusing since we haven't really shown it'll be used in a JSX tag yet.. I'm also not sure that people reading this necessarily know that constructors are often capitalized.. I mean that the whole convention of capitalizing constructors has no basis in the language. It's just a convention popularized by JSLint (or JSHint, I don't remember), I think. So for people not exposed to this convention (many React beginners) this implication will only further confuse them.. .only. Why do we need this check, here and in files below? This method is defined unconditionally, and AFAIK all the callers are also DEV-only files.. This fixes an issue that caused Jest to treat snapshot files as test suites. Also matches Jest docs.. It should be because Uglify will find no references to it. At least I think we've been doing this in many places and it worked before.. I think it's inside a DEV block (it's just a long one \ud83d\ude04 ). Just checked, and it's stripped out. I'll gate by DEV for more explicitness.. Maybe let's say \"set up a separate production build process\" or something like this? To indicate you don't need to do it for development, but that you need to separate how you develop from how you deploy.. I would just type props manually in the second example.\njs\n<MyComponent\n  myPropsOne={this.myPropsOne} \n  myPropsTwo={this.myPropsTwo} />. Please link to MDN.. Nit: need space before {. Nit: need space before {. Please use more realistic prop names than myPropsOne, myPropsTwo. Maybe onClick and value.. You can save current in a closure in DEV?. I don't think this would work in a flat bundle. Here's what I'm doing in current Rollup build. \nhttps://github.com/trueadm/react/commit/e4fcbecc1eccf4528c19b013154d44c614777b7e. Yea, sure. I just hope we don't change this again because it took me a little while to find that fix, and now it's obsolete \ud83d\ude1b . Renders renders. What do you think about waiting for first call and including the class displayName in the message?. Ahh okay.. This code just moved from below for clarity.. I think we only collapse leading and trailing whitespace, but only if it's leading or trailing for the whole line.. Why do you need this cast?. Bad describe. Instead of a separate test for an internal, maybe we can change ReactNoop to return null instead? It's not using the context anyway.. This didn't use to be required. Does it matter? I don't remember why I didn't check it.. Can you explain more about this change and why it is safe? I would prefer that we don't alter the build significantly in this PR, and pursue more aggressive strategies separately.. Oh I just realized it's disabled by default. \ud83d\ude04 . Maybe let's make it strict?. Nit: please capitalize \"other\" and \"libraries\" for consistent style. Could you add a one-paragraph summary for this page? Something that says that React can be used in any application, and summarizing two methods below.. Minor nit: please remove https://facebook.github.io from all links so that they stay relative to the root. This way they will resolve locally.. Maybe let's omit it here if we're not showing anything. Or make \"cleanup\" more descriptive.. \"What it does do\" reads heavily, can we rephrase?. We try to avoid experimental syntax in examples, could you please use ES6 only?. Nit: capitalize backbone.. It would be great to make the intro paragraph less about Backbone specifically, to make it clear the same applies to wrapping a React component in any imperative API. Maybe we could rename sections into \"Integrating with DOM Manipulation Plugins\" and \"Integrating with Other View Libraries\", explain the general idea in first paragraph of each, and then make jQuery and Backbone examples subheadings in them.. For people unfamiliar with Backbone, worth adding a comment here that notes that in Backbone, render runs once and is responsible for constructing the DOM tree.. Same: let's only use ES6.. Nit: single quotes everywhere. Let's change these to say ReactShallowRenderer too? Or maybe drop React there and just ShallowRenderer.. Ah I see. Thanks for explaining. . (I agree). Would it make sense to change snippet below to match package name?. Why did we remove these? Their ordering seemed important to me.. Same question here.. And here.. Hmm. I'm a bit confused. These pages (e.g. Conditional Rendering) don't have to do with addons as far as I can see.. It's only used from tests so.. I don't know. \ud83d\ude04 . Rather than have this special case in all bundles, I opted for importing ReactDOM explicitly in test utils.. Doesn't this mean that the replacement logic misses ' or something that delimits end of the string, and we should add that?. cc @trueadm . Not \"has been\"?. Should we make it clear it will keep on working indefinitely? \"temporary\" doesn't sound very reassuring.. \"that has no reason to change\" is not really explained. Maybe add \"like an empty <div />\"?. We jump into this code example too fast. It's worth adding a sentence before, e.g. \"For example, a component rendering a jQuery plugin could look like this:\". Nit: missing semicolon at the end of the line. And I see that you explained it later, but generally people stumble where they're confused, and don't read past it because they're not sure if they'll be able to follow the rest. It's better to explain before rather than after the code.. What is this.props.update? It looks like a React API but it\u2019s not. Maybe worth calling this this.props.onChange for convention, and adding a desired API example before the code sample (e.g. \"The component API we're aiming for is <Chosen onChange={this.handleChange} />\".. How does this work without shouldComponentUpdate() returning false? Maybe worth adding it for explicitness?. What happens when children change?. I'm worried that this example is potentially dangerous because we're mixing React children with jQuery parent with React grandparents. Maybe it would be better to use a \"leaf\" component for a jQuery example.\nIt's also worth noting that generally it is recommended to use React components, and this is just an escape hatch for when you need to integrate with older code.. Worth adding this is exactly how we use React at Facebook.\n. We avoid destructuring here in favor of props for easier reading to people unfamiliar with ES6.. Maybe explicitly say \"For example, in components it is best not to rely on IDs because the same component can be rendered multiple times. Instead, we will use React event system:\" and link that to events doc.. (props) please. Also let's not call anything Component, it conflicts with React.Component.. >This is something React normally calls for us\nThis is ambigious and might give the wrong idea that you don't need to call ReactDOM.unmountComponentAtNode() when you use ReactDOM.render() in some other contexts (e.g. a purely React app that happens to have those imperative calls for modals or something else).\nWe should make it clearer that unmountComponentAtNode() unmounts the whole React tree from the outside. However inside the React tree, React automatically takes care of unmounting individual components when their parents no longer render them. Not sure how to phrase it without going too much into details.. Maybe worth adding that in general we recommend one directional data flow such as React state, Flux, or Redux, but other approaches work too.. Maybe connectToBackboneModel. This is object rest/spread which isn't in ES yet. Can we use Object.assign() here?. What if there's a different model coming into props? I think it's worth showing how to handle it in componentWillReceiveProps because it's a common mistake in integrations.. Same on this line, this is object rest/spread and we probably shouldn't use it here yet.. (props) please. It's not super clear this is a component. Can you call this Example and then show how you call ReactDOM.render(<Example />) to make the point?. Don't do this inside the component. You're creating a new copy each render, destroying the state and DOM.. Can we just move this section about \"no special meaning\" above to where it's defined, and add a sentence here that this is where onClick has special meaning (because it's on an a built-in component like <button> rather than our custom Square).. It's weird we include this into bundles. Why aren't we calling PropTypes.checkPropTypes?. If you run build, you will see that there\u2019s a single react-test-utils.development.js left in the /build/ folder while everything else is neatly put into folders. This is probably because name corresponds to npm name, but there is no top-level /packages/react-test-utils/ so it doesn\u2019t understand where to take package.json from, and skips it. (I admit this behavior is confusing.)\nThe rule of thumb is that nothing should end up in top-level /build/ folder, and that /build/packages/ should be all publish-able \u201cas is\u201d after build. I don\u2019t think this is currently publish-able as is because test utils don\u2019t actually make their way into the react-dom package.\nYou probably want to put 'react-dom/test-utils' in this field instead. This will ensure it gets copied into /build/packages/react-dom/ instead. You can see we are using the same trick for react-dom/server.\nHowever, I\u2019m not sure how it will end up on npm. Don\u2019t we need to add a test-utils.js file to /packages/react-dom/ which points to the entry point, similarly to how we have server.js in /packages/react-dom/? And we\u2019d probably want to add more entries to \"files\" in /packages/react-dom/package.json so that the new files actually end up in the package. Otherwise this PR does not really do anything to make it appear in the react-dom package.\nI am slightly concerned about www. I would like to avoid deviating too much between how ReactTestUtils works in open source and in www. Currently, ReactTestUtils is a shim (/scripts/rollup/shims/facebook-www/) that re-exports a hidden value from ReactDOM. If we\u2019re separating them in open source, can we also separate them in www?\nThe way I see it, we could do it by removing ReactTestUtils from the secret exports of ReactDOMFBEntry.js and ReactDOMFiberFBEntry.js, removing the ReactTestUtils.js shim from /scripts/rollup/shims/facebook-www/, and instead adding a FB_DEV target to this bundle. We would need to make sure it imports require('react-dom') as an external so that it doesn\u2019t duplicate ReactDOM inside.\nI have a similar concern about duplication in the open source build too (which this PR implements). If you build it and look inside the bundle, it completely duplicates ReactDOM inside. However this means that components using findDOMNode will import them from react-dom that is different from the one react-dom/test-utils is using. If you look at 15.5, react-dom/test-utils intentionally shared the implementation with react-dom itself because otherwise it can\u2019t function correctly. So I think the need to declare react-dom as an external affects not only FB bundle, but open source bundle as well.\nDoes this make sense?. My suggestion:\n\nsetState() enqueues changes to the component state and tells React to re-render this component and its children. This is the primary method you use to update the user interface in response to event handlers, server responses, etc.\nThink of setState() as a request rather than an immediate command to update the component. For better perceived performance, React may delay it, and then update several components in a single pass. React does not guarantee that the state changes are applied immediately. \n\nWhat do you think?. Maybe \n\nsetState() does not immediately mutate this.state. Instead, React mutates this.state when it applies the enqueued update, and this may happen later than the setState() call. This makes reading this.state right after calling setState() a potential pitfall.\n\n?. Does it make sense to always export it? Or at least throw in production.. I don't understand this yet. Why does a FB entry point simply re-export? Can't we point the FB entry point to whatever react-dom/test-utils truly is?. Agree, we probably don\u2019t want this except for a quick manual testing before committing this.. Can we avoid instanceof checks here? They don't work across iframes.. Related past discussion https://github.com/facebook/react/pull/6355. We shouldn't update error codes in a PR.. This is not a warning though, it's an error.. Doesn't matter much here, but for the future reference: whitespace is significant in Markdown. So if you see two spaces at the line end, it is likely intentional to break the line.. If the test doesn't pass, can you amend the test instead? If it specifically tests for \"error codes\" then we can change it to trigger some other invariant whose code didn't change.. Can we avoid strings in these two cases? Seems like return '' + element would be enough. Minor thing but minifies better.. That's what we do for now. It doesn't really matter and gives us heads up on unexpected changes. Ideally later we'd migrate to another approach (e.g. a bot that comments). But this works okay for now. . Should we also throw for the main test renderer entry point then?. Or should we create prod versions of all of them? I don't see benefit but somebody might come up with a use case. Maybe just worth keeping in mind. . I think this file was deleted so the stat is probably not needed?. Can you verify with @sebmarkbage he has no concerns here?. This seems fragile. What if it isn't our context but the root element just happens to be a context provider?\nTo be honest I'm not a fan of second undocumented context argument. Our other APIs don't take it. I think it's remaining from the time context was owner-based and we might as well deprecate it and tell people to use their own context providers explicitly. But it's probably annoying to do in this PR.\nLet's just be stricter with checking here. . Would this re-trigger any validation? Would people see duplicate messages?. This will likely make all shallow tests slower. Would be good to measure it on some mid size codebase to check the impact. It might be better to add some way of bailing out if it's too bad. . While we're at it can we move src/test to a more appropriate place (considering the package structure)?. I'm a bit confused by this comment. Can we branch on require instead? Otherwise it looks like we stopped testing shallow renderer in Stack at all. However the Stack version is what we're currently running in www. . Oh. I didn't realize we deleted the Stack based one. Our usual strategy is to keep both until we\u2019ve migrated everything that uses the old one (e.g. www). This lets us revert to using the old one if the new one has issues. Otherwise once this is merged, we have no way but to fix forward. Which might be fine, but it\u2019s blocking any future syncs, and I don\u2019t know if this will pass www tests or not.\nUsually we keep both, and let the tests pick the right one based on the flag.. What about the key warning?\nIt\u2019s probably fine, just making sure you\u2019re aware of this.. I\u2019m not sure about this one.. Would you also change \u201cFacebook codebase\u201d to \u201cFacebook's codebase\"?. \"may cause issues with the components state\" is very vague. Can we make it a little bit more specific?. This is a fairly good explanation, but the CodePen example doesn't really demonstrate the problem. Can you add a \"sort\" button to it so that the user can see the problem itself? Ideally it would help to have a second CodePen example as well that would fix the issue.. Do we actually want to run this in shallow mode then? I would expect that this would crash if you use DOM refs. I don't think we used to fire it in 15.. Ditto.. Let's not pass prevContext?. Can we keep the way we determine class vs function consistent? This seems like an ad-hoc way that doesn't match how we do this elsewhere (prototype.isReactComponent). I'm also not sure if this supports \"factory\" components (function Foo() { return { render() { return <div /> } } }).. Shouldn't const { ReactDebugCurrentFrame } = require('ReactGlobalSharedState') work? If not we need to fix that.. Yes, \"in theory\" it would be correct to call it but I don't think it would work in practice. Curious how this doesn't blow up www.. Same as componentDidMount: it assumes DOM is there and could operate on refs. I guess at this point we need a redesign \ud83d\ude22 . Let's just do whatever 15 version does, and we can look at it again in 17 now that it's decoupled. You could also check with @sebmarkbage if he had short-term thoughts here.. cc https://github.com/facebook/react/issues/7678 and \"componentDidServerRender\". This is a similar problem. We can't currently separate DOM flush lifecycle from a more generic \"completion\" lifecycle.. I am only aware of these two places:\n\nFiber https://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactFiber.js#L234\nStack  https://github.com/facebook/react/blob/master/src/renderers/shared/stack/reconciler/ReactCompositeComponent.js#L45\n\nAre there more?. I think if we aren't ready to do an intentional decision here, we should just maintain existing behavior (I'm not sure what the existing behavior is). We should also add tests for this behavior.. The first one tests for factory components. This is a bit different. See my example in the comment above. We support components that are functions but return instances.\nOther examples depend on instances already existing. I was talking about how to determine something should be new'd before it gets created. It is important because it is unsafe to new some things (for example arrow functions), and because we support a pattern that doesn't need new but still returns instances (factory components). . Sorry, I'm on the road and probably not making sense. What I'm trying to say is that the other examples check for something on the instance. But instance doesn't exist when you're \"choosing\" how to create it. There are only two places where we \"choose\" that (based on type alone), and these are the places we need to be consistent with since we also have just the type.\nThe overall algorithm is:\n\nCheck for prototype.isReactComponent.\nIf it exists, call type with new.\nIf it doesn't, call type without new.\nLook at what type returned. If it's an object with render method, treat it as class instance from now on. Otherwise treat it as a functional component that returned an element. \n. It would be good to run them on existing Stack implementation to verify tests match previous behavior. . Maybe just copy and paste it here? With highlighting it's not really that distracting, and it helps to stay in the flow.. cc @vjeux, isn\u2019t very pretty. Always one step ahead of us.. I don't think this is important in this tutorial (and it's not relevant for most people who would follow along on CodePen).. Just placing a link like this is not very helpful. Is there a better way we could do it? I would also prefer that we do this consistently for all API rather than in one place.. Can you still provide a whole example here? It\u2019s fine to have a Demo component rendering WrappedInput. The only essential part is WrappedInput assignment should happen outside that component. (And you\u2019d need to update the codepen too).. This is not what I see when I follow along from the starter CodePen. Can we either make it similar or make it clear the code is just being skipped?. We should not put anything on global ourselves.. Take a look at the code below. We export rAF and rIC from this file. So we should just assign those variables instead of globals.. I imagine something like\n\n```js\nif (!ExecutionEnvironment.canUseDOM) {\n} else if (typeof requestAnimationFrame !== 'function') {\n} else if (typeof requestIdleCallback !== 'function') {\n} else {\n}\n```\nThis way you won\u2019t get into that condition at all if DOM is unavailable.. Naming nitpick: let's call this previousRAF (and previousRIC).. This is actually expected to throw since it determines you're in DOM mode. You need to keep this test (but change it to assert that it throws), and add another test that fools canUseDOM somehow to return false (look for existing tests that might do something similar\u2014maybe it's enough to delete window.document or something like that).. Maybe they\u2019re failing because they don\u2019t expect a new resetModules in an arbitrary test? Perhaps it\u2019s better to keep these two tests in a different file then, but keep them wrapped in the useFiber check.. Yea.. This is a generated file, could you please revert changes to it?. Seems like this change wasn't rolled back?. Shall we remove them immediately in master and keep them only in 15.6?. Please just change this require to be unconditional. It is no longer necessary to do this trickery now. (The original reason for this was related to some Jest behavior that's irrelevant with flat bundles.). Let's not touch this file. It's gone in next version of React. . Same here, let's leave this one as is because it's a goner. . Yes, please revert. I don\u2019t see us fixing this in 15 given that the hack was added to work around an accidental breaking change in 15.2.1: https://github.com/facebook/react/issues/7240. Let\u2019s wait for 16 here please.. >should i just var ReactComponentTreeHook = require('ReactComponentTreeHook') at the top of the file?\nYes.\n\nThis ReactComponentTreeHook is later conditionally required in DEV block.\n\nYou can remove that. It\u2019s unnecessary now.. Did this typo get into any non-alpha release?. Can you test for specific error message here please?. \"If you click on any square, an X should show up in it.\"\nI don't think the linked CodePen does this. I see an alert in it.. I\u2019m okay with this, but please change the existing \u201cfinal\u201d CodePen linked from intro paragraphs to match the new style. They should all be consistent with the doc.. This CodePen doesn\u2019t work for me.\n\n. Also I think this might give people the wrong impression that JSX requires you put things on a single line or they\u2019ll be split by newlines. This is not true. So maybe wordier version is clearer in this case.. Do we want to have this file long term? Since these are final versions ever (hopefully), it seems a bit redundant to add a new file that we\u2019ll never change, for parts that were technically discontinued. Maybe we could put this up as a gist instead?. In general we avoid deeply technical descriptions of changes.\nI would prefer that instead of \"envify and collapse\" we would say something like\n\nFixed the accidental size regression in UMD bundles.. Here, we try to separate React, React DOM, and React Test Renderer changes.\nCan we make it clearer which package each change corresponds to?\n\nI also think it might be simpler to roll addon updates right into this list, and summarize them as React Addons bullet point list for each version instead of giving each addon a section.. Maybe let\u2019s just keep it in the main changelog? It seems like they could fit in fine if grouped under React Addons for each release (see like we did before).. Styling nit: some PR links are missing hashes in text. Maybe \"for unitless CSS Grid attributes\". Maybe add \" which was never used\". People might think this is deprecating the mixin system otherwise. . When we change this we usually also want to change the GitHub pull request template (unless you already have). It's in .github folder. . Assuming we'll fix up the link format here too to match others. . Nit: lets use backticks for package names. We don't use them for proper names though (e.g. we either write React DOM or react-dom). AFAIK versions before 15.5.4 are using prop-types < 15.5.7 in the UMD, thus having the same critical issue. So we should make it clear all of them are effectively deprecated, and people should skip 15.5.0 to 15.5.3, and use at least 15.5.4.. It works great when forking though so maybe we should encourage people to fork. In my experience people trying React often already have CodePen accounts.. Yea, I kind of feel like duplicating it will make it harder for us to change things in the tutorial. It's also more valuable to debug your code as you write it, then debug a complete result.. Sorry I wasn't being clear. We put # in for PR numbers, but don't include it for commits.. (For PRs and commits, this is identical to how GH links work if you just paste a link. Unfortunately this doesn't work in Markdown documents, which is why we do this manually.). Not that it matters too much, but for future reference, we start warnings with a capital letter. It should be Setting defaultProps [...]. We don't consider Warning: to be part of the sentence.. Yea, I only really noticed it in the code.\nI thought it's worth changing as it might come up in custom warning dialog (I don't remember if it appends Warning: or not).. Seems like this can be removed.. Should this end with .*?. Why did we change this? We're not running benches on CI yet, are we?. Can we avoid checking in built copies of React? People will attempt to edit or download them.. Typo: compare (here and below).\nWhat does \"(default run)\" mean?. Is it used currently, or was it added for future experimentation? If not used let's remove it.. Do you think it would be helpful to have a commit hash here?\nOr maybe even print a GitHub link to commit below.. Nit: type here too. Is it better? Should it be the default? When would you want to use it?. Probably \"yarn bench\"?. I don't fully understand what these two commands do. (--local and --remote)\nIf I run --local will it not benchmark remote at all? Or will it just skip the build for remote?\nIf it doesn't run remote, how would I interpret the benchmark? Does it mean I'll only get absolute numbers as there's nothing to compare to?. Can we delete this?. Typo: bunldes. Do they recommend to use it for perf testing?. We don't want to implement forEach in terms of map because we don't want to allocate the result just to ignore it. It's fine to duplicate the code in this case.. Is it time to switch to named arguments here?. Why do we need to expose SyntheticEvent?. Can we copy and paste PooledClass into RN repo? It is relatively small and completely isolated.\nI'd like to avoid treating it as part of React's contract, and be able to safely change or remove it.. Should we put ReactPerf and ReactDebugTool imports under __DEV__?\nI think they are currently only imported from DEV-only modules in RN.. Same question about DEV here.. I think this is wrong. You don't need to expose SyntheticEvent for Flow types. SyntheticEvent is a global in Flow (yes, Flow can be weird).. How do we detect whether this code block was eliminated, judging by the source?\nIt can be tricky because it could be, for example, minified but not eliminated.\nI think we should instead do something like return 42; in __DEV__ block instead.\nThen, on DevTools side, we can check both that:\n\nThe function didn\u2019t return anything (DEV mode check)\nThe function doesn\u2019t contain 42 literal (dead code elimination check). Let's rename it to testMinification.. This is the important part, others are just for consistency.. Could we have two versions of FeatureFlags, one with Fiber enabled and other with it disabled? And use aliasing to feed it either one.. Hmm, I don't understand. They would still be specified at the build time, just without a need to look at process.. Replace with an invariant?. Can we keep the stacks?. This is a reference so it should probably go in the \"reference\" rather than \"advanced guides\". Guides read like prose, reference is more like a dictionary.\n\nCan be last item there, after synthetic events.. It should be in the reference so the old category looks correct.. Ah okay. I don't really mind since it's easier to debug things on the client anyway.. I think bundleType or version can be calculated here instead of being passed as arguments.. I don't think this check would work with Fiber. Would it? hierarchy contains fibers which wouldn't have the viewConfig property.. Can we first check that fiber type is either ClassComponent or HostComponent? I don't think it's universally safe to take .stateNode and expect it to be either a class or a node. For example coroutines also use .stateNode for a different purpose, and findNodeHandle() would blow up on unexpected inputs.\nI would imagine something like:\njs\nif (fiber.stateNode !== null && (fiber.type === HostComponent || fiber.type === ClassComponent)) {\n  hostNode = findNodeHandle(fiber.stateNode);\n}\nI\u2019m actually not sure if we even need to check for ClassComponent there because we\u2019d drill down anyway. So maybe it\u2019s enough to check fiber.type === HostComponent && fiber.stateNode !== null.\nWDYT?. I agree I\u2019d prefer we do another pass at this later, but unblock RN Fiber rollout now.\n(After fixing the other issues where we seem very close). Let's move imports to the top.. Let's make sure it's still defined in PROD mode (but is throwing).. Let's make sure this is defined in PROD too.. Nit: let's make the intent more explicit by doing a check in a ternary or an if statement instead of reading emptyObject.memoizedProps.. Nit: let's make the intent more explicit by doing a check in a ternary or an if statement instead of reading emptyObject.props.. Nit: let's make the intent more explicit by doing a check in a ternary or an if statement instead of reading emptyObject.props.. Can we move this section right after Overview? It's what most people are looking for when testing React.. Maybe \"updated documentation\".. Isn't this implying it got deprecated in 16 but will be removed later? Usually we say something is deprecated in the current cycle and removed (or moved) in the next cycle. Otherwise it seems like we have not deprecated it yet (but we did). . We could rephrase \"In React 16.0+, accessing PropTypes from React package will no longer work. [...]\" Then in my opinion it's clearer what will happen and when. . I don't think this matches the package name.\nhttps://github.com/facebook/react/tree/master/packages/react-dom-factories\nWe should probably avoid calling it an \"addon\" since it was never exposed on React.addons.. Please update the gist too when you do it (since it also references the package name).. We can either remove // ES6 here or provide an ES5 example.. We can probably say v15 here because even if we release bugfixes we guarantee it's a drop in replacement anyway. And we want people to install fixes. . Yes, probably. I just mean that we shouldn't give the impression that 15.5.3 is specific version to try because we know it's already broken (for AMD). We should recommend that they use the latest available 15.x version of create-react-class.. Unintentional double assignment?. Let's use v consistently in the message \u2014 either v15 or we can drop v from \"React v16\".. Generally we try to avoid code that is as dynamic as this. It makes it harder to trace what's going on. . Should this be public API of RN? I was surprised FB code uses NativeMethodsMixin but we don't seem to expose it.. I think this would confuse people because it's easy to mistake imports. Maybe ReactNative.NativeComponent? In which case would one use it?. Should this say \"cannot have string refs. Use callback refs instead\"?. While we're at it, can we remove \"ReactOwner\" from the message? I don't think it has any meaning to people outside. . Let's make sure we fix this before merging. Should be something simple (eg maybe there's a resetModules call in an unfortunate place). . Could you please add comment for why this field matters?. Let's note this is internal error and they should file a bug. . Is this TODO part of this PR or a followup? Seems important. . I'm okay with this but we generally are bad at maintaining JSDocs. They always eventually get out of sync with the code.\nMaybe we could use Flow here instead?. I'm also curious about the motivation \u2014 is it because the code is hard to read? Or it doesn't run in some Node version? It it's about the declaration feeling crowded, maybe we could keep the destructuring but move it into a first statement. I'm just hesitant to add comments that aren't checked by a tool, and pretty much repeat the code.. Can we reuse this node now for something else? Should we?. I don\u2019t think so..\nIf the first argument is false, warning is printed.\nI want to print the warning if we have not printed it before.\nTherefore I want the argument to be false when we have not printed it, or true when we have printed it before. Therefore I pass didCatchErrors.. Oh wait, my code contradicts my comment \ud83d\ude04 . This was not necessary (it's a root) but I just did this for consistency so I can remove NoEffect import here. I can put this back.. Do we need to remove this one?. Ah, missed that. Yea, fine to remove then.. I forgot, we added it later. Doesn't make a difference since it tests same thing as globals.. I didn't bother porting this test, for isomorphic (which is where this code leaves on) it's only testing flatten which is not even officially exposed. But I can write it against flatten specifically if somebody cares.. Let's revisit when/if rewrite Children.. Do we need this? It\u2019s only called for items in the hierarchy array which I presume are already not nulls.. I would probably prefer an early return of \u201cempty hierarchy\u201d rather than these kinds of checks.. hierarchy is an array.. Like you do in Fiber.. This means we\u2019re doing something else that\u2019s bad. How do nulls end up in owner hierarchy?. Shouldn't we exit earlier, if component is null?. (which is equivalent to closestInstance in the other version). Just noticed these links don\u2019t go anywhere. I wonder why we have them.. Yeah. This is copy paste.. Feels cool to reuse expectDev for this. We should adopt the same approach for testing flat bundles.. Yes, it's for consumers of CommonJS entry point who use browserify.. We test UMDs, but then this script overrides them to tack things onto React.addons object.\nIt would be nice to make this more solid but I'm a bit out of ideas or care here. I'll test that it works manually later and I'd just leave it at that. It's still better than lack of any tests... I think you'll need to add yourself to https://github.com/facebook/react/blob/master/docs/_data/authors.yml for this to become a link.. Yeah, we should! Good catch.. Let's roll the updates from https://github.com/facebook/react/pull/9951 here too.. I think this should start with ##. It looks giant compared to other headings otherwise.. Let's use backticks, not apostrophes. Backticks appear as code blocks in the post.. Here, too, we should use backticks.. We could also xit them for now to skip, and when we fix them, immediately it them so they don't regress. This would be almost equivalent, except that it wouldn't get indication when a skipped test suddenly unintentionally passes (since you have to explicit it it to see if it passed).. Minor nit: maybe assertConsistentTree or something that makes it clearer this is throwing.. Why did this happen?. That works too.. Backticks. Is \"downgrading\" universally understood in this context? Is there any equivalent way of saying it? \"Softening Deprecation Warnings\" or something like it. \"Downgrading\" sounds a bit related to versioning.. Generally we don't leave domain in posts in case we change the domain. So the link should start with /react/docs/... instead.. If you leave two spaces after this line (and similar headers), you'll see newlines in rendered result.\nOlder posts have two spaces there.\nOr you could use <br> to force it explicitly. (Two spaces after the line and <br> are equivalent in Markdown).. This seems fair to me\u2014it's what renderers do too.. This seemed to make sense to me, I already used it for debugger in the past, and it would be nice to run tests on a Fiber bundle even for non-DOM specific tests.. The first one is still there (I just moved it).\nThe second one shouldn't be there. It was cherry picked to 15.5.x as an urgent fixed so I already added it to relevant patch releases of addons in the changelog a few weeks ago. . This is reported to crash iOS Safari: https://github.com/facebook/react/issues/9956. Check src/node_modules/react. Note: we still have a shim that sets this to false by default, and the bundle code will ask for the shim.\n(Just like in www.)\nThis file is only used for tests.. It seems unfortunate to do this check here since we also check in the code path that calls this function. So it will get called twice for each property.\nCan you please keep a single check in setValueForStyles (and any other methods calling dangerousStyleValue), and instead add a boolean isCustomProperty to dangerousStyleValue?. This is not the only place this function is called as far as I can see. Can you please make sure this argument always exists?. You probably mean isCustomProperty.. injectInternals only runs if DevTools exists.\nCould you please move this out of the method?. This comment explains why we use it, can we keep it? It got lost with the move of this line.. We need this one.. This comment gets a bit confusing now.. Can you explain why these disappeared in more detail? I assume this is before it has thrown.. Yes, it's discouraged. Let's leave this out.. Nit: let's use American spelling everywhere for consistency. Nit: we generally use Capitalized Style for large headers. So that would be \"Why Accessibility?\". Nit: no : in headers. Let's change to \"Standards and Guidelines\". Might need a tiny one-line example here because they use a different convention than other JSX props.. Nit: Accessible Forms. Note: it's fine to not capitalize headers with ### and more so this one is good. Nit: space (outline: 0). Let's remove ReactDOM reference here.. We have existing styling format for notes:\n```\n\nNote:\n(note text)\n```\n\nLet's use it here too.\nThe \"Note:\" will be bolded automatically.. I suppose it's not a class?. Nit: whitespace is usually written as a single word?. Nit: we read it twice here, can we avoid that? \nSupernit: I see two spaces before =. I guess it's just an old message.. I would rewrite this as xIsNext: (step % 2) === 0. That's the intended logic right?. Let's keep it ES5-ish.. I think this should be in a finally block so that it happens regardless.. It would be nice to assert a specific error message here. I don't think Fiber currently has a nice message in this case. Can you look into it?. We still should show the warning even if DevTools don't exist.. Why do we need to disable this? I don't think it tests specifically progressed work.. I don't think this will work. jest won't perform the build. We have a separate task that's used for CI.\nSomewhere here is probably the right place for it.. Did you verify this? I don't think a file with this name gets generated on master.\nYou probably want to add build/dist/react.production.min.js and build/dist/react-dom.production.min.js here.. Let's add a similar test to ReactTestUtils-test for shallow renderer, and to ReactCompositeComponent-test for DOM renderer.. Since there's a new file we need to add it to whitelist in package.json, or it would get ignored on publish.. Maybe let's say \"required for react-native-web\" for explicitness.. Let's change this to should call setState callback with no arguments (and others too). Maybe let's assert arguments.length is 0 instead of checking first argument?. Can you see where that undefined comes from? I\u2019d like to understand it.. You should start using Prettier :-). Can we use = null instead? delete causes deopts in my experience.. Can you comment on this part? What are you trying to detect?. Should be as easy as adding a case here.. Let's use same check as in here and leave a TODO to remove it when Stack is removed.. We can, but we should probably remove it from all such files (there's a few). It's not relevant since flat bundles.. I think I'll send a separate PR for that.. This is just putting method content outside. Variable is no longer needed.. AFAIK our invariant transform does this automatically. But not warning. That said I'm all for explicitness. . Got it, thanks for clarifying.. In general we should avoid adding any wherever possible. It very often leads to bugs. I know we used it sometimes, but I just want to point out for future reviews that it should be used only as last measure.\n(I don\u2019t mean this particular case is problematic, but this is something to always keep in mind.). Was there any specific reason for changing terminology here? Did inputs change? Or was existing terminology inconsistent? In Stack, we used instance for internal instance, but in Fiber we use it for abstract renderer-specific instance (such as DOM node in case of ReactDOM). So both seemed fitting to me.. Could you explain more about why this change is necessary? I still don\u2019t quite get why it was called unconditionally, but now is called conditionally, even though subject (aka inst) type has not changed (or has it?). Oops, I misread. I now see that previous code also had (a different) check. I wonder if changing that check is what caused the issue. I'm still not sure why though.. Hmm no I didn\u2019t misread \ud83d\ude1b \nThis does look like a new check. So my previous comment still stands.. Do I understand correctly that now the code supports passing three different types? Stack instance, Fiber, and a DOM node.. I looked at the stacktrace and it's crashing here (rather than in the other place I expected).. This branching looks odd to me. It seems like it tries to branch on Fiber and Stack code. However now subject could be a DOM node itself. In this case it will go to track() rather than trackNode() which is why it breaks.\nI think this shows why it might be better to reduce the polymorphism here and maybe change this to only accept DOM nodes. But I'd also like to understand why tests (including fixtures) didn't catch this. It is not quite obvious to me.. Hmm. I was under impression it was always passed a Fiber or a Stack instance before this change. Since .tag check is for detecting Fibers.. I'll check that, thanks.. When you run npm test it's Stack.\nWhen you run REACT_JEST_USE_FIBER=true npm test it's Fiber.\nI'm okay with splitting the method if it helps.. >but i'm not sure how to confirm it\nCan you log the value in Fiber mode and look at the type?. I'm having trouble understanding how to hit this code path. In which case do we not have a tracker already? I assumed we always have it since we create it during mount.. I think @aweary is saying that if subject is a node itself then subject.stateNode (which is what we pass to trackNode) is going to be undefined.. How to do this?. That was a great idea, thanks. . Can we not expose it? Since only tests use it and they already have access to DOM node.. subject => node?. What do you think about always accepting nodes instead? Since we immediately get the node anyway.. Can also use getTracker here?. Can we remove mockComponent completely?. Minor nit but it might look a bit cleaner if you extract inner expression into const targetNode = .... This seems like it should be node. We can also just pass it directly: _getTrackerFromNode: getTracker. I only added null cases because others were already handled by existing tests.. This matters because of https://github.com/facebook/react/pull/2113. 0 shouldn't be removed in this case.. I left a few tests here that specifically assert things about markup (e.g. that it doesn't have extra px or spaces).\nThose that only assert correctness are replaced with integration tests.. What about '' + bool?. I see. I don't mind it being explicit. . Interesting release naming.. What is suggested alternative?. We'll delete it in a few days so probably not worth it. . Addressed.. This looks like code change?. Oops nevermind.. It used to return undefined in this code path but now returns ''. Does this matter?. How does it vary? Do we leave this after deleting Stack, or do we change something?. This seems unexpected to me. createPortal looks like a pure function (like createElement) and I wouldn\u2019t expect it to put a property on its argument. Can we do this when the portal mounts for the first time instead? I\u2019m not sure where this code would go though. This is probably not a big deal in grand scheme of things but it does feel odd.\nAnother concern is it might already exist. So this always allocates an object. I think we should create at most one object.\nIt would make me feel better about it if this was a boolean rather than an object, and if we only set it in __DEV__. Then it\u2019s clear it shouldn\u2019t be relied on, and it\u2018s only used for warning rather than keeping data or important logic. In this case I don\u2019t mind side effect that much.. I also wonder if this means createPortal(<div />, null) is going to throw (because containerInfo is null but is being accessed). Which I think ideally it should, but I\u2019m not sure if this is the case now. If we currently silently skip it, it might break product code that accidentally relies on this. I would expect master to still throw in this case though, just later. But we need to verify. Ideally we\u2019d add an early invariant in the future but that seems out of scope.. >Absolutely we should check for the presence of '_reactPortalContainer' before adding another one. Will fix.\nIt seems like if we change this to be a boolean then it\u2019s not a problem and we can always set it. Does it have to be an object?\n\nI could rename '_reactPortalContainer' to 'unstable_reactPortalContainer' to additionally show that it's not to be relied on.\n\nI think we use unstable_ for actual APIs people might call. In this case something like __reactInternalIsPortalContainer would look better IMO.\n\nSo if somehow createPortal was called after the portal component unmounted that would be a problem.\n\nI don\u2019t think this is possible. So seems fine.. cc @sebmarkbage unifying containers and portals might provide a less hacky solution to this.. Don't forget to revert this :-). Seems like we should still report it? I'd imagine we branch message, name, stack initial assignment on whether error exists or not, and make message be error coerced to string if it's missing.. This lets us not mutate the node in what seems to be a pure function.. No, it's just not minified. We might minify it eventually but for now it doesn't seem necessary (it goes through our pipeline anyway), and it's easier to see what happens during the sync.. Addressed.\n. We are trying to get away from unit tests like this because they make it hard to swap internals. Can you instead write an integration test? Either in the ReactDOMServerIntegrationTest if it's testing markup mismatch or maybe more targeted test right here (but that would use ReactDOM.render and reproduce this though public API instead).. I'm surprised why aria tests in integration test don't trigger this path. Can you check why?. Oh OK. Then I don't know. :-). Let's render two different types? e.g. [<div key=\"1\" />, <p key=\"2\" />].. Why do we need to do this? (Note: I'm not very familiar with this code so I'm learning it too.). Do warnings still work? You can add a test similar to this one but using an array.. This can be removed now?. I'm not sure this is sufficient. For example it could be a nested array. Conversely, it could be an array of invalid things (e.g. array of objects), and we'd want to throw in that case.\nI think the validation should be moved to a further stage at the point where we actually process the next frame. Which is the same strategy we do with Fiber. This way we don\u2019t do validation immediately, but we throw if we meet something invalid.. We still need this test because it tests both server and client.. Can we go with very minimal function prototype thing rather than Babel class output? We\u2019ve tried very hard to trim down isomorphic React package, class output was a bit bloated last I checked.. It was default in the old code. . This still seems too early. It only validates top-level element, but not its children. What I was referring to is that we have this validation in PartialRenderer and it should probably throw in some cases otherwise. Validation should happen as we resolve children rather than at the top.. Does something polyfill global in the browser?. . Right, but don't we still want to throw if it's neither array nor valid element?. >caution that in the past this made the transforms fail for me because the transforms read NODE_ENV and expect it to be 'test'. might need to set it to 'test' and back before/after the babel transform in the jest preprocessor.\nThat's what I ran into. I suppose yes, we'll need that.. Oops, thanks for pointing it out! I totally did not think about the onions. \ud83d\ude1b . #10274. Oh, please do! I remember this really tripped me first time I looked at this.. Hmm. I guess I misunderstood.\nIt was deleted but then re-added.\nhttps://www.wired.com/2012/02/the-html5-time-element-is-back-and-better-than-ever/. Updated comments.. I removed this test. It seems like the only mutation method we use is value, and AFAIK there are plenty tests about it specifically. Internally at FB we don\u2019t inject custom properties with mutation methods either.. I removed this test. I couldn\u2019t find any cases where property name would differ in practice\u2014neither in master nor internally at FB. If we add such case we should add an integration test for that specific property instead.. I couldn\u2019t figure out how to write this test in terms of public API. I tried rendering <select multiple> with both value and defaultValue, and then rendering <select> without multiple but couldn\u2019t get this test to pass. If I need to bring it back, can somebody please explain how? Or maybe this is better suited for DOM fixtures.. The diff got a bit messed up. The new test is:\njs\n     var container = document.createElement('div');\n      spyOn(console, 'error');\n      ReactDOM.render(\n        <input type=\"text\" value=\"foo\" onChange={function() {}} />,\n        container,\n      );\n      ReactDOM.render(\n        <input type=\"text\" onChange={function() {}} />,\n        container,\n      );\n      expect(container.firstChild.getAttribute('value')).toBe('foo');\n      expect(console.error.calls.count()).toBe(1);\n      expect(console.error.calls.argsFor(0)[0]).toContain(\n        'A component is changing a controlled input of type text to be uncontrolled',\n        );\nBut I\u2019m not sure this is right. As you can see, the last line in the old test:\njs\n      // JSDOM does not behave correctly for attributes/properties\n      //expect(stubNode.getAttribute('value')).toBe('foo');\n      expect(stubNode.value).toBe('');\nwas actually not true anymore. However uncommented line works:\njs\nexpect(container.firstChild.getAttribute('value')).toBe('foo');\nI\u2019m not sure what\u2019s going on here, and whether my test reproduces this case, or not.\nWhat is this really testing?. cc @syranide who wrote this test originally in #1510. Answering to myself: this test was written in https://github.com/facebook/react/pull/6228, seemingly to fix https://github.com/facebook/react/issues/6219. Perhaps I can use fiddle from that issue to recreate the original problem.. Hmm. I tried rendering uncontrolled select and then rendering it without multiple, and these assertions failed. I'll try again.. Unfortunately I don't know \ud83e\udd37\u200d\u2640\ufe0f We have the old unit test but it's not clear to me whether it is testing the right thing. . By the way we could remove the boolean flag if we used a sentinel. E.g. var noError = {} and then error === noError. . This name can look confusing in stack trace. Should we rename to something like runApplicationCode? (That's probably a bad name though.). Typo. \"Clever\" is a bit self congratulatory and probably doesn't work for the case where we can't provide useful info. I probably misunderstood, thanks for clarifying. I thought the flag only existed because null/undefined is a valid error. . Yea, just channeling my first reaction if I read this as a user :P. Maybe \"We try out best to [...] but [...]\". Seems like we need to change 144 to be \"Item must have been set\", and then it'll be good on next generation. That's because we temporarily re-added prop-types into alpha for RN's sake and then removed it.. This line doesn't look right. It should be Item must have been set.. Forgot about it. Want to send a PR?. Let's add some context here? It's not clear what stack traces this refers to. Something like:\n\"React 16 prints all errors to the console in development, even if the application accidentally swallows them. In addition to the error message and the JavaScript stack, it also now provides component stacks. Now you can see where exactly in the component tree the failure has happened:\". This breaks for arrays returning one element.. For example \njs\nfunction Foo() {\n  return [<div />];\n}\ncrashes.. Let's not call toArray() unless we know this is not a single element. The case where single element is returned should be a fast one. For example return <Foo /> shouldn't wrap <Foo /> into array before traversing down.\n. Seems like we also need to remove this check from renderToStaticStream as well?. Let's also make the component return array as well. This way we verify it's supported at multiple levels rather than just top level.. Let's move this test to ReactComponent-test close to the non-SSR similar test.. Same, let's move it close to identical non-SSR test.. Yes, please let\u2019s keep this focused on Map and Set.. Changed these for consistency with ReactDOM.render message. I'm not sure if it mattered in all cases (e.g. these ones are behind a flag that's now false in integration suite) but I changed them all for consistency.. We used to only check the first one.. Special case because shouldReuseContent() bails out. Happy to change this to use hydration API per conversation with @sebmarkbage, but I'd like to do this as followup.. Adding this to every error. Helped uncover cases where we crashed instead of throwing something useful.. New features are now enabled for all fixtures in this file. We don't ship \"no new features\" SSR builds anymore.. Added tests for top level string and number, and renamed array tests.. This is now valid.. This is now valid too.. Is this intentional? Do we need to rename the test? It says \"should throw\".. I copy pasted these tests into two separate groups.\nOne still calls render() and, for cases where markup is reused, we verify that in Fiber mode we print a deprecation. We can delete this group of tests in 17.\nAnother calls hydrate() and we don\u2019t expect deprecations there. The new version also removes non-Fiber branches since hydrate() only exists in Fiber.. Isn't the data-reactroot attribute enough for detection?. To be honest I don't understand in which case this would occur. I don't think I've even seen this message before.. @spicyj I think you wrote this part. Could you remember when this happens? I don't think we have an explicit teardown step anywhere.. I figured it out. It was asserting we didn't overwrite console.error explicitly in a test. Changed the logic to verify the same thing (but for warn too).. What is a non-container?. This is much nicer, thanks for pointing it out.. Ah okay. Will do. . Want to send follow up? We actually already have this as a constant in the same file. But literal is used in more than one test.. Existing constant is TEXT_NODE_TYPE.. This might be interpreted as advice against CDNs. Which I'm not sure we want to give? Do we have opinions on this?. Probably worth leaving a comment explaining why we need these two paths. . To clarify, it doesn't work at all without HTTP server, does it? At least not until you tick some setting.\nI took this wording from the existing code but happy to change.. That's probably because you checked \"allow access to file:// URLs\" in Extensions. But it isn't checked for new users by default. \"Why doesn't React tab show up\" has been the most common question about the extension. This is why we made the \"inactive\" icon link to this FAQ.. Now that we have the icon button, maybe the message isn't as important.. Yea, I understand. I'm just feeling \"works best\" is kind of vague and I'm struggling to find a more precise wording. The original was more precise in that it clearly prescribed what to do.. I came up with this:\n\nBut I like yours better.. Settled on this.\n\n. Let's keep it like this for now.. Seems unused?. Since this plugin doesn't take care of dev expression can we rename it to replace-invariant-error-codes?. cc @mjackson, have you had a chance to look into this for unpkg?. Global find-and-replace?. FWIW the link to gulp script is broken. We should probably just press y on GH and use a link to specific commit next time. Then it doesn't matter if we move or rename.. But I don't think it's super important to fix.. We could add shims that throw for renderToStream() APIs here. Then it's less mysterious.. We don't track these anymore, so yes.. Yea, let's remove it.. I think this sounds right.. Maybe let's make one of them an object?. I can confirm just crossorigin is enough.. Aren't we inside a __DEV__ block already? I don\u2019t see how we could get into this branch.. What is the purpose of repeating the call stack? Seems like just like we don't log the message now, we might as well skip the JS stack.. Why do we log this in production if browser always also logs it? It's not clear to me what is the value of repeating the same stack trace twice. I previously thought that browser doesn't always print it, but from the discussion here I understand that it does.. Done.. Can we leave this test for now? We still use injection internally in one place, and passthrough attributes didn't solve that case because the attribute gets an object.. What is special about objects and functions? Why not a switch that passes strings, numbers, and bools? Seems like explicit would be clearer.. Let\u2019s make this value === null || type === undefined instead of value == null. Otherwise this will also check document.all (yes, JS is weird).. Why are key and ref important here? I'd expect them to never be in props, and therefore, never be arguments to the \"set attribute\" methods. They exist on the object you pass to an element, but shouldn't be in element.props.. Should the warning now say Either remove this prop from the element, or pass a string, number, or boolean value to keep it in the DOM.\n?. Maybe shouldSetAttribute? Seems like it being used for attributes is an important part.. Must be related to https://stackoverflow.com/questions/10350142/why-is-document-all-falsy. Alternatively let's just add ajaxify to the list of known attributes. Then it will be coerced to string. I know it's not a real attribute, but we use that thing and it's not going away. Adding it to the whitelist will let us remove this injection support.. Seems like test title doesn't reflect the test anymore.. Let's remove this and onAfterResetModules. It was only needed for ajaxify.. To avoid two extra functions calls in DEV. (It's small but can add up.)\nAlso I find our warning notation with falsy condition meaning a failure very confusing. I try to avoid it whenever I write warnings, and always use warning(false so it\u2019s clear from outer condition in which case it executes.. Yea.. You can also remove logic that deals with onAfterResetModules in resetModules. That was the only place using it.. Typo: explicitly. Is there anything special about it?. Is this a note about server renderer? I imagine we don't get into style branch on the client because there\u2019s a hardcoded one earlier.\nWhat about custom elements? Does style still work correctly on those? (And did it at all in the past?). I think for now we're okay with doing whatever we used to be doing.. Can you explain this logic in more detail?\nWhat did it use to do, and what does it do now?. Should we check for value here?. I'd like to have a few more integration tests here. Similar to tests you added to ReactDOMComponent-test, I'd like to verify that server and client renderer behave consistently with regards to unknown attributes. We should assert that numbers/booleans/strings get passed through, objects/functions don\u2019t, and that there warnings are emitted when necessary.\nWe can probably even delete such tests from ReactDOMComponent-test because these are more exhaustive (they test both client and server, and that they match up).. Only. PR welcome :-). Nit: if you remove spyOn you can also remove the expectDev assertions. By default we fail the test if there's unexpected warnings.. Style nit: if there's newlines after each line, might as well collapse them.. I think this comment referred to the use of lowerCasedName in the previous version, but now it kind of become stray. Is it intentional? Do we have tests to verify that for data-MyAttribute we will still suggest data-myattribute?\nMaybe then let's move this comment to where this logic happens now.. Is it not obvious to me why this is necessary. Do we have a test verifying this change? Can you add a comment as to why we do this?. And is this only necessary for custom tags? What about custom attributes? If I do <div myAttribute=\"\" /> or <div data-MyAttribute=\"\">, does this also mess up server validation?. I don't think we have any consistent style but if anything, existing tests look too sparse to me. We generally only put newlines between independent parts of the test (e.g. test of two different cases).. Could be outdated. Worth looking at the blame when it was added to see if there was a good reason it was intended to warn at some point in the past.. Why did the test pass then, if it\u2019s wrong? Is it because we were testing internals rather than public API?. In other words, I think my test is not faithful to the original test, but is faithful to the actual behavior in 15.. None. Just seems a bit more flexible. . What are alternatives to doing this check?. Typo: implements. Number. https://www.w3.org/TR/SVG/fonts.html#FontFaceElementAlphabeticAttribute. Boolean. https://www.w3.org/TR/smil/smil-timemanip.html#TimeManip-autoReverseSyntax. Number. https://www.w3.org/TR/SVG/fonts.html#FontFaceElementIdeographicAttribute. Haha :-) It's a bit tough to find. . Worth adding an explicit space here? Direction:{' '}. This is slightly confusing because if I use it, it says:\n\nWarning: Invalid DOM property innerhtml. Did you mean innerHTML?\n\nBut then if I try innerHTML, of course it isn\u2019t supported:\n\nWarning: Directly setting property innerHTML is not permitted. For more information, lookup documentation on dangerouslySetInnerHTML.\n\nIt seems better if the same warning was displayed immediately (or if we just got a generic \"unknown property\" warning for wrong casing like innerhtml).. These two are currently not validated at all. If I type\njs\n<div onfocusin={function() {}} />\nit will silently ignore it. I would expect it to warn.. Is value always a boolean? In this case shall we name it hasDifferentCanonicalName or something like this?. Works for me.. Where do these become lowercase? This comment confused me a bit because I expected to find toLowerCase() call somewhere close but it\u2019s not there.. So this is the case where shouldSetAttribute seems like confusing naming, right? Since in case of null it won\u2019t \u201cset\u201d the attribute but rather remove it. Is that right?\nDo you think shouldUseAttribute would be better naming?. I like to say canonical form.. I'd like to leave the test specifically for ajaxify in. So that we don't accidentally break it with something else.. It's not ideal but we're not even sure we want to support it longer term. Probably not. But people (and we) already rely on it so maybe we can do it for a version before flipping it.. Yea, we should generally do a pass and inline extra the property access in this and similar functions. Let's do it after we decide the fate of this PR.. What bundle is this? Not really important but I don't think we have it :-). It's currently on ReactDOM. . This should probably include \"Read how to correctly configure React for production: \" and an fame link to \"Use the Production Build\" in \"Optimizing Performance\" doc. . This outer wrapper is probably unnecessary since we are already calling it from the same condition. . Let's extract this to a variable to be consistent. . Maybe \"ReactDOM was loaded before React.\". The other sentence looks good to me. . This will break hot reloading (which we just fixed). Do you mind sending a PR to react-deep-force-update to account for this change? Should be as easy as checking both fields. . We should still add an expectation. So that it doesn't emit some other unwanted warning by mistake in the future. . This is a very hot path. How do you feel about hoisting the condition right here (duplicating it) and only calling the function in the bad case?. Can we provide component stack here?. Only. Need to fix this, otherwise should be good to go. Does it need to be in the table of contents? Normally we don't add items for warnings. Those who have them will read this by following a link, those who don't probably don't need to know this. Every item in TOC adds some extra mental overhead for people learning React. . I offered another way to phrase this in Quip, feel free to use that or combine. :-) . That's how it used to do but I wanted to avoid extra overhead for calls for every single prop. These things are small but sometimes add up (like when we fixed DEV performance in 15.3). . But I don't feel strongly. Didn't think about the object case where it could change. . Does it? My impression is that by default Webpack won't either generate source maps nor use evals. . Oh, I see. I think most people won't have the debug field set (in my experience it's not commonly known, and I also can't find docs for it). . There is no space at the line end so sentences will appear to run into each other.\nAlso, let's phrase it a bit more user friendly. Most people don't know what \"composite\" means.\nFor example: \"TestUtils.Simulate expected a DOM node as the first argument but received a component instance. Pass the DOM node you wish to simulate the event on instead.\"\nYou don't need to mention \"DOM component instances\" because they don't exist anymore in React. Only DOM node is a valid argument these days. . Nit: I think we usually end warnings with periods (before the stack) so that they look like sentences. . The way it is written here will break other things in non-trivial way. Please check ReactDOMProduction for example of test that overrides process.env.. In fact it would be great if you could send a PR to master that fixes DEV override to work same way as in ReactDOMProduction-test. . Minor nit: this warning doesn't use backticks but the one for DOM props does. . Need to change test title to match new semantics.. Same. . Same?. Should we revert changes to Yarn lock? Seems like Uglify update could also go into a separate PR with just necessary lockfile changes. . I wanted this line to be inside try catch in case toString throws. I think this can happen in restrictive environments although not sure where I saw that. . It would still be nice to update it separately though :-) maybe it has improved in the meantime. . Let's also change this to say \"expects a DOM node\". . In fact let's make the wording identical to the new invariant but with \"received a React element\" instead of \"received a component instance\". . Minor nit but can we keep Element here? It refers to DOM Element type (which is what DOM node is), not to argument name. . Sorry about the churn but I just realized this part is important. I missed it on the first read. Can you please add it to the message as the last sentence for this particular case?\ne.g. \"Note that TestUtils.Simulate [...]\". The old test name was clearer. The new test name doesn't explain what should throw. Similarly \"attempting to use a React element\" is very vague.\nI think the choice here is between the old name and \"should throw when attempting to pass React element to Simulate\". I like the old name better because it reflects a real use case where this could happen. . Same issue: the test name is vague (\"use\" how?)\nLet's change to \"should throw if Simulate receives a component instance\".\nAlso we should probably group both tests under existing Similate describe block. . rendererName? rendererUniqueName? People cloning ReactDOM might think a \"type\" would still be ReactDOM.. We should still include the filename IMO. Maybe make it the first line, and then the rest?. Why do we use Invalid wording everywhere except here?. Sounds good to me!. Why do we start from A three times? Are these generated from different whitelists? In this case should there be a comment explaining grouping\nOr we could sort them all. . Could you also please add this to React Native entries?. This intentionally wasn't the case before because per discussion with @sebmarkbage this can lead to passing \"false\" value to some new DOM attribute that might treat \"false\" as truthy. I am assuming that you discussed this and decided that having less edge cases is more important/intuitive than this problem.. Why are we comparing value to object string? This used to be a typeof.. What is the \"special warning for children\" referring to?. (This comment is to @acdlite @flarnie). Was this test deleted intentionally? It looks valuable to me and tests public API.. I tried keeping just one project but even the newest version of Jest (21 alpha) crashes with just one project so I had to inline the config back. cc @cpojer in case this is not known.. Right, thanks. I remember a few issues were recently closed so I wasn't sure. Sorry I didn't check \ud83d\ude1b . Can we use React.Component here instead? I thought that's the recommended alias. . Ditto. (And actually this should take React.Node I think).. So far, we\u2019ve been focusing on the regular DOM elements so we didn\u2019t change the behavior for custom elements. Given that 16 is imminent we\u2019ll probably have to wait before 17 to change it.. :). It is a legit type but it's the internal name. I don't think it's meant to be used directly. The \"friendly\" alias is recommended for real use.. I might be wrong though. Maybe @calebmer can tell.. Yes, they're global and safe to use. I didn't mean to say they're not working. It just looks ugly and if there's a \"proper\" way to use it, I'd prefer that. But it's not important and not blocking this diff.. Is adding HAS_BOOLEAN_VALUE always safe? It changes semantics (falsy get removed). Are any of these actually true by default?\nShould we keep using this flag or should we introduce a new one?. This comment is now outdated.. Ditto.. Here too.. And here.. Maybe we can tweak the wording here. But it is intentional that behavior is the same for known and unknown attributes. . >Known boolean attributes will not warn because of the propertyInfo checks.\nYes, that's what I meant. The only ones for which we pass booleans through are the booleans we know. We don't pass booleans through for either known non-booleans or unknowns.\nThis keeps it unobservable whether a certain non-boolean attribute is known or unknown. Without this guarantee we can't hide the fact that, for example, src was cut from the whitelist. Implementation details start to leak out in the behavior.\nOf course that means we can never delete booleans from the whitelist. But that seems like a fair tradeoff.. >So how can a user correctly use a boolean attribute that we don't have whitelisted?\nBy casting it to a boolean.\n\nI don't think behavior changes in previously-known attributes implies implementation details are leaked; it just means attributes behavior has changed.\n\nI don\u2019t understand what you mean. Can you elaborate on what you propose instead? I think we might be talking past each other.. >I'm not sure what you mean, I'm talking about attributes that should already be accepting booleans.\nAll of these are in the whitelist. Are they not? It turned out to be pretty small (<20 attributes), and since HTML is not adding more boolean attributes at a giant pace, it seems okay to keep that whitelist.\n\nI'm suggesting that we accept this change, but add some warnings when previously-known attributes are passed invalid values.\n\nCan you write up a comment with \u201cbefore\u201d and \u201cafter\u201d for each case? We\u2019ve spent a few hours with @sebmarkbage talking about it yesterday and there are subtle things that are easy to miss. If you flesh out a table I can probably point out why we didn\u2019t go with that proposal.. it.only. This is fragile. Somebody might assume domElement is always a domElement in isCustomComponent, and break it.. domElement wouldn't be null.. Pushed a commit that does this slightly differently.. Nope :P. I think we already pass it wherever possible. It's only called at entry points like diff and createInstance where we don't know that info.\n. They're needed to determine if we should follow the custom element path (\"pass everything through without restrictions!\") or the normal path. Do you mean you want to unify them?. Without this, they don't get set correctly (you can try in an HTML file). I don't know. Maybe not?. It turned out we actually use data and have it in whitelist. Apparently it's useful for <object>. Yes, could make it a warning.. What is special about these files? If those are old translations should we delete them?. I think it's fine to leave as is, we didn't do this before either.. Let's not forget NODE_PROD too.. Fiber codebase doesn't use return value (which is always allocating an object).. The only case in which this wouldn't be equivalent is if element is truthy but not a DOM node. Doesn't seem like this could happen.. I deleted this set of assertions. I'm not sure what they're supposed to be testing but they didn't work in the first place.\nThe intention was probably to match whether an array contains an item, but toBeTruthy() check passes for -1. And -1 is exactly what we get on master because dependencies array looks like this:\njs\n      [ 'topBlur',\n        'topChange',\n        'topClick',\n        'topFocus',\n        'topInput',\n        'topKeyDown',\n        'topKeyUp',\n        'topSelectionChange' ]\nbut value being tested looks like\njs\n      'blur'\nMaybe there's some better way to test this but I figured just asserting the count is enough.. Stack code still relies on return value for unsubscribing. Fiber doesn't. I inlined the old Stack-friendly version right into Stack.. Deleted this aggregation because it goes through the same code path now.. I think it doesn't. Relies on GC to clean them up.. This is Stack-only codepath.. There exists a mobile version that wraps into TimeSlice guards but we don't use it. At least not since flat bundles. Nobody complained.. I manually checked the callers and I can\u2019t see how it possibly can be null. It always corresponds to domNode from either ReactDOMComponent or ReactDOMFiberComponent.. I don't think an invariant is very valuable here because it's a leaf code path (throws immediately with a very obvious message).. Aah, I get it now. We leave fbjs/lib/EventListener import in the www flat bundle, which actually redirects to the internal EventListener fork.. @aweary Yes I think we can.. Was this case removed intentionally?. It might be better to put this assertion first because otherwise the previous assertion would probably blow up with Cannot read property 0 of undefined. I haven't verified this though.. Same here.. Nit: I don't think we use Markdown in test titles anywhere.. Right. So maybe there's some way to tell it to preserve the comment with some special syntax or @license word in it. . Even if we add this warning I don't think we plan to strip them. Rather, we'll warn but leave them in the DOM.. Maybe I don't understand the first question but in Node environment it is expected that code is not minimized or altered in any way.. Yes, I'm mostly referring to findDOMNode case.\nI don't think we support running tests in production. For example test renderer throws in entry point if you try that. I guess we could relax that if there are valid use cases. . This is an old test. I just renamed it and moved down.. Let's remove \"experimental\" here, I think we support it pretty well now.. Let's make jsdom a link since people might not know what it is.. \"DOM tree\" is a bit iffy when said about React Native. Maybe \"a snapshot of the platform view hierarchy (similar to a DOM tree)\"?. Let's use ES6 in main example.. Maybe let's wrap link into text, e.g. [Learn more about it.]. Let's change to \"You can also traverse the output to find specific nodes and make assertions about them.\". Let's change this code to do Jest assertions with expect.. The createNodeMock documentation is a bit too vague here. I also don't want to call it out too prominently since it's mostly useful in a very specific scenario that's best described separately. Ideas?. I think it\u2019s important to mention this since people will often get this warning due to spreading.. Changing these calls wasn't essential but I figured I'd emphasize they are normalized by the browser anyway.. These tests were not specifically about casing so I fixed them.. Copy pasta from ARIA hook. Catches more cases which ensures we don't fire two warnings instead of one.. This is an unrelated change, and seems like Chrome version difference. Setting <link as=\"whatever\"> doesn't return \"whatever\" from link.as property anymore. But it works with valid values like \"audio\".. Shorter suggestions?. Oh I just copy pasted. I didn't actually check the semantics, assumed it's there for a reason \ud83d\ude1b . I guess putting things onto functions is also not nice?. Yess. I wanted something that would be hard to accidentally introduce into the function elsewhere. Because then you'd get a false positive. I guess I could search for throw instead?. What about this TODO btw?. Let's remove this section. There is quite a bit of new (or improved) warnings in 16. These are just the ones added between RCs and IMO having them here is more confusing than skipping the whole section. . Nit: we can remove Arrange/Act/Assert comments as we don't use them in other tests. . Yes, we could automate it. At this point I don't think it's important if we manually verify it works once.. Should we version this separately? Regular changes to React will be breaking changes for the reconciler.\nWe should either start with 0.0.1 or 1.0.0 \ud83d\ude04 . I would prefer a flag on the bundle, like we do for isRenderer. Or, ideally, unify them under a required enum: 'isomorphic' | 'renderer' | 'reconciler'. But unification can wait.. Maybe worth changing to \"New JS Environment Requirements\" to better signal it is a change.. I would prefer we don't advertise core-js and babel-polyfill in this way without a specific example. I believe we had an example somewhere (in the issue?)\nThe trouble with this wording is it looks like we're promoting importing the whole polyfill (e.g. import 'babel-polyfill'). We should not. They are huge!\nIn the example we had, we specifically imported only the necessary ones. . (We don't have to literally paste an example here. It's enough to link to the docs, where we might want to add the same info anyway. Or we could link to a gist.). This will not turn into a link in a Markdown file. GH only linkifies in comments and issues.. This also looks pretty bad in Markdown file. These need to be turned into real links.. We should put filenames in backticks for nicer formatting.. I would prefer if we separated error boundaries and portals into a separate \"New Features\" section. We could also add that components can now return arrays and strings into it, and that custom DOM attributes are now passed through (since it's technically one of top requested features).\nThen the second section would be \"Breaking Changes\". It's fine to repeat the \"unknown attributes\" thing there since in addition to being a new feature, it's also a breaking change. But other new features (portals, arrays, error boundaries) are not.. Tiny nit: eg => e.g.. Why is this one bold alone? Let's either make all of them bold or none. They're roughly the same level of importance. . It's not clear what it is. We generally try to make changelog easy to read for somehow who's not very deeply familiar with React. For example this could say: \"First-class support for declaratively rendering a subtree into another DOM node with ReactDOM.createPortal().\". (I don't think it's important to give the PR number here since the only thing my PR did was rename a method. But people reading this probably aren't familiar with the whole idea itself. IMO it's only useful to link to PRs if they show actual implementation. For this case let's just not link to it.). This looks like a commit message. Let's rephrase to match other items? For example, \"React DOM now allows passing non-standard attributes.\". Nit: not clear why this one is bold but others aren't . \"in some cases\" sounds pretty restrictive but in practice they will almost always be passed (except for invalid values). Let's change this to \"for valid values\" (and keep the link to the post). . \"And there is no data-reactid anymore\" sounds a but odd to me. Maybe \"It also doesn't use comments for empty components and data-reactid attributes on each node anymore.\". Capitalisation nit to match other sections: Removed Deprecations. I think we should add a separate point about error boundaries here as it is a breaking change. Specifically:\n\nErrors in the render and lifecycle methods now unmount the component tree by default. To prevent this, add error boundaries to the appropriate places in the UI. (And make it a link). This looks counter-intuitive. I would probably replace\n\njs\n       if (isRenderer) {\n         externalModules.push('react');\n       }\nwith\njs\n       if (moduleType !== ISOMORPHIC) {\n         externalModules.push('react');\n       }\nbelow.\n. Seems like we can get rid of Promise.all here?. I think we should instead check for ISOMORPHIC here, and reverse the ternary. Isomorphic gets the real thing, everyone else gets the shim. Even though technically we don\u2019t have reconciler UMDs anyway.. It's the only reserved attribute that actually needs to appear in the DOM. Previously this was special cased by leaving it in the DOM config (even though the flag was set to 0 with style: 0). Now we don't have a config so it has to go somewhere else.. I don't really care about this yet, as we'll likely change what's inside of these methods anyway. I'm mostly looking for feedback on the overall changes in how functions call each other.. Yes, flowifying and turning into something simper is in the plan. (Although it's already smaller than the original.). In general I found the distinction between *ForProperty and *ForAttribute very confusing because it's often lying (\"properties\" can use attributes).\nThis indeed seems like a bug, can you write a test case for it?. Oops, looks like we print a container name instead of the tag name. Will send a separate fix.. Yes, that was my original intention. See https://github.com/facebook/react/pull/10818. This seems okay to me but shouldn't we do this consistently? We don't use Invalid for event handlers.. Nit: it's usually better to avoid passive when possible, and use verbs over nouns.\ne.g. this reads easier:\n\nWe've added support for returning strings from the render method too.\n\nor\n\nYou can return strings now as well!. Should we mention we are considering adding a syntax that wouldn't require keys in the future? I suspect it will be the most common question.. It's on ReactDOM. (Although we might provide an isomorphic version someday.). divNode is a bit odd, maybe domNode?. Aickin (name in text has a typo in it). IMO we should also mention performance improvements here, again, maybe quoting Sasha's article.. Specifically that you don't have to bundle the server app anymore to get good performance.. Hanging \"The\" at the end. Needs backticks for methods. Maybe worth saying \"New Deprecations\" to make it clear these aren't deprecations we removed. refs link is broken Markdown. Should we mention somewhere that we expect all addons except Perf to work in the foreseeable future, but won't publish more updates to them? And that we'll consider bringing Perf back at some point in the future, but for now we recommend using the browser timeline as documented?. Yea. . Hmm. I don't remember if this was intentional or not. Maybe worth filing a bug to discuss?\nMy impression is that render() still clears the root element.. No, this only affects how synthetic event propagates. . Maybe you're not using latest Chrome? I recently updated those (see blame). . Should we use quote formatting here with >?. Maybe worth calling out it's a synthetic bench like the article does. . Lol. URLs have changed. These won't work. . Typo: foreseeable . \"In this issue\" maybe should become \"in a new issue\". Missing JS syntax . Broken URLs. We probably need to update them everywhere. . (Because there is no /dist anymore. UMD builds are in /umd). I removed this since it's not meant to be used directly. You'll get the right thing on the client even if you try to use react-dom/server.. I figured I'd remove this one as well since it's neither common nor recommended, and people who need it probably can figure it out.. That would be great.. What would be the best place to add it? I'll leave that to you for now, running home!. We're not specifying multiple languages, but we do use the js{3,4,10-12} trick for line ranges.. ?. Can you add a comment explaining what you're trying to do here?. Maybe\nConsider the code below written with JSX:\n\n?\nOtherwise it doesn't read like a sentence, but the continuation is already a separate sentence. So it's a bit awkward.. amount => number?. The sentence about \"the given component can be...\" is a bit hard to read because of parens. Can we turn this into a bullet point list?. Please don't use absolute links in the docs. Make it start with /docs since that's what the new website will use.. missing \"as\" before creating. Nit: single quotes. Let's just unify 2 and 3 under \"A React component\". Whether it is a class or function doesn't matter to the user.. Let's also remove the unnecessary arguments? They look weird here. Or you can make them , props, children.. This is a bit hard to read because the sentences repeat a few phrases too closely. shorter/shorthand/shorthand; creating elements / creating elements.. Wrong order in Markdown link (doesn't render). Same.. Worth noting that if you change site internals like plugins, it may be necessary to remove .cache directory and restart the server for changes to take effect.. The ssr error, ssr mismatch for Symbols doesn\u2019t sound great, but it\u2019s an existing issue with SVG attributes (you can search the file for many more matches). We should fix that separately.. This shows it worked.. I don't think parentNode can ever be undefined, can it? I would expect the browser to always give us either the node or null.\nEven if it can be undefined, let's just explicitly test two cases. We\u2019ve been doing this elsewhere for explicitness too. This is also a tiny bit faster than != null check because != has to generate some additional special code for historical reasons.. Is this the best place for this invariant? I'm curious if there's any way we can validate earlier. Or do we have this problem because early validation didn't help?. How does adding an invariant in the same place help us? Presumably this trades one crash for another?. Doesn't really matter. :-). Maybe we need a lint rule \ud83d\ude04 . That wouldn't help with properties that aren't in the whitelist.. For consistency with other packages.. Can we move into renderSubtreeIntoContainer since it covers more code paths?. Not super proud but I couldn't get Flow to understand I'm just trying to cast to string.. Ah I see. I guess we should update the custom ones too in this case.. This doesn't seem to check for .multiple. . You don't need this (or spyOn call). By default we assume none of the tests warn unless they opt in.. Instead you'll want to assert that the on attribute gets set (which it probably doesn't right now).. Can we just check name.length instead?. Why do we need this? If you append a child to another parent, it will be removed from the current parent.\nIsn't just \njs\n        get: (target, prop) => {\n          return target[prop];\n        },\nenough?. Please check this, yes. The comments might be very outdated.. Didn't it deopt when you have continues rather than break? I don't remember. @trueadm . Interesting. What you're saying is right for document.createElement(), but not for document.implementation.createHTMLDocument('').createElement() which is what we're using. I'm not sure why there is a difference (is it because it doesn't have a body or something like this?). If I remember it right I tried commenting both places out separately after adding the tests, and both were necessary. This one resets when we're entering a tag, and another resets when we're leaving a tag.. Please remove Warning:, it gets added automatically.. This is a bit hard to follow. Let's just wrap it in an if block with the real condition, and then pass false to the warning call.. I would tweak the wording to:\n\nThe <%s /> component appears to have a render method, but doesn't extend React.Component. This is likely to cause errors. Change %s to extend React.Component instead.\n\nYou\u2019ll need to pass the component name (use getComponentName).. This doesn't sound right.\nCan we instead fix it to be able to safely use ReactInternals?. It's not \"isomorphic\" (we only call the main React package this).\nCan we instead fix it to get Object.assign with ReactInternals?. Can we just inline this file into the fixture index.js? Otherwise it'll keep popping up in the autocomplete when we're looking for the real one.. That's not what it does anymore.. Yea.. In that case the change was correct :-) As long as it works then we're good.\nI didn't mean the change is necessarily wrong, I just meant that it is surprising and we should have a reasonable explanation.. I want to rework how it's done entirely (see https://github.com/facebook/react/pull/10805), and it would be more convenient if it was still centralized before I did that.. This feels wrong. We're relying on a variable name here that can change at any time.. (Not that I have any solution here.). When it's updated add it there too :-). We definitely should not be versioning the reconciler package together with other packages right now. I'd be okay bumping a minor on every release (e.g. 0.1.0 -> 0.2.0 -> 0.3.0). It is changing way too fast and I don't see it stabilizing for another six months or so.. Releasing patch by default won't work too. We will break it between main React patches pretty often. Ideally we should increment a 0.x minor for it when the Flow file changes, but I think the low-maintenance \u201calways increment\u201d approach will work fine in the meantime. People using this know it\u2019s very experimental anyway.. >I worry it adds confusion for end-users\nThere are, like, 10 end users. Only people creating custom renderers are end users, and they are already used to patching React and digging up super complicated internals just to get it working. So this is already a large improvement for them.\n\nt's a nicer developer experience to know that react-reconciler version X is compatible with react version X \n\nThere shouldn't be an issue with react <-> react-reconciler dependencies and we can safely say any react-reconciler version is friends with react@16. This is because we don\u2019t expose \u201cimportant\u201d things from react package anymore.. This was relevant for Jest 0.1.5 which was ages ago, and @zpao wasn't sure if it was necessary. Let's live without it and see how it goes.. This was relevant when we had default root folder, and thus needed to exclude build explicitly. We don't anymore.. This was relevant when we imported invariant/warning etc directly. Also the reason why tests don't currently fail in this case (but build does).. I deleted the file that this was for a few weeks ago.. This is Prettier. (The file was outside of its reach before.). I think it's no big deal that we duplicate this. Actually convenient that you directly see what's going on now.. Is there any way to still verify this is the case? It used to be very frustrating that breaking one root would fail to schedule others. Perhaps we can rewrite this as a ReactDOM test instead of disabling?. This seems like it should've been a part of my previous merged PR. Not sure why it didn't get included there.. Since you're adding a new field can you also initialize it in the constructor please?. Why is this needed?. Why?. Why?. Why?. Typing something as any is generally as bad as not typing in the first place. Or possibly worse because now you have an illusion of type safety.\nCould we perhaps use approach like\nhttps://github.com/facebook/react/blob/90370f28ff1ce876c8ee6ec0062c921cf05b7924/src/renderers/dom/fiber/ReactDOMFiberEntry.js#L200-L201\nand \nhttps://github.com/facebook/react/blob/90370f28ff1ce876c8ee6ec0062c921cf05b7924/src/renderers/dom/fiber/ReactDOMFiberEntry.js#L210\n?\nOr just treat that field as always optional?\n. This sounds like something we've done in React code itself.\nIt also sounds like existing Bower users will be negatively affected.\nI would instead add a separate section like \n\nDiscontinuing Bower Releases\nStarting with 16.1.0, we will no longer be publishing new releases on Bower. You can continue using Bower for old releases, or point your Bower configs to the React UMD builds hosted on unpkg that mirror npm releases and will continue to be updated.\n\nI don't think attribution is needed here since it's a team decision and more of a policy change than a behavior change.. Let's put it on top to make it hard to miss?. It doesn't assume it. (This is very rarely used code though and doesn't matter for majority of users. So we just checked in a compiled version.). Why did you do it then? \ud83d\ude1b . The comment says we drill down with mutation but it seems like we only drill down without it?. It feels odd to duplicate the message here. Can we just use the callerName and component name combined as a key, without the warning itself?. Same here.. How come we never bumped into this?. . I'd like to deduplicate this by component name. (We have a getComponentName call below that can be extracted into a variable and then used as key.). Let's change this to receive fiber instead. Then we can use getComponentName(fiber) instead of writing the code to get it manually.. Typo: warn. This is unnecessary as long as you remove both this and the spyOn call.\nWe assume tests shouldn't warn by default unless you spyOn.. Worth including the key into the message? To make sure we don't mess it up when printing.. Let's change to TestUtils.renderIntoDocument too for consistency?. Did this get resolved?. Would be nice to check for specific message/count. Just in case.. If we just remove the argument to createUpdateQueue would it be that bad?. Perhaps comment should be moved here?. OK. Probably invariant messages that will get stripped when we extract errors.\nYou can try \nyarn build --extract-errors\nyarn build\n(yea, twice). Doesn't this comment lie about what it does?. I thought the first time it generates the error code file, and second time it rebuilds taking it into account. Maybe that's how it used to work in the past.. This was from Stack era. component argument was unused.. Copying the pattern elsewhere in this file. We can fix them later together.. Removing dependency on Fiber-only module from something that can be used on the server.. Put the suggestion first since it would be odd to print it after the stack.. Removed this test since it's not really useful in component stacks (where we have both).\nWould be nice to mark owner in some special way in stacks but that's a separate issue.. Just describing what it really tested for.. Not new behavior, but we didn't have an SSR test for it.. Because we use getStack() directly as %s, which would show up as null right in the message when missing. I agree it's not great though and would be nice to fix the whole thing by adding a separate warningWithStack or something.. I don't remember :-). Yeah, I guess.. Just copy paste from above tests. I don't really care. I'll have to get back to this and find another way to test it when I enable production testing of bundles.. Agree. I\u2019m also not over the moon with arbitrary ReactDOM/ReactDOMComponent separation. Need to do a pass restructuring those later.. I agree. I just don't want to spend time here because I'll delete those tests anyway.. Would be great. . Probably accidentally or by copy paste. Want to send a PR to Flow-ify it?. Sure.. It's expected to occur on master builds.. Yea, definitely. On todo list above after we know the change itself works. . Probably yes. I wanted to avoid an explicit separate entry point because it feels like public API. But I guess we have .browser anyway so might as well do that. . I wanted to do in a follow up pass renaming those. Ideally I want this to be explicit and just use package names instead of labels. But that makes yarn build react match everything. Maybe it had to be exact match but then it's more typing. I figured let's update these later when we have a better idea of how to do this ergonomically. Not coupled to build changes per se. . I'll probably do another pass renaming them in this PR. I oscillated between long and short names here and used short ones. But maybe I was just tired of complex config and tried to simplify the perception by using shorter words. I don't care strongly either way and will think about them again. . There should be comments close to getShims and its usage explaining.\nThe object-assign shim replaces object-assign reference in anything that depends on React with assign implementation exposed on React internals. This avoids ReactDOM UMD having to ship its own polyfill of object-assign while React UMD already includes one.\nWe use the www shims for overriding some modules in React. Basically we want to have some requires be \"untouched\" and actually require modules from www instead of our implementations in the open source. We can't just tell Rollup to turn require('react/src/ReactCurrentOwner') into require('ReactCurrentOwner') because then it will attempt to resolve it (and not find it). The trick with a shim file and a separate plugin to \"transform\" the original file to null in memory is the only reliable way I found to completely \"rewire\" these requires to external modules in Rollup.\nSome of these hacks might fall away or become simpler after ES modules. CommonJS is afterthought in Rollup and it breaks some more unusual cases. It might be that we're in that territory, and migrating to ESM will allow to revisit and simplify those hacks. . jest-matchers was renamed to expect.. This cast seemed suspicious to me. Because if it \"worked\" then Flow would've inferred it anyway.\nI checked, and it seems like React.Element is any \ud83d\ude1e Flow can be so confusing. This is not the thing we're supposed to be using, apparently.. This is not a very helpful annotation. It's not always null. So by encoding it like this we actually make it harder to fix the Flow coverage because now it looks like fixing this is a Flow violation.. This is how to safely \"cast\" things to elements. (Ideally isValidElement() should work as a refinement but Flow folks haven't implemented that yet.)\nI introduced a separate variable because you can't change the type of the existing one.. Mixed is always better than any.. This was the trick I meant to suggest. Keep both PROD and DEV paths typechecked.. Why was this removed?. Btw I verified that using SimulateNative would have still (incorrectly) passed the test if I removed this line. Whereas with native dispatch it is covered (and fails as it should).. This has lost the focus() call. It is important. I verified that removing the fix in https://github.com/facebook/react/commit/84b8bbdfc9d47c82f3facc4e37d58463b5b54078 (where this test was introduced) fails on master, but doesn't fail here anymore.. Same, but for blur().. There's no \"stubs\" anymore, you can remove these findDOMNode() calls. Return value of ReactDOM.render(<div />) is the node itself.. Let's not call nodes \"components\". I understand this naming already existed but let's keep it clear in new code. We call DOM nodes \"nodes\" in newer code (or \"containers\" when we render into them). So otherNode was a good naming.. Why is it appended as a child to node? I don't see it in the original test. My impression (based on the test name) is that the test specifically wants to test it still works if the otherComponent is outside the React tree. Whereas this is putting it inside.. I think the right way to write this test would be something like:\n```js\n    var mock = jest.fn();\nvar container = document.createElement('div');\nvar node = ReactDOM.render(<div onMouseEnter={mock} />, container);\nvar otherNode = document.createElement('h1');\ndocument.body.appendChild(container);\ndocument.body.appendChild(otherNode);\n\nvar nativeEvent = document.createEvent('MouseEvent');\nnativeEvent.initMouseEvent('mouseout', true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, node);\notherNode.dispatchEvent(nativeEvent);\nexpect(mock).toBeCalled();\n\n```\nThis way we verify that if an event originates outside of React tree (on otherNode) it still fires an event inside a React tree.\nI had to use a different event but that doesn't matter for this test.. No findDOMNode please.. Here, too, we can remove all findDOMNodes.. Same re: findDOMNode.. Let's rewrite this one not to use SimulateNative either. Can we?. Why is there an array here? Shouldn't it be just new Event(eventType, defaultNativeEvent)?\nIt would be nice to rename defaultNativeEvent and nativeEvent to eventInit and defaultEventInit, to match how spec calls these arguments.. instance is the DOM element here. You can remove findDOMNodes.. I don't think this test works. If I comment out || nativeEvent.srcElement in getEventTarget.js the test still passes, whereas on master commenting it out fails the test. This means that dispatchEvent() probably fills .target it on the native event and thus it's not a problem.\nI'm not sure how to work around that really. Maybe there's no way.. Can we call this mock? It's a bit confusing to see click() calls like we're clicking on something.. It seems like we lost these two assertions on e.defaultPrevented and e.nativeEvent.returnValue? Why?. Only the first test was checking for srcElement. There shouldn't be a need to add this to every test.. I don't see this being tested (e.nativeEvent.cancelBubble). Same re: srcElement.. Same.. Can we make this warning(false and move out this (negated) condition together with the top one?. ``js\nif (typeof value === 'boolean' && !DOMProperty.shouldAttributeAcceptBooleanValue(name)) {\n  if (value === true) {\n    warning(false,\n      ...\n    );\n  } else {\n    warning(false,\n      ...\n    );\n  }\n  ...\n}. I saw another PR usingnew MouseEvent(type, args), could you check if that one's going to be shorter?. Shouldn't it be simulated on thecomponent?\n(which should be renamed tonode` btw)\nI believe the original test did that.. Which part of the code are this testing here? Are we confident that removing it causes test to fail?. This change is unnecessary, right? It just reformats the message in a slightly less readable way.. Would look nicer if If this is expected... started on the new line in test.. Same. Same. What does false={condition? value : undefined} mean? Why does it says false?\nPlease fix this to show the attribute name.. Can this also start with Received ... for non-boolean attribute ...? I want both messages to look similar, but with different second sentences.. TODO for when?. Nit: value and select are backticked but multiple isn't. Let's backtick it too. . Same for true. . What happens when it's an unrecognised symbol? Do we throw later?. Same question for number.. Why? Can you point me to discussion that explains this TODO?. Not necessary. Can remove. . Not sure it's possible. I think using PROD type most things and then unsafely casting to DEV type for DEV things is the way to go. . I guess yea. . Let's keep this called node? It's not a component.. It's not a component, it's a node. I know old tests are written this way but they're wrong. Let's use correct naming in new tests.. There's no need to findDOMNode because it is already a node.. If this is false then we're doing this check twice now. Maybe restructure so we don't have to?. Maybe flatten this to \"else if\" at the level above? Now that we have else's in both branches. . What does the user see though? We should at least warn because if it silently does nothing, then making it do something could be a breaking change (if someone starts relying on it by accident). . Can you extract this in a function with early returns?\n```js\nfunction flattenTopLevelChildren(children: mixed): FlatReactChildren {\n  if (!React.isValidElement(children)) {\n    return toArray(children);\n  }\n  const element = ((children: any): ReactElement);\n  if (element.type !== REACT_FRAGMENT_TYPE) {\n    return [element];\n  }\n  const fragmentChildren = element.props.children;\n  if (!React.isValidElement(fragmentChildren)) {\n    return toArray(fragmentChildren);\n  }\n  const fragmentChildElement = ((fragmentChildren: any): ReactElement);\n  return [fragmentChildElement];\n}\n\n``. ![](https://i.giphy.com/E2d2tsgz7iHo4.gif). I guess we'll need to add it andreact-native-renderer/src/ReactNativeTypes.js` to this list:\nEXPECTED='scripts/rollup/header.js\npackages/react-native-renderer/src/ReactNativeTypes.js\npackages/react-cs-renderer/src/ReactNativeCSTypes.js'\nAnd add providesModule to ReactNativeTypes again.. I don't think this is important. I'd prefer a single boolean to deduplicate (even though deduplicating one will influence the other). They're rare enough.\nThen we would move the isMultipleSelect check inside the condition. So it's only checked in error case.. I don't know if there's any difference. React just subscribes with addEventListener. If that works with both approaches in jsdom, let's use whichever is simpler. . Let's call this componentName. And this warningKey. We shouldn't return here since that won't execute the code outside of DEV. Let's just wrap the warning into a condition. . Same as above on naming. . Let's call this didWarnAboutNoopUpdateForComponent. Let's call this didWarnAboutStateAssignmentForComponent. We should put this assignment inside the if block. So that we don't spend time doing it if we don't use the result.. Let's change this to take fiber as argument instead. Then we can use getComponentName(fiber) || 'ReactClass' instead of duplicating its logic.. Oops, you're right. I didn't realize this is only called when we already know we're gonna warn. Disregard my previous comment.. Which tests were failing? I tried this on your branch and it worked:\ndiff\n-  var warnAboutUpdateOnUnmounted = function(\n-    instance: React$ComponentType<any>,\n-  ) {\n-    const ctor: Object = instance.constructor;\n-    const componentName =\n-      (ctor && (ctor.displayName || ctor.name)) || 'ReactClass';\n+  var warnAboutUpdateOnUnmounted = function(fiber) {\n+    const componentName = getComponentName(fiber) || 'ReactClass';\n     if (didWarnStateUpdateForUnmountedComponent[componentName]) {\n       return;\n     }\n@@ -1242,7 +1238,7 @@ module.exports = function<T, P, I, TI, PI, C, CC, CX, PL>(\n         } else {\n           if (__DEV__) {\n             if (!isErrorRecovery && fiber.tag === ClassComponent) {\n-              warnAboutUpdateOnUnmounted(fiber.stateNode);\n+              warnAboutUpdateOnUnmounted(fiber);\n             }\n           }\n           return;\nMaybe you forgot to update the callsite?. Please make sure to read the messages you assert in tests. It looks like you were trying to adjust tests to match the wrong behavior in the code, rather than the other way around.. I\u2019m sorry that I snapped. I had a bad day and shouldn\u2019t have spoken to you with this tone. I apologize. In this test, whatever is the attribute name. Not the value. You can see if from the first sentence:\n\nReceived false for non-boolean attribute whatever.\n\nTherefore, a condition like {whatever ? value : undefined} is not relevant to the user code. The user has something like whatever={condition && value} with condition being false. We want to tell the user to turn it into something like whatever={condition ? value : undefined}.\nSo I think ideally the messages would be:\n\nIf you get true:\n\njs\nexpectDev(console.error.calls.argsFor(0)[0]).toContain(\n  'Received `true` for non-boolean attribute `whatever`.\\n\\n' +\n  'If you want `true` to appear in the DOM, cast it to a string. ' +\n  'For example, you can pass `whatever=\"true\"` or `whatever={String(value)}` instead.'\n);\n\nIf you get false:\n\njs\nexpectDev(console.error.calls.argsFor(0)[0]).toContain(\n  'Received `false` for non-boolean attribute `whatever`.\\n\\n' +\n  'If you want `false` to appear in the DOM, cast it to a string. ' +\n  'For example, you can pass `whatever=\"false\"` or `whatever={String(value)}`.\\n\\n' +\n  'If you want to omit `whatever` based on a condition, use a ternary expression. ' +\n  'For example, you can pass `whatever={condition ? value : undefined}` ' +\n  'instead of `whatever={condition && value}`.'\n);\nIn these examples, whatever should of course refer to the attribute name, not literally \"whatever\". I only used whatever because that's what the test already uses.\nI hope this is helpful and clarifies things!. Let's put the whole thing into if (!renderPresent) so we don't run those checks unnecessarily. And make it warning(false. . I thought about the second one but it will throw for null/undefined. Might be unexpected. First one seems safer. Although on the other hand you probably don't want \"undefined\" or \"null\" as strings either.\nI wish there was some concise way to express \"stringify unless it's null/undefined\".\nI guess I like that value.toString() throws it it doesn't exist. If you mess it up you'll immediately realize it by the crash, instead of quietly using the wrong value. So let's suggest that.. Let's be explicit: \"did you accidentally return an object from the constructor\". Nit: we already know it's a boolean so can just write if (value). Let's also rename test file?. warning(false,?. Let's just drop this path?. This only runs assertions if we get into catch. But what if we have a bug that causes us not to throw an error? Then the test doesn't assert anything.. Doesn't look right to me. React$ComponentType represents a React type, not instance. E.g. MyClass or MyFunctionalComponent.\nThe original typing was wrong too though.. Same.. >Not sure about using HTMLInputElement for textarea is the correct way to do it.\nCan you declare two separate helpers (for input and textarea) instead?. The problem with tests like this is that if _onChange never fires, the test passes (since none of the expectations were called). We need to move those out.. Why do we need this? Don't we already have a document global?. Maybe let's not export it at all? It would be a bit odd to see it on React object being undefined.. Minor nit: let's reorder them before the portal (the numbers go in sequential order). . Let's just copy and paste this part between tests. It's fine for tests to be verbose. That way they're easier to debug. . Maybe the cleanest way would be to shim this file with a fake module that is generated by reading package.json.. Can we return this into a switch somehow?. Let's also assert we only emit one warning. Like other tests do by asserting on count.. Nit: let's remove this newline. Same feedback. I guess this relaxes the type so we can add things to it later. Actually this is probably not a great pattern and we should stop doing this. Since it probably also relaxes which properties it lets us read. . Doesn't matter right now. This code executes once. Although it probably makes sense to copy how we do it in ReactChildFiber. . This can just be !this._forcedUpdate, right?. Typo: fixture. Not sure I understand the difference between when to use version and when to use json.version.\nIf I do two pre-releases in a row, does this increment minor once or twice? If it only increments once then sounds fine.. Maybe just fall back to []? Then you don't have to check for existence later.. Useless assignment: it's reassigned right afterwards. Let's combine?. A comment here would help understand what this does and why. Maybe promisesForForwardingModules?. Comments like this are valuable because they're not obvious.. This check is redundant. You already check for the other value later.. This should ideally be done before React is imported.. Please remove this change. It shouldn't be in this PR.. Maybe try using ESLint Node API instead of exec here?. Note this doesn't actually fail the build. Should be process.exit(1) instead.\nI fixed in https://github.com/facebook/react/commit/646781b0b4f95d90cf08b7799bbd196e16136f06.. Removing this causes the test to no longer verify the SVG IE code path. You can test it yourself by commenting out the related parts in setInnerHTML: the test passes despite them being broken.. This is odd. Why do we need this?. Seems to defeat the purpose of the test (which is to verify setInnerHTML itself cleans up old nodes).. I think this is mistakingly testing that unmounting removes a child, and mounting into the same container later adds it.\nInstead of testing that inside an already mounted container, operations setting dangerous HTML on SVG node, if it doesn't have innerHTML (as in IE11), will use appendChild / removeChild.. Oh, great catch.. Probably should not. I'll file a follow up to ask whoever knows this piece.. This one is not necessary. We're guarding against [] access outside of bounds in particular. Here it doesn't happen.. Doesn't matter, we squash on merge anyway.. This is unnecessary. Just convert the options to use camel case form instead where they are defined.. Can we just use Object.assign({}, options, defaultOptions) here?. That would work too. I don't feel strongly as they're only called once. . It is intentionally outside of the function. We don't want to allocate one per call. . I tried using your approach, but it seems like Flow fails to catch some issues for some reason now. I'd prefer keeping it explicit so it's better typed.. Can you remind me where it is used?. I don't think we need them. This one doesn't have to be the current one. So as long as you save the fiber on some field on the instance (or use a weakmap), you can get one back.. It's not required. I added it for RN so that multiple apps on simulator don't steal devtools from each other.. Also, it's part of the options to connectToDevTools() call which sets up a websocket connection.\nThis is not related to the injectIntoDevTools call which injects renderer into a global variable.. That's also true. (Though it's nice to implement if you can I guess.). I think in most cases people would mean componentWillReceiveProps.\nMaybe we should say\n\nIf you meant to update the state in response to changing props, use componentWillReceiveProps(). If you meant to perform manual DOM manipulations or fetch data, use componentDidUpdate().. Maybe\nIf you meant to update the state in response to changing props, use componentWillReceiveProps(). If you meant to fetch data or run some code after React has updated the UI, use componentDidUpdate().. \ud83d\udc4d. Maybe show more important one? There's not much screen space there.. This should be inside the if (enableUserTimingAPI) check.. Isn't this weird though? I don't think I touched this code but now it wants me to reformat it.. There may be more bundle types where top-level things are declared in global scope. In theory. :-). I dunno, seems like a common pattern with plugin systems?\n\n\nHappy to change to something explicit if you prefer.. Shouldn't we add the container to body instead? This detaches the div from the original container.\n. Let's remove container from body at the end of each test instead? Or, better, declare variable once, and remove/add it before and after each test.. Maybe keep both? We can just collect error instances and then toString() them, no?. oh kay. Can we keep this nested? I want to keep all top level conditions uniform so it's obvious they all have to include the enableUserTimingAPI flag check.. These comments are a bit confusing now. They were meant to be attached to the phases below. Any way we can avoid nesting them?. Not very obvious to me what this means. Is there a way to phrase it in a more user-accessible way?. ?. You'll probably want to immediately set it to null before calling. Since now it is outdated. . Maybe _enqueueCallback. This will fail if the user doesn't have yarn, right? Can we make it fail gracefully with a nice message?\nWe also need to make sure it works on Windows. Also some people have yarn bound to some Java tool, and use yarnpkg alias instead. Maybe that would be safer?. I don't understand what this does in the context of this test.\nAs @jquense explained above, the original purpose of the test is to verify our custom tracker object \"sees\" the original value.\nHowever this notion of \"tracker\" is not the same thing that you get from the HTMLInputElement's prototype. I think you got confused by naming used in some other test.\nThe thing you read from HTMLInputElement prototype is just the jsdom's value accessor itself. So there is no need to test it at all. You're just testing that jsdom works. (But we already know it works as it has its own test suite :-). It looks like this test specifically verifies that the synthetic event still determines the target even if only srcElement was set. Your test doesn't verify this.. In https://github.com/facebook/react/pull/11332#discussion_r147254081, I didn't ask to remove srcElement from all tests like you did in https://github.com/facebook/react/pull/11332/commits/3b3db3fb50b2509a77d97425d6961bdbf072485d.\nI was saying that only one test intentionally tested for srcElement support (that's why the test existed). That's why after refactoring, there should also be one test that verifies this.\nThis test verified that this line can fall back to nativeEvent.srcElement. After the changes, the new test doesn't check this.. Does ReactDOM call the callback if shouldComponentUpdate skips an update? I would expect so, but this PR doesn't. Can you verify this?\nMaybe it's better to move the callback call here. Then you don't need to duplicate it in two branches.. I think this doesn't test that srcElement is used when event.target is not supported. The code just falls back to event.target because it exists. You need to do extra work to actually \"break\" event.target and cause the polyfill path to execute.. This doesn't test the React's synthetic event at all. It just creates a jsdom event object and then asserts that object works. This is not a useful test for us because we already know jsdom works (it has its own test suite).\nWe should instead test that the synthetic event object produced by React has the right fields.. It is better to first assert the number of expected events. Then, if some are missing, the errors are clearer.. ReactDOM.render already returns a DOM node. There is no need to call findDOMNode on a DOM node.. It wouldn't be undefined in practice. The old test was odd, but we shouldn't replicate that odd behavior in the new test :-). This does not test the React synthetic event system. Like below, the problem is this is testing jsdom itself. If React were to break the synthetic events completely, this test would still be happily passing. . This is not testing anything in React. You are creating a jsdom event (equivalent to a browser event) and then check that jsdom was dispatched. Even if the entire React source code was deleted, this test would still pass.. Note: unlike in existing tests, this actually ensures it's removed even if the test fails.. Can you remind me why this is necessary?. How do you feel about following this approach instead? Feels a tiny but more obvious what's going on and why IMO. https://github.com/facebook/react/pull/11517/commits/d7745d69917b28298d27b8e411329ca67cae4668. Smart.. This is a very hot path. We don't want to create closures here. It's fine to duplicate code instead if necessary. . We should deduplicate this warning so it doesn't warn more than once. See how we do with most other warnings. . Can we get rid of this helper and just inline calls in each test? I don't mind some repetition.. I would like to use the same beforeEach/afterEach structure as in https://github.com/facebook/react/pull/11365. Set up a container and add it to the document, then remove it. . Unfortunately Simulate* APIs are not very useful for testing because they are sort of like private APIs too. If you look at https://github.com/facebook/react/pull/11365 you'll see we're trying to avoid them and dispatch native browser events on DOM nodes instead. This PR should too. . Why is it not testable? Pretty sure https://github.com/facebook/react/pull/11365 tests this case. . Can you please add a similar TODO comment as we have in other such entry points?. And it's probably worth mentioning this issue too. In case somebody tries to change it back. . I would split the new verbiage into a separate line.\njs\n// Note: when changing this, also consider <link>. Actually let's move this note to export default { (in both cases).\nBecause right now it would be possible to remove default again and tests/build would still pass.. Maybe let's put it into an else clause to the next if?\njs\nif (propTypes) {\n  // ...\n} else if (componentClass.PropTypes && !propTypesMisspellWarningShown) {\n  // ...\n}. Let's reword to say:\nComponent %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?\nAnd pass the component name name  || 'Unknown' as an argument.. These helpers make it a bit hard to read what's really going on in the test. Could you please just store the instance instead, and then read state and call setState on it directly?. I don't think we need to add it to the body for this test.. Maybe _invokeCallbackIfNecessary? It doesn't always exist.. This doesn't verify that the callback itself has been called.. Since this is a hard exit, can you remove the else and just leave it after this code unindented?. If you want to test getFiberCurrentPropsFromNode, I think there are more assertions you might need to make. For example I can currently replace its implementation with\njs\nreturn node[internalInstanceKey].memoizedProps;\nand the test still passes. However, this is a wrong implementation (node[internalInstanceKey] can potentially point to an \"alternate\" fiber that is not \"current\". Current and alternate swap places on updates.)\nCan we make this test more solid by tracing what happens with \"current\" props? e.g. maybe they're used in some way where alternate props would've been wrong. You can git blame when getFiberCurrentPropsFromNode was added to maybe find the cases that were broken before it.. This seems a bit odd. If we don't want to do anything when processingEventQueue is empty, can we exit early instead? Otherwise we're directing simulated events into non-simulated branch (even though technically there's no events) which seems wrong.. : boolean. : bool. Seems like this can be inferred? I'd prefer we annotate public APIs and low-level functions, but not all the glue code.. Maybe:\nCould not find a Yarn installation. Please make sure Yarn is installed and that the `yarn` command works in your command line shell.. isYarnInstalled. Can we move this up to other DEV only variables?. Also let's initialise it to false. . I think just one is fine. . I don't mind if your test it in the minimal supported browsers. . Let's rename this to node. It's not a React instance. . Same. . Style nit: let's include assignment into definition?. What does this test have to do with IE8?\nThe test title says \"should be prevented if nativeEvent is prevented\". To test this, remove these properties and just call e.nativeEvent.preventDefault(). Then check e.isDefaultPrevented(). . Again, this is specific to IE8 and there is just a single test needed for this. There's no need to add srcElement testing to every test. . Same. . Is this test missing?. Can this be event.preventDefault() call instead? Since jsdom should implement it by providing .defaultPrevented. . It would be nice to test that we can still access syntheticEvent fields here. Since that's the thing that persist allows.\nLet's save syntheticEvent in a variable and asset its target and type here. . This is a private API. Instead of triggering it explicitly we should save the synthetic event to a variable. Then we should assert at the end of the test (after dispatching events) that accessing them does not work. . Same . What is this asserting? I don't understand this line.  . This makes sense to me now, thanks for explaining. . Let's clear them early before calling them. So that if one throws, old callbacks are still removed from the list. . I want to keep the test for srcElement. You're right we don't support IE8 anymore but the code is there so the test should be there too. We can later remove them together but that is unrelated to the task at hand (converting the test to use public API). . In other words I'd like to leave this part tested. . We can. Just embed it here :-). Which of the new tests verifies this?. Same question.. Please add a test where this is literally the argument value.. >I'm thinking of creating tests for escapeText thourgh the ReactDOMServer.renderToString API like these ones\nSounds goood.\n\nAlso, if you do, shouldn't this test be placed there where the script would actually run?\n\nNot sure what you mean. We just want to verify <script> can't be injected as attribute value.. This is not a correct implementation. For example gte('2.0.0', '1.2.1') says false but it should be true.\nIn general I'd prefer we don't reimplement this. Can we use something like require('semver').gte instead?. This logic is a bit complicated. Is there any module we can use for this? Or maybe there's some simpler way to write it? At least let's extract it to a separate function.. There is no gulpfile lol. \"because of how things are set up\" \u2014 my favorite kind of description!. Update inside a keyed array?. This is only equivalent if element always has addEventListener. The original code in fbjs checked for it.\nAre we 100% certain it always exists?. Nit: instead of disabling, you can split the message into multiple lines and concatenate them. Other tests do this.. Shouldn't we also fail the install in this case?. node-mkdirp seems fine. Why didn't we need it before?. We shouldn't be reading an internal field. Let's change this to only test for observable public behavior.. Instead we should re-render, and ensure callbacks didn't get called again.. Oh I see. I think changing allVersionsMatch is confusing since it's not what the original test was about. In fact let's break this task apart into two files? One would be check-react-versions.js and another would be check-development-environment.js.. Yes. Dunno. Used to be there. Maybe because it's one of Jest defaults? I can remove.. Nothing here?. Yep.. So, the nice thing about these old tests is they didn't assert how we escape, only that we do escape. Which opens the door for changing that in the future.\nMaybe it's not too important though.. This is also problematic. It's importing an internal module\u2014which is exactly the situation we're trying to avoid.. In fact I think the tests from getEventCharCode should just be \"rolled\" into this test case. Since they're covering the same thing.. A lot of these tests were written in a very unit testing centric way. You need to try to liberate from that mindset. Think what's actually valuable to test for from perspective of library user. Not all the possible inputs to internal functions that never get called with those inputs in the first place.. Tip: there is no \"stub\" :-) Old tests are bad, don't copy them.\nReactDOM.render() already returns a DOM node.. Why are we setting untracked value here? I thought this test verifies that it catches setting value programmatically (and thus through the tracked value property like in the original test).. This won't work because it's not actually rendering into document (yes, the naming of that method is pretty bad). That's why reviews in other similar tests added setting up a container and adding it to the body before every test.\n. I wrote \"fit\" in my example to force only a few tests to execute. It should not be used in committed code. . We should leave a comment about jsdom click misbehaving. It's not obvious and doesn't happen in the browser (it's also possible jsdom has fixed this in new versions so we need to make it clear in case somebody later tries to update it, and the test will fail). . I don't understand what this test is trying to test. What is the thinking behind it?. Sorry, I meant that I don't understand what the new (rewritten) test is doing (since it's not testing setting the field at all).. Yes.. Sorry, autocorrect. Meant \"we should leave a comment\". Like in the sample I wrote above.. Seems like it was important to do this for all types of inputs, and not just 'text'?. Maybe an ideal test would actually create a DOM node, put content into innerHTML and then assert that it only has a text node child with expected content?. >Though werid since this is used only on the server package\nNot sure what you mean. The end goal of rendering to a string is that the HTML shows up in somebody's browser :-) This is exactly what an integration test should verify: that what shows up in the browser would have been consistent with what we expect (as opposed to a dangerous script tag).. If you'd like to send a PR for this, happy to review. I'm not 100% sure it's the right approach but it seems to make sense to me.. Can you explain why these tests were added, and why they are important?. Nit: we might not need it. So maybe we should only calculate it when necessary? Also this is a second props.value access but we've already just read it into value.\nI would just leave inline conversions.. Are these irrelevant now?. I don't mind parallelizing them but I'm not 100% sure they're free of race conditions. I wouldn't both anyway tbh since they're really fast as you said.. Since you removed the last internal import in this file, we should also remove .internal.js prefix. Then tests will run in production env too :-). https://github.com/facebook/react/pull/11673. Do you mind doing this in beforeEach and then cleaning up in afterEach? Like here.. There's no need to findDOMNode. render() already gave you the right node. Old test just wasn't updated to reflect this.. This seems to be testing that a focus DOM event would have been ignored at this point. Shouldn't the new test also verify this?. Let's use the newer API for this? e.g. new MouseEvent('mousedown', {bubbles: true, cancelable: true}). Let's move this to where it's used?\nAlso let's rename to something like getSourceCodeWarnings.\nIn fact I would just inline this logic in the script that uses it, and add a comment explaining why it exists. . Since we're not using Responder plugin it's worth adding a comment explaining why the test is here and how it's related to Resonder. . The node is appended here to the document. We should remove it to clean up after the test. I usually put the rest of the test in try/finally, and remove it in the finally block. . Same. . In fact it may be easier to always add these nodes in beforeEach, and then always remove them in afterEach. Some tests will use them, some won't. . If we change nodes to always be added, tests like this will have to remove one instead. . Never mind, I misread the tests.. Our release script probably won't know to bump it, so eventually the local version will stop satisfying it. Can we use \"*\" as a version instead? Since we never publish it, that should be enough as a workaround.. We can just remove this field for now then.. Can we use a require here for consistency with other top level entry points?\ni.e.\njs\nmodule.exports = require('./src/ReactFiberTreeReflection');\nWe can eventually change this but I'd like all entry points to look the same.. The logic behind choosing to put either ARG or ARG2 here is not clear to me.\nIn the original tests, it was specific to a test. We're traversing enter/leave, and calling \"from\" path with ARG and \"to\" path with ARG2.\nHere, we instead encoded ARG and ARG2 right into components. I don't think this is right. This seems to couple them with specific test cases below. So it might be hard or impossible to add other completely valid tests which test the opposite enter/leave paths. This didn't use to be a problem.\nI'm not sure what the solution is; just pointing out an issue I see.. Nvm, I see why this wouldn't work now.. Yes this sounds right. MIT. I don't think this is easier to read.. This file is autogenerated. No need to change it.. We can't do this. This file ships on npm without transpilation. So it needs to be ES5. Same for all other files in /npm/ folder.. I would prefer a strict check here (e.g. typeof windowEvent !== 'undefined' || windowEvent !== null, depending on what actually happens).. So is this always false? Then this shouldn't be a test at all if it never executes.\nYou could, however, \"polyfill\" window.event in jsdom yourself somehow.. I used a switch here at first but Flow and ESLint started fighting over presence of breaks (which are technically unreachable). This is shorter anyway. It's not a hot path (always errs).. Can't just pass $$typeof because '' + obj conversion used by invariant doesn't work on symbols.. Note: keyup is not a mouse event.. Event* are internal modules. They shouldn't be here.. This is also an internal module, and tests shouldn't rely on it.. Yeah, there's many small things here worth revisiting. But fixing this one needs some method restructuring (which I plan to do). . No, this one is fine.. Yea, definitely will. I have another set of commits that dives into this but it turned out to be a rabbit hole and I decided to do these first.. Yep\u2014you can define it outside the dev block.. (but assign it inside). Maybe let validatePropertiesInDevelopment = () => {}; would be the best default value, and then in the block you reassign.. Not sure what you mean? I removed the flag.\nhttps://github.com/facebook/react/pull/11733/commits/c9ca797dfa3e3522fd3fcb432e3ffb70b15d0215\nEasier to read as individual commits.. Maybe only IE8?. (Regardless, don't want to change the logic here, only the structure :-). I want to consolidate all property/attribute stuff here first, then refactor it to make function contracts clearer, then possibly spread it out. I'd rather not spread it out yet.. It's just easier for me to deal with it if it's all in one file. Easier to see patterns.. My plan is to get rid of propertyInfo completely (maybe). This PR is just very iterative.. This is a good observation though.. AFAIK String() is slower, at least in V8.. This sounds like a bug to me. I'd like to always treat them as null instead of showing stale values. I'd be fine changing behavior even if that's what we did in 16 because I think it's more likely to cause product bugs.. I'd expect dynamic property access to be slower than just setting a property normally.. I think the constraint we care about is that objects get stringified. Since we depend on this a lot. Therefore we can't use browser APIs that don't attempt to stringify them.. Yeah. So, jest.resetModules() only resets requires, forcing next require() to load fresh versions. But it doesn't actually reset global objects like console. \nI think it's fine to just put spyOnDev(console, 'error') in the beginning of every test case. That's pretty explicit.. No. Let's change the code in expectInvalidNestingWarning to treat the first item in the array as the root element itself.\nFor example, for ['div', 'label', 'div'] have it render <label><div /></label> into a DOM div.\nThen, for ['body', 'datalist', 'option'] it would render <datalist><option /></datalist> into a body.. Shouldn't it display a warning?. No, it's okay.. Let's fork shouldSetAttribute here to shouldSetValue and remove the unneeded branches? I'm not against a special method per se, I'm against a special method for doing the assignment.. Can we use refs and avoid the need for this method?. Comment misleading now?. Suggestion: let's remove any use of Simulate and SimulateNative in this file.\nInstead, make sure that we add container to document.body in beforeEach, remove it from document.body in afterEach, and then use browser native dispatch:\njs\nnode.dispatchEvent(\n  new MouseEvent('click', {bubbles: true, cancelable: true}),\n);. A bit too patronising :-)\nMaybe:\nThe ReactDOM.unstable_createPortal() alias has been deprecated, and will be removed in React 17+. Update your code to use ReactDOM.createPortal() instead. It has the exact same API, but without the \"unstable_\" prefix.. I was trying to avoid making it polymorphic (number/undefined). Maybe that's silly, dunno.. Did you verify this test fails without your fix?. \"even if there is a markup mismatch\". Let's assert on a specific warning here by checking argsFor.. We should delete this folder after the build.. Let's call it packForNpmAndUnpack()?. What do you think about using a folder in os.tmpdir() here instead? Not sure if it would be better, but IMO it's easier to understand if there are fewer files being moved around inside the build folder.. Worth checking git blame to see why this was introduced.. This is undoing a recently merged change.. Let's call console.error.calls.reset() here. Then you can assert a specific count later (presumably 1?). I think it's a bit confusing that this function can mutate its argument. Let's copy tags at the beginning of this function?. Related to previous comment: this should assert on a specific number.\nWe should also assert on a specific message. It's fine if it's not 100% specific: you can assert on a part of the message with toContain().. I see it's not 1 for some tests.\nIn that case let's pass expectedWarnings into this function as an argument?\ne.g.\njs\nexpectInvalidNestingWarning(true, ['body', 'body'], [\n  'validateDOMNesting(...): <body> cannot appear as a child of <body>',\n  'render(): Rendering components directly into document.body is discouraged'\n]);\nThen you can assert that we have exactly that number of warnings, and they match the passed ones with toContain().. >There may be some rare cases, if a use's permission is misconfigured, system temporary folder is not accessible for writing.\nYeah. I think let's risk it and see if it's an issue in practice or not.. What if it's not empty, and the previous build terminated abruptly before rimraf got a chance to run?\nI think ideally we should create a new directory every time, with random uuids as folder names.. It feels a bit wrong to me that if you have two checkouts of React, running yarn build in them at the same time might produce conflicts. So I'd rather pass it around.. This is not good because now every host Fiber gets scheduled for an effect during commit. The whole point of returning a boolean is to avoid this, as ideally this should be a rare case. . Why was this extracted to top level? Looks like a local variable to me. . Let\u2019s remove DEV check here in tests. We want the code to run in any case. However we want to put the assertions about warnings inside a DEV check since in production they aren\u2019t expected to warn. . We shouldn't manually edit this file.. I used the __DEV__ checks at the beginning of the tests because some functions attached to validateDOMNesting are actually undefined in production so the tests would crash. That's not a problem when tests are written against the public API.\n\nwhich will not be testable in prod as we wont be seeing any. So no point in letting any of the code execute in prod.\n\nThere is still value in executing this code in PROD. In particular, we want to verify that the code doesn't crash. For example, imagine we made a mistake and called validateDOMNesting.updatedAncestorInfo in production environment. It would throw. The tests should verify that nothing bad happens by stressing that code path.\nIn this particular case it's true that if there was a big issue like this, other tests would probably fail too. But we still want to have coverage like this. I hope it makes sense!. Copy paste of existing code, didn't look into how it works.. There's a further console.error too so I guess it doesn't matter? The diff makes it look like I replaced one with the other, but I just added an additional one.. To be honest I'm not even sure what the difference on Node is \ud83d\ude05 . This doesn\u2019t copy the array, it only creates a reference to it. Therefore the splice call later mutates it.\nIt would be clearer IMO if we didn\u2019t mutate the input. Otherwise, for example, declaring an array as a variable in the test and passing it two times wouldn\u2019t work. We don\u2019t do this but it could be potentially confusing in the future.\nTo solve it we need to copy the array on this line. . This is still a private API. The point of this rewrite is to remove reliance on private APIs.. I think this is a bit confusing. Let's just copy and paste these constants, and completely remove this file :-) ESLint also actually accepts strings so we can later remove them altogether.. I think there's more to it. I think we want to have ecmaVersion set to 6 for the ES6 config and to 5 for the ES5 config. It's not just about var, but about all the other features too.. Is this efficient? What's the full yarn lint time before and after the change?. Is this necessary? Shouldn\u2019t an unexpected log fail the test anyway? I expect that if we explicitly mark each warning block then any warning outside should be a failure. Maybe even immediately when it\u2019s called rather than at the end of the test. . Let\u2019s bite the bullet and nest assertions?. Same; I would expect any warning that isn\u2019t inside a protected block to fail immediately. . I'm not sure if I was being clear enough.\nAnything except react or react-dom themselves is considered private API. Nothing that starts with events/ or has /src/ in the path is public.. This might be a good place to use it, but only with a benchmark run confirming it :-). ```js\nexpect(() => {\n  expect(() => {\n}).toWarnInDev()\n}).toThrowError('message')\n```\nAlthough there's a hazard of not specifying the message and thus catching a failure from the inner expect.. Maybe nesting them the other way around would work.. To be clear, I expect that with current infra it fails at the end of the test.\nHowever, I propose that toWarnInDev acts as a boundary, and we change console.error/console.warn to immediately throw outside of that boundary. This way we get the error immediately at the right call site instead of at the end of the test.. ?. Can we remove this line now? Seems unnecessary with the stack.. Consistency with all other checks. (I don't care either way but IMO we should change them all together if we want to.). Should ignore patterns also be a part of the respective configs? That would make sense to me. The fact that they\u2019re currently duplicated in eslintignore is a bit confusing. . If this is only used in linc task let\u2019s just move it and inline it there. I wouldn\u2019t worry too much about having a test for this file. . Maybe there\u2019s something clever we can do to have ESLint do the filtering instead of us? I\u2019m not sure but since Prettier can do this, maybe you can find a way with ESLint API too.. I guess that could mess with the editor integrations people on the team might be using. So maybe we shouldn\u2019t do it. What do you think?. That sounds a bit convoluted.\nHow about:\n\nWe use top level eslintignore/prettierignore for things that should never be touched (like build products and third party code)\nFor ES5/ES6, we always negate the other pattern to get a list of extra ignores. For example ES5 = everything in ES5 patterns except anything that is ES6. And vice versa. . It\u2019s even simpler.\n\nES6 doesn\u2019t need a pattern. It should just be \u201ceverything\u201d. The global ignores (in ESLint and Prettier top lebel ignore files) should filter out build artefacts and dependencies.\nES5 needs a pattern that just says \u201cthese files are ES5\u201d. It\u2019s a subset of all files.\nYou run ES5 passing it as \u201cinclude\u201d set.\nThen you run ES6 by passing ES5 as \u201cexclude\u201d set. Because everything else is ES6 (or already excluded by global config). \nIn either case ES5 is the only pattern that needs to be explicitly specified. . I think this message doesn't make it clear that this could be due to using a string ref in a functional component.\nCan we split it in three parts? e.g.\n```\nElement ref was specified as a string (me) but no owner was set. This could happen for one of the following reasons:\n1.\n2.\n3.\n``. We should make sure to show this warning once at most. Please deduplicate it.. I think we can just filter this particular warning from the output (and maybe raise an issue to ask for an option to completely disable this warning).. MaybedidWarnAboutUnstableCreatePortal. This is called__dirnamein Node :-).parserOptions, notparseOptions.. I don't see how this could possibly work. By the pattern, this file should be treated as ES5. But thenconst` should not parse. However it lints just fine.\nThis brings up a separate point: we're actually okay with treating our Node /scripts/ as ES6. It's just that we don't want trailing commas in them. So maybe we need three different file types (ESnext+JSX, ES6, and ES5).. JSX, Flow should also be disabled in ES6. And it should use the espree parser. . All shims should be treated as source (ESNext). Good catch.. No, this would get caught by:\njs\n  if (shouldTreatAttributeValueAsNull(name, value, isCustomComponentTag)) {\n    value = null;\n  }. Nice catch. Do we care? There's plenty of internal names, even in test files (e.g. ReactDOMComponent-test). I agree we need to clean it up by functionality rather than file, but don't think it's necessary to do in the scope of this PR.. To make it extra clear you're not supposed to call setAttribute with name unless you know what you're doing.. Oops yes. Let's follow up. This diff is getting hard to deal with.. I guess what I'm referring to is that there are already plenty examples where internal names don't match tests. It used to be important for them to be in sync when unit test tested internals, but they don't anymore. I agree it's confusing, but IMO mismatches in test file names are even more confusing.\nConceptually those tests are about deleting. I wouldn't move them into set*ForProperty just because those code paths moved there. Instead I would've preferred to rename all tests to human readable descriptions (e.g. \"deletion\"). But then it's already inconsistent in the current test codebase so I think it's easier to do in one big cleanup later.. This won't work. Everything inside scripts/bench (and scripts in general, except scripts/rollup/shims) should be normal ES6 without trailing commas in function calls. Otherwise it won't run on Node.. I don't see how this could work. It should be ES6 (which doesn't support trailing commas).. Why do we need these features for ES6? I\u2019d expect both to be false. . Please change this to console.error. Just inline \u201cYarn\u201d into the message. . Let\u2019s move \u201ccheck\u201d tasks up alphabetically.. Let's make this assertion first. If it's 0, the previous line would throw with a weird error.. Let's call this twice too.. We generally try to avoid __DEV__ && ... because it's not always obvious what's static and what's dynamic.\nCould you please just use nested ifs?. This comment is not relevant here because you\u2019re not testing deduplication :-)\nTo actually test deduplication, move it after the second render.. I think we can leave this check as is. It\u2019s a hot path so we can\u2019t do .some() there. It\u2019s also unnecessary because the number check below should cover it. . It depends on how deduplication is implemented\u2014in general I'd say rendering twice is a more sure way to tell if it works or not. You're right that in this case it's enough, but I would feel safer if we render twice and then check.. Just Map.. I still don\u2019t understand why this change is necessary. . Actually I think this is wrong. This means we only check once, not warn once.. Fixed in https://github.com/facebook/react/commit/abe0faf3a18ea5f3765f2e0390e4cf0b3f25fc80.. Shouldn\u2019t this compare to REACT_FRAGMENT_TYPE itself then? Without quotes. . Why does it work? Did it get enabled by default in some Node version?\nIn this case let\u2019s leave it on. But JSX shouldn\u2019t be. . Unintentional?. It feels confusing that we still have to explicitly ignore some paths here but ESLint is fully covered by just \u201cpatterns\u201d config. . Let\u2019s rename that file to filesByLanguageVersion?. I just mean we can safely omit this change from a PR.. I see. Let me look at that.\nI think I can take this PR from here, thanks a lot!. I don\u2019t think we should be calling internal functions. Just using props is enough. . This wasn\u2019t a hot path.... ...but this is. Seems unfortunate to run this check every time.\n(Also, if we do this I\u2019d expect it to happen outside of renderDOM which renders host components only.)\nSince we already read .type above when comparing to fragment maybe we should turn that branch into a switch?. Why didn\u2019t Fragment need this?. That's the plan. Thanks, that part looks good . Should this just be React.Fragment? Same for others. Some our warnings put < and /> around names.. Is this reentrant?\nImagine renderToString(<App />) where App calls renderToString() on another tree.. This actually removes valid assertions. :-) Yes, here they get deduplicated, but we still want to test those cases. Maybe let's use both caller name and the stringified \"received\" as key (combined)?. >Now that I look at this again, I believe this explicit check is necessary since we've necessarily spied on console.error in order for the matcher to work.\nWouldn't this approach solve it? https://github.com/facebook/react/pull/11786#discussion_r155672766\n\nIIR, I originally tried to clear the spy at the end of the matcher, so unexpected errors/warnings would cause an error\n\nI don't quite understand what clearing means in this context, or why it would be helpful.\nMy proposal would be to set up a mock when we enter toWarn and tear it down when we exit it. Outside of toWarn, I'd want console.error to be replaced with a function that insta-throws.. Yeah maybe :-) I don't care strongly. . >We could work around this in other ways. For example, I could not use Jest's spyOn functionality at all- but just override console.error with my own function and then restore the originally one before exiting. Maybe that's best anyway?\nSorry I wasn't clear; yes, this is what I meant.. >My initial design for this matcher was to setup a spy/mock when entering and then remove it before exiting. This way unexpected console.error calls would fail the test (as they do if you don't spy in the first place)\nThey still wouldn't fail it immediately. Only upon checking the mock (which currently happens at the end of the test). But this is annoying because you have to \"backtrack\" to see where exactly an extra warning has fired and why.\nMy proposal was to override these methods so we can replace them with shims that throw when we're outside of the toWarn block. This way calling them would fail the test immediately rather than we have reached the end of the test. But it does require us to roll our own.. >Regarding the second thing you say, I think you're just suggesting we modify our console overrides here to throw immediately rather than in an afterEach? I don't think this is specifically related to this PR, but I'd be happy to make that change as well.\nIt's related to making this PR more than an aesthetic change :-) I think throwing early extracts a benefit from the new API\u2014something we haven't been able to do before. It also prevents accidental use of old API (directly asserting on the mock). But I agree it's not a prerequisite.. Here is a scenario before and after:\n```js\ndoSomething();\nconsole.warn('did not expect this warning');\ndoSomethingElse();\n// we used to throw here\n```\nIn our current setup this test fails after it has finished executing. We have no clue as to where in the code the warning has happened.\nCompared to the same code:\njs\ndoSomething();\nconsole.warn('did not expect this warning'); // we can throw here\ndoSomethingElse();\nSince we now know that any warning outside of toWarn is bad, we can have it throw immediately, and thus show the stack trace.\n(Note: after editing I realized we can already do this now, for tests that don't expect any warnings. But my next example is unique to this API.)\n\nIf this still doesn't make sense, never mind, maybe I'm not explaining it well and it's not that important anyway.\nAll I'm saying is that toWarn() kind of API gives us the ability to know where exactly the \"expected zone\" for warnings starts and ends, as opposed to the previous API whose granularity was \"something in this test warns somewhere\".\nSo previously we couldn't fail immediately on a warning outside of that zone since the whole test was \"fair game\". But now we know exactly which lines can warn, and if any line outside warns, we can fail.\nIn fact now we can validate the warning messages immediately.\nWith\njs\nexpect(() => {\n  console.error('unexpected stuff'); // <-- we can throw here!\n  doSomething();\n  console.error('stuff');\n  console.error('other stuff');\n}).toWarn([\n  'stuff',\n  'other stuff'\n]);\nwe can now throw right in the first console.error call because we already know it has mismatched and there's no point executing the test further (and obscuring what happened by letting variables be mutated, etc).\nOn the other hand, with the current approach\n```js\nspyOnDev(console, 'error');\nconsole.error('unexpected stuff');\ndoSomething();\nconsole.error('stuff');\nconsole.error('other stuff');\nexpect(console.errors.calls.length).toBe(2); // <-- but we used to have to throw here\n```\nwe only know something went wrong by the time we reached the last line, and the state might have been obscured by now. Usually I end up having to comment out every line one by one until I find the earliest one where the mismatched warning still happens.. (My initial comment didn't make sense so I edited it). >It was still possible to do the throw-immediate thing before though\nHow would it work with this test case?\n```js\nspyOnDev(console, 'error')\nconsole.error('unexpected warning')\nconsole.error('expected warning')\nexpect(console.error.calls.count).toBe(1)\nexpect(console.error.calls.argsFor(0)[0]).toBe('expected warning')\n```\nPreviously we couldn't safely throw on the first console.error because we didn't know its message is unexpected by the time it ran.\nBut with toWarn we can because we know the exhaustive list of expected messages (and their count) before console.error is called.\nThus we'll get a full stack trace to the place where the message actually fired, as opposed to our check. And less code would run (which aids debugging).. This is a bit hard to read, can we negate individual expressions instead?. Can you explain these changes? I\u2019m not quite following. . Is it important to preserve them now? Why?. I see, they\u2019re here now. Still curious why you moved. . This sounds generic and not obviously error related. Do you have other uses?\n(Replying to myself: blockers you dummy.). Unrelated to this PR but I wonder what happens if console.error throws. Can happen if somebody overrides it for blacklisting and messes up. I hope we don\u2019t go into an infinite loop. . These todos are for blockers?. This one also fires for JS errors and images (not just media) but AFAIK it doesn't truly bubble either way.. This is a bit shady. I actually don't know why it's necessary at all. Native events don't always have event objects?. Happy to bikeshed on naming here. On the one hand it's not exactly clear this is flushing an existing queue as well. On the other hand, as far as I can tell, it's not supported to enqueue more events while we're extracting them (there's an invariant below saying it's not implemented). So the naming is probably fine since it's not supported to enqueue and not flush them anyway.. Let's just make the whole thing an array and add filename as one of the fields?. (This is specific to React Native). Hmm, not sure we want to introduce side effects there.. Can we include the expected next warning message if one exists, in this message?\nOtherwise it's a bit confusing that simply having a typo in the expected warning prints a message as if a warning was not expected at all.. I always forget what this does. Maybe = [] or .length = 0?. Can we use something well-known like Lodash for this?. Maybe shouldTerminate?. Nit: Maybe progressState? Not a fan of obj suffix.. Just ++. MIT license please :-). We could also change them to use jest.fn or something directly. . Fiit . We weren't using these anymore. Yeah, thanks for highlighting that. They are logged now (by jsdom) but we should probably fail the build on them (?)\nThis issue (and related PR) is actually why I got curious about updating jsdom :P. I think this was intentional although I don\u2019t remember what exactly it\u2019s trying to verify. Maybe it\u2019s not that important.. Are we sure this one is right? Can we log it and see what it's equal to for this PR?. Could this somehow get cached by Node? Since we overwrite it during the build, maybe we should fs.readFileSync() it?\n  . I think this file should not be checked in. It should be gitignored.\nLocally, instead of comparing to it during the run, we should locate a special cache folder (like babel-loader uses for caching). Inside that folder, we should have {sha}.json for every build done locally (that hasn't been purged from the cache yet).\nWhen we build with a clean git state, we can copy the JSON as {sha.json} into the cache. On every build (clean or not) we should also look up {merge-base-sha}.json in local cache. If it exists, that's what we compare against. Otherwise, we don't print the stats locally.\nWould that make sense?. (It's not a blocker though if we can get the remote results to be right at least). This of course is unrelated to this change, but we need to record them once in a while anyway. I can remove from this PR though.. Why can't we put these in react-reconciler/index.js.flow in the first place?. Have you checked how this looks in a browser? Since you didn't add the linebreaks I assume it will look a bit confusing.. I don't understand how this could work. Any JS object has toString defined.. Please don't expect fast responses during the holidays :-). Yes please. It could be inherited from something else. I think in general trying to detect a custom toString is a flawed approach.. Not necessarily. This function expected a string. But that's just because we let the code go far enough to go into this function. From user's point of view, they might expect it to be a custom component but they messed up the import and got undefined instead.\nWe should check earlier and show a full message, with the same wording as on the client. We should also add a test case to ReactDOMIntegrationElement-test similar to existing itThrowsWhenRendering calls in it. This way we verify the behavior is identical on the client and on the server.. Something like appendToContainer in the renderer?. A lot of these are outdated. Once we get the tests passing we should trim these down significantly.. No, what I'm saying is we should check if it's a string just before entering renderDOM. If it's not a string then we should throw.\nI guess technically it means the check could be inside renderDOM but I still find the flow to be more confusing since it depends on renderDOM call being the last branch. Moving the check out would make more sense to me.. Hmm maybe? Idk :-(. Worth supporting for consistency I guess. What if it already has onclick? Is it expected that rendering into it overrides onclick?. IMO would be nice to avoid another top level dotfile if we can.\nI'd move it to scripts/flow/coverage-config.. Should we do that in trapClickOnNonInteractiveElement itself then?\n  . Yeah, I guess you're right. By the way do we do this regardless of whether we're mobile safari? Is that good? Should we check the browser somehow?. This is not an error. It\u2019s comparing the actual children (because the error was \u201crendered\u201d into the DOM by an error boundary).\nJust change this to toContain and completely drop the part with the stack. It doesn\u2019t matter because we have other tests verifying the stack works. . Same as below. It was not throwing an error so it shouldn\u2019t throw one now either. . Please add a comment like // Make sure the warning is deduplicated and doesn't fire again before these new lines here and below. Otherwise it's not obvious what's being tested.. Why does this need JSON.stringify? Just coercing to string seems enough to me.. Yeah I think that's okay. Then maybe you don't even need to add new lines. Just add a comment where it's being deduplicated.. Flow isn't happy about this. Maybe try ${callerName}_${(callback: any)}, we don't care about safety here.. We should remove this concept completely.. This should check _hasSuppressedError. I think in order to do that we'll want to remember ReactErrorUtils._hasSuppressedError at the moment we capture the error (together with the _caughtError itself).\n  . This will require changing our unit test setup here and here not to rely on this property.\nInstead we can try changing the expect().toThrow() Jest matcher to set up an 'error' handler that does preventDefault(). Or figure out some other way to avoid failing all tests that intentionally throw an error.. In other words we still want to have a way to suppress error logging.\nWe just don't want to use a custom property on the error object for that. Instead, we want to read a property on an object we created (capturedError is a custom object).. Yeah that\u2019s what I\u2019m thinking. . We should still count this as caught error. The only way _hasSuppressedError should be used is to remember this in capturedError so we can avoid logging it later. The rest of the logic should be the same.. Yes, that sounds good.. We want to change this condition to always call preventDefault() (without the condition). Then it shouldn't log at all (since all errors will end up suppressed).\nAfter that, a few other tests will fail that test logging specifically. We should figure out a way to exempt those.. I don't understand. Can you make a more detailed write-up about cases that are currently failing, and what you need help with?. Instead of asserting like this, we use toWarnDev() in new code. Please see other tests.. We should make sure we don't trigger this warning for the same component more than once.\nIf the client-side code doesn't deduplicate them, we also need to add deduplication there too.\nSomething like\n```js\nconst didWarnAboutBadClass = {};\n// ...\nif (!didWarnAboutBadClass[componentName]) {\n  warning(...)\n  didWarnAboutBadClass[componentName] = true\n}. Probably not... I wouldn't expect this to be in public API of React package. Same. Same, this shouldn't be in React package. Same. Same. This shouldn't be here (same for all of them below). It's on ReactDOM's field, not React's.. I don't think we should add a custom matcher just for this one use case.\nI'm sorry I wasn't clear before\u2014when I said about custom matchers I meant about changing the code that currently uses toThrow(), not this use case.\nHere, you can just use toContain and remove the part with the stack trace (it's not essential to this test). >But we can not do this because as window object is not available in jsdom.\nNot sure what you mean. It is available. There are a few tests that run without it because they run without jsdom in the first place, but generally it's there.. If it's null we still want to show the message. Let's just say getComponentName(workInProgress) || 'Unknown'. You can add a custom matcher. See toWarnDev definition for an example of custom matcher. Maybe there is a way to similarly override the built-in toThrow matcher and do some custom logic in it?. Yep, thanks!. You can do expect(ReactNoop.getChildren()[0].children[0]).toContain(. Well, you can inspect the structure and figure out which one to compare \ud83d\ude09 . This part is kinda hacky and is the reason they weren\u2019t shared. It\u2019s just a different data structure. Maybe it\u2019s reasonable to change the function itself to accept the type directly, but I would rather have duplication than \u201clie\u201d about the type like here. . Let\u2019s just keep it how it is? I don\u2019t see us changing this function anyway so it\u2019s not worth unifying. . Can we return a copy here please instead of mutating?. This still mutates the object.. If there is (incorrectly) more than one child, this will ignore it. Let's make sure we don't \"lose\" any input children?. Some tests (only a few) use @jest-environment node. Search for it. Those won\u2019t have a window, but they also won\u2019t have this problem either (because the problem is specific to jsdom).\nAll other tests will have window.\nRemember setupEnvironment executes once per test file, not once per project. So it runs in different environments. . Oops I think this might not be enough now? We need to do the same for mediaEventTypes or we'll \"lose\" some events?. Whatever\u2019s currently there is \u201ccorrect\u201d in the sense that we shouldn\u2019t change it now, and we should remove SimilateNative altogether in 17. . Yes, thanks!\nI think for that test (and the few other tests that also have this problem) we can maybe wrap them in expect(...).toWarnDev()?. needs trailing comma (just run yarn prettier). Is it worth still trying to test this? Does this trigger some other code path in RequireJS?\nMaybe we could copy the fixtures?. Top-level folders in fixtures sound fine, let's keep both versions. Pretty sure ReactART-test failed without it. Just a manual smoketest.\nI'm not an expert either\u2014do what you think is reasonable and we'll try to review :-). Thanks, but it is important that this stays as a direct access so JS engines can better optimize what this code is doing in production.. I don't think these are important there. We generally prefer less terse code so we avoid surprises from Babel when it generates suboptimal code.. Nit: we're sure in this case, maybe drop the \"may\". This can be null, right? Do we want to pass {} in this case for type safety?\nI don't remember what this debate settled on.. I know they're not enabled yet but I don't think it's reasonable to emit one warning per component when we enable them.\nI would probably coalesce them across components. Gather data during reconciliation and then print after commit:\nThe componentWillMount() hook has been deprecated [...] It is currently used by the following components: A, B, C, [...].\nThis doesn't block the PR though.. Maybe !== null && !== undefined? I think we wanted to avoid relying on truthiness to make engines' life easier.\nIt's okay if you're matching some existing code though.. How do you feel about .call(null so that people can't rely on this value being the type? Not that it's hugely important, but could be easy to accidentally break in the future.. Should we flat out refuse to support both in one component? Why not?. Why is it important for these to be isolated?. Same as above re: maybe using .call(null. Yes, we do (or, rather, did, since we removed the whitelist in 16) this for unknown DOM props. Before we did this, the users were super annoyed because we literally printed hundreds of warnings. I think we need to be very unobtrusive here because this change is already very churning.. I just think it's easier than thinking about edge cases from using both. I might be wrong though.. Sorry, I meant why is it important to make them fields instead of top-level like we usually do.\n. We could change signature of this to addPercent(text, includeEmoji). Because we want percent sign in both cases. This lets us make the call unconditional, with different boolean values depending on the branch. Similarly, we could have boldRow accept a boolean.\nThen you could do\njs\nconst isProd = r.bundleType.includes('PROD');\nreturn setBoldness([\n  r.filename,\n  addPercent(r.prevFileSizeChange, isProd),\n  // ...\n], isProd);\nand not duplicate the column list twice.. Nit: this could be called isBold because this particular function cares about the formatting rather than when we make it bold. This is new to me. Why?. Haha no worries. Fresh eyes always help \ud83d\udc40 . Could you add a comment with different things it\u2019s supposed to match?. Do you plan to create a spill-over issue or do it here? Easy to forget something like this.. This is intentionally shared between all clones, right? Is cloning just an implementation detail invisible to the user, like with Fibers?. Why does this code need to work with Fabric instances? Do you mean we should pull it out and be shared between the two?. This is a behavior change. I don't think we want this.. But ... React is JavaScript! \ud83d\ude04 . This should also say \"deprecated cWM/cWRP\" rather than \"unsafe lifecycles\"?. Worth adding a similar test for unsafe lifecycles maybe?. This pollutes the react module but there's no resetModules() in afterEach. Let's add it so that any tests added later to this file aren't affected by this monkeypatching.. Do you want to have a similar test for non-unsafe naming too?. I expect that people will use this secret flag to fool React and \"hide\" valid deprecations on components. Do we care about this use case? Probably not; I'm just noting that for people who do that, it would be counter-intuitive that we only check for that flag on componentWillMount but not on other methods here.. I haven't looked through those changes in detail.\nI think it would be good to write up a table of what happens when both of either of methods is present (e.g. gDSFP, cWM/u_cWM, cWRP/u_CRWP).\nMy concern is that maybe some edge cases (e.g. \"both cWRP and gDSFP\" or \"both u_CWRP and gDSFP\" etc) may be handled differently between Fiber, SSR, and Shallow renderer. Of course we'd warn in this case but consistent behavior is still important.\nNote I'm not saying that there are mistakes. Just that this logic is getting complex, and it's not obvious to me that all these cases work the same way. Making a table with different permutations and expected result would help us fix bugs if we find any later. It might also be helpful for the blog post.. Maybe change this to test for function type explicitly for consistency? I know it didn't before but still.. Please add another test case for undefined type.. This line will crash if elementType is null or undefined.. Hmm wait. I don't see how this could work. Owner is defined on the element. Not on the elementType.. In other words you want nextElement._owner here. We know nextElement exists because we already read type from it.. This assumes no one manually edits them (e.g. to reorder). It's probably a fine assumption to make but would be nice to leave a comment with expected format. Or assert it.. Why are we doing this here instead of wrapping <UndefinedComponent /> JSX call where it happens?\nlet el;\nexpect(() => {\n  el = <UndefinedComponent />;\n}).toWarnInDev(...)\nawait render(el);. I don't quite understand how this check would work.\ndomElement here can be arbitrarily nested, can it not? Therefore it's not guaranteed to be a root.. Let\u2019s combine this file with StrictMode tests and just call this \u201cModes\u201d. We shouldn't have used this. It introduces reliance on Symbol which we don't currently require.\nI think we should add a lint against for ... of as it's easy to use accidentally and it's not obvious what it compiles down to.. Strictly saying this is the only case where it matters. But I figured changing TestRenderer code doesn't hurt too.. Oh I didn\u2019t know that. Happy to take a PR. . This feels surprising. Moving code into an iframe could fundamentally change the behavior if it used to pass the first check but doesn't pass the second one now.. Typo. \ud83d\ude2e. Not a super big fan of this. I usually grep for assignments when debugging to figure out what piece of code changed a field. On the other hand the code is smaller... I don't understand this, can you explain more? Does this fix the issue I reported or is it unrelated?. This makes sense theoretically but how practical is it? Once we're in an error state it's likely other things can break due to mistaken assumptions with cryptic errors that can't be reproduced otherwise.\nI guess a logger could remember whether it saw an error earlier, and attach that as metadata.. Can you explain why this is called \"combined\"? What is being combined here? Isn't the first effect that we \"catch\" the only one? Or do we attempt to render siblings as deep as we can and then \"wait on all\"?. This would make sense to me. I would maybe check just stack since it's added by the browser, but message could potentially be empty (I think?)\nOn the other hand is it plausible that Promise ever gets a stack?\nAlso, what happens if you just throw a string? It's bad but it can happen. We used to handle this, do we not anymore?\nMy impression is that the plan is to treat thenables specially, and treat everything else as an error. Why is the logic written around special casing the error object?. Do error boundaries still catch strings?. Please don't forget to change this back :-). To be honest I'd say it's okay to say this was unsupported. It's a known bad pattern, and error boundaries should not (yet :-) be used for control flow anyway. We always suggested they're meant to be used for exceptional situations.. Is this code path commonly exercised in tests? Is there a risk that we'll add a new tag, forget to add it to this switch, and it blows up only on the error path (which is rare enough that we will miss it)?. We should do this correctly right away since it's not a legacy package.\nLet's remove the default export here and only provide named exports. That's how we make it work with tree shaking, too (when we provide an ES build output).. To clarify, I'm saying this file shouldn't need to use CommonJS at all. Just re-export * from the source.. I think there was some reason but I don't remember straight away.\nIt's not very important in case of the reconciler though because it provides just one function. react-is, on the other hand, provides a bunch, and is expected to grow.\nCall/Return does avoid the .default hack: https://github.com/facebook/react/blob/29e8924c70856bef9b11e0c74a450140bfcce773/packages/react-call-return/index.js#L12\nIf there's some issue with top-level ES import (maybe there was) then the above is sufficient.. I could see this being confusing (e.g. when you read Fragment you assume it's from react).\nMaybe let's keep it grouped, like before? It just needs to be a namespace import rather than a default one.\njs\nimport * as ReactIs from 'react-is';. Can you explain why this is necessary?\nIt seems like if I add a package, I'd like to see its size reported.\nAnd for this PR, I wouldn't expect a \"new package\" to get reported because this PR did not add a new package.. This seems like it would return true for {type: 0xeacb}. But React wouldn't consider this a fragment. It would only consider {type: 0xeacb, $$typeof: 0xeac7} a fragment. Same for all other things with type. This is a small detail but IMO we should be strict about these things.. I find the structure of this function a bit hard to follow. Is there any specific reason it is written this way?\nIt also seems like we're reading .type and compare it many times in pretty common cases like when the input is an element.\nI would prefer to write it inline:\njs\nexport function typeOf(object: any) {\n  const $$typeof = getTypeOf(object);\n  switch ($$typeof) {\n    case REACT_ELEMENT_TYPE:\n      const type = object.type;\n      switch (type) {\n        case REACT_ASYNC_MODE_TYPE:\n        case REACT_FRAGMENT_TYPE:\n        case REACT_STRICT_MODE_TYPE:\n          return type;\n        default:\n          const $$typeofType = type.$$typeof;\n          switch ($$typeofType) {\n            case REACT_CONTEXT_TYPE:\n            case REACT_PROVIDER_TYPE:\n              return $$typeofType;\n            default:\n              return $$typeof;\n          }\n      }\n    case REACT_PORTAL_TYPE:\n      return $$typeof;\n    default:\n      return null;\n  }\n}\nWhat do you think? IMO this makes the object structure a bit clearer, and avoids unnecessary property reads.\nIt also mirrors how we use it in practice (both Fiber and SSR) so it is helpful as a guide for \"how do I handle all the cases\".. Seems like all of these could be rewritten as typeof() comparisons to ensure 1:1 check parity?. I don't agree that repeating the same checks many times is a nit. Generally we avoid this everywhere else in the codebase. (If you're referring to the previous comment.)\nYes, they probably don't make a difference in a large scheme of things, but if we can make it more efficient, why not do it?\nFor this comment, I'm not sure. The issue I noted in https://github.com/facebook/react/pull/12199#discussion_r167444125i was a correctness issue. It was fixed in https://github.com/facebook/react/pull/12199/commits/b22a7b78836d7d8252989c7a9a7522c40e7d2637. The fix required changes in two places. My concern is that it's confusing to remember both those places need to contain this logic. When we add a new type it won't be obvious which ones of those get* functions need to be called for is* to work consistently. Expressing this via typeof() solves this problem by consolidating that logic in one place.. >PS using typeOf in isElement didn't work, because the return type was overly specific. I didn't feel strongly about it, but I opted out of using typeOf director for that reason.\nYou probably considered it but another way to express this would be\njs\nswitch (typeof(obj)) {\n  case Element:\n  case ContextConsumer:\n  case ContextProvider:\n    return true;\n  default:\n    return false;\n}\nI agree there's no clear winner in this particular case though.. See my response below in https://github.com/facebook/react/pull/12199#issuecomment-364786033. Again I agree it probably doesn't matter in practice. But since it's a core utility and it's easy for us to minimize property access I don't see a reason not to.. Do any first- or third-party components use this with createReactClass like\njs\ncreateClass({\n  mixins: [NativeMethodsMixin],\n?\nIf yes, what happens if such component declares componentWillReceiveProps, but not componentWillMount? Could it be that suppression check here will cause it to show no message for custom componentWillReceiveProps (which we should have warned about)?. Meh. Probably okay.. Can you explain this change? I don't get it.\nWe were specifically looking for the UMD prod bundle earlier because that's the one we consider the \"React size\".\nSame below.. Let\u2019s not duplicate this hack anymore. It\u2019s only necessary for legacy stuff.\nSee Brian\u2019s react-is package for how we should do it in the future. . Ideally we should keep the error state and let the user display the message with a \u201ctry again\u201d button. Is this what it does?. Maybe (new)? I don't feel strongly. \"No changes\" becomes \"+0.0%\". Do you think maybe we could special case this and show (none) or (same)? Danger will skip over them but they still show up in local output. Or at least maybe lose the + if it's exact zero.. I bumped into a funny case where I accidentally clobbered the timeout queue with a bunch of setTimeouts that reschedule themselves, and the fallback never showed up for this reason. Was very tricky to debug.. Can we provide a component stack trace here?. FYI, I got here with 16.4.0-alpha.3174632. A warning wouldn't need this check in production code path. It would error in either case but for normal cases (where it doesn't error) it wouldn't need to spend CPU cycles on this during init.. because...?. Wow why are these things so easy with Fiber . Might want to validate before calling to get a nicer error message. See a similar check before context. I think Seb told me once it doesn\u2019t affect perf because engine has to check it\u2019s a function regardless and will likely remember that. . Hmm maybe we should change context to work the same way then.\nI don\u2019t think we should make it ever invariant during creation. Makes inlining harder and will likely cause duplicate checks. . Should we move this to context creation then? Or do we already warn there?. I mean createElement when we know type is a context consumer.. >Idk, not sure what the advantages are. \nYou get a JS stack trace pointing where it happened.. \"from Flux stores\" \u2014 this clashes with what you say earlier (this shouldn't be used for Flux stores). same. I think we don\u2019t need these arguments then. . Needs rename. Let's read render first and then call it. Then the fact that it's called with type as this doesn't become an unintenional part of the public API.. Is this necessary for this test? If not you can remove the internal file name suffix. . Needs rebase? Current. . Got it. Okay.. Why not a field?. To me, mutating state feels stranger than splitting them up. e.g. we might freeze the state object in the future.. Looks good to me! I trust you to know when it's safe to mutate things \ud83d\ude1b . We already write to __reactInternalMemoizedMaskedChildContext and __reactInternalMemoizedMergedChildContext for legacy context. I think anything __reactInternal is fair game.. It's enough to replace this whole block with just ReactDOM.render(<App />, container). If it did throw, the test would fail anyway. You can remove the error declaration too.. We avoid implementation details in test titles. Just \"should not crash calling findDOMNode inside a functional component\".. Did we intentionally \"lose\" the errorInfo argument here? Seems like a major change.. This is indentation change to make DEV-only intent clear (even though the whole function is only called in DEV).\nBut I also made it use name.. https://github.com/facebook/react/pull/12429/files?w=1 without whitespace changes. Maybe move to devDependencies with the others?. Lint fails because we don't use path now. You can run yarn linc to lint changed files.. Do you mind adding a comment here explaining what it's doing?. This line still confuses me a bit. Can it be something other than ClassComponent? Should the errorBoundary assignment also be conditional on that?. Right, which is why the tag check on the next line confused me.. Haha yeah. I think that was fixed in master but would appreciate a double check. Why use UNSAFE_componentWillReceiveProps in this test? Just curious\u2014doesn't seem like the test is specifically about UNSAFE_componentWillReceiveProps.. Personally I find it a bit confusing that one of them has a different type. Maybe convert them to sets (or even create a helper for this pattern) later?. What is UNSAFE_componentDidUpdate?. We're sure we won't forget to fire this warning at FB? Since it would be pretty essential to know this happened.. We seem to repeat these checks quite a few times. Can we extract them to cached variables, and use them throughout the method?. To be clear I mean that there's no lifecycle called UNSAFE_componentDidUpdate at all. It's not an actual alias we use because componentDidUpdate is not deprecated.. Maybe, I'm just not sure if this warning is also coalesced, and whether it will be in the whitelist or not. I don't think I remember our plan for what warnings are visible externally vs internally.. I\u2019d like if @acdlite could confirm this doesn\u2019t mess up any assumptions (I think it shouldn\u2019t but would be nice to verify). achieves? . \"async's benefits\" makes async a noun. It's a noun for us because we say it all the time but I'd say \"the benefits of async rendering\" here.. This is probably because <div hidden> doesn't ever expire.. Maybe we can make it clearer what this number means?\ne.g. (Waiting for async callback... will force flush in 5320 ms). Typically performWorkOnRoot is called inside a loop that finds next thing to work on until there's none.\nflushRoot is special because it wants to flush \"just one\" root. So it only called performWorkOnRoot once. This is why it didn\u2019t flush setState in commit lifecycles (they're just like flushing the same root twice\u2014if my mental model is right).\nThere could be more than one cascading update. So it seems like a loop is necessary.\nI'm not sure those are the right exit conditions though. . Overall I'm not feeling confident in this. There are other things performWork does that performWorkOnRoot doesn\u2019t. For example scheduling a deferred callback for leftover work. I\u2019m not sure if missing this here means it would get dropped. I wonder if we could reuse the rest of the scheduler code, but teach the scheduler the concept of the \"current\" batch which gets committed in isolation if it exists.. Also not sure what would happen if we used flushSync to schedule another root inside a currently committed batch's lifecycle.. https://github.com/facebook/react/issues/12502#issuecomment-377730208. Please don't edit this file. It's generated automatically on releases. Editing it now means people on older versions won't be able to find this error anymore.. \"made a component\" is a bit odd, maybe \"wrote\"?. Sounds good. This condition doesn't match what it used to be.. Since the goal is to be super fast I think the tradeoff of writing an \u201cinternal\u201d test for this (and doing no validation in DEV) is the right one. . Dunno if it helps: https://github.com/facebook/react/issues/12420#issuecomment-377952155. This one causes an unexpected pop because replay logic assumes we can always safely pop context after \"begin\" phase failed:\nhttps://github.com/facebook/react/blob/6b99c6f9d376bacbb769264d743c405b495b03ad/packages/react-reconciler/src/ReactFiberScheduler.js#L274-L291\nBut this doesn't necessarily need to be the case if pushing context involves running user or renderer code:\nhttps://github.com/facebook/react/blob/6b99c6f9d376bacbb769264d743c405b495b03ad/packages/react-reconciler/src/ReactFiberHostContext.js#L86\nhttps://github.com/facebook/react/blob/6b99c6f9d376bacbb769264d743c405b495b03ad/packages/react-reconciler/src/ReactFiberHostContext.js#L64\nIn that case there's a chance we won't get to push, and the stack won't line up.\nCuriously, for legacy class context we seem to avoid this problem because we first push without running user code and then \"replace\" it. So even if user code failed, the stack would match up. Maybe we could always do something like this?. This one fails because we assume rendering is idempotent:\nhttps://github.com/facebook/react/blob/6b99c6f9d376bacbb769264d743c405b495b03ad/packages/react-reconciler/src/ReactFiberScheduler.js#L297-L298\nBut there are cases (like lazy init) where it might throw the first time but not on subsequent calls. Or just a buggy render implementation where we may render something completely different. We should handle this gracefully. When this happens, when we exit this block, failedUnitOfWork is not the same as nextUnitOfWork (which might be null):\nhttps://github.com/facebook/react/blob/6b99c6f9d376bacbb769264d743c405b495b03ad/packages/react-reconciler/src/ReactFiberScheduler.js#L939. Should we maybe clear the variable just before throwing so we don't hold onto it until next replay?. Even though this one is for forceUpdate I figured we should push people to use this.state = ... and setState here anyway.. Note these are not new warnings. Just new tests for an existing warning.. Since we don't want to encourage those methods (and will start warning for them in the future) I wouldn't worry about them.. I feel hesitant because there might've been some reason it was written this way. For example I think this will have a false positive for hasOwnProperty. And potentially will make adding anything to Object prototype in JS spec a breaking change.. Do you mean you want to drop the second part? I thought it's kind of important because these issues will get more prominent with async.. Could you give me more details on your strategy in general? Is this the only issue blocking you? It's a bit hard to believe given in how many places we use dot-access.. I think I see what you mean. If this only affects constructor we might as well not talk about this.. I think we still need for React Native (and to go through our custom fbsource RN infra there).\nAlthough we might as well have implemented that through the new forking infra.. Been too long since I worked on Fiber. Thanks for catching.. In the rest of the codebase we use a function called invariant for errors. That integrates with our system that replaces error messages with error codes in production builds. Could you use it here too?\njs\ninvariant(false, 'message'). Let's be more specific here. Only null and undefined trigger that error, right?. Nit: extra line. One error for both cases is fine. FWIW, we've intentionally stopped using loose checks a while ago because they sometimes cause engine deoptimizations. I'd prefer strict ones. . Maybe something like React.cloneElement(...): The argument must be a React element, but you passed %s. and either null or undefined as second argument (invariant will interpolate it).. Yes please!. I don't think this is safe because findHostInstance is being passed to DevTools below:\nhttps://github.com/facebook/react/blob/76b4ba01290f446f4313adf3846954412c6051b8/packages/react-reconciler/src/ReactFiberReconciler.js#L508-L512\nDevTools assumes it can pass a Fiber there.. Aren't we already? This code is in the reconciler. I'm just pointing out that I think you changed the signature of the function you're passing.. Can you please revert this file?. This can probably move into ReactDOM-test?. Note: Map constructor doesn\u2019t work in IE11 so we\u2019ll need to change this . Iterating sounds fine I guess . Let's use specific cases and throw for default?. Same. I would prefer a wording like\nWarning: React does not support `!important` in inline style values. The specified `backgroundColor: \"red!important\"` style will be ignored. Either remove `!important` from the style value, or use a DOM ref to directly to set this style value.. Let\u2019s call this Context.Provider. This is missing the component stack argument. Can you please add it, similar to how we do elsewhere?\nI think you can use getCurrentFiberStackAddendum similar to how we do in ReactDOMFiberComponent.js.. Let's only call checkPropTypes if workInProgress.type.propTypes exists. Read it before the call and then, if it exists, call the function, passing it as an argument.. Could you please split this into two nested conditions? We try to always keep if (__DEV__) { as a separate block to make it very distinctive. . Please include stack in the expected message. You\u2019ll want to use ** placeholders similar to other tests that assert about the warning with stacks. . Why this change? Do I need to update my diagram? \ud83d\ude2c\nDoes this fix some edge case?. Instead of injection, could we move this to isntantiation time?\ncreateResponderEventPlugin(TopLevelTypes). I suggest that all modules that need top level types (including the store) export factories that take them as an argument. . Can we just rewrite the test to not depend on that?. It would be event better if we completely dropped usage of Simulate or SimulateNative in these tests and just used DOM dispatchEvent like in some other tests. Note this only works when component container is mounted in the document. Again, exisiting tests with dispatchEvent show how to do it. . Ok. This feels unnecessary, can\u2019t we call createResponderTouchHistoryStore from the inside?. Returning them together in an object sounds fine to me.. Please move this right after imports so we only do this once. You can check how we do this in other files. . Can this be Flow opaque type? So that we don't rely on what it is.. There is a concern that using a Map could be slower.\nI've seen this happen in https://github.com/facebook/react/pull/11733.\nOn the other hand, with numbers it would be slow to use number as a key in a regular object.\nThis needs benchmarking. Do you have ideas on how to measure the effect of this change?. I don\u2019t think we want this. We don\u2019t want it to be used in UMD builds if I understand it right. . Instead we want to add react-scheduler to dependencies of react-dom. . Changes adding script tags should not be needed. . AFAIK putting it in dependencies should do exactly what you described (for 16).\nCJS gets a require, UMD continues bundling (if you remove it from knownGlobals).\n. Can you add a comment clarifying these are RN types? Or even declare them separately as RNTopLevelEventType and use that in the union?. Will this be a breaking change for RNW? Technically we treat unstable* things as semver-exempt but it would be nice if it \"just worked\" for existing RNW users.\nIf not, it's okay, but would be nice to have a PR to RNW ready that shows how to prepare for this change.. Let's use a for loop. Same. There should be a note here explaining what's going on.\nSpecifically that these are opaque to the rest of the code but we do rely on them matching DOM names.. It seems like at this point we might as well just write [TOP_BLUR, 'onBlur'] and remove the string transformation below. on* across a list like this should gzip well. Can you try this? It would be nice to get rid of the concatenation and slicing/uppercasing here.\nhttps://github.com/philipp-spiess/react/blob/af02875c73e85300495d986c66488cd5a30b5470/packages/react-dom/src/events/SimpleEventPlugin.js#L134. With what?\n(Sorry if I'm being dense)\nAlso, is it possible for a deep update to influence the value of a ref above it?. >maybe Foo gets new properties that causes it to recreate the ref, but only a filtered set of those props are passed through to the ForwardRef component, so from it's POV nothing has changed?\nOK, that sounds potentially plausible. If you find any free time to hack on this I'd appreciate a test.. >If the ref callback itself changed, most likely this just means it's an arrow functions and has an identical implementation.\nI don\u2019t think we can rely on something like this. Otherwise we might as well never update refs.\nWe handled this correctly so far so I don\u2019t think we should regress in this particular case. . We chatted a bit with @acdlite and he proposed to check against current.ref. Seems like it wouldn\u2019t hurt but I\u2019ll think about it more tomorrow. . I am proposing that the second (not the first) item in these tuples becomes the event name. Then we can remove slicing and lowercasing.\nIt would change the eventTypes keys though (we\u2019d have to either slice it there or change the keys). Maybe that\u2019s significant. But I\u2019m not sure why keys there matter. They only seem to be used for Simulate.* names. But we can slice/lowercase there instead. . We don't disable these bailouts in strict mode for other components so we probably shouldn't here either.. OK, I inlined it back at usage.. OK, let me know when you're ready for another review pass!. If we back out of this change let's also remember to back out of https://github.com/facebook/react/pull/12676.. Also test renderer \ud83d\ude04 . Please destructure these early. We don't want the overhead of object access.. Actually I think it might make more sense to use our static forking mechanism for this. This was unused so I removed it.. Please be specific, e.g. !== null. Actually, isn't this just an identity function? In this case it would always choose this code path.\nDoes this mean we can just remove this check (and count on nobody using unknown dependency types if they access private API)?\nMaybe we could validate them in development, but not in production?. I think @sebmarkbage means we need memoizedProps, not pendingProps?. It's not ideal but since we're already doing this for context I guess this doesn't make it worse.. If you don't need this in PROD, let's avoid the extra allocation? Like ReactDOM does.. Same for the root one.. That\u2019s a century in JavaScript Library Years. . I want to keep instantiation. I think it works fine and in this case I don\u2019t see downsides (we don\u2019t plan to make this one inlined). . I can make it createReactNoop. No plans to do anything else with it. . We already print the error message itself earlier so these are additive.. I think at the time this was intentional because we didn't separate those concepts, and didn't want to have the overhead of setting a property in PROD when it doesn't end up being used (functional components can't be ref owners which was the only runtime behavior of this feature).. I'm bumping into this with test renderer when the context object is reused, but resetModules() is called between tests. Seems confusing.. Why did you remove root here, but null above?. Might rename/reuse them for next types we add?. DevTools does. . Haha oops . Looks like these changes are now unnecessary and can be reverted? We still expect one warning with null even if you don't pass onChange.. null is what getFirstHydratableChild would return given a text instance in current implementation.\nThat's why the behavior hasn't changed.\nhttps://github.com/facebook/react/blob/8227e54ccf32f47e4c6bf5f30d08f84b8fed455d/packages/react-dom/src/client/ReactDOMHostConfig.js#L422. It's my fault for missing this in the review, but this completely removed flow typing from the most important module in the codebase.. It's not super easy because a few modules already depend on this implicitly being any. I'm already working on a PR fixing this. . I had to extract this because Flow couldn't follow that fiberTag is always assigned in practice.. Had to inline these because Flow was getting confused when an error happened via another method.. I think this shouldn't happen in practice because we always assign them before performing work.\nIf it does we'll want to know.. Flow wasn't sure nextUnitOfWork isn't null without an explicit if / else here. \nThere's another break below the whole thing.. This is an invariant in DEV-only code. But we know it already crashes (https://github.com/facebook/react/issues/12449#issuecomment-386727431).\nMaybe @acdlite can think of a better fix but for now I'm making the existing bug explicit in the hope that somebody gives us a repro case.. We only call record method (which calls this one) in strict trees. So it's an underlying assumption that we can find it.. I cut this part out completely because it was only relevant to call/return.. I checked return value isn't being used. This is a type that wasn't updated.. angery reaccs only. Looks ok to me. . Maybe would be easier to get an array with Object.values() and then verify its length is the same as new Set(arr).size? . I think you'll want to restore this after the test has run. It's a global so I'd expect it to be shared between tests. At least within one file so the order starts mattering.\njs\nconst originalSymbolFor = global.Symbol.for;\nglobal.Symbol.for = null;\ntry {\n  // ...\n} finally {\n  global.Symbol.for = originalSymbolFor;\n}. Yea. I think even within a single file it's confusing that re-ordering tests matters though.. No idea. I didn't add this, the code just moved from below.. If you add it Flow will fail so we won\u2019t do it accidentally. I just left a comment so somebody doesn\u2019t think we should add it as part of normal flowification process and then get confused.  . Yeah. But good point. I think we might want to try to fail early although I\u2019m not yet sure how. . I should probably find a way to avoid this. Don\u2019t remember why it was necessary. . Same. . Feels good to Use The Modules. Note that in V8, objects with numeric keys are slow. So if we don't use a Map here (or something else) then it might be a good idea to prefix keys, e.g. id_${id}.. Posted about this internally.. Not a real property (we're detecting a bad polyfill). Fair game IMO.. In theory this could happen and then the code would crash.\nI'm not sure this is possible in practice.. Help Flow know these exist (we just refined).. I'll be working on a followup to fix this. The types are already wrong due to reconciler findHostInstance typing.. I could keep an object mapping but doesn't seem worth it in this case.\nFlow now considers timeout to be a special type (which is good for environments like Node where it's not a number).. Same as above, will fix in a follow up.. Only attempt to read _stringRef from function refs. Otherwise we already know it won't match up.. Just move it up. No change in logic.. This looks like it caught a bug! The invariant could never fire because of the typo.. Consistent naming throughout the file.. This is not super efficient (number keys are slow) but it can only fire in Node so it probably doesn't matter.\nThis is a na\u00efve shim anyway.. Actually it fires in tests. \ud83d\ude2e . Pushed a fix.. In Node setTimeout gives you an object, not a number.\nThis is a primarily Node code path.\nSince our intentional API is to return a number I think it would be confusing if we started returning objects in Node environment. The fact that it uses setTimeout in Node should be an implementation detail.. Hmm. I think this code is still wrong because componentOrHandle can also be either Fabric or non-Fabric instance. Or at least that's what the code implies.. AFAIK we don't run Flow on tests.. Force-pushed the version without the commit that changed this. Yes, it failed before your fix. When would it be false?. Added.. This is confusing. Which one of the two do you expect in jsdom environment? Please be specific. We don't run these tests in browsers so you don't need to account for different behavior.. Looks like we're not catching functional components here. They can also have contextTypes and should also be warned about.. Ping :-). I'd expect Flow to error on this because we pass different number of arguments. Let's explicitly pass null when we don't have an instance?. We try to avoid checks like something && in terms of explicit something !== null && when that argument is coming from our own code (and we know it's either null or an object).. Can you also add a test for factory component please?. This indirection seems a bit complicated :-(\nDo we want to keep this fork long term? Is there a better fix in mind? How will this ultimately work in open source when the package is ready?. Do you mind reverting changes to this file?. Does this look like getComponentName duplication here? Can we unify?. Same here, I feel like this is getting out of hand a little bit. We're going to forget updating some of these.. Let's hoist reading element.type so we don't keep repeating its reads?. Write everything twice. This is three times. :-)\nBut I don't care strongly.. Please revert changes to this file. You can just check container.firstChild?. \"schedule depends on requestAnimationFrame\" doesn't make it obvious \"schedule\" is a name so it reads a bit odd. Maybe we can reword the whole message to not mention the library name? e.g.\n\nThis browser doesn't support requestAnimationFrame. Make sure [...]. Instead of searching from the bottom, shouldn't we start search at the top and stop at the first match? Try adding more nesting to the test.. Please be explicit in type checks (e.g. !== null if that's what you mean). Don't rely on falsiness.. If you don't mind, i-- would feel a bit more intuitive to me. So, do we actually need those checks? I wouldn't expect a provider \"below\" to ever be null. We only clear them out as we pop. As long as we check i doesn't get below zero we should be fine.. Seems like we can remove this condition? For loop already covers it.. Let's initialize it to null and then compare to null instead of a truthy check.. This comment was about why we felt comfortable using Flow any:\n\njs\n// We assume this type is correct because of the index check above.\nPlease keep it above the any case. Maybe change to \"Flow type\" to disambiguate.\njs\n// We assume this Flow type is correct because of the index check above.\n. What does .length assignment do in V8? I'd like to make sure it doesn't think the array length change is likely to \"stay\" because it changes all the time. I think just using null is more straightforward and less surprising to the engine (even though the typing isn't as nice for us).. Please read this.providerStack[i] once. (Move it to a constant.). This comment is redundant, IMO the code speaks for itself. Can we add \"(such as within render...)\" part back? I don't see why it needs to be changed.. These checks aren\u2019t truly necessary, are they? We know they can\u2019t be empty because we\u2019re moving to the left and check the index.\nIf type system disagrees I think we should do an unsafe cast with a comment. . Let\u2019s just inline the try/catch here and leave a comment that this is for SVG in IE11. . Please use invariant(false, message) here so the error message gets stripped out in prod.. Let's change the message to the same one as in the warning above.. This is a DOM element. It's not related to React elements (which are the inputs to this function).. Should we resolve TODOs before getting this in?. Nit: can we avoid Unicode in source and use an escape?\nAlso are we confident ellipsis is printed properly in, say, IE11? Or when the script is served with incorrect char set? Maybe it would be better to stick to ASCII. . Please revert changes to this file . Can you offer some options? I've never thought about this so it would help to get a braindump.. Not really. I think at some point we wanted to delete it completely since we now track builds on PRs instead.. Does it need to be on process.env, as opposed to another global?\nMy understanding is that this flag always gets replaced in build process. So we don\u2019t actually let people use it, do we? Not unless they import our bundle directly. At that point we might as well call it __PROFILE__ to better indicate its internal only. . In case it\u2019s not clear I mean that we didn\u2019t change npm entry point so there\u2019s no way external consumers can set this variable. . I'm mostly curious about your intention. What is your plan for people to use this in CJS mode?. Hmm, we don't need this part now, right?. I think it's used for local builds only. I don't mind removing it altogether in a separate PR given that it doesn't break the build command.. What is the input to this function? Is it a string constructed on the client side? A string we read from the DOM? Sometimes one, sometimes the other?\nCan you add some tests that specify the current behavior, and then we discuss that?. We don't always Flow-type internal functions because those change more often. I figured that since we still have an outer annotation on the public API, we can leave this one inferred. If it returns something bad the annotation on the calling method should catch it.. So, this is a pattern we use everywhere we traverse fibers deeply. It's necessary because each fiber has two copies. The return pointer points to the parent but we don't know which copy (current of work in progress). If we just na\u00efvely follow \"return\" to go up, we might end up in a different tree copy from the previous update.\nThis is why every time we descend down, no matter when, we always overwrite the .return pointer to the parent in the tree we're working on. This should have no observable side effect because we do this on every deep traversal, and we never trust the chain of return pointers to give us the \"current\" tree.. This is just copy pasted from below. I didn't write it.\nIt works this way to skip over fragments / context consumers / other wrappers in the tree, and only \"see\" custom components and host nodes in traversal APIs.. >Why'd we change the previous providerStack to contextStack?\nFrom the PR:\n\nI also have a DEV-only stack for providers. I could've used it for context objects too, but I decided it's nice to avoid some property access on every pop when we need to read the context object. \n\nI meant that if I keep providers on the stack, I need to do a bunch of object access (provider.type._context) just to get to the context object. Storing it directly avoids that. I don't use provider itself anyway for anything other than DEV validation. This is similar to how we store Fibers on the stack only in DEV for validation.\n\nOr maybe, why do we also need contextProviderStack in DEV? Couldn't our DEV warning just use:\nindex > -1 &&\nprovider.type._context === (this.contextStack: any)[index],\n\nThis only validates that the context type matches so it's less restrictive. We could have a bug where we accidentally pop the wrong provider object but miss it because it has the same type.. >It's not obvious to me that the cost of maintaining a second stack is less than the cost of a property access. I guess it's not a big deal either way, since it's DEV only though.\nExactly, I was mostly microoptimizing for prod.\n\nContext (type), Provider, and Consumer have a 1-to-1-to-1 relationship, no?\n\n\"Provider\" is an object in this case. I guess providerElement would have been a clearer naming. So it's literally <MyProvider /> that gets pushed and popped, not MyProvider.. We need to be careful with stuff like this because it won't clean up if the test fails. I tend to either use try/finally (annoying) or put it in beforeEach/afterEach.. Can remove findDOMNode here too. Actually we should remove it in a lot of places in the tests, it's often completely unnecessary and is confusing. Is this based on any existing test in other renderers? If not, can you please find an appropriate existing test and then use it as a base?. Is there any reason you don't make this check a part of useFallbackCompositionData declaration itself?. This part was a bit shady.\nBy default we set inst.refs to a frozen, shared object (in fact, we do this in two places: Component constructor, and later in the renderer). Whenever we want to mutate a ref for the first time, we check whether it's still \"the same\" pooled object, and if it is, we swap it out with the mutable one.\nIn some obscure cases where emptyObject identity changes over time (e.g. due to a module reset in Jest, or due to a duplicate fbjs), this wouldn't work and cause very confusing errors.\nI've changed this to use an explicit flag instead. It is only set and read in this module. By default it's not set.\nWhen the flag is not set, the first attempt to set a legacy ref will know that we need to create a new mutable refs object. Then we set the flag. Next time we attach a ref, the flag tells us it's safe to mutate now.\nI could have put the flag on the mutable refs object instead. But that could break code like Object.keys(this.refs).map(...). I could make it non-enumerable. But Object.defineProperty is kinda slow. I figured an instance property is a fair game because we already use a bunch of those for legacy context.\nThis only affects classes using string refs. There is no cost for classes that don't use them. Even for those that do, it's a single boolean field.\nThis lets us get rid of the dependency on strict equality.. This is exported because there are subtle assumptions around its referential equality in a few places throughout the Fiber codebase. It's used a sentinel value. This makes it explicit for this particular use case.. We can now drop this.. \nI was on the fence about this. Even if it's shared, does it matter if it's frozen in DEV? Seems like you'd quickly catch the mistake. It's also used under this name for context. Do you want to have a separate EMPTY_CONTEXT too? I can revert that part.. We're already messing with them for legacy context. The only kind of components I'm worried about regressing (Relay) has both legacy context and legacy refs. This gives an incentive to migrate off both without regressing the current situation.. Pushed https://github.com/facebook/react/pull/13055/commits/1f0c930aae723f4a066a8751d1264473bd95b43f which makes explicit naming consistent across renderers. I guess context is more localized in practice than legacy refs. Maybe not worth risking.\nI can keep it on the React object but I think this will require some mocking of React itself in tests to ensure the object is preserved throughout resetModules. It was a bit easier for a separate module.. Pushed an alternative fix. I think the check here intends to check against null but will accidentally also be falsy if screenX is actually equal to 0. Please avoid truthy checks like this, they tend to hide bugs.. Same.. I think that if saved screenX is 0, but then you moved to 200, you want to return 200 - 0 rather than 0.. Another thing is that using the same variable for both null and numeric values can mess with VM optimizations. I think it would be better to use a separate boolean flag here.. Shouldn't this be true? I think this caused devtools code to get DCE'd in open source builds.. Yeah, this looks weird.\nWhat does Jest do when you diff two strings? e.g. expect(stringWithSpecialChars).toEqual(stringWithoutSpecialChars)?\nThey likely already solved this somehow. We could use whatever solution they came up with.. Why not?. I briefly talked to @sebmarkbage and he pointed out this doesn't necessarily give you the index inside the parent's host nodes.\nSpecifically, fiber.index is a position in any parent Fiber, which could be a fragment (or even a nested fragment), it could come after something that renders null (and thus doesn't produce a node), etc.\nSo this won't work. I'm not sure what the solution would be, but at least this gives you a starting point with missing test cases. \ud83d\ude43. Sorry \ud83e\udd26\u200d\u2642\ufe0f . Why are we comparing to a string literal here? Is this a bug? In that case it means we're missing a test that would have caught it.. Overall: we are reading props.dangerouslySetInnerHTML a lot of times here. I know old code did too, but this makes reading a bit difficult in all further conditions. Mind extracting it to a variable?. Can we add some tests to ReactDOMServerIntegration* suite instead? They will test all possible combinations and verify those match between client-only/server-only/hydration scenarios.. Is it strings and objects specifically that are allowed? What if __html is a number, for example?\nWhat did React 15 do in this case? Can you point to similar logic there so we can compare the behavior?. Isn't export * going to be sufficient to cover default too?. Let's name it, const React = { ... } and then export default React.. This only affects the profiling bundle, right?\nAt first I was a bit worried we'd do this in production mode too, but now I realized that we seemingly don't. Then it should be fine.\nIn general we try to avoid any extra overhead based on DevTools presence (i.e. until we actually connect). But a bit of overhead in profiling bundle specifically (and not in production) seems okay to me.. Typo. Typo. Can you explain more about why this is completely unobservable? Is it because it's only used for the UI, and not reported by the Profiler component? Should it be reported by Profiler component somehow?. Haha okay, TIL.. My main concern is with using _currentFiber() here which isn't a public API. Is there any way we could write these tests without reaching into the fiber data structure? If not (and if that's how DevTools works anyways) then it's okay.. DevTools wouldn't be using _currentFiber() but yeah, this seems like the easiest way without bringing the backend itself into this repo. I assume you're reading treeBaseTime from the Fiber in DevTools\u2014can't check because I'm not sure where the code is.. Wouldn't make the first movementX equal to the current screen coordinate, instead of 0? I think 0 would be expected (because the cursor didn't \"jump\" from top left point).. >In that case we still want to throw because that counts as using children\nDo we? On the client we only fire the invariant with == null check so neither null nor undefined counts:\nhttps://github.com/facebook/react/blob/571a9208d5133e8737f565fe60b762d201f0d37c/src/renderers/dom/shared/ReactDOMComponent.js#L161-L164\nServer logic should be the same, shouldn't it? Or am I missing something?\nWe should have a test for this too I guess.. This looks a bit misleading, as if we\u2019re using its return value.\nLet\u2019s just keep undefined there explicitly and then warn later. . Kind of, but I don\u2019t see how this helps us in general. It\u2019s entry point so its type doesn\u2019t matter in the internal flow check. . Let\u2019s change this to \u201cUnknown\u201d? I know it\u2019s not consistent but I like that better . Let\u2019s rename it in the test so it\u2019s more obvious we have it in the stack. Like MyComponent . Side effects cannot be moved to gDSFP, it has to be pure. Let\u2019s revert this part for now? We can think about this message separately. Nit: We expect a single argument, let's keep that explicit? Even if we changed to many, the other if branch already assumes it's just one, so might as well do here for clarity. You can remove this comment (and a similar one below), it's already implied by the code.. Let's set these to non-zero values? Then the test won't be fooled e.g. by always returning screenX.. localSetTimeout is a variable name so it doesn't mean anything to somebody reading this. That said, I don't think we want an invariant at all.. Intentionally ignored?. I'm not very familiar with this code but I think it would be safer if we did this conditionally only when context._currentRenderer === rendererSigil.. Same. Put these behind DEV flag please?. Why does Flow pass if the whole thing might be uninitialized? Seems suspicious.. Let's move this into the last else clause instead?\nAlso let's make the check more concrete, e.g. type.hasOwnPropery('$$typeof').. Didn't want to spend the bytes.\nI think it actually used an invariant in the past, and Sebastian wanted to relax that to a warning.. Is this one (actualStartTime) intentionally still called \"time\"? Or would it be more consistent to rename it too?\nIf it's intentionally still \"time\", would you say \"time\" now always refers to timestamps and \"duration\" always means length? Or is it still different?. It's almost like this was the plan all along! \ud83d\ude01. What happens if it already has a style attribute that disagrees? What if you hide it first, but then it updates itself with block as the value? Or does sequencing guarantee hideInstance always runs last?. Does this simulate the Enzyme issue?. Can you verify this fixes the original issue just in case?. Technically this DEV block is a change, but we could never get here in PROD \u2014 if we did, the next line would crash.. This is too prescriptive. We don't actually know they called setState in constructor, or that they want to move it to cDM (setting it in constructor might be better in most cases).. Oops. Shouldn't happen, but I'll change it to test for array length instead. It's for exceptional case where we accidentally call getStackAddendum too late.. Yes, but then we need to get a reference to the frame. I could do it \u2014 it's just very confusing to think about what currentDebugStacks would mean.\nI guess my solution is also confusing. . No, currentDebugFrames is not the same thing as frames :-(\nThat's why this is so confusing. I rewrote and pushed a more explicit solution which doesn't try to hide that we have stacks of stacks of stacks. I hope that will clarify.. Let's add an fb.me link that either points to a gist or a warning page with a drop-in replacement code? People who rely on it might not understand what mockComponent was doing exactly.. This needs to be behind a duplicate check. Otherwise it might significantly spam console in tests.. It's assuming that once you're inside ReactDOMServer call, you're only going to make other ReactDOMServer calls (at most), but not, e.g., ReactDOMClient or ReactART calls. Because it's synchronous. I think it's a safe assumption in 99% cases. \nAll ReactDOMServer calls share the same implementation. Happy to talk through it via VC \u2014 I'm worried this is getting difficult to explain like this.. In the worst case you'll end up with no stacks. Which is exactly what's happening today with any nesting. :-). Can we combine these two files into IntegrationSpecialTypes or something? We don't expect to add many more tests to it, and each test file has some overhead.. One fork down.. Two forks down.\n. Protect against passing Fibers by habit.. If you feel strongly about keeping this, I can add an optional props argument. I'm not sure this is important. I like that having a type is sufficient (which lets us use this utility in SSR, for example).. I didn't put it on the ReactDebugCurrentFrame object because I don't want it to be accessible by the renderers.. It provided a slightly more detailed entry in the component stack for Profiler components. I don't think it's very important, and I think we can drop this.. It doesn't exist outside of DEV, which is true in other \"hook\" files too. Other \"hook\" files don't have DEV blocks (they just assume they're called only in DEV) so I didn't put the condition there. Since this file already had a condition, I put it conditionally.. We could put Object.assign there directly and assume it'll be compiled to an assign import but that would obscure the reason we have this code in the first place (which is to attach this specific npm dependency). In other words:\n\nWe compile Object.assign calls to assign imports\nBut we also replace assign with React.__internals.assign in renderer bundles to avoid bundling assign twice for UMD builds\nSo we need to put assign on the React internals object\nWe could do that by using Object.assign.. which would fall back to assign... >why we don't also just use assign here instead of Object.assign \ud83d\ude04\n\nWe could, I just didn't see the point in explicitly using it in a situation where we normally wouldn't.. In other words \u2014 they're the same thing. The intention of the code is \"put this Node module onto an object\". So I'm using assign for the \"Node module\" part to express that intention, and use Object.assign for the \"put onto an object\" part because that's how we would express it in any other file. Otherwise you start thinking: \"okay, this file uses assign() from npm instead of Object.assign, maybe I need to do this in other files too..\"\n. Open to other suggestions, I don\u2019t really care either way. Feel free to change it to what\u2019s looks less confusing.\nThis isn\u2019t new code. . This should probably stay pinned.. Does this work better than just () => null?\nMy impression is we only use this feature in DevTools to highlight components from DOM nodes. But ART's host instances are not DOM nodes. So we'd never make use of this.\nAm I wrong? Is there any situation where ART actually does use DOM nodes (e.g. SVG mode?) In that case, can we make this code work by actually finding the fiber for an SVG node?. Since I added ability to return an error from a fork config, I need to ensure I don\u2019t run require.resolve on that error \ud83d\ude42\nOn the other hand I can\u2019t throw it early either because I don\u2019t know if that module will get used or not. . No, I meant to put it outside (just like we do in other effect traversal). It doesn't really give us anything to reset it on every iteration if we're going to set it again at the very beginning of every iteration.. Actually sorry, I misunderstood your question (I thought you meant a different line).\nBut here, too, it was intentional, to match what we do in the other effect traversal. I put it inside the loop because I want to set the current fiber to the current effect as we iterate through effects. Putting it outside would defeat the purpose. Each effect is a different fiber.. This seems wrong. \"false\" is not falsy.. I guess the behavior is right but the test title is confusing.. Nit: let's not read ownerDocument twice. Put it in a variable.. We don't use fbjs/lib/getActiveElement anymore, and have copied it in the repo. Let's tighten this up? Feel free to change getActiveElement as you see fit.. What exactly are we catching here? Is it defaultView access throwing? Or do we expect contentDocument to potentially be missing?. Yeah, it already had the grammar issue before. Will do. \"React element\" would be better here.\nAlso now that I think of it let's compare type.$$typeof === REACT_ELEMENT_TYPE explicitly. We don't actually \"own\" this convention. You can get REACT_ELEMENT_TYPE from existing ReactSymbols import in this file.. This is not a typo. It's the event name.. This code is here for debugging.. This code is here for future reference.. Sorry to be nickpicking -- could you make this a simple inline comment please? We're not using jsdoc in new code anymore and we'll probably delete the more useless ones. Putting it here because it fires for every host node (and gives me the type). No practical difference for existing tests that just tried to mount a span.. To make it jump out more . Just old copy pasta I noticed. We don't want to expose the fiber itself. This module is meant to work with different implementations too. For example server renderer sets its own ReactDebugCurrentFrame.getCurrentStack implementation that doesn't use Fibers internally.\nI was thinking something more like \njs\nReactDebugCurrentFrame.getCurrentStackFrames = ...\nwhich returns the object. Set it together with ReactDebugCurrentFrame.getCurrentStack. Later we'll remove ReactDebugCurrentFrame.getCurrentStack.. We currently don\u2019t. Last time we discussed this, we decided to try supporting React 16.0.0 in any 16.x renderer.\nIs this going to break?. It seems like once you have this, you should be able to rewrite getCurrentServerStackImpl on top of it and remove some of the duplication between them.. You can rewrite this on top of getCurrentFiberStackFramesInDev now. Nit: we tend to put DEV check in its own separate if block, and then nest another if (when necessary). Makes DEV conditions stand out more . Nit: \u201ca bit different message\u201d would become meaningless after merging this PR. Let\u2019s ensure any comments are helpful to future readers. . Why? It's never going to work correctly, and making it an invariant is consistent with what ReactDOM.render always did.. It's also (hopefully) not a hot code path.. Is size the only rationale for it being a warning?\nI tend to prefer errors when, if the condition doesn't pass, the code would later error anyway with a more obscure message.  This prevents confusing stack traces in production crash reports. Instead of 5 different potential places where it fails later with errors like Cannot call toLowerCase of undefined, we only get one with its own error code.\nI think the upside of having a clear error code here > the downside of adding five bytes.. When is it impossible to make a DEV-only warning, and we have to use an invariant? Are we only talking about things like preventing infinite loops?\nNot trolling \u2014 I'm just not sure I understand the decision procedure you're thinking of. Or do you mean we shouldn't add new invariants at all (which could also be plausible)?. >I don't understand your question\nRephrased: When should we use an invariant? What's the criteria by which we decide whether to use a warning or an invariant? \n\nfor things like this\u2013 where React will error in either case\n\nFor this specific case, it failed for me in a real app example, but didn't fail in Jest on a smaller example. So it's not consistent, and I wanted to ensure more consistency instead of letting the code continuing in a fragile state.\n. This is very vague. . Can you please describe this algorithm in words? What is it looking for in particular?\nSpecifically I wonder if you can avoid the need for nextNodeStack.. OK, I think I see what you're doing.\nYou're starting the search at the return fiber, and then looking for this fiber, counting how many host children there appear to be between them.\nI think you can still avoid nextNodeStack by using .return pointers instead where necessary. However, you'll need to remember to write to them every time you descend down. See for example propagateContextChange.. If a node is a host component, why do we need to go inside of it? I imagine we'd want to skip over it to search for the next one. Otherwise we'd count its children (which we shouldn't). Am I wrong?. Typo: selec. I still don't understand how this works. Can you explain?\ninstance in your code is not going to be a DOM node. It's going to be an ART object. So your getClosestInstanceFromNode implementation will give an ART object to DevTools. DevTools doesn't know what to do with those \u2014 it expects DOM nodes.\nCan you explain how this implementation is useful?. >If return pointers are only used during one traversal and their previous state is not relied upon, I can rewrite to use them instead of the stack.\nYeah, we rely on this pretty much everywhere.\n\nSaid that, this traversal is not performance-critical as it happens only in development mode and only when hydration failed.\n\nAgree but would prefer consistency since that's how we traverse elsewhere.. Why not?. Why shouldn\u2019t we couldn\u2019t them? \nI think we should count them regardless of whether they have children or not. We just shouldn\u2019t descend into them because their children have no effect on the index. \nThat said see my comment below. . In this context !! is redundant. You can drop it. . Please change the comment to the suggestion in the discussion thread . If I disable correspondingUseElement logic in getEventTarget.js this test still passes. Seems wrong.. This says \"falsy\" but the code checks for null and undefined. What should happen for ''? For 0? For false or true? Let's make sure code and comments agree.. I didn't really intend to test this part although I guess I could. I only wanted to ensure that we don't blow up the reconciler by rethrowing.. Added a check.. I guess setTimeout could also be buggy. Let's not think about this.. Probably just https://en.m.wikipedia.org/wiki/Priming_(psychology). It's a bit surprising this is the only place we use removeAttribute in this file.. Second one is a typo.\n. This condition seems unnecessary because we're in an else branch for if (value != null).. If I remove this line none of the tests seem to fail. Please make sure the tests cover all lines.. Nit: since we access props.type so much can you please read type in a variable early and use that. Let's put this line first? It'll probably be false more often.. No. Also there are other reasons why this doesn't work. Will look again.. What's the story behind this?\nWhy does window.hasOwnProperty('event') tell us whether it's writable?. \u201ca textarea\u201d. Let\u2019s change the test to have an owner?. This is a bit odd. Maybe we shouldn\u2019t treat it as reserved?. I don\u2019t know. You tell me what would happen :-). I think we had one but we cancelled the plan for automation. We can probably go on a different plan?. Since title case False doesn\u2019t have special meaning I don\u2019t think it\u2019s worth testing for. . Let\u2019s make value === 'false' the first condition. Since it\u2019s rare we won\u2019t have to check most other conditions.. Yeah. I see your point but I think it's unlikely enough to be written accidentally and we want to make the checks as cheap as possible. Strict comparison is better than extra toLowerCase call.. Can we throw here instead?. Here too.. Maybe add Although this works, it will not work as expected if you pass the string \"false\". to the true case.. Maybe add The browser will interpret it as a truthy value. to this case. To clarify why we're warning.. You could throw a frozen object though.. I guess it's uncommon enough that I can try/catch around it?. The part about passing ...args is intentional. It lets other tools read the stack separately.\nI'm only suggesting to map over them and coerce them to strings.. Sorry, that was an intentional change. See my collapsed comment below (silly GitHub). Nit: maybe stringArgs. I hate to nit on this, but do we do Canceled or Cancelled? (Failed) TC39 cancellation proposal used one l, so does .NET. Java uses two l.\nDOM has an API called cancelable so I think one \"l\" would be more consistent with JS/browser world. AFAIK one \"l\" is American spelling, two \"l\"s is British.. Comment nit: set, not array (?). Do we have any guarantees around what happens if one of these subscriber methods throws? Do we assume subscribers themselves are crash-free? (Which we could assume \u2014 but I think it's important that we communicate this explicitly, especially if a broken subscriber would bring down the product code too.)\nIf we assume subscribers are crash-free we could move try closer to callback. If we don't assume that, we should probably isolate failure in subscribers so that it doesn't prevent calling the callback?. As discussed let's make sure we're happy with the name before it becomes a public-visible dep. We'll need to manually test that UMD bundles of ReactDOM in profiling mode work with UMD builds of IT.. Can adding these later affect hidden class? I wonder if that or the number of fields itself could mess with some optimizations. Seems like it's important that we try to make the profiling build as close to prod characteristics as possible.. Related to my concerns in https://github.com/facebook/react/pull/13234#discussion_r209807981, I think we need to be very confident in user-level code to call it from this place in the scheduler. Since it's not inside the render phase or one of protected places in the commit phase, there's a risk that any error in it (and folks who want to use it are humans and may make mistakes) can mess up the scheduler state and cause infinite loops etc.\nOr we could wrap any user code call like this in a try/catch.. Will it break if I change the formula here but not in the other place it's used?. To be clear, what I'm concerned about is that if subscribers fail, we don't call the actual callback function, which from my understanding, would break product code (e.g. we wouldn't call the event handler implementation).. This is not equivalent.. Why do we have ssr error and ssr mismatch here but not in the other one? Can we fix SSR too?. Nit: this would swallow throw null.\nIn React, we solve this by having a wrapper function that toggles a boolean if an error was set.. DevTools won't be happy about this change. Renamed this from hasCaughtError to avoid clashing with the method name. . We can technically get rid of this object and just pass onError as context directly. Not sure if it looks too confusing.. Technically www already resets these but it felt a bit fragile so I'm repeating them here.. I reset these unconditionally before the call now.. Same, they're now reset unconditionally first.. I wanted it to really jump in front of you because I think it might be easy to miss that in this file console.error setup differs from our normal one. I don't feel strongly about this.. Didn't realize it was in scope lol.. It\u2019s easiest for me to leave this until next time I sync. I don\u2019t want to change the API and then whoever does the sync might forget about this change. . I also don\u2019t want to make it an extra argument to avoid having to mess with arguments when we forward the calls. . It\u2019s used in prod yeah. I can remove them. I don\u2019t expect them to stay here for more than a few weeks (when I do the next sync and replace this code). Since 16 we inject the version into DevTools so yeah, we can do this.. It's good when you don't have ssr warning. Just warning means everything is consistent between client and server.\nssr warning confusingly means \"client and server match in behavior except warnings\". So it's bad to have it.. Doesn't look good. If those are meant to be sharable then they should be in shared themselves. Like TypeOfWork.. Removing this still doesn't fail any tests.. Maybe just typeof maybeIterable !== 'object'?. You don't need this check now.. Isn't __esModule just a Babel thing? I don't think it's in the standard. So e.g. Node might not have it.. Why do we do this?. Why is this unnecessary now?. How old is this behavior?\nWould be nice to make this comment more specific than \"legacy purposes\".\nDo we want to change it?. We should make sure this doesn't break number/string comparisons.. How long has it been \"treated as a reserved property\"? If it's a few minors then we can treat this as a bug we're fixing.. If we ignore the differences in warnings, is there any difference in behavior we are taking about? If so, how long has the difference in behavior been there?. OK. My suggestion is: it's fine to change warnings even if old warning behavior was there for a few majors (but was wrong). It's fine to change actual production behavior if it was buggy and was only there for a few minors. Or if there were no legit use cases for relying on it.. Should have spotted this earlier. Sigh.. I think not \u2014 I think it was still overcounting actual updates (not entirely sure why). But it's better.. Can it even change if we bail out?. I'll push up a fix tho.. Can we do this instead\n``js\n// These are the few React props that we set as DOM properties\n// rather than attributes. These are all booleans.\n[\n  'checked',\n  // Note:option.selectedis not updated ifselect.multipleis\n  // disabled withremoveAttribute`. We have special logic for handling this.\n  'multiple',\n  'muted',\n  'selected',\n// NOTE: if you add a camelCased prop to this list,\n  // you'll need to set attributeName to name.toLowerCase()\n  // instead in the assignment below.\n].forEach(name => {\n  properties[name] = new PropertyInfoRecord(\n    name,\n    BOOLEAN,\n    true, // mustUseProperty\n    name, // attributeName\n    null, // attributeNamespace\n  );\n});\n``. Thetag` check was important here.\nThe code in getUnmaskedContext above says:\njs\n  const hasOwnContext = isContextProvider(workInProgress);\n  if (hasOwnContext) {\n    // If the fiber is a context provider itself, when we read its context\n    // we have already pushed its own child context on the stack. A context\n    // provider should not \"see\" its own child context. Therefore we read the\n    // previous (parent) context instead for a context provider.\n    return previousContext;\n  }\nHowever, for factory components we used to execute getUnmaskedContext before pushing own context on the stack (because we don't know own context yet). In fact we called it twice: once before calling the factory, and once after we know it's a factory component.\nThe first call used to be ignored because isContextProvider was \"unsure\" when given IndeterminateComponent and returned false. However now isContextProvider is more confident when IndeterminateComponent is a context provider. Breaking the assumption that getUnmaskedContext() isn't called with a context provider until after it's been pushed.. Fix in https://github.com/facebook/react/pull/13441. This is like type._reactResult._reactResult. Unintentional?. Sounds good. I couldn't find a name I'd be happy with. Which reflects how messed up this whole thing is.. I think it'll be hard to miss any changes because they broke so much in internal tests (e.g. enzyme). We're also already very intentional about changing these constants.\nIf we merge this, it'll be just a temporary concession. We still have to \"get our act together\" later. . I think the one that just happened seemed pretty intentional \ud83d\ude08 We should still fix this. If you feel strongly please feel free to send PR with a comment you'd find valuable. Maybe something like // Dependencies: *. But I'm also wary of making it seem like these are untouchable.. Yeah. Adding a rule right now.. While we\u2019re at it, can we add a message here so that we don\u2019t pass on any error?. What if you intentionally .dispatch() the same native event twice? e.g. in testing?. Also let's keep in mind that the end game is that we attach event listeners at the root rather than document. If that would also solve this problem maybe it's a better fix to focus on?. Well. I think in this case the original issue was https://github.com/facebook/react/issues/1254 which is called \"React shouldn't bind wheel or touch events to the document\". So that does sound to me as a specific instance of this more generic problem. :-). >I gave that a shot, but I wasn't able to prevent scroll jank. Attaching listeners locally was the only way that I could prevent it. I can do some more testing just to be sure, though.\nFor which events? Did you include wheel, scroll, and touch events?\n\nmaybe DOM bubbling/capture is simply sufficient.\n\nDoesn't implement portal bubbling.. Touch events seem essential to this.. https://reactjs.org/docs/portals.html#event-bubbling-through-portals. I just reused the same warning message we have in SSR. Seems to make more sense than the DOM nesting warning I tried to use before.. That's the real change here. All cases where behavior changed were warnings.. Just documenting existing behavior.. Already a warning.. This will avoid warnings for fbt.. This is not equivalent. Instead, it's like (event || 'unknown-event').type.. I agree read / write mismatch is confusing.. Do you want to remove it from the scheduler/noop too?. I think I used click at first and then forgot to change when I rewrote the test. What does the first part of this do?. My hypothesis is we never actually hit this.\nES6 class components always return undefined from isMounted and log a warning.\nRN host components don't have a method called isMounted().\nI guess a user could define their own isMounted() implementation but it wouldn't make sense to intentionally support this.. These checks all look very similar, is there a refactoring you can do to make the logic clearer?. not to break? \ud83d\ude04 . Is the plan to unpin this? If this is pinned then there is a high risk of duplication.. Truth hurts. These will hang from React secret exports in CJS too even though CJS ReactDOM doesn't use it, is that correct?\nIn that case I think maybe it's time to fork this file into the UMD and normal versions. Or \nmake a __UMD__ constant (might be simpler). It would be unfortunate to have all these names being unminifiable for an object that ends up being unused.. Not sure if this is correct but might be the reason.\n\n. Aaah I forgot it's measuring UMD. We still need this right?. This comment doesn\u2019t seem to make sense inside UMD conditionn. It would be nice to have some automatic check that verifies the list of exports matches the list of commonjs exports 1:1. (I understand you added a fixture but someone could add a method to CJS API, and forget to test it in fixture). A node script that imports all bundles after build and verifies their exports match up.\nOr a Jest test if you can figure out a way to import the entry point shim. . Nit: maybe APIs \ud83d\ude04 (I don't care really). Might be a bit clearer if the \"source of truth\" API is passed as first argument. Then you can remove the let i = 1 special case. Also errors would be better if you do\njs\nexpect(apis[i]).toEqual(nodeAPI);\nbecause it's UMD/Secrets API that are actual and the original source code that is expected.. Might be a bit clearer if the \"source of truth\" API is passed as first argument. Then you can remove the let i = 1 special case. Also errors would be better if you do\njs\nexpect(apis[i]).toEqual(nodeAPI);\nbecause it's UMD/Secrets API that are actual and the original source code that is expected.. Please revert changes to this file. Sorry, it's not currently documented, but you can just always revert it.. Technically this was used by TapEventPlugin. But it's already broken with 16.4 and has been deprecated: https://github.com/zilverline/react-tap-event-plugin#deprecated. So this doesn't matter in practice.\nI'll check what's up with our www version but last time I looked at it, there were 5 or so callsites left.. I tried to make this just , but Prettier kept moving my comment so I left it in.. Don't need this because we removed injection.. I could've made the whole thing an array, but our FB bundle puts some additional exports here. We'll need to come back to them and clean them up too.. \"faster\"? :-)\nI think this clarification taken out of context is more confusing than it's worth.. js\nmodule.exports = function sizes(. Not sure how many of these methods are typed but we can try. . That still wouldn\u2019t help if two methods have the same signature but you mess up their order. So I\u2019m not sure it\u2019s that helpful. And if you need to be careful anyway then maybe it\u2019s okay to keep as is. . As discussed, I tried this but some of those are untyped, and it seemed like more work than it's worth. You don't need this. We check that every test doesn't warn by default. So you can remove it.. Is there anything in jsdom you can monkeypatch for this specific test to reproduce IE behavior? I agree it's kind of useless like this.. How confident are you in this? What if ; is part of an image URL or something?. I guess it's fine since we normalize it on both sides. So at most you'll miss some legitimate warnings, but you shouldn't get warnings about valid code. Is that accurate?\nYour suggestion to gate this by document.documentMode sounds good to me too.. Sketchy. :/ If we can't figure out how to make Yarn work with this, let's just remove dependencies completely, and then make this cp -r ../../../../build/node_modules/* ./node_modules/?. Just wanna confirm this was intentional.. Need to remove this flag?. If we don't reference it in CJS then it makes sense to me.. If it embeds scheduler methods it means it always imports them regardless. So this is bad by itself (we don't expect them to be in CJS builds). Are they not getting tree shaken due to init time side effects? This might mean our approach with __UMD__ is not enough and we actually need to fork that file.. This should be in try-finally. Even if test fails you want to delete it to avoid breaking other tests. Extract this to a top level variable like canDiffHydratedStyleForWarning. In general it's fine if we don't test the full message. interaction is now part of schedule. This is used before declaration. Hence the bugs. . https://github.com/facebook/react/pull/13606. Naming of these options is confusing. It basically means \"still allow to rely on function hoisting, and don't complain about variables unless they are in the same scope\".. This would be bundler specific and I\u2019m not sure they all use the \u201calias\u201d wording.\nAnother thing to consider is that the person seeing this might be unaware that schedule package exists or what it is.\nHow about \nIt is not supported to run the profiling version of a renderer (for example, `react-dom/profiling`) without also replacing the `schedule/tracking` module with `schedule/tracking-profiling`. Your bundler might have a setting for aliasing both modules. Learn more at http://fb.me/react-profiling\nThe link points to a gist explaining how to do it in webpack. Later we change it to point to a blog post.. Maybe, but then we almost never change the config so I don't think it's that helpful. Can always blame to a PR if necessary.. Nit: does this line need to start with capital letter? Made reading the sentence a bit confusing.. There are more moving parts here than I'd like.\nI'd like to use the same solution for all cases. Can we do that somehow?\nThe easiest one might just be to switch on args length and explicitly pass them all down.. Fixed amount of args is okay. We have that in invariant.. What's the guideline for when it's \"safe\" to call it? How do we know it's okay here?. Should have a comment explaining why then.. Have you checked whether it does? ReactGenericBatching is only accessible in this repository.. This comment should move above btw.. Let\u2019s assert the number of arguments isn\u2019t higher than supported here?. If 8 is current maximum the let\u2019s check we have at most 8. . Try rebasing to solve the CI issue. Can this just be === 'function'?. You're doing props.checked access twice now. Let's avoid changes like this.. Seems like previous we didn't have to call this earlier than next condition. What changed? Let's avoid adding more eager computation.. Not really necessary. Just left here for exhaustiveness of switch. It should never happen.. This used to compare toString(node._wrapperState.initialValue) !== node.value.\nBut now it compares node._wrapperState.initialValue !== node.value.\nIs that change safe?. Why this change? Did we check every toString callsite to ensure it doesn't break them?. Needs a regression test?. My priority here is that the old code path stays as similar as it can be. So that we can merge this without worrying.. Can we make this more realistic? Such as a real pass through wrapper. Otherwise intent is not clear. . Please add period to the sentence. . Yes, let's make it as plain as possible.. Since performance.now() calls have a cost, I wonder if we could avoid recalculating it while we have expired work (since if 100 things expired checking the time is unnecessary \u2014 they can't \"unexpire\"). For example by having a nested loop. You read the time in the outer loop, and compare to it in the inner loop. Once you exit the inner loop, you read the time again. If there's nothing new that expired then we exit.. I wonder if this could leave a small buffer as a heuristic. So we don't go over by a few ms from last iteration every time.. I'd like to avoid using the word \"priority\" in this file if we can since mixing that with timeouts changes the meaning of \"higher\" and \"lower\".\ne.g.\njs\n// The new callback times out before this one\nThat would also map nicely to the sorted order. Same re:wording. Maybe window.__scheduleMock or something more obscure? . maybe let's name the arguments?. I think this means a newer React wouldn't work with an older ReactDOM, or vice versa. Since it's scoped to UMDs only I think that's fine and I wouldn't worry about going to extra lengths to make this work for mismatching versions.. Needs rebase? Name changed.. Both this and symbol export rename would be a breaking change technically. Unfortunately we forgot the unstable prefix here. Let\u2019s keep both and add a deprecation warning for isAsyncMode. . This should be inside if (__DEV__). Maybe remove mentions of Jest? If it\u2019s meant to be generic. . I wouldn't say this is a supported way to use React. There shouldn't be side effects in the rendering phase.\nCan you come up with a repro case that is more valid? e.g. maybe you can reproduce this with a class component when calling render and unmountComponentAtNode inside componentDidMount or another lifecycle?. For Flow I think. hmm wait this doesn't make sense. I dunno.. You can just do expect(typeof ...).toBe('function'). Not that it matters.. Would make more sense than duplicating to me.. I think getters don't work on www, can you rewrite this as Object.defineProperty calls?\nWorth checking tho. I don't know if all of these are a bug. At the very least [2000, undefined] seems to demonstrate a bug to me. Others might fail for another (maybe legit?) reason although I don't see it immediately.. Maybe.. I figured this one would be common and might be annoying to see it everywhere. Or maybe not?. No, it just discards the in-progress segment.. sure. I guess it could be helpful to see that a pure component re-rendered. This comment confuses me. It talks about DEV but is in PROD code path?. \"in a future major release\". Can you explain why we read it differently in DEV and PROD? It would help to have a written explanation of DEV/PROD matrix for Consumer/Context object and how behavior changes for each.. Is it better to have consumer proxy to context, or the other way around? Why?. There's none. I just meant if you could write up of what's supposed to change.\n\ndev when using consumer: (before) and (after)\ndev when using context: (before) and (after)\nprod when using consumer: (before) and (after)\nprod when using context: (before) and (after)\n\nThat would be easier for me to review since I can focus on intent separately from code.. unnecessary. Can this just be context._context? To avoid extra reads (even in DEV).. This can also be just context._context.. This message might confuse people a little bit. Maybe make it more visual?\nRendering <Context> directly is not supported and will be removed in a future major release. Did you mean to render <Context.Consumer> instead?. Why no stack? This is exactly the kind of warning where I think the stack would be highly valuable.. What if you render <Context.Consumer.Consumer>? Seems like that should also warn because it also relies on objects being shared.\nWhich makes me think: should the warning move into these getters instead? Fire for first getter accessed, ignore the rest. This could also nicely let us warn once per context type.. _calculateChangedBits and unstable_read never change, can we directly point to the original without getters for them?. It's assigned right after, no? This is undefined.. Now that I think of it Context.Consumer.unstable_read() should also warn.. Let's make <Context.Consumer.Provider> warn as well.. Nit: I'd probably call this Consumer. Is host environment throws, does it mean we don't clean up the stack due to pops being moved after?. \"a StrictMode children\" sounds odd, maybe drop \"a\"?. We know that context itself is not a \"new\" Consumer because in that case _context wouldn't be undefined. So it's safe to read context.Consumer.. There's a lot of setup cost for initializing these test modules. Can we put this together with some other tests since there's only a few of test cases here?. But https://github.com/facebook/react/pull/13822?. \u201clifecycle methods\u201d?. Let\u2019s hoist CurrentOwner? No need to access it many times. . Code size between modes shouldn't be a problem. One function will be DCE'd in persistent, another in mutative.. Kinda weird to treat undefined and null differently, no? Should we check for hasOwnProperty instead?. Also what happens if you sometimes specify it and sometimes don't? Is that a legit or broken pattern? Does it need a warning, like controlled<->uncontrolled \"flapping\" input?. Uh?. Yay DevTools. Should be 'Memo'. Seems like this code already changed.\n. oops. Comment pls?. So why do we still need this check? I thought the separate tag is supposed to address it.. Please revert? We don't change this file manually.. createCache isn't unstable but createResource is? Why?. ok just wanted to make sure it's intentional\n. Ran into bugs in the first implementation by trying it on the product code.. It's plausible one of returned values would be a Hook itself in the future.. Yes, it was because Flow has issues with symlinks on Windows.. That said we didn't follow it consistently either.. Nit: I kinda perfer if (__DEV__) to be a separate line for easier visual scannning. Maybe add \"but you can call an async function without waiting for it\" or something. Or I expect we'll keep getting issues asking for this.. This was also weird. Does this have default props resolved?. We should just delete it and stop generating it on local builds :P . And shallow one!. I can move to shared and reuse from ReactElement too. Couldn\u2019t find a nice existing place. . So where do you want it? I guess I can create a file in the reconciler package but I don\u2019t see why it deserves that when conceptually it\u2019s related to our design for lazy. . Thanks. I pushed another commit that clarifies which parts of the fix are DEV-only.. This is autogenerated and corresponds to existing error messages in past versions. Please revert changes to this file.. sure. These (and below) are wrong because they're written to be copied into RN repo.. I kept it in LazyComponent for now because I don't want to duplicate it in reconciler bundle twice.. >especially because it's not dev only\nIt is though. I think it would get DCE\u2019d because we never read it outside DEV. The only reason I write to it outside a flag is just because it seems awkward to do extra wrapping because of scoping.. Pushed another commit that makes it clearer that part is DEV-only too. I'll look at your suggestion tomorrow/. So this was the thing that caused us to \"forget\" about deletions?. Why would it be better?. Would it be simpler if instead of deleting the fallback we kept it hidden? Although that seems bad from memory perspective.. Umm.. Writer? Streamer? You know like cool kids on YouTube.. Let\u2019s add unstable to the entry point . Also fizz.node.js?. Set private to true to not block the sync?. Or just Server. . I think we do that for packages that are ready to be ESM. But here the actual output will be a function anyway so it doesn\u2019t matter. I guess could work either way. . I\u2019d add to the file. Because npm entry point (see npm folder) directly points the bundle. The entry point above (which you redirect) only used by Jest. So technically this change isn\u2019t even necessary right now. But would be less confusing. . For consistency you can make npm/fizz also do a re export of ./fizz.node. Like npm/server does. . Ah yes I mean the release . Sure. We also never got these things quite right from first try so I wouldn\u2019t expect to do it now. . Let's change to your suggestion. . Maybe add \"These settings are overridden below for some files\".. I wasn't sure what's expected here. We'll need to fill those out before merging.. Hmm. Right. I wasn't sure what's the correct mental model but intersecting makes sense.. Do we have a better understanding of this? \"Causes tests to fail\" doesn't say anything about the intent and whether those tests should fail or if there's some other mistake.\nThis feels dangerous to me if we don't understand it. How do you know clearing firstEffect is safe if nextEffect is unsafe? Maybe we just accidentally hit some cases in our tests but not others.. In general I'd prefer that we don't use vague wording like \"causes tests to fail\" in the comments. Either we know why it fails and explain the conceptual reason. Or we don't know, and should understand before merging.. What proxying?. Nit: reorder to match the order above? So it's easier to see they're the same.. Three linear searches here seem suspicious, is this faster with long inputs too?. Weren't you saying it's also slow in some other part of the codebase today? :-). Right but you're changing code from always doing one walkthrough to doing at least three of them. Even if the first ones are highly optimized. That's my cocnern.. Oh. Does this mean react-dom/server is not compatible with react@16.0.0? We've tried to relax this requirement during 16.x.x release line. If this doesn't work we need to start bumping peer deps again.. I don\u2019t know what bugs. Bugs with incorrect props?. The fix is simple enough I did it anyway. We should relax peer deps back imo.. Why type tests?. We don't expect it to ever be null in dev. Can assert somehow?. Hmm to be clear I don't think it's great to expose ConcurrentMode = null either.. Meh. This seems too complicated. Either would have to always re-create them, or cache them somewhere. I think shadowing is reasonable, no?. Makes sense. I\u2019ll make it respect whichever exists then, and warn if they both exist. . I don't really have an opinion on this but it's nice to show it doesn't have to be inside.. This should only be enabled for class components.. This is the legacy context object. It has no relation to the new context API you're implementing.. I figured it's bad regardless but can change. Not the common case though? I'm assuming defaultProps is not super common by itself, and especially when wrapped.. yes. fixed. Maybe you can add a comment about this? I was just puzzled over this because I forgot.. Let's combine.. What is this?. What's in it? Sorry if I missed it somewhere. Do we include it in all packages?. yea. Probably copypasta too.. === null pls?. Maybe Seb wanted it to be slower. Bad bad findDOMNode. . This is a hot path so I don't think we can afford to try-catch here.. Heads up to @bvaughn in case DevTools reads this . Typo: \"custom hooks\". No longer called useInspect. What does this function do exactly? I struggle to understand just from reading the code \u2014 maybe because of filter with a mutation and recursion inside. Not saying it needs to be changed but a brief comment about what it does to the tree would help.. Should we also have a test for useDebugValue on top level of component? Outside a Hook. . Also should we add tests for updates? To verify inspectHooksOfFiber can find latest version. (In case it matters \u2014 I don't understand this enough to tell yet.)\nAh nvm, I see you pass current fiber explicitly.. This comment is no longer relevant \u2014 deduplication refers to warnings. Instead there should be a justification for DEV-only invariant here.. I think grammar gets a bit clunky. It's almost a run-on sentence.. \"This will lead to a mismatch between the initial, non-hydrated UI, and the intended UI. If possible, replace useLayoutEffect with useEffect which doesn't block the first paint. However, if this effect must run before the user sees anything, you can change this component to only render on the client. To learn more, see https://fb.me/react-warning-server-uselayouteffect\". Yes definitely, and we should restore the old one back right after. . I think the test passes without these calls. Memo doesn't call \"prepare to use hooks\" so we're not in an area where there's a current fiber. You should be able to just remove them.. Since we don't need pauseHooks elsewhere this can become local isInUseMemo = true.. I don't think this will be relevant to shallow.. Why is this top level rather than inside useMemo?. Same q.. This comment is unnecessary, the line below says the same thing.. Same. Declaring variables pointing to shared objects has no effect on GC \u2014 I assume you mean the stack? I said it's a hypothetical concern but I'm not actually sure it matters and I think local function variable is fine.. Well, having two checks is likely going to be more expensive than having one check, no matter what you do.. To match https://github.com/facebook/react/pull/14594, let's call them deps (not inputs) and make sure we use null rather than [nextCreate] in all cases. (That's what #14594 was about.). I think that's just an omission.. Nit: I would replace a comment structure like\njs\n    currentlyRenderingComponent = null;\n    // now, it'll throw if you try to call a hook inside the reducer\n    newState = reducer(newState, action);\n    // restore the current component\n    currentlyRenderingComponent = cachedCurrentlyRenderingComponent;\nwith something like\njs\n    // Temporarily clear to forbid calling Hooks.\n    currentlyRenderingComponent = null;\n    newState = reducer(newState, action);\n    currentlyRenderingComponent = cachedCurrentlyRenderingComponent;\nThe pattern of replacing something and then setting again is very common in the codebase so we don't need to over-explain it \u2014 just enough to hint at the purpose when we clear.. Nit: Maybe just \"fiber\" everywhere? It's local so doesn't need too much introducing.. Nit: just copy paste it. If you want to ensure everything still works, worth asserting the output is legit.. Nit: we accidentally lost this line. \"created by createRoot\" sounded a bit tautological but I don't know if manage is better.\nContainer also wasn't technically \"created\" by createRoot. createRoot created the root but it's the container DOM node that we've previously passed to the other API. Not the root.. I went with \"passed to\". It also helps to avoid newlines in between so that the starting and ending line of replacement are as close to each other as possible.. My primary goal was to detect that a container previously passed to createRoot is then passed to unmountComponentAtNode. I don't think I can do this without some kind of a marker on the new container.\nI can't check its first child because createRoot doesn't clear children (and so could mount at arbitrary point). Scanning all children seems not great. I don't know of another way to detect that a DOM element is a new-style root.. This one looks stray? Where is this one being cleared?\nI would expect a pair around the reducer(newState, action); call two lines above instead.. Let's move this a line down and give it the usual comment.. Let's give it a comment for consistency.. For sure.. Could've been === 3 but I figured I don't want to punish users for our bugs.. But isn't that used by ReactDOM.render too? Since it's expressed via createRoot internally.. Want to wrap the whole body in DEV just to make the purpose clear?. Both of these statements should be DEV-only?. Seems like maybe we could avoid re-allocating currentHookMatches and just do .length = 0 here.. Why not in DEV?. We use FlowFixMe for bugs in Flow \u2014 I think this just needs to be conversion via any. (foo: any): desiredtype. For things like this it's nice to declare two types, Hook and HookDev. Then when you need a DEV-only field, do ((hook: any): HookDev).something = ...\nExample of this pattern: https://github.com/facebook/react/blob/8c1614a2fdbb841f65ebf403d7ece3a518c6a984/packages/react-dom/src/server/ReactPartialRenderer.js#L697-L699. You could use a single array with even/odd values.. Aaaah. That's why it had the loading state. Thanks.. This is still needed because we read thenable from lazyComponent._result while it's pending. If we keep the assignment, it will overwrite sync thenables. But if we remove it at all, we will throw null instead of thenable. This fixes both cases.. We could also do the same for failure. But doesn't seem worth the extra code to me. Could be a recursive call but then there's more risk of messing it up and going into a stack overflow. Meh.. I think we're talking about two different cases here.\n\n\nDetecting DOM container that's previously been used by ReactDOM.render. This is easy. That's what _reactRootContainer gives us.\n\n\nDetecting DOM container that's previously been used by ReactDOM.createRoot. I don't see a way to do this currently. As you said, \"new roots don't need the expando\". That's why I couldn't figure out how to detect them, and added a new DEV field.\n\n\nI need both checks. Not just one way around. In fact (2) is primary motivation for this PR \u2014 since Royi was passing createRoot() root to unmountComponentAtNode(). So it's new root that I needed to detect inside an old API.. > I suppose you're trying to distinguish between an empty DOM container that was never rendered by anything, and a DOM container that was rendered by createRoot, so you can provide a more helpful message.\nYep \ud83d\udc4d . (Note: callback is handled by previous if-clause so we don't need to check for that). Why edge casey? Does this happen on every mismatch?. The easiest thing we could do is dedupe by message. Keep a DEV-only set of diffs where you emit the warning. Don't emit the same diff twice.. Nit: we try to leave if (__DEV__) as its own condition for it to jump out \u2014 and nest ifs. Nit: for Fibers etc we use explicit null comparisons. Same nit. Nit: we try to avoid features that generated Babel output with helpers (even in DEV). Let's use apply?. I'd write these as switch so that the 1:1 correspondence is clear, and also so that we can (type) check if is exhaustive, HookType -> string. Nit: this is a bit hidden away. Let's read it very early so it's clearly visible this function assumes the variable is set. . Let's deduplicate the warning here.. Not saying this is critical but I'm also not sure how this will add complexity.. What does this do and why?. Another pattern we\u2019ve used is conditionally defining it but that\u2019s annoying for Flow. The dev body seems better. . You could call it warnedAboutMismatchForFibers to clarify the purpose . We warn anyway so maybe it isn't worth it?. This won't minify the name. Theoretically \u2014 could later make a smart compiler insert them automatically.. I suppose in this case the trace would be the stack of the warning itself?. The diff confused git. This is not a new test.\nAll I did is move the useContext() test with bits into readContext() section below.. This is a new test.. This is existing test which I made use readContext instead.. This test just moved below in the diff.. This is the actual change.. It feels wrong to have any logic concerning the DOM (even checks) in the reconciler. It\u2019s also why the warning false positives for the test renderer.\nWe should somehow make it specific to ReactDOM I think. . I then we should make it return result of calling batched updates (which by itself passes the callback retvalue).\nThis lets you write \njs\nconst inst = act(() => ReactDOM.render(...)))\nwithout awkward separate declaration. . ReactFiberHooks isn\u2019t any better. It\u2019s still in the reconciler. \nI meant to add a host config method that renderers can implement. Look at how server hydration warnings are done. . We'll need to remember to update the wording, e.g. \"UI\" not \"ui\", and also it's not clear where to import \"act\" from. It's also not clear what \"unexpected UI in testing\" means.. Nit: Capital Promise. Also probably you mean \"it does not return a Promise\".. Missing period at the end of the sentence.\nAlso maybe \"Putting asynchronous logic inside act() is not yet supported\".. I think it's the other way around. If we don't make it return a thenable now, people can write await act() without realizing they're awaiting undefined. Then making it actually return a Promise would be a breaking change.\nBy warning on await now we're effectively enforcing that you don't depend on what it returns. Therefore we can later make it actually return a Promise in some cases.. This link doesn\u2019t work. Needs to be an actual link. \nAlso technically not test renderer but test utils. See past Changelogs.  \nOr I guess there should be two entries because there are two new APIs. One in test renderer section and one in test utils.   . Can you think of a case where this matters? I thought we always batched updates during passive effects. . Was it also called context in some patch release?. Can you write the loop inline with minimal work it needs to do? For example reading previous value seems unnecessary except for the last one. This would also avoid the overloading you had to add to popProvider.. Why is this change correct? It disagrees with what the comment inside says (\"This is a render phase update\"). What was it supposed to mean? Why was it changed?. Why would they not? . Yeah setState should trigger a render.. Is this newline necessary? I thought stack starts with a newline.. What about the test renderer?. We try to avoid a && ..., if you want to check !== null && !== undefined let's do that instead.. Is this the only observable difference? Can you rewrite this test to check render count rather than whether props are referentially equal? Why does this matter at all?. Can you change the test to rely on props.something rather than props itself? Relying on referential identity of props seems a bit like assuming too much to me. This section is messy. I'll extract a function in a refactor before merging.. Lol I don't remember writing this\n. When you have your own Hooks with deps like useMyCustomEffect that you want to check. I'm open to removing this option (it was in first @calebmer's draft) but also seems like it isn't hard to support.. Oh I guess it's from Caleb's old code. Not sure I understand what you're saying.\nYou can see the code causing this in tests, e.g.:\nhttps://github.com/facebook/react/blob/0c722bb0d9d2e2256b0cd29398b3da96f5d20752/packages/eslint-plugin-react-hooks/tests/ESLintRuleReactiveDeps-test.js#L1306-L1315\nPassing [ref.current] in deps is almost always a mistake (which leads to rather gnarly bugs) because it's mutated outside the render phase. So during render it will always be \"one step behind\".\nJust like render result, deps should only depend on props/state/globals \u2014 not mutable values.. Couldn't resist. One simple compromise would be to only add at the end by default, but alphabetize if the current array is empty.. Actually we could alphabetize if existing list is alphabetized. \ud83d\ude0f. Can you give me a specific example?. This is the important part of the fix. The rest isn't.. I could include the name but this point to a specific place so I figured it's not super important. Could add it tho.. Please post both of these in https://github.com/facebook/react/issues/14920, with the guidelines I mentioned. Thanks.. TypeError isn't the main problem (easy to work around). A bigger problem is that you'll always keep getting the previous ref value since it's being read too early. The challenge is to explain this without freaking people out about how \"complex\" it is.. Oops, I misread. This is a different warning from the one I was thinking about. In this case the problem is that you're reading the next ref value when you meant to access the previous one.. Sounds reasonable.. Yeah. (This was already the case before this PR btw.). Mind keeping these?. >most people who use timers are going to use the fake timers, anyway.\nI don't believe this to be the case in open source. I've mostly seen people being wary of mocking timers for different reasons (often emotional ones like \"doesn't feel right\") and we need to meet them where they are.. This function just moved into the closure. It's the same implementation with a slightly different argument.. props is OK as an escape hatch when you just want the rule to shut up. It's still stable if you only set state, for example. Better than nothing.. You're welcome to send a PR. :-) There are more worrying things I'm currently focused on than this particular message.. This seems like it would be rather churny given it was prominent in the blog post and others already integrated it into wrapper libraries (like react-testing-library). The bigger problem is people would have to convert all their React tests to be async, right? That's not always ideal.\nBtw speaking of which, should we reach out to testing libraries to ask them to proxy the returned value?. I think it's a reasonable compromise to use async act in docs and blog posts but not warn for existing usage. People who discover issues or care will learn to convert to async, and eventually the knowledge will propagate.. Showed it to people and they were confused seeing the same variable name because it wasn't obvious it's being shadowed. This explanation clicked tho.. I guess I'm open to other changes, just want to avoid the shadowing. If people think this is confusing we can brainstorm more options.. This will crash outside of Node right? There's no global elsewhere. Not sure if people run test renderer in the browser but they might.. If you're just trying to appease flow, add a suppression. These types aren't used anywhere anyway.. \"a component\" \u2014 do you think people will assume divs aren't component?. I think ideally we'd special case values that are in scope in this message. . I thought maybe it's worth reporting at both. But I want to report it here because you usually should start fixing it here. (Such as by either cutting it to paste later \u2014 outside component or inside effect, or by wrapping in useCallback.) I'm worried that reporting at the dependency site will make people think they're supposed to remove it from the array and silence the rule.. Can you dedupe these? Can get pretty noisy if you render a bunch of them.. It's really easy to miss the difference between itRenders and itRejects in this suite. It took me a while to notice it. Maybe rename to something like itRejectsDangerousInput?. the metaprogramming intensifies. You're missing @flow on top. This isn't guaranteed to be a string (although I guess .test still works).\nMight be worth adding tests for <a href={{ toString() { ... } }}>.. Would be nice if accidentally adding it back here would error or warn in dev. At least for our tests.. If someone accidentally adds g to this it would be pretty bad. Not that I actively expect it to happen but it would be nice to have a test that would fail if you recovered from the error and then tried it again.. Especially javascript:void(0) seems like it's still pretty common because it's copy pasted from old samples etc. Is it dangerous to whitelist that one? Is it a vector by itself?. While we're at it, can we just say \"React Error\"? Is that a breaking change? \ud83d\ude04 . While we're here, can we make them actual numbers?. Can we avoid null | boolean? I imagine this would cause deopts.\nFor example, it could be an enum (0, 1, 2).. To avoid checking every plugin every time, can we have two lists of plugins, and switch early depending on the event?. What does \"legacy\" really mean here? That it can't handle passive events? Some other constraints?. This changes behavior from isLegacy effectively being true (because it didn't exist) to false by default. Are we sure we have no internal callsites calling this? Are they unaffected?. Can you make this if/else with two concrete names instead of access through a string?. Can you explain more about why we listen for both? Sorry I'm not quite following.. So which ones are not legacy? Are any?. Per our discussion, it seems like these code paths will never \"want\" to get two listeners attached/invoked. So instead of branching deeply and passing an argument through, let's fork the innermost implementation and call the fork from the new code when we want to. That will also likely let us DCE more based on a feature flag.. Not sure I like that we overload the meaning of this function (which was intentionally made for DOM validation) with also validation this new path. IMO this makes it a bit confusing. I'd prefer if event validation logic was completely separate.. Same comment as above. This has a very specific meaning in DOM. I think this code looks like it tries to do minimal changes, but that makes existing logic more confusing. Instead let's separate that logic.. What are valid values of this string? Should be an enum? Also, do we use strings in some places and symbols in others? Why?. I don't think we care that TestUtils work in IE9.. I guess I got confused because in another place, what used to always be a string became string | symbol. If we can polyfill it easily (and the polyfill lives outside production code path) then it seems ok. Otherwise \u2014 I'm not sure it's reasonable that everyone using ReactDOM in prod pays the cost for the hypothetical users who run TestUtils in IE9.. Why?. This codepath is for classes so should be ok. In fact it should probably use dot access since that's what we do in the real one.. Technically this can fire in RN too, so the message should probably say \"of React and the renderer (such as React DOM)\". Maybe \"for tips about how to debug and fix this problem\". To call more attention to the link.. In the React docs it's more acceptable because React docs in generally use DOM for examples. But seeing \"React DOM\" in your native console is weird.. What if context value actually is undefined?. Oh right.. Nit: addToErrorMap. Can we make it throw ReactErrorProd(ERR_CODE, adj, noun);? Then wouldn't need [] in minified output on every callsite.. Seems very unlikely to happen . Nope. Agree let\u2019s omit it. . Arrays are pretty rare as export values so I don't think it's worth handling.. Do you want to start this at 0.1.0 instead?. Ah good catch. ",
    "protron": "Error should be thrown only when all these are false. So is not null (because nulls are ok), is not a string (because strings are ok), and is not an instance of URI (becase URIs are ok).\n. Done. I had forgotten about the 80 chars rule. Thank you.\n. ",
    "eins78": "@spicyj If I move the space, It would go exatly 1 character over the line limit (80chars),\nso it would add another line\u2026\nEdit: doesn't really matter because the extra comma already means 1 more line is needed.\n. ",
    "Delapouite": "Small typos: libary, appications\n. ",
    "merriam": "Fixed the typos pointed out by Delapouite.\n. Fixed.   Thank you noticing.   -- Charles\nOn Fri, Jul 4, 2014 at 5:23 AM, Bruno Heridet notifications@github.com\nwrote:\n\nIn docs/docs/tutorial.md:\n\n@@ -376,9 +376,9 @@ When the component is first created, we want to GET some JSON from the server an\n ]\n```\n-We'll use jQuery to help make an asynchronous request to the server.\n+We'll use jQuery to help make an asynchronous request to the server.  It's the only we reason we loaded the jQuery libary:  React appications don't require it.\n```\n\nSmall typos: libary, appications\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/facebook/react/pull/1787/files#r14557785.\n. For sharing the server code, there is a pull request submitted for the\ngithub of the tutorial code,\nhttps://github.com/petehunt/react-tutorial/pull/20.  I could expictly\nmention the in this tutorial.md to no one has to cut and paste the server.\n\nI plan to also patch the github of the tutorial code to have the various\nintermediate steps in a separate directory.  I hate getting more than one\npending pull request per project, so I'll wait until the first pull request\nto that project clears.\nFor the nit about sentences, I suppose it could matter to someone reading\nthe source markdown file.  Because the markdown is generally viewed as\nHTML, they all fall down to single spaces anyway.   I'll patch it to be\nneighborly, but it is a truly small nit. :)\nOn Mon, Jul 7, 2014 at 11:41 AM, Paul O\u2019Shannessy notifications@github.com\nwrote:\n\nIn docs/docs/tutorial.md:\n\n\nwith open(COMMENTS_FILE, \"w\") as f:\nf.write(data_as_json)\n\nsend copy of data back as response\n\nself.send_response(200)\nself.send_header('Content-type', 'application/json')\nself.end_headers()\nself.wfile.write(data_as_json)\n  +\n  +\n  +Handler = ServerHandler\n  +httpd = SocketServer.TCPServer((\"\", PORT), Handler)\n  +httpd.serve_forever()\n  +\n  +```\n  +\n  +You can write the server in your favorite language as long as it does what our application needs:  handling the GET and POST of the JSON file.   There are many applications written in React that never hit any external server.   As an example, here's a sample node.js server that would also serve our application:\n\n\nNit, but single spaces after sentences and other punctuation (you have a\nmix of 2 and 3).\nStill thinking about the best way to actually share the server code.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/facebook/react/pull/1787/files#r14614227.\n. So, what't up with the pull request?\n1.  It's been a week.\n2.  It's a pretty good quality.\n3.  The current tutorial cannot complete because there is no server side\n   component.\n4.  You can always change it later.\n\nCharles\nOn Mon, Jul 7, 2014 at 1:26 PM, Charles Merriam charles.merriam@gmail.com\nwrote:\n\nFor sharing the server code, there is a pull request submitted for the\ngithub of the tutorial code,\nhttps://github.com/petehunt/react-tutorial/pull/20.  I could expictly\nmention the in this tutorial.md to no one has to cut and paste the server.\nI plan to also patch the github of the tutorial code to have the various\nintermediate steps in a separate directory.  I hate getting more than one\npending pull request per project, so I'll wait until the first pull request\nto that project clears.\nFor the nit about sentences, I suppose it could matter to someone reading\nthe source markdown file.  Because the markdown is generally viewed as\nHTML, they all fall down to single spaces anyway.   I'll patch it to be\nneighborly, but it is a truly small nit. :)\nOn Mon, Jul 7, 2014 at 11:41 AM, Paul O\u2019Shannessy \nnotifications@github.com wrote:\n\nIn docs/docs/tutorial.md:\n\n\nwith open(COMMENTS_FILE, \"w\") as f:\nf.write(data_as_json)\n\nsend copy of data back as response\n\nself.send_response(200)\nself.send_header('Content-type', 'application/json')\nself.end_headers()\nself.wfile.write(data_as_json)\n  +\n  +\n  +Handler = ServerHandler\n  +httpd = SocketServer.TCPServer((\"\", PORT), Handler)\n  +httpd.serve_forever()\n  +\n  +```\n  +\n  +You can write the server in your favorite language as long as it does what our application needs:  handling the GET and POST of the JSON file.   There are many applications written in React that never hit any external server.   As an example, here's a sample node.js server that would also serve our application:\n\n\nNit, but single spaces after sentences and other punctuation (you have a\nmix of 2 and 3).\nStill thinking about the best way to actually share the server code.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/facebook/react/pull/1787/files#r14614227.\n. \n\n",
    "avanderhoorn": "Ya I wasn't wild about transformAsObject as object but since transform was taken and we can't really change the existing transform to transformResult or something similar, that was what I came up with. Happy to change if we can come up with anything better.\n. ",
    "monsanto": "@zpao I'm having some trouble parsing your sentence. Do you mean that envify has no additional configuration when you add it to the transforms, and that you feel my wording implies that the reader needs to read the linked page to figure out how to configure it? \n. OK, in that case I don't think the mention is necessary at all. It is removed.\n. ",
    "justinwoo": "Ah, yep. Sorry, I lazily copy-pasted some of spicyj's code. Will fix if this PR is needed.\n. ",
    "browniefed": "This line also doesn't make much sense \"solution that allows developers to writing meaningful code\". Should it be \"to write meaningful code\"\n. ",
    "WickyNilliams": "@zpao would you like me to add note about ref in this PR also? To preserve the ref, should it be copied over explicitly like the key prop?\n. @zpao I just pushed an commit to follow convention for notes\n. ",
    "megawac": "isn't that covered in the next check anyway? It will throw if document = null but ^ change won't fix that either so \\o/\nMaybe this.document != null && document.createElement\n. You can access undefined properties on anything that isn't null or undefined so this.document != null && document.createElement will never throw an error. Your code will throw an error if for whatever reason document = null\n. Brings into question if that optimization is worth while implemented as is - it's going to mess up child setters arguments.length\n. ",
    "marianoguerra": "we can conditionaly do adoptNode only if parentNode.nodeName is an svg tag (like it's done on setInnerHTML), for that we would need to move svgNodes to a place where it can be used by all the modules.\n. same optimization applies here (only adopt node if svg nodeName)\n. I think it's the fastest way to clear the content of a node, and should work in all cases since innerHTML seems to set the content for svg nodes in all browsers, it's just that the namespace is not set correctly, any improved version is welcome.\n. ",
    "JedWatson": "Good call, updated.\n. ",
    "slorber": "@zpao I'm not sure if it's the correct way to explain this as I don't. Check this for more details: http://stackoverflow.com/questions/23665905/two-way-binding-with-checkboxes-always-returns-on\nhttp://stackoverflow.com/questions/12911787/html-checkbox-default-value\nI think this JsFiddle correctly illustrate this behavior:\nhttp://jsfiddle.net/kb3gN/4180/\nOn Child1 and Child3 I used valueLink instead of checkedLink. \n- You can see in Child1 that by default the value keeps being \"on\" as the checkbox is checked or unchecked. According to SO this default value is not specified on specification\n- You can see in Child3 that this default value \"on\" can be changed to another value, but this requires to initially link it to a non-undefined value in my state, because the valueLink will actually never modify this value again.\nSo @chenglou can you explain why you say checkedLink=valueLink= ???\n. ",
    "Meettya": "We are use own buld with patch, so its ok.\nAnyway, for me English its not mother tongue, and I not sure about I get you answer correctly.\nIs I right, I must to up brunch to current master state and revert changes to first version - adding just 'classid' in HTMLDOMPropertyConfig?\n. ",
    "julen": "Oh yes, my error when rewording, it's fixed now.\n. s/DOESN'T/DON'T/, s/has/have/\n. ",
    "janhancic": "Added, thanks!\n. Fixed :)\n. ",
    "dittos": "Quotes should be removed. (value={['B', 'C']})\n. \ub0b4\uc6a9\uc774 \ubc18\ub300\ub85c \ub3fc\uc788\ub124\uc694. \uc6d0\ubb38\uc740 React\uc5d0\uc11c\ub294 onChange\uac00 oninput\ub97c \ub300\uccb4\ud55c\ub2e4\ub294 \ub0b4\uc6a9\uc785\ub2c8\ub2e4.\n. \uac19\uc740 \ubc29\ubc95\uc73c\ub85c \ub300\ubd80\ubd84 \ube44\uc2b7\ud558\uac8c \uad6c\ud604\ud560 \uc218 \uc788\uc9c0\ub9cc -> \uad6c\ud604\ud560 \uc218 \uc788\ub294 \uba54\uc18c\ub4dc\uac00 \uac70\uc758 \uac19\uc9c0\ub9cc\n. ",
    "crm416": "Seems reasonable to me.\n. ",
    "ChrisSki": "Gotcha. I was thinking that but wasn't sure.\n. ",
    "contra": "@spicyj I agree - paused makes more sense than playing\n. ",
    "mtsyganov": "TODO: move this polyfill out of react.js\n. TODO: use this only for browsers which not support Accessors\n. I will correct this, so it tagets only <IE8 browsers which dont support Accessors\n. ",
    "rickbeerendonk": "That's where they publish Flux news :)\n. @zpao Good catch. I will remove it.\nNot too long ago I tried to build the site on my Windows machine, but it failed repeatedly. I thought the change was easy enough though, obviously not. Thx!\n. 2014 should become 2015 before this is merged.\n. @jimfb Opened a pull request to fix shallowEqual().\n. ",
    "alexeyraspopov": "HTML format is not supported by Safari browsers (both, desktop and mobile). We need to do something like this\n. Maybe we can just read innerHTML from body?\nnode.innerHTML = dom.body.innerHTML\n. Why not handleAuthorChange() {?\n. \ud83c\uddec\ud83c\udde7 . In production the branch if (typeof destroy !== 'function') { will still be present with destroy = null. Is it worth keeping it since the next line checks the type again?. ",
    "audreyt": "Added support to Safari as per your suggestion. Now it works in iBooks.app too! :heart: \n. @alexeyraspopov Well, this evaluates to <br> not <br /> and hence still fails to validate as XML:\njs\nnew DOMParser().parseFromString(\"<br>\", \"text/html\").body.innerHTML;\nUnless there is a way to cast a HTMLDocument into XMLDocument, serialization still seems required.\n. ",
    "undernewmanagement": ":thumbsup: sounds good. Let's go with that\n. ",
    "pvenkatakrishnan": "i can update the highlights part, if you think this will still be useful to be added in.\n. ",
    "Oleg24": "done!\n. ",
    "cirocosta": "actually the second arg must be a function (emptyFunction could be used) or it will throw as i remember. I'll take a look :+1: \n\nThanks for the catch. Much more concise now @syranide  :)\n. ",
    "pedronauck": "done :)\n. Of course, thank you @aackerman. I didn't see that.\n. ",
    "bloodyowl": "also\njavascript\nObject.create(null).hasOwnProperty === void 0\n. how about \njavascript\n'/**\\n\\\n * @PACKAGE@ v@VERSION@\\n\\\n *\\n\\\n * Copyright 2013-' + new Date().getFullYear() +', Facebook, Inc.\\n\\\n * All rights reserved.\\n\\\n *\\n\\\n * This source code is licensed under the BSD-style license found in the\\n\\\n * LICENSE file in the root directory of this source tree. An additional grant\\n\\\n * of patent rights can be found in the PATENTS file in the same directory.\\n\\\n *\\n\\\n */';\n. done for the wrapping.\ndo you think we should compare the mount node's ownerDocument with document to verify it's not from an iframe for the simple cases, and otherwise run the check each time?\n. whoops, fixed;\n. good catch\nhow about building a regexp with the case insensitive flag when creating the map, and test anything matching the pattern, but not equal to the valid prop?\n. and would fail with this edge-case:\njavascript\nvar eventTypes = {}\nvar eventType = eventTypes[\"constructor\"]\n!eventType || eventType === \"constructor\" // false\n. ",
    "ThomasCrevoisier": "I struggled with this because I don't know what kind of object is newNode. So I don't know how to access to the id of the new node.\n. Okay, it's done !\n. ",
    "Laiff": "First condition in this case will be totaly ignored. May use every and condition after them?\n. ",
    "aackerman": "Make sure to remove this.\n. ",
    "jquense": "The second \"experimental\" felt, to me, a bit repetitive, so I left it out, but i can add it back if it feels unclear still. On a whole that wording is much better than my stab at it.\n. different logic meaning using props.value vs _uncontrolledValue? I thought about just always tracking a 'lastValue' but I think (still early so I may be off base) you end up with additional complexity in componentWillReceiveProps, in cases where you switch between controlled & uncontrolled. It seemed simpler to localize all the logic in one place as much as possible vs spread over more lifecycle hooks? \n. oof I hadn't thought of that, you mean if the user provides a value props but then manually changes the DOM node value like findDOMNode(input).value = \"can't touch this!\"? I want to say in those cases the \"right\" thing to do is use the value prop as the last value, because the props existence indicates an intent to always handle the value declaratively.\n. > That can only be applied to controlled components, not uncontrolled. \nright, sorry I meant correct for just controlled values.\nOn that point my initial worry seems to be partly true (did a quick fiddle), starting an input uncontrolled, and switching to controlled will confuse \"this.lastValue\" unless you are also watching for the switch in componentWillRecieveProps that being said, I am not sure that situation can be used to bypass the issue b/c we are specifically checking for empty to empty values\n. yeah, honestly i returned returnValue just to appease eslint's consistent-return rule, originally it was just a lone return, which would be less prone to accidental refactoring breakage. Alternatively I could just wrap the whole thing in a big if/else or return undefined perhaps? Not sure how to best handle the lint rule :P\n. true, though the current way is consistent with similar checks elsewhere in the code base\n. Ya I saw that as well, but right below that it also demonstrates it using addEventListener, and it does seem to work in my testing. It could probably stand further testing\n. while true, Microsoft has said that a lot and then added another document mode :P it was more defensive than anything.\n. yeah, again more defensive than anything, I _know this event works with attachEvent in browsers that support it per the docs and experience, whereas with addEventListener, I only confirm it works in ie11 since that's all I have access too (that despite the ambiguity of the MS docs on support). \nIt may be that its supported in IE11 just because attachEvent doesn't exist anymore. Also it was already using attachEvent in IE9 even tho addEventListener is supported, so I didn't want to introduce a change for the older code.\n. that's totally fair, no good way to say this is helpful \"future proofing\"\n. I think this is currently unreachable yeah, Its been a few months but I may have just been overzealous refactoring. Let me remove it...\n. reverts #4051 since this addresses that issue as well. Lets the polyfill be more focused since it has some downsides.\n. Not sure that tracking on the DOM node is the best option, perhaps the instance is better? I am not sure with object is more long-lived\n. changing a value on on uncontrolled input should trigger an onChange which will trigger an update here (in text inputs anyway) since the code listens for both onChange and onInput. Missing an update should be fine since the next raised event will update the cached value \nThat being said, there is an inconsistency here but I think it might be the opposite one (or maybe the same). native onInput doesn't trigger when you set node.value; the IE8 pollyfill even wraps the value descriptor in order to detect and silence value changes triggered from javascript. If we need that consistency (which makes sense to me) then wrapping the value descriptor in the same way would allow for that, but I'm not sure if that causes any significant perf regressions, getting and setting all value descriptors on listened to inputs.\n. that was what I figured, my only thought was maybe nodes are destroyed/recreated for the same instance, but that didn't seem likely.\n. actually...it seems likes node.value = 'foo' doesn't trigger a change...which I could have sworn was not the case. Maybe there isn't any issue (from my perspective)\n. sorry slow this morning: yes failing test case\n``` js\nit.only('should not fire change when setting the value programmatically', function() {\n    var called = 0;\nfunction cb(e) {\n  called += 1;\n  expect(e.type).toBe('change');\n}\n\nvar input = ReactTestUtils.renderIntoDocument(\n  <input type=\"text\" onChange={cb} defaultValue=\"foo\"/>\n);\n\nReactTestUtils.SimulateNative.change(input);\ninput.value = 'bar'\ninput.value = 'foo'\nReactTestUtils.SimulateNative.change(input);\n\nexpect(called).toBe(2);\n\n});\n``\n. I am not sure these hooks are appropriate for this sort of thing, but they seem like they are well suited for it, baring the below annoyance\n. When unmounting the node is already gone by the time this hook is called so thegetNodeFromInstance` call throws.\nThis seems like an unfortunate break in encapsulation, the alternative was to use a try/catch but I'm mostly conditioned at this point to be afraid of try/catch VM deopts.\n. Leaky :/ see above comment https://github.com/facebook/react/pull/5746/files#r48664424\n. Deduping the events and only firing when the value changes creates a new layer of event triggering concerns.\nGenerally in a test (or where ever) I think that the expected behavior of manually triggering an event is that that event is fired regardless of the underlying logic. Since we are creating a new boundry of when these events are \"really\" fired that diverges from the browser, we run into the issue of not being able to just let manually triggered events pass through. I think the least disruptive approach is to try and maintain that behavior. \nOne solution would be flagging events in simulateNativeEventOnNode and then having the plugin check for the flag to determine if it should compare last and current values or just flush the event through. That feels kinda gross to me, but the current state of manually resetting the cache is also pretty damn ugly outside of the plugin and plugin tests.\nI am not aware of a native way to differentiate between user created Event objects and browser created ones.\n. this could be theoretically handled more generally, by having something loop through props propertyInfo and checking for IDL only attributes and setting them. Perhaps that would be more efficient? My assumption is that the above will properly batch everything anyway so it may not matter.\n. perhaps worth noting that React explicitly supports changing the value of an input imperatively via JavaScript. This isn't an obvious invariant when making changing to input code, but required to properly support autofilling, password managers, and general DOM interop (unfortunately). . AFAIK  datetime-local is still supported as datetime in some browsers, I'm not sure if that's worth adding or noting tho.. I didn't think about function components. but the farthest back version in the select is 0.13 which should be fine for plain class components . oops that makes sense. force of habit. go for it :thumbsup: got caught up with work so feel free. I switched to the unminified versions intentionally so was easier to step through stuff in devtools. This is the actual fix. I think so. I think originally I was being overly cautious about expected properties sticking around.. yeah its not great, I'm trying to detect if inst is a component instance, like it is in stack, or a DOM node as in fiber. This is the most minimal DRY change I could think of. Alternatively we could split this method into two, but its a bunch of duplication.. perfect \ud83d\udc4d . Last time I do merge conflict resolve on github :P man. . The inputs changed as far as I can know. The only place this was called otherwise was in the ChangeEventPlugin where it's just called an \"instance\" It may very well be a DOM node there in Fiber (now that I think of it). The need for the logic branch here is that we need the actual DOM node, and to handle both renderers that means calling getNodeFromInstance which seems to be fairly unforgiving of you passing in a node already, which I think is somerhow what's happening\nAs for the terminology it was more to save line space instead of writing InstanceWithWrapperState | ElementWithWrapperState in a few places.. more in the comment above, but the check is purely to avoid calling getNodeFromInstance when inst is already a Node, as in the Fiber case. The only reason it was added was to handle both renderers, You can see in backport PR that this file isn't even touched (i'm guessing that one probably doesn't suffer this bug btw). TBH I don't know what the Fiber type is/does here. I didn't add the types originally and AFAICT its never passed a Fiber, only an instance or Dom node. ooo I think I understand where the bug is. That may be! I still unfamiliar with the Fiber data types but the only place this is called is is ChangeEventPlugin with the targetInst parameter and DOMComponent. I'm unsure what the case is in the changeEventPlugin. \nIs the Fiber situation that sometimes it may be an \"instance\" (DOM Node) and sometimes it may be a \"Fiber\". In the Stack case it's always an internal Instance. So don't think subject can actually be a Fiber, unless that is what is being passed in in the ChangeEventPlugin, but i'm not sure how to confirm it. If so this should be easier to simply\nI would split this method into updateValueIfChangedFiber or something and then when Stack is retired, delete the old method, rename and move on.\nIs there something that needs to be done to run tests against either Stack or Fiber? . O the joy of supporting multiple things at the same time. Ok the lack flow annotations in the event system (and 14 levels of injection and indirection :p) made it difficult to understand what targetInst was type-wise. That's more on me, I'm not super up to date on the fiber internals. \nThe check isn't backward I don't think. The problem was node instances were making it to the track path instead of the trackNode path and exploding. I think the rub that makes this complicated isn't instances vs nodes but the case where a Fiber is passed, it makes the branching really awkward. . Which is to say the track path is really more of a stack only path but not well named. do we also want to exercise the change plugin route? e.g. trigger a change event on the input.. SimulateNative.change(node) should work, if the event triggered it passed through the function. It isn't specifically gonna catch a failure in Fiber but it covers the all paths through updateValueIfChanged.. Just to be clear for myself here, getNodeFromInstance works on Fibers?. sure \ud83d\udc4d . That's fine with me, it just means we need to call getNode at the call sites: ReactDOMComponent and ChangeEventPlugin. was a fight between eslint and flow. flow wants String(bool) and eslint prohibits primitive constructors. flow complains about an invalid coercion, its being a bit over protective . yeah the value is only ever used to compare to itself...and actually node can't be falsely here, since it's only called below after a if (node) check. it might be worth keeping the top level keyUp and keyDown since it's easy. oops it is true, but we aren't hitting this path, because the targetInst is null...I wonder if that is related to  selectionchange not having the right target? why would the instance be null in this case?\nand this bug is definitely in master as well. ok yeah this bug is probably in all versions of react. The Event responder can't find the associated instance  for this event because the target is the document. This would be true for any weird events like this.... so this was the problem (and is the problem on master/stable) there is no targetInst for this event so there is no way this event will get published to react-land. it does generally, The null check is out of caution, since this depends on on the input being focused, there may be edge cases where focus drops or some programatic driving of the browser doesn't set focus, etc. I don't think there is much we can do about such edge cases and wanted to limit the possible effect to only cases where the polyfill was being used.. We were already tracking the active element for this code so the constraint isn't new, i'm just deferring to activeElement instead of caching it locally in a variable.. Radios and Checkboxes were listening for onClick, i removed that in favor of just listening for onChange/onInput like text inputs.\nI'm not entirely sure why the original code used click, the comment suggested it was for IE8, it appears to work fine in IE9 though . React apparently requires it, I got a warning for it being missing. Not sure what the official place to snag it is. the original comment:\n\n99% of the time, keydown and keyup aren't necessary. IE8 fails to fire \npropertychange on the first input event after setting value from a    \nscript and fires only keydown, keypress, keyup. Catching keyup usually      \ngets it and catching keydown lets us fire an event for the first    \nkeystroke if user does a key repeat (it'll be a little delayed: right   \nbefore the second keystroke). Other input methods (e.g., paste) seem to     \nfire selectionchange normally.\n\nIt says IE8 only but one never knows right? We could add them back for sense of security, downside is just a few more lines of code, and maybe cargo-culting in code.. that's a good question...we should probably use a very focused set of polyfills according to what React says it requires. Should also help keep React honest about that as well :P\nI just didn't know what React requires now, for instance in DEV you need Set which didn't seem obvious. Its like a half-polyfill, we actually do rely on IE9's native onInput but patch around it so it's not unusably buggy. Specifically it works fine except when deleting text (lol), the selectionchange covers that case.. I think so! I forgot about actual event target, good call. why does this file still exist? It seems to be mostly (only?) used as a type import, but has actual code in it. Does this make it into a build? maybe worth changing to a purely flow file so there isn't any worry of runtime usage?. I wonder how irregular the mapping is, could maybe remove it in favor of something like we do here: https://github.com/jquense/react/blob/2a69ba16caf4eee8c9f1dcfbeb937049c494cec3/src/renderers/dom/shared/eventPlugins/SimpleEventPlugin.js#L133-L135\n. Maybe \"CRA works best with Node.js version 6 or above\" instead, since it's not actually required that node 6 be used?. I wonder if this is going to be resilent enough...perhaps something that explictly checks for native code e.g. https://gist.github.com/jdalton/5e34d890105aca44399f. I know you didn't write all this, but the logic is hard to follow here...can we switch early to see if it's controlled?. I was thinking check if propValue was set, but that wouldn't actually work...I guess i don't have any specific suggestions :P but I felt like I had to read this through 3 times to understand it, and it feels like it should be easier to express. it'd be nice to keep the change removing the click behavior for checkable inputs. I can see if I can just pull those bits out. I guess we have no reason to think this isn't the cause here.. perfect i'll try and get something up. Thinking more on it, it should be fine to stick some of this in a patch release anyway, given it's supposed just be clearing out unused code (why are browsers so hard).\nthanks yall. Can we adjust the comment to specify which platform it occurs on?  . It seems like practically this is going to make the unknown DOM warning permanent (modulo some cases). Granted it's probably not what the user intends it seems a bit heavy handed.. or perhaps maybe just that it's going to give the impression that everything is fine when they aren't getting this warning, while foo=\"[Object object]\" still gets passed. What about custom elements (or does that not hit here)? Chance of a false positive? If we are trying to get out of folks way about passing what they want to the DOM this feels a bit arbitrary as you say. . sigh didn't see the original issue, sorry for the noise :P. this is an awkward sentance...maybe \"When no arguments are passed, printInclusive defaults ...\"?. AFAIK v8 used to/does deop switches without string literals as the case, I couldn't find anything recent that gave clarity on if that was still true, it may not matter here either. (I mention it because  the return here is used in a switch elsewhere yeah?). So in 15.6.2 this fix is no longer working...broadly when an radio changes it triggers an update in related (same name) radio inputs manually. Originally (unless i'm going crazy) those other updates hit this branch, .e.g radio1 triggered updateComponent and the other radios reset their inputTracking. Now it seems like this branch is missed entirely and ReactDOMInput.updateWrapper is called directly...I could totally be going crazy and this never worked originally but i'm certain we all tested it...\nCC @aweary @nhunzaker . perhaps this should be set once on mount? That is a bit iffy i guess. Ostensibly defaultValue is set once for inputs and changing it after that is a noop for the life of the component. It seems like now tho you can set it, change it and reset the form and it'll use the new value. That may not be worth the complexity to address, but it opens up a new inconsistency perhaps.. ah ok, so it's consistent with the other input reset behavior sorry. carry on then :P. I believe you could still have cases where ownerDocument is undefined, e.g. if the node is detached (for some reason). This is definitely true for some browsers for password types, for \"security\". . I don't know if this will work since we stub this in the input tracking code...or is that only the instance property that's stubbed? . Essentially if the input event isn't supported this test won't test anything. I think this test as mutated a bit over time. This guard should be fine to just remove at this point. onInput will always be supported in the unit test environment so this wouldn't ever get hit.. this comment isn't correct anymore since you've moved the updateDOMProperties call below it. We would need to confirm that the original issue with validations firing doesn't occur. Can you write a dom fixture that demonstrates the issue and that it doesn't occur after this change?\n@nhunzaker Any suggestions on how to write that, or what conditions triggered it?. for these, is there a reason why we were calling them out specifically here vs in the ensureListeningTo above? Do they need to probably be attached like onChange now?. why do these need delegation? I wonder what the likelihood of this growing annoyingly is? . isn't root undefined here?. that's a good question, technically i'd be relying on a private implementation detail, but i can see it breaking tests for folks as well. I defer to what the team thing on this. ah so since everything is being attached directly there is no need to handle it here anymore \ud83d\udc4d  right. blah that's annoying, this should need to include topMouseEnter and topMouseLeave, at the moment we don't support the native event (we always polyfill it) and I think even if we did it wouldn't be needed, since those events always originate from the target element (react owned) whereas the other events originate from the relatedTarget, which may be not be react-owned. also did we end up some place on using the native event vs continuing to polyfill this forever?. I did the basic work checking for support, and we definitely can use the native event, the problem is Portals now. \nnaive approach: https://github.com/facebook/react/pull/10247\nhack with portal support: https://github.com/facebook/react/pull/10269\nIn terms of moving attachment to the plugin, there used to be (still are?) hooks on the plugins that would get called for this sort of thing, something like willAttachListener they may have been removed tho since i can't seem to find them...\n. any reason to pin the version? docker/node comes with at least yarn 1.2.1 already. worth using 8-alpine?. probably worth prefixing/appending -v1 to the key or something so it can be neatly manually invalidated if required. this is any click that isn't a left click yeah. which is correct going off the mdn example https://mdn.github.io/dom-examples/auxclick/. I think it should test that the tracked value updates when you set it from js. The test should normally set the value then trigger and event and assert that the event doesn't fire. hasUserInput?. are these needed, HTMLInputElement should already contain these properties i think yeah?. Doesn't react yell if you switch to undefined? Null gets a different warning about using an empty string. Should we add a TODO: to remove this on a major bump? It's not clear to me why ignoring other types vs throwing or defering to whatever the browser does is more corrrect. Sure that' makes ense, tho I think \"treating the as null\" vs an error is maybe less ideal. In, the error case it's easier track down and fix vs inputs clearing and maybe not noticing. this should not be necessary anymore :) \ud83d\udc4d . i'm not sure this is safe, but it seems to be. We use straight sets on textContent elsewhere. I think the stringify happens in diffProperties for update, so the value is already a string here. Good eye :P yeah it's not related to the one change, just another thing I noticed. I did split it out by commit but we can do separate PR's\nNo harm in being intentional about the changes! . I've tried to check back through the history to see what was going on here, and at least originally it used to try and precache nodes: https://github.com/facebook/react/commit/6d20556c78df6904254b8438bb588f7722ea602f#diff-a2fd175216a5aa6425363e6773426f3c\nBut at some point that was removed but I can't find git blame is not helping :/\nThen. I think in practical usage it doesn't get past 47, but I guess theoretically it could, if the fiber was a different type?\nMy guess tho is that this was for both stack and fiber and never got removed. Though even if it could get past 47 I don't think the loop does anything other than run one iteration, and return inst. no rush clearly. :). that's a good question. I think your probably right, however i was trying to keep with the spirit (for lack of a better term) of the method by failing softly.\nI do think tho that a situation where its not a component or text is kind of a different sort of error and maybe should fail hard. Are roots or portals cached on elements? Presumable you should hit a component before that tho. not that I've ever seen. might be worth ensuring these are logged somewhere. I noticed on RDL that errors thrown in event handlers where being swallowed by jsdom under mysterious circumstances...I guess there is already an issue for it tho:  https://github.com/facebook/react/issues/8260. Object.create(null) maybe ?\n  . this could be simplified to just dispatchType phased/direct if the names don't need to be configurable. I think on the DOM side the convention hold everywhere, not sure about RN tho. Yeah I was thinking the same thing. There doesn't seem to be much value to them they are just the event name with 'top' appended. . i don't think so, seems like a rebase issue. these should be exported as well. They also should probably not be the actual Fiber type. The goal of this is that they are opaque to a user, meaning they track the right type, but the contents of the type aren't visible to a user of it, e.g react-dom-lite will pass around OpaqueHandle but should know or touch anything on it.. this needs to be updated from the source again, the method sig changed here with my recent PR. I believe most of these types are already included in flow?. the PR is merged! check master for the updated signature. Its checking whether the name is null or undefined. != null or == null is a common shorthand for foo !== undefined && foo !== null since a double equal against null coerce undefined to null but nothing else. . might be clearer if it was an array of array pairs? Like maybe just the argument to the original map. Less likely to accidentally shift one array but not the other. i'm a little concerned this might have the same issue as https://github.com/facebook/react/pull/12353. we are still out on that, ideally polyfills should fix these cases. But it's not the Set or Map but the constructing either with an iterable that is weird in IE.. This seems fine in the case where you're rendering just host elements, but maybe not helpful for the HOC case where you wrap and render a single composite component.... probably not in practice but the ShallowRenderer tests do <NullIdentifer> which was how i was hitting this.. hmm i don't know, I was conflating workspaces and lerna, the latter of which handles the updates. I was thinking of this case:\njs\nfunction withFoo(Component) {\n  const Foo = (props) => <Component ref={props.forwardedRef} />\n  return React.forwardRef((props, ref) => <Foo forwardedRef={ref} />)\n}\nshallow(<WithFooComponent><div/></WithFooComponent>)\nYou'd get a different result than without the forwardRef but I guess that's true of any HoC thing, might even help hide the HoC guts a bit more with is nice.. The link is dead for me. Does accessing parentNode have an undue reflow effects? I don't have any reason to think it does but the DOM is weird :P. I'm not sure this test suite tests much? I suppose it doesn't hurt but it doesn't really cover this bug, or the svg case. I'm not sure if it makes sense to add.. I'd add an additional safety check here that composedPath  exists. Who knows what the compatibility matrix will look like here.... Does this test case fail without this PR? My understanding is the event would still fire, but the target would be wrong, the TestCase doesn't assert anything about the target, only that the event was seen.. we should probably also include a closed version that ensures documents/asserts the behavior in that case as well. I'd really like to track down the reason for this so we don't accidentally remove it again as well. Everything I can find suggests that srcElement should not be needed in IE9, so I'm wondering where the issue is coming from. I haven't found much some-places suggest that when attachEvent is used it follows the ie8 event model (with target undefined), I wonder if some branches are still hitting attachEvent?. the change polyfill uses it, Perhaps that's the root cause? I think we could use addEventListener there.... My other guess is that maybe it's like a quirksmode sort of thing, where folks are seeing something in document mode they don't realize they are in, in ie9 :/. @sophiebits original blog post on this is my primary text on the subject :P https://sophiebits.com/2013/06/18/a-near-perfect-oninput-shim-for-ie-8-and-9.html\nI think you are right, I was reticent to yank it all out out of an abundance of caution, but it should be ok to remove (as well as the keyup and down handlers with selectionchange below). this is soooo special.\nThe original point of of onpropertychange here was specifically for ie8, not ie9. It makes up the bulk of the polyfill, and should be the thing reporting the change. We avoid the ie9 oninput because it's a bit buggy, however without needing IE8 support we can craft a leaner polyfill that uses the selectionchange stuff as well as the native onInput event.\nI don't think it's safe to remove the onpropertychange tho unless it's backfilled with the onInput event, which (I think) is skipped for ie9.. really? huh... That seems weird the input support check specifically checks for documentMode > 9 . wouldn't the onInput event catch that as well? Or does it not fire in that case for ie9?. right, deleting doesn't work, we have the selectionchange and various key events to catch those cases tho (that is the intent anyway). I'm making a note to check this... my hunch is none of this logic is needed and we can just use node.contains will try it out tho. ditto here, tho this is probably for cross-iframe active element checking in ie9, maybe not relevant to react. seems like no? you really can't render them right?. would this be a good moment/save implementation complexity to change up how this plugin is implemented, could avoid the special traversal. isn't this true for any mouse/pointer event?. why does stopPropagation call stopImmediatePropagation (also IE support?). ",
    "graue": "Good catch, thanks.\n. nit: maybe call it 'can pass context when shallowly rendering'?\n. nit: add a trailing comma here\n. ",
    "jimfb": "Ok, thanks, fixed in latest version to be posted momentarily.  Incidentally, do you know Alan Pierce?  Tell him Jim from Palantir says Hi!\n. Ok, I agree, that's better.  Fixed in version to be posted momentarily.\n. Yeah, I was going to post a mini link, but the updated documentation hasn't been merged yet (Paul is out for a couple weeks, so it probably be a little while).  I went ahead and added a period to the sentence.\n. It's the intuitive thing to try, if you haven't read about dangerouslySetInnerHTML, so it's worth checking if for no other reason than to hint to the user where they might look for the supported function.\n. Looking at the implementation of invariant, I fail to see the performance issue.  The common case does two \"if\" statements, which shouldn't be measurably less performant than the other if check.  It's slightly slower in the failure case, but since this indicates an error, that should not be hit in production.  We're using invariant everywhere - I'll see what Sebastian thinks tomorrow.\n. The majority of other tests in this file are using double quotes, I was just being consistent with the file, but I have no objection to single quotes, so changed in latest.\n. renderToString fixed in https://github.com/facebook/react/pull/2565\n. Fixed.\n. Ok, great, removed.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Ok, displayname is going to be null/undefined in a lot (most?) cases.  It gives less info to whomever is debugging, but I agree those objects can get pretty big.  Anyway, updated in new diff.\n. I feel like the usage of isNode is pretty straightforward (am I missing something obvious?  see new diff).  Or did you mean you'd help with the other comments?\n. Better?\n. Done.\n. As per discussion, * would imply it could be an integer or boolean, etc - which would be incorrect usage.  Type should be ReactComponent|DomElement - fixed in the latest change set.\n. Done.\n. As per discussion, we're planning to ask Sebastian what to do here.\n. done.\n. done.\n. done.\n. ok, done.  You guys seem to really like the inverted form of if statements.  Personally, I tend to think it's easier to understand \"if the component has a render function, throw an error\" rather than \"assert that render is null OR that the render property is not a function\".  The former is closer to the semantic reasoning, while the latter feels like ~~demorganized~~ compiled output.  The exclamation point out front just converts the \"invariant\" into an \"if\", and the inside of the \"if\" is the failure condition.  I know both are technically relying on short-circuit evaluation, but it just feels easier to reason about the former.  Anyway, that's my two cents.  Updated diff uses demorganized form.\n. Excellent catch, thanks!\n. I still like the un-demorganized form better.  What do people think?\n. Can't spy twice, so as per discussion, using mocks.\n. done.\n. Done.\n. added todo.\n. Done.\n. done.\n. Ok, done in it(\"should warn if context values differ on update using wrapper\")\n. Now asserting both, we can think about handling the duplicate warning in another diff.\n. Good catch, link changed in previous CR change, fixed.\n. Good catch, thanks!\n. Ok, no strong preference, I'll take your recommendation.\n. haha, that looks so wrong :).  Done :).\n. There is a minor functional change, in that we will only fire each warning once (otherwise, you'd get the same warning over and over again every time a render() was called, which would be very noisy).  This means that in these two places where we were expecting console.warn.mock.calls.length to be 2, it will only ever reach 1.  I refactored the code into a separate test so that we can assert the warning does fire on the condition being tested.  See lines 266-269 of ReactElementValidator.js\n. We call quoteAttributeValueForBrowser, which calls escapeTextContentForBrowser.  Is that not good enough?\nWhat are you worried about?  Users controlling the property name?\n. ok, cool, I'll add an invariant.\n. Do we care?  Is someone fixing the transpiler soon, or do you want me to use Object.assign and manually remove the object properties?\n. They are independent concerns, so I'm thinking they should be independent if statements.  Especially with the newer if statement (checking both owners) which is more complicated to reason about.\n. Rrrarw, yeah, ok.  This is a perfect example of why the line length warning SUCKS and should be removed.\n. There are two places where proptype errors are detected/thrown.  The first is on the Element and the second is on the Component.  In open source, we now warn on the Element, but internally we still warn on the component and disable the element warning (while we fix our shit internally).  The intent here is that the warnings fired by the CompositeComponent shouldn't actually happen since they should already have been fired by the Element, so the warning module just silences those warnings.  If your proptypes are wrong and you're not getting any warnings, that sounds like an issue.  If you can create a simple demo on jsfiddle, we can take a look into it.\n. Yeah, sounds right to me.  cc @zpao \n. I'll fix in src https://github.com/facebook/react/pull/3208\n. No clue, it came with a copy-paste from ReactWebWorker-test, I suppose I was just being consistent :).  Fixed :).\n. Makes me a little queasy to see a function that takes in a message and prepends it to the beginning of a format string, because it's not entirely clear from the signature that the caller of warnAndMonitorForKeyUse is not allowed to pass user-controlled data into the message.  That said, all the callers are passing static strings and this change doesn't make that worse.  Just happened to notice, so I thought I'd point it out.\n. Did you mean for this to be childOwnerAddendum?  Looks like childOwnerAddendum is always the empty string.  Edit: zpao found it first and commented moments before me.\n. k.\n. Sebastian says that people shouldn't put anything on the object and should store everything in state, because he wants to do fancy things where he throws away components.\n. we are missing a type on children\n. if it's a varargs, it shouldn't be inside array brackets, should it?\n. Meh, I prefer incremental correctness over consistency, but sure.  Looks good to me.\n. \"an element\" or \"the elements\"; there is an article agreement issue with the current wording.  Also, it's useful to indicate that this functionality should only be used \"in rare situations\", since that allows newbies browsing the documentation to skip this section and also indicates to more experienced developers that they should use this functionality judiciously.\nAlso, the current wording makes it sound like we are mutating the children property, rather than cloning them and using the clones in render.  While the text you wrote isn't technically incorrect, I think it could be reworded a little to make it clear that we are NOT proposing that people mutate this.props.children.\nOther than the changes to this line, the rest of the PR looks good to me.\n. Markdown files don't usually have  elements, do they?  Usually markdown is intended to be both human and machine readable, to the extent possible, right?  cc @zpao who will know best.\n. I'm a little curious how this would interact with ES6 classes if we upgrade to ES6.  Is the prototype of an ES6 class a object or a function?  I feel like what you are actually wanting to check is if the prototype is undefined in order to avoid throwing on the next line.\n. Right, but is it good style?  Is it what we want to do here?  My understanding (which is admittedly limited) is that we want to avoid HTML in the markdown files whenever possible.  In the case of a linebreak, it seems avoidable, but maybe it's necessary/desirable here because we're in a table.  Another option would be to use a coma or other form of punctuation. instead of a br.  I don't have a strong preference here, mostly just flagging it for @zpao to take a look and make a call.\n. Yeah, I think Ben was also in favor of putting it on the component in order to preserve argument order.  I sort of like it too, because I see it like \"asking this component to render a child\" which seems better than rendering a child on behalf of the component.  But since I don't think this should be public API yet (I would have underscored it), I think addons is the right place for it, as per our discussion.  Moved it there.\n. Done, reformatted.\n. I'm a little surprised the unit test didn't blow up there.  It seems like travis should have failed this.  Interesting.\n. @sebmarkbage said, for now, only componentDidMount and componentDidUpdate are allowed.  Currently calling it from a callback is not allowed (although I don't like this, I think it should be allowed, it's always easy to remove this restriction later).  Calling it twice in a row shouldn't be a problem, though I can't imagine why someone would want to do that.  Calling it from within Render is (according to sebastian) not good and disallowed.  I'll clarify the error message.\n. Done.\n. Introduced when I added the lifecycle stuff and then removed it.  Reverting the file.\n. Not in this case, that came from a copy-paste of the previous test.  I'll remove it.\n. Fixed.\n. It is defined in ReactDOMIDOperations.js\n. It throws an Invariant Violation: Invalid attribute name: blah\" onclick=\"beevil\" noise=\"hi.  I'll go ahead and add it to the unit test for clarity, but the test/code here should already be technically correct.\n. Ah, I was looking at the wrong test block.  And it's all starting to come back to me.  We throw the Invariant Violation on initial render and updateAttributeByID throws a Invalid character: attribute name: blah\" onclick=\"beevil\" noise=\"hi on update.  The error is different because the first is a check we do ourselves during initial render, the second is a check done by the browser (so the browser owns the error message).  We could do the check on update also, but that would mean we are doing the check twice (once ourselves and once by the browser), which is a waste of valuable cpu cycles (performance issue).  We can't expect a particular error message to be thrown here because the specifics of the error message are browser-dependent and we want our unit tests to run in any browser.\n. I think that's how I originally had it written up, but it resulted in a couple of things that Sebastian (or maybe it was Paul) didn't like.  There is a remnant of the old implementation in the jsdocs over createMarkupForCustomAttribute (jsdocs specify a tagName parameter that was since removed); I'll go clean this up when we come to a decision here.  I don't remember the details, and I'm happy to change it back, but maybe get one of them to say yay/nay before we make a change that they don't want to accept.\nI think the issues might have been one or more of the following:\n- DOMPropertyOperations now has a cache, and they didn't want caching at that layer?  Someone wanted that layer to be a pure function of its inputs?\n- It leads to an awkward set of rules about who is responsible for validation.  For non-custom-attributes, the safety is verified by the whitelist, but for custom attributes we would be verifying in DOMPropertyOperations.  Now you can't say \"DOMPropertyOperations is unsafe and ReactDOMComponent is safe\"... the statement becomes \"things are safe because of a complicated interweaving of security checks.\"\n- Some other reason that isn't on this list.\nAnyway, my gut intuition is that validation should be done in DOMPropetyOperations (so I agree with you on that point), but I can also understand the other side of the arguments.\nCC: @zpao @sebmarkbage , can we get one of you to weigh in on this topic.  Where should each of these validations occur?\n. Or @spicyj if we don't feel strongly about it, we can keep it as-is (as per reasons above) and we can always change it later.\n. It's a style that allows you to add validation while passing a value through, similar to function chaining (where a builder returns its self).  Otherwise, the function is just void, so we don't loose anything by returning the value.  This pattern is pretty common in other languages, but we can remove it if it isn't common javascript.\n. We could, at the expense of an unnecessary pass over the markup.  As with virtually all optimizations, it is a tradeoff between \"performance\" and \"code beauty\".\nI don't have a preference - just let me know what you guys want here and I'll code it up.\n. This code is exactly the same as lines 64-68 in the same file.  I was just trying to be consistent.  Want me to move both of them?\n. Ok, fixing now.\n. Well, if it's invalid, it's a fatal code path anyway, so it doesn't matter much at that point.  But ok, sounds like you'd prefer we did the check ourselves, so I'll do that.\n. That's how I had my original code.  Sebastian chewed me out for it :), and said that we shouldn't be leaking tagName into this file (see first comment on this diff in the history).\nFor now, I'm tempted to leave it as-is, since this is how Sebastian wanted it.  You guys can battle it out later.\n. Fixed.\n. I'm not really sure how I feel about having this as the canonical example, primarily because I don't like the idea that I'm defining the functions in one place and then mutating the functions later in the constructor.\nWhen I bind the function, I do it at the point that I'm passing the function to the other component.  <button onclick={this.changeContent.bind(this)}>Click Me</button>.  Both styles have their pros and cons (mine is a little slower at runtime, because I'm not memoizing the bound function, but I'd gladly take the perf hit to avoid the mutation).\n. Both versions are awkward.  Maybe \"You may be thinking that it's expensive to change data if there are a large number of nodes under an owner\".  Just remove the \"to React\" altogether, since we're obviously talking about React perf?\n. please use if(__DEV__) instead of \"production\" !== process.env.NODE_ENV\n. You can just call warning directly here (the ternary operator will be added automatically as part of the build process transformations).\n. I feel like maybe we should skip the piece of child content if it is not a string or number.  Maybe something like if(typeof c !== 'string' && typeof c !== 'number') { warning(false, '%s can not have complex children/content', tag); } else { childrenContent += c; }, instead of checking for a valid element as the warning condition.\n. No, I think the opposite is true.  We DO want to require it in any case where we're in a real browser.  The polyfill will detect if the browser supports webcomponents, and if the browser does not support them, it will polyfill them.  Either way, we want to run this test in any browser that might support webcomponents (either natively or as a result of a polyfill).\nOne could argue that this test is unnecessary (because webcomponents will fail to load in PhantomJS anyway), which will result in the catch block, but we do want this in real browsers.\n. Done.\n. Oh, yeah, you're right!\n. Yep, good idea, will do!\n. Context isn't supported yet; I don't think we want to have an example.  For now, we will want to be unit-tests only.\n. Developers will be tempted to just always return true for shouldUpdateChildContext, since it's the simplest thing to do.  At the very least, we should warn if they return true but the object that getChildContext() returns is shallow equal to the previous context they returned.  We might even want to make shouldUpdateChildContext mandatory for any context provider.  Thoughts @sebmarkbage?\n. Use nextProps here, not props (which is undefined).\n. getReactRootIDFromNodeID is currently super cheap, and the iterate-until-nodeid-equals-rootid means the loop control variable gets updated in two places (much harder to reason about).  Sounds like premature optimization; you're optimizing for a case that doesn't happen yet.\nAs a side note: the legacy path (else branch) also calls getReactRootIDFromNodeID.\nHaving said all that, I'll go ahead and make the change now.\n. Shouldn't this be typeof module?  Also, fixed in https://github.com/facebook/react/pull/4150\n. Ugg, maybe we check for both?  It seems highly awkward to attempt to write to a variable called 'module' just because a variable called 'exports' exists (especially since the line would crash fatally if module doesn't exist).\n. For the unit tests run in debug mode, we load webcomponents in the wrapper html and module isn't defined.\n. I'm not even sure that change is required.  I made it because you flagged that file, but @ryanflorence's test doesn't seem to require that line.\n. But a shallow compare isn't good enough, because the context value might have changed deeply.\n. Ok.  Updating diff.\n. Ok, line is now required :).\n. Yeah, but we also get a new instance if the parent doesn't re-render because we call processChildContext and add the dom nesting validation.  See: https://github.com/facebook/react/blob/3dc43840efd127bf2f5089b1aa7043e6d1b497de/src/renderers/dom/shared/ReactDOMComponent.js#L708\n. Ok, good to know.  That is why I left a comment there and commented on it in the diff: https://github.com/facebook/react/pull/4221#issuecomment-115155813.  Do you have a jsfiddle / small test case that demonstrates this so we can add it to the unit tests?\nAdding this line appears to cause a unit test to fail (appears to cause React to fail to invoke the proper lifecycle methods).  I think it's because if we don't bail out, we invoke internalInstance.receiveComponent without first calling the lifecycle methods.  My top/immediate priority was to fix Ryan's usecase in order to unblock him, which this diff does, but I'll sync with @sebmarkbage asap and see if we can get to the bottom of this.\n. Since jsx is the more idiomatic way of creating elements, I feel like we should probably use jsx in the examples, instead of manually creating the elements.  Thoughts @spicyj?\n. It seems weird to call it tutorial13.json if everyone expects it to be comments.json.  @spicyj @zpao, is there a reason this comment doesn't say comments.json. \n. Let's put public/comments.json in backticks, so it becomes: public/comments.json, as done for getInitialState in the line above.\n. Yeah, I'm not sure how I feel about setting end to a magic number either.  Both solutions seem kinda sucky because they add complexity, I'd rather just keep this inline null check I think.  This is the type of thing that really should be handled by the JIT rather than hand-optimized.  Given that this is the type of thing that a JIT could easily optimize, do we even know that this improves perf?\nI'm inclined to agree with @syranide on this one.  But @sebmarkbage has a lower threshold for acceptable perf optimizations than I do, so tagging him in case he wants to jump in.\n. Maybe also put some text here to drive the point home?\nMaybe something like:\n\nThis change also applies to the return result of ReactDOM.render when passing a DOM node (eg. span, div, img) as the top component.  As with refs, this change does not affect custom components (eg. <MyFancyMenu> or <MyContextProvider>), which remain unaffected by this change.\n. Why does Grandparent exist here?  Seems like it should just be ReactTestUtils.renderIntoDocument(<Parent><div /></Parent>);\n\nAlso, why are you saving the result as component?  The variable appears to be unused/unnecessary.\n. We should also assert the text of the error message (ie. cloneWithProps(...) is deprecated. Please use React.cloneElement instead.) because that makes it easier to debug when the test starts failing.\n. I feel like we should not be appending a child to the body here.\n. This requires the browser to parse and rehydrate the markup, which is very expensive.  We should re-use the parsed nodes when we assign to the container (when we're done), or only run this normalization logic in dev mode (it's just for the error message, right?)\n. Invariant shouldn't be in devmode block.  @zpao should this even be an invariant?  Seems like this could just be a warning?\n. Haha :+1: \n. This seems to imply that props change as a result of the current component's render function being called.  Maybe \"... may change when a parent component is re-rendered\" or \"... may change as a result of a parent component re-rendering\"?\n. Yeah, that would fix the issue from https://github.com/facebook/jest/issues/429 (I solved that by assigning a new empty array to the variable), but there is also the issue that the lifecycle gets called more often in dev, so the arrays will not be equal anymore due to https://github.com/facebook/react/pull/3516.  We now just verify that every element of desiredWillUpdates dose appear in willUpdates.\n. Done.\n. Typo: there should be two m's in programmatically.\n. What is Acc?  Accumulator?  Can we call it ComponentsAccumulator?  Just adding Acc really doesn't tell me much more than Components did.\n. \"it\" is a little ambiguous.  How about \"Uncontrolled, means the <input> component maintains its own internal state.\"\n. I kind of like the older wording a little better for this paragraph.  The new wording almost makes it sound like it's a different kind of component, when in fact, it's still an input component, but behaves a tiny bit differently.  I like most of the changes in this diff, but this one isn't clearly better IMO.  I especially like that the old wording gave you a hint as to why you might want such a thing before looking at the code.  Otherwise, you read the code without context and are like \"wtf?\" and then don't figure it out until the next paragraph and then go back and look at the code again.\nIf we took the old paragraph, but changed the word \"set\" with \"prop specified\", would that clear up most of your dislike for that sentence?  So the new wording would read:\n\nAn <input> with value prop specified is a controlled component. In a controlled <input>, the value of the rendered element will always reflect the value prop. For example:\n. Right, I'm fine with the second paragraph changing, but the first such paragraph/sentence that I highlighted has no such ambiguity.\n\nBut if it's still a concern with the first paragraph, an alternate wording could be:\n\nSpecifying a value prop on an <input> makes it a controlled input component.  In a controlled <input>, the value of the rendered element will always reflect the value prop. For example:\n\nI mostly just want to give the reader some context before we throw some code at them; otherwise they're almost guaranteed to miss what we're trying to show them and have to go back to read it again.  We give them a complete description of what's going on, show them an example, and explain the example.  If they forget what a controlled component is in the future, they can open the page, read the first two sentences and say \"oh yeah, I remember now\" and close the page without digging through a novel to get to the implication part.\n. Yep, sounds good to me.\nThe sentence should have an 'a' before value, and also we try to use the word 'prop' across the docs when referring to properties on elements, so the line would become:\n\nA controlled <input> has a value prop. Rendering a controlled <input> will reflect the value of the value prop.\n. @zpao I'm fine with whatever you guys ultimately decide.  For a point of reference, this was one thing that tripped me up for a few minutes the first time I ran across it (which was pretty early in my usage of Simulate).  I suspect that this is a pretty common stumbling point among users of Simulate (it is the most obvious thing to do inside an event handler).  I don't feel strongly either way though.\n. The star is there to indicate a reference to the footnote/clarification below.  It's a way of connecting the additional information to that sentence without breaking the train of thought there.  But if we remove the * as per @zpao then we should probably also remove this star.\n. It's the style prop of the owner component?  This doesn't look right to me.  I don't think it's the \"style prop of the owner\"\n. You need to have an if-check, because there is no guarantee that _owner isn't null (element could have been created outside of a render method), in which case this will throw.\n. Yeah, it's not, but it's a mock event anyway and close enough to be sufficient for the unit test.\n. Posting mostly for my future self when we come back to this in the future: We fire the events during traversal because we need to change the target as we're traversing (unlike in the non-path case).  We could save that info in a lookaside array, which would need to be kept in sync and map 1-to-1 with the bookKeeping.ancestors, but that was less clean than firing as we iterate.  This new logic does attempt to keep the bookkeeping object as identical as possible (we do maintain bookKeeping.ancestors, despite the fact that the path function/implementation doesn't actually need it.\n. Flatten children is expensive; I'd prefer not to do it in production.  Is there a way we can avoid this?\n. I guess you just moved the callsite, but this actually increases the surface area where flattened children are expected, and ideally we'd decrease it so ReactChildReconciler never needs to flatten.\n. The new name is inconsistent with the docs block above.  Personally I like the more explicit name nextFlattenedChildrenElements and would like to see that used everywhere, but at the very least they should probably be consistent?\n. I feel like this reads a little awkwardly.  Maybe \"Merges (shallowly, not recursively) nextState with the current state\" or \"Merges nextState with the current state (shallowly, not recursively)\".  Or reword so it flows more naturally with the paragraph text.  The phrase \"Merges (shallow Merge) nextState\" just feels awkward; the rewording has the added bonus of clearifying what shallow means for anyone unfamiliar with the term (intro-to-react api).  That said, I don't have a strong objection here.  @zpao or @spicyj for a final decision here.\n. Yep, let's go with that.\n. If you want to access the event properties in an asynchronous way, you should call event.persist() on the event, which will remove the synthetic event from the pool and allow references to the event to be retained by user code.\n. Overall I think this is a good change, cleans up the verbiage.  Maybe \"and\" instead of \"or\"?  I'm not super familiar with twitter, but I think the two are slightly different operation and the twitter user would want to do both?  @zpao or @spicyj may have thoughts.\n. Everything was green.\n. The name is different, but this is effectively the same as Object.create, so this is just re-introducing the polyfill.  We want to use ES6 classes instead as per https://github.com/facebook/react/issues/4189#issuecomment-120479693\n. semantics, but let's call this publicInstance or publicComponentInstance instead of componentInstance.  The problem is that the component variable passed in is technically also a componentInstance (just, it's the internal one).\n. I'm a huge fan of having things fail really hard, but the common consensus among the javascript community is that things should attempt to fail softly when possible (we're outnumbered!).  We can just warn and not set/fire the ref in this case, so that seems more appropriate than crashing the app.  The app may still crash elsewhere as a result, but some apps may be able to continue with minimal disruption.\n. @sebmarkbage was the one who proposed using an ES6 class here, I'll let him make the final call here.\n. Yeah, would be good to give as much context as possible also.\n\nStateless function components cannot be given refs (see ChildComponentName created by OwnerComponentName). Attempts to access this ref will fail.\n. Ok, sounds good.  I think it's worth having an example that uses the ES5 syntax, since it's more familiar to people and ES6 isn't widely supported, but I just added an ES6 example to go alongside.\n. Done.\n. Was just using the original, fixed.\n. Maybe:\nvar node = getNodeIfCached(id);\nif(node) return node;\nelse return nodeCache[id] = ReactMount.findReactNodeByID(id);\nAt the very least that saves an object lookup (object lookups are surprisingly expensive in javascript).  It also reads a little better IMO.\n. Haha, \"very special\" was from the original doc, but yeah, I agree with you.  It's just special :).  I'll change it.\n. Thanks for catching typo!\nWith regards to React.render -> ReactDOM.render, I think we should hold off on that change since the link destination says React.render() and we should be consistent to avoid confusion.\n. Haha, one space for proportional fonts and two spaces for monospace fonts leaves it ambiguous what to do when you're writing .md which will turn into HTML.  I went ahead and changed this file to single-space, though we aren't exactly consistent throughout the rest of our docs :).\n. Done.\n. Sebastian wanted a \"memorable quote\" that would have impact in people's minds.  @sebmarkbage do you still like this line or should we remove it?  Perhaps:\n\nRather than calling ReactDOM.render() directly, consider writing/using a library that will manage mounting and unmounting within your application.\n. How about:\nIf you are rendering React components within a single-page-app, you may need to plug into the app's view lifecycle to ensure your app will invoke unmountComponentAtNode at the appropriate time.  React will not automatically clean up a tree. You need to manually call:\n. Is there a reason to not be more descriptive here?  The longer variable name doesn't detract from anything, but it is slightly less mysterious.  We know what a \"container\" is, but reminding a relatively new user that it's a DOM node they can mount into seems mildly useful.  Don't feel super strongly either way, let me know if you still want it changed.\n. I actually like the last sentence.  We don't say anything about it explicitly, but I think it leads people to take that next step.  Once you read it, it's like \"oh yeah, that's pretty cool!  I could do that!\"\n. I'm not sure that's sufficient.  If I were a new user, I would think to myself \"react is a javascript library, and javascript is object oriented\" and then wonder what that sentence was trying to say.  Even if I did figure out that the author was trying to draw a contrast, the sentence doesn't explain why the developer should care, and therefore doesn't transition to the next thought.\n\nMaybe:\n\nIn object-oriented programming, all state lives on each object instance and you apply changes incrementally by mutating that state, one piece at a time.  If you are using React within an app that expects an object oriented API (for instance, if you are building a custom web component using React), it might be surprising/confusing to a user that setting a single property would wipe out all the other properties on your component.\n. Removed dots, added checked link.\n\nDidn't want to put the warnings in LinkedValueUtils because I'm expecting that that class will be used in the addons/wrapper for anyone who wants to reuse the valuelink behavior in their apps/components, and they won't want to see the warning.\n. This should go into the if(__DEV__) check above.  We only fire warnings in dev mode.\n. We probably don't need to be checking valueLink, since that is going to be deprecated in 0.15 anyway.\n. We don't generally put links to the github issues in the source.  It clutters up the code, and it's easy enough to find the issue in github.\n. We should assert that the console.error contains the expected error message.  See how I did this in https://github.com/facebook/react/pull/5032/files\n. I don't think we should downplay the prebuilt browser builds.  I think they're as important (perhaps more important) than the NPM modules.  They should certainly be on the same footing.\n. I don't think we should downplay the prebuilt browser builds.  I think they're as important (perhaps more important) than the NPM modules.  They should certainly be on the same footing.\n. We should link to the react docs for details (specifically, reusable-components#stateless-functions)\n. I'd be tempted to take out both these examples and let people see the docs.  But if we want to have examples, we should have at least one ES5 example since that's what browsers run.\n. Maybe I'm missing something, but this line looks suspicious to me.  Is the boolean of a string ever falsey?\n. Moved the links into the description.\n. We usually warn for a release without a functionality change, and then change functionality the release after.  The reason being: if we are emitting warnings, users probably won't/shouldn't be using the \"feature\" that we are warning for (ie. they need to avoid the feature in order to avoid the warning).  For this reason, users won't benefit from the functionality change this release, so we might as well forestall the functionality change until they would actually be able to use it (so as to avoid breaking their apps when they update React versions).\n. We should probably take in a component name, since some components will be stateless and won't have instances but should still have names (I think).\n. Linter requires trailing comma.  You can run the linter by executing npm run lint\n. Yes, removing the return statement and adjusting the docs sounds good.\n. Eeeh, now I'm having mixed feelings about this one.  If we're going to make a change, we might as well add the name of the current component in addition to the owner component (to provide more context).  So directly passing in something like component._currentElement._owner.getName() and component.._tag.  We could do that, but it also means wiring it through createMarkupForStyles and I'm not sure it's worth it at this point.\nIn a perfect world, we would have the full path, which would require merging https://github.com/facebook/react/pull/5167 first, but we need to decide on the fate of that PR before we can merge it, and it might not be worth delaying this PR even longer.\nI'm tempted to say that this is fine for now, and we can make it better after https://github.com/facebook/react/pull/5167.  Unless @spicyj wants it changed now (or unless we merge https://github.com/facebook/react/pull/5167 real fast), my intuition is that maybe you just ignore this comment and we deal with stateless components and/or giving the full parent path when those things actually happen.\n. Is this line correct?  It is conflating the owner name with the element type, which feels wrong to me.\nI think we actually do want to print both pieces of information (the owner if it exists, and the current element's tag) in the error message.  Something like a %s tag (owner: %s) was passed a numeric string value for CSS property%s(value: %s) which will be treated as a unitless number in a future version of React.\n. I don't think this check is enough; we should not fire the warning if the string already contains the 'px' at the end.  Or actually, it might not always be px (could be 'em' or something).  We should only print the warning if the string value can be parsed as an integer.\n. We should only append 'px' if the value can be parsed as an integer.  If they specify units, we should honor those units to avoid printing '5pxpx' or '5empx' which would make no sense.  We can make that change in 0.15 (ie. now), since it should break any old code since presumably no one is doing that yet (because the old code would break).\n. There is a missing \" or \" between component and undefined\n. \" or \"\n. @thomasp9 Would like to start closing out PRs like this.  Did you want to update this PR to fix the zugrundeliegenden typo and then we can merge, or should we close this PR, or is it fine as-is,, or how do you want to handle this?\n. If you already have the branch checked out, you can just make the change and use git commit --amend to update the old commit.  (If you don't have it checked out, look at https://help.github.com/articles/checking-out-pull-requests-locally/)\nThen you can use git push -f to forcefully update the branch.\n. Comment still says IE9, despite documentMode being changed below.\n. @syranide Prior to this change, this code path targeted IE8 and IE9.  This change makes IE10 and IE11 also follow the same code path.  IE11 does not have attachEvent which is why this is reachable.  See https://github.com/facebook/react/pull/3826#issuecomment-109784848 for context.\n. If there never is, then maybe there is no harm?  I suppose I'd be fine either way, doesn't really matter to me, hard to tell when future proofing is beneficial/detrimental.  @syranide let me know if you have a strongly preferred solution here.  Maybe @spicyj has a strong feeling on this topic?\n. Maybe https://github.com/facebook/react/pull/4051/files#r36645968 ?\n. I'll defer to @jquense ; Jason, thoughts?\n. Styles may be unitless if they are integers, but strings must specify units if required (unitless strings may fire a warning).  This looks fine to me.\n. I'm skeptical this would work.  I think there is a single ReactDefaultPerf shared for all components; you are setting this field as a static field without regard to the current component.\n. Yeah, I agree, that would be better.  @drdelambre Would you mind updating this diff?\n. No idea.  Presumably I wouldn't have made it if it wasn't necessary, but I don't see the reason for it and it passes unit tests as null so I'll go ahead and remove it.\n. If someone is debugging, just saying \"Mutated props not allowed in...\" doesn't really describe what's wrong.  Someone who is writing a moderately complex component might not see what the issue is.\nI would say something like \"Constructor (of %s) may not invoke super(...) with props that differ from the props that were initially passed in from the component's owner.\"\n. Nit: Move the \"var\" down here to constrict the scope of propsMutated.\n. Because it's more inline with our facebook style, it gives linters an opportunity to catch more errors, and it minimizes the number of variables that a developer needs to keep in their mental working set.\n. We're slowly transitioning to ES6.  You'll notice that ES6 syntaxes have been appearing in the docs too; most of the new stuff uses ES6.\n. I'm fine with @spicyj's suggestion.\n. @zpao I tend to agree with @MattijsKneppers here - I'd rather that the examples be clear.  I also ran into this issue, but looking at the source I quickly figured out what was wrong and ran the webserver from the correct directory - but it might not be as obvious to some new users.  Having some better usage instructions in the html seems like a harmless enhancement.\nIf you want to have super strong consistency, we could add the instructions to all the files, though that seems wholly unnecessary since many of the files don't actually require a web server.\n. Yeah, newline after the pren is more inline with our fb style.\n. yes please.\n. Usually we recommend that component state be stored using this.setState() because that ensures that a rerender will be triggered and the component's rendered value will always equal the component's internal state.\n. Ok, works for me.  :+1: \n. eeh, I don't like \"functional component\", it makes it sound like other components aren't functional :P.\n. :+1: \n. ...so I guess my question is: is there a different term we could use in this diff?\nPerhaps \"stateless functional components\" as people on the internets have been calling them.  \"stateless component\" sounds better to me than \"functional component\", but if you want to change it, maybe we can find another name?\n. Is this different from ATTRIBUTE_NAME_CHAR?  Should that variable be shared?\n. Idk, I'd probably put it into HTMLDOMPropertyConfig (since it feels sort of config like).  DOMPropertyOperations can then require HTMLDOMPropertyConfig.ATTRIBUTE_NAME_CHAR.\ncc @spicyj for thoughts\n. :+1: \n. Make a private variable (local to the module) that is not exported called ATTRIBUTE_NAME_START_CHAR, and include that variable in the object that gets exported.  Then you can include the private variable in the sum.\n. Perf was my initial reaction too, but if I understand this code correctly, that check is already dev only.\n. SECRET_DO_NOT_USE_OR_YOU_WILL_BE_FIRED made sense when we were migrating and you really would break stuff.  But if we're adding this as an explicit hook to allow various environments, it shouldn't be a severe variable name (IMHO) - Or if this is just for the 0.14.3 update, perhaps it makes sense.  cc @zpao @spicyj for thoughts.\n. Yeah, I think I agree, we don't need any of the actualDOMAnchorNode stuff.  But I didn't want to confuse the diff by modifying test logic unnecessarily.\n. setState does not work there.  Among other things, we rollback the transaction after calling handleError.  I'll try to figure out a way to make it work before merging.\n. Should note that known DOM tags use className and htmlFor but custom elements (aka. web components) must use class and for directly.  Example: <my-tag class=\"foo\" />\n(PS: In case you're curious as to the reason, it's because custom elements can have arbitrary attributes, so we can't intelligently do attribute-name rewriting).\n. Nit: We could probably move this line into the two if statements below, immediately above the console.debug.  Keeping it closer to the console.debug makes the code easier to read, since that's the only place it's used.\n(also makes the code a microsecond faster, in the case where we don't end up printing the message, not that it's a huge difference :P; readability is the primary factor here)\n. Yeah.  I don't have a strong opinion one way or the other, but it does seem reasonable to have a note about it here, since it is a valid dom-difference.  Unless Ben or Paul feel otherwise, I'd be tempted to accept/merge a note about this (with the nuance mentioned above).\n. Actually, I think the original document is already correct; I think this diff makes it wrong.  The sentence is referring to things like a checkbox input, which supports defaultChecked.\nIt might be worth clarifying, maybe something like:\n\nLikewise, <input type=\"checkbox\"> supports defaultChecked, and the <select> component supports defaultValue.\n. We already have an example of setting proptypes above.  Let's just keep this as a simple note:\nHowever, you may still specify .propTypes and .defaultProps by setting them as properties on the function, just as you would set them on an ES6 class.\n\nAnd then we can skip the example below, since another example bloats the page and doesn't add a whole lot of value given the equivilant example above.\n. It was clearly just a typographical error, and the fix clearly doesn't change the meaning of the sentence.  I agree it's not worth investing a ton of effort in fixing up old blog posts, but if the work is already done and the fix is simple, and the correction makes the original author look good... I figured we might as well take it.\nI make typos all the time, and if someone corrected them when quoting me, so long as they were careful not to change the meaning of my sentence, I would appriciate the correction.\nIn my opinion, the key here is \"what would the original author say?\".  Fortunately, we can ask him.  cc @toddself\n. Done.  https://github.com/codemirror/CodeMirror/pull/3704\n. :+1:  Haha, that's true, but it's an old blog post that preserves the community's thoughts of the time.  Sounds almost like @toddself may be advocating for an even more aggressive change, like adding an [[UPDATE]] note of some sort (that would be a larger and orthogonal discussion).  \nAssuming we decide to keep the post in our archives, @toddself, do you approve of the correction or would you prefer we keep the incorrect spelling?\n. Just removed them, as per conversation, we can figure out how to expose them later.\n. I was hedging a bit, because I didn't want to say \"ALL\".  I don't know of any legitimate use cases.\nI'll change it to be less hedgy.\n. Correct, it isn't any better from a desirability perspective (except that your code won't break when we delete it), but it is a valid migration strategy, allowing us to remove isMounted from the codebase.  This is the approach we will probably take internally, so it seemed worth mentioning.\n. Most other things are easily cancelable (eg. unsubscribe from a flux store is trivial to figure out).  The problem was promises, which was the edge case that isn't trivially cancelable, which is why we mentioned it.\n. It was mentioned deep in the middle of a long github issue (https://github.com/facebook/react/issues/5465#issuecomment-157888325).  I didn't really want to link there, as it would confuse people.\n. Ok, done.\n. Yeah, I kind of liked that it was one line, but I can reformat.  I think I want to keep the \"this is bad\" comment.  Normally I'd use the red antipattern code boxes that we have internally, but I don't think we have those yet on our public documentation.  I want to make it abundantly clear at a glance that the code should not be copy-pasted into an application.\n. Yeah, I think it's for promise chaining.\n. For instance, because you want to upgrade to ES6 classes, which don't support the function.  Or because you want to start preparing your codebase for when we do delete it, so you have less work to do later.\n. Ok, I don't feel strongly, I'll link to the GH issue.  Fixed.\n. That's why I liked the original first sentence:\n\nAs we move closer to officially deprecating isMounted, it\u2019s worth understanding why the function is an antipattern, and how to write code without the isMounted function.\n\nWould you mind if I put that sentence back?  I think it sets up the intent of the article very well.  The point is to get people to start avoiding isMounted, and teach them about the why and how.\n\nOk, I added a codeblock above that demonstrates how to unsubscribe from a datastore.\n. ...automatically by React after a component...\n\"when\" is ambiguous (before? during? after?).\n. By definition, they should both have the same lifespan.\n. https://fb.me/react-special-props\n. We generally use fb.me urls that point to gists.  I created one for you to use: https://fb.me/react-special-props\n. We probably want to deduplicate, such that the warning only appears once.  Otherwise, the user's dev console is going to be filled with this warning.\n. Yeah, correct as-is.  \"...all the components\" is plural. \"need\" is plural and \"needs\" is singular. Could be \"all components need\" or \"a component needs\", but not \"all components needs\".\n. There is no guarantee that componentWillReceiveProps is called only when props change.  The only guarantee is that componentWillReceiveProps will be called if props change.\n. This is a little weird.  Why are you using Parent.ChildWithoutContext instead of ChildWithoutContext?\n. I want to make this point about it being incorrect abundantly clear, since people seem to make this assumption even after they are explicitly told that there is no guarantee that props have changed.\nBTW, all sentences in the entire site should be interpreted logically; people should be careful in their parsing of all documentation.  We work very hard to ensure that the documentation is as precise as possible, often spending hours nitpicking the choice of only a few words.  I'll deemphasize the incorrectness to avoid hurting people's feelings, but I do want to call out the fact that it's a common mistake.\n. https://www.google.com/webhp?sourceid=chrome-instant&ion=1&espv=2&ie=UTF-8#q=define%3Anewbie\n\nnewbie - noun - an inexperienced newcomer to a particular activity.\n\nSeems like the perfect word, though admittedly a little informal.  But I don't feel strongly, so I'll change it :P.\n. The example is using a standard mutable javascript object, for which this is the only solution.  As per the first two sentences of that bullet point, we are clearly talking about mutable inputs (not immutable).  It's the only possible solution for the framework, under current framework/language constraints.\nI think it's reasonable to keep this as-is.\n. Yep, that's better.  Fixed.\n. I don't think the isNaN(value) && ('' + value) === 'NaN' is correct.  For instance, the string \"NaN\" would pass that check, I believe.\nYou probably want to use Number.isNaN() or one of the polyfills listed in the docs:\nhttps://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/isNaN\n. This will bail out if any of the styles are NaN, but I don't think that's what we want.  For instance, suppose one of the styles is NaN but the other style was mutated.  In such a case, we want to display the mutation warning for the style that was mutated, and just skip the NaN.\n. It might not be immediately obvious to a user that we're talking about css styles here, it might be good to mention that it's a css style.  Also, I'm not sure any of our other warnings end in a question mark.  Maybe something like:\n\nNaN is an invalid value for the fontSize css style property\n. I feel like we probably shouldn't be modifying the user's input object.  cc @sebmarkbage @spicyj \n. Number is not being imported at the top of this file.  I think you'll need to create a Number polyfill module (ie. just copy-paste the one from the MDN docs) and import it in order to support legacy browsers.\n. I still feel like we probably shouldn't be modifying the argument.\n\nThis is a dev-only code path, so maybe we copy the object and mutate the copy.  Or maybe we fork shallowEqual to have the logic we want with regards to NaN in this case.  Or maybe there is another option/thought.\ncc @sebmarkbage @spicyj\n. Thanks @syranide , I agree, that's better.\n@jontewks Let's get rid of the changes to this file.  We can fix shallowEqual separately, since that's in a different repository.\n. TODO: @zpao what is the correct copyright header here?\n. ReactDOM.render returns the DOM node; you don't need to call findDOMNode\n. Same, no need for these findDOMNode calls, ReactDOM.render returns the DOM node.\nThere are a bunch of these in this diff, please do ctrl-f to find them and clean them up.\n. I feel like controlled inputs should not take in a defaultValue - that should be illegal.  In a controlled world, a button type=reset should have no effect.  To reset a controlled component, the click handler of the reset button should update application state.  It makes no sense to have both value and defaultValue specified.\nFiled https://github.com/facebook/react/issues/5819\n. The behavior here is technically \"undefined\".  Emitting a warning in this case would be ideal, but perhaps that's a different diff.\nFiled: https://github.com/facebook/react/issues/5821\n. I actually want to move the warnings out into a separate module eventually (using devtools api), so if we move it to CSSPropertyOperations, I would just have to move it back here later.  I think it's fine to leave it here, since then this is testing public api instead of internal API, which is better anyway.\n. The advantage to not inlining is readability, since otherwise if(value !== value) has an incredibly obscure behavior.  Easy to have a 3am WTF when your eyes are tired and brain is in low-power mode.  I don't feel strongly, so if you want it inlined, that's fine with me.\n. Not all of them: https://github.com/facebook/react/pull/5590/files\n. The first sentence in this error message makes it sound like neither of the props should be specified.  It says \"both... props... should not be specified\".  Alternative wording:\n\nInput elements must be either controlled or uncontrolled (specify either the value prop, or the defaultValue prop, but not both).  Decide between using a controlled or uncontrolled input and remove one of these props.  More info: https://fb.me/react-controlled-components\n. FTR: This is also a single child, not an array of children.  This is a single child that happens to have it's own child.\n. Yeah.\n. The code was already correct as-is.  The sel is referring to the variable name that is a parameter to the function.  You can see this pattern throughout the inline docs: https://github.com/facebook/react/blob/3b96650e39ddda5ba49245713ef16dbc52d25e9e/src/renderers/dom/client/ReactMount.js#L88-L91\n. :+1: \n. If type=\"checkbox\" then the controlled component would use the checked prop instead of the value prop.\n. checked is also valid for radio.  We probably shouldn't be branching based on props.type.  I think we can just do controlled = props.checked !== undefined || props.value != undefined\n. We should probably add a boolean so we only emit the warning once (otherwise the user's logs might fill up with this message).\n. It is a little weird for this to be false (a boolean) or an object.  Maybe rename the variable and use null instead of false?\n. We generally stick to warn-once where possible/practical, because otherwise a warning that fires often can drown out a warning that only fires infrequently (which results in people not seeing the less-frequent warning).\n\nLet's add a global boolean instead of using _serverSideRendered, since the latter will be thrown away each render.\n. Let's explicitly add a return statement here.  This is a getter, so we should return a value, and it makes the expected behavior a little more clear.  Same with the getter for ref.\n. It feels unfortunate that this runs in production, @spicyj do we care?\n. just created https://github.com/facebook/react/issues/5944\n. This is reading directly from the node (during a write phase?).  Is this going to cause dom thrash?  @spicyj @syranide \n. I'm not super familiar with this code, why did this line change?  That is to say: what is the difference between hidden and hidden.bs.modal, and how do we know which one is correct?\n. Let's just wrap this in a DEV block for now.\n. Can you put the first \"value\" into backticks (value).\n. null is no longer a legal value for uncontrolled inputs.  Setting value to null will emit a warning.  Let's just remove the parenthetical.\n. This sentence parses funny to me.  Perhaps we change it to something like:\n\nSaying that a component is Controlled means it doesn't maintain its own internal state; the component renders purely based on props.\n. Missing space between \"controlled(or\"\n. Same, missing space\n. Can we also specify the type of the input (checkbox/radio/etc).  We can just print the props.type to do that.\n. This is wrong, because setting the value to undefined SHOULD change the element if the prop was set to a non-default value when the element was created.  The desired behavior would be to use the prop's default value.\n. We probably don't need to introduce a loop here, since we know the only way this could happen is if the config prop is undefined.  We can just add an undefined check to the existing loop above.\n. && defaultProps !== undefined\n. We are doing an extra/unnecessary allocation here, which creates extra gc pressure.  See below.\n. How about:\nWhen creating an element using JSX, the type of the children prop will often be a string (text), a ReactElement (single child node), or an array (multiple children).  Dealing with this union type can be tricky, so React provides a collection of optional helper functions for use with this.props.children.\n\nOtherwise, I'm left wondering \"what is this mysterious children data structure?  Where does it come from?  Where is that documented?\".\n. I would just ditch this note.  I don't think it adds anything useful (beyond what I wrote above), and it opens a whole other can of worms.  For example, you didn't mention Symbol - was that intentional?  You said it could be an iterable containing React nodes... So when I do <Foo children={new myIterable(...)} /> will React.children.map(Foo.props.children) have a single element (the iterable) or will it map over all the values in the iterable (I could make the argument either way, it's really not clear which behavior is correct).\n. We should still assert the warnings here.  The reason being that we want to know if we start emitting some unexpected warnings.  Right now, this test just swallows all warnings.\n. coma between \"around\" and \"use\"\n. This codepath is a production codepath, so I was thinking we should avoid doing string concatenation unnecessarily.  If we want to avoid the concatenation, we can only have \"componentWillUnmount\" or the component name, but not both, right?  I don't feel strongly, I'd be happy to do any of the three (concat, functionName, className), just let me know which.  We could also fix in a followup if we decide it would be necessary/helpful.\n. Ok, fixed.\n. You can't put a Symbol into the DOM, but I don't see any reason why it's an invalid value for the children prop.  It's \"just another prop\" (according to Sebastian).  But you didn't list it on the set of possible values for children.\n. Yes, I agree, but if we're going to be precise and expose it as non-opaque, we might want to break it out into a different section (ie. a section on \"The children type in JSX\").  If we are claiming it's non-opaque, we should describe the behaviors in detail.  What happens if you pass an iterable, for instance?\n. This seems reasonable to me.  We don't need to check the value of pendingUpdate, we can just blindly set it to true.  Can you update the PR to remove that check?\n. We can move this up out of the GroceryList component/function, and have it accept both props and index.  That saves us an allocation on each render, which reduces GC pressure, and is therefore probably a better practice for stateless function components.\n. Translation lost?\n. lost translation.\n. props.items?  I think items is undefined.\n. props.items?  I think items is undefined here, right?\n. I think all these are fine, just noting this to myself (or others) because it's a potential change in the behavior of this class, but I don't think it has any impact on the overall program behavior.\n. A better name would be isProxySupported.\n. How about \"inst The instance, which is the source of events\".  Similarly for the others in this file, the previously proposed wording is confusing.\n. I was told (a while ago) by Sebastian to prefer multiple explicit args rather than using the arguments variable, because it avoids an array allocation, and jsperf (http://jsperf.com/asdfewgerge/2) agrees with him.\n. There is only ever one debug tool.  A debug tool doesn't (necessarily) have the overhead of emitting events, so it is suitable for collecting ultra-accurate performance metrics.\nThe default debug tool is an event emitter, into which you can plug dev tools.\nA dev tool is something that is not performance critical.  Things like emitting warnings, high-level performance metrics, interactive chrome extensions, etc.  You want to maintain good performance, but you're willing to eat the cost of event delegation for the purposes of a slightly better API (ie. the ability to have multiple devtools at the same time, functions you don't implement are ignored, errors thrown in a devtool don't take down the app, etc).\n. Correct, my guess is that devtools would only work in dev mode, but it's an easy thing to change if we change our minds.\n. I think Sebastian was thinking about creating a third build called \"profile\", which follows all the \"production\" codepaths with the exception of having debugtool enabled.\n. Yes, eventually.  Right now it's controlled by __DEV__, and is not as simple as just replacing all __DEV__s with a feature flag for reasons around dead code elimination.\n. We are going to need a debug tool specific to each renderer.  Does it make sense to also have a shared isomorphic ReactDebugTool for just a few lifecycle mehods?  Especially when some of the lifecycles may not exist for some renderers (eg. ServerSideRendering, if/when that gets split out).  Intuitively, it feels simpler/cleaner if all the debug tools just always live in the individual renderers.\n. Ok, I have no strong objections.  I think it's a little unfortunate to have two places to install the subtally-different debug tools, which is my main complaint, but I'm willing to defer to @sebmarkbage.\n. Makes the antecedent a bit more ambiguous (React vs. ReactLink), but I suppose the sentence is true regardless of which antecedent is chosen.  However, we could probably just blow away the qualifier.  Or better yet, just convert it into a deprecation note:\n\nReactLink is deprecated as of React v15.  The recommendation is to explicitly set the value and change handler, instead of using ReactLink.\n. This message seems to imply that what the user passed in was an element.  'div' is not an element, it is a string.  Perhaps \"Instead of passing a string like 'div', ...\"\n. setImmediate shouldn't be used, since it means we will never be able to run these tests in a real browser.  https://developer.mozilla.org/en-US/docs/Web/API/Window/setImmediate\n\nConsider setTimeout instead.\n. Maybe https://facebook.github.io/jest/docs/api.html#jest-dontmock-modulename ?\ncc @cpojer \n. Probably don't want to attach this to ReactCurrentOwner, since it has nothing to do with owners.  But conceptually, yes, we want to set some sort of value when we start a getChildContext.\nI think it probably makes sense to use the new devtools api here.  You can emit an event when you start/end getting the child context, and keep the state in a devtool instead of tying it into the core.  Devtool api details: https://github.com/facebook/react/pull/5590/files\n. Bad to have an API that is null or true.  If it is a boolean api, all values should be booleans.\n. boolean is a type.  A good variable name would be something like isPprocessingChildContext.  But why does this variable exist at all?  Isn't it always true in this function and always false in the other?\n. Should set a scope-local variable on the devtool, not warn and/or set variables on the instance.\n. Should set a scope-local variable on the devtool, not warn and/or set variables on the instance.\n. Should emit a setState event, warn within the devtool.\n. This seems like a weird place to define a polyfill.  Seems like we should do something more analogous to https://github.com/facebook/react/blob/master/src/shared/stubs/Object.assign.js\n. Normally we would just do require('ReactInvalidSetStateWarningDevTool'), so this seems weird.  I'm assuming you did this because require('ReactInvalidSetStateWarningDevTool') didn't work for you because you didn't have an @providesModule at the top of that file.\nIf you add the standard copyright header to ReactInvalidSetStateWarningDevTool.js and specify the @providesModule, we should be able to fix this line.\n. What is going on here?  Why this change?\n. Ok, well, we still need to fix so the original test passes.\n. Should wrap this in a __DEV__ block.\n. do not use typeof when comparing to undefined.  Prefer spec === undefined\n. If we're doing this, we might as well add checks for anything that is not an object.  So maybe we just wrap the whole thing in a if(typeof spec !== 'object'){...} and print the type in the error message.\n. What is || typeofSpec === null protecting against?\n. Why is this ternary operator here?  What value does it add over just typeofSpec?\n. Also, I think the typeofSpec !== 'object' check here might be backwards.  Warning behaves the opposite of an if statement, if I recall correctly.  We should probably add a couple of unit tests to verify behavior.\n. Let's just add another var statement, put a semicolon on the previous line.\n. To avoid lint error: var Something = function(){};\n. How about:\n\n.displayName or .name may be used as the name of the component within debug messages.\n\nRemoves \" (in that order)\" and replaces \"will\" with \"may\".  The reason being that we are also going to start pulling name info from the jsx source transform, so we don't want to be making guarantees about how component names are derived.\n. Let's say \"miscapitalize\" instead of \"mistype\"; it's a little more clear.\n. This typecheck seems wrong to me.  To detect improper capitalization, I feel like you need to normalize both sides (eg. send both of them toLowerCase).  I think this code as-is will only catch the case where the user happens to use all lowercase.\n. Sorry, it is not obvious to me why this code is dead.  Can you elaborate?\nUnless I'm mistaken... It is possible that the component rendered a <div /> last cycle, and is rendering null this cycle, in which case I think _pendingElement would be null and _currentElement would not be null.\n. Ah, ic, thanks!\n. Can you add an extra newline before and after Example using ES6 class syntax:?  To be consistent with the previous Example:.  Some markdown parsers don't like having the code block immediately following text.\n. Not a deal breaker, but seems a bit weird that warnedSVGAttributes gets set to true even if a warning never fired (ie. bailed out in the next three lines).  Maybe a few of these lines can be re-arranged to avoid this, maybe not worth the headache.\n. This is correct, but a little subtle.  Usually the way we solve this is to have a second invocation of ReactDOM.render.  It's not immediately obvious that the second rect tag is adding anything; I could easily see someone going through the code and \"cleaning it up\".  But again, this is correct and this nit may not be worth fixing, just something to keep in mind in the future I suppose.\n. :+1: \n. Isn't \"\u94b1\" the character for \"Money\"?  Just wanted to confirm that this doesn't say \"Money rendering is an experimental feature\"?\n. The indentation here is not consistent with the rest of our code.\n. This event seems awfully specific.  By firing more general events, we are able to expose an API that can be used for all sorts of devtools (even use cases we haven't though of yet).  I think I'd rather have an event that fires onCreateChainableTypeChecker.  The if (props[propName] == null) { can be replicated in the devtool.\n. should be whitespace surrounding !==\n. whitespace surrounding ===.\n. Yeah, that example was literally just moved verbatim from the existing tooling-integration page.  I don't feel strongly though, so I'll change it.\n. Thanks!\n. Users can use onFocus in leu of onFocusIn because the React variant bubbles.  We actually deviate from the standard here, so it's more than just \"normalization across browsers\".\nPerhaps:\n\nReact uses onFocus and onBlur instead of onFocusIn and onFocusOut.  All React events are normalized to bubble, so onFocusIn and onFocusOut are not needed/supported by React.\n. ?\n. As mentioned in the other PR, I don't feel quite comfortable with that link / lesson plan, for reasons mentioned here: https://github.com/facebook/react/pull/6332#issuecomment-200985826\n\nThe badge its self (unlinked) could be ok.  Or we could link it to a gist that describes the React-specific notes about how we manage pull requests.\n. I'd be fine with this if we link it to https://github.com/facebook/react/blob/master/CONTRIBUTING.md for now.  We can find a different/better destination later.\n. Should be the full path to the page: https://github.com/facebook/react/blob/master/CONTRIBUTING.md#pull-requests\n. Why are you removing the devtool?  This appears to be going in the wrong/opposite direction.\n. Ok, will fix, but just FYI, this was taken verbatim from the original documentation.\n. This line is the main one that concerns me.  It seems like this call should be inside createMarkupForProperty such that it gets invoked whenever anyone calls it will get the onCreateMarkupForProperty event.  However, we should not be passing the element to createMarkupForProperty.\nThus, why this PR is difficult, thus my comments in https://github.com/facebook/react/issues/6062#issuecomment-185528241 and https://github.com/facebook/react/issues/6062#issuecomment-185535439\n. For the purposes of getting a reference to the root node, I think they're both semantically equivilant.  The optional callback was introduced before callback refs were a thing.  For consistency, I think we would want to teach refs as the standard way of getting a reference to an instance.\nHowever, callback refs and the optional callback are not identical with regards to their other semantics.  The optional callback will be fired when the render completes, whereas the callback ref will only be fired when a component mounts/unmounts.  So their behavior is the same for initial mount, but different for updates.  Realistically, now that we have callback refs, the optional callback probably isn't very useful, but there are still some potential use cases if you wanted to know when a particular update/render has fully completed.\n. Already mentioned here: https://github.com/facebook/react/pull/5680#issuecomment-165274589, resolution was that HAS_SIDE_EFFECTS can be handled as a followup PR.\n. I don't want to use the word \"deprecating\" because we have a policy that we only mark something as \"deprecated\" when it's removal is imminent for the next release.  But I do like your additional explanation, so I'll work that into the message.\n. I think we need a null check here, because selectParent could be null at this point, right?\n. You don't need to do a findDOMNode here.  The value returned by render is the node, so var node = ReactDOM.render(stub, container); is sufficient.\n. Hmm, the issue here is that the return type isn't technically void (though it would be good if people treated it that way).\n. I want to leave it open to other traspilers/languages.  How about \"describes how to set up tools like Babel to transpile JSX for a better development experience.\"\n. Inserting a placeholder is an implementation detail, not something guaranteed by React.  I think my initial approach was to unmount safely first, but the issue is that you need to unmount the children but not the parent, in which case the parent's state is wrong, and the whole thing just starts introducing complicated branching logic and introducing a lot of surface area for bugs.  Rendering to null was much cleaner.\n. It's still a problem; :%s/transferPropsTo/the spread operator/g.\n. The problem is that this error message doesn't specify the line number, as per the last sentence of my comment in https://github.com/facebook/react/pull/6459#issuecomment-207506815\n. Let's capitalize the 'k' to become KeyEscapeUtils.  The reason being that we capitalize classes (an object full of methods is basically a class) and reserve lowercase for function names.\n. Same, capitalize the 'k' to become KeyEscapeUtils\n. Can you explain this line?  Maybe I'm just tired and not understanding, but I would have expected some sort of a check for a '$' symbol.  I think the first character could be a dot, but the next character not be a $, if we're using auto-generated keys (eg. for array).  We should triple check that this will always do exactly the inverse of escape.\n. Most of our lists are alphabetical; Paul likes consistency.\n. Well, you do like consistency and alphabetization.  You've called me out many times for not alphabetizing.  But ok, will reorder (https://github.com/facebook/react/pull/6517).  \ud83d\udc4d \n. I think we should have a comments indicating where this file can be downloaded, because we don't put the react-dom-server.js build on the downloads page so it's not obvious where to get that file.\n. Might as well have a link here too, for consistency.\n. \ud83d\udc4d \n. I assume you're referring to changing \"defining stateless components as functions\".\nI have no objections.  To be clear, class components can also be \"stateless\" and therefore technically match the term \"stateless components\", but I don't think that makes your version incorrect.\n. We generally prefer string concatenation instead of template literals.\n. 1.  I was wondering why the note was bold :P.  Fixed the boldness.\n2.  Eeh, ok, fixed.\n3.  Not really.  I think it's pretty clear that Enzyme stands out as a frontrunner (in the context of React).  Did another framework jump out as particularly noteworthy to you?\n4.  Fixed.\n. I don't think we want to say things like \"as it is running fine in its current form.\" because this statement could become untrue at any time and without notice.  In fact, we might not even notice that we broke it, in which case we'd certainly forget to come back and update the docs.  The blog post did a pretty good job of explaining our position, and I generally think that's sufficient.  We generally don't get a lot of questions about this, so I'd say we should just leave it as-is.\n. This file is auto-generated and does not need to be modified.\n. This will work for primitive DOM components (string type), but will print some ugly nastyness for composite components (function type).  There is some standard code/incantation to get the type/name of an element, should find it and apply it here.\n. Perhaps \"Client rendered a node, but server did not\".  The message \"Added a child node.\" is intensely ambiguous to me, as a user, reading the message.  I know we print the other info associated with the event, but I still think the message could be more descriptive here.\n. Again, I'd make the message something more stand-alone.  Perhaps \"Server rendered a node that the client didn't render\"?  Similarly for the other messages.\nThe jsdocs that you have above each method are great.  You can put the same text into the error messages :).\n. Sorry, why does a node array of length 2 imply that it is a blank text node?  Why does it being an array imply that it is a text node?  I feel like this logic conflicts with the jsdocs/description above.\n. Why did this line change?  I don't understand what we're trying to accomplish here.\n. The default value for elementToRenderOnClient probably doesn't make sense here.  If elementToRenderOnClient is undefined, we might want to just throw.  We should never expect a markup mismatch when elementToRenderOnClient === elementToRenderOnServer\n. Yes, I think the ideal behavior is to fire an onChange as soon as we've mounted.  But that's a behavior change, so let's punt on it until a future PR.  For now, we'll just retain the old behavior.\n. Maybe getRenderedComponentsFromDomNode()?  When I see a getChildren function, I assume the return value is going to match node.children.  But this structure is more specific to the way React renders children.  I don't feel strongly.\n. \"array of DOM nodes to reuse.\".  As per previous discussion, let's fix up the wording here to be a little more clear/correct.\n. add the variableName.  Also, this function takes 5 arguments, but only 4 of them are documented.\n. Singular or plural?  (nodes or node)(ToReuse)?\n. Even if it is an array, it represents a single RenderedComponent, correct?\nI guess I don't feel strongly, just wanted to be sure, because nodes implies multiple rendered components (eg. all of a component's children) rather than a single rendered result.  But I understand where you're coming from, so I'll leave it to be your call.\n. This line seems to imply that enqueueUpdate is getting called on a component that does not need to be updated (meets neither of the two conditions above) - which seems bad/wrong.  What am I missing here?\n. \ud83d\udc4d \n. Why does this remove the backticks?\n. As per note in other PR, this file is auto-generated and should not be changed.  Please update the PR such that this file remains unchanged.\n. Sebastian (ideally) wants us to detach at initial mount.\n. This was correct as-is, as per our MD generator.  You should try rendering the docs as described in the README in the docs directory.\n. Yeah, I don't think shallowEqual is going to add a meaningful amount of execution time.  The undefined check adds bytes, which increases download size; it might be a wash.  If we were going to do that check, we should just use nextContext !== undefined instead of doing a typeof and string compare, both of which are slow.\nBut in the interest of simplicity, let's just remove that undefined check.\n. Ok, I filed https://bugs.chromium.org/p/chromium/issues/detail?id=608416\n. Updating comment in code.\n. Ok, I got rid of postUpdateWrapper.  Ran through the tests on Chrome and Firefox again, looks good.\n. Ok, submitted another fiddle that doesn't use React.\n. We generally use the term prop to refer to anything that is passed into an element (eg. using jsx).  I think it's probably fine as-is.\n. Because previously we were processing only non-event properties because we were listening in setValueForProperty or whatever, but now we are just reading off the element so we need to filter out the events ourselves.\n. I believe this fixed the issue because the prop names were being filtered prior to this event firing, which means we only fire this event on props that are \"correct\".  This is a reasonable behavior, because some devtools (eg. perf) might want to know about the DOM operations that are actually being performed, rather than every prop that was specified.  We can re-think how/when those events fire, but that's a much longer discussion.\n. Yeah, I will follow up once this has merged.  But I don't want to make this diff any more complicated (it's taking long enough for people to review already), and git seems to make my life pretty miserable if I try to stack diffs and then changes are requested to the base diff, so I'll wait until after this has merged.\n. Looking into it now.  If not, I'll remove the comment as part of my rebase.\n. When a text input is created, value and defaultValue are attached to each other.  Changing defaultValue results in value being changed.  This line detaches them by setting value.  I think I like both comments, because it makes it abundantly clear that both of these apparent no-ops are intentional.\n. Ah, good call, I read right over that.  Probably an extra 'and'.  \ud83d\udc4d \nWill fix during rebase.\n. \ud83d\udc4d \n. I'd actually even argue that this shouldn't be a part of React's API and should live in a little helper/addon module somewhere on NPM.\n. Looked into it.  Appears that IE9 does indeed get upset if you set textContent to the same value it already had.  But this was totally the wrong place for a comment to be talking about that; applied a hack in setTextContent.js which is a much more appropriate place to deal with this.\n. Not sure.  What happens if you have a contenteditable div with text in it?  I wouldn't be surprised if there were another edge condition where this applied for React reconciliation, independent of text areas.\nBut regardless, it's the wrong place for the comment.  The behavior here shouldn't be dictated by a chain of assumptions where getNativeProps returns a particular value BECAUSE it knows that the reconciler will use the textContent property (as oppose to any other perfectly-valid method) to set the children of the textarea DOM component.  Correct solution is for the reconciler to properly handle this edge case by virtue of the fact that setTextContent properly handles this edge case.\n. Is it worse than copying the values in to a new array?  Happy to change it.\n. ok, fixed.\n. Yep, sounds like that would work too.  Updated PR.\n. I feel like the \"from you\" is what makes this sentence awkward.  With the \"from you\", both sentences read awkwardly.  Without the \"from you\", both versions seem fine.  Maybe the correct fix here is to remove the \"from you\" rather than moving the \"away\".\nThoughts @zpao?\n. Actually, no.  Issue is that setting the checked state (even just temporarily) will wipe out the radio button selections.  We would need to do a post-post-mount.\nSebastian implied that he liked the tmp variable solution better anyway (read, update, restore).\n. cc @hayesgm You wrote this line, why is this necessary?\n. Ok, I don't see how using tmp on update is any grosser/dirtier than using it on initial mount.  Especially since this means we incur unnecessary dom operations for every input instead of just updates to radio buttons.  But if you really like it better, I'll do it your way (unset name, set checked twice, set name) - updating diff now.\n. Ping @hayesgm\n. Done.\n. String refs can't be used at the top level, so it could never be a string ref, but yeah.\n. We will also eventually need a way to render into a container asynchronously.\nWhat about ReactTestUtils.renderAsync() which optionally accepts the second argument (container) or renders into a detached node if no such container exists.\nrenderDetached seems verbose, since 99.99% of the time, you don't care that the node is detached.  You just want to render something.\nWas just an idea.  I truly don't have a strong preference here.  Just let me know in a more definitive way when everyone is done bikeshedding and then I'll do the global replace. \n. @sebmarkbage @spicyj @gaearon  Do you guys want to join the bikeshedding on the function name?\n. innerHTML, onFocusIn, and onFocusOut already emit warnings telling the user not to use them.  Having it also emit this warning is just confusing, so I blacklisted those tags that we already warn about.\n. We won\u2019t use class properties in the docs. We only want to use stable ES2015 syntax. So if we need to bind an event handler, we will do this in the constructor.\n. You can just make this a standard function, and in the constructor say this.handleClick = this.handleClick.bind(this);\n. Yeah, I thought about that.  But if we're always going to pass props, why not context?\nAlso, what's the benefit of passing props, when 95% of the time, you don't need to access props.\nI convinced myself that it was better to only pass them/use when you need them.\n. @sebmarkbage What was the conclusion / final opinion here?  I remember there being a poll, and IIRC, you voted against this pattern.\n. Specifically, I'm referring to doing inline destructuring of the arguments.  But I suppose that was in the context of default props.\n. You shouldn't need to branch.  Just pass in the element as the argument.  You can get the element off the instance by using instance._currentElement\n. Let's change this to:\nfunction MyComponent() {\n  return ...;\n}\nbecause the syntax es5 is likely more familiar to new users, and has better compatibility across browsers.\n. This will need to be an ES6 class, because the ref needs to be attached to the this object.\n. @roganov is correct, but let's just use an es5 function for this component.  It is more familiar to newbies coming to React.\n. Eeh, setting margin to a unitless 16 felt weird.  I can change them back I suppose.\n. Someone (Jordan?) called it a hack.  The fact that the code presumes px instead of % or any other unit (em, ex, cm, mm, in, pt, pc, etc).\n. @keyanzhang Calling ReactDOM.render multiple times is not an anti-pattern.  In fact, if anything, calling setState would be the antipattern.  Ideally your components could all be stateless functions (ie. which have no setState function) and all your data would live in a flux store or something.\n. @josipherceg String concatenation is perfectly readable and is used more frequently throughout our codebase.  Also, it's particularly good to remain ES5 compatible when demonstrating the ES5 React.createClass API.\n. > setState is also not an antipattern.\nAgree, but given the choice between the two, I'd certainly take ReactDOM.render.\n. While we're here, can you also change this to \"values of a key in each object are\" instead of \"value of a key in each object are\".  The 'values' token must be plural (one value from each of the two objects) to match plural 'are'.\n. https://github.com/facebook/react/pull/6986\n. I don't think we want to remove this one.  This isn't actually the same as the setProps that you removed elsewhere.\n. Pssh, thanks.  https://github.com/facebook/react/pull/7006\n. We need a lint rule for that.\n. \"remain the same over time\" feels a bit odd to me, though I can't put my finger on exactly why.  I read it and I'm like \"what does that mean?\"\nPerhaps: \"Is it a constant value that never changes?  If so, it probably isn't state.\"\n. How about \"Does it remain constant (immutable) over time?  If so, it probably isn't state.\"  I feel like \"constant\" is better than \"remain the same\" but is still a little vague.\n. Done.\n. Personally, I think \"Does it remain unchanged over time\" reads the best.  I think I'd go with that one.\n. I think it is legal for this to be a composite component, so the children might not be simple option tags.\n. We're trying to put new warnings within devtools.  For an example that you can mimic, see: https://github.com/facebook/react/pull/7040\n. We try to include a stack trace for new warnings.  Again, https://github.com/facebook/react/pull/7040 is a good example.\n. Probably worth putting sudo apt-get install g++ in parenthesis, or linking to the github issue where people discuss how to install gcc for React, just to make life easier for people.  The apt-get probably covers the 95% use case.\n. Yeah, just copy-paste.\n. Does this actually change anything?  I thought we started ignoring the return value of an event handler a long time ago.\n. Yes, probably a full component trace using ReactComponentTreeDevtool.getStackAddendumByID(debugID)\n. I think the warning would fire even without this class being defined, right?  This is effectively just catching unknown elements?\n. I might change the message to something like:\n\n'Unknown element %s.  Did you misspell an HTML tag name?  If you using a custom component, make sure your custom component starts with an upper-case letter.%s', element.type, ReactComponentTreeDevtool.getStackAddendumByID(debugID)\n. I think we can just delete this line.\n. Afaik, we don't need to define createdCallback, detachedCallback, nor attributeChangedCallback.  It just makes the example more complicated and detracts from what we're demonstrating.  Can you remove these additional functions?\n. This can be const, right?  The reference identity remains the same.\n. cc @sebmarkbage performance?\n. > React.PureComponent is the recommend approach when working with ES2015 classes.\n\nI don't like this sentence because it implies that PureComponent should always be used (which is simply untrue; using PureComponent when your component takes in children is generally counterproductive).  I'd just remove that sentence alltogether.  It's enough to say that it is convenient and doesn't rely on mixins (ie. the sentence above).\n. We could potentially make the note a little more aggressive by replacing the entire note with something like...\n\nPureRenderMixin (for createClass components) has been replaced by React.PureComponent (for ES6 components) in React 15.3.  The React.PureComponent base class is now preferred over PureRenderMixin (legacy).\n. The old version was correct.  The dangerouslySetInnerHTML functionality is provided in order to cooperate with DOM string manipulation libraries.  The XML should be well-formed, and should be coming from a string manipulation library.\n. Yeah, making it a devtool sounds like a good idea to me.\n. Here is an example where I added a simple devtool: https://github.com/facebook/react/pull/7040/files\n. The fact that a component is disabled does not mean it is uncontrolled.  This logic is not correct.  You could imagine a controlled component becoming temporarily disabled if some background action is being performed; that doesn't mean the component becomes uncontrolled at that point.\n. \n",
    "samccone": "Indeed. However at least things are no longer broken in a silent fashion \n. sounds good to me, as you know there is a perf optimization for call vs apply, but if you are cool with apply then so am I :)\n. ",
    "awennimparitse": "Hello\n. Hello\n. ",
    "romanmatiasko": "I didn't know you meant the test, I'll fix that. :)\n. Sorry for the confusion. :)\n. ",
    "RichardLitt": "Ahhh I misread that, I was thinking react there meant React. The first is totally grammatical. \nThe second was just because it was in the same line and it was to be consistent with the DOM mutation. Removing that first the also fixes the problem. \n. ",
    "ryanzec": "It looks like the latest code (0.12.1) uses ReactBrowserEventEmitter instead of ReactEventEmitter\n. ",
    "asvsfs": "No , onClick doesn't work! \n. ",
    "smonev": "Updated the code. Not sure about the markdown comment (if escaping is what you meant - I used escapeTextForBrowser function).\n. ",
    "kevinold": "Right will fix later on.\u00a0\nOn January 26, 2015 at 5:31:24 PM CST, Paul O\u2019Shannessy notifications@github.com wrote:In src/classic/element/ReactElementValidator.js:  > @@ -298,9 +298,12 @@ function warnForPropsMutation(propName, element) { > > warning( > false, > - 'Don\\'t set .props.' + propName + ' of the React component' + > - elementInfo + '. Instead, specify the correct value when ' + > - 'initially creating the element.' + ownerInfo > + 'Don\\'t set .props.%s of the React component %s. ' + > + 'Instead, specify the correct value when ' + > + 'initially creating the element. %s', > + propName, > + elementinfo,   elementInfo  (is failing tests because of this)  \u2014Reply to this email directly or view it on GitHub.\n. ",
    "mzabriskie": "How should this be handled if the message itself is > 80 max-len? Ok to concatenate actual message to avoid lint failures?\njs\nwarning(\n  false,\n  'Style property values shouldn\\'t contain a semicolon. ' +\n  'Try \"%s: %s\" instead.',\n  name,\n  value.replace(badStyleValueWithSemicolonPattern, '')\n);\n. ",
    "cody": "Maybe '_reactInternal_' would be easier to read.\n. In another PR // was used at first, but it was argued that the prefix should be https//: https://github.com/facebook/react/pull/3180#issuecomment-74913038\n@zpao I am happy to change this, just let me know.\n. Nit: Use backticks for false\n. It is allowed to have html elements. At least <iframe> is already used in the docs for inline videos. Here this is explained: Inline HTML.\n. \"as\" is there twice.\n. This would for example not catch onMouseup. Maybe something like the following would be better?\njs\nvar eventType = eventTypes[propName.toLowerCase()];\nwarning(\n  !eventType || eventType === propName,\n. iamge is a typo.\n. Really nice. Just the superfluous * should be removed.\n. Instead of saying what's incorrect, I would suggest to make the explanation at the top more verbose. Now it just says: \"Invoked when a component is receiving new props.\" That this sentence is formal logic is not obvious.\n. I have removed this change.\n. The } for the constructor is missing.\n. The example should use .js as extension, doesn't it?\n. nit: The dot at the end is missing.\n. nit: The CDNJS link can be https, since it redirects to https anyway.\n. The link to the babel blog does not work, the / at the end has to be removed.\n. ",
    "hnordt": "Sorry, I didn't understand\n. Sorry. I've fixed it. Thanks!\n. @aweary fixed :). @aweary rephased \ud83d\udc4d . ",
    "gsklee": "Ooops I missed that line...\n. ",
    "irvinebroque": "+1 to keeping if/else. I point people coming from traditional templating systems to this page all the time, and if/else makes JSX feel more familiar.\nIf there is a ternary example, it makes sense to keep it within the return statement:\nreturn (\n      <nav>\n        {isLoggedIn ? <cite>Hello!</cite> : <strong>Log in, please...</strong>}\n        {isLoggedIn ? null : <SignUpButton/>;}\n      </nav>\n    );\n. ",
    "chicoxyzzy": "it shadows global.Buffer object (eslint throws no-undef)\n. seems like file is required\nhttp://eslint.org/docs/command-line-interface/\n. > Statement inside of curly braces should be on next line\n\nbrace-style rule\n. there is space-before-blocks. I'll add it\n. oops\n. no this doesn't work\n. done\n. @hzoo this doesn't work as well.\nBTW **/*.js works. But \n\n\u279c  react git:(remove-jshint) ./node_modules/eslint/bin/eslint.js **/*.js\nzsh: argument list too long: ./node_modules/eslint/bin/eslint.js\nso we need more flexible grunt task or maybe some grunt plugin. But I hope this can be another PR because this diff is too large already.\n. Not sure about comment that was here before. Grunt task didn't lint vendor/ before but comment was about vendor/fbtransform/syntax.js only.\n. done\n. template strings are ES6 feature so this will not work for some target browsers\n. semicolon is missing here\n. what @sebmck said :point_up: \n. someone please tell me why 0xeac7? I can't sleep\n. did you mean mutated?\n. you can use shallowEqual here\n. Is it more clear now?\n. Yes, seems like tests pass in that case. I'll try to fix it soon. TypeScript's documentation on Compiler API is not very helpful :(\n. eslint emits warnings here\n```\n  99:12  warning  Comparing to itself is potentially pointless  no-self-compare\n  99:23  warning  Comparing to itself is potentially pointless  no-self-compare\n\u2716 2 problems (0 errors, 2 warnings)\n```\nwhat should I do here?\n. done and rebased\n. If we omit return type then it's still a source of confusion and inconsistency\n. Oops. You are right thank you!\n. improved\n. hm.. why should it be here?\n. Thanks! Fixed\n. I've changed traverseContext type to mixed. Can you check my solution? I think we are missing else branch of refinement\n. yep\n. @keyanzhang you are rigth. I'll file PR\n. I think @keyanzhang is right\n. yep sorry didn't noticed that\n. I think we should avoid nested ternary operator\n. \u043f\u0440\u043e\u043f\u0443\u0449\u0435\u043d\u0430 \u0437\u0430\u043f\u044f\u0442\u0430\u044f \u043f\u043e\u0441\u043b\u0435 \u0441\u043b\u043e\u0432\u0430 \"\u043f\u0440\u043e\u0446\u0435\u0441\u0441\"\n. \u041f\u0440\u043e\u043f\u0443\u0449\u0435\u043d\u0430 \u0437\u0430\u043f\u044f\u0442\u0430\u044f \u043f\u043e\u0441\u043b\u0435 \u0441\u043b\u043e\u0432\u0430 \"\u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u043e\u0432\"\n. Technically these are not static properties. Static getters maybe?\n. I'm suggesting to reword as\n\nAlternatively, you can define propTypes and defaultProps using static getters.\n\nbut it's better if someone from React core team will chime in.\n. I think code below could be better if we don't care about IE<9 (and I hope nobody does develop in IE<9 :sweat_smile:):\njs\nfunction PropTypeError(message) {\n  this.message = message;\n}\nPropTypeError.prototype = Object.create(Error.prototype, { stack: { value: '' }});\n. it's better to write var dump = function dump(children) { to keep function names in stack trace\n. ",
    "hzoo": "what about eslint ./ then?\n. You can run eslint with grunt eslint or grunt lint\n. Oh then it's probably because it's not being processed - yeah src/vendor is in the eslintignore.\n```\nWe can probably lint these later but not important at this point\nsrc/vendor\n```\nSo instead you could try installing it globally and run it on a single file or remove the ignore from the file temporarily.\n. Not sure if this is right.\n. Not sure about this - could remove this line since no parameter is used?\n. Yeah like the arrow function xp. ~~Should I leave it?~~ Ok just left it.\n. Ok and what about the comments above? \"Finds the key at a given position...\"\n. There's an issue to allow longer lines with urls here https://github.com/eslint/eslint/issues/1661 but no implementation  yet (would be the same the jscs option allowUrlComments http://jscs.info/rule/maximumLineLength.html)\n. Yeah you're right; there's seems to be way too many changes to make.\n. Hmm noticed this, does this assume a object.assign polyfill (can use useBuiltIns option if so). ",
    "jasom": "Yeah, the state machine started out a bit differently, I'll clean that up.  Also, if you know a better way of checking for whitespace than (foo.trim() === \"\") let me know.\n. @zpao I fixed those in all the places I found; is there a style linter I can use to check for this in the future?\n. @hzoo Yeah, I did that, but it didn't flag any of the style issues zpao pointed out.\n. How embarrassing!  I removed it now.\n. I suppose it wouldn't surprise you that my day job uses mostly C...\n. ",
    "natearn": "This seems to be causing prop validation on my components to never generate warnings. I've spent a good while tracing through the validation code to end up here. If anyone reads this comment, I'm curious what the intent was here.\n. ",
    "vsiao": "I suppose this should be @param {ReactElement} element, and the same for the return type below\n. ",
    "koba04": "Sounds good.\n. @spicyj react-addons-perf and react-addons-test-utils too?\n. @syranide \nNo. Some tests depend on this issue's behavior.\nhttps://github.com/facebook/react/blob/master/src/test/tests/ReactTestUtils-test.js#L433-L465\nI prefer that the SyntheticEvent in TestUtils.Simulate isn't released after the event callback has been invoked.\nShould I separate a commit or create an another PR?\n. Thanks. I removed this line and fixed the failed tests!\n. @zpao I think currentTarget is already nullifiled because it is in the EventInterface property.\n- https://github.com/facebook/react/blob/master/src/renderers/dom/client/syntheticEvents/SyntheticEvent.js#L27\n- https://github.com/facebook/react/blob/master/src/renderers/dom/client/syntheticEvents/SyntheticEvent.js#L157-L160\n. @zpao \n\nReally target should be in that interface too\n\nI think so. DOM3 Event interface has target attribute.\nSyntheticEvent has all DOM3 Event interface attributes except target.\nhttps://www.w3.org/TR/DOM-Level-3-Events/#event-interfaces\n\nWhy it's not.\n\nIsn't this enough?\n``` diff\ndiff --git a/src/renderers/dom/client/syntheticEvents/SyntheticEvent.js b/src/renderers/dom/client/syntheticEvents/SyntheticEvent.js\nindex f9d0206..48ba4e8 100644\n--- a/src/renderers/dom/client/syntheticEvents/SyntheticEvent.js\n+++ b/src/renderers/dom/client/syntheticEvents/SyntheticEvent.js\n@@ -23,6 +23,7 @@ var warning = require('warning');\n  */\n var EventInterface = {\n   type: null,\n+  target: null,\n   // currentTarget is set when dispatching; no use in copying it here\n   currentTarget: emptyFunction.thatReturnsNull,\n   eventPhase: null,\n@@ -55,16 +56,17 @@ var EventInterface = {\n function SyntheticEvent(dispatchConfig, targetInst, nativeEvent, nativeEventTarget) {\n   this.dispatchConfig = dispatchConfig;\n   this._targetInst = targetInst;\n-\n   this.nativeEvent = nativeEvent;\n-  this.target = nativeEventTarget;\n-  this.currentTarget = nativeEventTarget;\nvar Interface = this.constructor.Interface;\n   for (var propName in Interface) {\n     if (!Interface.hasOwnProperty(propName)) {\n       continue;\n     }\n+    if (propName === 'target') {\n+      this.target = nativeEventTarget;\n+      continue;\n+    }\n     var normalize = Interface[propName];\n     if (normalize) {\n       this[propName] = normalize(nativeEvent);\n@@ -160,7 +162,6 @@ assign(SyntheticEvent.prototype, {\n     this.dispatchConfig = null;\n     this._targetInst = null;\n     this.nativeEvent = null;\n-    this.target = null;\n   },\n});\n``\n. @zpao Thanks! I updated this.\n. this condition is forevent.persist(). this is to avoid a warning in the persistent event.\n. SyntheticEvent constructor has to returnthis` explicitly now.\n5947\n. @jimfb Thank you! I got it fixed!\n. Yeah, this PR's diffs are created automatically by react-codemod/transforms/class.\nI think we can do more refactoring.\n. @gaearon @sebmarkbage Thanks! I've updated this with using ReactDOMFeatureFlags.useFiber.\n. @sebmarkbage Thanks! I've updated it. But In case of ReactDOMFeatureFlags.useFiber is false, this test is failed because of Your test suite must contain at least one test..\nSo I added some tests that can pass regardless the fiber flag.\nDoes this make sense?\n. @gaearon Thanks! I've fixed that this in render callbacks is the public instance.\nThen I confirmed the tests linked from your comment are passed when unstable_batchedUpdates is mocked.\nI'll fix it after this PR was merged.\n. In this case, I think two callbacks should be called after flushing. I've added a test for it.\n. @gaearon spaces inside curly braces aren't needed?\nI can see spaces inside curly braces in the ReactFiber codebase.\n- https://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactFiberCompleteWork.js#L126\nIs there a rule for that?\n. ok, I've fixed it!\n. I've moved it to behind the effectTag check.\n. Thanks! That makes sense. I'll update it.. Fixed it.. This is for consistent with stack reconciler.\nBecause stack reconciler can render other than string and number.\n\nhttp://codepen.io/anon/pen/BQXwVP?editors=0010\n. Does this condition still need? It seems to be unnecessary because it is covered  by if (lastHtml !== nextHtml).. @acdlite OK, fixed it. I've added the tests using ReactDOM.render instead of _createContentMarkup into ReactDOMComponent-test.. Should React update instance.props even if SCU returns false?. In addition to that, should shallow renderer update state and context as well?. According to my last research, ShallowRenderer calls cDU with setState, but it isn't called with render.\n\nYou can see the result at lifecycleExperimental being false in this link.\n(Enzyme's setProps and setContext are just calling render again)\n\n\nhttps://github.com/airbnb/enzyme/pull/318#issuecomment-225148673. @bvaughn \nI guess the reason is that ShallowRender.render run on an outside transaction, which means that enqueued functions have never been called.\n\n\nhttps://github.com/facebook/react/blob/master/src/test/ReactShallowRenderer.js#L68\n\nhttps://github.com/facebook/react/blob/master/src/renderers/shared/stack/reconciler/ReactCompositeComponent.js#L1043-L1053\n\nI used to create a PR to fix it. I hope it can be of any help to you.\n\nhttps://github.com/facebook/react/pull/7912. Thanks! I've fixed it!. Why don't you mention about a codemod for this?\n\nhttps://github.com/reactjs/react-codemod#error-boundaries. What about requestAnimationFrame?. Reconciler.createContainer(container);?. s/Renderer/Reconciler/g?\nReconciler.unbatchedUpdates(() => {\n  Reconciler.updateContainer(element, newRoot, null, callback);\n});. Reconciler.updateContainer(element, root, null, callback); ?. document.getElementById('modal-container'); ?. Add a comment and remove an unnecessary null check.. > What's the advantage to trimming \"index.html\"?\nThere might be not an advantage. But many links to index.html don't have index.html as the path. So I prefer to have consistency for these URLs.\nBut I'll remove the code if you don't need it.\n\npath.replace(/index.html$/, '')\n\nThat makes sense. I've fixed it.. missing @flow  annotation?. Is there any (perf) benefit to pass same shape objects as arguments of Object.assign?. Yes.. Why is this file required?. I got it. Thank you!. createComponent are still in README.\ns/createComponent/createSubscription/g \ud83d\ude04 . ",
    "Pouja": "Just of curiosity why are you not just returning false?\n. Ah TIL thank you!\n. attributeName is already defined. See line 269 in the Travis CI test of your PR. \n. ",
    "iamdustan": "Is this note saying the following?\n``` javascript\nvar Parent = React.createClass({\n  componentDidMount() { console.log('Parent componentDidMount called'); },\n  render() {\n    return ;\n  }\n});\nvar Child = React.createClass({\n  // the Important note in this PR is stating that this is not fired for this example.\n  componentDidMount() { },\n  render() {\n    return Child;\n  }\n});\nReact.render(, document.body);\n``\n. because in reality all childrencomponentWillMountandcomponentDidMountlifecycle methods _are_ called.\n. All ofnpm-react-codemod`\u2019s tests are failing on master for me right now.\nError: You have a collection of type [CallExpression]. \"replaceWith\" is is only defined for \"Node\"\n. Additionally, I\u2019m okay not changing these. I can back out these updates and only have docs updates. These tests will get a bit of noise due to the react/addons deprecation notice, but nothing will break at this time.\n. added\n// see http://facebook.github.io/react/docs/addons.html for a comprehensive list\n. :clap: pretty sure this is exactly what I need right now.\n. :) this is my kind of test!\n. this file should probably be deleted now that it\u2019s built from source and not copying these over.\n. TODO: these appeared to only build minified versions. Need to generate both regular and .min builds\n. The InjectedCurrentOwner is just {current: null} which works by reference, but does feel slightly hackish.\n. How can I test that? Or is the fact that grunt build:basix fails indicative of it being incorrect?\n. Remotefriendlycoughcough\nWould abusing the RN packager be analogous to haste tooling? I dug around a bit today and noticed this current impl is a bit lacking.\n. wasn\u2019t there some work to reign in the build system somewhere?\nUpdated with that and now grunt build works correctly, the browser examples each work, and I can npm link this into my custom renderer and require react directly instead of react/lib/ReactIsomorphic.\n. Do these different builds have any overlap with the feature flags such as https://github.com/facebook/react/blob/3b96650e39ddda5ba49245713ef16dbc52d25e9e/src/shared/utils/ReactFeatureFlags.js?\n. Thanks, @jimfb. The \u201ceventually\u201d part is all I need to know :)\n. :raised_hands: woohoo!\n. I\u2019m assuming this is copied out of RN? The current release listed on https://www.npmjs.com/package/fbjs is v0.8.0-alpha.3\n. I see the increased sharing idea. This is exciting. :)\n. will babel-plugin-transform-class-properties need to be added to this repo for this or will the RN packager handle transforming this yet?\n. What's the difference between a callback ref and the value provided to the optional callback function to ReactDOM.render?\n. Thanks for the explanation, @jimfb.\n. It appears like the capitalization only happens after a :. Is there any reason to break that pattern here?\n. this.updater falls back to the ReactNoopUpdateQueuewhich is also in isomorphic/modern/class/. Is it okay to not call ReactInstrumentation.debugTool.onSetState() in that scenario?\n. should this use the same config from 'babel-preset-fbjs' in #6876?\n. nit: there are instead of there\\'re to avoid the escaping\n. extra jsdoc blocks (rootId and containerTag)\n. could you help me understand why this is returning the component when it\u2019s looking at the _renderedComponent all the way down? Is it because when there is no more _renderedComponent we have reached the bottom of that component hierarchy?\n. \ud83d\ude4c that\u2019s the scenario I was thinking. Thank you.\n. I think that all React* modules currently capitalized React...\n. ah! thanks!\n. would adding a warning call here be helpful to avoid any surprising behavior?\n. Trying to understand how some things work, it looks like the ReactDOMComponentTree logic was hoisted out of ReactDOMProperties as a stepping stone to this TODO.\nIf I understand correctly: had this change not hoisted ReactDOMComponentTree out of the (set|delete)ValueForProperty calls the tests would fail. With this change a subset of the tests and functionality pass, though the ReactPerf and ReactDevtools would still not be able to take advantage of this.\nIs this an okay-ish understanding or am I off?\n. shouldn\u2019t Flow understand this to be a function if it exists? https://github.com/facebook/flow/blob/master/lib/react.js#L74\n. With the Shared comment it looks like this is saying that the lifecycles are shared between the ReactCompositeComponent and ReactDOMComponent. Is that true?\n. I don\u2019t have a good understanding of the difference between ReactElement<*> and ReactElement<any>, though I think that ReactElement<*> allows Flow to infer more. Does that matter or nah?\n. TI ~= TextInstance?\n. Is this supposed to be the same comment as above? How is setting the effectTag to Update equal to clearing it?\n. should the require statement here by ReactDOMStackInjection?\n. Ah beautiful. Thanks for the callout! I\u2019ll get a chance to look deeper later this week :smile:\n. this intentionally still xit?\n. ...and fit?\n. Should \u201ccomposite components\u201d start becoming part of normal React users lexicon? Even though it may be a bit foreign when a developer first sees and experiences it, it can present an opportunity to start learning about Composite and Host components and how React models things a bit more.. Yeah, I opened this early for feedback (thanks, btw!)\nI didn't see a test case for what should happen in the function ref case already. assuming there isn't a current message for that case what should it be? I don't think it will be too bad to add that case (I'm fiber at least. Will need to look into amending stack). Perfect!\nTo be clear, the tasks are:\n- [x] update the current test case to have the stack addendum rather than just the owner name\n- [x] update both stack and fiber impls for that behavior.. It seems as though ReactDebugCurrentFiber.getCurrentFiberStackAddendum() and ReactComponentTreeHook.getStackAddendumByID(this._debugID) return slightly different stacks.\nFiber:\n\"Warning: Stateless function components cannot be given refs. Attempts to access this ref will fail.\n        in StatelessComponent (at ReactStatelessComponent-test.js:156)\n        in Parent (at ReactStatelessComponent-test.js:160)\"\nStack\n\"Warning: Stateless function components cannot be given refs Attempts to access this ref will fail.\n        in Parent (at ReactStatelessComponent-test.js:160)\"\nThis is with a render method of:\nrender() {\n        return <div><StatelessComponent name=\"A\" ref=\"stateless\"/></div>;\n      }\nIs this acceptable deviance? If yes should I just make the test loose enough to assert on the commonalities? If not how do you want me to proceed?. will the other tag types ever have a component name to return?. haha. I\u2019ve seen this type of thing a few times. Now I understand why. :). I think the warning is expected. There is a stateless component in this test that should fire a warning. I added the same warning spy that is elsewhere to this test.. Thank you for the thorough review, @gaearon. This is my own remaining question. While this test passes this looks wrong to me. (The same set of assertions fails in ReactStatelessComponent with fiber on). \nI would expect the ownerName to be Foo rather than FunctionalComponent. If I cahnge the getCurrentFiberOwnerName() to return the fiber._debugOwner for FunctionalComponents then I get Foo.... I\u2019m going to push one more commit with that change for review since it looks like you landed that getCurrentFiberOwnerName change yesterday.. If I put FunctionalComponent directly with HostComponent where it returns null when there is no fiber._debugOwner then three following tests move from the fiber success to fiber failure:\n```\nsrc/renderers/shared/fiber/tests/ReactIncrementalErrorHandling-test.js\n- catches reconciler errors in a boundary during mounting\n- catches reconciler errors in a boundary during update\nsrc/renderers/shared/shared/tests/ReactComponent-test.js\n-* includes owner name in the error about badly-typed elements\n```\nAll three of those tests specifically; include a FunctionalComponent returning const X = undefined; return <X />.. oh, idk. It was just a thing I tried and wanted to document. I tried it in an attempt to not give FunctionalComopnents their own case.. If I remove this line then the following three tests fail:\nsrc/renderers/shared/fiber/__tests__/React\nIncrementalSideEffects-test.js\n-* invokes ref callbacks after insertion/update/unmount\nsrc/renderers/shared/shared/__tests__/ReactStatelessComponent-test.js\n * should update stateless component\n * should unmount stateless component\n * should pass context thru stateless component\n-* should warn when given a string ref\n-* should warn when given a function ref\nThey all fail for the same reason. This is an example of the results from the current stack reconciler.\nexpectDev(normalizeCodeLocInfo(console.error.calls.argsFor(0)[0])).toBe(\n      'Warning: Stateless function components cannot be given refs. ' +\n      'Attempts to access this ref will fail. Check the render method ' +\n      'of `Foo`.\\n' +\n      '    in FunctionalComponent (at **)\\n' +\n      '    in div (at **)\\n' +\n      '    in Foo (at **)'\n    );\nIf I remove this line then Fiber ends up with:\nexpectDev(normalizeCodeLocInfo(console.error.calls.argsFor(0)[0])).toBe(\n        'Warning: Stateless function components cannot be given refs. ' +\n        'Attempts to access this ref will fail. Check the render method ' +\n~       'of `FunctionalComponent`.\\n' +\n        '    in FunctionalComponent (at **)\\n' +\n        '    in div (at **)\\n' +\n        '    in Foo (at **)'\n      );\n\ntldr; without this line Fiber ends up logging the FunctionalComponents name in the same location that stack logs the FunctionalComponents owners name.. :thumbsup: I suspected this was going to be reverted from your last comments.. so the resulting fix is passing the debugOwner through the createFiberFrom* functions explicitly. Yeah?. I think that makes sense. The two ideas i was going to explore was to either create something like getDebugFiberWorkInProgress or floundering my way through something like what you did.\nWhat were the other solutions you tried that didn\u2019t work out?. I don\u2019t think ever, but flow was complaining that TestRenderer.createContainer may return null. Oh yeah, forgot about this one. The stack-based ReactTestRenderer exposes this currently... good point. this was to make one of the tests pass, but I think to be correct I need to capture the type when creating the TextInstance and only coerce back to a number if it came in as a number.. \ud83d\ude07\n...adding this to the PR checklist.. outdated comment.. oh whoops, didn\u2019t mean to actually commit this. This was testing the behavior difference for refs between the test-renderer and DOM renderer re https://github.com/facebook/react/pull/8628#issuecomment-271478813. the flow type for instance on master is any. Whilst adding the PI parameter does end up saying instance is PI, that fails flow due to ref expecting:\nref: null | (((handle : ?Object) => void) & { _stringRef: ?string }),\nI suspect this could be improved, but for time constraints at the moment I simply dropped it back to equal the current inference.. oh, would this need to be invalidated on receiveComponent?. _debugSource is added via a babel plugin, right?. not directly related to this PR, but are there any concerns that dev behavior may change slightly based on babel-plugins? Especially for compile-to-js implementations?\nPerhaps there should be documentation added to https://facebook.github.io/react/contributing/implementation-notes.html for _debugSource?. if the babel plugin is updated to follow React.createClass aliases I assume this test would break?. +1. this test looks very comprehensive.. welp, I\u2019ve updated it to on mountComponent because that is the earliest point we can do so (that is when hostContainerInfo is passed in). disclaimer: this implementation was mostly an amalgamation of ReactNoop and the stack ReactTestRenderer so there is likely some unnecessary complexity from the copypasta.. The tldr is I originally wrote the TestContainer to hold the createNodeMock function and keep a pointer to it. This likely can be simplified. Top-level create with a fragment is likely broken right now.\nI\u2019ll look at unifying TestComponent and TestContainer tonight. Should I add a test case for top-level create?. what is the tdlr of this method? No tests currently require it so I just left it empty. Sounds like I\u2019ll need to add a test case.... great! sounds like it\u2019s been magically resolved :). hmm...I can remove this one, but not those in the returned methods.... oh duh. It\u2019s because in unmount  we clean up our closured reference to root, but the consumer could still do:\nconst renderer = TestRenderer.create(<Comp />);\nrenderer.unmount();\nrenderer.update(<OtherComp />); // shouldn\u2019t be possible because we unmounted.\nI\u2019ll need to look into what the current implementation does.... Hmm...this actually seems to maybe work okay already? Here is my current test case:\n```jsx\n    it('can update text nodes when rendered as root', () => {\n      var Component = (props) => props.children;\n  var renderer = ReactTestRenderer.create(<Component>Hi</Component>);\n  expect(renderer.toJSON()).toEqual('Hi');\n  renderer.update(<Component>{['Hi', 'Bye']}</Component>);\n  expect(renderer.toJSON()).toEqual('Hi Bye');\n  renderer.update(<Component>Bye</Component>);\n  expect(renderer.toJSON()).toEqual('Bye');\n  renderer.update(<Component>{42}</Component>);\n  expect(renderer.toJSON()).toEqual(42);\n  renderer.update(<Component><div /></Component>);\n  expect(renderer.toJSON()).toEqual({\n    type: 'div',\n    children: null,\n    props: {},\n  });\n});\n\n```\nThough currently <Component>{['Hi', 'Bye']}</Component> toJSON() only returns Hi (instead of Hi Bye). I\u2019m not actually certain what is expected at this point.\nI\u2019m going to add another test case later, family-time!. I\u2019m not actually certain if this should be Hi or Hi Bye. I think that when given a fragment-like thing the first is the only one returned, but only spent 30 seconds on it so far.. Sorry, this is the root node test as I understand it: https://github.com/facebook/react/pull/8628/files#diff-417ca2789067ee4dcafab55a48aa03cbR532\n```\n    it('can render and update root fragments', () => {\n      var Component = (props) => props.children;\n  var renderer = ReactTestRenderer.create([\n    <Component>Hi</Component>,\n    <Component>Bye</Component>,\n  ]);\n  expect(renderer.toJSON()).toEqual('Hi');\n  renderer.update(<div />);\n  expect(renderer.toJSON()).toEqual({\n    type: 'div',\n    children: null,\n    props: {},\n  });\n  renderer.update([<Component>{42}</Component>, <Component>The answer</Component>]);\n  expect(renderer.toJSON()).toEqual(42);\n});\n\n```. https://github.com/facebook/react/blob/e4733076498695c754740ff3a8f9d41c447b1a3e/src/renderers/dom/fiber/tests/ReactDOMFiber-test.js#L137-L158\nThe underlying implementation uses TestRenderer.findHostInstance(root). From looking at what I believe are the corresponding DOM tests, only the first element in a fragment is returned.. I thought it was just Instance or TextInstance, though Container is also actually a possibility.\nThis was added for exhaustiveness because I couldn\u2019t get flow to be okay without else if check just before this.. how would that look? I could add $$typeof symbols to the container and text instances... are there any examples of type checking with symbols?. I added static strings before seeing this message. Okay?      799e901. without the typeof I get the following:\nsrc/renderers/testing/ReactTestRendererFiber.js:36\n 36:   $$typeof: CONTAINER_TYPE,\n                 ^^^^^^^^^^^^^^ string. Ineligible value used in/as type annotation (did you forget 'typeof'?)\n 36:   $$typeof: CONTAINER_TYPE,\n                 ^^^^^^^^^^^^^^ CONTAINER_TYPE. a bug. should be parentInstance.children.. how so? what can I do to rectify that?. Related, how can I type the createNodeMock function so PI is properly inferred?. how do I say the return value is Instance | TextInstance | createNodeMockReturnValue?. how could I reproduce this scenario? None of the current tests seem to have an issue. I attempted to reproduce it with a root ref and the return value of render with a few component types.\n```\ndescribe('root level refs', () => {\n  it('attaches and detaches root refs in stack', () => {\n    assertForRenderer(require('ReactDOM'));\n  });\nit('attaches and detaches root refs in fiber', () => {\n    assertForRenderer(require('ReactDOMFiber'));\n  });\nconst assertForRenderer = (DOM) => {\n    spyOn(console, 'error');\n    var ref = jest.fn();\n    var container = document.createElement('div');\n    var result = DOM.render(, container);\n    expect(ref).toHaveBeenCalledTimes(1);\n    expect(ref.mock.calls[0][0]).toBeInstanceOf(HTMLDivElement);\n    expect(result).toBe(ref.mock.calls[0][0]);\n    DOM.unmountComponentAtNode(container);\n    expect(ref).toHaveBeenCalledTimes(2);\n    expect(ref.mock.calls[1][0]).toBe(null);\nclass Comp extends React.Component {\n  render() {\n    return <div>Comp</div>;\n  }\n}\n\nref = jest.fn();\nresult = DOM.render(<Comp ref={ref}/>, container);\n\nexpect(ref).toHaveBeenCalledTimes(1);\nexpect(ref.mock.calls[0][0]).toBeInstanceOf(Comp);\nexpect(result).toBe(ref.mock.calls[0][0]);\nDOM.unmountComponentAtNode(container);\nexpect(ref).toHaveBeenCalledTimes(2);\nexpect(ref.mock.calls[1][0]).toBe(null);\n\n};\n});\n``. what\u2019s the \u201crule\u201d here forvarvconst?. I don\u2019t *think* thatgetPublicRootInstancewill ever callgetPublicInstance`. They both seem to be added for backwards compatibility with different features and operate independently.. well, what should this be:\nvar result = ReactDOMFiber.render(5, container);\n// result? '5' or fiber?. I think this is \u201ccurrent\u201d behavior. Even if I remove the getPublicInstance added from the ref, the result in that example is not '5' as I expected. I think, though, that that is a different issue... The more I think about this the less I\u2019m convinced that this should be changed from I | TI to PI. PI was only added for getPublicInstance which is only called via attachRef. The naming may be unfortunate since getHostPublicInstance and getPublicInstance aren\u2019t related (internally).\nFwiw, I\u2019m not attempting or desiring to implement anything new here, just trying to understand what the behavior was before #8628.. I have to double-check, but I don\u2019t think the fiber version would ever return a number since it\u2019s always converted to strings inside fiber.. yeah, I think this is okay. I thought the same thing when grabbing this from the stack implementation. \ud83d\udc4d . since stack and children behave in slightly different ways I do think that numbers are still numbers at this point, but once again I\u2019ll need to confirm in a short while.. Maybe too much info/review but:\n\nComposite components are the capitalized components like <Foo />\nHost components are the lowercase ones like <div />\n\nI think what @gaearon is saying is that as a fiber renderer you don\u2019t ever actually get to see the composite components because those are all happened internally so the children you see are the reconciled host component descriptions.. Ah yeah. That\u2019d do it. Test case and possible solution implemented in 9a9a4db394ffe9ce8928ad3381656d853735b1c0.. https://github.com/facebook/react/pull/8751/files#diff-7002876230f7effe9aa22e292f6a52c6R463 handles it in CommitWork. Added the switch for this method as well to do the same for getRootPublicInstance. Some tests have regressed that I\u2019ll need to look into why.\nShouldn\u2019t render(<Foo />) pass the I | TI back for backwards compatibility?. Is it safe to assume this module isn\u2019t relevant for server rendering?. Something I was thinking about when doing the initial test renderer implementation is if the createNodeMock had to be part of the HostConfig long-term. I think it did at the time for backwards-compatibility, but ideally could be done without extending the HostConfig. Since this is a new API can you think of a way to have this done entirely in renderer-land?. I was guided towards making the HostConfig shape strict in a prior change. May be applicable here as well.\nSee https://github.com/facebook/react/pull/8628#discussion_r93817157. slight alternative: it looks like 2 of the 3 warning() call sites in here are wrapped in __DEV__. Would it make sense to wrap the 3rd one in __DEV__ as well, or unwrap all of them?. Will this be able to solve reviving input values (#7745) (whether now or after 16) or is solving that in ReactDOM core a non-goal?. I don\u2019t want to conflate this issue too deeply with this tangent knowing it\u2019s a non-goal so let me know if it makes sense to have a tracking issue for thoughts/best practices (whether that turns into implementation or documentation in the form section)\n\nWe could potentially always fire a change event after reviving with the new value.\nIt seems to me that most use cases for this would suffer in some way unless you designed both experiences.\n\nI\u2019m curious what use cases would suffer or hurt the user experience with this? I\u2019ve experienced this scenario from browser prefilling forms from autocomplete setting and resetting the value during a refresh.\nIn both scenarios having it modeled as an onmount setState would\u2019ve been sufficient to hydrate the host environment values back to React component state.. > It won't type check if we use proper disjoint unions on Fibers.\nIs that PR any closer to landing by chance?. should I change all the anys to mixed?. Donesies.. whoa. why is FB_PROD so much larger than NODE_PROD/UMD_PROD? Legacy files that are being consumed internally yet?. Ah! Great point. :thumbsup:. derp, probably need to do more than simply copy-paste this.. \ud83e\udd37\u200d\u2642\ufe0f Everything worked okay for me so far. Idk if I even need those in the packages/react-reconciler area. There\u2019s also a rollup warning right now for this package and apparently I broke bundling ReactDOM.. Idk if this needs to stick around or how to write a test that ensures that each reconciler has its own scope for reconciler-unique things like valueStack other than this really hacky way.\nPossibly something with actually creating two reconcilers and then making them both do work that would indicate if they were clobbering each other or not.. It is, but this covers ensuring that all other modules with global-module state is created anew for each 3rd party reconciler instance until all internal modules with that state are wrapped in factory methods.. great eye, @koba04. thanks!. this is the mistake causing the file diff.. that\u2019s what it was doing on this branch before the last commit. That\u2019s why the file size was different.... No? I guess now it just tests that \u201cit works\u201d?. naturally I\u2019m biased towards tiny-react-renderer which will be getting updated after this is released. :smile:. can this have node removed since build.js has the #!/usr/bin/env node hashbang?. I probably don\u2019t know async/await well enough, but why does this function need to be marked async? It looks fully synchronous internally.. so that\u2019s how you\u2019re generating the fun artwork!. where does run come from? \ud83e\udd14 . should running yarn install && yarn test inside fixtures/reconciler happen in here, too?. I think react-reconciler should be special cased here to not have lock-step versioning (though not sure what to do besides just give it minor bumps). \ud83e\udd14  Since the API isn\u2019t semver stable yet keeping it sub 1.x avoids issues for breaking the likely breaking API changes that will take place as the async work makes progress.. want that before you land this PR or as a folow-up?. all the Frame annotations below only add debugElementStack in dev mode which causd a lot of errors in the logging utility functions. Just declaring it as always present (which it is in dev, and I think appropriately defended against in prod) solved a lot of the flow errors.. all of these are because of https://github.com/facebook/react/pull/11251#discussion_r145140768\njsx\nvar frame = {\n  ...everythingExcept_debugElementStack\n};\nif (process.env.NODE_ENV) {\n  frame.debugElementStack = [];\n}\nSo the frame: Frame = ({}: any) annotation is so that flow knows that this object can have the debugElementStack property.\njsx\nvar frame: Frame = ({\n  ...everythingExcept_debugElementStack\n// the any is to prevent Flow from considered this a\n// sealed object without the debugElementStack\n}: any);\nwithout this then the following chunks of code have a lot of errors due to debugElementStack being undefined\nhttps://github.com/iamdustan/react/blob/bacc1e72f58e1ec3eab16c52d6db28c7d0c21014/src/renderers/shared/server/ReactPartialRenderer.js#L65-L98. I\u2019m not really sure why Flow isn\u2019t understanding that child is a React.Element at this point without this extra hint. I thought that by typing the callsites to resolve this would just work.. It is typed similarly, just var binding: Type = ({}: any); instead of var binding = (({}: any): Type);\nThough I\u2019ll look to into make the making separate *Prod and *Dev variants yet.. Do you need the : ReactElement on both sides of the assignment? I\u2019ve only ever done one or the other and it always seemed to work as expected.. Yeah, one of my few wishes for flow is that it would be easier to see what it thought something was at any point in time and why.. since this entire chunk of code is inside a if (__DEV__) block I think we could safely say that var frame: FrameDev = stack[stack.length - 1];. I was trying (and unable) to find a way to get Flow to know that the only variant between Frame and FrameDev that could ever make it to the *CurrentDebugStack methods above were FrameDev types.. \ud83d\udc4d . does the isAppActive() method no longer exist?. I think the devtools integration used to work without this method \ud83e\udd14 \nWith this being required I think we\u2019d also need ReactFiberTreeReflection.findCurrentHostFiber and ReactFiberTreeReflection.findCurrentHostFiberWithNoPortals also exposed.. It used to be part of the devtools config I think. https://github.com/facebook/react-devtools/blob/ef493abba0d08c0243bdb1f2183edc797d5d366c/packages/react-devtools-core/src/backend.js#L13-L18\nI think the usage was so that an app could indicate whether it should take over the devtools connection or not, but not really sure. Or maybe to return false while still starting up (according to this comment)\nhttps://github.com/facebook/react-devtools/blob/ef493abba0d08c0243bdb1f2183edc797d5d366c/packages/react-devtools-core/src/backend.js#L52-L55. does this imply that the internal subscriptions from react-redux (https://github.com/reactjs/react-redux/blob/master/src/utils/Subscription.js#L58) will be handled by React itself then?. This is a way to do a relatively unsafe typecast with flow https://flow.org/\njsx\n(variableReference: type);\nWe can\u2019t do the following to cast frame to a FrameDev because flow already understands it to be of type Frame:\njsx\n(frame: FrameDev).debugElementStack = [];\nBy first saying (frame: any) we effectively erase the knowledge that it is a Frame to be able to say specifically that it is of type FrameDev.\nDefinitely grain of salt the specifics on that regarding how flow internally represents this, but that should give you a high level view of what\u2019s going on.. @gaearon The issue is not so much about context propagating, but that this instance method that reads from state to be rendered and updated when setState is called.. The following is pretty close to actual code that experienced this.\n```jsx\n// @flow\nimport * as React from 'react';\nimport { login } from 'api';\nimport { BetaFeatureConsumer } from 'BetaFeatures';\nimport { SingleSignOn } from 'SingleSignOn';\ntype P = {};\ntype S = {\n  username: string,\n  password: string,\n  loading: boolean,\n  errors: *,\n};\nexport default class Login extends React.Component {\n  state = {\n    username: '',\n    password: '',\n    loading: false,\n    errors: null,\n  };\nonChange = (event: SyntheticEvent) => {\n    const { name, value } = event.currentTarget;\n    this.setState({ [name]: value });\n  };\nonSubmit = (event: SyntheticEvent<*>) => {\n    event.preventDefault();\n    this.setState({ loading: true, errors: null });\n    login(this.state.username, this.state.password).then(data => {\n      this.setState({ loading: false });\n      if (data.hasError) {\n        this.setState({ errors: { ...this.state.errors, ...data.errors } });\n      }\n    });\n  };\n_render = v => {\n    return (\n      \n\n\n\n          Submit\n        \n        {v.singleSignOn && }\n      \n    );\n  };\nrender() {\n    return (\n      \n        {this._render}\n      \n    );\n  }\n}\n```. I\u2019d guess because https://github.com/facebook/react/blob/master/packages/react-dom/src/shared/HTMLNodeType.js isn\u2019t typed.. ",
    "awwright": "Storing a separate list sounds good, the spec doesn't seem to give a name for this class of elements though, how about newlineEatingTags (or -Elements?) like how I've been describing the behavior.\n. ",
    "jeffchan": "s/my/much/?\n. ",
    "vipulnsward": "update => updates\n. upgrade => upgrading\n. got rid of it altogether.\n. ",
    "wmertens": "@zpao I was thinking that the interpolation is closer in look/feel to the way the JSX is written and is more idiomatic. But two arguments works too of course.\nChanged and squashed.\n. ",
    "banderson": "Aha, I was running command line via npm test /  jest. I'll take fix this, thanks for the tip!\n. ",
    "jonhester": "Ahhh...thanks. I'll fix.\n. ",
    "mfunkie": "I've always considered using just the index a React 'best practice', especially for lists that paginate so that you can re-use a lot of the DOM nodes in the list.  Isn't the reconciliation step wise enough to tell that only the new item exists on add, considering it is added to the end of the list, and most of the DOM manipulation will be skipped if just the index is used (I recognize this would be the same behavior as using the itemText in the key also)?\n. ",
    "solomonhawk": "Perhaps this comment should be updated as well?\n. It may be useful to pull that comment out of filterDisabledEvents and place it where the Clone this.props comment existed.\n. ",
    "ariabuckles": "good idea :)\n. yeah, i'll reword this to try to be less confusing\n. ",
    "tgolen": "Why not\n<script src=\"//reactjs.github.io/react-magic/htmltojsx.min.js\"></script>\nso it is protocol agnostic?\n. ",
    "mheiber": "Hi jsfb\nThanks for the feedback. I'll incorporate the changes. Could you recommend a title? The current title is \"Cloning ReactElement,\" which is confusing since React.cloneElement is similar but distinct. \nI also think it would be best if the documentation could provide guidance as to the use case for using React.addons.cloneWithProps instead of React.cloneElement. Here's my guess: cloneWithProps is useful for when you want to create multiple copies of an element rather than a single copy. That's when you would definitely not want to keep key and ref. Is that right?\n. ",
    "pftg": ":+1:  for //\n. ",
    "jdreesen": "There are two more occurences of a which should be an instead.\n. ",
    "mariodu": "You means need a more reliable and exact  IE8 detect method?\n. IE8 use childNodes.item to read child is OK.But use it when dynamic insert will throw error, so it need detect IE 8.\n. IE8 has childNodes.item method, but it's implementation maybe different, array in IE is com.\n. When childNodes is empty, childNodes.item  will throw arguments error, then use childNodes[index] will work. After that, I found that when dynamic insert, it also throw that.\n. Sure, it throw error because index outside the size of the list.But it only happened under the IE8.Others use childNodes.item worked well.\n. I think try catch is better.\n. ",
    "rohozhnikoff": "yeah, .bind sometimes get the problem with GC when you use this functions with DOM listeners\nin this case i tested on 120-length hashes, calling 30000+ times\nversion with .bind showed better results on different tests\nmaybe you know cases, where it can create a problems?\n. tried to test variants:\nobjB.hasOwnProperty(...)\nObject.prototype.hasOwnProperty.bind(objB)\nhasOwnProperty.call(objB, ...)\nMy tests show the same results for each variants. Seems like .bind its carry-func under .call.\n. ",
    "TimeBomb": "Done.\n. ",
    "ljharb": "I thought about that, but even though I own and maintain it now, I saw no need to remove Kris' credit for creating it and building it up in the first place. These are your docs, so it's your call :-)\n. Will this reliably grab stack information across all browsers?\n. Do you need a whole plugin for this? You can use no-restricted-syntax to block for..of loops with a custom message.. any reason not to use isValidElementType from react-is here, and asserting the type isn\u2019t string, rather than repeating some of the logic?. you may want to use Object.prototype.hasOwnProperty.call here, since it\u2019d otherwise work fine to pass a function component with a null prototype.. should this use isForwardRef(element) (and cache the isForwardRef status in a var, since it seems to be checked multiple times)?. ",
    "hedgerwang": "you could just do \ntype.prototype !== undefined\n. ",
    "teosz": "for consistency i verified type like others lines\n. ",
    "mridgway": "typeof is about 20-25% faster than direct equality according to http://jsperf.com/hasownproperty-vs-in-vs-undefined/81\n. I'll update to match the styling rules.\n. This would cause undefined (the default) to opt out of autobind right? I could default it to true I suppose.\n. What is meant by this?\n. You're totally right. I'm not sure all of the possible cases here. I do know that null is also possible in this case. Would null and undefined checks be sufficient?. ",
    "reedloden": "I thought Twitter had retroactively changed all those to https://, but I guess not. Will change back.\n. For future note, on a YouTube video, click on \"Share\" -> \"Embed\" -> \"Show More\" -> \"Enable privacy-enhanced mode\", you'll get this same youtube-nocookie.com link. This YouTube support page provides more information. Backstory is that it was added at the request of the White House so they could embed YouTube videos on whitehouse.gov without a cookie being immediately set by YouTube for loading the interstitial (before the video is actually loaded and played).\n. Went ahead and just fixed it everywhere. :)\n. Changed.\n. ",
    "codesuki": "Missed that one, thanks! Will fix it.\n. ",
    "framp": "Yes, this one is optional but other uses (xlink:href and image for example) are not\n. Luckily all the current browsers seems to ignore namespace set on the 2nd argument of setAttributeNS:\nTesting it with the 'whatever' namespace.\nhttp://jsfiddle.net/framp/yst5c721/1/\nhttp://imgur.com/vXsHlGL\n. ",
    "masterfung": "Sure. I am happy to add this.\n. Oops, yes. I will make the update and submit the changes.\n. I would disagree on the flow of the sentence.\n. ",
    "alansouzati": "oh yea, working on it!\n. ",
    "yiminghe": "https://github.com/facebook/react/blob/91194126d87c6165edf7d33ac67dd2fae86cf08f/src/utils/traverseAllChildren.js#L102\nChildren.each will skip boolean and undefined.\nyour code will render hello if test is false?\n. good idea!\n. done. I copied from \"Test scryRenderedDOMComponentsWithClass with TextComponent\", thought it's the appropriate  style ....\n. why not use Math.random()\n. publicInstance must be retrieved inside updatedCallback.\nsee tc from https://github.com/facebook/react/pull/5125/files\n. setTimeout is mocked by jest, don't know how to simulate asynchronous in jest\n. runAllTimers run function provided to setTimeout synchronously. This test case needs asynchronization\n. ",
    "fkling": "You shouldn't have to do this, that's more likely a bug in jscodeshift actually. I will investigate.\n. Same\n. ",
    "DavidBrear": "nitpicking: couldn't you just use: hasNoisyInputEvent = document.documentMode > 9; since undefined > 9 will be false?\n. \"custom components\" ?. ",
    "arkist": "\"\uc131\ub2a5 \uc2ec\ud654\"\ub85c \ub418\uc5b4\uc788\uc2b5\ub2c8\ub2e4\n. ",
    "marocchino": "Applied. :3 6f434b3\n. \ud558\uc774\ud508 \uc0ac\uc774\uc758 \ubb38\uc7a5\uc744 \ub04a\uc5b4\uc11c \ubc88\uc5ed\ud574\uc57c\ud558\uc9c0 \uc54a\uc744\uae4c\uc694? \n\nFor <input> and <textarea>, onChange supersedes the DOM's built-in oninput event handler.\n\u2014 and should generally be used instead of \u2014\n. never mind, It was my misread. \n. \ucee4\ub9e8\ub4dc \ub77c\uc778 \ud234\uc5d0\uc11c \ub8e8\ube44 \uc628 \ub808\uc77c\uc2a4 \uc5f0\ub3d9\uae4c\uc9c0 \ud3ec\ud568\ub429\ub2c8\ub2e4. -> \ucee4\ub9e8\ub4dc \ub77c\uc778 \ud234\ubd80\ud130 \ub8e8\ube44 \uc628 \ub808\uc77c\uc2a4 \uc5f0\ub3d9\uae4c\uc9c0 \ub2e4\uc591\ud55c \ubc29\ubc95\uc774 \uc788\uc2b5\ub2c8\ub2e4.\n. \uc0c1\ud0dc \uc5c6\ub294 -> \uc0c1\ud0dc\ub97c \uac00\uc9c0\uc9c0 \uc54a\ub294\n. \uc790\uc2dd\ucef4\ud3ec\ub10c\ud2b8\uc640 -> \uc790\uc2dd \ucef4\ud3ec\ub10c\ud2b8\uc640\n. arrow function -> \ud654\uc0b4\ud45c \ud568\uc218\n. \uac00\ub974\ud0a4\uae30 -> \uac00\ub9ac\ud0a4\uae30\n. \ubaa8\ub4e0 React\uac00 \ub80c\ub354\ud560 \uc218 \uc788\ub294 DOM \ucef4\ud3ec\ub10c\ud2b8\ub294 -> React\uac00 \ub80c\ub354\ud560 \uc218 \uc788\ub294 DOM \ucef4\ud3ec\ub10c\ud2b8\ub294 \uc804\ubd80\n. remove it!\n. \ud3fc \uc5d8\ub9ac\uba3c\ud2b8 \ub9cc\uc774 \uc544\ub2cc -> \ud3fc \uc5d8\ub9ac\uba3c\ud2b8\ubfd0\ub9cc \uc544\ub2c8\ub77c\n. \ud22c\ud1a0\ub9ac\uc5bc -> \ud29c\ud1a0\ub9ac\uc5bc\n. It used at docs/docs/07-forms.ko-KR.md:11 's link. \nI want leave it as is.\n<form> \uc774\ubca4\ud2b8\uc5d0 \uad00\ud55c \uc815\ubcf4\ub294 \ud3fc \uc774\ubca4\ud2b8\ub97c \ubcf4\uc138\uc694.\n. Since kramdown strip i18n characters.\nhttp://facebook.github.io/react/docs/events-ko-KR.html#\ud3fc-\uc774\ubca4\ud2b8\n\nis not valid link.\nAuto-generated link (http://facebook.github.io/react/docs/events-ko-KR.html#-) is pointing \"\uc774\ubca4\ud2b8 \ud480\ub9c1\".\nYou can check this behaviour on current page. \nhttp://facebook.github.io/react/docs/events-ko-KR.html#-\n. You can read more at here.\n. ",
    "levibuzolic": "@zpao definitely seems to be working locally with null. Just double checked with Safari, Chrome and Firefox.\nSafari\n\nChrome\n\nFirefox\n\nAre you using inputmode instead of inputMode possibly, or are you seeing this in another browser?\n. @zpao thanks for that, I'll update the PR. :bow: \n. ",
    "lasekio": "I know i should quit foreach when element's found but Array.prototype.forEach does not support breaks. Array.prototype.some is able to do this but I'm not sure it is safe \n. ",
    "jasonLaster": "Maybe add additional expect for jimfb\n. should use native mouseenter if it is supported\n. should use native mouseLeave if it is supported\n. ",
    "alexpien": "I can't seem to get tests to work :/ any suggestions on how I should approach it? There aren't currently any tests to make sure the classnames are correct.\n. sounds good, ill make sure appear works and put something up today\n. ",
    "JoshuaGross": "IMO it's good practice to make sure that what's being logged is exactly what you expect - reading this without context, I have no idea why console.error is being logged to, which makes the tests harder to understand. If you check for the specific message that will help a lot with comprehension. \n. ",
    "lili21": "I will fix it soon. Thanks for the feedback.\nThere are some new commits on upstream/master branch, what should I do on my fix branch ? should I fetch and merge those commits ? or rebase it ?\n. For the render() warning. According to the source code,\nwarning(\n      container && container.tagName !== 'BODY',\n      'render(): Rendering components directly into document.body is ' +\n      'discouraged, since its children are often manipulated by third-party ' +\n      'scripts and browser extensions. This may lead to subtle ' +\n      'reconciliation issues. Try rendering into a container element created ' +\n      'for your app.'\n    );\nWhen the container is false, the warning message would be confused . \n. This change is for the Rendering components directly into document.body warning. \nWithout doing this, I need to spyOn the console.error function. or should I ?\n. ",
    "bgw": "That isn't actually. My bad regexp codemod caught it, and I figured it wouldn't hurt to change it. Let me know if you want me to revert it.\n. I agree, and think we should actually enforce trailing commas, but I think that should be another commit, and could be done with a codemod.\n. I think we should turn it off, but only for tests. Explicitly writing var next = undefined makes the code more readable. That requires making our grunt rule a bit smarter so it can pattern match __tests__ directories, which should be another commit and codemod.\nLet me know if you'd prefer I turn it off globally (for normal code and tests) and I'll do that instead.\n. componentWillLeave also defined cb so there was shadowing. Additionally, the existence of _cb and cb seemed a bit ugly. This seemed like the smallest modification I could make that didn't sacrifice readability.\n. I like this idea. I'll grep for /*eslint-disable no-unused-expressions */ and do that.\n. Later in the code, there's the test:\njs\n   it('should warn if a fragment is accessed', function() {\n     spyOn(console, 'error');\n     var child = React.createElement('span');\n     var frag = ReactChildren.map([child, child], function(c) {\n       return c;\n     });\n     ...\nWhich means there's shadowing. Since frag was just a stub method used in only two places, I figured it'd be better to just get rid of it rather than renaming things to avoid a conflict.\n. eslint requires indenting code blocks, instead of doing them on the same line. This is part of brace-style. If you'd prefer to allow single-line function declarations, we can enable allowSingleLine.\n. It's been brought up multiple times that we shouldn't be running these tests internally anyways, so I'll look into that issue before we merge this.\n. Yes. component was being shadowed (see line 802), but I both declarations held the same value. This part of the test is checking asap sets this correctly, which I believe this version still checks for.\n. There's other tests where we're breaking lines like this, so I think it's fine.\nIs trying to hit 80 columns everywhere a goal or not? Currently it's making the linter incredibly noisy. (235 warnings)\n. This is a workaround for eslint/eslint#2239. It had @zpao and I scratching our heads for a bit.\n. no-shadow. On line 121 and 122:\njs\nvar span1 = instance.refs.span1;\nvar span2 = instance.refs.span2;\nAs a general rule, I prefer giving the shorter name to the more deeply-nested bit, so these instances got changed.\n. There's whitespace between the function identifier and the open-paren designating the argument list.\n. @zpao, thoughts?\n. What if we had a flag you could pass to grunt lint to hide warnings? It wouldn't solve the problem of discouraging people from using long lines of code, but it would at least make it easier to sort through the errors.\n. I'll open another PR reversing this rule, and rebase this PR on top of it after it merges. That seems like the least amount of overall effort.\n. :+1: That worked. Strange, I could've sworn I tried that the first time around and it caused some other error. Maybe I did something else wrong.\n. It was triggering an unused-var warning. Regardless, the void change fixes it.\n. Yeah, I think most of the no-shadow rules triggered in places where the variable was defined below the shadowing scope because they probably would've been caught by a human earlier otherwise.\n. Changing it to use void like the no-unused-expressions cases seems to work for this. Would that be preferable? It's hard for me to think of any good places (besides tests) that you'd want to use constructor side-effects.\n. > To configure global variables inside of a configuration file, use the globals key and indicate the global variables you want to use. Set each global variable name equal to true to allow the variable to be overwritten or false to disallow overwriting.\nhttp://eslint.org/docs/user-guide/configuring.html\nEDIT: I can comment something to that effect in the eslintrc if you want.\n. The alternative, IMHO is to disable no-unused-expression in __tests__ only, by extending the grunt task to do the pattern matching itself, or by supporting multiple sets of eslintrc and eslintignore files.\n. Good catch.\n. As cool as I think sweet.js is, it actually parses the code, which means it'll likely break on ES6/ES7 features it doesn't support, and on JSX. I think sweet.js and babel are mutually exclusive.\nEDIT: That doesn't mean we couldn't so something similar to this with babel's plugin API. It would just be a lot more work.\n. Okay. I've changed my mind here. I'll fix the dangling commas after this PR lands. I hacked together a fancy codemod tool that hooks into eslint's node API to fix the code. (which is awesome because we get zero false positives, and it obeys eslintignore/eslintrc files)\n. Oh, right.\n. That would be nice functionality to have, but I don't think it would help us much: In the current state, we've got hundreds of warnings, and many of those are not containing URLs.\nIdeally we should fix them, or change our style rules, but we're having trouble coming to a consensus internally, and this fix is more immediately important, as the large number of warnings makes it hard to effectively use the lint tool.\n. On a related note, I'd kind of like to add an exception for objects and arrays nested immediately within another object or array. It's quite common to have an array of a single element, and to end up with syntax like:\njs\nvar config = {\n  rules: [{\n    foo: true,\n    bar: false,\n  }],\n}\n. @mathieumg I suspect because github doesn't understand jsx. It hardly matters. People won't be reading the raw github markdown file anyways.\n. I think this should be in a .babelrc file (which gulp-babel reads). You might be able to better share the configuration between this and jest that way.\n. // fall through is only supported in ESLint 1.0.0. I think we're on an older version, so in that case, you need to pluralize fall to // falls through.\nAlso, make sure it's the last thing in the case, after the conditional.\n. ",
    "vslinko": "@syranide thanks. changed\n. Use function name as component name.\n. Are you sure React should support this kind of definition? What is benefit of this over stateless functions and classes?\n. done\n. React.findDOMNode returns null if this method return null\n. done\n. done\n. done\n. done\n. done\n. removed\n. So, I don't see any option how to check function is stateless or module before ReactCompositeComponentMixin.mountComponent. That means we should merge ReactCompositeComponentMixin and ReactStatelessComponentMixin and turn on optimisations if var inst = new Component(publicProps, publicContext); returns ReactElement.\nMay be you have other better and simpler ideas?\n. @sebmarkbage I found a problem with that kind of components while trying to fix this: https://github.com/facebook/react/pull/4109\n. @sebmarkbage I'm done with hack that supports stateless and module pattern components at same time.\nNow component constructor called two times. I can fix this if you agreed to remove context argument from module pattern components constructor:\n``` js\n// Now\ntype StatelessComponent = (props) -> ReactElement\ntype ModulePatternComponent = (props, context) -> ReactComponent\n// Should be\ntype StatelessComponent = (props) -> ReactElement\ntype ModulePatternComponent = (props) -> ReactComponent\n```\n. It's just a typo :smile: \n. ",
    "chrisui": "Yeah, this was just the branch I was working on for testing my stuff visually and so all this code would need cleaning up a lot before actually going in. Seb opened up a pr for discussions sake :)\nIt's great to see all the discussion which has been going on though! I've been busy and away over the past week so haven't been able to get involved too much. Hopefully will have a read through everything later!\n. ",
    "dujuanxian": "Hi @zpao I have reverted it.\n. ",
    "cristovaov": "@zpao should be fixed with 4564e555b3b815f1ac8fcf9fd46eb61412b556aa ~\n. ",
    "mosch": "@zpao can you help on this? I would also love to help out on this if i can. Maybe with the test?\n. ",
    "bryanbraun": "Good thinking. I'll update this shortly.\n. The anchors do work. I did some testing across the various desktop browsers where I added anchors at various points in the loading process. I found that they all hop to IDs added after the DOM is fully loaded, though they differ in how much later in the process they will successfully jump to the anchor. In case you're curious, here's where each of the browsers fared on the test (the browser name is listed where they last successfully jumped to the anchor).\n- On DOM Ready (DOMContentLoaded)\n  - Safari\n  - Chrome\n  - Opera\n- On Page Fully Loaded (window.onload)\n  - Firefox\n  - IE\n- After Arbitrary setTimeout\n  - - none -\nIn short, we're safe in adding the IDs where we have, at least for all the browsers I tested.\n. It's compensating... changing how we add space between the title and hash-link. The UI should look the same:\n\n. Good call. I've made these updates in 1757114.. ",
    "jisaacks": "Yep Alright pushed that change up :)\n. ",
    "JoeStanton": "Is this a pun? or a typo? :)\n. ",
    "plasticine": "\nand we figured we'd do the same ~~this~~ thing today with our first beta\n\n:wink: :smile: \n. ",
    "kohei-takata": "I'm sorry I can't understand what you mean.\nWhat should I change?\n. Ah, thanks! I understand!\nI've changed that.\n. ",
    "dcousens": "currentPathElemen didn't annoy you?  But Id did?\n. SyntaxError: ReactEventListener: Unexpected character '\u0001' here as seen by https://travis-ci.org/facebook/react/jobs/70337892.\nI did it via GitHub, maybe something weird snuck in.\n. Just a nit,  but why not just while (i < m) {  and initialize i earlier?\nfor loops with expressions missing always just looks odd IMHO.\n. Agreed\n. Could probably split these up by lines as the markdown will concatenate them anyway.\nIn that way,  this diff would be much easier to read in future.\n. ",
    "blainekasten": "My understanding was that this function was for events that can't be caught at the global level and need to be attached to the actual dom node. For example, media events don't bubble and can only be received on the media node.\n. should I make this alphabetical too?\n. You mean I should just copy the code for audio and video? What's the benefit in that?\n. gotcha. Donezies\n. ReactDOM.render(<App />, appContainerNode) ?\n. ",
    "gajus": "I disagree.\nThe first sentence sets out a condition (\"Something is X because it has Y.\"). User acknowledges that and proceed to read the implication (\"It will render Y.\").\nThese very paragraphs is what made me confused when I read the docs the first time:\n\nAn <input> with value set is a controlled component. In a controlled <input>, the value of the rendered element will always reflect the value prop.\nAn <input> that does not supply a value (or sets it to null) is an uncontrolled component. In an uncontrolled <input>, the value of the rendered element will reflect the user's input.\n\nThe key difference that makes input controlled or not controlled is weather it has a value property set, not weather the value reflects user input, which is how I understood the difference the first time I read it.\n. Keep it simple then:\n\nA controlled <input> has value property. Rendering a controlled <input> will reflect the value of the value prop.\n\nIt does not sound sound as natural, but it is succinct. The present description is too verbose. Furthermore, this definition gives a hint that it reflects the value of the property at the time of each render.\n. How about\n\nA Controlled component maintains its own internal state; the component renders purely based on props.\n\nto be consistent with uncontrolled component definition, which is:\n\nAn uncontrolled component maintains its own internal state.\n. \n",
    "dmatteo": "Well, unless you have something particular like a two way binding, you usually have an event handler attached to your inputs, right?\nE.g. This snippet doesn't work with event.target.value  (code here)\n``` javascript\n  it('should add elements to .state.values on \"Enter\"', function() {\n    var instance = TestUtils.renderIntoDocument();\n    var inputNode = React.findDOMNode(instance.refs.inputField);\n//inputNode.value = 'hello';\nSimulate.change(inputNode, {target: {value: 'hello'}});\nSimulate.keyDown(inputNode, {keyCode: 13, which: 13, key: 'Enter'});\n\ninputNode.value = 'react';\nSimulate.change(inputNode);\nSimulate.keyDown(inputNode, {keyCode: 13, which: 13, key: 'Enter'});\n\nexpect(instance.state.values, 'to exhaustively satisfy', ['hello', 'react']);\n\n});\n```\nDon't you think that is a source of confusion in how Simulate works?\n. ",
    "cristiancavalli": "I have observed the same increase in event firing consistency with a direct call to queueClass and queueClass modified as such (POC purposes only):\n```\nqueueClass: function(className) {\n    if ( REQUEST_ANIMATION_FRAME ) {\n        REQUEST_ANIMATION_FRAME(\n          function ( ) {\n            this.classNameQueue.push(className);\n            REQUEST_ANIMATION_FRAME(this.flushClassNameQueue);\n          }.bind(this)\n        )\n    } else {\n      this.classNameQueue.push(className);\n  if (!this.timeout) {\n    this.timeout = setTimeout(this.flushClassNameQueue, TICK);\n  }\n}\n\n}\n```\n(updated to include api-absent envs)\n. ",
    "KevinTCoughlin": "Yea, the \\* removed in 60a081e66b634a269caf76549b78489dad74f9c9 was there to escape the asterisk for markdown formatting and reference the footnote below.\n. @zpao - sounds good, removed the footnote demarcation in ee11412\n. ",
    "niole": "I read the issue as being it would be helpful if the error message\ncontained the name of the react class that has the render method where the\nstyle prop has bad syntax, which is what that piece of code returns\nOn Jul 24, 2015 11:03 PM, \"Jim\" notifications@github.com wrote:\n\nIn src/renderers/dom/shared/ReactDOMComponent.js\nhttps://github.com/facebook/react/pull/4482#discussion_r35480276:\n\n@@ -263,7 +263,7 @@ function assertValidProps(component, props) {\n   }\n   invariant(\n     props.style == null || typeof props.style === 'object',\n-    'The style prop expects a mapping from style properties to values, ' +\n-    'The style prop of '+component._currentElement._owner._instance.proto.constructor.displayName + ' expects a mapping from style properties to values, ' +\n\nIt's the style prop of the owner component? This doesn't look right to me.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/facebook/react/pull/4482/files#r35480276.\n. Woops must have been sleepy when I submitted that. I would change it to say\n'check the render method of '+code_snippet\n\nI read the issue as being it would be helpful if the error message\ncontained the name of the react class that has the render method where the\nstyle prop has bad syntax, which is what that piece of code returns\nOn Jul 24, 2015 11:03 PM, \"Jim\" notifications@github.com wrote:\n\nIn src/renderers/dom/shared/ReactDOMComponent.js\nhttps://github.com/facebook/react/pull/4482#discussion_r35480276:\n\n@@ -263,7 +263,7 @@ function assertValidProps(component, props) {\n   }\n   invariant(\n     props.style == null || typeof props.style === 'object',\n-    'The style prop expects a mapping from style properties to values, ' +\n-    'The style prop of '+component._currentElement._owner._instance.proto.constructor.displayName + ' expects a mapping from style properties to values, ' +\n\nIt's the style prop of the owner component? This doesn't look right to me.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/facebook/react/pull/4482/files#r35480276.\n. \n",
    "frantic": "nit: move \"Disable Chrome web store version\" to the beginning of the paragraph, otherwise it's very easy to miss.\n. Firefox?\n. Should this be instance._renderedChildren?. ",
    "daukantas": "thank you\n. ",
    "probablyup": "I don't think this will work. According to MSDN, the propertychange event is only fired when listened via the attachEvent API\n. or \"non-recursively\"\n. I like this particular change, with the brackets. Makes it much more clear that it's a specific flavor of object.\n. AFAIK, IE will continue to exist in Enterprise installs for backward compat with ActiveX-based crud. So it's possible the version could be incremented at some point.\n. bind isn't necessary, forEach takes a second arg, being thisarg if desired - https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach\n. reduce might make more sense here\n. same here, reduce would probably make more sense\n. you shouldn't need ReactDOM.findDOMNode here, if I'm reading this right? IIRC since the ref is a non-composite, it should directly return the node\n. cont_r_olled\n. What about flipping this to be using pure functions as \"stateless\" components? I think it gets the idea across a little more clearly.\n. Could add a recommendation to enable property initializers in Babel to set initial state that way. https://babeljs.io/blog/2015/06/07/react-on-es6-plus#property-initializers\nAs a user if something was being taken away, I'd definitely want a suggestion on a replacement pattern like this.\n. If you need to do something complicated, yes. You can do basic setting based on props with initializers.\n```\nclass MyComponent extends React.Component {\n  state = {\n    foo: this.props.bar,\n  }\nrender() {\n    return (\n      {this.state.foo}\n    );\n  }\n}\n```\n. There is a PR open to remove the need to delve into internals. https://github.com/facebook/jest/pull/2138\n. Why would you ignore yarn.lock? The whole point of it is to be included to ensure specific versions of things are installed. . Typo: projectes . https://reactjs.org/blog/2016/01/12/discontinuing-ie8-support.html\nJust IE9+ it seems. ",
    "johngoren": "Oops, yeah, I agree that \"rendered\" is the wrong word. Maybe something like\n\"made available among.\" This would have helped me get it earlier.\nOn Mon, Aug 17, 2015 at 7:01 PM Paul O\u2019Shannessy notifications@github.com\nwrote:\n\nIn docs/docs/tutorial.md\nhttps://github.com/facebook/react/pull/4642#discussion_r37216521:\n\n@@ -568,7 +568,7 @@ var CommentBox = React.createClass({\n });\n```\n-Let's call the callback from the CommentForm when the user submits the form:\n+Now that the callback has been conveniently rendered into the child's properties, we can find and call it from the CommentForm when the user submits the form:\n```\n\n\"rendered\" isn't a good term to use here. \"rendered\" typically means it's\nin the DOM and that's not what actually happens with functions. It has been\npassed down in props, so we could say something more like that (I'd prefer\nwe use \"props\" over \"properties\" to make it clear that's how it works in\nReact).\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/facebook/react/pull/4642/files#r37216521.\n. \n",
    "rgbkrk": "Done deal.\n. ",
    "ning-github": "Thanks Jim. I definitely see your point there. I can edit the change to be 'and' or 'and/or' depending on what you guys prefer, since if for whatever reason a twitter user does not wish to follow reactjs but still wishes to check the latest news, they can use the hashtag. \n. ",
    "djrodgerspryor": "Good point. Fixed here: https://github.com/facebook/react/pull/4719\n. ",
    "jontewks": "@zpao Right now it looks like those two urls you recommended both redirect to facebook.com. If it makes more sense, I could change the firefox debug statement to point to https://addons.mozilla.org/en-US/firefox/addon/react-devtools/ which is where the react-devtools will point firefox users anyways.\n. @zpao understood. Updated with the newer urls!\n. Thanks for that. That's basically what I was trying to emulate but somehow missed the more specific Number.isNaN in my search. Updated with this change.\n. I originally thought the NaN warning would suffice, but you are right and it would be a good idea to show both. I've updated the PR to remove the NaN values before the equality check for the mutation warning.\n. Jim, I've added a module that exports that function rather than polyfilling onto the Number object. I found a file that appeared to be doing this for Object.assign, but I couldn't tell if that was being used anymore since there is also a node_module object-assign, but tried to follow this convention anyways. Let me know if this is the wrong place for this file, or if adding the isNaN function onto the Number object is preferable, and where that file should be placed. Thanks!\n. Please let me know the final verdict on if this should be moved or not. I believe that we will be all set once that is finalized and the fbjs shallowEqual is updated.\n. Thanks @gaearon, updated!\n. Thanks for the clarification, I've updated the error message.\n. ",
    "8398a7": "Sorry, I fixed it.\n. ",
    "kittens": "Do you think it's worth requiring a symbol polyfill similar to how an ES5 one is required? Seems kinda dangerous to allow older browsers to be vulnerable.\nOn Thu, Sep 10, 2015 at 6:12 PM, Christoph Pojer notifications@github.com\nwrote:\n\n\n@@ -24,6 +24,10 @@ describe('ReactElement', function() {\n   beforeEach(function() {\n     require('mock-modules').dumpCache();\n-    // Delete the native Symbol if we have one to ensure we test the\n-    // unpolyfilled environment.\n-    delete global.Symbol;\n  ohhh.. right, it is from the engine. Let's see if this test will fail with newer versions of node! Don't you still use node 0.10 for jest right now? If yes, that doesn't have Symbol, does it?\n\nReply to this email directly or view it on GitHub:\n  https://github.com/facebook/react/pull/4832/files#r39185824\n. \n\n",
    "josephsavona": "parens around the github link for consistency\n. Header here?\n. ",
    "taion": "It's typically styled \"PostgreSQL\".\n. ",
    "glenjamin": "Oh, neat! I should have just tried it instead of poking through docs :)\n. I tried this in https://github.com/glenjamin/react/commit/7bb820fa55011388ff1dcc8ec49c44f76f22ccde - as far as I can tell this is a Jasmine 2.0 feature that isn't available the vendored jasmine 1.3 jest contains.\n. ",
    "jw-00000": "Done.\n. ",
    "dgreensp": "It's not a polyfill, because there is no accurate polyfill for Object.create; that's why we're in this predicament. :) The Object.create es5-sham (which I'm a contributor on) is over 100 lines.  Setting a proto, on the other hand, is something every JS framework has to do at one point or another, since long before Object.create existed.\nCan you elaborate on the ES6 class idea?  Do you mean rewriting SyntheticEvent to use ES6 classes and real inheritance?  The main problem with that approach is that Babel's own _inherits helper uses Object.create! Babel helpers in general are not IE8-compatible, so \"just use Babel\" does not apply directly to the current problem, which is making React work in IE8 without relying on shams in the environment.  (The right solution to using Babel in IE8 without shams, which is what we do in Meteor, is to override the helpers with IE8-compatible versions.)  Also, this would be the first use of the class keyword in the entire codebase, which would pull in _inherits and other Babel helpers for the first time, and while there is nothing wrong with that, it seems like a big move that I would rather trust to a core contributor, and not necessarily something to block this issue on.\nAt the end of the day, setting a proto is 3 lines of JS, or one line with Object.create, but the latter requires that something called Object.create exist in the global environment.  There are logically only a few possible ways to avoid calling global Object.create with a small localized code change -- don't use Object.create at all; test for it and use it if available; factor out the functionality you need into a utility -- and any of them is acceptable to me.\nSince SyntheticEvent.augmentClass is already basically a one-off inheritance mechanism, in my opinion it would be reasonable to simply inline the code of createObjectWithProto (which either calls Object.create or does the equivalent work) into that function until such time as SyntheticEvent is moved over to real inheritance.  What do you think?\n. Functionally speaking, there's probably a small benefit to using Object.create if available, because the created object may look better in the dev inspector/debugger, but otherwise there is very little difference.\n. @sebmarkbage Will do\n. ",
    "bspaulding": "Dig. I definitely punted on what to name that. Will go with publicComponentInstance.\n. Bummer! I've updated it to a warning.\n. Now that this is a warning, I wonder if a more helpful message would be nice. Even if it was just Stateless function components cannot be given refs. Attempts to access this ref will fail.\nThoughts?\n. Donezo. Also added the ref name into the error: (See ref \"stateless\" in StatelessComponent created by Parent)\n. Done.\n. ",
    "vramana": "Shouldn't this be ref={(ref) => this.myTextInput = ref} ??\n. @gfogle You are converting a collection (keys) into single object (result). So it is essentially a reduce.\n. ",
    "loganhenson": "lint fix\n. lint fix\n. ",
    "krzysiek1507": "Is this line ok?\n. The same as above.\n. 2016 or present?\n. @jimfb here also present ;)\n. ",
    "bhamodi": "Hey @zpao - I changed those for two reasons. The first was that I couldn't find any documentation on markdown compiling only on certain line numbers. Secondly, it didn't make sense to me why we would want to only highlight certain lines in a code block? Please do correct me / point me in the right direction.\n. Wow that's impressive!\nI'll go ahead and put back the ranges on the lines that should be emphasized.\n. Nit pick: optimizations should probably just be optimization here.\n. ",
    "pluma": "Okay. Should I just revert the original change (i.e. remove the return statement and adjust the tests and docs) then?\n. What would I need to change to do that? Just pass in component._currentElement._owner.getName() directly?\n. Derp. Fixed.\n. That behaviour hasn't actually changed. Otherwise the tests would be falling, anyway. If you look at my first commit you'll see that the only actual change in logic is that the reassignment has been replaced with a return statement. This only affects unitless numeric string values.\n. Will do.\n. ",
    "tomduncalf": "I'm not sure if this description suffices but I didn't know how else to describe what it does!\n. @spicyj Makes sense - probably worth raising a separate issue for this as this PR is now merged\n. Cool - thank you!\n. ",
    "jadekler": "Cool, I also do. I noticed the other examples (see examples/jquery-bootstrap: https://github.com/facebook/react/blob/master/examples/jquery-bootstrap/js/app.js#L19-L31) smush functions together. Would you like me to make these other examples consistent with the whitespaced functions, or just keep the mix?\n. On it.\n. Sweet, get you that change in a moment.\n. ",
    "gfogle": "im assuming we want to keep this implementation consistent with the 'getMeasurementsSummaryMap' method above... \njust curious, why do you prefer reduce here? since i'm not really reducing the array and concerned about initial value, previous, etc. I'm just mapping the array onto an entirely new one.\n. see comment below\n. good point\n. thats a fair point. if whoever reviews the PR wants me to update it to use reduce i'm happy to do so. not clear if they would like to keep consistent with the other print methods already in the file.\n. Instead of a switch statement with fall-throughs, what do you think of using Todd's approach here with object literals? \n. :+1: \n. ",
    "acdlite": "Oops, will delete\n. Just noticed: while I'm in here, should \"ref prop\" be changed to \"ref attribute,\" since it's not really a prop? \n. Pretty sure using fiber.memoizedState here is a bug because we don't know if fiber is current. But, I don't know how to get the current state. It would be nice if we could rely on instance.state but that won't work in the case of an aborted update.\n. Will have the same problem with getting the current props for the updater form of  setState((state, props) => newState).\n. Rather than bubble up the priority both trees, could we bubble once and assign to the alternate at each level? I think so...\n. Hmm, I'm confused. I see your point about how the trees aren't parallel, but given that, isn't bubbling up both trees the only way? The first part of your comment seems to contradict the second.\n. Ooooh, okay. I think I get it now! Thanks for the detailed explanation (and for being patient as I try to keep up, haha).\n. Good catch\n. I believe you're correct about the second case, and the first case is if it's an update.\n. Oops, this isn't right because this also adds the previous state updates to the beginning of the queue! This causes the updates to be applied twice, because the updates were already used to compute the previous memoized state. I believe this is unobservable unless there are side-effects inside state updaters (which there shouldn't be), but it's wasteful regardless.\nShould instead combine the callbacks into a single callback, add to an empty node, and prepend it to the update queue.\n. Oops. I think it's fixed now?\n. Hmm I think I see what you mean. So the only place we should ever reset the queue / callback list is after the changes are committed?\nEDIT: Meant this to be a reply to the other comment above.\n. Is the fix as simple as not resetting the updateQueue on current here? I think so...\n. Ah alright. I'll need to rethink what to do here then: https://github.com/acdlite/react/blob/04c9a399e871d5ffe7323f11132b51185bc32e6e/src/renderers/shared/fiber/ReactFiberBeginWork.js#L158-L174\nDoes the overall strategy of callback list seem sound or should I go back to the drawing board?\n. Actually... I don't think any of this is necessary at all, right? If an update is preempted the callbacks won't be lost because they're still on the current tree's update queue?\n. I'm having trouble reasoning about this since it's not yet possible to test :D\n. Good call\n. This todo is correct, I think. Once you split the priority fields to distinguish between the fiber's priority and the subtree's priority, there could be a matching update further down the tree. Now that this function operates on the work in progress tree, could you do a recursive call?\n. Unfortunate that you have to go through this list again, but this is way easier to reason about.\n. This feels like the time the React docs mentioned in passing an experiment using React to build a native app, and then a few years later...\n. Isn't this a repeat of line 240? Also the name \"currentChild\" is a bit confusing; could be mistaken for the child of the alternate.\n. I agree it's too much to expose to renderers. I only added it here because I needed some way to test it. Any suggestions?\n. > If we don't expose it to users, maybe we also shouldn't expose it to renderers?\nI can imagine renderers might need at least some more granular control than a user, because there are certain scheduling tricks that can only be controlled at the renderer level. E.g. I had assumed that the deprioritization that happens when hidden={true} (or style={{ display: hidden }}) would eventually be handled by the renderer via some API, rather than being embedded in Fiber itself. Or a renderer might want to use a different priority for specific types of events? Curious what your plans are for that.\n. It looks like whenever useFiber is used, you also set the return fiber. Any reason this is kept separate?\n. This might be a stupid question but I've looked at it for a while and still don't get it\u2014why is it called mapAndDeleteRemainingChildren if it iterates over all the children?\n. Ugh. Duh. Thanks.\n. It may just be my brain struggling to read mutating code after avoiding it for a while.\n. Misplaced space here is causing bold issues\n. I suggest\n- [A Cartoon Intro to Redux](https://code-cartoons.com/a-cartoon-intro-to-redux-3afb775501a6)\n- [A Cartoon Intro to Relay](https://code-cartoons.com/a-cartoon-intro-to-facebook-s-relay-part-1-3ec1a127bca5)\n. Did we reach a decision on whether to use the updater form here or not? Even though it doesn't matter for a Timer where state is only updating once a second, people will see this and use it elsewhere.\n. It's not quite a race condition, it's that setState is potential asynchronous and/or batched. I don't think it's a good idea for the official docs to implicitly communicate that this is okay. Nobody will know this is a problem unless we're explicit about it.\n. Maybe instead of \"hard\" or \"easy\" we can say \"straightforward\"?\n. We should eventually link to the list of supported tags and attributes, once that doc gets moved over https://facebook.github.io/react/docs/tags-and-attributes.html\n. Yeah, good call\n. Yes, good edit\n. Hmm the problem with a data-fetching example is that you have to update render as well, which as I recall now was the reason I chose a shouldComponentUpdate example in the first place. Can you think of another example that doesn't involve render?\n. Ooh, maybe a logging example a la react-lumberjack? \n. True but instead of state, though, it could log the latest props.\n. There should be a comma between the two modifiers of \"pieces\": \"independent, reusable pieces.\nThat last part should be \"as if it existed in isolation\" without \"the\" but I wonder if it's redundant. How about \"...and think about each piece in isolation.\"\n. The British style is to place a period outside the quotes, as you've done here. I prefer this style, but the American style is to place it inside the quotes, for typographic reasons. I don't care either way as long as we're consistent across all the docs.\n. \"Hello, Sara\"\n. Commas after \"Typically\" and \"However.\"\nI think we can rid of some of those \"React\"s.\n. Is calling it a \"root\" element the best verbiage here? \"Single element\" seems sufficient.\n. It should be a self-closing <div /> for consistency, right?\n. > this.props and this.state always represent the currently rendered state and props\nThis isn't necessarily true, or at least it won't be with Fiber. state and props are updated before the changes are flushed to the DOM, which may or may not happen.\n. Should we say that setState is asynchronous or that it may or may not be asynchronous? Does \"asynchronous\" cover both cases? It's possible that an update will update synchronously.\n. The second \"other\" is redundant\n. \"current props\" might be misleading\u2014it is the props at the time when the update is applied. Not sure if the distinction matters for this document, though.\n. > This is why we called its prop more generically\nThis could sound like you're calling a function. Perhaps: \"This is why we named its prop more generically,\" or to avoid the awkwardly placed modifier, \"This is why we have given it a more generic name.\"\n. (Non-blocking) Is this the best rule of thumb? My rule of thumb is to split once I need the same thing in more than one place, or to split a large component into more manageable units.\n. This is a really trivial nit, but is it correct to say that React always applies the minimal number of updates? The algorithm optimizes for performance in the common case, not necessarily the smallest number of updates possible. E.g. if you have two class components with the same implementation, and you swap them across renders, React will unmount the first component even though in this particular case it'd take fewer operations to update the previous one.\n. \"If you don't use it in render, it shouldn't be in the state\" is a good way to put it. Maybe work that in somehow?\n. It's an em dash. Looks weird in monospace but usually those don't have spaces around them. How do we do it elsewhere?\n. It's a common misconception for people who are used to inheritance, unfortunately\n. What's an example of an HOC that doesn't use a container? I'm fine ditching this paragraph, though, it's not essential.\n. Good idea. I'll move the \"don't mutate\" part into the previous section, though, since that one is stricter.\n. Oops, my bad.\nGood call, a specific example is much more helpful\n. I copied this over from Dan's mixin post. I don't think it's confusing, but I see your point. In most apps nowadays you'd likely use context, or more likely a library like Redux which handles that for you.\nWhere DataSource comes from isn't all that relevant to this section. Is it alright if I just drop a comment in there to clarify?\n. Just in this one place or throughout the entire doc? Higher-order component gets pretty wordy when you say it over and over again.\n. Copy paste fail\n. I mention it briefly below\n. > The reason to not use a component seems simple to me. A component can't mess with its childrens' state. A HOC can totally mess with the state of the wrapped component.\nThat doesn't seem clarifying to me at all, to be honest.\nI think you're right that I can probably just scrap this section. It was a bit awkward to write anyway, because there is a vocal contingent of folks who prefer components + render callbacks to HOCs. But perhaps that belongs in a separate doc that compares the two approaches.\n. I mean if we have a doc about render callbacks, it seems appropriate to cross-reference it, no?\n. Oh I see what you mean. That's still a container to me, though I can see how this paragraph makes it seem like it's not a container unless it uses state or lifecycle methods.\n. Agree that this sentence makes render sound like an imperative API\n. Hmm not sure how you solve this without storing it on the fiber or instance\n. Can just pass instance here now, not that it matters too much\n. We already keep the about-to-be-flushed update queue in callbackList so that we can call the callbacks. What if we add a previousState field to the queue? It can be set when mergeUpdateQueue is called. Then rename callbackList to something broader.\n. > React will just render a comment tag\nThis is an implementation detail; might be best to leave it out\n. The props object is, more precisely, the value of the props at the time the update is applied. Calling it the \"current props\" could imply that it's the value at the time setState is called.\n. > setState() will always trigger a re-render unless...\nCould we change this slightly to say \"will eventually lead to a re-render\" to account for batching? Current wording could imply a 1-to-1 correspondence between setState and renders.\n. > with the keys defined according to the React.Component subclass. There are no special state keys with behavior defined by the core React.Component class itself.\nThis more confusing than it needs to be, I think. Can we just say that the state object is user-defined and link to the setState section for more info?\n. Why forEach here? Would it not make a perf difference to avoid the closure by using a loop?\n. Is there an issue with using current.memoizedState?\n. Can remove this TODO\n. Lol that's what I had before the last commit and @gaearon asked me to change it to this :D https://github.com/facebook/react/pull/7869#discussion_r82143805\n. I kinda prefer it the old way, as well, but I believe Dan's point was that it sounded a bit repetitive.\n. I didn't do a proper, scientific survey or anything but in terms of usage I'm pretty sure it's true. I want to communicate that this signature is the de-facto standard. How could I make it less confusing?\n. I'll just remove the props argument entirely. Like context, it's not actually required.\n. Ah yes, I meant compared to passing the UI as a child.\njs\n<Child><Foo /></Child>\nversus\njs\n// Child controls when to render Foo\n<Child>{() => <Foo />}</Child>\nBut I see what you mean. I'll rewrite.\n. Yeah this is what I meant by \"not quite done\" :D The implementation is pretty simple\n. react-motion uses it, as does React Router v4\n. How do know these spans haven't updated? idx hasn't changed, so even if you flush completely on line 654 you would still expect these to be 0. (On that point, what is the purpose of idx in this test?)\n. This is the intended behavior? I wonder if this breaks any user assumptions.\n. I feel like your @observer example proves my point. An advantage of the \"double-calling thing\" is that it's decorator compatible.\nMaybe what you really want is a more in-depth discussion of decorators? I hesitate to do that until they're more stable. Babel doesn't even support them.\n. I'm totally fine with getting rid of \"by far\" if that solves your concerns, though\n. I thought what we decided was we didn't need it when constructing a class component. Still need it for rendering a functional component. Might be best to remove this until it's actually needed regardless.\n. Cool I'll wait until that one gets merged\n. Oh yeah I even imported ClassComponent to do the comparison but then forgot :D\n. Yeah I imported it for this purpose but forgot: https://github.com/facebook/react/pull/8099/files#r85031873\n:D\n. That also works :)\n. Yeah tbh I barely looked at what this file does; just trying to get it merged for now :D\n. We could add a new TypeOfWork https://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactTypeOfWork.js\n. I like the bitmask idea\n. Oh yeah I didn't mean I would add it now :D\n. Oh duh\n. I'll fix when I rebase my PR on this\n. I think I found the problem... If scheduleUpdateQueue is sync (and not batched) then the update is flushed before enqueueCallback is ever called. Then enqueueCallback will add a callback to the queue but it won't ever get called until the next time the fiber is committed.\n. Yes we should fix this in the stack reconciler. I'll open an issue for it once I understand it better. (Not very familiar with how stack works.) @sebmarkbage has more details.\n. The extent of my knowledge is: under certain circumstances in componentWillMount, enqueued callbacks aren't flushed, so they stick around until some other update causes them to flush.\n. Hmm idk. Doesn't seem much different than passing performAnimationWork to requestAnimationFrame.\n. Good call. I think I'll just get rid of defaultPriorityContext entirely. I added it when I thought we'd need a way to change the default on demand, but now that it's determined by the host config it's not necessary.\n. And it shouldn't lead to deep stacks because nested sync updates are batched\n. Took me a while to figure out. If the updater schedules them separately, and the update is synchronous, then the work is already done by the time the callback is scheduled, so the callback doesn't get called until the next flush. This is what I was trying to describe on Friday that is similar to the componentWillMount bug we found.\nIn incremental mode, the flow goes like this:\n- (in updater) Schedule update\n- (in updater) Schedule callback\n- Perform work\nIn sync mode, it goes like this\n- (in updater) Schedule update\n- Because the update is synchronous, the work is performed immediately\n- (in updater) Schedule callback\nI'm actually not sure how Stack deals with this, come to think of it, but this seemed like the most straightforward solution.\n. There was a bug because enqueueUpdate only adding the callback to the queue; it didn't schedule an update on the fiber. This was unobservable previously because the callback was added to the same update queue node as the state update.\nI can get it to work by adding that to enqueueUpdate, but it felt wrong that you need an extra flush for a callback that is conceptually linked to the update.\n. Oops, meant enqueueCallback. On my phone so can't edit.\n. Yeah, forgot to remove\n. I don't think we need to reset it because we track on the update queue node whether the callback was called already. Are you saying that we should leave it to avoid the extra allocation on the next update?\n. Oh haha oops I didn't read the code correctly. I think it works either way, but the way it is now will avoid an allocation.\n. OTOH it's a bit odd to keep track of whether a callback node has been called. Don't know why I originally did that, probably being paranoid. Meh.\n. What does this error protect against? Seems unnecessarily dangerous. If the scheduler calls scheduleAnimationCallback and a callback is already scheduled, the renderer can just treat it as a noop.\n. This API is just for testing?\n. We can test if a callback is scheduled if flushing produces work. Not sure why this is needed.\n. I see, if it's only the noop renderer then it makes sense. Just wouldn't want to throw in a public renderer for a case that's unlikely to produce an error.\n. Just seems better to use the \"public\" APIs for testing when possible. Don't have a strong opinion on this though.\n. There's a difference between \"lo-pri\"/\"high-pri\" and \"deferred\"/\"animation\". Example: ReactPriorityLevel.HighPriority is scheduled using requestIdleCallback, so it's deferred.\n. scheduleAnimationCallback used to be called scheduleHighPriWork but we renamed it to avoid confusion: https://github.com/facebook/react/pull/7466/commits/5cae65bd9283931c67f6e9a5d0c28c6cabe2f40b\nI don't really care what we name them either as long as it's not ambiguous. Overloading \"hi-pri\" and \"lo-pri\" is, IMO.\n. > AFAIK we don't use HighPriority anywhere\nhttps://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactPriorityLevel.js#L21\n. Oh sorry. You're right that it's not directly used, but for example, when I was implementing scheduleWork, at first I branched incorrectly because I thought HighPriority was supposed to be scheduled with scheduleHighPriWork due to the confusing naming.\n. I don't disagree :D\n. This line here is how I got it to work, and why I had to move this function into the scheduler.\n. Hehe :D\n. Functions that contain a try-catch/finally can't be optimized in V8. Can we move this reset back to the catch in handleErrors?\n. Can you explain in more detail why it's necessary to unschedule failed roots?\n. Usual strategy is to split the try-catch/finally block into a separate function that does nothing but an unsafe function. We should do a pass at some point to do this across the codebase.\n. I agree it's easier to follow this way but I don't think it's worth a perf hit\n. I wonder if we had a way to only perform work on a specific root if we could avoid having to unschedule.\n. I suspect this might not be too challenging. Add the ability to pass a root to perform* functions. If so, they won't attempt to look for new work once they run out.\n. Haha good point\n. Maybe drop a TODO in there?\n. > Would always force unmounting children in an error boundary help with this case?\nIt would because we'd be recreating the whole tree instead of trying to reuse failed work... I think?\n. I'm facing the same problem in the PR I'm working on.\n. Perf optimization, unobservable\n. The reason this isn't an array is because we only need to capture the first error that's thrown, not all of them. (Or the last error, not sure it's super important. Opinions, @gaearon?)\n. So following up from my previous comment, this should return either a single error or null\n. Add a return type: Error | null\n. Delete this line, please. Even though the callback failed, we don't want to call it again. (Also, I don't think callbackWasCalled is even a necessary thing to keep track of. We can remove it in a separate PR.)\n. Oh yes, good catch. Could you also do that with tryCallComponentDidUpdate/Mount, too, while you're at it? :)\n. The changes in this file are minimal; there's a lot of noise because I wrapped everything in this function, which increased the indentation.\nThe only real change is the addition of a forceReplace parameter.\n. Could these arrays be combined into a single linked list? From what I can tell it doesn't look like you need indexing because you only ever need to access the tail.\n. I was thinking instead of literally unwinding to catch an error, we schedule an update on the boundary and reset the unit of work pointer. That's how I've started to implement it, not totally sure if it will work yet.\n. Where by \"schedule an update\" I mean give it work priority\n. What I'm trying to say is that if we always start from the root, I don't think unwinding the context is necessary because of your line here: https://github.com/facebook/react/pull/8272/files#diff-74dedebbf08d8dcec2e92b8931274454R377\n. This only gets called when there's a single text child\n. I thought we made the decision that recovering from error work should use whatever priority created the error in the first place?. Hmm I think I may see how this would work, I'll try it out. Hmm good question.... Ah the previous, failing test is putting the scheduler into an inconsistent state, causing this test to fail. Something isn't being reset in a finally block. I had a similar bug earlier, should be easy to narrow down and fix.. Is my latest commit okay? Had to add another loop outside so that we can continue after an error. Yeah I'm working on it now. Oh right that's true. js\nReactDOM.render(null, el);. It was added to fix the multiple roots issue.. https://github.com/facebook/react/pull/8304/commits/46581a3f8042b0467f318e121838af1863ba1885. Not really other than this was how the root was already being checked. Yeah let's do this as a follow-up. I like the flushWithCycles idea. The way flushDeferredPri works right now is confusing because it takes 5(n+1) to do n cycles of work.. Good call, I think those should be special-cased like cWU so they don't interrupt deletion.. That's right. Didn't seem like it was worth the extra try-catch block, since the component will get unmounted anyway. I updated the test to match the new behavior.. I kept the second part (after pendingCommit &&) inline so that it would short circuit, but I guess the entire expression could be pulled out if that makes it clearer.. HighPriority is scheduled with a deferred callback, not an animation callback. This was the reason for the name change a while back.. I'll add a comment to explain. This is so that updates that occur after a root completes but before it commits are not dropped. I added a unit test for this. Previously completed roots were always immediately committed so it wasn't needed. (Btw this is the thing I joked about on Twitter that took me two hours to debug haha.). That would change semantics because it the condition fails it should go to the else block. Could you look at the latest commit and see if you think it's clearer? I'd link to it but I'm on my phone right now.. No but the code you're commenting on here is outdated. Still on my phone but it's line 552.. This was removed in a later commit. Yeah I'll just get rid of it. You lied! https://github.com/facebook/react/pull/8479#discussion_r91148215. Does this mean use the updateQueue?. The updateQueue does this by default, so sounds good.. I can't remember exactly... it has something to do with the changes I made to the work loop. But I'm changing this completely right now per our discussion. I'll see if I can revert this change, and if not I'll explain why.. So I think the reason I added these additional checks is to support the case where we switch from a direct text child to an empty child (null, undefined, or boolean). So these checks should actually be comparing nextProps.children, not prevProps.children.\nCould you add a test for these cases? It's my fault those don't already exist :). I had them outside at first but it was awkward because it required exposing access the current priority context, which seems leaky. Either the class module needs to be aware of the priority context or the scheduler needs to be aware of the update queue.. Dang and I thought this was so clever too :D. Hmm well it needs to change whenever nextPriorityLevel changes. Maybe in findNextUnitOfWork? I'll see.. Will address in separate PR. Fixed. Np that value is immediately reset anyway. Oh nvm I thought this was a different line (on my phone). Okay I'll just use like 999 or something :D. Haha okay. It was exploded but then whenever I made changes I kept forgetting to update both versions. Maybe that's not a big deal once the code is stable, though.. Oops I forgot to clone this update before adding it to the callback list. Ok I'll remove insertUpdateIntoQueue and inline the logic and see if that helps. Or maybe I'll keep insertUpdateIntoQueue but won't use it for the case where the update isn't cloned, and instead handle that case manually.. Only reason that function exists is for first and last, it's really easy to forget to update those.. Could perform the check separately inside addUpdate, addCallback, et al.. Hmm I don't think this isEmpty thing is necessary. Naming is bad. state is the accumulated state. prevState is the initial accumulation.\nRoughly what this code is doing is:\njs\n// initialState is the state before applying any updates\nconst nextState = updates.reduce((accumulatedState, update) => {\n  if (update.isReplace) {\n    return update.partialState;\n  } else {\n    return merge(accumulatedState, update.partialState);\n  }\n}, initialState);\nBy applying the update to the initial state rather than the accumulation, it effectively drops the previous updates. But... this actually isn't right anyway because we should only drop updates with the same priority. We already do this in addReplaceState. So this comment is wrong and we should always pass state (the accumulation).. I think this is detritus... something I tried out but isn't actually necessary.. I'll remove. Not that it really matters but\njs\nsetTimeout(callback, 0, { timeRemaining() { return Infinity; } });\nwould save an allocation :). @sebmarkbage You're right that these should be moved outside the scheduler. I'll do this as part of #8585.. This is the test case that I struggled to get passing. Passes now, but I'm not sure if the solution is correct.. Also I think this is only really a problem for the initial mount, when there is no current tree.. What was happening before I added blockedChild is that the blocked PromiseForFoo fiber was being thrown out, causing a new one to be mounted at a higher priority, which blocks the tree again.. Amended the commit, here's a link to the same test case: https://github.com/facebook/react/pull/8595/commits/e91a3facb87fe92bf9d300b8b2fcc8249d833c2e#diff-935a1efc6cdeb4dee86edd8bd0b4ba6aR133. Hmm good question. I don't think so. What is the right behavior?. https://github.com/facebook/react/pull/8585. Actually for a deep error I think they would because we catch unmount errors during the commit phase and continue committing the rest of the effect list.. try blocks prevent the containing function from being optimized. Can you find a way to solve this problem without adding a new try block? Maybe by fixing it in unwindContext?. Explained by the now-deleted comment above:\n\nIn Fiber, the initial callback is not enqueued until after any work scheduled by lifecycles has flushed (same semantics as a regular setState callback outside of a batch). In Stack, the initial render is scheduled inside of batchedUpdates, so the callback gets flushed right after componentDidMount.\nTODO: We should fix this, in both Stack and Fiber, so that the behavior is consistent regardless of whether you're in a batch.. I'm actually not sure why it re-rendered immediately before, since setState is called inside componentDidUpdate which should happen in a batch regardless. Is this too significant a change to make in a non-major release?. partialState at the top level is always an object with the shape { element: something }. The previous test was just wrong. I thought about writing a unit test for this but it's unobservable except in incremental mode. And when we do switch to incremental by default the top-level mount/update/unmount API will have to change anyway.. Didn't seem worth extracting into a function.. Your suggested change is wrong because\n\njs\nObject.assign({}, { element: element }, null);\nmerely copies the previous state, whereas an unmount sets element to null.. Just removing this guard. I was going to remove scheduleSetState et al from the scheduler anyway because they were just an extra layer of indirection around addUpdate et al. See @sebmarkbage's comment here for context: https://github.com/facebook/react/pull/8538#discussion_r92308098\nTo avoid introducing this problem again we could delete addCallback and enqueueCallback since they're no longer used. Sebastian thought it was better not to break the existing class updater API on the off chance someone was relying on it.. Ok then I'll remove. Could we put the reassignment of priorityContext (line 208) inside resetContextStack? It's not quite the same as the other contexts but it serves a similar purpose.. Will we actually do this?. Shouldn't we return workInProgress.child inside this branch? I get that bailoutOnAlreadyFinishedWork does that anyway but if there's state then it's not really a bailout, is it?. Nice!. GitHub suppressed my comment on an older commit so here it is again:\nShouldn't we return workInProgress.child inside this branch? I get that bailoutOnAlreadyFinishedWork does that anyway but if there's state then it's not really a bailout, is it?\n. Yeah putting it on the updateQueue seems reasonable.. Need an additional check that the tag is HostComponent.. Let's keep the previous name. What you're calling an \"initial effect\" could also be used to describe componentDidMount. I think calling this a \"lifecycle\" is sufficient.. How about commitInitialMount?. Could you explain why we need this extra method? Could we not unify this with commitUpdate? We can determine if it's the initial mount by checking if oldProps is null. That's how we detect the initial mount elsewhere.. In fact the code to handle this is already in master: https://github.com/facebook/react/blob/master/src/renderers/dom/fiber/ReactDOMFiberComponent.js#L609 You deleted it in a previous commit but I think if you add it back, it will work now that the host component is scheduled to update on initial mount.. Makes sense. Let's go ahead and call that method commitMount then. Initial is redundant.. Yeah you're right, I misunderstood when setInitialProperties was called.. Hmm how about we move this to commitLifeCycles? Avoids an extra check. https://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactFiberCommitWork.js#L434. Oops. Oh shoot, missed this. Don't need to check for Update effect because it was already checked by the time commitLifeCycles is called.. Because it also gets called if there's a Callback effect, which host components don't have. I guess it's a bit weird either way, so I'm fine with keeping this as-is.. To satisfy Flow, which complains otherwise. I'm guessing because it doesn't know that syncUpdates executes its callback synchronously.. That's what I thought too but something in the DOM renderer does trigger a re-render in between prepareForCommit and resetAfterCommit, in one of the tests. I'll be honest and confess I don't know exactly why \u2014 something in the event system I'm guessing \u2014 but this seems like a less fragile solution than what we were doing previously (stashing values in global state), anyway.\nIf you revert the last commit you'll see the test that fails.. Good catch. No it's not. Just outside the scope of this PR. It should be accompanied by tests.. Not sure what you mean. All batchedUpdates does it make it so any sync updates are batched together using Task priority. syncUpdates does the opposite, where if you're already in a batch, it forces a synchronous flush.\nThe test only passes if line 347 flushes synchronously. So I'm not sure how you'd get a false positive.. Oh I see. Yeah this test assumes that batchedUpdates works properly, because we have other tests that cover the behavior of batchedUpdates.. I don't have a strong opinion on it, so I'll add it to make you happy :D. Oh right, I forgot that componentWillUnmount is called during the first pass. That explains it then.. I see. I don't see a way to avoid it given that a sync update may occur inside componentWillUnmount. Unless we disallow sync updates there.. That actually might be a good idea... Interleaving commit phases could cause trouble.. Oops, good catch!. Fixed by pushing to an array like we usually do. Since methodName is now always a string, we can remove the typeof check on line 215.. Isn't this the equivalent test? https://github.com/facebook/react/pull/8661/files/ad7bcdf999ffc2cd891aef00174f245bcfb497c1#diff-4f1eede220a643b4c75172fcaf8daf59R370. What about false? Does Stack render that?. Let's put this test in ReactDOMComponent-test.js next to the other dangrouslySetInnerHTML tests. And give it a more specific name, like \"can dangerouslySetInnerHTML with falsy value.\". I started working on a fix for this, which I'll submit as a separate PR, since it's outside the scope of this one.. Hmm idk why that branch was there. Seems ok to remove it.. Thank you for moving the test. Can you remove the ones in this file now? We don't need duplicates because ReactDOMComponent-test is run in both Stack and Fiber mode.. Yeah that works. Brian added validateCallback checks whenever a callback is enqueued. Didn't need it before either, really. The field gets reset whenever we beginWork.. Also the type is stricter now. Previously we iterated through a list of Updates, whose callback type is Function | null, but now we're iterating through a list of functions.. This reminds me though that in cloneUpdateQueue, some of those fields should just be reset since by the time we clone from current, they're no longer valid. Not an observable change but it's what cloneFiber does so better to be consistent.. No bug, just noticed it wasn't being copied and I added it for consistency's sake. Although actually, callbackList, isProcessing, and hasForceUpdate can be reset when cloning. I'll do that instead. https://github.com/facebook/react/pull/8728#discussion_r95282877. Oops yes I meant to do that, forgot!. I think this change is correct. The effect is flushed sooner than before because we're reusing more work. I may be wrong.. This feels a bit weird but I couldn't think of a better solution.. Uh... I don't remember. I thought I did this in a file where the branch wrapped a describe block but that's not true of this file.. Sure, though may I ask why it's ok to use arrays for context but not here?. Meh I guess I should just put these directly on the update queue type :D. What's more important, that this List type is generic or that we avoid the extra allocation?. Could also make the List type an intersection of the ListNode type, like the UpdateQueue type was in the first version.. https://github.com/facebook/react/pull/8752. I think that's the message for when you return a non-element in a composite component. The one for top-level is here: https://github.com/facebook/react/blob/master/src/renderers/dom/stack/client/ReactMount.js#L439. Oops this should be an invariant. Well huh, it looks like sometimes Stack warns and sometimes it's an invariant?\nhttps://github.com/facebook/react/blob/master/src/renderers/shared/stack/reconciler/ReactCompositeComponent.js#L46. Haha didn't see that PR, sorry Dan! I'll rebase on top. I'll cherry-pick everything except the last commit, in favor of the way I did it here, for the reason Sebastian gave here: https://github.com/facebook/react/pull/8648#discussion_r94506177. We're already pretty inconsistent throughout the codebase :D One day we'll go through and clean this up. I put the memoization after reconciling the children because it seemed to make the most sense conceptually. Perhaps I could move it earlier before any lifecycles. The tricky part about that is that some things need to read from the previous memoized values. So you'd have to pass those around and it gets a bit hard to follow. But there's likely a better way to structure all this.. I'd like to get to the point where we never read from the instance at all. This is one of two (I believe) places where we still do.. Haha I almost did it so I could log when I was happening :D And at one point it was a bit more involved.\nI agree this could be restructured in a better way but when I'm unsure I prefer to just find something that works and passes the tests and then clean it up later.. *mostly, not almost. For example if I rewrote all the stuff in ReactFiberClassComponent, and then you told me the overall approach was wrong, I'd have wasted a bunch of time. And it would be harder to review. Easier to rewrite after overall approach is figured out.. I agree but that breaks an assumption we make in a few places that we always have either pending or memoized props. I figured that was outside the scope of this PR but I'll fix it here if it helps this land. Shouldn't be too difficult.. A bunch of tests fail because of this invariant: https://github.com/facebook/react/blob/24b8ba7340f5ce66df0b858ead480ca7103a8153/src/renderers/shared/fiber/ReactFiberClassComponent.js#L329. That wasn't the case before because we would always memoize in completeWork, even if it failed in beginWork.. Haha if I remove those invariants everything seems to still work. I guess I thought it'd be a bit more complicated than that. I'll go ahead and push that :)\nEdit: Never mind, this actually does break some things. Hmm although what should get passed to shouldComponentUpdate the next time if we set memoizedProps to null? An empty object?. I guess in that case we shouldn't call shouldComponentUpdate at all since it's as if it's mounting for the first time.. Yeah that was an oversight on my part. Let's rename the test so it's clear that this is specifically about updating the pointers before calling lifecycles.. Good point. Looks like Stack only accepts undefined. I'll add a test. https://github.com/facebook/react/blob/3bc5595dfd6db741b19f17e7aef98b2c1e4be847/src/renderers/shared/stack/reconciler/ReactCompositeComponent.js#L1203. Updated. Refs shouldn't schedule an Update effect anymore, since we added the Ref effect. Forking the entire function was the only way I could get it down to a single check. But you're right that there's a lot of overlap and it's weird to fork the entire thing. I split it out into three checks instead.. Only need this in DEV. Just noticed that, not sure why. It does work the old way but it warns. Stack doesn't warn but it seems like it should?\nWhy doesn't Stack warn?. https://github.com/facebook/react/pull/8919#discussion_r99279560. Good catch. There's an identical non-dev check that happens below. I'll refactor so there's only one check.. I was thinking if there's no iterator in DEV, skip the key warning and go straight to the prod invariant, which will throw.. Yeah we currently only warn about different copies of React on unmount. Yep, my bad. Hrrm, didn't think about that. Don't think it makes a substantial difference but we can change later.. Yeah I'll loosen those up. Should do a pass at some point and change all our maybe types to null unions. Though props is currently an any, which is worse.. I think this is correct because if it's not an iterator then we shouldn't have reached this code path.. Yeah, I copy and pasted this from Stack. I'll change it in both places to use multiple invariants instead.. Oops just noticed this. My hunch is that setState on an unmounting parent in componentWillUnmount isn't that common but yeah I'll check. Code changed, moot now anyway. I'm passing null in prod. But yeah, I like that better anyway.. Should do the same in ReactFiberUpdateQueue https://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactFiberUpdateQueue.js#L217. Is the name argument worth keeping?. I'm guessing the name parameter is only important for ErrorUtils. I'll come back to this before landing.. Wrong test name. Maybe clarify that react-transition-group is a package?. I actually don't know why Flow didn't catch this before, because the type on performWork was already Deadline | null. Would it not be simpler to mock the component just once, on mount?\njs\nworkInProgress.type = mockComponent(...);. That way this would be the only place we'd ever have to branch on hasMockingBehavior. toTree() is part of the test renderer, so you could store the original type on the mocked type.. I don't think this needs to be released until 16. Could be mistaken.. Yeah.. Seemed like it might be a useful opt-in, perhaps if a lib's error messages are less specific and don't include the component name. But yeah I'll just get rid of it.. Not sure I understand the advantage of getStack over formatMessage? Isn't the latter a superset of the former?. Interesting!. Looks like it's a superset. I'll consolidate.. Fixed. Regarding the naming, we pass both pending and memoized props to this method. areChildrenOffscreenForGivenProps is kind of a mouthful \ud83d\ude06. Yeah the \"should\" is better but I wanted to be more specific than \"deprioritize\". shouldChildrenBeOffscreen?. I guess my question is whether there's another deprioritize case besides hidden where you want to deprioritize but not as much as if it's offscreen.. +1 to \"subtree\". Yeah, I think it was written that way originally because capturedErrors !== null was just capturedErrors, and when it was null the whole expression would evaluate to null unless it was coerced. I'll change it.. I'll ask the Flow folks. Same here what?. Oh nvm I see your comment above. We have a separate effect for refs (Ref). The Ref effect gets marked here: https://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactFiberBeginWork.js#L273-L274. Or wait, should ref change trigger a componentDidUpdate call? I assumed no but maybe it should.. Outside the scope of this PR, but we should probably have a separate check for callbacks, for similar reasons.. Style q: why are these separate checks?. Yeah I can see how that looks a bit messy.\njs\nif ((!current && typeof instance.componentDidMount !== 'function') ||\n    (current && typeof instance.componentDidUpdate !== 'function')) {\n  return;\n}\nAlternatively, you could do\njs\nif (current) {\n  if (typeof instance.componentDidUpdate !== 'function') {\n    return;\n  }\n} else {\n  if (typeof instance.componentDidMount !== 'function') {\n    return;\n  }\n}. I wonder if we should move this check into the switch statement. Already bad that ContentReset isn't in there. It requires adding a bunch of combinations (e.g. PlacementAndRef, PlacementAndUpdateAndRef, UpdateAndRef, etc) but it's better for perf.. Perfwise is it the same? Does the engine have to check current twice?\nAlso we should use current === null. Missed one :). @spicyj Is this an automatic comment? :D. docs/js/react.js is not a source file. Please revert any changes to it.. This is not a source file. We have a transform that converts if (__DEV__) to the output you see here.. What are you trying to do here?\nThe problem we're trying to solve is that if instance.updater is mutated, it will break setState (and replaceState). \"Updater\" is a common enough word that someone might do that accidentally without realizing that it's a private React method:\njs\nclass MyComponent extends React.Component {\n  constructor() {\n    // This will break setState :(\n    this.updater = someCustomValue\n  }\n  /* ... */\n}\nI think we should either warn whenever updater is mutated, or obscure the name.\nSince it's possible someone is relying on updater, let's go with the first option and print a warning. Something like\n\nComponentName: The updater property is an internal React method. Mutating it is not supported and it may be changed or removed in a future release.. The code you've added won't work because it happens too early. You'll see what I mean if you write a test.. Suggestion: use Object.defineProperty to define a custom setter on the class prototype.. Me too except it truncates some of the file names without it.. Rebase mistake I think. We can do that in 15.5 (I have a separate branch that I haven't pushed to yet) but in 16 React.createClass is undefined. We could use a void function and warn in there but that would lead to confusing errors in prod.. I like the instinct to use snapshots but since that's not how we test all of our other warnings, let's just use a string matcher.. We prefer to test using only public APIs when possible. I don't think we need this test. If this were to fail, a bunch of other tests would fail too because we'd get an extra warning every time we created a class.. A valid updater is any of the ones React uses internally. So this also includes the updaters used by Stack and Fiber. (Be aware that there's a module called ReactFiberUpdateQueue but that's not an updater. An unfortunate naming collision.)\n\nInstead of validating the shape of the object, I would add a DEV-only property to each of our updaters and check for that.. Let's wrap this whole function in a DEV block so it gets stripped out in production. Let's maybe prefix isValidUpdater with an underscore so people aren't tempted to add it themselves?. Make sure it only warns once so we don't spam the user with multiple warnings, and add a test for this behavior.. Maybe include the suggestion to use React.Component instead? Slightly more actionable.. Let's add a todo here so that we come back and remove while (true). > setState() is an asynchronous method\nSometimes it's sync and sometimes it's async, depending on the priority of the update.\n\nduring the next update cycle\n\nWhat does \"update cycle\" mean? The next time the component is rendered? That's not true because the update might not have enough priority.. > Accessing this.state after calling this method can potentially return the previous state\nIt could also return a future state that hasn't flushed yet, or a state that was aborted completely.\n\nThis is a common source of bugs in React applications.\n\nSource? This seems overly alarmist.. Again? I believe this is the first time :D. Let's add something like \"it will be removed completely in React 16\"\nAlso, maybe we could make this warning and the one for React.createClass more consistent.. See https://github.com/facebook/react/pull/9399#discussion_r110997070. Suggestion:\n\nPropTypes have been moved to a separate package. Accessing React.PropTypes is no longer supported, and will be removed completely in React 16. Use the prop-types package on npm instead.. And then with a link with more explanation. This is better, but I'm concerned that it implies that this.state is a source of truth. You can mostly get away with this assumption in sync mode, with the exception that you describe here. But this won't be the case with async.\n\nWhat I'd like to write is\n\nYou should only read this.state (or this.props) inside a lifecycle method or render. It's not safe in an event handler, promise handler, timeout callback, or any place in the stack above React, where you should use this.setState((state, props) => stateUpdate) instead.\n\nbut this might be too prescriptive. Because again, this isn't really an issue in sync mode, only with async. And we'll likely have to come up with a new API for async mode, anyway, at which point this setState doc will be moot.\nMaybe this is a good way to split the difference:\n\nsetState() does not always immediately update the component. It may batch or defer the update until later. This makes reading this.state right after calling setState() a potential pitfall. Instead, use componentDidUpdate or a setState callback (setState(update, callback)), either of which are guaranteed to fire after the update has been applied.. Not related to this PR, but I love that we check these stats in \ud83c\udf89 . Do you think it's worth splitting this out into its own module? Might be easier to just inline it in both places.. For our new test suites, we're trying to give them names that are less coupled to our module structure and implementation details. Maybe ReactChildren instead? Not a huge deal. Ah right. Let's just put it there then?. Actually I'm confused by how this works. When are we supposed to update this file? @gaearon @trueadm . Oops, meant to delete this invariant. I'll add a comment explaining what it does and a TODO to figure out a better name \ud83d\udc4d . If I were to abstract this, I would change createFiber to accept the return fiber, and copy the contextTag in there. But that requires changing a bunch of call sites, so for this first pass I'd rather leave it as-is until the repetition becomes a nuisance.. If we do that then we might want to change unstable_asyncUpdates to a static property instead of an instance property, so that it's available during reconciliation.. Probably makes more sense as a static property, anyway.. Oops neglected to delete this, don't need it anymore. Because I don't know if the priority level returned by getPriorityContext is the default priority or, e.g. Task priority inside a lifecycle. and I only want to override the result of getPriorityContext if it's the default priority.\n\nWe could also solve by getting rid of getPriorityContext and moving addUpdate, addTopLevelUpdate, et al back into the scheduler, but we previously decided to move them out because the scheduler was getting too bloated.. Yeah but life-cycles are just an example. It applies to any time we change the priority context from its default, like in event handlers or during reconciliation.. Should we only do classes, or functional components, too?. Can you add an assertion to make sure the update processed, but wasn't committed yet? Maybe by passing an updater function to setState instead of a plain object.. Any reason we don't pass the node to this function? Need to assign it to stateNode anyway.\nOtherwise I don't understand the value of this function versus calling createFiber directly.. Yeah maybe that's a bit better. Don't think either name makes it clear what it does or how it's different from progressedWork. I'll be sure we circle back to the naming before landing this PR.. Interesting, I wrote it that way at first but then rewrote it this way because I thought it was easier to understand haha :D. It's like choosing between De Morgan's Law and a double negative: which is more confusing??. Version 1:\njs\n!(progressedWork === workInProgress && workInProgress !== newestWork)\n\"Don't resume on the work-in-progress if it's not the newest work\"\nVersion 2:\njs\nprogressedWork !== workInProgress || workInProgress === newestWork\n\"Don't resume on the work-in-progress unless it's the newest work.\"\nYeah I guess version 2 is better.. Let's use mixed instead?. Yes please. Yes. It will return true if they reference the same object in memory, which is what this is checking\njs\nconst emptyObj = {};\nconst refs = emptyObj;\nrefs === emptyObj; // true. Saving that for the end :D. I think it can be a follow up along with the other error issues we know about. Not related to this PR, just something I noticed.. I have a comment in beginWork but yeah I'll add one here, too. I'm planning to do another comments pass before landing.. Could you add a comment here with the explanation you gave to me in person?. It's fine. This test fails but I want to check it in, anyway. Maybe we should use the same approach for incremental bugs as we did for Fiber \u2014 put failing tests behind a feature flag and track them with a script?. setState inside componentWillReceiveProps schedules a callback if one is not already scheduled. What we should do is not schedule an additional idle callback if we're already performing idle work.\nThis is an existing issue, though, not one introduced by this PR. It's only visible now because the new version of ReactNoop.flush() keeps flushing until there is no more work (until scheduledDeferredCallback is null), whereas before it would only flush the current callback.\nThe fix is simple but outside the scope of this PR.. Sounds good. scheduleAsyncCallback? Seems redundant, but so does \"deferred\" :D Will we ever schedule more than one type of callback?. I can change the version constraint \u00af\\_(\u30c4)_/\u00af It's just the noop renderer. Basically this is a result of me trying to both 1) avoid while (true), and 2) not repeat the same checks that are done in workLoop. Should I just use while (true) and break  / continue?\nI could get rid of hasRemainingAsyncWork by scheduling the callback inside this loop instead of once we exit it. That's how I did it originally but I found this easier to follow. I'll change it back.. Maybe? Why didn't we already have a HighPriority test then? My impression was that this test existed because of the different semantics for Animation priority versus async/deferred priorities.. I asserted on the children instead.\njs\nexpect(ReactNoop.getChildren()).toEqual([span('')]);. Let's just call it scheduleDeferredCallback for now but idk how descriptive that actually is.. This is the topic I brought up at lunch. I believe you're the one who suggested this to me, and why I added this comment :)\nSeems correct to me that if we setState at Task priority, but we're not already performing work, we should schedule a callback and perform it later. The other option is to treat it as synchronous work, I suppose. We need to decide whether \"task\" priority should be treated as semantically different from sync priority for non-nested updates.. Added a snapshot test. You're right, this check is redundant. I added this check first, then realized it made more sense to check isPerformingWork in scheduleUpdate, but forgot to remove the check here. I'll remove it.. Fixed. Discussed offline, but documenting here for anyone watching.\nBoth branches are performing synchronous work. What's different is the first parameter to performWork, which specifies the minimum level of work that should be performed. In the normal case, we should perform both task and synchronous work. In the isUnbatchingUpdates case, we should only perform synchronous work.. We fall through elsewhere, e.g. https://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactFiberBeginWork.js#L864-L869. Interesting, I wouldn't have guessed that forEach was the fastest way to do this. TIL. https://jsperf.com/set-iterator-vs-foreach/4. Fixed. I think it's not needed because we handle this during priority reset, here: https://github.com/acdlite/react/blob/9713bd40a6e4eb406b6f66b8a55c4bbd662d5ae3/src/renderers/shared/fiber/ReactFiberScheduler.js#L558-L564. beginUpdateQueue sometimes clones workInProgress.updateQueue, so we need to point to the latest version.. Updated. How would you change it? Or is it better after my latest commit?. This extra check ended up not being necessary because we set nextUnitOfWork = performUnitOfWork() but I left it for clarity. Don't mind removing, though.. Including the name of the component in the message probably isn't necessary. The JS stack will include either componentDidUpdate or componentWillUpdate. And the component that's updating won't necessarily be the component whose lifecycle triggered it.. Oops. Fixed to reset at the end of performWork.\nBefore fixing, I changed the limit to 3 and ran the tests again, got lots of failures as expected. So I guess in our ~whole~ test suite we have fewer than 1000 nested updates.\nEDIT: The scheduler state is reset for each individual Jest file, and the test that triggers the infinite loop is at the end of its module. So it wasn't triggering a failure because no Jest file has greater than 1000 nested updates.. Also we do this everywhere :D But yeah I'll move it out. My reasoning is that it's always ok to do an async update in componentDidUpdate because it's non-blocking. So we shouldn't ever throw this error for an async update. E.g. If you do LIMIT - 1 nested sync updates, and then an additional async update, that should be fine.. ...well that example is bad now that the check is in findNextUnitOfWork. Here's a better one: if you commit at async priority, then you have remaining time, so you commit again at a lower priority, that's not a nested update, it's just two separate priority levels. By adding this check, we know we're only counting updates that were scheduled in the previous commit phase.\nThe other way we could implement this is by counting the number of commits in which setState is called at least once. Then we don't have to do a priority check. Now that I think about it, that might be more elegant.. Turns out this isn't observable in master because beginFailedWork doesn't read from context. All it does is render null. So the order of beginFailedWork and unwindContext ends up not mattering. I'll improve the test anyway, but that's why we weren't getting errors before.. It does fail in this PR though because of a push/pop context mismatch. We end up popping the boundary twice. I'll fix it!. We run this whole suite in both prod and dev mode. https://github.com/acdlite/react/blob/155648e26724083132b5fb3a2172c7d288533e08/src/renderers/shared/utils/tests/ReactErrorUtils-test.js#L22-L45\nThe dev version of invokeGuardedCallback is only enabled in dev if it passes a feature test. jsdom happens to fail that feature test, because it doesn't handle throw null. So I added a flag to ReactDOMFeatureFlags that forces the use of the dev version. https://github.com/acdlite/react/blob/155648e26724083132b5fb3a2172c7d288533e08/src/renderers/shared/utils/ReactErrorUtils.js#L187-L191\nFor Chrome and Firefox, I think we'll have to rely on a manual browser fixture, unless we start running automated browser tests.. Ha right, right :D. Updated. About to push a commit that does this the same way as PureComponent. Fixed. I did it the same as PureComponent. I don't have all the context for why this is important, but if it is, we should do it for PureComponent as well.. Oh right, the Jest thing. Yeah, funny that the \"worst case\" in this situation is exactly what we'd want it to be, anyway, per our recent discussion. :D. Just to make sure\njs\nvar {invokeGuardedCallback} = require('ReactErrorUtils');\nstill works (though I avoid this in invokeGuardedCallback anyway). Ok yeah, I'll do that and also add some comments explaining how this all works, because it's not so straightforward if you don't know what this is all for.. We could also create our own error object with a helpful message explaining what happened. If there is browser flakiness, this would be more helpful to the developer than throwing undefined.. Which boolean flag?. I swear I do this every time :D. didError needs to be separate so that it doesn't depend on the error event firing, only on whether the function errors.. I meant \"clever\" pejoratively in this case, but I'll reword.. Let's be honest, this is going to look confusing in a stack trace regardless :D I'll change it to something more specific, though.. But as long as it's in the codebase, I think we should keep the implementations in sync.. I guess I misunderstood @bvaughn's original description of this change as a bugfix, or improvement to a more correct behavior. Subsequent comments suggest otherwise.\nNow that I think about it, this only affects context providers, right? So I guess functional components aren't affected?. Suggested refactor:\njs\nif (didChange) {\n  const mergedContext = processChildContext(workInProgress, previousContext, true);\n  instance.__reactInternalMemoizedMergedChildContext = mergedContext;\n  pop(didPerformWorkStackCursor, workInProgress);\n  pop(contextStackCursor, workInProgress);\n  push(contextStackCursor, mergedContext, workInProgress);\n} else {\n  pop(didPerformWorkStackCursor, workInProgress);\n}\nOne fewer branch and prevents Flow from complaining.. In that case, you would use an Access Control Allow Origin header. Do you think we should add this detail? Might be better to link to a page with more details?. Will that be dead code eliminated?. Flow. I want it to be DCE'd, but if we change this to always ignore the message in DEV then this doesn't matter. https://github.com/facebook/react/pull/10353#issuecomment-319718373. In the production build, it will be DCE'd the same as the rest of the DEV blocks. What I want to DCE is the extra checks\njs\nerror != null && error.__reactShouldIgnoreErrorMessage === true\nthat only happen in DEV.\nBut this convo is moot anyway, because I'm going to remove this branch and just always ignore the error message in DEV.. \"syncrhonous\"\nGah, every time. I don't even know how this happens because 'c' and 'r' are both left-hand keys \ud83e\udd26\u200d\u2642\ufe0f . Also just realized this isn't an amazing explanation. Without the setImmediate, the update is batched because it's inside an event handler. With the setImmediate, the update is deferred until the next tick, but within that tick, the setState is synchronous.. Because for some reason I was thinking that wasn't in master yet :D Good call. In production we use a try-catch, so the browser doesn't log it. Only our error logger.. Oh, unless the error is unhandled and rethrown. Then we double log. I think we could fix that.. Good call, I'll add a guard there as well.. We decided that cleaning up capturedErrors when an error boundary's parent is unmounted (see test added in https://github.com/facebook/react/pull/10403/commits/894656cda2d60dac3b9de147c5bdf730c3e55b9d) wasn't worth it, and so capturedErrors !== null is not a reliable indicator that there are unhandled errors.\nIf you're referring to moving the check to a while loop, that's how it used to work, but we recently refactored the work loops to do as few checks as possible on each iteration, and only do certain checks (like whether the priority level is correct) right after committing, which is the only time they change. Requires a bit more duplicated code but fewer runtime checks.. @sebmarkbage I went back and forth on whether this should be an optional method. Landed on making it required because all renderers will need to account for features like expiration boundaries.. Is this polyfill sufficient? Or am I overlooking something?. performance.now needs to be bound, but looks like Date.now doesn't. I'll update.. Why did this file change?. Can we remove the \"so\" and make it two separate sentences?. Remove the .js extension. This should be\njs\ngetComponentName(owner) || 'A component',. Not that I can think of, more concerned about the case I can't think of, like how I didn't consider error boundaries. Is this a perf concern?. I can think of some in async mode, just not sync mode.. Hmm that's what I recorded in my notes after yesterday's conversation, but I may be mistaken. I though the rationale was that toString could be slow and we should encourage people not to rely on it.\n@sebmarkbage. Yeah you're right, Sebastian says (for now at least) we'll omit the warning, since so many people rely on it. We may revisit this in the future.. Brain fart, my bad. Jest doesn't seem to like it if there's a snapshot test in both projects. Only really care about Fiber, anyway.. Flow also caught this error, I just forgot to run it. There's probably a better way to do this but idk what it is :D. What I really want is a callback that says \"Hey CRA is serving your app now, go ahead and run your tests.\". Ooh, didn't know Flow treated those differently.. Works for me. (I figure we can have a team bikeshedding meeting before we land this :D). Hmm, is this behavior really necessary for work that prerendered async? Or is it only relevant to sync work?. Could you explain why prettyFormat is necessary here?. We want to avoid optional types like ?Fiber in favor of Fiber | null. Since this file is already using optional types it's fine, just letting you know for the future.. Similar thing here. Explicit null checks node == null && node.sibling === null are faster, so we favor those in the Fiber codebase. Not a blocker.. Oops yes, that was a typo, I meant node === null. And yeah, same thing.. Looks like the same issue, but for HostComponents. This whole function is a code smell, IMO. Ideally we'd bail out on low priority before we ever call performUnitOfWork. I tried this out on my big refactor PR from earlier this summer. Will revisit when we add back resuming.. Just the noop renderer is fine :D This doesn't touch any renderer-specific code.. I\u2019m sorry :( Didn\u2019t know you were struggling with this. If something\u2019s not renderer specific, we usually just test with the noop renderer. Except for older tests, which use React DOM.. Good call, I think I was trying to avoid too many \u201cwe\u201ds and fell off track. Hard to find the right voice!. I tried a blockquote but that's what we use to format those yellow \"Note: \" boxes :(. Oops. Oh cool, my bad!. Good call switching these all over to your account. Maybe we could create a shared React Codepen account so that anyone can make changes without updating the link? Unless it's too much hassle to switch between accounts.. Might be worth adding an inline comment about accessibility, in case people copy + paste without reading the other note.. \"Entry\" modules are the public API. The renderer is what you create out of a host config. For whatever reason, our React Native renderer splits the two into separate files, whereas our DOM renderer does not. Don't think there's any real reason, just happened to be factored that way.. Can delete?. Oh never mind, I see the commented out code below. Names are a bit confusing. PerformedWork means this fiber was worked on. PreparedWork means this fiber has stuff that needs to be garbage collected if it's dropped without committing.. They're separate because not all fibers that are worked on need to be garbage collected.. Yeah I'm not happy with any of the names here, was just trying to avoid a naming clash. NoWork seems fine, can import the other one as NoWorkPriority if I need to.. This function used after checking the deadline so we know whether to resume or yield, and after a setState to schedule a callback. https://github.com/acdlite/react/blob/867aeac5819c997bfee0a0ddf7d973624ef5e3d2/src/renderers/shared/fiber/ReactFiberScheduler.js#L1475\nPriorityLevel is also used for going the other direction: priority -> expiration time. When scheduling an update.. Rather than change the priority context every time we start on a new bucket, and then change it to task in the commit phase, and then reset it to the previous value when an error is thrown, I found it was simpler to move this complexity to getPriorityContext. https://github.com/acdlite/react/blob/867aeac5819c997bfee0a0ddf7d973624ef5e3d2/src/renderers/shared/fiber/ReactFiberScheduler.js#L1520-L1552. Agree it's confusing. Working on a PR that will remove this function entirely, so I'll leave it for now.. @blling https://github.com/facebook/react/pull/10715. Let's just move this to ReactEntry.js, since it's not a class anymore.. Let's actually render these elements. The missing key warning is fired during reconciliation, not element creation.. Seems like there's no point in this being a separate function anymore. Let's inline it into createFiberFromElement.. I don't get this block?. What's this for? Copypasta?. Nah but I feel a pang of guilt whenever I intentionally do something \"unsound.\"  If this were Reason I'd be forced to handle it :D But you're right, I can get rid of it.. \ud83d\udc4d  I did that here: https://github.com/facebook/react/pull/10624/commits/9154198c3b188f6c4db2d9094d57f397bd3f2154 Held off in this PR until it's actually needed.. Nah, should probably throw? I'll address in a follow-up.. Didn't we just add an API called createRoot? :D. Also I think that comment is outdated post-portals, but I wasn't sure enough to delete it.. \ud83d\udc4d  I'll address this before landing, mostly pushed this for feedback from @sebmarkbage. Let's use div and span helper functions like we do in the other test modules. https://github.com/facebook/react/blob/56e5288b042523729d5f8b84a3e569b0b96a329a/src/renderers/shared/fiber/tests/ReactIncrementalSideEffects-test.js#L26-L33. If Stateful never re-renders, then instance points to the previous value. So we need to test that Stateful actually re-renders to avoid a false negative ;) The ops.push() pattern is useful here. Could also check if componentDidUpdate is called, rather than comparing instances.. Same feedback as above. and again. Looks like your PR branch has fallen behind master. This flag no longer exists since we deleted Stack. You'll want to rebase it.. What's with all these style changes? Prettier version mismatch?. It looks like the only difference between this branch and the next is that if it's a Fragment fiber, the pendingProps should be the children. Can we merge these two branches and only branch on that assignment?. Same as previous comment. Why are you checking the type of return fiber? Does it matter?. Do we? We might have in Stack, but that's no longer the \"existing React.\" :D If we don't support it in 16, let's not worry about it.. Because I was lazy and didn't want to import it :D. Would you like to rewrite it for me? :D. Before the fix, this would infinite loop. That's what was failing in www.. Updated. @gaearon I'd prefer to keep it for type safety for queues that don't belong to Fiber. Don't have any of those yet but could in the future (I do in one of my PRs).. I'll put it in both places :D. I think the easiest way to review this would be to start here. Everything after this line is meant to be extracted into the renderer. It's all logic that already existed, but used to be spread out across the scheduler.. AFAICT the changes here are only because the commit phase is now a separate entry point. Other than that it's the same.. Yeah we should do a renaming pass. I always assumed you went with \u201cnext\u201d to avoid confusion with the current tree.. It throws. Could exit instead? I don\u2019t think it\u2019s quite as huge a burden if most things are async.. commitAllWork used to be called from inside performWork, where the flag is set.. Yeah I like that. The reason I moved this here is so that it's not coupled to the magic values for Sync and Task. The only reason it's still a global is so the error is thrown inside setState, for nice stack traces. Otherwise it could be local to the while loop in flushWork, which is where it conceptually belongs.. Updated. Once we lift batchedUpdates into the DOM renderer we can get rid of unbatchedUpdates (a hack to account for legacy Stack behavior) by treating any unmounted tree as unbatched.. https://github.com/acdlite/react/blob/cfa98b631ebdef4005cb7e98f2a86f8809c78945/packages/react-reconciler/src/ReactFiberScheduler.js#L1570-L1580. @sebmarkbage Since I'm pretty sure you'll comment on this, I think this could be improved by using if statement + a do-while loop.. Eh nah it's better this way. Checking at the end is confusing because the list is mutated inside the loop.. Never mind, got it to work with just control flow.. For the record, I wasn't working on this for the whole two hours. I ate dinner then read a book and then came back to it :D. @sebmarkbage This is the part we were discussing earlier. Need some way to tell the reconciler to treat all work up to expirationTime as synchronous. Here we do this by passing the same time as both the current time and the expiration time. But since the reconciler only uses the current time to check whether it's sync or async, a boolean would also work.. No I like having the focused cases so that if I\u2019m debugging this later and those fail I can focus on fixing those first, which may have the effect of fixing the complex ones too.. Can we change this to mixed instead of any?. Hmm, that's how I did it in https://github.com/facebook/react/pull/11232... The root state contains a deferred field that's true if the tree shouldn't be committed yet. Don't know why I didn't do that here again. I think maybe I thought it would conflict with the new deterministic updates behavior, but that doesn't sound right. I'll update.. Ah, I think it was this: the current renderRoot API returns finishedWork if the tree completes, but there's no way to say \"this tree has no more work left but also it isn't ready to commit yet.\"\nI wish we could return multiple values from renderRoot. Like a tuple of (finishedWork, deferCommit, didError, errorObject). The tricky part is that a root can be deferred at multiple levels. When the first one is flushed, the second level is still blocked from committing.\nAfter talking offline, I'll update to use an array of expiration times instead of using the UpdateQueue type.. For whenever we figure out how errors inside a then callback should be handled :D Would like to do that before landing this PR, if we intend this to ship in 16.1.. My current thinking is that then callbacks should always resolve when the tree completes, regardless of errors. I don't think we can/should support rejection handlers in the case of unhandled render errors, because it won't be clear which update caused the error. Could be from a previous or subsequent update.\nWhat I'm not sure about is the rethrow behavior. If there's an unhandled render error, and the then callback throws, which error should we rethrow at the end?. This is a FiberRoot, right? Can we use an existential type? And maybe a comment. Once we upgrade Flow, we should export an opaque type.. @clemmy @gaearon Can y'all explain how this works? Do we run the tests twice?. Could also have meant componentWillReceiveProps()? Let's include both. I like that, though will also be seen for non-DOM users.. \"some code\" -> \"side-effects or mutations\"\n?. @gaearon Wasn't sure what to do here. Should we show both warnings? How should they be formatted?. Updated. Yeah, let's think of something better. I was trying to keep it concise. What it means is:\n\"An async update starved because the main thread was blocked\". The timeout is a workaround until we have a way to schedule an async update from inside a lifecycle (passive componentDidUpdate).. > Doesn't this mean that >1 call to scheduleDeferredCallback will now result in a timer that can't be cancelled?\nWe don't ever call it more than once. If we want to be defensive I'd prefer to throw. ReactNoop does this, so I'm pretty confident we won't regress.. Nah it's not used by React. I added in anticipation of pulling this out into a standalone module.. We set it back to null in the complete phase, unless we tear (down-prioritize), in which case the torn props are stored on the current fiber. https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberCompleteWork.js#L395-L405. @sebmarkbage Thanks for pointing that out; realized it's simpler to just never reset pending props.  Updated!. What's the rationale for putting the second call after the timer has ended?. Is there a scenario where it's useful for these to be separate flags?. debugRenderPhaseSideEffects seems appropriately generic :D. Nah it's fine either way I think, just curious. createRoot is only useful in async mode, so the rationale is that if you're not async resilient, you should keep using the legacy API.. Updated. I guess because we don't have a test that covers them. I'll add one.. Actually I guess the debug tool is supposed to skip over these. Ooh, yeah, I'll put these on the instance and add a test. This change is because the previous version was screwing up my editor's syntax highlighting \ud83d\ude06 . Yeah that\u2019s the reason. Didn\u2019t know this until @sebmarkbage pointed it out. https://github.com/facebook/react/pull/11818#discussion_r157120923. Previous test case works fine. I updated it so the error is thrown in the ~~render phase instead of the commit phase, since we already have commit phase coverage. But I suppose both test cases are useful, so I'll add the old one back too.~~ Actually, both are in the commit phase. The newer version tests the same thing, I just rewrote it to be a bit simpler.. Not every fiber is cloned before we start work on it again (resuming), but the effect list should always be cleared.. Yea. https://github.com/facebook/react/pull/11901#discussion_r159291448. We try to avoid reading things from the instance directly. Let's use workInProgress.memoizedState instead (probably should be passed as an argument to this function, same as props).. If newState is null or undefined, we should avoid creating a new state object, so that it's referentially identical.\nRelated: if the props haven't changed, we shouldn't call this method. Same as componentWillReceiveProps. Need a test for this.. Unrelated, but why is this test disabled?. Super-duper nit: strict compare to null and undefined: newState === null || newState === undefined. We don't do this everywhere consistently yet but it's slightly faster.. How about something like this?\n\nWarning: MyComponent: componentWillMount() is deprecated and will be removed in the next major version.  Read about the motivations behind this change: (link)\nAs a temporary workaround, you can rename to UNSAFE_componentWillMount instead.\n\n(link) can point to some fburl that we write later.. For this one, we should call out getDerivedStateFromProps as the preferred solution.\n\nWarning: MyComponent: componentWillReceiveProps() is deprecated and will be removed in the next major version. Use getDerivedStateFromProps() instead. Read about the motivations behind this change: (link)\nAs a temporary workaround, you can rename to UNSAFE_componentWillReceiveProps instead.. For now the link can be your RFC :). The Provider's stateNode represents the bits that changed during this render. Setting this to 0 tells the child context that nothing in the provider has changed. I'll add a comment.. This seemed like the obvious place to put this check, but perhaps there's a higher level caller where this can go instead?. This injection was redudant. Here's the other place we do it: https://github.com/acdlite/react/blob/36cac01aa9aaa1aae8204b4219d28fa274baf1f3/packages/react-native-renderer/src/ReactFabric.js#L35. Could you try to come up with a test case that's more representative of a real world use case? As suggested in Sebastian's comment. Ideally a person should be able to look at this unit test and understand not just what the method does, but why it exists.. >  it will be handy when I will get to implementing selection inside the renderer\n\nThis sounds interesting. If you can approximate this use case in the unit test, maybe with some comments to clarify, I'll merge the PR :). I can think of worse ones. You're right, I guess my comment is more about interactive updates in general, not controlled updates specifically. I'll change it to focus on restoreStateIfNeeded instead.. context.current = null is important.. We do that everywhere :D Idk why, to be honest. This is related to item 2 in the \"Unresolved items\" section. Waiting for feedback on whether this is too drastic a change and if we should hew more closely to the existing retry semantics.. Maybe we should only do duck typing and skip instanceof entirely?. Meant to delete this, not needed. I think in most cases, if you catch multiple errors, it will be because they can from different siblings. (Another difference between this implementation and the previous one is that if there's an error, we continue rendering the siblings before we unwind.) In that case, you'd want to log all three errors.. I think I'll just get rid of this, but the idea was that you could dispatch multiple errors at the same time. It's only being used for unhandled errors at the root. Don't think it's necessary.. I don't love it either but all the alternatives I considered were worse. I can try to convince you out of band if needed :D. ~Realizing this test made more sense when it was using the render phase version of the lifecycle. I'll rewrite.~ Never mind, I still think this makes sense. Three siblings, three errors.. I want to leave the door open for supporting custom algebraic effects. Error boundaries are a normal effect boundary that pattern matches on errors; there\u2019s another boundary that pattern matches on promises, and so on. That\u2019s what these lines here are intended to model.\nError boundaries will no longer catch null or undefined, but the root still will (that\u2019s why the Unknown type exists).. No they only catch errors. A string will propagate to the root. I\u2019ll add this to the list of known deviations.\nIf this is too drastic a change I\u2019m fine with for holding off on that part until React 17. Though if we do that, we should warn so people don\u2019t rely on that behavior.. It\u2019s triggered whenever anything throws, so we need test cases that throw for every possible type. Working on adding this to the fuzz tester.. True. Though we still should test every path to prevent stack push/pop mismatch bugs, like we\u2019ve seen in the past.. Strongest case I think is resuming. We should be able to reuse parts of the effect list during a bail out, including any of the values that were thrown.\nCan you think of some viable alternatives? I'm having trouble coming up with one.. Yeah, I can reenable, but if we ever do this again, we'll have to ensure that this test triggers whatever path adds a fiber to Map/Set. So I think we'll need to think about it regardless.. Ha yes I hit this exact bug when I did the release and neglected to include the change in the commit :D. ?. Oh, right, idk what these lines are haha. Forgot to delete or something.. Sort of. The error is cached so the next time that resource is read, the cache will throw the error so the user can capture it with an error boundary. But I don\u2019t know when we should reset it to empty. I guess right here, right before we throw? But what if multiple components attempt to read the same value? They should all throw, not just the first one. Maybe we should reset it after n milliseconds.. Ah you're right, Babel uses arguments. I'll change.. I should use a sum type for Record, too.. I guess so. I thought maybe the \u201cunknown tag\u201d invariant would reduce the likelihood that we\u2019d overlook one of the types but it doesn\u2019t provide that much safety. Need tests regardless.. We could pass both the key and the hash to the cache. For the simple case, they\u2019re both the same thing.\nThen we don\u2019t need the closure.. I'm treating these as fragments right now because I'm not really sure how this output is consumed. Should I create a new nodeType?. Seems like nodeType is only used for user-defined components and host components. Everything else is treated as a pass-through.. There's a comment below. It's used to trigger invokeGuardedCallback, which no longer wraps the begin phase unless an error is thrown.. Yes :D I'm curious why you thought perhaps we don't need separate builds?. Our typical strategy is to never put assertions inside of callbacks. It's too easy to neglect to call the callback. Instead, we push into a log and make assertions on it in the main function. See one of our async tests for an example: https://github.com/facebook/react/blob/48ffbf06beb272d2ab9484b1084063757b6a64f1/packages/react-reconciler/src/tests/ReactIncremental-test.internal.js#L75-L140\nThen you can get rid of suppressErrorLogging = false.. I see. Yeah, let's have both, for debugging. And since it's possible we may add warnings.. Another benefit of a log is the test will fail if there are multiple invocations.. Why do we care about anyone who isn\u2019t also using React, with which they have to deal with this anyway?. I get that you\u2019re saying we can get more adoption within the React community if it becomes widely adopted outside of it but idk if I buy that scenario. In my view the main argument for a DEV build is so we can warn, e.g. if we detect the presence of a non-native global requestIdleCallback implementation, which isn\u2019t something we\u2019d want to do in prod (I\u2019m assuming). Warning in ReactDOM makes sense.. I'll remove it entirely until the next PR. Yeah that\u2019s the bug @ryanflorence found. Should be fixed now, haven\u2019t pushed a new canary yet.. Oops, forgot to delete :D. Fixed. There's a test that fails when I do that, for some reason, haven't figured out why yet. Seems like it should do the same thing, since it will end up bailing out a few lines below, anyway.. Ah figured it out. Ha, I was trying to avoid assigning the result of shouldDeprioritizeSubtree to a boolean :D. Yeah sorry. Soft expiration vestigia.. Let's rename these too?. Context creation is too early. Needs to check on every render. Like a prop type.. Ah I see. Idk, not sure what the advantages are. I thought about using propTypes but if the plan is to remove those eventually? Although maybe this is an indication that would shouldn't.... There's a lot of noise in this diff, but all I did here was move this into a module constructor and add a corresponding Flow type.. Can we add some more assertions to prove that the component has not yet committed?. Same here. error -> warn. This one line summary is too appealing. It doesn't suggest any reasons for why I shouldn't use subscriptions.. Let's use createRef? :). I suppose subscribe isn't as hot a path as, say, the render phase, but could we change this to a warning?. Typo: Promsie -> Promise\n(\"Promsie\" sounds like an adorable cartoon used to brainwash kids into learning JavaScript). Maybe you should always return an unsubscribe function? If it's not supported, you can return a noop. By supporting a boolean, it implies that either option is equally fine, whereas you should always unsubscribe if possible.. Maybe you should always have to return an unsubscribe function? If it's not supported, you can return a noop. By supporting a boolean, it implies that either option is equally fine, whereas you should always unsubscribe if possible.. Oh I guess I missed the earlier comments about this. Put me down as +1 for always requiring an unsubscribe function. The fact that it's weirder in the promise case is a feature, IMO, not a bug.. AFAICT it's the same pattern you're using. Roughly:\n```js\nstate = {\n  unsubscribe: React.createRef(null);\n};\nsubscribe(source) {\n  this.state.unsubscribe.current = unsubscribe;\n}\nunsubscribe() {\n  this.state.unsubscribe.current();\n}\n``. Shouldn't this besource: ?Property`?. Is it that you have to create a new object every time the source changes? That's what you're doing anyway. > Yeah, I just don't see the value of using createRef in this case, since we're throwing the ref away each time props change.\nThis is one of the points of createRef, to make the container pattern easier. If you don't see any benefit, maybe that means we shouldn't have a createRef API at all :D\n\nIt also kind of blocks this PR on the .value to .current change\n\nNot necessarily, I mean createRef is already in master. Would just have to update this when landing the naming change.. Why are you using log instead of ReactNoop.yield?. Does this need to be an invariant, as opposed to a warning?. Because warnings can be stripped out at runtime. If the code is correct, there's no overhead. invariants add runtime overhead regardless of whether the code is correct. It's the same reason prop-types uses warnings instead of invariants.. This is beyond the scope of this PR, but if it makes Flow typing harder... we should fix that. If createRef doesn't make this particular use case better, I question why we added it at all. Because this is the exact use case it's meant to be used for.. Added. Nit: could you move this into the branches below? That way it's less likely they get out of sync.. Maybe when we don't complete, it should say that we yielded?. Sorry, another nit: can we move isWorking back out? :) It's not related to the work timer and it's the same in every branch.. We should be able to implement this without adding a new field to every fiber.\nCould we try storing it on the stateNode (instance) instead? It's confined to the commit phase, so should be fine.. Nit: move this inside the condition. What's the point of coercing this to null?. Why are we adding a new traversal of the effect list instead of using the host effect traversal (commitAllHostEffects)?. The snapshot is only used within a single commit phase so it shouldn't collide with anything. Commit phase is uninterruptible.. Why though. Conceptually, what you're calling prevState is the work-in-progress state. So your comment here applies to all cases; it's not special.. Why did you change the order of getDerivedStateFromCatch and getDerivedStateFromProps? The new order seems correct, just curious what led you to make the change in this diff.\nIt looks like the order in the \"resume mount\" path is different now, though. Should be consistent regardless.. Nit: let's not use findDOMNode. Maybe a ref instead? I know it's just a test, but we should still try to avoid using legacy APIs :D. One more thing: could you add a test so the order doesn't incidentally change in the future?. We call this for HostRoots, too, I believe. https://github.com/gaearon/react/blob/509b257a30839b6b47f53ae522679756161cdf84/packages/react-reconciler/src/ReactFiberCommitWork.js#L291. This bit needs to be added to HostEffectMask (which is probably misnamed... meant to include any effect tag on a completed node. Name not relevant to this PR).. Looks fine. Maybe \"limitations\"? To communicate that it's correct, but not ideally scheduled.. Confession: I hate the word problematic. So much baggage. Other than that, good suggestion.. Andrew is English much. Yeah something like this should work. Seems easy to mess up, though.. Sounds fine, we'll have some inline comments so the next person knows what's up.. Would prefer if this weren't optional. Not a blocker.. Yeah good call. This is because we weren't counting componentDidCatch as a lifecycle previously. I don't know why this wasn't already 0. There are no host effects or lifecycles in the second flush. New snapshot seems correct.. Same. Stop denying me muh mixins!. The other assignment is here: https://github.com/facebook/react/pull/12600/files/a99b4cae0283fd811c80b9a5b18eb59c5401dac6#diff-b69c8f2165f95ef2355ac661c12fa407R727. I don't think there was a reason. It happened to be a convenient place to do it. Now we do it while processing the update queue.. getDerivedStateFromProps is inherently weird because it treats receiving props as an event, which is not how React works. With this change, we call it on every render, not only on prop changes, and we only persist the result to the queue once there's no more work to be done. So the result still accumulates, but it's more deterministic \u2014 not completely deterministic, but it works for most cases. The implementation is also simpler, because we don't have to enqueue an update.\nIf you're use getDerivedStateFromProps the way it's intended to be used, then this change shouldn't affect anything. If you're using it to count the number of renders, or to accumulate prop change \"events\", then this is breaking. We (Brian, Sebastian, and I) decided it was important enough to put in a minor. Call it a bugfix.. The three use cases for getDerivedStateFromProps are:\n\nMemoization. We have a better model for how this should work in the future.\nAvoiding the need to derive the same value repeatedly in multiple methods/lifecycles. (Similar to the problem that defaultProps solves.) Again, our future model handles this better.\nReacting to prop changes. This is the weird one, and I don't think we totally understand yet what the best practices should be.. We already have an debugRenderPhaseSideEffects check outside of a DEV block: https://github.com/facebook/react/blob/5dcf93d146ccde90af2c442d6cb32b29efddb46b/packages/react-reconciler/src/ReactFiberUpdateQueue.js#L297-L305\n\nbecause debugRenderPhaseSideEffects is only true in DEV mode. But I agree we should put it in a DEV check anyway, for extra safety.. Per our discussion, let's go back to having a single, pooled deadline object. The name of this function and its implementation are identical. I think that's a smell. Seems like the point of the helper is so you don't accidentally reset the callback without also resetting timeoutTime. So maybe can we give it a more semantic name, like resetScheduledCallback?. This test should assert that the callbacks were called in the correct order. It's common for callbacks to reschedule themselves if time runs out in the frame and they have remaining work. (The exception is callbacks that ignore the deadline object entirely.) I don't think this implementation accounts for that case.\nExample:\n```js\nfunction callbackB() {}\nfunction callbackA(deadline) {\n  while (hasWork()) {\n    if (!deadline.didTimeout && deadline.timeRemaining() < 1) {\n      // Ran out of time. Reschedule self so we can continue later.\n      rIC(callbackA);\n    }\n    doUnitOfWork();\n  }\n}\n// Schedule a callback\nrIC(callbackA);\n// With your PR, this will early flush callback A...\n// If callback A runs out of time, it will reschedule itself, all before we get a chance to schedule callback B.\nrIC(callbackB);\n``. What doesdependencies` mean in this context? Things that get inlined into the flat bundle, or things that are left as a require statement (or global reference, for UMD builds)?\nThe point of the scheduler package is to coordinate React work with non-React work (e.g. Booloader, Webpack, non-React product code) using a centralized scheduler. We want the scheduler to be packaged separately from React and React DOM, not inlined into the flat bundle, so everything can share the same instance.\nSince this is a breaking change for UMD bundles, the plan for 16.x is to include the scheduler in the UMD bundle but use the global scheduler if it's available. In 17+, we stop bundling and always use the global scheduler instance.\nFor CommonJS bundles, it's not a breaking change, so we can externalize it immediately without waiting for 17.. If you assert on the entire array, like this...\njs\nexpect(callbackLog).toEqual(['A', 'B']);\nthen it guarantees that the callbacks are only called once.\nIt's also easier to read, IMO. I have a harder time trying to follow what's happening when I have to recreate the list of operations in my head :D. This callback could throw, which would leave us in a broken state.. These checks are wasteful, since we already checked if scheduleCallback is null above. This block should be moved into the earlier one:\n\nCheck if there's an already scheduled callback\nIf so, flush it\n\nSchedule the incoming callback. We also avoid using destructuring, except for module-style functions. Can't remember the full rationale, ask @sebmarkbage. I think the main reason is because it obscures how many reads there are?. This callback could throw, in which case isCurrentlyRunningCallback won't be reset.. The number is meant to be used as an id to cancel callbacks. This still matters for this PR, since it is possible to have multiple callbacks scheduled at a time (pendingCallbacks). When I talked to @sebmarkbage about this a few weeks ago, he suggested that instead of using an id \u2014 which requires us to store to map of ids to callbacks \u2014 we could store the pending callbacks as a doubly-linked list, and the return value would be the item in the list, which the caller treats as opaque. Then you could remove the callback from the list without needing a map. If you want to do that in a follow up, a map is fine for now, but either way we should account for cancellation in this PR.. Needs tests for:\n\n\nErrors\n\nTimeouts. Meh either seems fine. I'll update so they're consistent.. I think it's ok if we use a Map here. React itself already has a Map dependency.. Yes. Conceptually I think of these as callbacks. Yes it's global state. Conceptually I want the incoming props. In this particular case, both memoizedProps and pendingProps are the same thing so it doesn't matter.\n\n\nIt used to be null. Maybe it will be again\n\nOk but that's true of all these decisions. I could use the memoized props, but what if we move memoization to the complete phase? We used to memoize in the complete phase, maybe we will again.. Yeah you're right, we don't need it. I think I thought it was important to wait until the commit phase until attaching the promise listeners, but I don't think it matters.. The other option is to store the earliest timeout on the context stack. I think that might be best.. > This is a pretty leaky use of alternate\nWould it be better to pass this in from the scheduler?\n\nassumes that the return pointer is always the work in progress\n\nWe always assume this in the unwind phase, right?. This seems wrong. You want to measure the subtree only if there is pending work in the subtree. We shouldn't reconcile the children unless there are new props.. I think Dan ran some performance tests that showed the stateNode should always use an object or null, so the hidden class is monomorphic, for performance reasons.. Can you move this resetExpirationTime in the scheduler? That's where we \"bubble up\" expiration time, which is conceptually similar.. Can you reuse the Update effect type? I don't think we need a new tag here.. Profiler is the only type of work that might have this effect, right?. Same as previous comment. Can we move this into the switch case for Profilers?. But why are you reconciling the children? You should only do that if the props have changed. Otherwise you should skip reconciling, which is what bailoutOnAlreadyFinishedWork does.. You're adding an extra check to every single unit of work. We already check for the Update effect.. @bvaughn I miscommunicated. I thought you were talking about the scheduler\u2019s recalculateCurrentTime function. HostConfig.now is fine to use. My bad!. \nI don't think we need to account for the counter exceeding the maximum integer :D. Use a Map?. What is this for? Don't we have to check the entire list regardless?\nI don't understand why this is a nested loop. What is the purpose of the outer loop?. Why is this a feature flag? I don't think there's any valid use of the schedule module unless it supports multiple callbacks. Except for its use by React, but in that case it's only used for async mode, which is already behind its own feature flag. I don't think we need this one.. Yeah I think we should use a linked list instead of ids for cancellation, but it's fine to fix that in a follow-up.. I didn't want to inline this because it's one of the things we would eventually lift to the renderer. Along with the other stuff at the bottom of this module.. It's to unwind the stack. I could refactor this a bit but I'd prefer not to in this PR since it's, ahem, perpendicular :D. This is another one of those methods that would be lifted into the renderer.. The pending times are levels we haven\u2019t tried yet. If we try them and they suspend, they are cleared. In other words, need to distinguish between \u201cincomplete\u201d and \u201cincomplete and suspended.\u201d. Ok I\u2019ll add comments in the morning. Yeah, this is the first bullet. Huh this is called after a commit, so \u201cflush\u201d seemed appropriate. Suggestions?. When I made the change to infer the start time from the expiration time, all the numbers in the tests were off by 250ms (the bucket size) because we were rounding up. Since in practice it doesn\u2019t really matter if we round up or down when placing updates into buckets, I adjusted it here rather than change all the tests and introduce more noise to the diff.. Lol ok. Copy pasta. Why are we leaving these in?. Nit: Use explicit null checks. Need to update tail?. So it's ok to land this without error handling because React is still the only consumer, but we'll need to handle errors correctly before we can use this anywhere else. Is that right?. If there is no next or previous callback, then we need to set the head and tail to null, I think?. You shouldn't have to check the tag since this is already part of a class-only code path.. Yeah. Why are they ever off? It's only read in strict mode, yeah? My understanding was that these warnAbout- feature flags only exist so we can turn them off in certain tests.. Why is this any instead of CallbackConfigType?. This the same as the else block of the previous if statement. If there's no next callback in the list, then the list must be empty now. . Make sure we always explicitly compare to null. Same here, compare against null. I find this much easier to follow using nested if statements. The reason I prefer that style is it makes it easier to avoid redundant type checks.\njs\nif (callback === head) {\n  if (callback === tail) {\n    // List is now empty\n    head = tail = null;\n  } else {\n    // Remove from start of list\n    head = callback.next;\n    // (Flow will complain that `head` could be null)\n    head.previous = null;\n  }\n} else if (callback === tail) {\n  // Remove from end of list\n  tail = callback.previous;\n  // (Flow will complain that `tail` could be null)\n  tail.next = null;\n} else {\n  // Remove from middle of list\n  const previous = callback.previous;\n  const next = callback.next;\n  // (Flow will complain that `previous` and `next` could be null)  \n  previous.next = next;\n  next.previous = previous;\n}\nBut it seems like maybe the redundant checks are necessary to satisfy Flow? That's a shame.. Typo?. Isn't the loop below sufficient?. These can be moved to the else block above. For the initial clone, these are already 0.. Code size nits incoming:\nLift this line above the condition so you only have to read callbackConfig.nextCallbackConfig once.. Same here. Lift this above the conditional.. And here.\nIn fact, since we always end up checking these values, we can move the variables to the top of the function.. Nit: Remove the local prefix\njs\nconst Date = window.Date;. Same here. callSafely implies that the function won't throw. Can we rename this to callUnsafely or similar?. A timed out callback that throws will infinite loop, because it never gets cancelled by the line below. Need unit test.. This doesn't seem necessary. Could you replace with something like\njs\nconst alreadyCancelled = callbackConfig.next === null && callbackConfig !== tail;\n?. So this is sufficient to fix the crashes? How important is the follow-up PR to add a commit phase hook?. Small not-even-worth-mentioning nit: since this isn't always a boolean, might be better to explicitly compare to undefined instead, like we do for other optional types.. Ok Seb, I know what a comment is. Thanks for the explanation.. \"Better comment, please\" would have sufficed. TODO: Re-inline because this is a really hot path. TODO: Add emptyTimeoutHandle, setTimeout, and clearTimeout to HostConfig. TODO: Use the same function as scheduleWork. TODO: Don't need to store this on the stack. We only hit this path if we're IO-bound. Using the stack would slow down even the non-IO-bound case.. I figured it was ok in this case because I need to use an object for dynamic dispatch. But I agree explicit is better.. TODO: Move next to the caller. TODO: Move next to the caller. TODO: Meh, it's probably fine to render non-async, strict mode placeholders asynchronously. Revert.. What about the part where we continue the propagation where we left off?. This module throws if this is undefined, right? Maybe we should use an invariant?. I guess in sync mode this module is never used so an invariant would be harsh. @sebmarkbage As you pointed out, we already did this check while scanning from the provider. But where to store that data? On the update queue, perhaps? I'd rather not put it in the expiration time, if we can avoid it, since that field is already pretty confusing and overloaded.. Can we please go ahead and implement this for the React repo? @cyan33 You want to do this?. During the commit that hides them, hideInstance always comes last because children effects fire before parent effects. While they're timed out, the children will never update. It's a more extreme version of hidden.. > yielding and flushing are super coupled\nIt's coupled in the sense that if you yield inside the render phase, React will pause the work. But you can also yield outside the render phase. For example, in the Suspense tests, ReactNoop.yield is called to signal that a promise has resolved.\n\nflushing is necessarily tied to a root\n\nNot in the current implementation. unstable_flush flushes work on all roots, not just the one you call it on. (That might change in the future but even then I would argue yielding should be isomorphic because of the above point.). I was thinking we should turn these into Jest matchers. That way we get nicer diffs. Working on this in a separate PR.. I don't want to add too much non-standard test renderer stuff to the scheduling methods (like flushSync, which is cross-root and also exists in ReactDOM), but putting in a custom Jest matcher gives us more flexibility.. Why the type rather than a prop?. Add to prepareUpdate, too?. next is always null ever since we deleted call/return. Let's just remove the block below.. It's checked by the matcher?. Right, I think only test helpers (like the matchers) should ever use these low level methods\nWe can maybe rename them to internal_flushThrough even once they're stable. How about we have it accept a number instead? Then it seems less misleading. Right. Do we warn about version mismatches? If not, seems like we should.. I think it's fine because you can only reach this path via Context.unstable_read, which is exposed by the isomorphic React package. Older versions won't even have unstable_read.. @sebmarkbage This is the most important part to review. I'm not that happy with this approach; I think the ideally we would store each set of children on a separate field, the way call/return used to store its first child set on the state node. I resisted that at first because I thought it would be cumbersome to have to account for both sets every time we traverse the fiber tree (including context). But it turns out that I have to account for it in most of the places regardless.\nAny alternative ideas?. continue should only be true if we were already inside an async callback. That's the check above: deadline !== null. Maybe scheduler should warn or error if continue: true is passed but you're not already inside a callback.\nTo me this indicates that the API should use generators instead. Then this type of mistake wouldn't be possible.. See other comment. What should happen if options.continued is true but we're not inside another callback?. Oops?. Let's pass this to commitWork instead. Why .from?. Oh nvm, I see. You can move this and the other assignment in createFiberRoot to the begin phase. Also let's call it memoizedInteractions instead? \"Committed\" is misleading because it hasn't committed yet at this point. It's more like memoizedProps and memoizedState.. Nit: This can go inside the if. Well maybe if this is going to be a separate package. But what I meant is we shouldn't have dev- or prod-only invariants.. Agree this should be a warning, but don't care because it's unstable. @sebmarkbage This change is because I'm using a callback to remove the root from the global list. What we should do instead is add an explicit reconciler API for unmounting a root. We had this at one point but now that we're not relying solely on GC we need to add it back. I can do this in a follow up.. This test passes in master, but it covers a case that wasn't previously covered.. Nit: Can you combine the enableProfilerTimer check with these inner checks? Or do we not trust the build system to strip out the dead code?. Will an expando no longer work? error._suppressLogging = true. If we use an expando, then I think you can get rid of the extra ReactErrorUtils methods.. Yeah seems fine. Can't get rid of this because of shouldComponentUpdate, but I think maybe I can use the forceUpdate field on the update queue?. Would prefer to do that in a follow-up, though.. Never mind, added another commit that does this. I have a test for that. Works by creating a new component type and throwing in beginWork, as you say. Not the greatest, but the new approach we discussed offline will be better.. I couldn't decide if you would hate this or not :D. Oops, meant to come back to this function. I'll find a way to get rid of it.. That's two extra, usually redundant, calls we have to do on every invocation. Is invokeGuardedCallback ever used in prod by www? If so we should get rid of these.. The idea is that a call to invokeGuardedCallback must always be followed by a call to hasCaughtError, which does the reset. It's a low-level, infra-level API so the fragileness is preferable to the perf hit (unless it's DEV-only I suppose).. Although if this were used in prod, we would probably mutate the object directly like ReactCurrentOwner, instead of calling a function.. Sorry, that was vscode's auto importer. Forget to fix. It works well if you already imported from that module, not as well for new imports.. Is it really? I intentionally put it first because it seems like it will be the most common one. Providers are pretty rare. Perhaps ForwardRef will more common, in the near term.. I did it this way because it's called from places that aren't allowed to throw. But I suppose I could wrap those call sites in a try-catch.. Oh my bad, I thought this was a different file. Ok.. Because it has fewer characters, obviously.. You're right, I got rid of it. > I removed some of them in the previous commit, and deleted a few more in this one. I left a few behind because the remaining ones would require additional refactoring that feels outside the scope of this PR.. Seems like it. Ok I'll get rid of it. I think I'll still need updateClassComponentLazy to do the defaultProps resolution. Right but the shared function should accept the resolved component type, not the whole fiber. Unless I misunderstand.. I thought that maybe it's possible from renderSubtreeIntoContainer. Oh nvm I read it wrong. The tricky thing is that I think I need to reset the memoized props back to the unresolved value so we can quickly bail out the next time.\nEDIT: I guess this isn't so tricky.. No good reason. The pending props needs to match the memoized props so that the next time we visit this fiber, when we compare memoizedProps to pendingProps, they are the same object.\nAlthough this looks like a mistake. I think it should be workInProgress.memoizedProps = props. Clearly I forgot to write a test... will do.. Nope, I did write a test. But if I delete it, it passes. I think it was failing in an earlier version.\nIt's not needed because we compare to current's pendingProps instead of memoizedProps. Which kinda suggests we should delete one of those fields :D. What about ReactTestRenderer?. > I think it needs to store the unresolved props because if you store the resolved ones, you'll never get reference equality.\nYeah, that's what this was originally intended to do: restore the unresolved props.. Not sure what the rules are for deep linking from the shared directory... I can inline the helpers if needed.. If only one can be scheduled at a time, maybe the API should be to mutate current directly.. I don\u2019t get why these feature flags exist. Oh that is what React does. Why does this other API exist at all?. Or rather, I get why they exist for React but not why they are used by this package. Is it because we\u2019re still inlining it instead of publishing as a separate module?. I don't think I understand why wrap is so complicated. I was expecting it to be essentially this:\njs\nfunction wrap(callback) {\n  const continuedInteractions = interactions.current;\n  retain();\n  return (...args) => {\n    track(continuedInteractions, () => callback(...args));\n    release();\n  }\n}\nwhere most of the code is reused from track. Almost always, this callback will be called at or near the top of the stack. But if it isn't, shouldn't this \"stack/accumulate\" interactions the same way track does? (If so, why not?) This is one of the reasons I assumed you would implement wrap on top of track.. Nit: I think this is fine and Babel will compile it to callback.apply(undefined, arguments) but to be safe I usually prefer to manually use apply.. I suppose avoiding the extra function call is worthwhile, but I believe semantically they should be identical. See other comment: https://github.com/facebook/react/pull/13234#discussion_r210817384. But... why?. I suppose I was expecting the semantics of wrap to be that it restores and stacks.. It doesn\u2019t modify the current set of interactions because it will reset them back to the previous set after it exits.. Just noticed this... wrapped is an arrow function here, so these are the arguments to the outer function. Need a test.. You could also change this to a normal function :D. It's a nit. I'm just paranoid about the Babel output.. Should be able to use nextRoot, but I assume Brian has passed it as an argument to avoid another type check, since Flow doesn't know that it's not null.. Agree with Seb that this should be try/finally.\n\nAnd then the old failed work will also re-appear.\n\nThat sounds like something we should fix in the scheduler instead. What the scenario that causes that to happen?. Did you try using an intersection type here? Or a spread type. Then the any below shouldn't be necessary.. > Without this, our interaction zone expires when React finishes this batch of work\u2013 and there's nothing to restore it when the thenable completes.\nThis is only an issue if the work times out, which we determine here: https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberScheduler.js#L1449. Why are these outside the feature flag?. If this is so fragile, can we move it into a function?. commitRoot should never throw. There could be additional work at lower priority, or on another root. This is probably why you had to use try/catch instead of try/finally in the test renderer.\nIf interaction subscribers throw an error, we should only rethrow them once React is completely finished with its other work. So at the end of performWork.. https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberScheduler.js#L1089. Typo?. Nit: change back to const plz. I'm not sure if it's worth adding this to the existing renderer, even in this limited form. If we do, we should emit a warning so people know to migrate to the new one.. Needed to make a small tweak to an existing test: Callbacks are now executed in timeout-order. This is the only semantic change.. Erm I don't get it. Why does that matter?. Should I get rid of let/const as well then?. Uh I guess Prettier ran on this file :D. Probably should inline them? Also should use Symbols, with a fallback to magic numbers.. Because eventually this will live in a separate repo. Maybe include a comment explaining why this check works, since it's a bit confusing.. Suggestion: nextRenderIncludesTimedOutPlaceholder. Yeah I'll add a comment. It's mostly just a fork of scheduleWork but it inserts the continuation before the first callback with equal expiration instead of after the last callback with equal expiration time.. Yeah it's like try/finally. I'll add a test.. D'oh. Good catch. I keep going back and forth on which one I prefer, but usually in conversation I end up saying \"normal\" so that's what I went with here. These aren't final though.. Thanks for the feedback. Note that the actual names used here are not final yet.\n\nPerhaps deadline.didTimeout is rather didExpire (as you have called these elsewhere), but is it a deadline that expires or is there a way to express this without negation\n\nThe deadline naming is inherited from requestIdleCallback. You're right that the naming is confusing because it's about the frame deadline, which is different from the expiration. We haven't figured out the best terms to use yet but we'll take all this into consideration before we reach stable.\n\nAlso what happens if one forgets to check expiration, I would guess the scheduler calls us immediately again so it works, just slower, or is the problem more drastic.\n\nIf you forget to check if the work is expired, but you do check timeRemaining(), then it will still  work because timeRemaining() will be 0 (though I guess I'm missing a test for this). Maybe this implies that we should unify the two APIs into one (these are also inherited from requestIdleCallback). I think it's likely we'll replace both with a single shouldYield() method. But I do think it's useful to provide a estimate for how much time before the next frame. But that could be a separate API.. Can we name this isLegacyContextConsumer to be more specific?. Good point. Previously the expirationTime field represented the pending priority of props, state, and context. In the begin phase, we check if this is lower priority than the render priority. If so, we can bail out.\nAfter this change, it represents only the pending priority of state and context. The props check is moved to the begin phase. That way, in the begin phase, we can distinguish between an update caused by props versus an update caused by state or context. pure will never bail out if state or context has changed.. Corresponds to the changes in https://github.com/facebook/react/pull/13748/files#r221093037. Me too :D. Hmm, yeah I don't think this is right. I think I know how to fix it though. Let's pair on it tomorrow morning.. This check isn't sufficient because firstUpdate might be a low priority update. It needs to be sync. You can check fiber.expirationTime === Sync instead.. If currentFirstChild !== null && currentFirstChild.tag !== HostText, then yes we do need to delete the remaining children.. The tricky bit is that ReactTestRenderer.create will run the renderer synchronously on a new root, so it will cause React to interrupt the previous root and switch to a new one. That makes it unsuitable for some tests, and it\u2019s a non-obvious/surprising behavior when it happens.. Also why wouldn't that test work? It should! I just used strings in the Suspense test because it was less to type.. Yeah it's probably just a bug. I'll add more tests as I go.. Is react-test-renderer not for generic React testing? :D. Yeah it was just a bug :) Updated ErrorBoundaryReconciliation-test. You can yield from anywhere, not just a root.. What's an Enzyme? :D \nBut yeah good point :(. Ok I'll make it throw with a helpful message. Flow would have caught this if it were an opaque type, but since it's a bitmask we can't do that.. An explanation for why you don't like this hack leads to better software and smarter teammates!. oops. Compare to null and undefined explicitly, plz. Another style nit: we don't use destructuring, with some exceptions like module-style objects or function args (component props).. This is to make debugging easier. These tests use overridden Date.now() so the start time is unimportant.. I thought this would work but now I don't think it does. There are three callbacks: the one scheduled with requestAnimationFrame (represented by isAnimationFrameScheduled), the message event handler (represented by isIdleScheduled), and the one that actually contains the work (scheduledCallback). Need all three concepts. For example, as added by this PR, sometimes an animation frame is scheduled even if there's no actual work scheduled. So I think all three are needed.\nI'll rename these a bit so it's less confusing.. Why did these change?. Thanks! Need to fix this for forwardRef, too, but we can do that in a separate PR.. Problem is we never hit this code path because of: https://github.com/facebook/react/blob/0af81997095dfa3db67a0c5d287b144797742e99/packages/react-reconciler/src/ReactFiberBeginWork.js#L1209-L1217. Now that you mention it, memoizedState does seem to make the most sense. Good call.. I'll revert this, mistake when resolving conflicts. I did it this way to avoid additional code size, but I guess this is a really hot path. My mistake, forgot it's always non-null. I no know DOM.. DidCapture effect isn't being used for SuspenseComponent anymore, just forgot to remove it. (It's still used by error boundaries).\nThe motivation for storing this on the state object is to unify the concurrent and non-concurrent modes as much as possible. The begin phase no longer distinguishes between them at all, unlike before where a non-null updateQueue was a hack to indicate non-concurrent mode.. It\u2019s not a static feature flag like persistent vs mutation. Happens at runtime.. Oh nvm I misunderstood Seb\u2019s original comment. I thought he meant we should get rid of the recursion entirely unless there\u2019s something to toggle.. I guess he meant both. Oops, accidentally committed this. Will revert.. Better fix: schedule a placement effect on workInProgress. Let's revert this commit, except for the redundant existence check for instance.style. This test does read from the cache? And idk what you mean by \"common reconciliation\". Why the two functions? Doesn't look like this is called anywhere else. I believe you. Should we get rid of this argument now?. These can be early returns. Oops, shouldn't have deleted the break, because now it falls through to SuspenseComponent. I'll revert.. Missing a word?. I moved these outside because captureAssertion was swallowing the stack trace.. This is a fix for an oopsies that could have been its own PR, but it was required to get the new test I wrote to pass. I can split it out if I need to.. This is the main fix here.. I split this out because it was getting hard to follow all the nested branches in the throwException function. I believe this will fix the issue in www, haven't confirmed yet. I'll try on my sandbox shortly.. Guards against something resolving multiple times. Promises don't do that but a thenable might. Thanks for pointing this out, though, because now I realize I didn't write a test for it.. @sebmarkbage Nah, I'll change. createCache doesn't exist anymore after I merge this: https://github.com/facebook/react/pull/13865\nLet's land this PR as-is then I'll land mine.\n. Yeah we found the same thing when testing at FB. Forgot to update in the upstream brach. :). Perhaps \"variable number of hook dependencies\"?. Updated. Planned to change it once I proved it worked, then forgot :D. I think I originally used invariant inside a try/catch but @sebmarkbage said we should fix our error extraction script to work on Error instead.. It's a known flaw with sync mode. Pings aren't batched, so we get a synchronous retry for every individual ping. Added a comment in the rebased version of your test:\nhttps://github.com/facebook/react/blob/74322975b74170fa4eabda5e5c0496a6c2a9356d/packages/react-reconciler/src/tests/ReactSuspense-test.internal.js#L739-L741. What if initialState is null or undefined?. Need to transfer from the siblings, too.. Could you rewrite this comment in terms of what it means semantically instead of what will break if it goes wrong?\n\"treeBaseDuration is the sum of all the children durations\" would be sufficient. This gets called again in completeUnitOfWork, with no work in between. Seems wrong?. Suggested alternative: bubble this in completeUnitOfWork, where resetChildExpirationTime would normally go for a completed fiber.. I don't love this boolean, especially because it's not dev only. But I'm more concerned that this replay logic is getting really convoluted and it seems there must be a better way to structure it.\nMaybe we can move where replayUnitOfWork is called instead. If replayUnitOfWork is only called after a failed begin phase, we could fork beginWork to beginWorkInDEV which has a local try/catch.\n```js\nfunction beginWorkInDEV(current, workInProgress, renderExpirationTime) {\n  try {\n    beginWork(current, workInProgress, renderExpirationTime);\n  } catch (e) {\n    resetContextDependences();\n    resetHooks();\n// Either call replayUnitOfWork or inline the whole thing here\n\n// Then throw to outer catch block\nthrow e;\n\n}\n}\n```\nThere might be other implications that I'm forgetting, but I think we should give this a shot before piling more complexity onto this code path.. Just checked \u2014 this is what I originally did, but @sebmarkbage asked that I move the extra try out of the hot path: https://github.com/facebook/react/pull/12201#discussion_r170399852\nI feel we should reconsider given the additional complexity of distinguishing between the begin and complete phases.. Suggested comment:\n\nBecause primaryChildFragment is a new fiber that we're inserting as the parent of a new tree, we need to set its treeBaseDuration.. I thought the whole point of your previous PR is that memoizedProps does not include the resolved default props, but instance.props does?. Oh duh, didn't notice the outer check :D. I don't think there's any way to hit this condition. nextUnitOfWork should always be workInProgress.. Yes. To avoid the confusing series of checks this comment is wrapped in. Could be replaced by checking if the stateNode is null.\n\nI'm not sure that's actually better though. Kinda gross either way.. It would be simpler because we would always render two fragments, instead of switching between fragments and no fragments like we do now. That's why updateSuspenseComponent has so much code in it; we don't do this type of custom reconciliation anywhere else, yet. Combined with the other weird things we do with Suspense (committing incomplete trees in sync mode, hiding instead of deleting after a timeout) it's gotten pretty complex. Trade off still seems worth it, but unfortunately that means it might take longer to flush out all these edge cases.\n(I keep trying to think of a good fuzz test, but I can't. Haven't given up though.). Are we still doing this? I think we switched to\njs\nexport * from './src/ReactFizzRenderer';\n@gaearon . Oh, the other entries do that. Maybe I'm confused.. My understanding based on absolutely nothing was that old packages do this because to switch to ESM would be a breaking change. But new packages don't have that restriction.. Leaving this here because it's useful when debugging a failing test case. Idk, for some reason I thought FB did but I guess we don't any longer. Should use relative paths. Let's make this private for now until we're sure we want it?. Don't you mean globalThis? \ud83d\ude0f. Copypasta. Not related to this PR, but I don't think we need to put 'use strict' at the top of these files because they are ES modules, so strict mode is implied. @gaearon?. Probably should add note that this is experimental/unstable like we do with the others. Commented it out while debugging, meant to add back. Although now I just noticed... I screwed up when I converted this to use the test renderer. It's not actually testing anything in concurrent mode anymore :facepalm:. I'll fix that in a separate PR since it's unrelated. Only that it seemed like a riskier change. I'll add a follow-up.. We typically use numbers for these types of tags. See ReactWorkTags for example.. Let\u2019s only include this field in DEV so it doesn\u2019t cost memory in production.. In many cases, a Hook mismatch will cause a throw so it needs to happen in that path, too. Should add a test.. Yeah I figured that was fine? Idk. I could use a separate bit instead of reusing PerformedWork. They're similar enough that it seemed fine to reuse the same one for now.. It made more sense in an earlier iteration of this PR. It's not strictly necessary but the re-render logic is less fragile this way. I can move this to https://github.com/facebook/react/pull/14591 if needed.. Commented them out while debugging, forgot to un-comment. (I do this quite often... maybe the sizebot could report the change in the number of tests.). Right, I suppose that\u2019s true. I guess I figured since I had to reset PerformedWork in the bailout case anyway I might as well use it for both. But global flag is better.. Please assert on some portion of the error message so we can distinguish intentional errors from accidental ones.. Yeah let's keep this local to useMemo.\n. Shouldn't need this because _reactRootContainer only exists on legacy roots.. js\nconst reactHasBeenPassedToCreateRoot = domContainer._reactRootContainer === null;. suggestion\n    expect(ReactTestRenderer).toHaveYielded(['Hi']);. Alt suggestion:\njs\n// Check if it resolved synchronously\nif (lazyComponent._status === Resolved) {\n  return lazyComponent._result;\n}\nSince if it's already resolved we don't need to throw the thenable. ReactDOM.render uses the ReactRoot type, but it doesn't call createRoot directly.\nThe only place _reactRootContainer is set is in legacyRenderSubtreeIntoContainer. New roots don't need the expando because the root is retained in user space.\nhttps://github.com/facebook/react/blob/b66e6e41e606745b30238689fa1a98e874b29e6e/packages/react-dom/src/client/ReactDOM.js#L556. You still need the assignment, but I don't think you need to move it up here. If you keep it right after the early return branch you added on line 78-80, then there's always a single assignment.\njs\nif (lazyComponent._status === Resolved) {\n  return lazyComponent._result;\n}\nlazyComponent._result = thenable;\nthrow thenable;. Inside unmountComponentAtNode, if _reactRootContainer doesn't exist, that's a mistake. I was figuring you would warn regardless, but I suppose you're trying to distinguish between an empty DOM container that was never rendered by anything, and a DOM container that was rendered by createRoot, so you can provide a more helpful message.\nSwitching from root.render to ReactDOM.render is more interesting, though, I didn't notice you were warning about that one too. That makes sense and I get why you would need the additional expando for that case.. Can we move these dev only functions behind the guard so it's more obvious that it's dev only? It's not that I don't trust Closure to strip them out, it just helps keep track when reading the file.. Why is this a set? The size is always either 1 or 0. And if it's 1, it's always currentlyRenderingFiber. Unless I'm missing something. You'll always flush either at the end of the component function, or inside resetHooks if that component throws, right?. Same here, I know closure will strip it out, but I'd prefer if it were behind a dev guard.. Ok, so don't kill me: I know I asked you to make these numbers, but that was before I realized you needed the strings, anyway, for the warning message. Since these are dev-only and we need them for the warning, let's use the strings directly. Then we can get rid of this indirection.. Ah right. So usually the way we handle this is we de-dupe by component display name. That way if you have a list of components all with the same bug, you\u2019ll only see a single warning. Refer to ReactFiberClassComponent.. Yeah it\u2019s dev and the strings will be interned anyway. Just noticed this: for future reference, we try to always explicitly compare to null or undefined. That way we distinguish between intentional and unintentional missing values, and comparisons are slightly faster.. Don\u2019t need these variables, just inline the strings. Do the same for the other occurrences of renderWithHooks. The weird inner branch didn't concern me because I figured it would go away once we change the lazy init API to the new one, but you're right, this is small enough that we should just inline it.. > Why not switch the dispatcher back to the ContextOnlyDispatcher?\nWe would have to do the switch in prod, too, which means adding additional code before and after every instance of those Hooks for something that will never happen if you use the Hooks lint rule, and will likely lead to a crash regardless.. > If the pattern for all hooks is just made to be changing the dispatcher (and currentHookNameInDev) these could also all be factored into a higher order function. useMemo: wrapForDev('useMemo', mountMemo), et al.\nWith very few exceptions, like ReactChildFiber, we don't use dynamic dispatch or higher-order functions or metaprogramming in this codebase. Partly for performance reasons \u2014 boring code is more predictable \u2014 but also because it avoids early abstractions, makes refactoring easier, and is generally easier to read.. Won't need to check if currentHook is null once #14701 lands. I went with that approach originally but it became a problem after I made the change to switch back to the mount dispatcher once we reach the end of the list\nhttps://github.com/facebook/react/blob/5a739725cd126e9cb1353279c64d46617712b3b7/packages/react-reconciler/src/ReactFiberHooks.js#L567-L572\nbecause now the finally block will reset the dispatcher back to the old one.\nAn alternative would be to wrap each call site with a separate try/finally block (instead of the entire hook) but that leads to lots of forking in the code because for each site you have to store a reference to the previous dispatcher. And it still suffers from the same problem because the nested hook could mutate the dispatcher \u2014 which is perhaps fine because that's a buggy code path, anyway, but it's a deviation from production behavior.\nhooksAccessForbiddenInDEV seemed like the best trade off, and I don't think it's as bad as the previous boolean because it's completely localized within the DEV block that defines the DEV dispatcher.. I'm about to open a follow-up PR. > It seems like a problematic pattern in general if we can't use try/finally in that way since we're now deviating from the \"algebraic effects\" approach.\nI don't think this is a problem in general, it's only a problem because of the unsupported nested mutation, which is always a bug and only exists because we don't want to add a redundant check to the prod version.. The other thing I considered was putting createWorkInProgress on the Dispatcher.. Resolved via chat: We don't support progressive enhancement yet anyway so let's throw and follow up once we get to that feature.. @sebmarkbage Usually we coerce missing values to null before storing them in our internal data structures, but I think that's because we usually accept either, and null is preferred because it's less likely to be unintentional. But in this case, since we don't accept null, I can skip the type check in prod. Let me know if this doesn't make sense.. Ok I'll leave it like this until we learn more, I suppose. I'll add a branch specifically for null. Can you explain why this part is necessary? I don't think I get it. I gotcha. Right this change doesn't have much immediate impact, but gives us flexibility to customize the implementation in the future. For example, noop renderer already has a forked implementation.. suggestion\n    deps !== null && deps !== undefined ? deps.concat([ref]) : null;\nNit: Should only be null, not undefined. I wondered why this wasn't a type error but it's because mountEffectImpl and updateEffectImpl contain their own type check; we might inline those later.. Same as above. I think this should be\nsuggestion\n      } else if (data === SUSPENSE_START_DATA) {\nIndicates a test for clearing nested Suspense boundaries is missing?. suggestion\n  // This has now been refined to a suspense node.. We already compare prevProps to nextProps at the beginning of beginWork. And if they are different we set the module-level boolean didReceiveUpdate to true. (This approach would also account for legacy context changing, even though that's deprecated in strict mode anyway and I'm guessing partial hydration will only work in strict mode?). Should be able to replace calls to this function with true per our conversation. I don't think you need to do anything in this branch, but maybe add a comment explaining why: a dehydrated boundary should never time out. The only way the boundary would time out is if it's upgraded to a normal Suspense boundary.. suggestion\n        // Since we already have a current fiber, we can eagerly add a retry listener.\nThe terminology for \"ping\" versus \"retry\" isn't great but that's what we're using everything else. Since this branch doesn't suspend (it doesn't call renderDidSuspend) I would expect React to keep rendering the same level over and over until the promise resolves. Is that what's happening?. I see so when something suspends inside a dehydrated Suspense boundary it always bails out and clears the expiration time. The ping/retry adds the expiration time back. There\u2019s no need to suspend the commit because it\u2019s not blocking anything.. This will work for useState but not useReducer, which I assume is intentional, correct?. Using a timeout isn't ideal because it only works if the timers run. Let's figure out something better. At the very least, we should use a microtask instead of a timer event.\n(In retrospect, maybe what we should have done is wait to call the callback until the thenable is awaited. Then act wouldn't do anything unless you await the promise. But I don't think there's a way to change that without breaking everyone's existing tests.). Yeah I think if you make this a microtask (Promise.resolve().then instead of setTimeout) then it's good enough. Jest will still fail even if nothing is awaited.. Welp, never mind, that only works because of the way we set up Jest in the React repo.. Still, microtask is probably our best option. We can looking into having Jest always wait a microtask at the end each test.. Yeah this is the opposite of what we want. Should always await.. We should only fire this warning if we're in concurrent mode, I think. Otherwise it's a breaking change. So we'll need some way to detect if the callback scheduled concurrent work.. Ah, or I guess not because we currently warn if the callback returns a promise. Never mind.. Although it does seem like, ideally, we would enforce that you always await act. So that microtasks have a chance to fire. Unfortunately that's a breaking change :/. I think we can get rid of this global now, right? By passing the name directly to the function on the next line.. Oh right, forgot it was used there, too. Never mind then!. Yeah, got it working by changing the regex to only match the top level directory per package.. They're not being used in this module anymore. Do you mean comment these lines out?. I don't get it. Why can't you use jest's fake timers?. This seems nitpicky but by convention in our tests we push things into a log and then assert on the log. That way if, say, the callback is called twice instead of once, the test will fail.. I'll comment them out so we don't forget next time we import Scheduler in this module. How about two microtasks? :D\nhttps://github.com/facebook/react/blob/a477f6d2fa056fdb54bf8a58037f7c225b4fb997/packages/react-noop-renderer/src/createReactNoop.js#L841-L848  . What's going on here?. Now we have fewer! :D. Can you move this to the specific test(s) where you rely on native timers then?. So the reason I don't like using native timers in all of these tests is that now it takes at least 500ms before this test can finish. Whereas if you use fake timers, it's CPU bound.. These act calls are not being awaited :(. If you replace the setTimeout in the effect with sleep(200).then(() => setToggle(1)) then the test will fail, because the update happens in a microtask. That's why it's important that you always await act. We need another test case that shows that.. I don't think we want this anymore, right? Should always await.. Technically we don't require promise support. Since this is just a warning, wrap it in an existence check.. Same here. I know this isn't new but this is the first time I've noticed it. How does this work for non-Jest test runners?. It's fine to use real timers in one or two of these tests but doing it in all of them seems like overkill especially since most people who use timers are going to use the fake timers, anyway.. Even if it's not true for fake timers (though I think it is) it would be true for other types of events, like network.. I don't think we treat new warnings as a breaking change. We introduce warnings in minors all the time. It's a bit churny, but I think it's worth it in this case. I might not have thought through all the implications though so perhaps we should discuss it during our team meeting.. The test I wrote :D. This check is only necessary right after subscribing to a new source, correct? But it looks like you're checking every time the subscription produces a new value.. I know you showed me this earlier, but I can't remember why this part is necessary given that source is one of the deps in the effect below.. How are 1 and 2 different? I would expect that if you have 1 (the manual call) you don't need 2.. Is didUnsubscribe not sufficient for that?. We always fire pending passive effects right at the beginning of setState, to prevent this type of scenario. Ah but I guess that would require closing over a mutable variable. Ok now I get it.. So the only alternative I could think of was to have expose a getParentContext function from the stack module. This seemed less bad? Idk. It doesn't have anything to do with concurrent mode. The motivation for requiring await is it flushes pending promise resolutions.\nFor example, if you call jest.advanceTimers(ms), that will fire timer events, but the promises won't resolve, which leads to subtle differences in how your component will work in a real environment. (See: https://github.com/facebook/react/pull/14853#discussion_r263034445). Like if a promise handler includes additional setStates, the test will exit before those have a chance to render, potentially leading to false negatives.\nMaybe the downsides of using async/await in all tests outweigh the benefits but we shouldn't dismiss it without considering this pitfall.. Another way to think about this is that microtasks are another kind of \"passive effect.\" Ideally, act should always flush microtasks at the end for the same reason it flushes passive effects at the end.. I understand the reasons why it's annoying but nobody seems to be addressing my point about dangling effects in promise handlers.. Sure, I'll just delete that last commit then. Idk I copy-pasted the other test entry points. Oh no wait, that's a rename mistake. I'll delete whichever one is superfluous.. For context I would have just used exec or whatever but something something Windows contributors whatever I don't care enough it's CI anyway. Yeah. I'd be comfortable changing in a minor. Shouldn't need this extra jump anymore. Which CI error? And I can't find the internal post. Send to me via Work Chat? :D. Use a thenable instead of a promise. Because the macrotask thing is so subtle, we need tests that correspond to each of the platforms where you might run tests.\n\nNode + jsdom (or other fake dom)\nNode without jsdom\nReact Native\nNo setImmediate\nPolyfilled setImmediate. Polyfilling setImmediate is very common and the semantics are non-standard. It's supposed to be a macrotask but I don't know if we can rely on that.. This test doesn't make much sense to me. Can you write this test in the way you expect people to write their product tests?. What is this line for?. I don't get this comment. Nit: nextTick might not be the best name because in Node it behaves like a microtask, not a macrotask. But you specifically want this to resolve after a macrotask.. What if MessageChannel is not defined?. As an example of why you should have a test for each of these scenarios, this part indicates to me that act will fail if neither setImmediate nor MessageChannel is defined:\n\nhttps://github.com/facebook/react/pull/14853/files#r265820721\n(Maybe I'm missing something, but regardless, it would be nice to have a test that verifies this.). They don't need to be super elaborate tests, just a sanity check that this won't insta-fail in those environments so that the next time someone touches this code they don't forget to consider those cases.. As a follow-up item, we should talk to Jest about a version of fake timers that encourages/requires you to wait for a new task. I'm guessing they haven't thought much about this problem because Facebook polyfills promises and transpiles async/await.. Explain to me again why we need to use the built-in promises? I still don't get why a thenable isn't sufficient.. This is in a dev block, anyway, and Promise will almost certainly always be defined, so it can use an existence check. The bar for using $FlowFixMe needs to be really high and I don't think it's necessary in this case.\nAlternatively we should decide that Promise is a required global and update our ESLint config accordingly.. Wrap in a DEV check plz (I know we have a Babel plugin that does this automatically but we try to be explicit and I'd like to get rid of it in the future.). runCallbackUntilPredicateFails isn't a public API, right? Maybe I missed a conversation about this?. I had expected you'd solve this problem with something like doesHavePendingPassiveEffects(). Why is this preferable? Remember this is a temporary workaround and the real solution is to have a custom testing build of React DOM.. That error doesn't seem to relevant to me. It says Promise is not a polymorphic type, which is more a problem with Flow's built-in type defs. But that shouldn't matter here because you don't need to type the resolved value; you only need to call Promise.resolve().then:\nhttps://flow.org/try/#0AoJw9gtglgzgpgOhHGYA2A3OAKAlAgFwAs4A7PIA. You don't need to use Promise in the types of any of these functions though. You can use Thenable<T>.. If it'a already wrapped in batched updates then it shouldn't need to be wrapped in batchedUpdates, too. Why is onDone ever undefined?. I think we can assume successFn is a function. We do the same for Suspense thenables.. Unlike with successFn above, you're not checking if errorFn exists. That's probably ok, because we expect people to use async/await, or wrap in Promise.resolve. But it should be consistent regardless.. If it's already wrapped in actedUpdates, I meant.\n\nI moved the batchedUpdates call from FiberScheduler to here\n\nWhy though? Remember that eventually the entirety of act is going to live in ReactFiberScheduler, behind a feature flag. That's probably what I would have done in this PR, in fact: Implement act behind a feature flag, and turn that on for test and noop renderers. For DOM you can use a (temporary) forked implementation. Then in a subsequent PR you can create a separate build of React DOM that turns on the feature flag.. I wasn't sure about this part so I asked Sebastian and his rationale was that using arguments will make ReactErrorProd slightly slower, but using an array will likely make all the functions that throw slightly slower to compile, so it's hard to say which way is better. But since ReactErrorProd is in an error path, and fewer bytes is generally better, no array is good.. I don't think we've been doing this on our new packages. See: https://github.com/facebook/react/blob/master/packages/react-cache/index.js. ",
    "ali": "Fixed, I used the formatting you suggested.\nLine 78 seems to hint that I should be indenting the lines after the ? with two spaces:\njs\nvar registrationName = (\n  EventPluginRegistry.possibleRegistrationNames.hasOwnProperty(\n    lowerCasedName\n  ) ?\n    EventPluginRegistry.possibleRegistrationNames[lowerCasedName] :\n    null\n);\nLet me know if you prefer this formatting instead and I'll change it.\n. ",
    "prometheansacrifice": "Agreed.\n. Why? Variables in Javascript are known to have function scope.\n. Alright\n. @jimfb @spicyj Can we have a consensus over the warning message? I personally find both the messages good enough.\n. Sure. Foo (or Bar) can directly inherit. Making the change in the next commit.\nIs ES6 necessary here? I find most of the React Component definition is ES5 syntax. Simpler as it maybe, mixing up the syntax looks bad on the file as a whole.\n. Alright then.\n. The same would have to be repeated at React.createClass right?\n. By ===, you mean deep comparison of objects? I remember @jimfb asking me to avoid as it is expensive.\n. Like this?\nvar propsMutated =\n        !shallowEqual(inst.props || {}, publicProps);\n      var componentName =\n        Component.displayName || Component.name ||\n. Currently its just 70 characters. Still break after =?\n. Right. The idea is to replace it with a link to relevant documentation being discussed at #5740 \n. This PR needs more work too. Its failing some tests\n. @jimfb But accessor methods will get triggered for every access. Are you suggesting an alternative to the entire accessor  approach?\n. Right. I'll wait for @spicyj's comment on the next line note and update this PR afterwards.\n. I guess it can be put in a __DEV__ block.\n. The behaviour change can be handled with another condition (check for undefined), however making the checks more ugly.\n. @gaearon /cc. There's a window.addEventListener on L92 too. Use the same trick there?. Or fake polyfill requestIdleCallback itself?. On L92 there a window.addEventListener. \nFake polyfill requestIdleCallback too?. But that wont prevent the codepath accessing requestAnimationFrame (and turns out requestIdleCallback too. L101 is breaking on the server too.\nSo wrap the entire polyfilling code in else block of the if (!ExecutionEnvironment.canUseDOM) {?. What about disableNewFiberFeatures tests that are failing?. Back next to ReactDOMFrameScheduling?. Sure. My bad actually. I have pushed the changes. Please have a look.. Fair point. Making the changes.. Sorry. Don't know how I missed that.. @gaearon How does this require work right now? I couldn't find any jest mocks for 'react'. @gaearon  Move testMinification out of injectInternals? Do we need it if there DevTools are not installed?. Hahaha. Okay \ud83d\ude04 . I used hasLoggedCreatePortalDeprecationWarning to check if already logged. Variable name too verbose?. I feel bad about this: is this okay?. Heads up: A lot of flow fixmes.. Sure we can. This PR is not ready to be merged yet. But I wanted to know if I'm headed the right way with the babel script.. Tried explaining in the comment earlier :). Can you please point me to the change in your PR?. Maybe. I don't know for sure. This file is auto generated. It's the result of the babel script. Right now it's present in the PR to only give a sense of what the output will look like.. ",
    "MattijsKneppers": "The problem for me is that when running python ... from the directory where the file is, the example doesn't work because the server doesn't find directories below the server root (i.e. the files in ../../build/ and in ../shared/css/). When running the server from the repository root, the example does work.\nThis is on Mac OS 10.10.\n. Thanks, will do\n. Which means that installing this preset should also be added to the inline instructions, am I correct? Babel 6.0 will not transpile the jsx file without the react preset as far as I can see. It says\n```\nSyntaxError: example.js: Unexpected token (8:11)\n   6 |       'React has been successfully running for ' + seconds + ' seconds.';\n   7 | \n\n8 |     return {message};\n     |            ^\n   9 |   }\n  10 | });\n  11 | \n```\n. According to @zpao 's comment, I removed the instruction to create a file and added the --presets flag. I also optimized line wrapping for github.\n. \n",
    "yangshun": "@spicyj For the error messages of findRenderedDOMComponentWithClass and findRenderedDOMComponentWithTag, there's no newline after the paren. Should I still go with a newline after the opening paren?\n. Ok, then I'll add the newline after the paren for the error messages for findRenderedDOMComponentWithClass and findRenderedDOMComponentWithTag too?\n. Ok done (:\n. @spicyj @jimfb what's the verdict on this? \"stateless functional component\" / \"stateless component\" / \"functional component\"?\n. missing a comma?\n. This link explains about accessing key and not ref. Might be confusing to the reader.\n. Nitpick: React needs to call componentWillReceiveProps\n. Nitpick: componentWillReceiveProps will get called.\n. Is this a typo? peek vs peak\n. Reorder the sectionListCommunity links on the Community Resources page to match the footer.. The new docs site does not render the bold markdown tags. They have to be converted to <strong> explicitly.. Some ExternalFooterLinks in the Footer were passing in a rel prop but this component was not making use of them.. Redundant else.. Sure, I'll do that in future (:. This is a 404 now because it redirects to https://reactjs.org/react. Current markdown rendering engine requires this line to have a > at the start to treat the whole chunk as one single blockquote.. Current markdown rendering engine requires these lines to have a > at the start to treat the whole chunk as one single blockquote.. The rest of the \"Bug Fixes\" heading in this post are ####.. According to https://github.com/facebook/relay/pull/1965, Relay Playground has been removed. I think this section should be removed as well as https://facebook.github.io/relay/prototyping/playground.html leads to a 404. . Christoph Pojer -> Christoph Nakazawa. It looks better with margin between code blocks and the content below it.\nPrev\n\nCurr\n\n. IMO, the font size of <code> should not be hardcoded as 16 because it is used in multiple places with different font size:\nPrev\n\nCurr\n\n. ",
    "nLight": "It's the same. Any suggestions where to put this variable? Both of them require DOMProperty\njavascript\nvar DOMProperty = require('DOMProperty');\n. Deleted the comment because it's not simplified subset anymore\n. Can't reference ATTRIBUTE_NAME_START_CHAR in the sum if I just put these expressions into DOMProperty as fields. ATTRIBUTE_NAME_CHAR could be a function though. \n. Maybe it's a good idea to put all these regexes in one place like DOMProperty and just use constants.\n. ",
    "rppc": "I think I get the idea!\n. Got it!\n. ",
    "knowbody": "also should be: there're I think\n. ",
    "hejld": "Section headers have anchors by default, can we use #\ud3fc-\uc774\ubca4\ud2b8 anchor instead - without the need for hidden element?\n. Thanks @marocchino and @zpao for the details! I will remove this change here and keep it for another pull request once we know better solution.\n. ",
    "claudiopro": "Same issue with http://facebook.github.io/react/docs/events-zh-CN.html. Is it a known limitation or issue of Jekyll ?\n. @marocchino wow, thanks! Good to know :eyes: \n. ",
    "kryogenic": "Ah you're right, I didn't read the full example. It seems to me that null or false is a better convention than '', as the behavior is the same aside from '' creating extra <span> tags.\nPerhaps it would be better yet if empty strings were treated like null but I am not sure if that is possible.\n. ",
    "mhujer": "Thanks for the feedback, I've added the articles.\n. ",
    "thekevlau": "@jimfb thanks for that info! I was unaware of that; is your feedback that that should also be included in the gotcha? (because it certainly got me)\n. ",
    "koulmomo": "mostly out of curiosity.\naccording to: https://github.com/petkaantonov/bluebird/wiki/Optimization-killers#2-unsupported-syntax try/catch/finally make their containing function unoptimizable (in V8 at least).\nIs there a reason you don't use the suggested workaround of isolating the try/catch/finally statements into minimal functions? \n. ",
    "freddyrangel": "Ah makes sense! Ok done :)\n. ",
    "tgandrews": "I want to leave things as jumping off points, otherwise we should be providing a full skeleton.\n. I don't mind on this one. @cody do you have a preference?\n. Is it worth including this in what is just a starting point and I did not expect it to be a final config?Hence, it just comments what could be done for dev mode and does not include a comprehensive config.\n. I don't mind on this one, I use jsx for React components and then js for all pure JS files. The client convention as well is something I have used in a few projects. I am happy to change this.\n. ",
    "abhinavsingi": "Expected value can of type object/function, why restrict it?\n. ",
    "kentcdodds": "TIL\n. yup! comma-dangle specified here :+1: \n. When calling preventDefault, we set the defaultPrevented access the nativeEvent properties. This leads to three warnings even if the developer only called preventDefault.\n. Similar situation as mentioned above\n. whoops :-) fixing now\n. I'm getting a linting error:\n190:13  error  The second argument to warning must be a string literal  react-internal/warning-and-invariant-args\nI think it's because of this line. Is there a reason I can't provide the propName here? I feel like it would be useful to have it.\n. Same lint error here.\n. :+1:\n. Ah, yeah, that makes sense.\n. The thing I'm trying to avoid is multiple warnings. If we try to set this.defaultPrevented after this has been destructored then we'll get a warning for that action. Similarly for accessing this.nativeEvent. So this code change was an effort to first check if it's already been destructored, if it has, don't attempt to access/set variables, log the one warning, and return.\n. Sounds good to me. So how about I put this function at the bottom of the file, then change the code to something like:\njavascript\nvar Interface = this.constructor.Interface;\nfor (var interfacePropName in Interface) {\n  setToNullOrWarning(this, interfacePropName);\n}\nsetToNullOrWarning(this, 'nativeEvent');\nthis.dispatchConfig = null;\nthis._targetInst = null;\nthis._destructored = true;\nWhere setToNullOrWarning accepts a context and a propertyName.\n. :+1: \n. I see what you mean. With what you're suggesting, the production code will pretty much look like it does today. Makes total sense. I'll adjust my implementation to optimize for that. Thanks!\n. Unless I'm missing something obvious, putting a function declaration in an if block like that wont work. However dead code elimination would remove it anyway, so I think we're good.\n. Should we be concerned about performance implications of deleteing the properties off the instance?\n. I think I'll just put this in an if (__DEV__).\n. This function will be dead-code eliminated when !__DEV__ because it's only referenced in if (__DEV__) statements.\n. Just realized this property is no longer necessary. Updating now.\n. This warning now happens when the property is accessed\n. Updated. Thanks!\n. Thanks for the reminder. Forgot about that. I totally agree.\n. > In addition, it might be best to preserve the old wording (calling a method rather than accessing the property) for methods.\nI considered that, however this wouldn't make sense in a scenario where they're simply getting a reference to the method:\njavascript\nconst stop = event.stopPropogation\n// maybe use stop later or something?\nThis would log a warning that wouldn't make sense because they're not actually calling it. I realize that's an edge case, but thought it would make the code simpler and the messaging more accurate.\nDefinitely willing to be overruled though :-)\n. That's reasonable. Updating now :-)\nOn Sat, Jan 30, 2016 at 1:00 PM Dan Abramov notifications@github.com\nwrote:\n\nIn src/renderers/dom/client/syntheticEvents/SyntheticEvent.js\nhttps://github.com/facebook/react/pull/5940#discussion_r51350027:\n\n\n'This synthetic event is reused for performance reasons. If you\\'re ' +\n'seeing this, you\\'re setting property %s on a ' +\n'released/nullified synthetic event. This is effectively a no-op. See ' +\n'https://fb.me/react-event-pooling for more information.',\npropName\n);\nreturn val;\n},\nget: function() {\nvar warningCondition = false;\nwarning(\nwarningCondition,\n'This synthetic event is reused for performance reasons. If you\\'re ' +\n'seeing this, you\\'re accessing property %s on a ' +\n'released/nullified synthetic event. This is %s. See ' +\n'https://fb.me/react-event-pooling for more information.',\n\n\nAh, good point. Maybe something like \"accessing a method\" is neutral\nenough?\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/facebook/react/pull/5940/files#r51350027.\n\n\nKent C. Dodds https://twitter.com/kentcdodds\n. That make sense. I felt odd spying on it and not asserting anything. Will do.\n. :+1: \n. Full disclosure. The resource itself is absolutely free and always will be. However I do make money when people watch it. Thought it appropriate to call that out.\n. I'd be cool with the badge linking to react-specific notes. I'm mostly motivated by a desire to make it easier for beginners to contribute to React.\n. \u00af\\_(\u30c4)_/\u00af works fine either way. Test it here. Nice thing about this is that it'll work in forks as well. But let me know if you want me to change it.\n. Sure!\n. Updated :+1:\n. I wasn't sure how to reproduce this problem in a test. This is in updateFromMap. Any tips?. Yes, please let's not force all tests to be async \ud83d\ude2c. I'd just like to only have to await in my test if my component actually is doing something async (typically with promises). Otherwise I'd like to keep my test sync is all :). I'm personally fine with that plan so long as there's a useful error message that explains what's going on clearly please. Because I just know I'll get issues on react-testing-library otherwise.. Perfect \ud83d\udcaf. \n\n",
    "iamchenxin": "i will do a revert, and separate en-docs and zh-docs commit.\nfor  en-docs ,the mainly modification were delete the unnecessary newline\n. ok\n. @jimfb  :D , nope , that is [\u6d45 shallow] not [\u94b1 money], Shallow is always translated to \u6d45 in  mainland of china, like \u6d45\u62f7\u8d1d\uff08shallow copy\uff09\uff0c\u6d45\u5806\uff08shallow heap\uff09\u3002\nWait! I find that is my mistake \uff0c i see it ... \u94b1\u6e32\u67d3\u662f\u4e00\u4e2a\u5b9e\u9a8c\u6027\u7279\u6027  #_# , thank you,shame for my wrong typo .\n. @jimfb Maybe there should have a plan to host a top-level Glossary page(en to non en) for non English docs. Cause in Chinese Mainland React community\uff0c there are a few kind of different glossary for a same English word\uff0c this makes  meanings are quite vague\u3002\nAs someone said:  One of the key steps in becoming immersed in an ecosystem is learning its vocabulary. \n. ",
    "zzz6519003": ":beer: \n. ",
    "TimeBandit": "I understand your point but the grammar isn't quite there I think. However, if you insist on the singular form, maybe it would be better to say, \nFind a common owner component, i.e. a single component above all the components that need \"state\", in the hierarchy).\n. Agreed, you can close this one :+1:\n@jimfb as a new reader of the document I think once the context became fully understood then it became clearer. I think if to my new eyes if it had said something like \n(a common component above all the components that use state). \nthen, there wouldn\u2019t have been that disjunct in my understanding which probably would have gone anyway on a second or third pass of the document as is.\n. ",
    "austindebruyn": "Check a file like ReactElementValidator to see how a module-global object (ownerHasKeyUseWarning) is used to make sure the warning is printed only once for each offense.\n. ",
    "milesj": "I was trying to recreate the scenario in my codebase where componentWillReceiveProps wasn't firing, as seen here: https://github.com/facebook/react/issues/5756#issuecomment-168873198\n. Correct, they will only run once. The checked property handles this -- but I could probably just execute the validators on load and forget these checks all together.\n. I originally had it this way. I will change it back.\n. Thanks for the heads up.\n. Oops, nice catch, that's left over from old jQuery code I copied. It was there because different versions of Opera supported either otransitionend or oTransitionEnd and jQuery allowed binding multiple events via spaces. The lowercase one is the latest, so I will update to use that.\n. Yeah it was hard to tell. Would be nice if there was a table of all the browsers, their versions, and what prefixes are used.\n. This isn't true though. Passing props to super is only required when access this.props in the constructor, which is pointless since you can just access props from the constructor args.. Where does it state that time was deprecated?\nhttps://www.w3.org/TR/html5/text-level-semantics.html#the-time-element. \ud83d\udc4d . s/isFragment/isPortal. Might be a bit much, but what if it was element for a DOM element and component for a React component, instead of value?. Noticed the capital e.. You should just use preset-env instead of doing this all manually.. ",
    "mwiencek": "I made it so that if it's an empty string it doesn't insert an empty text node between the comments. Not really sure which is preferable.\n. Since text components consist of multiple nodes, I needed a way to get a reference to the last node (the closing comment) here...\n. Is there a better way than using a document fragment here?\n. Okay, it seems to work out nicely if I just make the closing comment node the \"native node\" and cache the opening comment node on the text component. The opening comment is only needed when calling removeDelimitedText or replaceDelimitedText. Or I suppose those functions could traverse backwards instead, if they're given the domID. I'll push the changes and let you be the judge. :)\n. So this and line 147 are the only places that need to reference this._openingComment now. I made unmountComponent remove the opening comment + text nodes here but the closing comment node is still removed via ReactMultiChild -> DOMChildrenOperations, since it's what's returned by getNativeNode. I didn't need to change anything about ReactMultiChild or DOMChildrenOperations.processUpdates that way.\n. So now I remember the problem with doing that in DOMChildrenOperations was that if I set _openingComment to null here, I wouldn't be able to access it in DOMChildrenOperations. Not sure of a good way around that. So I just added a getOpeningCommentNode method that takes the closing comment as a param and walks back from there (couldn't look at this._nativeNode either since it's also null in DOMChildrenOperations).\n. Hmm, I think returning just the closingComment was convenient because the lastPlacedNode stuff in ReactMultiChild uses getNativeNode for that, and I didn't have to add any special cases for it that way. But I'll see if that turns out to be simpler.\n. Seems to work fine. :) But not sure if Array.isArray is a very robust way to check for this case.\n. Woops, sorry, I guess I assumed useCreateElement=false was already tested. But this seems obvious now. Too bad we needed the code to find the other comment, after all.\n. ",
    "SimenB": "Ah, of course. Do [<div/>, <div/>], then?\n. Ok, updated. Thanks for the really fast feedback\n. I did indeed!\n. Changed\n. Changed\n. I just copied from the ref docs: http://facebook.github.io/react/docs/more-about-refs.html#the-ref-callback-attribute\n. It's gone now, and wrt the first point, again copied from http://facebook.github.io/react/docs/more-about-refs.html#the-ref-callback-attribute.\nWRT second point, I agree! But it's gone \ud83d\ude06 \n. Oops, that was the whole point of that snippet...\n. Should be able to just do path.posix.relative here instead. expect is still in here in beta, is that used?. you should dedupe. Using Jest 24, the test passes without faking global.requestAnimationFrame. So whenever the upgrade lands, just remove the implementation here. Lolex will fake this.\nThe test also passed when removing it when using Jest 23, not sure what it was supposed to do?. Could do an await, then you're guaranteed a tick even if promises are faked. This might be set to something else (https://jestjs.io/docs/en/configuration#testenvironmentoptions-object).\nMight be a good idea to also check for some sign it's Jest (e.g. Jest can start to do global.thisIsActuallyJest = Symbol.for('jest-yes-this-is-jest') or something). I saw the earlier talk about checking for global.it - at some point Jest will want to provide a global-less API so it'd be great to not couple anything more to it (although not in the immediate future). that might also go away at some point, but not in the foreseeable future. Thanks!. ",
    "hayesgm": "Removed this test case to defer to changes in #5819\n. Removed this test case to defer to checks added in #5821\n. Went ahead and replaced all of these after a direct call to ReactDOM.render() in ReactDOMInput-test.js and ReactDOMTextarea-test.js\n. Sorry, been MIA, taking a look now.\n. I believe this was causing a quirk with one of the test cases, as setting innerHTML changed the behavior of my test. Also, I think it's a strange hack that should be opt-in instead of opt-out for test cases which call into renderTextarea. That said, if it's no longer applicable, you can surely remove the flag.\n. Sounds right to me.\n. If I recall from way back when, once you call the setter for value, it then ignores changes to the defaultValue. In this case, we set the value to the same value, which has this effect.. ",
    "david0178418": "Done.\n. Ah.  Clearly, I didn't have enough coffee today.\nDone.\n. ",
    "benmills": "I'm unsure about this part. I like reusing the primitive function checker, but using apply might be too magical.\n. I only see tests for string. I added function since I was relying on it in my tests. Is the thought to only test one example of createPrimitiveTypeChecker? If so I could remove mine.\n. ",
    "satya164": "Did you mean past?\n. Why not const instead?\n. This is a syntax error. It should be render().\n. This looks wrong. Where is the closing brace for the function? Also class properties are stage-1 feature. you probably meant to use a class method.\n. You're calling the function here instead of passing it to onClick. Also it should be attached to this (this._handleClick)\n. This should be inside a render method\n. The ref should be attached to this\n. ",
    "piscolomo": "it makes sense, I've updated the PR following your suggestion @jimfb \n. i didn't notice that, thanks @syranide i've sent a fix\n. ",
    "mdolbin": "Agree, I was thinking about false compared to missing declaration but surprisingly I forgot to consider null as an option\n. @jimfb I saw this pattern a lot of times, but it seems like it would be much easier to rework an abstract component as a whole if we know about all warnings at once (which can be delayed in time), instead of discovering them one by one. IMHO\nAnyways, let me know if we still want to stick to the first warning only policy. I'll just add one more property to the _serverSideRendered object in that case\n. Makes sense\n. ",
    "ianobermiller": "Yes, that makes sense, need to add a null-check then. Still need a truthy check on mappedChild.key, so mappedChild.key && (!child || mappedChild.key !== child.key)\n. I hate all the parens, but this makes it crystal clear.\n. ",
    "chrisbolin": "You're totally right! I'll fix that\nOn Mon, Jan 25, 2016 at 2:31 AM Baraa Hamodi notifications@github.com\nwrote:\n\nIn docs/docs/10-addons.md\nhttps://github.com/facebook/react/pull/5912#discussion_r50660214:\n\n@@ -18,7 +18,7 @@ The React add-ons are a collection of useful utility modules for building React\nThe add-ons below are in the development (unminified) version of React only:\n-- TestUtils, simple helpers for writing test cases (unminified build only).\n-- Perf, for measuring performance and giving you hint where to optimize.\n+- TestUtils, simple helpers for writing test cases.\n+- Perf, a performance profiling tool for finding optimizations opportunities.\n\nNit pick: optimizations should probably just be optimization here.\n\u2014\nReply to this email directly or view it on GitHub\nhttps://github.com/facebook/react/pull/5912/files#r50660214.\n. \n",
    "scjody": "@zpao Done.  Sorry I didn't notice that earlier.\n. ",
    "MarkMurphy": "hidden wasn't working for me. I checked the Bootstrap docs which shows to use hidden.bs.model and that did work for me.\n. Also, it may not have been working because there was no listener in place for either event ie.\njavascript\n$(this.refs.root).on('hidden.bs.modal', this.handleHidden);\n// or\n$(this.refs.root).on('hidden', this.handleHidden);\nI added that listener on line 25\n. Actually, both event names work. The syntax is how jQuery namespaces events. So it wasn't working for me initially because there wasn't an event listener setup when the component was mounted.\n. ",
    "truongduy134": "Ah I see. Will update the behavior and test cases. Thanks @jimfb \n. Thanks @jimfb . I usually have this allocation to avoid undefined checking, but not realize it has bad effect on gc. Updated my PR\n. ",
    "sambev": "@jimfb Removed check for pendingUpdate. Let me know if there is anything else, or I misunderstood. Thanks!\n. ",
    "wnr": "It seems to me like the !target.nodeType doesn't to anything really. If the target has a correspondingUseElement property, the target must be an instance of  SVGElementInstance and lives in the shadow DOM. Such elements do not have a nodeType property, and therefore it will always be falsy. Perhaps the check is present for some weird browser bugs? @edmellum \nhttps://www.w3.org/TR/SVG/single-page.html#struct-__svg__SVGElementInstance__correspondingUseElement\n. ",
    "edmellum": "I've looked over and retested everything. !target.nodeType is a relic from my exploration during early implementation that only partially solved the issues on IE, whereas correspondingUseElement properly solves it. I'll remove it and rebase onto the current commit so there's no noise to merge.\n. ",
    "joshhunt": "I know I'm late to this, but ['node_modules'] is the default anyway, so that whole resolve: {} block could be removed (presuming .jsx is dropped in favour for .js), making the config less overwhelming for a 'getting started, and the webpack docs covers this config and many others in depth.\n. IE does not support innerHTML on SVG Elements, so we wrap the markup to make it a 'complete' svg string, pop that into a temp container node, then copy across the children of the <svg>.\n. what would be the advantage of checking the namespace as opposed to just checking if the node is a SVGElement?\n. You're right - I knew it wouldn't work in the browser but was hoping that it would work under the fake JSDOM environment and I meant to confirm, but missed out.\nI'm kinda stuck for how to accurately test this then, apart from creating a complete mock node like\nvar node = { appendChild: spy() };\n...\nexpect(node.appendChild).toHaveBeenCalled();\nSeems like a bit of a pointless test though if I'm not even passing in a real node.\nJSDOM also seems to lack SVGElement which makes it slightly harder as well\n. Ended up using defineProperty to 'remove' the getter to make innerHTML undefined, and then assert on node.outerHTML. On second thought I guess I could have asserted on node.firstChild.outerHTML, but I think this is is fine.\n. ",
    "stonebk": "Leave PropTypes.bool and PropTypes.func for backwards compatibility. Not sure what route should be taken to deprecate these.\n. ",
    "raineroviir": "Cool!Thanks for the notes I'll fix this\n. Are there any examples of the Devtool api used in React code?\nWould I be writing my own devtool function or do I use something like ReactDOMInstrumentation.debugTool.onSetValueForProperty(inst, 'processingChildContext', true)\n. Cool , Thanks!  \nSo I notice I can't extend the internalInstance object to add the flag (that we are processingChildContext). What is a good object to add the flag to?\n. Thank you for the notes!\n. You're right, Thanks\n. Got it. That providesModule thing is super cool \n. I wanted to see why the test was throwing the warning \n1. in the original test we rendered <Parent> <Child /> <Parent>, and on setState we change the render to <Parent><span>Child</span></Parent>\n2. in the changed test which doesn't create a warning we go from <P><span>Child</span> </P> to <P><Child /><P>\nI commited the change here for now in case it could benefit our search for the fix\n. Yeah! I will make the original test pass\n. Sure\n. ",
    "jmm": "If something like this does eventually go in it should probably link to the definition of ReactNode, which should of course be updated if necessary (e.g. it does not currently mention null, boolean, undefined, or non-array iterables.)\n. ",
    "csuwildcat": "This is more of a curiosity than anything: does the perf profile look the same if you do the same sequence of appends with nodes in a Document Fragment?\n. ",
    "stevenvachon": "It sets it to styleFloat in IE8.\n. ",
    "swaroopsm": "Oh my bad. I meant spec === null.\n. Missed spec === null in here as well.\n. Ah right. Warning behaves the opposite of an if statement.\n. Yeah right. IMHO, I don't think there might be a case where an array will be included as mixin? The docs also has an example with a mixin being an object. Thoughts?\n. @gaearon Since we have this condition, a mixin in case if is an array, will never get inside this block. \nI feel if a mixin is an array, then its better we show a separate warning that says: \nWarning: Your\\'re attempting to include a mixin that is an array. Expected object but got array\n. ",
    "mxstbr": "There's a gate on 630 if (this._pendingElement != null) {, so it can't be null there, but it might be undefined?\n. TIL that works with != null!\n. 'Unkown' is a weird default, imagine getting an error message like:\nReact.createElement(...): Expected props argument to be a plain object. Properties defined in its prototype chain will be ignored. Unknown.\nWhy not make it an empty string and leave as-is by default?\nI'd also change the error message instead of appending the name, what about something like this:\nJS\n'React.createElement(...): Expected props argument of ' + displayName +\n' to be a plain object. Properties defined in its prototype chain will be ignored.'\n. ",
    "yuanyan": "when this._pendingElement is undefined, this._pendingElement != null is false value.\n. this._pendingElement is  object or null. \n. ",
    "conorhastings": "not sure if any of these are possible in real scenario  but this code could theoretically perform differently then before I believe.\n\n. ",
    "camjc": "Thanks for catching that @cody!\n. ",
    "everdimension": "@zpao It's a question of being either clear or general. In any case, I'm not aware of other attributes which may need to be handled similarly. And currently it is the only one. The previous comment line mentions this, so I believe writing value makes it more clear for others reading this code.\n. ",
    "shogunsea": "can you remove xxin@groupon.com ? was a mistake, sorry about this, thanks!\n. ",
    "maherbeg": "As in, add an expect call within componentWillMount? Sure!\n. ",
    "jdlehman": "I was trying to avoid branching, but the bind definitely felt dirty to me as well, so I am glad that you found it to be disagreeable as well. The branching implementation you proposed definitely assumes less.\n. This is where I initially thought they were doing something different as well. This code was actually added later to fix a bug with default props (undefined values were not falling back to default props) that only existed in cloneElement via https://github.com/facebook/react/pull/5997/files.\nThe real difference structurally between how it was and how it is in this PR is when default props are set (if needed). Currently they are set while setting props, but before setting children on props. The order ultimately doesn't matter because default props will only be set when a value is undefined and clone element. We can also see from the tests passing that this functionality still behaves as expected.\nThough actually, from playing with this more I this difference is an inconsistency when children is explicitly set to undefined and the component has a default prop for children. See the issue I just opened: https://github.com/facebook/react/issues/14136.\nI'll add a test case depending on the outcome of that issue.. I think here we just care if the prop value is undefined, otherwise explicitly setting a prop to null would fallback to the default prop since null == undefined is true. (perhaps it might be more clear to do typeof props[propName] === \"undefined\"). ",
    "cbrwizard": "Done! Want me to add a rule for that to .eslintrc in a separate PR?\n. ",
    "rayshan": "\nThis only works when you have at most one child such as a collapsible panel. This approach wouldn't work with an image carousel because while an image is animating its way out, another image animates its way in, so <ReactTransitionGroup> needs to give them a common DOM parent. You can't avoid the wrapper for multiple children but you can customize it with the component prop as described above.\n\nMay I propose:\n\nThis only works when you are animating a single child in and out, such as a collapsible panel. This approach wouldn't work when animating multiple children or replacing the single child with another child, such as an image carousel. For an image carousel, while the current image is animating out, another image will animates in, so <ReactTransitionGroup> needs to give them a common DOM parent. You can't avoid the wrapper for multiple children, but you can customize the wrapper with the component prop as described above.\n. \n",
    "koistya": "Shouldn't it be symbol: createSymbolTypeChecker, (without () at the end)?\n. ",
    "RaitoBezarius": "Calling the createSymbolTypeChecker returns the chainable type checker, right?\nAs you would do something like: React.PropTypes.symbol.isRequired and not React.PropTypes.symbol().isRequired (am I wrong?)\n. It's a leftover from a @puradox fix on tests \u2014 I will clean up this!\nOn Sat, Apr 9, 2016, 00:26 Dan Abramov notifications@github.com wrote:\n\nIn package.json\nhttps://github.com/facebook/react/pull/6377#discussion_r59097655:\n\n\"coveralls\": \"^2.11.6\",\n \"del\": \"^2.0.2\",\n \"derequire\": \"^2.0.3\",\n-    \"es6-symbol\": \"^3.0.2\",\n\nIs this necessary? Doesn\u2019t appear to be used.\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly or view it on GitHub\nhttps://github.com/facebook/react/pull/6377/files/ad94295f139a8190286852e14a5c731065f5f0ba#r59097655\n\n\nRyan Lahfa, de mon t\u00e9l\u00e9phone.\n. I have pushed a fix on your fork to remove the dependency, so that we can\nunblock the code review.\n\nKind regards, Ryan Lahfa\n. ",
    "troydemonbreun": "Ah,  I didn't realize that operation was called directly. I've another\napproach in mind as well,  I'll try it out next week.\nOn Apr 1, 2016 6:35 PM, \"Jim\" notifications@github.com wrote:\n\nIn src/renderers/dom/shared/ReactDOMComponent.js\nhttps://github.com/facebook/react/pull/6398#discussion_r58281313:\n\n@@ -651,6 +652,9 @@ ReactDOMComponent.Mixin = {\n             markup = DOMPropertyOperations.createMarkupForCustomAttribute(propKey, propValue);\n           }\n         } else {\n-          if (DEV) {\n-            ReactDOMInstrumentation.debugTool.onCreateMarkupForProperty(propKey, propValue, this._currentElement);\n\nThis line is the main one that concerns me. It seems like this call should\nbe inside createMarkupForProperty such that it gets invoked whenever\nanyone calls it will get the onCreateMarkupForProperty event. However, we\nshould not be passing the element to createMarkupForProperty.\nThus, why this PR is difficult, thus my comments in #6062 (comment)\nhttps://github.com/facebook/react/issues/6062#issuecomment-185528241\nand #6062 (comment)\nhttps://github.com/facebook/react/issues/6062#issuecomment-185535439\n\u2014\nYou are receiving this because you authored the thread.\nReply to this email directly or view it on GitHub\nhttps://github.com/facebook/react/pull/6398/files/295b048adf2a1de62d2572c179da584bccfc7cb1#r58281313\n. Yes,  have rebased\nOn Apr 26, 2016 6:45 PM, \"Dan Abramov\" notifications@github.com wrote:\nIn src/renderers/dom/shared/ReactDOMDebugTool.js\nhttps://github.com/facebook/react/pull/6398#discussion_r61183415:\n\n@@ -62,6 +62,27 @@ var ReactDOMDebugTool = {\n   onTestEvent() {\n     emitEvent('onTestEvent');\n   },\n-  onBeginProcessingChildContext() {\n-    emitEvent('onBeginProcessingChildContext');\n-  },\n-  onEndProcessingChildContext() {\n-    emitEvent('onEndProcessingChildContext');\n-  },\n-  onSetState() {\n-    emitEvent('onSetState');\n-  },\n-  onMountRootComponent(internalInstance) {\n\nNow that #6549 https://github.com/facebook/react/pull/6549 landed, the\nargument is debugID rather than internalInstance.\nWould you mind rebasing on that?\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly or view it on GitHub\nhttps://github.com/facebook/react/pull/6398/files/ba8e02edad10495fb868586ec53519b881fa4f3e#r61183415\n. @gaearon no-oped, or should I return false?\n. @gaearon oh, so don't call createChainableTypeChecker as an alternate branch flow, always call warning?\n. @gaearon pushed my interpretation of your comments, thanks\n. @gaearon feedback implemented, thanks\n. \n",
    "levrik": "style={{'{{'}}width: '300'}} does not look right. It should look like this: style={{width: '300'}}.\nAlso there's missing a close bracket I think.\n. ",
    "sprjr": "The markdown parser on their site is different than GH, unfortunately, but this works on the blog post display just fine.\n. Not sure why, but like in XML: felt awkward to read. Would just like XML: be better?\n. ",
    "aweary": "\nThis, along with the other changes mentioned above, have always been considered implementation details of how React targets the DOM.\n\nShould be \"has\" since \"this\" is the subject and singular.\n. OS X always burning me with these apostrophes!\n. Is the typeof check required? shallowCompare should already work with stateless components so that same behavior should apply to context.\n. I did verify that this test fails without my code change. Mocking isEventSupported isn't required because it just returns early no matter what if we're using SSR, so the warning call is never reached.\n. Is this check necessary? I'm pretty sure that prop types are only validated in __DEV__ anyways so this would only be executed in the __DEV__ code path anyways.\n. Shouldn't coponentWillTransition be called before componentDidTransition?\n. Did you mean to leave this console.log call here? \ud83d\ude03 \n. @git-richard you're not returning undefined, you're returning the string 'undefined'. Also, if offset{X,Y} is added to a SyntheticMouseEvent it should be available in all browsers React supports, so a polyfill is required.\n. This should be placed within the _DEV_ block at the top of the function so it only runs in development.\n. You would create a new file for this warning. #7040 is just a reference for what it might look like. You can maybe name it something like ReactDOMDuplicateSelectValuesDevtool.js to be consistent with the current naming scheme.\n. @git-richard looks like a copy/paste error to me, but @jimfb can verify. \n. I feel like this should include a reference to which element is causing this warning.\n. Per @jimfb new warnings should be implemented within devtools (you can reference https://github.com/facebook/react/pull/7040 as a template)\n. Here's a jsfiddle with the current code, I'm not seeing any difference when the return value is changed. What version of React are you using?\n. @sthodup1  Glad to here. Maybe you can open a PR that updates the example's React dependency? \n. Thanks @sthodup1! would you mind closing this PR then? \ud83d\udc4d  (edit: nevermind :-) )\n. This implementation would require validating the tags against some kind of whitelist since HTMLUnknownElement isn't reliable either, so is there another reliable source? Seems like this PR would hinge on that.\n. If there isn't a secondary source to validate against to ensure that HTMLUnknownElement isn't throwing false positives we'd probably need to consider a different way to handle this. Keeping around  ReactDOMFactories just for this case is likely not the best solution.\n. Would it be possible to add any type annotations if you're already using flow? I know there have been some recent efforts by @vjeux to add annotations. I don't see any files that are using weak mode either so that might be something to consider.\n. This param type needs to be updated\n. Yeah that's a good point, the constructor clearly shows that the transaction is of the Transaction type like 4 lines later. It's probably redundant. The only downside I could imagine is that people might be more used to parsing types from JSDoc annotations, but that's not a big concern since this isn't a public API\n. @gaearon any particular reason to use spyOn instead of jest.fn()? I know @cpojer has recommended using jest.fn over spyOn to me in the past.\n. There's a test towards the bottom that tests that these warnings don't appear in the dev environment.\n. Maybe I should rename typeCheckPass. It doesn't actually test if the validation passes or fails since that's tested elsewhere. I used valid and invalid values to be sure that the error is logged regardless of whether the validation passes or not.\n. Just once per what, the type checker or the prop/component?\n. Maybe something like productionWarningCheck instead\n. So should I use a generic message that doesn't mention the component name/prop then? I included that because I thought it would be useful, but if we're only warning once globally then it won't really matter\n. Cool that works for me \ud83d\udc4d \n. Well if we're not doing any __DEV__ tests then it would just be a constant 0 right? No need for any kind of branching.\n. My concern was that if we only warned once and they are calling PropType functions in multiple places they are only being warned about one of those instances. That might be annoying, especially in production, since you'd think you fixed it (since you only got one warning) and then you'd get the warning again for the next instance.\n. \ud83d\udc4d  will do. Just curious, why? It'll be coerced to a string either way AFAIK.\n. Yeah definitely! \n. > I\u2019m a bit concerned about this. We\u2019re not actually testing that React is passing the secret when validating.\nThere is a test in ReactPropTypesProduction-test.js that makes sure the warnings aren't being called when prop types are validated internally.\n\nSo if React doesn\u2019t do it in some case.\n\nReact should do it all cases, I updated all the files that called a PropType function internally, and I would say it's reasonable that any future changes that involve calling one of these PropType functions should also be sure to pass in ReactPropTypeSecretValue. \n\nwe\u2019ll miss this.\n\nIt's hard to miss, the test suite blows up if a warning is logged when it shouldn't be.\n\nCan we change these typeCheckFail and typeCheckPass to be more like integration tests? i.e. they would create a class and then make sure that calling createElement produces (or doesn\u2019t produce) the relevant warning. Or am I missing something?\n\nI can definitely do that. As is I don't think it makes a difference, but it would ensure that future changes to how PropTypes are checked don't require this test to be updated as well.\nThe only issue I see is that if we do it this way we can't get the actual error instance returned from declaration so it would have to rely on spying on console.error instead.\n. I learned that the hard way once everything started failing after moving this from production to dev \ud83d\ude04 \n. Do you want me to change the other instances of this? I was just following the format of the other tests in this file. (see ReactServerRendering-test.js#L265-L268)\n. For you to remind me I left it there so I can remove it \ud83d\ude09 \n. This warning is consistent with the current invariant in ReactCompositeComponent: https://github.com/facebook/react/blob/master/src/renderers/shared/stack/reconciler/ReactCompositeComponent.js#L1182\n. But I do think I should probably include the component/ref name just like https://github.com/facebook/react/blob/master/src/renderers/shared/stack/reconciler/ReactCompositeComponent.js#L1187-L1190\n. I use toContain so I don't have to include the \"Warning: \" prefix in the check.\n. component.getName is not always going to be defined here.\n. This entire block should be wrapped in if block that just checks __DEV__, so that the code can be removed completely in a production build\njs\nif (__DEV__) {\n  // check enableStrictAttributeValidation here\n}\n. Would it make more sense to warn instead of throw? If it's a noop currently it doesn't make sense to start throwing errors. If so you should use the warning package. Even if it's decided this would throw you would want to use the invariant package here instead of throwing the error manually.\n. I think we need to be explicit about how React.PureComponent is for ES6 classes specifically. I like how @jimfb phrased it. I know we say \"base class\" here, so it implies it's for ES6 classes, but maybe we can just make that clearer? \n. @TanaseHagi can you add a new line here, per @zpao's request? I think we can merge this after that change.\n. How does this perform for an <input /> that may have numerous props, compared to the current implementation? An indexOf check for every prop in nextProps seems potentially expensive. \n. Relay has a RelayTypes and RelayInternalTypes file, would there be any benefit here to implementing something similar to that approach, if the end goal is a fully typed codebase?\n. Can we change \"Careful things might break\" to something a little more formal / explanative? Like maybe \"Using shady-dom with React may cause subtle issues and is not recommended\" @gaearon any input on phrasing here?\n. If accepted, wouldn't this introduce a new inconsistency between controlled text inputs and checkboxes?\n. Should we have tests for both renderToString and ReactDOM.render? The title of this test block should be changed too if we're not testing SSR.\n. nitpick, but can you use a single line comment instead of a block comment? Just so it's consistent. Also, I think you can just remove the link to the W3C standard \ud83d\udc4d \n. Instead of using these inline fallbacks, can we just wrap this entire function body in an if block that checks for MutationObserver? That way it's just a no-op if it doesn't exist.\njs\nstartObservation: function() { \n  if (MutationObserver) {\n  // ...\n  }\n}\n. I think this should also be a devtool hook as well (see renderers/dom/shared/hooks), does that sound right @jimfb?\n. Won't this cause warnedOnce to be set to true even if this invariant evaluates to true and doesn't actually log a warning?\n. Sorry for the small nitpick, but can you remove the left over comma too? Thanks! \n. One last thing: I think the grammar might be a little bit confusing as-is. Can we change this to:\njs\n// specifies target context for links with `preload` type\nThat's more in line with how the spec describes it as well. After that I think we can merge \ud83d\udc4d \n. coveralls should do that too https://coveralls.io/features\n. Isn't this the opposite of what we want? i.e., we want to add the empty click handler to elements that aren't considered interactive? \n. I think we're wanting to use | null instead of ? so we avoid the ambiguity that the maybe type has https://www.facebook.com/groups/2003630259862046/permalink/2098952973663107/\n. Not sure how this would be typed, is there a better way to type an object that looks like a DOM node?\n. Should we have a default getMockRef implementation  as well and just return this._mockConfig.getMockRef(this._currentElement)?  Or just keep that check\n. So, there's a difference between setting node.value and calling node.setAttribute('value').  node.value tracks the value of the node in JS, and setAttribute will actually set the attribute on the element in the DOM.\nThis change causes an issue where the DOM attribute is never updated, because node.value is already updated prior to this check, so it never actually sets the attribute. \n. React does deviate from browser behavior when it comes to controlled components (e.g., change events on keydown instead of on blur). Currently the value attribute does update on controlled inputs, and it looks like we're explicitly setting it, so there may be a good reason I'm not aware of.\ncc @spicyj @zpao\n. Oooo, I didn't know about _compositeType, thanks! \ud83c\udf89\n. It should still suppress the warning correctly though, right? Since it wouldn't be a SFC if there wasn't a _compositeType anyways. I can add an additional check to make it safer if you'd like\n. Sorry, I didn't remove this when I implemented the transaction code.\n. getPublicInstance is already defined inside the test renderer, but I didn't think to pass the transaction itself to getPublicInstance, which should let us clean up all this domain-specific code\n. @gaearon one issue is that component.getPublicInstance() will be calling ReactCompositeComponent.getPublicInstance if the component is a composite. Even if I pass transaction all the way to ReactCompositeComponent, it would have to be aware of transaction.mockConfig if we wanted composite components to return mock instances.\n. I'm surprised that changing the return type doesn't break any tests, do you know if there are cases in our test suite that returns [null, null]? \n. Can you add a space before the key name and after the value? { autofocus: 'autoFocus' }\n. Got it. This is eventually passed to accumulateInto which accepts either an item or array of items, so it works just fine.\n. I'm so sorry @hkal, I guess we don't pad inline objects \ud83d\ude2d . You were totally right the first time.\n. Currently if you pass in anything as options to create it does assume that you've provided a getMockRef function and it will throw. How do you want to handle that? Should getMockRef be required if you're passing in your own options? \nI'm assuming somewhere down the line we provide more user-configurable options to pass here, so I don't want to default to defaultMockConfig if getMockRef doesn't exist.\n. We're already calling Object.assign on the prototype, do you think it would be worth just assigning these there instead, like we do in a few other places? It would be a bit cleaner.\n. @gaearon should I add flow as a separate PR? I know you mentioned keeping style changes separate from feature changes, but I wasn't sure where flow landed on that spectrum.\n. I wasn't too sure if I typed nativeParent and nativeContainerInfo correctly. From what I could tell, nativeParent is either null or another instance of ReactTestComponent, and nativeContainerInfo was either null or undefined.\n. Let's say \"ES6 classes\" instead and remove the comma.\n. I think we'd also need to mention that PureComponent isn't exactly the same as pure-render-mixin, as it also affects the behavior of functional children. See https://github.com/facebook/react/pull/6914 for @spicyj's overview of what it does\n. \"ES6 class syntax\" sounds weird to me, but I don't feel strongly either way \n. Flow kept giving me a warning about $$typeof if I didn't mark it as optional. I think it might be because we're using Object.defineProperty?\n. These methods are inherited from ReactMultiChild. Is there a way tell flow that this class inherits from ReactMultiChild using the current method of calling Object.assign on the prototype? ReactMultiChild isn't typed yet, though.\n. Yupp, of course \ud83d\udc4d \n. Can we also add a test verifying we get a warning when passing in a valid aria- attribute with invalid casing? \n. It shouldn't be AFAIK, it's still extending the same methods. They just exist on a class now instead of an object.\n. Since we're using injectDOMPropertyConfig these aria- properties should be populated in DOMProperty.getPossibleStandardName. ReactDOMUnknownPropertyHook uses that to make a recommendation when warning for improperly cased props.\nCan you do the same in ReactDOMInvalidARIAHook? That way if someone passes down aria-hasPopup it will ask if they meant aria-haspopup.\n. Thanks for explaining that, in that case it looks like this would be a breaking change. I can open PRs in RN and ART to update their use of MultiChild. Though I don't see and use of ReactMultiChild in RN\n. Will this affect releasing https://github.com/facebook/react/pull/7649 in a minor release?\n. This fixes flow errors introduced by #7649, so I was just wondering if we'd cut a release that contained some flow errors.\n. The issue was that flow didn't understand that ReactTestComponent was inheriting mountChildren and updateChildren from ReactMultiChild with Object.assign. \nOne way around that is what I did initially, which is just add annotations for those methods on ReactTestComponent directly. A suppression would work too. I'd be happy to revert the class conversion and fix the flow error somehow else.\n. I fear that people might interpret this to mean that Enzyme is a utility specifically for Jest\n. I'm not sure, maybe add something to make it clear that it enzyme can be used with other testing libraries. Something like:\n\nIf you're deciding on a unit testing utility to use together with Jest, or another testing library, it's worth checking out\n. Can you also include classes here, as @syranide mentioned\n. It became really what?! \ud83d\ude04 \n. Small nit: can you drop the word \"Custom\"? \n. Array.map was part of ES5, not ES6\n. It is slightly misleading to say that only complex data would benefit from unique identifiers as keys. If the order of the items could possibly change in any way, using the index as the key would be a bad idea.\n. I think \"arrow function\" is more commonly used than \"fat arrow function\"\n. Could you tie this back into the previous example with <Person/>? The markup is close to what that example would render, and I think it would be clearer.\n\nIn the <Person/> example you can just update the key to use person.name and update the text in the <li/> node here.\n. It's not clear how a component being stateful has any relation to keys. \n. Missing back tick after <Header />\n. It might be useful to first explain that {} lets you inline any JavaScript statement within JSX. This kind of implies that {} is used specifically for rendering collections of components.\n. Can you return 'an array' so that the error message sounds less awkward?\n. > In this code, shouldComponentUpdate is just doing a shallow comparison between the old props and state, and the new props and state.\nWhat code is this referring to? The example above doesn't do a shallow comparison and the example below uses React.PureComponent which is introduced at the end of the paragraph.\nI read that sentence and immediately looked for the code it was referring to and got confused. I would either:\n- Rephrase this so it doesn't sound like its referring to either code snippet. Something like...\n\n\"You can use shallow comparsion between the old props and state...\"\n- Add an example that's doing shallow comparison manually\n. To me \"shallow comparison between the old props and state, and the new props and state\" would refer to something like shallowCompare(this, nextProps, nextState). That's consistent with what PureComponent does. \n\nYour example is not shallowly comparing props/nextProps and state/nextState, it's using reference inequalities for two specific values.\n. This is a little confusing, how does it give a child component control over rendering? If anything it gives the parent component more control by allowing render behavior to be specified via props.\n. Sounds good, I wasn't totally sure if there were situations where setting textContent to an empty string was valid.\n. This is false in IE11 when placeholder has been set on a text area. There's a bug (linked in the comment above) where setting placeholder also sets textContent.\nThe bug report specifically mentions innerHTML and innerText, but it also effects textContent\n. Why did you change this logic here? We shouldn't change implementation logic unless there's a good reason to do it. We also don't want to include changes like this alongside stylistic changes like flowtype annotations, as it would make it hard to revert just this change if we needed to.\n. We need to add the header document comment here like the other files (example). \nWithout the @providesModule comment the haste module system doesn't know where to find this file and tests fail.\n. Looks like ClassComponent isn't used anywhere?\n. @gaearon not sure how to address this, but in receiveComponent the transaction is not pulled from the pool with the test options like it is during the initial mount. This means this fails since options ends up being true instead of the options object we'd want.\nInjection makes this kind of a hard case, so I'm wondering what you think we can do here. It seems like we'd have to either attach the test options to the instance and access it there or do more injection, but both of those sound less than ideal.\n. Can you put this under the \"Upcoming Conferences\" section at the top of the file? Thanks! \ud83d\ude04 \n. Yupp, I'll go ahead and do that as well \ud83d\udc4d \n. Can we add a linting rule for this? hard to remember if lint doesn't complain.\n. A linting rule for this would also be great.\n. This was because of flow, _hostContainerInfo is typed as null | Object, which is valid since it is null when the instance is created. The _hostContainerInfo isn't populated until the instance mounts.\nWhile it never should be null when this method is called, flow doesn't know that. getPublicInstance is also typed as returning an Object. That's easy to change though if you want to do null | Object.\n. True, it should always be populated here.\n. Can we specify that this is IE11, since IE9 and IE10 are still supported by React.\n. I'm not sure how useful this warning would really be, it doesn't give you any information about what was mutated or where it happened. I know that providing those details would make this more difficult, but I don't think it provides a whole lot of benefit for the cost as it stands.. I don't think this approach is the right way to implement this. The reconciler shouldn't be aware of the current renderer. If this were to be added to React it should be contained within ReactShallowRenderer.. We need to make sure this is invoked when the input is blurred, and add a test if possible.. Does this test fail if you revert the changes in ReactErrorUtils?. It would be nice if unpkg or npm had a small API to get this information, but it doesn't look like they do. The easiest way may be to just manually keep it up to date as part of the release process. It would be nice to have something like CHANGELOG but in JSON.. Maybe it would be nice to also add the export warning for undefined, since trying to import a named export that doesn't exist will return undefined and I think that's probably a common mistake too. Especially when using third party libraries.. Won't this cause us to set the value attribute every time the input is blurred, even if the value hasn't changed? . Hmm, I wonder why this was dev-only in the first place? . \"Latinx\" actually the correct term, see the code2040 site. It's a general-nuetral alternative to \"Latino\".. Would it make sense for this to live in ReactFiberUpdateQueue like it does in stack with ReactUpdateQueue?. Even if they're not direct equivalents, if validateCallback is meant to validate a callback specifically for enqueued callbacks it would make sense for it to live alongside the rest of the queue logic. Not a big deal though.\n. Yes, please remove this, we explicitly made sure to check this in https://github.com/facebook/react/pull/7957. @acdlite does this add any value here? . Small typo!\n\nuntilt he \n. @acdlite renderSubtreeIntoContainer already calls validateContainer, can this duplicate call be removed?. This got deleted when I merged, I'll make sure to add it back. What should we call it? react-fixtures?. We need to figure out the best way to get a copy of the local react and react-dom builds.  The relative path was not working out of the box, so I ended up just copying the files from build manually. Maybe we should make that part of the build process, or do it before the start script for this app?\n\nIf you're testing locally, make sure to copy those files into here for now!. Are we all OK with shipping this with a fetch polyfill so we can use this ^?. Question got hidden as \"outdated\", but its not: https://github.com/facebook/react/pull/8589#discussion_r94507090. Yeah, probably. The way I do it with version is to just pass it from the window.location and update window.location.search when it changes, forcing it to reload (since we need a full reload on version change).\nI did the same thing here, but I guess we don't need a full reload on fixture change? . Yeah, I already feel unsure about setting window.location properties directly, does that consistently cause a refresh in all supported browsers? If we don't need to do it then \ud83d\udc4d on avoid it . I like that it lets readers jump directly into the appropriate section based on what they want to do, so they don't have to read the (albeit short) sections that are irrelevant to them.. Can we make the Babel link HTTPS too?. @bvaughn but renderSubtreeIntoContainer is only called if container._reactRootContainer exists, so it wouldn't actually throw, it would just be a no-op.. I couldn't find an equivalent guide on production builds on the 1.x site, so I just linked to the docs for each plugin instead.. My only worry with that is users clicking to the other linked doc pages from that tutorial and not really realizing they're potentially getting bad information.\nWe could mention that this article is on the Webpack 2 doc site after linking to it? Something like:\n\nThis guide works with Webpack 1.x and 2, but is hosted on the new Webpack 2 site. If you're not using the Webpack 2 beta, refer to the Webpack 1.x website for all other documentation.\n\nOtherwise, I can just revert it back \ud83d\udc4d \n. @nhunzaker can we check node.value here too and see if its \"0.0\"? Since 0.0 === 0 I think we're going to need to rely on checking the raw node value since its stringified.. @gaearon looks like webpack requires resolve.root to be absolute, had to make this change for the webpack packaging fixtures to build. We should use warning to remain consistent with the rest of the codebase. I think there's other reasons we use warning specifically, not sure offhand what they are. Since this is unconditional you would just do:\njs\nwarning(false, \"message\")\nBut we'd likely want to dedupe this error message if accepted. See how the React.__spread warning handles it below.. @rauchg ah, you're right. good catch, I missed that it was in a function.. Can you add an assertion on the content of the warning? It's not a big deal, but I like to make sure the tests are checking for the correct warning, not just any warning.. Can you change to \"\"ReactJS Day 2017\" to be consistent with their site?. I considered adding some messaging here about mixins being considered harmful, but I'm not sure if that's overstepping since they're not actually considered deprecated.. Fixed!. Right now the fixtures can be tested with (almost) every version of React published. If we use functional components then it will break with versions <14.\nIt's probably safest to just use class components everywhere, but we can discuss limiting which versions we really need to support (probably not many). I think we're fine with only offering fixture tests for 0.13+, so we should probably convert all fixture components to use ES6 classes.. Maybe we can give the fixture test case a slight but noticeable green border when its checked off? That way it's very easy to scroll through quickly and see which tests you haven't done.. For React and ReactDOM they should just be globally available. If we import it then we're only getting the current version that create-react-app installed. The react-loader script will load the selected version from a CDN.. Maybe it would be helpful to also add resolvedIn and resolvedBy so we could give more details\njsx\n<TestCase title=\"foo\" resolvedIn=\"15.2.0\" resolvedBy=\"#1760\" />\nThen it could say:\n\nThis test case was fixed in version 15.2.0 by #1760. This test is not expected to pass for the selected\nversion, and that's ok!. @zemlanin would you be able to verify that there are no significant performance regressions in DEV with this change?\n. Can you add tests for other types, like an array, number, and boolean? We should also add a test verifying it doesn't warn when using an object with a custom toString implementation.. Misc events is probably fine for now. . Maybe it's too pedantic to matter, but technically only transpilers, a subset of compilers, take source code and return source code. Maybe we can clarify this, something like:\nA JavaScript transpiler is a compiler that takes JavaScript code, transforms it, and returns JavaScript code in a different format.. Lets just use \"and\" instead of \"&\" throughout the doc.. Also, missing period at the end.. Missing period at the end.. > When JSX gets compiled, the result is JavaScript objects called \"elements\".\n\nJSX doesn't get compiled directly to objects. It is typically compiled to function calls that return those objects. In React its compiled to React.createElement calls.. It might be helpful to clarify that we use the JavaScript API naming conventions specifically. . Missing space after third sentence.. For function components, it would just be props.children, since you access it on the passed parameter and not this . Refs can be functions or strings (string refs are pretty-much-legacy but still allowed). Also, missing a period at the end.. Let's link to the reconcilliation doc page here: https://facebook.github.io/react/docs/reconciliation.html. Yeah its kind of a tricky topic. A compiler is a general term for any program that takes source code in, and outputs some other representation of that code. Usually, compilers will compile code from a source language (like JavaScript) to a lower level target language (like machine code).\nA transpiler is a special kind of compiler that takes in one type of source code and outputs another type of source code. So babel is a transpiler since it takes in JavaScript and outputs JavaScript. Yeah we should probably update that section as its misleading. You can see here that JSX gets compiled to React.createElement calls that return objects called \"elements\".\n\nDoes that feel like a better description?\n\nThat definitely sounds better \ud83d\udc4d . > A component's state is a snapshot of the data contained in a component.\nI'm worried this might sound misleading; someone might think state is a periodical snapshot of the props passed in or something. Maybe rephrase to something like:\n\nState is a way for components to manage data that is private and fully controlled by that component.\n\nThat's also closer to what we say in the linked docs page.\n\nstate is user-defined, props are received from a parent component.\n\nprops are technically user-defined too, just defined in another component \ud83d\ude04 It may be more accurate to say:\n\nstate is owned and controlled by the component that created it. props are received from a parent component.. > A \"key\" is a special string attribute you need to include when creating lists of elements.\n\nI don't think there's any specific restriction that says a key has to be a string. It's the most common thing to use, but you could also use numbers, or even objects.. Historically we've avoided adding/using test-renderer specific APIs to ReactCompositeComponent (reference: https://github.com/facebook/react/pull/7649#r78279440) Could we derive this tree from the instance inside the stack test renderer like you did with Fiber?\nMaybe it could be abstracted into a module like ReactInstanceToTree or something like that?. We'll want to use the invariant module for error handling to remain consistent.\nYou can just do invariant(false, '[message]'). ReactNodeTypes returns an integer representing the type, but in the spec we define nodeType as a string. Should we update the spec and standardize the numbering, e.g., 0 always refers to a host node?. Can you swap the last sentence with the one before it? So that the last thing in the paragraph is the \"Finally\" step.. Yupp, I just removed it. It also caused problems when changing versions as it checks query.version === 'local'. \"on every value change\" might be misleading, since onChange is not called if the value is updated programmatically.. Maybe rephrase as \"whenever the value is updated in the input\" or something. It's more verbose but might be clearer. Let's rephrase this to:\n\nTo create an optimized product build with Brunch, just add the -p flag to the build command. See the Brunch docs for more details.. Lets rephrase to:\nFor Brunch, you need to add the -p flag to the build command.. I don't think we need to include node types that we don't use at all, especially ones that are no longer in the DOM spec.. Maybe we could destructure here so we don't have to do property access everytime we check a nodeType?\n\njs\nvar {\n ELEMENT_NODE,\n DOCUMENT_TYPE_NODE,\n DOCUMENT_FRAGMENT_NODE\n} = require('HTMLNodeType');. The __DEV__ check should also be in a separate, wrapping if block so that it can be properly removed via dead code elimination.\n``js\nif (__DEV__) {\n  // UseObject.defineProperty` to define setter\n}\n. Correct, we do not need to explicitly support IE8 anymore.. Can we just use the element that was already created above (stored in the el variable)?\nIf there's some reason we need to create another element here, we should use ownerDocument instead of document to create the element.. Can you please undo all the spacing changes made to this file?. Why are we declaring this as a global in each file?. Seems fine, but cc @gaearon do we want to enforce this?. Can you please remove them and verify npm run lint passes? I tested locally with the existing comments on master and it seems to lint fine. I don't think our usage of hasOwnProperty requires this to be defined as global with eslint.. Isn't the check there to see if you can use Object.defineProperty though?. Uglify should be able to eliminate it just fine even if it's defined in DEV block. I'm not sure we should add the warning if it's not consistent. Users could still mess up inside an svg tag and they wouldn't get any warnings, which is extra confusing since they would get warnings anywhere else. @spicyj what do you think?. I see @gaearon did mention previously he'd be OK with that. As long as you only access addUpdaterMutationWarn inside a __DEV__ block it should work fine. For example, in ReactFiberClassComponent you can see that startPhaseTimer is defined in a __DEV__ block and only accessed in other __DEV__ blocks.. There were apparently some other reasons for setting the value attribute that weren't fully explained, see https://github.com/facebook/react/pull/7359#issuecomment-244768124. Maybe @jimfb or @spicyj have some historical insight that would be useful?. We also need to be clear that form.reset is totally fine when the form contains only uncontrolled inputs. If we did go the route of warning it should only warn if the form contains one or more controlled inputs.. We can probably get away with removing UI here\n\ntrigger updates in response to event handlers, server responses, etc.... >  building a nextState\n\nMaybe change to\n\nbuild a new state object\n\nAs it's unclear what nextState is if you're not already familiar with setState callback signature. Can we use an object literal instead so it's a little more familiar? Maybe use the same example above that updates myInteger \njs\nsetState({ myInteger: this.state.myInteger  + this.props.step })\nThat could also serve as an example of a situation where the setState callback is preferred, as this.state.myInteger may not be totally up-to-date.. This part feels a little too opaque for beginners \n\nIf mutable objects are being used and conditional rendering logic cannot be implemented in shouldComponentUpdate()\n\nWhat does conditional rendering logic have to do with shouldComponentUpdate and setState?\n\ncalling setState() only when the new state differs from the previous state will avoid unnecessary re-renders.\n\nDon't you only get the new state by calling setState in the first place? I get what you mean, but it's slightly ambiguous.\n. Ah, the diff made it look like you did. It would be nice to simplify this here or in another PR \ud83d\udc4d . I feel like numbering it makes it seem like these are two steps to Creating a Single Page Application, which makes it less clear what these instructions are saying \ud83e\udd14 . Can you reword it to:\n\nIt also assumes an understanding of the differences between React components, their instances, and elements\n\nSo it's more stylistically consistent with the rest of the content? Thanks!. This should be PropTypes.array. Should we just import element since it's the only PropType in the example?. What's the advantage of having a fixture for this? Wouldn't this be well covered by the unit test?. Why not just use JSX instead of directly calling React.createElement?. To make this a little clearer, let's rephrase to:\n\nThis means that when the square is clicked it calls the onClick function that was passed by the parent. The onClick prop here is part of React's synthetic event system, which will call the function passed in when a click event is dispatched on the button. . Let's add a little more context to this first sentence as well:\nAll of React's event handler props start with on, for example, onClick and onFocus. It's a common pattern to name the functions passed to those props starting with handle, such as handleCick for onClick or handleFocus for onFocus. It's a useful pattern for being consistent with how event handlers are defined, but it's not required.\n\nIt's a little more verbose, but I think the inline example and clarification that it's not required are useful.. I wasn't aware whitespace was meaningful in that context easier, thanks @gaearon. I almost removed it when I rebased for @davidblurton, but it wasn't clear if this should be excluded. There is a test that relies on testing the new error (and error code) in ReactDOMProduction, won't that test potentially fail if codes.json isn't updated now since the code will potentially change?. Oh I see now, it's not testing this specific invariant it's just testing any production invariant. That makes sense, we should definitely change it.. What's the policy for committing changes to results.json? It would be weird if branch was always just the name of the last branch merged into master.. I wonder if there's a way we could do this without having to create a new function for every child? What if parentType was passed to validateExplicitKey and it was called from there instead?\nIf not, we should move this outside of the for loop so the function is created once per call.. Same here. If we bind outside of the loop (maybe at the top of validateChildKeys) we can save some work. Maybe just return the string from the arrow function directly?\njs\nconst getMainExplicitKeyWarning = () => (\n 'Each child in an array or iterator should have a unique ' +\n '\"key\" prop.' +\n 'See https://fb.me/react-warning-keys for more information.';\n)\nThis could also be moved out of warnOnDuplicateKey  into it's own DEV block too. So should we be asking contributors to include this in PRs that make changes to code included in bundles? If so I can add it to our PR template for now.. Let's use JSX here so it's consistent with the other test.. Maybe we should instead use Object.defineProperty to define getters for each method, so we don't have to rely on Proxy at all and split up the logic for these warnings.. We could simply it further by using a for ... in loop over ReactDOMFactories!\njs\nif (__DEV__) {\n  var warnedForFactories = false;\n  for (var factory in ReactDOMFactories) {\n    React.DOM[factory] = function(...args) {\n      if (!warnedForFactories) {\n        warning(\n          false,\n          'Accessing factories like React.DOM.%s has been deprecated ' +\n          'and will be removed in the future. Use the ' +\n          'react-addons-dom-factories package instead.',\n          factory\n        )\n        warnedForFactories = true;\n      }\n      return ReactDOMFactories[factory](...args);\n    }\n  }\n}. Thanks for clarifying! Your comment above had it as lowercase so I thought it was fine, but I'll make note of this from now on.. This change worries me. This would be breaking behavior since we currently just stringify false and this would potentially change runtime behavior. I think we should leave this specific part as-is, where null is used to identify attributes that should be removed.. I don't think this is the correct place to do this type of validation. We currently warn if defaultProps is an instance property in ReactFiberClassComponent. We should take a similar approach here.. Are there any other enumerated attributes like that which use stringified booleans? I would hate to special case them, but I also think it's reasonable to ask users to provide the expected stringified values themselves, e.g., spellcheck=\"true\". We could have dev-only warnings for that maybe.\n. Also, using \"true\" and \"false\" but not making it a boolean attribute seems like a really confusing decision \ud83e\udd14 . Instead of including the specific copy of the warning, maybe it would be better to focus on explaining how to handle empty values. Something like:\n\nYou should use an empty string to represent an empty controlled input. Setting a controlled input's value to null, or undefined will cause React to assume the component is no longer controlled and may produce a warning.. I see where the confusion is coming from, but I think this is also missing the point that's it's trying to communicate. When it says \nwe can safely assume that x has changed.\n\nIt means we know the value that x was holding, which was updated and stored in a new reference y, has changed because the reference equality check returned false. \nWe should clarify this point better. I suggest something like:\n\nIn this case, since a new reference is returned when mutating x we can use a reference equality check (x === y) to verify that the new value stored in y is different than the original value stored in x. \n\nIt might also be useful to demonstrate that updating a record with the same value results in a passing equality check:\njs\nconst y = x.set('foo', 'bar')\nx === y // true\n. This should be \"controlsList\" right?. I'm worried this might be too specific since the original sentence covered immutable data in props and context as well.. >  The HTML output by this stream should be character-for-character equivalent to the output...\nPhrasing is a little awkward, could we convey the same idea without \"character-for-character\" and \"should\"?\n\nThe HTML output by this stream will be exactly equal to what ReactDOMServer.renderToString would return.\n. ReactDOMServer.renderToString link should also be inside backticks. Any specific reason we're destructing in these constructors? It doesn't look like highWaterMark is used here, so maybe we can just do:\n\n``js\nconstructor(element, makeStaticMarkup, options = {}) {\n   super(options);\n   // ...\n}. It looks likesrcObjectshould be set as a property on the element, not as an attribute. We should useMUST_USE_PROPERTYinstead of0` here to force React to set it as a property on the element.. The difference is between:\njs\nvideo.setAttribute('srcObject', stream)\nand\njs\nvideo.srcObject = stream\nSince stream is likely an instance of MediaStream, setting it as an attribute wouldn't work since it would coerce it to a string\nhtml\n<video srcobject=\"[object MediaStream]\"></video>. @Aprillion I do get that, and it makes sense from that perspective, but these docs are primarily accessed as a primary source for users learning/using React. I think including the warning might serve to confuse the majority of users who aren't coming from the link in the warning.\nWe could potentially make the warning itself clearer if there's some specific ambiguity you think we could clarify.. Missing space before the bracket. Missing space after the comma in the replace argument list. Can we put this input on a new line to keep the line width reasonable?. This may not be relevant to this fixture, but by trimming these date strings we're changing the actual value of the date. For example:\njs\nnew Date(\"2017-07-12T14:28:58.590Z\")\n// Wed Jul 12 2017 09:28:58 GMT-0500 (CDT)\nnew Date(\"2017-07-12T14:28:58\")\n// Wed Jul 12 2017 14:28:58 GMT-0500 (CDT)\nSo if you try to actually change the date here, the values kind of jump around. This might be acceptable if we're just looking to test the switch from date to datetime-local, but it might be confusing for a new contributor going through the test fixtures.. I was planning on Prettier to the DOM fixtures after this \ud83d\ude04 . This is the actual config change. https://github.com/facebook/react/pull/10157\n. @jquense testing locally, I'm seeing that updateValueIfChanged is being called with both a Fiber as well as a DOM node. For example, for our fixture that tests onChange events with radio inputs it's called with:\n\nThe Fiber for the radio input that's being selected\nThe DOM node for the radio input that's being unselected\nThe DOM node for the radio input that's being selected\n. Also, isn't this check backward? This logic means that if subject is a Fiber or if subject is a DOM node, we're passing subject.stateNode to trackNode.\n\nWon't subject.stateNode be undefined for DOM nodes?. For reference, updateValueIfChanged is called with a Fiber instance because of getTargetInstForClickEvent ChangeEventPlugin.js#L217-L221. edit: yeah, that ^\n@jquense but in this case you're always passing subject.stateNode to trackNode. If subject is a DOM node (which the isNode check allows) subject.stateNode will be undefined.\nI think we should do inputValueTracking.trackNode((subject: any)) if isNode is true, right?\n. It does, yeah. See ReactDOMComponentTree.js#L190-L194. Is this just a stylistic change or does this affect the semantics at all?. @gaearon I think it's fine, getValueFromNode is just used to compare next and last values, both of which are returned from getValueFromNode. So the equality check should still hold.. We're already importing the emptyFunction library in ReactChildren, could use just use emptyFunction.thatReturnsNull and get rid of this?. It's because of the branch that @nhunzaker linked in the OP. getValueForProperty isn't currently being called in diffHydratedProperties for custom attributes. Instead it's using getValueForAttribute.. Is this true? I tested this build out in IE9 on Windows 7 and it wasn't dispatching change events for deletion. But I also tested out master and I saw the same problem. Are you seeing something different?. Does getActiveElement not return the correct node for getting the instance from getInstanceFromNode?. Fiber currently requires it, I think this way is fine.. Do you think using babel-polyfill will be problematic at all? It might make it easy to miss changes that won't work in all our supported browsers by default. . If getTargetInstForInputEventPolyfill is only used in a browser (IE9) that doesn't support the input event, does it make sense to check for topInput?. Yeah, I like that with requestAnimationFrame we have an invariant so it fails early. I feel like we should do the same with other stuff like Set or Map if we have a hard requirement on those without fallbacks.. OK cool, got it. For some reason, I was thinking IE9 didn't fire input events \ud83d\ude04  . @jquense can we use targetNode as nativeEventTarget for selection events in IE9? When you start backspacing it registers a change event but it gets undefined for event.target.value since event.target is still the document.. If we use this same check to branch when calling createAndAccumulateChangeEvent it should fix input backspacing in IE9 (tested locally).\njs\nvar event = createAndAccumulateChangeEvent(\n  inst,\n  nativeEvent,\n  (!isTextInputEventSupported && topLevelType === 'topSelectionChange')\n     ? targetNode\n      : nativeEventTarget,\n);\nWe can dedupe that check with a constant, but yeah. I think that should be work?\n. If we're assuming all supported browsers will support mouseenter events, do we need the isEventSupported check?. This makes the type object polymorphic which could hurt performance a bit. We may want to define these fields on type with null values to avoid creating multiple hidden classes.. topLevelTypes is imported in ReactBrowserEventEmitter, see: https://github.com/facebook/react/blob/master/src/renderers/dom/shared/ReactBrowserEventEmitter.js#L19. Duplicate comment?. >The regex bench has to compile the regex every time.\nHere's an ESBench which lets you define setup code, and it also shows that the slice is much faster.. Why do we coerce objects just for boolean values?. Can we dedupe this equality check with a constant towards the top of the 'object' case?. I'm not a big fan of this copy, I'm open to suggestions \ud83d\ude04 . Let's keep higher-order component lowercased to stay consistent with the rest of the docs.. I agree it's a little dense, can you clarify what you mean by switching early to see if it's controlled?  As far as I can tell, updateOptions only branches on multiple and doesn't really care if it's controlled or not.. This warning isn't included in stack since it fails early. Done in https://github.com/facebook/react/pull/10453/commits/c377e352ce33f233cc66aa76ead517f504c79f73. > Usually you don't need to set it explicitly because it's inferred from the function or class name that creates the component.\nCan you rephrase this to:\n\nUsually, you don't need to set it explicitly because it's inferred from the name of the function or class that defines the component.. > I think our logic was that if we filter out booleans for unknown props, then we would also consider changing that behavior for known attributes, and that would create more work to get this landed as well as more API changes for users.\n\nI'm not sure I see how that follows. For known attributes, we know if they're boolean attributes or not beforehand. For unknown attributes, I think it makes sense to treat them as boolean attributes if they're passed boolean values (set with node.setAttribute(attributeName, '')). If the attribute expects a stringified boolean I think it's reasonable to require users to pass a stringified boolean.. Can't we just maintain a whitelist of known enumerable attributes expecting boolean strings (a pretty small subset) and assume any unknown attribute with a boolean value is a boolean attribute?. Why does it warn about being non-boolean for unknown attributes? It seems like we don't know whether an unknown attribute is actually a boolean attribute or not, so this could lead to false positives.. In what way is the behavior the same? Known boolean attributes will not warn because of the propertyInfo checks. I'm not sure I understand why we assume unknown attributes being passed booleans are not boolean attributes.. So how can a user correctly use a boolean attribute that we don't have whitelisted?\nI don't think behavior changes in previously-known attributes implies implementation details are leaked; it just means attributes behavior has changed. Which is why this is part of a major release. Why not instead utilize warnings in this major release that would allow us to treat any unknown attribute with boolean values as a boolean attribute in the next?\n\nOf course that means we can never delete booleans from the whitelist. But that seems like a fair tradeoff.\n\nI don't agree that having to maintain a boolean whitelist forever is a fair tradeoff, it introduces the same issues we had with the whitelist in the first place, just with a smaller subset of attributes.\n . > I think we might be talking past each other.\nThat's totally possible \ud83d\ude04 \n\nBy casting it to a boolean.\n\nI'm not sure what you mean, I'm talking about attributes that should already be accepting booleans. With this PR, if I try and render:\njsx\n<div bool-attr={true} />\nIt will warn and it will not set bool-attr. Assuming bool-attr is some valid boolean attribute that we just don't have whitelisted, this behavior is wrong. It is a boolean attribute and it should be set/unset with true/false. Casting to strings, in this case, would also be wrong because <div bool-attr=\"false\" /> is not the behavior the user would want.\n\nI don\u2019t understand what you mean. Can you elaborate on what you propose instead? I think we might be talking past each other.\n\nSo using src as an example, I'm assuming the problem we're worried about is that <img src={true} /> would be a problem since it's no longer whitelisted and it would be incorrectly treated as a boolean attribute. I'm suggesting that we accept this change, but add some warnings when previously-known attributes are passed invalid values.\nSo if you did <img src={true} /> it would warn with something like:\n\nThe src attribute expects a string but received a boolean true. This will cause React to treat it as a boolean attribute, which is likely a mistake. If you intend to use a stringified boolean value, make sure to stringify it beforehand.\n\nThis might involve keeping a DEV-only whitelist if we just warned, or adding the whitelist back for just the next major to warn + maintain behavior, but IMO it would provide us with a better long-term solution for 17+\n. That's fair, I figured there's likely some internal context that I'm missing. If everyone is OK with forever maintaining the whitelist then my proposal is moot \ud83d\ude04 As long as custom elements can correctly define arbitrary boolean attributes.\n. It's easy enough for static attribute values but once you have to start dynamically setting and unsetting boolean attributes you have to start switching between \"\" and null and remember those map to true and false, which is unfortunate.. In my mind the goal is to reduce that inconsistency, which we maintain by coercing booleans to \"true\" or \"on\". In the long-term I think it makes sense to require users to be explicit about those enumerated attributes that expect boolean-ish values, and that's something we can add warnings for.\n\nIn theory we could make the default behavior be whatever has the most attributes following that rule. Do we know for sure which that is?\n\nLooking at this attribute table in the spec it seems clear that there are far more boolean attributes than there are attributes that accept \"true\"/\"false\" or \"on\"/\"off\". How does Fiber handle removing those listeners on unmount? Does it just not do that anymore?. Would it make sense to throw if element is falsy? I don't think there's any current code path where trapBubbledEvent or trapCaptureEvent should be called without a node.. @gaearon what throws immediately? If this is protected from null elements earlier in the code path could we just remove the falsy check?. Should we use a switch case here if there's only two possible return values? We could shave a off few more bytes with a ternary or if/else. I wonder if it would minify better if we used constants instead of string literals?. Why is style being special-cased here now?. Doesn't this change the semantics of how unknown attributes are handled since the propertInfo check is removed? Now unknown attributes aren't being handled by setValueForAttribute so they aren't validated by isAttributeNameSafe, which means that invalid attributes will now cause a fatal error, e.g\nFailed to execute 'setAttribute' on 'Element': 'foo$$bar' is not a valid attribute name. . @gaearon I agree it's confusing, I wouldn't think that setValueForProperty would be setting attributes. I pushed a commit to this branch with a failing test.. But in what case will shouldSetAttribute be called for the style prop? From what I can tell ReactDOMFiberComponent always checks for the style prop early and defers to CSSPropertyOperations. I don't think we're explicitly setting the style attribute anywhere.. Is it the SSR code path? I didn't check that \ud83d\ude00\nedit: I checked and, as expected, it isn't called for SSR either @gaearon. I think as a rule of thumb, if you have an API like setValueForProperty it shouldn't ever hit a code path that sets it as an attribute, and vice-versa. It's confusing that there's code like node[name] = value inside shouldSetAttribute checks. From what I can tell, the naming scheme is confusing two different types of properties: what we just call \"props\" and properties that we need to be set as a property (what shouldUseProperty checks).. We could just not pass the second argument at all since it will default to undefined anyways, but I would prefer null here as well. It's also shorter \ud83d\ude04 . > Really, I think if we stop syncing the value attribute with the value property, we can just drop mutation methods all together.\nI wonder if we could just inline the getMutationMethod calls as well, since there's only one property that uses mutation methods. Like:\njs\nif (name === \"value\") {\n  setDOMValueAttribute(node, null)\n}. Why did these change? Was it just outdated or something?. fit :). @gaearon this is causing the fixtures to fail in browsers that don't have customElements. We should either provide a polyfill or only run this fixture in browsers that support the custom element registry.. > Ostensibly defaultValue is set once for inputs and changing it after that is a noop for the life of the component.\nThat isn't the case, as far as I've seen. Here's an example that you can update defaultValue and a form reset will reset to the new defaultValue option. That happens in ReactDOMFiberInput.updateWrapper here. In both cases, updating .defaultValue is guarded by a loose null check for value first, so I think it should be consistent?\n. According to MDN, code isn't widely supported. Is there a way to cheaply polyfill this for those browsers?. This would only happen when switching from a controlled to uncontrolled component right? Since we're not removing the attribute anymore could this break anybody?. I know this is consistent with the rest of the warnings, but I wonder if we should just inline noSetStatesFromProps and avoid the whole negation thing?\njs\nwarning(\n  instance.state !== instance.props,\n  `...`\n). Have you verified that the browsers that support window.event define it as a writable property?. It might be good to test in IE9 and IE10 as well if they support it.\nDoes this get properly reset after the event dispatch is complete? We need to be sure that window.event doesn't start persisting, since it should only be defined while an event is in progress.. Right, it warns and it will also remove the attribute. With this change, I believe it will warn but the attribute will not be removed.. Typically we do warning(false,  \"\") when we also need to execute some other code when issuing the warning, such as setting a flag so that the warning is deduped.. Could this just be inlined in DOMPropertyOperations? Doesn't look like it's used anywhere else. Also, we could then just do check the set directly instead of a function call too.. @gaearon at this point it looks like there aren't any properties that contain more than one flag. We could probably stop using bitmasks and just use an enum, remove checkMask and use a single property in propertyInfo instead of 6.. Not a blocker, but it might be worth using a method specific to value since shouldSetAttribute does a few unnecessary checks in this case. It might also call shouldAttributeAcceptBooleanValue which also does more work than needed\nI don't think this is a really hot path, so it's probably fine the way it is, but just worth noting.. I bet in the long-term checking set membership will be faster, since that's the sole purpose of the data structure. If we're still getting 25 million ops/s with a set it's probably fine to use it since its the correct data structure for this.. If it's a non-trivial performance regression we should definitely consider changing it. It's just so nice using Set and Map instead of arrays and objects \ud83d\ude0d . \"performs a state change\". Can we update this so it's only disabling the coercion rule?. Before this change the 0/ \"\" coercion would occur for any type of input. Now it only applies to number inputs. Any chance that breaks something weird?. Why alias name to attributeName?. Can you rename this test since deleteValueForProperty doesn't exist anymore?. Did you mean if the prop is not in the special list?. All attributes that must use property are boolean values, so technically this check is unnecessary. We could add a new attribute type like HAS_BOOLEAN_PROPERTY to simplify this, and get rid of the bitmasks again (happy to do in a follow up). Using names of internal APIs that exist is different. In this case, it's referrencing a function that no longer exists. If I was looking to contribute and encountered that, I would be confused that the function didn't exist anywhere in the codebase.\nIt's not critical, but since you remove it feels like it's in scope to fix any lingering references. If we're going to restructure the tests soon anyways, it probably doesn't matter.. It was hard to find due to a couple project reorganizations nuking the file history, but this was removed in https://github.com/facebook/react/pull/10798. I think the most likely explanation is that the whole loop could have been removed as well, but it wasn't clear that it was stack-only.\nIt's a little confusing, but at first glance it seems safe to remove \ud83d\ude04 . Does it make sense to return null for invalid fiber types? Maybe it should throw if it's not a HostComponent or HostText? I'm not sure if there are any situations where this should be called with any other type of node.. Is there another place to perform DOM-specific effects when a portal is mounted?. trapBubbledEvent is kind of a confusing name now since it's attaching the listener directly to the event target in some cases.. If we do it in appendChildToContainer then we'll also be trapping click events on other containers, I guess that's fine?. @gaearon is using a comment node as a mount point supported for portals as well?. I guess if it already has onclick we don't need to trap click events, so I'll wrap this in a null check.. Yeah that's what I was doing :) my only hesitation is that trapClickOnNonInteractiveElement is also called on elements that React controls (which shouldn't have onclick making the check redundant in most cases).. Right now we do it regardless of the browser. There's an existing TODO for adding browser detection. It might be a good time to address that, assuming browser detection is fast/reliable enough.. We can remove all of these event name strings like 'load' if we have trapBubbledEvent/trapCaptureEvent call getRawEventName directly. Assuming we never call it with a mismatched top-level type and event. I don't think we do.. It might be worth extracting this into a function like isEventName so it minifies better.. It depends on how it affects bundle size. If we keep them and do something like https://github.com/facebook/react/pull/11894 then the event plugins can just use the numeric constants for dependencies/switching on events, which would probably compress better.. defaultView is defined as a getter, and since we don't expect it to change within setOffsets maybe we should store the value in a local variable so we avoid triggering the getter twice.\n. Why do we need to check if node exists? In what situation will node not be a DOM node?. Could you do it in ChangeEventPlugin instead?. For new test cases that are stateful, can you break it out into it's own component? See NumberInputExtraZeroes.js as an example.. Instead of defining an inline array, let's just add some additional cases to the boolean expression. \njs\n(\nnodeName === 'input' &&\n(elem.type === 'text' || elem.type === 'email' || elem.type === 'tel')\n). @cramaechi you're right that a data-reactroot attribute would be added, but it's only added to the root element. So if you render a component like:\njsx\nconst App = () => (\n  <div>\n   <h1>Hello</h1>\n  </div>\n)\nwith renderToString you'll get markup that looks like:\nhtml\n<div data-reactroot>\n <h1>Hello, world</h1>\n</div>\nYou'll see that the data-reactroot attribute only exists on the root element (the div) but not any of it's children (the h1 tag). The problem with with the approach you took here is that it will be potentially called with elements that aren't the root, so it will end up warning when it shouldn't. In this case, it might see the h1 tag doesn't have the data-reactroot attribute and warn even though it shouldn't.\nDoes that make sense? To implement this correctly you'll need to add a check that only runs on the root element passed to ReactDOM.hydrate. @cramaechi see my comment here for my recommendation: https://github.com/facebook/react/pull/12166#issuecomment-363562627. Why not just call clear on a single Set instance?. Right, I meant after forEach do inProgressContexts.clear() instead of nullifying it and creating a new instance each time.. What would be the advantage of a development build? There aren't any warnings or DEV-only checks as of now. I guess just providing a non-minified build in DEV is a fine enough reason?. It does assert that the callback is called, but this looks much better than hacking suppressErrorLogging \ud83d\udc4c . This is a DEV-only code path that won't be called frequently in most cases, so small performance tweaks aren't super important.. The validation in useRef.js is just a warning though, maybe use an invariant and throw early instead?. Is the intention to rely on the warning to explain the error that would occur here when renderProp isn't a function? I understand not throwing during creation, but an explicit error seems better to me.. I think it's missing an \"on\" before \"an unmounted component\"?. I think warning during creation is a good idea, but I also think there should be an explicit error with a component stack trace when updateUseRef inevitably throws.. I talked/tweeted with @sophiebits and I believe it's reasonable to ask people to polyfill in browsers that have bad native implementations. I opened https://github.com/reactjs/reactjs.org/pull/677 to update the docs for this.. Using \"Unknown\" as a proper noun feels kind of confusing, but I can't think of something better.. Maybe \"An unknown component uses...\"?. In what cases does React not know the name of a component? \"An unnamed component\" sounds better than \"Unknown\" to me \ud83d\udc4d. Maybe:\n\nThis is an inherent limitation of subscriptions in React: storing state outside of React's managed state queue and rendering in response to a change event is problematic with React's async rendering model.. Yeah, let's go ahead and go with mocking performance instead of actually taking too much time.. Yeah, @Swieckowski please revert this. We were intentionally not using toString. @Swieckowski please revert his back as well. . For consistency let's move this to the top of the file, and then only define it in DEV\n\n```js\nlet stringifyWithPerformanceWarning;\nif (DEV) {\n  stringifyWithPerformanceWarning = function(value) {\n   // ...\n  }\n}\n`. Please use'' + valueinstead oftoStringhere as well.. We want to useperformance.nowif it exists, and fallback toDate.nowif it doesn't. Lets do the same thing we do here: https://github.com/facebook/react/blob/master/packages/react-native-renderer/src/ReactNativeFrameScheduling.js#L12-L17. The messaging here isn't clear enough. Let's also pass the attribute name tostringifyWithPerformanceWarning, improve the wording, and also include a component stack. You can get a component stack by importing and usinggetCurrentFiberStackAddendumfromReactDebugCurrentFiber`.\nLets make it look like:\njs\nwarning(\n  stringifyEnd - stringifyStart <= 2,\n  'The attribute `%s` took more than 2 milliseconds to stringify. This usually means you provided a large object ' +\n  'as the value for a DOM attribute, which can lead to performance issues.%s',\n  attributeName,\n  getCurrentFiberStackAddendum(),\n). @acdlite I initially went with \"incompatible with React's async rendering model\", but I wasn't sure if it was too strong of a statement. If it isn't, I like it better.. Does this actually fix the undo behavior, or just stop it from throwing? Since we're not setting nodeValue I'd expect the behavior to still be broken, no?. I noticed recently that it's possible for Fibers to retain references to detached nodes. I wonder if this is potentially related? Does this issue occur in React 15.x?. We could just use a loose equality check here\njs\nelement != null. @gaearon didn't know that. We still have tons of places where we use loose equality checks.. @nicolevy I don't know, I'm not sure it's worth it? It could be helpful to make the changes and then somehow benchmark them. I'd also be interested in seeing a profile that shows the current deoptimizations and their impact as well. Making all the checks strict would increase the overall bundle size, so there are other costs to consider.. No need to wrap the \"quack\" key in brackets, just use double quotes\njsx\n<div key=\"quack\" />. @nicolevy you can find an example of what Dan means here: https://github.com/facebook/react/blob/master/packages/react/src/tests/ReactContextValidator-test.js#L182-L183. getStack would only ever be called in DEV, so we can pass getCurrentFiberStackAddendum to checkPropTypes directly and avoid the getStack variable altogether.. Just an idea: since we have to map the event types to the native event names anyways, I wonder if we can just use the event names as the event type constants? Then we could potentially remove the indirection of mapping event types to event names.\nI think we'd have to ensure that GCC didn't inline the strings, and I'm not sure if we can control that with current closure-compiler-js API.. If we're getting to the point where we have to introduce meta-programming to get around this IE11 Map issue, we should seriously consider requiring a polyfill in the next major release.. I think this should be modeled as a union of all the top level types. See shared/ReactTypeOfWork.js#L10 for an example. It's more verbose, but that's not a big deal here.. formatted should never be an arbitrary string, so cases like -2.abc aren't really a concern.. @gaearon for reference there's an existing PR https://github.com/facebook/react/pull/12764. This would make it impossible to intentionally set an empty value\njsx\n<input type=\"submit\" value=\"\" />\nWe'd need a more specific check like props.value === undefined. It should probably be moved into the hasOwnProperty check below, so we can avoid checking type if value doesn't exist at all.. Can you add a test for an intentionally empty value?. According to MDN:\n\nIE 9 does not fire an input event when the user deletes characters from an input (e.g. by pressing Backspace or Delete, or using the \"Cut\" operation).\n\nhttps://developer.mozilla.org/en-US/docs/Web/Events/input (footnote 2). Right, right I thought you were asking about input events with onInput, but you were probably talking about our polyfilled version :). If it's equal to 0 then it will still return 0 since that's the second expression in the ternary.. Checking for an Array isn't sufficient since React supports using iterables as children. Instead, can we invert the logic so that it checks for undefined?\njs\nconst optionChildren = props.children === undefined\n    ? props.children\n    : flattenOptionChildren(props.children)\nAlternatively we could just add that check to flattenOptionChildren directly. If children was null then the user must have explicitly rendered with null as a child. In that case we still want to throw because that counts as using children. We just want to handle the case where there are no children at all, so just checking undefined is sufficient.. I thought we threw for null. You're right, server logic should be the same.. Remind me again why we set defaultChecked twice, is it related to value detachment? It'd be great if we could add a comment here explaining the reasoning.. Yes, it fails with the same error if the test renderer is configured as primary. The Enzyme issue was just that one test rendered context with ReactDOM indirectly via mount, and then another test rendered the same context instance with the test renderer. So this should be the same scenario.. I reproduced the error with the steps in #13150 and verified the error no longer occurs with builds of react, react-dom, and react-test-renderer from this branch . Correct!. Correct!. > yield unexpected results\nnice pun \ud83d\ude04. Can we just shorten this and add a link to https://github.com/facebook/react/issues/12872 here for reference?\n\nAvoid setting value attribute on submit/reset inputs as it overrides the default value provided by the browser. See: https://github.com/facebook/react/issues/12872. set a value *on a submit input. I think a better name would be:\n\"should remove the value attribute on submit inputs when value is updated to undefined\". Can we also add a test here for mismatches for objects with toString?. Minor UX nit: this \"Why/Notes\" column is mostly empty. The few notes we have would likely be better as footnotes\n\n. We should really make sure all maintainers have access to a subscription. @sophiebits is there a way we can get a shared account for one of these services that external collaborators can also use?. Switching between pages is a little jarring with this.  Since we do full page reloads every time you select a new fixture it always flashes \"Awaiting fixture...\" before rendering. It might be better to just render null . Include error.message?. @philipp-spiess I reached out to BrowserStack about it awhile ago, and they require projects to include an endorsement/link in the README to get the free option. Which, at least at the time, wasn't something we were able to do.\nA team account would be great! We just need the Live functionality for manual testing.. > We want to tree it\n\ud83c\udf32. What is this status check guarding against? . A* lazy. > We want to tree it\ntreat it?. The test is failing at componentDidUpdate and getSnapshotBeforeUpdate (this.props), as they are coming back undefined.. The type and tag are overwritten, so my first thought was that the same should be done for pendingProps. ReactFiber just has a comment and prefixes the DEV only fields with _. \nYou could call it _debugType?. What about a top-level DEV-only variable like currentHookType. Set it to the expected type before calling createWorkInProgressHook and then read that in cloneHook and createHook? Then it doesn't have to be passed around and it would be more easily DCE'd for the prod build.. @threepointone with currentHookType you could also avoid passing hookType to createHook as well. I don't think GCC will remove unused function arguments%253B%250A%250A), so the HookType arguments won't get removed from the prod build even though they're unused\nIf you do:\njs\nif (__DEV__) {\n  currentHookType = RefHook\n}\nworkInProgressHook = createWorkInProgressHook();\nThen I believe it will get DCE'd in prod, adding no new bytes.. I think its safe to remove, a comment is probably better? Writing to a top-level variable is a pretty common pattern in the codebase, and new hook types are rare enough that a comment is probably a sufficient safeguard . This should now read from currentHookType right?. I wish we had some easy way to validate these JS engine assumptions, it\u2019d be interesting to see how often they\u2019re true \ud83e\udd14. This test is failing saying Expected test not to call console.error(), but I'm calling toWarnDev here so I don't think that's right?. This test is failing here because the rendered output doesn't match. I verified that getRenderOutput is returning <div>1</div>. I guess its failing because they're not the same React elements, but we're using this same pattern elsewhere in this test suite so I don't know why its failing here.. It's a little confusing, but that doesn't work because isForwardRef expects a React Element for the forwardRef, not the actual object returned from forwardRef itself.\njs\nconst forwardRef = React.forwardRef(...);\nisForwardRef(forwardRef) // false\nisForwardRef(React.createElement(forwardRef)) // true\n. Probably because isValidElementType was introduced after this version of the shallow renderer. That's a good point though, because looking at isValidElementType catches more uncommon cases that React technically supports and that fail with the shallow renderer.\nFor example, you can do:\njs\nconst MemoFragment = React.memo(React.Fragment)\nBut rendering that with the shallow render will trigger this invariant. The same goes for other elements that have their own type like React.Suspense, React.ConcurrentMode, React.StrictMode, etc.. Yeah, it was changed to _context in https://github.com/facebook/react/pull/12501. Is it worth checking? I think a lot more would be broken if you were trying to render a tree created with a version of React that still used context since we don't check for it in the context code paths.. Isn't the context value tracked as _currentValue on this _context element?. I think we can add \"a\" here to make it a little clearer\njs\naddendum = ' However, it is set to a ' + typeof contextType + '.';\nThat way it reports \"set to a string\" instead of \"set to string\", which sounds better. Same goes for numbers, symbols, and functions.. Add another branch for arrays?\njs\nelse if (Array.isArray(contextType)) {\n  addendum = 'However, it is set to an array.'\n}. \ud83e\udd37\u200d\u2642\ufe0f seems like it could happen if you import the wrong value. I figured that if it happens it would be weird to see.\n\nHowever, it is set to an object with keys {0, 1, 2, 3, 4, 5, 6...100000}\n. \n",
    "kuon": "Maybe state in the comment that this is deprecated and evil to use?\n. ",
    "puradox": "This fails when ran with grunt test but passes when this test file is ran by itself.\nAny idea why?\n. Thank you @RaitoBezarius! I forgot to remove this dependency when removing unit test support for es6-symbol.\n. ",
    "ericmatthys": "The configRef value is returned by getRef and can be null. We could strictly check null, but an undefined or null check felt safer.\n. If null values should be allowed here, I think we'd need to check config.ref and config.key before calling getRef and getKey and then always set ref and key to the return.\n. Allowing key to be null seems like a mistake, since it is coerced to the string \"null\".\n. I think this approach should keep behavior consistent. Let me know what you think and I'll add a test for the null cases.\n``` js\nfunction isValidConfigRefOrKey(config, name) {\n  if (DEV) {\n    return config.hasOwnProperty(name) &&\n      !Object.getOwnPropertyDescriptor(config, name).get;\n  }\nreturn config[name] !== undefined;\n}\nfunction getConfigKey(config) {\n  return '' + config.key;\n}\n...\nReactElement.createElement = function(type, config, children) {\n  ...\nif (isValidConfigRefOrKey(config, 'ref')) {\n  ref = config.ref;\n}\n\nif (isValidConfigRefOrKey(config, 'key')) {\n  key = getConfigKey(config);\n}\n\n...\nReactElement.cloneElement = function(element, config, children) {\n  ...\nif (isValidConfigRefOrKey(config, 'ref')) {\n  // Silently steal the ref from the parent.\n  ref = config.ref;\n  owner = ReactCurrentOwner.current;\n}\n\nif (isValidConfigRefOrKey(config, 'key')) {\n  key = getConfigKey(config);\n}\n\n``\n. We're adding potentially 3 function calls. It could very easily be reduced to 2 sincegetConfigKey` isn't very necessary. The function has the same undefined condition that existed previously, but it now skips assigning null again since the value is already null. That doesn't seem like enough to make any measurable difference in performance, but I'm sure if you have any thoughts on proving that empirically.\n. ",
    "DanielRosenwasser": "@mhegazy says this should be fine.\n. Linking to our site's documentation might be better: http://www.typescriptlang.org/docs/handbook/jsx.html\n. Actually we have a quick start guide for using React with Webpack as well if you'd like to link to it: https://github.com/Microsoft/TypeScript-Handbook/blob/master/pages/quick-start/react-webpack.md\n. I believe this should be ts.JsxEmit.React\n. Whoops! Sorry about that, and good catch. :smile: \n. ",
    "steventsao": "\n\u5c01\u88dd\u7684\u975e\u5e38\u597d\n\nWould you consider \u5c01\u88dd\u6027\u9ad8 over the phrasing above? It's a more succinct phrasing based on this Wiki entry. Nice job!\n\n\u5177\u5099\u5c01\u88dd\u6027\uff08Encapsulation\uff09\u7684\u7269\u4ef6\u5c0e\u5411\u7a0b\u5f0f\u8a2d\u8a08\u96b1\u85cf\u4e86\u67d0\u4e00\u65b9\u6cd5\u7684\u5177\u9ad4\u57f7\u884c\u6b65\u9a5f\uff0c\u53d6\u800c\u4ee3\u4e4b\u7684\u662f\u901a\u904e\u8a0a\u606f\u50b3\u905e\u6a5f\u5236\u50b3\u9001\u8a0a\u606f\u7d66\u5b83\u3002\n\nhttps://zh.wikipedia.org/wiki/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1 \n. ",
    "jackson-huang": "It's better. Thanks!\n. ",
    "hkal": "@jimfb I used a side project of mine to test unescaping during development, because the situation you brought up was a concern of mine. However, I probably didn't run into the scenario because this expression being false only occurs when the developer messes up assigning the component key.\nI'll add the check and add a test.\n. text in this case is not ensured to be a string. I'm also not sure if adding a property here is the right move. Maybe the check should be done in validateDOMNesting.js?\n. Will skip valid parent check for all children deemed whitespace. Not just elements in <table>\n. That's right. validateDOMNesting is a noop in production mode and, at the moment, it's the only place that cares about _isWhitespace.\nThanks for pointing that out, so this line should be changed to:\njs\nif (__DEV__) {\n  this._isWhitespace = typeof text === 'string' && text.trim().length === 0;\n}\nOr did you have something else in mind?\n. Removed the changes to both files found in /fiber\n. @syranide - We now check for dev mode before adding this property\n. This strategy for duplicate checking is a bit slow: O(n\u00b2)\nWe can check for duplicates in the first loop (line 52) by making values a dictionary and checking if the current value has already been seen:\n``` js\nconst values = {};\nfor (const option of options) {\n  ... // code for handling optgroups\nif (option.type === 'option'\n    && option.props != null \n    && option.props.value) {\n      const value = option.props.value;\n  if (!values[value]) {\n    values[value] = value;\n  } else {\n    // warn about duplicate\n    return;\n  }\n\n}\n}\n```\nHowever, in reality, the chances of a <select> having enough <options>s to make this matter is small, but doing it this way does save us some lines of code.\n. Done.\n. No worries @Aweary. I'll change it back.\n. ",
    "keyz": "How about \"\u4ec5\u9700\u8981\u8868\u8fbe\u51fa\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u5728\u4efb\u4f55\u65f6\u95f4\u5e94\u8be5\u5982\u4f55\u5448\u73b0\uff0c\u5f53\u5e95\u5c42\u7684\u6570\u636e\u53d8\u5316\u65f6\uff0cReact \u4f1a\u81ea\u52a8\u66f4\u65b0\u6240\u6709\u7528\u6237\u754c\u9762\u3002\"?\n. \u201c\u4f7f\u7528\u201d might be better than \u201c\u91c7\u7528\u201d\u3002There is a whitespace missing before the first \"React\". :)\n. Would you remove the whitespace after the first \"\u3002\"?\n. There's an extra whitespace after the second \"\uff0c\".\n. We shouldn't use Chinese punctuation marks in code blocks. The comma above (\"\uff0c\") is a fullwidth comma (U+FF0C) and it won't be parsed correctly.\n. fullwidth comma (U+FF0C) in code block.\n. Fullwidth comma (U+FF0C) in code block. \n\u975e\u5e38\u611f\u8c22\u60a8\u7684\u8d21\u732e\uff0c\u80fd\u5426\u8bf7\u60a8\u91cd\u65b0\u68c0\u67e5\u4e00\u4e0b\u8fd9\u4e9b\u7ec6\u8282\uff1f\u5e0c\u671b\u60a8\u80fd\u591f\u79fb\u9664\u4e2d\u6587\u6807\u70b9\u524d\u540e\u7684\u7a7a\u683c\uff0c\u4ee5\u53ca\u5c06\u4ee3\u7801\u5757\u4e2d\u7684\u4e2d\u6587\u6807\u70b9\u66ff\u6362\u56de\u82f1\u6587\u3002\u8c22\u8c22\uff01\n. Thanks!\n. Removing the empty \">\" lines might affect Jekyll's Markdown parsing. I could be wrong though. Could you build the docs (instructions here) to double check if the page renders correctly? Thanks! \ud83d\ude00\n. Oh yeah, sorry I didn't see your regexp. Sure!\n. Yeah it makes sense to me. I thought the issue with Unknown was about the name of the node but I actually got confused by element vs. instance here. Thanks!\n. Sure!\n. I tried to put selfDebugID as the first arg of instantiateChild and to use instantiateChild.bind(null, selfDebugID) here, but that means we need to call bind as well in the production build. Do you think the current approach (arrowed currying, if that's a term) is acceptable? @spicyj \n. @spicyj what's a good way to get and feed debugID to flattenChildren here? The only place that calls ReactTransitionChildMapping.getChildMapping (syntactic sugar for flattenChildren) is here: https://github.com/facebook/react/blob/master/src/addons/transitions/ReactTransitionGroup.js#L41. In other words, how do I/can I get a debugID from a component?\n. Also, seems like the only other place we use flattenChildren is in ReactMultiChild and there's already a test for that in ReactMultiChild-test. Interestingly, when ReactChildReconciler finds duplicated keys, the error message talks about \"flattenChildren\" (which is also test covered in the new ReactChildReconciler-test file).\n. Hmm, I thought about this; self is more clear to me since we are talking about the current component which happens to be the parent for the children here.\n. Interestingly, ReactInstanceMap doesn't have information for the component at this point. That's probably because the component hasn't been mounted. \n. The first warning has no stack info. I think this is because it is triggered by getInitialState and we don't have stack info about the component yet. Moving ReactInstanceMap.set from mount-time to construction-type might fix this issue, but I don't know if that makes sense. @spicyj \n. I removed the error info object packing and unpacking logic and moved the memoizer to validateExplicitKey. Other than that there shouldn't be any (behavioral) changes.\n. Not sure if this is a good way to branch on the type of the argument\n. Cool, I'm fixing this now and it will take either an element or a debugID.\n. Hey, thanks for catching this! This is kinda tricky -- as a parser, babylon has its own options here and it's different from babel's so we can't directly import/require it. All our syntax (parser)-related configs are specified here in fbjs. I'll update this one to make sure they are the same.\n. GitHub supports \"squash and merge\" now so feel free to add a new commit.\n. sure, extract-errors.js or extractErrors.js?\n. This will be reused when we rewrite invariants later. Do you think I should still inline it?\n. ah, it's because path is already declared in the upper scope.\n. How about inlining this module and lifting the babylon config to a variable at the top?\n. How about codes_js = \"var errorMap = #{codes_json.chomp};\\n\"?\n. Yeah, sometimes we have a link in a message that points to a gist/doc page (e.g., this one). This function is used to \"urlify\" the link. See http://keyanzhang.github.io/react/docs/error-codes.html?invariant=119&args=\"foo\"&args=\"bar\" as an example.\nI tried to use dangerouslySetInnerHTML, but it didn't work since we have stuff like <%s> in our error messages.\n. Yeah, but still we need to escape all <%s>s if we wanna dangerouslySetInnerHTML. The ideal one would be a markdown parser that parses a string to an array of React elements with proper keys. I think this is good for now -- as a side effect we also keep the messages exactly the same as the development build.\n. @gaearon Would it be better to use hot loader v3 here?\n. Just curious -- instead of calling ReactDOM.render repeatedly, why not using setState inside the component? IMO calling ReactDOM.render multiple times is an anti-pattern.\n. Agreed! I'll change it soon.\n. Would slicing arguments be less performant? I thought passing arguments to a call would leak the arguments object.\n. Also, should [] and & be encoded?\n. Yeah, I think making a regex for URLs is either leaky or an overkill...\n. Yeah I copied it from invariant first, then i changed the implementation (not allocating [a, b, c, ...]) but forgot to drop it (doh!).\n. Oh btw, reactProdInvariant is hard-coded now. Do you think I should make it an option to the babel plugin?\n. @spicyj \n. How about Symbol.for('dev-expression-with-codes.seen')?\n. Sorry, just saw this. selfDebugID is actually an optional parameter that will only be available in dev mode. You can also see from the number= JSDoc annotation. cc @vjeux \n. Same as above.\n. What's the difference between selfDebugID: ?number and selfDebugID?: number?\n. Copied from the flow group:\n- (arg?: number) means (arg: number | undefined)\n- (arg: ?number) means (arg: number | undefined | null)\nIn this case I think they should all be arg?: number.\n. @chicoxyzzy Thanks, there's already #7110 :)\n. there's a trailing i\n. @zpao @sebmarkbage do we want to use returnFiber : Fiber or returnFiber: Fiber (space before the colon)? \nAlso the closing ) should be on a new line IMO.\n. You can just add a commit to your fork branch and it will show up here. GitHub supports \"squash and merge\" right now so there's no need to squash commits from your end.\n. \u8bd1\u4e3a\u300c\u4e8b\u4ef6\u5904\u7406\u51fd\u6570\u300d\u4f1a\u6bd4\u300c\u5904\u7406\u5668\u300d\u66f4\u597d\u4e00\u4e9b\n. \u80fd\u5426\u8bf7\u60a8\u5c06\u5176\u6539\u56de\u300c\u5173\u6ce8\u5206\u79bb\u300d\uff1fhttps://zh.wikipedia.org/wiki/%E5%85%B3%E6%B3%A8%E7%82%B9%E5%88%86%E7%A6%BB\n. \u6b64\u5904\u4e4b\u524d\u7684\u5199\u6cd5\u5e76\u6ca1\u6709\u95ee\u9898\uff1bjekyll \u9700\u8981\u6211\u4eec\u7528 '{{'}} \u8fd9\u6837\u7684\u5199\u6cd5\u3002\n. \u6b64\u5904\u8bd1\u4e3a\u300c\u7ed1\u5b9a\u300d\u4f1a\u6bd4\u300c\u4fdd\u62a4\u300d\u66f4\u597d\u4e00\u4e9b\n. \u6df1\u6bd4\u8f83 -> \u6d45\u5c42\u6bd4\u8f83\n. \u300c\u8bbe\u7f6e\u51fd\u6570 properties \u7684\u65b9\u5f0f\u300d\n. Thanks for catching this!\n. \u300c\u8fdb\u884c\u6bd4\u8f83\uff0c\u4ee5\u8ba1\u7b97\u51fa\u300d\n. Yeah, Rollup is able to prune the entire thing.\n. Could you add zh-TW prefixes to this metadata block (similar to https://github.com/facebook/react/blob/master/docs/docs/01-why-react.zh-TW.md)? Thanks!\n. @gaearon would you take a look at this? ReactPerf is the only dev-only module that we publicly expose and it was refactored to make sure the public API doesn't break.\n. should this method be private too?\n. yeah, I added backward compatibility support for ReactDebugTool in https://github.com/facebook/react/pull/7381/commits/bba0d992d8f4ecf9cf6677817a1218e7f48a8a77. Not sure if we should also do it for ReactDOMDebugTool tho :)\n. Oops, sorry didn't notice that :|\n. I think it's important that the behavior stays the same across different envs so I call slice here regardless of the environment (prod vs. dev). Without this we won't be able to catch cases like var children = [...]; <Comp children={children}> since we don't want to freeze the original array reference from userland.\n. Oh yeah, good catch!\n. Could you change these lines to \npermalink: docs/advanced-performance-zh-CN.html\nprev: shallow-compare-zh-CN.html\nnext: context-zh-CN.html\nThanks!\n. - DOM\"j\"?\n-  \u300c\u7ed9\u5f00\u53d1\u8005\u4ee5\u66f4\u77ed\u7684\u65f6\u95f4\u53bb\u5904\u7406\u8fd9\u4e2a\u8fc7\u7a0b\u300d->\u300c\u8ba9\u5f00\u53d1\u8005\u53ef\u4ee5\u77ed\u63a5\u8fd9\u4e2a\u8fc7\u7a0b\u300d\n- \u300c\u8ba9React\u53ef\u4ee5\u6267\u884c\u66f4\u65b0\u300d->\u300c\u8ba9React\u53bb\u6267\u884c\u66f4\u65b0\u300d\n. \u6b64\u5904\u300c\u7ebf\u7a0b\u300d\u5e94\u8bd1\u4e3a\u300c\u5bf9\u8bdd\u300d\n. \"mix\" -> \"mixin\"\n. \"porp\" -> \"prop\"\n. \u300c\u53ef\u4ee5\u8ba9\u6211\u4eec\u575a\u6301\u4e00\u4e2a\u6570\u636e\u6e90\u662f\u5426\u6539\u53d8\u53d8\u5f97\u66f4\u52a0\u65b9\u4fbf\u300d->\u300c\u8ba9\u8ddf\u8e2a\u53d8\u5316\u53d8\u5f97\u7b80\u5355\u300d\n. Could you revise this sentence? Thanks! :)\n. \"stors\" -> \"stores\"\n. *store*\u53ef\u4ee5\u7528\u4e24\u4e2alist\u6765\u8bb0\u5f55users\u548cmessages\n. Record \u51fd\u6570\u63a5\u53d7\u4e00\u4e2a\u5bf9\u8c61\u4f5c\u4e3a\u53c2\u6570\uff1b\u8fd9\u4e2a\u5bf9\u8c61\u5b9a\u4e49\u4e86 Record \u4e2d\u7684\u952e\u503c\u4e0e\u9ed8\u8ba4\u503c\n. \u300c\u52a0\u5de5\u300d->\u300c\u5904\u7406\u300d\n. Could you also change the above lines to\nid: expose-component-functions-zh-CN\ntitle: \u66b4\u9732\u7ec4\u4ef6\u51fd\u6570\nlayout: tips\npermalink: tips/expose-component-functions-zh-CN.html\nprev: communicate-between-components-zh-CN.html\nnext: children-undefined-zh-CN.html\nWe'll need the -zh-CN suffix for our i18n site to work in the future. Thanks! :)\n. \u300c\u6765\u8ba9\u5b50\u7ec4\u4ef6\u81ea\u5df1\u5224\u65ad\u300d->\u300c\u6765\u8ba9\u5b50\u7ec4\u4ef6\u5728 componentDidUpdate \u4e2d\u5224\u65ad\u300d\n. - \u300c\u4f7f\u7528\u4e86\u300d\uff1a\u591a\u4e86\u4e00\u4e2a\u300c\u4e86\u300d\uff1f\n- \u300c\u5f00\u53d1\u6784\u5efa\u5de5\u5177\u300d->\u300c\u5f00\u53d1\u6784\u5efa\u7248\u672c\u300d\n- \u300c\u6784\u5efa\u4f60\u7684\u5e94\u7528\u300d -> \u300c\u8c03\u8bd5\u4f60\u7684\u5e94\u7528\u300d\n. - \u300c\u6539\u53d8\u7ec4\u4ef6\u7684state\u7684\u300d->\u300c\u6539\u53d8\u7ec4\u4ef6\u7684state\u65f6\u300d\n- \u300c\u725b\u903c\u7684\u6280\u672f\u300d->\u300c\u6280\u672f\u300d:)\n. \u300cproduction build\u300d\u5e94\u8bd1\u4e3a\u300c\u5f00\u53d1\u6784\u5efa\u7248\u672c\u300d\u800c\u4e0d\u662f\u300c\u5f00\u53d1\u6784\u5efa\u5de5\u5177\u300d\u3002\u80fd\u5426\u8bf7\u60a8\u4fee\u6539\u8fd9\u4e00\u884c\u4ee5\u53ca\u4e0a\u9762\u7684\u6807\u9898 (## \u4f7f\u7528\u751f\u4ea7\u6784\u5efa\u5de5\u5177 -> ## \u4f7f\u7528\u751f\u4ea7\u6784\u5efa\u7248\u672c)?\n. \u80fd\u5426\u8bf7\u60a8\u91cd\u65b0\u7ffb\u8bd1\u4e00\u4e0b\u8fd9\u6bb5\u8bdd\uff1f\u8c22\u8c22\uff01\n. Yes, that's unfortunate. :( Do you think there's a better way to do this? \nHowever, it should be more performant than the current approach, which slices in the ReactElement() function (https://github.com/facebook/react/blob/master/src/isomorphic/classic/element/ReactElement.js#L138) for every component that has more than one child. The new one slices in createElement and only when an user explicitly passes an array as children. If this makes sense then I guess the question is whether we want to slice in prod.\n. \u8c22\u8c22\uff0c\u60a8\u770b\u8fd9\u6837\u5982\u4f55\uff1f\n\n\u53e6\u4e00\u79cd\u6765\u8ddf\u8e2a\u6570\u636e\u53d8\u5316\u7684\u65b9\u6cd5\uff0c\u662f\u901a\u8fc7 setter \u6765\u8bbe\u7f6e\u6807\u8bc6\u7b26\u6765\u505a\u810f\u68c0\u67e5 (dirty checking)\u3002\u8fd9\u79cd\u65b9\u6cd5\u7684\u95ee\u9898\u5728\u4e8e\u5b83\u5f3a\u8feb\u4f60\u4f7f\u7528 setter\uff1b\u4f60\u9700\u8981\u591a\u5199\u5f88\u591a\u989d\u5916\u4ee3\u7801\u6216\u8005\u8ddf\u8e2a\u5206\u6790 class \u4e2d\u7684\u6570\u636e\u3002\u53e6\u5916\u4e00\u79cd\u65b9\u5f0f\u662f\uff0c\u4f60\u53ef\u4ee5\u5728\u66f4\u6539\u4e00\u4e2a\u5bf9\u8c61\u4e4b\u524d\u5bf9\u5b83\u8fdb\u884c\u4e00\u6b21\u6df1\u590d\u5236\uff0c\u4e4b\u540e\u518d\u8fdb\u884c\u6df1\u6bd4\u8f83\uff0c\u6765\u5224\u65ad\u8fd9\u6b21\u64cd\u4f5c\u662f\u5426\u9020\u6210\u4e86\u6570\u636e\u6539\u53d8\uff1a\u8fd9\u79cd\u65b9\u6848\u7684\u95ee\u9898\u5728\u4e8e\u6df1\u590d\u5236\u4e0e\u6df1\u6bd4\u8f83\u90fd\u662f\u5f88\u6602\u8d35\u7684\u64cd\u4f5c\u3002\n. .displayName?\n. just curious: what are xit and xdescribe?\n. @Aweary the SFC heuristics didn't get included; see https://github.com/facebook/react/pull/7195#issuecomment-236365843\n. Since this is an array, each child should have a unique key prop.\n. <Repeat numTimes={10}>? :) Also missing key here.\n. did you mean description = 'odd'?\n. The error code generator was written in a way that it reads the file first, traverses the AST, and appends to the target file. I guess when we invoke it multiple times it causes a race condition and overwrites the same file.\n\nTo be honest there should a better way if I'm more knowledgeable in Gulp :). This PR simply changes it back to the way that the generator was used.\n. @gaearon I rebased and removed reactNoopRenderer from the list of extract-errors targets. Please let me know if it makes sense!\n. Is the jest package just an alias for jest-cli? Only one is needed I think. \n. jest just exports jest-cli (https://github.com/facebook/jest/blob/master/packages/jest/src/jest.js) so only one of them would be enough here.\n. Thanks, that's much clearer. :). I've already updated the Codepen! Is there anything specific that needs improvement? :). \ud83d\udc4d Updated.. \ud83d\udc4d. If we also rename nextState to partialState in the property explanation will it be more clear?. Or pendingState, which is more accurate here.. The config enables throttling by default\n- https://github.com/GoogleChrome/lighthouse/blob/master/lighthouse-core/config/default-config.js#L50\n- https://github.com/GoogleChrome/lighthouse/blob/master/lighthouse-core/config/perf-config.js#L12\n. ",
    "sarbbottam": "probably\ndiff\n+          invariant(\n+            classNames !== undefined,\n+            'TestUtils.scryRenderedDOMComponentsWithClass expects a ' +\n+            'className as a second argument.'\n+          );\n           if (!Array.isArray(classNames)) {\n. Thanks @ipeters90 for the detailed explanation.\n\nif someone makes a mistake and entered the className foo as the only argument\n\nI guess then there should have been a check for root as well.\n. Got it, thanks!!\n. ",
    "ipetez": "@sarbbottam I also thought about doing it that way. The reason that I did it the way I did was to make sure the errors were as useful and specific as possible. For example. If we were to do it the way that you're recommending, if someone makes a mistake and entered the className foo as the only argument. They will no longer receive the helpful error that states that foo is not an instance of a component but will be presented with this new error instead Invariant Violation: TestUtils.scryRenderedDOMComponentsWithClass expects a className a second argument , which, to me is more ambiguous and unclear of what part of their test they need to fix. I think the second (new) error is more helpful when it is only presented to the user after we have verified that the first argument is a valid instance of a component. That's my reasoning but I'm opening to updating the code to your implementation if that's the consensus. Thanks for the feedback!\n. Inside of scryRenderedDOMComponentsWithClass, which takes in the root (instance of component) as the first argument, it calls ReactTestUtils.findAllInRenderedTree(root) which checks if root is a valid instance of a react component.\nReference: https://github.com/facebook/react/blob/master/src/test/ReactTestUtils.js#L168-171\nSo if someone calls scryRenderedDOMComponentsWithClass with no arguments or with an invalid root argument, it will throw an appropriate error (Invariant Violation: findAllInRenderedTree(...): instance must be a composite component). That seems sufficient to me. Do you think there's additional checks needed ? @sarbbottam \n. ",
    "elrumordelaluz": "You are right @iamdustan, capitalisation happens after : or - and this attribute (xmlns) seems to be al little weird (but this is a spec problem). I just followed the point 3 from this comment and seems coherent to me.\n. ",
    "evenstensberg": "Agree. Especially using \"running\". Saw the blog explaining the situation on IE was using \"current form\", so used the same definition. Should I rephrase / You rephrase and republish or should we just leave it? It would be a nice addition to the browser support section as this is exactly where this kind of information should be rather just in a blog post. Perhaps just cut of \"running fine\" and say we do not actively support? \n. \"We believe React will work in its current form there but we will not be prioritizing any efforts to fix new issues that only affect IE8.\"\n. Hmm, okay. Closing this then \ud83d\ude04 \n. I thought the comment was meant to warn if user returns null in initialState, (also forgot about first conditional). Is the comment meant to warn AND/OR remove the mocking function? As by now, there's only two places in the repository that uses ._isMockFunction\n. Yeah, it will. It's just a \"sketch\" now to show how I was thinking. Doing like a conditional like if(!ReactCurrentOwner.current == null && warnedOnce == true) might make tests fail, at least did when I did that\n. Also worth noting, when you have a conditional inside conditional, it's preferable to come up with something else, so having an extra layer of abstraction here could be good, as we are making the code really dirty. But we will wait for someone else to decide that. @Aweary if you wanna join, there's space for you to help too :)\n. ",
    "aickin": "I wasn't sure if there was a utility function that already did this; please let me know if there is.\n. This error handling had to move over from _mountImageIntoNode because now a markup mismatch results in a thrown Error from mountComponent.\n. This copies the behavior in ReactDOMInput.js, and is needed to pass unit tests that attempt to render selects without a markup mismatch.\n. I genuinely don't know what the correct behavior in this case should be. Given that the user has modified the value since the input was loaded, I think we probably should queue up a change event. However, the current code does not do this, since it is currently not able to detect when the user has changed the value before client-side render. Thoughts?\n. This was blatantly copied from the if (transaction.useCreateElement) branch. It seems to work, but I'm not entirely sure what it does.\n. From the linked document on developer.mozilla.org in the comments:\n\nNote that the thrown MyError will report incorrect lineNumber and fileName at least in Firefox.\n\nI can do some research into other browsers.\n. Good call. I'll go back and massage the error messages with a more critical eye. \n. I should comment this much better. The answer is that there are four possibilities for what node is, and they each map to different components:\nSingle element node: ReactDOMComponent\nSingle comment node: ReactDOMEmpty Component (e.g. <!-- react-empty:1 -->)\nTwo comment nodes: ReactDOMTextComponent with no text.  (e.g. <!-- react-text:1 --><!-- /react-text -->)\nComment node, text node, comment node: ReactDOMTextComponent with text.  (e.g. <!-- react-text:1 -->Some text<!-- /react-text -->)\nI'll comment this better, and I may also make the checks more thorough and self-explanatory (check the node types when it's an array, for instance). \n. Thanks, I'll look it up. \n. That's fair. I was just copying the signature around, and it makes sense in the other function signatures, where shouldMatch is also an argument. \nThanks!\n. I started at first with nodeToReuse, but I changed them all (I think!) to nodesToReuse after I realized that argument would sometimes be a single value and would at other times need to be an array. I chose plural everywhere to match the naming of props.children, which is plural but also a variable that can represent a single value or an array. I don't have strong feelings about this, and if you'll like me to change it, I'm happy to do so.\n. I agree that the name isn't very descriptive or good.\nI may be wrong, but it seems like RenderedComponent is generally a term in the code for actual components, and this method returns DOM nodes. What do you think about something like getNativeNodeChildren which mirrors the getNativeNode methods?\n. Great. Thanks for the feedback!\n. You are 100% right; this is an unnecessary addition. It made sense in a previous version of this PR, but it no longer does, and I missed that it should be removed.\nThanks for your eagle eye, and it should be fixed in 352aa15.\n. Reading further on this at this MDN article and this MSDN article, it seems to me that this will grab a stack for all browsers where a stack is available. Stack is completely non-standard, so I can't guarantee that it will work absolutely everywhere. \nIt should be fine on platforms where there is no stack property.\nNote also that every place in the current code where MismatchError is thrown, it is caught without looking at the stack.\nGiven all that, I'm going to leave the code as is. Let me know if you disagree, and thanks for the comment!\n. Thanks for the feedback, @donabrams! \nI realized this yesterday while I was working on the standalone renderer, but I haven't gotten around to patching it. There's also some other cases, like xlinkHref/xlink:href and xmlLang/xml:lang. I'll certainly fix it up with a unit test and a patch if we decide to move forward with this PR, and thanks again!\n. Thanks for the feedback, @Munter! \nI'll look at this again and patch it up if we decide to move forward with this PR.\n. Is there still an issue with using Object.create? I believe it's only unsupported in IE8, which I think is no longer supported by React?\n. I believe this incantation is necessary to stop browserify from bundling in a fake version of node's stream library.\n. I believe this line is needed to get require to look for a package rather than a module that uses providesModule.\n. I just moved these out of ReactDOMComponent so that they could be shared.\n. There's no ReactInstanceMap in the server renderer.\n. I don't know why tracking owner is important for SSR, so I didn't put the work in to get this test passing.\n. I should probably re-implement adler32.js using this file with just one chunk; I just haven't gotten around to it. I basically just stole this from react-dom-stream so I could get this done.\n. escape-html uses &#39 instead of &#x27, which should be a completely equivalent HTML entity for single quote (and it's one byte less, too).\n. None of the tests in this PR use it, but some of the ones coming later do. \nThe idea is that itRenders is for tests that only need to inspect the DOM, whereas itClientRenders is for tests that need to test interactivity (things like events, refs, etc.). The latter tests are only possible when ReactDOM.render has been called, which doesn't happen in the server render-only tests.\nI tried to explain that in the comment above the function, but obviously it wasn't clear enough. Any suggestions on how to make it clearer? . You're right; this was an incantation I copied from the old code without thinking. I've changed it in a91c836 to change canUseDom to true before the call to ReactDOM.render in renderToDom (and change it back after). Seems to work right AFAICT.. No problem. Changed in a91c836.. Good call. Modified all three tests in a91c836. Thanks!. Yeah, it behaves differently if renderToString throws an error. With Promise.resolve(), the arrow function throws, whereas with new Promise, the promise just rejects. There are some tests that I haven't yet submitted that depend on the promises rejecting on error rather than throwing up the call stack.. Totally fair point. I'll remove it.. Good catch! I fixed that in 091d7fd and made some of the other names more descriptive. Thanks for the help!. Good question! I could argue that it's a little different, in that it's comparing two different React.Component class implementations against each other, which wasn't done above, but yeah, it's probably duplicative and has a very low (maybe zero?) likelihood of catching something not caught by those tests. I can take it out in the next PR.. I agree; I'm genuinely not certain if it's a good idea to have in SSR or not. If not, we can just change these tests pretty easily, though.. Good call. I added those checks in a734aec. Thanks!. Tiny nit: you should be able to just get rid of the second argument here and on line 448 below; the error count argument defaults to 0.\nNice job!. Imagine a single tear streaming down my face... \ud83d\ude22\n(but seriously: this PR is super, super, super exciting). The use of textContent here is interesting. I'd argue that innerHTML may be more technically correct, as textContent will ignore child elements in the existing DOM tree. \nFor example, for the JSX <div>My Content</div>, textContent would be fine hydrating <div>My <span style=\"color: blue\">Content</span><input type='text' value='some input value'></div>, whereas innerHTML would not.\nYou are deliberately not checking everything in the tree, though, and the documentation for textContent on MDN says that it's tends to perform better than innerHTML, so maybe this is intentional? If so, I think a comment is in order.. I'd argue that it's probably a good idea to put in some junk text here to make sure that the patch up occurs. It's not impossible to assume that some tests try rendering <div someprop='some value'/> (either already or in the future), and that wouldn't trigger the patch up code at all.. Cool. \nOne other thought I just had: what about when children is an array of text or an array of numbers (or an array of arrays of strings, etc.)? I think this code will fail to fix up the text in that case, right?. I thought at one point about having the test in the hydrating \"good markup\" case actually walk the entire DOM tree before and after rendering to confirm that the nodes were not replaced by hydration. Would that be helpful as a PR?. And hence my comment about still not understanding the Fiber internals. Thanks for your patience; I'll be quiet now. \ud83d\ude01. Thanks for the comment; I wasn't aware of readable-stream!\nI did some reading on the subject, though (in particular, this blog post referenced by the readable-stream README), and it seemed like this is only really a problem for versions of Node <= 0.12. Given that those versions of Node are all deprecated, is there still a good reason to use readable-stream that you know of?\n(and thanks again for your comment!). Yep, you're right! Thanks!. Thanks for the suggestions! Should be fixed in b8f2529.. Should be fixed in 132567d. Thanks!. Right you are! \nShould be fixed in b6f9e06, and I opened PR #10027 to fix it in the doc for ReactDOMServer, too.\nThanks for the help!. I haven't found much other documentation or argumentation about readable-stream.\n\nE.g. how does it integrate with other code that assumes the native Node stream?\n\nMy understanding (which is a bit fuzzy) is that it literally is the native Node stream code pulled out of Node core. The authors are the Node Streams Working Group.\nI think the benefit of using readable-stream would be more consistency of behavior across versions of Node, potentially making it easier to repro reported bugs. Of course, Stream hasn't changed that much since 4.x (unlike in the 0.9-0.12 timeframe), so this may not be that big a deal.\nOn the other hand, linking to a particular version of readable-stream means that someone on the React team should probably track when readable-stream gets released and cut new releases of React if it's useful to upgrade. If we use native stream, though, developers don't have to wait on the React team to get the newest version of streams; they can choose to upgrade Node themselves.\nFor now, I vote we use stream; it's a simpler setup with less maintenance involved. If we find there are a bunch of streaming bugs due to Node versions, though, we can replace it with a pinned version of readable-stream. Does that sound OK?. Fixed in 3d1421a. I assumed that the same logic applied to ReactDOMStringRenderer.js as well, since the file is parallel in structure to this one. \nThanks!. Good call. Done in 3d1421a. Thanks!. Sounds good, done in 3d1421a. Thanks!. Great question!\nThe reason I'm destructing highWaterMark is that there are several other options that can be passed to the Readable constructor (documented here), and those options will make the stream behave incorrectly. For example, if you pass an encoding argument to the Readable constructor, the stream will output gibberish. Passing a read argument will make the stream not render anything.\nIf we pass the options object through unfiltered, the client of this class could accidentally make it malfunction, whereas if we only pass highWaterMark, we will be OK. Does that make sense?. Perhaps? But that won't do anything for folks who are using npm (like me), and the official contribution doc has its instructions in npm, so that's what I thought was supported.. Nit: maybe include a comment denoting the end of the duplicated code; at first I thought it was just the regex that was duped.. Oops, this was almost certainly a copy-paste error on my part. Thanks for fixing it!. There should probably be a comment here noting that the code here is copied in ReactDOMComponent.. ",
    "sheerun": "I'd leave it as it's the same as in the source:\nhttps://github.com/facebook/react/blob/master/src/renderers/shared/reconciler/tests/ReactStatelessComponent-test.js\n. ",
    "Yaxian": "I think it worked fine in browser after modifying.\n. OK, I will.\n. OK, I will have fixed it, and squashed the commits.\n. @zpao Sorry, I did not know that {{  is a Jekyll's opening tag. Thank you for it. And I  already reverted the change.\n. ",
    "tony99nyr": "I was thinking it may add execution time to the shallowCompare call so why not avoid calling shallowEqual when we can.  I don't think its required though.\n. ",
    "iEgit": "typo: \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u043e\u0435\n. ",
    "davidaurelio": "this one is commented out in ReactNativeBaseComponent.js\n. sure, I can change that. Having the renderer in its own package makes a lot of sense.\n. ",
    "donabrams": "also need to handle htmlFor/for?\n. ",
    "Munter": "You might need to throw it to guarantee that the stack trace is serialized: https://github.com/unexpectedjs/unexpected/commit/5dcd441b1ccde7513930cbb4223859f8b4b61c2b\n. ",
    "wub": "Sounds good to me, @jimfb.\nAfter some searching, \"abstracts away [the DOM]\" seems more popular - would \"abstracts the DOM away\" make more sense?\n. ",
    "arendjr": "FYI: I'm working on a related bug now, and it appears that indeed \"onpropertychange\" works with attachEvent(), but \"propertychange\" doesn't with addEventListener(). At least in IE11 in IE10 Compatibility Mode. FWIW :)\n. ",
    "nfcampos": "I've changed it\n. ",
    "aaronabramov": "@spicyj that is true.\nMaybe what we can do is add an afterEach hook that will console.log the number of expects in the test and make output look something like:\n\u2713 it supports classic refs [# of expects: 4]\nand compare that.\nhacky.. but maybe that'll do :)\n. i think this one should go to package.json, since it's shared between both projects. (both projects share reporters, including CoverageReporter that uses this information). same as in fiber.config.json. right. with this option you should be able to collect coverage when running this project separately, but i don't think it'll collect coverage properly when running with MPR (specifically i don't think it'll add files that have 0% coverage to the report).. ",
    "roderickhsiao": "change is here, other just sort variable by alphabetical order\n. absolutely, thanks for the feedback . ",
    "ankitml": "Ok. Will update in next commit. \n. ",
    "roganov": "1) should be (props)\n2) forgot arrow\n. consts must be initialized\n. ",
    "gustavovnicius": "I think thats the habit. Changed it \ud83d\ude04 \n. ",
    "sashashakun": "Fix other things but need some clarification here, you mean I should leave \njavascript\nif (!__DEV__) {\n  warnInProduction();\n  return [];\n}\nonly in start() and stop() and remove in other places?\n. Ooops, understood.\n. Fixed\n. Fixed, but not sure that understood you correctly about this:\nanother right around the if\n. Fixed\n. ",
    "stryju": "<3\n. ",
    "lexjacobs": "Yes, no problem. To avoid an extra commit, will it work for me to amend the commit and force push to my fork? Or I can make a new pull request. What do you prefer? \n. Adjusted line breaks to match reviewer feedback.\n. ",
    "ibekavac": "Leave a comment\n. ",
    "josipherceg": "You can also use template literals instead. With template literals, you are able to make use of the syntactic sugar making substitutions like this more readable. Check: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals\n. ",
    "wali-s": "Good call. Fixed.\n. ",
    "jamesplease": "It is if I'm not mistaken. This call to componentWillTransition in the the endListener callback, which is called after the transition ends.\n. I needed to change this to if (childRef && childRef.componentDidTransition) {} to prevent errors in certain situations.\n. I needed to change this to if (childRef && childRef.componentWillTransition) {} to prevent errors in certain situations.\n. ",
    "RandScullard": "@jmeas That's correct. componentWillTransition is called just before the transition begins and componentDidTransition is called just after it ends. The order looks backwards because of the position of endListener in the source code.\n. ",
    "yordis": "Is this right?\n. ",
    "YusongLiu": "Yeah fixed.\n. ",
    "git-richard": "It is not needed on line 73. It is in the return statement because getBoundingClientRect.left returns a float. I used parseInt to match the MouseEvent offsetX, which returns an int.\n. I wasn't sure whether to use null or undefined. Was looking for some advice there.\nI'm not sure what you mean by \"on creation\" & \"on demand\". It does execute on every MouseMove event. Should I remove the polyfill?\n. Should I move it to ReactDOMNullInputValuePropDevtool.js or create a new file? If a new file, what should I name it? Thanks.\n. I noticed ReactDOMNullInputValuePropDevtool.js exports ReactDOMUnknownPropertyDevtool. Is that correct or a copy/paste error?\n. Thanks for the feedback. I updated it to use the dictionary but found an issue so I reverted back to the arrays. The dictionary approach shows a warning for a select like this:\n<select>\n    <option value={{val: 'a'}}>a</option>\n    <option value={{val: 'b'}}>b</option>\n</select>\nThose are different values and shouldn't show a warning. I agree that a select shouldn't normally have enough options for the array comparisons to be a performance issue.\n. You're right. I didn't notice that. Do you think using a dictionary of the options, as mentioned above, is a correct approach? Thanks,\n. I changed it back to a dictionary. Do you see any other issues with it?\n. Do you mean the props.children for a select element can be something besides option or optGroup? I'm not sure how that would work. Can you point me towards some documentation  explaining it? Also, thanks for the feedback. Researching these issues you and others have pointed out has taught me quite a bit about how React works.\n. I updated the code to check that it's a React element. I also refactored it to remove the duplicate code.\n. ",
    "nsfmc": "@spicyj sorry to randomly bikeshed my way into this discussion, but my experience was that the spaceless em was mostly advocated to me by designers that had done work in europe (since it's apparently a common newspaper pattern) whereas the en/space is more common here (and among my mostly american faculty for whatever reason). follow your heart, ben (although i also put a vote in for the hard em dash without spaces since i always feel it adds an air of immediacy in the break \ud83d\ude38 ). \n. also as a note, the Just return... is the most awkward sentence here, i know what you're saying but i don't think the meaning is totally clear to somebody that hasn't internalized thinking in react.\n. i was thinking something like \n\nDesign simple views for each state in your application and React will efficiently manage updating & rendering just the right components when your data changes.\n. one \"authority\" (which agrees with alpert in this case) is robert bringhurst's elements of typographic style. my v3.0 copy says\n5.2.1 Use spaced en dashes \u2013 rather than close-set em dashes or spaced hyphens \u2013 to set off phrases.\n\nI'm not much of a prescriptivist, sadly, i just like the look of the close-set em dashes (especially if the em dash in the font doesn't include any sidebearing space around the glyph). i'm definitely of the school of thought that it's good to explore any arguments for/against and then make whatever decision you think works best in this sort of case (if you've commissioned a typeface for close setting em dashes (or even if you haven't), i think you should be allowed to use them however you like, like wearing sneakers with a suit, which some people consider untoward and others perceive as a mark of a kind of fashion).\n. ",
    "calebmer": "I'm just happy someone cares about using em dashes \ud83d\ude0a\n. Hi \ud83d\udc4b\nI\u2019m the original author of this ESLint rule popping in for a review.\nThe reason I used a cache here is that in complex components, time complexity can really start to spike up. Consider:\njs\nfunction MyComponent() {\n  if (a) {} else {}\n  if (b) {} else {}\n  if (c) {} else {}\n  useHook();\n}\nHere we have 23 = 8 paths from useHook() to the start of MyComponent. Representing the following combinations of a, b, and c.\n|a|b|c|\n|-|-|-|\n|true|true|true|\n|false|true|true|\n|true|false|true|\n|false|true|false|\n|true|false|false|\n|false|true|false|\n|false|false|true|\n|false|false|false|\nSo we have a 2n exponential relationship, fun. Now remember that every && and || (in the future perhaps also ??) introduces a condition since false && expensive() will not execute expensive().\nLet\u2019s say we have a complex component that has 5 conditions placed in the component before 6 hooks all in the same segment. Without a cache we have to call countPathsFromStart() on 25 paths 6 times. With a cache, we only need to call countPathsFromStart() on 2 \u00d7 5 segments because we cache the value for every segment so we only need to visit each segment once.\nIn big-O notation where \u201cn\u201d is the number of conditions and \u201ch\u201d is the number of hooks, we have O(2n) time complexity with a cache and O(2n \u00d7 h) without a cache.\nTo see what I mean in practice try adding the following component to the test suite. On this branch, I became impatient after waiting about 10s for the test to finish. When I switched back to master the entire ESLint test suite finished in about 3s.\nIt\u2019s up to the React team (cc @gaearon) to determine whether or not this performance regression is acceptable. 20 conditions and 10 hooks were fine for me on this branch, but 40 conditions and 10 hooks were not. If this performance regression is not acceptable then I recommend adding the below component to the test suite.\n```js\nfunction MyComponent() {\n  // 40 conditions\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n  if (c) {} else {}\n// 10 hooks\n  useHook();\n  useHook();\n  useHook();\n  useHook();\n  useHook();\n  useHook();\n  useHook();\n  useHook();\n  useHook();\n  useHook();\n}\n``. I added some comments below with a possible solution and the rationale behind that solution. TL;DR whencountPathsFromStart()` breaks a cycle it gives a temporary result of 0 to avoid looping forever.. ",
    "garethx": "Yes, that's it - the link creates a clone of the latest version of React tutorial project (https://hyperdev.com/#!/project/shade-king), so anyone who clicks on it will get their own version of that latest code that they can then play around with and edit however they like.\n. ",
    "cbrandolino": "I wanted to avoid negatives in the question, but I see how that phrasing might sound clunky.\n@jimfb Would you go with \"Does it remain constant over time\"? \n. What about \"does it stay constant over time\"?  The \"stay\" helps bringing home the idea I think.\nAt any rate, the \"no-negatives\" wasn't dogmatic. \"Does it remain unchanged over time\" is also fine for me. Let me know which one you prefer and I'll edit accordingly.\n. ",
    "sthodup1": "@jimfb It made a difference when I ran it. Without the return false, the page reloaded and the form cleared. \n. Was using 15.0.1 but switching to the newest version fixed the problem. The zip included with the tutorial uses 15.0.1, which may be the cause of the issue.\n. @jimfb @Aweary The newest version fixes the issue. I just submitted a PR updating the example's React dependency.\n. ",
    "eblin": "I moved the warning to devtools, let me know if everything is fine :)\n. I added the createClassline to test that the warning was actually triggering but yes feel free to delete it.\n\nThis is effectively just catching unknown elements\n\nCorrect as long as the element.type passes the criteria:\njs\nif (element == null || typeof element.type !== 'string' ||\n    element.type.match(/\\-|\\s+/) !== null ||\n    ReactDOMFactories.hasOwnProperty(element.type)) {\n    return;\n  }\n. Agree! I was not too happy with the message itself! Thanks for the suggestion, I'll change it to that.\n. @Aweary Agreed, as far as I know there's none.\nReactDOMFactories was used since it's already being used by the project.\n. @Aweary completely agree with you, but other than keeping a list of elements, how else can we make sure there's no false positives?\nAccording to the the specs, SVG and MathML are elements allowed in HTML which belong to their own respective namespace, so createElement will return HTMLUnknownElement for any of these elements, aside from those, everything else should represent HTMLUnknownElement accurately.\nSeems to me the solution for now is, we have to list svg/mathml valid tags and make sure we \"ignore\" those as valid. \nIn a perfect world we could get this data from W3C but I couldn't find anything useful to consume other than scraping their repo or MDN. They do have the useful tests that we can probably gather something from.\nHowever this is essentially keeping a list of elements (kind of like the same ReactDOMFactories is doing) which it was already said is not the best solution. What do you guys think would be the ideal solution?\n. ",
    "jalexanderfox": "You are correct, they are not required for the purposes of the demonstration, though it is quite nice to have all four callbacks available should someone want to know which ones exist or want to expand upon the example. Also, I didn't see it as complicating the example since they are empty functions but to your point, less code to read is less. I will remove them.\n. ",
    "gabelevi": "Couldn't you do\nJavaScript\nreturn (elem instanceof HTMLInputElement && supportedInputTypes[elem.type]) || \n  nodeName === 'textarea';\nor something to that effect? The any is unfortunate\n. ",
    "omerts": "@gaearon I had to extract _notifyStateChanged again, so it can be used for notifying on inital state.\n. done\n. ",
    "rricard": "Not sure about this though, maybe there is a way to do better there. I personally would have used Immutable for this kind of trick, but, I understand the constraints here. So if I can do that differently, just tell me!\n. Oh! maybe you don't want those! Can delete them if you ask, but flow helped me though (once again!)...\n. I can do that, especially if I can consider that UpdateQueues will be identical. Yes, you understood that correctly, should I change my comment to be more clear maybe ?\n. Okay, that makes complete sense (I forgot about the JIT optimisation...). I will consider it is required. Should I worry about other Transaction files though ? And yes, there are some other ReactUpdateQueue usages I didn't catch, I will update them as well!\n. This override shouldn't be needed: too much copy-pasta: will delete that!\n. Okay I will check that still, to be sure...\n. Yes! => ReactNativeReconcileTransaction !\n. Yes, good catch! I will refactor that!\n. I would actually change the message to something more adapted to the server:\nWarning: setState(...): Can only update a mounting component. This usually means you called setState() on an unmounted component or already mounted component on a server. This is a no-op. Please check the code for the Component component.\n. Oh! Cool! I thought that this part wasn't quite yet babel-ready. I should have checked the gulp pipeline ...\n. The first setState is not supposed to trigger warnings. But as you may already have found out, the test just before uses setState that way and would fail anyway. So you're right, that's pointless, I just realised !\nSo I will do exactly as you proposed, and detach multiple tests, that makes total sense! I kinda tried nested timeouts but wasn't really sure it was fine, code-readability-wise !\n. I think I will just delete it. We may want to use this mechanism for other uses.\n. Yes, of course! I can change the babelrc if needed...\n. I'll think of something. I really like react warnings because they are super-clear, I want to continue in this direction here...\n. I can totally do that! I wasn't sure about babel on the React codebase but as @gaearon pointed out, babel is there so, yes I can do it. (After this, I can also start to add some flow throughout the codebase if you are ok with that, you can even point me to critical parts. However, the flow declarations for react already are super complete, so I'm not sure there is really critical parts).\n. Yes, I agree, I will add an actual state change.\n. There is 53 flow errors in ReactCompositeComponent (missing annotations), I'll do this file in a separate PR.\n. weak allows unannotated function defs, it is often used for progressive addition of flow, that way you can start typechecking but in the absence of annotation, flow will consider the params automatically as any. https://flowtype.org/docs/existing.html#weak-mode\n. For instance, I think you could add @flow weak everywhere in this codebase without raising much issues. The upside would be that flow could still emit warnings on very risky things it managed to infer.\n. Yes, again, copy-pasta, disn't put much thoughts into it, thanks for pointing it out!\n. That's the question I myself has on my projects, flow annotations are ok, IF you don't use any doc generation...\n. For now I'll leave both. \n. Ok let me some time to think about it and really understand the situation :)\n. Okay. Yes. I think I got it\n. Oh! Never used that before... Good to know!\n. Ok, seems fair to me: I can help with the full flow conversion if wou want.\n. Ok, this is what I thought: the public React flow definition doesn't define (yet) transactional partialState. https://github.com/facebook/flow/blob/master/lib/react.js#L25\n. For now, I'll stick with the jasmine-way of spying on things...\n. It's indeed more interesting to roll files with @flow right away. Never used weak that much, if the flow team deprecates it, I will stop recommending it then!\n. I could change that on both places, what would you recommend @zpao ? Something like warnUnmountedStateChange ?\n. May I propose something else ? Maybe we should use flow's public react interface types there as well: such as React.Component. Or just use a mixed type in the meantime given the fact that mixed is generic enough to avoid problems\n. https://github.com/facebook/flow/blob/master/lib/react.js#L16\nJust trying it, if you are still not ok with it, I can get back to mixed or no flow at all!\n. I choose to use React.Component<*,*,*> since it seems to be more generic than a ReactClass in flow\n. Just figured out I could use ReactComponent in flow without importing anything. Thanks!\n. Yes, that works well indeed. Thanks!\n. That's actually needed by flow to be able to assign this.transaction.\n. yes, that makes sense\n. Flow does pass here. Adding an annotation to ReactServerRenderingTransaction(renderToStaticMarkup: boolean) was enough for flow.\n. ~~Without comments requires two special babel plugins (syntax-flow & transform-flow-strip-types) I haven't checked if it there are there yet...~~\n. ~~Nope!~~\n. Same as for ReactServerRenderingTransaction.js, flow passes her so it's apparently sufficiently typed. Adding flow has two effects I'd like to keep if you don't mind:\n1. Performing typechecking in the file itself (as well as checking nullability for example)\n2. Forcing to provide flow annotations on exposed function signatures (which is the case there! => ReactReconcileTransaction(useCreateElement: boolean))\nI would \"vote\" to keep it, but I understand if you want it to disappear and wait for a PR that will be correctly typechecking all of that, but better! \n. Scratch that, the transform needed there is an ES7 transform: syntax-class-properties\n. Ok, I'll type those files completely then, but by experience, that's how flow works, it will not pass if for instance, ReactServerRenderingTransaction is not annotated... I know the coverage is not complete but having a complete coverage requires pretty much having all of the repo typed!\n. For instance ReactServerRederingTransaction is already covered at 66%. Most of the lack of coverage comes from the imports\n. yep\n. Good idea!\n. However, I don't see how to trigger any setState/replaceState or forceUpdate on a functional component ...\n. Well, after thinking about it, I doubt it is useful! Let me see if I can simplify all of this!\n. @gaearon yup, was possible to make it simpler!\n. Now, That's the interesting part! I'll try to do that...\n. It wasn't that hard ... Maybe there is a more elegant way to do that though ...\n. Ok, I tried to do that more efficiently, but I have hard time passing that information around without relying on optional parameters.\n. That makes sense, depends where we track if we're rendering or not though. I wouldn't get the rendering condition from something such as the instrumentation if the outcome is a throw ...\n. Ok, I'll see if I can do the right check only if we're in the edge case...\n. @gaearon good catch! should have thought of it...\n. That's a test case I should write\n. You're right, I'm going to change that\n. Ok, so that's why you have both! Invariant throws, warning goes in the console... Will do!\n. can do a quick PR on that\n. Understood! Here is the PR: https://github.com/facebook/react/pull/8306\n. ",
    "alexzherdev": "\u043e\u043f\u0435\u0447\u0430\u0442\u043a\u0430: \"\u0438\u043d\u0442\u0444\u0435\u0440\u0444\u0435\u0439\u0441\u044b\"\n. Two colons at the end here\n. This assumes #7159 to be merged first.\n. This assumes #7216 is merged first.\n. I can update this depending on whether #6706 can make it first.\n. \"\u041f\u0435\u0440\u0435\u0434\u0430\u0447\u0430\" \u043d\u0435 \u0441\u043e\u0432\u0441\u0435\u043c \u043e\u0442\u0440\u0430\u0436\u0430\u0435\u0442 \u0441\u0443\u0442\u044c \u0441\u043b\u043e\u0432\u0430 \u0432 \u0434\u0430\u043d\u043d\u043e\u043c \u0441\u043b\u0443\u0447\u0430\u0435, \u044d\u0442\u043e \u0431\u043e\u043b\u044c\u0448\u0435 \u043f\u043e\u0445\u043e\u0436\u0435 \u043d\u0430 \"\u043f\u0440\u043e\u0431\u0440\u0430\u0441\u044b\u0432\u0430\u043d\u0438\u0435\"? \u041d\u043e \u043d\u0435 \u0443\u0432\u0435\u0440\u0435\u043d, \u0447\u0442\u043e \u0442\u0430\u043a\u043e\u0435 \u0441\u043b\u043e\u0432\u043e \u043c\u043e\u0436\u043d\u043e \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c.\n. transferring-props-ru-RU.html#-----... - yuck. This works, but illustrates how jekyll (or markdown?) fails at generating readable section links with any language other than English.\n. Depends on #7234 \n. Depends on #7235 \n. On this line I had to remove a link to another section altogether due to the issue described in https://github.com/facebook/react/pull/7235#discussion-diff-70165133R52. In this document, multiple section links are generated with the anchor #-, so it's impossible to refer to any one of them specifically.\n. Suggest changing this to \"stateless functional components\" since that is what seems to be used in other docs.\n. Not an expert at all, but I think \"repetitive manual work\" sounds better than \"manual repetitive work\".\n. Typo? (rvm)\n. Better to say 'argument of type X' as it's more in line with the language I've seen in other places\n. @zpao Ah, didn't know about that, sorry \ud83d\ude0a I have a fix for this to include Asian languages and Russian, but will need to update the links in existing docs. I can put up a PR when that's ready.\n. Trying to fix this in #7497 \n. \u0422\u0430\u043c \"If you don't use JSX\", \u0442\u0430\u043a \u0447\u0442\u043e \u0442\u043e\u0433\u0434\u0430 \"\u043d\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0435 JSX\".\n\u041d\u0435 \u0441\u043e\u0432\u0441\u0435\u043c \u0441\u043e\u0433\u043b\u0430\u0441\u0435\u043d \u0441 \"\u0444\u0443\u043d\u043a\u0446\u0438\u0438 \u044f\u0437\u044b\u043a\u0430\": Object.assign \u0445\u043e\u0442\u044c \u0438 \u043c\u043e\u0436\u043d\u043e \u043d\u0430\u0437\u0432\u0430\u0442\u044c \u0442\u0430\u043a\u043e\u0432\u043e\u0439, \u043d\u043e _.extend \u043d\u0435 \u043f\u043e\u0434\u0445\u043e\u0434\u0438\u0442 \u043f\u043e\u0434 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \"\u0444\u0443\u043d\u043a\u0446\u0438\u0438 \u044f\u0437\u044b\u043a\u0430\".\n\u041a\u0440\u043e\u043c\u0435 \u0442\u043e\u0433\u043e, \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442\u0441\u044f \u0418\u041c\u0425\u041e \u0434\u0430\u043b\u0435\u043a\u043e\u0432\u0430\u0442\u043e \u043e\u0442 \u043e\u0440\u0438\u0433\u0438\u043d\u0430\u043b\u044c\u043d\u043e\u0439 \u0444\u0440\u0430\u0437\u044b \"object helper\".\n. ",
    "alexyuly": "I don't know the technical term, but yes these \"static get\" declarations work with just the Babel es2015 preset and nothing else.\n. Thanks for the feedback. I'll keep an eye on the PR and be happy to update after guidance.\n. ",
    "zeel": "it would be great if we can merge this two ifs.\n. ",
    "mP1": "not sure if the names $trapBubbledEvent and $trapCapturedEvent should be different so theres no confusion about them being refs to the ones that live in ReactEventListener.\n. Unfortunately i had to add these \"public\" or \"visible\" apis because other places need to call them.\n. ???\nThis is the only big q, does document.querySelectAll exist in all currently supported react browsers, or do i need a fallback etc.\n. > IE8 does not have it, \nDoes react officially support ie8 ?\n\nWouldn't it make more sense to just keep a counter?\n\nThe problem i was trying to avoid by counting is that only works if code unmounts each and every component helping the counter stay accurate.\nIm not sure how big or small a concern this is. For me it seems wrong to track and \"count\" when you can ask the dom to tell you and that would never be wrong.\nWhat should i do ?\n1) update code to \"count\" root additions and removals ?\n2) keep doc.querySelectAll and provide a fallback for ie ?\n. ok, i will count mounts/unmounts of roots and get back to you...\n. @syranide \nThis function can accept documents and other types of targets. In both these cases it returns a remover that removes all registered listeners. To give a consistent interface it must therefore always return a remover for all types of target.\nIn this case, the caller knows if its adding to a document, and it does the right thing with the returned remover.\nIts simply trying to match the style that whoever registers a listener also takes care of removing them at the right time.\nRegarding the wastefulness of creating an array for each call, it hardly matters, as this isnt called that frequently, actually it only happens once if your \"root\" is the document, or once for the other \"targets\", which again wont be that many.\n. ",
    "usmanajmal": "That's a better style. I will push a patch. :)\n. My bad. Closing parenthesis should have been on new line. \nCan someone guide me on how can I push a patch?\nWe use Gerrit in house and all we need to do is to keep same change-id for a commit. That takes care of patching a commit already pushed.\n. Ok @keyanzhang , let me try that. Thanks. :)\nPushing new patch to the original PR #7230 in a while. Running grunt test and grunt lint first. \n. sure :)\n. ",
    "vitkarpov": "@gaearon I have a couple of questions about this solution, could you please explain this.\n- I'm not sure about why this changes don't break the current behaviour. In the previous code the key was just inst._rootNodeId and not it's '.' + inst._rootNodeId. How this could be the same thing as there're no other changes?\n- Why does it improve performance?\n. Guys, seems pretty reasonable for me now. @gaearon Thanks!\nAlso it seems that getDictionaryKey should have a good explanation, comment above. V8's being developed so this could be irrelevant eventually.\n. ",
    "timdorr": "Why not just toString? \n. That's what you get with a dynamically typed language :smile:\n. ",
    "pke": "Maybe keep it consistent with the docs and name it \"Stateless functional components\"?\n. Yes, knowing which component has the invalid ref would help a lot.\n. ",
    "edvinerikson": "IMO this should follow the normal pattern check the render method of ...\nSomething like Stateless functional component %s cannot have refs attached. Check the render method of %s. I also think that the other message (when using a string ref) should follow this pattern too.\n. js\nvar componentName = component.getName() || 'a component';\n. Probably better to use toEqual\n. Ah okay, I guess you can remove component && ... though\n. Adding ? at the end of a object/argument key means that the field is optional while adding ? in the beginning of the type means that it can be null or the type you specified however you always need to pass the argument/key.\n``` js\n/ @flow /\nfunction foo1(a?: { bar: number}) {\n}\nfoo1(); // fine\nfoo1({}) // not fine\nfunction foo2(a: { bar: ?number }) {\n}\nfoo2({}); // invalid\nfoo2({ bar: 1}); // fine\nfoo2({ bar: null}); // fine\n```\nhttps://flowtype.org/try/#0PQKgBAAgZgNg9gdzCYAoVUCuA7AxgFwEs5swo44BGACgEMB+ALjAG8wAjWgJ2e0wFt2AUy4BfAJStUo9OSrVxAbjDBgZQtiEYKNFhJVrscfOs2ycBYqTkAmOszaceYen0Eiw+ltNkU7epQMwDQA3WhhCABNtOH8ObmZKCWVVUy1bakcEsD4YGGSgqA0hIA\n. does SSR still work with this enabled? . I believe the changes in this file should be replicated in the Fiber component as well. . will this only be called on the initial mount? or also when new children get's appended on a already mounted node?\nwill appendChild or appendInitialChild handle: [\"Foo\"] -> [\"Foo\", \"Bar\"] ?. I guess this will bloat devtools a little bit if all host components are prefixed with this? . Haven't checked the Fiber code for a while. Does this make it so that all text get it's own instance? <Text>Hej</Text> Did not get a text instance before since it's a single child. . Maybe it should be global instead of window (probably doesn't matter)?. If you are tired of forgetting the arguments I added flowtypings for this function in my PR https://github.com/facebook/react/pull/8361/files#diff-0480067610415f2abfec7a69ca45997eR37. Seems to be the case actually. Kind of handy since you don't have to handle that special case in createInstance/commitUpdate. \nhttps://github.com/facebook/react/blob/master/src/renderers/shared/fiber/ReactFiberBeginWork.js#L228. https://github.com/facebook/react/pull/8361#issuecomment-262029066 Is the short answer \ud83d\ude04\nSo when \u2018Hello\u2018 is detected \u2018Hello\u2018 will not have its RCTRawText instance created instead it's up to you to create it manually in createInstance by checking if props.children is a string or number. \nOn mobile right now. Let me know if my explanation isn't clear \ud83d\ude04. Yeah I am not sure how much overhead the fiber and child work have in this case either. It felt kind of awkward implementing it in my PR since it was basically duplicating the createTextInstance method. . Sounds good to me \ud83d\ude0a. Maybe do a typeof instead? that is what we have done in other places where we need to detect numbers / strings. I am not sure this works with negative values. Do we even need this check now? . Ah okay \ud83d\udc4d . guess this will break if there is multiple react trees on the page. is this one necessary? . sure \ud83d\udc4d . https://github.com/facebook/react/pull/8858. ",
    "sassanh": "Just wanted to be safe about it. Thought maybe tests can produce situations that both functions generate warnings and then check the output of both. Changed it as you suggested in new commit.\n. Great, didn't know how warning-'s api. Changed it as you suggested in new commit.\n. Np happens, I'm glad you found it. Just fixed it in new commit.\n. I see, fixed it in a new commit.\n. ",
    "finnigantime": "Using a warning makes sense to me, fixed.\nI also expect that this will expose warnings on existing native apps where some invalid attributes currently no-op. There may even be some cases where someone wants to use invalid attributes and no-op (e.g. if a component's JSX refers to a subcomponent that gets swapped out for another subcomponent that only supports a subset of the original's attributes). However, I think in most cases it's nice to get a warning that the attribute you're trying to set is invalid (adding this warning has already helped me catch one such case). I originally suggested making the enableStrictAttributeValidation property configurable so someone can toggle it without having to rebuild React, but I didn't see an existing way to support configuration without adding a new top-level property to React, which is overkill just for this single property. It would be nice to have a React.configure() mechanism. Thoughts?\n. I had to opt-out of validation for 'collapsable' and 'style'  to get ReactComponentTreeDevtool-test.native.js to pass. I guess these props come from ReactNativeDefaultInjection's EmptyComponent.\n. ",
    "catamphetamine": "@alexzherdev Wouldn't it confuse people? \"Expected props argument of type div\", as if \"@param {div} props\".\n. ",
    "kellycampbell": "What's the reason for this assignment since the next line reassigns it to defaultValue? Also, line 249 looks like a no-op as well.\n. ",
    "jamesblight": "Most people will come to this page from the link provided in the warning message. Assuming that is true, I think a more informative message could be shown here without repeating the warning.\nInstead of: \n\nYou probably came to this page because of this error:\nWarning: React.createElement: type should not be null, undefined, boolean, or number.\nIt should be a string (for DOM elements) or a ReactClass (for composite components).\nThis usually occurs when attempting to render an element that is of an invalid type. The following examples will trigger this error:](url)\n\nYou could write something like:\n\nYou probably came here because your code is trying to create a ReactElement with an invalid type. This usually happens when you have an invalid import statement.\n. \n",
    "nkt": "\u0415\u0441\u043b\u0438 \u0432\u044b \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0435 JSX, \u043c\u043e\u0436\u043d\u043e \u0432\u044b\u0437\u044b\u0432\u0430\u0442\u044c \u043b\u044e\u0431\u044b\u0435 \u0444\u0443\u043d\u043a\u0446\u0438\u0438 \u044f\u0437\u044b\u043a\u0430, \u0442\u0430\u043a\u0438\u0435 \u043a\u0430\u043a Object.assign \u0432 ES2015 \u0438\u043b\u0438 _.extend \u0438\u0437 Underscore:\n. \u0414\u0430\u043b\u0435\u0435 \u043c\u044b \u0440\u0430\u0441\u0441\u043c\u043e\u0442\u0440\u0438\u043c \u043b\u0443\u0447\u0448\u0438\u0435 \u043f\u0440\u0430\u043a\u0442\u0438\u043a\u0438. ...\n. ",
    "wong2": "\u5f00\u53d1\u8005\u7248\u672c\u5305\u62ec\u989d\u5916\u7684\u8b66\u544a\u4fe1\u606f\uff0c\u8fd9\u5728\u4f60\u5f00\u53d1app\u7684\u65f6\u5019\u5f88\u6709\u7528\uff0c\u4f46\u662f\u56e0\u4e3a\u8981\u8fdb\u884c\u989d\u5916\u7684\u5904\u7406\uff0c\u6240\u4ee5\u5b83\u4e5f\u4f1a\u6bd4\u8f83\u6162\n. \u804a\u5929\u7ebf\uff1f\uff1f  \u8fd9\u91cc thread \u5e94\u8be5\u53ef\u4ee5\u7ffb\u8bd1\u4e3a \u5bf9\u8bdd\n. ",
    "cht8687": "\u201c\u7ed9\u5f00\u53d1\u8005\u51cf\u77ed\u8fd9\u4e2a\u8fd9\u4e2a\u8fc7\u7a0b\u56de\u8def\u7684\u80fd\u529b\u3002\u201c  => \u8d4b\u4e88\u5f00\u53d1\u8005\u8df3\u8fc7\u8fd9\u4e2a\u8fc7\u7a0b\u7684\u80fd\u529b\u3002 verb short-circuit : (transitive) to bypass (a procedure, regulation, etc)\n. ",
    "morenoh149": "Do you have to be a fb employee to see the internal link?\n. ",
    "donavon": "I would use deconstruction. I would also not be afraid to break it up into multiple lines for better readability. A \"single statement\" fat arrow function does not mean single line.\nInstead of:\njs\nconst HelloMessage = (props) => <div style={props.style} className={props.className}>Hello, {props.name}</div>;\nYour example is better represented (IMO) as follows:\njs\nconst HelloMessage = ({ style, className, name }) => (\n    <div style={style} className={className}>\n        Hello, {name}\n    </div>\n);\nBut then again, I could be wrong. \ud83d\ude04 \n. Shouldn't you also wrap the actual function in an if (__DEV__)?\n. You could maybe use deconstruction and fat arrow:\njs\nthis.classNameAndNodeQueue.forEach(({ node, className }) => {\n    CSSCore.addClass(node, className);\n});\n. can be shortened to just:\njs\n{\n  className,\n  node\n}\n. maybe something like this instead?\njs\nreturn values.map(value => (\n  getPropType(value) === 'function' ? `Unexpected function: ${value}` : value\n));\nYou shouldn't have to specially call toString on value.\n. I'd like to see this written as a SFC to help promote that pattern for simple components like this. I understand that you want to maintain the whole cat/mouse thing, but I believe that one would likely pass x and y as two props, not as props within a prop, if writing this for real. Passing a mouse prop (as an object with x and y properties) is a leaky abstraction that Cat shouldn't have to worry about.\nTo put it another way, if I asked you to write a component that positioned an image of a cat at an x/y coordinate, you would probably write this:\njsx\nconst Cat = ({ x, y }) => (\n  <img src=\"/cat.jpg\" style={{ position: 'absolute', left: x, top: y }}/>\n);. First, for security reasons, you probably shouldn't expose state directly to a foreign component. You can't be guaranteed that they won't mutate it.\nSecond, why not use JSX in this situation? You're expecting the caller to pass in a component, so why not just render it with JSX? You did so on line 126 above, so why change how Cat is rendered just because the implementation of Cat is passed in as a prop?\nWith that, I'd like to see render like this. Note how I spread state.\njsx\nrender() {\n  const Cat = this.props.render;\n  return (\n    <div style={{ height: '100%' }} onMouseMove={this.handleMouseMove}>\n      <Cat {...state} />\n    </div>\n  );\n}\nIn my article for AmericanExpress.io titled \"Function as Child Components Are an Anti-Pattern\", I talk about various implimentation of render callback.  I call this specific pattern Component Injection as you are injecting a component. I find myself using this pattern frequently.\nI might even consider naming the passed in prop Cat (or RenderCat) instead of simply render. That way it's clear that you are rendering a cat and not just some component. Also, the code would go from this:\njs\nconst Cat = this.props.render;\nto this:\njs\nconst { Cat } = this.props;\nAlso, depending on the application, it's possible that you may need to pass in multiple render props to the same component. You might want to inject both a Cat and a Dog component. If the prop were called simply render, it would be an issue.. No need for a lambda here. Just inject the Cat component directly. Again, component injection.\nMouseTracker should also be a SFC.\n```js\nconst MouseTracker = () => (\n  \nMove the mouse around!\n\n\n);\n``\n. you're missing a;`\nor better yet, destructure:\njs\nconst { mouse }  = this.props;. I was going to point that out as well, but thought that the complexity of passing a function might take away from the point of the docs.. I have the same problem when writing docs. We need eslint to be able to check inside of code blocks of md files.. @Daniel15, \n\nIt's used twice. left: mouse.x and top: mouse.y.\nTighter code. This code is more concise:\n    js\n    const { mouse }  = this.props;\n    that this code below. See how the term mouse is entered twice below?\n    const mouse = this.props.mouse;\nConsistency. In the next component that you write, you may pass props foo and bar. That should look the same.\n    js\n    const { foo, bar }  = this.props;\n. @ryanflorence,\n\nSee my implementation of MouseTracker in this CodeSandbox.\n\nIf you use createElement on an inline function you're going to get mounting/unmounting on every render, which you never want.\n\nIf Cat is mounted/umounted on each render (as you suggested), then why is the console output in componentWillMount  displayed only once? Note that I've only turned Cat into a class component so that I could console.log the mount lifecycle. And wouldn't the same thing hold true in line 192? \n\nAdditionally, the point is to compose Cat and Mouse w/o either having to know about the other, so making renderCat obliterates the decoupled composition of render props.\n\nI'll give you that one and I completely agree that one shouldn't know about the other. I was being a bit to literal and following @mjackson's prior naming.. Are you kidding me? As you friend @ryanflorence said below:\n\nthe point is to compose Cat and Mouse w/o either having to know about the other\n\nCat is really just what we render at an x/y location. We could pass Render={SquareRedDiv}. If we did, you would also likely just pass x and y. Cat or SquareRedDiv have no idea that they are trailing a mouse point, nor should they.. That seems to have fallen out of fashion when using React, but I remember using that all the time. It hated it as I wanted real private methods.. Forked CodeSandbox with SquareRedDiv implementation really shows why passing a mouse prop is just silly.\n```jsx\nconst style = {\n  position: 'absolute', \n  width: 64, \n  height: 64, \n  backgroundColor: 'red',\n};\nconst SquareRedDiv = ({ x, y }) => (\n  \n);\n```. @alexkrolick,\nAhh... Now I get what @ryanflorence was saying. Thx for clarifying.\n. @alexkrolick \n\nIt seems the RR folks really want to encourage a pattern that allows for inline definition.\n\nI know that my next statement is like throwing gasoline on a slow burning Twitter controversy (and even cause SOME TO SCREAM), but... Inline component definitions (like inline labmda function handlers in render) are just a bad idea from a memory management/garbage collection perspective. I think we should discourage the pattern that allows for inline definition.\n. @Daniel15 \n\nwe have a custom Babel transform to make them \"actually private\"\n\nI WANT! Only I had always dreamed of a transform that took methods and properties that began with an underscore, or prefixed with the private keyword, and used WeakMaps instead of name mangling or Symbols to make them \"actually private\". Probably an overkill, I know, but still, they would be as close to private that we an get w/ES5. Plus I'm not as much of a purist anymore. I've been beaten down over time. But if I had that custom Babel transform, maybe it would breath some new life into me. \ud83d\ude18 \ud83d\ude4f. @alexkrolick Very nice. It demonstrates exactly what's going on. Thx for putting this together! I'd like to point out your last comment once again.\n\nThis is totally aside from any memory issues that arise from defining functions in render.\n\n. ",
    "justingreenberg": "in this case, invocation only needs to be wrapped... since this block will be considered unreachable, uglifyjs dead code elimination excludes it from minified production builds\n. removes logic to reset ReactDebugCurrentFrame.element since current fiber and debug tracking is now handled by renderers\ndiff\n   if (__DEV__) {\n-    ReactDebugCurrentFrame.element = null;  // line 255\n     freezeDefaultProps(element);\n   }\nedit: included in c508d90, somehow lost change in rebase. ",
    "sstur": "I notice these are \"temporary patches\" but there's no mention of a task that's blocking us from doing a less temporary fix so I'm wondering what is the right approach here in our React codebases that use Flow? Also what about type Props = {children: ReactNode}. Should we create declare type ReactNode = string | number | ReactElement<any> | Array<string | number | ReactElement<any>>;?\n. ",
    "jesstelford": "Right you are my good man! Done, and (gasp) force pushed ;)\n. ",
    "mnpenner": "Could this message be confusing? Whitespace doesn't matter between JSX tags -- doesn't this problem only occur when there's whitespace inside a variable?\nEdit: Nevermind, per this blog post, whitespace can appear when: \n\nElement nodes will maintain white space when mixed with with non-element nodes on the same physical line of JSX code.\n. Aha, didn't know that. I guess that makes sense, but it's not something you normally think about! (Which is why this warning is helpful!)\n. PhpStorm did that :cry: I noticed after I pushed.\n. \n",
    "reaperhulk": "No problem, I will revert it. I noticed that referrerPolicy appears to have been missed in this list (it was added in the 15.3 release) so you'll want to add that in addition to playsInline the next time you update these docs.\n. I can confirm that with HAS_BOOLEAN_VALUE alone the property is emitted and a test page works as expected in iOS 10.\nI'm not sure toggling this value has a great deal of meaning though, as playsinline (at least as currently used by iOS) is only relevant as a modifier when autoplay is present. If both are true (and the video is muted or has no audio track) then iOS will play the video automatically and without fullscreen. If you toggle playsinline later it's unclear what we should expect -- immediate fullscreen? But re-toggling while it's fullscreen shouldn't make it go automatically inline again.\nI can definitely build something to test this if you'd still like to know, but any findings we get are more likely to be filed as Safari bugs than anything for react. Hopefully I didn't misunderstand the request!\n. ",
    "jin": ":+1: will do\n. I was referring to the createElement API. Not sure why I didn't see the hash button for the permalink, will fix!\n. ",
    "captainsafia": "\nWe would need to check that window exists here, as it may not on the server, for example. I think usually ExecutionEnvironment.canUseDOM is the check we use (you can search for it in the source).\n\nNoted. Will update.\n\nI would prefer we check != null rather than !== undefined here in the case where there is a Polymer variable set to null so member access doesn't throw later. I know this is unlikely but still.\n\nMmmm. Good point.\n\nShould we emit the warning if Polymer.useShadow is false? I'm not sure what it means (will need to read some docs) but from the code it seems like useNativeShadow would then also become false regardless of the polyfill.\n\nYeah, the documentation is pretty sparse on this, but your Googling skills might be better than mine. It looks like useShadow checks to see if the user passed a { dom: 'shadow' } property when configuring Polymer and if they have a native shadow polyfill. I think what we actually want to check for is Polymer.settings.wantShadow && !Polymer.settings.nativeShadow to check if they are requesting a shadow but must rely on the shady dom.\n. ",
    "millermedeiros": "lint is complaining about these functions being inside the else\n116:3  error  Move function declaration to program root  no-inner-declarations\n  119:3  error  Move function declaration to program root  no-inner-declarations\n. for some weird reason lint thinks that Item is not being used:\n46:6  error  \"Item\" is defined but never used           no-unused-vars\n. OK, updated the test to use ReactDOM.render instead. FYI, original test was introduced by https://github.com/facebook/react/pull/6694\n. ",
    "flarnie": "Would you want to use 'mixed' here rather than 'any'?\n. Don't worry about it since it makes no difference in this case - thanks for explaining. :)\n. Sounds good, thanks! Will update that.\n. Sounds good - will update.\n. Thanks for catching that!\n. Good question - this part of EventPluginRegistry makes me think that the 'registrationName' property can be used when there is no 'phasedRegistrationNames' property. I will try to verify whether there are actually events created that follow that pattern.\n. Interesting - perhaps PooledClass could export a class that we use as a Flow Mixin  when declaring other classes that later have 'PooledClass.addPooling' called on them. Is that what you meant?\nI agree that we should move away from Flow definitions - which we already are with ReactSyntheticEvent. If we are thinking of replacing the Flow implementation of React types, we can try and keep a separation between the public API and the internal API of each class, because Flow types should only reflect the public API of React classes.\nI can take a stab at both those in a follow-up PR if I'm understanding correctly. \n. Sounds good!\n. (We're both learning - that's the fun. :))\nAn example is the EnterLeaveEventPlugin where the dispatch config has a registrationName and not a phasedRegistrationNames property.\n. Both ideas make sense! I'll try just typing the SyntheticEvent class itself and using that. I had thought we might want to avoid using that directly, but now I can't think of a good reason why not.\n. Just saw your comment at the bottom - will do the typing of SyntheticEvent in a follow up PR then. Thanks!\n. Thanks! I would have said the same thing too, except @Aweary pointed out the benefits of null | <Type> to me in a different PR. Based on this post by sebmarkbage.\n. It seems like people keep adding complexity to this function, a little at a time, and it's getting longer and longer. And it doesn't seem to be covered by the test for this file, although I didn't read the whole test yet. \nAfter reading the comparable code in ReactNative I think this would be more maintainable if pulled out and refactored. Just didn't want to start down that path without some idea of whether it's worth it.\n. Thanks - will fix.. Yup - you are right, I had guessed that we were not using 'createRenderer' any more. Will fix.. This was from rebasing off my other documentation updates.. It's cool - will fix.. Because it was incorrect, as the diff in the other PR points out and fixes. When I cherry-picked this to make a stand-alone branch/PR I either kept this correction or made it again because it was convenient.. The pattern we show first is\nconst ReactShallowRenderer = require('react-test-renderer/shallow');\nconst renderer = new ReactShallowRenderer();\nIt makes sense to reserve the UpperCamelCase for the class itself, and for instances of the class use lowerSnakeCase. What we need still is consistency between the naming of the instances. I would vote for shallowRenderer instead of renderer.. My thought was that they are no longer part of an ordered navigation - each one is now either a stand-alone package, or deprecated. They soon won't live in the main React documentation. The 'next' and 'prev' links only make sense when they are all part of the set of 'addons', but the concept of the set itself is deprecated.. Yes! Will submit a follow-up PR.\n. You're right - I was just going through the list of add-ons docs and accidentally updated some others too. Thanks! Fixing in that follow-up PR.. This was 99% copy-pasted from ReactElementValidator.js, with my only real change being allowing this method to return an empty string when no 'parentType' is passed.\nMaking this return an empty string when no parentType is passed is kind of a hack. Ideally would refactor this, as I explained in the commit message for this change.\nAlso planning to open a 'good-first-bug' issue to get this flow typed.. Sounds good - will remove it from the PR.. No real reason - I was looking at another test which intentionally avoided JSX. Will update this to use JSX.. Sounds good - will move this. Then we can then also skip the pointless test that gets run when ReactDOMFeatureFlags.useFiber is false.. I will probably just refactor the code so that things make more sense, rather than trying to maintain the way that it was working before. So we probably don't need this as a separate module.. tldr; In most cases no, there won't be terrible merge conflicts, and when it happens it should be fairly easy to resolve.\nI think I have been in similar situations with generated 'schema' type files, and there can be annoying merge conflicts in some cases.\nIf people have a stack of commits, and they commit the 'results.json' in each commit, and then rebase, they could have a merge conflict to resolve for each diff.\nIdeally they just commit the 'results.json' at the top of their commit stack, and if there is a conflict they can regenerate the file and git add scripts/rollup/results.json.\nIt would be great to automate this though.. Thanks! Will fix.. Nice catch - will fix.. I think the cleanest option is to just move it outside of the 'for' loop. I'll play around with some alternatives and maybe push another version to see, but I think it will be ugly.. Sounds good! Will fix.. I'm looking into why it's structured this way, and will simplify if there doesn't seem to be a good reason. Nice catch.. It was added here - https://github.com/facebook/react/commit/47e49ae8b7e41b566db4cabb47ee2f31e5b9bf0b and looks like the author was just copying the type of logic that was used before, when we had two nested objects for the two types of key warnings we threw. So I am removing the nesting.. That's a good question. I can also fix this case by adding 'key' to each element in an array, but I think it's better to find the corner case where this change adds an extra warning, and decide if we want that extra warning. Looking into it now.. So in this test we call \nReactDOM.render(<div>{updateWithChildren}</div>, container);\n on line 33. With 'fiber' enabled, when 'updateWithChildren' is an array, it's treated as a fragment and the missing keys trigger a warning. This is a separate warning from the one for missing keys in the nested arrays wihin 'updateWithChildren'.\nThis seems like\nA) A corner case\nB) Possibly ok?\nThe only problem I can think of is that it is a change, so folks could have tests which passed before and then fail with Fiber, and that would be confusing.\nI'm not sure how to detect the difference and stop the warning if it's a situation like this though.. Sounds good - will fix. :). I stand by our decision to leave the name 'contextTag' for now and find a better name in the future. Wondering if it would be helpful to open an issue or at least leave a 'TODO' comment about renaming this would be helpful.. Now that I'm seeing this whole thing, I'm noticing we always do these two things:\ncreated.return = returnFiber;\ncreated.contextTag = returnFiber.contextTag;\nMakes me think of putting these two things into a reusable method, 'updateFiber' or something, which takes the 'created' and 'returnFiber'. I might think differently once I finish reading this code more thoroughly though. And it seems like we err on the side of less abstraction, so maybe the repetition is ok.. I like how these tests turned out.. I think the way you did it is how it is done throughout the React tests.. We removed the 'Add-Ons' section of the docs from the main navigation when we deprecated most of them in v15.5. (https://github.com/facebook/react/pull/9359) I think it's worth having this documentation - maybe we could put it in the README for the new separate module? . I really like this use of a Proxy. I'm wondering though about the fact that, according to MDN, Proxy is not yet supported in IE. To also show this warning in IE, we may want to switch and add the warning in the copy of ReactDOMFactories that remains in React. We could do that in a follow-up PR though. . Using Object.defineProperty could be handy.\nWith Object.defineProperty it might look like this:\n```\nif (DEV) {\n  // React.DOM factories are deprecated. ...(rest of comment)\n  var hasWarnedOfFactories = false;\n  var DOMFactoryMethodNameList = ['a', 'abbr', 'address', ... 'text', 'tspan'];\n  DOMFactoryMethodNameList.forEach((method) => {\n    React.DOM = Object.defineProperty(React.DOM, method, {\n      get: function() {\n        if (!hasWarnedOfFactories) {\n          warning(\n            false,\n            'Accessing factories like React.DOM.%s has been deprecated ' +\n            'and will be removed in the future. Use the ' +\n            'react-addons-dom-factories package instead.',\n            method\n          );\n      hasWarnedOfFactories = true;\n    }\n    return React.DOM[method];\n  },\n});\n\n});\n}\n``\nUnless there is a way to define a generic 'get' for all object attributes withObject.defineProperty`?\nIf not then it seems just as easy to do without the Object.defineProperty call I think, something like this;\n```\nif (DEV) {\n  // React.DOM factories are deprecated. ...(rest of comment)\n  var hasWarnedOfFactories = false;\n  var DOMFactoryMethodNameList = ['a', 'abbr', 'address', ... 'text', 'tspan'];\n  DOMFactoryMethodNameList.forEach((method) => {\n    var wrappedMethod = React.DOM[method];\n    React.DOM[method] = function() {\n      if (!hasWarnedOfFactories) {\n        warning(\n          false,\n          'Accessing factories like React.DOM.%s has been deprecated ' +\n          'and will be removed in the future. Use the ' +\n          'react-addons-dom-factories package instead.',\n          method\n        );\n    hasWarnedOfFactories = true;\n  }\n  return wrappedMethod.apply(null, Array.prototype.slice.call(arguments));\n});\n\n});\n}\n```\nBoth of these instantiate an extra wrapper function for every factory method, which is annoying. I figure a follow-up PR, either by me or someone else, can come up with a good approach.. Sounds good - will move it to a gist.. Aaah nice - that is a simpler way of saying it. Will fix.. Good of you to notice, and yes it's intentional. A bunch of these changes were made in PR 9383.. I can do that - also going to update this to use the '[@author] in [#PR/commit]' format.. I tried to figure out either what version a change was released in, or at least what the latest version of each package is. The latest version of each of these is 15.5.2 and 15.5.1 respectively.. Sure - maybe that will be less confusing after all. Although then it's a bit tricky to map the add-on version to the React version. I guess I would annotate them in the section where React was using that version of the add-on.. Also will update all these to use the '[@author] in [#PR/commit]' format.. Based on later comments, will move this inline to the main Changelog.. You are right - thanks again for flagging!. Thanks - missed that one. Will fix.. Ah - good to know. Fixing now. :). Great - for now I'll add the same disclaimer from the 'prop-types' repo. Was also thinking of adding the 'yanked' annotation but since that would be a new convention will propose it in a follow-up PR.. Nice touch - will fix.. Thanks - will fix.. nice catch - will fix. Gotcha - fixing now.. I would think that makes sense - it was nice to have them put back in this PR though, so I can more easily cherry-pick it to the 15.6 branch. Removing can be in a follow-up that does not get cherry-picked.. Going to fix this; requier -> require. Sure - agreed that this should be rare and would cause bugs. . Sure - I will make it a duplicate and just swap 'error' for 'warn'.. Sounds good!. I think every time. This came up in code review before, on https://github.com/facebook/react/pull/9420 and @trueadm said: \n\nFor now, whenever you update something that will be merged into master (it's always good to merge master into your branch and run this after). It gives us all some indications on possible mistakes in terms of bundle size regressions. We'll improve how this works in the coming weeks too.\n\n\n. We could probably update the 'contributing' docs to mention this if they don't already. I don't think most people are.. Or automate it - even better. :). will fix. Sounds good~ will fix. Yea, but looking at it again I don't think we need the parens. Will fix, thanks for pointing it out. :). Sounds good! Will fix.. Didn't mean to update all these versions. Will probably make a separate PR with an update to yarn.lock.. Thanks - going to do an overall clean-up of that. The README in that package has the wrong name, and probably other places too.. You mean the fb.me url and the README.md which it points to? Yes.. oops - just noticed this. will fix.. Were there any issues with versions earlier than 15.3 though? . Good point - will fix. Thanks!. \u26a1\ufe0f \ud83c\udfb8 \ud83e\udd47 . Thanks!!! Will fix.\n\n. Double-thanks!. Oh thanks! I didn't mean to add that line at all - since the createClass deprecation warning was noted in the 15.5 changelog we don't need to say it again, do we?. Sounds good - will remove the comments.. oop! I didn't mean to remove that. Weird.. Oh I see - it was nested under 'packaging' and didn't seem like that belonged. I can put it back though.. will remove this. Not sure - just saw that you cleaned it up along with other things. Thanks!. I did run it through prettier - was wary of trying to take specific parts of the changes because I might miss a closing bracket somewhere.. I can fix the quotes at least though.. Seems like this was removed because it was not used. ?. Do we still need the 'browserify' part if we switched to webpack?. Thanks - so maybe we can change it to this:\nWhen deploying your app, make sure to [use the production build](...link to that doc).. Thanks! Will fix.. Agreed - not sure about 'Softening' either but will chat with folks and see what we come up with.. Will fix.. Nice!!! Thanks, will fix.. I'm guessing the reason for removing these two items is that they are both relatively small fixes? I could see that making sense, if that is your intention.. Thanks for updating the node types to use constants.. Why have both this and the previous expectation? They seem to be testing the same thing.. Could we remove this 'TODO'? Or is that talking about a follow-up step that changes the build process?. \n. Good idea - will fix.. Good points;\n - Absolutely we should check for the presence of '_reactPortalContainer' before adding another one. Will fix.\n - I can look for a place add the '_reactPortalContainer' that is more similar to where the '_reactRootContainer' is added.\n - Will wrap the '_reactPortalContainer' addition in a __DEV__ check.\n - I could rename '_reactPortalContainer' to 'unstable_reactPortalContainer' to additionally show that it's not to be relied on.\n - Agreed in general that it feels odd; if there is another way to determine whether the parent is a portal I'd rather use existing code, but didn't see anything else that was exposed there.\n\nI also wonder if this means createPortal(<div />, null) is going to throw (because containerInfo is null but is being accessed). Which I think ideally it should, but I\u2019m not sure if this is the case now.\n\nThat sounds about right to me, and I also would expect an error if I tried to pass 'null' as the container to createPortal. Hopefully this is a corner case, and if product code relied on it they could add a null check.\nWe only have one internal use case and  in that framework they currently create a new div element for the portalContainer and then they do set it to null when unmounting the component.\nSo if somehow createPortal was called after the portal component unmounted that would be a problem. I don't think that is possible with the current code but maybe it's worth adding a warning?. > It seems like if we change this to be a boolean then it\u2019s not a problem and we can always set it. Does it have to be an object?\nRight - making it a boolean now, and so that no longer needs fixed. I guess I meant that in the case that it was an object we should do that.\nI had thought that an object would be useful if we ever want to store more metadata on the portal container - but there is no reason to make it an object until then.\n\nI think we use unstable_ for actual APIs people might call. In this case something like __reactInternalIsPortalContainer would look better IMO.\n\nThat makes sense, thanks for the context! Will fix the name.\nI'm still looking for where to assign the __reactInternalIsPortalContainer property, and will push another commit shortly that fixes that and the other issues. Thanks for the dialog about this.. If it would be possible to write such a method, without adding a flag to the portalContainer node, then there must already be something we could look at here that would tell us if it's a portal. Is that right?. Ah, ok. Interesting.\nWhat is the advantage of adding another method to DOMRenderer rather than setting a boolean flag on the portalContainer node?. Does it help that we now do the mutating inside of ReactFiberCommitWork? That is where we do other DOM updates.\nIf we really want to avoid adding this flag then I can implement another method on DOMRenderer but I think @sebmarkbage's point that \"It's a bit awkward that we expose a new method on the public Reconciler API that is only ever needed for a specific DEV warning.\" is valid, and I'd rather avoid that.. Good point - talked more with @spicyj offline also and it looks like we may also just be able to change this spot to filter portals out, and then we might not need a new method?\nhttps://github.com/facebook/react/blob/7b9f64307d7d0d4e9df7f8e2316a2379d7c4bcdf/src/renderers/shared/fiber/ReactFiberTreeReflection.js#L245. ack - thought I had gotten that. Thanks. Removing now.. Why not pass in newChild and put typeof newChild !== 'function' instead of false?. nit - probably meant \"\\<MATH>\" not \"\\<mATH>\". awesome - thanks for adding a test!. nit - we could condense this and then link to docs, which could provide more info.\nI think we could always improve the error message in a follow-up commit, if this comes up often for folks.. ! Good catch! I'll update it. Maybe we can have it look for two occurrences of the search string.. Ack - yes, both of those should be removed from this diff. Will fix that.. Sure thing - I forget why I moved it out, will put it back.. I was copying what the babel transform would do - seems like a reasonable default. They would both default to false otherwise.\nSince it's not _root, it seems like it should be enumerable and configurable.. Sure - if you make a follow-up PR I can verify that it doesn't cause the issue with our integration tests.\nAlso +1 to what @spicyj said - we are happy to help find a repro case that is not just our internal tests. Thanks for your help on this!. I think this makes sense - like I said, we throw the same error for known attributes receiving a Symbol in 15.*. I can update the test.. Worth checking - I'll update this to include something like https://github.com/facebook/react/blob/master/src/renderers/dom/shared/tests/ReactDOMComponent-test.js#L26-L32 and that should clear the warning cache, right?. Will try adding the jest.resetModules stuff in a beforeEach and see if the warnings show up.. Oh nevermind - we already have that in the test.\nNot sure how else to force the warning cache to clear?. That was our conclusion, recorded in our notes, and I still question which is the right way. \nI think our logic was that if we filter out booleans for unknown props, then we would also consider changing that behavior for known attributes, and that would create more work to get this landed as well as more API changes for users.\nIt's true that, long term, we should probably stop stringifying booleans and filter them out.. This is a case we didn't test or discuss - I think this approach makes sense.. Just wondering - how do we know that this third param is optional? Seems like it always gets passed in.. Nit - we could prever setTimeout to setInterval.. That check does imply that - thinking we could update the Flow type here too in that case. Could be a follow-up PR.. We probably don't intend to merge this part, right?. :) fixed while you were reviewing. Cool - will look into that.. Thanks for updating everything while also moving these into the react repo!. dash-it-all, didn't mean to update this in this commit. Also not sure why it changed again. . Ok - good to know!. I think it would be nice to link to something - I find it a bit of a leap to send them to the Babel repl; it looks like the default doesn't have any React or JSX. https://goo.gl/d1eRN4\nEither way I'll put back the 'JSX is optional' comment.. Yup! On it.. will remove TODO. +1 will fix. Sweet - will fix.. Yes - that is the crazy thing. fields was coming up undefined in the graphQL result unless I made this change. \ud83e\udd37\u200d\u2640\ufe0f. \nwill fix!. Thanks - will remove for now.\nWhat if I got the diff in warnings between 15 and 16 and documented the changes? Could be a follow-up.. Edit: \nI see you did add a comment and link below - still might be good to comment here too.\n\nIt might be possible to make it a bit more 'React' ish. For now we could start by adding a comment and linking to the blog post that describes this fix for the iOS overscroll bug. (http://blog.christoffer.online/2015-06-10-six-things-i-learnt-about-ios-rubberband-overflow-scrolling/) . Sounds good! Will fix.. Sweet! I was struggling to find the groupings within 'major changes' and I really like those two. Will fix.. Yea - I was trying to find something to link to since we don't have docs yet but I can just say 'Docs coming soon' like in one of the previous points.. Seems like a good idea - not sure how easy it would be to add a warning for that, without doing something hacky like checking the caller.. Sounds good!. Kind of crazy that you could do this in the first place :D. Just curious - why not use 'figure' tags for all of these images?\nI am guessing we just want to avoid adding extra HTML to our markdown files as much as possible.. Can we put back the 'center' tag?. same here and below regarding 'center' tag.. It's sort of a shame to add more JS control over visibility to various components. I was brainstorming alternatives, but I think this is the best way I could think of.. I think we need a componentWillUnmount and to unbind this listener when the page unmounts, right?. Looks like window.matchMedia is not supported in IE9, so I'm wondering if we have a polyfill? Also I'm asking around to see if we have stats on how often that browser is used to visit our docs, so we can prioritize this kind of thing.. super-nit: I usually put newlines between method definitions. Not sure we are doing that in the docs code though.. > Because Gatsby's layout can't re-render its children\nI believe you, and I'm also curious about this. Won't dig into it much for now but would be curious if you have time to comment more about that.\nThis seems a bit complicated to me. Going to read through it again and make sure I understand what is happening with this context call. . This seems good, but it also makes me nervous;\n- how can we ensure that this will not catch touchMove events from within the menu overlay?\n- what if we somehow get into a state where isMenuOverlayOption is true but the user can't see the menu overlay? Can we add an invariant somehow to prevent that?\nI know these are not great suggestions - will try to come up with something more specific on my second pass at this.. Again - this makes me a bit nervous, so I might take some time to think about possible problems we might run into by catching this event here.. This does make sense - as a follow-up it would be nice to isolate in a wrapper component if possible, but no big deal for now.. I read through this again, and I'm still not sure why the onMenuOverlayToggle is not passed down via a prop instead of context? Then we could call this.props.onMenuOverlayToggle here. Context is fine too, but more obscure than just using props I think.. I see - didn't realize this was a limitation of Gatsby, that we can't pass custom props to the children of the template. Makes sense!. nit - extra newline. Just a reminder to fill in the 'TODO' links. :). Same as what @nhunzaker mentioned above - this should probably be a heading.. We probably want to turn these into nice markdown links.. Same here - should turn this in to a markdown link.. Header pls. Read the codepen - lgtm.. I like that this name change decouples this expiration time from the UI context in which it's used. What we really mean is 'this might never finish updating, and that's ok' and that may or may not be literally \"offscreen\" in the UI.. haha, I guess it's not a rename after all. (\"OffscreenPriority\" to \"Never\" expirationTime). Why is this added to ReactNativeFiberRenderer and not ReactNativeFiberEntry?. Sounds good - will fix.. We could probably check earlier - It's uncertain where in the process the parentNode is removed, so I'd rather leave it here until we know that.. Nice catch - thanks!. The only benefit is making the error more clear - in hopes that\nA) someone else might see it and realize their code is causing this situation.\nB) If we ran into it again it would be clear faster what is going on.\nIf we knew what situation caused this, we could add a link to helpful info, although so far it seems like an unfortunately high-visibility corner case.\nI think it would be nice to add a check for a parent if it's a commentNode in isValidContainer, which we use in several places to validate the container node. But again, not sure that would catch this since we don't know when the parentNode is getting unmounted.. I wondered that - would be curious how they actually get read by a screen-reader. Let me try to check that out.. Nice catch - we are fine with just the 'aria-label'. :). I love the sound of code being deleted ^_^. I don't think this filter call is doing anything?\nWe can probably delete that line.. At first I thought maybe we could use yarn upgrade here and combine with the later step, but it seems like that is different since it involves commiting change to the lockfile. Still wonder if they could be combined.. such a cute name! figlet~. This was a nice touch imo. \ud83c\udfa8. Gotcha - at first was confused because this is similar to yarn check but I see it's our own script here (https://github.com/facebook/react/blob/master/scripts/tasks/version-check.js) which will throw if the versions don't match. Nice.. This is really beautiful. I love the structure of this whole thing.. Maybe I missed it, but could we add a prompt after the 'release' to create the 'release' on Github? This is a separate step done via the Github UI.. Oh wait - is it stripping empty strings or something? Because of '' being falsy?. Suggested wording improvements, based on our IRL convo.:\n``\nEach person using this script will need to have their own CircleCI API token.\nTo make this token available to the release script, you can add it to yourbash_profile` like so:\nReact release script\nexport CIRCLE_CI_API_TOKEN=\n. Good idea! Will fix.. So this should call the constructor twice, right?. nit - update comment. YES! I was going to suggest starting with a concrete example, glad you added this here.. Firstly - What do you think of showing an example that passes through the value returned by the promise? Like so:\nconst PromiseSubscription = createComponent({\n  getValue: //...\n  subscribe: (promise, callback) => {\n    promise.then(\n      // Success\n      (v) => callback(v),\n      // Failure\n      (v) => callback(v)\n    ).;\n  },\n// ...\n});\n```\nSecondly:\n\nNote that it an initial render value of undefined is unavoidable due to the fact that Promises provide no way to synchronously read their current value.\n\nTrue; unless you're overly clever! :D \nlet savedPromiseValue;\nconst PromiseSubscription = createComponent({\n  getValue: promise => {\n    // we have saved the promise value from when it was last updated\n    return savedPromiseValue;\n  },\n  subscribe: (promise, callback) => {\n    promise.then(\n      // Success\n      (v) => {\n        savedPromiseValue = v;\n        callback(v);\n      },\n      // Failure\n      (v) => callback(v)\n    );\n  },\n// ...\n});. Those types - nice!\n. Just curious why we define the types here rather than outside this method - it means they would be re-recreated every time this is called, but since it probably won't be called often not too worried.. We should save any subscription reference here too, right? See my later comment in 'componentDidMount'.. Nit: Why not pull in the real RxJS as a dev dependency?. ReactNoop makes this kind of test so much easier :). Yes! It's the clever way \ud83d\udd27. Right - sorry, meant to delete that comment.. nit - 'This utility is should' -> 'This utility should'. Nit - this bullet could be reworded for clarity, something like this:\n\nComplex libraries like Relay/Apollo should manage subscriptions manually with the same techniques which this library uses under the hood (as referenced ..)) in a way that is most optimized for their library usage.. What if we call it 'getCurrentValue'?\n\nWe could also add a note in the comments saying that this value will be read repeatedly as the component re-renders.. The return value here is really important - what do you think of adding JSDoc style comments above each method, showing it's expected params and return value? Just for this example, not all the following ones.. Do we support returning false? Looks like we expect it to be a function.. I like that! Will fix.. Thanks - will update the comment.. In the old version were these two tests identical?. Good point!\nI will write some tests around this and take it into account.. We may need to keep a queue... -> We keep a queue.... So, this method is supposed to return a number, and it seemed to me it should return the request id from the rAF call. But I can remove that change if it needs further discussion.. Realized this doesn't quite make sense, because sometimes the initial rAF call just schedules a new rAF call, so even if you got the id of the first call, and called 'cancelAnimationFrame' you might not cancel the overall chain of rAF calls.\nI'll just always return 0 as a compromise, but really the return value doesn't mean much and I'd rather drop the return value.\nIt depends on how the 'cIC' method will work once we support serial and deferred callbacks. If it takes the callback id, then returning a number from 'rIC' makes sense.\nReturning an id which could be used to cancel the callback might be useful, but it depends how we implement cIC for deferred priority callbacks.. It looks like lots was rewritten but really I just wrapped the existing tests in a new 'describe' block. Would separate this into a different PR ideally.\nThe only real change is that new tests were added at the end.. Above we have startTime as the first argument in the computeExpirationForFiber type, and here we have currentTime as the first argument. Is that intentional?. Not sure I'm satisfied with this method of handling errors. We shouldn't swallow them, but don't want to throw when we may be in the middle of a queue of callbacks.\nExposing an 'onError' handler eventually maybe? Or taking an 'onError' option.. We discussed this in person and considered using postMessage to either throw the error sooner or even to create a postMessage event for each callback, so that errors could be thrown without interrupting the queue of callbacks getting called.\n@sebmarkbage we would like you to make the call on whether the setTimeout is good enough for now, or should we explore using postMessage or some other approach?\nI also considered saving the errors and just throwing them once we finish whatever is in the queue.. @acdlite pointed out that having this block, then setting up the next callback, and then calling previouslyScheduledCallback below is confusing. Going to restructure this for clarity, so that we handle all logic related to the previous callback in one conditional block instead of two.. Thanks @acdlite for pointing out we can assert expect(callbackLog).toEqual(['A', 'B', 'C']);. Had forgotten that matcher checks every item of arrays and objects for equality.. @sebmarkbage would like your input here, I think this is the last thing to decide before landing this PR. My previous comment here:\n\nWe discussed this in person and considered using postMessage to either throw the error sooner or even to create a postMessage event for each callback, so that errors could be thrown without interrupting the queue of callbacks getting called.\n@sebmarkbage we would like you to make the call on whether the setTimeout is good enough for now, or should we explore using postMessage or some other approach?\nI also considered saving the errors and just throwing them once we finish whatever is in the queue.\n. We talked a bit more and decided the 'try/finally' trick won't work, because a 2nd error thrown in the queue will get swallowed.\nGoing to look at alternatives, based on what we currently do in React to handle errors.. \n\n. We will later refactor this for error handling, but for now this works.. It is laying the groundwork for support to multiple callbacks, yes. I have a follow-up PR that implements that support, just breaking things into multiple steps.. Regarding the comment - it's outdated, will remove either in this PR or the next.. Sebastian said in our last discussion to not use a Map, mainly to avoid dependencies on polyfills.\n-> We don't use 'Map' because this library is intended for use outside of React, don't want to add dependency on a polyfill if we can avoid it.\nin the previous PR in the stack.. The nesting is because a callback in the list might time out while we are in the process of calling other callbacks.\nExample:\n- We have callbacks [A, B, C] and B has timed out.\n- We call B. It takes a while to run, and while it is running A times out.\n- We finish our loop by checking C, but we don't know that A has also now timed out!\nSo that's why we keep looping until we verify that nothing has timed out.. Was being cautious, but if we can skip the feature flag that is simpler.. Discussing in person, we agreed that it could just get pushed into the next tick if something times out while one cb is running.. Will remove, thanks!. This does eventually get called in multiple places, and will be more complex once we implement error handling.. We still could use a linked list. Is the potential size of the map a concern?. I like the efficiency. Would be curious to know more about the efficiency of deletion in a Map or object. It sounds like the slowest way is to search in an array and delete with splice, then the next fastest is deleting from a Map, and then even faster is using a linked list.\nIt's possible that other users of this API are relying on the fact that the 'id' returned is typed as a number, but seems unlikely. I had initially avoided changing the type because it introduces inconsistency in our API for how the 'cancel' method works in our renderer in general.\n. oops. I plan to improve the API for writing these tests; instead of drainPostMessageQueue and runRAFCallbacks it should be more generic and descriptive, like so:\n```\nconst shorterTimeout = 2;\nconst longerTimeout = 100;\nscheduleWork(callbackA);\nscheduleWork(callbackB, {timeout: longerTimeout});\nscheduleWork(callbackC, {timeout: shorterTimeout});\n// generic API for advancing a frame and configuring how much idle time there will be\nadvanceByOneFrame({timeRemaining: -1 * (longerTimeout * 2)});\n// idle time was negative, so there was none and we passed the timeout threshhold for the shorterTimeout\nexpect(callbackLog).toEqual(['C']);\n// ... etc.\n```. Thanks - that is useful! Will keep it in mind if we end up keeping the map/array approach.\nI have a PR that moves this to a linked list1, but before landing that needed to open a PR to increase test coverage.[2]\n[2]: https://github.com/facebook/react/pull/12858. :( I noticed that. We could either consider it as inline documentation for now, or I can replace it with comments in order to avoid a false sense of security.. Let's discuss this in person - the tldr is that we sometimes want the 'callbackIdType' to be a number, sometimes the CallbackConfigType, sometimes something else.. That's true - if it's more clear will write it that way.. I can try to rewrite it this way, think we can still make Flow happy.\nMight be ok with concise > clear in this particular module, but for now let me try the more clear way.. Rather than keeping and updating the 'size' property here, could we rely on the size property of the map attribute of the cache?. Just one thing - I think even if 1, 2, and 3 are also evicted I think this will still pass. We could verify that those don't throw Promises?. It is complicated, agreed.\n\nDo we want to keep this fork long term? Is there a better fix in mind? How will this ultimately work in open source when the package is ready?\n\nHere is my understanding of how it will work - \n- Once the schedule API is stable, we publish it as a separate module and make it a dependency of react-dom and react-art. In OS people just pull in the schedule bundle via npm, and it uses the native requestAnimationFrame.\n- We would still need something like this for the 'www' build of 'react-dom', because we still have the problem with our 'requestAnimationFrame' polyfill in 'www'. Some of the behavior of the polyfill doesn't work, but some of the custom behavior we still need. I think at that point we can get away with the following simpler approach in 'www':\n    - we still require 'schedule' before the polyfill runs, which means 'schedule' pulls in the native rAF and uses it.\n    - In 'www' we write a wrapper module that adds the 'timeSlice' wrapper to 'schedule' itself, which we still need, and React would grab the wrapped version. Not sure if we'll still need a fork/shim for that to work.\nIt took a lot of discussion to agree on this solution, I'm hesitant to go back to the drawing board when we have something that works. \nRegarding my original solution of just shimming 'requestAnimationFrame' itself in our 'www' build - @sebmarkbage had concerns that we should not be using the polyfilled version of 'requestAnimationFrame' at all in 'www', and that the best way to avoid pulling in the polyfill was to require the schedule module before the polyfilling happens.\n. Actually, if we just wrap the 'callback' before we pass it into 'scheduleWork' at every single callsite, or even if we just expose a wrapped version of 'schedule' for non-React use within 'www', then I think we can still avoid a fork of 'schedule'. After we publish it as a separate module, that is.. edit: looking again, maybe it's not a Flow error if we do window.Date like you actually suggested. Still feels weird but less weird than const Date = Date;.\n\nJust one thing - which I think is why I did this in the first place. It's a Flow error, and seems like bad practice, to use a variable name which is also a global keyword.\nI could do RequestAnimationFrame but that seems easier to be confused about. The local prefix means this is the local variable holding a reference to that API.. Going to land this PR, we can fix these in a follow-up.. Absolutely - thanks!. Nit - we could explicitly flow type the return value; Array<ReactTestInstance | string>. \nAlso I see that this was copy-pasted from the getChildren method below. Wish there was a docblock, it's not very clear to me why this works the way it does. But that could be for the future.. Granted this is copy-pasted - but wondering if you know, why do we mutate the fiber instance to set it's return here?. nice\n\n. I'm sure it will become clear as I continue reading, but I was surprised that this method mutates the nodes and goes down to potentially get deeply nested children.. Good question~! It's arbitrary - seemed like enough time to have lots of numbers increment, but not too fast to see.. Interesting - we do always check for 'DEV' before doing this, seems fine to inline the 'DEV' check.. Agreed, I like throwing the more specific error first.. ",
    "kevinslin": "yep, definitely. changed and pushed\n. ",
    "RobertKielty": "Will do.\n. Fair enough, Paul, it was the change I was most iffy about, this change looks ugly and your assessment is correct. I'll drop it.\n. I'll do it now.\n. @zpao I have to disagree on this. I think we should take our cue from ICANN and not the Associated Press and definitely not the New York Times. This is particularly apposite given the point being made in the documentation. Cross site scripting is a problem on The One and Only Global Internet In Use By Us All but it may not be a problem on an internet that you own yourself and no one else has access to. See https://en.wikipedia.org/wiki/Capitalization_of_%22Internet%22 \nThe more substantive problem with this edit is that the link to the XSS PDF appears to be broken. Perhaps it should point to the Wikipedia or an OWASP page on the topic, I'll dig out a couples of refs tomorrow. \n. ",
    "jshawl": "how about:\n\nNotice the use of the arrow function - =>: we're ensuring this inside the map() refers to the GroceryList. This is not a new React concept; it's just JavaScript.\n. \ud83d\udc4d Would you like me to rebase and push?\n. \n",
    "qiuyuntao": "@keyanzhang \u8fd9\u6bb5\u8bdd\u611f\u89c9\u4e0d\u662f\u592a\u597d\u7ffb\u8bd1\u3002\u80fd\u5426\u5e2e\u5fd9\u770b\u4e0b\uff0c\u6211\u6574\u7406\u540e\u7684\u5185\u5bb9\n\n\u53e6\u4e00\u79cd\u6765\u8ddf\u8e2a\u6570\u636e\u53d8\u5316\u7684\u65b9\u6cd5\uff0c\u662f\u901a\u8fc7\u8bbe\u7f6e\u6807\u8bc6\u7b26\u6765\u505a\u810f\u6570\u636e\u7684\u68c0\u67e5\u3002\u8fd9\u79cd\u65b9\u6cd5\u7684\u95ee\u9898\u5728\u4e8e\uff0c\u4f60\u53ef\u80fd\u4f1a\u4e3a\u4e86\u5b9e\u73b0\u8bbe\u7f6e\u6807\u8bc6\u7b26\u800c\u5199\u4e86\u5f88\u591a\u989d\u5916\u7684\u4ee3\u7801\u53c8\u6216\u8005\u5728\u4f60\u7684\u7c7b\u4e0a\u8bbe\u7f6e\u8fc7\u591a\u65b9\u6cd5\u3002\u8fd8\u6709\u4e00\u79cd\u65b9\u6cd5\uff0c\u4f60\u53ef\u4ee5\u5728\u64cd\u7eb5\u4e00\u4e2a\u5bf9\u8c61\u4e4b\u524d\u5bf9\u5b83\u8fdb\u884c\u4e00\u6b21\u6df1\u590d\u5236\uff0c\u4e4b\u540e\u518d\u505a\u4e00\u4e2a\u6df1\u6bd4\u8f83\uff0c\u6765\u5224\u65ad\u8fd9\u6b21\u64cd\u4f5c\u662f\u5426\u6539\u53d8\u4e86\u5b83\u3002\u4f46\u662f\uff0c\u8fd9\u79cd\u65b9\u6848\u5bfc\u81f4\u7684\u95ee\u9898\u662f\u5728\u505a\u6df1\u590d\u5236\u548c\u6df1\u6bd4\u8f83\u7684\u8fc7\u7a0b\u4f1a\u975e\u5e38\u635f\u8017\u6027\u80fd\u3002\n. \n",
    "vigneshshanmugam": "Is all those checks necessary? Can't we simply check 'mark' in performance or 'measure' in performance and just assume the User Timing API is supported? \n. Not sure if its a overkill. But wanted to confirm if there is any weird behaviour with any browsers. \nTotally agree on that point \ud83d\udc4d\n. Cool. Sounds good. \n. ",
    "Jessidhia": "Maybe just add a // not a default export comment before the export const Foo line?\n. \"or your module system's export mechanism\"?\nThe documentation either has to pick a canonical modules system, or it'd need use cases for ES6, commonjs, AMD...\n. That is correct; DOMStringMap (the backing type for .dataset) always only holds string values.. However, the overwhelmingly majority of serious web projects, React or not, will have a build step anyway, if only to minify code \ud83e\udd14 . Does this also mean that it is always safe to return this.props.children in render for the components that do it, without wrapping it with React.Children.only?. Does this work with any Node (e.g. can an svg element be a parent), or only with HTMLElement? If the latter, naming it htmlElement might be clearer. One of the breaking changes for client-only rendering I noticed in React 16 is that it does not empty the root element before rendering.\nLuckily I noticed it early enough at work, before other people tried to write HTML inside mount points (loading spinners et al) that were intended to be deleted when React rendered.. Does this also mean that returning null from a setState function (e.g. this.setState(() => null)) will avoid triggering an update? Does this also apply to undefined so () => {} (and early returns) would work as well?. Not a link (works in comments but doesn't work in .md files IIRC). Does React stopPropagation of the original DOM event itself once it reaches the element controlled by the portal, or does the DOM event continue on its own?. I'll check again at work tomorrow, but it could be caused by my particular use of portals.\nI'm using many portals to render different components at different mount points in a legacy website (not SPA) while sharing a common context; it's possible that I had noticed this detail in a portal instead of regular render (I'm using a custom component that delegates to createPortal if available, otherwise uses renderSubtree on lifecycle events).. This also affects the initial render time, because you first must build the createElement tree, then diff it against the DOM (which should be missing everything), then commit it.\nThis is mitigated by doing server side rendering, of course.. Doesn't Fiber already require a Map polyfill? Or does that not include WeakMap?. yarn seems to have a bug where it occasionally alternates between registries on some packages; not sure what causes it, but I've seen it once in a while. IIUC, it would cause v8 to store the field in a double, even if you flag it as an int through the |0s.. There might be a slight performance benefit to not do the shortcut, even with a code size penalty, because foo != null is basically equivalent to foo !== document.all && foo !== null && foo !== undefined.\nWelcome to document.all :psyduck:. Would be nice if there was a way to validate that all the enumerable keys from source were indeed copied to target, but where would you put it? __DEV__? :trollface:\nAny way to write a test to see if nothing is missing, or not all fibers have the expected properties?. Perhaps this could be disabled on StrictMode?. Why not import * as Children from './ReactChildren'; export { Children };? If ReactChildren exports only the public API, this would allow for tree shaking.. : undefined. This does not allow both unless you're using babelmodules; please don't write things for babelmodules other than maybe in a compatibility bundle. Write things to work on real modules.\nReal ES modules will only be able to import * as React from from the non-transpiled version, and only be able to import React from from the transpiled version. This is why it's important to have a .mjs entry point, so that every place is able to do import * as React from correctly.\nIf you want to still preserve import React from even in the .mjs entry point you're going to need an export default { ...list of all the exports }.. The type of hasSymbol is typeof Symbol.for | false so maybe hasSymbol could be used directly to create the symbols and save bundle size?\nhttps://tc39.github.io/ecma262/#sec-symbol.for Symbol.for doesn't look into this at all so maybe renaming it to SymbolFor and doing SymbolFor ? SymbolFor(id) : fallBack would save space.\nCertainly a lot less space saved now that you refactored it, though.. Interesting; this also means that you can't use the usual const { Provider, Consumer } = React.createContext() pattern with hooks.. Only namespace reexports are tree-shakeable by webpack; by storing the result in an actual object you prevent webpack's tree shaking.\nEven if it somehow does work anyway, you're still creating an unnecessary additional object that doesn't follow the rule of namespaces (no null prototype for example).. IMO, it's best to only treat undefined as undefined, similar to argument/destructuring defaults. null is an actual value that is defined to be \"the empty value\", typeof bugs notwithstanding.. useImperativeMethods specifically only works with ForwardRef too. I opened a related issue at https://github.com/facebook/react-devtools/issues/1213.. In __DEV__, could this be made into a getter that would throw if code is missing from the event?. The same could be accomplished, without requiring a constructor or making this more difficult to convert to ES modules, by just using conditionals for each assignment.\njs\nReact.ConcurrentMode = enableStableConcurrentModeAPIs ? REACT_CONCURRENT_MODE_TYPE : undefined;\n// et al. \ud83d\ude22\n(tangentially, it'd be great if an ES modules export was made available in time for 16.7, especially with all the additional commonly used exports exposed by hooks). More of a question: would it be better to write this function inside the effect callback instead?\nSupposedly, the engine would only have to evaluate the function declaration when the effect callback is called, but I'm not sure it'd help anyway as it'd still have to create the shared closure object.\nAt any rate, writing it outside the component entirely would definitely be better.. Didn't know you could use this in tests too \ud83e\udd14 \nDo tests get run twice for this, or does it just always take one of the paths?. Just a clarification: in TypeScript, a () => void function is actually allowed to return anything (like () => any), you're just not allowed to look at the result. Does this mean the same thing in Flow, or does Flow ensure that () => void can only have void returns?\n*: the workaround to force an actual void function in TypeScript would be () => void | undefined. This sounds like a race condition to me \ud83d\ude13. Assuming this is an eslint@5 plugin, then yes as it's supported since node 6.\n(Unless there are specific rules against it here?). Would be nice to refer to this assumption on the initial site where this is set. \"renderWithHooks / resetHooks assume they are the only code changing it\"?. (I still don't understand what's the purpose of a useMemo that doesn't receive any deps). Why not switch the dispatcher back to the ContextOnlyDispatcher? Or rather, why downgrade it to just a warning in dev if it's just as invalid to be reentrant and will crash in prod? If it was still kept as an error you could use a dispatcher that just throws the right error on all hook invocations, it'd make state saving/restoring not have to vary between different hooks either; essentially continuing the pattern that you're adding here to begin with.\nIf the pattern for all hooks is just made to be changing the dispatcher (and currentHookNameInDev) these could also all be factored into a higher order function. useMemo: wrapForDev('useMemo', mountMemo), et al.. Also: before jest.runAllTimers() it should be '4'.. Whe I wrote my own hackish tests I cheated by just doing two interactiveUpdates batches :innocent:. If you don't make it return a Promise now, you can't make it accept an async function later.\nOr, well, you can, but it'll be a breaking change.. in sync with...?. \ud83e\udd2f\nThis will work for passive effects but we'll probably need something else for ConcurrentMode.\nI guess that's where the potential Promise-based API change would come in.. One thing that confused me when I was reading this: is this before or after the nextRenderExpirationTime?. \"during the current render\"? \"as the current render\"? \"with the current render\"?. This is IIUC an inlined version of:\nts\nreturn runWithPriority(\n  Math.min(NormalPriority, getCurrentPriorityLevel()),\n  eventHandler\n)\n?\nWould be nice to be able to treat it more as a continuation; there is already support for it in the scheduler after all... but continuations would inherit the current deadline, defeating the point. Would it work if the continuation itself was wrapped with wrapCallback?\nAt any rate adding non-imperative continuations to React event handlers is likely a breaking change.. When I was reading this code last week I was wondering how you'd be able to mess with the schedulePassiveEffects priority. Doesn't seem normally possible... unless you cause a Sync update I guess.... I thought of adding the warnings to mountRef / mountState / mountReducer instead but, because of how the dispatcher is invoked, by the time things reach them the arguments.length will already be 1 (or 3). ReactHooks.js is the only place that sees the arguments exactly as provided by the user.. This will leak the semaphore if the act rejects. Should be in a .finally call (or one emulated with .then(cb, cb).. An option to support some interleaving is to instead only do the check if you were the call that first acquired the semaphore (assert that first in is also the last out), but I'm not 100% sure that is safe.\nAlso not sure how that interacts with possible interleaving with e.g. concurrent jest tests.. You can just use useContext here, the readContext is if you need to access the context from outside the render pass.. Rather, I assume most of these tests predate hooks. The code for the useContext hook is literally just this readContext, the only difference is it creates a node in the memoizedState linked list.. Maybe this could also be space for a future \"sorted-deps\" rule? \ud83e\udd14. A possible heuristic is to guess that hooks which receive a callback followed by an array as their last argument are following the useMemo pattern. This kinda runs into that issue I mentioned in an earlier comment. It may be valid to use the latest value of a local but only reacting to a specific value changing. I know I wrote something that used this property recently but I can't remember what...\nAt any rate, it would be good to opt out of specifying a specific value without disabling the rule for the entire array. Perhaps it could be possible to write something to let the rule know you know about it? My first idea would be just having the identifier present inside the array but commented out, but I'm not sure eslint lets you consume comments that easily. Here's some partial source code where I ended up having to break this rule. You can see it in the last useEffect's effect list -- basically, I want this effect to run after the update is called by a dispatch to setCurrentState. However, it should not run on initial mount, or when setCurrentState was invoked by the previous effect which synchronizes the internal-only page with the memoPage.\n```ts\nfunction useCurrentPage({\n  location,\n  marker,\n  replace\n}: Pick) {\n  const { hash } = location\n  const memoPage = useMemo(() => {\n    if (!hash || !hash.startsWith('#')) {\n      return 1\n    }\n    return Math.max(\n      1,\n      parseInt(hash.slice(1), 10) || getPageFromChapterId(hash) || 1\n    )\n  }, [hash])\n  const [page, setCurrentPage] = useState(memoPage)\nuseEffect(() => {\n    setCurrentPage(memoPage)\n  }, [memoPage])\nuseEffect(() => {\n    // ignore if it was an update from the synchronization above\n    if (page === memoPage) {\n      return\n    }\nif ((!page || page <= 1) && marker === null) {\n  replace({\n    ...location,\n    hash: ''\n  })\n} else {\n  replace({\n    ...location,\n    hash: `#${page}`\n  })\n}\n// uses latest data but only triggered by setCurrentPage changes\n\n}, [page])\nreturn [memoPage, setCurrentPage] as [typeof memoPage, typeof setCurrentPage]\n}\n```\nIt's certainly possible I just didn't think this through well enough, but it looks unavoidable. Adding marker to the dependencies list could cause unwanted updates because, on the initial pass, page won't have been synchronized yet.. The rubber ducky debugging might have struck again, because it looks like the page === memoPage check in the effect is also sufficient to guard against unwanted updates to marker or location. However, it'd still be a problem to have memoPage in the dependencies list -- the effect would run before the synchronization, used to detect whether setCurrentPage was dispatched from inside or from outside, happens.. ",
    "camspiers": "null | ReactSyntheticEvent -> ?ReactSyntheticEvent\n. Ignore me, I guess ?ReactSyntheticEvent would also include undefined and I guess you aren't wanting that.\n. ",
    "ivanzotov": "@gaearon \u041f\u0435\u0440\u0435\u043f\u0438\u0441\u0430\u043b \u0441\u0432\u043e\u0438\u043c\u0438 \u0441\u043b\u043e\u0432\u0430\u043c\u0438, \u043d\u043e \u043d\u0435 \u0441\u0442\u0430\u043b \u0440\u0430\u0437\u043c\u0430\u0437\u044b\u0432\u0430\u0442\u044c, \u0447\u0442\u043e if-else \u0432 \u0438\u0442\u043e\u0433\u0435 \u043f\u043e\u043f\u0430\u0434\u0435\u0442 \u0432 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b \u0438 \u0442.\u0434., \u0434\u0443\u043c\u0430\u044e \u0434\u043e\u0441\u0442\u0430\u0442\u043e\u0447\u043d\u043e \u0441\u043e\u0441\u043b\u0430\u0442\u044c\u0441\u044f \u043d\u0430 \u043f\u0440\u0438\u043c\u0435\u0440.\n. @gaearon \u043f\u0435\u0440\u0432\u043e\u0435 \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u0435 \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u0441\u043b\u0438\u0448\u043a\u043e\u043c \u0434\u043e\u0441\u043b\u043e\u0432\u043d\u043e \u043f\u043e\u043b\u0443\u0447\u0438\u043b\u043e\u0441\u044c, \u0432\u043e\u0442 \u0435\u0449\u0435 \u043f\u0430\u0440\u0443 \u0432\u0430\u0440\u0438\u0430\u043d\u0442\u043e\u0432 \u2013 \n1. \u0412 JSX, \u043e\u0434\u0438\u043d\u043e\u0447\u043d\u044b\u0439 \u0442\u0435\u0433 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u0442\u0441\u044f \u043a\u0430\u043a <MyComponent />, \u043d\u043e \u043d\u0435 <MyComponent>.\n2. \u0412 JSX, \u0443 \u043e\u0434\u0438\u043d\u043e\u0447\u043d\u043e\u0433\u043e \u0442\u0435\u0433\u0430 \u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u0437\u0430\u043a\u0440\u044b\u0432\u0430\u044e\u0449\u0438\u0439 \u0441\u043b\u0435\u0448 <MyComponent />, \u0430 \u043d\u0435 <MyComponent>.\n. \u0412 JSX, <MyComponent /> \u0432\u0435\u0440\u043d\u043e\u0435 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \u043e\u0434\u0438\u043d\u043e\u0447\u043d\u043e\u0433\u043e \u0442\u0435\u0433\u0430, \u043d\u043e <MyComponent> \u043d\u0435\u0442.\n. Fixed\n. /src/renderers/native and /src/renderers/shared links exists in the master branch\n. It seems like it should be fixed to the stack folder /src/renderers/dom/stack/client and /src/renderers/dom/stack/server\n. Also it seems that react-bower package isn't updated yet. ",
    "gabro": "@vjeux @gaearon I took a stab at documenting this: https://github.com/facebook/flow/pull/2465\nBy the way, judging by a comment in the source code, it looks like $Keys is preferred to $Enum, which should be removed: https://github.com/facebook/flow/blob/master/src/typing/type_annotation.ml#L247\n. ",
    "SalehHindi": "I want to make a devtool hook as suggested but I've never made a react devtool hook before. Could you elaborate on the general process for making a devtool? \n. ",
    "havenchyk": "Fixed. Pushed with --force, but it looks like new github's review tool doesn't understand it.\n. ",
    "jessebeach": "Certainly. Good call.\n. Great suggestion. I added the changes to address this change request.\n. \"Accessibility support is necessary to allow assistive technology to interpret web pages.\". \"People who experience disabilities only fully benefit from websites when they include accessibility features\".\nThis phrase feels a bit contentious. I can't come up with a phrasing that doesn't have \"othering\" connotations or undertones of condescension. Let's just stick with a factful sentence about the technology as written above.. \"The following WCAG checklists provide an overview\". \"directly used in React\". Skip past navigation sections, not content sections, right?. Seems like a duplicate of section \"Mechanisms to skip to desired content\" above. Combine?. \"after that modal window is closed\".\nDereference the anaphor. . I'm hesitant to include this example. We really shouldn't encourage folks to call focus on an element on an onClick event. \nMaybe remove the example code and just point to react-aria-modal.. Thank you for including this note :). Could be rolled into thereact-axe section above.. Again, could be rolled into the react-axe section above.. Should be rolled into the \"Colour contrast\" section above.. \"but ARE also exposed to screen readers\".\nMaybe just cut the last sentence altogether. Up to you. Labels aren't required to be visible, although it's definitely preferred.. @spicyj, is ReactDOM.findDOMNode discourage in the latest best practice?. ",
    "ssorallen": "Would it be useful to link to the ES6 Classes docs in these notes? Without more description, someone might be lost when they find this and wonder how they should handle initial state if not with getInitialState.\nES6 Classes: https://facebook.github.io/react/docs/reusable-components.html#es6-classes\n. @yaycmyk Since getInitialState was a bound function in which components did calculations of state based on props, I'd suggest the constructor over a property initializer for state. It's most similar to getInitialState.\n. > You can do basic setting based on props with initializers.\nYup definitely. These are the docs pointing away from getInitialProps though, so I'd suggest the best analog: the constructor. I can imagine more questions if this instead pointed to property initializers asking how to do more complicated work for initial state than expressions will allow.\n. ",
    "ventuno": "Good idea, @donavon. Thanks a lot, I implemented your recommended change :-).\n. ",
    "i1skn": "Yeah, also I figured, that there https://github.com/facebook/react/blob/master/src/renderers/dom/client/eventPlugins/SimpleEventPlugin.js#L152 we already has this logic, but I do not know good place to move it, so we can reuse it, any ideas?\n. ",
    "kevinSuttle": "https://github.com/facebook/react/issues/7287\n. ",
    "ericnakagawa": "The font size for h3 is massive relative to body copy.\n. This is great feedback. I considered switching to text links. Thanks @zpao and @acdlite \n. @spicyj community@reactjs.org now forwards to a support tool called HelpScout. This tool allows managing inbound emails by multiple team members. The advocacy team will review/respond when people write in to provide feedback/suggestions for this new series.\n. @gaearon Bad merge, had to back out of it. This PR should reapply the changes you made.\n. Changed.\n. Thanks for spotting. Fixed.\n. Will rewrite this section.\n. Good idea. I've swapped around data per your suggestion.\n. Replaced.\n. I will rewrite this section to be clearer.\n. Changed.\n. Good call. I've rewrote as functional components to simplify.\n. I've redone the example to include a key from beginning.\n. I removed this example.\n. I've include keys from first React example.\n. Going through now and updating terms -- hoping I got this right.\n. Converted this and another examples to be stateful.\n. Fixed.\n. Fixing all fn calls\n. Makes sense, rearranging.\n. Moving this to top.\n. Rewrote.\n. Switched to normal links.\n. Removed link at end and moved link to map().\n. I had something similar prior. Adding back.\n. Applied second array in first 3 examples.\n. The Codepen is written in a Functional Component, this example wasn't updated properly. Fixed.\n. Converted example 2 to Functional component and focused only on item 1 in list.\nI added a small section on Incorrect/Correct key usage.\n. I'll expand the example to include an id and use that instead.\n. I've modified examples to pull from an id from sample data array.\n. Removed.\n. Removed.\n. In older docs, /react/docs-old/multiple-components.html -- it mentioned that this was how it reconciled multiple objects.\n. Changed.\n. Done.\n. Added.\n. Added.\n. Added.\n. Changed.\n. Changed.\n. Removed.\n. Split up.\n. Removed.\n. Removed.\n. Moved Multiple Component example to top, and followed your guide for introducing each level.\n. Changed.\n. I modified the WarningBanner example to check a prop and return false if the prop.warn value is false. I think this better demonstrates not rendering of a component.\n. Adding white space to these.\n. breaking this apart, too.\n. Good idea.\n. Changed.\n. Moved ternary up.\n. I added an example to Conditional Rendering.\n. Copy changed.\n. Fixed.\n. Fixed.\n. Fixed.\n. Fixed.\n. Fixed.\n. Fixed.\n. Fixed.\n. Fixed.\n. Fixed.\n. ",
    "gilchenzion": "@zpao sounds good. Just updated.\n. ",
    "shrayasr": "Probable typo with iports here? \n. Thank you for writing such a detailed guide :+1:\n. ",
    "lacker": "You can't actually go to localhost:4000/react, that 404s\n. Yeah good point I'll rename\n. ok i took most of your wording here\n. that's weird man but ok\n. I'll change this wording. What is actually the best way to build e.g. a Rails + React non-single-page app? It seems like it might actually be to start with Create React App. But I dunno for sure so I'll hold off on that for now. \"Building a new non-single-page-app\" seems like it's one of the key omissions here at the moment, but I don't know what to recommend.\n. ok changed this sentence\nI kinda like mentioning webpack and babel though because a lot of people just think \"oh i have to set up webpack myself\". But shrug\n. I looked around but it wasn't clear to me what were good Node / Rails tutorials that adhered to best practices. Do you have particular suggestions that you like or have heard good things about? If not, maybe we should just let people Google around themselves.\n. OK fixed\n. OK\n. OK\n. ok\n. ok\n. ok\n. Do you think it would be more similar to real usage if you used document.getElementById('root') or similar here, rather than mountNode?\n. how about just using concat to avoid ...\n. Also - wasn't someone talking recently about, you shouldn't use this.state.foo in setState, because there's some race condition if you do it twice per update cycle? I really prefer the look of this code, but, I just want to make sure we're not suggesting something buggy.\n. fixed\n. Hm ok I stopped saying \"JSX element\".\n. OK\n. I ditched the import and cut it down to one example instead of two to de-emphasize it. I'd like to keep this here though because this section of the document is explaining \"all the ways to specify the element type\".\n. OK\n. OK rewrote this part\n. Fixed\n. OK\n. I'm just going to delete it - it probably belongs more appropriately in somewhere that discusses \"components vs instances vs elements\" rather than \"all about jsx\" because it's not really jsx-specific\n. fixed\n. OK I added a section about whitespace\n. Fixed\n. fixed\n. fixed\n. OK I just took this wording exactly\n. Yeah this is intentional because downloading the file from your browser will default to naming it the title of the page, and if there's spaces and a ! in it, it's annoying to open it in CLI editors. At least that's how I felt when actually using it to try out some examples.\n. OK I switched to use an example like this\n. Fixed\n. OK i think this part is correct now. Updated the examples too\n. OK\n. OK\n. OK\n. I like your example. Added\nHmm, this seems like a super logical place to mention that true is ignored... I'll just mention it here.\n. OK\n. This code block is the only place we use React.createElement and I'd like to have it in one place so it's clear that it doesn't compile to the 'e' thing. How about I make this part specifically say, you can compile out the JSX\n. OK\n. OK\n. OK\n. OK\n. OK****\n. I tweaked the wording a bit. AFAICT this behavior is useful so that\nFoo & Bar\nworks the same way in HTML and in JSX - you need an unescape because JSX will re-escape it later. I'm guessing someone implemented this for children and just implemented it for all string literal props at the same time? Dunno though. Seems like a historical wart.\n. OK - yeah I didn't intend that part to explain functions, only to explain loops, so I turned it into a one-liner. Also added that post-explainer\n. OK\n. i just switched this to be more realistic rather than \"blorp\"\n. fixed\n. fixed\n. OK I just removed that \"oh but this makes sense for children\" comment.\n. I think you could skip this caveat - when you're learning JSX this is going to be a distraction.\n. Maybe you can skip this caveat too? It just might not be needed for an intro.\n. Maybe just leave out this section - most people who are learning stuff, they don't need to know more about JSX at this point, they need to start learning about props and state.\n. I think this sentence is too anti-JSX. JSX is great and our docs should emit love for JSX. I would be ok just ditching this note.\n. Do the codepen things need to be emphasized with ** ? I think it will make the page feel a bit more cluttered.\n. I think period-inside-quotes is nuts, it's just like a mistake some professor of grammar made while codifying English grammar. Let's do period-outside-quotes.\n. You're skipping step 2\n. Are these names?\n. UIs dynamic -> UIs are dynamic\n. english nitpick: recommend to refresh -> recommend refreshing\n. I think this sentence is confusing to a new React user. In general, when you want your UI to update, you don't just create a new element and pass it to ReactDOM.render(). It's not like you have a callback that handles a button-click and in that callback you create a new element.\n. This seems like it isn't a good pattern to advise - would you ever want to update your React app that way? If someone cut and pasted this pattern into their app it would probably end up being a mess.\nMaybe the whole concept of \"How UIs update\" should go later, when state is introduced. And this page could demonstrate rendering an element, and it could also demonstrate rendering a tree of elements, but not show how render can be used many times into the same DOM node because that doesn't seem like something we want to advocate.\n. You might want to call out that this super(props) call is necessary - it's easy to skip over if it's just in the code.\n. english nit: comma after However\n. I think the right way to say it is that setInterval \"sets up a timer\" and clearInterval \"clears the timer\" rather than that it \"sets up an interval\" and \"clears the interval\". \n. rather than referring it sometimes as \"interval ID\" and sometimes as \"timeout ID\" how about calling it the \"timer ID\"\n. I don't think \"shallow merging\" is a commonly used phrase. How about describing more precisely what shallow merging means. Something like, if you only provide some keys in setState, then setState only updates those keys. So if state is {x: 1} and you call setState({y: 2}) your new state is {x: 1, y: 2}.\n. \"Passing this.state down is the only useful thing you could do with it\" doesn't seem quite true. Maybe just ditch that sentence\n. set up its own timer\n. i would call this \"root\" rather than container to avoid confusing it with container components. or just put it inline in the render call.\n. I'm confused by what DataSource is, in this example. Is it just some global variable? That seems unusual. But if it's not a global variable, how does the CommentList get a hold of it?\n. I guess my concrete suggestion is just to make it clear what DataSource is from the code. If it's passed a prop make it a prop, for example.\n. can you say \"higher-order components\" instead of \"HOCs\" here - in general not making people remember the HOC acronym is nice\n. render() for consistency\n. How about briefly mentioning decorator syntax? I think it advanced at TC39 this week, so it's gonna be official eventually. And I know we get a bunch of questions like \"don't I need decorators for mobx\" so it would be useful in HOCs to explain how decorator syntax and the non-decorator syntax are the same.\n. I don't really understand this paragraph. I thought we aren't talking about the difference between CommentList and BlogPost, we're talking about what is the same between them.\nThe reason to not use a component seems simple to me. A component can't mess with its childrens' state. A HOC can totally mess with the state of the wrapped component.\n\"Why Not Use Inheritance\" might be more useful IMO - I think in many languages this would be a pattern you'd use inheritance for. Although I think you could also just drop this section.\n. I would just ditch this note, it seems like we should advocate HOCs unless people really really know what they're doing\n. Wow, I would not be tempted to modify a component's prototype at all. Is this a real concern, that we need to warn people against?\n. IMO we could just say \"Don't mutate the component you're wrapping\" in one sentence and leave it at that, rather than providing these code examples.\n. parameterized\nHOCs don't have to use containers as part of their implementation, do they? IMO this paragraph could also be ditched.\n. There's not that many conventions. What about ditching this brief intro, and just writing \"Convention: X\" in the headers before the conventions\n. This \"optional\" thing seems just as conventiony as the other conventions. For consistency I'd just say \"Convention: X\" in the title of all the conventions, and then you can also ditch the little intro-to-the-conventions-section\n. can you linkify React Developer Tools\n. Just to shorten up the prose how about\n\"We consider HOCs an advanced technique because they\" -> \"Higher-order components\"\n. spaces around - i think\n. You could have a HOC that adds in some UI, right? Even if it's weird, it's useful to know that there's nothing that prevents it, to help understand the underlying model.\n. We could delay talking about binding until the \"handling events\" doc. I think in practice when you start to handle events is going to be when people first run into binding functions.\n. needs an \"a\" before the <h1>...\n. remove \"element\" after <div /> - i think. it is hard to make these mixed code-and-words sentences grammatical\n. For example a this.state.showCompleted in a todo list app that toggles whether to show completed todo items - you don't pass it down as props to child components, but you do you use it in render to decide what should be rendered.\nI like expressing this as \"if you don't use it in render, it shouldn't be in the state\". In particular the difference between a regular member variable on the class, and being in the state, is that setState will cause a rerender, and just setting this.foo = bar in the component won't.\n. I vote for ES6. The term \"es6\" is much more commonly used than the term \"ES2015\". https://www.google.com/trends/explore?q=es6,es2015\n. this sentence was a bit unclear to me - maybe \"We recommend that such components use the special children prop to pass children elements directly into their output.\"\n. recommend to lift -> recommend lifting\n. Additionally -> Additionally,\n. I think this actually leads to some buggy behavior. Try typing \"0.123\" on codepen, and then slowly delete it one character by one character - it seems like when you delete the \"1\" it also deletes the \".\" and the cursor jumps to the beginning. The problem is that parseFloat + toString is lossy parseFloat(\"0.\").toString() is just \"0\". So I think the prop actually has to be the string, or something like that. Or maybe you could only accept ints?\n. ok\n. Hmm I think giving something a variable name implies that the name is accurate when the variable is in use, which in the case of a function like this one is the time that the function runs. So I think this wording is appropriate. It's also just called \"currentProps\" in the current docs - I copied this example verbatim.\n. OK\n. OK changed the wording\n. OK removed this part\n. The problem with ignoring HTML is that we don't really expect people to read the React documentation to figure out what events all the elements support. We only super-briefly discuss it. I think really, to know what events there are, you have to be aware of the rule, \"it's just like HTML except camelcased\".\n. fixed\n. OK\n. OK moved it\n. This example is showing how to prevent the default action, so it's a link that does something else. That's why handleClick calls preventDefault. I updated the text to make this more clear.\n. updated\n. renamed\n. fixed\n. OK good convention\n. OK\n. OK, TIL, I updated this part. Honestly it seems pretty unlikely that most people hit this, I'm inclined to just use arrow syntax for callbacks in my own projects :P\n. OK I added a little bit about it. I think there will be one \"reference\" page about synthetic events and we should link there from here.\n. yeah this paragraph is pretty awkward. In my defense I just copied it from the previous docs :P I split the sentence and cleaned up a bit\n. fixed\n. OK\n. OK\n. Man how am I missing so many periods. fixed\n. OK\n. I feel like a global find and replace went awry for me or something, i swear im not this bad of a typist. anyway fixed\n. OK\n. OK I renamed it \"ActionLink\" :P\n. OK\n. OK\n. ok\n. OK\n. ok\n. I added that extra explanation\n. OK - i basically redid this part\n. OK, I added a bunch more about \"why not to use context\". I also just added a link to that article.\n. ok i swapped out w this paragraph\n. ok added\n. replaced\n. ok\n. ok\n. yeah this doesnt make sense, ok i futzed around with this paragraph\n. This PR does also change the \"installation\" page to briefly mention the production build. The webpack code here is helpful though... I just added this content inline, I think this works. I kept the .min.js links on the installation page because they seem logical there too.\n. OK updated\n. OK\n. OK. Whew, I had to actually learn what React.PureComponent is.\n. ok\n. ok\n. ok\n. ok\n. ok\n. OK. I agree that in practice using regular JS structures is better. I wrote about how to do the spread operators, moved Immutable.js to the bottom, mentioned the other two as well.\n. oops fixed\n. fixed\n. It's referring to the snippet above which does\nif (this.props.color !== nextProps.color) {\n      return true;\n    }\n    if (this.state.count !== nextState.count) {\n      return true;\n    }\nyes?\n. good point, I added a mention of those two exceptions\n. Hmmmmm I can't say I'm happy with this notation. This doc makes me want a diagram of \"what is the virtual dom\". This is all about transforming one tree into another. What tree are we transforming? The virtual doms? The real dom? Some virtual tree that has both virtual dom and real dom squished together, like should I think of it as a tree of elements and some elements happen to have pointers to DOM nodes? Hrmph. I'll try to rewrite this part....\n. Hmmmm, what about the case where one is a DOM element and one is a component element? Like if you have a component ShimButton which always just renders to a <button/>, and then if you have a second component SpitefulButton which first renders to <ShimButton/>, and then at some time later rerenders directly to <button/>. React will just throw away the first tree and rerender the <button/> element... right?\n. ok\n. Guess I have been defending against the wrong sort of null in all this sample code. There's no fidgety way that the click event could execute after React does the unmount? Anyway I un-overdefended this\n. ok\n. OK noted.\nWhy is this behavior with null useful, anyway? I can't really think of a use case. Especially if all you do is use the ref callback to set a property - any code that would handle that seems like it would be in componentDidUnmount anyway.\n. ok\n. fixed\n. ok\n. I see, I was thinking it is equivalent to a shallow comparison since we know these props and state to only use these values. Anyway, I'd like it to be clearer, so I altered the wording in a way that I believe will be @Aweary-compatible.\n. Ah yeah garbage collection makes a lot of sense.\n. ok\n. oops fixed\n. oops fixed\n. Hmm that doesn't quite seem correct - it's fine if your component accepts functions as props, you just need to make sure that the parent passes the same function rather than recreating it. OK I get what you're saying though, let me reword this in some way\n. ok :P\n. OK - i added a second component. I also moved the diagram up, so that this section and the section that goes into detail about not mutating things are next to each other, because they are kind of starting to merge in terms of content.\n. ok\n. OK. Honestly the redux doc is a better explanation of what the heck this is ;-) but yeah it's weird to link to redux here. Changed\n. ok\n. ok i reworded this\n. I moved stuff around so that there's three parts - different types, same type of DOM element, same type of component element, I think this satisfies all comments\n. OK - i think \"instance\" and \"element\" are now used correctly\n. ok\n. ok\n. ok\n. ok\n. ok\n. Man, I hate this syntax. Maybe you guys can make it so that relying on the previous value in the intuitive way actually works in react? \ud83d\ude03 Anyway, fixed\n. ok\n. Ahhh good point. ok I added some more explaining the object spread syntax\n. I think state should come before lists, but events should come before forms, so maybe interleave them:\nstate\nlists\nevents\nforms\n?\n. no space before the ()\n. no space before ()\n. this applies to a number of things through the code sample.\n. you say JSFiddle but you mean CodePen\n. Could you make it into two sentences instead of the , otherwise ? E.g.\n\"In the example below we determine which button to display to a potential user. We track state using this.state.loggedIn to represent whether or not they are logged in. If the user is logged in then we want to render a <LogoutButton />, otherwise we want a <LoginButton />. We use a variable loginButton to hold either element, depending on the value of this.state.loggedIn.\"\n. This seems like the simplest content of all. Maybe this could go at the front, before using map?\n. That's pending on the \"forms\" doc existing. @ericnakagawa said he'd have that in a PR later today\n. ok I just stopped trying to explain\n. ok added this mention\n. Ah, you're right - actually I don't think key and ref belong in this document at all. This document is supposed to just be differences between the regular DOM, and the React DOM, and key and ref are more like React features than things related to DOM elements. Since we already have other docs that go into great detail about key and ref, I just removed this brief sections.\n. just removed this section as mentioned below\n. OK\n. OK\n. Ah OK - I did not see that those were different things. In that case I think this section should just not go into the doc, along with the React.DOM-specific stuff. Removed it\n. I found this hard to understand initially because <FetchData/> isn't a thing. Is there any example for where you'd use render callbacks that is simple enough that you could actually include real working code? Bonus points for codepen. Maybe something like, a render callback to render the ith thing in a list?\n. Is this convention actually popular? Like is there some popular library that uses it? If so, maybe you could just have an example of code using that library.\n. This seems like a full example would be pretty useful. Like if you had a real working example of render callbacks as the first example, you could have a higher-order-components example here that did the same thing, and also show what code using both of them would look like.\n. I don't think it's quite correct to say a HOC transforms itself. How about:\n\"Whereas a component transforms props into UI, a higher-order component transforms a component into another component.\"\n. super(props)\n. super(props)\n. space around - ?\n. I really like this list and the following paragraph, I find it very educational\n. Is this actually the most common signature? I found this sentence confusing. How about just:\n\"Some HOCs, like React Redux's connect, look different:\"\n. add a : at the end\n. no \"but\" at the beginning, capitalize This. Just for consistency with the phrasing around other inserted code blocks\n. ok\n. ok\n. ok\n. OK. I took these words. Yeah I found this confusing when I first read it - to me the way that reconciliation makes the most sense is to think of there as being three trees. There is the \"element tree\" which the developer is creating when they return JSX, there is the DOM which the browser knows about, and there is this \"secret internal tree\" which only React uses, React creates it when you first do a ReactDOM.render, and the secret internal tree has nodes where each node corresponds to some element and might correspond to something in the DOM. And reconciliation is basically a recursive algorithm on the internal tree. But this is so not the terminology that we are publicly using, I don't really want to go attempt to rewrite everything to refer to three trees right now. That's how I'd explain reconcilation on a whiteboard though. Anyway I just updated this sentence to not imply React is mutating the tree returned by render().\n. ok\n. ok\n. OK\n. OK\n. ok\n. OK\n. ok\n. ok\n. ok\n. ok\n. ok\n. ok\n. FWIW @spicyj specifically requested adding this exact paragraph \ud83d\ude1b Well, I rewrote it to be more polite towards web components, I believe everyone will be happy now\n. I also don't have a survey but mobx doesn't look like this for example - there you just stick @observer in front of your class rather than doing the double-calling thing. How about just not saying \"by far\" here.\n. ok\n. Yeah, it's just a redirect though. I think the world will survive having one \"tip\" with ~0 usage having a confusing redirect.\n. This tip only did one thing, gave an example of a component with all the lifecycle methods doing nothing. So I think this is the logical place to redirect it to, also the tip was not really too helpful for anything IMO.\n. ok\n. Just a phrasing nitpick - can you break this up into two sentences like:\n\nIf you wanted to listen to updates to the value, you could use the onChange event just like you can with controlled components. However, you would not pass the value you saved to the component.\n. can you put a space after if and break this up into multiple lines so it matches the style of other parts?\n. can you put spaces around the ? and : operators when you're ternarying\n. spaces around the : too, plz\n. I think this code is not using fetch appropriately - you should be checking response.ok to see if there is an error. As is, if there is a 4xx or 5xx error I think it will fail in some weird way during parsing. Even just rejecting a promise would be OK here IMO but fetch actually does not reject the promise on server failure.\n. I think the best practice is actually to write some helper that uses fetch. Then the nature of this async/await example is different. I think it's still handy to have an example with async/await here though.\n. So basically you could not use any of the previous examples in production because they do not handle the cases where promises are fulfilled out of order, or the component unmounts. Is it even a good idea to explain those paradigms? It does not seem like a great idea to provide sample code that is actually buggy.\n\nIs there a simple way to write code that loads data asynchronously that actually does not have any of these race condition bugs?\n. So what's your suggested solution to callback race conditions - just don't unmount a component that's loading data? I don't like having a \"pitfalls\" section that just states that something is a problem for everyone without showing how to solve it - we should just not have a \"pitfalls\" part and instead explain \"how to do things right\".\n. I don't think this is something we want to tell everyone to do, is it?\n. nitpicks: spaces after //, Refrence misspelled\n. NODE_ENV is only applicable when compiling yourself - you might be using a CDN version. So I think this sentence is better just left out, the right way to refer to this is \"using the development build\" rather than \"setting NODE_ENV\".\n. no : needed\n. Rather than referring to \"the old official tutorial\" how about just having a little bit of example code and then linking to somewhere that it's available as a html file where people can just drop into dev tools. It could be in the assets directory in the react website, I think that would make sense because we put some other html stuff there too.\n. our example code we're using ES6 for now - could you make this the same style as the other docs?\n. Could you avoid using this dangerous html stuff in example code?\n. It's best to avoid dependencies on new backends, especially a one-off herokuapp instance. Perhaps this could just be a static file on the react website itself.\n. \"multiselect\" isn't really its own thing - it's just a feature of select. How about making this example inline with the previous section, and just saying something like:\n\"You can also do multiple selection, by setting the 'multiple' parameter and using an array as the value.\"\n...followed by sample code that just changes the example to a multiselect example. I think it would be better to combine the JSX and javascript code in this example. Look at how textarea works, the format is just:\n--\nIn HTML a textarea is like this:\n(example)\nIn React, you change X and Y, so a full example is this:\n(full example)\nNote some brief stuff stuff.\nHow about using that parallel format for checkbox and radio buttons?. What happens here if the component has unmounted before this request completes?. Could you say \"repositories\" instead of \"Repos\"? I think a lot of people will not instinctively know what a \"repo\" is.. Is this fetchRepos function supposed to have a particular behavior in terms of doing things in the right order? Does axios guarantee that?. Won't this lead to, if you first load repos for foo, and then for bar, on the immediate load of bar it will show the foo repos under a header that says \"bar repo\"?. Is it possible that this._source has already completed by the time this line of code runs? That seems possible to me.. Looks like one of the links is missing here?. In particular, this line of code already exists elsewhere in the tutorial, so we should just use the same one here. It doesn't use template strings but it does do a consistent single-quoting. I'll just fix up this PR directly rather than back-and-forthing around these nitpicks though.. I think I prefer the original text better here. You don't really want to walk people through all the details again, you want to explain more generally and expect that this time people understand it. So it doesn't feel right to say \"remove handleClick now\" - the goal of the tutorial is that when you say, this component needs an onClick prop like the other one, the student understands how to do that. If they don't then the previous section failed. It might be easier to follow along if you just hand-hold the entire way, but it doesn't necessarily make the tutorial better.. This seems like too much. How about just adding like one sentence somewhere when the student is told to put the status logic elsewhere, that you should also remove it from Board?. Minor: you say \"Lastly\" a lot but logically only one thing can be lastly. Probably better to not do it. This change seems good. Maybe rather than splatting all the code inline, it would be better just to refer to the codepen where the solution code is - I found that more helpful, to just have the correct answer entirely. But I think we already do that?. Is this a UI change or is this just to compensate for something that's happening in that Redcarpet library? If it is a UI change, would you mind posting a before and after screen shot to show what you're changing here?. It seems inconsistent to inline this when things like live_editor.js are included as separate scripts, what do you think about refactoring this out similar to the other stuff?\nI suspect people in the future will be digging through old code and trying to figure out what the heck this bit is doing, so would you mind adding just enough overall comments to explain what it is that this section of code is trying to accomplish?. ",
    "briandeheus": "I've tried passing on ReactCurrentOwner.current but that doesn't work since it's a ReactInstance but it expects a ReactElement. Is there any way I can get ReactElement from the ReactInstance? :thinking: \n. > I think in my ideal world here, we would display in unknown when we have the location info and leave that line off and just show the parent if we don't.\nIf we have the location info why would we display in [unknown]?\n. Let me know if something needs changing and I'll gladly edit my PR.\n. I'll get on it. :+1:\n. ",
    "samsch": "Should be \"...with the full power...\".\n. Should be \"...with the full power...\".\n. \"...also use curly braces...\"\n. ",
    "hramos": "Red does seem overly aggressive here. I can open a PR to fix this. If you need any other styling changes, send them my way.\n. Browserify is capitalized on their site, while webpack is not. \n. ES2015 vs ES6\nWhile these terms can be used interchangeably, it can be confusing to a new developer if they see references to both ES6 and ES2015 in an introductory tutorial. We should pick just one.\nES6 seems like a good pick as the first document in the series already introduced the term. \n. ...on the other hand, the Babel preset that enables you to use ES6 is babel-preset-es2015.\n. I thought we were going to avoid using this Flow/type-like notation in the docs.\n. Use a level 3 heading here as these APIs don't belond under The Component Lifecycle.\n. Sounds good.\n. Will do. ReactElement and ReactClass are holdovers from the original reference, looks like I missed a handful on this first pass.\n. All feedback aside from this has been addressed. Will get back to this line tomorrow.\n. This is a good list of supported validators. Do you think I should update /react/docs/react-api.html#proptypes to include a list of these? An API reference should list all valid symbols. Your typechecking guide can then cover use cases alongside code examples.\n. Good catch\n. Done.\n. Done.\n. Done.\n. Sounds good, I'll open a new PR.\n. Is this warning from pure-render-mixin.md still relevant?\n\nReact.PureComponent's shouldComponentUpdate() only shallowly compares the objects. If these contain complex data structures, it may produce false-negatives for deeper differences. Only mix into components which have simple props and state, or use forceUpdate() when you know deep data structures have changed. Or, consider using immutable objects to facilitate fast comparisons of nested data.\nFurthermore, shouldComponentUpdate skips updates for the whole component subtree. Make sure all the children components are also \"pure\".\n. Lets continue discussion in #7956\n. Agree, these should not be top level under Reference. They're still reference docs, so they will be listed under Addons within Reference.\n. OK\n. I'm not familiar with importing from UMD - how would that look like?\n. OK\n. Renamed back to LinkedStateMixin.\n. OK\n. OK\n. OK\n. OK\n. OK\n. Missed this in my last batch of commits. Will address. \n. Ah, I got what you meant by the distinction, but missed that we already had two add-ons that were actually deprecated:\n- cloneWithProps\n- ReactLink\n\nI'll leave those two above marked as deprecated, and mark the following two as legacy:\n- update\n- PureRenderMixin\n. OK\n. Got it.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done. I used 'valueLink' in some places where the docs were referring to an instance of the valueLink object that is used with LinkedStateMixin.\n. Done.\n. Done.\n. Done. I moved the step-by-step guide to shallow rendering back to the top, next to the list of shallow rendering methods.\nYou'll notice the descriptions for the methods in the reference at the bottom are now shorter. My thinking is that these should limit themselves to describing what the method does, and the guide at the top is what brings them together.\n. Moved to the top, it should make more sense now.\n. Updated to link back to Shallow Rendering introduction, and added a comment saying it shallowly renders a component.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Done.\n. Removed entirely.\n. Done.\n. They do work locally.\n. I should justify why I commented this out here. It's common place to use ... in code samples to imply \"some other code goes here\", but this is problematic when you're working with ES6 code. The reader now ask themselves: did they mean to use the spread operator here, or not?\nBy avoiding the use of ... when we don't actually mean to use the spread operator, it will hopefully make it clearer when people do need to use spread.\n{/* ... */} looks weird but it would be correct in this case.\n. Yep, missed this one.\n. ",
    "hozefaj": "Would it make sense then to mention about dangerouslySetInnerHTML, if I wanted not to escape the values?\n. ",
    "vladshcherbin": "Why let, not const?\n. ",
    "saschwarz": "How about:\nWe call this a \"container\" DOM node because the React app is contained by it. Everything inside it will be managed by React DOM.\n. I'd delete this line and move your more descriptive line ahead of the example:\nWhen we want the UI to update, we create a new element, and pass it to ReactDOM.render(). It updates the DOM to match the newly passed element.\n. Has the concept of element tree been presented before here? If not maybe a brief explanation (since this isn't the diffiing the DOM tree but the React DOM element tree) or a link.\n. This diffing algorithm makes React efficient, but the real win is thinking about how the UI should look at any given moment rather than how to change it over time eliminates a whole class of bugs.\n. ",
    "markerikson": "Eh, given the tutorial context, I'm fine with that wording.  It's close enough to get the concept across.\n. A typical jQuery plugin might get cleaned up with $el.somePlugin(\"destroy\") or similar.\nAlso, is it worth having the ref callback just save the element onto the class instance, and creating the jQuery wrapper in componentDidMount, for clarity?. And React :). Various plugin libs have their own setup/destroy approaches, but I think $el.somePlugin(\"destroy\") is a typical and clear enough example that it should go in there.\nUsing $ is absolutely clear, I'm just suggesting to do that as a separate step in componentDidMount so it's not kind of 'buried\" in the ref callback.  It'll also help illustrate that the normal use for a callback ref is to save the reference to the real DOM node.. Yeah, just:\n```js\ncomponentDidMount() {\n    this.$el = $(this.el);\n    this.$el.somePlugin();\n}\nrender() {\n    return  this.el = el} />\n}\n```\nOr something along that line.. Should be this.$el = $(this.el);. Worth highlighting this a bit somehow. The key is that rendering a consistent set of elements each time means React won't be trying to make changes, so a lib that does modify the DOM can get away with it and not clash with React applying updates.. ",
    "kevinzwhuang": "Ah good catch! I went ahead and added the check for && el.shadyRoot and replaced the warning argument with didWarnShadyDom\n. Sounds good with me, added this in the last commit\n. \u2705  Done in the last commit\n. I tried using var name = type.displayName || type.name || 'A component';, but it did not work since this._currentElement.type ended up referring to a string (which I believe is the HTML element tag?) without displayName or name properties ever\n. Agreed! Redid the last commit without the newline\n. Haven't seen a case where owner would be missing, but it seems like there are checks for owner in other places, added in latest commit to be safe.\n. :+1: \n. Rendering just <div /> fails the isCustomComponentTag check, which was the reason why props were being passed to simulate an is= custom component.\nI found a remedy to this by rendering anything with a hyphen in the name (which happens to be the naming convention of all Polymer components) like <polymer-component /> instead. No props needed!\n. ",
    "azizj1": "Just for my understanding, but if you have a constructor that doesn't utilize the props, you can just do constructor() { super(); .. }, right?\n. ",
    "Jiab77": "Hi, I've created then removed a pull request, because of the semantic was troubling me.\nCould you please, explain me why the type object is only defined on the method getInitialState() ?\nOk, I'm a ReactJS beguiner and though I had to use \":\" after the method name in my code, which is stupid and of course, resulted in a compilation error. I took the time to read more about ES6 classes and this thread to understand that my pull requests were unneeded.\nIs it possible to define the type on every methods inside the documentation ? or not define them at all. So this could be less misunderstood for beginners like me...\n. @gaearon thanks for your link, which helped me to convert my code to ES6 classes and correct all getInitialState() blocks I had because the use of React.createClass()\n. ",
    "suchipi": "This should probably be \"Class components can also...\" (adding the word 'can')\n. ",
    "nashio": "This part might need rewording?, here's an idea: \"If you want to reuse non-UI functionality between components, we suggest extracting it into a plain JavaScript module so you can import it, and use it as a module inside a component\"\n. ",
    "samit4me": "Small nitpick, but I don't think parseFloat() takes a radix, only parseInt(), so I believe the base10 is ignored. This radix is also passed is in a few other places throughout this code.\n. Class properties are not officially in the JS spec and require the use of either:\n- Babel plugin transform-class-properties OR\n- Bable preset Stage 2 or lower (e.g. Stage 0).\nThere is some great information regarding modern JS in hello-world.md\n. ",
    "kof": "why not to use \njs\nhandleChange = (e) => {\n...\n}\nTo avoid the need for a bound function generation in constructor?\n. ",
    "draco": "Nitpick but there's a typo here celsium instead of celsius, it also happened in a few other places as well.\n. ",
    "acusti": "Setting tabIndex on the iframe element here and then invoking iframe.focus() below at line 202 was only necessary because jsdom didn\u2019t handle setting activeElement in the parent correctly. This is fixed in jsdom v9.7.0, so if we updated jest\u2019s jsdom dependency, I could remove the hacky workaround.\n. Updating the version of jsdom used by jest has landed (includes a fix of a major perf regression, so it\u2019ll be fun to see how that affects test running times), so when a new version is released, should be able to remove the hacky workarounds in this test.\n. If you just try to access the contentDocument of an HTMLIframeElementthat comes from a non-matching (separate) domain (like if there\u2019s an embedded YouTube player in the DOM), the browser will throw an error.. According to the MDN page about the Node interface:\n\nNode.ownerDocument returns the Document that this node belongs to. If no document is associated with it, returns null.\n\nThat doesn\u2019t refer to a node that isn\u2019t in the DOM, which will still have a reference to the ownerDocument where it originated (via document.createElement). In my experience, ownerDocument is only null for Document nodes themselves, which matches what MDN says on the page specifically about Node.ownerDocument:\n\nIf this property is used on a node that is itself a document, the result is null.\n\nSo now that you mention it, this check could be updated to handle Document specifically, maybe like var doc = node.nodeType === 9 ? node : node.ownerDocument;\nHowever, maybe ownerDocument could also be null if, for example, you had a reference to a node from a document that has since been destroyed (an iframe element that got removed from the DOM and garbage collected, for example)? I\u2019m not sure. Hence the simplified fallback to the global document whenever ownerDocument isn\u2019t truthy.. Nothing to do with selection; this is just another part of the codebase that relies on the global window object rather than the window object relative to the DOM node being used. That said, I just looked it up, and window.clipboardData is an IE-only API and one where it seems like the code being executed should only try to look up it\u2019s own window.clipboardData (because of browser permissions / security settings), so I\u2019m going to revert this set of changes.. If the event was dispatched at the window level, like if you had a window.onresize listener, for example, the event target would be the window object and would therefore have a document but no ownerDocument. And if it was dispatched on the window object of a nested browsing context, it would be the window object of that iframe, not the global one.\nHowever, looking at where this gets invoked, I see that the call site has it\u2019s own nested browsing context-compatible way to calculate doc that was added a year ago: https://github.com/facebook/react/commit/6e04bd758ed7a28ebdfbf544f6db9065340392e1\nI guess I\u2019ll just repeat the same logic here, if that makes sense to you; i.e. I\u2019ll replace these lines with:\njs\n    var doc =\n      nativeEventTarget.window === nativeEventTarget\n        ? nativeEventTarget.document\n        : nativeEventTarget.nodeType === DOCUMENT_NODE\n          ? nativeEventTarget\n          : nativeEventTarget.ownerDocument;. That\u2019s a great question! That\u2019s what the existing function enforces, so I figured I\u2019d capture that behavior in the tests:\njs\n  return (\n    nodeName &&\n    ((nodeName === 'input' && elem.type === 'text') ||\n      nodeName === 'textarea' ||\n      elem.contentEditable === 'true')\n  );\nBut I\u2019m not sure it\u2019s desired, because those input types can definitely have selections. The hasSelectionCapabilities check could be changed to something like:\njs\n  return (\n    nodeName &&\n    ((nodeName === 'input' && ['text', 'email', 'number', 'password'].includes(elem.type)) ||\n      nodeName === 'textarea' ||\n      elem.contentEditable === 'true')\n  );. I don\u2019t know really know anything about clipboard APIs in IE, but based on a quick google search, my hunch is that this change wouldn\u2019t actually be for the better. There\u2019s some mentions about browser settings and issues with clipboardData not being accessible across different browsing contexts, so keeping it hardcoded to window.clipboardData might actually be correct.\nBut I\u2019d be happy to open a separate PR with it if someone would be able to figure that all out.. Considering they\u2019re in the same file, I\u2019m making a getEventTargetDocument function. I dropped native from the name because I don\u2019t think that distinction is relevant at the level of this function.. Good call! The check is actually useless, because if priorActiveElement is not in document, the function will early return and never reach this if block.. The value that gets passed in comes from fbjs/lib/getActiveElement, which returns a nullable HTMLElement (https://github.com/facebook/fbjs/blob/master/packages/fbjs/src/core/dom/getActiveElement.js#L21). The only instance where the return value would be null is if the util was unable to find a document object, which I think would only happen in SSR. But because it is theoretically nullable, all the operations in this file first confirm that node (or elem, in hasSelectionCapabilities) is truthy.. I made that change (for this line and two other instances) in 51be426d3. @aweary Just double checking: we can remove this dependency now, right?. @wilsonhyng I believe we don\u2019t need immutable.js in the fixtures anymore now that we\u2019ve removed the draft.js dependency. @aweary Please correct me if I\u2019m wrong.. If you just try to access the contentDocument of an HTMLIframeElement that comes from a non-matching (separate) domain (like if there\u2019s an embedded YouTube player in the DOM), the browser will throw an error.. @gaearon We can update getActiveElement.js to look like:\njs\nexport default function getActiveElement(doc: ?Document): Element {\n  doc = doc || document;\n  try {\n    return doc.activeElement || doc.body;\n  } catch (e) {\n    return doc.body;\n  }\n}\nBut strictly speaking, flow will still complain that document.body can be null (ref: https://github.com/facebook/flow/issues/4783#issuecomment-326770766), so strictly speaking, the Element return value still has to be ?Element, unless we did something like\njs\nexport default function getActiveElement(doc: ?Document): Element {\n  doc = doc || document;\n  const body = doc.body || doc.createElement('body');\n  try {\n    return doc.activeElement || body;\n  } catch (e) {\n    return body;\n  }\n}\nDo you have a preferred approach?. @nhunzaker No try/catch needed for the second example, and the ReactInputSelection plugin won\u2019t have any issues; the code is already setup to handle detached DOM elements for a case where the active element becomes detached between when it is first read and cached and after React finishes committing an update. The second option has grown on me; I suggested it thinking it was silly, but now feel like it\u2019s pretty reasonable. If we go with that one, should we add a comment explaining that document.body can be null?. In the case of IE8, and possibly other very old browsers. We can remove the early return if that no longer matters.. Likewise, in IE8. js\n    node && node.ownerDocument && containsNode(node.ownerDocument.documentElement, node)\n(will need to be prettified, I expect). Need to restore the truthy check on elem. Revert this entire function. Might be clearest to specifically call out \u201ccross-origin\u201d here (as in CORS):\njs\n    // to throw, e.g. if it has a cross-origin src. Thanks for tracking this down! This is definitely an oversight of #12037 that we didn\u2019t address.\nFor context, the reason that getOffsets uses a different method to get a relative window and document object than setOffsets is that getOffsets only needs to use the relative window (which has getSelections), whereas setOffsets needs to use both the window object (for getSelection, again), and the document object (for createRange). So this should really be a hybrid of the two approaches, i.e.:\njs\n  const doc = node.ownerDocument || document;\n  const win = (doc && doc.defaultView) || window;\n  ...\n  const range = doc.createRange();\nWhere it still guards against a missing ownerDocument by falling back to the global and also guards against the case  of having an ownerDocument that\u2019s  missing a defaultView.. ",
    "sethkinast": "If the two clauses joined by but are independent (test: can they stand alone and make sense as a sentence?) a comma is appropriate. So a comma is correct here\n. ",
    "cmatheson": "so the instanceof checks are necessary so that flow knows what kind of element we are dealing with (an HTMLElement doesn't have a type property, but a HTMLInputElement does, for example).  I was thinking this logic was equivalent (except using the type checker instead of elem.nodeName to infer the type, as it currently does).\nI could just add the necessary instanceof check while preserving the current checks though... something like\njs\n    return nodeName && (\n      (nodeName === 'input' &&\n        elem instanceof HTMLInputElement &&\n        elem.type === 'text') ||\n      nodeName === 'textarea' ||\n      elem.contentEditable === 'true'\n    );\n?\n. ",
    "nhardy": "Typo: [hoist-react-non-statics] -> [hoist-non-react-statics]\n. ",
    "aditya1994": "Hello! \nCan someone still make a PR for this bug?\n. @gaearon this looks great. Was just curious how ReactComponentTreeHook works. Thanks for replying!\n. ",
    "goatslacker": "Done.\n. ",
    "rthor": "In that case, shouldn't all the examples feature async / await? Or is it better to demonstrate both methods?\n. Just the constructor. Should I repeat it instead? Wasn't sure what your preference would be.\n. Yeah, I realized that after I made the PR. Didn't want to change it in case this guide should be elsewhere. Should we keep it here then?\n. Going back to it, I saw that other guides in the same section don't have previous links. I removed the one in this article to keep consistency.\n. Yeah sorry, my bad.\n. While I agree that this adds a lot to the guide, I think that this way is more in tone with the rest of the documentation. Ie show a \"simplified\" version first and gradually refactor towards best practices.\n. Not that I'm aware of, no. Would you prefer that we bake the pitfalls section into each example? Ie provide \"bug-free\" code from the get-go even if it might be a bit verbose and will probably be explaining to much in one pass for a newcomer.\n. I'm not sure what you mean by resolving the unmounting issue as it can be a completely correct behaviour and has nothing to do with the request itself. \n\nAPI calls should be happening as high up in your component tree as possible.\n\nI would argue against this approach. If data is passed down the entire tree, without defining componentShouldUpdate at every step, the entire app will be rerendering with every response.\n. Good point. But Dan wanted this in the guide.\n. Helper to handle errors and bad requests then? eg\njs\nfunction safeFetch(url, options) {\n  return fetch(url, options).then(response => {\n    if (!response.ok) {\n      throw new Error(response.statusText)\n    }    \n    return response.json()\n  })\n}\n. So the async code would be:\njs\nasync fetchGists() {\n  const { username } = this.props;\n  try {\n    const gists = await safeFetch(`https://api.github.com/users/${username}/gists`);\n    this.setState({gists});\n  } catch (error) {\n    // Request failed...\n  }\n}\n. Not sure I follow. This is the \"container's\" children, which should be the component's root element. Unless I'm mistaken...? This is a very early PR btw. Still wrapping my head around how Fiber works internally :) . ",
    "goenning": "I thought about it, but as Fiber is still very recent and folder structure can still change, I think it's better to link a frozen tree. Aside from that, most other examples on this page also links to the same commit hash. I'm open for changes btw, as long as the link works \ud83d\udc4d \n. Just trying to follow a standard, all links inside the block should point to the same tree.\n. ",
    "ankeetmaini": "I saw and tried returning the error as was done there. The tests were breaking because it was returning from the function. I'll take a look at it again. Thanks so much @gaearon!\n. @gaearon ReactFiberCommitWork.js returns the error.\njs\n try {\n      instance.componentDidUpdate(prevProps, prevState);\n      return null;\n    } catch (error) {\n      return error;\n    }\nBut I can't return the error as it'll stop the while loop of the subsequent callbacks of the rest of the nodes in the queue.\nShould I make node.callbackWasCalled = false if it throws up and console.log? Suggestions please!\n. trapError\njs\nfunction trapError(failedFiber : Fiber | null, error : any, isUnmounting : boolean) : void\nis defined in ReactFiberScheduler.js which adds errors to an array nextTrappedErrors\nIt is passed to ReactFiberCommitWork.js during instantiation. We can pass trapError function to callCallbacks\njs\ncallCallbacks(finishedWork.callbackList, instance, trapError);\nDoes this look good @gaearon?\n. Sure!\n. Should I also check if error exists at this point of time because of calling tryCallComponentDidUpdate or tryCallComponentDidMount above as @gaearon mentioned to just keep the first error?\n. Yes, sure :)\n. ",
    "MicheleBertoli": "Sure, thanks!\n. ",
    "Faradey27": "what the reason of such style? \nwhy here you can't just have \n```\n    var value = fn(props, context);\nif (__DEV__) {\n  ReactCurrentOwner.current = workInProgress;\n}\n\n```\nor\nif (__DEV__) {\n      ReactCurrentOwner.current = workInProgress;\n    }\n    var value = fn(props, context);\n. ",
    "hedgerh": "I think we should get rid of this refactor step.  It adds 40 lines just to explain to the reader that if they write the same code twice, they should probably turn it into a function.  The other option is for the first example to already have the fetchGists method.\n. We should get rid of all this stuff about async/await, too.  It's really out of scope.  Our readers are busy learning React, and they either already know about async/await, or shouldn't worry about learning about async/await right here.\n. We probably only need these comments in the example for the componentDidUpdate example, but no biggie either way.\n. We should first mention that the best solution to this issue is to resolve whatever is causing this unmounting issue.  API calls should be happening as high up in your component tree as possible.  If your top-level component is so far up the tree that you can't make the API call there and pass down the data, that's when I'd start considering keeping my state outside of React.\n. > Async/await is enabled in Create React App by default.\n@gaearon: would you mind elaborating on why we should include a section on async/await?\nIt seems like something better suited for async/await documentation, since it's a pretty trivial example.. I was imagining some scenario that could be fixed by restructuring your code.  For instance, if it'd be possible to move the API call up to the immediate parent, and pass the data down to the component instead.  Was I way off base there? :P \nCancellation is obviously the solution when it's unavoidable.\nAlso, out of curiosity, what are some common use cases where this occurs for people?  I understand how it could happen, but I never really encounter it.  Route changes was one that came to mind.. ",
    "marcysutton": "I don't understand how that works even after looking at it. The numbers don't look like they match line numbers...?\n. ",
    "dashtinejad": "I think this note is suitable to be in the reference\n. I think this note is suitable to be in the reference (we can change it to a Note block).\n. ",
    "nolanlawson": "The feature itself (user timings) has been in there since IE10, and Firefox supports it too (caniuse). However I'm not sure if IE10 DevTools actually surfaces it; I'd have to grab a Windows VM and test.\nMy understanding was that the point here was to indicate which browsers support surfacing the user timing info to Dev Tools, since otherwise we should mention Firefox too for completeness.\n. ",
    "dhyey35": "In this tutorial I am using only one file but in real projects developers use bable and webpack or other such tools. If we import Perf ES6 style in any file of our project we have to make it global to access it from console and @gaearon has mentioned it in issue #6174 . So I think we should let developers know solution to a common problem beforehand. What do you think ?\n. Where should I put my code in order to get it into assets dir on react website as I dont have access to it ? Examples directory of repo ?\n. It has been mentioned in the solution of issue #6174 . So I think it should be included so developers know how to solve it when they run into reference error.. Where should I put the code to get it into assets dir of react website ?. ",
    "manjudhiman": "should number be used as constant?. typo: objects. ",
    "iansu": "That's fair. Adding the name of the component to the warning is relatively easy. I should have done that in the first place. Showing what was changed is definitely more difficult. If people think that's valuable then I'm willing to look into it.. I originally tried checking for the specific error message. I copy/pasted the message but it said actual vs. expected message didn't match, even though they appeared identical. I'll give it another try.. This description is wrong. The bug was that creating an element with a ref in a constructor did NOT throw an error in dev mode.. ",
    "laumair": "Closed this for https://github.com/facebook/react/pull/8439 @brigand Indentation fixed!. ",
    "gre": "s/trough/through/. ",
    "n3tr": "What if we reorder to call ReactElement.createElement first and pass element to getCurrentStackAddendum(element) to get stack addendum.\nThe output will be something like:\nin Unknown (at example.js:6)\n    in Button (at example.js:12)\n    in DangerButton (at example.js:25)\n    in div (at example.js:24)\n    in ExampleApplication (at example.js:35)\nIs it good enough?\n~~just curious about testing, the output contains line number of caller and it might be changed when edit test file. How can I test it?~~\n-Warning: React.createElement: type should not be null, undefined, boolean, or number. It should be a string (for DOM elements) or a ReactClass (for composite components).\n-    in Unknown (at ReactElementValidator-test.js:530)\n+Warning: React.createElement: type should not be null, undefined, boolean, or number. It should be a string (for DOM elements) or a ReactClass (for composite components). \n+    in Unknown (at ReactElementValidator-test.js:537)\nedited: got it - use regex\nI'm new to react code base and would like to learn, Thanks. \ud83d\ude03 . IMO, We don't need actual implementation (which will slow down the test suite). I think better do polyfill global.performance  in the test setup and implement our own version of it (like @aweary mentioned in https://github.com/facebook/react/issues/12209#issuecomment-365764897).\nFor an idea, we can take a look at https://github.com/facebook/react/blob/2cf9063318014dcc9a4839bb15ebb89a55198fce/packages/react-dom/src/tests/ReactDOMRoot-test.internal.js#L49-L53\nor jest.mockImplementation might be helpful.\nHope this help :). ",
    "bvaughn": "\nCould you add a test for these cases? It's my fault those don't already exist :)\n\nYup, sure. I'll add another test.. Is this what you had in mind, @acdlite?. Aye, this test fails if you revert the change to ReactFiberBeginWork.. Roger that. ~~I'll append it to my existing sync PR.~~\nEdit: Added to reactjs/react-art/pull/109 and merged.. nit: I think it would be nice for us to alpha-sort HostConfig props to make it easier to scan for differences between fiber renderers. (At least it helps when things are changing fairly often due to fiber being in-flux.). Great suggestion. I will update the flow types in this PR as well.. I don't actually know enough to answer that question. (Maybe someone who knows more about Fiber than me can chime in?). Actually I think this is correct as-is. Returning true from this method will create an RCText view with no visible text. Looking at the underlying react-native source, at least on the Java side, I think it is expected that such a text view should contain FlatTextShadowNode children.\nIf I update shouldSetTextContent to behave more like the DOM fiber renderer and return true for string/number children, then the apps I've been testing lose most of their visible text.\nI believe that the current behavior (in this PR) of creating both RCTRawText and RCText views matches native stack behavior (eg <Text>string</Text> creates an RCTRawText view for the inner \"string\").\nPlease correct if you feel I'm mistaken here. I'm new so it's quite possible. \ud83d\ude04. Nice! This also eliminates the need for ReactNativeFiber renderer to bundle along the viewConfig with each instance as well.. Right, I understand. But that implementation wouldn't reduce the number of (native) views created, just the number of Fibers. And it's not clear to me that the additional complexity added to the renderer's createInstance (checking if type is RCTText and children are stringifyable) is a worthwhile trade off. So I thought to err on the side of a simpler renderer, at least for this initial pass.. Agreed. From a renderer's perspective, this is something that could be made simpler to implement. Maybe it will change.\nHow about for this PR, I'll add a TODO comment to revisit this specific area? \ud83d\ude04 . Aye, that's what I was thinking by\n\nFrom a renderer's perspective, this is something that could be made simpler to implement.. Good catch. Yeah, this change can be reverted.. This was git mved from the pre-existing ReactNative.js. The only modifications to this file was the @providesModule name and the 6-line findNodeHandle.injection calls.\n\nI'll delete the comment though.. This was also git mved from the pre-existing ReactNative.js but I'll delete the extra line! \ud83d\ude04 . Hmm. I didn't modify this code other than to add the type-cast. But you're right. It looks fishy.\nReactNativeAttributePayload.create may return null if no props have changed. So that return type is correct.\nThe Java implementation of updateView doesn't specify a @Nullable annotation for the incoming payload param, but the underlying UIImplementation class does check for null before doing anything with them.\n~~I think the right thing to do here though, regardless, is to check for non-null before calling. I'll do that.~~\nActually I think the right thing to do is to change the flow type to annotate the property as nullable. Because the native implementation handles nullable props for both createView andupdateView functions.. Sorry. I missed this comment. Let me add an assertion, as you say! \ud83d\ude04 . Gah!. Seems like maybe this PR comment should be an inline comment so it doesn't get lost or forgotten?. I could move the call to instance.render into a separate function that is try/finally wrapped to minimize the impact. (I'm not an expert with the whole inlining area.) In its currently form I think it would be difficult to fix things in unwindContext.\nAlthough I'm working today on an effort to combine ReactFiberContext and ReactFiberHostContext and add fiber-level tracking so that we won't pop a Fiber more than once, or pop one that wasn't pushed. It will hopefully ease the pressure here a bit as it would enable us to just dev-warn and ignore the bad pop rather than throw an error.. At a glance, this change seems unrelated to the core of this PR, and also like the opposite of what the logic used to be. Was it a bug before? I don't see any other change inside of this PR that looks as though it would have invalidated the previous check, but maybe I'm missing it.\neg I would expect to see a change more like\njs\nconst isTopLevelUnmount = (\n  partialState === null ||\n  partialState.element === null\n);. Do we manually inline these 3 blocks (and the one in enqueueCallback) for performance reasons?. > The previous test was just wrong.\nGotcha. This is what I thought may be the case but I wasn't sure.. My initial thought was to go with null, but I noticed that ReactFiberContext returned emptyObject in a few cases so I followed that pattern. I'll change it to null. Probably best to have the emptyObject fallback happening in ReactFiberContext rather than ReactFiberStack anyway.. Passing a default value feels a bit awkward since (at least for now) none of the cursors have meaningful defaults. But the generics benefit is nice! So sure! \ud83d\ude04 . That is correct. At least in its current form, #8611 unifies these context stacks so that it is no longer possible to reset them independently. You can only reset both or unwind both to a current Fiber.. Absolutely.. I thought about doing that, but then I'd lose the ability to differentiate between \"empty\" and default-state. Which isn't really important in this case but... slightly more compelling is that it would also mean the cursor would have asymmetric behavior- false by default, and then null after the stack gets reset (since we don't track and fall back to the default value). It seemed worth doing the cast to avoid that, but I don't feel strongly about it.. Good catch.. Sure. It's a little weird either way I guess. I'll drop the cursor from reset and just manually clear the current pointer :). Ok. :) I'll go ahead and make that change then. I don't feel strongly about it. . Good suggestion.. You are correct\u00a0of course! \ud83d\ude01  That turnery was a holdover from when I was pushing/popping incorrectly. D'oh.. Seems slightly weird to bypass the contexts and talk directly to the stack they use, no?\nBut sure. I can change that.. nit: This comment makes sense to me, with the context I have, but might not be sufficient explanation for someone seeing this part of the code for the first time. Maybe we should elaborate about why we use the previous one. Maybe even just a pointer to see the comments in pushContextProvider?. \ud83d\udc4d . Curious why you're using throw here instead of invariant? (How do we determine when to do one vs the other?). Isn't previous actually the value at valueStack[index]?\nCurrent is in cursor.current and previous is the top item in the stack (at index).. PS I was already thinking about doing this, but I believe I'll submit a follow-up PR that adds some unit tests for ReactFiberStack itself.. This check is unnecessary. We only care about < 0 which is already checked for above.. No problem. I'll add some tests for this specific type of thing. \ud83d\udc4d . Rather than \"unnecessary\" I should have said \"bad\" because it would prevent the default value from being returned as previous if one was set. (eg like the default for didPerformWorkStackCursor). Thanks!. Right \ud83d\udc4d Sorry. This wasn't quite ready for review yet. I probably shouldn't have opened a PR yet. I just like to track my thoughts-in-progress via PR. Once it's ready I'll assign a reviewer.. Good call! I've updated the description to be more clear. \ud83d\ude01\nI thought everyone else was on holiday today!. I attempted to explain my reasoning in my previous comment. Some of it is subjective.\n\nThat change would introduce asymmetry between prepareUpdate and commitUpdate. commitUpdate would be called for newly-mounted components as well as pre-existing ones but prepareUpdate would only be called for existing ones. (Technically we could call prepareUpdate during initial mount as well but it seems unnecessary.)\ncommitUpdate would be called during different times, depending on whether the component was initially mounting (in which case it would be called during commitAllLifeCycles) or whether it was an updated to a pre-existing component (in which case it would be called during commitWork).\nAdding checks to handle possible null values for oldProps for all renderers just to support a specific on-mount use case for one renderer felt (subjectively) wrong.. > In fact the code to handle this is already in master. You deleted it in a previous commit but I think if you add it back, it will work now that the host component is scheduled to update on initial mount.\n\nThe previous code was in setInitialProperties which is only called by finalizeInitialChildren which happens too early (during complete not commit).\nIf you are referring to moving it into updateDOMProperties, then correct me if I'm wrong, but doing that would cause us to call domElement.focus() more than just on initial mount- which is not the way autoFocus should work.. I dig it.. Shoot. Thanks!. If that's the case, why does the ClassComponent case check for it: https://github.com/facebook/react/blob/9e461c715cb22523764b37c783fd37cf9b878fb5/src/renderers/shared/fiber/ReactFiberCommitWork.js#L406. Ah, right. That makes sense. Ok!. Given that syncUpdates immediately executes the callback you pass it, why is the new newRoot variable necessary?. You've already checked if (failedWork) above. This check seems unnecessary.. Curious why this is a TODO instead of actual code. Is it more difficult than it seems?. Nit: This test could produce a false positive if either batchedUpdates or syncUpdates happened to defer the callback. (Which I guess is super unlikely so maybe this doesn't matter.). I'm curious what motivated this method signature change. At first I thought it might be to support nested calls to commitAllWork (between the call to prepareForCommit and resetAfterCommit). But I don't think that's a use-case we support. commitAllLifeCycles might generate more work, but commitAllHostEffects shouldn't- right?\nI'm probably overlooking something. \ud83d\ude01. If batchedUpdates didn't immediately execute the provided callback, the test would complete without any assertions (since it's not an async test) which could potentially give you a false positive if there was a failing assertion inside of the inner callback.. You could guard against this with:\njsx\nit('can force synchronous updates with syncUpdates, even inside batchedUpdates', (done) => {\n  ReactNoop.batchedUpdates(() => {\n    ReactNoop.syncUpdates(() => {\n      ReactNoop.render(<span />);\n      expect(ReactNoop.getChildren()).toEqual([span()]);\n      done();\n    });\n  });\n});\nBut yeah I agree, probably not necessary. \ud83d\ude04. I reverted your most recent commit (79f01b2) and ran all tests, and you're right. Looking at one of the failing tests, it seems that unmounting from a componentWillUnmount hook eventually results in more sync priority work being scheduled.\nOkay. You're right, this seems less fragile anyway. \ud83d\udc4d . Good suggestion.. This expectation won't be evaluated. It could fail and Jest won't catch it because you've already called done in componentDidUpdate above. To resolve this you could set a bool (eg componentDidUpdateCalled = true) in componentDidUpdate above, verify it here, and then call done() at the end of the sync update.\n```jsx\nit('nested updates are always deferred, even inside unbatchedUpdates', done => {\n  let instance;\n  let componentDidUpdateCalled = false;\n  class Foo extends React.Component {\n    state = { step: 0 };\n    componentDidUpdate() {\n      if (this.state.step === 1) {\n        ReactNoop.unbatchedUpdates(() => {\n          // This is a nested state update, so it should not be\n          // flushed synchronously, even though we wrapped it\n          // in unbatchedUpdates.\n          this.setState({ step: 2 });\n        });\n        expect(ReactNoop.getChildren()).toEqual([span(1)]);\n        componentDidUpdateCalled = true;\n      }\n    }\n    render() {\n      instance = this;\n      return ;\n    }\n  }\n  ReactNoop.render();\n  ReactNoop.flush();\n  expect(ReactNoop.getChildren()).toEqual([span(0)]);\nReactNoop.syncUpdates(() => {\n    instance.setState({ step: 1 });\n    expect(componentDidUpdateCalled).toBe(true);\n    expect(ReactNoop.getChildren()).toEqual([span(2)]);\n    done();\n  });\n});\n. \ud83d\udc4d . It isn't! Good catch. Removed. \ud83d\ude04 . Don't we have the same potential problem below for the `ReactPureComponent` state check?jsx\n!shallowEqual(instance.state, newState)\n```\nShouldn't this function always use memoizedProps and memoizedState? (Can we also just remove the redundant oldProps parameter?). These all 3 point to essentially the same place. Is there value in having them as separate links?. Fair enough.\nI think readers might have an expectation of more substantial/lengthy content in the first 2 sections since they're separate links. But it's definitely just a nit; I was just thinking out loud. \ud83d\ude04 . Shouldn't we also do this reset before componentWillReceiveProps? and componentWillUpdate?\nI think this argues for putting the reset at the start of updateClassInstance- so the other 2 lifecycle methods aren't called with stale props. Also, this way, even if the user doesn't define shouldComponentUpdate the instance attributes will still be synced before render is called.. Extra t on the end ^\nIsn't this unnecessary though?\nunmountComponentAtNode calls renderSubtreeIntoContainer which calls validateContainer which throws- just with a slightly different error message (eg \"Target container is not a DOM element.\"). Maybe a better fix would just be to update the ReactMount-test to expect the slightly different error message based on ReactDOMFeatureFlags.useFiber?. \ud83d\udc4d . No, the earlier commit wouldn't have made it past CI (unless someone merged without noticing). I just ran master to verify and the fiber snapshots look right.\nI also just ran your branch locally and the fiber script moved those 2 entries out of the failing tests and back into the passing ones. Did you perhaps run it with some other local/uncommitted changes?. CI agrees with my local results: https://circleci.com/gh/facebook/react/638?utm_campaign=vcs-integration-link&utm_medium=referral&utm_source=github-build-link\n\n. Would it help to only track this on context consumers?. I agree. I mentioned that as a hack in the PR description.\nI could move the setting of that hidden field into a helper function inside of ReactFiberContext to at least keep the naming of the field there. Briefly considered doing that initially.. Is #8723 an improvement?. The thing that makes this tricky is that instance won't always exist yet when getMaskedContext is called. That's the whole reason the separate function exists at all.\nWhat would you suggest?. You are correct. We do not need instance for that. I just mentioned that we need to do some kind of duplicate work since instance won't always exist.\ngetMaskedContext returns emptyObject for non-consumers. We could compare it? eg\n```js\nfunction cacheContext(workInProgress : Fiber, unmaskedContext : Object, maskedContext : Object) {\n  if (maskedContext !== emptyObject) {\n    const instance = workInProgress.stateNode;\nif (instance) {\n  instance.__reactInternalMemoizedUnmaskedChildContext = unmaskedContext;\n  instance.__reactInternalMemoizedMaskedChildContext = maskedContext;\n}\n\n}\n}\n``. I assume thatgetMaskedContextreturnsemptyObjectinstead ofnull` for a reason.\n\nWe could but it seems a bit fishy to make one perf optimization to rely on another perf optimization being present in another file.\n\nThis all inside of ReactFiberContext. What's the other file?. Ah! I think I understand.. Yup. Thanks for clarifying. \ud83d\ude04  Updated.. Sure, we could do that. I didn't do it initially because it seemed unsafe. Fiber may not have an instance and I didn't wan to rely on external callers of this function having to know only to call this method when an instance existed.. We could. Same safety-related concern as above.\nEdit: I think I'm going to leave this as-is since we call getMaskedContext in half a dozen places and it seems to easy to mess up if we require all callers to check isContextConsumer before calling.. PS. I'm happy to defer to your judgement here. You're more familiar with the project and the way things are done. Just sharing my thought process. \ud83d\ude04 . Okay. I understand your thoughts now. Thank you for elaborating.. Great suggestion Dan. Thanks!. Deduped and a new test added. Aye, the PR summary noted that:\n\nIE8 compatibility note\nNote that this PR also drops use of the focusNode helper method since it was in place for IE8 and IE8 support was officially dropped in January 2016.\n\nSeemed wrong to keep an abstraction around solely for compat with a browser version we no longer support.. Meh https://flowtype.org/docs/functions.html#too-many-arguments. The problem is that tests (at least ones I spot-checked) are already asserting that errors occurred (eg spying on console.error and asserting a specific number of calls). This increases the number though and so the tests failed.\nI wanted to limit the size of this commit. But I'd be happy to update the 20-30 tests if you guys have a strong preference. \ud83d\ude04 \nEdit: I'll swap the 2 console.log calls with a single console.error call and update the tests accordingly.. This is proving to be a little complicated since Stack doesn't behave the same as Fiber in terms of error-handling behavior. It isn't a matter of just adding console.error calls to Stack.. I think an appropriate solution for now is to globally mock ReactFiberErrorLogger (so that Stack and Fiber maintain parity regarding console.error calls). This prevents our tests from forking all over the place.. This is awkward. I'm not sure how to test both unmocked and mocked without explicitly doing this.. Was just mirroring what's in the rest of the class. I'll replace it with ES6 syntax though. I prefer that anyway.\nWrote this test first, mirrored the rest of the class, wrote the other test afterward and used ES6. Not sure why. \ud83d\ude05 . This component is only used by Stack so you don't need to handle Fiber components; the Fiber equivalent is ReactDOMFiberComponent. (If you did, tag wouldn't be the right attribute; it's just a constant/number. getComponentName can be used to log the display name of stack-or-fiber components FWIW.) :smile:. Pretty sure you actually meant this to be \"%s iscontentEditable...\" similar to the changes you made in the fiber component? (The messages should be the same between Fiber and Stack, no?). This check is still necessary.commitMountwill be called for host components with refs even iffinalizeInitialChildrenreturnsfalse. (The \"_preserves focus_\" test inReactDOM-testcovers this case indirectly.). True! What other sorts of work do you thinkfinalizeInitialChildren` might want to schedule? (I'd prefer to think of at least one other likely use case before adding a constant.). Hm, I think you're right, but there's this: https://github.com/facebook/react/blob/3bc5595dfd6db741b19f17e7aef98b2c1e4be847/src/renderers/shared/fiber/ReactFiberCompleteWork.js#L240-L243\nI think this is actually not intentional. I'll follow up on it. \ud83d\ude04 . Follow-up on #8779. Yes good catch.. I had no idea. Thanks for the catch. I'll push up a small fix shortly.. Hm, yes I suppose it would be. \ud83d\ude04. Agreed. Hadn't considered the multiline case. Shouldn't code before \u2615\ufe0f \ud83d\ude01\nI think this version (just pushed) is more robust. Tested various browsers with single-line message, multi-line message, and no message.. Edge-case in message content and browser formatting differences are why I initially just logged error.stack by itself. The \"thrown at\" header and stripping the redundant error message (in the case of Chrome) were suggestions from others (above).\nThough FWIW I think the stack, by itself, is not as intuitive without the header and formatting for certain browsers.. Thanks for pointing that out Ben.\nThe latest commit has been tested with single-line\u00a0message, multi-line message, no message, and messages containing special regex chars.\nBrowsers tested: Chrome, Firefox, Safari, IE. Test is now erroring with TypeError: Set is not a constructor whereas before it was just failing with an expectDev. Thinking out loud: performance.now() and Date.now() return very different values but they're being used interchangeably, driven by the param passed to requestAnimationFrame. Wouldn't this cause problems if we ever end up mixing the 2 due to polyfills? (requestAnimationFrame is supposed to be passed a time from performance.now() but some polyfills are Date based.)\nFortunately I don't think this is likely to occur. It seems both are supported by everything we target except for:\n IE9, which supports neither; presumably this means we'd use Date.now for both.\n iOS 8.4 which supports requestAnimationFrame but not performance.now. This version is 2.5 years old though and iOS has pretty strong upgrade adoption, so maybe we can just ignore this one point release.. IE9+ supports addEventListener; as we no longer support IE8 this should be fine. \ud83d\udc4d . My apologies. I was unaware of this.\nI think there are a couple of other places where we have warning outside of __DEV__ (eg ReactDOMFiberSelect). Should we clean these up?. Rather than bypassing the lint check, seems better to split params across lines:\njs\nfunction renderSubtreeIntoContainer(\n  parentComponent : ?ReactComponent<any, any, any>,\n  children : ReactNodeList, containerNode : DOMContainerElement | Document,\n  callback: ?Function,\n) {\nThis is what we normally do (eg createInstance above).. This isn't how we normally indent params. Check out createInstance or prepareUpdate above for examples.. nit: Same as above.. nit: Same as above.. nit: Probably better to split string across lines rather than bypass lint rule (eg like here).. Same as above.. nit: ); on new line is more readable (eg see here). Same as here for various methods in this file.. Probably better as:\njs\nmodule.exports = function<T, P, I, TI, PI, C, CX, PL>(\n  config : HostConfig<T, P, I, TI, PI, C, CX, PL>\n) : Reconciler<C, I, TI> {. This changes the logged text (adding empty space and line breaks in between \"merged,\" and \"should\"). This isn't desirable. Can you split this text like you did above (in scripts/release-manager/cli.js)?. \ud83d\udc4d . Same comment as above! \ud83d\ude04 . Guh. Sorry for missing it.. Yup. Noticed this when fit() running the test.. This callback || null is now unnecessary.. This PR is just me poking things a bit and familiarizing myself with the problem. Sebastian and I are going to talk more about it when he gets in this morning. \ud83d\ude04 . Sure, sure \ud83d\ude04  Changed and force-pushed. This check seems unnecessary, other than for flow, since we're within a __DEV__ block. I liked Dan's suggestion below- to use a different type for dev/prod so we can avoid all of the unnecessary not-defined checks below.. Good point, Ben. \ud83d\udc4d . Thanks for pointing this out Dan! Can we fix this in the rollup branch, along with the rest of the changes? (I hope this branch can be merged soon.). Yeah, I feel you. As soon as we drop ReactNativeStack a lot of the nasty injections and potential circular deps go away.. nit: Curious why not move canDefineProperty and warning require statements into this __DEV__ block so you can get rid of this check? They're only used here.. \ud83d\ude06 Yes, ignore me.. Sure!. Done.. What's this refer to? Maybe accidentally left over from before?. This is the old way of doing things. The new way should be:\njs\nconst ReactShallowRenderer = require('react-test-renderer/shallow');\nconst renderer = new ReactShallowRenderer();. nit: I think we might want to rename these to ReactShallowRenderer to reduce ambiguity between what's returned by the import (the class) and the instance you render with.\njs\nimport ReactShallowRenderer from 'react-test-renderer/shallow'; // ES6\nvar ReactShallowRenderer = require('react-test-renderer/shallow'); // ES5 with npm\nI should have mentioned this before. Sorry.. Why does the perf pointer change?. Ok. I didn't make the connection.. Let's change the prop-types link to https://www.npmjs.com/package/prop-types?. D'oh! Habit. I'll undo this change and update the packages/*/package.json files instead \ud83d\ude04 . DOM does check too but it uses React.checkPropTypes. Rollup also only complained about the externals reference for isomorphic.. \ud83d\udc4d . I gave an example below (in the comments) of what it maps the requires to but I'll update it to be a bit more explicit. Basically if it partial-matches one of the keys (eg prop-types/checkPropTypes matches prop-types) then it stops searching and uses a path like prop-types/index.js/checkPropTypes.js. Yup!. Sweet. Will do.. Nice! I'll try that. \ud83d\ude01 . Changed in afdc9d2.. Yeah totally. I'll remove the word \"temporary\". Words are hard \ud83d\ude05 . That is a bit silly, now that you point it out. It was unintentional. src/isomorphic/classic/types/checkPropTypes.js just forwards to prop-types/checkPropTypes. But I can remove the unnecessary indirection. \ud83d\ude04 . Locally I've pointed entry and fbEntry at the same file. (Haven't pushed yet.). I considered throwing, but I thought it would be immediately obvious when you tried to use it. I guess I can throw a more meaningful error message at least, sure!. nit: Curious why we're checking the stack portion in all of the above tests but not this one. Seb and I chatted about this idea in person. He didn't seem to, but I'll let him comment here (or I can follow up with him in person on Monday). Sure!. > Otherwise it looks like we stopped testing shallow renderer in Stack at all.\nThis new shallow renderer is fiber only. Seemed like too much effort to create a new one that supports stack and works with our new bundles- just to throw it away. (I mentioned this in the description but maybe it wasn't prominent enough.)\nI'm not sure how to address www yet. I'll give it some more thought. \ud83d\ude04. > Or should we create prod versions of all of them?\nI don't see the value of this, and it would cause problems with __DEV__ only things like the non-enumerable _owner attribute.\nI'll throw in the main test renderer too, sure.. Done!. Yeah, totally understood- and I'm glad you bought it up. I'll figure out a strategy for www tests with stack once the fiber bundles and renderer is solid. \ud83d\ude01 . This would only re-trigger if the ReactElement returned from the top-level render was a class component with propTypes. In that case, it still wouldn't show a duplicate message because checkPropTypes tracks loggedTypeFailures and avoids re-logging duplicates.\nDo you think this is reasonable? Should I look for a way of bypassing checkPropTypes for this case (or some other approach)?. Key warning will only log once as well.\nYup, much appreciated for the double check. \ud83d\ude04 . Good catch, @koba04.. Ah, sure, looks like it should. I wasn't aware of that.. Fair enough. Although we have tests for some lifecycle hooks (eg componentWillUnmount) so it seems weird not to have cDU. I guess you're right though, that without access to host refs it's a bit weird to call this lifecycle hook.. Pretty sure I saw that we had tests internally that depend on cDU being called for shallow rendered components.\nWhat's the concern with calling this?. Sure. We aren't super consistent with how we check. This ^ was just mimicking the way we check in a few places I saw- but if prototype.isReactComponent is the more recommended way I'll switch. :). We actually don't have that many uses of shallow renderer in www tests.\nI'll remove cDM though and add an inline comment about why we do it!. Good call.\nI recall now that it was while testing Enzyme that I noticed the expectations that componentDidUpdate will be called.. Those places do it the way you mentioned- which is great, I'm happy to change to that. \ud83d\ude01 \nThere's a few places we're check for a render function too but they're probably just older:\n ReactFiberBeginWork\n reactComponentExpect\n findNodeHandle\n findDOMNode. Yup! I had already added lifecycle hook tests in this PR. \ud83d\ude04 \nI'll update to match the fact that we won't call cDM.. Good clarification.. No no. Your previous comment totally made sense. \ud83d\ude01. Hm, that's interesting. It's a little confusing to trace through their tests because of how they're structured. it blocks often depend on state initialized by a parent describe block so it takes a bit of scanning back and forth, and there's a couple of flags (eg lifecycleExperimental, disableLifecycleMethods) that change things.\nI believe you're right though. I'll try to mimic the old shallow renderer behavior in this regard, even though I don't understand the reasons for it. \ud83d\ude41 . \ud83d\ude06  Agreed. So much nicer!. Nope! I fat fingered it in PR #9399 in prep for alpha 10.. This points to the same PR as above. Mistake?. Actually these all point to the same PR. Think maybe you meant to link multiple bullets to PR #9385?. I think they were actually made in PR #9385 though, not PR #9383. Wouldn't that leave the same problems I was trying to solve by injecting it?. Oh. Maybe I misunderstood what you were suggesting them (and I actually don't know after all). Could you give a more concrete example?. Yup, this is on the Quip doc checklist. Initially I saw SE was being required a dozen or so places internally but then realized it was a built-in type and just haven't ticked off that item yet. Thanks for pointing it out though! \ud83d\ude01 . Should we use emptyObject here?. empty object :D. Should we be manually updating bundle sizes like this? I feel like I'm still never sure.. I don't like this idea. I think it is asking for troubles when it comes to merge conflicts.. I just feel like that will cause a lot of problems. We're basically guaranteeing that every merged PR will conflict every other PR, requiring master-merges or rebases, etc. It seems like, in the extreme, we'll have total gridlock. And unless we always rebase and rebuild before merging, we can't trust the file sizes in the results file.. Now we have another mostly synonymous term to add to the mix \ud83e\udd21  current, in-progress, progressed, newest. I'd prefer to use NativeMethodsMixinType and add a \"TODO\" comment to replace it with an interface once NativeMethodsMixin is gone. This works (I tested it a few days ago) and avoids having to maintain mirror types.. This is redundant with the NativeMethodsMixinType type already being used.. Oh, rats! That's unfortunate. \ud83d\ude26 \nIn that case, then I guess the duplicate type is a reasonable workaround. If we use it, we should just remove the (ReactNativeComponent.prototype: NativeMethodsMixinType) cast too I guess.. This can be removed too \ud83d\ude01 . And this :grin:. The deprecation warning added in this PR is about DOM factories rather than createClass. Did you tag the wrong PR? Seems like this meant to go with the line above.. > Or it doesn't run in some Node version?\nThis was the reason.\n\nI'm just hesitant to add comments that aren't checked by a tool, and pretty much repeat the code.\n\nAgreed that comments are kind of no-value-add here. They're a bit of extra maintenance burden but otherwise you might as well just scan below.. Should this actually be?\njs\nwarning(didCatchErrors, 'React DevTools encountered an error: %s', err);. Should this actually be DevTools 2.3.x and earlier?. Right. If the first parameter is false the warning will be printed. You init didCatchErrors to false and then set it to true after calling warning but... you invert the value when you pass to warning (!didCatchErrors) so... won't this skip the first warning, and print every one after it? (Isn't that the opposite of what you want to do?)\nAm I misreading this? \ud83d\ude05 . I think this still calls out the wrong version of DevTools. No worries \ud83d\ude05  Seemed equally plausible I was just misreading it.. Yes. I only added enough things to prevent the repro steps from crashing.. Ok!. Schwoops.. Yup! Testing that now.. Agreed, that's nicer. Thanks for pointing out the obvious. \ud83d\ude04 . Yeah, that would be better. \ud83d\ude04 . I think this link no longer exists?\nShould we instead link to https://facebook.github.io/react/docs/optimizing-performance.html#use-the-production-build. nit:\njs\nparentInstance: Instance,. nit:\njs\ncontainer: Container,. So far as I know (based on very limited testing) that would work.. Actually I think I was creating a new object to handle the case of a string or null being thrown (instead of an Error) but I can just change the code to only create a new Error in that case.. \"supernit\" \ud83e\udd23 . Wish we had a better way to test this~ but there's precedent in at least a half dozen other tests so it's probably okay. \ud83d\ude01 . Sure \ud83d\udc4d . Hm. I thought it seemed nicer to always trim. (When wouldn't you want to?). Sorry, I actually meant more specifically- in this file- it didn't seem like we actually wanted/needed untrimmed output. I agree with you in general.\nBut I don't feel strongly about this so I'll revert that part of the change.. FWIW I considered this but thought it wasn't worth the tradeoff- (regex is much slower)- given that the DOM render would warn about onions when the client took over.. Yeah, it's probably not enough of a difference to actually matter. And it's dev-only anyway I guess.\nhttps://jsperf.com/asdiohsd. spelling nit synchronously. This code was added in 673f514 for an alpha release and is no longer around (apparently).. This is wrong \ud83d\ude26 . Looks like the Rake copy_error_codes task just wasn't run. That's why the map is out of date.. I like this suggestion. Check out the most recent commit. It cool?. This change shouldn't be relevant for functional components, since it's specific to context-providers. Functional components can only consume context, since there's no underlying instance. Right?. Oh Edge \ud83d\ude1d . I think the wording of this message is a bit confusing. Maybe we could say something like this instead?\n\nDownload the React DevTools for a better development experience: https://fb.me/react-devtools\nReact DevTools works best if you use an HTTP server (instead of file://URL).. This a nit.\n\nI like the change to always export a function from this file!\nonCommitRoot and onCommitUnmount get fired a lot though. I wonder if it wouldn't be slightly better to export emptyFunction for them (if typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ === 'undefined') and avoid having to do this check all of the time?\nProbably this won't actually matter.. Why typeof error.__reactShouldIgnoreErrorMessage === 'boolean' && error.__reactShouldIgnoreErrorMessage instead of error.__reactShouldIgnoreErrorMessage === true ?. Might be easier to read if the if/else condition above were collapsed into:\njs\ncapturedErrors.set(boundary, {\n  componentName,\n  componentStack,\n  error,\n  errorBoundary: errorBoundaryFound ? boundary.stateNode : null,\n  errorBoundaryFound,\n  errorBoundaryName,\n  willRetry,\n  shouldIgnoreErrorMessage: __DEV__ && error != null && error.__reactShouldIgnoreErrorMessage === true\n});. React DevTools work for me if I load the react-virtualized demo site via file://...\nI just found the wording of this message confusing when I initially read it. (Haven't seen it before.). No. During stripEnvironmentVariables, __DEV__ would be converted to true/false.. Really \ud83d\ude10 . Sorry, I think this is kind of a tangent. I wasn't suggesting that the content/meaning of the message was invalid, just that the way it was worded before was confusing to me and it might be clearer if we broke it into 2 sentences. \ud83d\ude04 . Ah, yeah that's fair. What about\n\nDownload the React DevTools for a better development experience: fb.me/react-devtools\nYou should also use a local HTTP server (instead of file://): fb.me/the-react-devtools-tab-doesnt-show-up\n\nFeel free to ignore this if it's getting too bikesheddy.. I'm confused. You have it in an if(DEV)/else currently, which won't be DCEd.. Nice!. I'm confused. This PR adds the following:\njs\nif (__DEV__) {\n  capturedErrors.set(boundary, {...});\n} else {\n  capturedErrors.set(boundary, {...});\n}\nI suggested collapsing this if/else branch b'c I thought it was more readable. I don't understand how DCE applies here, since neither approach would actually get DCE'd.. Ah, I misunderstood your concern then. So you could have done:\njs\n__DEV__ ? error != null && error.__reactShouldIgnoreErrorMessage === true : false\nBut yeah \ud83d\ude01 . Ah, yes. Nice catch.. We can, although this will also require updating a couple of references to this transform in the docs.. Yeah, that's what I did. Was just mentioning it since the diff now contains docs changes also. \ud83d\ude04  Sorry for being unclear.. Agreed.. should be\njs\nthrows={() => new Error('Oops!')}\nelse we end up throwing undefined. Actually, given the name, it should be:\njs\nthrows={() => {\n  throw new Error('Oops!');\n}}\nAnd then we should just remove the throw from BadRenderer. We should remove the message and name variables now. They don't seem to be used anymore.. Nit: Might be nice to leave a placeholder comment referencing why we decided not to call cDU. ~~Isn't it only a dev issue though? Since in production we use a regular try/catch instead of the funky global handler~~\nSorry. I read your statement twice as \"to re-emphasize that this isn't only an issue in dev.\". nit: The name of this option threw me a bit. To me, \"deep\" relates to the location within the tree but seems more like returnFirst?. That's not how I'm understanding the code. Isn't it a choice between:\n If a component matches, return it, otherwise return the first descendant that matches.\n Return the component and any of its descendants that match.\nI think the thing that I find confusing is that deep:false can still return a matching descendant (if the component doesn't match).\nAm I misunderstanding this?. Ah, I understand. \ud83d\udc4d . Sure~. Great question. I was on the fence about this. I'll remove it for now. \ud83d\ude04 . Thanks! That must have come in after I posted this. I'll use that wording.. Uncertain. Chrome was the only browser I tested that demonstrated this behavior- but it's also the most commonly-used browser.. Proper headers are listed below as 1 of the 2 possible causes.\nMaybe something like this?\n\nYou can simplify the development/debugging process by ensuring that errors are thrown with a same-origin policy. Below are some common causes of cross-origin errors and ways to address them.\n\nWe can also always tweak this wording later.. I believe I saw this behavior when I removed the devtool setting entirely. I also saw reference online about it defaulting to \"eval\" but looking at where I think it's set in their code, that doesn't seem to be the default.\nI will confirm now.\nEdit 1: It looks like if debug is on, they may default to eval-cheap-module-source-map. (I'm not at all familiar with this codebase so I'm not sure how these pieces fit together really.)\nEdit 2: I'll just back down the wording here (for now) to be a little less broad. We can tweak it later as we learn more about it.. I'm curious- why does this need to be enumerable or configurable?. enumerable perhaps but I don't think it should be configurable. (Both of these default to false by the way, which I think would also be reasonable in this case.) \ud83d\ude04 Not a big deal though just sharing my thoughts. It felt weird for a getter that might throw to be enumerable. I don't hold this opinion strongly though. \ud83d\ude04 . I considered mapping componentStackFrames through describeComponentFrame for the componentStack string (rather than re-crawling the graph) but decided it wasn't worth it given that we don't hit this code path often.. Yeah. We access these properties outside of DEV blocks in other places, but with null-checks. So I did the same here.. Based on this list of React types in Flow, React$Component seems a legit type. Also, commit 3a920c6 was me running the flow-upgrade utility provided by Flow, and it also inserted a bunch of React$Component types so... it seems okay?. To be honest, I'm still a little unclear on when we should be using one vs the other, but I think you're right that the Node type would work here.. Interesting. So I just took a closer look at the Flow upgrade script and saw this comment:\njs\n// Update the type identifier to be `React.Element` or the\n// equivalent global.\nnode.id = reactName ? j.qualifiedTypeIdentifier(j.identifier(reactName), j.identifier('Element')) : j.identifier('React$Element');\nSeems like that implies the React$Component type is a global and is safe to use? Which lines up with the usage of it that I see everywhere.. Gotcha. I believe I misunderstood what you meant by \"internal name\". \ud83d\ude04 Thanks for clarifying.\nSeeing as how we were already using these types (via the ReactComponent and ReactElement aliases we declared) I think it's save to move forward with this PR and follow up later based on feedback from @calebmer!. I use viewConfigCallbacks to check for view name uniqueness. Nulling out prevents us from blocking GC while avoiding having to check both viewConfigs and viewConfigCallbacks maps.. Whoops ^. Whoops ^. This works but I think we'd be better off doing this check in gatsby-node like we do for the Home page.. Whoops! I missed this.\nWe can't have window references in code that's auto-executed as part of an import b'c they break the Gatsby build step. I'll remove this one! \ud83d\ude04 . Same here as with window. Should be:\njs\ndefaultActiveSection={\n  location != null\n    ? findSectionForPath(location.pathname, sectionList)\n    : null\n}\nWe also need to pull location from Gatsby rather than relying on the global.\nMy bad for overlooking.. Agreed with keeping the \"JSX is optional...\" bit. Don't feel strongly either way about linking to the Babel REPL.. :grin: I do kind of like this notion now that I think about it more. That's interesting. I'm curious why we have to include the copy of hex2rgba in node_modules here, given that we declare the module below?. (At least until we have Flow covering us) maybe we should initialize titlePostfix to an empty string (to avoid potentially adding \"undefined\") to the generated title below?. FWIW will be reactjs.org\nAnd I think we should just do it now. The new site will probably never really be live at github.io.. Ah! Yes, good suggestion.. Just curious- was this actually necessary?. Gotcha. I assume this has to do with the version of Node you're using? Not sure which version added support for the object initializer shorthand syntax. Think this was part of ES6/ES2015.\nOh well \ud83d\ude01 . This line causes errors for me.\nyarn build fails with:\n\nWebpackError: Cannot read property 'items' of null\n\nyarn dev shows a runtime redbox with:\n\nTypeError: Cannot read property 'items' of undefined. Note that I happened to have this page open when running yarn dev:\nhttp://localhost:8000/blog/2013/06/12/community-roundup.html. Maybe rather than passing in isFooter we could support additional custom CSS? (Since only one instance of Container would have the footer CSS).. Why'd the \"alt\" get removed? Accident?. Why not display: none ?. I'm not sure I care for the newly-added media constants. The API was kind of built to make sense with sizes but the new strings are kind of more arbitrary. This query particular is pretty confusing. \ud83d\ude01  What does it mean to be between xlargerSmaller and belowSidebarFixed?. I don't think these constants make sense, (paricularly xlargeSmaller \ud83d\ude01 ), with the way the sizes were designed. If we need these new sizes, then\u00a0I think we should pick a few hard-coded media query values rather than try to make them work within the media methods.. These probably weren't intended to be left in ^. > aXe was picking it up that it was a duplicate of the title; which is apparently an anti-pattern\n\nI have never heard this. Interesting. So it's best to explicitly specify an empty alt attribute vs none at all in this case?\n~~Upon further consideration, I think images used as links should have alt text describing the destination of the link, not the image itself. So maybe this one should say something like, \"React home page\"?~~ Oh, I see what you're saying now.. Gotcha. This is gross. \ud83d\ude1b  But I think your logic is reasonable. The grossness is just browser stuff. \ud83d\ude01 . I might look into changing the markup slightly after this is merged to avoid this if you don't oppose it.. This isActive change is good \ud83d\udc4d  Thanks. nit brandDark ?. nit: subtleDark ?. Sure that's okay \ud83d\ude04  Feel free to ignore \"nit\" comments. Is this conditional correct? Or did you mean to have an || instead of an &&?\nCalling between(small, large, true) would create a media query with max-width even if the max size was Infinity. When would we want that?. I'm still confused. Isn't a max-width of Infinity the same as no max-width at all?. Ah... I see now that you're using ${SIZES[largeKey].min} below. Hm.. Prob needs better description?. It doesn't seem ideal that our test process involves editing content in node_modules. I would expect to see something more like:\nyarn install\nyarn build\nyarn test\nWhere the yarn build step just runs yarn build -- reconciler in the main project to build a copy of the reconciler.\nThen the test file (index.js I guess) should test something meaningful without any editing being required.. \ud83d\ude01 . Missing prop-types, fbjs, and object-assign dependencies?. Whoops. I thought I was looking at packages/react-reconciler/package.json instead of the one in fixtures. Disregard. \ud83d\ude04 . Strong initial dislike to all of the global handlers/selectors here. If we have to do this, I think we should wrap it up in a separate component rather than mix it into the sticky component.\nIdeally we could do this in a more \"React\" way (with props/refs) but I'd have to think about that a bit more. Might be harder to do.. It would be nice to avoid global styles for this. I suggest we pass an isOpen prop do this component instead and (probably) expose a toggle function to the sticky sidebar via context. (I'll be happy to help implement this change.). nit: Alpha-sort props \ud83d\ude04 . Yes. @flarnie or I can help with this though.. Weird that we have both of these. That was an accident on my part. Let's just remove develop \ud83d\ude04 . React itself aims to support IE9+ (see here) but I think it's okay if the docs site only targets 11+.. Should probably clean-up on close too:\njs\nif (this.state.isMenuOverlayOpen && !prevState.isMenuOverlayOpen) {\n  // add handler\n} else if (!this.state.isMenuOverlayOpen && prevState.isMenuOverlayOpen) {\n  // remove handler\n}\nB'c not all closes will reload the page (eg Tutorial section). Or we could just get rid of the previous check entirely:\njs\nif (this.state.isMenuOverlayOpen) {\n  // add handler\n} else {\n  // remove handler\n}. This method needs to be bound to the instance. Else it errors during runtime:\n\nOpen the mobile nav\nClick the \"X\" to close it\nTouch and scroll the page to drag\nConsole error:\nUncaught TypeError: Cannot read property 'state' of undefined\n  at t.handleTouchMove\n\nFix should be either to call .bind in the constructor (like you do for the other class methods) or use this syntax:\njs\nhandleTouchMove = (evt) => {\n  // ...\n};. \ud83d\udc4d . This redirect looks good \ud83d\udc4d \nI'm curious why we didn't remove everything from this file except the redirect code though (so it would load faster) since the content isn't being rendered anymore anyway? \ud83d\ude01 . Using ASTExplorer to quickly test, it seems possible for someone to specify multiple languages, via ```js something-else\nBut I don't think we actually do this anywhere, do we? (Just curious why we're doing indexOf and substring instead of just string comparison). Oh good point! I'd totally forgotten about our line highlighting syntax.. This came in from master - looks like it was accidentally added via PR #10824\nI've fixed it in this branch.. Cool. I suspected that was the case but hadn't had time to dig in yet. Thanks.. I don't understand?. What's the advantage to trimming \"index.html\"?\nIf there's an advantage in doing this, I suggest:\njs\npath.replace(/index\\.html$/, '')\nThis way we don't clobber a path like \"'some/blog/path/index.html'\". Should be the new header:\n/**\n * Copyright (c) 2013-present, Facebook, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @emails react-core\n */. What is site-constants ? Shouldn't this just be constants (to refer to the constants.js file in the root directory)?. Disregard this comment. I see the note about this.. A couple of these anchor tags are invalid b'c of how Gatsby handles them. For instance, this one should now be: reactjs.org/docs/react-api.html#reactchildrenonly\nBut this is not related to this PR \ud83d\ude04 Just mentioning it in passing.. I think we should revert this until we have a custom focus style. Focus outline helps with keyboard accessibility.. Without the outline style, there's no visual indicator of focus on the desktop site. There is on the mobile-sized layout, but outline is already suppressed there.\nAnyway. Thanks for reverting this bit. \ud83d\ude04 . I don't think this is actually being used for anything. At least, the feed doesn't display a <date> attribute or any dates in this format, but rather:\nxml\n<pubDate>Tue, 13 Jun 2017 00:00:00 GMT</pubDate>. What is the excerpt being used for? Looks like the feed has descriptions that contain the entire article.. Should this be more specific / less redundant? (If it's only used by the RSS feed, should it maybe say something more about what the RSS feed is?). I have a slight preference for subjective changes (like this) not to be included in PRs b'c they run the risk of unnecessarily churning code.. Ditto for this (subjective).. Not quite accurate. The index.md page specifically is just filled with HTML (see here) and Remark doesn't parse markdown syntax when it's within an HTML tag.\nWe have an issue filed to clean this up in the future (removing inline HTML+CSS from files like this) but for now this change is \ud83d\udc4d . Nice find.. Gotcha. Okay then. \ud83d\ude04 . This seems slightly prefable. Do we really need both alt and aria-label tags? (Aren't they redundant?). Why pass rssFeedTitle and rssFeedDescription? I think it should be sufficient to pass these via the re-named title and description keys only.. Seems like we only need site_url in this query, if we update site.siteMetadata.siteUrl below to be site.siteMetadata.site_url?. @KyleAMathews Why is this?. Gotcha. Thanks for the context.. No parentTag? (Is this inferred from the beforeTag?). Should we update this file or leave it until the next release we build?. TODO bvaughn \ud83d\ude06 . Is it okay to always make update calls (even if there are no changes)? We added a check to avoid no-op bridge calls for RN b'c of the expense.. We update props in commitUpdate and createInstance. Is that odd? Should it be  in commitUpdate and commitMount instead? (I realize you're doing the same thing React Native does \n but I'm questioning that now too.). The reason for this variable is not obvious to me.\n(I realize that it also exists in ReactNativeTagHandles.). My question was more about the fact that we update this during commit phase in one place and complete phase in another. I was asking if we should wait to update in commit phase in both places.. > The only quirk here is that this set will leak if it doesn't commit, which is a more general problem.\nThanks for clarifying. This is more what I was concerned about ^ but if this is a conscious decision on your part, then I'll defer to your judgement. \ud83d\ude04 . \ud83d\ude0d . nit: Might it be confusing that event ends up holding values like onTopChange instead of topChange? Maybe we should name it key or something instead?. Sure. Maybe that was just a poor example. My point was that the prop (key) usually corresponds to the event handler name rather than the event name. But maybe this new renderer is different?. Okay. Sounds like you've thought about this and it's intentional then so...cool. \ud83d\ude04  Thanks for elaborating.. nit: Seems inconsistent that this self-registers when other similar things are registered by a Injection or Entry file.. \ud83d\udc4d . It's not valid to define the same property twice. Instead use PropTypes.oneOfType([...]). Maaaybe but I am not a very big fan of WebDriver automated tests. \ud83d\ude04 . We can always follow up with that. I'm reluctant about introducing WebDriver into our release process. It's always a pain in the ass. But I won't be stubborn about it if others feel differently.. Good news is, the new release script should make preview releases easy too!\n```sh\n./scripts/release/build.js -v 16.1.0-rc.0\nDo manual fixture verification...\nOr run automated WebDriver tests if they exists\n./scripts/release/publish.js -v 16.1.0-rc.0\n16.1.0-rc.0 will be published to NPM with @next tag\n``. I also like the idea of automated tests for the fixtures stuff- but I would prefer not to put it into the release script. The release script could make mention of the automated scripts though, just not block on them.. Yeah, it's optional, provided the file has the executable permission, which it will \ud83d\ude04 . I actually generated it manually \ud83d\ude05  before remembering thefigletmodule heh. Yeah, probably just a difference between how I thought I'd write the code and how I ended up writing it. You're right thatasynccould be removed from this function.. Should just beserve`. My bad.. Want to take a stab at writing up some new bullets for this?. Hm. Why would we want to release reconciler independently? In the past, we've released react-* things in lock step (even though often not strictly required) b'c it's easier for external people to see and reason about.. Up to you I guess, but after would be nice.. Gotcha.\nI see 2 potential downsides for this change:\n1: It adds complexity to the automated process we are trying to streamline. (I'm not saying this a compelling argument not to do it but it is a downside.)\nWe could require a separate argument for the reconciler version- or we could require the release engineer to manually update it before hand but both are a worse experience for the release engineer.\nMaybe we should just handle the case of a version < 1 by auto-incrementing (eg 0.1.0 is less than 1.0.0 so we special case to auto-bump to 0.1.1). What are your thoughts? Is it important to be able to choose between 0.2.0 and 0.1.1 in that case or will a minor version bump suffice for pre-release versioning?\n2: I worry it adds confusion for end-users. It's a nicer developer experience to know that react-reconciler version X is compatible with react version X without having to rely on the (typically noisy, often overlooked) peer dependency warning mechanism.\nI think this is more important and we should aim to synchronize the version of react-reconciler with react as soon as the API stabilizes.. It removes empty lines. For example:\n``js\nstr =\na\nb\n`;\nstr.split('\\n') // [\"\", \"\", \"a\", \"\", \"b\", \"\", \"\"]\nstr.split('\\n').filter(owner => owner) // [\"a\", \"b\"]\n```. Hm. Interesting.\nI actually didn't think you could yarn upgrade if you hadn't yet yarn installed but it seems like you can.. Thank you! \ud83d\ude01 . That's part of the printed instructions once this script completes (in print-post-publish-summary):\n\nStep 1: Create GitHub release\n1. Open new release page: https://github.com/facebook/react/releases/new\n2. Choose ${version} from the dropdown menu\n3. Paste the new release notes from CHANGELOG.md\n4. Attach all files in build/dist/*.js except react-art. to the release.\n5. Press *\"Publish release\"!. > We definitely should not** be versioning the reconciler package together with other packages right now.\n\nYes, that's become apparent \ud83d\ude04  I didn't realize the degree of expected instability for this package because I haven't been following it closely.\n\nbut I think the low-maintenance \u201calways increment\u201d approach will work fine in the meantime.\n\nGreat.\n\nThere are, like, 10 end users.\n\nThat's a good thing to be reminded of.\n\nThere shouldn't be an issue with react <-> react-reconciler dependencies and we can safely say any react-reconciler version is friends with react@16. This is because we don\u2019t expose \u201cimportant\u201d things from react package anymore.\n\nI'm skeptical of this \ud83d\ude04  but so long as this is a temporary thing (unlocked versions) until the reconciler package stabilizes, I'm not opposed.. Great! How do you feel about:\n\n. Actually I don't think we can install all dependencies and also update a few specific dependencies in a single step. Looks like yarn upgrade <deps> doesn't work in that case. So let's keep these separate?\n(I also think it's a little easier to reason about if they are separate.). Yeah, they're called tagged template literals: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals. Libs like styled-components make heavy use of them, eg:\n``js\nconst Button = styled.button\n    / Adapt the colours based on primary prop /\n    background: ${props => props.primary ? 'palevioletred' : 'white'};\n    color: ${props => props.primary ? 'white' : 'palevioletred'};\nfont-size: 1em;\nmargin: 1em;\npadding: 0.25em 1em;\nborder: 2px solid palevioletred;\nborder-radius: 3px;\n\n;\n```. Sure. Sounds awesome. We can just copy what you've already done. \ud83d\udc4d . I'm not sure I understand the motivation here, or why it's advantageous to copy/paste this boilerplate into several tests.. I like.filter(Boolean)` well enough. \ud83d\udc4d \nI also think owner => owner is fine and the unnecessary !!owner cast nags me (even though it wouldn't actually matter in this case).. \ud83d\udc4d . ~~Should we also include packages/*/npm/*.js to ensure the NPM entry points stay formatted?~~\nNevermind. Looks like these are covered below in scripts. \ud83d\udc4d I like this.\nWe could actually enumerate all package folders (so we increment version numbers) but just only publish non-private ones.. ~~Are we concerned about a partial copy? (Like maybe something failed from a previous run?)~~\nNevermind. Looks like the main rollup/build script calls rimraf before createBundle.. This is something the release script could do too, if it makes more sense there.. Why twice?\nI actually only run this step once in the release script, after testing the output of yarn build vs yarn build --extract-errors and determining they were the same.\nDid I overlook something?. Cool. Thanks for elaborating.\nI'll test again to be sure.. Okay. Just did a quick test locally with a revision that had a stale error codes JSON file.\nComparing the output of yarn build -- --error-codes (run once) to yarn build (run again after the error codes were updated) does seem to yield slightly different results. eg for packages/react-dom/cjs/react-dom.development.js:\n```diff\n12469c12469\n<                 invariant(isBatchingUpdates, 'Task updates can only be scheduled as a nested update or ' + 'inside batchedUpdates. This error is likely caused by a ' + 'bug in React. Please file an issue.');\n\n\n            !isBatchingUpdates ? invariant(false, 'Task updates can only be scheduled as a nested update or inside batchedUpdates. This error is likely caused by a bug in React. Please file an issue.') : void 0;\n\n```\n\nThese 2 look equivalent to me.\nI also did a more extreme case where I completely emptied out the error codes JSON and ran a single yarn build -- --error-codes step and then compared output. The only changes were ones like I pasted above.\nI think this means it's okay to combine these steps?. I'm curious: Why the change from null => ''?\n(Is it to maintain the previous behavior where we had an inline function just returning an empty string?). \ud83d\udc4d . Ah. Gotcha.\nI asked b'c the Flow return type is also null | string but it's no big deal \ud83d\ude04 . \ud83d\ude06  \"gosh\". I guess the second format is slightly better because it potentially avoids creating strings (eg getComponentName) that we wouldn't actually use if the invariant passes (which is the common case) but I'm confused as to what the relationship is between the error-codes JSON and this output.. You could put the entire error string into this var since it's duplicated below?. Sure, no big deal. Just seemed pretty arbitrary the way it was currently setup.. It's a bit confusing that we now have ReactNativeRenderer that requires a file named ReactNativeFiberRenderer.. Love it ^. Nice!. Yeah, it's def not a blocker to this PR. Just an observation that the naming seems even weirder now \ud83d\ude04 . This is because of our build script's replace-invariant-error-code short-circuits if it can't find the error in the error codes map. I can fix that to still do the replacement and then we can safely combine the yarn build steps into 1.. Yup. I'm on it \ud83d\udc4d . How do you feel about adding a lint rule for this?\nSomething like...\n```js\nexport default function(context) {\n  return {\n    Identifier(node) {\n      if (node.name === 'require') {\n        const path = node.parent.arguments[0].value;\n    if (path.match(/^react.*\\/src/)) {\n      context.report(node, 'Do not import project internals');\n    }\n  }\n}\n\n};\n};\n```\nThis would make us less likely to add more of these.. \ud83d\udc4d . Note to self: I don't understand the purpose of  scripts/rollup/shims/rollup/*\nUpdate: Looks like it maps to a combination of forkedFBModules and getShims in modules.js. Still not entirely sure why it's necessary. Seems like it's related some some quirk/limitation of Rollup?. Should we drop the -fiber suffix from these now?. nit: This could have a more meaningful name? Maybe like babelOptionsHook? I dunno. Names are hard.. Looks like this only exists to map react-dom/server to react-dom/server.node\nCouldn't we simplify by just renaming react-dom/server.js to react-dom/server.node.js?. Yeah, I saw the comments. I just didn't fully understand them I guess. The third paragraph above helps me understand a little.. I didn't think too hard about the name since we plan to change it soon anyway. I'll rename it when we do the real implementation.. Thanks for catching this Dan. \ud83d\udc4d . This comment should be moved above line 14?. The release script uses this, but it would be easy to change it. Looks like the only other reference is our version-check task which would also be easy to update.\nI think those are the only 2 things blocking this TODO? If so, I'd be happy to help with a follow-up PR.. version is coming from the user's CLI param (eg 16.0.1-beta)\nThe \"version\" in package.json will typically be the same, except for < 1.0 releases like the reconciler, when we'll increment the major (eg 0.1.0 -> 0.2.0) and now also append the prerelease suffix (eg 16.1.0-beta -> 0.2.0-beta).. I'll update the inline comment to be clearer.. Are the wrapper functions necessary? Couldn't we just do...\n```js\n    injectIntoDevTools(devToolsConfig: DevToolsConfig): boolean {\n      const {findFiberByHostInstance} = devToolsConfig;\n      const findFiberByHostInstanceImpl = findFiberByHostInstance\n        ? findFiberByHostInstance\n        : () => null;\n  return ReactFiberDevToolsHook.injectInternals({\n    ...devToolsConfig,\n    findHostInstanceByFiber: findHostInstance,\n    findFiberByHostInstance: findFiberByHostInstanceImpl,\n  });\n},\n\n```. Boo, Flow.\nOkay. No biggie.. It still does. The implementation (below) is:\njs\n        findFiberByHostInstance(instance: I | TI): Fiber | null {\n          if (!findFiberByHostInstance) {\n            // Might not be implemented by the renderer.\n            return null;\n          }\n          return findFiberByHostInstance(instance);\n        },. Yah. Node error.stack includes the message, so it's not needed. Why'd you remove isCallbackScheduled?\nDoesn't this mean that >1 call to scheduleDeferredCallback will now result in a timer that can't be cancelled?\nWouldn't it be safer to just store a callbackID and check for it to be non-null before scheduling? (Then if it is non-null, we can just return it and skip the additional timeout)?\neg\n```js\nlet scheduledCallbackId = null;\nfunction setTimeoutCallback() {\n  frameDeadline = now() + 5;\nconst callback = scheduledCallback;\n  scheduledCallback = null;\n  scheduledCallbackId = null;\n  if (callback !== null) {\n    callback(frameDeadlineObject);\n  }\n}\nfunction scheduleDeferredCallback(callback: Callback): number {\n  scheduledCallback = callback;\nif (scheduledCallbackId === null) {\n    scheduledCallbackId = setTimeout(setTimeoutCallback, 1);\n  }\nreturn scheduledCallbackId;\n}\nfunction cancelDeferredCallback(callbackID: number) {\n  scheduledCallback = null;\n  scheduledCallbackId = null;\nclearTimeout(callbackID);\n}\n```. > We don't ever call it more than once.\nI don't like the fact that the implementation of this part of the code has been changed to depend on how another piece of the code uses it. That feels brittle.\nIf you'd rather throw, that's cool. I'd support that.. I think most of these are after the timer. Didn't seem important to put before or after, so long as it was outside of the timer. If you prefer I change it, I'm happy to.. Not really. Maybe it was mostly just a naming concern, which is kind of silly I guess. Happy to combine them. Any suggestion for a name that covers both?. \n. \ud83d\ude43 \njs\nreturn (\n  typeof __REACT_UNSTABLE_SUPPRESS_ERROR_LOGGING__ === 'undefined' ||\n  __REACT_UNSTABLE_SUPPRESS_ERROR_LOGGING__ !== true\n);\nEdit for clarity: This is just a nit. It seems like you could combine the if-condition-return into just a return.. This comment might be nice to move up to line ~446, for the whole rimraf callback, since we also execute the first few create* tasks serially.\nEdit: Actually now that I look again, I'm pretty sure we could just leave the comment here and parallelize the above few tasks \ud83d\ude04  We were running them in serial before but I don't think those need to be. (Not that it would make a bit difference. Those tasks should be super fast.). nit: We could wrap these in a Promise.all (not that it would make a big diff, should be fast either way). That's for the create-bundle steps (below). The sync steps here just copy files. They should be okay to do in parallel. (They don't even log anything, so they wouldn't cause unreadable output.)\nBut, it wouldn't make a big diff in terms of performance since they're just copying a few files. So it's a \"nit\" \ud83d\ude04 . \ud83d\ude06  Whoops! Thanks. Curious why async is hard-coded to true here vs being opt-in like hydrate?. Whoops. Sorry. Had written this comment before we chatted in person and forgot to remove it before submitting the LGTM.. nit: console.error ?. Why not use chalk.red() ?. Possible follow-up: We could remove this new Promise boilerplate here and below using Promise.denodeify. Gotcha. Should be identical to chalk.red('string'). I think the only difference is that one outputs to stderr and the other to stdout. I don't think it actually matters in this case. \ud83d\ude01 . True.\nAnd no idea. \ud83d\ude04 . > Shouldn\u2019t an unexpected log fail the test anyway\nGood point.. I think this was just me being silly.. I'm not sure what you have in mind here. Mind giving a faux code example?. Now that I look at this again, I believe this explicit check is necessary since we've necessarily spied on console.error in order for the matcher to work.\nIIR, I originally tried to clear the spy at the end of the matcher, so unexpected errors/warnings would cause an error, but neither the version of Jest we're using (21.3.0-beta.4) nor the latest release (22) actually expose the spy.mockReset method the docs mention.\nWe could call spy.and.callThrough() at the bounds of the matcher, so that errors were actually passed through, but (a) that could negatively affect tests with multiple .toWarnDev calls and (b) this wouldn't actually fail the test, only print the red text to the console.\nMaybe I'm overlooking something?. Nesting toWarnDev inside of toThrowError won't work. Failures in the toWarnDev assertion are silent. But nesting it the other way around (toThrowError inside) does seem to work.. I think we're saying the same thing, but misunderstanding each other.\nMy initial design for this matcher was to setup a spy/mock when entering and then remove it before exiting. This way unexpected console.error calls would fail the test (as they do if you don't spy in the first place). The Jest docs suggest this should be possible via a mockReset method, but that method doesn't actually exist (in Jest 21 or 22) so I'm not sure why the docs mention it. The problem then, is that once we've spied on console.error initially, we can't remove that spy and so any unexpected calls to it don't actually cause failures.\nWe could work around this in other ways. For example, I could not use Jest's spyOn functionality at all- but just override console.error with my own function and then restore the originally one before exiting. Maybe that's best anyway?. I think that's actually a reasonable plan for this matcher, since we don't need full the spy functionality as implemented by Jasmine/Jest anyway.. Oh sorry, looks like our comments got crossed.\nWRT just rolling our own \"spy\"- cool. I'll do this.\nRegarding the second thing you say, I think you're just suggesting we modify our console overrides here to throw immediately rather than in an afterEach? I don't think this is specifically related to this PR, but I'd be happy to make that change as well.. Hmm, ok. Although I think aesthetics/ergonomics are important for test writing.\n\nI think throwing early extracts a benefit from the new API\u2014something we haven't been able to do before.\n\nSorry if I'm being dense, but I don't understand what you mean about us being unable to throw immediately before. Could you explain?\nWe always wanted unexpected warnings to fail, and we always signified they were expected by spying on them. That hasn't changed with this PR.. I believe I see why now.\n~~I think it's because we set up our console overrides during a global setup step, and we checked them after each test, but we never reset them before each test.~~ Edit: I think Jest does this for us by clearing mocks after each test run, so I'm still unsure. :)\nHowever, I'm not clear on why we did this. Is it because we wanted to enable people to spyOn in a beforeEeach?. Ah! I think I understand what you're saying better now.\nThe boundary is clearer with the new API. Before the boundary was more informal, between spyOn and the first (...calls.length).toBe() check.\nIt was still possible to do the throw-immediate thing before though. That's what confused me a bit.. I guess it was also easier for the old spies to miss things if warnings were logged after the last count check too. That's another advantage of this boundary.. It just occurred to me coming back from lunch that, since I know the error message(s) ahead of time, I could also throw immediately (within my fake spy) any time a message is logged that isn't expected.\nI'll rework the matcher to behave this way instead.. Yeah. I like this suggestion.\nWhat do you think about the following change?\n\n. To be clearer:\njs\nit('should fail when the expected warnings passed to .toWarnDev() do not match the actual warnings', () => {\n  expect(() => {\n    console.error('foo');\n  }).toWarnDev('bar');\n});\n\n. Note to self: Some of our tests spy on console.log (eg ReactDOMComponent-test) so this would also need to check if methodName === \"warn\" || methodName === \"error\". This is so easy to do. Maybe we should add an ESLint rule against it.. I read the intent here as making sure that we warned about both issues with distinct component stacks (pointing to the right element for class and onclick). I'm not positive but that seemed to be the case. I approximated this by changing the element type and asserting with that instead.. It looks like several of these lines were added by you a year ago \ud83d\ude05  with PR #8570\nThe others were added 2 years ago with PR #6398 in order to verify that our error message pointed to the correct component+line. (See issue #6062) I think the new approach I'm taking also satisfies this goal! So it should be okay. \ud83d\udc4d . Nifty. Clever solution. \ud83d\udc4d . Nice!. I'm not sure how to prevent Flow from trying to parse the JSON file if I move it here. Even adding it to the [ignore] block in the .flowconfig isn't sufficient.. For now I'm just going to leave this as a dotfile. I don't know how to make Flow ignore it (and not error) otherwise, and it doesn't seem pressing enough to invest more than a few minutes into.. Yeah, we used this same wording for the warning from render. I assumed the reason was b'c the user may have return undefined or they may have just forgotten/omitted the return entirely.\nHappy to change it though.. It can be null, yup. I assume this was desirable since it can be used to detect that the state has not yet been initialized. Alternately if you've initialized the state via the constructor it will be whatever that value us.. It's not, but it does result in slightly cleaner dev-bundle:\njs\nif (warnAboutDeprecatedLifecycles) {\nRather than\njs\nif (true && warnAboutDeprecatedLifecycles) {\nWe do have them in isolation for at least one other feature flag. That being said, I don't feel very strongly about this. It just seemed slightly nicer.. Interesting. Do we do this (coalescing warnings) anywhere else?\nI will add this to the list of follow-up items.. It could be argued that we refuse to support both. I lean slightly towards warning. I don't have a strong argument.. I initially mirrored the check in ReactFiberUpdateQueue, but I think it's worth changing here. \ud83d\udc4d  Will do.. Oh! I misunderstood. \ud83d\ude04 \nNo strong reason here. I'll move them off the instance.. One small, lazy reason for supporting both (but with a warning) is that it prevents us from having to fork some of the more verbose tests like ReactComponentLifeCycle-test where we need to explicitly test both.. Sounds like a good follow up thing to do then. Thanks for the suggestion!. > If newState is null or undefined, we should avoid creating a new state object, so that it's referentially identical.\nGotcha. \ud83d\udc4d \n\nRelated: if the props haven't changed, we shouldn't call this method. Same as componentWillReceiveProps. Need a test for this.\n\nGood observation! Fixed and added test in 361a2cf11.. Hm. We can't just use workInProgress.memoizedState here because it won't exist during the initialization path. So I can make state a param to this helper function, but I'll still have to pass instance.state down from constructClassInstance. That cool?. I wondered the same thing. Not sure.. Nice! Thanks for the improved wording suggestions!\nI've made the wording improvements in 3772ee2.. Wow. Sorry! Looks like I fucked up there.. Oh no! \ud83d\ude31  My TODOs are multiplying. Should we do any Flow trickery here to make sure these attributes all stay in sync with ReactNativeRenderer? I guess they're probably pretty stable so maybe this isn't necessary.. What is currentProps used for?\nIs it related to the event handler TODO comment?. \ud83d\ude2d  Sins of the past.... At this point the clone's props and canonical.currentProps are out of sync. Is this intentional?. This same component is referenced by both renderers:\njs\n// packages/react-native-renderer/src/ReactFabric.js\nconst ReactFabric: ReactNativeType = {\n  NativeComponent: ReactNativeComponent,. Yes. It is called the second time right below:\njs\nconst instance = new ctor(props, context);. Yeah, this was the silly oversight ;). Nice call.. > I expect that people will use this secret flag to fool React and \"hide\" valid deprecations on components. Do we care about this use case?\nNo, not really. I believe this was the best of all options considered, despite that minor drawback.\nI only check that one method because it's all that's required to verify the presence of the polyfill.. > I think it would be good to write up a table of what happens when both of either of methods is present (e.g. gDSFP, cWM/u_cWM, cWRP/u_CRWP).\nI have tests that codify that for all three renderers (ReactComponentLifeCycle-test, ReactDOMServerLifecycles-test, and ReactShallowRenderer-test).\ntl;dr is that none of the unsafe lifecycles are invoked if gDSFP is present. This is necessary for the polyfill approach to work.. > Making a table with different permutations and expected result would help us fix bugs if we find any later. It might also be helpful for the blog post.\nWhere would such a table live? Seems like codified in tests is as good as any.\nI can add some inline comments.. Technically this test is verifying that the polyfill can add the old, deprecated methods (not the new ones with the UNSAFE_ prefix) without triggering a deprecation warning. This only really matters in the window between when we turn on the deprecation warnings and when 17 is released and those old methods go away entirely.. Sure \ud83d\udc4d . Probably don't need to include this file?. Hm. Okay.\nI'm curious: Why didn't we follow that pattern with other new packages (like react-reconciler)?. Okay. This makes sense. Thanks for the suggestion. \ud83d\ude04\nIt's been updated.. Yeah, that's reasonable.. There is a lot of back and forth on a PR, and the latest round seems entirely like nits. Seems a bit inefficient.\nWRT using typeOf here- Either way should be fine. It's just a subjective preference, right?. PS using typeOf in isElement didn't work, because the return type was overly specific. I didn't feel strongly about it, but I opted out of using typeOf director for that reason.. > Yes, they probably don't make a difference in a large scheme of things, but if we can make it more efficient, why not do it?\nI don't think the specific comment this is in response to is really more efficient one way or another, in terms of runtime efficiency. And the complexity/code-size difference is minimal. This is why I said it felt like a nit.. Sure, the comment we're responding to is the implementation of isAsyncMode, so the runtime path of typeOf didn't seem relevant since it wasn't being used (just the helper getter functions).\nIt's fine. I'm about to push the change you suggested.. Many built-in components like View and ActivityIndicator use createReactClass with NativeMethodsMixin in this way. None of them use legacy componentWillReceiveProps or componentWillMount methods though because I've code-modded them all away (before enabling this warning for the RN renderer).\nI don't know if third-party components use the mixin, but hopefully not since it's behind __SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.. You are correct though, that if I was wrong about the 2nd point, and a component only declared cWRP, the warning would be suppressed.\nI could expand the check you linked to to verify that flag on both of the lifecycles if you think it's worth doing. I think it would be a simple matter.. No worries. It was trivial to make the check robust enough to cover that case too.. nit: Don't push or pull changes from repo repo. Don't check CI status.. Isn't this the exact opposite of what you want? (Don't you want !==). I think isPrerelease should always be determined by:\njs\nisPrerelease = semver.prerelease(version);\nAnd I think the script should fail (with an error) if we ever try to combine the \"latest\" tag with a version that isn't x.x.x (eg 16.3.0-alpha.0 and \"latest\" should be an error). This could use an inline comment about the case it's intended to handle. I'm not really familiar with this particular code, but it would not be obvious to me at a glance why it was okay to silently ignore this case.. D'oh \ud83d\ude01 . Hard-coded props name (source) is what is proposed here:\n```js\nconst Subscription = createComponent({\n  getSubscriptionValue: source => source.value,\n  subscribe: (source, valueChangedCallback) => {\n    const onChange = event => valueChangedCallback(source.value);\n    source.addEventListener(\"change\", onChange);\n    return onChange;\n  },\n  unsubscribe: (source, subscription) => {\n    source.removeEventListener(\"change\", subscription);\n  }\n})\nconst App = ({ textInput }) => (\n  \n    {value => }\n  \n);\n```\nAnd I'm a fan of it.. That's fine. I think the way I'm currently leaning is shown in my most recent comment anyway, so the Component param would go away.. The component will runtime error without any of these properties, so I don't understand why a warning would be more appropriate.. That makes sense. \ud83d\udc4d . Cool. I'll update to Value | void. > What do you think of showing an example that passes through the value returned by the promise?\nI show true/false because the example shows a \"loading\" promise.\nMaybe I can compromise? Check out the commit I'll push shortly.\n\nTrue; unless you're overly clever! :D\n\nUnfortunately, that wouldn't prevent the initial render with undefined because we don't \"subscribe\" until the commit phase. (Unless I'm misunderstanding something.). I think they have to be defined inline because of the <> parameters?. Yeah, I guess I could. I considered doing this at one point \ud83d\ude04 . Yes agreed!. There's no subscription reference to save yet, since we don't subscribe until mount/update.. Sure. I don't know if one is better than the other really.. WHoops. I like this wording much better! \ud83d\ude47 . Sure, that's reasonable \ud83d\udc4d. suuuuper nit: I think two \\n might look nicer. Seems like we should de-dupe this warning?. Incremental tests seem like an odd place to test these warnings. Why here?. This looks weird. Should we just put an expect here that asserts context is undefined?. I know! \ud83d\ude01 . I already validate in packages/react/src/useRef.js when the prop is passed initially.. I'm not sure what consensus we've come to here. \ud83d\ude04\nI think the warning during creation is good. Do we also want additional checks/invariants here? Or is it unnecessary?. Damn! You're right!\nI just read that word as though it was there. \ud83d\ude04 . Is 166d236 what you had in mind? The component stack will only be included in DEV mode.\nThis feels a little weird to me, checking both places.. This error message isn't great \ud83d\ude04 Any suggestions?. Could just be else. warning is an empty function if not DEV, so I didn't think that was necessary. But sure!. Good suggestion. I like renderFn. Yup. I kind of halted my renaming in the middle because of the ReactChildFiber suggestion I'm trying out.. \"Promsie\" \ud83d\ude06 . Yeah, I was on the fence about this. Returning false was a suggestion above but I'm okay with the noop approach. \ud83d\udc4d . Sure! I'll log and compare parent commit lifecycles.. Gotcha. I tried to clarify who shouldn't use it below (in the \"Who should use this?\" section). Any specific wording suggestions?. What's the benefit of doing this? Seems like it would be more awkward, since I would need to create new refs each time from getDerivedStateFromProps.. I think warnings might be too easy to overlook. I could add one, but I think we'd also want an error later (when unsubscribing) which happens just as often, so what's the point?. You're forgetting getDerivedStateFromProps (which is the part that makes it awkward in my opinion). Sorry. Ignore my previous comment. Yes, I think you're right.. Any actionable suggestion to avoid this? Docs? Method names?. ~~I don't see how moving this line would affect the case you mentioned above?~~\nNevermind. I see what you're saying. Let me think about this.. Yeah, I just don't see the value of using createRef in this case, since we're throwing the ref away each time props change.\nIt also kind of blocks this PR on the .value to .current change \ud83d\ude04 . I don't think I want to try to support the clowny pattern you mentioned above. If the \"subscribable\" doesn't invoke callbacks on-subscribe, then that pattern will definitely break things. Even if it does, but doesn't sync invoke them, it will cause unnecessary double renders. I'd rather fail \"hard\" in this case.. I don't think createRef is inherently un-useful, I just didn't think it made this particular case any better.\nI also think it makes the Flow typing a little trickier.. How would I verify that commit hadn't happened with the yeild. Yeah, why not? This relates to my previous comment. https://github.com/facebook/react/pull/12325#discussion_r174232329. Ah! Good catch. I forgot to update the wording. Thanks. :). I'm not a fan of JSDoc style comments. I thought about adding Flow types initially, but decided to use comments instead- in part because I didn't know what types to show. (I thought the generic types would be confusing in this case.) I have actual examples below.. Ah, good call.. Wouldn't we want to keep a meaningful error message in either case?\nI could change this to a warning if you feel strongly that's the better way to go.. > If createRef doesn't make this particular use case better, I question why we added it at all. Because this is the exact use case it's meant to be used for.\nI disagree, but maybe in a subtle way.\nI think createRef is nice when you're only the consumer of the mutated value- because it requires a little less code (and presumably it's easier on the compiler?). In this case, as both the consumer and the manager of the value, I just didn't think it added anything.\n```diff\ndiff --git a/packages/create-subscription/src/createSubscription.js b/packages/create-subscription/src/createSubscription.js\nindex 748090d6c..aee5693d1 100644\n--- a/packages/create-subscription/src/createSubscription.js\n+++ b/packages/create-subscription/src/createSubscription.js\n@@ -7,6 +7,8 @@\n  * @flow\n  */\n+import type {RefObject} from 'shared/ReactTypes';\n+\n import React from 'react';\n import invariant from 'fbjs/lib/invariant';\n import warning from 'fbjs/lib/warning';\n@@ -51,9 +53,7 @@ export function createSubscription(\n   };\n   type State = {\n     source: Property,\n-    unsubscribeContainer: {\n-      unsubscribe: Unsubscribe | null,\n-    },\n+    unsubscribeContainer: RefObject,\n     value: Value | void,\n   };\n@@ -61,9 +61,7 @@ export function createSubscription(\n   class Subscription extends React.Component {\n     state: State = {\n       source: this.props.source,\n-      unsubscribeContainer: {\n-        unsubscribe: null,\n-      },\n+      unsubscribeContainer: React.createRef(),\n       value:\n         this.props.source != null\n           ? getCurrentValue(this.props.source)\n@@ -74,9 +72,7 @@ export function createSubscription(\n       if (nextProps.source !== prevState.source) {\n         return {\n           source: nextProps.source,\n-          unsubscribeContainer: {\n-            unsubscribe: null,\n-          },\n+          unsubscribeContainer: React.createRef(),\n           value:\n             nextProps.source != null\n               ? getCurrentValue(nextProps.source)\n@@ -136,7 +132,7 @@ export function createSubscription(\n           'A subscription must return an unsubscribe function.',\n         );\n\nthis.state.unsubscribeContainer.unsubscribe = unsubscribe;\n\nthis.state.unsubscribeContainer.value = unsubscribe;\n // External values could change between render and mount,\n // In some cases it may be important to handle this case.\n\n@@ -148,7 +144,7 @@ export function createSubscription(\n }\nunsubscribe(state: State) {\n-      const {unsubscribe} = state.unsubscribeContainer;\n+      const unsubscribe = state.unsubscribeContainer.value;\n   if (typeof unsubscribe === 'function') {\n     unsubscribe();\n   }\n```. Should we (DEV-only) assert that the stack is empty after unwinding?. Good call.. Without it, the number of yields vary between dev and prod :(. A \"field\"?. If you're asking, \"Why store in state rather than on the instance?\"\n\n\nI guess I could do that, so long as I always unsubscribed before subscribing in componentDidUpdate \ud83e\udd14. I guess it \"felt\" a little nicer to group the source, value, and unsubscribe all together within a single state object- but it's subjective.. Makes sense!\nAre you happier with what I changed it to?. I don't think it's possible to have a null React element type?. Will this require updates to our release/build script to keep these deps in sync? Needs follow up.. Suggestion:\n```js\nit('should handle ForwardRef', () => {\n  const testRef = React.createRef();\n  const SomeComponent = React.forwardRef((props, ref) => {\n    expect(ref).toEqual(testRef);\n    return (\n      \n\n\n\n    )\n  });\nconst shallowRenderer = createRenderer();\n  const result = shallowRenderer.render();\nexpect(result.type).toBe('div');\n  expect(result.props.children).toEqual([\n    ,\n    ,\n  ]);\n});\n. I think this line should be:js\nthis._rendered = element.type.render(element.props, element.ref);\n```\nI'm not sure I understand your PR comment though?. Oh I see. \ud83d\udc4d . These versions are bumped by our release script manually. It's fine. I'll add it to my list of follow up things.. I see. In general, I'm not sure how valuable shallow testing with anything refs or HOC related is. \ud83d\ude04 . Addressed via 610df95. It's true that \"Unknown\" is probably a more common fallback name, but it's not strictly necessary to use that pattern. That being said, I think this warning is a bit verbose and maybe tries to cover too broad a topic (e.g. sharing state between several components).\nAt first glance, I would prefer a shorter message, something like:\njs\nwarning(\n  instance.state !== instance.props,\n  \"%: It is not recommended to assign props directly to state. \" +\n    \"Updates to props won't be reflected in state. \" +\n    \"It's usually better to just use props directly.\",\n  getComponentName(workInProgress) || \"Unknown\"\n);\nThat being said, I realize this contradicts an earlier suggest from Dan so I'll defer if there are stronger preferences there.. Yeah, there's a TODO about this \ud83d\ude04 This PR isn't ready yet.\nInitially I was thinking maybe the updateQueue could be a good place to store the snapshot but I'm not sure if this would work out. I think updateQueue could be null when I'd need it in some cases.\nI dunno about using the instance. Seems like we could have potential collision issues if we tried that?. To pass null instead of undefined. Yeah, good call. Initial approach was just whatever I could get working quickly. Planning on iterating.. I meant naming collisions. Writing to the instance might clobber an existing property.. Seems better to pass a consistent value regardless of whether getSnapshotBeforeUpdate exists or not.. Let's stop this mini review for now \ud83d\ude04 I don't think it's useful. I'll let you know when the PR is ready.. \"in this case\" just referred to the update case. The other two invocations of this method are mounting cases. But I'll re-word the comment.. I confess, I often copy paste an existing test when writing a new one to save a few seconds.. > Why did you change the order of getDerivedStateFromCatch and getDerivedStateFromProps?\nThis was incidental. I changed the order of processUpdateQueue and getDerivedStateFromProps. I did that because it seemed easier to get the correct partial state value that way than trying to mess with the update queue and it's memoized vs base state.\n\nIt looks like the order in the \"resume mount\" path is different now, though. Should be consistent regardless.\n\nFair \ud83d\udc4d . Agreed. I wonder if there's a way I could improve this by reformatting the message slightly.. That makes it seem like React doesn't know which component, when really- it just doesn't know what the name fo the component is.\nMaybe \"An unnamed component\" ?. Actually I think just plain \"Component\" might be okay, and more inline with other places.. create-react-class case. componentDidCatch only works for class component API.. \ud83d\ude01 Yeah.. I just tried to cover a mix of old and new aliases in the test. There's not really a meaningful pattern to it.. Same as above. Just trying to cover more cases.. I think you're just saying that we should be sure to update the warning whitelist?. Sure, I removed the redundant checks from the two methods that had them (88d4cac). Sure! I updated the old objects to be sets (ca09ef8). To be clear, these tests are kind of verbose and I was hoping to avoid having to duplicate them for old and new lifecycle aliases, so I just tried to cover a mix of both (so the test could verify that the correct lifecycle name was printed in the warning). Sorry. I misinterpreted this comment to be another like the one in the test above. This is a legit mistake.. This warning isn't coalesced. We log once per component-type if there is a combo of new and unsafe lifecycles. We'll need to add this pattern to the createWarning list though for sure. It isn't there currently.. Added... (nice catch). Nice!. (The same is true for this.props). This needs to be within an if (__DEV__) check. Suggest using the one right below (line 711).. Need a trailing space (\" \") here.. nit: I think we generally use \"Component\" as the default name in warnings when it's followed by \":\" (e.g. \"Component: blah\". We use \"A component\" when it's part of a sentence (e.g. \"A component blah\"). nit: Might read nicer with \"\\n\\n\" between these two sections?. Overall, I like this message better- but this first sentence seems less accurate and maybe confusing, since you can call setState from componentWillMount/UNSAFE_componentWillMount.. Yeah, no strong feelings about this I guess.. Seems kind of silly that we're using fbjs for warning and invariant at this point \ud83d\ude01 . Right, that's what I meant. We may have well just built our own thing.. We can also delete the forwarding scripts/rollup/shims/react-native/ReactNativeBridgeEventPlugin.js now?. Should we just get rid of the ReactNativeBridgeEventPlugin entirely now and just move extractEvents over into the view config registry as well?. We should just move extractEvents out of ReactNativeBridgeEventPlugin and into this file too so we can get rid of ReactNativeBridgeEventPlugin. \ud83d\ude04 . I think we should move this check up a level:\njs\nif (__DEV__) {\n  if (instance.state === instance.props) {\n    const componentName = getComponentName(workInProgress) || 'Component';\n    if (!didWarnAboutDirectlyAssigningPropsToState.has(componentName)) {\n      didWarnAboutDirectlyAssigningPropsToState.add(componentName);\n      warning(false, ...);\nThis way we don't add things to the Set unnecessarily, and we also don't potentially suppress a later warning (e.g. if we encounter 2 components with the same name- and the second one assigns props to state but the first one doesn't).. Yeah. This looks like a mistake.. I think this sentence is fine with or without the word \"the\".. Note this is turned off for open source builds.. Things in the \"oss\" sub directory are blacklisted from FB configs in order to prevent Haste module conflicts. This added subdirectory should not impact open source builds though.. \"TODO (bvaughn)\" \ud83d\ude06 . Note open source builds no longer depend on dynamic flags.. The react-rt/react-cs commands were no longer being used.. The old version had two tests for polyfilled getDerivedStateFromProps - one with and one without StrictMode. I don't think the one without is all that useful (since it's a subset) so I removed it. I replaced it with a new test (with StrictMode) for polyfilled getSnapshotBeforeUpdate.. Not referenced ^. Why is this necessary?. Circling back- the potentially troublesome check was later improved via facebook/react/pull/12647. I don't think there's anything wrong with the prior wording. \"it makes code\" is a general statement. \"it makes the code\" is more specific. Either could apply in this case, but I think the docs are saying that- in the general case, JSX makes code more readable.\nAs for the oxford comma you've removed... I'm actually a fan of those. \ud83d\ude04 I think they make sentences more readable.. I think we should also compare workInProgress.ref. > Also, is it possible for a deep update to influence the value of a ref above it?\nI'm not sure, but it seems conceivable that a ref could be the only changed \"prop\" (if it's an inline arrow function for a non-PureComponent) and we might bail out when we shouldn't here?\nAlthough in that case it probably wouldn't matter anyway.. Hm... maybe Foo gets new properties that causes it to recreate the ref, but only a filtered set of those props are passed through to the ForwardRef component, so from it's POV nothing has changed?\nMaybe this is too contrived.. I think maybe this is too contrived to be a real concern.\nRef callbacks would be re-invoked if the underlying instance/ref changed. If the ref callback itself changed, most likely this just means it's an arrow functions and has an identical implementation.\ncreateRef would be more problematic, but it is only expected to be created once in the first place, so in practice shouldn't be a problem.\nMaybe we should just add an inline comment saying this is technically possible but probably not a concern in practice?. I tried to write a contrived test to catch the case we're talking about, and it looks like I was mistaken to begin with. Even if props are shallowly equal, the memoizedProps and pendingProps objects themselves won't be equal- so we won't bail out- which side steps the issue I mentioned.\nSorry for the dead end. \ud83d\ude04 . These new symbols should be added to ReactIs and getComponentName.. Probably also need a follow-up PR for DevTools to add the new type in so it doesn't show as \"unknown\"?. Maybe my wording is wrong?\nThis is not forcing children to re-render. It's just measuring the \"cost\" of re-rendering. If the tree bails out b'c of e.g. sCU then the \"actual\" render time is small, which is good.. I'm curious- why?\nLint complains about that form (no-useless-call) but I can add an ignore rule if you prefer it.. Oh? cc @gaearon . Sure. No strong preference.. Hm. Maybe. Not obvious to me why that would be an improvement.. Our comments got crossed.\n\nProfiler is the only type of work that might have this effect, right?\n\nYes.. \ud83d\udc4d . Oh, haha. I misread that \ud83d\ude04 . It's easy enough to add a wrapper object if that would be better in any way. (I actually had one earlier and removed it last minute.). \ud83d\udc4d . Gotcha.\nI'll take another look at this this evening, after dinner. \ud83d\udc4d. Already using memoized.\nI'll remove .call - but I'd like to learn more about why it's good to avoid it in this case. \ud83d\ude04 . I used the host config function originally but removed it because my understanding was that we planned to change that in the future in a way that would not be compatible with this use case. cc @acdlite . If this is not the case, I can change it back to using the host config function. I'll have to make a change two test renderer to support mocking that function but that should be easy.. \"Both renders\" meaning- if the side effect flag is enabled?\nYes. The tests disable the side effects flag for this reason.. This is a DEV-only sanity check to make sure we don't forget to pop anything from the timing stack.\nWe do the same DEV-only check with the context stack in scheduler.. I...think so.. Ah! No problem. Thanks for clarifying. \ud83d\ude04 I'll revert that particular change then.. Ah, in the event of an error, if the replayFailedUnitOfWorkWithInvokeGuardedCallback flag is enabled, then when replayUnitOfWork is called- it also stops (and discards) the base time. I think this is right, because that time is kind of meaningless.. Do we? Why? This time is accounted for in both the start and stop time methods.\nI guess I can reset it in commitRoot if you think it's best.. I think you're saying:\njs\nif (enableProfileModeMetrics) {\n  if (workInProgress.mode & ProfileMode) {\n    // Bubble both times\n  } else {\n    // Bubble only expiration time\n} else {\n  // Bubble only expiration time\n}. Moving that one up would break things, since findHighestPriorityRoot() sets nextFlushedExpirationTime. I can move this one down though.. Yes, good catch. This should have been two ifs rather than an if/else. This is just bad Flow typing on my part. I actually do initialize both to 0 below. My bad.. Interesting!\nI avoided doing this initially because:\n The existing stack is complete context-centric, so I wasn't sure if it was appropriate to intermingle timing values. (I was also concerned about adding complexity in terms of push/pop timing when adding more hooks into the existing stack.)\n Re-using the existing stack cursor makes the profiler functions more awkward to use (since it requires initializing the module explicitly, and passing the profiler to the begin/unwind/complete modules explicitly).\n* The stack seemed like a lightweight enough structure that I didn't think the cost of creating a new one for profiling mode (not production mode) was a big concern.\nThat being said, I'll make this change \ud83d\udc4d . I wasn't sure how to type them- given that we only assign these values if the feature flag is enabled. (We don't want to add them to every fiber if the flag isn't even enabled- right?). To be clear, they are always either on or off. It's based on the feature flag. This will not break the hidden class of a fiber, since this is a bundle-wide thing.\njs\n  if (enableProfileModeMetrics) {\n    this.selfBaseTime = 0;\n    this.treeBaseTime = 0;\n  }. > Otherwise these timers will be shared with other renderers that could be rendering interleaved with this one.\nD'oh. Good point.\nI always forget about this use case.. ~~But then we won't strip the code when enableProfileModeMetrics is false. I assumed this was more important.~~ Disregard. I'm silly.. Yeah. Duh, me.. I agree. I expected that also.. Yah, hadn't yet pushed the DEV only check, but it's there now.\nInteresting suggestion with the second bit. I'll add that.. > A new parent can never be a RCTVirtualText.\nI'm not sure I understand what you're saying here.\ngetChildHostContext() can get called with type === \"RCTVirtualText\" in cases like:\njs\n<Text>\n  <Text>this is inside of a virtual text</Text>\n</Text>\n\nWhich highlights that this is in fact not just a DEV only contextual thing.\n\nI don't understand. The \"DEV only\" bit here is the warning, not the runtime behavior.. To avoid creating new wrapper objects if isInAParentText hasn't changed.. That's fair.. Text -> View is not valid.\n(It currently is for iOS but it soon won't be. Tim is changing this now.). cc @yungsters in case this is not correct. Certain types of components (like Image) are allowed inside of Text - but RCTView itself (the <View> component) is not.\nHm. But I think I see what you're saying. Only treating this value as a one-way thing would suggest that this is allowed: <Text> -> <Image> -> \"foo\" (although this specific case would have a different error about Image not accepting children...). Maybe this is a better example of why we shouldn't only set this value one way:\n<Text>\n  <ScrollView>\n    foo\n  </ScrollView>\n</Text>\nI don't think this is valid. We should warn.\nI'm going to add a test for this and back out the one-way change.. nit: Why not init to 0? \ud83d\ude04 . nit: Why \"latest\"? Isn't it actually a \"new\" id?. Does this need to be a separate function call? I guess it could get inlined anyway so it probably doesn't matter.. I think this comment should be above scheduledCallbackConfig  = {...} rather than the call to getCallbackId.\nBut also, the comment confuses me a little. A lot of this module seems written to support multiple, concurrent callbacks (like the fact that rIC returns an id and adds to a registeredCallbackIds map).. I never close tabs, man.. That's true. I'd guess emptyObject is resolving to an any type?. Good point! I've been trying to use exact types when I think of it. I dig the $ReactOnly suggestion too.. Actually something more insidious is going on here. I can't make Flow report an error in this type no matter what I do, within the React native or fabric renderers.. Run yarn prettier to reformat this file and CI should pass! \ud83d\ude04 . For example, given this type:\njs\ntype HostContext = $ReadOnly<{|\n  isInAParentText: boolean,\n|}>;\nFlow reports \"no errors\" if I add these lines inside of a method like createInstance() that accepts a hostContext: HostContext param:\njs\nhostContext.isInAParentText = false;\nBut if I change it to this, Flow fails:\njs\n(hostContext: HostContext).isInAParentText = false;\n\nCovariant property isInAParentText incompatible with contravariant use in assignment of property isInAParentText. Note that the React repo is using flow-cli v0.61 and the latest version is v0.72 ~ not sure if this could be an old Flow bug.. Resolution: I was trying to reproduce inside of a conditional, and we're using an older version of Flow that has a bug (reproducible in the REPL) that does not properly handle this case.. Yes. I'll add this discussion point to our sync notes.. Here is a failing case:\n\n```js\ntype HostContext = $ReadOnly<{|\n  isInAParentText: boolean                \n|}>;\nconst hostContext: HostContext = {\n  isInAParentText: true\n};\nif (hostContext.thisPropertyDoesNotExist) {\n  // And this one is a Boolean and should not be writable\n  hostContext.isInAParentText = 'abc';\n}\n```\n\nFlow 0.61.0 link\nFlow 0.72.0 link. Should we add an else here with something (e.g. \"Unknown error\")?. Totally. This is why I had the question in the PR description:\nShould I remove the conditionals around stopBaseRenderTimerIfRunning? (Is it worth having them?)\n\n\n\nI was on the fence.. I'll just back out 27706f7 \ud83d\ude04 . Makes sense. I was wondering about this bit.. Do we need to declare this invariant twice? Did you consider something like this?\njs\nfunction getFiberTagFromObjectType(type, owner): TypeOfWork {\n  const $$typeof = typeof type === \"object\" && type !== null\n    ? type.$$typeof\n    : null;\n  switch ($$typeof) {\n    case REACT_PROVIDER_TYPE:\n      return ContextProvider;\n    case REACT_CONTEXT_TYPE:\n      return ContextConsumer;\n    case REACT_FORWARD_REF_TYPE:\n      return ForwardRef;\n    default:\n      invariant(\n        false,\n        \"Element type is invalid: expected a string (for built-in \" +\n          \"components) or a class/function (for composite components) \" +\n          \"but got: %s.%s\",\n        type == null ? type : typeof type,\n        getInvalidElementTypeErrorInfo(type, owner)\n      );\n  }\n}. Wonder if there's some sort of automated test we could write to guard against this sort of clowniness in the future.. This change isn't necessary. I just figured I'd match them up while I'm in here.. This doc comment is wrong. This new feature flag should be added to the other *FeatureFlag files as well. Flow should warn about this.. Add a link to https://fb.me/react-strict-mode-warnings. Couple of thoughts:\n\nWe should probably add the strict root component stack (like we do above with the unsafe lifecycle warning).\nWhy low priority warning instead of a warning?\nI'm not sure this warning message matches the tone of our other warnings. Maybe something like...\n\njs\nwarning(\n  false,\n  'Legacy context usage has been detected within a strict-mode tree:%s' +\n    '\\n\\n%s' +\n    '\\n\\nLearn more about this warning here:' +\n    '\\nhttps://fb.me/react-strict-mode-warnings',\n    strictRootComponentStack,\n    sortedNames,\n);. What are your thoughts about this proposed wording change, @cyan33 ?. I think the Profiler component stack could be useful. There's a precedent of including that for other warnings. But I wouldn't say it was necessary.\nThe suggestion of warning vs lowPriorityWarning was more of a consistency with other, pre-existing StrictMode warnings.. Ah, yeah. This was pretty dumb. Thanks for the pointer.. Yeah, that would be easier but this provides a more meaningful error message if it fails. \ud83d\ude04 . I thought Jest automatically reset modules between test files. \ud83e\udd14\nBut yeah, still probably a good suggestion.. Agreed \ud83d\udc4d . It's unfortunate that forgetting to do this causes a totally non-obvious (to me) failure:\n\nI guess this is the only test where we need to do this though?. Worth adding some automated check for? Or do you think the inline comment will be sufficient (when we create new renderers)?. Any more context for this TODO? (What's the blocker?). We can shave off a bit by not even initializing stateNode for Profiler unless we're actually going to use it for timing.. Why did these lines move above the StrictRoot ancestor check? I don't think they should have.. nit: Should the StrictMode ancestor check (below) come before this early return?. Can we not initialize the Set until we actually have something to warn about? (In other words, can we move this initialization into the conditional below?) Seems like that would be a little better for perf.\nI think this would also let us skip the  fiberArray.length > 0 check in the forEach below.. nit: We don't actually need to re-set this in the Map do we?. Curiosity question: Did we intentionally turn this on for RN renderer but not but for www? (It's probably good to turn it on for both.). Generally, I think error sanity checks (like the StrictRoot check) belong first in the function. In this case, I guess I agree that it doesn't matter practically speaking.\nYour call \ud83d\ude04 . The outer conditional could be removed?. The advantage of this isn't obvious to me.. Right. You're updating the reference that's already stored in the Map.. Haha, nice \ud83d\ude05 . Let's turn it on for the following feature flag forks:\n ReactFeatureFlags.native-fb.js\n ReactFeatureFlags.native-fabric-fb.js\n* ReactFeatureFlags.www.js\njs\nexport const warnAboutLegacyContextAPI = __DEV__;. If we realize this causes problems during the next www sync (which I'll be running) we can back it off then.. Accidental?. Revert this?. The two side effect flags are controlled by GKs internally. They're off by default, but can be turned on by injection. (xplat feature flags can't directly reference MobileConfig for GKs like www can.). This is gross \ud83d\ude2c. Gah! I read it, multiple times, as \"opt\" \ud83d\ude26 but you're right.. This PR caught this (actual) mistake from master.. Yargh. Yeah. I thought this error message might be more readable, but you're right- it's unnecessary.. True, although I'll have to break this up so that selfBaseTime and treeBaseTime get copied in both cases. No problem though!. The current approach avoids reading propTypes from a possible null or undefined value (although that shouldn't actually happen in practice). I don't think it's a problem as-is.. Yes, it's similar. But getComponentName accepts a Fiber and this is a ReactElement.\nWe could refactor both to use a shared helper, but it didn't seem like the obvious correct thing to do in this case.. > getting out of hand a bit\n\ud83d\ude1d\nWe often inline things rather than reuse them. I made a judgement call. I'm happy to change it if you think I should.. @guillaumep I'm sorry to hear that 16.4 caused troubles for you.\nThe point you raise is discussed in detail in #12898 if you'd like to learn more about why we made it.. I originally named it __PROFILER__ but backed it out in 812beec because of Flow. I don't feel strongly about that change though. Happy to change it back and just add a Flow declaration.\nEdit Done.. Intention wasn't to let people override this value at runtime, so you're right that using process.env was probably misleading or confusing.\n\nWhat is your plan for people to use this in CJS mode?\n\nHaven't thought a lot about this, but I was assuming people would alias react (and renderer) imports for production builds if they wanted to use profiling capabilities.. Why'd we change the previous providerStack to contextStack?\nOr maybe, why do we also need contextProviderStack in DEV? Couldn't our DEV warning just use:\njs\nindex > -1 &&\nprovider.type._context === (this.contextStack: any)[index],. > I also have a DEV-only stack for providers. I could've used it for context objects too, but I decided it's nice to avoid some property access on every pop when we need to read the context object.\nIt's not obvious to me that the cost of maintaining a second stack is less than the cost of a property access. I guess it's not a big deal either way, since it's DEV only though.\n\nThis only validates that the context type matches so it's less restrictive. We could have a bug where we accidentally pop the wrong provider object but miss it because it has the same type.\n\nContext (type), Provider, and Consumer have a 1-to-1-to-1 relationship, no?. Ah! I see what you're saying now (for both cases) \ud83d\ude04 Makes sense. Thanks for explaining.. Sure, that makes sense.. Nice \ud83d\udc4d . Also nice \ud83d\ude04 . Yes, it only affects profiling builds.. Had to read 3x to spot it. Maybe \"unobservable\" isn't the right word to use, but this time value won't be tracked at all unless the DevTools are detected\u2013\u00a0because App isn't inside of a Profiler root (which is intentional or this test).. I don't think so. Also, this is kind of doing what Sebastian suggested (assuming I understood his comment correctly).. This change wasn't strictly necessary, but I noticed while tracing through that this finishRendering call was redundant, since performWork (called by performSyncWork) also calls finishRendering.. I think I can replace this Map with a batchStartTime number field. The only case we really need to handle is processing a batch commit while async work is yielded. Other root changes will unwind the yielded work, which w already handled.\nThis was just a hacky first attempt to make tests pass. \ud83d\ude04 . This was dead code so I just removed it ^. This was unnecessary, since performWork (called by performSyncWork) calls finishRendering at the end.. This new method was necessary to write a test that mimicked RN's Text/View nesting validation.. Moving this to the end of completeWork was necessary to avoid double-popping in the event of an error (like RN's Text/View validation).. Letting the profiler timer know when it's processing sync work enables it to deduct that time from pending async work (by adding it onto the total pause time later). This ensures we don't count time spent processing a batch commit against yielded async work.. This clears out the host root from the profiler timer's DEV-only fiberStack in the event of an error (which prevents us from incorrectly warning on the next render).. This method didn't really feel necessary, so I removed it.. Start time and commit time are accurate. They both contain performance.now() values. Actual and base durations contain time deltas.. So yes, \"time\" now always means a point in time and \"duration\" always means a length of time.. Normally I would have put this check before the prior one, but that would change the error message in a lot of cases and I suspect the current message might be more helpful. Thoughts?. The transient null value didn't seem to be buying us anything, and it complicated the logic below\u2013 so I ditched it.. Nice tests \ud83d\udc4d. Just curious, but when would this happen? I don't see anywhere we push null to this stack.. Do we need this explicit DEV-only pointer?\u00a0Isn't it always the frame at index - 1?. Good comment \ud83d\udc4d . Cool, I'm happy with tweaking the wording \ud83d\ude04 . Not sure I follow. We only use the debugReturn attribute in getStackAddendum() where we just start at the top frame in currentDebugFrames and walk back. Seems like we could just do that with a for loop?. Huh. The change you pushed to getStackAddendum in 5e3f51e looks like what I was suggesting \ud83d\ude05 but it looks like some commits are missing now so I can't step backwards..... \ud83d\udc4d Sure. Follow up PR #13194. Huh... does this work? Do we never push more than once before popping?. Hmm... or is this just assuming that all pushes before the pop will be for the same renderer and will have the same previous stack impl? I find this more confusing initially \ud83d\ude06 . Gotcha. Yeah, that's what I was thinking from reading it. Was just unsure if that would ever cause problems.. Fair enough!. This rename might not be a great idea. Our current naming convention, although confusing, kind fo seems to be that \"fb\" stands for Facebook's \"fbsource\" and \"www\" stands for www.\nWe could do a cleanup pass where we made them more cohesive (i.e. either \"facebook\", \"facebook-www\", or \"facebook-fbsource\") but unless we do a larger cleanup like that, I think the www feature flag file makes better sense with its original name.. No, it's fine. I was just following the forward ref precedent. I think it's mildly useful, but not enough to warrant making the callsites more complicated.. This comment took me back to the stack/fiber split days \ud83d\ude05. Nice comment \ud83d\udc4d . Sure.. Hm, it's early so maybe Dan's explanation makes sense\u2013 but after reading it twice, I'm still confused about why we import assign:\njs\nimport assign from 'object-assign';\nBut then use Object.assign here.\nEdit: I just spotted the assign key in the internals object above, so it makes sense why we import assign but I'm not clear on why we don't also just use assign here instead of Object.assign \ud83d\ude04 . That...makes sense, but I still find the distinction (within this file) confusing. And I suspect others might too. \ud83d\ude04. Minor nit, since this only affects contributors and not users\u2013 I find this kind of confusing, both the naming and how it's overloaded.\nWe could perhaps address both of these issues\u2013 while still satisfying your goal of being highly visible\u2013 by changing splitting the public facing API into different methods:\n toWarnDev: Verifies warning and stack\n toWarnDevWithoutStack: Verifies warning and no-stack\n* toWarnDevWithMaxStackCount: Verifies warning and maximum expected stack count\nJust thinking out loud here. This change isn't necessary.. Nice failure messages.. This param was renamed while I was writing my original comment from expectNoStack to withoutStack. The new name is an improvement.. tiny nit: Might be nicer to move ReactNoop.render outside of the expect call.. Nice \ud83d\udc4d . Clever!\nCould use an inline comment. Wasn't clear (to me at least) on first read what it was doing.. Nice!. Hm? \ud83e\udd14. Did you mean to put this inside of the while loop? I assume you meant to put it before?. D'oh yeah, I must have misread this previously.. nit \"they make debugging\". supernit \"should warn if a property is added to a synthetic event\". I get why it's appealing for yield not to be tied to a root, but it seems odd to me since yielding and flushing are super coupled, and flushing is necessarily tied to a root.. Would be nice if this worked like the flush* methods\u2013 accepting an array of expected yields and auto-validating.\nNot sure how that would work for unstable_flushSync though since that also uses clearYields. Maybe we just shouldn't use clearYields in that method?. The expectedValues param is no longer used.. It's a little weird that flushThrough just flushes a fixed number now and the string values in the array aren't even checked. Seems a bit misleading.. I find toFlushAndThrow a bit confusing. These \"wrong expected values\" are actually exactly what I would expect to pass in\u2013 two yielded values, and then an error. The fact that you have to pass values after the error is weird to me.. Let's just chat about this when you get in \ud83d\ude04 There's something I'm not understanding about why the reconciler works the way it does in this error case. Would probably be easy to clear up from a quick chat.. Right, if you're using the matcher. The use case I was pointing out as odd though is that you could do:\njs\nrenderer.flushThrough(['foo', 'bar']);\nAnd the renderer would happily flush any two arbitrary strings.. Yeah yeah. That's more like what I was thinking.. Hey @acdlite, I was using expirationTime for interaction tracking (#13234)\nAny objection to my adding the parameter back? Or any alternative approach you'd recommend instead?. Disregard! Will move the interaction tracking check to scheduleWork instead.. The start/stop continuation methods aren't really intended for user-facing use. They enable React to restore previous context when processing work asynchronously.. Ah, is our current convention just to throw explicitly?. Yeah, I dig that.. Could this be a dev waring instead?. Not sure if there's much point in discussing it after the PR's been merged \ud83d\ude04 but as for \"why\" \u2013 to avoid impacting the size of the production bundle. It would still fail in both cases, but with a useful message in DEV.. I think the idea is that invariants add up, so as a general rule\u2013 we should make them DEV-only when possible.\nI think it's highly likely you'd try this first in DEV mode, see the error, then fix it\u2013 so you'd get a clear error message regardless.. I don't understand your question, but I'll try to rephrase. My understanding was that for things like this\u2013 where React will error in either case\u2013 it's slightly preferable to add a helpful error message in DEV mode, and let PROD just error without a (helpful) message.. We could remove the enabled param at this point. Base time is a little awkward to handle. Before, we were only including \"begin\" phase work in the base time value\u2013 and this PR continues that behavior, because I wasn't sure how to preserve the behavior we wanted otherwise (without adding an additional field).\nThe behavior is, essentially:\n When cloning a fiber, copy the base time from the previous render.\n If the fiber bails out, leave that value in place.\n If the fiber renders, override the base time value.\n When the fiber completes, bubble up base times from its children.\nSince we are using a single timer to track both the \"actual duration\" and \"base duration\" values, and this timer wraps both the \"begin\" and \"render\" phases\u2013 I opted to only update base time during render (since we know definitively whether we have bailed out or not during that phase).\nIf this is silly for some reason, or you know of a better way to achieve this, let's chat! I don't think it's a very big deal, since completeWork doesn't really include any time spent in user component code.. This PR changes the timing so that we override the actual time spent during the failure with the time spent while retrying it (only for that particular fiber)\u2013 but I think that's fine. This particular detail was kind of arbitrary anyway.. This change was an unnecessary one but made the test a little stronger since 10 & 10 could give a false positive.. Nope, this is just something subjective I've done because it seems to read more clearly that the outer conditional is a feature flag. Happy to combine them if you have a preference.\nTo be fair, there's precedent for this in a lot of other places\u2013 but again, I don't feel strongly about it. If you do, I will change it.. Yeah, that could work! Although that would leak it into user space.. Why would this be expensive to store? It's just a number.\nYou can see how I use it in PR #13253. Each root gets its own base thread ID, which gets combined with the expiration time to uniquely identify a root+priority. I thought this was part of what we agreed to yesterday? Maybe I misundestood.. Fair enough! \ud83d\udc4d . Ha, fair enough. I named it \"base thread id\" initially but then changed my mind. I'll change it back.. To be clear, the reason I changed it was because this could be the actual thread ID. It's an implementation detail of React that a single root spawns multiple \"threads\" for different priorities. You could imagine something else (e.g. Preact) that only has a single \"thread\" just using this return value directly.\nFor that reason, I still slightly prefer it as-is.. Should I only add this property if the enableInteractionTrackingObserver flag is enabled? Kind of leaning that way at the moment.. Nah, that's totally fair. I've always written \"cancelled\" but I think that's ... not the more common US way. I don't care at all. \ud83d\ude04 . Oh whoops, I didn't mean for this particular change to be in this PR. I'll move it to #13253. Yes. I created a fixture locally to test this, actually. I can add it to the repo.. Edit for clarity\nI tried to write the code in a way that guarded against this\u2013 e.g. by restoring the interactions set before calling handlers. So at least it wouldn't leave the package in a corrupted state, assuming something external handled the error.\nI don't think we should swallow the error completely though (although maybe we should?)\nIn either case, I should have added some tests that made the expected behavior more explicit. I will do that now.. Right. I am leaning towards being strict with subscribers\u00a0though. If they error, it's like an error in the callback. We won't leave the module in a corrupted state, but we won't try to run code like nothing happened either.. I've added tests and tightened up the error handling in b8287cf.\n~~I'm still on the fence about whether it's worth adding additional complexity to e.g. catch an error in on subscriber, but still call other subscribers.~~\nEdit - After chatting with Marco, I've just changed the subscriber API to only support a single subscriber. This has the added benefit of removing a lot of forEach loops \ud83d\udc4d . Hmm! I don't know. If so, I could move the definition of root within the if/else to ensure that we always added the same number of fields based on the feature flag.. It will \"break\" in that the callbacks will receive a different thread ID and so any reporting done based on those callbacks would be inaccurate. I'll add a comment to each of these places noting that we shouldn't change one without changing the others. Good call!. Great point. Although I'm not sure what the expected error recover behavior really should be in this case. I'll take a stab at it\u2013 with some new tests\u2013 and we can discuss it from there.. True. That occurred to me but seemed unlikely. I'll replace it with a bool though!. Why not do this override-and-restore stuff in beforeEach/afterEach ? Seems more \"standard\". Totally unimportant but I'm just curious\u2013 was changing consoleSpy to createConsoleSpy actually unnecessary? Couldn't methodName have just used consoleMethod?. Gotcha. I also don't feel strongly about this, was just curious.. I'm also a little unclear on why we store these separately.. What's the value of not just doing this now (in master) and updating www during the next sync?. React mutates the interactionRef directly. Non-react things (e.g. Web Speed's code) will subscribe. I don't really want to expose the ref to things we don't directly control.. The enableInteractionTracking is used to make the production bundle no-op for interaction tracking (since nothing consumes that data).\nThe enableInteractionTrackingObserver flag is maybe not necessary, but I was using it when the subscription stuff was more obnoxious so that we could turn it off entirely if we decided to (e.g. for open source). I could remove this flag if we want.. I don't think wrap is that complicated. This approach avoids an extra function call and additional wrapper function.\nAlso the behavior of wrap/track are different. track is additive (stacking on top of what the current interactions are). wrap temporarily restores interactions at a previous point in time.. My above comment mentions this. The behavior of wrap/track are intentionally different. track is additive (stacking on top of what the current interactions are). wrap temporarily restores interactions at a previous point in time.. Ah, good call. Thanks!. Interesting.\nUsing \"any\" to mask a null initialization value seems equally potentially dangerous but... I don't mind removing all of the Flow casts \ud83d\ude05 . Hm...I could do this, but it would end up throwing the last error, rather than the first. Right?. Ditto ^. Hmm...that would make the API feel clunkier to me \u2639\ufe0fbut if you think it's important/necessary, I trust your judgement.\n\nThat makes this package a bit lighter too.\n\nBy such a tiny amount that it isn't really important \ud83d\ude01. Because that's kind of fundamental to how track and wrap work? I'm not sure I understand the question.. wrap exists so that you can preserve the interactions at a specific time to track async work against them later. If tracking later modified the set of interactions (by accumulating) that could be confusing.\nProbably this doesn't matter in many cases. For something like React that batches work\u2013 I think it might be in some cases.\nI don't think this is a problem. \ud83d\ude04. No, I meant that it would modify the original set. So if I wrapped [foo,bar] I would expect my async work to be attributed to [foo,bar]\u2013 not [foo,bar,...whatever-else-was-also-active]. Okedoke. I'll change it.. I like the brevity of \"track\" and \"wrap\" but I'm not bullish on them if others feel there are more meaningful names.. Returning in finally masks thrown errors.. Ok. I'll pull the subscribe/unsubscribe methods for now and re-add them in a follow up.. Yikes. Yup. Good catch.. The Babel output is fine. I've checked it. \ud83d\ude04\nBut sure, I don't mind.. memoizedInteractions is a Set and the I initially proposed passing onRender an Array. We could change this so that the API passes a Set instead, then I wouldn't need to clone it.\nUsers could mutate it though, and I think a Set can't be object-frozen...?\nOpen to suggestions here \ud83d\ude04. Yes, we're within an active interaction zone at this point. (That's why wrap works in the first place.)\nThe issue is that we attach onResolveOrReject to our thenable to resume work when the e.g. promise has finished loading. wrap ensures that we restore the right set of interactions at that time.\nWithout this, our interaction zone expires when React finishes this batch of work\u2013 and there's nothing to restore it when the thenable completes.. I believe catch is appropriate here, because I specifically want to reset the scheduledCallback only when an error occurs that prevents it from being processed.. Same as above. (I think catch is right here.). Right. This one's a bit tricky, but I'm manually catching and re-throwing to guard against an error in one of the onInteractionScheduledWorkCompleted callbacks\u2013 so that it doesn't block subsequent callbacks. (I'm iterating over a set of interactions and calling this callback for any that have completed.). nit: The naming of this implies that the Fiber is a context provider when it's actually meant more to reflect which phase the component is in. Maybe we could call it something more meaningful? Even didPushOwnContextIfProvider?. This was the only reference to getResultFromResolvedThenable. This should have a big bold inline comment explaining the significance of 2. I don't know why I added the word \"bold\" \ud83e\udd21. I still think an inline comment might be helpful to avoid situations like the one that just happened (person A changing this, and person B discovering a few days later that it causes a lot of churn). Ooh. Seems like we could lint against this.. Nice! \ud83d\ude01 . The chain is ... -> performWorkOnRoot(root) -> completeRoot(root) -> commitRoot(root) -> commitAllHostEffects(root)\nWhy is passing root to this specific function a problem? \ud83d\ude04 . Hm, I think this breaks the suspense case\u2013\u00a0(e.g. covered by test \"tracks both the temporary placeholder and the finished render for an interaction\")\u2013 since renderRoot only resets the stack once but commitRoot is potentially called multiple times. (This causes the interaction pending working \"count\" to be off.). Yes. This was the only type combo I could come up with that worked. If you can show me another syntax that Flow would support though, I'm happy to change it.. Sorry, maybe I'm being dense, but I'm not sure I understand how this feedback applies.. Sure. I didn't want to add the overhead of a function call, but maybe such a small function would just get inlined.. So they can be referenced below when we restore interactions and call onInteractionScheduledWorkCompleted. If the feature flag is disabled, they should get removed anyway since they aren't referenced.. To be clear, try/finally doesn't make sense at all in the test renderer case. I only added the try/catch to recover from a corrupted state.\nThis throw is unrelated. (This code path isn't even executed in the use case my other change was targeting\u2013 since that was an error thrown by onWorkStarted, which gets called by performWorkOnRoot).. > Should be able to use nextRoot, but I assume Brian has passed it as an argument to avoid another type check, since Flow doesn't know that it's not null.\nMaybe I'm missing something... nextRoot is actually null in many cases though.\nrenderRoot() sets nextRoot to null to indicate that there's no more work to be done for the current batch. This means that if performWorkOnRoot() then calls completeRoot() \u2013 the value will be null.\nI assume this is why we've been passing around a root param to these other functions in the first place.. This was my attempt to guard against an edge case error thrown by the interaction-tracking onWorkStarted subscription hook (called from performWorkOnRoot). Such an error would be thrown before any actual React work was processed, so the work shouldn't be cleared.\n~~TBH, I'm not sure of the best way to handle this case. If a tracking hook like onWorkStarted throws, presumably it's going to just throw again if we retry the work.~~\n~~Maybe a better way to handle this would be to just catch the error, process the React work, and then re-throw the caught error afterward?~~\nI was just being silly. I think the not-silly solution here is to make use of the already existing unhandledError var, as I did in c9b6c87.. On re-reading this code, I think the caughtError approach was silly and I should have just made use fo the existing hasUnhandledError / unhandledError variables \ud83d\ude04\nFixed in c9b6c87.. FWIW I added a $FlowFixMe comment here. I don't know of a better way to do this, but we can improve it with a follow up PR.. Subtle nod to DJT. Nah I just can't type for shit. It's a negative look behind to make sure the required module isn't being assigned to a variable.. To be clear, this is definitely a hack. \u2639\ufe0f I'm just not sure how to strip the unused import any other way. And if it's important to us to avoid importing the 816 byte interaction-tracking production bundle, then we have to strip it.. \"safe (not really safe)\" \ud83d\ude06 \ud83d\ude2d . Haha damnit.. Ah, yeah. I'll change it to \"^16.4.3-alpha.0\". Yes that's true. I considered forking but it felt gross. Maybe a UMD constant would be less gross. \ud83d\ude04 Lemme look into that.. The PR blurb mentions the reason I believe we're seeing this:\n\nAs part of this change, the react-scheduler code (which used to be inlined into individual renderers) has been moved to the react package. This makes it look like react has grown more than it has (rather, there is a corresponding decrease in e.g. react-dom).. But this would only impact the UMD bundle ^. Yup, if we want to avoid a no-op side require being in a production bundle. At least making it a plug-in like @TrySound suggested should be a bit faster since it doesn't have to do any extra file IO. Hah, you're right.. I meant for that comment to be in the below default case. I just rebased and cleaned that one up.. We do it for performance since this code is really \"hot\" (it runs a lot). Seb would be a much better person to answer this question but I'll take a stab at it. \ud83d\ude04\n\nJavaScript VM makes property lookup faster for objects by creating a class in the native-code layer based on the \"shape\" of the object (e.g. what keys it has). This is called the \"hidden class\", and it's a runtime optimization. If the VM isn't sure about the object's shape, it uses a slower (hash table) method to lookup properties. When fields are added/deleted after an object is created, it breaks the VM's \"hidden class\" assumptions and de-opts to hash table lookup.\nProbably worth remembering that enableInteractionTracking is a compile time flag so this if/else won't exist in the built bundle. \ud83d\ude04. Yeah, that's reasonable. Although I think the bundled UMD solution is pretty reasonable\u2013 and it's really only for edge-case usage anyway\u2013 I'm not very happy with these \"shims\" and the way they kind of bypass our normal build system.\nI'm not sure how to add an automated check without increasing the hackiness. Any ideas?. Whoops, this comment just came through. I'll tackle this with a follow up :). Huh. That turned out to be simpler than I thought. \ud83d\ude04\n13532. I feel kind of clever about this test even though it's silly \ud83d\ude01 . I'm not sure I understand what you're asking? The plugin name is \"strip-unused-imports\". I think we could use Flow to type the Array below to keep these two files in sync for us, e.g.:\nEvents: [Foo, Bar, Baz] = [ ... ]\nLike so. True, it wouldn't be perfect, but even if all the types were the same\u2013 it would warn if we added/removed an arg one place and not the other.. Yeah, it was\u2013 but I'm not sure it was the right decision. Still poking around locally. May revert this.. I thought so too, but it results in the scheduler methods (e.g. cancelScheduledWork) being embedded in the package, so... I re-added it.. The approach seems to be working fine. At least, the bundles look good to me. Removing this dep causes troubles though.\nThere may be a reasonable explanation. I'm not going to dig into it today though. (Holiday.)\nI think this PR is good at this point. The deposit was already there so it's at least not new from this PR.. I dig it. \ud83d\udc4d Thanks for the ideas Dan.. No, I can change the comment \ud83d\ude06 . This approach causes some interactions to get lumped together in the case of a suspended+sync root with a high priority interruption, but I think that might be acceptable?\nI'd be happy to discuss alternatives!. Ah, poo. Ok.. Rebasing on master seems to suggest that master is broken \ud83d\ude04 \n```\n$ yarn build\nBUILDING  react.development.js (umd_dev)\n OH NOES!  react.development.js (umd_dev)\nError: Could not resolve 'scheduler' from /Users/bvaughn/Documents/git/react/packages/react/src/ReactSharedInternals.js\n    at /Users/bvaughn/Documents/git/react/node_modules/rollup-plugin-node-resolve/dist/rollup-plugin-node-resolve.cjs.js:85:23\n``. Ah, I probably just need to runyarnfirst huh. I always forget this silly step \ud83d\ude04 . Okay, rebased!. This name isn't accurate for the initialnullrender but I don't care \ud83d\ude01 . Yeah, because of the renamed schedule method \ud83d\ude04. I don't feel strongly about this, but I preferDefaultPriority. Either we should renameNormalPriority->DefaultPriorityor we should rename this toNORMAL_PRIORITY_TIMEOUT(but I prefer the former). Whether a native lib likeperformance.now` is available depends on a fixed thing, e.g. the browser+version. So assigning the function up front avoids us having to do a conditional check inside of a very \"hot\" function (one that's called lots of times). The resulting code size will be slightly larger but it's worth the runtime performance gains.. So this loop is handling the case where a higher priority callback is scheduled while we're executing and a continuation is returned\u2013\u00a0so we want to drop the continuation in where the previous callback was, without it preempting the higher priority work?\nI think this is not obvious from the scope of this function and we should add an inline comment.. This condition looks subtle and could use a comment.\nI think it's meant to guard against reentrancy, e.g. if you called wrap and then immediately executed the wrapped function within another scheduled callback\u2013 because I think the only time currentEventStartTime === -1 is essentially when it's called from a finally block (else it would have the current time).. Is it intentional that we still flush immediate in the event of an error?. (Same question about flushing after an error). Might be worth a comment here that we check \">=\" (instead of \">\" like in unstable_scheduleCallback) intentionally, because we want the continuation to be the first callback with this priority. (It's probably not that subtle but still may be worth mentioning explicitly...). Nice! Glad to see this explicitly tested. nit \"wrapped callbacks inherit the current priority\" ?. The timeRemaining function is called many times, and so it's performance sensitive. Each time it's called, it needs to read the current time (now) so setting this value once would not work.. I guess we don't, since we also provide a nice DEV mode warning if it's not a function. I'll remove this type check.. ~~Actually, if we don't check in at least the instantiation path, we'll throw before our DEV warning. So I think it's best to leave these checks in place after all.~~\n~~If you feel strongly about it, let's talk and come up with another plan. I think the DEV warnings are useful to preserve though.~~\nDisregard. I'll just move the warning earlier. #13736. nit: Ambiguous wording. This function declaration fails the no-inner-declarations lint rule.. This test was useful for me since my initial \"fix\" to sync mode broke concurrent mode. I'm not sure about this amount of abstraction though. On the one hand, it makes it very easy to spot what's different between these otherwise very similar tests. On the other hand, it may be harder to read.. I'm not super confident about this fix ^. This file was literally copied from ReactErrorBoundaries-test.internal.js so it doesn't really need to be reviewed. Normally I would have git mved it, but in this case\u2013 I wanted the reviewer to be able to easily spot the places the new render-phase error boundary behavior differed from the old behavior\u2013\u00a0so I modified the existing file.. Nice, thanks!. I think in the initial commit (7c4ff13) ensureHostCallbackIsScheduled expected a param, but the second commit (5f74f04) changed it to just read from the package-level firstCallbackNode variable since that's always the value that was passed in anyway. Seems like the call sites were just overlooked as part of this change.. This import is not used.. This isn't actually used anywhere within this test.. We might want to add future clarity about whether this package is meant for generic React testing or only for testing with react-test-renderer. (I assume the latter.). I still think it's weird that this matcher accepts the ReactTestRenderer rather than a renderer instance.. This is...interesting. I guess it allows you to avoid the inline require, but it also seems more complex and less powerful than what I originally wrote. Why the change?\nFor example, the following test would work with this matcher:\njs\nconst ExampleComponent = ({ foo }) => foo;\nconst renderer = ReactTestRenderer.create(<ExampleComponent foo=\"bar\" />);\nexpect(renderer).toMatchRenderedOutput('bar');\nBut this test wouldn't:\njs\nconst ExampleComponent = ({ foo }) => <div>{foo}</div>;\nconst renderer = ReactTestRenderer.create(<ExampleComponent foo=\"bar\" />);\nexpect(renderer).toMatchRenderedOutput(<div>bar</div>);\nAnd so I wouldn't be able to use this matcher for the tests in ErrorBoundaryReconciliation.. That's fair. I think it's reasonable\nI'm concerned that what we have with this PR isn't flexible enough to be very useful with many \"real\" components.. Oh whoops, missed your second comment.\n\nAlso why wouldn't that test work?\n\nLots of undefined property access errors. If you think it should be possible for it to work with more complex test cases, then I can help dig into how we'd fix it.. Cool. In that case, it would be great to update ErrorBoundaryReconciliation to use the new matcher.. I added inline comments initially, as I wrote these tests, thinking I might point people to the test as a reference in lieu of docs\u2013 but maybe I should remove them?. No. People will see this and then it's meant for use with Enzyme.. It's more a matter of consistency. I expect people will accidentally use expect(renderer).toClearYields because that's what they do everywhere else. Nice!. Just noticed this. Looks like an oversight that you read from workInProgress.memoizedProps.fallback twice rather than use the fallback const.. s/tree it/treat it/ \ud83d\ude04 . Oh schwoops.. Andrew has concerns that createResource is less stable.. Seems like this error message should mention \"hooks\". It's a little cryptic.. Yeah, I like that change.. ~~It's early and I'm probably being stupid, but shouldn't this be elapsedTimeInMs < scheduledCallbackTimeout ?~~\nEdit Never mind. This is just saying that we should never yield if work has already timed out.. It's not initially obvious to me that dl.didTimeout is semantically equivalent to shouldYieldToRenderer() but I trust you here.. Uh, why ! >= rather than <?. \"We yielded at least as many\"?. This test is not running in concurrent mode, so placeholders are shown immediately (sync).. These tests seem a little weak since they don't assert on what the error message actually is. I guess ReactDOMServerIntegrationTestUtils doesn't provide a mechanism to do this currently, but it seems like it would be an improvement if e.g. expectErrors supported either a number or an error of partial messages.. Seems a little odd that we're any-casting something that explicitly might not be ReactContext to that type for DEV mode.. I don't think we normally include results.json in PRs (to avoid causing merge conflicts).. Would be nice to have some basic testing of the stack parsing+intersection logic too.. Would be nice if we had an automated check to ensure that the set of fake hooks here stays in sync with the set of real ones.. Would be nice if we had an automated check to ensure these hook signatures stayed in-sync with the real ones.. Why do we swallow errors in this way? An error in an given hook would block parsing of all subsequent hooks.. Seems a little confusing that a function named nextHook returns the current hook \ud83d\ude04. This comment is great. ^\nWould be nice to have some tests for these cases.. Why not just read the value from contextMap directly in readContext and useContext (rather than temporarily overriding context._currentValue)?. Yeah, I chose my words poorly.\nI was trying to point out that an error halfway through the hooks initialization would leave primitiveStackCache halfway populated with stack info, which seems weird. What's the point? It seems like we should just fail hard (no primitiveStackCache, future calls to this method also fail). Good catch. Fixed and updated tests to cover this via 7be6879. I don't think so, because completeUnitOfWork also calls startProfilerTimer before it starts working on the complete phase.\nThis clears out the previous timer, erasing any time spent in the \"begin\" phase. That's what we're recording here.. \ud83e\udd2a Right.. We already have a similar bubbling there to ensure that actualDuration bubbles all the way up to the Suspense component (or error boundary).\nI think it's tricky to propagate this specific value (from the fiber that threw) in completeUnitOfWork without counting it too many times (since we unwind and process ancestors between the fiber that throws and either Suspense or an error boundary).\nWe know we've reached the ancestor boundary when next != null but...I'm not sure of a heuristic to only update for the fiber that threw. Conceptually, it feels like the right place to do this is where we catch.\n. Scratch that, I misunderstood your initial suggestion. You're right!. Thanks for adding a new integration test!. I strongly dislike the fact that the newly proposed API methods only exist on the DEV build.\nDo other packages do this? I know that sometimes methods are no-ops in production builds, but having them be missing entirely feels weird.\nI also think the fact that these methods exist only for DEV reinforces the notion that you could just use existing browser tooling (like the browser's built-in pause/resume functionality).. Let's revert the changes to this file.. Why isn't the browser's built-in pause/resume functionality sufficient for whatever you're using this for?. Instead of exposing play, pause, and dump-queue\u2013 what if we just exposed the queue itself (firstCallbackNode) somewhere globally in DEV mode only? Then we could just write our own tiny helper function that read from it (if that was actually needed).\n(This also assumes that we just use the browser's built-in play/pause script execution functionality.. Seems like this could get noisy if we don't do any kind of de-duping. I wonder if this is something you considered and ruled out?\nGuess de-duping would have a small impact on tests too.. Ugh, this is subtle. Had to read these tests a couple times. Nice to have a warning for it.. This var is no longer used. pushstate-server works better. I thought this conditional was stripped from production and production+profiling builds (as part of uglification).\nRemoving it will cause non-profiling production builds to increase memory size, no?. Looking at the CJS bundles in NPM, it looks to me like the condition is being removed from all but the dev builds.. FWIW, my above comment only applies to builds where this flag is static ^. It is static for production bundles\u2013 just not the dev bundle because we don't dead code eliminate it.\nWe choose which bundle to serve based on a gatekeeper. (We switch at the level of the react-dom bundle.) Within the bundles\u2013 profiling or production+profiling\u2013 we've already DCE'd so the condition has been removed.. Do these lines not affect anything? (Any reason we shouldn't move them and the hooks assignments into the function too?). I guess React.Children.* isn't used often enough to matter?. Whoops, yes.. Shit. That was my way of making sure no one but me changed the scripts. \ud83d\ude09 . I don't see a pattern in what you use an uppercase first letter for (e.g. ReactCurrentFiberPhase) and what stays lower case (e.g. getInstance). Curious why we forked for enableHooks rather than using ternaries like for enableStableConcurrentModeAPIs and __DEV__? e.g.\n```js\nReact = {\n  Children: {\n    map,\n    forEach,\n    count,\n    toArray,\n    only,\n  },\ncreateRef,\n  Component,\n  PureComponent,\ncreateContext,\n  forwardRef,\n  lazy,\n  memo,\nFragment: REACT_FRAGMENT_TYPE,\n  StrictMode: REACT_STRICT_MODE_TYPE,\n  Suspense: REACT_SUSPENSE_TYPE,\ncreateElement: DEV ? createElementWithValidation : createElement,\n  cloneElement: DEV ? cloneElementWithValidation : cloneElement,\n  createFactory: DEV ? createFactoryWithValidation : createFactory,\n  isValidElement: isValidElement,\nversion: ReactVersion,\n__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED: ReactSharedInternals,\nConcurrentMode: enableStableConcurrentModeAPIs\n    ? REACT_CONCURRENT_MODE_TYPE\n    : null,\n  Profiler: enableStableConcurrentModeAPIs ? REACT_PROFILER_TYPE : null,\nunstable_ConcurrentMode: !enableStableConcurrentModeAPIs\n    ? REACT_CONCURRENT_MODE_TYPE\n    : null,\n  unstable_Profiler: !enableStableConcurrentModeAPIs\n    ? REACT_PROFILER_TYPE\n    : null,\nuseCallback: enableHooks ? useCallback : null,\n  useContext: enableHooks ? useContext : null,\n  useEffect: enableHooks ? useEffect : null,\n  useImperativeMethods: enableHooks ? useImperativeMethods : null,\n  useLayoutEffect: enableHooks ? useLayoutEffect : null,\n  useMemo: enableHooks ? useMemo : null,\n  useMutationEffect: enableHooks ? useMutationEffect : null,\n  useReducer: enableHooks ? useReducer : null,\n  useRef: enableHooks ? useRef : null,\n  useState: enableHooks ? useState : null,\n};\n``\nNo big deal I guess, just curious.. True, although...we do the same for the unstable/stableConcurrentModeandProfilerproperties. I\"m not sure why that would actually matter. Seems preferable to forking but...I don't feel strongly \ud83d\ude04 . Yeah I agree completely. I wasn't suggesting that \ud83d\ude05 I don't like even this fork but I think we've already talked about it more than it's worth so I'll \ud83e\udd10 . Would you feel any differently aboutundefined?. I'm not sure what this comment means. Literally the line right above this, Imkdir build && mkdir build/node_modules`. > is there a reason the output is hidden?\nMakes the overall flow of the build script easier to follow.\nI guess if you think it's important to show the build script output, the scripts could be tweaked to do this. I don't feel very strongly here.. Hm. Ok.. Oh! Ha! I forgot to specify cwd with this command.. Hm. At least some of the fixtures pull from build/node_modules (e.g. the Webpack fixture). I assumed they all did to be honest. Let me wipe out build and do a fresh pass at this to see what's up myself \ud83d\ude04 . I have a \"nice to have\" entry on the umbrella issue that says:\n\nStore local rolling average for how long the \"build\" step takes for long steps (e.g. create-canary) and show a progress bar with estimated time remaining.\n\nThat seems like maybe the ideal way to do this.. I see the build/dist references. I'll update them to point into build/node_modules UMD folders!. 9000 is the default port.. Yeah maybe that's a good improvement :). \ud83e\udd14 Good point. (done). This is a little awkward. I could combine these branches?. This convention seemed fairly inline with existing Jest mock packages.. build-info is metadata managed and used by our release scripts.. Sure, combined in db14ad8. Just some metadata about this build, e.g.\nhttps://unpkg.com/react@canary/build-info.json\nIt's useful particularly for the prepare-stable script when it comes to swapping out the shared/ReactVersion value\u2013 but also I think it might be generally useful.. We don't need to do this manually anymore! \ud83d\ude01 . Sure!. I assumed this external was required for some reason, since it was listed as a dependency for the jest-react package (even though that package didn't reference it anywhere that I saw).. Cool. That was definitely just copypasta.. Oh well. We can rip it out in of both then.. #14372. Interesting. I was referring to the fact that the result is Fibers all having different shapes (which seemed like a deopt to me) but admittedly, I was just guessing at terminology \ud83d\ude04 \nEdit I've updated the wording based on your clarification ~ 1dc108e. What do you mean by \"in any other context\"?. > For example, if arbitrary user code could make host components hidden today\nAh. This isHidden attribute is set by the renderer's host config though. It's not something users can directly set. So if we ever had an invalid isHidden setting, that would mean a bug in React (or at least the test renderer).. I guess that makes sense...but it feels like that would be a kind of heavyweight way to guard against that.\nI think we would need to update this function, as well as the toJSON recursive method it calls, to check every child for isHidden === true and if it ever finds them\u2013 verify that there is only one sibling, and that it's isHidden === false.. This change (and the one in check-out-packages) was just fixing an edge case I noticed while testing these changes.. We never actually used this combination anywhere (in www, fbsource, or open source).. nit: This should actually be React.lazy(() => ({default: Component}); but that doesn't matter for the purposes of this test.. Somewhat arbitrary (so I'll move it).\nSeems a little weird either way, since such a synchronous re-renderer would mean we're reading from stale memoizedProps when we do our copy.. Looks like debugRenderPhaseSideEffects is a dynamic value, debugRenderPhaseSideEffectsForStrictMode is being set to true in InitializeReactFeatureFlags, and nothing is changing the default value of warnAboutDeprecatedLifecycles.. This is a nice cleanup, although we'll probably end up restoring a similar fork when suspense metrics are added.. All of these tests can now be run against the built bundle \ud83d\udc4d . All of these tests can now be run against the built bundle \ud83d\udc4d . Sure, I can add a test for that. I'm not sure what the expected behavior should be. A warning? Just ignore it entirely?\nFor now I'll just  remove them.. Good point. I meant to do this but forgot. \ud83d\ude01 . This seems trickier than I thought because of how we're parsing the stack for function names and then comparing them to the primitive labels.\nFor example, I can name the local function something more unique (e.g.  useDebugValue__REACT_INTERNAL) but if it's assigned to the dispatcher as useDebugValue\u2013 then function name that's being parsed and passed to isReactWrapper is useDebugValue.\nMaybe I'm overlooking something obvious. I'll come back to this.\nOr maybe I'll just use the subHooks.length heuristic.. Maybe we could make DEV faster by splitting up the hook definition?\njs\nlet hook: Hook = __DEV__\n  ? {\n      _debugType: currentHookType,\n      memoizedState: null,\n      baseState: null,\n      next: null\n    }\n  : {\n      memoizedState: null,\n      baseState: null,\n      next: null\n    };. > Maybe we could use react-debug-tools to print a warning that shows the expected the hook structure versus the actual one cc @bvaughn\n@acdlite's idea sounds nice. Kind of like a Jest diff error\u2013\u00a0expected  but got \nI guess we'd need to set some global flag at this point (rather than warning) indicating that a mismatch occurred, then check and do the warning elsewhere. Maybe in ReactFiberBeginWork -> updateFunctionComponent?. nit: Should we only set the ReactCurrentDispatcher.current to a non-null dispatcher when actually rendering? Not sure if this is strictly necessary, but it seems more semantically correct (and is more inline with other renderers).. Needs useDebugValue (noop). The partial renderer impl varies from yours:\njs\nfunction readContext<T>(\n  context: ReactContext<T>,\n  observedBits: void | number | boolean,\n): T {\n  let threadID = currentThreadID;\n  validateContextBounds(context, threadID);\n  return context[threadID];\n}\nNot sure of this reason for this. Is it a mistake?. We'll want to add a return type of typeof Dispatcher to this one #14599 is merged. Agreed. Just didn't have any context on the SSR case for this and wanted verification that it wouldn't cause any unforeseen trouble here.. > This sounds like a race condition to me\nWhat makes you say this?\nTemporarily overriding the current dispatcher is a pattern we follow in several places. As long as   each place that overrides is careful to restore on completion, what's the race?. Seems a little weird now that we're exporting these multiple times with the same name \u00af_(\u30c4)_/\u00af Oh well though.. tiny nit: This is unlikely to conflict, but should we maybe pick something a little longer and more unique?. super tiny nit result !== null && .... Because I wasn't convinced that no 16.8+ renderer would ever have a valid use case for accessing current dispatcher?. e.g. react-cache uses it. What is this break statement doing inside of the if block?. How is this intended to be used? (When would you need it?). TIL \"elided\". \ud83d\ude2e lol. What's an example of code that would fire this warning? The rule supports refs, and e.g. props objects. It seems to be okay with other mutable values you pass it.. Interesting. I thought a little (not much) about useReducer support but didn't think it was necessary.\nEdit for clarity: DevTools only supports edit functionality (currently) for useState but I could go back to the drawing board if we think it's important to support useReducer too!. Are you suggesting I rename the injected overrideHook method to overrideHookDebugValue? I think that sounds confusingly close to useDebugValue even though they aren't actually related. Maybe I'm misunderstanding you.\noverrideHookState seems okay though. Probably more clearly indicates its purpose. . Good catch. My test had a blindspot here since the null hook would just re-initialize the state. I'll change it to throw if that happens.. Hmm... \ud83e\udd14 I think this might be trickier than a simple __DEV__ check can account for. It's not a matter of whether react-debug-tools is itself in production or development mode, but whether the renderer it's interacting with is.. This comment and the code below seem out of sync. Maybe bad copy-pasta? Maybe should mirror the comment above?\n\nValid because the ref is captured.. I think I've complied with part of your request (renaming overrideHook to overrideHookState) but I'm still a little fuzzy on the other comment. Would you like me to also rename isEditable to something like isStateEditable?. Chatted offline and the consensus was this:\n Replace index and isEditable properties with a single property, e.g. overrideState that is either a function or null.\n DevTools will pass through the renderer-injected values to react-debug-tools when inspecting a fiber.\n* For hooks that are editable, react-debug-tools will add an overrideState function that closes over the necessary info.. This change wasn't strictly necessary but it seems like this test is a bit more robust (and reads better) if it uses our toWarnDev check.. No, we can't get rid of currentHookNameInDev because we use it in the areHookInputsEqual function. We could pass it directly to the dev checks but it didn't seem necessary since the module variable is already there.\n\nI'm going to merge this for now since it seems like this comment doesn't require a change and I don't want to interrupt your work flow. I can follow up with another PR if you have any follow up feedback though. \ud83d\ude04 . Actually implementing the changes above is proving to be kind of complicated, and I'm having second thoughts about it being a good idea. It requires maintaining and coordinating several data structures, all of which are updated async.\nInspecting hooks\nReact itself has the hooks list stored in memoizedState. These hooks are what we actually need to update.\nReactDebugHooks has its own inspected hooks object, consisting of a pointer to the \"native\" hook, the name (e.g. \"State\"), value, array of sub-hooks (if it's a custom hook), and an overrideState function that closes over things needed to e.g. modify a state or reducer hook.\nThe frontend needs its own representation, but since this is sent across the Bridge\u2013 we need to replace the overrideState function with something that can be serialized. So we need an ID that lets us map back to the original closure function. This means a third structure\u2013 with an id, name, value, sub-hooks array, and an isStateEditable boolean indicating whether there's an overrideState function.\nOverriding state\nThe frontend starts by sending an \"overrideHookState\" message with the hook id, path, override value, and the renderer ID (so the backend can find the right injected internals).\nThe agent uses the renderer ID to pass this info along to the appropriate renderer interface, which needs to be able to find the original inspected hook (from ReactDebugHooks, using our ID) so it can call the overrideState method.\nThen the overrideState method needs a way to find the current fiber, and to call the renderer's injected overrideHookState method with that fiber along with the \"native\" hook, path, and value.. @sebmarkbage Let's talk about this again. I'm not convinced that this change is a positive one after looking into how I would implement it. I think it adds a lot of complexity without adding enough value to offset it.. Nice test! \ud83d\udc4d . I guess this is the right approach, since we kind of have to assume immutability for much of this stuff to work. Seems like it's at least possible that props.foo.bar.baz was specified because foo gets mutated, but I guess we just don't support that case.. Nice \ud83d\udc4d . \u2764\ufe0f . Yeah, this particular before and after example just made me think about it more closely :). No. A side effect would be e.g. mutating a variable or calling a callback. This is just telling React to schedule some follow up work.. This is essentially following the pattern we recommend for derived state:\nhttps://reactjs.org/docs/hooks-faq.html#how-do-i-implement-getderivedstatefromprops. So the thing I'm guarding against here (which maybe my comment doesn't do a good job of clarifying) is this:\n\nSubscription added to source A\nComponent renders with a new source, source B\nSource A emits an update\nPassive effect is invoked, removing subscription from A and adding to B\n\nWe need to ignore the update from A that happens after we get a new source (but before our passive effect is fired).\nI tried to make this clear with all of the inline comments but maybe I could improve them somehow?. This check might be useful in two scenarios:\n\nOur manual call to checkForUpdates() in the passive effect body (a few lines below).\nWhen we attach our subscription (since some sources, like rxjs, will auto-invoke a handler when attached).\n\nI could use another local var (like didUnsubscribe) to track this but that doesn't seem any better than this check, IMO.. No. Because in the case I mentioned above, we haven't unsubscribed yet (because the passive effect wasn't yet fired).. We sync-check in case we've missed an update (1). We also need to subscribe for updates to be notified of future updates (2). We wouldn't have to sync-check if all subscription sources auto-invoked our subscription callback, but that's not the case. Some do, some don't.. ",
    "bmaurer": "Could you simplify this by making lastHtml '' rather than undefined? . ",
    "blasten": "@gaearon this implementation doesn't allow to pass values other than strings to a custom element. How do I pass an array, object or function?. ",
    "davidwparker": "Minor: Looks like you have some inconsistent spacing here. (sometimes 2, sometimes 3).... ",
    "vinnymac": "@nhunzaker If you make a request to the NPM registry and parse out the version keys, you should be able to get a similar output to the npm view react versions command. Here is the response on the registry for react, it contains all versions published. (Note: You could fall back to Yarn if NPM was down.) \nEDIT: If you are going to be doing all of this in the browser, that method may actually fail, as the NPM registry turned off CORS support. An alternative option would be to fetch the tags instead.. @nhunzaker Here is what the docs says about Browser Support. Having ES5 does appear to be the boundary. Shimming support for other browsers is possible (IE8 on React v0.14).. ",
    "vernondegoede": "Custom components makes me think of web components (custom web elements). I think user-defined sounds better \ud83d\udc4d . ",
    "Andarist": "Yes. But test file would need to stay as in my PR so the ordering issue is solved by resetModules. Sure thing, should the new one be located in the same file or should I move it somewhere else? gonna prepare better test later 2day. Should i revert this change and the latter? Would be cool to fix this whole thing in 15.x. should i just var ReactComponentTreeHook = require('ReactComponentTreeHook') at the top of the file? \nThis ReactComponentTreeHook is later conditionally required in __DEV__ block. What about it then? Should something be adjusted?. !nativeEvent.relatedTarget.disabled - is this needed? I think it wont even be emitted by the browser when relatedTarget is disabled . > Why not import * as Children from './ReactChildren'; export { Children };? If ReactChildren exports only the public API, this would allow for tree shaking.\nWould it? I would expect Children becoming an object after such a thing and thus preventing tree-shaking for less sophisticated algorithms. I don't think namespace reexports are tree-shakeable by webpack, although I might be wrong.. @trueadm actually this could be useful for libraries wanting to hide their providers \ud83e\udd14 . @Kovensky not sure if you statements agrees with me or not, just to test this once again - even if only for myself - I've prepared a quick test to see if they are treeshakeable by webpack or not and according to my results they are not\nhttps://github.com/Andarist/webpack-reexported-namespace-test/blob/cf141855cf341a9cf0ea673d760546f77438e6ca/dist/main.js#L47-L54. wont this deopt ReactDOM object once again?. The reversed condition should be DCEed just fine though.. according to the previous check - those lengths should be the same, so shouldnt this iteration just assume that fact?. This checks the render count - see renderCountRef. I can't just count renders directly inside Inner, because it has to render (it reads changed context).\nWhy this matters?\nBecause it's inconsistent with \"regular\" memo component. Conceptually from the user's perspective React.memo(Component) & React.memo(Component, shallowEqual) should behave exactly the same (but they dont).\nIt makes caching assumptions less predictable. While this test is ofc artificial I've encountered this problem when implementing some derived state caching (based on both context & props) in a real world application. It caught me completely off guard because I was relaying on the fact that React.memo should always provide me same props (referentially equal) and I've only checked against that - skipping shallowEqual because I was trusting React to perform this one on my behalf.. Comparing against props referential identity isnt that unusual - https://github.com/reduxjs/react-redux/blob/fac9ad19d17000f5b9fdd52fc9843225b807845b/src/components/connectAdvanced.js#L142 .\nI can't change this test to rely on props.something because this issue is specifically about the fact that props are not referentially equal in this case (sorry if I havent made that clear before). Anything on the props will be referentially equal as it pass shallowEqual test.\nMy point is that the current behaviour is inconsistent here and IMHO that's not a good thing because it makes the mental model about this a little bit unreliable.\nHave you checked out my codesandbox which compares React.memo(Component) & React.memo(Component, shallowEqual)? I strongly believe that they should behave exactly the same and should not be distinguishable from user's perspective, as React.memo implementation conceptually looks like:\nReact.memo = (Component, compare = shallowEqual) => {\n // ...\n}\nTherefore supplying the second argument implicitly (relaying on default params) and explicitly should result in the very same observable behaviour.\nWhen I've encountered this issue in my code I've supplied shallowEqual as 2nd argument by hand, just so I could put a debugger statement quicker in it's implementation to see why my component is rerendering and to my surprise it has fixed \"the issue\" which was at very least really surprising (knowing that React.memo uses shallowEqual by default). Oh, good to know! I was writing this test based on other test in this file and it has used this readContext thingy inside the render \ud83e\udd14 . This error message kinda surprises me when taking into account our recent discussion ( https://github.com/facebook/react/pull/14876 ) around props referential equality etc. \nIf props have \"unstable\" reference then IMHO you shouldnt ever suggest using it as hook's dependency \ud83e\udd14 The latter advice sounds way more appropriate (destructuring). isnt this somewhat a side effect in render phase? i suppose it leads to a predictable result even if a particular render gets replayed, but shouldnt generally this be done inside useEffect?. Thanks for the clarification!. Shouldnt the advice get reordered then? First propose destructuring and only latter propose using props directly.\nYou are calling it an escape hatch to shut up the rule - so it sounds to me that this is actually not something which you'd like to recommend. . Sure, might prepare one - was just validating my thinking so far :). ",
    "kwonoj": "Don't know reason why, but on Windows when global.process has replaced it loses access to process.cwd, test runner setup fails to use those function.. yeah, good catch. I think I saw some glitch when not to stringify, but it seems not - updated.. ",
    "jochenberger": "I guess you meant to name this \"rjs-test\". Apart from that, there's not much I can contribute here I'm afraid. :-(. ",
    "treyp": "may want to refer to the wrapperify instance in this error as wrapperifyAddons. ",
    "churchie317": "Looks like this is working correctly.. Do you know why these moved to the test-failing file? Are they a regression introduced in an earlier commit?. Oh, whoops.\nThis is actually from an earlier PR that's still pending. Is there a good way to handle something like this?. ",
    "gyfis": "I thought it would be a good fit here because it's a place where the ref callback calls are mentioned, and also, for me, the first time I was reading up about refs was also the time I'd appreciate this kind of information. But you're right it's a better fit for the \"Caveats\" section. I'll update the text later today. Thanks!. I understand what you mean, thanks! I've moved the text talking about the double ref fire into a \"Caveats\" section at the bottom of the doc as advised, so hopefully new readers of React won't have to care about these specific details unless/until they really need it.. Thanks for the suggestions! I'm ok with all but replacing the mentioned render with updates, maybe I don't understand but when saying it will get called twice during updates, what updates? The DOM update? Props/State update? I think it may confuse readers; when we specify during render directly, I think it's more technical, but more clear too.. Actually I've read the whole paragraph again, and updates is ok - it is mentioned afterwards that it's the render that creates the function. Thanks and sorry for the confusion!. ",
    "sptq": "I think you can change this to let instead of var\n. You could change var to const. You can change those to import instead of require. ",
    "joeldenning": "Not sure if there is a better way to do this. I want custom properties on custom elements to be set, but the next few lines of code prevent that from happening because DOMProperties.properties cannot possible have a propertyInfo for a custom property name.\nThe reason why I'm calling this function at all is because I want the instrumentation code in this function to run. Otherwise I would consider just doing node[propName] = propValue inside of ReactDOMComponent itself.. Like I described above, custom properties on custom elements won't have a propertyInfo definition, but we still want to set them on the element.. See my comments above for setValueForProperty -- I'm changing this function for much the same reason.. custom elements now only receive element properties, not attributes.. Tbh I don't really know what \"attribute key injection attack on markup\" is. This test started failing when I changed the code because it's expecting attributes to be set instead of properties. However, my guess is that this attack vector doesn't apply anymore now that we're not actually putting the react props into the markup as attributes.\nNot 100% sure, though, would love to hear others' thoughts on it.. Same here about this probably no longer being applicable now that things are passed as properties instead of attributes.. See custom elements spec for why I changed this. It explains that you create customized built-in elements like so:\n```js\n/ Method 1: the \"is\" attribute in the markup\n * React doesn't do this because it calls createElement instead of setting innerHTML\n /\ndocument.body.innerHTML = '';\n/ Method 2: the \"is\" option when calling createElement\n * React needs to do this in order for the browser to correctly upgrade an\n * element to be a customized built-in element.\n /\ndocument.createElement('button', {is: 'my-button'});\n``. React props are now dom element properties, not attributes. Thetrueis to indicate that this is a custom element node.. Same here - React props are now dom element properties, not attributes. Thetrueonce again indicates that this is a custom element node.. If this pull request is merged, then the only way to set attributes on a custom element would be with refs ( el.setAttribute('my-attr', val)} />).. Note that when you change many native dom properties (such asnode.idandnode.className) that the corresponding attributes (idandclass) are automatically changed to reflect the property value. So users will still be able to effectively set theidandclassattributes (among others), by changing theidandclassName` properties on the element.. See https://dom.spec.whatwg.org/#dom-document-createelement.\nThe is prop indicates that the react element should be a customized builtin element.. document.createElement should not have a second argument of a string, but rather an options object. ",
    "jddxf": "They help to normalize the path.But we need more work to construct a RegExp instance. \n\nThe backslash added here is to escape the leading separator, which is an special character in regular expression.\nOh,Wait.All of a sudden, I find the dots need to be escaped too.So I'll change it to:\nvar reactRegex = new RegExp(\n  path.join('/', '(?:React|ReactDOM)(?:\\.d)?\\.ts$')\n    .replace(/[\\\\.]/g, '\\\\$&')\n);\nOr more simple, if we don't mind matching files like XXXReact.d.ts:\nvar reactRegex = /(?:React|ReactDOM)(?:\\.d)?\\.ts$/;\n@gaearon Which do you think would be better?. @acdlite I found flow would catch this if Deadline was declared in ReactFiberScheduler.More details https://github.com/facebook/flow/issues/3368. ",
    "crosscompile": "In terms of linting, would it be preferable to pull in the eslint updates from master and make 15-stable conform?  Or update 15-stable to conform to its current linting rules?  I seem to be getting linting errors on install due to these changes and this rule.  That rule was removed in 16.. That makes more sense, I've made the changes!. ",
    "justinfagnani": "How would one set an attribute on a custom element then?. ",
    "rauchg": "@aweary my understanding is that deduping is happening there because it's a function that can be called many times. Isn't this file meant to be evaluated once?. I also couldn't decide if it was exactly a warning. It's more along the lines of \"Listening on http://localhost:3000\", which everyone is ok with.. ",
    "spikebrehm": "Another distinction is that warning uses console.error(), rather than console.log():\n(cf. https://github.com/BerkeleyTrue/warning/blob/master/warning.js#L38)\nHowever IMO console.warn() would be the most appropriate in this case.. ",
    "tomgasson": "No, that still uses windows slashes\npath.normalize('C:\\\\temp\\\\\\\\foo\\\\bar\\\\..\\\\');\n// Returns: 'C:\\\\temp\\\\foo\\\\'\nhttps://nodejs.org/api/path.html#path_path_normalize_path. ",
    "diegomura": "Not sure where to add this event on the docs. Does not feel right in any of the current categories, that's why I added a new one, but still not sure if is the way to go. ",
    "andys8": "I'd suggest using template strings and/or not mixing single and double quotes.. @dhyey35 How about dropping return?\njsx\nconst Comment = props => (\n    <div className=\"comment\">\n        <h2 className=\"commentAuthor\">\n            {props.author}\n        </h2>\n        <span>{props.children.toString()}</span>\n    </div>\n);. \"than\" vs. \"then\". > the measurements .See the\nSpacing in text. Question for understanding: Should it be available globally by default? When will it be available and when not? What circumstances trigger the different states?. ",
    "j0lv3r4": "yeah, i should look for all react trees and run the observer on each of them; will fix.. ",
    "jamesknelson": "I haven't found a way to make CodePen and similar tools work with routing examples. They disable access to pushState -- probably for good reason.\nFor the RRv4 and Junctions docs, we're using an in-memory history object and a \"fake\" url bar component. But this sounds a little heavy for the React website?. Will remove the filename suggestion.\nInteresting point with wrapper, especially given that isn't just a wrapper as it provides extra functionality on top of the raw API.\nThe reason I named it as such is that just calling it history (which is what I've seen in the wild) may be confusing when the underlying API is History. What would you suggest the object be called?. Ok, will make this change.\nThe reason I had used the global-in-render method was that I use the same pattern with the history object in the later <App> and <Link> components. In order to avoid this pattern, I'd either need to use context to pass the history to the <Link> components, or we'd need to pass history explicitly via props. I'd like to hear your opinion on how to approach this.\n. Added as dot points, and removed the previous list which outlined the coming headings.. Yep, have already tested this -- except moving window.location out of the component kind of breaks it.. I'm happy to name the variable browserHistory, although I would suggest against calling the file that as there are multiple types of history, and browser history is just one. Like you said, \"Best Practices\".. The Link component here was based on a fairly old version of the one in react-router. Maybe we could add a comment mentioning this?\nThat said, the idea is to show people how Routing works. Once they understand, they'll have a better idea of whether it makes sense to use react-router for their project -- or possibly another router.\n\nBring in path parsing and you're 90% to react router v4. \n\nBut not having path parsing makes it so much easier for beginners to understand what is actually happening. We're also missing redirects, routes, switches, context, etc. As it stands, this is a long way from explaining 90% of react router v4.. @mjackson I learned a lot from your code and really grateful that you've made it available. I definitely did not intend to copy/paste without attribution.\nThe Link component does contain a lot of similar logic in the onChange handler, as it performs the same task -- but it is not a direct copy/paste. This is what I meant by \"based on\". But if you feel like it is a copyright violation, I will remove this PR and write a new onChange handler in my own library. Please let me know.. ",
    "ThisIsMissEm": "Else typo. Is there perhaps a way to expose this file to devtools, that way it can find & read it, as to not break?. ",
    "thijsw": "Little typo in the word 'else'. ",
    "JimFung": "small typo here: Objcet instead of Object. . ",
    "andresroberto": "Hi, I am curious. What's that concatenation for? Is it a security-related thing?. ",
    "mrscobbler": "Should the \"intro to JSX\" documentation be modified? In this section: https://facebook.github.io/react/docs/introducing-jsx.html#jsx-is-an-expression-too it says \"After compilation, JSX expressions become regular JavaScript objects.\"\nFor the glossary, I can change the phrasing to say something like \"JSX gets compiled to React.createElement() calls which return plain JavaScript objects called 'React elements'.\" <-- Does that feel like a better description? I was trying to keep the definitions simple and refer people to the actual documentation if they wanted to dig a little deeper.. Ok yeah -- I'm still a little fuzzy on the difference between transpilers and compilers -- some of the articles I read about it said the words were interchangeable.. ",
    "zemlanin": "@aweary \n1. I'm not sure how or with what tools I could do regression testing\n2. Well, I broke this PR ><. ",
    "lelandrichardson": "hmm. This makes sense as a rule. I'm not sure what the cleanest way to do this is but I'll give it a shot. I thought about this. I feel like there are two ways of looking at this, and I'm not sure which one is more correct:\n\nwe just export a nodeType that makes the most sense based on the data structure available and not relying on the knowledge of the RST node spec.\nwe export a nodeType that is identified by the RST node spec.\n\nThe former is easier in terms of the react implementation and makes the \"enzyme adapter\" more complicated. The latter makes the enzyme adapter simpler, but means that react has to have some knowledge of this \"RST node spec\".\nI'm open to either. Now that I'm saying it out loud, option 2 seems a bit better to me.. for some reason, .node on HostRoot was always null.. gah, sorry.  i meant .child.\nIf i change this line to return toTree(node.child);, this breaks because node.child is null but node.progressedChild is not. :/. ok good to know. Any advice on what i should dive into in order to try and track down why this is happening?. sorry.... can you explain what you want me to try here?  just run npm run build?. I've confirmed that build/packages/react-test-renderer/lib/ReactTypeOfWork.js exists. @acdlite one problem with this option is that then the resulting data structure in toTree() would have type be set to the mock, rather than the original value. when I originally wrote these tests, prettyFormat was strangely required. I forget why, but it seems like there was some strange bug in the deep equality algorithm which was causing things to fail (i don't remember at this time what they were). If we can remove it now and things work, that sounds good to me!. ",
    "seangransee": "@gaearon I reverted the change in this file.. ",
    "xtuc": "This is because of the lack of typing in JavaScript. I would prefer to tell people to use defaultProps and set it to false by default.. I would say the optimized version instead of fast . ",
    "davidhu2000": "You are absolutely right, the prop is undefined. \nWhat I was trying to say is if you don't pass in autocomplete, you can do this inside the component \nif(autocomplete) {\n  // if autocomplete is passed in as 'true' or other values\n} else {\n  // if autocomplete is not passed in or passed in as false\n}\nI already made these changes and recommitted. . make sense, I will remove it. and defaultProps belongs to the components-and-props readme. . ",
    "davidflanagan": "I just want to emphasize that the issue I filed the PR about is not uncertaintly about the precise details of when onChange is triggered, but the huge intentional difference between React's onChange and the DOM's onchange.\nI'm a reader who knows the DOM well but has never used React. This is my first time reading the docs. And when I reached this point, I was confused and assumed the docs were wrong. \nMy proposed fix is incomplete because it doesn't link to any further explanation. But really, if this was something I was writing, I'd actually add a whole new section near the top of this document summarizing the ways that React rationalizes the legacy DOM to make onChange and value work consistently for form elements. If you had a paragraph or two on that up at the top of this document on forms, that would solve the problem nicely.\nLet me know if you're interested in a PR to add those paragraphs.\nAs for the \"on every keystroke\" issue, how about \"whenever the user changes the text displayed in the text field\" or something to that effect. That excludes programmatic changes, but includes pastes done with a mouse.. ",
    "dsblv": "Sounds reasonable.\nI'm a little confused by the module resolution system. Does require(\"ReactDOM\") in UMDEntery points to the specific file or to the whole ReactDOM package (which is already exporting Fiber)?\nThe latter would mean that UMD build featured Fiber before this change. Which is false. Ok I got it.. ",
    "trueadm": "This message was wrong, I've changed it. I didn't mean to state automocking.. Agreed, completely. I was unsure if we wanted 1:1 parity with Stack in regards to these strange warning messages. I don't know why anyone would ever need the second warning message when using functional components, given they can't ever use getChildContext on the components. Was there intentions at some point to allow functional components to use getChildContext?. Flow complains if I do it any other way :). Wouldn't this have failed before if that was the case?. Yes this fails: Uncaught TypeError: Cannot read property 'purgeUnmountedComponents' of undefined. What is the strategy for dealing with these issues?. That's what I thought, I'm a bit confused as to why they should have been removed if we don't want these errors to show when mixing bundles? I can re-add the safety checks but this will need more testing.. @spicyj @bvaughn @gaearon \nI've updated the PR with some guards. Let me know if there's something I may have missed? I tested locally with React (min) and ReactDOM (non-min) and it's working, although that's not going to test all the code paths that dev code may go through \u2013 so please let me know if something doesn't look right.. Will this be stripped properly? Maybe it's best to also put it in a dev block?. dev block for this require too?. Ah my bad :). That's cool. Would be good validate as this is something we can improve with flat bundling if it's not happening here.. This stuff is WIP, it's disabled by default too :). It's not going to happen yet, I just added support to the tooling to be used when we get around to it. We need to change some things on master for this stuff to work anyway.. I attempted to do this, but it confuses Flow as I cannot export the class (it won't allow me to do so) as the format is CJS and class can't be exported like type can in this context.\nWe could hold off doing this till we convert the codebase to ES2015.. nit: can we use const or let here?. As per @gaearon's point above, if we put quotes around this, so it's moduleAlias[`'${legacyModule}'`] then the legacyModule order shouldn't matter as the replace module literally \"just\" does string replacement :). @gaearon I added a comment below, we don't need this logic here :) this should address what @spicyj said as well. For now, whenever you update something that will be merged into master (it's always good to merge master into your branch and run this after). It gives us all some indications on possible mistakes in terms of bundle size regressions. We'll improve how this works in the coming weeks too.. Sorry, what do you mean by CIs? Is this for CI integration hooks?. According to the examples, a fetchAll and mergeBranches is the equivalent to a git pull.\nI'll implement the merge base strategy.. Node 7 should be faster than Node 6. Not a big deal though.. Good point. Can be removed, was used for static-www build. Yes, it's only for absolute values. To me, the results weren't as effective by default. Headless runs everything much faster (it seems) so it was hard to get good feedback and it seems like it's still a new feature. We can revisit adding this by default in the future.. I've had no official say-so for perf testing. I'll chase someone to get some feedback on using it before enabling it by default.. The variance was all over the place in some runs and better in others. It was too unreliable and no one could tell me as why this is currently the case with headless mode.. So what implementation is right here then? This was ported from an old PR, so it would be good to know what the ideal would be here.. This is needed by inspector to show the current position in the tree relative to the root. It expects an array of fibers here.. I'm not sure if this will work. The synthetic event may be unavailable at this point and be recycled if in the pool. In fact, you don't need to use functional setState at all in the case. Not using it in this case is completely fine.. Is this something that is going to add a lot of value to do now rather than later? I get the reasoning for doing this, but I feel having a working Fiber inspector merged soon along with RN flat bundles is going to be of more value. What do you think?. I'm confused with the check on fiber.type, when changing it to either HostComponent or ClassComponent, it fails as it never matches these, it seems they are functions not numbers.. IMO we should be updating this file for when a PR is ready, as it updates master so it has the latest sizes \u2013 which is great for indicating when we've maybe let DEV code slip in unexpectedly.\nI'm not sure how we handle the issues with merge conflicts though :/. Can this be written differently? I think we can make it easier to interpret by not having the wrapping inverse of the inner condition.. could newestWork be lastWork?. We don't use the shim on www, we reference it through the secret internal object directly.. Can we move the nestedSyncUpdates++ <= NESTED_SYNC_UPDATE_LIMIT check out of the invariant call entirely? We can check this in an if statement, which should be less costly rather than doing it as a function call.. It gets DCE in the PROD bundle. Will change as part of another PR.. We support Node 0.10?. Is it possible that element.attachEvent is undefined? If it is never the case, maybe leave this as an else?. I know it's not related to this PR, but the length check should be before we access the characters at these indexes to prevent de-opts.. I don't think we should call it if rootNodeID is null, shouldn't we guard against this?. Maybe a clearer message?. Same as above. I\u2019m not sure this is the best name. Maybe isUMDBundle?. I\u2019m not sure this is super obvious as to what\u2019s happening?. How can we better type this so it's not any?. Yep, I believe contents is also a property on some DOM nodes too. value makes more sense in the case of this immutable object having a mutable object representing the ref itself.. No idea what my brain was thinking then. Sorry, pushed the code.. The build script originally did exactly this but it made the output unreadable (the different bundle errors/warnings were spat out over each other) and there win wasn't actually that of a win in performance as the work is mostly CPU intensive, not IO intensive.. Can we also deconstruct this object rather than using Packaging?. Can value be undefined?. why do we need to do typeof value === 'undefined'? why not just value === undefined?. Can we add type annotations to this function?. Can we also added type annotations here whilst we're at it?. Type annotations here too please?. textContent applies stringify and sanitization AFAIK. I'm not sure what this is used for and I see no comments anywhere from before?. I don't think you intended to keep the typeof here?. I've made the change. Did I do it correctly?. Really? They work in IE9 the last time I checked.. I changed over to Object.defineProperties. It's a shame Flow has such bad support for them though :(. I checked and the context gets written to the most in our tests.. Can you reference me to another matrix? I updated the comment. It's a DEV path.. I've put a big nice comment in there that explains things better now. I'll aadd the matrix to this PR.. n00b question: how does one generate a stack with lowPriorityWarning? I know you can with warning but then the APIs are consistent then. I'll just switch to warning to unblock this.. Moving the warning into the getters will stop the error from coming up for just using <Context /> as React's internals will always read/write from the context and never the consumer \u2013 the backwards compatibility is there for cases where libraries might try and read/write to the consumer for whatever reason. I'll address the nested Consumer.Consumer issue.. Moved the line above, my bad.. There\u2019s no reason to use that pattern anymore with hooks.. I agree, this is something I stumbled into. It can be something we do as a follow up as I know that we're planning on making some changes to the server renderer and this might flow nicely with that workload.. I was testing this on the FB bundle, sorry, I should have stated. We need to somehow make this static for FB too otherwise it seems most, if not all of our fibers on FB code end up getting deoptimized on V8 :(. I remove the change, as it's not the fix. Something else must be touching those properties. Thanks for the help, I'll keep digging.. \nIt doesn't hit the validateContextBounds code path when contextType is undefined.. I tried that and the object still depots, likely because it has quite a few properties.. @gaearon I was more asking @acdlite for some guidance on this. I also reverted the PR, as I also agree that this needs more exploration.. In my testing it was. I think V8 has optimized String.prototype.indexOf significantly.. Sorry, I meant that String.prototype.indexOf has significantly improved over what it has been in the past compared where you had to use RegExs for optimal performance.. I get what you mean, that's what I would have assumed would be always true. You'd think that indexOf would do an O(n) lookup each time, but I guess the VMs are doing some string optimisations.\n\nThere's not a lot between them, but indexOf seems to edge it slightly. I'm happy to go back to a RegEx for escapeText.. This was it! I'm sorry, I feel stupid now :(. I think we can word this message better. lead to bugs sounds a bit ambiguous \u2013 what bugs? Maybe it's best to link to a docs page or something instead.. I did that originally, but @gaearon suggested that it unnecessarily exposed the hooks APIs as properties.. I had to draw the line somewhere and they seemed less bad to expose. Forking the object 4 times would have been pretty horrible. :D. It's failing for me. Note, the way to run React Fire tests on this PR is: yarn test-fire or yarn test-fire-prod. It seems this might be failing with the normal non-Fire ReactDOM, which means I must have changed some logic somewhere by accident.. Was mistakenly pulled from an old branch.. I believe we have something similar in the current ReactDOM inside SimpleEventsPlugin.. Do you have any ideas how we can change this plugin? For now the idea was to leave the current logic mostly alone and try and refactor with the new codebase operational. It would be good if you have some ideas how to avoid doing all this extra work.. Are you saying that there is a bug in the existing code today? If so, why isn't the test failing currently? Shouldn't we try to fix this bug in current ReactDOM, so we can have a regression test for Fire?. This is true, but for phase 1 of React Fire, the idea is to keep attaching to the document so this will stay until we remove it in phase 2. :). It's nested for a reason \u2013 it's so the DEV code can get dead-code-eliminated by the React bundle build system for production environments.. It\u2019s not about the reverse condition. It\u2019s about a different coding pattern - in this case an early return guard.. We use threads on the SSR version, but I believed we didn't for the DOM version. I'll take another look at this.. I can do that, but the reason I didn't was because #14594 didn't make that change to packages/react-dom/src/server/ReactPartialRendererHooks.js.. I'm not sure how Enzyme works, but in this case, it's triggering an update to the update queue. There is no re-render, which seems more in line with how shallow renderer works (you explicitly call render).. Ah, my mistake. I've changed the PR to do a re-render.. I couldn't think of a case where that would happen, at least in the case they do this invariant would hit. If you can think of a test for it I can enable it and add the logic for that code path :). Good idea. Given the new API is still a while a way from being mainstream, it might be a hard limitation for this new API.. I'll make that change. Nice one.. We store legacy and nonLegacy in the same object, which goes into the Map.. This is intentional. We want to double listen so the new event APIs in the future can control heuristics given both. They'd likely guard one path given an API. For example onTouchMovePassive vs onTouchMoveActive.. I've updated the comment to be more clear.. I'm not sure how we can test this at runtime to know if the various options are supported without adding quite a few more bytes. Is it worth it? We could just recommend a polyfill like we do in other places for those who need backwards support. https://github.com/WICG/EventListenerOptions/blob/gh-pages/EventListenerOptions.polyfill.js. We could just fall back to not supplying options, which would allow preventDefault to work in all cases (not just nonPassive). What we could do, is set a flag to state this is the case and block preventDefault() on the SyntheticEvent object.. Won't capturing all events lead to the same issues pointed out in those threads? I'm happy to change it, if it makes sense to do so without any side-effects.. Yes that\u2019s what it means for now. I wasn't sure if we wanted to add more features at a later stage.. I\u2019ve checked all callsites and updated them accordingly. We should catch it from Flow types in the future too.. We listen to both so we can handle both cases in future plugins event APIs. This is because we listen on the root ahead of time so we need both to handle specific logic that is only possible in one or the other . None yet. . I was going to do this in a follow up PR anyway. I can put in a other PR to do this sooner. :). I\u2019ll update the www version. In this case, the event target needs to mutate the direct DOM elements of the event target. This is only known till commit phase as the children might not have been created/attached in complete phase. Well at least that's the issue I ran into when testing this, maybe I'm missing something though.. I originally did that, but it meant updating the host context object to include another property, which felt a bit over-engineered when technically event components are related to the DOM ancestor tree too.. My same comment applies. Splitting this function up might also make some parts more confusion. I'll give it another pass by though.. I can change it to a symbol. For now there is only one valid type and that is touch hit. I'll wrap the logic in a type.. Updated this and made it a symbol.. Updated and changed it to use its own logic without using updatedAncestorInfo.. Because we then don't need to expose the fiber work tag logic in the renderer for the fiber.. Your example would work, the parent needs to be an EventComponent and in the above case, it is.. Indeed! https://github.com/facebook/react/pull/15152. ",
    "tlakomy": "The word is is not missing, it's right after React:\n\nReact is, in our opinion, the premier way to build big. Don't pay attention to those, my editor is configured to trim the whitespaces at the end of the line, I can revert those changes if necessary. Oooh, now I get it, will do.. I got really confused there for a sec, thank's for clarifying that - I'll amend other files in a minute. The plan is to display a warning whenever someone is trying to update the updater property, just like in your example. \n\nI was under the impression that checking if this.updater is perhaps already defined here and if it is and we're in dev mode should cause a warning to be displayed here. I might be understanding it incorrectly, though. Thanks! \ud83d\udc4d  I'll pick this issue again shortly as it is bedtime in my timezone. ",
    "beznosd": "Definitely yes. ",
    "jlongster": "\ud83d\udc4d I do this too.. It's consistent with breaking a function call; if the args are too long it will always put arguments on their own lines. We could see if there is a way to keep it on the same line if there is only one argument, which would also always apply to if/while/etc statements.\nWe could at least implement this heuristic: if there is only one element inside parens, and it's a unary operator or a function call (maybe other things), print it on the same line. If we do it more generally we'll see things like:\njs\nif(thisCondition &&\n  thatCondition &&\n  anotherCondition) {\n  const x = 5;\n}\nWhich is really bad; it's a lot more clear to move the whole expression to the same line (same reason a lot of people put the end bracket in JSX on its own line).\nBut there's no reason we couldn't optimize for a few patterns. Is it important enough to do so?. ",
    "wacii": "See #9078.\nIt does look that way. But shared modules are now accessed under their package name, so require('react/lib/getNextDebugID') instead of require('getNextDebugID'). Why this was done with an extra module, what @sebmarkbage referred to as forwarding modules I believe, and not an alias...I have no idea.. Couldn't remember if somePlugin('destroy') was standard or not. That works out well as I wanted to mention the issue in the code without cluttering it with a full explanation.\nAs to saving the element instead of the wrapped element on the component, I'm not sure. Anyone familiar with jQuery will know the $variableName convention, and it is more performant to wrap it once. But jQuery isn't used nearly as much anymore, so is this still safe to assume? Should I go further and use jQuery(el) instead of $(el)?. Ah. Do it in two steps. Sure. That is certainly neater.. I added a section about rendering with strings/templates so the render function doesn't come out of nowhere. Not sure if that's enough.. ",
    "marvinhagemeister": "I've also seen something like this in the wild:\njs\nif (thisCondition\n&& thatCondition\n&& anotherCondition) {\n  const x = 5;\n}. Just ran the benchmarks from that link locally in node 8.1.3 and the iterator wins there by a tiny bit. I feel like microbenchmarks cannot be trusted in js. Perhaps @bmeurer can chime in?. ",
    "stevemao": "Maybe reword this to It is just a way to represent user-defined components?. We can link constructor to the mdn page. I think people who read this should have some basic knowledges.. I'd rather write more to explain it :) It's a really common pattern that's not just specific to javascript. I've always thought that components should be a class/constructor for a long time :). ",
    "sungwoncho": "That's fair. I have removed all node type values that are not being used.. @aweary I refactored it by destructuring imports and fixed the test.. ",
    "vnctaing": "Ahah went too fast, thanks. Did you passed an object to setState to set the state asynchronously on purpose or could you have passed a function ?. ",
    "dmitriid": "Please add more examples of routers, may be even outside React, such as router5.\nReact Router is a confusing name implying it's endorsed and maintained by the official react team. However, it's not (well, it' endorsed in the docs when this change is merged :) )\nHowever, it's a library that:\n- is known to introduce major breaking changes with every new release with no deprecation policy\n- promotes bad coding practices (see this issue, for example)\n- has had multiple unaddressed issues in the past that were ignored despite active community requests (search for \"named routes\")\n- etc. etc.. Basically, it all comes down to the purpose of the guide.\nIs the guide supposed to explain react-router? Well, then \"90%\" (which still require \"basic wrappers\" such as Redirect, Switch, Route etc. etc. etc.) is perfectly ok.\nHowever, the guide is supposed to be an explanation on how things can work/can be implemented in React. As such, it must be as framework-agnostic as possible. It should explain how a basic routing solution can be implemented. \nAfter that it should say:\n\nThis is how you could implement a basic routing solution. There are also many routing libraries with many additional features. They can be either fully component-based (react-router), designed for React (monorouter) or framework-agnostic (router5). @ryanflorence \n\nThis issue has three other issues referencing it. In every single one of them was closed because \"that's the way it's going to be\".\nAs for\n\ncan also be implemented in like 10 lines of code on top\n\nthat's exactly what you argued for in the comment to the props issue. Moreover, that's basically the only argument you give over and over and over and over and over again:\n\"This is not needed, devs are wrong, you can always implement it yourself with 10 lines of code\". Until, obviously, you figure out how to do it and suddenly it's ok, and makes its way into react-router code. \nHowever. Even with all that this is completely beyond the point.\nThe main point is: this is not a react-router guide. And React team should not endorse a single router solution even if it is named react-router. There are multiple other solutions. Some of them better. Some of them worse. Some using completely different approaches to react-router.. To close the whole topic revolving around hurt feelings by react-router, I propose simplifying the guide.\nAs we are building a basic routing solution first, we can remove all the nitty-gritty details of handing onClick. Start simple: do a e.preventDefault() and call some transition function unconditionally:\n\n``js\n handleClick(event) {\n    event.preventDefault();\n    // Instead of a normal URL, browserHistory.push() expects an object with\n    //pathnameandsearch` properties\n    const pathname = this.props.href.split('?')[0];\n    const search = this.props.href.slice(pathname.length);\n    const location = {pathname, search};\n// Update the browser URL and notify any listeners added\n// via browserHistory.listen()\n\nbrowserHistory.push(location);\n }\n```\n\nThis will be a very basic working router implementation. It's short, it's sweet, it works, it's perfect for a beginner.\nAfter this is done, after other pieces like rendering proper components in App are explained, briefly explain other changes you can make to the Link component:\n\nTo extend Link functionality, you may want to extend handleClick to correctly work in a variety of situations:\n- support for onClick={...} may be handled by if(this.props.onClick) ...\n- check if the user clicked left button, not right button: const isNotLeftClick = event.button !== 0;\n\nAnd conclude with the paragraph I proposed here. ",
    "mjackson": "This Link class basically re-creates everything we're already doing in react-router. You can read through our click handler and see all of the exact same pieces as you've got in your handleClick.\nWhy not just promote using the router? It's virtually the same code.. > Maybe we could add a comment mentioning this?\nThe fact that you failed to mention that you copied that code from the router leads me to believe you're strongly biased against mentioning react-router at all.. There are no \"hurt feelings\". Our code is copyrighted. You can't just copy it and put it somewhere else as if it were your own.. unpkg currently sets Access-Control-Allow-Origin: * on responses which should be sufficient for all requests w/out credentials.. I don't think so, @sebmarkbage. I created a test page that loads 16.0.0-beta.2 from unpkg w/out using <script crossorigin> and it seems to work ok (i.e. I can use \"Pause on exceptions\" w/out any problem) and React is able to catch and report the error in the console.\n\nIs that what I'm supposed to be testing?. It might be nice to say \"If you are using React from a CDN in development, ensure ...\" just to re-emphasize that this is only an issue in dev.. > Passing a mouse prop (as an object with x and y properties) is a leaky abstraction that Cat shouldn't have to worry about.\nI personally prefer the mouse prop to keep the semantics of the code. A real cat doesn't care about x's and y's. But a mouse? Now you've got his attention! ;)\nAdditionally, passing { x, y } assumes the caller knows too much about what a <Cat> does (namely, that it chases a mouse and wants to position itself at the mouse's { x, y } coordinates). If mouse.isHiding were true, the <Cat> probably would be completely oblivious to his presence and wouldn't move a muscle.. I could've used a function, but I usually don't do that unless the new state depends on some previous state value. Since the purpose of this doc is not to make any points about asynchrony and setState, I think the current implementation is fine.. Thanks, I'll gladly add the missing semi. A quick glance at the rest of the docs doesn't reveal any other usage of destructuring, so I'd rather not put it in this doc.. Good call, I'll update the code examples to use a space before closing />.. Good call. I had some text in there earlier about higher-order components, but I removed it. Will fix.. I haven't seen it in years.. I'm just trying to be more consistent with the rest of the docs. I don't see any others that use destructuring.. I honestly don't think it matters very much what the props to <Cat> are here. It's just a matter of preference. I like the semantics of <Cat mouse> and I like the fact that the caller doesn't need to know any of the details of what the <Cat> component is going to do with that information. It's a nice, clean separation in my mind.. Since this is only really an issue in large apps, perhaps I could just put a note here that says something like\n\nIf a render prop returns a large component tree, it's a good idea to use an instance method if you can instead of writing the function inline in your JSX.\n\nWhat do you think?. ",
    "ryanflorence": "Bring in path parsing and you're 90% to react router v4. This feels weird to me.. Yeah, I still stand by 90% if you brought in path-to-regexp. Redirect, Switch, Route, are all pretty basic wrappers around history and path-to-regexp, the LOC come from propTypes.\n\nMaybe we could add a comment mentioning this?\n\nYou're actually supposed to respect the license of the code when you copy it. It's MIT.\nAnyway, I'll bow out. Carry on.. @dimitriid we haven't had a breaking change in the API for almost 2 years, history's props are no long spread into the route component props in v4, and named routes prevent the ability to do dynamic routing and code splitting (can also be implemented in like 10 lines of code on top). There's nuance there, it's not being called as an element. People like to say components are \"just functions\" but how they get called matters. If it gets called as React.createElement you're gonna get a bunch of unexpected (or expected) mounting/unmounting if a function is inlined.\nIn this example its called as a function (not as createElement), so it would be semantically incorrect to pass the whole component in, that component is intended to be called with createElement.\nAlso, the entire point is to show how state comes through the render prop, hiding it doesn't make sense.. One nice thing about render props is that you can inline behavior. \nCalling a function like this this.props.render() and this <this.props.render/> are extremely different.\nIf you use createElement on an inline function you're going to get mounting/unmounting on every render, which you never want.\nThis is why Route in React Router has a render prop (called as a function) and a component prop (called with createElement). Not the same thing.\nAdditionally, the point is to compose Cat and Mouse w/o either having to know about the other, so making renderCat obliterates the decoupled composition of render props.. As for mutating the state object, the only risks are to the application. This component doesn't use state anywhere other than to pass it down in render. So, whether we give them a copy of state or the actual object doesn't change anything. They'll mutate the copy and get the same bugs.. ",
    "addyosmani": "That sgtm. I'll update to include wording closer to setting up a separate build process to avoid shipping dev mode.. ",
    "arshabh": "Well, we cant really test SVG elements using HTMLUnknownElement. Thus i will use ownerDocument as you suggested (Edit: Please ignore this.). This was added to handle specific scenario of menuitem tag. The <menuitem></menuitem>  is supported only on firefox. In all other browsers the instanceof window.HTMLUnknownElement would throw a false positive. menuitem is included in voidElementsTags array. \nMy idea was that since all items in voidElementTags are known elements it would be safe to check if the to be rendered element is in that array or not - because that array is guaranteed to contain only valid elements.\nMaybe i can add a descriptive comment about that or do you have any other solution in mind on how to handle menuitem ?. Done. Using el instead of creating the element again.. ok - totally agree - which means while using menuitem in chrome we should get the error message as expected. Fine but for that i will have to make some changes in the unit tests concerning menuitem to make them pass with this implementation.. @aweary This is done. Can you please take a look into it ?. ",
    "shergin": "Thank you for feedback, Ben!\nI changed the test to match the original conditions. . I believe currently the only most outer <Text> supports display: none, but I think that's incorrect behavior (and I will fix it).. ",
    "lamo2k123": "Such a comment was in the files where hasOwnProperty was already used before my fixes. You can delete this comment.. hmm.. here rules trim_trailing_whitespace https://github.com/facebook/react/blob/master/.editorconfig#L11. fixed. fixed\n. Let's accept some solution. @aweary @gaearon . In the generated version there are spaces. And my IDE deleted them because of the rule trim_trailing_whitespace in.editorconfig.\nhttps://github.com/facebook/react/pull/7853/files/886b36ce0806850c510f1f188f908157b960cc27#diff-57684bed596d80d110b216140caa66ebL18015. fixed. @gaearon ?. ",
    "rogeliog": "Awesome! \ud83d\udc4f. I guess we still need an empty func that would not get stripped out right? So that it can be statically analyzed?\n```\nlet addUpdaterMutationWarn = () => {};\nif (DEV) {\n  addUpdaterMutationWarn = context => {\n  // ...\n  // ...\n``. So that means that we need a// eslint-disable-next-line no-undefevery timeaddUpdaterMutationWarnis used right?. But even if I declare it inside theifstatement I would get aReferenceErrorwhen trying to use it\n. Right \ud83d\udc4d ! I was usingconstinstead ofvar` which doesn't get hoisted to the top . ",
    "misoguy": "Just to be clear, does this mean if the app has two different pure components, the warning should only show up once? Or does it mean to only warn once for the same pure component used numerous times in different places?\nI'm guessing it's the latter but asking just to be sure :). Thank you for the review! Well noted \ud83d\ude04 . ",
    "spences10": "I'm struggling on this bit, it is confusing, people need to be walked through this again, it breaks the flow of the tutorial as in you have to go back to where it was mentioned previously.\nI mean I've had to log an issue and then go digging through other issues and PR's to see if there's a solution to it, apologies I should have done that the other way round, but I was pretty frustrated at that point with how I couldn't make out what the documentation was instructing me to do.. ",
    "vkrol": "shouldComponentUpdate instead of componentWillUpdate?. ",
    "CodinCat": "key?. ",
    "kevinjamesus86": "this.props.model.on('change', this.rerender);. this.props.model.off('change', this.rerender);. this.props.collection.on('add', 'remove', this.rerender);. this.props.collection.off('add', 'remove', this.rerender);. ",
    "ericelliott": "Good point. =). This is intended to show the signature, not an example, but you make a good point that an example would be helpful.. I didn't write this part. It's already in the docs. Maybe cleanup of that wording could happen in a separate PR.. I agree. I wasn't sure what to do with it, so I left it alone for now. =). I know this from mentoring students & product teams who are making the switch to React. I saw two examples yesterday. See setState Gate. Further evidence is available by searching for setState on Stack Overflow (there are MANY more examples of confused setState users on Stack Overflow).. Suggestions for rewording?. > potentially return the previous state\nThat bit is just a slight rephrase of the current doc, which says \"potentially return the existing value\". . Love it.. ",
    "filiphosko": "@aweary You are right, that's why I removed the line that says Creating a Single Page Application and instead added the line Currently there are two popular ways to get started with React:. Of course numbering isn't always the best solution, it was just my suggestion for a quick 'fix' ;). ",
    "bondarewicz": "The `onClick` in `renderSquare doesn't have any special meaning here,\nis missing ending tick after renderSquare\nThe `onClick` in `renderSquare` doesn't have any special meaning here,. ",
    "aionda": "@bondarewicz Thanks, fixed!. ",
    "abhaynikam": "Was unaware of it and it happened because of my sublime text editors configuration. It removes trailing white space. Will take care of it in future. . @gaearon : Can I send a PR for adding flow typing here again?. @gaearon : Oh okay. So flow type here should be any. Right?. ",
    "hanumanthan": "It may be slightly confusing when we say onClick prop as both the Square and button has that prop. Rather rephrasing this way\nThe onClick prop of the button is part of React's synthetic event system, which will call the function passed in when a click event is dispatched on the button.. ",
    "abhisheksoni27": "I'd prefer changing \"..the Facebook codebase..\" to \"..Facebook's Codebase..\"\nWhat do you reckon? . ",
    "hswolff": "Just wanted to share some work I've done on this front. I recently created a HoC for syncing Backbone Models/Collections with React that might be of value to link to in this doc? I called it connect-backbone-to-react and its API is super inspired by react-redux's. Hopefully this is of value to other developers! . ",
    "radi-cho": "OK, I will close this pull request, but I will open another, better request. Thanks for activity, @gaearon I'm big your fan (I'm 11 years old and now I learning to develop with react).... https://github.com/facebook/react/pull/9459. ",
    "ajcumine": "I've added a little more details here but I would hope that if someone does want more information that they will click through to the in-depth explanation...  contained in /react/docs/reconciliation.html#recursing-on-children that I have also updated.. I've rewritten the example to make it much clearer, hopefully I haven't made it too confusing with all the buttons there.\nAlso added the fixed example showing the same functionality but using an ID as a key rather than an index.. ",
    "simonkberg": "This will throw in environments without Symbol. ",
    "linmic": "I believe initEvent is deprecated, would you consider using Event() and dispatchEvent instead?. ",
    "Hypnosphi": "shouldn't this be node.value !== '' + value to prevent unnecessary updates when you provide the same non-string value as before?\n```js\nrender(, el);\nrender(, el); // shouldn't reset value\n```. ",
    "threepointone": "+1. super minor issue 0 this looks odd with ligature fonts (but I can't think of a solution, you can't add a space there iiuc)\n\n. well maybe (your-token-here) or [your-token-here]. this takes a looong time. thank you for the spinners (really, at least I'm certain it hasn't 'hung'), but is there a reason the output is hidden? it's been about 5 mins for me now.  . this assumes /build/node_modules exists, ie - you've done a build previously on this machine. I just failed that (working on a fresh checkout). mkdir -p?. (there's another instance of this, cmd-f cp -r). this doesn't work. the html assumes the files are in build/dist, but the script generates node_modules. . consequently, this fails because dist hasn't been generated . I don't feel strongly about this either. I wish I could add priorities to my comments. this is definitely lowest pri. . suggestion\n          'Publishes the current contents of \"build/node_modules\" to NPM.',. -s isn't a pushstate-server option though? also, you need a port, so this should probably be pushstate-server . 9000. have you considered using npx for one off things like this? you could merge steps 4 and 5 with \nnpx pushstate-server . 9000. ah I see, fair. it throws an error with -s tho. . \ud83d\ude4f . ugly. thinking about it, open to ideas. . could make it clear that this isn't for prod (...unless, maybe it could be?). I figured I should use something more efficient, thanks for the pointer! . \"...using differently ordered hooks...\". I decided to read off currentHook directly!. @aweary I just pushed a version with your suggested change. one concern I have is I don't 'cleanup' currentHookType after setting it, so it might cause bugs if someone makes a new hook type but doesn't set it. . I might just remove this . Maybe I shouldn't add anything else, except for the link to the site?. damn, thanks for that. love it. . oh interesting, you're right they pass. I recollect how I broke this - I had a bad test, and 'fixed' it after I had my code in place. bleurgh, thanks for the catch. . agreed, that was my first cut as well. . revert. it's one less var to be gced, reuses the location across runs. you mentioned the local var has a cost I assumed you'd want to avoid?. maybe I should just trust javascript engines . I'll do that! I also want to show the expected vs actual hook order maybe. created by. this can read as \"new StyleRoot\" (and confused me for a moment), I assume you mean \"new-style root\". maybe reactIsCreateRootDEV?. created by. didn't want to encourage reading from it, but I guess that's actually fine. revert. revert. revert. \ud83d\ude14yeah. sorry about that. . should this have been areHookDepsEqual?. tried this, and it's pretty noisy. should probably group errors by component and/or show the diff. . this should be a short url. done. I could probably do better than this. this should log just once. check it out, I log the hook chains in currentHookMatches rn . neat trick!. I'll do this. . this bit is odd, but I'll dive into it later, unless you folks have an idea. . ^ calling out this dev vs prod difference. I think it should be ok?. I'll add a screenshot of what this looks like. . flushMismatchWarning?. til, good check. . ugh I missed this, will get to in a bit . missed this . I thought about this, and maybe I don't think this is critical? we're not planning on changing this list anytime soon,  and it'll add complexity. . Right now, we don't add a ContextType Hook to the hooks list on a fiber, we just do a straight  context read. this means you can't trace it's previous/current positions when rendering. this above bit adds it the list (via createWorkInProgressHook) so it can track it when it gets called again. . didn't want to add extra function calls and the comparisons when it was readily indexed and available here.  . you ok with the string comparisons happening on every run?. the set hookMismatchFibers is for deduping error messages on fibers, so we show a max of one warning per fiber, persisted across app lifetime. it never flushes itself out. I'll add a comment \ncurrentHookMismatch holds the last mismatch recorded, and gets flushed. . you mean the contents of the fn, right? function padEndSpaces(){ if (__DEV__){...}}. done and done. I'll change this to be more formal :P. I'll move it into the Events array. we were including the trace so peeps could tell which (possibly custom hook) was the offending one. fine to remove?. right, of course the warning would have its own trace. thanks!. agreed, I felt icky doing this. will change, . nice nice nice. is there a reason a generic batchedUpdates was exposed from TestRenderer?. I\u2019d originally put the canUseDOM check inside ReactFiberHooks, I\u2019ll move it back there. qq - how would I test if it's happening \"inside\" a react-dom renderer?. Changed it so that it only detects jest now. . \ud83d\ude43good catch, thanks . This is a bit confusing, will fix. suggestion\n          'Did you mean to call unstable_createRoot(container, {hydrate: true}).render(element)?',. or even ReactDOM.unstable_createRoot(?. these are the ones moved in from TestUtils-test. these are newly added . this might seem weird, but it matches user behaviour exactly - a flash of '0', followed by '1'. . we try to 'trick' act by awaiting its result, but not actually waiting for it. . but nuh uh, we warn anyway (todo - match on actual warning message). fair, removed. . \nworking on it!. moved these tests into a separate file for .act tests . we didn't need this act statement here . lol this isn't needed anymore, but I'll keep the check. . I don\u2019t think we want to support interleaving, do you have an example of when you\u2019d want to interleaved test interactions?. Thanks, I\u2019ll fix this and add a test . not sure if relevant, but we add the workinprogresshook to the list only when DEV. so hook.next behaves differently in prod vs dev https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberHooks.js#L527-L529. suggestion. this bit is the odd behaviour. this would simplify tests too (which I assume was the reason you did this). til, thanks!. act doesn't advance timers at all, so this title is a bit wrong. . the problem with the microtask is that it resolves before any further created promises resolve, triggering the warning every time. . just to clarify how we resolved this - I'll verify that jest won't swallow warnings when this is fired 'out of band' in sync tests. . OSS can\u2019t/don\u2019t use fakeTimers reliably, so I want to run tests in an environment as close to theirs as possible. (Specifically for the async/await test, which started the need for this pr). Good point, I\u2019ll make it so. there's a difference in behaviour between the TestRenderer and DOM, and I thought it shouldn't. A similar test in ReactDOM works as I'd expected, but I guess it just works that way though. I can make a separate PR showing the difference. deleted this wall of text here. . I fixed this, but I found a bunch of other usages of this pattern in the tests haha https://github.com/facebook/react/search?q=%22called+%3D+true%22&type=Code. I'm not sure that's true with fakeTimers, but I'll verify. . I can reduce the timer length, but this is specifically to test when we can't use fake timers reliably. . Is that what we discussed? are we making a breaking change here? (actually asking, I thought we decided not to). Everything 'works', except we don't warn when you don't use act around an update. We considered other options (NODE_ENV=test etc), but this seemed most reasonable for now. . so I tried, and - \n- in our setup (and likely oss too), this will trigger the warning. the fix for this is simple - use the async version to catch microtasks like so \njsx\nawait act(async () => {\n  jest.runAllTimers()\n})\n- I'd assumed we had a setup similar to fb's, where the changed code will not trigger the warning (I just tested)\nI'm updating the test to show this. . I don't think we need to await all acts. In sync mode, it works fine with sync-y code. if tests queue promises, they can use the async version (and await on that). now, tests written for sync mode could fail in concurrent mode, at which point we have one of two options - rejig the test setup to match fb's so we can resolve promises immediately, or use the async version of act. both are reasonable choices depending on your constraints.. Getting a particularly odd error when I put in the existence check (see the CI error.) posted about it internally, let's see. . why did you decide to do a single character here?. No I trust your judgement, I was just curious. It makes sense. Thanks!\n(ashamed to say I usually use x =>..., which people around me hate). working on an xplat version of this asap (probably postMessage). I considered doing this with callbacks, but this reads a bit better. . (done). I tried, but it still needs the microtask before running flushPassiveEffects again, making this hairier. I'm moving this out of ReactFiberScheduler (into TestUtils/TestRenderer/createReactNoop), so it's... fine, maybe?. still do, since the thenable that triggers the warning may be called after one microtask. consider also that this codepath is only called with the async version of act, which means they probably have Promise defined on the page . how does enqueueTask sound? . so this is in older browsers (ie9 and below and some others). the annoying scenario is when someone's using fakeTimers + async act, and running their tests across browser. we can't use setTimeout in this case because it would require manually advancing after each act call. So the challenge is to delay by one macrotask, but without using any of the usual suspects - setTimeout, setImmediate, etc. \nHere's a super dirty version of a workaround\njsx\nfunction nextTick(callback){\n  let promise = Promise.resolve()\n  let ctr = 0\n  while(ctr < 100){\n    ctr++\n    promise = promise.then(() => {})\n  }\n  return promise.then(() => {\n    callback()\n  })\n};\nThis isn't satisfying; it's slow, and there are obvious edge cases. \nAnother option is to create a dummy element (like an img/iframe/link) and try to load an inlined resource. something like this -\njsx\nfunction nextTick(callback){\n  const img = new Image()\n  img.onload = callback\n  img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='\n}\nthis one's less ickier. I tested it, and it \"works\". Thoughts?. > Is this the reason you have to do weird things like call useRealTimers and call runAllTimers at random places?\n(notes for posterity's sake)\nI need to useRealTimers() because we use fake timers by default, but OSS folks don't, so I need to explicitly disable them for our tests. \nThere are 4 'scenarios' -\n- fake timers, with transpiled environments (al\u00e1 fb): in this setup, the async version of act is barely (never?) used, and peeps use runAllTimers() to 'advance' time. of note, the above codepath is never used. this is typical code when so - \njsx\nact(() => {\n  jest.runAllTimers();\n  // advance time and capture \n  // updates and effects\n}); \n- real timers, common js presets: closer to what OSS has. in this scenario, both the sync and async versions work as expected, no real surprises. you would see code like this -\njsx\nawait act(async () => {\n  doSomething()\n  await waitForElement(() => getByTestId('greeting-text'))\n})\n- real timers, transpiled environments: similar to the previous one, both sync/async versions will work as expected. \n- fake timers, common js presets: this is the default setup we have in the react repo, and where tests with cascading promises would fail (it'll pass the first tick with await act(async () =>   jest.runAllTimers();, but thats not sufficient). your proposed hack fixes this! for browsers without MessageChannel, how do you feel about this hack? https://github.com/facebook/react/pull/14853/#discussion_r265993434. so... should I not have the fallback, or just throw an error? our 'support' usually involves just adding polyfills, and this is a scenario where that might be enough (it'll be odd to ask folks to install a MessageChannel polyfill to pass their tests, but sure.). I'll rewrite this entire test, it's now a lot better with the way we 'wait' for stuff, and the user won't have to do any manual Promise.resolve() statements.. deal. I'm moving all this logic into TestUtils, so it won't add to ReactDOM . rewrote this test completely . > we need tests that correspond to each of the platforms where you might run tests.\ndo you still feel strongly about this? now that - \n- we use the non-mocked setImmediate from node\n- we aren't trying to use anything beyond MessageChannel (and warn if you try in a browser that doesn't have it). Missed erplying to this. It's all the tests, except the ones that use fake timers. I want to be explicit about using fake timers in this suite. . this is now better since we wait for a whole task. . a side effect of making awaiting act mandatory, is people wouldn't be able to make synchronous assertions about their UI (when nesting inside an async act, for example). I think we want to keep this behaviour. marking this bit as resolved, unless y'all think differently. . alright, the current version seems to appease both lint and flow. marking this resolved. . I spoke to a couple of folks around here, and they mentioned they're looking at using https://nodejs.org/api/async_hooks.html. That's fair, I could do that. . the problem with an existence check, is that flow infers that Promise might not exist as a global, and it throws weird errors. sent you a link privately to internal post on the same.  . ack fair, missed it. . I think we're on the same page? The examples you just gave should still work. I simply meant that in an fb-like-environment, there isn't much use (yet!) for the async version of act, since - \njsx\nact(() => {\n  runAllTimers();\n});\nwill effectively do the same thing as -\njsx \nawait act(async () => {\n  runAllTimers();\n});\n(which is to resolve queued promises and timers.) . It poisons any function with a Promise in its type annotation. I'll keep trying to fix this, but fair warning I already tried a bit and kept hitting walls. \nI would heartily +1 updating the eslint config. It seems reasonable at this point. . Alright, I must have been doing something wrong earlier. I \"fixed\" this. . I must have been doing something wrong. I managed to get this to work. . Have a look now? Do you think I should still export doesHavePassiveEffects instead of passing it as a callback? . It\u2019s not passed in prod (it comes from actedUpdates, which needs it only to decrement the depth and possibly issue a warning, neither of which we do in prod). Hmm? I moved the batchedUpdates call from FiberScheduler to here. Ah good catch. Will fix both. I think I had a test where I\u2019d manually called .then. I\u2019ll remove the checks. . Only for bytes, since dan and seb had mentioned they\u2019d like to ship as little as possible in Reactdom. That\u2019s why I\u2019m using the hack to flush effects too; in a previous commit, most of this was in the FiberScheduler. I could move that back in and put it behind a feature flag ofc. . unsure how to proceed here. I could either move stuff into FiberScheduler, and add some weight to ReactDOM, or keep it outside, and copy paste across the 3 targets as I do now. and maybe I should put the feature flag in a follow up PR? I can bring this up on monday in chat. . btw, the decision was to let it insta fail when setImmediate/MessageChannel aren't available (so, 'old' IE). I have a backup plan in case that's needed, but letting it be. I'll set up tests for the rest. . https://github.com/facebook/react/pull/14853/files#diff-08838400dbefc5107cea81326e3d9847R176 . ",
    "himynameisdave": "Yep no problem, I'll fix that up then resolve & merge with master \ud83d\udc4d . ",
    "hikaru-light": "I thought so, too.. Yes, I was just wondering.. ",
    "jordanpapaleo": "Ill give it a try :). Also this is all for a issue requesting the docs be updated\nI just did this and the synthetic event is logged, as expected.  Is there a specific property that I can be checking on this event to determine whether its been recycled?\n```\nimport React, {Component} from 'react'\nexport default class App extends Component {\n  test = (se) => {\n    console.log('test', se)\n    this.setState(() => {\n      console.log('setState', se)\n      return {}\n    })\n  }\nrender () {\n    return (\n      \nTest\n\n    )\n  }\n}\n```\nThanks!. ",
    "jwbay": "This is no longer ES5 code \ud83d\ude2f . ",
    "petetnt": "Small typo: migrate. Typo: migrate. That GIF is awesome \ud83d\ude39 \ud83d\ude39 . ",
    "justinkambic": "it looks like its working but it's not. The input remains\nChange to \"it looks like it's working but it's not.\". Expect updated text from above, it's. Like above, \"looks like it's working\". Update to \"looks like it's working\". ",
    "thysultan": "If it's a hot path, could checking for a non-getter property help here?\njs\nparentInstance.insertData !== undefined. ",
    "jeromecovington": "To the best of my knowledge, comparing object instances, even if structurally \"identical\" will always evaluate false.\n({} === {}) // false. ",
    "Aprillion": "What about users who click on the link in the actual warning? I thought it might be good to provide something relevant to that warning. For me, I knew exactly how to fix, but before I got the connection from the warning to the != null condition, I had literally no idea what the *** happened why I got the stupid warning...\n@aweary is your experience with this warning different? I am not trying to solve any other use cases right now, just a life line for anyone who clicks the link from the warning.... ok, I got my help with this particular warning on stack overflow and no one else is supporting my position, so I will update my PR to use your suggestion. ",
    "kastentx": "Thanks for the reply! I've implemented these changes in a new commit.. ",
    "pingan1927": "I have fixed it. Any Problem?. ",
    "AlmeroSteyn": "Fixed in next push.. Fixed in next push.. Yeah. Meant that, as in jump past sections I am not interested in. Fixed in next push :-). This is currently a subsection of that section, together with Semantic HTML and screen readers. There I meant to convey that you can skip to these elements using the screen readers (like the rotor in VoiceOver). I have now combined both into the upper section. What do you think? Changed in the next push.. Fixed in next push.. Thanks!. Done, I have rolled all aXe related things into one section. All under the heading of Testing accessibility in the browser. As axe-core uses a browser DOM this is technically correct. Changed in next push.. As above.. Done. Fixed in next push. Agreed. I was struggling with this myself when I wrote it. Trying to avoid 'othering' while coming up with something that would speak to the developer who so not know about a11y yet. This one won then but your signal is clear enough that the vote should have gone the other way. Thank you! Fixed in the next push.. Originally I had a different example but I ended up using this one as this exact example exists on the refs page in the docs. Perhaps it should be looked at, at some stage then.\nI want to try and propose a compromise. And know when I started up with React this was something that took a while to sink in. So I have cut down the code to just show how you focus, instead of showing where you put the code. I still think that maybe it could help to get devs started quicker with focus management.\nWhat do you think of the new code examples? If you still feel edgy about it I will remove it :-)\nChanged in next push.. Hmmm good one. Left the sentence but cut the visible bit so as not to indicate something is dogma when it isn't.  Also saw I invented a new word form contol which I then fixed.. Removed the example.. Removed the example.. Fixed. Fixed. Fixed. Noted. Also stepped through all ## headers and capitalized where required.. Fixed.. Nice!! Fixed.. Changed it to include the following:\n\n. Fixed the ones I could find not being American hehe. ",
    "TrySound": "Yep. It can be generic\njs\nexport type RefObject<T> = {\n  contents: T | null\n};. With input will be ref.value.value :). Is it ok to format package.json?. $ReadOnly<{}> can be used instead of +. Shouldn't this be?\njs\nimport { createSubscription } from \"create-subscription\";. \"Render prop\" in warning may confuse users. Maybe \"render function\"?. Nope. That was a surprise to me too.\nhttps://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/export. Reexport with default will be in mjs entry point with NODE_ENV conditions. This is only bundle entry point. This hack is only for cjs.. Afaik rollup is able to treeshake object literals. Not sure webpack able to handle any of cases.. I think running babel inside transformBundle without extra read/write would be a better idea.. There is not such option in this plugin.\nI already made an update here\nhttps://github.com/facebook/react/pull/13321. This is also part of the language now. Try to remove. And here too. This is more sound I think. In current case flow will always refine any value and function params and return value won't be checked. I had the same problem in powerplug.\njs\ntype BasicStateAction<S> = (S => S) | S;. Here the same problem. (() => S) is unreachable.. ",
    "yoshuawuyts": "It's recommended to use readable-stream instead. This might cause wildly different behavior depending on the node version you use. Hey yeah glad you like it - readable stream contains fixes that aren't necessarily backported to older Node versions (a new version was published today which contains fixes for the ._destroy stuff iirc). Generally it's just a good practice to pin to a specific stream version rather than relying on whatever version is in core. Hope that makes sense (:. ",
    "razh": "Reverse the order of these links?. ",
    "dummycode": "Object shorthand? Can revert if wanting to keep things simple.. Why even bother with the ternary operator?. Will need to update linked codepen after this change. . Cool, changes made. Sorry this ended up being such a nit picky PR. Thanks for the feedback!. ",
    "stereobooster": "I suppose we need to add cancel to componentWillUnmount. \n```js \ncomponentDidMount() {\n   let CancelToken = axios.CancelToken;\n   let cancel\n   let cancelToken = CancelToken(c => cancel = c)\nthis.setState({ cancel: cancel })\naxios.get('https://api.github.com/users/facebook/repos', { cancelToken })\n     .then(response => this.setState({ repos: response.data }))\n     .catch(error => console.log(error));\n }\ncomponentWillUnmount() {\n  this.state.cancel()\n}\n```\nUPD there is example with cancelation lower\n. what about loading state e.g. spinner?. state error - show error message. Not that much code, but will encourage programmers to implement error messages and think of all states of component with async load. done. Suspicious indeed https://flow.org/try/#0DYUwLgBAHgXA3gQxgZzAJwJYDsDmBfAbgCgBjAey1QgBEBRANRgCMyzQEsBedAVxGIwAzCAAo69AJQQ4RCNAidpSAEQBGAEwBmZYSJ4iQ0eKky55SmxAA6YGRwioVhBOJ4gA. ",
    "michael-donat": "I'm not sure I follow here. What is the difference between property and an attribute?\nsrcObject is no different to src really, the only difference is that one accepts a stream while the other a url.. Ahh, makes sense, thanks for explaining this!. ",
    "bmeurer": "Unfortunately both are pretty slow in V8 at the moment. The fact that Set.prototype.forEach is faster in some cases isn't intended, and I wouldn't rely on that. We plan to improve the performance of the collection iterators in the future BTW.\nMy suggestion here: Don't base decisions on current perf results. Use whatever makes sense for your code and try to improve readability instead.. ",
    "gwmccull": "done. so I tried this but npm test causes the length of arguments to be 1, [ undefined ].  But node ./scripts/fiber/record-tests has the length of the arguments as 0, [ ]\nSo it seems like checking the first argument is the only way to go that I see. ",
    "sumnerevans": "The original seems grammatically correct to me. In fact, I think that this change introduces some ambiguity. Which existing code do we not have to rewrite? By adding \"the\", \"existing code\" could refer to either the React codebase or your application codebase.\nIf the sentence needs clarification, something like the following could work, but I'm not convinced that it adds anything to the sentence since I think it's implied by \"so you\".\n\nWe don't make assumptions about the rest of your technology stack, so you can develop new features in React without rewriting your existing code.. \n",
    "rscharfer": "Sorry.  For a second there I was imagining \"React v15.5\" was a date.  So, for example, \"React.PropTypes\" was moved into a different package on Dec, 13 2016\" would have been correct.  \nLooking at it again, I think we could incorporate your as of and say React.PropTypes is in a different package as of React v15.5  or as of React v15.5, React.PropTypes is in a different package or even since React v15.5, React.PropTypes is in a different package.    But 'has moved' and 'since' don't work together unless it has been moving to the new package this entire time.. ",
    "stepancar": "yes, its needed. Try to run it. ",
    "evilbs": "ok, good idea.. \"setCurrentDebugStack\" method will set debugElementStack.length = 1, This is to init the debugElementStack array. The same method handles when HostCompoment return array type children.https://github.com/facebook/react/blob/master/src/renderers/shared/server/ReactPartialRenderer.js#L769\n. @gaearo, It's done. Please review.. hmm. Has been resolved, It can test passed both server and client. There is no warning.. > I'm not sure this is sufficient. For example it could be a nested array. Conversely, it could be an array of invalid things (e.g. array of objects), and we'd want to throw in that case.\nI think here can use 'React.Children.toArray' method to deal with this situation. \n1. nested array: Will flatten the array.\n[[<Hello />,<Dan />],<Cool />] => [<Hello />,<Dan />,<Cool />]\n2. array of objects: Will throw when passed object does not have an iterator.\n\nI think the validation should be moved to a further stage at the point where we actually process the next frame. Which is the same strategy we do with Fiber. This way we don\u2019t do validation immediately, but we throw if we meet something invalid.\n\nif disableNewFiberFeatures=false then don't do validation immediately.  \n. :smiley: I understand what you mean. I fell that children do not need validation. Because when resolve method meet array type children , It will return to render method, The render method will check if child is a array type, If it is then push to stack.  So resolve method only validates single element child and do not validates array type children.. We can use 'React.children.toArray', It will accept valid element or valid array, otherwise it will throw an error.\n1.  When children is single element: It will be validated by React.isValidElement.\n2.  When children is array type: It will be validated whether the array is valid, It can either array(native array) or object that have iterator function. and per element of array will be validated by React.isValidElement. \nSo we can validated the following cases by React.children.toArray:\n1.  First call to render, ReactDOMServer.renderToString(reactElement) \n2.  Element be returned by render method.\n. yes, we can do it like this.\n/**\n * react.development.js \n * React v16.0.0-beta.5\n *\n * Copyright 2013-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n *\n */. cc @gaearon . I have added license header to NODE_PROD env in my laptop, But seems to be filtered by this.. ",
    "thymikee": "@nhunzaker There was alpha, beta, and chi ;). jest.spyOn. Yup, it's a known issue you already filed https://github.com/facebook/jest/issues/4117 \ud83d\ude09 . @bvaughn Are you planning on using Flow inside tests at some point? If so, you could get rid of these checks.. Let's change to 23.0.1. ",
    "erikdesjardins": "This is always true because it will find its own search string, i.e.\njs\n(function foo() { return foo.toString().indexOf('any arbitrary string') !== -1; })();\nso this error will be thrown in correctly minified code.\nExtracting it to a variable might work:\njs\nvar searchString = 'any arbitrary string';\n(function foo() { return foo.toString().indexOf(searchString) !== -1; })();\nbut Babili [will inline it][inlining], recreating the original problem.\n'UNREACHABLE'.toLowerCase() appears to work for now, but probably not in the future, as Babili currently evaluates some other String.prototype methods.\n[inlining]: https://babeljs.io/repl/#?babili=true&evaluate=true&lineWrap=true&presets=&targets=&browsers=&builtIns=false&debug=false&experimental=true&loose=false&spec=false&code_lz=BQMwrgdgxgLglgewsAlAAgN4FgBQuBuAhgE5oDOApiVABYDKMxcEA5mgLxoDkkxVthAEYAbClwDcuXOGjwkaGBTIwAsszgg4UQnOTpsONGg1pgi5WogatOxBAB0EQgFsKHdpy7nV6zdt1c-rhGRgD0oWgA6m4kbhAIMGjOvnAUACb2wSHhaAAqNHBkSXAsNImCMWgAcghpbhQQ-HDESK4QiQDuNBR8aAAiAMIAosZF8YkUAB4ADhSw6WiEEACeHYTLmYYhfDBgxBCSWwC-WSbAXNMtaWCwdlzunnX4FMII020wgZhZYRHRaFNZrAFAUiq4YDRamgkMJlgoEGgKmhtMJRGljBA0JdajddJsQiCWh00BAKMShsQWsRzvlCqM0Lx-DQhKJAocjCctow4QYCVAkMpyAg9lA3JxvJZrP47PYYAgGExWKh2SEzmRhcRRfZmHVJgB5EDnOUK5gsL4eTgAWgAjEEtgScv8ANbxYkgBCkQhoECEYEQmKCBDPNDCZj1SaFGBkfEEtA5fI9Cju3r-xFEyikFiEYNgIrMIih9HqkUUGMEnZ7A4_NCcglqjVanVTA3ASjUeiMU3oACEHjQNrtsbjET6VHR_LqANDyScujQHWFwnRzODyiY01m6IhOjTS1o1d-iLmhFzbjgiTpcGc0wQZDIcBEbjlaD4vpoGKxV1xMoP5AoMFyK8KGFGBQEgW4kFQb57VjHIhggMg9jPRIWH_Io-BvYhFC3BFsWuCDMVeFgWFNX8jAhIkSTJNAKSpc4ACV-AvdDICsVgPzw795GcWoKAAGkRMBEjqQhx147gyKHKSCQAam4F4r2YWx5GZMYEiPBpFg3UN0nsNBGNEtBIWJZ9-UpOYYFhCSYOk2yQjkrh-QgTQWCQ_SmO9D1PxxAiAC5rLswL7O4MoYGmMhfPCEBBD2YR7H5ZxQlfWBLVmYgQEtU9LX9VKvwIy0YrgJc2V_I4UBVDksiOZEdFoUwKH0TlOVwCUUmlSDyqkHAyuVXAgA. Similar thing here, this works, but is kinda misleading.\nconst source = testMinification.toString(); could be replaced with const source = String(testMinification); and this check would still work.. ",
    "jfo84": "Sounds good!. ",
    "Kritika2808": "Just curious, why {items: [], text: ''} is first assigned to this.originalValues and then this.state\nWhy this change was made ?. ",
    "aesopwolf": "this.originaValues is used in the handleReset method. I can use a different approach, or add an comment describing the behavior.. ",
    "leonardoanalista": "variable assignment inside an if condition can be overlooked.. allowTransparency is expected to appear as lowercase on html according to: https://msdn.microsoft.com/en-us/library/ms533072(v=vs.85).aspx. \nDoes the same happen to httpEquiv (which is expected to be http-equiv on html) ? . there is a potential utils functions here const isNumber = (value) => typeof value === 'number'; to be re-used. I am sure this is not the first, neither the last time you need to check for a number.. ",
    "robdodson": "why do you want to set [object Object] instead of setting a property on the element? A custom element receiving [object Object] can't really do anything with it.. Could you set functions as properties?. ",
    "mitermayer": "Hi Flarnie, \nThis one I could be wrong about it, I assumed it could be nullable due to the bellow line\njs\nvar nativeEvent = nativeEventParam || EMPTY_NATIVE_EVENT;. ",
    "Gregoirevda": "node.firstChild can never be undefined?. ",
    "clemmy": "prettyFormat isn't necessary. I was simply following the convention with the other toTree tests that use prettyFormat.. I ran the tests again, removing all usages of prettyFormat and everything is \ud83d\udc4c . Strict or loose checks (== or ===)? Also, is this also true for an explicit inequality check (!==)?. Should have said so sooner! :'(. Gotcha, good to know! :). Trailing The. In what scenarios can both workInProgress.effectTag & PerformedWork and workInProgress.effectTag & PreparedWork be true?. By JS object dependent stuff, do you mean callbacks since they're kinda unique to JS?. Is this valid syntax? I've never seen it before.. Why do we use an existential type here instead of something explicit?. This was an existing TODO comment in the code :D. If it's no longer relevant, should I remove it?. Will do :) The reason I didn't add TestUtils.renderIntoDocument here was because it's only necessary to fire key warnings, which this test wasn't testing.. \ud83d\ude06 was matching the other typos in this file. I'll fix the typo for all the tests.. Wasn't aware of that, it looks like the number 44444 if you convert it to decimal. \ud83d\ude06 . Is ReactElementValidator not used when __DEV__ is off?. Would it be preferable to have a branch on current.tag === Fragment && element.type === REACT_FRAGMENT_TYPE at places where it would usually be a current.type === element.type? That the initial way I implemented this but @acdlite suggested I can add this field to not have to special case.. @sebmarkbage I'm having a tough time with this part. From my understanding, there's only a branch that optimizes for reconciling a single child in reconcileSingleElement. However, if we want to preserve the semantics of not having a fragment fiber in a top level array, then we need to reconcile using reconcileChildrenArray, which only takes in an array of children.. Actually, I can probably recurse on reconcileChildFibers. Does that make sense? I'll test that right now.. When can both isBatchingUpdates and isUnbatchingUpdates be true at the same time?. Bringing this up made me think about some other permutations of fragment and array combinations given our current desired behavior of top-level fragments behaving the same as a top-level array. I jotted some of them down here (with the ones I'm unsure about marked with ?:\nhttps://gist.github.com/clemmy/b3ef00f9507909429d8aa0d3ee4f986b\nDoes that look right to you?\n. This feels like a superset of the previous test (same things being tested, but with a few more expects). Should we remove the previous?. The fallback here is a number for a couple of reasons:\n\nStrings are currently used for specifying host components in React.createElement, it would be a bit confusing to special case fragments into this space. See https://github.com/facebook/react/pull/10783#discussion_r145575197\nNumber comparison is faster than string comparison in JS. Currently there's nothing implemented to throw later, since @sebmarkbage suggested leaving this space open for fun things (https://github.com/facebook/react/pull/10783#discussion_r145575197). https://github.com/facebook/react/issues/11290 It's to ensure correctness between type checking when comparing across functions, classes, strings, and potentially numbers/symbols.. In order to preserve the optimization on the if/else, I'd end up with something like:\nif (React.isValidElement(children)) {\n      const element = ((children: any): ReactElement);\n      if (element.type === REACT_FRAGMENT_TYPE) {\n        if (React.isValidElement(element.props.children)) {\n          flatChildren = [element.props.children];\n        } else {\n          flatChildren = toArray(element.props.children);\n        }\n      } else {\n        flatChildren = [element];\n      }\n    } else {\n      flatChildren = toArray(children);\n    }\nThe code is a bit more confusing, but it does save a duplicate check. What do you think?. Oops! Somehow missed this haha.. So the behavior we want is to warn if it's not equal to REACT_FRAGMENT_TYPE?. This looks very nice. \ud83d\udc4d . Oops, I assumed that ref would appear in element.props. I think it makes sense to do the check in ReactElementValidator since that's the earliest possible time we can catch the potential bug right? What are the advantages of having the warning inside ReactChildFiber?. When you say that people can create elements by inlining, this can only happen in non-dev mode right? (I'm assuming that when you mention inlining, you are referring to this transform: https://github.com/babel/babel/tree/master/packages/babel-plugin-transform-react-inline-elements). Is there a way to do less checks? I think that every way we re-write this, there still ends up being 3 checks. https://github.com/facebook/react/pull/10783/files/48bcaa7198ef5d97bfc78badd1636a836a076cda..27312d0ebbc3ebbdaa8dc48e6f70119847267389#r147533483. We should make sure to remove the : Object when removing the enableCreateRoot flag.. I'm not sure what you are asking. My understand is that the tests should only run once, or not at all.. This can probably be a const, since it's never re-assigned.. Don't think you need ...{}. const?. Hmm, wonder why it was written the other way initially. \ud83d\ude1b . How about:\nconst hostProps = {\n    ...props,\n    value: undefined,\n    defaultValue: undefined,\n    children: '' + node._wrapperState.initialValue,\n  };. Similar:\nconst hostProps = {children: undefined, ...props};. I think this is probably fine.. Test name is a little bit weird. Maybe propagates error instead?. \n",
    "kenotron": "jsdom is needed here to create a brand new document because by default jest-jsdom assumes every test is on the same document.. I've verified that this test case fails in the current master.. line 101: type Container = Element | Document; \nI think so.. We don't have to, I guess from the same flow typing info, it can only be an Element (which HAS ownerDocument) or it's a Document which is the document itself.. That's a good call out, but I'm actually removing that ownerDocument and changing the name for short.. From the way it WAS written before, Fiber would have broken the iframe case. If you looked at the ReactDOMFiberComponent's createElement(), you'd see that the semantics there for retrieving \"ownerDocument\" is the same as what I have written here:\njs\n var ownerDocument: Document = rootContainerElement.nodeType ===\n      DOCUMENT_NODE\n      ? (rootContainerElement: any)\n      : rootContainerElement.ownerDocument;\nI'm going to reuse this bit of code for clarity inside fiberentry. done :). I've also addressed the parallel structure comment from @sophiebits. Since now we have repeated code to do that same thing, I've also factored that out into a function.. @sophiebits I've added this check.. would I still need this Document type? I think flow should be able to infer, right?. good catch - goober from a previous attempt at it.. @sophiebits ping?. ",
    "appsforartists": "\"tracks the cursor position\" would be fine.  I think it's fair to assume someone who speaks JS understands how mousemove works.. This would be a really weird way to reuse code.\nI'd expect someone who didn't understand how render functions work would use the component as a variable.\n```typescript\n\n\nrender() {\n  const {\n    component: Component,\n  } = this.props;\nconst {\n    mouse,\n  } = this.state;\nreturn (\n    \n  );\n}\n```\nOf course, render functions are more flexible because they don't make assumptions about the shape of the child component.  But, if someone wasn't using a render function, they'd probably use a component variable, not copy/paste the whole component implementation.. I thought I'd run that.  I'll double-check.. Fixed.. I wasn't sure which route you'd prefer.  I did test both before opening the PR.\nOptions:\n1. Merge as-is.\n2. Include react-dom as a script and react in this map (or vice versa - we could even have dev test one combo and prod test the other).\n3. Make a new pair of fixtures that tests the map style.\nWhich would you prefer?  If you'd like both, would they each live as folders in fixtures, or as subfolders of fixtures/requirejs?. I've never used RequireJS before, so I'm certainly not the expert.  Perusing its source, it looks like define(name is inserted into defQueue, but it's not obvious how config.paths gets registered.\nI didn't originally add 2 sets of fixtures because ensuring that define(name and paths[name] worked the same way seemed like a RequireJS concern (rather than a React one), but I'm happy to add a second set if you think it's worthwhile.  (I also don't know who/how fixtures are tested - is it just a manual smoketest, or is checking them part of a process?). I'm inclined to leave it as-is.  My inclination is that it's RequireJS's responsibility to ensure that config.paths works with define(name, and that adding fixtures to React that assert that adds noise more than value.\nI feel more confident in this direction because I did test the old style before updating the fixture - they both work.. Oh, I just saw that you did request both fixtures.  It got lost in the thread.  I'll add them.. ",
    "glennreyes": "I would add a space here like <Mouse /> and to all self-closing JSX tags in this file to keep this style consistent across the React docs.. ",
    "alexkrolick": "This conversation hits the nail on the head regarding one of the main sticking points of this pattern - enforcing an API contract between the higher-order function and its arguments. It would be nice if this document could call out some strategies for dealing with that.. @donavon it comes down to whether the render component is defined inline or not--React reconciles based on the type of the component. In your demo the Cat function is static so a createElement call preserves the instance. It seems the RR folks really want to encourage a pattern that allows for inline definition.. Created a CodePen to demo which patterns definitely cause a repaint in the DOM:\nhttps://codepen.io/alexkrolick/pen/WZwMYW?editors=0010\n\nNote that render props that are called as functions rather than components (createElement/JSX) are the only inline-able ones that don't cause a redraw. \nThis is totally aside from any memory issues that arise from defining functions in render.\n. This is a little misleading since JSX is itself converted to createElement calls, as you mention below.. - The community seems to have settled on h() as a shorthand for createElement, so I'd suggest using that\n- The nested example is a lot easier to read with the shorthand + a newline:\n```jsx\nconst h = React.createElement\nclass Hello extends React.Component {\n  render() {\n    return h('div', {},\n      h('p', {}, 'Hello, World!')\n    );\n  }\n}\n```. ",
    "the-spyke": "@alexkrolick It also useful to add another Inline, but this time a class:\nconst InlineClass = class InlineClass extends Component {\n    render() {\n        return <span>{this.props.foo}</span>\n    }\n}. ",
    "frenzzy": "This line was removed from LICENSE file, but not from other source files... :blush:. ",
    "siddharthkp": "came here to comment this \ud83d\ude05. ",
    "MichaelDeBoey": "Maybe add a link to the CRA repo?. ",
    "danny-andrews": "\nNo need for a lambda here. Just inject the Cat component directly. Again, component injection.\n\n@donavon\nIsn't the lambda good location for any prop mapping that may need to happen between Mouse and Cat (for example, converting prop.mouse into prop.x and prop.y? If we want to keep Mouse and Cat ignorant of one another, it seems odd to let Mouse directly render Cat. Also, what if you wanted to give Cat props in addition to those passed down by Mouse?\n\nWith render props:\njs\n<Mouse render={mouse => (\n  <Cat x={mouse.x} y={mouse.y} speed=\"slow\" />\n)}/>\nWith component injection:\njs\n<Mouse render={Cat} /> // How do I set cat's speed? I wanted to keep mouse alive. ;(. p.s. I'm loving this example. It's so disarming. :D. ",
    "KyleAMathews": "maxWidth of the main content div is 840px. This needs copied over from the existing site (I'm assuming you're using Google Analytics \u2014 if not remove this). This should use gatsby-link for internal links \u2014 probably the cause of https://github.com/facebook/react/issues/10898. perhaps change to \"to start the hot-reloading development server powered by Gatsby\"?. You also need to run yarn at the root right? For Prettier, etc?. Changing html.js triggers a page refresh automatically so this line isn't necessary. Had one more suggestion :-)\n\"Edits to markdown files in /docs and to React components in\u2026\". I didn't write this plugin so\u2026 probably just should be fixed. I believe site_url is required to be the key name for the node.js package that creates the feed but the duplicate in the query doesn't seem necessary.. ",
    "hprobotic": "Some /react/ link has been broken. ",
    "Connorelsea": "I agree, this can be improved. \nI went through a few iterations and came to the following. If there are any improvements you can think of let me know and I can put whatever final version you want in the PR.\n\nThough using React.createElement() instead of JSX offers the same functionality and versatility of JSX, over time it may become cumbersome to write React.createElement() so frequently throughout your application. To solve this problem, we can think in JavaScript - simply assign the function to a variable for use as a shorthand helper.\n\n```javascript\nconst e = React.createElement;\nReactDOM.render(\n  e('div', null, 'Hello World'),\n  document.getElementById('root')\n);\n```. I also think a brief section should be added in this doc about nesting. It seems obvious to someone familiar with React, but to a beginner unfamiliar with function composition, it may not carry over from JSX super easily.\nHow do you feel about a code example like this?\njavascript\nclass Hello extends React.Component {\n  render() {\n    return React.createElement('div', null, React.createElement('p', null, 'Hello, World!'));\n  }\n}. ",
    "nstraub": "the comment has been adjusted. ",
    "nihgwu": "there will be a input indicator there when focused, the live jsx editor focus in the same way. should be 14 here for consistence and also added to TypeOfWork above?. ",
    "viankakrisna": "is this is always the case? can we elaborate more about this?. perfers -> prefers. I see, so in other words, react needs to traverse the component tree and compare the difference every time it renders, and a compiled template can be optimized ahead of time to just modify the DOM directly? For example:\n<div>\n  <div>\n    {props.children}\n  </div>\n</div>\nif we want to update the props.children,\nIn React this would be a minimum of 2 createElement calls at runtime and then apply the difference to the DOM (two steps that happen for every render)\nIn an AoT template, this can be just one step (to put it simply), because the compiler knows that the only thing that needs to be updated is the props.children. Is that right?. isn't this will throw on undefined value? we only strictly check for null above it.. why do we need to pass source in here? wouldn't it already accessible at the call site?\njs\nexport function useSelector(selector) {\n  const store = useContext(ReduxContext);\n  const subscription = useMemo(\n    () => ({\n      source: store,\n      subscribe: (store, handler) => {\n        // why do we need the store as argument here?\n        return store.subscribe(handler);\n      },\n      getCurrentValue: () => {\n        return selector(store.getState());\n      }\n    }),\n    [store]\n  );\n  return useSubscription(subscription);\n}\n. ",
    "fpoumian": "It seems that the gatsby-plugin-feed plugin uses that date attribute in order to generate the pubDate field. If I remove it then the pubDate field disappears as well, although I'm not sure why it doesn't respect the format.. To make it less confusing I'm thinking we could add a \"rssFeedDescription\" property to siteMetadata (as opposed to the generic \"description\" property) and have the plugin use that instead:\n{\n          site {\n            siteMetadata {\n              title\n              rssFeedDescription\n              description: rssFeedDescription \n              siteUrl\n              site_url: siteUrl\n            }\n          }\n        }\n. Correct; I noticed that the previous RSS feed (http://web.archive.org/web/20170829050443/https://facebook.github.io/react/feed.xml) contained the whole article instead of just the excerpts, so that's why I kept it that way.\nI'll remove the excerpt field in my next commit :). Or, if we want to keep exactly like the previous RSS Feed, we could something like this:\njavascript\nsiteMetadata: {\n    title: 'React: A JavaScript library for building user interfaces',\n    rssFeedTitle: 'React'\n    rssFeedDescription: 'A JavaScript library for building user interfaces',\n    siteUrl: 'https://reactjs.org',\n  },\n{\n          site {\n            siteMetadata {\n              rssFeedTitle\n              title: rssFeedTitle\n              rssFeedDescription\n              description: rssFeedDescription \n              siteUrl\n              site_url: siteUrl\n            }\n          }\n        }\n. Correct; apparently the only field that needs to be duplicate is the siteURL field, otherwise the links in the RSS feed don't work. My latest commit should reflect those changes. . Ok sounds good!. The problem is that for some reason the plugin requires that duplicate key to be present, otherwise it doesn't work correclty. So, I run this query:\n{\n          site {\n            siteMetadata {\n              title: rssFeedTitle\n              description: rssFeedDescription\n              site_url: siteUrl\n            }\n          }\n        }\nThe XML I get back turns out like this:\nxml\n<link>undefined/blog/2017/09/26/react-v16.0.html</link>\n<guid isPermaLink=\"false\">undefined/blog/2017/09/26/react-v16.0.html</guid>\nSeems like even in the documentation page they suggest using the duplicate key:\nhttps://www.gatsbyjs.org/packages/gatsby-plugin-feed/\n. ",
    "ojab": "MIT MIT MIT. ",
    "cztomsik": "I think this is because you can compile template directly into DOM calls, so there is no overhead of diffing (of course the performance is always tricky but in general, compiled templates are faster - see marko for example). Yes :). ",
    "NE-SmallTown": "What do you mean \"remove\"?We are based on \"ReactPriorityLevel\" to scheduling, right?. > I think the else in the end is unnecessary\nThis is just another code style, IMO, current implementation is for more readability. Why we do the judgement again instead calling now() directly?. @sebmarkbage I am a little confused, ms / UNIT_SIZE) | 0 equals Math.floor rather than Math.round, right?. @acdlite Any explanation here?. @sebmarkbage Do we have any plan about wasm?. @gaearon @acdlite  Could you please tell me what does 'The initial render was aborted' mean? I'm a little confused that we call componentWillUpdate and componentDidUpdate but don't call the render method, this is different with the common life cycle process. @acdlite Could you explain more about the standard of a event should be put in 'Interactive events' or 'Non-interactive events' ? E.g. Why put 'mouseover', 'scroll' in  'Non-interactive events' rather than 'Interactive events'?. Thanks for your clarification! So, the more accurate word is \u2018(async)instant/immediate\u2019 instead 'Interactive'?. Should be\nif (oldProps === null || newProps === null) {\n   throw new Error('Should have old props');\n}\n?. Yea, #12590. This makes me remember this and this :). Switch case trap. From the comment 'Updates during the render phase', I'm a little confused why we use else rather than else if (isRendering) here, @acdlite would you mind explain some details? Thanks!. @bvaughn Can I ask that why we do the repetitive logic, i.e. only interactionThreadID, memoizedInteractions and pendingInteractionMap is related to enableInteractionTracking, we don't need to copy the remaining  fields here, why not just do something like if (enableInteractionTracking) { root.interactionThreadID === xxx} or if (enableInteractionTracking) { root === { ...root, interactionThreadID: xxx } }( or use Object.assign here).. http://v8-io12.appspot.com/#29\nhttps://www.youtube.com/watch?v=UJPdhx5zTaw\nThank you Brian!  I know the performance now.. @acdlite @sebmarkbage Can I ask that why we use this name(i.e. requestWork)? It seems that this is only related to 'root', should we rename it to requestWorkOnRoot or something else?. Ah, fine, just want keep the consistent. Will remove this this evening. @nhunzaker From this commit and the test, looks like we support custom createElement function before? I don't know .... Why we need to do this again? I mean, we have done the args.length > 8 check, we won't reach this branch . Ahh, when you use 'ES file', seems we all think it refer to 'ES6+ file'. Seems more '*' than others \ud83d\ude04 . I'm a little confused here, even before this PR, the the terminal state is still deterministic(i.e. ReactNoop.getChildren() === abcdefg). Seems this PR only change the behavior of ReactNoop.flush() in this test case?(It doesn't been provided to the user, the user can just feel the children) But I don't know why it just change the ReactNoop.flush() rather than ReactNoop.getChildren(), React relays on flush so I think it should have same result of flush and getChildren. @sebmarkbage Could you give some info about this?. Why not just import maxSigned31BitInt.js. I'm a little confused here, it seems we can just do\n```\nconst now = hasNativePerformanceNow ? performance.now() : Date.now();\n// or for tree-shaking? we can use if (hasNativePerformanceNow) { now = performance.now()} else { now = Date.now() }\ntimeRemaining = function() { ... } // we just need do this once rather than twice currently\n``. nice rename ~. Maybe \"This callback priority is equal or lower than the new one\" is better just IMO\n. timeout -> expirationTime?. And seems it doesn't do sort, it just do a find & insert operation. I don't know why even I remove this line i.e.queue.firstCapturedUpdate = newFirstCapturedUpdate, it still works, maybe the queue has been set tonullafter we executed this function? I don't know, don't dig into it. So I still remain this line. @bvaughn I don't understand. The code I show above **don't** \"do a conditional check inside of a very \"hot\" function\", it just do the check **once** when theindex.jswhich be bundled **first run**. And it reduces duplicate code. So it's a win-win thing. Sorry for the typo, I mean:const now = hasNativePerformanceNow ? performance.now : Date.now, so later we can just usenow()to read the current time. @bvaughn . @acdlite  Yes, so I don't delete that line(which at [line 1093](https://github.com/facebook/react/pull/13745/files#diff-f8ecb7d2b88a9e6edcab34023a47fe47R1093)) above. I just delete this line.\nOr you just mean I need adjust the comment?. @acdlite SeemsensureHostCallbackIsScheduleddoesn't use any argument in the function body, can I ask that why we pass thefirstCallbackNodehere?. @acdlite  TheabsoluteTimeoutargument doesn't been used here, I'm not sure why eslint doesn't warn about this. Should I remove it?. Should I remove this\uff1f. Should we modify the comments together?. I think the lint should warn on this but don't know why not. Could we give more explanation about why \"even though there is no frame time\"?. IIRC,enableSuspense` has been removed in #13799 ?. Should we use or add a PureComponent of AsyncText case like :\n<AsyncText ms={100} text={2} />\n<AsyncText ms={100} text={3} />\n<AsyncText ms={100} text={1} />\nhere? IMO, we need a case which test the cache read and common reconciliation together.. Sorry. I mean, this just test the function component(the AsyncText) but in real world, we have class component which can be PureComponent or normal Component, so in the common reconciliation and update, they will go to different switch cases or codes, I think maybe it also should be tested with the cache read processing. @acdlite . @acdlite  Should we add expect for 0 < time < 500 and 500 < time < 1000 just like Suspense-test does?. And I'm a little confused here, if you could tell me I would be very happy!\nWhy textContent is Loading... after execute ReactDOM.render immediately? IMO, it should shows Loading... only after time >= 500 just like how Suspense works, doesn't it?. Below we do index = match.index, so it doesn't need assign here. Every switch case we do break, so this line is unreachable. Oh, don't know that, could we add some comments about that, I think that would be better?. Done. Remove these and below. Oops, sorry, I confuse the brace.. @bvaughn Thanks, I don't notice that. But if so, seems we don't need to set the maxDuration prop?. @acdlite Could I ask what is \"progressive enhancement\" in your context?. ",
    "OriR": "In the comment here it says that JSDOM doesn't remove the node from the current parent when moving nodes using appendChild, though I didn't verify this myself.\nI could check and see if that's still relevant, if not then I can remove the get handler altogether.. You were right, this was no longer necessary \ud83c\udf89 \nRemoved the get handler altogether!. ",
    "sw-yx": "thanks sebastian - just doublechecking before I fix - the issue discussion last left saying it should be an invariant outside a __DEV__ block (see here) - are you sure you want it just as a warning? . regardless, i will resubmit as requested :) really honored to help.. ooh, this is pretty. one concern is that this may be too verbose because we have a -lot- to cover here. but i have no qualms incorporating this first and then deleting after if we dont like it.. ok. sections for now.. the guidance is not clear here tbh. i've seen @gaearon also prefer warning(false,.... and doing all the logic in an if block. \u00af_(\u30c4)_/\u00af. I personally think that would be confusing as that's not something anyone would code. if anything we could just drop the word \"updater\" cos it doesn't really add anything. I like that but I should also point out that this is also very likely to happen if you do \njs\nthis.setState(state => {\n    // some logic here\n    // forgot to return\n})\nhow to address that as well?. here? https://reactjs.org/docs/react-component.html#setstate. ok. i guess i shoudl have asked about this haha, i was also unsure about it. i think i understand.. done; i guess i was just twitchy about touching code that isnt mine haha. after studying this a bit, I think this suggestion would cause additional duplication because i would need to pull in the work done by getStackByFiberInDevAndProd and there are other modules that depend on getStackByFiberInDevAndProd. So instead of doing a rewrite of getCurrentFiberStackInDev I will do a rewrite of getStackByFiberInDevAndProd and just get getCurrentFiberStackInDev to rely on it.. ",
    "Noitidart": "I think the sell is good, because of the link there I was able to understand when to use a HoC and when to use a render prop. After reading and understanding I have use cases for both.. ",
    "blling": "Should return target.ownerDocument.parentWindow immediately.. Which PR?. :D. ",
    "Haroenv": "Maybe the var can be completely removed then? and not augmenting the class?. yarn installs yarnpkg and yarn by default, so you can change that to yarnpkg --version and checking if it's installed first (maybe which yarnpkg or something if that's supported on windows). ",
    "bfreis": "Can't wait to see the updated tiny-react-renderer after this is released! I learned so much from that. Thanks! :). ",
    "charlie-axsy": "@danny-andrews you could potentially pass through any unwanted props.  This is how redux-form does it.  However in this example, it just means that the mouse is eaten even quicker.\njsx\n<Mouse render={Cat} speed=\"slow\" />. ",
    "d4rky-pl": "Done!. Yes, _forcedUpdate is always a boolean. ",
    "Yeti-or": "Great song by the way \ud83d\ude06 . ",
    "SadPandaBear": "Correct me if I'm wrong, but ReactTestUtils.SimulateNative.change actually needs to have an element listening to an event to be applied. Any change dispatched to this element won't have any consequences (e.g the value will still be the same). So, judging that in this case, where there's no event at all, makes more sense this way.\nYou can check a similar case here.. @sebmarkbage Thank you for the hint with setUntrackedValue.call(node, 'giraffe');!\nIt's way more flexible too! Working on right now!. Totally agree, I'm gonna check it out right now and post here the results.. @sebmarkbage Yes, the tests are passing indeed.\nPlus, I think using something like the node.dispatchEvent(nativeEvent); seems to be a very flexible way to obtain the expected results without reaching those internals.. @gaearon Wow, I really wasn't aware of that fix. Thank you! \ud83d\ude03 . @gaearon Does it make any huge difference on our tests using the Event constructor rather than the old-fashioned initEvent way when we want to create events?\nActually, how is Fiber dealing with these two approaches today?. Nice!\nReally liked what you did here for the html interfaces.  \ud83d\udc4d \n. I'm not sure if you do have to create an instance for the trackers. See, the solution I made for ReactDOMInput-test actually only had the calls for the input values i wanted to test. \nAnyway, I can't see any trouble really about this solution. \ud83d\ude04 \nI see you are setting the value directly into inst. What happens if you set with the tracker instance you created (like this)? Will the test still pass (considering you write the setUntrackedValue and everything)?. I was thinking on doing something like:\njs\nvar event = new ClipboardEvent(type, { bubbles: true });\nif(data) event.clipboardData = data;\nelement.dispatchEvent(event);\nBut unfortunately ClipboardEvent is not supported. \ud83d\ude22 . validateChildKeys conditions are expecting for a list of valid children elements, a valid single element (which will evaluate the _store.validated to true) and/or an element that may provide an iterator.\nThe children that createElementWithValidation receives as the index 2 (and so on...) arguments keeps the default values of ReactElement for non-valid props (like the key), which are mostly null, even when props are explicit. \nIn this way, there won't be a difference between undefined and [1, 2, 3] keys for error messages, for example.\nFor instance, the snippet you wrote will never be true, because the child keys will literally be messed up when they get inside validateExplicitKey.\n\nBased on the test i've wrote previously, you can see every time an element is created and how its parameters are being handled (these are logs from createElementWithValidation arguments).\nThe last one is the only one that passes through validateChildKeys and do the rest of the validation inside validateExplicitKey.\nThe reason i separated imposeInvalidExplicitKeyPropType is that i wanted to ensure that it would be using the right props beforehand, not the ReactElement default ones or props that would evaluate to false in every single expression from validateChildKeys. \nPerhaps mutating the warning text doesn't look that nice, i can come up with something like sending props to validateChildKeys (and then i could even move imposeInvalidExplicitKeyPropType's code to validateExplicitKey and do all validation there).\nNeedless to say that wrapping it into validateExplicitKey may mess up with clones since they can pass invalid key props.. ",
    "VladBlow": "Hey,\nWhy you added types in flow style if this file have't flow comment?. yep! I can delete useless flow typechecking or add comment flow. If I add flow comment maybe I can try to update types for all file? If you want this.. ",
    "enapupe": "I'm not sure about this first test, it seems to have lost its initial purpose.. Hey! I did the requested changes, could you take a look at it?\nI'm still not sure if the first test is on spot because before it tested two unrelated components and now they have a parent-child relationship. \nAlso while we are at this file, I'm not sure how to rewrite should not get confused by disappearing elements.. I think I understand the thinking behind it but I'm not sure if it's possible to accomplish the same result without mocking handleTopLevel. I'd have to unmount a component in the middle of the event chain, which seems impossible.\nThanks!. Yeah it seems \nnew MouseEvent('mouseout', {\n  bubbles: true,\n  cancelable: true,\n  relatedTarget: node,\n})\nworks just fine.. ",
    "Ethan-Arrowood": "how do you check if an input is valid?. This is the only prototype method I could find that would grant me access to this kind of info. If the value is untracked it won't show up in the Object.getOwnPropertyDescriptor() call. (Hence why I am using the .set method).. Okay then I'll clean up my code and push. Should be good to go at this point.. Should it just be it?. Can you please elaborate on what a 'common' is? . javascript\nnode.dispatchEvent(new Event('click'));\nexpect(called).toBe(0);\nIs this what you mean?. Merge conflict mistake. Will change. Yes. I need to make the following two lines globs instead of hardcoded values too. . toContain is checking if something is within an array with ===. The span() method returns an object which would fail the strict equals. Could I keep it as .toEqual() and strip out the stack trace? I'll get to work on a code sample for this right now.. In these instances it seems as though children is an empty array. I'm getting: Expected array but received undefined when I use that line in the expect() statement.. Okay I guess I don't fully understand mutation. Let me know how the most recent changes look. I'm also going to start trying to fix the build errors.. Gotcha. Let me see what I can come up with.. ",
    "uniqueiniquity": "@clemmy Why is the fallback here a number instead of a string? Not sure I follow.\nI'm curious so I can accurately update the react typings for TypeScript, and it seems weird to have the first argument to createElement be a string or a symbol or a number.\n. (sorry, didn't mean to add myself as a reviewer). Sounds good. Thanks!. ",
    "NicBonetto": "Yes :) Just so I have a correct understanding, the refactor will look like:\nif (typeof value === 'boolean' && !false) {\n  if (value === true) {\n    warning(false,\n      ...\n    );\n  } else {\n    warning(false,\n      ...\n    );\n  }\n  ...\n}\nIs this the branching logic you prefer? I do not understand the !false condition, so if I am incorrect please explain what should take it's place.. Sorry, my understanding was that the value being passed was the condition. So value should hold the attribute name instead of condition correct? It didn't make sense that whatever (holding the value false) could be an attribute. Thank you for your patience and help through this issue.. No need to apologize, your message did not come off badly. I only apologized for making you revise this pr so many times because I did not grasp the whole picture. Yes, this is extremely helpful. Thank you. . Do you prefer:\n`whatever={String(value)}`\nor\n`whatever={value.toString()}`\nI feel the second option is a bit more verbose and easier to read.. ",
    "dleitee": "\nWhy is there an array here? Shouldn't it be just new Event(eventType, defaultNativeEvent)?\n\nI was using arrays because I've seen the Event's constructor on jsdom and the first argument is args and it is an array: https://github.com/tmpvar/jsdom/blob/2d51af302581a57ee5b9b65595f1714d669b7ea2/lib/jsdom/living/events/Event-impl.js#L7\nbut no problem to change it :D\n\nIt would be nice to rename defaultNativeEvent and nativeEvent to eventInit and defaultEventInit, to match how spec calls these arguments.\n\nOk\n. thanks. @gaearon  there is no value on e.nativeEvent.returnValue, I think it's not testable.. what do you think?. could I use it: ReactTestUtils.SimulateNative.click(instance, {returnValue: false});. ",
    "silvestrijonathan": "Sure-habit taking over from how I do this on the day-to-day. My bad!. Sure, can do!. Good catch!. On it!. ",
    "anushreesubramani": "When I changed it to fiber and tried, the tests failed because getComponentName(fiber) was returning null and not the component name itself for some reason. So had to revert it.. I have changed this to getComponentName(..) || 'Component'. This is because, I was getting a flow error in this line::: !!stateDeprecationWarning[currentComponent], which said\n\naccess of computed property/element. Computed property cannot be accessed with null\n\nNot sure if giving default value is the right fix for this.. but the if condition is based on this value. So, we need this statement here. I tried this and the tests were still failing. In the test output, getComponentName(fiber) was returning null (not sure why) and so instead of the expected component name, ReactClass was used as default value for component name and caused the test to fail. Not sure if I am missing something here.. ooohh god.. yes i forgot to change it there, my bad. Sorry :(. @gaearon I believe the reason why the DEV checks are right at the beginning of the tests is because ALL the assertions are related to warnings, which will not be testable in prod as we wont be seeing any. So no point in letting any of the code execute in prod. . ",
    "smaniotto": "That was my first attempt, but I keep getting this error:\nTypeError: Argument to dispatchEvent must be an Event. To reset changes done on document.body, replaced it by document.body.innerHTML = ''.. @SadPandaBear Not sure if it's possible to use the Event constructor in this case, since I have to mock the clipboardData. Any ideas?. ",
    "AudyOdi": "@SadPandaBear Thank you for reviewing. I have confirmed that changing value using tracker instance still pass the test. The reason I create an instance for the tracker is because  getValueTracker is being used for both input and textarea element. Not sure about using HTMLInputElement for textarea is the correct way to do it.. @gaearon got it, I will define the helper in each test case instead so that input will use HTMLInputElement, and textarea will use HTMLTextAreaElement. ",
    "GordyD": "Thanks for the comment @gaearon . I'll update to move assertions out of the event handler - this is much simpler. \nThough FWIW from my understanding of async tests in Jest if done() is never called, due to _onChange not firing, then it would fail - albeit the failure message would not be the most helpful.. I like it. Tests are more focussed on testing and we move set up to where it should be - thanks for the pointer. I'll adopt this approach.. In order to simulate the behavior of trying to switch a component from being uncontrolled to controlled we need to assign a new value to the input without it being tracked - I found this approach after reading through the comments of #11309.. Thanks for the detail, I'll check out the blame and track down ways to make the test more robust.. ",
    "MatteoVH": "Makes sense.. ",
    "xjlim": "Thanks, will look into that.. I see. Sorry I accidentally messes up with the git, should I squash them?. Should also check for zero warnings.. ",
    "yu-tian113": "Agree. Also need to check require(packageJson).files is not undefined, as files entry is missing in some package.json(e.g. react-call-return).\nUpdated to \nconst whitelistedFiles = (fs.existsSync(packageJson) &&\n    require(packageJson).files) || []; \nAnd deleted the existance check below.\n~~if (whitelistedFiles && whitelistedFiles.length > 0) {}~~\nif (whitelistedFiles.length > 0) {}. Agree, done.. Comments added. hehe, sorry, didn't realise I typed these promises as proxies.\nVariables renamed.. Thanks @gaearon, some modules may help with bits and pieces, but I'm a little hesitant including any as new dev dependencies, considering we already use things like ncp and glob(which these modules are also build upon).\nThe other reason I did't use a prebuild module is I don't want to encapsulate tasks together. For example, glob composes a whiteListedFiles list during the copy process, which is used later for checking all entry points are whitelisted. If a module doing things like copy with glob, we'll have to run glob again separately to get the list.\nnode-mkdirp can help creating nested directories. Do you think I can add it as dev dependency?\nI will extract it to a separate function, make the code flow more intuitive.\n. Agree, updated to use os.tmpdir(), it makes sense to do temp packing and unpacking in the os's temporary folder.\nThere may be some rare cases, if a use's permission is misconfigured, system temporary folder is not accessible for writing.\nPlease review.. Updated.. Fixed, together with the swap to os.tmpdir(). What do you think about removing both build and temp before building, something like rimraf(`{build, ${npmPackagesTmpDir}}`, async () => {...})\nPassing the uuided path to all build functions feels quite cumbersome?. Thanks for pointing this out! Please review.. ok, these tests are removed.\nCan't find a good way to test the math generating path, all other props are covered in snapshot tests.\nPlease let me know if anything's missing.. ",
    "oguzgelal": "@gaearon @bvaughn I'm having a problem with these lines: I'm using enzyme and it uses shallow rendering, for tests, while NODE_ENV is set to production. So my tests are failing because of this.. ",
    "raphamorim": "Make sense. Updated ad3223a. te-hehe\nDo you recommend putting it back?\nI think it does not make sense to keep this line. Since it is the same reference. \nTradeoff: I guess it was written for better readability. \nWhat do you think @clemmy . I guess circleci/node:8 uses yarn@1.3.1.. I'm using circleci docker images (https://hub.docker.com/r/circleci/node/tags/)\nUnfortunately none existent image with Alpine. But this is nice question: Move foward with 8-alpine (https://hub.docker.com/_/node/) ?. \ud83d\udc4d  :octocat: . Ok, I'll change it.. changed in 4446de5. @gaearon question: files with explict strict mode, should keep var right?. Hm, @gaearon I guess my first idea is wrong. Seems to be a scope issue.\nIn this case I simple changed it and returns errors like: \nReferenceError: validatePropertiesInDevelopment is not defined on tests.. ok, I'll fix for react-dom, and see if forgot some var in other package then. I'll add on this PR.. It's okay for you?. I think it's better I close this PR and send one with another branch name :P. damn, you're right. I'll solve it, can you continue review the other files?\nI had conflict only with this file and the ReactFiber of reconciler package. hm, you right @gaearon. Updated :octocat: . ",
    "landvibe": "OK. yours is better. I also think it's unnecessary.. I think updateNamedCousins is called only on the button because of this code ReactTestUtils.Simulate.click(buttonNode);\nI checked that updateNamedCousins is not called when I run your fixture.. I added the code in updateProperties because updateWrapper also calls updateChecked. ",
    "monkindey": "Thank @gaearon for review. \n\nThis will fail if the user doesn't have yarn\n\nAgreed, we can catch the error and make it fail gracefully, I will try it.\n\nWe also need to make sure it works on Windows.\n\nI think yarn --version command will support Windows.\n\nuse yarnpkg alias instead\n\nIf user use other name instead, it's hard to trace. \ud83e\udd14. Thank @Haroenv for reminding. yarn v0.16.0 started to support yarnpkg. It seems ok to check yarnpkg first.. Do you have a better message about running yarn failed.. It will try yarnpkg first, and then yarn. If both of them throw error, and will fail gracefully with a message when error.code is ENOENT. Yes, if local yarn version is lt the MIN_YARN_VERSION, the process will exit. I don't know whether I got what you mean.. first check development environment and then check react version? . Maybe this script too long, Any idea?. ",
    "M-ZubairAhmed": "I have added the boolean flag after observing other places where warning() was used. Also tested locally. changes done. Thank you @gaearon for being so patient with me.. I have also tested this in fixtures/dom by introducing some props and misspelling propTypes. Added the variable declaration under if(__DEV__){ which is after import statements. Now working on test.. Should the test be added in both ReactElementValidator-test and ReactJSXElementValidator-test?. Oh i just added test in both of them, i pushed my code. Should i remove from one ?\nAlso i have verified all tests were passing and ran build in my local example which was reproducing the error.\nI was wondering if i should add another test it(should not show any errors is correct propTypes property assignment is passed)?. ",
    "timjacobi": "I'm currently investigating this.. I'm currently investigating this.. I'm currently investigating this.. The previous version of this test had two expectations. On where defaultPrevented was true and one where returnValue was false. I checked why and it turned out IE uses returnValue instead of defaultPrevented. Happy to use e.nativeEvent.preventDefault() but it will have less parity with the previous version of the test.. I just realized that we have dropped support for IE8 and IE9 doesn't use srcElement anymore so we could simplify this like you have suggested initially. Your call.. Could you elaborate? I don't follow.. Yeah I'm not entirely happy with that either. Will think about a more elegant solution.. I wonder if we're good to just remove the ARGs since we're now tracking the event type which we haven't done before. If I get it righttraverseEnterLeave(from, to, fn, argFrom, argTo) will be called with argFrom and argTo set to the events that are dispatched on the target anyway so I feel like extracting the target id and event type will be strict enough.. ",
    "travi": "sure thing. updated. sure, that makes sense. updated. ",
    "strugee": "Drive-by nit: capitalize \"facebook\". ",
    "jeremenichelli": "Lol, forgot to take it out.. @gaearon I'm thinking of creating tests for escapeText through the ReactDOMServer.renderToString API like these ones, do you think that it would make sense to write them? Also, if you do, shouldn't this test be placed there where the script would actually run?. Great, will add test on both escapeText and quoteAttribute tests.. @gaearon from here, tests for number, object and script tags on attributes have been added back. Above tests for text content in nodes contemplate these cases too, let me know if you ahve any more concerns or something that I might have missed.. What I didn't like form this test is that thy are just testing a switch JavaScript statement by doing it directly from the module. These internal modules pass thourgh other checks and algorithms when applied, so someone could modify that code, prevent the script to actually escape the characters and test would still pass, something that won't happen now \ud83d\ude03 . Yeah, that could be one way. Though werid since this is used only on the server package, maybe adding cases from renderToStaticMarkup would be valuable.. I understood it better after writing my response but didn't want to edit it.\nYeah I guess that would mimic the text string from server to node conversion better than just testing the string. Let me know if you are planning on migrating to that. I might think about revisiting these tests in the future if necessary.. ",
    "aarboleda1": "I expect charCode at this point to be 13 but get this message.\n\nI'm wondering if there is a difference between the keydown and keypress event that I am missing. \n. The EventInterface, the keypress event also seems to be not firing in the same manner as keydown and keyup. . ",
    "accordeiro": "I didn't find a way to replace this specific test (that the callback queue was actually growing). However, the test that ensures that the mockFn was called twice \u2013 do you think this is enough?. OK, I've updated the test to ensure callbacks aren't called more than once.. ",
    "HeroProtagonist": "Changes reflect this. Do you prefer to have function declaration vs definition? . @gaearon should this then be an invariant and have a shorter version of this error thrown when NODE_ENV=production? Otherwise, production would have the toLowerCase error displayed . Ah I see in render which in turn calls renderDOM has lots of checks in it. I will update PR soon!. Didn't make the connection that I could do this. Thanks, this is so much easier than overriding the function. Removed the beforeEach and added this to the tests. ",
    "veekas": "That looks better to me, as well. ~~Should I make the edit?~~ Edit: Made the edit and pushed a new commit.. Good point. Pushed a new commit with line breaks before and after the code excerpt to increase readability.. I'm inclined to agree, but as I searched through the code base I saw the getComponentName(*) || 'Unknown' pattern used 22 times while Component or A component were only used 7 and 8 times respectively. In fact, the most recent commits by @gaearon, @acdlite, and @bvaughn all use Unknown (#12028, #12359, #11455). I'll let one of them chime in about whether they think this should be changed.. Fixed!. Fixed!. Ah, yes, of course. Thanks for catching that. (Edit: fixed). ",
    "ConradIrwin": "I've verified that the fixture works in Chrome, Safari and IE 11. Firefox does not support this. Is there a complete list of browsers I should try and support, or any support for running the tests/fixtures in a large set of real browser environments? . Good call on checking. It does not work in IE 9 or 10 or 11 (I'm not sure how I persuaded myself that it did before), as it fails with \"Assignment to read-only properties is not allowed in strict mode\".\nThe event does get reset correctly in Chrome and Safari, and I've added a check for that to the fixture.\nThere are two other approaches I considered, but neither seem to work:\n\nInstead of window.event =, defining a property on window that returns the correct event. This works to return the correct event object (as far as I can tell), but the event object is unusable in IE 9 or 10 (it does work in IE 11) because any attempt to access the event's properties throws \"Member not found\".\nInstead of creating a new fake event to dispatch, just re-dispatching window.event. (this fails with an error that \"event is already being dispatched\")\n\nFor now I've updated this pull request to not preserve window.event in IE at all. If it would be preferred, I can make it work in IE 11 using window.defineProperty \u2014 it still will not work in IE9 or 10, but it can be made to not crash.. @gaearon Thanks for looking into this.\nIt is useful for two reasons, only one of which I added to the comment:\n\nRunning window.event = event on IE <= 10 throws an error \"SCRIPT3: Member Not Found\". As far as I can tell, this has nothing to do with anything other than \"running in IE <= 10\". So I needed at least a feature check for these browsers.\nFirefox does not support window.event at all. So I wanted a check for browsers that usually have an event property on window.\n\nBy happy coincidence this check does both. I've updated the comment, and rebased over your latest changes.\nPlease let me know if I can improve this more, as this is currently the main thing holding us back on 16.2.. ",
    "gkal19": "Sorry! I've forgotten to revert this :cry:. ",
    "madeinfree": "oh ! I missing refs can use with Component Class before I read the document again, I remove the get* method and only use refs . ",
    "skiritsis": "Sorry, was totally unaware of that. Reverted the changes in codes.json. Of course. I will update it accordingly.. ",
    "ctxhou": "I also want to refactor it. But currently I don't think of other refactor way.\nBut it doesn't affect too much efficiency, because this script will only be used on yarn linc to distinguish es5 and es6 files: here.\nFor yarn lint, because the es5, and es6 pattern is known, we don't need to judge files' ecma version.\nHere is the yarn lint run time after the change:\nBefore: 22.50s\nAfter: 17.86s.\nThe reason for runtime decrease is because, before the change, the filePattern was [.] (ref), after the change we use specific es path.. ok, I add it on new commit.. ok. OK, I'll move it to respective config.\nDoes it mean we should put all the eslintignore setting to the shared config file?. ok. I think we should keep the .eslintrc to make editor work as usual. \nIf we want to avoid ignore pattern duplicate, maybe we can write a script to read .eslintrc to use in prettier ignore part.. Cool! It's more clear. I will correct it in this way.\nBTW, for the lint change, eslint provide a ignorePattern params.\nSo when linting es5 files, we can pass es6 path as ignore pattern, vice versa.\nHowever, it will cause this warning when the file is ignored: (related issue: https://github.com/eslint/eslint/issues/5623)\n0:0  warning  File ignored because of a matching ignore pattern. Use \"--no-ignore\" to override\nTo turn off this warning is to set quiet as true, but it will quiet \"all warning\". I think it's inappropriate.\nTherefore, I think write the filter to distinguish es5 files and es6 files is needed. I'll try a cleaner method to do it.. So the main different lint setting of ES6 and ESnext is we turn off comma-dangle rule at es6?\nCurrently, I can't find other different of ESnext and ES6 config.. OK, so there are some files in scripts should be ignored.\nLike: \n/scripts/flow/environment.js\n/scripts/rollup/shims/react-native/NativeMethodsMixin.js. It's my fault. On previous commit, I was uncareful to ignore benchmark, so it ran prettier on those files.\nI've reverted it on latest commit.. Cause this files scripts/release/build-commands/parse-build-parameters.js use this syntax.\nSo we don't allow this syntax?. I think that's because our devEngines is required node v8.x, so this syntax works.. ok. ok, I'll revert it.. I think remove the scripts in ignore will cause other issues. Some patterns are covered (like 'scripts/flow/*.js') will run on both prettier process.\nBecause we run prettier twice (default -> scripts), the results seem work as our expect, but actually some changes on default prettier is covered by scripts prettier.\nMaybe we can expand the scripts pattern to make it more clear?\nconst nodePath = [\n  'scripts/babel/*.js',\n  'scripts/circleci/*.js',\n  'scripts/error-codes/*.js',\n  ...\n];\n. You're welcome. Thanks for your patience.. ",
    "magicmark": "Should number be allowed?. Ah...\n```\n\ntypeof ({}).toString\n'function'\n```\n\n@gaearon good catch, could refactor to use .hasOwnProperty? :)\n```\n\n({}).hasOwnProperty('toString')\nfalse\n``\n  . Hmm yeah, so maybe back to square 1? Just check for an object, with a check for the existence oftoStringfor corner cases likeObject.create(null)`?. \n",
    "watadarkstar": "Done. Done. @gaearon  Just so I understand. I am doing the following twice which should fire the warning twice:\nhtml\n<option selected={true} />\n<option selected={true} />\nAnd so isn't this testing for deduplication of the warning?. Sounds good. Woah good catch!. ",
    "XaveScor": "Because type of polyfilled Symbol is object. This check cannot catch this situation.. Oh, thanks. I am so stupid.. ",
    "yenshih": "Yeah you're right. For now, ${callerName}_${JSON.stringify(callback)} is the key of didWarnOnInvalidCallback.. Shall I close this pull request due to no response? @gaearon . @gaearon If we remove JSON.stringify, {foo: 'bar'} and new Foo() will be coerced to the same string [object Object]. Shall we just remove the toWarnDev test cases about new Foo()?. @gaearon Seems all things are done in the new commit :). ",
    "orta": "Yep \ud83d\udc4d . Ah yeah! \nSure, (I've been hacking on this slowly over the last two days) I am a bit surprised by the build failures but I think this is pretty much good to go once those are figured. Done \ud83d\udc4d . I agree, it should be gitignored \ud83d\udc4d \nI'm about to head into a meeting but I'll gonna take a look into why the results I'm seeing locally are different in general, maybe a node_modules introduced by Danger changes the results?. Yes, definitely, thanks!. Sure, I can remove it again. \nCurrently, it compares the new package against a non existent one in the previous results json and says how it is infinitely bigger (that was the message from last night) - which is true strictly speaking. I've added some protection for that \ud83d\udc4d \n. Yeah, I initially thought when looking at that code that a different version of those libs could slip through the net and not raise a warning. But you're right, the highlights are specifically for the prod user-facing builds, so I've reverted the change. ",
    "azz": "This file has since been removed from Jest.. Passing in the path explicitly avoids looking up the FS tree for each file.. Are we ok with top-level return? I could change it to process.exit().. ",
    "vikramcse": "I am able to get _hasSuppressedError property in ReactFiberScheduler.js and checked for the error, but in ReactFiberErrorLogger.js how do I get _hasSuppressedError property, as we have not imported ReactErrorUtils.js?\nwhat I am thinking is to add a new property hasSuppressedError in  capturedError object \njavascript\nconst capturedError = {\n        componentName,\n        componentStack,\n        error,\n        errorBoundary: errorBoundaryFound ? boundary.stateNode : null,\n        errorBoundaryFound,\n        errorBoundaryName,\n        willRetry,\n        hasSuppressedError,\n      };\nso that hasSuppressedError can be found on ReactFiberErrorLogger.js.\nis this a right approach?\n  . I did not understand!\nIn order to clear the ReactErrorUtils._hasSuppressedError we need to check the suppress error exist or not.so count this as a _caughtError I need to set ReactErrorUtils._hasCaughtError true\njavascript\nif (shouldIgnoreError && error != null) {\n        this._hasSuppressedError = true;\n        this._hasCaughtError = true;\n        this._caughtError = error;\n      }\n  . also one of the test case if failing resets instance variables before unmounting failed node test is failing saying Expected test not to call console.error().\nam i missing something?\n```javascript\nExpected test not to call console.error().\nIf the warning is expected, test for it explicitly by:\n1. Using the .toWarnDev() / .toLowPriorityWarnDev() matchers, or...\n2. Mock it out using spyOnDev(console, 'error') or spyOnProd(console, 'error'), and test that the warning occurs.\n\nThe above error occurred in the <Foo> component:\n    in Foo (at ReactIncrementalErrorLogging-test.internal.js:229)\n    in ErrorBoundary (at ReactIncrementalErrorLogging-test.internal.js:228)\n\nReact will try to recreate this component tree from scratch using the error boundary you provided, ErrorBoundary.\n    at CustomConsole.newMethod [as error] (/home/vikram/code/javascript/oss/react/scripts/jest/setupTests.js:70:19)\n    at logCapturedError (/home/vikram/code/javascript/oss/react/packages/react-reconciler/src/ReactFiberErrorLogger.js:68:13)\n    at captureError (/home/vikram/code/javascript/oss/react/packages/react-reconciler/src/ReactFiberScheduler.js:1017:53)\n    at renderRoot (/home/vikram/code/javascript/oss/react/packages/react-reconciler/src/ReactFiberScheduler.js:841:22)\n    at performWorkOnRoot (/home/vikram/code/javascript/oss/react/packages/react-reconciler/src/ReactFiberScheduler.js:1607:24)\n    at performWork (/home/vikram/code/javascript/oss/react/packages/react-reconciler/src/ReactFiberScheduler.js:1517:7)\n    at performAsyncWork (/home/vikram/code/javascript/oss/react/packages/react-reconciler/src/ReactFiberScheduler.js:1495:5)\n    at flushUnitsOfWork (/home/vikram/code/javascript/oss/react/packages/react-noop-renderer/src/ReactNoop.js:292:5)\n    at flushUnitsOfWork.next (<anonymous>)\n    at Object.flushUnitsOfWork (/home/vikram/code/javascript/oss/react/packages/react-noop-renderer/src/ReactNoop.js:421:129)\n\n  at Object.<anonymous> (scripts/jest/setupTests.js:114:15)\n\n``\n  . In out test cases we need to callpreventDefaultwhen any component throws error intentionally,\nbut I am not able to figure out how to add a error event handler inJestas windowobject is not there.. For example [test](https://github.com/facebook/react/blob/master/packages/react-test-renderer/src/__tests__/ReactTestRenderer-test.js#L398-L457)  inReactTestRenderer-test.jsfailing. with an errorExpected test not to call console.error().To overcome this error we need to create an error handler and callprevent default` so that out handleSuppressError logic gets executed.\nHere is an example and what I am thinking to add event handler in the test. But we can not do this because as window object is not available in jsdom.\nis there any alternative to setup an error handler?\n. In the past comments you mentioned (for writing unit test):\nInstead we can try changing the expect().toThrow() Jest matcher to set up an 'error' handler that does preventDefault(). Or figure out some other way to avoid failing all tests that intentionally throw an error.\nI am not able to figure out how to implement this, can you give me some clue?. we have added below code in  setupEnvironment.js so that, when an error (intentionally) is thrown in our tests it will call preventDefault and eventually out handleSuppress logic will get called.\njavascript\nif (typeof window !== 'undefined') {\n  window.addEventListener('error', event => {\n    if (event.error != null) {\n      event.preventDefault();\n    }\n  });\nBut at the time of debugging in this setupEnvironment.js the eventListnener is not added because window object is undefined.\n\nIs this  setupEnvironment.js file get used while running tests?\nWhy I am not able to get window object?\n. File ReactTestRenderer.js file has the @jest-environment node flag.  It means at the time of initialization setupEnvironment the window object is not available and therefore eventListnener is not initialized.\n\nin which below test is failing.\n```javascript\nit('supports error boundaries', () => {\n    const log = [];\n    class Angry extends React.Component {\n      render() {\n        log.push('Angry render');\n        throw new Error('Please, do not render me.');\n      }\n      componentDidMount() {\n        log.push('Angry componentDidMount');\n      }\n      componentWillUnmount() {\n        log.push('Angry componentWillUnmount');\n      }\n    }\nclass Boundary extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {error: false};\n  }\n  render() {\n    log.push('Boundary render');\n    if (!this.state.error) {\n      return (\n        <div>\n          <button onClick={this.onClick}>ClickMe</button>\n          <Angry />\n        </div>\n      );\n    } else {\n      return <div>Happy Birthday!</div>;\n    }\n  }\n  componentDidMount() {\n    log.push('Boundary componentDidMount');\n  }\n  componentWillUnmount() {\n    log.push('Boundary componentWillUnmount');\n  }\n  onClick() {\n    /* do nothing */\n  }\n  componentDidCatch() {\n    this.setState({error: true});\n  }\n}\n\nconst renderer = ReactTestRenderer.create(<Boundary />);\nexpect(renderer.toJSON()).toEqual({\n  type: 'div',\n  props: {},\n  children: ['Happy Birthday!'],\n});\nexpect(log).toEqual([\n  'Boundary render',\n  'Angry render',\n  'Boundary componentDidMount',\n  'Boundary render',\n]);\n\n});\n```\nerror:\n```javascript\nExpected test not to call console.error().\nIf the warning is expected, test for it explicitly by:\n1. Using the .toWarnDev() / .toLowPriorityWarnDev() matchers, or...\n2. Mock it out using spyOnDev(console, 'error') or spyOnProd(console, 'error'), and test that the warning occurs.\n\nThe above error occurred in the <Foo> component:\n    in Foo (at ReactIncrementalErrorLogging-test.internal.js:229)\n    in ErrorBoundary (at ReactIncrementalErrorLogging-test.internal.js:228)\n\nReact will try to recreate this component tree from scratch using the error boundary you provided, ErrorBoundary.\n    at CustomConsole.newMethod [as error] (/home/vikram/code/javascript/oss/react/scripts/jest/setupTests.js:70:19)\n    at logCapturedError (/home/vikram/code/javascript/oss/react/packages/react-reconciler/src/ReactFiberErrorLogger.js:68:13)\n    at captureError (/home/vikram/code/javascript/oss/react/packages/react-reconciler/src/ReactFiberScheduler.js:1017:53)\n    at renderRoot (/home/vikram/code/javascript/oss/react/packages/react-reconciler/src/ReactFiberScheduler.js:841:22)\n    at performWorkOnRoot (/home/vikram/code/javascript/oss/react/packages/react-reconciler/src/ReactFiberScheduler.js:1607:24)\n    at performWork (/home/vikram/code/javascript/oss/react/packages/react-reconciler/src/ReactFiberScheduler.js:1517:7)\n    at performAsyncWork (/home/vikram/code/javascript/oss/react/packages/react-reconciler/src/ReactFiberScheduler.js:1495:5)\n    at flushUnitsOfWork (/home/vikram/code/javascript/oss/react/packages/react-noop-renderer/src/ReactNoop.js:292:5)\n    at flushUnitsOfWork.next (<anonymous>)\n    at Object.flushUnitsOfWork (/home/vikram/code/javascript/oss/react/packages/react-noop-renderer/src/ReactNoop.js:421:129)\n\n  at Object.<anonymous> (scripts/jest/setupTests.js:114:15)\n\nExpected result would be error should not be printed in the console.javascript\nfunction onError(event) {\n        error = event.error;\n        didSetError = true;\n        if (error === null && event.colno === 0 && event.lineno === 0) {\n          isCrossOriginError = true;\n        }\n        if (event.defaultPrevented) {\n          shouldIgnoreError = true;\n        }\n      }\n``\nI checked the reason it's happening because ininvokeGuardedCallback.jstheonError(above) function is not called so theshouldIgnoreErrorflag remainsfalse.\nDoes this problem trace sounds good?. By addingexpect(...).toWarnDev()` the tests are now passing  on my machine :)\nbut somehow the test-prod is failing in CI. ",
    "wyze": "I added that to make Flow happy, but your solution is better. I should do the same default on the server side warning too, correct?. Yes I had the hacky reservation while making the change. I\u2019m open to changing the shared function to just accept the type or I can close this PR. Doesn\u2019t bother me either way, just let me know how you want to proceed. . ",
    "chrisdieckhaus": "I\u2019m not entirely sure how to deal with a Shadow DOM in the test fixtures. I\u2019ll look into it. . So whenever I go with that sort of an implementation, I get the following error when it tries to render the shadow element:\nTypeError: Failed to construct 'HTMLElement': Please use the 'new' operator, this DOM object constructor cannot be called as a function.\nIt seems like custom elements are not compatible with ES5 style classes. I'm able to get it working with their suggested solution, native-shim.js. Is this something we'd be able to include in react? Or should we be looking for a different solution to this?. @nhunzaker thoughts on this?. ",
    "rickhanlonii": "@gaearon this was added in your commit here, do you happen to remember why it is necessary? I didn't see anything throwing without it. Passed locally, let's see if it fails in CI. jsdom added localhost as a default hostname. The error matcher string changed, we no longer have the \"Expected value to equal\" text at the top of error outputs (shoutout to @pedrottimark). We changed this setting to allow multiple files and name it something that makes more sense (shoutout to @ddruker) . ",
    "banga": "This is only needed for the node bundles because the contents of fbjs are not included in those bundles, so properties like emptyFunction.thatReturns get renamed when they shouldn't be. I also remember hitting a problem with canUseDOM not being set to true when it should be, but I can't repro that right now. I was being defensive when I created this file by including everything from fbjs that I saw being used, but we can cut it down to a smaller set of things if that would be preferable.. Forgot to mention \u2014 this file is not pulled in for UMD bundles, because fbjs is not part of externals for those, which are checked in getClosureExterns to determine which externs files to look for.. ",
    "vldvel": "Ohh, got it! Thanks for feedback. And what about object arguments and destructuring should I merge them?. ",
    "clairecliu": "Thanks. I have revised the codes per your comments.. ",
    "billyjanitsch": "Done :). ",
    "arcanis": "Updated the typing (commit data referenced as CD), it seems to pass the flow test. I'd have expected to have to add an any into a generic type instantiation somewhere, but Flow seems able to infer it?. Since I don't use it in my renderer at the moment I removed the commit data from this PR, I'll open a new one when I'll reach the point where it is needed :). Done \ud83d\udc4d \nfwiw devDependencies on workspace top-level aren't really useful, since workspaces are typically always installed on development environment (we do however respect them, so if you run yarn --production from the root, we won't install them, which will make your scripts unusable).\n. ",
    "batjko": "Sounds like the worst possible reason for a change in a project with more than one developer.. ",
    "burimshala": "I think the else in the end is unnecessary. You can simply return null. Also I'd suggest to refactor this into another functions because of readability.. Maybe there is a way to refactor this so you don't have almost the same implementation as in https://github.com/acdlite/react/blob/0276eb5c5b27ea6ac251c42bd83211c7d486ab16/packages/react-reconciler/src/ReactFiberNewContext.js. ",
    "spirosikmd": "I was in doubt about the implementation. Thanks for the guideline!. I will add a comment containing the link as well. As far as I can see we are only using the selectionStart and selectionEnd in the code. So I guess we match up with these two rows.. ",
    "cramaechi": "Hmmm... You're right. But according to the docs,  if the HTML contents of the element that is passed to hydrate() is rendered by renderToString(), a data-reactroot attribute is created automatically, is it not?. Doc: https://reactjs.org/docs/react-dom-server.html#rendertostaticmarkup. Hi @aweary - That makes perfect sense.\nAnd thank you for the much needed, detailed explanation!\nI will go ahead and make the changes.. @aweary - To detect the root element, would checking the node type of the element work?\nI ask this because if div is a root element in your example, would it actually qualify as a document node?. ",
    "phistuck": "While there is some value in having a clearly defined API somewhere (which can also be used as an externs file for other project, even better if it had type annotations), why are you not using the @expose annotation instead?. ",
    "Yiin": "Can someone explain this syntax please?. Thanks!. ",
    "stipsan": "It's probably because @acdlite redacted LoadingComponent to keep us in suspense until @gaearon's talk \ud83e\udd2b. ",
    "sompylasar": "@acdlite Hi,\nThis PR is about showing a nice DOM diff and a component stack in the hydration mismatch warnings for developers.\nTo implement the diff I had to add two additional arguments 1) index: number and 2) isReplaced: boolean to the ReactFiberReconciler's didNotFindHydratable* methods to pass down to the warning-generating functions 1) the index of the child node that's being hydrated within the parent node's hydratable children and 2) the fact that it's being replaced or inserted.\nThe index is required to show the minus/plus diff prefix at the correct line when looping through the parent node's hydratable children while constructing the diff.\nThe isReplaced fact is required to not add the minus diff prefix when the preceding sibling node was not in fact removed during hydration.\nExample warning when the <p> element did not match and was replaced with the <div> element (isReplaced: true):\nWarning: Expected server HTML to contain a matching <div>{['children ', \u2026]}</div>\n in <div>nested<!-- --> <p>children <b>text</b></p></div>.\n  <div>\n    {'nested'}\n    {' '}\n-   <p>children <b>text</b></p>\n+   <div>{['children ', \u2026]}</div>\n  </div>\n    in div (at **)\n    in Component (at **)\nExample warning when the <p> element did match thus not removed/replaced, the <div> element was added (isReplaced: false):\nWarning: Expected server HTML to contain a matching <div>{['children ', \u2026]}</div>\n in <div>nested<!-- --> <p>children <b>text</b></p></div>.\n  <div>\n    {'nested'}\n    {' '}\n    <p>children <b>text</b></p>\n+   <div>{['children ', \u2026]}</div>\n  </div>\n    in div (at **)\n    in Component (at **)\nCould you please approve this change or recommend another direction?\nThank you.. Yes, I'd love to hear some thoughts from the React team how you'd like the TODOs to be resolved, as solutions vary in volume and complexity.. Okay, yes, to simplify I'll replace with three ASCII dots.. Will do. It was not clear for mr whether it should be committed or not, so I decided to make sure every commit that changes the build has this file on par. Is there any note about this file in the contribution guidelines? I didn't find.. RE: displaying special characters in quotes, the braindump:\n1. There are two contexts where quoted strings appear: HTML and JS/JSX.\n2. In HTML, the special characters are escaped with &mnemonic; and &#hexnumber; sequences. The implementation of such display may vary from writing a function that prints the char codes, or reusing the browser implementation via set innerHTML/get innerText on an off-screen DOM node.\n3. In JavaScript, the special characters are escaped with a backslash and a mnemonic or a number. The implementation may vary from implementing the escaping in code for certain characters to reusing JSON.stringify. The latter generates double-quoted strings whereas React's JavaScript style uses single quotes, and there's no standard \"JavaScript.stringify\" function.\n4. Given the above adds some complexity around displaying values on the console, the other solution would be to dump the values as they are.\n5. React already prints some values to the console, what is the pattern to do that? Which utility functions are used?. 6. The above thoughts assume that we want to display the values as convenient for the developer looking at the warning as possible, so that they were familiar with the value and could resolve the issue/find it easily.. Is the committed rollup/results.json still used somewhere, or you would accept a separate PR ripping it out of the build process or just removing and gitignoring it to avoid future confusion?. See \ud83d\udc49 https://github.com/facebook/react/pull/12063/commits/e085f69436485b2f134e670da99edf0cbd222e00 for a couple of examples that came to mind.\nI could also add a pack of unit tests for these functions specifically, but I wonder if these functions are to be extracted into files, how would you prefer to lay out the files and how to import/require them, and what about having tests that do not use the public API.. Done during rebase to latest fasebook/master.. Done during rebase to latest fasebook/master.. I'm not talking about Jest, I'm talking about showing a warning with invalid syntax to the developers, e.g.\n<div data-attr=\"\"many\"\"\"\"unescaped\"\"quotes\"\"\"\"><<<<<<looks like a tag but it's not, it's text content>>>>></div>\nMaybe it's an edge case, but I'm trying to think about these as well.. Oh sorry you mean how Jest escapes the values \u2014 these special chars like tab and newline were printed verbatim, unescaped.. But the special chars within \"expected\" and \"received\" strings are, contrary to our case, not printed in a JavaScript/JSX or HTML context (like within quotes or tags), they are printed on separate lines without any delimiters. See screenshots below where I added FOOBAR to make the tests fail:\n\n\n. Here's what Jest does in their jest-matcher-utils package:\njs\nexport const printReceived = (object: any) =>\n  RECEIVED_COLOR(highlightTrailingWhitespace(stringify(object)));\nexport const printExpected = (value: any) =>\n  EXPECTED_COLOR(highlightTrailingWhitespace(stringify(value)));\nWithin stringify they use pretty-format library with plugins for DOM and React element printing \u2013 this library goes extra mile to make the output beautiful \u2013 including using their own escapeHTML function, as well as many functions to print HTML-like tags.\nThe more I look at this pretty-format/src/plugins/lib/markup.js file, the more it resembles what I wrote here by hand, but without the diff part (the plus and minus prefixes on certain lines). I'd love to reuse something from there, but this will require react to depend on pretty-format which I don't think would be a good idea.\nBy the way, they use the unicode ellipsis \u2026 in printElementAsLeaf.. All right, thank you, this is exactly what I asked about when I just started because this assumption about fiber.index was the foundation for the diff display.. Here's the failing test I could come up with where the indexes are off. https://github.com/facebook/react/pull/12063/commits/7d6bbdef4086736c0461ce734b0bba460d96f0eb\n. \nYes, I saw the traversal variant with writing into the return pointers but I thought it would be unsafe to modify the structure owned and maintained by another piece of code. If return pointers are only used during one traversal and their previous state is not relied upon, I can rewrite to use them instead of the stack.\nSaid that, this traversal is not performance-critical as it happens only in development mode and only when hydration failed.. Yes I just had this thought, too, while drawing the diagram. Should it not have children by definition though?. Okay, I think I got it: if a HostComponent is e.g. a div, it may have children. Then we should only count children-less HostComponents and HostTexts.. Yes, you're right. I assumed we need to count leaf host nodes, but in fact we need to count only the parent's immediate children host nodes. Thanks for the repro test case.. > Naming of these options is confusing. It basically means \"still allow to rely on function hoisting, and don't complain about variables unless they are in the same scope\".\nIf .eslintrc.js is a .js would it make sense to put this explanation in a comment next to the added option?. Here and below I fixed the test code to match the test title:\n- 'should warn if mounting into left padded rendered markup' \u2013 the padding (the space) on the left, renderToString output on the right (was the opposite)\n- 'should warn if mounting into right padded rendered markup' \u2013 the padding (the space) on the right, renderToString output on the left (was the opposite)\n. Changes to the diff printer compared to PR #12063:\n1) always prints elements with no children as self-closing, assuming the diff output is renderer-agnostic and is presented in JSX-like syntax, not in the underlying HTML syntax; previously the diff printer had access to omittedCloseTags from react-dom, now the diff printer is renderer-agnostic so cannot rely on that.\n2) applies some logic to determine if plain strings should be printed in curly braces and quotes, or as plain text (see printChildrenValue and shouldPrintStringAsRawUnescapedText in ReactFiberHydrationWarning.js) to produce more natural, less cluttered output.\nNo change:\n- the HTML comment nodes and other non-hydratable host nodes are still printed out to add more context to the diff (react-reconciler asks react-dom to print them via a ReactDOMHostConfig function); this is debatable, you may want to remove them to make the output JSX-only, and simplify some code.. Change to the warning message compared to PR #12063:\n- the values are not converted to strings before being printed with JSON.stringify, so they no longer appear in quotes if they are not strings. TODO: Print the attribute names array nicer, with a space after comma. Now the default array toString is used implicitly.. I decided to always print the top-level plain text children as strings in curly braces, but this can be changed with a single boolean flip, see printElementOrTextForHydrationDiff.. Here I test that the HTML comment is printed the same way it would've been written in the original markup, &gt; ensures the HTML comment is not ended prematurely.. Same as for HTML comments, but for other non-hydratable nodes, escape the > with &gt; in the diff.. TODO: Currently, the special characters in the JSX string output are not escaped, the output looks invalid.\nDespite there's code that should escape them (escapeNonPrintableCharacters). Need to look into it once again.. The special logic for the plain versus quoted strings triggered here: the <span> contains text that contains < and >, the characters that are special in the JSX markup, so they need to be escaped (quoted in a JavaScript string, wrapped in curly braces).. The special logic for the plain versus quoted strings triggered here: the data-ssr-mismatch-attribute-with-special-characters attribute contains the double quote \" which is special in the JSX attribute markup, so it needs to be escaped (quoted in a JavaScript string, wrapped in curly braces).. Here both texts in the warning are added to the test. They are printed as quoted strings, the result of JSON.stringify.. Here react-dom ReactDOMComponent imports from react-reconciler to issue specific warnings not covered within the reconciler itself.. Looks like there was a typo here.. The suppressHydrationWarning variable was file-level for some reason, not function-level, so it may have affected functions unrelated to this function call. Now its expression rawProps[SUPPRESS_HYDRATION_WARNING] === true is only used in one place within this function, so the variable was removed.. Now the check for rawProps[SUPPRESS_HYDRATION_WARNING] === true is performed within didNotMatchHydratedChildrenPropValue and similar functions provided by react-reconciler ReactFiberHydrationWarning, so no need to check it here. Still checking __DEV__ to ensure this call is not bundled into production build.. We still need to check rawProps[SUPPRESS_HYDRATION_WARNING] === true here as per the comment, to skip the heavy comparison code below if the warning was suppressed.. This (domElement: any) typecasting is ugly, but it was required to convince Flow that Element is compatible with Instance when typechecking with renderers other than dom, such as yarn flow native, where react-dom should not be used at all, but alas it's still typechecked.. This normalizeHTMLTextOrAttributeValue function is used in ReactDOMHostConfig, so exporting it here. It's not a function declaration because the function implementation gets substituted in __DEV__.. The new type HostInstance means all possible host node types (like comment nodes and other non-hydratable nodes) that the hydration process can potentially meet during its DOM traversal, not just Element (Instance) and Text (TextInstance).\n\n\u2753I still haven't figured out how to make yarn flow custom typecheck succeed. The assumption is that HostInstance is at least a union of HydratableInstance | Container, but there is no strict guarantee that it is defined like that. Please advice, this is the only remaining thing that fails in CI now. \u2753. This instance printing code happened to be more complex than I expected, but this all for the sake of beautiful and natural-looking diffs.. > TODO: Currently, the special characters in the JSX string output are not escaped, the output looks invalid.\n\nDespite there's code that should escape them (escapeNonPrintableCharacters). Need to look into it once again.\n\nFixed in https://github.com/facebook/react/pull/13602/commits/c0b778097f0af2c950e8de5bac3abb244e195a08. > TODO: Print the attribute names array nicer, with a space after comma. Now the default array toString is used implicitly.\nFixed in https://github.com/facebook/react/pull/13602/commits/9c8093f3516b695239620d128420e9870ec96787. Refactored this flag to be an enum value, PRINT_CHILDREN_VALUE_MODE_DEFAULT or PRINT_CHILDREN_VALUE_MODE_RAW (see getHydrationDiff).. > The new type HostInstance means all possible host node types (like comment nodes and other non-hydratable nodes) that the hydration process can potentially meet during its DOM traversal, not just Element (Instance) and Text (TextInstance).\n\n\n\u2753I still haven't figured out how to make yarn flow custom typecheck succeed. The assumption is that HostInstance is at least a union of HydratableInstance | Container, but there is no strict guarantee that it is defined like that. Please advice, this is the only remaining thing that fails in CI now. \u2753\n\nI decided to simplify the code and remove printing of non-hydratable nodes. This refactor resulted in removing HostInstance type as unnecessary, and removing HydratableInstance type (inlining the alias). See https://github.com/facebook/react/pull/13602/commits/3ad9c5ff4fcc385ba62689bab9d0c423b944185f description for details.. > Without the component stack here because it's empty: rendering a text node directly into the root node\nA thought came to me here: why doesn't React show in the stack the place where the render or hydrate was called? This would be 1) consistent, there'd always be a stack; 2) useful for apps with multiple render entry points.\n. Note to self: conflict with https://github.com/sebmarkbage/react/blob/2bdd79afe07a96792b401bee06b4a6d7c073dfe5/packages/react-dom/src/client/ReactDOMHostConfig.js . ",
    "hartzis": "cool! absolutely, good clarification. ",
    "raunofreiberg": "Use const over let.. Typo: pefomance => performance.. Why was this changed? The comment above no longer reflects the actual code. Aren't we concerned about IE8/9 anymore? If not, then the comment should also be updated, I guess.. I'm no expert here, but since this is already a let, wouldn't using an if else block instead of the ternary below make this easier to digest?. Is the use of  != as opposed to !== intended here? If so, why? Thanks.. Just a small nit: it would probably be a better idea to pass A component instead of Unknown if no component name is found.\nYour example:\nIt looks like the Unknown component contains a line ...\nThis formatting seems quite odd to me. What the Unknown component? What if I in a rare case I have my own Unknown component and it's not the erroring one?\nSuggestion:\nA component contains a line ...\nor if the component name exists\nFoo contains a line like this...\nThis would also keep the handling of missing component names in error messages consistent. See: ReactFiberTreeReflection.js, ReactDOM.js. I guess you could use ES6 imports instead since the former ones do?. I decided to remove this since the shouldRemoveAttributeWithWarning function already duplicates this logic internally.. I agree, but wouldn't we then be committing unwanted attributes to the DOM?. Running the tests added in this PR were failing unless I ran resetModules before each. \n\nAlthough running them 1 by 1 via fit seemed to fix the issue.. Sorry, should've been more thorough. I've added this comment as a reminder for future references once this PR is good to go. Currently there are no warnings for reserved props in React and hence the TODOs in @nhunzaker's PR and this one :-). Ah, you're right. This has to be a mistake. I took influence from ReactDOMFiberInput and the files got oddly similar under cognitive load.\nInstead, it can simply be getSafeValue(initialValue), I think :-)\nThanks!. initialValue already references props.value on L:83 so this logic is redundant.. Btw, thanks for the feedback. I really appreciate it \ud83d\ude42. I have a question about this change - could someone please be more specific about which cases require the casting done previously ('' + value) and what exactly breaks by removing it from here and the previous lines?. I went ahead and uncommented defaultValue from the list of reserved properties and a few test suites started to fail in a similar manner (for e.g, ReactDOMServerIntegrationForms), confirming what I was expecting.\nE.g.\n\nThis seems to only affect SSR, client side cases seem to pass, for e.g:\nconst div = document.createElement('div');\nconst node = ReactDOM.render(<textarea defaultValue=\"1\" />, div);\nexpect(node.getAttribute('defaultValue')).toBe(null);\nI'm not too certain nor familiar with how strict we want to be about reserved properties (committing them to the DOM is definitely out of the question, I would assume). \nMaybe we can keep the attribute reserved as is, but instead add another key to PropertyInfo (e.g. boolean shouldWarnInDev) to enable warnings for custom properties. This way the condition that you mentioned above would become:\nif (\n  propertyInfo !== null &&\n  propertyInfo.type === RESERVED &&\n  !propertyInfo.shouldWarnInDev\n) {\n  return false;\n}\nAlso, enabling warnings for other reserved properties would be a breeze this way, IMHO :-). I've added a proof of concept commit to illustrate my approach better.. That does make sense to me. Is there a particular reason though why the casting is done by concatenation instead of e.g. String(value)? Because with Symbols it produces a TypeError when trying to concat a Symbol and a string.\nMoreover, if a textarea receives for i.e a function as its value and we concat it into a string, then getSafeValue would fail its check and append it as a valid value.. Maybe we could add a similar check like in ReactDOMFiberInput?. Just pushed my changes - I hope they make sense and I took the right approach :-). Can we just do safeValueToString(node._wrapperState.initialValue) instead here?. Hm, right. Would it make more sense if the comparison was props.value !== node.value and use getSafeValue for const newValue?. Gotcha. Pushed a change with regards to this.. Should we stringify here as well, just to be safe?. Sure, I'll change it. I found it odd as well initially, but figured I'd be better off leaving it. \ud83e\udd37. You're right, this does seem redundant. Removed it, thanks!. Since ToStringValue is an opaque type I wasn't sure what to do here.. This seemed to be a additional case that I found failing before this PR. I don't know if this is the best way to test it, though.. Actually, this case is probably fine as is, since the browser defaults to using the element's children as a value if the attribute value is not provided.\n```\n\nhi\n\nconsole.log(document.getElementById('test').value) // 'hi'\n``. Maybe useconst` \ud83d\ude42?. That's a good point. I'll try and play around with it and see what I find out \ud83d\ude42Feel free to report an issue, regardless.. What about passing a function as a value? Should we test that here as well?\nAlso, defaultValue?. Makes sense.. ReactLazy sets the status to -1, not sure about this.. Didn't seem worth keeping this file Flow typed just to have a void return :D. This didn't seem to resolve after adding the annotation. \u00af_(\u30c4)_/\u00af. I don't know. Your tests, you tell me :-)\nIn all seriousness, it seems like because of the shallowEqual function which seems like was just copied into the test suite for some reason and (in)conveniently just included types. Could probably just use the one at packages/shared/shallowEqual.js instead?. Can we maybe reduce it to just ReactDebugCurrentFrame ? ReactDebugCurrentFrame.getStackAddendum() : '', since ReactDebugCurrentFrame only exists in dev anyway?. Redundant async?. ",
    "kassens": "Value could be undefined here if props.source is. Should probably be Value | void? Would be nice if the flow type could reflect that Value is always set for the case that the subscription can provide that and the source is non-nullable.. This type is more accurately\nvalue: Value | void\nas the key always exists, but the value might be undefined.. I think this should be Value | void for the case that getValue() returns undefined for the initial render or if source is null.. ",
    "Deraen": "So the Set should not be used as it might not work on IE11? Okay. I can easily change this to dynamically built object which should also work.. Oh right. I forgot how JS objects work.\nI think I'm out of ideas for fixing #12368 here. I'll check on Closure side if it can be made to understand hasOwnProperty as dynamic access so it can keep the properties like with bracket access.. Related to #12368 #12370 #12530\nThis RESERVED_PROPS change is no longer required because Closure-compiler was fixed to not collapse properties of objects which are accessed using hasOwnProperty: https://github.com/google/closure-compiler/commit/c13cf48b98477e44409dba6359246bffa95b1c7b\nThis fix is included in release v20180319\nBased on discussions on the mentioned PR's I think the change should be reverted.. ",
    "zyy7259": "I'm trying to understand the logic here. Could somebody tell what \"detach\" means here?. Thanks for the explanation. ",
    "barrymichaeldoyle": "Even better, I'll update the PR.. ",
    "timneutkens": "@bvaughn Reacte is a typo right \ud83e\udd14. ",
    "antsmartian": "Yup sure, make sense. . ",
    "Swieckowski": "Thanks a lot for the review, I'll get on it sometime soon!. ",
    "getaaron": "How about we skip the verb entirely?\n\"If your component starts with a lowercase letter, make it uppercase.\". ",
    "halftrue": "Maybe a test by comparing assignFiberPropertiesInDEV and Object.assgin's results could be better.. ",
    "KatSick": "Typo in Retore word. Probably you mean Restore.. ",
    "FOODy": "Duplicate line. ;-). ",
    "nicolevy": "Yeah that\u2019s really cool, I\u2019ll put that in there. Yes it\u2019s basically a cannot read property \u2018props\u2019 of undefined/null problem where it tries to copy the props of the original element I think. So it should explicitly check if element is null or element is undefined and throw a specific error for each of those cases?. Ah right yes, because the type conversion will catch undefined \ud83d\udc4d . @gaearon okay gotcha, reverted that.\n@aweary I can look into switching some over in a PR maybe? That should be pretty straightforward and I would love the opportunity to get more familiar with the codebase.. @aweary hmmm okay, I\u2019ll wait until a decision is made before I start on that then.. Okay thanks that\u2019s cool, I\u2019m going to read up on how invariant works for the future for sure. I\u2019m also going to look at writing some tests.\nAlso wanted to ask if you have any input on this thread: https://github.com/facebook/react/pull/12534#pullrequestreview-109914109. Done!. Ahhhh I meant to do this after I was done testing it and completely forgot, I\u2019ll get on that tonight!. I\u2019m having a bit of trouble finding an example of this in the tests. Potentially just not sure what I\u2019m looking for. Do you know of one that uses this?. Ah yes gotcha \ud83d\udc4d . Good now!. ",
    "marionebl": "The test case fails without the other changes in this PR. typeof nativeEvent.composedPath === \"function\" should do the trick?. ",
    "gnapse": "This whole + block in the diff is duplicating a huge section of the README.. I thought the same too, but not being a native English speaker made me doubt.. ",
    "philipp-spiess": "Ugh. Thanks for pointing that out. Should I just create the nested array structure and loop over it to set the props then or do you have a util function for that? :). Those methods have been used by the responder plugin and a dependency of the responder and were thus added in the events/ shared package. Since don't have the top level types for DOM here anymore, those were removed.. TopLevelTypes now need to be injected into ResponderEventPlugin to work. We can use those to create the necessary helper functions.. ResponderTouchHistoryStore is also depending on the helper functions that require knowledge of the event type identifiers. To solve this, I've made them injectable as well. \nAlternatively, I could have imported this module from ResponderTouchHistoryStore as well and exported those functions creating a circular reference. Let me know if you prefer this or if you have better ideas ;). It seems wrong to add private API to this unit test that works perfectly against public API. Should we perhaps export DOMTopLevelEventTypes as part of the ReactTestUtils?\nOn the other hand using ReactTestUtils.simulateNativeEventOnNode is not something we should encourage and we could completely avoid exposing the top level event types mapping if we don't.. Sure! Should we follow the same pattern for ResponderTouchHistoryStore?\njs\ncreateResponderTouchHistoryStore(EventUtils);\nWe can keep it in the closure of createResponderEventPlugin(TopLevelTypes) forever since it seems that RNW no longer depends on it (and that appears to have been the only reason why it's added as an export to ReactDOMUnstableNativeDependencies).. Can we do this as a follow-up? . We can, but then we would have to return both the ResponderEventPlugin and the ResponderTouchHistoryStore from this function since the latter is also exported in ReactDOMUnstableNativeDependencies. \nOn the other hand, when we'd do this we could directly inject the helper functions and only have them twice instead of three times \ud83d\ude43 . Yeah seems to work but it becomes a bit ugly because I have to force-cast (((x: any): OpaqueType) in the two places where I create TopLevelType out of thin air. \nLet me push the commit so you can see.. > Do you have ideas on how to measure the effect of this change?\nNot really. One approach is probably to create a new benchmark example that fires random events - but that seems like a lot of work to get right. I'm also not sure how \"realistic\" that would be.\nI tried to get an idea about this problem by running some micro benchmarks in Chrome, Firefox, Safari, IE11, and Edge: https://esbench.com/bench/5ade7596f2949800a0f61a8b\nSeems like there's a huge variance across different browsers. The slow number lookup of a Map in Edge might be an issue.\n. > Just an idea: since we have to map the event types to the native event names anyways, I wonder if we can just use the event names as the event type constants? Then we could potentially remove the indirection of mapping event types to event names.\nI had to try that. Please have a look at my latest commit and the updated bundle sizes :)\n\nI think we'd have to ensure that GCC didn't inline the strings, and I'm not sure if we can control that with current closure-compiler-js API.\n\nEven if we don't care about GCC inlining, using the raw event names still significantly reduces the bundle size while avoiding Map completely (might still be in my WIP commit but can definitely be removed).\nCompared to the number approach, the gzipped version is even smaller! :) What do y'all think about that?. > Compared to the number approach, the gzipped version is even smaller! \nAt least when using the build numbers of my previous commit as a baseline, this was the result. On CI, the gzipped file sizes seems to be pretty much identical.\nLocal Builds \nPrev Size: 98.7 KB \nCurrent Size: 99.08 KB \nDiff: +0.4%\nPrev Gzip: 31.73 KB\nCurrent Gzip: 31.73 KB\nDiff: -0.2%\nCI Sizes\n\nNumber IDs: react-dom.production.min.js   -1.6%   -1.0%   100.2 KB    98.63 KB    31.97 KB    31.66 KB    UMD_PROD\nRaw Event Name IDs: react-dom.production.min.js   -1.1%   -1.0%   100.2 KB    99.08 KB    31.97 KB    31.67 KB    UMD_PROD\n. I've upgraded babylon and all babel-* packages. This was required to get proper support for opaque types across the toolchain. All upgrades where minor version only.. By importing the type from the react-dom module, we can use an opaque type and avoid leaking the underlying type in any other module.\n\nDefining the opaque type in DOMTopLevelEventTypes makes the types a lot easier but introduces this not-so-nice type dependency on react-dom.. The only thing I really changed here besides wrapping it in a factory function and adding type annotations was that I added dependencies to all event types (and thus upstreaming the changes required by RNW).\nRN ignores those but the Flow type system still requires them. . eslint is weird about the opaque type export \ud83e\udd37\u200d\u2640\ufe0f . This might no be necessary but I figured it was a good idea especially since DOMTopLevelEventType are opaque and other modules don't know that they hold the raw event name and (as I verified) GCC eliminates this function.. Yeah that will be a breaking change. The current version of RNW will overwrite the dependencies with the invalid top level strings and will patch the ResponderEventPlugin with an additional guard that won't work anymore. Here's the PR: https://github.com/necolas/react-native-web/pull/908\nI could build a PR to RNW that works on both the current version (using top* strings) as well as the next version (which hopefully uses my work) to smooth migration.\n. If we use on* as the base name, we'd still have to slice and lowercase to create the event name used for the dispatch configurations, see here: \nhttps://github.com/facebook/react/pull/12629/files/af02875c73e85300495d986c66488cd5a30b5470#diff-67a781594a9123abc44160cea6eb65f7R145. > It would change the eventTypes keys though.\nThat's what I meant, yes. I'll try that so we can see the impact. IIRC RN registers events using top* strings as the eventTypes keys.. After replacing all eventTypes keys with on* and clean up the slice + lowercasing mess in the SimpleEventHub, the bundle sizes (both regular and gzipped) grew a little again: \n```\nreact-dom.production.min.js  (UMD_PROD)\nPrev Size: 99.03 KB\nCurrent Size: 99.13 KB\nDiff: +0.1%\nPrev Gzip: 31.69 KB\nCurrent Gzip: 31.72 KB\nDiff: +0.1%\n```\nI went ahead and fixed ReactTestUtils as well but it turns out that there are still 14 other modules with failing unit tests. I'm not sure if it's worth to look into that further, what do you think?. This is really interesting! I was not aware of the forks system. Thank you for having another look and showing me that. . See the first thought in my comment here: https://github.com/facebook/react/pull/12629#issuecomment-388506615. Using DOMTopLevelEventType would require us to force a cast to DOMTopLevelEventType in the event plugin. My idea is to keep things limited to this file for now.. No idea if that is the right place for the test :). I move this function (which is only used for one test) inside this describe() closure so it's easier to clean up the container.. I\u2019ve changed the order here slightly such that we can dispatch the event on the node that is already appended to the document.. Is there any particular reason for this addition? I think the only reason we do that is when we have tests that require multiple separate versions of React at the same time. . This seems to be different than the previous implementation. Do you mind explaining why? \ud83d\ude42 . I don't quite understand this comment. @nhunzaker I think this is copied over from #11741 - Can you point me to something so I can read up on that?. Ah, right, makes sense. Otherwise the warning will only pop up once \ud83d\udc4d. > Is there a particular reason though why the casting is done by concatenation instead of e.g. String(value)?\nThere were some performance concerns about String(): https://github.com/facebook/react/pull/11741#discussion_r154350917. > because the value always reports as a string\nI was wondering why Flow did not catch that and found the issue in the getSafeValue() function. Not sure if we want the fix since it adds some complexity but it's nice to know that all code paths indeed work. Check out: https://github.com/facebook/react/pull/13367. I like that section a lot! Maybe we can also list some free options if money is an issue. For example:\n\nMicrosoft provides the option to download free virtual machines with various Internet Explorer versions: https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/\nYou can download a legacy version of Chromium by looking up the base position in https://omahaproxy.appspot.com/ and using that number in https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html. \nMaybe that's a little to complicated? We can skip the first step and hardcode 369907 as the base position?\nAlternatively we can link to https://www.chromium.org/getting-involved/download-chromium\nFirefox ESR versions can be downloaded here: https://www.mozilla.org/en-US/firefox/organizations/\n\nI guess that's it. For Safari you'd need a VM to an old macOS version which will require running macOS as well.. We need suspense \ud83d\ude42 . I don't quite understand this warning. I think the one below should be enough. Maybe this is a merge conflict of some sort?. We have a helper for this now. For an example, check out: https://github.com/facebook/react/blob/725e499cfb4da60da46aa5b44c4bad29cad3d08f/packages/react-dom/src/tests/ReactDOMInput-test.js#L74-L80. I think we want the same behavior for radio buttons as well.. BrowserStack is free for selected open source projects: https://www.browserstack.com/open-source/\nSince Angular qualifies we might as well?. The type of initialValue in the _wrapperState below should probably be SafeValue now, just like we did for input elements.\nEdit: Nevermind you have to push your changes first \ud83d\ude48 . Yes, this seems correct \ud83d\udc4d . _wrapperState is only set once and that is already a SafeValue.. defaultValue was a string before and is a SafeValue now. I'm not sure if this causes issues with the equality test below.. We compared this against a string before and now it's a SafeValue. Is this intended? I think this means when value is a non-string (i.e a number) it will always update node.value since the strict equality will always return false.. That would still false if props.value = 1 and node.value = '1'. I think bringing back const newValue as safeValueToString(value) is more correct.. Can you find out if we really need to convert to ToStringValue here?\nI think we should be able to just pass children directly as the defaultValue since we convert to the ToStringValue down below anyway.. We should probably get rid of this interim value completely. I\u2019ve added it because we used this pattern in the input code but I feel like it caused a lot of confusion already \ud83d\ude15 \nMaybe we can keep the original value as mixed in the wrapper state? \nI can work on that next week.. Let's move the jest.fn() initalization into the beforeEach method. This way you don't need to clear the mock every time. . I think this should be called childRef and parentRef instead so it's more clear what this is doing.. This already returns what you call PARENT so we probably don't need the PARENT variable at all. I also think we can remove the comment here as this method is pretty trivial.. I don't understand this ref here. createInitialInstance already returns a ref to the Parent.. You can remove this comment.. Can you verify that this is indeed necessary? i.e Removing it should fail some tests.. I think the tests are easier to understand when you inline the code from createInitialInstance and updateInstance. . This assertion is already in createInitialInstance(). Can you please verify that you're testing the proper behavior here?. This assertion is already in createInitialInstance() and a duplicate of the previous test. Please verify that you're testing the proper behavior here?. nit: You can use node.click() so it's easier to read \ud83d\ude42 . We could use a ref to the div element directly to avoid findDOMNode.. The comment does not really make sense. . We need to explain why we need to dispatch a click event in the componentWillUnmount callback. This should make it clear that the event system is disabled in that particular use case.. These comments can all be removed. It's clear what's going on from looking at the code.. nit: expect(LISTENER).toBeCalledTimes(2); \ud83d\ude0a . Just pushing parent is probably enough. You can also use calls.push('parent') instead of copying the array, like we do in the previous tests.. This comment is not necessary. That's what stopPropagation() does. . What happened to the comment here? Is this no longer necessary?. Calling event.stopPropagation() might mean that it never hit the root. What if we store a list of all elements that the event already targeted and reset once a duplication is found?\nI think the problem with that is that we would ignore the second dispatch if the same event targets another subtree \ud83e\udd14\n```\n\n\na.dispatchEvent(event);\nb.dispatchEvent(event);\n```\nNow that I understand what's the issue here I can also wrap my head around that a bit \ud83d\ude42 . Something we could try for sure. I'm a little worried that we overestimate the power of a per-root event listener though. We seem to praise it as the solution for all of our event problems right now.\nAt some point I want to compile a list of issues that we've found to see which of those per-root listening can solve and what other problems might occur.. Scroll is also a requirement for the responder event plugin so that might break  RNW if we remove it from the synthetic event system.\nhttps://github.com/facebook/react/blob/master/packages/events/ResponderEventPlugin.js#L25. This test indeed fails if I re-apply my changes from #13358. If the onSubmit handler added a preventDefault(), this would never be called.. I was a bit confused about what we're querying here. Maybe getQueryParam() makes it less confusing? \ud83d\ude42 . License looks \ud83d\udc4d But we need to include the copyright notice I believe (see here).\nSeems like the GitHub files already added this \ud83d\ude42 . Can we put the Fixture into the closure of this file instead of the global namespace? I was confused where this was set when in fact it is very easy and all in the same file \ud83d\ude42 . I was confused about this checkbox. Maybe \"Hydrate on reload\" or \"Auto Hydrate\" makes it clearer? \nEspecially when this checkbox is unchecked you see a button with the same name.. I\u2018m a bit confused about this - where do we use this event constructor? . Have you found out why this PureComponent is needed? It was also set on the wrapper of Child previously - Maybe to avoid the Child from receiving updates?. I think we don't need to have LISTENER as an variable in the closure and can just call jest.fn() whenever we want a listener :-) . Can we remove this abstraction (as well as updateInstance()) and use ReactDOM.render() directly in each test? This way we can make sure to use the least amount of setup for each test and make it a lot easier to follow.. This test is not asserting the same thing as the previous one. The previous test used to call the internal API ReactDOMComponentTree.getInstanceFromNode(node); to find out if React internally added an event listener. The new code is asserting that the onClick prop is set which is what you do in the line above. I think this would be green even if we remove the event system.\nI think this test can safely be removed though. We have a lot of coverage for simple onClick cases.. This test is a duplicate to the one above, check my comments there.. This test is again only asserting the props that you set. I think you can use ReactDOM.render() with an onClick listener and then another ReactDOM.render() without the listener, then fire a native event, and assert that the handler is not called. This way we know that React has cleaned up the listeners internally.. This can be removed.. I can also export this type from ReactDOM if that makes more sense.. I wonder how you came up with all of those edge cases. \ud83d\ude09 . I tested in Chrome and noticed that when a select element is marked as multiple, this issue is not present so the else if seems OK.. I realized that we need to unset the prop so we can reuse the container after we've unmounted. I'm not sure if this is a good place to do so though since there can still be work pending - Maybe we add it into the .then callback? But that would mean that we can't do the following in sync:\njs\nconst root = ReactDOM.unstable_createRoot(container);\nroot.render(<App />);\nroot.unmount();\nconst root2 = ReactDOM.unstable_createRoot(container);\nWhich also seems bad, hence the current approach.. Nit: You can do button.click(); as well \ud83d\ude42. Right, removed that part.. I'm not sure if the options parameter is working across browsers that the new implementation should support. Might be something to look into later.\nWe could feature test is with something along those lines:\njs\nconst supportsCaptureOption = false;\ndocument.createElement(\"div\").addEventListener(\"test\", function() {}, {\n  get capture() {\n    supportsCaptureOption = true;\n    return false;\n  }\n});. Should we fall back to a regular Map if WeakMap is not available? We do this here for example:\nhttps://github.com/facebook/react/blob/a9aa24ed8dc843b76ceb4880b83e776c696cafaf/packages/react-reconciler/src/ReactFiberUnwindWork.js#L82. It seems like those legacy events are also stored in the ElementListeningObject. Did I miss something or is this comment outdated?. If the browser doesn't support passive/non passive events, we would potentially adding two different (since we used .bind) event listeners here so they might double fire. This is of course pure speculation but it might need a feature test here as well (and for the capture case).. Makes sense. I think I was confused by:\n\nWe store [..] on the event listener.. Yeah you're right the listeners will only call the respective callbacks so we need them both to fire. My bad. :-) . Thanks \u2764\ufe0f  Super clear now.. Looking at this polyfill I think it will be complicated to install it in apps that use React to render into a different JavaScript context (<iframe>, etc). I will have to do some testing to know for sure, though.\n\nOn MDN (https://developer.mozilla.org/de/docs/Web/API/EventTarget/addEventListener) it also seems that the options object is not implemented in Edge and IE11 which would affect quite a few users. I don't 100% trust this data though. If you want I can do some cross-browser tests to see which browsers support the options prop? \ud83d\ude42 \n\n\n[..] know if the various options are supported \n\nI think that it is enough if we only test for passive event support. There are no other options that we would set. If passive events are not supported, we don't need the options prop. . I think in this case we need a different message as it does not have a dependency and won't re-run on every render. I'd say we still encourage this pattern even if the function captures only the first ref value and not the ones on re-render.. @Jessidhia \n\nDo tests get run twice for this, or does it just always take one of the paths?\n\nThey're run twice \ud83d\ude42\n. This should use the infrastructure we have in place for dev only warnings. Check out this and this.\nThis will also make sure that the warning is not emitted in production and that the message is indeed correct.. I'm not sure if our builds will properly dead-code-eliminate this branch. I'd rather split it like this:\njs\nif (__DEV__) {\n  warning(nativeEvent.code !== undefined, \"Warning here\");\n}\nAlthough it should probably use warningWithoutStack() since it is triggered within an event handler which does not have a component stack I think.\nhttps://github.com/facebook/react/blob/master/packages/shared/warningWithoutStack.js\n. I think you can remove the JSDocs type annotations since we use Flow anyway.\nThis file should also add the usual copyright header and a flow hint:\nhttps://github.com/facebook/react/blob/679402a66b09e129d06f415cd976d18727cc8590/packages/create-subscription/src/createSubscription.js#L1-L8. The message is not particularly clear. If we go for it, we need to make sure that it explains what's going on. What about:\n\nKeyboardEvent.code is not supported in the browser you\u2019re currently using. You should either add a polyfill or use KeyboardEvent.key instead.\n\n. ",
    "necolas": "Are you asking for that exact wording? Do you mind if we clear up the ambiguities? React / ReactDOM, style values / style property values. ",
    "bee0060": "I just read some code in dangerFile. And found code on line 65\njavascript\nif (/^-|^0(?:\\.0+)$/.test(formatted)) {\nI am not sure the purpose of this code, but when formatted equals -.2abc this .test(formatted) will also return true,( it will return true with any strings start with -) does it meet the expectation ? Or is it a bug?\nIf here just  want to return formatted when change less than or equals 0, maybe replace this code by:\nif (change <= 0) {\nwould be easier to understand.. ",
    "WeShared": "\u2764\ud83d\udc99\ud83d\udc9b\ud83d\udc9a\ud83d\udc4d. ",
    "bsheikh": "Hey, thanks for taking some time to review the PR. As I'm looking back, I'm not sure why I removed null above, root should've been removed instead. Great catch, I've updated the PR.\nThanks!. ",
    "cyan33": "So should fiber.tag === ClassComponent be removed in this case?. Just have added to other files. Now running yarn flow gives out 0 errors \ud83d\ude04 . Sorry I missed this comment. \n\nConsistence wise, I agree. But do we really need to show the component stack? I think the stack information sometimes could easily be noise.\nI'm not quite sure, because I have seen both lowPriorityWarning and warning in this file and I thought priority-wise this is the same with deprecated lifecycles. But we can definitely change it to warning, if it needs more attention from developers.\nI agree that this wording is better. Will change a bit later.\n. I move it upwards intentionally. Because I was thinking that maybe we should not spare time to find its strict node if we already warned this fiber? in which case the findStrictNode becomes extraneous operations.\n\nTell me if I was wrong.. Is it because when we do let warningsForRoot = pendingLegacyContextWarning.get(strictRoot);\nand warningsForRoot.push is mutating the content in pendingLegacyContextWarning?. I thought it was creating a new copy. I'll delete this line.. That makes sense to me now. I agree.. That's a good point. . I'm not sure about this. Maybe ask @acdlite \ud83d\ude04 . Sure will do. It didn't error on this, but I certainly agree on yours.. Of Course \ud83d\udc4d . ",
    "ellsclytn": "Should we cater to null in the same way? If we want to match React 15 behavior, anyway.. Heh, good spot. This is a bit of copy-pasta from the tests above. Will fix.. Good spot. Fixed \ud83d\ude04 . ",
    "eemeli": "Shouldn't it be const propTypes = type.propTypes after the typeof type check, as that's the only value that it gets assigned?. ",
    "guillaumep": "Going from React 16.3 to 16.4 has caused two major regressions in my application because of this change. I was relying on the fact that getDerivedStateFromProps() was only called when the props changed, in the same way componentWillReceiveProps worked.\nGranted, I probably did not understand the original intent of getDerivedStateFromProps. My case is this is more than just a simple bug fix.. ",
    "Illu": "Oh, you're absolutely right! I'll update it right away.. ",
    "ericsoderberghp": "OK. I wasn't sure if there was a more Flow appropriate way to check. Flow wanted explicit checks for both null and undefined.. Duh. Fixed.. Done. I'm used to not allowing infix from our projects lint rules, old habits.. Agreed. But, Flow doesn't seem to be aware of that. Perhaps we need some special Flow syntax I'm not aware of, which is highly likely?. I addressed this by changing the array definition to be stricter and pop via setting the length. It didn't seem right to allow null as an array item but then not test for null when iterating over the array, even though the logic of how the array was being manipulated was OK.. OK.. Good idea.. OK.. OK. But, going back to using null seems to require testing for null when accessing array items by index, since Flow has been told that null and undefined are expected array item values. Or, is there an alternate Flow syntax that allows us to remove the explicit checks?. Yep.. OK. Happy to. I wasn't sure how strict you wanted to be with the type checking.. ",
    "iliran11": "was just thinking it was lengthy.\n maybe perhaps instead of printing \"Cannot update during an existing state transition\" ,  It is better to be concise and print \"Cannot update state during render lifecycle method\" ?. ",
    "GarethSmall": "Good suggestion, since this only occurs in the event of multiple this makes sense.. ",
    "asiniy": "Made behaviour absolutely the same as warnAboutUpdateOnMounted. Did it for child context as well. get rid of componentWillMount. ",
    "jasonwilliams": "oops, yes it should. https://github.com/tc39/proposal-nullish-coalescing would have helped a lot with this, yes we should check if equal to null. Also, are we happy to assume screenX on event? If undefined we could end up with undefined - null. Ok so if screenX will always be an Number, could we not just initiate previousScreenX as 0 Instead of null, and then instead of a ternary or null checking, always perform the minus operation. Because we can guarantee both operands will be Numbers by this point . . ",
    "fatfisz": "I'll look for that!. The only test I could find that is related to this was: \"should not override state with stale values if prevState is spread within getDerivedStateFromProps\" in react/packages/react-dom/src/__tests__/ReactComponentLifeCycle-test.js. I modified it a bit (it involved a parent and a child component, but in the case of shallow rendering this seemed to be a bit too complicated).. ",
    "crux153": "Since my implementation of isUsingKoreanIME depends on CompositionEvent.locale property from composition event, making it part of useFallbackCompositionData requires it to be a function that needs to be invoked every time a composition event occurs.\nCurrent declaration of useFallbackCompositionData happens at load time as it only checks for browser. Check for Korean IME only needs to be invoked when using fallback mode, so I thought additional function invocation would be inefficient for those with modern browsers, though it will be certainly better for code readability.. ",
    "dilidili": "You are right. The node._wrapperState.initialChecked will simplify the DOM operations.. I think we set defaultChecked twice for solving Checkbox checked state is erroneously influenced by value of defaultChecked in Chrome.\ntest:\n+<!DOCTYPE html>\n+<html>\n+<head>\n+<script src=\"../../../resources/testharness.js\"></script>\n+<script src=\"../../../resources/testharnessreport.js\"></script>\n+</head>\n+<body>\n+<script>\n+test (function() {\n+    var el = document.createElement(\"input\");\n+    el.setAttribute(\"type\", \"checkbox\");\n+    el.defaultChecked = true;\n+    el.checked = true;\n+    el.defaultChecked = false;\n+    assert_true(el.checked);\n+}, \"This test check that checked state of checkbox once explicitly set is not affected by default state.\");\n+</script>\n+</body>\n+</html>\ndiff:\n```\nvoid HTMLInputElement::setChecked(bool nowChecked, TextFieldEventBehavior eventBehavior)\n {\n+    m_reflectsCheckedAttribute = false;\n     if (checked() == nowChecked)\n         return;\n\n\nm_reflectsCheckedAttribute = false;\n     m_isChecked = nowChecked;\nif (RadioButtonGroupScope* scope = radioButtonGroupScope())\n```\n\n\nThe purpose of the first assignment is set the m_reflectsCheckedAttribute to false. So, both of our codes work. \n. @nhunzaker updated.\nAnd i changed test case because of which i found: \nif a <input /> is neither checkbox nor radio, input.defaultChecked = true will call input.setAttribute('checked', '') but input.getAttribute('checked') still be null. Thereafter, input.defaultChecked = false will not call input.setAttribute on the uncheckable input.. That makes sense, Updated.. Haha, i tried and got a Flow type check error.\nCannot assign node._wrapperState.initialChecked to node.defaultChecked because property defaultChecked is missing in object type.. ",
    "antmdvs": "This message is a good start (though I also agree with @nhunzaker above). However, it misses the opportunity to provide more directed/clearer guidance for fixing the common mistake you cited in #13121:\n\nthis.setState(({ bool }) => { bool: !bool });\n\ni.e. they intended to use an arrow function with a concise body (implicit return), but they forgot to wrap the object literal in parenthesis to turn it into a JS expression.\nIf I was presented with the above, it might still take me a minute to realize what the actual issue is. \ud83e\udd14\nI think something along these lines would help with that:\n\nThis could happen if you are using an arrow function to return an object literal expression, but forgot to wrap the object literal in parenthesis.. > Do you think it would be worth adding an example, like this.setState(() => undefined), or would that just be confusing?\n\nIMO, this seems too contrived to aid one in resolving the issue. :) (I commented below on possibly elaborating on the warning to address the more concrete/practical case that @sw-yx cited in the original issue.). I didn't mean to get rid of ln 419, meaning you could still say, \"... Otherwise, if a no-op was intended, return null.\"\nIn sum, maybe:\n\nsetState was called with an updater function that returned undefined. This could happen if you are using an arrow function to return an object literal expression, but forgot to wrap the object literal in parentheses. Otherwise, if a no-op was intended, ensure that you return null within the updater function body.. @sw-yx Just reread your comment and I see what you mean; the warning doesn't address the case where the user intended to return non-null, but simply forgot.\n\nI guess we'd have to say something like (which is now getting a little verbose):\n\nsetState was called with an updater function that returned undefined. This could happen if you are using an arrow function to return an object literal expression, but forgot to wrap the object literal in parentheses. Otherwise, ensure that you either return an object or null (if no update is required).. I'm not sure that updater should be omitted, especially if we include a link to the docs.. \n",
    "ImanMh": "doesn't typeof Symbol.for | false return \"error undefined has no key for\" for browsers that does not support symbol at all?\n. ",
    "DCtheTall": "Definitely will use hasOwnProperty over dot notation.\nJust to be clear, are you saying to nest another if statement inside that last else clause or make this the last else if before the else below?. Going to go with the latter to avoid any nested if statements (ugly). If you want it the other way just lmk.. ",
    "zx6658": "@gaearon I agree:) Whatever, i thought deprecated lifecycle error message should be deleted! As you say, I will fix pr by setting warn message by deleting message about prescriptive message (constructor and cDM). @gaearon is it ok?\n. ",
    "yunchancho": "@gaearon Thanks for your review. If an user sets art mode to SVG, React ART renderer creates DOM nodes for SVG. So I think that 'ref' attribute of React ART's component(e.g. Surface, Group) needs to be presented on react-devtools for debugging. The lines that you said above exists for this. In other words, that lines make react-devtools find the fiber for an DOM node of SVG. \n. @gaearon \u00a0I was a little misunderstanding about code line above . As you said, any\u00a0instance\u00a0from ReactART is not DOM node. I will remove\u00a0ReactARTComponentTree.js\u00a0file and change the line to\u00a0findFiberByHostInstance: () => null.. ",
    "prashant-andani": "Thought! Can we not get the code from Git History for future reference?. @gaearon  added back the commented code for now.. ",
    "pgarciacamou": "I'm not sure if this line will work, any comments are welcomed.. I don't understand why you export it twice, I believe that is what is increasing the size of the build files.. ",
    "Slowyn": "This is a behavior change and I'm not sure how to avoid this with this solution. But it's only warning, so shouldn't be critical.. Yeah, It's some temporary \"name\" until we get a full working version.\nGoing to change it to some concrete form \ud83d\ude04 \nHave you taken a look on anccestorInfo in current case?. What about this description: \"Options with stateful children; it should change its state properly and shouldn't fail\"\nWhat do you think?. ",
    "ryota-murakami": "Might be add boolean return type is fine.. @Ailrun When exactly the case you said, Flow is so effective.\nI create live example,\nCould you please look following link\ud83d\ude47\u200d\u2642\ufe0f\nhttps://flow.org/try/#0PQKgBAAgZgNg9gdzCYAoVBTAHgBzgJwBcwBjOAOwGdiBRAGRoFkaA5AFQH0WB5AERrABeMAEYA3JlwFiZKsTY0AGpx78hYAMwTseIqQrUwAYW6Nm7LnwHCAHNql7Zh3tyMBVcyqvqAnPd0yBsQu7p4cAGIASgCCAOJhqtai4uioUACu5CSEAJYUYDmUAGoAhjA5ACZGFIQlOeQY+AAU5HAVGACUAFxgAEZwcDAYJeRgAN6oYGD4GITp+KNNk1Ngre1gAGQby1MtbRgAdGsYbACeOBhCgsL0TKxeagA+jzsrx0f7ZxdXwiEe95Yni8Vm99h92l9Ltdfq5-hYonEEt5nq9du9jpCfsZTEi1FtUaD2uCMKUYOkodcwAByabDbIAWgAtnBMoR6Xh6mzMtQSr0htSOh1lh0JABfdDAYBgRh1cioQqkyrVci1eqNFrpGAwIVAA. ",
    "segoddnja": "postMountWrapper attempts to update options, but as at this moment select doesn't have any child appended, it makes no sense, it will iterate over empty options collection. However it should not cause any problems so if you think it is better approach I can do this change.. ",
    "lidoravitan": "@gaearon I agree that was wrong, so i fixed that. please review again.\nthanks :). @gaearon hope you can review this PR again, thanks . ",
    "WojciechRydel": "These statements might confuse, because override prototype methods in a constructor and those prototype's methods are not used at all. As babel-plugin-transform-class-properties is enabled then you can easily declare those methods using arrow functions:\nclass Dot extends React.Component {\n  constructor() {...}\n...\n  enter = () => {\n    this.setState({hover: true})\n  }\n...\n}. ",
    "elas7": "@TrySound sounds good to me. I can make that change.\n@gaearon are you ok with that?. @TrySound done. ",
    "thoamsy": "Thanks for your advice \ud83d\ude04 \nBut I just want to use the Standard JS feature in the pure HTML file. This is also consistent with the (doc)(https://reactjs.org/docs/handling-events.html).\n\nbecause override prototype methods in a constructor and those prototype's methods are not used at all\n\nThe syntax doesn't override prototype methods. For this.enter  = this.enter.bind(this),\nthe this.enter on the left, is a function for the class instance.   And the this.enter on the right, is a function for the prototype.. ",
    "motiz88": "Happy to take your steer on this, I'd just like to state my case first for completeness: The thing I was trying to make safer was people drawing inferences from one \"boolean\" HTML attribute to another. Since enumerated attribute values are case-insensitive, spellCheck=\"False\" does behave differently to hidden=\"False\", in exactly the same way as the respective lowercase variants do. I take your point that most people would be using lowercase to begin with, so this is probably a rarer case, but it does theoretically occur.\nTo clarify, you're referring to dropping the toLowerCase() in the actual check, as well as removing this test, right?. This test was broken by adding the warning on \"true\". I opted to just fix what the warning was complaining about, which doesn't change the semantics of this test AFAICT.. Arguably this test belongs under String boolean attributes above, rather than here under Boolean attributes (a test category I introduced in #13372), but then again it's clearly a sibling test to the other two that do belong here. \ud83e\udd37\u200d\u2642\ufe0f  Happy to restructure this based on feedback.. ",
    "Kachulio1": "@gaearon I have reverted it back to ternary, I had a doubt on that one.. \n. ",
    "goksu": "I'd move this out to a private helper method instead of crowding cloneElement().. Great update!\nOne last thing, I would move the definition for propName in to the loop as in for (let propName in origProps).. ",
    "arianon": "Why not use resolvedValue.__esModule ? resolvedValue.default : resolvedValue?. You are correct, Node.js with --experimental-modules doesn't have it,and  neither does Chrome's native ESM support.. ",
    "benbraou": "I noticed that it does not override but rather duplicate the junit error messages displayed in CircleCi. I am removing this, and keeping the reporter only in line 13.. Indeed, no need for unique reports. I am removing this, and keeping the reporting only in line 13.. sure. ",
    "tjallingt": "writeDefault (or maybe writeGlobal / writeBase)\nContext.write() implies to me like it would write to the nearest parent provider (just like, if i'm not terribly mistaken, Context.read reads from the nearest parent provider).. ",
    "Yurickh": "This might look like nitpicking, since it's completely unrelated to the issue at hand, but I'm honestly curious on why you used MouseEvent for input here.\nSorry for the random chime in \ud83d\udc50 . I see. Thanks for the quick answer :)~. I'm not really sure why this changed, as I just run the tests, and didn't ask for snapshot updating at any time.. I guess so, since the linter always runs in a node environmemt. . Also, IIRC, thrownSegments isn\u2019t an array here, it\u2019s just array-like. . Since it is a direct extract from the original code, this shouldn't really be an issue.. Hi! Thanks for the chime in, explaining the original rationale behind this piece of code, that was really enlightening.\nUnfortunately, I'm not sure there's a way to work around this performance regression. Using the cache as it is proved itself faulty and could lead to false negatives, as issue proved.\nI could just remove the item from the cache once we finished visiting it, but the complexity of the overall algorithm would be the same.\nI guess the complexity of the problem of finding the number of paths between two nodes on a graph can't really be reduced here.\nI'll think about how we could improve it for the case of multiple hooks, so the complexity is not so high.. ",
    "alex-saunders": "I've tried putting it into a variable to avoid the repeated code. Nice spot, cheers @Simek , added that now. ",
    "mgol": "@gaearon Reverted. I don't know what generated changes to this file, I was just trying to follow https://reactjs.org/docs/how-to-contribute.html.... Yeah, I already did in this PR. I'll remember for the future. :). I'm not sure how useful this test is; it'd need to be run in IE to make sure there is no regression, other browsers (and jsdom) would pass it even without this PR's changes.\nMaybe it's useful as a way of ensuring my changes don't break jsdom?. That's an excellent point. I'm afraid the only certain solution would be to do CSS parsing of the declarations included in the style attribute but the grammar for that is not that simple:\nhttps://www.w3.org/TR/css-syntax-3/#tokenizing-and-parsing\nespecially around unquoted URLs so this might be too much.\nThat said, spaces are not that frequent in URLs, especially around semicolons and colons so this change should have very few false positives as opposed to having false negatives for every style attribute.\nIf I understand correctly, this only affects development. How about keeping this logic but only if document.documentMode is truthy? Regular browsers would work as they are now and developing in IE would be a little less unpleasant.. > So at most you'll miss some legitimate warnings, but you shouldn't get warnings about valid code. Is that accurate?\nYes, that's exactly it. And in non-IE browsers you'll still get all the warnings.. ",
    "alexmckenley": "I was planning on controlling this in www like so: https://fburl.com/diff/i1l0949n. \nlet me know if you'd rather just hard-code the value here.. ",
    "nishp1": "Updated suspense readme. Not 100% sure if interaction was renamed. . ",
    "link-alex": "That was my first intention :)\nBut then I thought that maybe it\u2019s not desired to switch to fixed amount of args.\nIf it\u2019s ok for you - I can update.. As far as I can see the maximum of 8 arguments is used at the moment for this warning. Do you want to add extra check? But how many arguments do we need to check? That's exactly the reason I didn't use this approach initially..\nbtw, the tests marked as failed, but as I can see on circleci - tests itself passed, but later this happened. Is it related to the change? Or verification job could be just restarted?\nRequest failed [401]: https://api.github.com/repos/facebook/react/pulls/13620/requested_reviewers\nResponse: {\n  \"message\": \"Bad credentials\",\n  \"documentation_url\": \"https://developer.github.com/v3\"\n}\nError:  TypeError: Cannot read property 'repo' of undefined\n    at GitHub.APIMetadataForPR (/home/circleci/project/node_modules/danger/distribution/platforms/GitHub.js:274:27)\n    at GitHub. (/home/circleci/project/node_modules/danger/distribution/platforms/GitHub.js:164:39)\n    at step (/home/circleci/project/node_modules/danger/distribution/platforms/GitHub.js:40:23)\n    at Object.next (/home/circleci/project/node_modules/danger/distribution/platforms/GitHub.js:21:53)\n    at fulfilled (/home/circleci/project/node_modules/danger/distribution/platforms/GitHub.js:12:58)\n    at \n    at process._tickCallback (internal/process/next_tick.js:189:7)\nDanger failed. ",
    "JSteunou": "I understand, I changed the logic a bit by over-protecting this path\nUpdate incoming. ",
    "armujahid": "Done. Thanks for the review. ",
    "AyWa": "Flow will fail there, but waiting to get Proposal of fix:  opinion. Got it, the original issue was with componentDidMount so I updated the test with it.\nAlso I don't know if it should be supported or just throw a warnings? (because in the original issue, the unmountComponentAtNode was unnecessary).. ",
    "mycatnamedweb": "Isn't it a problem that this will not be reverted to its original value if the test fails?. ",
    "CharlieTruong": "Good call.  I pushed a commit to move this test to be under a describe block and ensured the process.env is reset in a afterAll block.  Thanks for the feedback!. ",
    "vikr01": "Why were all React.Fragment's removed?. From @loganfsmyth:\n\nThis can be removed, since it has landed in the language official and is thus always enabled.. trailingFunctionCommas should be removed from here, see babel's changelog.. This should be updated.. This needs to be updated.. You missed this one.. \n",
    "1pete": "container.firstChild.src on master is hello but in this pr is http://localhost/hello\nso you change test case just to make test passes.\nyou should change settings instead of changing this test case, shouldn't you?. ",
    "NMinhNguyen": "For what it's worth, I had to update my local copy of this transform as follows: https://gist.github.com/NMinhNguyen/4c3f8fdbd99730df6e00e5c33a23751c. This is against beta 42 so things might have changed since then, but I definitely encountered problems without doing babel.types.cloneNode(state.id). I'm not sure if this comment still makes sense at the top level, but these rules were in eslintrc.default.js. Had to turn this rule off because strict: ERROR with sourceType: 'module' causes errors such as\n/react/packages/create-subscription/index.js\n  10:1  error  'use strict' is unnecessary inside of modules  strict. This can now be simplified as follows but I thought I'd leave as is so it can be more easily extended in the future.\njs\nconst {errorCount, warningCount, output} = runESLintOnFilesWithOptions(\n  allPaths,\n  onlyChanged\n);. Instead of adding these to each UMD bundle, I could add another overrides section disabling this rule. Something like\n```js\n// .eslintrc.js\n{\n  overrides: [\n    // ...\n    {\n      files: ['packages//npm/umd/.js'],\n      rules: {\n        'no-unused-expressions': OFF,\n      }\n    }\n  ]\n}\n```. ",
    "mrkev": "@acdlite I think I might want to expose this variable too, since for debugging it's necessary to know if the thing is paused at all in the first place. I don't have an opinion on this. no-oping in production seems a good solution in my book.. ",
    "blixt": "Does this mean that the bug only happens when in DEV?\nAlso, couldn't this code be combined into the following block to avoid implying that the conditions/variables have any effect in production?\n```typescript\n        if (DEV) {\n          // Reset global debug state\n          // We assume this is defined in DEV\n          (resetCurrentlyProcessingQueue: any)();\n      if (!wasCompleting && replayFailedUnitOfWorkWithInvokeGuardedCallback) {\n        const failedUnitOfWork: Fiber = nextUnitOfWork;\n        replayUnitOfWork(failedUnitOfWork, thrownValue, isYieldy);\n      }\n    }\n\n```. ",
    "locknono": "I\u2018m very sorry that i accidently deleted my fork repository both remote and local,could i close this pull request and open a new one?. ",
    "jcs090218": "Look carefully to the code. I think @acdlite is saying we need to keep deleteRemainingChildren(returnFiber, currentFirstChild); in both conditions? They are returning the existing; on line 1096, which the code would not reach.. I am a bit confuse and worry that these lines will not produce the same result as setProps function do?. ",
    "Matthew-Goldberg": "Are you sure this test is useful?  It seems this assertion passes even without a fix to the actual problem.. ",
    "tagalong420": "(1) Yeah it could if the code is missing or incorrect.\n(2) If it did proceed to load it would load wrong and kick the user out of the server and or domain. \n(3) Codes for all links and sites haft to be correctly placed in the script and diagram/program. . ",
    "jjspace": "I added a getter for this to throw an error if code is not defined on the KeyboardEvent object. I also tried to add tests for this but I couldn't find a way to force code to be undefined on the native event within node, any suggestions/help with that?. It seems like it should work, I was going off what I saw in other test files like this here It seems like it just runs once and chooses the path dependent on the env variables. \nBut I also was unable to find a way to force the code property of the KeyboardEvent to be undefined to actually test it as the constructor will set it to '' automatically if set to undefined like in line 466.. ",
    "poeschko": "Yes, good idea.. Yes, done.. ",
    "matpag": "typo on \"parepare\". typo on \"suggesgted\". typo on \"Othewise\". typo on \"falttened\". Typo on \"availbale\" in line 161 too. ",
    "apalm": "Typo?. ",
    "voxpelli": "I submitted a PR to fix this: https://github.com/facebook/react/pull/14314. ",
    "tzachyrm": "Happened to me in practice :). ",
    "dotspencer": "I'm curious about this too... \ud83e\udd14 . ",
    "sdevalapurkar": "I think we should be able to simplify this conditional to read as:\nsuggestion\n    if (typeof origProps[propName] !== 'undefined') {\n      propsToAdd[propName] = origProps[propName];\n    }\nsince the if block is not performing any operation, we should be able to remove it completely. If I am understanding this functionality correctly, maybe this can read as:\nsuggestion\n  // Only the original props that are not undefined are copied. I think this function should be renamed to\ncheckPropsForUndefined\nbecause that is what it seems to be doing. I think it would make more sense because undefined and null are quite different things. question/nit: could this just be\nsuggestion\n    if (props[propName] == undefined) {. supernit:\nsuggestion\n * `ReactElement` statically sets the `ReactElementValidator` keys to `null` as default.. should we be using !== here?. ",
    "mathiasbynens": "Nit: s/deopt/performance cliff/\n(It's not a deopt.). To give some more background, a deopt happens when we're running optimized machine code generated by the optimizing compiler (TurboFan in V8's case), and one of the assumptions in the optimized code turns out to be invalid. In such cases we have to deopt and go back to running bytecode in the interpreter (Ignition in V8's case). (Our JSConf talk includes some more detail and visualizations that make this more clear, in case you're interested.)\nThis V8 bug however occurs before we even get to optimized code.\nYou can verify this yourself by running our reduced test case with --no-opt: it still reproduces. . ",
    "j-nolan": "This test seems to pass. ChangeEventPlugin-test.internal.js is red though. ",
    "Goodluckhf": "I think, for better readability is better to reverse conditions. It'll lead to decrease level of nesting\nsomething like this:\nif (! __DEV__) return; . it looks like repeating code from line 306. Is it possible to simplify logic here, maybe to extract method?. else here is redundant. It's only add unnecessary nesting. ",
    "AGMETEOR": "@trueadm  I was suggesting a description like it('is an empty test, () => {} would be better.. ",
    "lamhieu-vk": "hi @gaearon , In the first, thank you for review this PR!\nIn our bug log, I realize this is where the error appears, it only appears in some versions of Firefox!. @gaearon please give me a comment for change ^^, thank you!. ",
    "zhigang1992": "Perhaps we can improve the error message here. Add a shortened link to Rules of Hooks ?. ",
    "hg-pyun": "Is it okay includes method without polyfill?\nhttps://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Global_Objects/Array/includes. Okay, It looks good.. If the hooks are officially released in the future, there will be no problem since it will disappear.. ",
    "kachkaev": "\ud83d\udc4b Should there be a space before the opening bracket?. ",
    "leonardodino": "fix pull request number (it was duplicated from the entry above)\nsuggestion\n* Fix reporting after encountering a loop. ([@calebmer](https://github.com/calebmer) and [@Yurickh](https://github.com/Yurickh) in [#14661](https://github.com/facebook/react/pull/14661)). ",
    "jamesisaac": "@Jessidhia () => void enforces a void return in Flow.  The effect you're talking about would be written as () => mixed in Flow.. ",
    "matthargett": "should we warn when in dev mode about the value being less than 8?. ",
    "thecotne": "suggestion\n* [Hooks (Preview)](https://reactjs.org/docs/hooks-intro.html). ",
    "dudenamedjune": "Could you delete this maybe, it will surely release if you do  \ud83e\udd51. ",
    "rodrigopr": "Yeah, I missed updating the comment =/\nBefore this change _dispatchAction ignored calls after the render returned, this checks if its the same component and queue the action.. Should it also rerender in this case?\nIt would be inline with class component behavior, covering tests like\njs\nrendered.props.onClick();\nexpect(shallowRenderer.getRenderOutput()).toEqual(... updated ...);\nwhich is what I think a lib like enzyme would do internally. But don't shallow-render Updater do this already? (immediately change the state and rerender)\nhttps://github.com/facebook/react/blob/0e4135e8c2f1bc9cd14f439190aa28865395e4b1/packages/react-test-renderer/src/ReactShallowRenderer.js#L154-L159\n(i'm not sure who calls enqueueSetState, so I might be missing something). ",
    "overlookmotel": "I've pushed another commit which does as you request.\nHowever, the previous value does need to be restored for each Provider, as each Context's current value is stored separately on each Context object.\nWell, if there were several nested Providers for the same Context, then yes you could only restore just the last previous value. But I don't think this would be more performative, as clearProviders() would need to loop over the array twice - once to identify any repeated contexts, and then a 2nd time to restore whatever was the oldest previous value for each Context.\nI think it's probably cheaper to redundantly write the value multiple times in these cases.\nBut if you want further changes, please just say so and I'll implement.. NB This leaves contextStack and contextValueStack unaltered, and so retaining memory. But I guess since the PartialRenderer instance has been destroyed, it will be dereferenced and garbage collected shortly anyway.. ",
    "Ailrun": "This is not type-safe since without !!, this function can return any falsy value of node, like null.. @ryota-murakami The problem is that passing null is a valid use case of this function. You cannot remove a valid usage for a wrong correctness.. ",
    "TheSavior": "I copied this from https://github.com/facebook/react/blob/b87aabdfe1b7461e7331abb3601d9e6bb27544bc/packages/react/src/tests/createReactClassIntegration-test.internal.js#L24-L27. Is there a better flow type I should be using for handle?. Alright, seems like a problem for another PR at another time. :) . What do you mean by canonical? It seems like to get Flow to pass these consts have to be defined in every file. Ah, nvm. I understand. I need to re-export the one from FeatureFlags. I'm testing this change more closely to ensure I can actually flip this on in FBSource.. ",
    "dan-lee": "I think this use case I've got also relates to this:\n```jsx\nfunction LinkInterceptor({ html }) {\n  const handleClick = e => {\n    e.preventDefault()\n    console.log(e.target.href)\n  }\n  const ref = useRef()\nuseEffect(\n    () => {\n      Array.from(ref.current.querySelectorAll('a')).forEach(node =>\n        node.addEventListener('click', handleClick)\n      )\n  return () => {\n    Array.from(ref.current.querySelectorAll('a')).forEach(node =>\n      node.removeEventListener('click', handleClick)\n    )\n  }\n},\n// eslint-disable-next-line react-hooks/exhaustive-deps\n[html]\n\n)\nreturn \n}\n```. ",
    "eps1lon": "A cultural suggestion: Explain what is happening and why rather than telling someone directly they made a mistake. I suspect people might get overly defensive if the computer tells them they made a mistake.\nsuggestion\n              `the effect cleanup will likely cause a TypeError because by this time React ` +\nNo opinion what should we call it e.g. \"null pointer exception\", \"reading a property from null\" etc.. Right, maybe \nsuggestion\n              `the effect cleanup will likely use a different ref value because by this time React ` +\nMy point was more about not actually saying that this \"is a mistake\". That's already implied by reporting that a lint rule has been violated. As far as I know the other messages don't add this is likely a mistake either.. Would this also match a potential future warning? I had the full message originally but I'm not sure how it would actually look like\nsuggestion\n      expect(() => ReactDOM.findDOMNode(child)).not.toWarnDev(['Warning: findDOMNode is deprecated in StrictMode.**']);. ",
    "kulek1": "You can use const here.. ",
    "ahtee": "any reason for this change? looks like it was intended to fit under the \n/******* ESLint Plugin for Hooks (proposal) *******/ title. this seemed fine.. care to explain why the proposed change?. ",
    "kunukn": "Not from me. \nI executed yarn prettier as peer pull request guidance and prettier decided to do that.\n. ",
    "jaredpalmer": "I copied from the React docs. Should we also maybe update those as well? . Will open a different PR there.. "
}